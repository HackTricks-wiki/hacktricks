# Bins & Memory Allocations

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹ã€‚

</details>

## åŸºæœ¬æƒ…å ±

ãƒãƒ£ãƒ³ã‚¯ãŒæ ¼ç´ã•ã‚Œã‚‹åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€å„ãƒãƒ£ãƒ³ã‚¯ã¯1ã¤ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã«ã ã‘ã§ã¯ãªãã€è¤‡æ•°ã®ã‚¿ã‚¤ãƒ—ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒ“ãƒ³ã§ã‚ã‚Šã€5ç¨®é¡ã®ãƒ“ãƒ³ãŒã‚ã‚Šã¾ã™ï¼š[62](https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1407) small binsã€63 large binsã€1 unsorted binã€10 fast binsã€ãŠã‚ˆã³ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«64 tcache binsã€‚

å„unsortedã€smallã€large binsã¸ã®åˆæœŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¯åŒã˜é…åˆ—å†…ã«ã‚ã‚Šã¾ã™ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã¯æœªä½¿ç”¨ã§ã€1ã¯unsorted binã€2ã‹ã‚‰64ã¯small binsã€65ã‹ã‚‰127ã¯large binsã§ã™ã€‚

### Small Bins

Small binsã¯large binsã‚ˆã‚Šã‚‚é€Ÿãã€fast binsã‚ˆã‚Šã‚‚é…ã„ã§ã™ã€‚

62ã®å„binã«ã¯**åŒã˜ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯**ãŒã‚ã‚Šã¾ã™ï¼š16ã€24ã€...ï¼ˆ32ãƒ“ãƒƒãƒˆã§ã¯æœ€å¤§504ãƒã‚¤ãƒˆã€64ãƒ“ãƒƒãƒˆã§ã¯1024ãƒã‚¤ãƒˆï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç©ºé–“ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¹ããƒ“ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹é€Ÿåº¦ã‚„ã€ã“ã‚Œã‚‰ã®ãƒªã‚¹ãƒˆã¸ã®ã‚¨ãƒ³ãƒˆãƒªã®æŒ¿å…¥ã¨å‰Šé™¤ã®é€Ÿåº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚

### Large Bins

å›ºå®šã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹small binsã¨ã¯ç•°ãªã‚Šã€å„**large binã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®ç¯„å›²ã‚’æ‰±ã„ã¾ã™**ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ãŒ**ã•ã¾ã–ã¾ãªã‚µã‚¤ã‚º**ã‚’åˆ¥ã€…ã®ãƒ“ãƒ³ãªã—ã§åå®¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ¡ãƒ¢ãƒªã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã§ã¯ã€large binsã¯small binsãŒçµ‚ã‚ã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚large binsã®ç¯„å›²ã¯å¾ã€…ã«å¤§ãããªã‚Šã€æœ€åˆã®binã¯512ã‹ã‚‰576ãƒã‚¤ãƒˆã®ãƒãƒ£ãƒ³ã‚¯ã‚’ã‚«ãƒãƒ¼ã—ã€æ¬¡ã®binã¯576ã‹ã‚‰640ãƒã‚¤ãƒˆã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç¶šãã€æœ€å¤§ã®binã«ã¯1MBä»¥ä¸Šã®ã™ã¹ã¦ã®ãƒãƒ£ãƒ³ã‚¯ãŒå«ã¾ã‚Œã¾ã™ã€‚

large binsã¯small binsã¨æ¯”è¼ƒã—ã¦æ“ä½œãŒé…ããªã‚Šã¾ã™ã€‚ãªãœãªã‚‰ã€é©åˆ‡ãªå‰²ã‚Šå½“ã¦ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«**ã•ã¾ã–ã¾ãªãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®ãƒªã‚¹ãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦æ¤œç´¢**ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒlarge binã«æŒ¿å…¥ã•ã‚Œã‚‹ã¨ãã¯ã‚½ãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ¡ãƒ¢ãƒªãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨ãã¯é©åˆ‡ãªãƒãƒ£ãƒ³ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¿½åŠ ä½œæ¥­ã«ã‚ˆã‚Šã€large binsã¯**é…ã**ãªã‚Šã¾ã™ãŒã€å¤§ããªå‰²ã‚Šå½“ã¦ã¯å°ã•ãªå‰²ã‚Šå½“ã¦ã‚ˆã‚Šã‚‚ä¸€èˆ¬çš„ã§ã¯ãªã„ãŸã‚ã€å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã§ã™ã€‚

ä»¥ä¸‹ãŒã‚ã‚Šã¾ã™ï¼š

* 64Bç¯„å›²ã®32 bins
* 512Bç¯„å›²ã®16 bins
* 4096Bç¯„å›²ã®8 bins
* 32768Bç¯„å›²ã®4 bins
* 262144Bç¯„å›²ã®2 bins
* æ®‹ã‚Šã®ã‚µã‚¤ã‚ºç”¨ã®1 bin

### Unsorted Bin

unsorted binã¯ã€ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’è¿…é€Ÿã«è¡Œã†ãŸã‚ã«ãƒ’ãƒ¼ãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒä½¿ç”¨ã™ã‚‹**é«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥**ã§ã™ã€‚å‹•ä½œæ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼šãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾ã™ã‚‹ã¨ãã€ãƒ’ãƒ¼ãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¯ãã‚Œã‚’ã™ãã«ç‰¹å®šã®ãƒ“ãƒ³ã«å…¥ã‚Œã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€éš£æ¥ã™ã‚‹ç©ºããƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã—ã¦å¤§ããªç©ºããƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ãã®å¾Œã€ã“ã®æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’ã€Œunsorted binã€ã¨å‘¼ã°ã‚Œã‚‹ä¸€èˆ¬çš„ãªãƒ“ãƒ³ã«é…ç½®ã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ¡ãƒ¢ãƒªã‚’è¦æ±‚ã™ã‚‹ã¨ãã€ãƒ’ãƒ¼ãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¯unsorted binã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ååˆ†ãªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚é©åˆ‡ãªãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Œã°ã€ã™ãã«ä½¿ç”¨ã—ã¾ã™ã€‚é©åˆ‡ãªãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ã‚µã‚¤ã‚ºã«åŸºã¥ã„ã¦ãã‚Œã‚‰ã‚’å¯¾å¿œã™ã‚‹small binã¾ãŸã¯large binã«ç§»å‹•ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€unsorted binã¯ã€æœ€è¿‘è§£æ”¾ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã‚’è¿…é€Ÿã«å†åˆ©ç”¨ã—ã€æ™‚é–“ã®ã‹ã‹ã‚‹æ¤œç´¢ã¨ãƒãƒ¼ã‚¸ã®å¿…è¦æ€§ã‚’æ¸›ã‚‰ã™ã“ã¨ã§ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’é«˜é€ŸåŒ–ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

{% hint style="danger" %}
ç•°ãªã‚‹ã‚«ãƒ†ã‚´ãƒªã®ãƒãƒ£ãƒ³ã‚¯ã§ã‚ã£ã¦ã‚‚ã€åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ãŒä»–ã®åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ã¨è¡çªã—ã¦ã„ã‚‹å ´åˆï¼ˆã‚«ãƒ†ã‚´ãƒªãŒç•°ãªã£ã¦ã„ã¦ã‚‚ï¼‰ã€ãã‚Œã‚‰ã¯ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚
{% endhint %}

### Fast Bins

Fast binsã¯ã€æœ€è¿‘è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹æ§‹é€ ã«ä¿æŒã™ã‚‹ã“ã¨ã§ã€å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’**é«˜é€ŸåŒ–ã™ã‚‹**ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ“ãƒ³ã¯ã€æœ€å¾Œã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒæ–°ã—ã„å‰²ã‚Šå½“ã¦è¦æ±‚ãŒã‚ã‚‹ã¨ãã«æœ€åˆã«å†åˆ©ç”¨ã•ã‚Œã‚‹**Last-In, First-Outï¼ˆLIFOï¼‰**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®å‹•ä½œã¯é€Ÿåº¦ã«ã¨ã£ã¦æœ‰åˆ©ã§ã‚ã‚Šã€ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆLIFOï¼‰ã®ãƒˆãƒƒãƒ—ã‹ã‚‰æŒ¿å…¥ãŠã‚ˆã³å‰Šé™¤ã‚’è¡Œã†ã®ã¯ã€ã‚­ãƒ¥ãƒ¼ï¼ˆFIFOï¼‰ã‚ˆã‚Šã‚‚é€Ÿã„ã‹ã‚‰ã§ã™ã€‚

ã•ã‚‰ã«ã€**fast binsã¯å˜æ–¹å‘ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆ**ã‚’ä½¿ç”¨ã—ã€ãƒ€ãƒ–ãƒ«ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã§ã¯ãªã„ãŸã‚ã€é€Ÿåº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚fast binsã®ãƒãƒ£ãƒ³ã‚¯ã¯éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã•ã‚Œãªã„ãŸã‚ã€ä¸­å¤®ã‹ã‚‰ã®å‰Šé™¤ã‚’è¨±å¯ã™ã‚‹è¤‡é›‘ãªæ§‹é€ ã¯ä¸è¦ã§ã™ã€‚å˜æ–¹å‘ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã¯ã€ã“ã‚Œã‚‰ã®æ“ä½œã«å¯¾ã—ã¦ã‚ˆã‚Šå˜ç´”ã§é€Ÿã„ã§ã™ã€‚

åŸºæœ¬çš„ã«ã€ã“ã“ã§èµ·ã“ã‚‹ã“ã¨ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒã‚§ãƒƒã‚¯ã™ã‚‹æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ï¼‰ãŒå¸¸ã«ãã®ã‚µã‚¤ã‚ºã®æœ€æ–°ã®è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚ã—ãŸãŒã£ã¦ï¼š

* ãã®ã‚µã‚¤ã‚ºã®æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä½¿ç”¨ã™ã‚‹ç©ºããƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®ç©ºããƒãƒ£ãƒ³ã‚¯ãŒæ¬¡ã«ä½¿ç”¨ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¿å­˜ã•ã‚Œã€æ¬¡ã®å‰²ã‚Šå½“ã¦ãŒã©ã“ã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã™ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€ç©ºããƒãƒ£ãƒ³ã‚¯ã¯ç¾åœ¨ã®åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã—ã€ã“ã®æ–°ã—ãè§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

{% hint style="danger" %}
fast binsã®ãƒãƒ£ãƒ³ã‚¯ã¯è‡ªå‹•çš„ã«åˆ©ç”¨å¯èƒ½ã«è¨­å®šã•ã‚Œãªã„ãŸã‚ã€ä»–ã®ãƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã§ãã‚‹ä»£ã‚ã‚Šã«ä¸€å®šæ™‚é–“fast binãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦ä¿æŒã•ã‚Œã¾ã™ã€‚
{% endhint %}

### Tcacheï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰Bins

ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ç‹¬è‡ªã®ãƒ’ãƒ¼ãƒ—ã‚’æŒã¨ã†ã¨ã—ã¾ã™ãŒï¼ˆ[Arenas](bins-and-memory-allocations.md#arenas)ãŠã‚ˆã³[Subheaps](bins-and-memory-allocations.md#subheaps)ã‚’å‚ç…§ï¼‰ã€å¤šãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒã¤ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆWebã‚µãƒ¼ãƒãƒ¼ãªã©ï¼‰**ã¯ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãƒ’ãƒ¼ãƒ—ã‚’å…±æœ‰ã™ã‚‹å¯èƒ½æ€§**ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€ä¸»ãªè§£æ±ºç­–ã¯**ãƒ­ãƒƒã‚«ãƒ¼**ã®ä½¿ç”¨ã§ã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šã‚¹ãƒ¬ãƒƒãƒ‰ã®**é…å»¶ãŒè‘—ã—ãé…ããªã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€tcacheã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã®fast binã®ã‚ˆã†ã«ã€ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒãƒ¼ã‚¸ã—ãªã„**å˜æ–¹å‘ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆ**ã§ã‚ã‚‹ã¨ã„ã†ç‚¹ã§ä¼¼ã¦ã„ã¾ã™ã€‚å„ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¯**64å€‹ã®å˜æ–¹å‘ãƒªãƒ³ã‚¯tcache bins**ãŒã‚ã‚Šã¾ã™ã€‚å„ãƒ“ãƒ³ã«ã¯ã€[64ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯24ã‹ã‚‰1032Bã€32ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯12ã‹ã‚‰516B](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l315)ã®[åŒã˜ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ãŒæœ€å¤§7ã¤](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l323)å«ã¾ã‚Œã¾ã™ã€‚

ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ**ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹**ã¨ãã€ãã‚ŒãŒtcacheã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã«ã¯**å¤§ãã™ããªã„**ã‹ã¤å¯¾å¿œã™ã‚‹tcache binãŒ**æº€æ¯ã§ãªã„**ï¼ˆã™ã§ã«7ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ï¼‰å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚tcacheã«ç§»å‹•ã§ããªã„å ´åˆã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ“ãƒ³ã§è§£æ”¾æ“ä½œã‚’è¡Œã†ãŸã‚ã«ãƒ’ãƒ¼ãƒ—ãƒ­ãƒƒã‚¯ã‚’å¾…ãŸãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

**ãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹**ã¨ãã€**Tcacheã«å¿…è¦ãªã‚µã‚¤ã‚ºã®ç©ºããƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚Œã°ä½¿ç”¨**ã•ã‚Œã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ“ãƒ³ã§è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ãƒ’ãƒ¼ãƒ—ãƒ­ãƒƒã‚¯ã‚’å¾…ãŸãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚\
ã¾ãŸã€ã“ã®å ´åˆã®æœ€é©åŒ–ãŒã‚ã‚Šã€ãƒ’ãƒ¼ãƒ—ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹é–“ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¯è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã®ãƒ’ãƒ¼ãƒ—ãƒãƒ£ãƒ³ã‚¯ï¼ˆ7ã¤ï¼‰ã§Tcacheã‚’åŸ‹ã‚ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€å¿…è¦ãŒã‚ã‚Œã°Tcacheã§ãã‚Œã‚‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
## å‰²ã‚Šå½“ã¦ãƒ•ãƒ­ãƒ¼

{% hint style="success" %}
(ã“ã®ç¾åœ¨ã®èª¬æ˜ã¯[https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/core_functions)ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚TODO: æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦æ›´æ–°ã™ã‚‹)
{% endhint %}

å‰²ã‚Šå½“ã¦ã¯æœ€çµ‚çš„ã«é–¢æ•°`void * _int_malloc (mstate av, size_t bytes)`ã§å®Ÿè¡Œã•ã‚Œã€ä»¥ä¸‹ã®é †åºã§è¡Œã‚ã‚Œã¾ã™:

1. **ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ**ãªã©ã‚’è€ƒæ…®ã—ã¦`bytes`ã‚’æ›´æ–°ã—ã¾ã™ã€‚
2. `av`ãŒ**NULL**ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
3. **ä½¿ç”¨å¯èƒ½ãªã‚¢ãƒªãƒ¼ãƒŠ**ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆ`av`ãŒNULLã®å ´åˆï¼‰ã€`sysmalloc`ã‚’å‘¼ã³å‡ºã—ã¦mmapã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã¾ã™ã€‚æˆåŠŸã—ãŸå ´åˆã€`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
4. ã‚µã‚¤ã‚ºã«å¿œã˜ã¦:
* \[å…ƒã®å†…å®¹ã«è¿½åŠ ] æ¬¡ã®fastbinã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å‰ã«tcacheã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
* \[å…ƒã®å†…å®¹ã«è¿½åŠ ] tcacheãŒãªã„ãŒç•°ãªã‚‹binãŒä½¿ç”¨ã•ã‚Œã‚‹å ´åˆï¼ˆå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§èª¬æ˜ï¼‰ã€ãã®binã‹ã‚‰tcacheã‚’åŸ‹ã‚ã‚ˆã†ã¨ã—ã¾ã™ã€‚
* ã‚µã‚¤ã‚ºãŒ**fastbin**ç¯„å›²ã«ã‚ã‚‹å ´åˆ:&#x20;
1. é©åˆ‡ãªbinã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®fastbiné…åˆ—ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
2. ãã®binå†…ã®æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã€`victim`ã‚’ãã‚Œã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚
3. `victim`ãŒNULLã®å ´åˆã¯ã€æ¬¡ã®ã‚±ãƒ¼ã‚¹ï¼ˆsmallbinï¼‰ã«é€²ã¿ã¾ã™ã€‚
4. `victim`ãŒNULLã§ãªã„å ´åˆã¯ã€ãã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ç‰¹å®šã®binã«å±ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆ"malloc(): memory corruption (fast)"ï¼‰ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ã€‚
5. `alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¦ã‹ã‚‰ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
* ã‚µã‚¤ã‚ºãŒ**smallbin**ç¯„å›²ã«ã‚ã‚‹å ´åˆ:
1. é©åˆ‡ãªbinã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®smallbiné…åˆ—ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
2. ã“ã®binã«ãƒãƒ£ãƒ³ã‚¯ãŒãªã„å ´åˆã¯ã€æ¬¡ã®ã‚±ãƒ¼ã‚¹ã«é€²ã¿ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒã‚¤ãƒ³ã‚¿`bin`ã¨`bin->bk`ã‚’æ¯”è¼ƒã—ã¦ç¢ºèªã•ã‚Œã¾ã™ã€‚
3. `victim`ã¯`bin->bk`ï¼ˆbinå†…ã®æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ï¼‰ã«ç­‰ã—ããªã‚Šã¾ã™ã€‚NULLã®å ´åˆï¼ˆ`åˆæœŸåŒ–`ä¸­ã«ç™ºç”Ÿï¼‰ã€`malloc_consolidate`ã‚’å‘¼ã³å‡ºã—ã¦ã€ç•°ãªã‚‹binã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã®å®Œå…¨ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
4. ãã‚Œä»¥å¤–ã®å ´åˆã€`victim`ãŒNULLã§ãªã„å ´åˆã¯ã€`victim->bk->fd`ã¨`victim`ãŒç­‰ã—ã„ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ç­‰ã—ããªã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ï¼ˆ`malloc(): smallbin double linked list corrupted`ï¼‰ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ã€‚
5. `victim`ã®æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ€ãƒ–ãƒ«ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã§ã¯ãªããƒ¡ãƒ¢ãƒªå†…ï¼‰ã®ãŸã‚ã«PREV\_INSUSEãƒ“ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
6. ã“ã®ãƒãƒ£ãƒ³ã‚¯ã‚’binãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚
7. `av`ã«å¿œã˜ã¦ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®é©åˆ‡ãªã‚¢ãƒªãƒ¼ãƒŠãƒ“ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
8. `alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¦ã‹ã‚‰ãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
* ã‚µã‚¤ã‚ºãŒsmallbinç¯„å›²ã«ãªã„å ´åˆ:
1. é©åˆ‡ãªbinã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®largebiné…åˆ—ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
2. `av`ã«fastchunksãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã¯ã€`av->flags`ã®`FASTCHUNKS_BIT`ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãã†ã§ã‚ã‚Œã°ã€`av`ã§`malloc_consolidate`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
5. ã¾ã ãƒã‚¤ãƒ³ã‚¿ãŒè¿”ã•ã‚Œã¦ã„ãªã„å ´åˆã€æ¬¡ã®ã„ãšã‚Œã‹ãŒ1ã¤ä»¥ä¸Šã®å ´åˆã‚’ç¤ºã—ã¾ã™:
1. ã‚µã‚¤ã‚ºãŒã€Œfastbinã€ç¯„å›²ã«è©²å½“ã™ã‚‹ãŒã€fastchunkãŒåˆ©ç”¨ã§ããªã„å ´åˆã€‚
2. ã‚µã‚¤ã‚ºãŒã€Œsmallbinã€ç¯„å›²ã«è©²å½“ã™ã‚‹ãŒã€smallchunkãŒåˆ©ç”¨ã§ããªã„å ´åˆï¼ˆåˆæœŸåŒ–ä¸­ã«`malloc_consolidate`ã‚’å‘¼ã³å‡ºã™ï¼‰ã€‚
3. ã‚µã‚¤ã‚ºãŒã€Œlargbinã€ç¯„å›²ã«è©²å½“ã™ã‚‹å ´åˆã€‚
6. æ¬¡ã«ã€**unsorted chunks**ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã€ãƒˆãƒ©ãƒãƒ¼ã‚¹ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒbinã«é…ç½®ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒãƒ£ãƒ³ã‚¯ãŒbinã«é…ç½®ã•ã‚Œã‚‹å”¯ä¸€ã®å ´æ‰€ã§ã™ã€‚unsorted binã‚’'TAIL'ã‹ã‚‰åå¾©å‡¦ç†ã—ã¾ã™ã€‚
1. `victim`ã¯ç¾åœ¨è€ƒæ…®ã•ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¾ã™ã€‚
2. `victim`ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºãŒæœ€å°å€¤ï¼ˆ`2*SIZE_SZ`ï¼‰ã¨æœ€å¤§å€¤ï¼ˆ`av->system_mem`ï¼‰ã®ç¯„å›²å†…ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆ`malloc(): memory corruption`ï¼‰ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ã€‚
3. ï¼ˆè¦æ±‚ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒsmallbinç¯„å›²ã«ã‚ã‚‹ï¼‰ã‹ã¤ï¼ˆ`victim`ãŒæœ€å¾Œã®æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã§ã‚ã‚Šï¼‰ã‹ã¤ï¼ˆunsorted binå†…ã«å”¯ä¸€ã®ãƒãƒ£ãƒ³ã‚¯ã§ã‚ã‚Šï¼‰ã‹ã¤ï¼ˆãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒè¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºä»¥ä¸Šã§ã‚ã‚‹ï¼‰å ´åˆ: **ãƒãƒ£ãƒ³ã‚¯ã‚’2ã¤ã«åˆ†å‰²**ã—ã¾ã™:
* æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã¯è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã«ä¸€è‡´ã—ã€è¿”ã•ã‚Œã¾ã™ã€‚
* æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã¯æ–°ã—ã„æœ€å¾Œã®æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã¨ãªã‚Šã¾ã™ã€‚ã“ã‚Œã¯unsorted binã«å†æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚
1. ä¸¡æ–¹ã®ãƒãƒ£ãƒ³ã‚¯ã®`chunk_size`ã¨`chunk_prev_size`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é©åˆ‡ã«è¨­å®šã—ã¾ã™ã€‚
2. æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã¯`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ãŸå¾Œã«è¿”ã•ã‚Œã¾ã™ã€‚
3. ä¸Šè¨˜ã®æ¡ä»¶ãŒå½ã®å ´åˆã€ã“ã“ã«åˆ¶å¾¡ãŒåˆ°é”ã—ã¾ã™ã€‚`victim`ã‚’unsorted binã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã€‚`victim`ã®ã‚µã‚¤ã‚ºãŒè¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹å ´åˆã¯ã€ã“ã‚Œã‚’è¿”ã—ã¾ã™ï¼ˆ`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ãŸå¾Œï¼‰ã€‚
4. `victim`ã®ã‚µã‚¤ã‚ºãŒsmallbinç¯„å›²ã«ã‚ã‚‹å ´åˆã€ãƒãƒ£ãƒ³ã‚¯ã‚’é©åˆ‡ãªsmallbinã«`HEAD`ã«è¿½åŠ ã—ã¾ã™ã€‚
5. ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€é©åˆ‡ãªlargebinã«æŒ¿å…¥ã—ã€ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸé †åºã‚’ç¶­æŒã—ã¾ã™:
6. æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆæœ€å°ï¼‰ã‚’æœ€åˆã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚`victim`ãŒæœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã‚ˆã‚Šã‚‚å°ã•ã„å ´åˆã€æœ€å¾Œã«æŒ¿å…¥ã—ã¾ã™ã€‚
7. ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€`victim`ã‚ˆã‚Šã‚‚ã‚µã‚¤ã‚ºãŒå¤§ãã„ãƒãƒ£ãƒ³ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ãƒ«ãƒ¼ãƒ—ã—ã¾ã™ã€‚ã‚µã‚¤ã‚ºãŒå®Œå…¨ã«åŒã˜å ´åˆã¯ã€å¸¸ã«2ç•ªç›®ã®ä½ç½®ã«æŒ¿å…¥ã—ã¾ã™ã€‚
8. ã“ã®ã‚¹ãƒ†ãƒƒãƒ—å…¨ä½“ã‚’æœ€å¤§`MAX_ITERS`ï¼ˆ10000ï¼‰å›ã€ã¾ãŸã¯unsorted binå†…ã®ã™ã¹ã¦ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ã„æœãŸã•ã‚Œã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚
7. unsorted chunksã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸå¾Œã€è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºãŒsmallbinç¯„å›²ã«ãªã„å ´åˆã¯ã€**largebins**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
1. é©åˆ‡ãªbinã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®largebiné…åˆ—ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
2. æœ€å¤§ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆbinå†…ã®æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ï¼‰ã®ã‚µã‚¤ã‚ºãŒè¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã‚ˆã‚Šã‚‚å¤§ãã„å ´åˆ:
1. 'TAIL'ã‹ã‚‰ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆã—ã¦ã€è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºä»¥ä¸Šã®æœ€å°ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆ`victim`ï¼‰ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚
2. `unlink`ã‚’å‘¼ã³å‡ºã—ã¦ã€binã‹ã‚‰`victim`ãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
3. `victim`ã®ãƒãƒ£ãƒ³ã‚¯ã®`remainder_size`ã‚’è¨ˆç®—ã—ã¾ã™ï¼ˆã“ã‚Œã¯`victim`ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º - è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã«ãªã‚Šã¾ã™ï¼‰ã€‚
4. ã“ã®`remainder_size`ãŒ`MINSIZE`ï¼ˆãƒ˜ãƒƒãƒ€ã‚’å«ã‚€æœ€å°ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºï¼‰ä»¥ä¸Šã§ã‚ã‚Œã°ã€ãƒãƒ£ãƒ³ã‚¯ã‚’2ã¤ã«åˆ†å‰²ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã€å…¨ä½“ã®`victim`ãƒãƒ£ãƒ³ã‚¯ãŒè¿”ã•ã‚Œã¾ã™ã€‚æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã‚’unsorted binã«æŒ¿å…¥ã—ã¾ã™ï¼ˆ'TAIL'ã®æœ«å°¾ã«ï¼‰ã€‚unsorted binã§`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ï¼ˆ"malloc(): corrupted unsorted chunks"ï¼‰ã€‚
5. `victim`ãƒãƒ£ãƒ³ã‚¯ã‚’`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¦ã‹ã‚‰è¿”ã—ã¾ã™ã€‚
8. ã“ã‚Œã¾ã§ã«unsorted binã¨ãã‚Œã«å¯¾å¿œã™ã‚‹fastã€smallã€ã¾ãŸã¯large binã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸã€‚è¦æ±‚ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®**æ­£ç¢ºãª**ã‚µã‚¤ã‚ºã§å˜ä¸€ã®binï¼ˆfastã¾ãŸã¯smallï¼‰ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ã™ã¹ã¦ã®binãŒä½¿ã„æœãŸã•ã‚Œã‚‹ã¾ã§ä»¥ä¸‹ã®æ‰‹é †ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™:
1. biné…åˆ—ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¢—ã‚„ã—ã¦ã€æ¬¡ã®binã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
2. ç©ºã®binã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã«`av->binmap`ãƒãƒƒãƒ—ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
3. `victim`ã‚’ç¾åœ¨ã®binã®'TAIL'ã«æŒ‡ã—ã¾ã™ã€‚
4. binmapã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€binãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆï¼ˆä¸Šè¨˜ã®2ç•ªç›®ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ï¼‰ã€ãã‚Œã¯ç¢ºå®Ÿã«ç©ºã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ãŸã ã—ã€ã™ã¹ã¦ã®ç©ºã®binãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨ã¯ä¿è¨¼ã—ã¾ã›ã‚“ã€‚victimãŒç©ºã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ç©ºã®å ´åˆã¯ã€å†åº¦binã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ä¸Šè¨˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ï¼ˆã¾ãŸã¯ã“ã®ãƒ«ãƒ¼ãƒ—ã‚’ã€Œç¶™ç¶šã€ã—ã¾ã™ï¼‰ã€‚
5. ãƒãƒ£ãƒ³ã‚¯ã‚’åˆ†å‰²ã—ã¾ã™ï¼ˆ`victim`ã¯ç©ºã§ãªã„binã®æœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¾ã™ï¼‰ã€‚æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã‚’unsorted binã«æŒ¿å…¥ã—ã¾ã™ï¼ˆ'TAIL'ã®æœ«å°¾ã«ï¼‰ã€‚unsorted binã§`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ï¼ˆ"malloc(): corrupted unsorted chunks 2"ï¼‰ã€‚
6. `victim`ãƒãƒ£ãƒ³ã‚¯ã‚’`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¦ã‹ã‚‰è¿”ã—ã¾ã™ã€‚
9. ã¾ã ç©ºã®binãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€'top'ãƒãƒ£ãƒ³ã‚¯ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™:
1. `victim`ã¯`av->top`ã‚’æŒ‡ã—ã¾ã™ã€‚
2. 'top'ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ'requested size' + `MINSIZE`ã‚ˆã‚Šã‚‚å¤§ãã„å ´åˆã€ãã‚Œã‚’2ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²ã—ã¾ã™ã€‚ã“ã®å ´åˆã€æ®‹ã‚Šã®ãƒãƒ£ãƒ³ã‚¯ã¯æ–°ã—ã„'top'ãƒãƒ£ãƒ³ã‚¯ã¨ãªã‚Šã€ä»–ã®ãƒãƒ£ãƒ³ã‚¯ã¯`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã•ã‚Œã¾ã™ã€‚
3. `av`ã«fastchunksãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã¯ã€`av->flags`ã®`FASTCHUNKS_BIT`ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãã†ã§ã‚ã‚Œã°ã€`av`ã§`malloc_consolidate`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã‚¹ãƒ†ãƒƒãƒ—6ï¼ˆunsorted binã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å ´æ‰€ï¼‰ã«æˆ»ã‚Šã¾ã™ã€‚
4. `av`ã«fastchunksãŒãªã„å ´åˆã€`sysmalloc`ã‚’å‘¼ã³å‡ºã—ã¦ã€`alloc_perturb`ã‚’å‘¼ã³å‡ºã—ã¦å¾—ã‚‰ã‚ŒãŸãƒã‚¤ãƒ³ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
## ãƒ•ãƒªãƒ¼ãƒ•ãƒ­ãƒ¼

{% hint style="success" %}
(ã“ã®èª¬æ˜ã¯[https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚TODO: æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦æ›´æ–°ã™ã‚‹)
{% endhint %}

ãƒ¡ãƒ¢ãƒªã®ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹æœ€çµ‚é–¢æ•°ã¯ `_int_free (mstate av, mchunkptr p, int have_lock)` ã§ã™ï¼š

1. `p` ãŒãƒ¡ãƒ¢ãƒªå†…ã® `p + chunksize(p)` ã‚ˆã‚Šå‰ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼ˆãƒ©ãƒƒãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`free(): invalid pointer`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
2. ãƒãƒ£ãƒ³ã‚¯ãŒå°‘ãªãã¨ã‚‚ `MINSIZE` ã¾ãŸã¯ `MALLOC_ALIGNMENT` ã®å€æ•°ã®ã‚µã‚¤ã‚ºã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`free(): invalid size`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
3. ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ fastbin ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹å ´åˆï¼š
1. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒæœ€å°ã‚µã‚¤ã‚ºã¨æœ€å¤§ã‚µã‚¤ã‚º (`av->system_mem`) ã®é–“ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`free(): invalid next size (fast)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
2. ãƒãƒ£ãƒ³ã‚¯ã« `free_perturb` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
3. `av` ã®ãŸã‚ã« `FASTCHUNKS_BIT` ã‚’è¨­å®šã—ã¾ã™ã€‚
4. ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ fastbin é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚
5. ãƒã‚¤ãƒŠãƒªã®ãƒˆãƒƒãƒ—ãŒè¿½åŠ ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`double free or corruption (fasttop)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
6. ãƒã‚¤ãƒŠãƒªã®ãƒˆãƒƒãƒ—ã«ã‚ã‚‹ fastbin ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒè¿½åŠ ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã¨åŒã˜ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`invalid fastbin entry (free)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
7. ãƒãƒ£ãƒ³ã‚¯ã‚’ fastbin ãƒªã‚¹ãƒˆã®ãƒˆãƒƒãƒ—ã«æŒ¿å…¥ã—ã¦è¿”ã—ã¾ã™ã€‚
4. ãƒãƒ£ãƒ³ã‚¯ãŒ mmapped ã•ã‚Œã¦ã„ãªã„å ´åˆï¼š
1. ãƒãƒ£ãƒ³ã‚¯ãŒãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ã¯ã„ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ (`double free or corruption (top)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
2. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ãŒã‚¢ãƒªãƒ¼ãƒŠã®å¢ƒç•Œå†…ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`double free or corruption (out)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
3. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ã®å‰ã®ä½¿ç”¨ãƒ“ãƒƒãƒˆãŒãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`double free or corruption (!prev)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
4. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒæœ€å°ã‚µã‚¤ã‚ºã¨æœ€å¤§ã‚µã‚¤ã‚º (`av->system_mem`) ã®é–“ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ (`free(): invalid next size (normal)`) ãŒç™ºç”Ÿã—ã¾ã™ã€‚
5. ãƒãƒ£ãƒ³ã‚¯ã« `free_perturb` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
6. å‰ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã€å‰ã®ãƒãƒ£ãƒ³ã‚¯ã« `unlink` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
7. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ãŒãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã§ãªã„å ´åˆï¼š
1. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã« `unlink` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
2. ãƒãƒ£ãƒ³ã‚¯ã‚’å‰ã®ãƒãƒ£ãƒ³ã‚¯ã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ã¨ãƒãƒ¼ã‚¸ã—ã€ç©ºããŒã‚ã‚Œã°æœªæ•´åˆ—ãƒã‚¤ãƒŠãƒªã®å…ˆé ­ã«è¿½åŠ ã—ã¾ã™ã€‚æŒ¿å…¥ã™ã‚‹å‰ã«ã€`unsorted_chunks(av)->fd->bk == unsorted_chunks(av)` ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ ("free(): corrupted unsorted chunks") ãŒç™ºç”Ÿã—ã¾ã™ã€‚
8. æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ãŒãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã ã£ãŸå ´åˆã€é©åˆ‡ã«ãƒãƒ£ãƒ³ã‚¯ã‚’å˜ä¸€ã®ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚
5. ãƒãƒ£ãƒ³ã‚¯ãŒ mmapped ã•ã‚Œã¦ã„ãŸå ´åˆã€`munmap_chunk` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

## ãƒ’ãƒ¼ãƒ—é–¢æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

ãƒ’ãƒ¼ãƒ—å†…ã§é »ç¹ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèªã—ã¾ã™:

{% content-ref url="heap-functions-security-checks.md" %}
[heap-functions-security-checks.md](heap-functions-security-checks.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/](https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/)
* [https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/](https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/)
* [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„** ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„** å ´åˆã¯ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹** ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ãã ã•ã„

</details>
