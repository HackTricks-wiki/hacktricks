# ãƒ“ãƒ³ã¨ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong>ã§ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

- **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)** ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ ã§ **@hacktricks\_live** ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰**ã™ã‚‹ã«ã¯ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹

</details>

## åŸºæœ¬æƒ…å ±

ãƒãƒ£ãƒ³ã‚¯ã®æ ¼ç´åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€å„ãƒãƒ£ãƒ³ã‚¯ã¯1ã¤ã®ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã«ã ã‘ã§ã¯ãªãã€è¤‡æ•°ã®ã‚¿ã‚¤ãƒ—ãŒå­˜åœ¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒ“ãƒ³ã§ã‚ã‚Šã€5ç¨®é¡ã®ãƒ“ãƒ³ãŒã‚ã‚Šã¾ã™: [62](https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=6e766d11bc85b6480fa5c9f2a76559f8acf9deb5;hb=HEAD#l1407) small binsã€63 large binsã€1 unsorted binã€10 fast binsã€ãŠã‚ˆã³ã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã«64å€‹ã®tcache binsãŒã‚ã‚Šã¾ã™ã€‚

å„æœªæ•´åˆ—ã€smallã€large binsã¸ã®åˆæœŸã‚¢ãƒ‰ãƒ¬ã‚¹ã¯åŒã˜é…åˆ—å†…ã«ã‚ã‚Šã¾ã™ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ã¯æœªä½¿ç”¨ã§ã€1ã¯æœªæ•´åˆ—ãƒ“ãƒ³ã€2ã€œ64ã¯small binsã€65ã€œ127ã¯large binsã§ã™ã€‚

### Tcacheï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã”ã¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰Bins

ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ç‹¬è‡ªã®ãƒ’ãƒ¼ãƒ—ã‚’æŒã¨ã†ã¨ã—ã¾ã™ãŒï¼ˆ[Arenas](bins-and-memory-allocations.md#arenas)ãŠã‚ˆã³[Subheaps](bins-and-memory-allocations.md#subheaps)ã‚’å‚ç…§ï¼‰ã€å¤šãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æŒã¤ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆWebã‚µãƒ¼ãƒãƒ¼ãªã©ï¼‰ã®å ´åˆã€**ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãƒ’ãƒ¼ãƒ—ã‚’å…±æœ‰ã™ã‚‹å¯èƒ½æ€§**ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€ä¸»ãªè§£æ±ºç­–ã¯ **ãƒ­ãƒƒã‚«ãƒ¼**ã®ä½¿ç”¨ã§ã‚ã‚Šã€ã“ã‚Œã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ **è‘—ã—ãé…ãã™ã‚‹å¯èƒ½æ€§**ãŒã‚ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€tcacheã¯ã€ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒãƒ¼ã‚¸ã—ãªã„ **å˜æ–¹å‘ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆ**ã§ã‚ã‚Šã€å„ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¯ **64å€‹ã®å˜æ–¹å‘ãƒªãƒ³ã‚¯tcache bins** ãŒã‚ã‚Šã¾ã™ã€‚å„ãƒ“ãƒ³ã«ã¯ã€[64ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯24ã€œ1032Bã€32ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã§ã¯12ã€œ516B](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l315)ã® [åŒã˜ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯7å€‹](https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l323) ãŒå«ã¾ã‚Œã¾ã™ã€‚

ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹ã¨ãã€ãã‚ŒãŒtcacheã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã«ã¯ **å¤§ãã™ããªã„** ã“ã¨ã¨ã€å¯¾å¿œã™ã‚‹tcache binãŒ **æº€æ¯ã§ãªã„**ï¼ˆã™ã§ã«7ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ï¼‰ã“ã¨ãŒå¿…è¦ã§ã™ã€‚tcacheã«ç§»å‹•ã§ããªã„å ´åˆã¯ã€ãƒ’ãƒ¼ãƒ—ãƒ­ãƒƒã‚¯ã‚’å¾…ã£ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ“ãƒ³ã§è§£æ”¾æ“ä½œã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨ãã€å¿…è¦ãªã‚µã‚¤ã‚ºã®ç©ºããƒãƒ£ãƒ³ã‚¯ãŒ **Tcacheã«ã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨**ã—ã€ãã†ã§ãªã„å ´åˆã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ“ãƒ³ã§è¦‹ã¤ã‘ã‚‹ã‹æ–°ã—ã„ã‚‚ã®ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ãƒ’ãƒ¼ãƒ—ãƒ­ãƒƒã‚¯ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã¾ãŸã€ã“ã®å ´åˆã®æœ€é©åŒ–ãŒã‚ã‚Šã€ãƒ’ãƒ¼ãƒ—ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹é–“ã«ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¯è¦æ±‚ã•ã‚ŒãŸã‚µã‚¤ã‚ºã®ãƒ’ãƒ¼ãƒ—ãƒãƒ£ãƒ³ã‚¯ï¼ˆ7ã¤ï¼‰ã§Tcacheã‚’åŸ‹ã‚ã‚‹ãŸã‚ã€å¿…è¦ãªå ´åˆã¯Tcacheã§ãã‚Œã‚‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<details>

<summary>tcacheãƒãƒ£ãƒ³ã‚¯ã®ä¾‹ã‚’è¿½åŠ </summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunk;
chunk = malloc(24);
printf("Address of the chunk: %p\n", (void *)chunk);
gets(chunk);
free(chunk);
return 0;
}
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã€main é–¢æ•°ã® ret ã‚ªãƒšã‚³ãƒ¼ãƒ‰ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ã¾ã™ã€‚ãã®å¾Œã€gef ã‚’ä½¿ç”¨ã—ã¦ tcache bin ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã‚’ç¢ºèªã§ãã¾ã™:
```bash
gefâ¤  heap bins
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for thread 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tcachebins[idx=0, size=0x20, count=1] â†  Chunk(addr=0xaaaaaaac12a0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
```
#### Tcacheã®æ§‹é€ ä½“ã¨é–¢æ•°

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€**max bins**ã¨**chunks per index**ã€**`tcache_entry`**æ§‹é€ ä½“ãŒäºŒé‡è§£æ”¾ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¦ãŠã‚Šã€**`tcache_perthread_struct`**ã¯å„ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãƒ“ãƒ³ã®å„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹æ§‹é€ ä½“ã§ã™ã€‚

<details>

<summary><code>tcache_entry</code>ã¨<code>tcache_perthread_struct</code></summary>
```c
// From https://github.com/bminor/glibc/blob/f942a732d37a96217ef828116ebe64a644db18d7/malloc/malloc.c

/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */
# define TCACHE_MAX_BINS		64
# define MAX_TCACHE_SIZE	tidx2usize (TCACHE_MAX_BINS-1)

/* Only used to pre-fill the tunables.  */
# define tidx2usize(idx)	(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)

/* When "x" is from chunksize().  */
# define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)
/* When "x" is a user-provided size.  */
# define usize2tidx(x) csize2tidx (request2size (x))

/* With rounding and alignment, the bins are...
idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)
idx 1   bytes 25..40 or 13..20
idx 2   bytes 41..56 or 21..28
etc.  */

/* This is another arbitrary limit, which tunables can change.  Each
tcache bin will hold at most this number of chunks.  */
# define TCACHE_FILL_COUNT 7

/* Maximum chunks in tcache bins for tunables.  This value must fit the range
of tcache->counts[] entries, else they may overflow.  */
# define MAX_TCACHE_COUNT UINT16_MAX

[...]

typedef struct tcache_entry
{
struct tcache_entry *next;
/* This field exists to detect double frees.  */
uintptr_t key;
} tcache_entry;

/* There is one of these for each thread, which contains the
per-thread cache (hence "tcache_perthread_struct").  Keeping
overall size low is mildly important.  Note that COUNTS and ENTRIES
are redundant (we could have just counted the linked list each
time), this is for performance reasons.  */
typedef struct tcache_perthread_struct
{
uint16_t counts[TCACHE_MAX_BINS];
tcache_entry *entries[TCACHE_MAX_BINS];
} tcache_perthread_struct;
```
</details>

`__tcache_init` é–¢æ•°ã¯ã€`tcache_perthread_struct` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆãŠã‚ˆã³å‰²ã‚Šå½“ã¦ã‚‹é–¢æ•°ã§ã™ã€‚

<details>

<summary>tcache_init ã‚³ãƒ¼ãƒ‰</summary>
```c
// From https://github.com/bminor/glibc/blob/f942a732d37a96217ef828116ebe64a644db18d7/malloc/malloc.c#L3241C1-L3274C2

static void
tcache_init(void)
{
mstate ar_ptr;
void *victim = 0;
const size_t bytes = sizeof (tcache_perthread_struct);

if (tcache_shutting_down)
return;

arena_get (ar_ptr, bytes);
victim = _int_malloc (ar_ptr, bytes);
if (!victim && ar_ptr != NULL)
{
ar_ptr = arena_get_retry (ar_ptr, bytes);
victim = _int_malloc (ar_ptr, bytes);
}


if (ar_ptr != NULL)
__libc_lock_unlock (ar_ptr->mutex);

/* In a low memory situation, we may not be able to allocate memory
- in which case, we just keep trying later.  However, we
typically do this very early, so either there is sufficient
memory, or there isn't enough memory to do non-trivial
allocations anyway.  */
if (victim)
{
tcache = (tcache_perthread_struct *) victim;
memset (tcache, 0, sizeof (tcache_perthread_struct));
}

}
```
</details>

### ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³

ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã¯ã€**å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã®ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’é«˜é€ŸåŒ–**ã™ã‚‹ãŸã‚ã«ã€æœ€è¿‘è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹æ§‹é€ ã«ä¿æŒã™ã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ“ãƒ³ã¯ã€æœ€å¾Œã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒå†åˆ©ç”¨ã•ã‚Œã‚‹ãŸã‚ã€æœ€æ–°ã®è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒæ–°ã—ã„å‰²ã‚Šå½“ã¦è¦æ±‚ãŒã‚ã‚‹ã¨ãã«æœ€åˆã«å†åˆ©ç”¨ã•ã‚Œã‚‹ã¨ã„ã†Last-In, First-Outï¼ˆLIFOï¼‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®å‹•ä½œã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆLIFOï¼‰ã®å…ˆé ­ã«æŒ¿å…¥ãŠã‚ˆã³å‰Šé™¤ã™ã‚‹é€Ÿåº¦ãŒã€ã‚­ãƒ¥ãƒ¼ï¼ˆFIFOï¼‰ã‚ˆã‚Šã‚‚é€Ÿã„ãŸã‚ã€é€Ÿåº¦ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚

ã•ã‚‰ã«ã€**ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ã¯å˜æ–¹å‘ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨**ã—ã¦ãŠã‚Šã€ãƒ€ãƒ–ãƒ«ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã§ã¯ãªã„ãŸã‚ã€ã•ã‚‰ã«é€Ÿåº¦ãŒå‘ä¸Šã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³å†…ã®ãƒãƒ£ãƒ³ã‚¯ã¯éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã•ã‚Œãªã„ãŸã‚ã€ä¸­å¤®ã‹ã‚‰ã®å‰Šé™¤ã‚’è¨±å¯ã™ã‚‹è¤‡é›‘ãªæ§‹é€ ã¯ä¸è¦ã§ã™ã€‚å˜æ–¹å‘ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã¯ã€ã“ã‚Œã‚‰ã®æ“ä½œã«å¯¾ã—ã¦ã‚ˆã‚Šå˜ç´”ã§è¿…é€Ÿã§ã™ã€‚

åŸºæœ¬çš„ã«ã€ã“ã“ã§èµ·ã“ã‚‹ã“ã¨ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã®ãƒã‚¤ãƒ³ã‚¿ï¼‰ãŒå¸¸ã«ãã®ã‚µã‚¤ã‚ºã®æœ€æ–°ã®è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ã—ãŸãŒã£ã¦ï¼š

- ãã®ã‚µã‚¤ã‚ºã®æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ä½¿ç”¨ã™ã‚‹ç©ºããƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚ã“ã®ç©ºããƒãƒ£ãƒ³ã‚¯ãŒæ¬¡ã«ä½¿ç”¨ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¿å­˜ã•ã‚Œã€æ¬¡ã®å‰²ã‚Šå½“ã¦ãŒã©ã“ã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã™ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€ç©ºããƒãƒ£ãƒ³ã‚¯ã¯ç¾åœ¨ã®åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã—ã€ã“ã®æ–°ã—ãè§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã®æœ€å¤§ã‚µã‚¤ã‚ºã¯`0x80`ã§ã‚ã‚Šã€`0x20-0x2f`ã®ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹`0`ã«ã€`0x30-0x3f`ã®ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹`1`ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

{% hint style="danger" %}
ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³å†…ã®ãƒãƒ£ãƒ³ã‚¯ã¯åˆ©ç”¨å¯èƒ½ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€å‘¨å›²ã®ä»–ã®ç©ºããƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã§ãã‚‹ä»£ã‚ã‚Šã«ã€ä¸€å®šæ™‚é–“ãƒ•ã‚¡ã‚¹ãƒˆãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦ä¿æŒã•ã‚Œã¾ã™ã€‚
{% endhint %}
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711

/*
Fastbins

An array of lists holding recently freed small chunks.  Fastbins
are not doubly linked.  It is faster to single-link them, and
since chunks are never removed from the middles of these lists,
double linking is not necessary. Also, unlike regular bins, they
are not even processed in FIFO order (they use faster LIFO) since
ordering doesn't much matter in the transient contexts in which
fastbins are normally used.

Chunks in fastbins keep their inuse bit set, so they cannot
be consolidated with other free chunks. malloc_consolidate
releases all chunks in fastbins and consolidates them with
other free chunks.
*/

typedef struct malloc_chunk *mfastbinptr;
#define fastbin(ar_ptr, idx) ((ar_ptr)->fastbinsY[idx])

/* offset 2 to use otherwise unindexable first 2 bins */
#define fastbin_index(sz) \
((((unsigned int) (sz)) >> (SIZE_SZ == 8 ? 4 : 3)) - 2)


/* The maximum fastbin request size we support */
#define MAX_FAST_SIZE     (80 * SIZE_SZ / 4)

#define NFASTBINS  (fastbin_index (request2size (MAX_FAST_SIZE)) + 1)
```
<details>

<summary>é«˜é€Ÿãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ã®ä¾‹ã‚’è¿½åŠ </summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[8];
int i;

// Loop to allocate memory 8 times
for (i = 0; i < 8; i++) {
chunks[i] = malloc(24);
if (chunks[i] == NULL) { // Check if malloc failed
fprintf(stderr, "Memory allocation failed at iteration %d\n", i);
return 1;
}
printf("Address of chunk %d: %p\n", i, (void *)chunks[i]);
}

// Loop to free the allocated memory
for (i = 0; i < 8; i++) {
free(chunks[i]);
}

return 0;
}
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚åŒã˜ã‚µã‚¤ã‚ºã®8ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¦è§£æ”¾ã™ã‚‹æ–¹æ³•ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€tcacheãŒåŸ‹ã¾ã‚Šã€8ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒfastãƒãƒ£ãƒ³ã‚¯ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã€mainé–¢æ•°ã®retã‚ªãƒšã‚³ãƒ¼ãƒ‰ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ã¾ã™ã€‚ãã®å¾Œã€gefã‚’ä½¿ç”¨ã—ã¦ã€tcache binãŒåŸ‹ã¾ã‚Šã€1ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒfast binã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã®ãŒè¦‹ãˆã¾ã™ã€‚
```bash
gefâ¤  heap bins
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for thread 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tcachebins[idx=0, size=0x20, count=7] â†  Chunk(addr=0xaaaaaaac1770, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1750, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1730, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1710, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac16f0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac16d0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac12a0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fastbins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Fastbins[idx=0, size=0x20]  â†  Chunk(addr=0xaaaaaaac1790, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
Fastbins[idx=1, size=0x30] 0x00
```
</details>

### Unsorted bin

æœªæ•´åˆ—ã®ãƒ“ãƒ³ã¯ã€ãƒ’ãƒ¼ãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’è¿…é€Ÿã«è¡Œã†ãŸã‚ã«ä½¿ç”¨ã™ã‚‹**ã‚­ãƒ£ãƒƒã‚·ãƒ¥**ã§ã™ã€‚å‹•ä½œæ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼šãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹ã¨ã€ã“ã®ãƒãƒ£ãƒ³ã‚¯ãŒtcacheã‚„fast binã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œãšã€ã‹ã¤ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¨è¡çªã—ã¦ã„ãªã„å ´åˆã€ãƒ’ãƒ¼ãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¯ãã‚Œã‚’ã™ãã«ç‰¹å®šã®å°ã•ãªãƒ“ãƒ³ã‚„å¤§ããªãƒ“ãƒ³ã«é…ç½®ã—ã¾ã›ã‚“ã€‚ä»£ã‚ã‚Šã«ã€éš£æ¥ã™ã‚‹ç©ºããƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã—ã¦ã‚ˆã‚Šå¤§ããªç©ºããƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ãã®å¾Œã€ã“ã®æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’ã€Œæœªæ•´åˆ—ã®ãƒ“ãƒ³ã€ã¨å‘¼ã°ã‚Œã‚‹ä¸€èˆ¬çš„ãªãƒ“ãƒ³ã«é…ç½®ã—ã¾ã™ã€‚

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ**ãƒ¡ãƒ¢ãƒªã‚’è¦æ±‚**ã™ã‚‹ã¨ã€ãƒ’ãƒ¼ãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¯æœªæ•´åˆ—ã®ãƒ“ãƒ³ã‚’**ãƒã‚§ãƒƒã‚¯**ã—ã¦ååˆ†ãªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚è¦‹ã¤ã‹ã‚Œã°ã™ãã«ä½¿ç”¨ã—ã¾ã™ã€‚æœªæ•´åˆ—ã®ãƒ“ãƒ³ã«é©åˆ‡ãªãƒãƒ£ãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã“ã®ãƒªã‚¹ãƒˆå†…ã®ã™ã¹ã¦ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ã€ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ãã‚Œãã‚Œã®ãƒ“ãƒ³ï¼ˆå°ã•ãªãƒ“ãƒ³ã¾ãŸã¯å¤§ããªãƒ“ãƒ³ï¼‰ã«ç§»å‹•ã—ã¾ã™ã€‚

å¤§ããªãƒãƒ£ãƒ³ã‚¯ãŒ2ã¤ã®ãƒãƒ¼ãƒ•ã«åˆ†å‰²ã•ã‚Œã€æ®‹ã‚ŠãŒMINSIZEã‚ˆã‚Šå¤§ãã„å ´åˆã€ãã‚Œã¯æœªæ•´åˆ—ã®ãƒ“ãƒ³ã«æˆ»ã•ã‚Œã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€æœªæ•´åˆ—ã®ãƒ“ãƒ³ã¯ã€æœ€è¿‘è§£æ”¾ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã‚’è¿…é€Ÿã«å†åˆ©ç”¨ã—ã€æ™‚é–“ã®ã‹ã‹ã‚‹æ¤œç´¢ã¨ãƒãƒ¼ã‚¸ã®å¿…è¦æ€§ã‚’æ¸›ã‚‰ã™ã“ã¨ã§ãƒ¡ãƒ¢ãƒªå‰²ã‚Šå½“ã¦ã‚’é«˜é€ŸåŒ–ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

{% hint style="danger" %}
ç•°ãªã‚‹ã‚«ãƒ†ã‚´ãƒªã®ãƒãƒ£ãƒ³ã‚¯ã§ã‚ã£ã¦ã‚‚ã€åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ãŒä»–ã®åˆ©ç”¨å¯èƒ½ãªãƒãƒ£ãƒ³ã‚¯ã¨è¡çªã—ã¦ã„ã‚‹å ´åˆï¼ˆå…ƒã€…ç•°ãªã‚‹ãƒ“ãƒ³ã«å±ã—ã¦ã„ã¦ã‚‚ï¼‰ã€ãã‚Œã‚‰ã¯ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚
{% endhint %}

<details>

<summary>æœªæ•´åˆ—ã®ãƒãƒ£ãƒ³ã‚¯ã®ä¾‹ã‚’è¿½åŠ </summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[9];
int i;

// Loop to allocate memory 8 times
for (i = 0; i < 9; i++) {
chunks[i] = malloc(0x100);
if (chunks[i] == NULL) { // Check if malloc failed
fprintf(stderr, "Memory allocation failed at iteration %d\n", i);
return 1;
}
printf("Address of chunk %d: %p\n", i, (void *)chunks[i]);
}

// Loop to free the allocated memory
for (i = 0; i < 8; i++) {
free(chunks[i]);
}

return 0;
}
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚åŒã˜ã‚µã‚¤ã‚ºã®9ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¦è§£æ”¾ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**tcacheãŒåŸ‹ã¾ã‚Š**ã€8ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã¯**fastbinã«ã¯å¤§ãã™ãã‚‹ãŸã‚ã€unsorted binã«æ ¼ç´**ã•ã‚Œã€9ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã¯è§£æ”¾ã•ã‚Œãªã„ãŸã‚ã€9ç•ªç›®ã¨8ç•ªç›®ã¯**ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã•ã‚Œãªã„**ã€‚

ãã‚Œã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã€mainé–¢æ•°ã®retã‚ªãƒ—ã‚³ãƒ¼ãƒ‰ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ã¾ã™ã€‚ãã®å¾Œã€gefã‚’ä½¿ç”¨ã—ã¦ã€tcache binãŒåŸ‹ã¾ã‚Šã€unsorted binã«1ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ã®ãŒè¦‹ãˆã¾ã™ã€‚
```bash
gefâ¤  heap bins
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for thread 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tcachebins[idx=15, size=0x110, count=7] â†  Chunk(addr=0xaaaaaaac1d10, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1c00, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1af0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac19e0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac18d0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac17c0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac12a0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fastbins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unsorted Bin for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[+] unsorted_bins[0]: fw=0xaaaaaaac1e10, bk=0xaaaaaaac1e10
â†’   Chunk(addr=0xaaaaaaac1e20, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in unsorted bin.
```
</details>

### Small Bins

Small binsã¯large binsã‚ˆã‚Šã‚‚é€Ÿãã€fast binsã‚ˆã‚Šã‚‚é…ã„ã§ã™ã€‚

62ã®å„binã«ã¯**åŒã˜ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯**ãŒã‚ã‚Šã¾ã™: 16, 24, ... (32ãƒ“ãƒƒãƒˆã§ã¯æœ€å¤§504ãƒã‚¤ãƒˆã€64ãƒ“ãƒƒãƒˆã§ã¯1024ãƒã‚¤ãƒˆ)ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç©ºé–“ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã¹ãbinã‚’è¦‹ã¤ã‘ã‚‹é€Ÿåº¦ã‚„ã€ã“ã‚Œã‚‰ã®ãƒªã‚¹ãƒˆã¸ã®ã‚¨ãƒ³ãƒˆãƒªã®æŒ¿å…¥ã¨å‰Šé™¤ãŒå‘ä¸Šã—ã¾ã™ã€‚

ã“ã‚ŒãŒsmall binã®ã‚µã‚¤ã‚ºãŒbinã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦ã©ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã‚‹ã‹ã§ã™:

* æœ€å°ã‚µã‚¤ã‚º: 2\*4\*index (ä¾‹: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹5 -> 40)
* æœ€å¤§ã‚µã‚¤ã‚º: 2\*8\*index (ä¾‹: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹5 -> 80)
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711
#define NSMALLBINS         64
#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT
#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT > CHUNK_HDR_SZ)
#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)

#define in_smallbin_range(sz)  \
((unsigned long) (sz) < (unsigned long) MIN_LARGE_SIZE)

#define smallbin_index(sz) \
((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) >> 4) : (((unsigned) (sz)) >> 3))\
+ SMALLBIN_CORRECTION)
```
### Function to choose between small and large bins:

### å°ã•ãªãƒ“ãƒ³ã¨å¤§ããªãƒ“ãƒ³ã®é–“ã‚’é¸æŠã™ã‚‹ãŸã‚ã®é–¢æ•°:
```c
#define bin_index(sz) \
((in_smallbin_range (sz)) ? smallbin_index (sz) : largebin_index (sz))
```
<details>

<summary>å°ã•ãªãƒãƒ£ãƒ³ã‚¯ã®ä¾‹ã‚’è¿½åŠ </summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[10];
int i;

// Loop to allocate memory 8 times
for (i = 0; i < 9; i++) {
chunks[i] = malloc(0x100);
if (chunks[i] == NULL) { // Check if malloc failed
fprintf(stderr, "Memory allocation failed at iteration %d\n", i);
return 1;
}
printf("Address of chunk %d: %p\n", i, (void *)chunks[i]);
}

// Loop to free the allocated memory
for (i = 0; i < 8; i++) {
free(chunks[i]);
}

chunks[9] = malloc(0x110);

return 0;
}
```
9ã¤ã®åŒã˜ã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã¦è§£æ”¾ã™ã‚‹æ–¹æ³•ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãã‚Œã‚‰ãŒ**tcacheã‚’åŸ‹ã‚ã‚‹**ã‚ˆã†ã«ãªã‚Šã€8ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã¯**fastbinã«ã¯å¤§ãã™ãã‚‹**ãŸã‚ã€unsorted binã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚9ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã¯è§£æ”¾ã•ã‚Œãªã„ãŸã‚ã€9ç•ªç›®ã¨8ç•ªç›®ã¯**ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¨ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã›ã‚“**ã€‚ãã®å¾Œã€0x110ã®å¤§ããªãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ã€**unsorted binã®ãƒãƒ£ãƒ³ã‚¯ãŒsmall binã«ç§»å‹•**ã—ã¾ã™ã€‚

ãã‚Œã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã€mainé–¢æ•°ã®retã‚ªãƒšã‚³ãƒ¼ãƒ‰ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ã¾ã™ã€‚ãã®å¾Œã€gefã‚’ä½¿ç”¨ã—ã¦ã€tcache binãŒåŸ‹ã¾ã‚Šã€small binã«1ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ã®ãŒè¦‹ãˆã¾ã™ã€‚
```bash
gefâ¤  heap bins
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for thread 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tcachebins[idx=15, size=0x110, count=7] â†  Chunk(addr=0xaaaaaaac1d10, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1c00, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac1af0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac19e0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac18d0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac17c0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  Chunk(addr=0xaaaaaaac12a0, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fastbins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unsorted Bin for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[+] Found 0 chunks in unsorted bin.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Small Bins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[+] small_bins[16]: fw=0xaaaaaaac1e10, bk=0xaaaaaaac1e10
â†’   Chunk(addr=0xaaaaaaac1e20, size=0x110, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in 1 small non-empty bins.
```
</details>

### ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³

å°ã•ãªãƒ“ãƒ³ãŒå›ºå®šã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ã‚’ç®¡ç†ã™ã‚‹ã®ã«å¯¾ã—ã€**å„ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã¯ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®ç¯„å›²ã‚’æ‰±ã„ã¾ã™**ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ãŒ**ã•ã¾ã–ã¾ãªã‚µã‚¤ã‚º**ã‚’åˆ¥ã€…ã®ãƒ“ãƒ³ãªã—ã§åå®¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ãƒ¡ãƒ¢ãƒªã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ãƒ¼ã§ã¯ã€ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã¯å°ã•ãªãƒ“ãƒ³ã®çµ‚ã‚ã‚Šã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã®ç¯„å›²ã¯å¾ã€…ã«å¤§ãããªã‚Šã€æœ€åˆã®ãƒ“ãƒ³ã¯512ã‹ã‚‰576ãƒã‚¤ãƒˆã®ãƒãƒ£ãƒ³ã‚¯ã‚’ã‚«ãƒãƒ¼ã—ã€æ¬¡ã®ãƒ“ãƒ³ã¯576ã‹ã‚‰640ãƒã‚¤ãƒˆã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç¶šãã€æœ€å¤§ã®ãƒ“ãƒ³ã«ã¯1MBã‚’è¶…ãˆã‚‹ã™ã¹ã¦ã®ãƒãƒ£ãƒ³ã‚¯ãŒå«ã¾ã‚Œã¾ã™ã€‚

ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã¯ã€å‰²ã‚Šå½“ã¦ã«æœ€é©ãªãƒãƒ£ãƒ³ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«**ã•ã¾ã–ã¾ãªãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®ãƒªã‚¹ãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦æ¤œç´¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å°ã•ãªãƒ“ãƒ³ã‚ˆã‚Šã‚‚æ“ä½œãŒé…ããªã‚Šã¾ã™**ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã«æŒ¿å…¥ã•ã‚Œã‚‹ã¨ã€ã‚½ãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ¡ãƒ¢ãƒªãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨ãã«ã‚·ã‚¹ãƒ†ãƒ ã¯é©åˆ‡ãªãƒãƒ£ãƒ³ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è¿½åŠ ä½œæ¥­ã«ã‚ˆã‚Šã€ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã¯**é…ã**ãªã‚Šã¾ã™ãŒã€å¤§ããªå‰²ã‚Šå½“ã¦ãŒå°ã•ãªå‰²ã‚Šå½“ã¦ã‚ˆã‚Šã‚‚å°‘ãªã„ãŸã‚ã€ã“ã‚Œã¯è¨±å®¹ã§ãã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ï¼š

- 64Bç¯„å›²ã®ãƒ“ãƒ³32å€‹ï¼ˆå°ã•ãªãƒ“ãƒ³ã¨è¡çªï¼‰
- 512Bç¯„å›²ã®ãƒ“ãƒ³16å€‹ï¼ˆå°ã•ãªãƒ“ãƒ³ã¨è¡çªï¼‰
- 4096Bç¯„å›²ã®ãƒ“ãƒ³8å€‹ï¼ˆä¸€éƒ¨ãŒå°ã•ãªãƒ“ãƒ³ã¨è¡çªï¼‰
- 32768Bç¯„å›²ã®ãƒ“ãƒ³4å€‹
- 262144Bç¯„å›²ã®ãƒ“ãƒ³2å€‹
- æ®‹ã‚Šã®ã‚µã‚¤ã‚ºç”¨ã®ãƒ“ãƒ³1å€‹

<details>

<summary>ãƒ©ãƒ¼ã‚¸ãƒ“ãƒ³ã‚µã‚¤ã‚ºã®ã‚³ãƒ¼ãƒ‰</summary>
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711

#define largebin_index_32(sz)                                                \
(((((unsigned long) (sz)) >> 6) <= 38) ?  56 + (((unsigned long) (sz)) >> 6) :\
((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
126)

#define largebin_index_32_big(sz)                                            \
(((((unsigned long) (sz)) >> 6) <= 45) ?  49 + (((unsigned long) (sz)) >> 6) :\
((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
126)

// XXX It remains to be seen whether it is good to keep the widths of
// XXX the buckets the same or whether it should be scaled by a factor
// XXX of two as well.
#define largebin_index_64(sz)                                                \
(((((unsigned long) (sz)) >> 6) <= 48) ?  48 + (((unsigned long) (sz)) >> 6) :\
((((unsigned long) (sz)) >> 9) <= 20) ?  91 + (((unsigned long) (sz)) >> 9) :\
((((unsigned long) (sz)) >> 12) <= 10) ? 110 + (((unsigned long) (sz)) >> 12) :\
((((unsigned long) (sz)) >> 15) <= 4) ? 119 + (((unsigned long) (sz)) >> 15) :\
((((unsigned long) (sz)) >> 18) <= 2) ? 124 + (((unsigned long) (sz)) >> 18) :\
126)

#define largebin_index(sz) \
(SIZE_SZ == 8 ? largebin_index_64 (sz)                                     \
: MALLOC_ALIGNMENT == 16 ? largebin_index_32_big (sz)                     \
: largebin_index_32 (sz))
```
</details>

<details>

<summary>å¤§ããªãƒãƒ£ãƒ³ã‚¯ã®ä¾‹ã‚’è¿½åŠ </summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunks[2];

chunks[0] = malloc(0x1500);
chunks[1] = malloc(0x1500);
free(chunks[0]);
chunks[0] = malloc(0x2000);

return 0;
}
```
2ã¤ã®å¤§ããªå‰²ã‚Šå½“ã¦ãŒè¡Œã‚ã‚Œã€ãã®å¾Œ1ã¤ãŒè§£æ”¾ã•ã‚Œã¾ã™ï¼ˆã“ã‚Œã«ã‚ˆã‚Šã€ãã‚ŒãŒæœªæ•´åˆ—ã®ãƒ“ãƒ³ã«é…ç½®ã•ã‚Œã¾ã™ï¼‰ã€ãã—ã¦ã‚ˆã‚Šå¤§ããªå‰²ã‚Šå½“ã¦ãŒè¡Œã‚ã‚Œã¾ã™ï¼ˆè§£æ”¾ã•ã‚ŒãŸã‚‚ã®ãŒæœªæ•´åˆ—ã®ãƒ“ãƒ³ã‹ã‚‰å¤§ããªãƒ“ãƒ³ã«ç§»å‹•ã—ã¾ã™ï¼‰ã€‚

ãã‚Œã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€ãƒ¡ã‚¤ãƒ³é–¢æ•°ã®retã‚ªãƒšã‚³ãƒ¼ãƒ‰ã«ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ãƒ‡ãƒãƒƒã‚°ã—ã¾ã™ã€‚ãã®å¾Œã€gefã‚’ä½¿ç”¨ã—ã¦tcacheãƒ“ãƒ³ã®ãƒ•ã‚£ãƒ«ã¨å¤§ããªãƒ“ãƒ³å†…ã®1ã¤ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```bash
gefâ¤  heap bin
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for thread 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
All tcachebins are empty
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fastbins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Fastbins[idx=0, size=0x20] 0x00
Fastbins[idx=1, size=0x30] 0x00
Fastbins[idx=2, size=0x40] 0x00
Fastbins[idx=3, size=0x50] 0x00
Fastbins[idx=4, size=0x60] 0x00
Fastbins[idx=5, size=0x70] 0x00
Fastbins[idx=6, size=0x80] 0x00
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unsorted Bin for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[+] Found 0 chunks in unsorted bin.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Small Bins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[+] Found 0 chunks in 0 small non-empty bins.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Large Bins for arena at 0xfffff7f90b00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[+] large_bins[100]: fw=0xaaaaaaac1290, bk=0xaaaaaaac1290
â†’   Chunk(addr=0xaaaaaaac12a0, size=0x1510, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[+] Found 1 chunks in 1 large non-empty bins.
```
</details>

### ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯
```c
// From https://github.com/bminor/glibc/blob/a07e000e82cb71238259e674529c37c12dc7d423/malloc/malloc.c#L1711

/*
Top

The top-most available chunk (i.e., the one bordering the end of
available memory) is treated specially. It is never included in
any bin, is used only if no other chunk is available, and is
released back to the system if it is very large (see
M_TRIM_THRESHOLD).  Because top initially
points to its own bin with initial zero size, thus forcing
extension on the first malloc request, we avoid having any special
code in malloc to check whether it even exists yet. But we still
need to do so when getting memory from system, so we make
initial_top treat the bin as a legal but unusable chunk during the
interval between initialization and the first call to
sysmalloc. (This is somewhat delicate, since it relies on
the 2 preceding words to be zero during this interval as well.)
*/

/* Conveniently, the unsorted bin can be used as dummy top on first call */
#define initial_top(M)              (unsorted_chunks (M))
```
åŸºæœ¬çš„ã«ã€ã“ã‚Œã¯ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªãƒ’ãƒ¼ãƒ—å…¨ä½“ã‚’å«ã‚€ãƒãƒ£ãƒ³ã‚¯ã§ã™ã€‚mallocãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ä½¿ç”¨å¯èƒ½ãªãƒ•ãƒªãƒ¼ãƒãƒ£ãƒ³ã‚¯ãŒãªã„å ´åˆã€ã“ã®ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¯å¿…è¦ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã‚µã‚¤ã‚ºã‚’æ¸›ã‚‰ã—ã¾ã™ã€‚\
Top Chunkã¸ã®ãƒã‚¤ãƒ³ã‚¿ã¯`malloc_state`æ§‹é€ ä½“ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã•ã‚‰ã«ã€æœ€åˆã«ã€æœªæ•´åˆ—ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<details>

<summary>Top Chunkã®ä¾‹ã‚’è¦³å¯Ÿ</summary>
```c
#include <stdlib.h>
#include <stdio.h>

int main(void)
{
char *chunk;
chunk = malloc(24);
printf("Address of the chunk: %p\n", (void *)chunk);
gets(chunk);
return 0;
}
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã„ã€mainã®retã‚ªãƒšã‚³ãƒ¼ãƒ‰ã§ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ãŸã¨ã“ã‚ã€mallocãŒã‚¢ãƒ‰ãƒ¬ã‚¹`0xaaaaaaac12a0`ã‚’è¿”ã—ã€ã“ã‚ŒãŒãƒãƒ£ãƒ³ã‚¯ã§ã™:
```bash
gefâ¤  heap chunks
Chunk(addr=0xaaaaaaac1010, size=0x290, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac1010     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]
Chunk(addr=0xaaaaaaac12a0, size=0x20, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac12a0     41 41 41 41 41 41 41 00 00 00 00 00 00 00 00 00    AAAAAAA.........]
Chunk(addr=0xaaaaaaac12c0, size=0x410, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac12c0     41 64 64 72 65 73 73 20 6f 66 20 74 68 65 20 63    Address of the c]
Chunk(addr=0xaaaaaaac16d0, size=0x410, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)
[0x0000aaaaaaac16d0     41 41 41 41 41 41 41 0a 00 00 00 00 00 00 00 00    AAAAAAA.........]
Chunk(addr=0xaaaaaaac1ae0, size=0x20530, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  â†  top chunk
```
ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ãŒã‚¢ãƒ‰ãƒ¬ã‚¹`0xaaaaaaac1ae0`ã«ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€æœ€å¾Œã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒ`0xaaaaaaac12a0`ã«ã‚µã‚¤ã‚ºãŒ`0x410`ã§ã‚ã£ãŸãŸã‚ã§ã‚ã‚Šã€`0xaaaaaaac12a0 + 0x410 = 0xaaaaaaac1ae0`ã¨ãªã‚Šã¾ã™ã€‚\
ã¾ãŸã€ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã®é•·ã•ã‚’ãã®ãƒãƒ£ãƒ³ã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
```bash
gefâ¤  x/8wx 0xaaaaaaac1ae0 - 16
0xaaaaaaac1ad0:	0x00000000	0x00000000	0x00020531	0x00000000
0xaaaaaaac1ae0:	0x00000000	0x00000000	0x00000000	0x00000000
```
</details>

### æœ€å¾Œã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼

`malloc` ãŒä½¿ç”¨ã•ã‚Œã€ãƒãƒ£ãƒ³ã‚¯ãŒåˆ†å‰²ã•ã‚Œã‚‹ã¨ï¼ˆæœªãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‹ã‚‰ã¾ãŸã¯ãƒˆãƒƒãƒ—ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰ãªã©ï¼‰ã€åˆ†å‰²ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰ä½œæˆã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¯ã€Œæœ€å¾Œã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã€ã¨å‘¼ã°ã‚Œã€ãã®ãƒã‚¤ãƒ³ã‚¿ã¯ `malloc_state` æ§‹é€ ä½“ã«æ ¼ç´ã•ã‚Œã¾ã™ã€‚

## å‰²ã‚Šå½“ã¦ãƒ•ãƒ­ãƒ¼

æ¬¡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="heap-memory-functions/malloc-and-sysmalloc.md" %}
[malloc-and-sysmalloc.md](heap-memory-functions/malloc-and-sysmalloc.md)
{% endcontent-ref %}

## è§£æ”¾ãƒ•ãƒ­ãƒ¼

æ¬¡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="heap-memory-functions/free.md" %}
[free.md](heap-memory-functions/free.md)
{% endcontent-ref %}

## ãƒ’ãƒ¼ãƒ—é–¢æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

ãƒ’ãƒ¼ãƒ—å†…ã§é »ç¹ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="heap-memory-functions/heap-functions-security-checks.md" %}
[heap-functions-security-checks.md](heap-memory-functions/heap-functions-security-checks.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/](https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/)
* [https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/](https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/)
* [https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions](https://heap-exploitation.dhavalkapil.com/diving\_into\_glibc\_heap/core\_functions)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/tcache/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/tcache/)

<details>

<summary><strong>AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>!</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„** ã¾ãŸã¯ **HackTricks ã‚’ PDF ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„** å ´åˆã¯ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ PEASS & HackTricks ã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com) ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«** [**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã™ã‚‹

</details>
