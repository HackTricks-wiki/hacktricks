# WWW2Exec - \_\_malloc\_hook & \_\_free\_hook

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‹ã‚‰AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ï¼š[**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **Malloc Hook**

[å…¬å¼GNUã‚µã‚¤ãƒˆ](https://www.gnu.org/software/libc/manual/html\_node/Hooks-for-Malloc.html)ã«ã‚ˆã‚‹ã¨ã€å¤‰æ•°**`__malloc_hook`**ã¯ã€`malloc()`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã³ã«**å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿**ã§ã‚ã‚Šã€**libcãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¾‹ãˆã°**One Gadget**ã§ä¸Šæ›¸ãã•ã‚Œã€`malloc`ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€**One GadgetãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™**ã€‚

mallocã‚’å‘¼ã³å‡ºã™ã«ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãã‚Œã‚’å‘¼ã³å‡ºã™ã®ã‚’å¾…ã¤ã‹ã€**`printf("%10000$c")`ã‚’å‘¼ã³å‡ºã™**ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`libc`ãŒå¤šãã®ãƒã‚¤ãƒˆã‚’å‰²ã‚Šå½“ã¦ã€ãã‚Œã‚‰ã‚’ãƒ’ãƒ¼ãƒ—ã«å‰²ã‚Šå½“ã¦ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

One Gadgetã«é–¢ã™ã‚‹è©³ç´°ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

{% content-ref url="../rop-return-oriented-programing/ret2lib/one-gadget.md" %}
[one-gadget.md](../rop-return-oriented-programing/ret2lib/one-gadget.md)
{% endcontent-ref %}

{% hint style="warning" %}
ãƒ•ãƒƒã‚¯ã¯**GLIBC >= 2.34**ã§ã¯**ç„¡åŠ¹**ã«ãªã£ã¦ã„ã¾ã™ã€‚æœ€æ–°ã®GLIBCãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ä»–ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚å‚ç…§ï¼š[https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md)ã€‚
{% endhint %}

## Free Hook

ã“ã‚Œã¯ã€æœªæ•´åˆ—ãƒ“ãƒ³æ”»æ’ƒã‚’æ‚ªç”¨ã—ãŸãƒšãƒ¼ã‚¸ã®ä¾‹ã§æ‚ªç”¨ã•ã‚Œã¾ã—ãŸï¼š

{% content-ref url="../heap/unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](../heap/unsorted-bin-attack.md)
{% endcontent-ref %}

ä»Šã€**fast bin attack**ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

* ã¾ãšã€**`__free_hook`**ã®å ´æ‰€ã§ã‚µã‚¤ã‚º200ã®**é«˜é€Ÿãƒãƒ£ãƒ³ã‚¯**ã‚’æ“ä½œã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼š
* <pre class="language-c"><code class="lang-c">gefâ¤  p &#x26;__free_hook
$1 = (void (**)(void *, const void *)) 0x7ff1e9e607a8 &#x3C;__free_hook>
gefâ¤  x/60gx 0x7ff1e9e607a8 - 0x59
<strong>0x7ff1e9e6074f: 0x0000000000000000      0x0000000000000200
</strong>0x7ff1e9e6075f: 0x0000000000000000      0x0000000000000000
0x7ff1e9e6076f &#x3C;list_all_lock+15>:      0x0000000000000000      0x0000000000000000
0x7ff1e9e6077f &#x3C;_IO_stdfile_2_lock+15>: 0x0000000000000000      0x0000000000000000
</code></pre>
* ã“ã®å ´æ‰€ã«ã‚µã‚¤ã‚º0x200ã®é«˜é€Ÿãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã§ãã‚Œã°ã€å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ãƒã‚¤ãƒ³ã‚¿ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™
* ãã®ãŸã‚ã«ã€ã‚µã‚¤ã‚º`0xfc`ã®æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒä½œæˆã•ã‚Œã€ãã®ãƒã‚¤ãƒ³ã‚¿ã§ãƒãƒ¼ã‚¸ã•ã‚ŒãŸé–¢æ•°ãŒ2å›å‘¼ã³å‡ºã•ã‚Œã€ã“ã®æ–¹æ³•ã§ã‚µã‚¤ã‚º`0xfc*2 = 0x1f8`ã®è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒå–å¾—ã•ã‚Œã¾ã™ã€‚
* æ¬¡ã«ã€ã“ã®ãƒãƒ£ãƒ³ã‚¯ã§ç·¨é›†é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã€ã“ã®é«˜é€Ÿãƒ“ãƒ³ã®**`fd`**ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰ã®**`__free_hook`**é–¢æ•°ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
* æ¬¡ã«ã€ã‚µã‚¤ã‚º`0x1f8`ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½œæˆã•ã‚Œã€é«˜é€Ÿãƒ“ãƒ³ã‹ã‚‰å‰ã®ç„¡ç”¨ãªãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã€**`__free_hook`**ã«é«˜é€Ÿãƒ“ãƒ³ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã€**`system`**é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¸Šæ›¸ãã—ã¾ã™ã€‚
* æœ€å¾Œã«ã€æ–‡å­—åˆ—`/bin/sh\x00`ã‚’å«ã‚€ãƒãƒ£ãƒ³ã‚¯ãŒå‰Šé™¤é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦è§£æ”¾ã•ã‚Œã€**`__free_hook`**é–¢æ•°ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€`/bin/sh\x00`ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æŒã¤systemãŒæŒ‡ã™é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook](https://ir0nstone.gitbook.io/notes/types/stack/one-gadgets-and-malloc-hook)
* [https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md](https://github.com/nobodyisnobody/docs/blob/main/code.execution.on.last.libc/README.md).

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‹ã‚‰AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ï¼š[**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
