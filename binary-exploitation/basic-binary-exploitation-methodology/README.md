# Metodolog铆a B谩sica de Explotaci贸n de Binarios

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci贸n B谩sica sobre ELF

Antes de comenzar a explotar cualquier cosa, es interesante entender parte de la estructura de un **binario ELF**:

{% content-ref url="elf-tricks.md" %}
[elf-tricks.md](elf-tricks.md)
{% endcontent-ref %}

## Herramientas de Explotaci贸n

{% content-ref url="tools/" %}
[herramientas](tools/)
{% endcontent-ref %}

## Metodolog铆a de Desbordamiento de Pila

Con tantas t茅cnicas, es bueno tener un esquema de cu谩ndo cada t茅cnica ser谩 煤til. Ten en cuenta que las mismas protecciones afectar谩n a diferentes t茅cnicas. Puedes encontrar formas de evadir las protecciones en cada secci贸n de protecci贸n, pero no en esta metodolog铆a.

## Controlando el Flujo

Hay diferentes formas en las que podr铆as terminar controlando el flujo de un programa:

* [**Desbordamientos de Pila**](../stack-overflow/) sobrescribiendo el puntero de retorno de la pila o el EBP -> ESP -> EIP.
* Podr铆a ser necesario abusar de un [**Desbordamiento de Enteros**](../integer-overflow.md) para causar el desbordamiento.
* O a trav茅s de **Escrituras Arbitrarias + Escribir Qu茅 D贸nde a la Ejecuci贸n**
* [**Cadenas de Formato**](../format-strings/)**:** Abusar de `printf` para escribir contenido arbitrario en direcciones arbitrarias.
* [**Indexaci贸n de Arreglos**](../array-indexing.md): Abusar de una indexaci贸n mal dise帽ada para poder controlar algunos arreglos y obtener una escritura arbitraria.
* Podr铆a ser necesario abusar de un [**Desbordamiento de Enteros**](../integer-overflow.md) para causar el desbordamiento.
* **bof a WWW a trav茅s de ROP**: Abusar de un desbordamiento de b煤fer para construir un ROP y poder obtener un WWW.

Puedes encontrar las t茅cnicas de **Escribir Qu茅 D贸nde a la Ejecuci贸n** en:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

## Bucles Eternos

Algo a tener en cuenta es que generalmente **solo una explotaci贸n de una vulnerabilidad puede no ser suficiente** para ejecutar con 茅xito un exploit, especialmente si se necesitan evadir algunas protecciones. Por lo tanto, es interesante discutir algunas opciones para **hacer que una sola vulnerabilidad sea explotable varias veces** en la misma ejecuci贸n del binario:

* Escribir en una cadena **ROP** la direcci贸n de la funci贸n **`main`** o la direcci贸n donde est谩 ocurriendo la **vulnerabilidad**.
* Controlando una cadena ROP adecuada, podr铆as ser capaz de realizar todas las acciones en esa cadena.
* Escribir en la direcci贸n de **`exit` en GOT** (o cualquier otra funci贸n utilizada por el binario antes de finalizar) la direcci贸n para volver a la **vulnerabilidad**.
* Como se explica en [**.fini\_array**](../arbitrary-write-2-exec/www2exec-.dtors-and-.fini\_array.md#eternal-loop)**,** almacenar 2 funciones aqu铆, una para llamar nuevamente a la vulnerabilidad y otra para llamar a **`__libc_csu_fini`** que llamar谩 nuevamente a la funci贸n de `.fini_array`.

## Objetivos de Explotaci贸n

### Objetivo: Llamar a una funci贸n existente

* [**ret2win**](./#ret2win): Hay una funci贸n en el c贸digo que necesitas llamar (quiz谩s con algunos par谩metros espec铆ficos) para obtener la bandera.
* En un **bof regular sin** [**PIE**](../common-binary-protections-and-bypasses/pie/) **y sin** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), solo necesitas escribir la direcci贸n en la direcci贸n de retorno almacenada en la pila.
* En un bof con [**PIE**](../common-binary-protections-and-bypasses/pie/), necesitar谩s evadirlo.
* En un bof con [**canary**](../common-binary-protections-and-bypasses/stack-canaries/), necesitar谩s evadirlo.
* Si necesitas establecer varios par谩metros para llamar correctamente a la funci贸n **ret2win** puedes usar:
* Una cadena [**ROP**](./#rop-and-ret2...-techniques) **si hay suficientes gadgets** para preparar todos los par谩metros.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) (en caso de que puedas llamar a esta llamada al sistema) para controlar muchos registros.
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) y [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) para controlar varios registros.
* A trav茅s de un [**Escribir Qu茅 D贸nde**](../arbitrary-write-2-exec/) podr铆as abusar de otras vulnerabilidades (no bof) para llamar a la funci贸n **`win`**.
* [**Redirecci贸n de Punteros**](../stack-overflow/pointer-redirecting.md): En caso de que la pila contenga punteros a una funci贸n que se va a llamar o a una cadena que va a ser utilizada por una funci贸n interesante (system o printf), es posible sobrescribir esa direcci贸n.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) o [**PIE**](../common-binary-protections-and-bypasses/pie/) podr铆an afectar las direcciones.
* [**Variables no inicializadas**](../stack-overflow/uninitialized-variables.md): Nunca se sabe.

### Objetivo: RCE

#### A trav茅s de shellcode, si nx est谩 deshabilitado o mezclando shellcode con ROP:

* [**(Stack) Shellcode**](./#stack-shellcode): Esto es 煤til para almacenar un shellcode en la pila antes o despu茅s de sobrescribir el puntero de retorno y luego **saltar a 茅l** para ejecutarlo:
* **En cualquier caso, si hay un** [**canary**](../common-binary-protections-and-bypasses/stack-canaries/)**,** en un bof regular necesitar谩s evadirlo (filtrarlo).
* **Sin** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **y sin** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md) es posible saltar a la direcci贸n de la pila ya que nunca cambiar谩.
* **Con** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) necesitar谩s t茅cnicas como [**ret2esp/ret2reg**](../rop-return-oriented-programing/ret2esp-ret2reg.md) para saltar a ella.
* **Con** [**nx**](../common-binary-protections-and-bypasses/no-exec-nx.md), necesitar谩s usar alg煤n [**ROP**](../rop-return-oriented-programing/) **para llamar a `memprotect`** y hacer que alguna p谩gina sea `rwx`, para luego **almacenar el shellcode all铆** (llamando a read por ejemplo) y luego saltar all铆.
* Esto mezclar谩 el shellcode con una cadena ROP.
#### A trav茅s de syscalls

* [**Ret2syscall**](../rop-return-oriented-programing/rop-syscall-execv/): til para llamar a `execve` y ejecutar comandos arbitrarios. Necesitas encontrar los **gadgets para llamar al syscall espec铆fico con los par谩metros**.
* Si se habilita [**ASLR**](../common-binary-protections-and-bypasses/aslr/) o [**PIE**](../common-binary-protections-and-bypasses/pie/), necesitar谩s vencerlos **para usar los gadgets ROP** del binario o las bibliotecas.
* [**SROP**](../rop-return-oriented-programing/srop-sigreturn-oriented-programming/) puede ser 煤til para preparar el **ret2execve**.
* Gadgets de [**ret2csu**](../rop-return-oriented-programing/ret2csu.md) y [**ret2vdso**](../rop-return-oriented-programing/ret2vdso.md) para controlar varios registros.

#### A trav茅s de libc

* [**Ret2lib**](../rop-return-oriented-programing/ret2lib/): til para llamar a una funci贸n de una biblioteca (generalmente de **`libc`**) como **`system`** con algunos argumentos preparados (por ejemplo, `'/bin/sh'`). Necesitas que el binario **cargue la biblioteca** con la funci贸n que deseas llamar (generalmente libc).
* Si est谩 **compilado est谩ticamente y no hay** [**PIE**](../common-binary-protections-and-bypasses/pie/), la **direcci贸n** de `system` y `/bin/sh` no cambiar谩n, por lo que es posible usarlos est谩ticamente.
* **Sin** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **y conociendo la versi贸n de libc** cargada, la **direcci贸n** de `system` y `/bin/sh` no cambiar谩n, por lo que es posible usarlos est谩ticamente.
* Con [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **pero sin** [**PIE**](../common-binary-protections-and-bypasses/pie/), conociendo la libc y con el binario utilizando la funci贸n `system` es posible **`ret` a la direcci贸n de system en el GOT** con la direcci贸n de `'/bin/sh'` en el par谩metro (tendr谩s que descubrir esto).
* Con [ASLR](../common-binary-protections-and-bypasses/aslr/) pero sin [PIE](../common-binary-protections-and-bypasses/pie/), conociendo la libc y **sin que el binario utilice el `system`**:
* Usa [**`ret2dlresolve`**](../rop-return-oriented-programing/ret2dlresolve.md) para resolver la direcci贸n de `system` y llamarla&#x20;
* **Evade** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) y calcula la direcci贸n de `system` y `'/bin/sh'` en memoria.
* **Con** [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **y** [**PIE**](../common-binary-protections-and-bypasses/pie/) **y sin conocer la libc**: Necesitas:
* Evadir [**PIE**](../common-binary-protections-and-bypasses/pie/)
* Encontrar la **versi贸n de `libc`** utilizada (filtrar un par de direcciones de funciones)
* Verificar los **escenarios anteriores con ASLR** para continuar.

#### A trav茅s de EBP/RBP

* [**Pivoteo de pila / EBP2Ret / EBP Chaining**](../stack-overflow/stack-pivoting-ebp2ret-ebp-chaining.md): Controla el ESP para controlar RET a trav茅s del EBP almacenado en la pila.
* til para desbordamientos de pila **off-by-one**.
* til como una forma alternativa de controlar EIP mientras se abusa de EIP para construir la carga 煤til en memoria y luego saltar a ella a trav茅s de EBP.

#### Miscel谩neo

* [**Redirecci贸n de punteros**](../stack-overflow/pointer-redirecting.md): En caso de que la pila contenga punteros a una funci贸n que va a ser llamada o a una cadena que va a ser utilizada por una funci贸n interesante (system o printf), es posible sobrescribir esa direcci贸n.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) o [**PIE**](../common-binary-protections-and-bypasses/pie/) podr铆an afectar las direcciones.
* [**Variables no inicializadas**](../stack-overflow/uninitialized-variables.md): Nunca se sabe.
