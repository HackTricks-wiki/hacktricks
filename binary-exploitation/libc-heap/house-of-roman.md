# House of Roman

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚§ã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«PRã‚’é€ä¿¡ã—ã¦** [**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«

</details>

## åŸºæœ¬æƒ…å ±

ã“ã‚Œã¯ã€å½ã®fastbinsã€unsorted_binæ”»æ’ƒã€ãŠã‚ˆã³ç›¸å¯¾çš„ãªä¸Šæ›¸ãã‚’ä»‹ã—ã¦ãƒªãƒ¼ã‚¯ãªã—ã§RCEã‚’å¯èƒ½ã«ã™ã‚‹éå¸¸ã«èˆˆå‘³æ·±ã„ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã—ãŸã€‚ãŸã ã—ã€ã“ã‚Œã¯[**ãƒ‘ãƒƒãƒæ¸ˆã¿**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)ã§ã™ã€‚

### ã‚³ãƒ¼ãƒ‰

* ä¾‹ã¯[https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã«ã‚ã‚Šã¾ã™

### ã‚´ãƒ¼ãƒ«

* ç›¸å¯¾ãƒã‚¤ãƒ³ã‚¿ã‚’æ‚ªç”¨ã—ã¦RCEã‚’é”æˆã™ã‚‹

### å¿…è¦æ¡ä»¶

* fastbinã¨unsorted binã®ãƒã‚¤ãƒ³ã‚¿ã‚’ç·¨é›†ã™ã‚‹
* ä½œæ¥­ã™ã‚‹ãŸã‚ã«12ãƒ“ãƒƒãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ0.02%ã®ç¢ºç‡ï¼‰

## æ”»æ’ƒæ‰‹é †

### ãƒ‘ãƒ¼ãƒˆ1: Fastbin ChunkãŒ\_\_malloc\_hookã‚’æŒ‡ã™

è¤‡æ•°ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã™:

* `fastbin_victim`ï¼ˆ0x60ã€ã‚ªãƒ•ã‚»ãƒƒãƒˆ0ï¼‰: å¾Œã§ãƒ’ãƒ¼ãƒ—ãƒã‚¤ãƒ³ã‚¿ã‚’ç·¨é›†ã—ã¦LibCã®å€¤ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹UAFãƒãƒ£ãƒ³ã‚¯
* `chunk2`ï¼ˆ0x80ã€ã‚ªãƒ•ã‚»ãƒƒãƒˆ0x70ï¼‰: è‰¯ã„ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã®ãŸã‚
* `main_arena_use`ï¼ˆ0x80ã€ã‚ªãƒ•ã‚»ãƒƒãƒˆ0x100ï¼‰
* `relative_offset_heap`ï¼ˆ0x60ã€ã‚ªãƒ•ã‚»ãƒƒãƒˆ0x190ï¼‰: 'main\_arena\_use'ãƒãƒ£ãƒ³ã‚¯ä¸Šã®ç›¸å¯¾ã‚ªãƒ•ã‚»ãƒƒãƒˆ

æ¬¡ã«ã€`free(main_arena_use)`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®ãƒãƒ£ãƒ³ã‚¯ãŒunsortedãƒªã‚¹ãƒˆã«é…ç½®ã•ã‚Œã€`fd`ãŠã‚ˆã³`bk`ãƒã‚¤ãƒ³ã‚¿ã®ä¸¡æ–¹ã§`main_arena + 0x68`ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãŒå–å¾—ã•ã‚Œã¾ã™ã€‚

æ¬¡ã«ã€`fd`ãŠã‚ˆã³`bk`ã«`main_arena + 0x68`ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’å«ã‚€æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯`fake_libc_chunk(0x60)`ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚

ãã®å¾Œã€`relative_offset_heap`ã¨`fastbin_victim`ã‚’è§£æ”¾ã—ã¾ã™ã€‚
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
* &#x20;`fastbin_victim`ã¯`relative_offset_heap`ã‚’æŒ‡ã™`fd`ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
* &#x20;`relative_offset_heap`ã¯`fake_libc_chunk`ã‹ã‚‰ã®è·é›¢ã‚ªãƒ•ã‚»ãƒƒãƒˆã§ã‚ã‚Šã€`main_arena + 0x68`ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚
* `fastbin_victim.fd`ã®æœ€å¾Œã®ãƒã‚¤ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã€`fastbin_victim`ã‚’`main_arena + 0x68`ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

å‰è¿°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã«ã¯ã€æ”»æ’ƒè€…ã¯`fastbin_victim`ã®`fd`ãƒã‚¤ãƒ³ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã®å¾Œã€`main_arena + 0x68`ã¯ã‚ã¾ã‚Šèˆˆå‘³æ·±ããªã„ã®ã§ã€ãƒã‚¤ãƒ³ã‚¿ãŒ**`__malloc_hook`**ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

`__memalign_hook`ã¯é€šå¸¸`0x7f`ã§å§‹ã¾ã‚Šã€ãã®å‰ã«ã‚¼ãƒ­ãŒç¶šããŸã‚ã€`0x70`ã®fast binã®å€¤ã¨ã—ã¦å½è£…ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æœ€å¾Œã®4ãƒ“ãƒƒãƒˆã¯**ãƒ©ãƒ³ãƒ€ãƒ **ãªã®ã§ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å€¤ãŒèˆˆå‘³ã®ã‚ã‚‹å ´æ‰€ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã¯`2^4=16`ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã“ã§ã¯BFæ”»æ’ƒãŒå®Ÿè¡Œã•ã‚Œã€ãƒãƒ£ãƒ³ã‚¯ãŒæ¬¡ã®ã‚ˆã†ã«ãªã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼š**`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`**ã€‚

(æ®‹ã‚Šã®ãƒã‚¤ãƒˆã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã«ã¤ã„ã¦ã¯ã€[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã®èª¬æ˜ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚BFãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ï¼ˆå‹•ä½œã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—ã¾ã™ï¼‰ã€‚

ãã®å¾Œã€æœ€åˆã®2ã¤ã®fast binãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã«2ã¤ã®mallocãŒå®Ÿè¡Œã•ã‚Œã€3ç•ªç›®ã®mallocãŒå®Ÿè¡Œã•ã‚Œã¦ã€**`__malloc_hook:`**å†…ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã¾ã™ã€‚
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### ãƒ‘ãƒ¼ãƒˆ2: Unsorted\_bin attack

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„:

{% content-ref url="unsorted-bin-attack.md" %}
[unsorted-bin-attack.md](unsorted-bin-attack.md)
{% endcontent-ref %}

åŸºæœ¬çš„ã«ã¯ã€`chunk->bk` ã§æŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã« `main_arena + 0x68` ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€æ”»æ’ƒã§ã¯ `__malloc_hook` ã‚’é¸æŠã—ã¾ã™ã€‚ãã‚Œã‚’ä¸Šæ›¸ãã—ãŸå¾Œã€ç›¸å¯¾çš„ãªä¸Šæ›¸ãã‚’ä½¿ç”¨ã—ã¦ `one_gadget` ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã“ã‚Œã«ã¯ã€ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—ã—ã¦ãã‚Œã‚’ **unsorted bin** ã«å…¥ã‚Œã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
UAFã‚’ä½¿ç”¨ã—ã¦ã€`unsorted_bin_ptr->bk`ã‚’`__malloc_hook`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒã‚¤ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼ˆä»¥å‰ã«ã“ã‚Œã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¾ã—ãŸï¼‰ã€‚

{% hint style="danger" %}
ã“ã®æ”»æ’ƒã¯unsorted binã‚’ç ´å£Šã—ã¾ã™ï¼ˆã—ãŸãŒã£ã¦smallã¨largeã‚‚ï¼‰ã€‚ãã®ãŸã‚ã€ä»Šå¾Œã¯**fast binã‹ã‚‰ã®å‰²ã‚Šå½“ã¦ã®ã¿ã‚’ä½¿ç”¨ã§ãã¾ã™**ï¼ˆã‚ˆã‚Šè¤‡é›‘ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ä»–ã®å‰²ã‚Šå½“ã¦ã‚’è¡Œã„ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€ãã—ã¦ã“ã‚Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã«ã¯**åŒã˜ã‚µã‚¤ã‚ºã‚’å‰²ã‚Šå½“ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‚ãªã„ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚**
{% endhint %}

ã—ãŸãŒã£ã¦ã€`__malloc_hook`ã‚’`unsorted_bin_ptr->bk`ã«è¨­å®šã—ãŸå¾Œã€`main_arena + 0x68`ã«æ›¸ãè¾¼ã‚€ãƒˆãƒªã‚¬ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ã«ã¯ã€å˜ã«**`malloc(0x80)`**ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3: \_\_malloc\_hookã‚’systemã«è¨­å®šã™ã‚‹

ã‚¹ãƒ†ãƒƒãƒ—1ã§ã¯ã€`__malloc_hook`ã‚’å«ã‚€ãƒãƒ£ãƒ³ã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãï¼ˆå¤‰æ•°`malloc_hook_chunk`ï¼‰ã€ã‚¹ãƒ†ãƒƒãƒ—2ã§ã¯ã€ã“ã“ã«`main_arena + 0x68`ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ä»Šã€`malloc_hook_chunk`ã§ã®éƒ¨åˆ†çš„ãªä¸Šæ›¸ãã‚’æ‚ªç”¨ã—ã¦ã€ãã“ã«æ›¸ãè¾¼ã‚“ã libcã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ`main_arena + 0x68`ï¼‰ã‚’ä½¿ç”¨ã—ã¦**`one_gadget`ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™**ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã“ã§ã€**12ãƒ“ãƒƒãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ï¼ˆè©³ç´°ã¯[how2heap](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã®[ä¾‹](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)ã«ã‚ã‚Šã¾ã™ï¼‰ã€‚

æœ€å¾Œã«ã€æ­£ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸Šæ›¸ãã•ã‚ŒãŸã‚‰ã€**`malloc`ã‚’å‘¼ã³å‡ºã—ã¦`one_gadget`ã‚’ãƒˆãƒªã‚¬ãƒ¼**ã—ã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
* [https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc\_2.23/house\_of\_roman.c)
* [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house\_of\_roman/)

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã®ã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹[**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€è‡ªåˆ†ã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>
