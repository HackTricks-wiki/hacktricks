# ROP - Programaci贸n Orientada a Retornos

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informaci贸n B谩sica**

**La Programaci贸n Orientada a Retornos (ROP)** es una t茅cnica avanzada de explotaci贸n utilizada para evadir medidas de seguridad como **No Ejecutar (NX)** o **Prevenci贸n de Ejecuci贸n de Datos (DEP)**. En lugar de inyectar y ejecutar shellcode, un atacante aprovecha fragmentos de c贸digo ya presentes en el binario o en bibliotecas cargadas, conocidos como **"gadgets"**. Cada gadget generalmente termina con una instrucci贸n `ret` y realiza una peque帽a operaci贸n, como mover datos entre registros o realizar operaciones aritm茅ticas. Al encadenar estos gadgets, un atacante puede construir una carga 煤til para realizar operaciones arbitrarias, evitando efectivamente las protecciones NX/DEP.

### Convenciones de Llamada

Comprender las **convenciones de llamada** es crucial para construir cadenas ROP efectivas, especialmente al llamar funciones o manipular datos:

**x86 (32 bits)**

* **cdecl**: El llamador limpia la pila. Los argumentos de la funci贸n se empujan a la pila en orden inverso (de derecha a izquierda). **Los argumentos se empujan a la pila de derecha a izquierda**.
* **stdcall**: Similar a cdecl, pero el llamado es responsable de limpiar la pila.

**x64 (64 bits)**

* Utiliza la convenci贸n de llamada **System V AMD64 ABI** en sistemas tipo Unix, donde los **primeros seis argumentos enteros o de puntero se pasan en los registros `RDI`, `RSI`, `RDX`, `RCX`, `R8` y `R9`**. Los argumentos adicionales se pasan en la pila. El valor de retorno se coloca en `RAX`.
* La convenci贸n de llamada **Windows x64** utiliza `RCX`, `RDX`, `R8` y `R9` para los primeros cuatro argumentos enteros o de puntero, con argumentos adicionales pasados en la pila. El valor de retorno se coloca en `RAX`.
* **Registros**: Los registros de 64 bits incluyen `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` y `R8` a `R15`.

{% hint style="danger" %}
A partir de estas convenciones de llamada, es posible observar que en **32 bits los argumentos** de las funciones se **pasan a trav茅s de la pila** mientras que en **x64** se **colocan en registros espec铆ficos**.
{% endhint %}

### C贸mo Funciona ROP

1. **Secuestro de Flujo de Control**: Primero, un atacante necesita secuestrar el flujo de control de un programa, t铆picamente explotando un desbordamiento de b煤fer para sobrescribir una direcci贸n de retorno guardada en la pila.
2. **Encadenamiento de Gadgets**: Luego, el atacante selecciona cuidadosamente y encadena gadgets para realizar las acciones deseadas. Esto podr铆a implicar configurar argumentos para una llamada de funci贸n, llamar a la funci贸n (por ejemplo, `system("/bin/sh")`), y manejar cualquier limpieza necesaria u operaciones adicionales.
3. **Ejecuci贸n de la Carga til**: Cuando la funci贸n vulnerable retorna, en lugar de regresar a una ubicaci贸n leg铆tima, comienza a ejecutar la cadena de gadgets.

### Cadena ROP en x86

Consideremos un escenario hipot茅tico donde queremos llamar a `system("/bin/sh")` usando ROP en un binario de 32 bits:

1. **Encontrar Gadgets**: Supongamos que hemos encontrado los siguientes gadgets en el binario o en bibliotecas cargadas:
* `pop eax; ret`: Desapila la parte superior de la pila en `EAX` y retorna.
* `pop ebx; ret`: Desapila la parte superior de la pila en `EAX` y retorna.
* `mov [ebx], eax; ret`: Mueve el valor en `EAX` a la ubicaci贸n apuntada por `EBX`.
* La direcci贸n de `system`.
2. **Preparar la Cadena**: Necesitamos preparar una pila que se vea as铆:
* La direcci贸n del gadget que establece `EBX`.
* La direcci贸n del gadget `pop eax; ret`.
* La direcci贸n de la cadena `"/bin/sh"` en memoria (o donde planeamos escribirla).
* La direcci贸n del gadget `mov [ebx], eax; ret`, para mover `"/bin/sh"` a la ubicaci贸n apuntada por `EBX`.
* La direcci贸n de la funci贸n `system`, con `EBX` apuntando a nuestra cadena.
3. **Ejecuci贸n**: Cuando la funci贸n vulnerable retorna, comienza a ejecutar nuestra cadena de gadgets, eventualmente llamando a `system("/bin/sh")` y abriendo una shell.

### ROP en x64

Considera un escenario hipot茅tico donde deseas llamar a `execve("/bin/sh", NULL, NULL)` en un sistema x64 utilizando la convenci贸n de llamada System V AMD64 ABI:

1. **Encontrar Gadgets**: Primero necesitar铆as encontrar gadgets que te permitan controlar los registros `RDI`, `RSI` y `RDX`, ya que estos contendr谩n los argumentos para `execve`.
2. **Construcci贸n de la Cadena**:
* **Establecer `RDI` para que apunte a la cadena `"/bin/sh"`**: Esto se hace t铆picamente con un gadget `pop RDI; ret` seguido por la direcci贸n de la cadena (que puede necesitar ser colocada en la carga 煤til o encontrada en memoria).
* **Anular `RSI` y `RDX`**: Dado que los segundos y terceros argumentos para `execve` son `NULL`, necesitas gadgets para anular estos registros, como `xor RSI, RSI; ret` y `xor RDX, RDX; ret`.
* **Llamar a `execve`**: Finalmente, se requiere un gadget que salte a `execve` (o lo llame indirectamente).
3. **Ejecuci贸n de la Carga til**: Despu茅s de construir y enviar esta carga 煤til a una aplicaci贸n vulnerable, la cadena ROP se ejecuta, generando una shell.

Dado que x64 utiliza registros para los primeros argumentos, a menudo requiere menos gadgets que x86 para llamadas de funci贸n simples, pero encontrar y encadenar los gadgets correctos puede ser m谩s complejo debido al mayor n煤mero de registros y al espacio de direcciones m谩s grande. El mayor n煤mero de registros y el espacio de direcciones m谩s grande en la arquitectura **x64** ofrecen tanto oportunidades como desaf铆os para el desarrollo de exploits, especialmente en el contexto de la Programaci贸n Orientada a Retornos (ROP).

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
