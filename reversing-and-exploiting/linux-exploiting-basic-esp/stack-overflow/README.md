# Desbordamiento de pila

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## 쯈u칠 es un desbordamiento de pila?

Un **desbordamiento de pila** es una vulnerabilidad que ocurre cuando un programa escribe m치s datos en la pila de los que se le asignan para contener. Estos datos adicionales **sobrescribir치n el espacio de memoria adyacente**, lo que lleva a la corrupci칩n de datos v치lidos, la interrupci칩n del flujo de control y potencialmente la ejecuci칩n de c칩digo malicioso. Este problema suele surgir debido al uso de funciones inseguras que no realizan comprobaciones de l칤mites en la entrada.

El principal problema de esta sobrescritura es que los punteros **EIP** y **EBP** para volver a la funci칩n anterior est치n **almacenados en la pila**. Por lo tanto, un atacante podr치 sobrescribir esos punteros y **controlar el flujo de ejecuci칩n del programa**.

La vulnerabilidad suele surgir porque una funci칩n **copia dentro de la pila m치s bytes de los asignados para ella**, pudiendo sobrescribir otras partes de la pila.\
Algunas funciones comunes vulnerables a esto son: `strcpy`, `strcat`, `sprintf`, `gets`, `fgets`...

Por ejemplo, las siguientes funciones podr칤an ser vulnerables:
```c
void vulnerable() {
char buffer[128];
printf("Enter some text: ");
gets(buffer); // This is where the vulnerability lies
printf("You entered: %s\n", buffer);
}
```
### Encontrar Desbordamientos de Pila

La forma m치s com칰n de encontrar desbordamientos de pila es proporcionar una entrada muy grande de `A`s (por ejemplo, `python3 -c 'print("A"*1000)'`) y esperar un `Segmentation Fault` que indique que se intent칩 acceder a la **direcci칩n `0x41414141`**.

Adem치s, una vez que se haya encontrado la vulnerabilidad de desbordamiento de pila, ser치 necesario encontrar el desplazamiento hasta que sea posible **sobrescribir el puntero EIP**, para esto generalmente se utiliza una **secuencia de De Bruijn**. Que para un alfabeto dado de tama침o _k_ y subsecuencias de longitud _n_ es una **secuencia c칤clica en la que cada subsecuencia posible de longitud **_**n**_** aparece exactamente una vez** como una subsecuencia contigua.

De esta manera, en lugar de tener que averiguar manualmente qu칠 desplazamiento est치 sobrescribiendo el EIP, es posible usar una de estas secuencias como relleno y luego encontrar el desplazamiento de los bytes que terminaron sobrescribi칠ndolo.

Es posible utilizar **pwntools** para esto:
```python
from pwn import *

# Generate a De Bruijn sequence of length 1000 with an alphabet size of 256 (byte values)
pattern = cyclic(1000)

# This is an example value that you'd have found in the EIP/IP register upon crash
eip_value = p32(0x6161616c)
offset = cyclic_find(eip_value)  # Finds the offset of the sequence in the De Bruijn pattern
print(f"The offset is: {offset}")
```
o **GEF**:
```bash
#Patterns
pattern create 200 #Generate length 200 pattern
pattern search "avaaawaa" #Search for the offset of that substring
pattern search $rsp #Search the offset given the content of $rsp
```
## Explotando Desbordamientos de Pila

Durante un desbordamiento (suponiendo que el tama침o del desbordamiento es lo suficientemente grande), podr치s sobrescribir valores de otras variables dentro de la pila hasta llegar al EBP y EIP (o incluso m치s).\
La forma m치s com칰n de abusar de este tipo de vulnerabilidad es **modificando el puntero EIP** para que cuando la funci칩n termine, el **flujo de control se redirija a donde el usuario lo especifique** en este puntero.

Sin embargo, en otros escenarios tal vez solo **sobrescribir algunos valores de variables en la pila** sea suficiente para la explotaci칩n (como en desaf칤os CTF f치ciles).

### Ret2win

En este tipo de desaf칤os CTF, hay una **funci칩n** **dentro** del binario que **nunca es llamada** y que **necesitas llamar para ganar**. Para estos desaf칤os solo necesitas encontrar el **desplazamiento para sobrescribir el EIP** y **encontrar la direcci칩n de la funci칩n** a llamar (generalmente [**ASLR**](../common-binary-protections/aslr.md) estar칤a deshabilitado) para que cuando la funci칩n vulnerable retorne, se llame a la funci칩n oculta:

{% content-ref url="ret2win.md" %}
[ret2win.md](ret2win.md)
{% endcontent-ref %}

### Shellcode en la Pila

En este escenario, el atacante podr칤a colocar un shellcode en la pila y abusar del EIP controlado para ir al shellcode y ejecutar el c칩digo del atacante:

{% content-ref url="stack-shellcode.md" %}
[stack-shellcode.md](stack-shellcode.md)
{% endcontent-ref %}

## ROP

Esta t칠cnica es el marco fundamental para evadir la protecci칩n principal de la t칠cnica anterior: **Pila no ejecutable**. Y permite realizar varias otras t칠cnicas (ret2lib, ret2syscall...) que terminar치n ejecutando comandos arbitrarios abusando de instrucciones existentes en el binario:

{% content-ref url="rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](rop-return-oriented-programing.md)
{% endcontent-ref %}

## Tipos de protecciones

Existen varias protecciones que intentan prevenir la explotaci칩n de vulnerabilidades, cons칰ltalas en:

{% content-ref url="../common-binary-protections/" %}
[common-binary-protections](../common-binary-protections/)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
