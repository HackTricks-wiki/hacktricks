# EBP2Ret - Encadenamiento de EBP

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

Esta t茅cnica explota la capacidad de manipular el **Puntero Base (EBP)** para encadenar la ejecuci贸n de m煤ltiples funciones mediante el uso cuidadoso del registro EBP y la secuencia de instrucciones `leave; ret`.

Como recordatorio, **`leave`** b谩sicamente significa:
```
movl               %ebp, %esp
popl               %ebp
ret
```
Y como el **EBP est谩 en la pila** antes del EIP, es posible controlarlo controlando la pila.

### EBP2Ret

Esta t茅cnica es particularmente 煤til cuando puedes **alterar el registro EBP pero no tienes una forma directa de cambiar el registro EIP**. Aprovecha el comportamiento de las funciones cuando terminan de ejecutarse.

Si, durante la ejecuci贸n de `fvuln`, logras inyectar un **EBP falso** en la pila que apunta a un 谩rea en la memoria donde se encuentra la direcci贸n de tu shellcode (m谩s 4 bytes para tener en cuenta la operaci贸n `pop`), puedes controlar indirectamente el EIP. Cuando `fvuln` retorna, el ESP se establece en esta ubicaci贸n manipulada, y la operaci贸n `pop` subsiguiente disminuye el ESP en 4, haciendo que apunte efectivamente a tu shellcode. Cuando se ejecuta la instrucci贸n `ret`, el control se transfiere a tu shellcode.

#### Construcci贸n del Exploit

Primero necesitas **inyectar tu shellcode** en alg煤n lugar de la memoria ejecutable y **obtener la direcci贸n**, o obtener la direcci贸n de un [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) v谩lido, o hacer que el ESP apunte a un lugar con la direcci贸n de **`system()`** seguido de **4 bytes basura** y la direcci贸n de `"/bin/sh"`.

Luego, crea un relleno y **compromete el EBP** con la `direcci贸n del shellcode/one_gadget - 4`. Debe ser `-4` debido al `pop`. Entonces, el `ESP` apuntar谩 a nuestra direcci贸n deseada y se ejecutar谩 el `ret`.

#### Exploit de Desbordamiento por Uno

Existe una variante espec铆fica de esta t茅cnica conocida como un "Exploit de Desbordamiento por Uno". Se utiliza cuando solo puedes **modificar el byte menos significativo del EBP**. En ese caso, la ubicaci贸n de memoria que almacena la direcci贸n del shellcode debe compartir los tres primeros bytes con el EBP, lo que permite una manipulaci贸n similar con condiciones m谩s restringidas.

### **Cadenas de EBP**

Por lo tanto, al colocar una direcci贸n controlada en la entrada de `EBP` de la pila y una direcci贸n a `leave; ret` en `EIP`, es posible **mover el `ESP` a la direcci贸n controlada de `EBP` desde la pila**.

Ahora, el **`ESP`** est谩 controlado apuntando a una direcci贸n deseada y la siguiente instrucci贸n a ejecutar es un `RET`. Para abusar de esto, es posible colocar en el lugar controlado del ESP esto:

* **`&(pr贸ximo EBP falso)`** -> Carga el nuevo EBP debido a `pop ebp` de la instrucci贸n `leave`
* **`system()`** -> Llamado por `ret`
* **`&(leave;ret)`** -> Llamado despu茅s de que system termine, mover谩 ESP al EBP falso y comenzar谩 de nuevo
* **`&("/bin/sh")`**-> Par谩metro para `system`

B谩sicamente de esta manera es posible encadenar varios EBPs falsos para controlar el flujo del programa.

Para ser honesto, esto es como un [ret2lib](ret2lib/), pero m谩s complejo sin un beneficio aparente, aunque podr铆a ser interesante en algunos casos excepcionales.
