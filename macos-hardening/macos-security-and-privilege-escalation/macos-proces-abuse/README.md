# macOS ãƒ—ãƒ­ã‚»ã‚¹ã®ä¹±ç”¨

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[Telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ã§ **@carlospolopm**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚

</details>

## ãƒ—ãƒ­ã‚»ã‚¹ã®åŸºæœ¬æƒ…å ±

ãƒ—ãƒ­ã‚»ã‚¹ã¯å®Ÿè¡Œä¸­ã®å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ãŒã€ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã›ã‚“ã€‚ã“ã‚Œã‚‰ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ãƒ—ãƒ­ã‚»ã‚¹ã¯å®Ÿè¡Œä¸­ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ãƒ¡ãƒ¢ãƒªã€ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã€ãƒãƒ¼ãƒˆã€æ¨©é™ã‚’æä¾›ã™ã‚‹ã ã‘ã®ã‚³ãƒ³ãƒ†ãƒŠ**ã§ã™ã€‚

å¾“æ¥ã€ãƒ—ãƒ­ã‚»ã‚¹ã¯ï¼ˆPID 1ã‚’é™¤ãï¼‰ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹å†…ã§é–‹å§‹ã•ã‚Œã€**`fork`** ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã®æ­£ç¢ºãªã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã€ãã®å¾Œ**å­ãƒ—ãƒ­ã‚»ã‚¹**ã¯é€šå¸¸ã€æ–°ã—ã„å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦å®Ÿè¡Œã™ã‚‹ãŸã‚ã«**`execve`**ã‚’å‘¼ã³å‡ºã—ã¾ã—ãŸã€‚ãã®å¾Œã€**`vfork`** ãŒå°å…¥ã•ã‚Œã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ¡ãƒ¢ãƒªã‚³ãƒ”ãƒ¼ãªã—ã§é«˜é€ŸåŒ–ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚\
ãã®å¾Œã€**`posix_spawn`** ãŒå°å…¥ã•ã‚Œã€**`vfork`** ã¨ **`execve`** ã‚’1ã¤ã®å‘¼ã³å‡ºã—ã§çµ„ã¿åˆã‚ã›ã€ãƒ•ãƒ©ã‚°ã‚’å—ã‘å…¥ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ:

* `POSIX_SPAWN_RESETIDS`: æœ‰åŠ¹IDã‚’å®ŸIDã«ãƒªã‚»ãƒƒãƒˆ
* `POSIX_SPAWN_SETPGROUP`: ãƒ—ãƒ­ã‚»ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—æ‰€å±ã‚’è¨­å®š
* `POSUX_SPAWN_SETSIGDEF`: ã‚·ã‚°ãƒŠãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
* `POSIX_SPAWN_SETSIGMASK`: ã‚·ã‚°ãƒŠãƒ«ãƒã‚¹ã‚¯ã‚’è¨­å®š
* `POSIX_SPAWN_SETEXEC`: åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œï¼ˆã‚ˆã‚Šå¤šãã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‚™ãˆãŸ `execve` ã®ã‚ˆã†ãªï¼‰
* `POSIX_SPAWN_START_SUSPENDED`: ä¸­æ–­ã—ã¦é–‹å§‹
* `_POSIX_SPAWN_DISABLE_ASLR`: ASLRãªã—ã§é–‹å§‹
* `_POSIX_SPAWN_NANO_ALLOCATOR:` libmallocã®Nanoã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã‚’ä½¿ç”¨
* `_POSIX_SPAWN_ALLOW_DATA_EXEC:` ãƒ‡ãƒ¼ã‚¿ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã§ `rwx` ã‚’è¨±å¯
* `POSIX_SPAWN_CLOEXEC_DEFAULT`: exec(2)æ™‚ã«ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«è¨˜è¿°å­ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é–‰ã˜ã‚‹
* `_POSIX_SPAWN_HIGH_BITS_ASLR:` ASLRã‚¹ãƒ©ã‚¤ãƒ‰ã®é«˜ãƒ“ãƒƒãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ åŒ–

ã•ã‚‰ã«ã€`posix_spawn` ã§ã¯ã€ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚»ã‚¹ã®ã„ãã¤ã‹ã®å´é¢ã‚’åˆ¶å¾¡ã™ã‚‹ **`posix_spawnattr`** ã®é…åˆ—ã‚’æŒ‡å®šã—ã€ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ **`posix_spawn_file_actions`** ã‚’æŒ‡å®šã§ãã¾ã™ã€‚

ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã™ã‚‹ã¨ã€è¦ªãƒ—ãƒ­ã‚»ã‚¹ã« **ãƒªã‚¿ãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡**ã—ã¾ã™ï¼ˆè¦ªãŒçµ‚äº†ã—ãŸå ´åˆã€æ–°ã—ã„è¦ªã¯PID 1ã«ãªã‚Šã¾ã™ï¼‰ã€‚è¦ªã¯ `wait4()` ã¾ãŸã¯ `waitid()` ã‚’å‘¼ã³å‡ºã—ã¦ã“ã®å€¤ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã‚ŒãŒèµ·ã“ã‚‹ã¾ã§å­ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚¾ãƒ³ãƒ“çŠ¶æ…‹ã«ãªã‚Šã€ã¾ã ãƒªã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã™ãŒãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã—ã¾ã›ã‚“ã€‚

### PID

PIDï¼ˆãƒ—ãƒ­ã‚»ã‚¹è­˜åˆ¥å­ï¼‰ã¯ä¸€æ„ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è­˜åˆ¥ã—ã¾ã™ã€‚XNUã§ã¯ã€**PID** ã¯ **64ãƒ“ãƒƒãƒˆ**ã§å˜èª¿ã«å¢—åŠ ã—ã€**å·»ãæˆ»ã—ã¯æ±ºã—ã¦è¡Œã‚ã‚Œã¾ã›ã‚“**ï¼ˆä¹±ç”¨ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰ã€‚

### ãƒ—ãƒ­ã‚»ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€Coalation

**ãƒ—ãƒ­ã‚»ã‚¹**ã¯ãã‚Œã‚‰ã‚’æ‰±ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã« **ã‚°ãƒ«ãƒ¼ãƒ—** ã«æŒ¿å…¥ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®ã‚³ãƒãƒ³ãƒ‰ã¯åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã«ãªã‚‹ãŸã‚ã€ä¾‹ãˆã° kill ã‚’ä½¿ç”¨ã—ã¦ **ä¸€ç·’ã«ã‚·ã‚°ãƒŠãƒ«ã‚’é€ä¿¡**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã¾ãŸã€**ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã¨ï¼ˆ`setsid(2)`ï¼‰ã€å­ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«è¨­å®šã•ã‚Œã¾ã™ãŒã€ç‹¬è‡ªã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ãªã„é™ã‚Šã€‚

Coalation ã¯ã€Darwinã§ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹åˆ¥ã®æ–¹æ³•ã§ã™ã€‚Coalationã«å‚åŠ ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€ãƒ—ãƒ¼ãƒ«ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€ãƒ¬ã‚¸ãƒ£ãƒ¼ã‚’å…±æœ‰ã—ãŸã‚Šã€Jetsamã«ç›´é¢ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Coalationã«ã¯ç•°ãªã‚‹å½¹å‰²ãŒã‚ã‚Šã¾ã™: ãƒªãƒ¼ãƒ€ãƒ¼ã€XPCã‚µãƒ¼ãƒ“ã‚¹ã€ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã€‚

### è³‡æ ¼æƒ…å ±ã¨ãƒšãƒ«ã‚½ãƒŠ

å„ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã§ã®ç‰¹æ¨©ã‚’è­˜åˆ¥ã™ã‚‹ **è³‡æ ¼æƒ…å ±** ãŒã‚ã‚Šã¾ã™ã€‚å„ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯1ã¤ã®ä¸»è¦ãª `uid` ã¨1ã¤ã®ä¸»è¦ãª `gid`ï¼ˆãŸã ã—ã€è¤‡æ•°ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚\
ãƒã‚¤ãƒŠãƒªã« `setuid/setgid` ãƒ“ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚\
æ–°ã—ã„ uid/gid ã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ã„ãã¤ã‹ã®é–¢æ•°ãŒã‚ã‚Šã¾ã™ã€‚

ã‚·ã‚¹ã‚³ãƒ¼ãƒ« **`persona`** ã¯ã€**åˆ¥ã®**ã‚»ãƒƒãƒˆã® **è³‡æ ¼æƒ…å ±** ã‚’æä¾›ã—ã¾ã™ã€‚ãƒšãƒ«ã‚½ãƒŠã‚’æ¡ç”¨ã™ã‚‹ã¨ã€ãã®uidã€gidã€ãŠã‚ˆã³ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã‚’ **ä¸€åº¦ã«** å‰²ã‚Šå½“ã¦ã¾ã™ã€‚[**ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰**](https://github.com/apple/darwin-xnu/blob/main/bsd/sys/persona.h) ã§ã€æ§‹é€ ä½“ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```c
struct kpersona_info { uint32_t persona_info_version;
uid_t    persona_id; /* overlaps with UID */
int      persona_type;
gid_t    persona_gid;
uint32_t persona_ngroups;
gid_t    persona_groups[NGROUPS];
uid_t    persona_gmuid;
char     persona_name[MAXLOGNAME + 1];

/* TODO: MAC policies?! */
}
```
## ã‚¹ãƒ¬ãƒƒãƒ‰ã®åŸºæœ¬æƒ…å ±

1. **POSIXã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆpthreadsï¼‰:** macOSã¯C/C++å‘ã‘ã®æ¨™æº–ã‚¹ãƒ¬ãƒƒãƒ‰APIã§ã‚ã‚‹POSIXã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆ`pthreads`ï¼‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚macOSã«ãŠã‘ã‚‹pthreadã®å®Ÿè£…ã¯`/usr/lib/system/libsystem_pthread.dylib`ã«ã‚ã‚Šã€ã“ã‚Œã¯ä¸€èˆ¬ã«åˆ©ç”¨å¯èƒ½ãª`libpthread`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰æ¥ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½œæˆã‚„ç®¡ç†ã«å¿…è¦ãªé–¢æ•°ã‚’æä¾›ã—ã¾ã™ã€‚
2. **ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä½œæˆ:** æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯`pthread_create()`é–¢æ•°ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚å†…éƒ¨çš„ã«ã¯ã€ã“ã®é–¢æ•°ã¯XNUã‚«ãƒ¼ãƒãƒ«ï¼ˆmacOSãŒåŸºã¥ã„ã¦ã„ã‚‹ã‚«ãƒ¼ãƒãƒ«ï¼‰ã«å›ºæœ‰ã®ä½ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã§ã‚ã‚‹`bsdthread_create()`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã‚„ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºãªã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®å‹•ä½œã‚’æŒ‡å®šã™ã‚‹`pthread_attr`ï¼ˆå±æ€§ï¼‰ã‹ã‚‰æ´¾ç”Ÿã—ãŸã•ã¾ã–ã¾ãªãƒ•ãƒ©ã‚°ã‚’å–ã‚Šã¾ã™ã€‚
* **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚º:** æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¿ãƒƒã‚¯ã‚µã‚¤ã‚ºã¯512 KBã§ã‚ã‚Šã€é€šå¸¸ã®æ“ä½œã«ã¯ååˆ†ã§ã™ãŒã€å¿…è¦ã«å¿œã˜ã¦ã‚¹ãƒ¬ãƒƒãƒ‰å±æ€§ã‚’ä»‹ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã‚’å¢—æ¸›ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
3. **ã‚¹ãƒ¬ãƒƒãƒ‰ã®åˆæœŸåŒ–:** `__pthread_init()`é–¢æ•°ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«é‡è¦ã§ã‚ã‚Šã€`env[]`å¼•æ•°ã‚’åˆ©ç”¨ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã®å ´æ‰€ã‚„ã‚µã‚¤ã‚ºãªã©ã®ç’°å¢ƒå¤‰æ•°ã‚’è§£æã—ã¾ã™ã€‚

#### macOSã«ãŠã‘ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã®çµ‚äº†

1. **ã‚¹ãƒ¬ãƒƒãƒ‰ã®çµ‚äº†:** é€šå¸¸ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¯`pthread_exit()`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§çµ‚äº†ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã«ã‚ˆã‚Šã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ãã‚Œã„ã«çµ‚äº†ã—ã€å¿…è¦ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒè¡Œã‚ã‚Œã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¯å‚åŠ è€…ã«æˆ»ã‚Šå€¤ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
2. **ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:** `pthread_exit()`ã‚’å‘¼ã³å‡ºã™ã¨ã€é–¢æ•°`pthread_terminate()`ãŒå‘¼ã³å‡ºã•ã‚Œã€é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰æ§‹é€ ã®å‰Šé™¤ãŒå‡¦ç†ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Machã‚¹ãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒˆï¼ˆMachã¯XNUã‚«ãƒ¼ãƒãƒ«ã®é€šä¿¡ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ï¼‰ãŒè§£æ”¾ã•ã‚Œã€ã‚¹ãƒ¬ãƒƒãƒ‰ã«é–¢é€£ã™ã‚‹ã‚«ãƒ¼ãƒãƒ«ãƒ¬ãƒ™ãƒ«ã®æ§‹é€ ãŒå‰Šé™¤ã•ã‚Œã‚‹`bsdthread_terminate`ã¨ã„ã†ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

#### åŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç®¡ç†ã—ã€ç«¶åˆçŠ¶æ…‹ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã€macOSã¯ã„ãã¤ã‹ã®åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã¨ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ç’°å¢ƒã§é‡è¦ã§ã™ã€‚

1. **ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹:**
* **é€šå¸¸ã®ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ï¼ˆã‚·ã‚°ãƒãƒãƒ£: 0x4D555458ï¼‰:** ãƒ¡ãƒ¢ãƒªãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆãŒ60ãƒã‚¤ãƒˆï¼ˆãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹56ãƒã‚¤ãƒˆã¨ã‚·ã‚°ãƒãƒãƒ£4ãƒã‚¤ãƒˆï¼‰ã®æ¨™æº–ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ã€‚
* **é«˜é€ŸãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ï¼ˆã‚·ã‚°ãƒãƒãƒ£: 0x4d55545Aï¼‰:** é€šå¸¸ã®ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ã«é¡ä¼¼ã—ã¦ã„ã¾ã™ãŒã€ã‚ˆã‚Šé«˜é€Ÿãªæ“ä½œã«æœ€é©åŒ–ã•ã‚Œã¦ãŠã‚Šã€ã‚µã‚¤ã‚ºã‚‚60ãƒã‚¤ãƒˆã§ã™ã€‚
2. **æ¡ä»¶å¤‰æ•°:**
* ç‰¹å®šã®æ¡ä»¶ãŒç™ºç”Ÿã™ã‚‹ã®ã‚’å¾…ã¤ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ã‚µã‚¤ã‚ºã¯44ãƒã‚¤ãƒˆï¼ˆ40ãƒã‚¤ãƒˆã¨4ãƒã‚¤ãƒˆã®ã‚·ã‚°ãƒãƒãƒ£ï¼‰ã§ã™ã€‚
* **æ¡ä»¶å¤‰æ•°å±æ€§ï¼ˆã‚·ã‚°ãƒãƒãƒ£: 0x434e4441ï¼‰:** æ¡ä»¶å¤‰æ•°ã®æ§‹æˆå±æ€§ã§ã€ã‚µã‚¤ã‚ºã¯12ãƒã‚¤ãƒˆã§ã™ã€‚
3. **ä¸€åº¦ã ã‘å¤‰æ•°ï¼ˆã‚·ã‚°ãƒãƒãƒ£: 0x4f4e4345ï¼‰:**
* åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰ãŒä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã‚µã‚¤ã‚ºã¯12ãƒã‚¤ãƒˆã§ã™ã€‚
4. **èª­ã¿æ›¸ããƒ­ãƒƒã‚¯:**
* ä¸€åº¦ã«è¤‡æ•°ã®ãƒªãƒ¼ãƒ€ãƒ¼ã¾ãŸã¯1ã¤ã®ãƒ©ã‚¤ã‚¿ãƒ¼ã‚’è¨±å¯ã—ã€å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã¸ã®åŠ¹ç‡çš„ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
* **èª­ã¿æ›¸ããƒ­ãƒƒã‚¯ï¼ˆã‚·ã‚°ãƒãƒãƒ£: 0x52574c4bï¼‰:** ã‚µã‚¤ã‚ºã¯196ãƒã‚¤ãƒˆã§ã™ã€‚
* **èª­ã¿æ›¸ããƒ­ãƒƒã‚¯å±æ€§ï¼ˆã‚·ã‚°ãƒãƒãƒ£: 0x52574c41ï¼‰:** èª­ã¿æ›¸ããƒ­ãƒƒã‚¯ã®å±æ€§ã§ã€ã‚µã‚¤ã‚ºã¯20ãƒã‚¤ãƒˆã§ã™ã€‚

{% hint style="success" %}
ã“ã‚Œã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æœ€å¾Œã®4ãƒã‚¤ãƒˆã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
{% endhint %}

### ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ï¼ˆTLVï¼‰

**ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ï¼ˆTLVï¼‰**ã¯ã€Mach-Oãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆmacOSã®å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ï¼‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã€ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦**å„ã‚¹ãƒ¬ãƒƒãƒ‰**ã«å›ºæœ‰ã®å¤‰æ•°ã‚’å®£è¨€ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å„ã‚¹ãƒ¬ãƒƒãƒ‰ãŒå¤‰æ•°ã®ç‹¬è‡ªã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒã¡ã€ãƒŸãƒ¥ãƒ¼ãƒ†ãƒƒã‚¯ã‚¹ãªã©ã®æ˜ç¤ºçš„ãªåŒæœŸãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’å¿…è¦ã¨ã›ãšã«ç«¶åˆã‚’å›é¿ã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¶­æŒã§ãã¾ã™ã€‚

Cè¨€èªãŠã‚ˆã³é–¢é€£è¨€èªã§ã¯ã€**`__thread`**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’å®£è¨€ã§ãã¾ã™ã€‚ä»¥ä¸‹ã¯ã€ä¾‹ã§ã®ä½¿ç”¨æ–¹æ³•ã§ã™:
```c
cCopy code__thread int tlv_var;

void main (int argc, char **argv){
tlv_var = 10;
}
```
ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã§ã¯ã€`tlv_var`ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å„ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ç‹¬è‡ªã®`tlv_var`ã‚’æŒã¡ã€1ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒ`tlv_var`ã‚’å¤‰æ›´ã—ã¦ã‚‚ã€ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã®`tlv_var`ã«å½±éŸ¿ã‚’ä¸ãˆã¾ã›ã‚“ã€‚

Mach-Oãƒã‚¤ãƒŠãƒªã§ã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã«é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ç‰¹å®šã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ•´ç†ã•ã‚Œã¦ã„ã¾ã™:

* **`__DATA.__thread_vars`**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã«é–¢ã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ãã®ã‚¿ã‚¤ãƒ—ã‚„åˆæœŸåŒ–çŠ¶æ…‹ãªã©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
* **`__DATA.__thread_bss`**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€æ˜ç¤ºçš„ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã‚¼ãƒ­ã§åˆæœŸåŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ã«ç¢ºä¿ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªã®ä¸€éƒ¨ã§ã™ã€‚

Mach-Oã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãŒçµ‚äº†ã™ã‚‹éš›ã«ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ç‰¹å®šã®APIã§ã‚ã‚‹**`tlv_atexit`**ã‚‚æä¾›ã—ã¦ã„ã¾ã™ã€‚ã“ã®APIã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¨ãã«ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªé–¢æ•°ã§ã‚ã‚‹**ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ç™»éŒ²**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ã‚¹ãƒ¬ãƒƒãƒ‰ã®å„ªå…ˆåº¦

ã‚¹ãƒ¬ãƒƒãƒ‰ã®å„ªå…ˆåº¦ã‚’ç†è§£ã™ã‚‹ã«ã¯ã€ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹ã‚’è¦‹ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ±ºå®šã¯ã€å„ã‚¹ãƒ¬ãƒƒãƒ‰ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸå„ªå…ˆåº¦ãƒ¬ãƒ™ãƒ«ã«å½±éŸ¿ã‚’å—ã‘ã¾ã™ã€‚macOSã‚„Unixç³»ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ã“ã‚Œã¯`nice`ã€`renice`ã€Quality of Service (QoS) ã‚¯ãƒ©ã‚¹ãªã©ã®æ¦‚å¿µã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚

#### Niceã¨Renice

1. **Nice:**
* ãƒ—ãƒ­ã‚»ã‚¹ã®`nice`å€¤ã¯ã€ãã®å„ªå…ˆåº¦ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹æ•°å€¤ã§ã™ã€‚ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯ã€-20ï¼ˆæœ€é«˜ã®å„ªå…ˆåº¦ï¼‰ã‹ã‚‰19ï¼ˆæœ€ä½ã®å„ªå…ˆåº¦ï¼‰ã¾ã§ã®`nice`å€¤ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹ãŒä½œæˆã•ã‚ŒãŸã¨ãã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`nice`å€¤ã¯é€šå¸¸0ã§ã™ã€‚
* ã‚ˆã‚Šä½ã„`nice`å€¤ï¼ˆ-20ã«è¿‘ã„ï¼‰ã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚ˆã‚Šã€Œåˆ©å·±çš„ã€ã«ã—ã€ä»–ã®`nice`å€¤ãŒé«˜ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚ˆã‚Šã‚‚CPUæ™‚é–“ã‚’å¤šãä¸ãˆã¾ã™ã€‚
2. **Renice:**
* `renice`ã¯ã€æ—¢ã«å®Ÿè¡Œä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ã®`nice`å€¤ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚ã“ã‚Œã¯ã€æ–°ã—ã„`nice`å€¤ã«åŸºã¥ã„ã¦ãƒ—ãƒ­ã‚»ã‚¹ã®å„ªå…ˆåº¦ã‚’å‹•çš„ã«èª¿æ•´ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚
* ãŸã¨ãˆã°ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒä¸€æ™‚çš„ã«ã‚ˆã‚Šå¤šãã®CPUãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ãªå ´åˆã€`renice`ã‚’ä½¿ç”¨ã—ã¦ãã®`nice`å€¤ã‚’ä¸‹ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### Quality of Service (QoS) ã‚¯ãƒ©ã‚¹

QoSã‚¯ãƒ©ã‚¹ã¯ã€ç‰¹ã«**Grand Central Dispatch (GCD)**ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹macOSãªã©ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¹ãƒ¬ãƒƒãƒ‰ã®å„ªå…ˆåº¦ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚ˆã‚Šç¾ä»£çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚QoSã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€é–‹ç™ºè€…ã¯é‡è¦åº¦ã‚„ç·Šæ€¥åº¦ã«åŸºã¥ã„ã¦ä½œæ¥­ã‚’ç•°ãªã‚‹ãƒ¬ãƒ™ãƒ«ã«åˆ†é¡ã§ãã¾ã™ã€‚macOSã¯ã“ã‚Œã‚‰ã®QoSã‚¯ãƒ©ã‚¹ã«åŸºã¥ã„ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã®å„ªå…ˆé †ä½ä»˜ã‘ã‚’è‡ªå‹•çš„ã«ç®¡ç†ã—ã¾ã™:

1. **User Interactive:**
* ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å¯¾è©±ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚„å³åº§ã®çµæœãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå¿œç­”æ€§ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«æœ€é«˜ã®å„ªå…ˆåº¦ãŒä¸ãˆã‚‰ã‚Œã¾ã™ï¼ˆãŸã¨ãˆã°ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼‰ã€‚
2. **User Initiated:**
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‹å§‹ã—ã€å³åº§ã®çµæœãŒæœŸå¾…ã•ã‚Œã‚‹ã‚¿ã‚¹ã‚¯ã€ä¾‹ãˆã°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹ãã‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨ˆç®—ãŒå¿…è¦ãªå ´åˆãªã©ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã¯é«˜ã„å„ªå…ˆåº¦ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚ˆã‚Šä¸‹ã§ã™ã€‚
3. **Utility:**
* ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã¯é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã€é€šå¸¸ã¯é€²è¡ŒçŠ¶æ³ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆãŸã¨ãˆã°ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé–‹å§‹ã—ãŸã‚¿ã‚¹ã‚¯ã‚ˆã‚Šã‚‚å„ªå…ˆåº¦ãŒä½ãã€å³åº§ã«å®Œäº†ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
4. **Background:**
* ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‹•ä½œã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¦‹ãˆãªã„ã‚¿ã‚¹ã‚¯ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã€åŒæœŸã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã©ã®ã‚¿ã‚¹ã‚¯ã§ã‚ã‚Šã€æœ€ä½ã®å„ªå…ˆåº¦ã§ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ã»ã¨ã‚“ã©å½±éŸ¿ã‚’ä¸ãˆã¾ã›ã‚“ã€‚

QoSã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€é–‹ç™ºè€…ã¯æ­£ç¢ºãªå„ªå…ˆåº¦ã®æ•°å€¤ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ã¯ãªãã€ä»£ã‚ã‚Šã«ã‚¿ã‚¹ã‚¯ã®æ€§è³ªã«ç„¦ç‚¹ã‚’å½“ã¦ã€ã‚·ã‚¹ãƒ†ãƒ ãŒCPUãƒªã‚½ãƒ¼ã‚¹ã‚’é©åˆ‡ã«æœ€é©åŒ–ã—ã¾ã™ã€‚

ã•ã‚‰ã«ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã«ã¯ç•°ãªã‚‹**ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼**ãŒã‚ã‚Šã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãŒè€ƒæ…®ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã¯`thread_policy_[set/get]`ã‚’ä½¿ç”¨ã—ã¦è¡Œã†ã“ã¨ãŒã§ãã€ç«¶åˆçŠ¶æ…‹æ”»æ’ƒã§å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
### Python Injection

ç’°å¢ƒå¤‰æ•°**`PYTHONINSPECT`**ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€pythonãƒ—ãƒ­ã‚»ã‚¹ã¯çµ‚äº†æ™‚ã«python cliã«ç§»è¡Œã—ã¾ã™ã€‚ã¾ãŸã€**`PYTHONSTARTUP`**ã‚’ä½¿ç”¨ã—ã¦ã€å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚ã«å®Ÿè¡Œã™ã‚‹pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚\
ãŸã ã—ã€**`PYTHONINSPECT`**ãŒå¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã¨ãã«ã¯ã€**`PYTHONSTARTUP`**ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

**`PYTHONPATH`**ã‚„**`PYTHONHOME`**ãªã©ã®ä»–ã®ç’°å¢ƒå¤‰æ•°ã‚‚ã€pythonã‚³ãƒãƒ³ãƒ‰ãŒä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã®ã«å½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

**`pyinstaller`**ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸå®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€åŸ‹ã‚è¾¼ã¾ã‚ŒãŸpythonã‚’ä½¿ç”¨ã—ã¦ã„ã¦ã‚‚ã€ã“ã‚Œã‚‰ã®ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚

{% hint style="danger" %}
å…¨ä½“çš„ã«ã€ç’°å¢ƒå¤‰æ•°ã‚’æ‚ªç”¨ã—ã¦pythonãŒä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\
ãŸã ã—ã€ã»ã¨ã‚“ã©ã®äººã¯**Hombrew**ã‚’ä½¿ç”¨ã—ã¦pythonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**æ›¸ãè¾¼ã¿å¯èƒ½ãªå ´æ‰€**ã«pythonãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ãªæ–¹æ³•ã§ãã‚Œã‚’ä¹—ã£å–ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```bash
mv /opt/homebrew/bin/python3 /opt/homebrew/bin/python3.old
cat > /opt/homebrew/bin/python3 <<EOF
#!/bin/bash
# Extra hijack code
/opt/homebrew/bin/python3.old "$@"
EOF
chmod +x /opt/homebrew/bin/python3
```
## æ¤œå‡º

### Shield

[**Shield**](https://theevilbit.github.io/shield/) ([**Github**](https://github.com/theevilbit/Shield)) ã¯ã€æ¬¡ã®ã‚ˆã†ãª**ãƒ—ãƒ­ã‚»ã‚¹ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’**æ¤œå‡ºãŠã‚ˆã³ãƒ–ãƒ­ãƒƒã‚¯**ã™ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ï¼š

- **ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨**ï¼šæ¬¡ã®ç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ã‚’ç›£è¦–ã—ã¾ã™ï¼š**`DYLD_INSERT_LIBRARIES`**ã€**`CFNETWORK_LIBRARY_PATH`**ã€**`RAWCAMERA_BUNDLE_PATH`**ã€**`ELECTRON_RUN_AS_NODE`**
- **`task_for_pid`** ã®å‘¼ã³å‡ºã—ï¼š1ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒåˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹ã®**ã‚¿ã‚¹ã‚¯ãƒãƒ¼ãƒˆã‚’å–å¾—**ã—ã‚ˆã†ã¨ã™ã‚‹å ´åˆã‚’è¦‹ã¤ã‘ã€ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
- **Electronã‚¢ãƒ—ãƒªã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**ï¼šèª°ã‹ãŒ**`--inspect`**ã€**`--inspect-brk`**ã€**`--remote-debugging-port`** ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ä½¿ç”¨ã—ã¦Electronã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã€ãã‚Œã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- **ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯**ã¾ãŸã¯**ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯**ã®ä½¿ç”¨ï¼šä¸€èˆ¬çš„ã«æœ€ã‚‚ä¸€èˆ¬çš„ãªæ‚ªç”¨ã¯ã€**ãƒ¦ãƒ¼ã‚¶æ¨©é™ã§ãƒªãƒ³ã‚¯ã‚’é…ç½®**ã—ã€ãã‚Œã‚’**ã‚ˆã‚Šé«˜ã„æ¨©é™**ã®å ´æ‰€ã«å‘ã‘ã‚‹ã“ã¨ã§ã™ã€‚ãƒãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã¨ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®æ¤œå‡ºã¯éå¸¸ã«ç°¡å˜ã§ã™ã€‚ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚ˆã‚Šã‚‚**ç•°ãªã‚‹æ¨©é™ãƒ¬ãƒ™ãƒ«**ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**ã‚¢ãƒ©ãƒ¼ãƒˆ**ã‚’ä½œæˆã—ã¾ã™ã€‚æ®‹å¿µãªãŒã‚‰ã€ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®å ´åˆã€ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸å¯èƒ½ã§ã™ã€‚ãƒªãƒ³ã‚¯ã®å®›å…ˆã«é–¢ã™ã‚‹æƒ…å ±ãŒä½œæˆå‰ã«ã¯ã‚ã‹ã‚‰ãªã„ãŸã‚ã§ã™ã€‚ã“ã‚Œã¯Appleã®EndpointSecuriyãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®åˆ¶é™ã§ã™ã€‚

### ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã‚‹å‘¼ã³å‡ºã—

[**ã“ã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿**](https://knight.sc/reverse%20engineering/2019/04/15/detecting-task-modifications.html) ã§ã¯ã€**`task_name_for_pid`** é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã—ã€ãã®ä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

ãã®é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã«ã¯ã€ãã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ã¨**åŒã˜uid**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã¯**root**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæƒ…å ±ã‚’è¿”ã™ã ã‘ã§ã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹æ–¹æ³•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚

## å‚è€ƒæ–‡çŒ®

- [https://theevilbit.github.io/shield/](https://theevilbit.github.io/shield/)
- [https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f)
