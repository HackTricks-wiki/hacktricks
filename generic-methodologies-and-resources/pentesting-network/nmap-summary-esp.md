# Resumen de Nmap (ESP)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Par√°metros

### IPs a escanear

* **`<ip>,<net/mask>`:** Indica las IPs directamente
* **`-iL <ips_file>`:** lista_IPs
* **`-iR <number>`**: N√∫mero de IPs aleatorias, se pueden excluir IPs posibles con `--exclude <Ips>` o `--excludefile <file>`.

### Descubrimiento de equipos

Por defecto, Nmap lanza una fase de descubrimiento que consiste en: `-PA80 -PS443 -PE -PP`

* **`-sL`**: No es invasivo, lista los objetivos haciendo solicitudes **DNS** para resolver nombres. Es √∫til para saber si, por ejemplo, www.prueba.es/24 son todos nuestros objetivos.
* **`-Pn`**: **Sin ping**. Es √∫til si sabes que todos est√°n activos (de lo contrario, podr√≠as perder mucho tiempo, pero esta opci√≥n tambi√©n produce falsos negativos diciendo que no est√°n activos), evita la fase de descubrimiento.
* **`-sn`** : **Sin escaneo de puertos**. Despu√©s de completar la fase de reconocimiento, no escanea puertos. Es relativamente sigiloso y permite un peque√±o escaneo de red. Con privilegios env√≠a un ACK (-PA) a 80, un SYN(-PS) a 443 y una solicitud de eco y una solicitud de marca de tiempo, sin privilegios siempre completa las conexiones. Si el objetivo es la red, solo utiliza ARP(-PR). Si se usa con otra opci√≥n, solo se descartan los paquetes de la otra opci√≥n.
* **`-PR`**: **Ping ARP**. Se utiliza de forma predeterminada al analizar computadoras en nuestra red, es m√°s r√°pido que usar pings. Si no desea utilizar paquetes ARP, use `--send-ip`.
* **`-PS <puertos>`**: Env√≠a paquetes SYN a los cuales si responde SYN/ACK est√° abierto (a los que responde con RST para no finalizar la conexi√≥n), si responde RST est√° cerrado y si no responde est√° inalcanzable. En caso de no tener privilegios, se utiliza autom√°ticamente una conexi√≥n total. Si no se proporcionan puertos, se env√≠a a 80.
* **`-PA <puertos>`**: Similar al anterior pero con ACK, combinando ambos se obtienen mejores resultados.
* **`-PU <puertos>`**: El objetivo es lo contrario, se env√≠an a puertos que se espera que est√©n cerrados. Algunos firewalls solo verifican conexiones TCP. Si est√° cerrado, responde con puerto inalcanzable, si responde con otro icmp o no responde, se deja como inalcanzable.
* **`-PE, -PP, -PM`** : PINGS ICMP: respuesta de eco, marca de tiempo y m√°scara de direcci√≥n. Se lanzan para saber si el objetivo est√° activo.
* **`-PY<puertos>`**: Env√≠a sondas SCTP INIT a 80 de forma predeterminada, INIT-ACK (abierto) o ABORT (cerrado) o nada o ICMP inalcanzable (inactivo) pueden responder.
* **`-PO <protocolos>`**: Se indica un protocolo en los encabezados, por defecto 1 (ICMP), 2 (IGMP) y 4 (Encap IP). Para los protocolos ICMP, IGMP, TCP (6) y UDP (17) se env√≠an los encabezados de protocolo, para el resto solo se env√≠a el encabezado IP. El prop√≥sito de esto es que debido a la malformaci√≥n de los encabezados, se responden Protocol unreachable o respuestas del mismo protocolo para saber si est√° activo.
* **`-n`**: Sin DNS
* **`-R`**: Siempre DNS

### T√©cnicas de escaneo de puertos

* **`-sS`**: No completa la conexi√≥n, por lo que no deja rastro, muy bueno si se puede usar (con privilegios). Es el que se utiliza de forma predeterminada.
* **`-sT`**: Completa la conexi√≥n, por lo que deja rastro, pero se puede usar con seguridad. Por defecto sin privilegios.
* **`-sU`**: M√°s lento, para UDP. Principalmente: DNS(53), SNMP(161,162), DHCP(67 y 68), (-sU53,161,162,67,68): abierto(respuesta), cerrado(puerto inalcanzable), filtrado (otro ICMP), abierto/filtrado (nada). En caso de abierto/filtrado, -sV env√≠a numerosas solicitudes para detectar alguna de las versiones que nmap soporta y puede detectar el verdadero estado. Aumenta mucho el tiempo.
* **`-sY`**: El protocolo SCTP no logra establecer la conexi√≥n, por lo que no hay registros, funciona como -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, pueden penetrar algunos firewalls y extraer informaci√≥n. Se basan en que las m√°quinas compatibles con el est√°ndar deben responder con RST a todas las solicitudes que no tengan retrasos SYN, RST o ACK elevados: abierto/filtrado(nada), cerrado(RST), filtrado (ICMP inalcanzable). No fiable en Windows, CIsco, BSDI y OS/400. En Unix s√≠.
* **`-sM`**: Escaneo Maimon: Env√≠a banderas FIN y ACK, utilizado para BSD, actualmente devolver√° todo como cerrado.
* **`-sA, sW`**: ACK y Window, se utiliza para detectar firewalls, para saber si los puertos est√°n filtrados o no. El -sW s√≠ distingue entre abierto/cerrado ya que los abiertos responden con un valor de ventana diferente: abierto (RST con ventana distinta de 0), cerrado (RST ventana = 0), filtrado (ICMP inalcanzable o nada). No todos los equipos funcionan de esta manera, por lo que si todos est√°n cerrados, no est√° funcionando, si hay algunos abiertos, est√° funcionando bien, y si hay muchos abiertos y pocos cerrados, est√° funcionando al rev√©s.
* **`-sI`:** Escaneo inactivo. Para los casos en los que hay un firewall activo pero sabemos que no filtra a una cierta IP (o cuando simplemente queremos anonimato) podemos usar el esc√°ner zombie (funciona para todos los puertos), para buscar posibles zombies podemos usar el script ipidseq o el exploit auxiliary/scanner/ip/ipidseq. Este esc√°ner se basa en el n√∫mero IPID de los paquetes IP.
* **`--badsum`:** Env√≠a la suma incorrecta, las computadoras descartar√≠an los paquetes, pero los firewalls podr√≠an responder algo, se utiliza para detectar firewalls.
* **`-sZ`:** Esc√°ner SCTP "extra√±o", al enviar sondas con fragmentos de eco de cookies deber√≠an ser descartadas si est√°n abiertas o respondidas con ABORT si est√°n cerradas. Puede pasar a trav√©s de firewalls que no pasan por init, lo malo es que no distingue entre filtrado y abierto.
* **`-sO`:** Escaneo de protocolo Ip. Env√≠a encabezados incorrectos y vac√≠os en los que a veces ni siquiera se puede distinguir el protocolo. Si llega un protocolo ICMP inalcanzable est√° cerrado, si llega un puerto inalcanzable est√° abierto, si llega otro error, filtrado, si no llega nada, abierto|filtrado.
* **`-b <servidor>`:** FTPhost--> Se utiliza para escanear un host desde otro, esto se hace conectando el ftp de otra m√°quina y pidi√©ndole que env√≠e archivos a los puertos que se desean escanear desde otra m√°quina, seg√∫n las respuestas sabremos si est√°n abiertos o no. \[\<usuario>:\<contrase√±a>@]\<servidor>\[:\<puerto>] Casi todos los servidores ftp ya no permiten hacer esto y, por lo tanto, tiene poco uso pr√°ctico.

### **An√°lisis centrado**

**-p:** Se utiliza para especificar los puertos a escanear. Para seleccionar los 65335: **-p-** o **-p all**. Nmap tiene una clasificaci√≥n interna seg√∫n su popularidad. Por defecto utiliza los 1000 principales. Con **-F** (escaneo r√°pido) analiza los 100 principales. Con **--top-ports \<numero>** Analiza ese n√∫mero de principales (de 1 hasta los 65335). Comprueba los puertos en orden aleatorio, para evitar esto **-r**. Tambi√©n se pueden seleccionar puertos: 20-30,80,443,1024- Esto √∫ltimo significa que mire en adelante del 1024. Tambi√©n se pueden agrupar los puertos por protocolos: U:53,T:21-25,80,139,S:9. Tambi√©n se puede elegir un rango dentro de los puertos populares de nmap: -p \[-1024] analiza hasta el 1024 de los incluidos en nmap-services. **--port-ratio \<ratio>** Analiza los puertos m√°s comunes que un ratio que debe estar entre 0 y 1

**-sV** Escaneo de versi√≥n, se puede ajustar la intensidad de 0 a 9, por defecto 7.

**--version-intensity \<numero>** Regula la intensidad, de modo que cuanto m√°s bajo solo lanzar√° las sondas m√°s probables, pero no todas. Con esto podemos acortar considerablemente el tiempo de escaneo UDP

**-O** Detecci√≥n de OS

**--osscan-limit** Para escanear bien un host se necesita que al menos haya 1 puerto abierto y otro cerrado, si no se da esta condici√≥n y hemos puesto esto, no intenta hacer predicci√≥n de OS (ahorra tiempo)

**--osscan-guess** Cuando la detecci√≥n de OS no es perfecta, esto hace que se esfuerce m√°s

**Scripts**

\--script _\<nombre_archivo>_|_\<categor√≠a>_|_\<directorio>_|_\<expresi√≥n>_\[,...]

Para usar los predeterminados, basta con -sC o --script=default

Los tipos disponibles son: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version y vuln

* **Auth:** ejecuta todos los _scripts_ disponibles para autenticaci√≥n
* **Default:** ejecuta los _scripts_ b√°sicos por defecto de la herramienta
* **Discovery:** recupera informaci√≥n del _target_ o v√≠ctima
* **External:** _script_ para utilizar recursos externos
* **Intrusive:** utiliza _scripts_ que se consideran intrusivos para la v√≠ctima o _target_
* **Malware:** revisa si hay conexiones abiertas por c√≥digos maliciosos o _backdoors_ (puertas traseras)
* **Safe:** ejecuta _scripts_ que no son intrusivos
* **Vuln:** descubre las vulnerabilidades m√°s conocidas
* **All:** ejecuta todos los _scripts_ con extensi√≥n NSE disponibles

Para buscar scripts:

**nmap --script-help="http-\*" -> Los que empiecen por http-**

**nmap --script-help="not intrusive" -> Todos menos esos**

**nmap --script-help="default or safe" -> Los que est√°n en uno o en otro o en ambos**

**nmap --script-help="default and safe" --> Los que est√°n en ambos**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<nombre_archivo>_

\--script-help _\<nombre_archivo>_|_\<categor√≠a>_|_\<directorio>_|_\<expresi√≥n>_|all\[,...]

\--script-trace ---> Proporciona informaci√≥n sobre c√≥mo va el script

\--script-updatedb

**Para usar un script solo hay que poner: namp --script Nombre\_del\_script objetivo** --> Al poner el script se ejecutar√° tanto el script como el esc√°ner, as√≠ que tambi√©n se pueden poner opciones del esc√°ner, se puede a√±adir **‚Äúsafe=1‚Äù** para que se ejecuten solo los que sean seguros.

**Control de tiempo**

**Nmap puede modificar el tiempo en segundos, minutos, ms:** --host-timeout arguments 900000ms, 900, 900s, and 15m all do the same thing.

Nmap divide el n√∫mero total de hosts a escanear en grupos y analiza esos grupos en bloques de forma que hasta que no se han analizado todos, no pasa al siguiente bloque (y el usuario tampoco recibe ninguna actualizaci√≥n hasta que se haya analizado el bloque), de esta forma, es m√°s √≥ptimo para nmap usar grupos grandes. Por defecto en clase C usa 256.

Se puede cambiar con\*\*--min-hostgroup\*\* _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ (Ajustar tama√±os de grupo de escaneo paralelo)

Se puede controlar el n√∫mero de esc√°neres en paralelo pero es mejor que no (nmap ya incorpora control autom√°tico en base al estado de la red): **--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**

Se puede modificar el rtt timeout, pero no suele ser necesario: **--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**

Se puede modificar el n√∫mero de intentos:**--max-retries** _**\<numtries>**_

Se puede modificar el tiempo de escaneado de un host: **--host-timeout** _**\<time>**

Se puede modificar el tiempo entre cada prueba para que vaya despacio: **--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**

Se puede modificar el n√∫mero de paquetes por segundo: **--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**

Muchos puertos tardan mucho en responder al estar filtrados o cerrados, si solo nos interesan los abiertos, podemos ir m√°s r√°pido con: **--defeat-rst-ratelimit**

Para definir lo agresivo que queremos que sea nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> Solo se escanea 1 puerto a la vez y se espera 5min hasta el siguiente

\-T1 y T2 --> Muy parecidos pero solo esperan 15 y 0,4seg respectivamente entre cada prueba

\-T3 --> Funcionamiento por defecto, incluye en paralelo

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

No dejan pasar a puertos y analizan paquetes.

**-f** Para fragmentar paquetes, por defecto los fragmenta en 8bytes despu√©s de la cabecera, para especificar ese tama√±o usamos ..mtu (con esto, no usar -f), el offset debe ser m√∫ltiplo de 8. **Esc√°neres de versi√≥n y scripts no soportan la fragmentaci√≥n**

**-D decoy1,decoy2,ME** Nmap env√≠a esc√°neres pero con otras direcciones IPs como origen, de esta forma te esconden a ti. Si pones el ME en la lista, nmap te situar√° ah√≠, es mejor poner 5 o 6 antes de ti para que te enmascaren completamente. Se pueden generar IPs aleatorias con RND:\<n√∫mero> Para generar \<n√∫mero> de IPs aleatorias. No funcionan con detector de versiones sin conexi√≥n de TCP. Si est√°s dentro de una red, te interesa usar IPs que est√©n activas, pues sino ser√° muy f√°cil averiguar que t√∫ eres la √∫nica activa.

Para usar IPs aleatorias: nmap-D RND: 10 Ip_objetivo

**-S IP** Para cuando Nmap no detecta tu direcci√≥n IP, se la tienes que dar con eso. Tambi√©n sirve para hacer pensar que hay otro objetivo escane√°ndoles.

**-e \<interfaz>** Para elegir la interfaz

Muchos administradores dejan puertos de entrada abiertos para que todo funcione correctamente y les resulte m√°s f√°cil que buscar otra soluci√≥n. Estos pueden ser los puertos DNS o los de FTP... para buscar esta vulnerabilidad nmap incorpora: **--source-port** _**\<n√∫meropuerto>**_**;-g** _**\<n√∫meropuerto>**_ _Son equivalentes_

**--data** _**\<cadena hexadecimal>**_ Para enviar texto hexadecimal: --data 0xdeadbeef y --data \xCA\xFE\x09

**--data-string** _**\<cadena>**_ Para enviar un texto normal: --data-string "Escaneo realizado por Security Ops, extensi√≥n 7192"

**--data-length** _**
