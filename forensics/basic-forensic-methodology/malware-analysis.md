# AnÃ¡lisis de Malware

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Hojas de Trucos de Forensics

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Servicios en LÃ­nea

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Herramientas de Antivirus y DetecciÃ³n sin ConexiÃ³n

### Yara

#### InstalaciÃ³n
```bash
sudo apt-get install -y yara
```
#### Preparar reglas

Utiliza este script para descargar y fusionar todas las reglas de malware de yara desde github: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Crea el directorio _**rules**_ y ejecÃºtalo. Esto crearÃ¡ un archivo llamado _**malware\_rules.yar**_ que contiene todas las reglas de yara para malware.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Escaneo

Before analyzing a malware sample, it is important to perform a thorough scan to identify any potential threats. This scan can be done using various antivirus tools and malware scanners. The purpose of the scan is to detect any known malware signatures or suspicious behavior that may indicate the presence of malware.

Antes de analizar una muestra de malware, es importante realizar un escaneo exhaustivo para identificar posibles amenazas. Este escaneo se puede realizar utilizando varias herramientas antivirus y escÃ¡neres de malware. El propÃ³sito del escaneo es detectar cualquier firma de malware conocida o comportamiento sospechoso que pueda indicar la presencia de malware.

During the scan, the antivirus tool or malware scanner will compare the files and processes on the system against a database of known malware signatures. If a match is found, the file or process will be flagged as potentially malicious. Additionally, the scanner may also look for suspicious behavior such as unauthorized network connections, unusual file modifications, or attempts to inject code into other processes.

Durante el escaneo, la herramienta antivirus o el escÃ¡ner de malware compararÃ¡n los archivos y procesos del sistema con una base de datos de firmas de malware conocidas. Si se encuentra una coincidencia, el archivo o proceso se marcarÃ¡ como potencialmente malicioso. AdemÃ¡s, el escÃ¡ner tambiÃ©n puede buscar comportamientos sospechosos, como conexiones de red no autorizadas, modificaciones inusuales de archivos o intentos de inyectar cÃ³digo en otros procesos.

It is important to note that while a scan can help identify known malware, it may not be able to detect new or zero-day threats. Therefore, it is recommended to use multiple scanning tools and keep them up to date to ensure the best possible detection rate.

Es importante tener en cuenta que si bien un escaneo puede ayudar a identificar malware conocido, es posible que no pueda detectar amenazas nuevas o de dÃ­a cero. Por lo tanto, se recomienda utilizar varias herramientas de escaneo y mantenerlas actualizadas para garantizar la mejor tasa de detecciÃ³n posible.
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: Verificar malware y crear reglas

Puedes utilizar la herramienta [**YaraGen**](https://github.com/Neo23x0/yarGen) para generar reglas yara a partir de un archivo binario. Echa un vistazo a estos tutoriales: [**Parte 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Parte 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Parte 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### InstalaciÃ³n

Para instalar ClamAV, sigue los siguientes pasos:

1. Abre una terminal en tu sistema operativo.
2. Ejecuta el siguiente comando para actualizar los repositorios:

   ```
   sudo apt update
   ```

3. Luego, ejecuta el siguiente comando para instalar ClamAV:

   ```
   sudo apt install clamav
   ```

4. Durante la instalaciÃ³n, se te pedirÃ¡ que configures ClamAV. Puedes seleccionar las opciones predeterminadas o personalizar la configuraciÃ³n segÃºn tus necesidades.

Una vez que la instalaciÃ³n se haya completado, tendrÃ¡s ClamAV instalado en tu sistema y estarÃ¡s listo para realizar anÃ¡lisis de malware.
```
sudo apt-get install -y clamav
```
#### Escaneo

Before analyzing a suspicious file, it is important to perform a thorough scan to identify any potential malware. Scanning the file with an up-to-date antivirus software can help detect known malware signatures and provide an initial assessment of the file's safety.

Antes de analizar un archivo sospechoso, es importante realizar un escaneo exhaustivo para identificar cualquier malware potencial. Escanear el archivo con un software antivirus actualizado puede ayudar a detectar firmas de malware conocidas y proporcionar una evaluaciÃ³n inicial de la seguridad del archivo.

```markdown
**Note:** It is recommended to use multiple antivirus engines for a more comprehensive scan. Online malware scanning services and sandbox environments can also be used to further analyze the file.
```

```markdown
**Nota:** Se recomienda utilizar varios motores antivirus para un escaneo mÃ¡s completo. TambiÃ©n se pueden utilizar servicios de escaneo de malware en lÃ­nea y entornos de sandbox para analizar aÃºn mÃ¡s el archivo.
```
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** detecta posibles **capacidades maliciosas** en ejecutables: PE, ELF, .NET. Por lo tanto, encontrarÃ¡ cosas como tÃ¡cticas de Att\&ck o capacidades sospechosas como:

* verificar errores de OutputDebugString
* ejecutarse como un servicio
* crear un proceso

ObtÃ©nlo en el [**repositorio de Github**](https://github.com/mandiant/capa).

### IOC

IOC significa Indicator Of Compromise. Un IOC es un conjunto de **condiciones que identifican** algÃºn software potencialmente no deseado o malware confirmado. Los equipos de seguridad utilizan este tipo de definiciÃ³n para **buscar este tipo de archivos maliciosos** en sus **sistemas** y **redes**.\
Compartir estas definiciones es muy Ãºtil, ya que cuando se identifica malware en una computadora y se crea un IOC para ese malware, otros equipos de seguridad pueden utilizarlo para identificar el malware mÃ¡s rÃ¡pidamente.

Una herramienta para crear o modificar IOCs es [**IOC Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Puedes utilizar herramientas como [**Redline**](https://www.fireeye.com/services/freeware/redline.html) para **buscar IOCs definidos en un dispositivo**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) es un escÃ¡ner de Indicadores Simples de Compromiso.\
La detecciÃ³n se basa en cuatro mÃ©todos de detecciÃ³n:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) es un escÃ¡ner de malware para Linux lanzado bajo la licencia GNU GPLv2, diseÃ±ado para enfrentar las amenazas en entornos de alojamiento compartido. Utiliza datos de amenazas de sistemas de detecciÃ³n de intrusos en el borde de la red para extraer malware que se estÃ¡ utilizando activamente en ataques y genera firmas para su detecciÃ³n. AdemÃ¡s, los datos de amenazas tambiÃ©n se derivan de las contribuciones de los usuarios con la funciÃ³n de verificaciÃ³n de LMD y los recursos de la comunidad de malware.

### rkhunter

Herramientas como [**rkhunter**](http://rkhunter.sourceforge.net) se pueden utilizar para verificar el sistema de archivos en busca de posibles **rootkits** y malware.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[FLOSS](https://github.com/mandiant/flare-floss) es una herramienta que intentarÃ¡ encontrar cadenas de texto ofuscadas dentro de ejecutables utilizando diferentes tÃ©cnicas.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) verifica algunas cosas bÃ¡sicas dentro del ejecutable (datos binarios, entropÃ­a, URLs e IPs, algunas reglas yara).

### PEstudio

[PEstudio](https://www.winitor.com/download) es una herramienta que permite obtener informaciÃ³n de ejecutables de Windows, como importaciones, exportaciones, encabezados, pero tambiÃ©n verificarÃ¡ VirusTotal y encontrarÃ¡ posibles tÃ©cnicas de Att\&ck.

### Detect It Easy(DiE)

[DiE](https://github.com/horsicq/Detect-It-Easy/) es una herramienta para detectar si un archivo estÃ¡ **encriptado** y tambiÃ©n encontrar **empaquetadores**.

### NeoPI

[NeoPI](https://github.com/CiscoCXSecurity/NeoPI) es un script de Python que utiliza una variedad de **mÃ©todos estadÃ­sticos** para detectar contenido **ofuscado** y **encriptado** dentro de archivos de texto o script. El propÃ³sito principal de NeoPI es ayudar en la **detecciÃ³n de cÃ³digo de shell web oculto**.

### **php-malware-finder**

[php-malware-finder](https://github.com/nbs-system/php-malware-finder) hace todo lo posible para detectar cÃ³digo **ofuscado**/**sospechoso** y archivos que utilizan funciones de **PHP** que a menudo se utilizan en **malwares**/shell web.

### Firmas Binarias de Apple

Cuando se verifica una **muestra de malware**, siempre se debe **verificar la firma** del binario, ya que el **desarrollador** que lo firmÃ³ puede estar **relacionado** con **malware**.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the appâ€™s contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## TÃ©cnicas de DetecciÃ³n

### Apilamiento de Archivos

Si sabes que una carpeta que contiene los **archivos** de un servidor web fue **actualizada por Ãºltima vez en una fecha determinada**, **verifica** la **fecha** en la que todos los **archivos** del servidor web fueron creados y modificados, y si alguna fecha es **sospechosa**, verifica ese archivo.

### Baselines

Si los archivos de una carpeta **no deberÃ­an haber sido modificados**, puedes calcular el **hash** de los **archivos originales** de la carpeta y **compararlos** con los **actuales**. Cualquier modificaciÃ³n serÃ¡ **sospechosa**.

### AnÃ¡lisis EstadÃ­stico

Cuando la informaciÃ³n se guarda en registros, puedes **verificar estadÃ­sticas como cuÃ¡ntas veces se accediÃ³ a cada archivo de un servidor web, ya que una shell web podrÃ­a ser una de las mÃ¡s**.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
