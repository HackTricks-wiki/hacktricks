# Archive Extraction Symlink Exploitation (Zip Slip & Friends)

{{#include ../banners/hacktricks-training.md}}

Abusing **symbolic links (symlinks)** embedded inside archives (ZIP, TAR, 7Z, RAR …) is a classic way to turn an apparently innocuous file-extraction operation into **arbitrary file write** and, frequently, **remote code execution (RCE)**.  
The trick ‑ popularised in 2018 with the *Zip-Slip* wave of vulnerabilities ‑ is still frequently rediscovered when archiving tools fail to ensure that the **final extraction path always stays inside the chosen destination directory**.

When the extractor naively *follows* symlink entries during decompression, an attacker can smuggle files *outside* the destination folder and overwrite anything the current user (or service account) is allowed to write.

## TL;DR

1. Create a directory tree that contains **symlink entries that point to sensitive targets** (e.g. `/etc/ssh/ssh_host_rsa_key`, `~/.bashrc`, `%windir%\System32\drivers\etc\hosts`).  
2. Add the **malicious payload file** next to each symlink.
3. Compress the tree with any format that preserves symlinks (ZIP, TAR, 7Z, RAR …).
4. Convince the victim to extract the archive with a **vulnerable utility/library**.  
   • Linux/Mac: works under normal privileges because creating/following symlinks is unrestricted.  
   • Windows: extraction must run with **SeCreateSymbolicLinkPrivilege** (Administrator/UAC elevated) *or* **Developer Mode** enabled.
5. Upon extraction the tool traverses the symlink and **writes the attacker-controlled payload to the real target path** → overwrite → code execution / persistence / privilege escalation.

## Anatomy of a Malicious Archive

```bash
$ tree evil/
├── link -> /etc/ssh/ssh_host_rsa_key   # symlink entry (stores the final path!)
└── link                                # the file that will overwrite the key
```

1. `ln -s /etc/ssh/ssh_host_rsa_key evil/link`
2. `echo "malicious-key" > evil/link`   # replaces content via the symlink
3. `zip -y -r evil.zip evil`            # `-y/--symlinks` keeps links in ZIP

`evil.zip` now contains an entry whose **stored filename is `evil/link`** and whose **target is `/etc/ssh/ssh_host_rsa_key`**.  When a vulnerable extractor recreates the symlink **and then writes file data through it**, the original host key is overwritten.

## Real-World Vulnerabilities

The pattern affects both CLI tools and the countless libraries that implement archive parsing:

• `7-Zip` < 25.01 (CVE-2025-55188) – writes outside extraction directory when processing symlinks.  
• `unzip` 6.0 – originally vulnerable; fixed in many distros.  
• Java `ZipFile` libraries used by GoCD, maven-installer, … (Zip-Slip 2018).  
• `libarchive`, `pyunpack`, `bsdtar`, `busybox tar` (various CVEs).

## Detecting Vulnerable Extractors

A quick test archive can be generated with the snippet above.  If, after extraction, the *real* file (`/etc/ssh/ssh_host_rsa_key`) changes, the utility is vulnerable.  
When performing assessments:

1. Upload a crafted archive through any feature that unpacks server-side (CI/CD import, attachment preview, theme installers…).
2. Check if protected files changed or if new files appeared outside the upload directory.

## Mitigations & Hardening

* Developers → **Validate extraction paths**:  
  `absolute(dest_path).startswith(absolute(extract_dir))` **before** creating/writing a file.  Never follow symlinks blindly.
* Users / sysadmins →  
  • **Patch** affected software (e.g. 7-Zip ≥ 25.01).  
  • **Extract with `--no-same-owner --no-same-permissions --no-symlinks`** flags when available (e.g. `bsdtar`).  
  • Drop privileges (`sudo -u nobody`) or **chroot/fakeroot** before bulk-extracting untrusted archives.
* Windows → disable Developer Mode; avoid running extractors as Administrator.

## Post-Exploitation Ideas

• Overwrite `~/.ssh/authorized_keys` → persistent SSH backdoor.  
• Replace `/etc/profile.d/*.sh` or `~/.bashrc` → command execution on next login.  
• Overwrite systemd service files → privilege escalation after daemon reload.  
• On Windows, overwrite a `%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup\evil.bat` or DLL search-order hijack target.

## One-Liner PoC (Linux)

```bash
# Overwrite current user .bashrc on extraction
mkdir -p pwn && ln -s ~/.bashrc pwn/link && echo 'evil="$(id)"' > pwn/link
zip -y -r pwn.zip pwn
```

## References

- [New 7-Zip flaw (CVE-2025-55188)](https://www.redhotcyber.com/en/post/new-7-zip-flaw-symbolic-links-turn-extraction-into-a-hack-2/)
- [Zip-Slip write-up 2018](https://snyk.io/research/zip-slip-vulnerability)
- [7-Zip 25.01 release notes](https://github.com/ip7z/7zip/releases/tag/25.01)

{{#include ../banners/hacktricks-training.md}}