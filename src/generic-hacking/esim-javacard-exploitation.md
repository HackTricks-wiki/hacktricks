# eSIM / Java Card VM Exploitation

{{#include ../banners/hacktricks-training.md}}

## Overview
Τα Embedded SIMs (eSIMs) υλοποιούνται ως **Embedded UICC (eUICC)** smart-cards που τρέχουν μια **Java Card Virtual Machine (JC VM)** πάνω σε ένα secure element. Επειδή προφίλ και applets μπορούν να προμηθευτούν *over-the-air* (OTA) μέσω Remote SIM Provisioning (RSP), οποιοδήποτε σφάλμα ασφάλειας μνήμης μέσα στη JC VM γίνεται αμέσως ένα remote code-execution primitive **μέσα στο πιο προνόμιο στοιχείο της συσκευής**.

Αυτή η σελίδα περιγράφει μια πραγματική πλήρη παραβίαση του eUICC της Kigen (Infineon SLC37 ESA1M2, ARM SC300) που προκλήθηκε από την έλλειψη ελέγχων type-safety στα bytecodes `getfield` και `putfield`. Η ίδια τεχνική μπορεί να εφαρμοστεί και σε άλλους vendors που παραλείπουν την on-card byte-code verification.

## Attack Surface
1. **Remote Application Management (RAM)**  
   Τα eSIM profiles μπορεί να ενσωματώνουν αυθαίρετα Java Card applets. Η προμήθεια γίνεται με standard APDUs που μπορούν να tunneled μέσω SMS-PP (Short Message Service Point-to-Point) ή HTTPS. Αν ένας attacker αποκτήσει (ή κλέψει) τα **RAM keys** για ένα profile, μπορεί απομακρυσμένα να `INSTALL`/`LOAD` ένα κακόβουλο applet.
2. **Java Card byte-code execution**  
   Μετά την εγκατάσταση, το applet εκτελείται μέσα στη VM. Η έλλειψη run-time checks επιτρέπει memory corruption.

### 2024–2025 ecosystem changes
* **GSMA TS.48 v7.0 (18 Jun 2025)** αφαίρεσε τα public RAM keysets από το Generic Test Profile και μπλοκάρει `INSTALL` εκτός αν παρέχονται randomized keys· τα cached v≤6 profiles εξακολουθούν να εκτίθενται με static RAM keys και παραμένουν exploitable.
* **GSMA AN‑2025‑07 (09 Jul 2025)** προτείνει on-card bytecode verification· τα περισσότερα eUICCs ακόμη παραλείπουν πλήρη verification, οπότε τα VM memory bugs παραμένουν προσβάσιμα μετά το install του applet.
* **Kigen OTA hardening (Jul 2025)** μπλοκάρει το loading applets όταν ενεργά είναι legacy TS.48 test profiles και προσθέτει runtime checks, αλλά οι μη patched συσκευές παραμένουν vulnerable.

## The Type-Confusion Primitive
`getfield` / `putfield` υποτίθεται ότι λειτουργούν μόνο σε **object references**. Στο Kigen eUICC οι εντολές δεν επαληθεύουν αν ο operand στην stack είναι αναφορά *object* ή *array*. Επειδή μια λέξη `array.length` βρίσκεται στην ίδια ακριβώς offset με το πρώτο instance field ενός κανονικού object, ένας attacker μπορεί:

1. Create a byte-array `byte[] buf = new byte[0x100];`
2. Cast it to `Object o = (Object)buf;`
3. Use `putfield` to overwrite *any* 16-bit value inside an adjacent object (including VTABLE / ptr translation entries).
4. Use `getfield` to read *arbitrary* memory once internal pointers are hijacked.
```java
// Pseudo-bytecode sequence executed by the malicious applet
// buf = newarray byte 0x100
// o   = (Object) buf            // illegal but not verified
// putfield <victimObject+offset>, 0xCAFE // arbitrary write
// ... set up read-what-where gadgets ...
```
Το primitive παρέχει **arbitrary read / write** στον χώρο διευθύνσεων του eUICC — αρκετό για να αποθηκεύσει το μοναδικό για τη συσκευή ιδιωτικό κλειδί ECC που πιστοποιεί την κάρτα στο οικοσύστημα GSMA.

## Πλήρης ροή εκμετάλλευσης
1. **Καταγραφή firmware** – Χρήση του μη-τεκμηριωμένου `GET DATA` item `DF1F`:
```
80 CA DF 1F 00   // → "ECu10.13" (vulnerable)
```
2. **Εγκατάσταση κακόβουλου applet OTA** – Κατάχρηση των δημόσια γνωστών κλειδιών του TS.48 Generic Test Profile και αποστολή SMS-PP fragments που μεταφέρουν το CAP file (`LOAD`) ακολουθούμενο από `INSTALL`:
```
// simplified APDU chain
80 E6 02 00 <data>   // LOAD (block n)
80 E6 0C 00 <data>   // INSTALL for load
```
3. **Trigger type-confusion** – Όταν το applet επιλέγεται εκτελεί το write-what-where για να καταλάβει έναν pointer table και να leak μνήμη μέσω κανονικών APDU αποκρίσεων.
4. **Εξαγωγή GSMA certificate key** – Το ιδιωτικό EC key αντιγράφεται στο RAM του applet και επιστρέφεται σε κομμάτια.
5. **Προσποίηση eUICC** – Το κλεμμένο key pair + πιστοποιητικά επιτρέπουν στον attacker να authenticate σε *any* RSP server ως νόμιμη κάρτα (EID binding μπορεί να απαιτηθεί ακόμα για κάποιους operators).
6. **Κατέβασμα και τροποποίηση profiles** – Τα plaintext profiles περιέχουν πολύ ευαίσθητα πεδία όπως `OPc`, `AMF`, OTA keys και ακόμα επιπλέον applets. Ο attacker μπορεί:
* Clone a profile to a second eUICC (voice/SMS hijack);
* Patch Java Card applications (e.g. insert STK spyware) before re-uploading;
* Extract operator secrets for large-scale abuse.

## Cloning / Hijacking Demonstration
Η εγκατάσταση του ίδιου profile σε **PHONE A** και **PHONE B** έχει ως αποτέλεσμα το Mobile Switching Centre να δρομολογεί την εισερχόμενη κίνηση στη συσκευή που έκανε πιο πρόσφατη registration. Μία συνεδρία Gmail 2FA SMS interception αρκεί για να παρακαμφθεί το MFA του θύματος.

## Automated Test & Exploit Toolkit
Οι researchers δημοσίευσαν ένα εσωτερικό εργαλείο με την εντολή `bsc` (*Basic Security Check*) που δείχνει άμεσα αν μια Java Card VM είναι vulnerable:
```
scard> bsc
- castcheck        [arbitrary int/obj casts]
- ptrgranularity   [pointer granularity/tr table presence]
- locvaraccess     [local variable access]
- stkframeaccess   [stack frame access]
- instfieldaccess  [instance field access]
- objarrconfusion  [object/array size field confusion]
```
Modules shipped with the framework:
* `introspector` – πλήρης εξερευνητής VM και μνήμης (~1.7 MB Java)
* `security-test` – γενικό applet παράκαμψης επαλήθευσης (~150 KB)
* `exploit`       – 100 % αξιόπιστη παραβίαση Kigen eUICC (~72 KB)

## Mitigations
1. **On-card byte-code verification** – επιβάλετε πλήρη παρακολούθηση τύπων control-flow & data-flow αντί μόνο του stack-top.
2. **Hide array header** – τοποθετήστε `length` έξω από επικαλυπτόμενα object fields.
3. **Harden RAM keys policy** – μην διανέμετε προφίλ με public keys· απενεργοποιήστε το `INSTALL` σε test profiles (TS.48 v7 αφαιρεί RAM keysets).
4. **RSP server side heuristics** – rate-limit λήψεις προφίλ ανά EID, παρακολουθήστε γεωγραφικές ανωμαλίες, επικυρώστε την freshness των πιστοποιητικών.
5. **Keep devices off legacy test profiles** – εφαρμόστε το July 2025 OTA που μπλοκάρει το φόρτωμα applet με TS.48 v≤6 ή αφαιρέστε το test profile από τα factory images.

## Quick Checklist for Pentesters
* Query `GET DATA DF1F` – vulnerable firmware string `ECu10.13` υποδεικνύει Kigen.
* Inspect loaded profiles: TS.48 test profiles με static RAM keys (v≤6) είναι άμεσα εκμεταλλεύσιμα; v7 χωρίς RAM keys χρειάζονται νέο key leak.
* Check if RAM keys are known ‑> attempt OTA `INSTALL`/`LOAD`.
* After applet installation, brute-force simple cast primitive (`objarrconfusion`).
* Try to read Security Domain private keys – επιτυχία = πλήρης παραβίαση.

## References
- [Security Explorations – eSIM security](https://security-explorations.com/esim-security.html)
- [GSMA TS.48 Generic Test Profile v7.0](https://www.gsma.com/get-involved/working-groups/gsma_resources/ts-48-v7-0-generic-euicc-test-profile-for-device-testing/)
- [GSMA AN-2025-07 Preventing misuse of an eUICC Profile](https://www.gsma.com/solutions-and-impact/technologies/esim/gsma_resources/an-2025-07-preventing-misuse-of-an-euicc-profile-and-installation-of-malicious-java-card-application-v1-0/)
- [The Hacker News – eSIM vulnerability in Kigen eUICC (July 2025)](https://thehackernews.com/2025/07/esim-vulnerability-in-kigens-euicc.html)
- [Java Card VM Specification 3.1](https://docs.oracle.com/en/java/javacard/3.1/jc-vm-spec/F12650_05.pdf)

{{#include ../banners/hacktricks-training.md}}
