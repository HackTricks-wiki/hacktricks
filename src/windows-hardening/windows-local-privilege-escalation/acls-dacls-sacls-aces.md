# ACLs - DACLs/SACLs/ACEs

{{#include ../../banners/hacktricks-training.md}}

## **Список контролю доступу (ACL)**

Список контролю доступу (ACL) складається з упорядкованого набору записів контролю доступу (ACE), які визначають захист об'єкта та його властивостей. По суті, ACL визначає, які дії яких суб'єктів безпеки (користувачів або груп) дозволені або заборонені для даного об'єкта.

Існує два типи ACL:

- **Дискреційний список контролю доступу (DACL):** Визначає, які користувачі та групи мають або не мають доступ до об'єкта.
- **Системний список контролю доступу (SACL):** Регулює аудит спроб доступу до об'єкта.

Процес доступу до файлу передбачає перевірку системою дескриптора безпеки об'єкта на відповідність токену доступу користувача, щоб визначити, чи слід надати доступ і в якій мірі, на основі ACE.

### **Ключові компоненти**

- **DACL:** Містить ACE, які надають або забороняють права доступу користувачам і групам для об'єкта. Це, по суті, основний ACL, який визначає права доступу.
- **SACL:** Використовується для аудиту доступу до об'єктів, де ACE визначають типи доступу, які потрібно реєструвати в журналі подій безпеки. Це може бути безцінним для виявлення несанкціонованих спроб доступу або усунення проблем з доступом.

### **Взаємодія системи з ACL**

Кожна сесія користувача асоційована з токеном доступу, який містить інформацію про безпеку, що стосується цієї сесії, включаючи ідентичності користувача, групи та привілеї. Цей токен також включає SID входу, який унікально ідентифікує сесію.

Локальний орган безпеки (LSASS) обробляє запити на доступ до об'єктів, перевіряючи DACL на наявність ACE, які відповідають суб'єкту безпеки, що намагається отримати доступ. Доступ надається негайно, якщо не знайдено відповідних ACE. В іншому випадку LSASS порівнює ACE з SID суб'єкта безпеки в токені доступу, щоб визначити право на доступ.

### **Стислий процес**

- **ACL:** Визначають права доступу через DACL та правила аудиту через SACL.
- **Токен доступу:** Містить інформацію про користувача, групу та привілеї для сесії.
- **Рішення про доступ:** Приймається шляхом порівняння ACE DACL з токеном доступу; SACL використовуються для аудиту.

### ACEs

Існує **три основні типи записів контролю доступу (ACEs)**:

- **ACE доступу заборонено:** Цей ACE явно забороняє доступ до об'єкта для зазначених користувачів або груп (в DACL).
- **ACE доступу дозволено:** Цей ACE явно надає доступ до об'єкта для зазначених користувачів або груп (в DACL).
- **ACE системного аудиту:** Розташований у системному списку контролю доступу (SACL), цей ACE відповідає за створення журналів аудиту при спробах доступу до об'єкта користувачами або групами. Він документує, чи був доступ дозволений або заборонений, і характер доступу.

Кожен ACE має **чотири критичних компоненти**:

1. **Ідентифікатор безпеки (SID)** користувача або групи (або їх основне ім'я в графічному представленні).
2. **Прапор**, який ідентифікує тип ACE (доступ заборонено, дозволено або системний аудит).
3. **Прапори успадкування**, які визначають, чи можуть дочірні об'єкти успадковувати ACE від батьківського.
4. [**Маска доступу**](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/7a53f60e-e730-4dfe-bbe9-b21b62eb790b?redirectedfrom=MSDN), 32-бітове значення, що вказує на надані права об'єкта.

Визначення доступу проводиться шляхом послідовного перевірки кожного ACE, поки:

- **ACE доступу заборонено** явно не забороняє запитувані права довіреній особі, ідентифікованій у токені доступу.
- **ACE доступу дозволено** явно не надає всі запитувані права довіреній особі в токені доступу.
- Після перевірки всіх ACE, якщо будь-яке запитуване право **не було явно дозволено**, доступ автоматично **забороняється**.

### Порядок ACEs

Спосіб, яким **ACEs** (правила, що визначають, хто може або не може отримати доступ до чогось) розташовані в списку, званому **DACL**, є дуже важливим. Це тому, що після того, як система надає або забороняє доступ на основі цих правил, вона перестає перевіряти решту.

Існує найкращий спосіб організувати ці ACE, і він називається **"канонічний порядок."** Цей метод допомагає забезпечити, щоб все працювало гладко і справедливо. Ось як це виглядає для систем, таких як **Windows 2000** та **Windows Server 2003**:

- Спочатку розмістіть усі правила, які створені **конкретно для цього елемента**, перед тими, що походять з іншого місця, наприклад, з батьківської папки.
- У цих конкретних правилах розмістіть ті, що говорять **"ні" (заборонити)** перед тими, що говорять **"так" (дозволити)**.
- Для правил, що походять з іншого місця, почніть з тих, що походять з **найближчого джерела**, наприклад, з батьківського, а потім йдіть назад. Знову ж таки, розмістіть **"ні"** перед **"так."**

Ця структура допомагає у двох великих аспектах:

- Вона забезпечує, що якщо є конкретне **"ні,"** воно поважатиметься, незалежно від інших правил **"так."**
- Вона дозволяє власнику елемента мати **остаточне слово** про те, хто може отримати доступ, перед тим, як будь-які правила з батьківських папок або далі вступлять у силу.

Таким чином, власник файлу або папки може бути дуже точним у тому, хто отримує доступ, забезпечуючи, щоб правильні люди могли потрапити, а неправильні - ні.

![](https://www.ntfs.com/images/screenshots/ACEs.gif)

Отже, цей **"канонічний порядок"** полягає в тому, щоб забезпечити, щоб правила доступу були чіткими та працювали добре, ставлячи конкретні правила на перше місце та організовуючи все розумно.

### Приклад GUI

[**Приклад звідси**](https://secureidentity.se/acl-dacl-sacl-and-the-ace/)

Це класична вкладка безпеки папки, що показує ACL, DACL та ACE:

![http://secureidentity.se/wp-content/uploads/2014/04/classicsectab.jpg](../../images/classicsectab.jpg)

Якщо ми натиснемо кнопку **Додатково**, ми отримаємо більше опцій, таких як успадкування:

![http://secureidentity.se/wp-content/uploads/2014/04/aceinheritance.jpg](../../images/aceinheritance.jpg)

І якщо ви додаєте або редагуєте суб'єкта безпеки:

![http://secureidentity.se/wp-content/uploads/2014/04/editseprincipalpointers1.jpg](../../images/editseprincipalpointers1.jpg)

А наостанок у нас є SACL на вкладці Аудит:

![http://secureidentity.se/wp-content/uploads/2014/04/audit-tab.jpg](../../images/audit-tab.jpg)

### Пояснення контролю доступу в спрощеному вигляді

Керуючи доступом до ресурсів, таких як папка, ми використовуємо списки та правила, відомі як списки контролю доступу (ACL) та записи контролю доступу (ACE). Вони визначають, хто може або не може отримати доступ до певних даних.

#### Заборона доступу конкретній групі

Уявіть, що у вас є папка з назвою Витрати, і ви хочете, щоб усі мали доступ до неї, крім команди маркетингу. Налаштувавши правила правильно, ми можемо забезпечити, щоб команді маркетингу був явно заборонений доступ перед тим, як дозволити всім іншим. Це робиться шляхом розміщення правила заборони доступу для команди маркетингу перед правилом, яке дозволяє доступ усім.

#### Дозвіл доступу конкретному члену забороненої групи

Припустимо, Боб, директор з маркетингу, потребує доступу до папки Витрати, хоча команда маркетингу загалом не повинна мати доступу. Ми можемо додати конкретне правило (ACE) для Боба, яке надає йому доступ, і розмістити його перед правилом, яке забороняє доступ команді маркетингу. Таким чином, Боб отримує доступ, незважаючи на загальне обмеження для його команди.

#### Розуміння записів контролю доступу

ACEs - це окремі правила в ACL. Вони ідентифікують користувачів або групи, вказують, який доступ дозволено або заборонено, і визначають, як ці правила застосовуються до піделем (успадкування). Існує два основних типи ACE:

- **Генеричні ACE:** Ці правила застосовуються широко, впливаючи або на всі типи об'єктів, або розрізняючи лише контейнери (наприклад, папки) та неконтейнери (наприклад, файли). Наприклад, правило, яке дозволяє користувачам бачити вміст папки, але не отримувати доступ до файлів у ній.
- **Об'єктно-специфічні ACE:** Ці правила забезпечують більш точний контроль, дозволяючи встановлювати правила для конкретних типів об'єктів або навіть окремих властивостей в об'єкті. Наприклад, у каталозі користувачів правило може дозволити користувачу оновити свій номер телефону, але не години входу.

Кожен ACE містить важливу інформацію, таку як те, до кого застосовується правило (використовуючи ідентифікатор безпеки або SID), що дозволяє або забороняє правило (використовуючи маску доступу) і як воно успадковується іншими об'єктами.

#### Ключові відмінності між типами ACE

- **Генеричні ACE** підходять для простих сценаріїв контролю доступу, де те саме правило застосовується до всіх аспектів об'єкта або до всіх об'єктів у контейнері.
- **Об'єктно-специфічні ACE** використовуються для більш складних сценаріїв, особливо в середовищах, таких як Active Directory, де може знадобитися контролювати доступ до конкретних властивостей об'єкта по-різному.

У підсумку, ACL та ACE допомагають визначити точний контроль доступу, забезпечуючи, щоб лише правильні особи або групи мали доступ до чутливої інформації або ресурсів, з можливістю налаштування прав доступу до рівня окремих властивостей або типів об'єктів.

### Макет запису контролю доступу

| Поле ACE   | Опис                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Тип        | Прапор, який вказує тип ACE. Windows 2000 та Windows Server 2003 підтримують шість типів ACE: три типи загальних ACE, які прикріплюються до всіх об'єктів, що підлягають захисту. Три типи об'єктно-специфічних ACE, які можуть виникати для об'єктів Active Directory.                                                                                                                                                                                                                                                            |
| Прапори       | Набір бітових прапорів, які контролюють успадкування та аудит.                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| Розмір        | Кількість байтів пам'яті, які виділені для ACE.                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Маска доступу | 32-бітове значення, біти якого відповідають правам доступу для об'єкта. Біти можуть бути встановлені або вмикатися, але значення налаштування залежить від типу ACE. Наприклад, якщо біт, що відповідає праву на читання дозволів, увімкнено, а тип ACE - Заборонити, ACE забороняє право на читання дозволів об'єкта. Якщо той же біт увімкнено, але тип ACE - Дозволити, ACE надає право на читання дозволів об'єкта. Більше деталей про маску доступу з'являється в наступній таблиці. |
| SID         | Ідентифікує користувача або групу, доступ яких контролюється або моніториться цим ACE.                                                                                                                                                                                                                                                                                                                                                                                                                                 |

### Макет маски доступу

| Біт (діапазон) | Значення                            | Опис/Приклад                       |
| ----------- | ---------------------------------- | ----------------------------------------- |
| 0 - 15      | Специфічні права доступу до об'єкта      | Читати дані, Виконати, Додати дані           |
| 16 - 22     | Стандартні права доступу             | Видалити, Записати ACL, Записати власника            |
| 23          | Може отримати доступ до системного ACL            |                                           |
| 24 - 27     | Зарезервовано                           |                                           |
| 28          | Генеричний ВСІ (Читати, Записати, Виконати) | Все нижче                          |
| 29          | Генеричний Виконати                    | Усі речі, необхідні для виконання програми |
| 30          | Генеричний Записати                      | Усі речі, необхідні для запису у файл   |
| 31          | Генеричний Читати                       | Усі речі, необхідні для читання з файлу       |

## Посилання

- [https://www.ntfs.com/ntfs-permissions-acl-use.htm](https://www.ntfs.com/ntfs-permissions-acl-use.htm)
- [https://secureidentity.se/acl-dacl-sacl-and-the-ace/](https://secureidentity.se/acl-dacl-sacl-and-the-ace/)
- [https://www.coopware.in2.info/\_ntfsacl_ht.htm](https://www.coopware.in2.info/_ntfsacl_ht.htm)

{{#include ../../banners/hacktricks-training.md}}
