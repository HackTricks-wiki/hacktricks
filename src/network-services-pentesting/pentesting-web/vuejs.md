# Vue.js

{{#include ../../banners/hacktricks-training.md}}

## Vue.jsにおけるXSSシンク

### v-htmlディレクティブ
`v-html`ディレクティブは**生**のHTMLをレンダリングするため、サニタイズされていないユーザー入力に埋め込まれた`<script>`（または`onerror`のような属性）は即座に実行されます。
```html
<div id="app">
<div v-html="htmlContent"></div>
</div>
<script>
new Vue({
el: '#app',
data: {
htmlContent: '<img src=x onerror=alert(1)>'
}
})
</script>
```
### v-bind with src or href
ユーザーストリングをURLを持つ属性（`href`、`src`、`xlink:href`、`formaction` …）にバインドすると、リンクがフォローされたときに`javascript:alert(1)`のようなペイロードが実行されます。
```html
<div id="app">
<a v-bind:href="userInput">Click me</a>
</div>
<script>
new Vue({
el: '#app',
data: {
userInput: 'javascript:alert(1)'
}
})
</script>
```
### v-on with user-controlled handlers
`v-on`はその値を`new Function`でコンパイルします。その値がユーザーから来る場合、コード実行を手渡すことになります。
```html
<div id="app">
<button v-on:click="malicious">Click me</button>
</div>
<script>
new Vue({
el: '#app',
data: { malicious: 'alert(1)' }
})
</script>
```
### 動的属性 / イベント名
ユーザー提供の名前を `v-bind:[attr]` または `v-on:[event]` に使用することで、攻撃者は任意の属性やイベントハンドラーを作成でき、静的分析や多くのCSPルールを回避します。
```html
<img v-bind:[userAttr]="payload">
<!-- userAttr = 'onerror', payload = 'alert(1)' -->
```
### ダイナミックコンポーネント (`<component :is>`)
`:is` にユーザーストリングを許可すると、任意のコンポーネントやインラインテンプレートをマウントできるため、ブラウザでは危険であり、SSRでは壊滅的です。
```html
<component :is="userChoice"></component>
<!-- userChoice = '<script>alert(1)</script>' -->
```
### SSRにおける信頼できないテンプレート
サーバーサイドレンダリング中、テンプレートは**あなたのサーバー上で**実行されます。ユーザーのHTMLを注入することで、XSSを完全なリモートコード実行（RCE）にエスカレートさせることができます。`vue-template-compiler`のCVEがリスクを証明しています。
```js
// DANGER – never do this
const app = createSSRApp({ template: userProvidedHtml })
```
### フィルター / レンダー関数が eval を実行する
ユーザーデータに対してレンダーストリングを構築したり `eval` / `new Function` を呼び出すレガシーフィルターは、別の XSS ベクターです。これらを計算プロパティに置き換えてください。
```js
Vue.filter('run', code => eval(code))   // DANGER
```
---

## Vueプロジェクトにおけるその他の一般的な脆弱性

### プラグインにおけるプロトタイプ汚染
一部のプラグイン（例：**vue-i18n**）のディープマージヘルパーは、攻撃者が`Object.prototype`に書き込むことを可能にしました。
```js
import merge from 'deepmerge'
merge({}, JSON.parse('{ "__proto__": { "polluted": true } }'))
```
### vue-routerによるオープンリダイレクト
チェックされていないユーザーのURLを`router.push`または`<router-link>`に渡すと、`javascript:` URIやフィッシングドメインにリダイレクトされる可能性があります。
```js
this.$router.push(this.$route.query.next) // DANGER
```
### CSRF in Axios / fetch
SPAsは依然としてサーバー側のCSRFトークンが必要です; SameSiteクッキーだけでは自動送信されたクロスオリジンPOSTをブロックできません。
```js
axios.post('/api/transfer', data, {
headers: { 'X-CSRF-TOKEN': token }
})
```
### Click-jacking
Vueアプリは、`X-Frame-Options: DENY` と `Content-Security-Policy: frame-ancestors 'none'` の両方を送信しない限り、フレーム化可能です。
```http
X-Frame-Options: DENY
Content-Security-Policy: frame-ancestors 'none';
```
### Content-Security-Policyの落とし穴
フルVueビルドは`unsafe-eval`が必要です。危険なソースを排除できるように、ランタイムビルドまたはプリコンパイルされたテンプレートに切り替えてください。
```http
Content-Security-Policy: default-src 'self'; script-src 'self';
```
### Supply-chain attacks (node-ipc – March 2022)
**node-ipc**の妨害は、Vue CLIによって引き起こされ、遷移依存関係が開発マシン上で任意のコードを実行できることを示しました。バージョンを固定し、頻繁に監査してください。
```shell
npm ci --ignore-scripts   # safer install
```
---

## ハードニングチェックリスト

1. **すべての文字列をサニタイズ**してから`v-html`に渡す（DOMPurify）。
2. **許可されたスキーム、属性、コンポーネント、およびイベントをホワイトリスト化**する。
3. **`eval`と動的テンプレートを完全に避ける**。
4. **依存関係を毎週パッチ**し、アドバイザリーを監視する。
5. **強力なHTTPヘッダーを送信**する（CSP、HSTS、XFO、CSRF）。
6. **監査、ロックファイル、署名付きコミットでサプライチェーンをロック**する。

## 参考文献

- [https://www.stackhawk.com/blog/vue-xss-guide-examples-and-prevention/](https://www.stackhawk.com/blog/vue-xss-guide-examples-and-prevention/)
- [https://medium.com/@isaacwangethi30/vue-js-security-6e246a7613da](https://medium.com/@isaacwangethi30/vue-js-security-6e246a7613da)
- [https://vuejs.org/guide/best-practices/security](https://vuejs.org/guide/best-practices/security)

{{#include ../../banners/hacktricks-training.md}}
