# Descobrindo CloudFlare

{{#include ../../banners/hacktricks-training.md}}

## Técnicas Comuns para Descobrir Cloudflare

- Você pode usar algum serviço que lhe dê os **historical DNS records** do domínio. Talvez a página web esteja rodando em um IP usado anteriormente.
- O mesmo pode ser conseguido **checking historical SSL certificates** que podem apontar para o origin IP address.
- Verifique também os **DNS records of other subdomains pointing directly to IPs**, pois é possível que outros subdomínios apontem para o mesmo servidor (talvez oferecendo FTP, mail ou qualquer outro serviço).
- Se encontrar um **SSRF inside the web application** você pode abusá-lo para obter o IP do servidor.
- Busque uma string única da página web em buscadores como shodan (e talvez google e similares?). Talvez você encontre um IP com esse conteúdo.
- De forma similar, em vez de procurar por uma uniq string você pode buscar pelo favicon com a ferramenta: [https://github.com/karma9874/CloudFlare-IP](https://github.com/karma9874/CloudFlare-IP) ou com [https://github.com/pielco11/fav-up](https://github.com/pielco11/fav-up)
- Isso não funcionará com muita frequência porque o servidor precisa enviar a mesma resposta quando acessado pelo endereço IP, mas nunca se sabe.

## Ferramentas para descobrir Cloudflare

- Pesquise o domínio em [http://www.crimeflare.org:82/cfs.html](http://www.crimeflare.org:82/cfs.html) ou [https://crimeflare.herokuapp.com](https://crimeflare.herokuapp.com). Ou use a ferramenta [CloudPeler](https://github.com/zidansec/CloudPeler) (que usa essa API)
- Pesquise o domínio em [https://leaked.site/index.php?resolver/cloudflare.0/](https://leaked.site/index.php?resolver/cloudflare.0/)
- [**CF-Hero**](https://github.com/musana/CF-Hero) é uma ferramenta de reconhecimento abrangente desenvolvida para descobrir os endereços IP reais de aplicações web protegidas pelo Cloudflare. Ela realiza coleta de inteligência multi-fonte através de vários métodos.
- [**CloudFlair**](https://github.com/christophetd/CloudFlair) é uma ferramenta que busca usando certificados do Censys que contêm o nome de domínio, então procura por IPv4s dentro desses certificados e, por fim, tenta acessar a página web nesses IPs.
- [**CloakQuest3r**](https://github.com/spyboy-productions/CloakQuest3r): CloakQuest3r é uma poderosa ferramenta em Python meticulosamente construída para descobrir o IP verdadeiro de websites protegidos pelo Cloudflare e outras alternativas, um serviço amplamente adotado de segurança e melhoria de performance web. Sua missão central é discernir com precisão o endereço IP real de servidores web que estão ocultos atrás do escudo protetor do Cloudflare.
- [Censys](https://search.censys.io/)
- [Shodan](https://shodan.io/)
- [Bypass-firewalls-by-DNS-history](https://github.com/vincentcox/bypass-firewalls-by-DNS-history)
- Se você tem um conjunto de IPs potenciais onde a página web pode estar localizada, você pode usar [https://github.com/hakluke/hakoriginfinder](https://github.com/hakluke/hakoriginfinder)
```bash
# You can check if the tool is working with
prips 1.0.0.0/30 | hakoriginfinder -h one.one.one.one

# If you know the company is using AWS you could use the previous tool to search the
## web page inside the EC2 IPs
DOMAIN=something.com
WIDE_REGION=us
for ir in `curl https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | select(.region|test("^us")) | .ip_prefix'`; do
echo "Checking $ir"
prips $ir | hakoriginfinder -h "$DOMAIN"
done
```
## Descobrindo o Cloudflare a partir da infraestrutura de nuvem

Observe que, embora isto tenha sido feito em máquinas AWS, poderia ser feito em qualquer outro provedor de nuvem.

Para uma melhor descrição deste processo, confira:


{{#ref}}
https://trickest.com/blog/cloudflare-bypass-discover-ip-addresses-aws/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks
{{#endref}}
```bash
# Find open ports
sudo masscan --max-rate 10000 -p80,443 $(curl -s https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | .ip_prefix' | tr '\n' ' ') | grep "open"  > all_open.txt
# Format results
cat all_open.txt | sed 's,.*port \(.*\)/tcp on \(.*\),\2:\1,' | tr -d " " > all_open_formated.txt
# Search actual web pages
httpx -silent -threads 200 -l all_open_formated.txt -random-agent -follow-redirects -json -no-color -o webs.json
# Format web results and remove eternal redirects
cat webs.json | jq -r "select((.failed==false) and (.chain_status_codes | length) < 9) | .url" | sort -u > aws_webs.json

# Search via Host header
httpx -json -no-color -list aws_webs.json -header Host: cloudflare.malwareworld.com -threads 250 -random-agent -follow-redirects -o web_checks.json
```
## Contornando o Cloudflare via Cloudflare

### Authenticated Origin Pulls

Este mecanismo depende de **cliente** [**SSL certificates**](https://socradar.io/how-to-monitor-your-ssl-certificates-expiration-easily-and-why/) **para autenticar conexões** entre os servidores **reverse-proxy** do **Cloudflare** e o servidor de **origem**, o que é chamado de **mTLS**.

Em vez de configurar seu próprio certificado, os clientes podem simplesmente usar o certificado do **Cloudflare** para permitir qualquer conexão proveniente do Cloudflare, **independentemente do tenant**.

> [!CAUTION]
> Portanto, um atacante poderia simplesmente configurar um **domain in Cloudflare using Cloudflare's certificate and point** para o endereço **IP** do **victim**. Desta forma, deixando seu domínio completamente desprotegido, o Cloudflare não protegerá as requisições enviadas.

More info [**here**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/).

### Allowlist Cloudflare IP Addresses

Isso irá **rejeitar conexões que não se originem das** faixas de IP do **Cloudflare**. Isso também é vulnerável à configuração anterior, onde um atacante simplesmente **aponta seu próprio domain in Cloudflare** para o endereço **IP** do **victim** e o ataca.

More info [**here**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/).

## Bypass Cloudflare for scraping

### Cache

Às vezes você só quer contornar o Cloudflare para apenas scrape a página web. Há algumas opções para isso:

- Use Google cache: `https://webcache.googleusercontent.com/search?q=cache:https://www.petsathome.com/shop/en/pets/dog`
- Use outros serviços de cache como [https://archive.org/web/](https://archive.org/web/)

### Tools

Algumas ferramentas como as seguintes conseguem contornar (ou conseguiram contornar) a proteção do Cloudflare contra scraping:

- [https://github.com/sarperavci/CloudflareBypassForScraping](https://github.com/sarperavci/CloudflareBypassForScraping)

### Cloudflare Solvers

Foram desenvolvidos diversos solvers para o Cloudflare:

- [FlareSolverr](https://github.com/FlareSolverr/FlareSolverr)
- [cloudscraper](https://github.com/VeNoMouS/cloudscraper) [Guide here](https://scrapeops.io/python-web-scraping-playbook/python-cloudscraper/)
- [cloudflare-scrape](https://github.com/Anorov/cloudflare-scrape)
- [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)
- [Cloudflare-IUAM-Solver](https://github.com/ninja-beans/cloudflare-iuam-solver)
- [cloudflare-bypass](https://github.com/devgianlu/cloudflare-bypass) \[Archived]
- [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)

### Fortified Headless Browsers <a href="#option-4-scrape-with-fortified-headless-browsers" id="option-4-scrape-with-fortified-headless-browsers"></a>

Use um headless browser que não seja detectado como um navegador automatizado (pode ser necessário customizá-lo para isso). Algumas opções são:

- **Puppeteer:** The [stealth plugin](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth) para [puppeteer](https://github.com/puppeteer/puppeteer).
- **Playwright:** The [stealth plugin](https://www.npmjs.com/package/playwright-stealth) está chegando ao Playwright em breve. Acompanhe o desenvolvimento [here](https://github.com/berstend/puppeteer-extra/issues/454) e [here](https://github.com/berstend/puppeteer-extra/tree/master/packages/playwright-extra).
- **Selenium:** [SeleniumBase](https://github.com/seleniumbase/SeleniumBase) é um framework moderno de automação de browser com capacidades stealth embutidas. Oferece dois modos: **UC Mode**, um patch otimizado do Selenium ChromeDriver baseado em [undetected-chromedriver](https://github.com/ultrafunkamsterdam/undetected-chromedriver), e **CDP Mode**, que pode contornar detecção de bots, resolver CAPTCHAs e aproveitar métodos avançados do Chrome DevTools Protocol.

### Smart Proxy With Cloudflare Built-In Bypass <a href="#option-5-smart-proxy-with-cloudflare-built-in-bypass" id="option-5-smart-proxy-with-cloudflare-built-in-bypass"></a>

**Smart proxies** são continuamente atualizados por empresas especializadas, visando superar as medidas de segurança do Cloudflare (já que esse é o negócio delas).

Alguns deles são:

- [ScraperAPI](https://www.scraperapi.com/?fp_ref=scrapeops)
- [Scrapingbee](https://www.scrapingbee.com/?fpr=scrapeops)
- [Oxylabs](https://oxylabs.go2cloud.org/aff_c?offer_id=7&aff_id=379&url_id=32)
- [Smartproxy](https://prf.hn/click/camref:1100loxdG/[p_id:1100l442001]/destination:https%3A%2F%2Fsmartproxy.com%2Fscraping%2Fweb) são conhecidos por seus mecanismos proprietários de bypass do Cloudflare.

Para quem busca uma solução otimizada, o [ScrapeOps Proxy Aggregator](https://scrapeops.io/proxy-aggregator/) se destaca. Esse serviço integra mais de 20 provedores de proxy em uma única API, selecionando automaticamente o proxy mais adequado e custo-efetivo para seus domínios alvo, oferecendo assim uma opção superior para contornar as defesas do Cloudflare.

### Reverse Engineer Cloudflare Anti-Bot Protection <a href="#option-6-reverse-engineer-cloudflare-anti-bot-protection" id="option-6-reverse-engineer-cloudflare-anti-bot-protection"></a>

Fazer engenharia reversa das medidas anti-bot do Cloudflare é uma tática usada por provedores de smart proxy, adequada para scraping em larga escala sem o alto custo de rodar muitos headless browsers.

**Vantagens:** Esse método permite criar um bypass extremamente eficiente que mira especificamente nas verificações do Cloudflare, ideal para operações em grande escala.

**Desvantagens:** A desvantagem é a complexidade envolvida em entender e enganar o sistema anti-bot deliberadamente obscuro do Cloudflare, exigindo esforço contínuo para testar diferentes estratégias e atualizar o bypass à medida que o Cloudflare reforça suas proteções.

Find more info about how to do this in the [original article](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/).

## References

- [https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/)

{{#include ../../banners/hacktricks-training.md}}
