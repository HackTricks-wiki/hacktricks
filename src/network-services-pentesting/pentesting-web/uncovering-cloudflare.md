# Kufichua CloudFlare

{{#include ../../banners/hacktricks-training.md}}

## Mbinu za Kawaida za Kufichua Cloudflare

- Unaweza kutumia huduma fulani inayokupa **historical DNS records** za domain. Labda ukurasa wa wavuti unafanya kazi kwenye anwani ya IP iliyotumika hapo awali.
- Ndivyo inaweza kufikiwa kwa **checking historical SSL certificates** ambazo zinaweza kuonyesha anwani ya origin IP address.
- Angalia pia **DNS records of other subdomains pointing directly to IPs**, kwani inawezekana subdomains nyingine zinaonyesha kwenye server ile ile (labda kwa kutoa FTP, mail au huduma nyingine yoyote).
- Ikiwa utapata **SSRF inside the web application** unaweza kuitumia kupata anwani ya IP ya server.
- Tafuta mnyororo wa kipekee wa ukurasa wa wavuti kwenye mashine za utafutaji kama shodan (na labda google na zinazofanana?). Labda unaweza kupata anwani ya IP yenye yale yaliyomo.
- Kwa njia inayofanana, badala ya kutafuta mnyororo wa kipekee unaweza kutafuta favicon icon kwa kutumia tool: [https://github.com/karma9874/CloudFlare-IP](https://github.com/karma9874/CloudFlare-IP) au [https://github.com/pielco11/fav-up](https://github.com/pielco11/fav-up)
- Hii haitafanya kazi mara nyingi kwa sababu server lazima itume jibu lile lile inapofikiwa kwa anwani ya IP, lakini hujui.

## Zana za kufichua Cloudflare

- Tafuta domain ndani ya [http://www.crimeflare.org:82/cfs.html](http://www.crimeflare.org:82/cfs.html) au [https://crimeflare.herokuapp.com](https://crimeflare.herokuapp.com). Au tumia tool [CloudPeler](https://github.com/zidansec/CloudPeler) (ambayo inatumia API hiyo)
- Tafuta domain kwenye [https://leaked.site/index.php?resolver/cloudflare.0/](https://leaked.site/index.php?resolver/cloudflare.0/)
- [**CF-Hero**](https://github.com/musana/CF-Hero) ni zana kamili ya uchunguzi iliyotengenezwa kugundua anwani halisi za IP za web applications zilizolindwa na Cloudflare. Inafanya ukusanyaji wa taarifa kutoka vyanzo vingi kwa kutumia mbinu mbalimbali.
- [**CloudFlair**](https://github.com/christophetd/CloudFlair) ni zana itakayotumia Censys certificates zinazojumuisha domain name, kisha itatafuta IPv4s ndani ya hizo certificates na hatimaye itajaribu kufikia ukurasa wa wavuti kwenye hizo IPs.
- [**CloakQuest3r**](https://github.com/spyboy-productions/CloakQuest3r): CloakQuest3r ni zana yenye nguvu ya Python iliyotengenezwa kwa umakini kufichua anwani halisi ya IP ya websites zilizolindwa na Cloudflare na mbadala nyingine, huduma inayotumika sana ya usalama wa wavuti na kuboresha utendaji. Lengo lake kuu ni kubaini kwa usahihi anwani halisi ya IP ya web servers zinazofichwa nyuma ya kinga ya Cloudflare.
- [Censys](https://search.censys.io/)
- [Shodan](https://shodan.io/)
- [Bypass-firewalls-by-DNS-history](https://github.com/vincentcox/bypass-firewalls-by-DNS-history)
- Ikiwa una seti ya IPs zinazowezekana ambapo ukurasa wa wavuti unako, unaweza kutumia [https://github.com/hakluke/hakoriginfinder](https://github.com/hakluke/hakoriginfinder)
```bash
# You can check if the tool is working with
prips 1.0.0.0/30 | hakoriginfinder -h one.one.one.one

# If you know the company is using AWS you could use the previous tool to search the
## web page inside the EC2 IPs
DOMAIN=something.com
WIDE_REGION=us
for ir in `curl https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | select(.region|test("^us")) | .ip_prefix'`; do
echo "Checking $ir"
prips $ir | hakoriginfinder -h "$DOMAIN"
done
```
## Kufichua Cloudflare kutoka miundombinu ya wingu

Kumbuka kwamba hata ikiwa hili lilifanywa kwa mashine za AWS, linaweza kufanywa kwa mtoa huduma mwingine wa wingu.

Kwa maelezo ya kina ya mchakato huu angalia:

{{#ref}}
https://trickest.com/blog/cloudflare-bypass-discover-ip-addresses-aws/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks
{{#endref}}
```bash
# Find open ports
sudo masscan --max-rate 10000 -p80,443 $(curl -s https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | .ip_prefix' | tr '\n' ' ') | grep "open"  > all_open.txt
# Format results
cat all_open.txt | sed 's,.*port \(.*\)/tcp on \(.*\),\2:\1,' | tr -d " " > all_open_formated.txt
# Search actual web pages
httpx -silent -threads 200 -l all_open_formated.txt -random-agent -follow-redirects -json -no-color -o webs.json
# Format web results and remove eternal redirects
cat webs.json | jq -r "select((.failed==false) and (.chain_status_codes | length) < 9) | .url" | sort -u > aws_webs.json

# Search via Host header
httpx -json -no-color -list aws_webs.json -header Host: cloudflare.malwareworld.com -threads 250 -random-agent -follow-redirects -o web_checks.json
```
## Kupita Cloudflare kupitia Cloudflare

### Authenticated Origin Pulls

Mfumo huu unategemea **client** [**SSL certificates**](https://socradar.io/how-to-monitor-your-ssl-certificates-expiration-easily-and-why/) **kuthibitisha muunganisho** kati ya **Cloudflare’s reverse-proxy** servers na **origin** server, ambayo inaitwa **mTLS**.

Badala ya kusanidi certificate zao, wateja wanaweza kutumia tu certificate ya Cloudflare kuruhusu muunganisho wowote kutoka Cloudflare, **bila kujali the tenant**.

> [!CAUTION]
> Kwa hiyo, mshambuliaji anaweza tu kuweka **domain in Cloudflare using Cloudflare's certificate and point** kwa **victim** domain **IP** address. Kwa njia hii, akiwa ameweka domain yake bila ulinzi kabisa, Cloudflare haitalinda maombi yatakayomtumwa.

More info [**here**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/).

### Allowlist Cloudflare IP Addresses

Hii itakataa **connections that do not originate from Cloudflare’s** IP address ranges. Hii pia inabadiliwa na usanidi uliotajwa hapo awali ambapo mshambuliaji anaweza tu **point his own domain in Cloudflare** kwa **victim** IP address na kui-shambuliza.

More info [**here**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/).

## Kupitisha Cloudflare kwa scraping

### Cache

Wakati mwingine unataka kupita Cloudflare ili tu scrape ukurasa wa wavuti. Kuna chaguzi kadhaa kwa hili:

- Use Google cache: `https://webcache.googleusercontent.com/search?q=cache:https://www.petsathome.com/shop/en/pets/dog`
- Use other cache services such as [https://archive.org/web/](https://archive.org/web/)

### Zana

Baadhi ya zana kama zifuatazo zinaweza bypass (au ziliweza bypass) ulinzi wa Cloudflare dhidi ya scraping:

- [https://github.com/sarperavci/CloudflareBypassForScraping](https://github.com/sarperavci/CloudflareBypassForScraping)

### Cloudflare Solvers

Kumezuliwa idadi ya Cloudflare solvers zilizotengenezwa:

- [FlareSolverr](https://github.com/FlareSolverr/FlareSolverr)
- [cloudscraper](https://github.com/VeNoMouS/cloudscraper) [Guide here](https://scrapeops.io/python-web-scraping-playbook/python-cloudscraper/)
- [cloudflare-scrape](https://github.com/Anorov/cloudflare-scrape)
- [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)
- [Cloudflare-IUAM-Solver](https://github.com/ninja-beans/cloudflare-iuam-solver)
- [cloudflare-bypass](https://github.com/devgianlu/cloudflare-bypass) \[Archived]
- [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)

### Fortified Headless Browsers <a href="#option-4-scrape-with-fortified-headless-browsers" id="option-4-scrape-with-fortified-headless-browsers"></a>

Tumia headless browser ambayo haigunduliki kama automated browser (huenda ukahitaji kuibadilisha kwa ajili ya hili). Baadhi ya chaguzi ni:

- **Puppeteer:** The [stealth plugin](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth) for [puppeteer](https://github.com/puppeteer/puppeteer).
- **Playwright:** The [stealth plugin](https://www.npmjs.com/package/playwright-stealth) is coming to Playwright soon. Follow developments [here](https://github.com/berstend/puppeteer-extra/issues/454) and [here](https://github.com/berstend/puppeteer-extra/tree/master/packages/playwright-extra).
- **Selenium:** [SeleniumBase](https://github.com/seleniumbase/SeleniumBase) ni framework ya kisasa ya browser automation yenye uwezo wa kujificha (built-in stealth capabilities). Inatoa mode mbili: **UC Mode**, patch ya Selenium ChromeDriver iliyoboreshwa msingi kwa [undetected-chromedriver](https://github.com/ultrafunkamsterdam/undetected-chromedriver), na **CDP Mode**, ambayo inaweza bypass bot detection, kutatua CAPTCHAs, na kutumia mbinu za Chrome DevTools Protocol.

### Smart Proxy With Cloudflare Built-In Bypass <a href="#option-5-smart-proxy-with-cloudflare-built-in-bypass" id="option-5-smart-proxy-with-cloudflare-built-in-bypass"></a>

**Smart proxies** zinaendelea kusasishwa na kampuni maalum, zikitafuta kupita tahadhari za usalama za Cloudflare (hiyo ndio biashara yao).

Baadhi yao ni:

- [ScraperAPI](https://www.scraperapi.com/?fp_ref=scrapeops)
- [Scrapingbee](https://www.scrapingbee.com/?fpr=scrapeops)
- [Oxylabs](https://oxylabs.go2cloud.org/aff_c?offer_id=7&aff_id=379&url_id=32)
- [Smartproxy](https://prf.hn/click/camref:1100loxdG/[p_id:1100l442001]/destination:https%3A%2F%2Fsmartproxy.com%2Fscraping%2Fweb) are noted for their proprietary Cloudflare bypass mechanisms.

Kwa wale wanaotafuta suluhisho lililo optimized, [ScrapeOps Proxy Aggregator](https://scrapeops.io/proxy-aggregator/) inasimama nje. Huduma hii inaunganisha zaidi ya watoaji proxy 20 katika API moja, ikichagua kiotomatiki proxy bora na yenye gharama nafuu kwa domain zako za lengo, hivyo kutoa chaguo bora kwa kuzunguka ulinzi wa Cloudflare.

### Reverse Engineer Cloudflare Anti-Bot Protection <a href="#option-6-reverse-engineer-cloudflare-anti-bot-protection" id="option-6-reverse-engineer-cloudflare-anti-bot-protection"></a>

Reverse engineering ya Cloudflare's anti-bot measures ni taktiki inayotumika na watoaji smart proxy, inayofaa kwa scraping kubwa bila gharama kubwa ya kuendesha headless browsers nyingi.

Faida: Njia hii inaruhusu uundaji wa bypass yenye ufanisi sana inayolenga haswa ukaguzi wa Cloudflare, inafaa kwa shughuli za wigo mkubwa.

Hasara: Hasara ni ugumu wa kuelewa na kudanganya mfumo wa anti-bot uliotengenezwa kwa makusudi, ukihitaji juhudi za kuendelea kujaribu mbinu tofauti na kusasisha bypass wakati Cloudflare inaboresha ulinzi wake.

Pata maelezo zaidi kuhusu jinsi ya kufanya hili katika [original article](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/).

## References

- [https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/)

{{#include ../../banners/hacktricks-training.md}}
