{{#include ../../../../banners/hacktricks-training.md}}

**Kumbuka muhimu:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** ni kazi ya PHP ambayo inaweza kutumika kupakia nyongeza za PHP. Ikiwa kazi hii haijazuiliwa inaweza kutumika vibaya ili **kuzidi `disable_functions` na kutekeleza amri zisizo na mipaka**.\
Hata hivyo, ina mipaka kadhaa kali:

- Kazi ya `dl` lazima iwe **ipo** katika **mazingira** na **isiwe imezuiliwa**
- Nyongeza ya PHP **lazima iwe imejengwa na toleo kuu sawa** (toleo la API la PHP) ambalo seva inatumia (unaweza kuona habari hii katika matokeo ya phpinfo)
- Nyongeza ya PHP lazima iwe **imewekwa katika directory** ambayo **imefafanuliwa** na **`extension_dir`** mwelekeo (unaweza kuona hii katika matokeo ya phpinfo). Ni vigumu sana kwamba mshambuliaji anayejaribu kutumia seva atakuwa na ufikiaji wa kuandika katika directory hii, hivyo hitaji hili labda litakuzuia kutumia mbinu hii).

**Ikiwa unakidhi mahitaji haya, endelea kusoma chapisho** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **kujifunza jinsi ya kuzidi disable_functions**. Hapa kuna muhtasari:

Kazi ya [dl](http://www.php.net/manual/en/function.dl.php) inatumika kupakia nyongeza za PHP kwa njia ya kidinari wakati wa utekelezaji wa skripti. Nyongeza za PHP, ambazo kwa kawaida zimeandikwa kwa C/C++, zinaongeza uwezo wa PHP. Mshambuliaji, baada ya kugundua kuwa kazi ya `dl` haijazuiliwa, anaamua kuunda nyongeza maalum ya PHP ili kutekeleza amri za mfumo.

### Hatua zilizochukuliwa na Mshambuliaji:

1. **Utambuzi wa Toleo la PHP:**

- Mshambuliaji anabaini toleo la PHP kwa kutumia skripti (`<?php echo 'PHP Version is '.PHP_VERSION; ?>`).

2. **Upataji wa Chanzo cha PHP:**

- Anapakua chanzo cha PHP kutoka kwenye [tovuti rasmi ya PHP](http://www.php.net/downloads.php) au [archive](http://museum.php.net) ikiwa toleo ni la zamani.

3. **Usanidi wa PHP wa Mitaa:**

- Anatoa na kufunga toleo maalum la PHP kwenye mfumo wake.

4. **Uundaji wa Nyongeza:**
- Anasoma [kuunda nyongeza za PHP](http://www.php.net/manual/en/zend.creating.php) na kuchunguza msimbo wa chanzo cha PHP.
- Anazingatia kuiga kazi ya [exec function](http://www.php.net/manual/en/function.exec.php) iliyoko `ext/standard/exec.c`.

### Maelezo ya Kuunda Nyongeza Maalum:

1. **ZEND_MODULE_API_NO:**

- `ZEND_MODULE_API_NO` katika `bypass.c` lazima ikae sawa na Ujenzi wa Nyongeza ya Zend wa sasa, inayoweza kupatikana kwa:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Mabadiliko ya PHP_FUNCTION:**
- Kwa matoleo ya hivi karibuni ya PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` inaweza kuhitaji marekebisho. Kipande cha msimbo kilichotolewa kinaelezea mabadiliko haya.

### Faili za Nyongeza Maalum:

- **bypass.c**:
- Inatekeleza kazi kuu ya nyongeza maalum.
- **php_bypass.h**:
- Faili ya kichwa, ikifafanua mali za nyongeza.
- **config.m4**:
- Inatumika na `phpize` kusanidi mazingira ya ujenzi wa nyongeza maalum.

### Kujenga Nyongeza:

1. **Amri za Uundaji:**

- Inatumia `phpize`, `./configure`, na `make` kujenga nyongeza.
- Nyongeza inayotokana na `bypass.so` kisha inapatikana katika saraka ndogo ya moduli.

2. **Usafishaji:**
- Inatekeleza `make clean` na `phpize --clean` baada ya ujenzi.

### Kupakia na Kutekeleza kwenye Seva ya Mwathirika:

1. **Ulinganifu wa Toleo:**

- Inahakikisha matoleo ya PHP API yanalingana kati ya mifumo ya mshambuliaji na mwathirika.

2. **Upakiaji wa Nyongeza:**

- Inatumia kazi ya `dl`, ikiepuka vizuizi kwa kutumia njia za uhusiano au skripti ili kuendesha mchakato.

3. **Utekelezaji wa Skripti:**
- Mshambuliaji anapakua `bypass.so` na skripti ya PHP kwenye seva ya mwathirika.
- Skripti inatumia kazi ya `dl_local` kupakia kwa kidinari `bypass.so` na kisha inaita `bypass_exec` kwa amri iliyopitishwa kupitia parameta ya swali `cmd`.

### Utekelezaji wa Amri:

- Mshambuliaji sasa anaweza kutekeleza amri kwa kufikia: `http://www.example.com/script.php?cmd=<command>`

Mwongozo huu wa kina unaelezea mchakato wa kuunda na kupeleka nyongeza ya PHP ili kutekeleza amri za mfumo, ikitumia kazi ya `dl`, ambayo inapaswa kuwa imezuiliwa ili kuzuia uvunjaji wa usalama kama huu.

{{#include ../../../../banners/hacktricks-training.md}}
