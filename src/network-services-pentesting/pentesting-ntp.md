# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Temel Bilgiler

**AÄŸ Zaman ProtokolÃ¼ (NTP)**, deÄŸiÅŸken gecikme sÃ¼relerine sahip aÄŸlar Ã¼zerinden bilgisayarlarÄ±n ve aÄŸ cihazlarÄ±nÄ±n saatlerini doÄŸru bir ÅŸekilde senkronize etmelerini saÄŸlar. IT operasyonlarÄ±, gÃ¼venlik ve gÃ¼nlÃ¼kleme iÃ§in kesin zaman tutmanÄ±n saÄŸlanmasÄ±nda kritik Ã¶neme sahiptir. Zaman, neredeyse her kimlik doÄŸrulama, kripto-protokol ve adli sÃ¼reÃ§te kullanÄ±ldÄ±ÄŸÄ±ndan, **NTP'yi etkileyebilen bir saldÄ±rgan genellikle gÃ¼venlik kontrollerini atlayabilir veya saldÄ±rÄ±larÄ± araÅŸtÄ±rmayÄ± zorlaÅŸtÄ±rabilir.**

### Ã–zet & GÃ¼venlik Ä°puÃ§larÄ±

- **AmaÃ§**: Cihaz saatlerini aÄŸlar Ã¼zerinden senkronize eder.
- **Ã–nemi**: GÃ¼venlik, gÃ¼nlÃ¼kleme, kripto-protokoller ve daÄŸÄ±tÄ±k sistemler iÃ§in kritik.
- **GÃ¼venlik Ã–nlemleri**:
- Kimlik doÄŸrulama ile gÃ¼venilir NTP veya NTS (AÄŸ Zaman GÃ¼venliÄŸi) kaynaklarÄ± kullanÄ±n.
- Daemon'u sorgulama/emir verme yetkisini kÄ±sÄ±tlayÄ±n (``restrict default noquery``, ``kod`` vb.).
- Eski Mod-6/7 kontrol sorgularÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±n (``monlist``, ``ntpdc``) veya oran sÄ±nÄ±rlamasÄ± uygulayÄ±n.
- ManipÃ¼lasyon iÃ§in senkronizasyon kaymasÄ±/sÄ±Ã§rama saniyesi durumunu izleyin.
- Daemon'u gÃ¼ncel tutun (aÅŸaÄŸÄ±daki son CVE'lere bakÄ±n).

**VarsayÄ±lan portlar**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Enumeration

### Klasik ntpd / ntpq / ntpdc
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (Ã§oÄŸu modern Linux daÄŸÄ±tÄ±mÄ±nda)

``cmdallow`` etkinleÅŸtirildiÄŸinde, uzaktan IP'lerden yalnÄ±zca birkaÃ§ izleme komutu kabul edilir:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
**M/S** bayraklarÄ±nÄ±n ve diÄŸer alanlarÄ±n (stratum, reach, jitter, vb.) anlamÄ± iÃ§in chronyc man sayfasÄ±na bakÄ±n.

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Kitle/Ä°nternet taramasÄ±
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## YapÄ±landÄ±rma dosyalarÄ±nÄ± inceleyin

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ yalnÄ±zca istemci)

Ã–zellikle ``restrict`` satÄ±rlarÄ±na, ``kod`` (Kiss-o'-Death) ayarlarÄ±na, ``disable monitor``/``includefile /etc/ntp/crypto`` ve *NTS*'nin etkin olup olmadÄ±ÄŸÄ±na (``nts enable``) dikkat edin.

---
## Son GÃ¼venlik AÃ§Ä±klarÄ± (2023-2025)

| YÄ±l | CVE | BileÅŸen | Etki |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | **ntpq** yanÄ±tlarÄ± aracÄ±lÄ±ÄŸÄ±yla eriÅŸilebilen Ã§oklu sÄ±nÄ±r dÄ±ÅŸÄ± yazmalar. **4.2.8p16**'da yamanmÄ±ÅŸ, gÃ¼ncelleyin veya dÃ¼zeltmeleri geri taÅŸÄ±yÄ±n. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023 | **CVE-2023-33192** | **ntpd-rs** (Rust uygulamasÄ±) | Bozuk **NTS** Ã§erezi, v0.3.3'ten Ã¶nce uzaktan **DoS**'ye neden olur â€“ NTS **devre dÄ±ÅŸÄ±** olsa bile 123 numaralÄ± portu etkiler. îˆ€citeîˆ‚turn4view0îˆ|
| 2024 | daÄŸÄ±tÄ±m gÃ¼ncellemeleri | **chrony 4.4 / 4.5** â€“ birkaÃ§ gÃ¼venlik gÃ¼Ã§lendirmesi ve NTS-KE dÃ¼zeltmesi (Ã¶rneÄŸin, SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024 | KayÄ±t DDoS | Cloudflare, **5.6 Tbps UDP yansÄ±ma** saldÄ±rÄ±sÄ± (kullanÄ±lan protokoller arasÄ±nda NTP) bildirmektedir. Ä°nternete aÃ§Ä±k sunucularda *monitor* ve *monlist*'i devre dÄ±ÅŸÄ± bÄ±rakÄ±n. îˆ€citeîˆ‚turn5search0îˆ|

> **SÃ¶mÃ¼rÃ¼ kitleri**: 2023 ntpq OOB-yazma serisi iÃ§in kanÄ±t konsepti yÃ¼kleri GitHub'da mevcuttur (Meinberg yazÄ±sÄ±na bakÄ±n) ve sistem yÃ¶neticilerinin istemci tarafÄ± kimlik avÄ± iÃ§in silahlandÄ±rÄ±labilir. îˆ€citeîˆ‚turn1search4îˆ

---
## Ä°leri DÃ¼zey SaldÄ±rÄ±lar

### 1. NTP Amplifikasyonu / YansÄ±ma

Eski Mod-7 ``monlist`` sorgusu, **600 host adresine** kadar dÃ¶nebilir ve hala binlerce Ä°nternet sunucusunda mevcuttur. YanÄ±t (428-468 bayt/girdi) 8 baytlÄ±k isteÄŸin *~ 200Ã—* daha bÃ¼yÃ¼k olduÄŸu iÃ§in, bir saldÄ±rgan Ã¼Ã§ haneli amplifikasyon faktÃ¶rlerine ulaÅŸabilir. Ã–nlemler:

- ntp 4.2.8p15+ sÃ¼rÃ¼mÃ¼ne yÃ¼kseltin ve **``disable monitor``** ekleyin.
- UDP/123'Ã¼ kenarda hÄ±z sÄ±nÄ±rlamasÄ± yapÄ±n veya DDoS cihazlarÄ±nda *sessions-required*'Ä± etkinleÅŸtirin.
- Kaynak sahteciliÄŸini engellemek iÃ§in *BCP 38* Ã§Ä±kÄ±ÅŸ filtrelemesini etkinleÅŸtirin.

AdÄ±m adÄ±m bir inceleme iÃ§in Cloudflareâ€™Ä±n Ã¶ÄŸrenim merkezi makalesine bakÄ±n. îˆ€citeîˆ‚turn5search1îˆ

### 2. Zaman KaydÄ±rma / Gecikme saldÄ±rÄ±larÄ± (Khronos / Chronos araÅŸtÄ±rmasÄ±)

Kimlik doÄŸrulama ile bile, bir yol Ã¼zerindeki saldÄ±rgan, paketleri dÃ¼ÅŸÃ¼rerek/geciktirerek **istemci saatini** sessizce **kaydÄ±rabilir**. IETF **Khronos (eski adÄ±yla Chronos) taslaÄŸÄ±**, arka planda Ã§eÅŸitli sunucularÄ± sorgulamayÄ± ve sonucu kontrol ederek > ğš¡ ms kaymayÄ± tespit etmeyi Ã¶nermektedir. Modern chrony (4.4+) zaten benzer bir kontrol filtresi (``maxdistance`` / ``maxjitter``) uygulamaktadÄ±r. îˆ€citeîˆ‚turn9search1îˆ

### 3. NTS kÃ¶tÃ¼ye kullanÄ±mÄ± ve 4460/tcp maruziyeti

NTS, aÄŸÄ±r kriptografiyi ayrÄ± bir **TLS 1.3 kanalÄ± Ã¼zerinde 4460/tcp** (``ntske/1``) taÅŸÄ±r. KÃ¶tÃ¼ uygulamalar (bkz. CVE-2023-33192) Ã§erezleri iÅŸlerken Ã§Ã¶kebilir veya zayÄ±f ÅŸifrelemelere izin verebilir. Pentester'lar ÅŸunlarÄ± yapmalÄ±dÄ±r:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Kendinden imzalÄ± veya sÃ¼resi dolmuÅŸ sertifikalarÄ± ve zayÄ±f ÅŸifreleme takÄ±mlarÄ± (non-AEAD) arayÄ±n. Referans: RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## GÃ¼Ã§lendirme / En Ä°yi Mevcut Uygulama (BCP-233 / RFC 8633)

*OperatÃ¶rler ÅUNLARÄ± yapmalÄ±dÄ±r:*

1. Tek kaynak zehirlenmesini Ã¶nlemek iÃ§in **â‰¥ 4** baÄŸÄ±msÄ±z, Ã§eÅŸitli zaman kaynaklarÄ± (kamusal havuzlar, GPS, PTP-kÃ¶prÃ¼leri) kullanÄ±n.
2. KÃ¶tÃ¼ye kullanan istemcilerin tam yanÄ±tlar yerine **Kiss-o'-Death** hÄ±z sÄ±nÄ±rlama paketleri almasÄ± iÃ§in ``kod`` ve ``limited``/``nomodify`` kÄ±sÄ±tlamalarÄ±nÄ± etkinleÅŸtirin.
3. **Panik** olaylarÄ± veya 1000 s'den fazla adÄ±m ayarlamalarÄ± iÃ§in daemon gÃ¼nlÃ¼klerini izleyin. (RFC 8633 Â§5.3'e gÃ¶re saldÄ±rÄ± imzalarÄ±.)
4. Leap-second kesintilerini Ã¶nlemek iÃ§in **leap-smear**'Ä± dÃ¼ÅŸÃ¼nÃ¼n, ancak *tÃ¼m* aÅŸaÄŸÄ± akÄ±ÅŸ istemcilerinin aynÄ± smear penceresini kullandÄ±ÄŸÄ±ndan emin olun.
5. Leap-second bayraklarÄ±nÄ±n kaÃ§Ä±rÄ±lmamasÄ± iÃ§in sorgulamayÄ± â‰¤24 saat tutun.

KapsamlÄ± bir kontrol listesi iÃ§in RFC 8633'e bakÄ±n. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## KullanÄ±ÅŸlÄ± AraÃ§lar

| AraÃ§ | AmaÃ§ | Ã–rnek |
|------|---------|---------|
| ``ntpwn`` | monlist & peers sorgularÄ±nÄ± yaymak iÃ§in script-kiddie sarmalayÄ±cÄ± | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Toplu tarama / monlist bayraÄŸÄ± iÃ§eren JSON Ã§Ä±ktÄ±sÄ± | YukarÄ±daki komuta bakÄ±n |
| ``chronyd`` ile ``allow`` | Pentest laboratuvarÄ±nda sahte NTP sunucusu Ã§alÄ±ÅŸtÄ±rma | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Wi-Fi'de zaman kaydÄ±rma MITM iÃ§in NTP paketleri enjekte etme | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## HackTricks Otomatik Komutlar
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Referanslar

- RFC 8915 â€“ *AÄŸ Zaman GÃ¼venliÄŸi iÃ§in AÄŸ Zaman ProtokolÃ¼* (port 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *AÄŸ Zaman ProtokolÃ¼ BCP* îˆ€citeîˆ‚turn8search0îˆ
- Cloudflare DDoS raporu 2024 Q4 (5.6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- Cloudflare *NTP Amplifikasyon SaldÄ±rÄ±sÄ±* makalesi îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 CVE serisi 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- NVD kayÄ±tlarÄ± **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- SUSE chrony gÃ¼venlik gÃ¼ncellemesi 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Khronos/Chronos taslaÄŸÄ± (zaman kaydÄ±rma azaltma) îˆ€citeîˆ‚turn9search1îˆ
- chronyc kÄ±lavuzu/uzaktan izleme iÃ§in Ã¶rnekler îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- zgrab2 ntp modÃ¼lÃ¼ belgeleri îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
