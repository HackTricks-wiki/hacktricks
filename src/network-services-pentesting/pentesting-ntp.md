# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## InformaÃ§Ãµes BÃ¡sicas

O **Protocolo de Tempo de Rede (NTP)** garante que computadores e dispositivos de rede em redes com latÃªncia variÃ¡vel sincronizem seus relÃ³gios com precisÃ£o. Ã‰ vital para manter a cronometragem precisa em operaÃ§Ãµes de TI, seguranÃ§a e registro. Como o tempo Ã© usado em quase todos os processos de autenticaÃ§Ã£o, criptografia e forense, **um atacante que pode influenciar o NTP pode frequentemente contornar controles de seguranÃ§a ou tornar os ataques mais difÃ­ceis de investigar.**

### Resumo & Dicas de SeguranÃ§a

- **PropÃ³sito**: Sincroniza os relÃ³gios dos dispositivos em redes.
- **ImportÃ¢ncia**: CrÃ­tico para seguranÃ§a, registro, criptografia e sistemas distribuÃ­dos.
- **Medidas de SeguranÃ§a**:
- Use fontes NTP ou NTS (SeguranÃ§a de Tempo de Rede) confiÃ¡veis com autenticaÃ§Ã£o.
- Restringir quem pode consultar/comandar o daemon (``restrict default noquery``, ``kod`` etc.).
- Desativar consultas de controle de modo legado 6/7 (``monlist``, ``ntpdc``) ou limitar a taxa delas.
- Monitorar a deriva de sincronizaÃ§Ã£o/estado de segundo bissexto para adulteraÃ§Ã£o.
- Manter o daemon atualizado (veja os CVEs recentes abaixo).

**Portas padrÃ£o**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## EnumeraÃ§Ã£o

### ntpd / ntpq / ntpdc ClÃ¡ssico
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (na maioria das distribuiÃ§Ãµes Linux modernas)

Apenas um punhado de comandos de monitoramento Ã© aceito de IPs remotos quando ``cmdallow`` estÃ¡ habilitado:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Veja a pÃ¡gina do manual do chronyc para o significado das flags **M/S** e outros campos (stratum, reach, jitter, etc.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Escaneamento em massa/Internet
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Examine arquivos de configuraÃ§Ã£o

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ apenas cliente)

Preste atenÃ§Ã£o especial Ã s linhas ``restrict``, configuraÃ§Ãµes ``kod`` (Kiss-o'-Death), ``disable monitor``/``includefile /etc/ntp/crypto`` e se *NTS* estÃ¡ habilitado (``nts enable``).

---
## Vulnerabilidades Recentes (2023-2025)

| Ano | CVE | Componente | Impacto |
|-----|-----|------------|---------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | MÃºltiplas gravaÃ§Ãµes fora dos limites acessÃ­veis via respostas **ntpq**. Patch em **4.2.8p16** ğŸ¡’ atualize ou faÃ§a back-port das correÃ§Ãµes. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023 | **CVE-2023-33192** | **ntpd-rs** (implementaÃ§Ã£o em Rust) | Cookie **NTS** malformado causa **DoS** remoto antes da v0.3.3 â€“ afeta a porta 123 mesmo quando NTS **desabilitado**. îˆ€citeîˆ‚turn4view0îˆ|
| 2024 | atualizaÃ§Ãµes de distro | **chrony 4.4 / 4.5** â€“ vÃ¡rias correÃ§Ãµes de seguranÃ§a e NTS-KE (por exemplo, SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024 | Registro DDoS | Cloudflare relata um ataque de **reflexÃ£o UDP de 5.6 Tbps** (NTP entre os protocolos utilizados). Mantenha *monitor* e *monlist* desabilitados em hosts expostos Ã  Internet. îˆ€citeîˆ‚turn5search0îˆ|

> **Kits de exploraÃ§Ã£o**: Payloads de prova de conceito para a sÃ©rie de gravaÃ§Ãµes OOB do ntpq de 2023 estÃ£o no GitHub (veja o artigo da Meinberg) e podem ser armados para phishing do lado do cliente de sysadmins. îˆ€citeîˆ‚turn1search4îˆ

---
## Ataques AvanÃ§ados

### 1. AmplificaÃ§Ã£o / ReflexÃ£o NTP

A consulta legada Mode-7 ``monlist`` retorna atÃ© **600 endereÃ§os de host** e ainda estÃ¡ presente em milhares de hosts na Internet. Como a resposta (428-468 bytes/entrada) Ã© *~ 200Ã—* maior que a solicitaÃ§Ã£o de 8 bytes, um atacante pode alcanÃ§ar fatores de amplificaÃ§Ã£o de trÃªs dÃ­gitos. MitigaÃ§Ãµes:

- Atualize para ntp 4.2.8p15+ e **adicione** ``disable monitor``.
- Limite a taxa de UDP/123 na borda ou habilite *sessions-required* em dispositivos DDoS.
- Habilite filtragem de egress *BCP 38* para bloquear spoofing de origem.

Veja o artigo do centro de aprendizado da Cloudflare para uma explicaÃ§Ã£o passo a passo. îˆ€citeîˆ‚turn5search1îˆ

### 2. Ataques de Deslocamento de Tempo / Atraso (pesquisa Khronos / Chronos)

Mesmo com autenticaÃ§Ã£o, um atacante na rota pode silenciosamente **deslocar o relÃ³gio do cliente** ao descartar/atrasar pacotes. O rascunho **Khronos (anteriormente Chronos)** da IETF propÃµe consultar um conjunto diversificado de servidores em segundo plano e verificar a sanidade do resultado para detectar um deslocamento > ğš¡ ms. O chrony moderno (4.4+) jÃ¡ implementa um filtro de sanidade semelhante (``maxdistance`` / ``maxjitter``). îˆ€citeîˆ‚turn9search1îˆ

### 3. Abuso de NTS e exposiÃ§Ã£o 4460/tcp

NTS move a criptografia pesada para um **canal TLS 1.3 separado na porta 4460/tcp** (``ntske/1``). ImplementaÃ§Ãµes ruins (veja CVE-2023-33192) travam ao analisar cookies ou permitem cifras fracas. Os pentesters devem:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Procure por certificados autoassinados ou expirados e suÃ­tes de cifra fracas (nÃ£o-AEAD). ReferÃªncia: RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## Fortalecimento / Melhor PrÃ¡tica Atual (BCP-233 / RFC 8633)

*Os operadores DEVEM:*

1. Usar **â‰¥ 4** fontes de tempo independentes e diversas (pools pÃºblicos, GPS, pontes PTP) para evitar contaminaÃ§Ã£o de fonte Ãºnica.
2. Habilitar restriÃ§Ãµes ``kod`` e ``limited``/``nomodify`` para que clientes abusivos recebam pacotes de limite de taxa **Kiss-o'-Death** em vez de respostas completas.
3. Monitorar logs do daemon para eventos de **panic** ou ajustes de passo > 1000 s. (Assinaturas de ataque por RFC 8633 Â§5.3.)
4. Considerar **leap-smear** para evitar interrupÃ§Ãµes de segundo bissexto, mas garantir que *todos* os clientes a montante usem a mesma janela de smear.
5. Manter polling â‰¤24 h para que as bandeiras de segundo bissexto nÃ£o sejam perdidas.

Consulte a RFC 8633 para uma lista de verificaÃ§Ã£o abrangente. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Ferramentas Ãšteis

| Ferramenta | PropÃ³sito | Exemplo |
|------------|-----------|---------|
| ``ntpwn`` | Wrapper de script-kiddie para spray de consultas monlist & peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Escaneamento em massa / saÃ­da JSON incluindo flag monlist | Veja o comando acima |
| ``chronyd`` com ``allow`` | Executar servidor NTP malicioso em laboratÃ³rio de pentest | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Injetar pacotes NTP para MITM de desvio de tempo no Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Comandos AutomÃ¡ticos HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## ReferÃªncias

- RFC 8915 â€“ *SeguranÃ§a de Tempo de Rede para o Protocolo de Tempo de Rede* (porta 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *Protocolo de Tempo de Rede BCP* îˆ€citeîˆ‚turn8search0îˆ
- RelatÃ³rio de DDoS da Cloudflare Q4 2024 (5,6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- Artigo da Cloudflare sobre *Ataque de AmplificaÃ§Ã£o NTP* îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 sÃ©rie CVE 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- Entradas NVD **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- AtualizaÃ§Ã£o de seguranÃ§a do chrony da SUSE 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Rascunho Khronos/Chronos (mitigaÃ§Ã£o de deslocamento de tempo) îˆ€citeîˆ‚turn9search1îˆ
- Manual/examples do chronyc para monitoramento remoto îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- DocumentaÃ§Ã£o do mÃ³dulo ntp do zgrab2 îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
