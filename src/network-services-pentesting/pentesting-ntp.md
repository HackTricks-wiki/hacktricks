# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Informations de base

Le **Network Time Protocol (NTP)** garantit que les ordinateurs et les dispositifs r√©seau sur des r√©seaux √† latence variable synchronisent leurs horloges avec pr√©cision. C'est vital pour maintenir une chronom√©trie pr√©cise dans les op√©rations informatiques, la s√©curit√© et la journalisation. Parce que le temps est utilis√© dans presque tous les processus d'authentification, de crypto-protocole et d'analyse judiciaire, **un attaquant capable d'influencer NTP peut souvent contourner les contr√¥les de s√©curit√© ou rendre les attaques plus difficiles √† enqu√™ter.**

### R√©sum√© & Conseils de s√©curit√©

- **Objectif** : Synchronise les horloges des dispositifs sur les r√©seaux.
- **Importance** : Critique pour la s√©curit√©, la journalisation, les crypto-protocoles et les syst√®mes distribu√©s.
- **Mesures de s√©curit√©** :
- Utilisez des sources NTP ou NTS (Network Time Security) de confiance avec authentification.
- Restreindre qui peut interroger/commander le d√©mon (``restrict default noquery``, ``kod`` etc.).
- D√©sactiver les requ√™tes de contr√¥le Mode-6/7 h√©rit√©es (``monlist``, ``ntpdc``) ou les limiter en taux.
- Surveiller la d√©rive de synchronisation/l'√©tat des secondes intercalaires pour d√©tection de falsification.
- Gardez le d√©mon √† jour (voir les CVE r√©cents ci-dessous).

**Ports par d√©faut**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) ‚Äì TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## √ânum√©ration

### ntpd / ntpq / ntpdc classique
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (dans la plupart des distributions Linux modernes)

Seule une poign√©e de commandes de surveillance sont accept√©es depuis des IP distantes lorsque ``cmdallow`` est activ√© :
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Voir la page de manuel de chronyc pour la signification des indicateurs **M/S** et d'autres champs (stratum, reach, jitter, etc.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Scan de masse/Internet
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Examinez les fichiers de configuration

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd ‚Äì client uniquement)

Faites particuli√®rement attention aux lignes ``restrict``, aux param√®tres ``kod`` (Kiss-o'-Death), √† ``disable monitor``/``includefile /etc/ntp/crypto`` et √† savoir si *NTS* est activ√© (``nts enable``).

---
## Vuln√©rabilit√©s r√©centes (2023-2025)

| Ann√©e | CVE | Composant | Impact |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551‚Üí26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | √âcritures hors limites multiples accessibles via les r√©ponses **ntpq**. Correctif dans **4.2.8p16** ü°í mise √† niveau ou correctifs de r√©troportage. |
| 2023 | **CVE-2023-33192** | **ntpd-rs** (impl√©mentation Rust) | Un cookie **NTS** malform√© provoque un **DoS** √† distance avant v0.3.3 ‚Äì affecte le port 123 m√™me lorsque NTS est **d√©sactiv√©**. |
| 2024 | mises √† jour de distribution | **chrony 4.4 / 4.5** ‚Äì plusieurs durcissements de s√©curit√© & correctifs NTS-KE (par exemple, SUSE-RU-2024:2022) |
| 2024 | DDoS record | Cloudflare signale une attaque de **r√©flexion UDP de 5,6 Tbps** (NTP parmi les protocoles utilis√©s). Gardez *monitor* & *monlist* d√©sactiv√©s sur les h√¥tes expos√©s √† Internet. |

> **Kits d'exploitation** : Des charges utiles de preuve de concept pour la s√©rie d'√©critures OOB ntpq 2023 sont sur GitHub (voir l'article de Meinberg) et peuvent √™tre arm√©es pour le phishing c√¥t√© client des administrateurs syst√®me.

---
## Attaques avanc√©es

### 1. Amplification / R√©flexion NTP

La requ√™te Mode-7 ``monlist`` renvoie jusqu'√† **600 adresses h√¥tes** et est toujours pr√©sente sur des milliers d'h√¥tes Internet. Comme la r√©ponse (428-468 octets/entr√©e) est *~ 200√ó* plus grande que la requ√™te de 8 octets, un attaquant peut atteindre des facteurs d'amplification √† trois chiffres. Att√©nuations :

- Mettez √† niveau vers ntp 4.2.8p15+ et **ajoutez** ``disable monitor``.
- Limitez le d√©bit UDP/123 √† la p√©riph√©rie ou activez *sessions-required* sur les appareils DDoS.
- Activez le filtrage de sortie *BCP 38* pour bloquer le spoofing de source.

Consultez l'article du centre d'apprentissage de Cloudflare pour un d√©compte √©tape par √©tape.

### 2. Attaques de d√©calage / retard temporel (recherche Khronos / Chronos)

M√™me avec authentification, un attaquant sur le chemin peut silencieusement **d√©caler l'horloge du client** en supprimant/d√©lai des paquets. Le **brouillon IETF Khronos (anciennement Chronos)** propose d'interroger un ensemble diversifi√© de serveurs en arri√®re-plan et de v√©rifier la coh√©rence du r√©sultat pour d√©tecter un d√©calage > ùö° ms. Le chrony moderne (4.4+) impl√©mente d√©j√† un filtre de coh√©rence similaire (``maxdistance`` / ``maxjitter``).

### 3. Abus de NTS & exposition 4460/tcp

NTS d√©place le lourd cryptage vers un **canal TLS 1.3 s√©par√© sur 4460/tcp** (``ntske/1``). Les mauvaises impl√©mentations (voir CVE-2023-33192) plantent lors de l'analyse des cookies ou permettent des chiffrements faibles. Les pentesters devraient :
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Recherchez des certificats auto-sign√©s ou expir√©s et des suites de chiffrement faibles (non-AEAD). R√©f√©rence : RFC 8915 ¬ß4.

---
## Renforcement / Meilleures Pratiques Actuelles (BCP-233 / RFC 8633)

*Les op√©rateurs DOIVENT :*

1. Utiliser **‚â• 4** sources de temps ind√©pendantes et diverses (pools publics, GPS, ponts PTP) pour √©viter le empoisonnement par source unique.
2. Activer les restrictions ``kod`` et ``limited``/``nomodify`` afin que les clients abusifs re√ßoivent des paquets de limitation de taux **Kiss-o'-Death** au lieu de r√©ponses compl√®tes.
3. Surveiller les journaux du d√©mon pour des √©v√©nements **panic** ou des ajustements de pas > 1000 s. (Signatures d'attaque selon RFC 8633 ¬ß5.3.)
4. Envisager **leap-smear** pour √©viter les pannes de seconde intercalaire, mais s'assurer que *tous* les clients en aval utilisent la m√™me fen√™tre de smear.
5. Garder le polling ‚â§24 h afin que les indicateurs de seconde intercalaire ne soient pas manqu√©s.

Voir RFC 8633 pour une liste de contr√¥le compl√®te.

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Outils Utiles

| Outil | But | Exemple |
|-------|-----|---------|
| ``ntpwn`` | Wrapper pour script-kiddie pour pulv√©riser les requ√™tes monlist & peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Scan de masse / sortie JSON incluant le drapeau monlist | Voir la commande ci-dessus |
| ``chronyd`` avec ``allow`` | Ex√©cuter un serveur NTP rogue dans un laboratoire de pentest | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Injecter des paquets NTP pour un MITM de d√©calage horaire sur Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Commandes Automatiques HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## R√©f√©rences

- RFC 8915 ‚Äì *S√©curit√© du temps r√©seau pour le protocole de temps r√©seau* (port 4460)
- RFC 8633 ‚Äì *Protocole de temps r√©seau BCP*
- Rapport DDoS de Cloudflare Q4 2024 (5,6 Tbps)
- Article de Cloudflare sur l'*attaque d'amplification NTP*
- NTP 4.2.8p15 s√©rie CVE 2023-04
- Entr√©es NVD **CVE-2023-26551‚Äì55**, **CVE-2023-33192**
- Mise √† jour de s√©curit√© chrony SUSE 2024 (chrony 4.5)
- Projet Khronos/Chronos (att√©nuation du d√©calage horaire)
- Manuel chronyc/exemples pour la surveillance √† distance
- Docs du module ntp zgrab2
{{#include ../banners/hacktricks-training.md}}
