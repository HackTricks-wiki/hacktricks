# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Podstawowe informacje

**ProtokÃ³Å‚ Czasu Sieciowego (NTP)** zapewnia, Å¼e komputery i urzÄ…dzenia sieciowe w sieciach o zmiennej latencji synchronizujÄ… swoje zegary dokÅ‚adnie. Jest to kluczowe dla utrzymania precyzyjnego pomiaru czasu w operacjach IT, bezpieczeÅ„stwie i logowaniu. PoniewaÅ¼ czas jest uÅ¼ywany w niemal kaÅ¼dym procesie uwierzytelniania, protokole kryptograficznym i procesie kryminalistycznym, **atakujÄ…cy, ktÃ³ry moÅ¼e wpÅ‚ywaÄ‡ na NTP, czÄ™sto moÅ¼e obejÅ›Ä‡ kontrole bezpieczeÅ„stwa lub utrudniÄ‡ badanie atakÃ³w.**

### Podsumowanie i wskazÃ³wki dotyczÄ…ce bezpieczeÅ„stwa

- **Cel**: Synchronizuje zegary urzÄ…dzeÅ„ w sieciach.
- **Znaczenie**: Krytyczne dla bezpieczeÅ„stwa, logowania, protokoÅ‚Ã³w kryptograficznych i systemÃ³w rozproszonych.
- **Åšrodki bezpieczeÅ„stwa**:
- UÅ¼ywaj zaufanych ÅºrÃ³deÅ‚ NTP lub NTS (Network Time Security) z uwierzytelnieniem.
- Ogranicz, kto moÅ¼e zapytywaÄ‡/komendowaÄ‡ demon (``restrict default noquery``, ``kod`` itp.).
- WyÅ‚Ä…cz kontrolne zapytania w trybie 6/7 (``monlist``, ``ntpdc``) lub ogranicz ich czÄ™stotliwoÅ›Ä‡.
- Monitoruj dryf synchronizacji/stan sekund przestÄ™pnych pod kÄ…tem manipulacji.
- Utrzymuj demona w aktualizacji (zobacz ostatnie CVE poniÅ¼ej).

**DomyÅ›lne porty**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Enumeracja

### Klasyczny ntpd / ntpq / ntpdc
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (w wiÄ™kszoÅ›ci nowoczesnych dystrybucji Linuksa)

Tylko garstka poleceÅ„ monitorujÄ…cych jest akceptowana z zdalnych adresÃ³w IP, gdy ``cmdallow`` jest wÅ‚Ä…czone:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Zobacz stronÄ™ podrÄ™cznika chronyc, aby poznaÄ‡ znaczenie flag **M/S** i innych pÃ³l (stratum, reach, jitter itp.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Skanowanie masowe/Internetowe
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Zbadaj pliki konfiguracyjne

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ tylko klient)

ZwrÃ³Ä‡ szczegÃ³lnÄ… uwagÄ™ na linie ``restrict``, ustawienia ``kod`` (Kiss-o'-Death), ``disable monitor``/``includefile /etc/ntp/crypto`` oraz czy *NTS* jest wÅ‚Ä…czone (``nts enable``).

---
## Ostatnie luki (2023-2025)

| Rok | CVE | Komponent | WpÅ‚yw |
|-----|-----|-----------|-------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | Wiele zapisÃ³w poza zakresem dostÄ™pnych poprzez odpowiedzi **ntpq**. Åatka w **4.2.8p16** ğŸ¡’ zaktualizuj lub wprowadÅº poprawki. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023 | **CVE-2023-33192** | **ntpd-rs** (implementacja w Rust) | Å¹le sformatowane ciasteczko **NTS** powoduje zdalny **DoS** przed wersjÄ… v0.3.3 â€“ wpÅ‚ywa na port 123 nawet gdy NTS **wyÅ‚Ä…czone**. îˆ€citeîˆ‚turn4view0îˆ|
| 2024 | aktualizacje dystrybucji | **chrony 4.4 / 4.5** â€“ kilka poprawek zabezpieczeÅ„ i NTS-KE (np. SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024 | Rekord DDoS | Cloudflare zgÅ‚asza atak **5.6 Tbps UDP reflection** (NTP wÅ›rÃ³d uÅ¼ywanych protokoÅ‚Ã³w). Utrzymuj *monitor* i *monlist* wyÅ‚Ä…czone na hostach wystawionych na Internet. îˆ€citeîˆ‚turn5search0îˆ|

> **Zestawy exploitÃ³w**: Dowody koncepcji dla serii OOB-write ntpq z 2023 roku sÄ… dostÄ™pne na GitHubie (zobacz opis Meinberga) i mogÄ… byÄ‡ wykorzystane do phishingu po stronie klienta w celu ataku na administratorÃ³w systemÃ³w. îˆ€citeîˆ‚turn1search4îˆ

---
## Zaawansowane ataki

### 1. Wzmocnienie / Odbicie NTP

Zapytanie w trybie 7 ``monlist`` zwraca do **600 adresÃ³w hostÃ³w** i wciÄ…Å¼ jest obecne na tysiÄ…cach hostÃ³w w Internecie. PoniewaÅ¼ odpowiedÅº (428-468 bajtÃ³w/wejÅ›cie) jest *~ 200Ã—* wiÄ™ksza niÅ¼ 8-bajtowe zapytanie, atakujÄ…cy moÅ¼e osiÄ…gnÄ…Ä‡ wspÃ³Å‚czynniki wzmocnienia w trzech cyfrach. Åšrodki zaradcze:

- Zaktualizuj do ntp 4.2.8p15+ i **dodaj** ``disable monitor``.
- Ogranicz przepustowoÅ›Ä‡ UDP/123 na krawÄ™dzi lub wÅ‚Ä…cz *sessions-required* na urzÄ…dzeniach DDoS.
- WÅ‚Ä…cz filtrowanie egress *BCP 38*, aby zablokowaÄ‡ faÅ‚szowanie ÅºrÃ³dÅ‚a.

Zobacz artykuÅ‚ w centrum wiedzy Cloudflare dla szczegÃ³Å‚owego opisu krok po kroku. îˆ€citeîˆ‚turn5search1îˆ

### 2. Ataki na przesuniÄ™cie czasu / opÃ³Åºnienie (badania Khronos / Chronos)

Nawet przy uwierzytelnieniu, atakujÄ…cy na Å›cieÅ¼ce moÅ¼e cicho **przesunÄ…Ä‡ zegar klienta** poprzez gubienie/opÃ³Åºnianie pakietÃ³w. Projekt IETF **Khronos (dawniej Chronos)** proponuje zapytanie do rÃ³Å¼norodnego zestawu serwerÃ³w w tle i sprawdzanie wynikÃ³w, aby wykryÄ‡ przesuniÄ™cie > ğš¡ ms. Nowoczesny chrony (4.4+) juÅ¼ implementuje podobny filtr sanity (``maxdistance`` / ``maxjitter``). îˆ€citeîˆ‚turn9search1îˆ

### 3. NaduÅ¼ycie NTS i ekspozycja 4460/tcp

NTS przenosi ciÄ™Å¼kÄ… kryptografiÄ™ do osobnego **kanaÅ‚u TLS 1.3 na 4460/tcp** (``ntske/1``). SÅ‚abe implementacje (zobacz CVE-2023-33192) zawieszajÄ… siÄ™ podczas analizy ciasteczek lub pozwalajÄ… na sÅ‚abe szyfry. Pentesterzy powinni:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Szukaj certyfikatÃ³w samopodpisanych lub wygasÅ‚ych oraz sÅ‚abych zestawÃ³w szyfrujÄ…cych (non-AEAD). Referencja: RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## Wzmacnianie / Najlepsze aktualne praktyki (BCP-233 / RFC 8633)

*Operatorzy POWINNI:*

1. UÅ¼ywaÄ‡ **â‰¥ 4** niezaleÅ¼nych, rÃ³Å¼norodnych ÅºrÃ³deÅ‚ czasu (publiczne pule, GPS, mosty PTP), aby uniknÄ…Ä‡ zanieczyszczenia z jednego ÅºrÃ³dÅ‚a.
2. WÅ‚Ä…czyÄ‡ ograniczenia ``kod`` oraz ``limited``/``nomodify``, aby klienci naduÅ¼ywajÄ…cy otrzymywali pakiety **Kiss-o'-Death** z ograniczeniem prÄ™dkoÅ›ci zamiast peÅ‚nych odpowiedzi.
3. MonitorowaÄ‡ logi demona pod kÄ…tem zdarzeÅ„ **panic** lub dostosowaÅ„ krokÃ³w > 1000 s. (Podpisy ataku zgodnie z RFC 8633 Â§5.3.)
4. RozwaÅ¼yÄ‡ **leap-smear**, aby uniknÄ…Ä‡ przerw zwiÄ…zanych z sekundÄ… przestÄ™pnÄ…, ale upewniÄ‡ siÄ™, Å¼e *wszyscy* klienci downstream uÅ¼ywajÄ… tego samego okna smarowania.
5. UtrzymywaÄ‡ polling â‰¤24 h, aby nie przegapiÄ‡ flag sekund przestÄ™pnych.

Zobacz RFC 8633, aby uzyskaÄ‡ kompleksowÄ… listÄ™ kontrolnÄ…. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Przydatne NarzÄ™dzia

| NarzÄ™dzie | Cel | PrzykÅ‚ad |
|-----------|-----|----------|
| ``ntpwn`` | Wrapper dla script-kiddie do rozprzestrzeniania zapytaÅ„ monlist i peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Masowe skanowanie / wyjÅ›cie JSON z flagÄ… monlist | Zobacz powyÅ¼sze polecenie |
| ``chronyd`` z ``allow`` | Uruchomienie nieautoryzowanego serwera NTP w laboratorium pentestowym | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Wstrzykiwanie pakietÃ³w NTP do ataku MITM na Wi-Fi z przesuniÄ™ciem czasowym | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Automatyczne Komendy HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Odniesienia

- RFC 8915 â€“ *BezpieczeÅ„stwo Czasu Sieciowego dla ProtokÃ³Å‚u Czasu Sieciowego* (port 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *ProtokÃ³Å‚ Czasu Sieciowego BCP* îˆ€citeîˆ‚turn8search0îˆ
- Raport Cloudflare DDoS 2024 Q4 (5.6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- ArtykuÅ‚ Cloudflare *Atak Amplifikacji NTP* îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 seria CVE 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- Wpisy NVD **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- Aktualizacja zabezpieczeÅ„ SUSE chrony 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Projekt Khronos/Chronos (Å‚agodzenie przesuniÄ™cia czasowego) îˆ€citeîˆ‚turn9search1îˆ
- PodrÄ™cznik chronyc/przykÅ‚ady do zdalnego monitorowania îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- Dokumentacja moduÅ‚u ntp zgrab2 îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
