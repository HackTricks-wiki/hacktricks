# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Informations de base

Le **Network Time Protocol (NTP)** garantit que les ordinateurs et les dispositifs rÃ©seau sur des rÃ©seaux Ã  latence variable synchronisent leurs horloges avec prÃ©cision. C'est vital pour maintenir une chronomÃ©trie prÃ©cise dans les opÃ©rations informatiques, la sÃ©curitÃ© et la journalisation. Parce que le temps est utilisÃ© dans presque chaque processus d'authentification, de protocole cryptographique et d'analyse judiciaire, **un attaquant qui peut influencer NTP peut souvent contourner les contrÃ´les de sÃ©curitÃ© ou rendre les attaques plus difficiles Ã  enquÃªter.**

### RÃ©sumÃ© & Conseils de sÃ©curitÃ©

- **Objectif** : Synchronise les horloges des dispositifs sur les rÃ©seaux.
- **Importance** : Critique pour la sÃ©curitÃ©, la journalisation, les protocoles cryptographiques et les systÃ¨mes distribuÃ©s.
- **Mesures de sÃ©curitÃ©** :
- Utilisez des sources NTP ou NTS (Network Time Security) de confiance avec authentification.
- Restreindre qui peut interroger/commander le dÃ©mon (``restrict default noquery``, ``kod`` etc.).
- DÃ©sactiver les requÃªtes de contrÃ´le Mode-6/7 hÃ©ritÃ©es (``monlist``, ``ntpdc``) ou les limiter en taux.
- Surveiller la dÃ©rive de synchronisation/l'Ã©tat des secondes intercalaires pour dÃ©tection de falsification.
- Gardez le dÃ©mon Ã  jour (voir les CVE rÃ©cents ci-dessous).

**Ports par dÃ©faut**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Ã‰numÃ©ration

### ntpd / ntpq / ntpdc classique
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (dans la plupart des distributions Linux modernes)

Seule une poignÃ©e de commandes de surveillance sont acceptÃ©es depuis des IP distantes lorsque ``cmdallow`` est activÃ© :
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Voir la page de manuel de chronyc pour la signification des indicateurs **M/S** et d'autres champs (stratum, reach, jitter, etc.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Scan de masse/Internet
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Examinez les fichiers de configuration

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ client uniquement)

Faites particuliÃ¨rement attention aux lignes ``restrict``, aux paramÃ¨tres ``kod`` (Kiss-o'-Death), Ã  ``disable monitor``/``includefile /etc/ntp/crypto`` et Ã  savoir si *NTS* est activÃ© (``nts enable``).

---
## VulnÃ©rabilitÃ©s rÃ©centes (2023-2025)

| AnnÃ©e | CVE | Composant | Impact |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | Ã‰critures hors limites multiples accessibles via les rÃ©ponses **ntpq**. Correctif dans **4.2.8p16** ğŸ¡’ mise Ã  niveau ou correctifs de rÃ©troport. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023 | **CVE-2023-33192** | **ntpd-rs** (implÃ©mentation Rust) | Cookie **NTS** malformÃ© provoque un **DoS** Ã  distance avant v0.3.3 â€“ affecte le port 123 mÃªme lorsque NTS **dÃ©sactivÃ©**. îˆ€citeîˆ‚turn4view0îˆ|
| 2024 | mises Ã  jour de distribution | **chrony 4.4 / 4.5** â€“ plusieurs durcissements de sÃ©curitÃ© & correctifs NTS-KE (par exemple, SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024 | DDoS enregistrÃ© | Cloudflare signale une attaque de **rÃ©flexion UDP de 5,6 Tbps** (NTP parmi les protocoles utilisÃ©s). Gardez *monitor* & *monlist* dÃ©sactivÃ©s sur les hÃ´tes exposÃ©s Ã  Internet. îˆ€citeîˆ‚turn5search0îˆ|

> **Kits d'exploitation** : Des charges utiles de preuve de concept pour la sÃ©rie d'Ã©critures OOB ntpq 2023 sont sur GitHub (voir l'article de Meinberg) et peuvent Ãªtre armÃ©es pour le phishing cÃ´tÃ© client des administrateurs systÃ¨me. îˆ€citeîˆ‚turn1search4îˆ

---
## Attaques avancÃ©es

### 1. Amplification / RÃ©flexion NTP

La requÃªte hÃ©ritÃ©e Mode-7 ``monlist`` renvoie jusqu'Ã  **600 adresses hÃ´tes** et est toujours prÃ©sente sur des milliers d'hÃ´tes Internet. Comme la rÃ©ponse (428-468 octets/entrÃ©e) est *~ 200Ã—* plus grande que la requÃªte de 8 octets, un attaquant peut atteindre des facteurs d'amplification Ã  trois chiffres. AttÃ©nuations :

- Mettez Ã  niveau vers ntp 4.2.8p15+ et **ajoutez** ``disable monitor``.
- Limitez le dÃ©bit UDP/123 Ã  la pÃ©riphÃ©rie ou activez *sessions-required* sur les appareils DDoS.
- Activez le filtrage de sortie *BCP 38* pour bloquer le spoofing de source.

Consultez l'article du centre d'apprentissage de Cloudflare pour un guide Ã©tape par Ã©tape. îˆ€citeîˆ‚turn5search1îˆ

### 2. Attaques de dÃ©calage temporel / de retard (recherche Khronos / Chronos)

MÃªme avec authentification, un attaquant sur le chemin peut silencieusement **dÃ©caler l'horloge du client** en supprimant/dÃ©lai des paquets. Le **brouillon Khronos (anciennement Chronos)** de l'IETF propose d'interroger un ensemble diversifiÃ© de serveurs en arriÃ¨re-plan et de vÃ©rifier la cohÃ©rence du rÃ©sultat pour dÃ©tecter un dÃ©calage > ğš¡ ms. Le chrony moderne (4.4+) implÃ©mente dÃ©jÃ  un filtre de cohÃ©rence similaire (``maxdistance`` / ``maxjitter``). îˆ€citeîˆ‚turn9search1îˆ

### 3. Abus de NTS & exposition 4460/tcp

NTS dÃ©place le lourd cryptage vers un **canal TLS 1.3 sÃ©parÃ© sur 4460/tcp** (``ntske/1``). Les mauvaises implÃ©mentations (voir CVE-2023-33192) plantent lors de l'analyse des cookies ou permettent des chiffrements faibles. Les pentesters devraient :
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Recherchez des certificats auto-signÃ©s ou expirÃ©s et des suites de chiffrement faibles (non-AEAD). RÃ©fÃ©rence : RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## Renforcement / Meilleures Pratiques Actuelles (BCP-233 / RFC 8633)

*Les opÃ©rateurs DOIVENT :*

1. Utiliser **â‰¥ 4** sources de temps indÃ©pendantes et diverses (pools publics, GPS, ponts PTP) pour Ã©viter le empoisonnement par source unique.
2. Activer les restrictions ``kod`` et ``limited``/``nomodify`` afin que les clients abusifs reÃ§oivent des paquets de limitation de taux **Kiss-o'-Death** au lieu de rÃ©ponses complÃ¨tes.
3. Surveiller les journaux du dÃ©mon pour des Ã©vÃ©nements **panic** ou des ajustements de pas > 1000 s. (Signatures d'attaque selon RFC 8633 Â§5.3.)
4. Envisager **leap-smear** pour Ã©viter les pannes de seconde intercalaire, mais s'assurer que *tous* les clients en aval utilisent la mÃªme fenÃªtre de smear.
5. Garder le polling â‰¤24 h afin que les indicateurs de seconde intercalaire ne soient pas manquÃ©s.

Voir RFC 8633 pour une liste de contrÃ´le complÃ¨te. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Outils Utiles

| Outil | But | Exemple |
|-------|-----|---------|
| ``ntpwn`` | Wrapper de script-kiddie pour pulvÃ©riser les requÃªtes monlist & peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Scan de masse / sortie JSON incluant le drapeau monlist | Voir la commande ci-dessus |
| ``chronyd`` avec ``allow`` | ExÃ©cuter un serveur NTP malveillant dans un laboratoire de pentest | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Injecter des paquets NTP pour un MITM de dÃ©calage horaire sur Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Commandes Automatiques HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## RÃ©fÃ©rences

- RFC 8915 â€“ *SÃ©curitÃ© du temps rÃ©seau pour le protocole de temps rÃ©seau* (port 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *Protocole de temps rÃ©seau BCP* îˆ€citeîˆ‚turn8search0îˆ
- Rapport DDoS de Cloudflare 2024 T4 (5,6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- Article de Cloudflare sur l'*attaque d'amplification NTP* îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 sÃ©rie CVE 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- EntrÃ©es NVD **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- Mise Ã  jour de sÃ©curitÃ© chrony SUSE 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Projet Khronos/Chronos (attÃ©nuation du dÃ©calage horaire) îˆ€citeîˆ‚turn9search1îˆ
- Manuel chronyc/exemples pour la surveillance Ã  distance îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- Docs du module ntp zgrab2 îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
