# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Informa√ß√µes B√°sicas

O **Protocolo de Tempo de Rede (NTP)** garante que computadores e dispositivos de rede em redes com lat√™ncia vari√°vel sincronizem seus rel√≥gios com precis√£o. √â vital para manter a cronometragem precisa em opera√ß√µes de TI, seguran√ßa e registro. Como o tempo √© usado em quase todos os processos de autentica√ß√£o, criptografia e forense, **um atacante que pode influenciar o NTP pode frequentemente contornar controles de seguran√ßa ou tornar os ataques mais dif√≠ceis de investigar.**

### Resumo & Dicas de Seguran√ßa

- **Prop√≥sito**: Sincroniza os rel√≥gios dos dispositivos em redes.
- **Import√¢ncia**: Cr√≠tico para seguran√ßa, registro, criptografia e sistemas distribu√≠dos.
- **Medidas de Seguran√ßa**:
- Use fontes NTP ou NTS (Seguran√ßa de Tempo de Rede) confi√°veis com autentica√ß√£o.
- Restringir quem pode consultar/comandar o daemon (``restrict default noquery``, ``kod`` etc.).
- Desativar consultas de controle de Modo-6/7 legadas (``monlist``, ``ntpdc``) ou limitar a taxa delas.
- Monitorar a deriva de sincroniza√ß√£o/estado de segundo bissexto para adultera√ß√£o.
- Manter o daemon atualizado (veja os CVEs recentes abaixo).

**Portas padr√£o**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) ‚Äì TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Enumera√ß√£o

### ntpd / ntpq / ntpdc Cl√°ssico
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (na maioria das distribui√ß√µes Linux modernas)

Apenas um punhado de comandos de monitoramento s√£o aceitos de IPs remotos quando ``cmdallow`` est√° habilitado:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Veja a p√°gina do manual do chronyc para o significado das flags **M/S** e outros campos (stratum, reach, jitter, etc.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Escaneamento em massa/Internet
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Examine arquivos de configura√ß√£o

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd ‚Äì apenas cliente)

Preste aten√ß√£o especial √†s linhas ``restrict``, configura√ß√µes ``kod`` (Kiss-o'-Death), ``disable monitor``/``includefile /etc/ntp/crypto`` e se *NTS* est√° habilitado (``nts enable``).

---
## Vulnerabilidades Recentes (2023-2025)

| Ano | CVE | Componente | Impacto |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551‚Üí26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | M√∫ltiplas grava√ß√µes fora dos limites acess√≠veis via respostas **ntpq**. Patch na **4.2.8p16** ü°í atualize ou fa√ßa back-port das corre√ß√µes. |
| 2023 | **CVE-2023-33192** | **ntpd-rs** (implementa√ß√£o em Rust) | Cookie **NTS** malformado causa **DoS** remoto antes da v0.3.3 ‚Äì afeta a porta 123 mesmo quando NTS **desabilitado**. |
| 2024 | atualiza√ß√µes de distro | **chrony 4.4 / 4.5** ‚Äì v√°rias corre√ß√µes de seguran√ßa e NTS-KE (por exemplo, SUSE-RU-2024:2022) |
| 2024 | DDoS Record | Cloudflare relata um ataque de **reflex√£o UDP de 5.6 Tbps** (NTP entre os protocolos usados). Mantenha *monitor* e *monlist* desabilitados em hosts expostos √† Internet. |

> **Kits de explora√ß√£o**: Payloads de prova de conceito para a s√©rie de grava√ß√µes OOB do ntpq de 2023 est√£o no GitHub (veja o relat√≥rio do Meinberg) e podem ser armados para phishing do lado do cliente de sysadmins.

---
## Ataques Avan√ßados

### 1. Amplifica√ß√£o / Reflex√£o NTP

A consulta legada Mode-7 ``monlist`` retorna at√© **600 endere√ßos de host** e ainda est√° presente em milhares de hosts da Internet. Como a resposta (428-468 bytes/entrada) √© *~ 200√ó* maior que a solicita√ß√£o de 8 bytes, um atacante pode alcan√ßar fatores de amplifica√ß√£o de tr√™s d√≠gitos. Mitiga√ß√µes:

- Atualize para ntp 4.2.8p15+ e **adicione** ``disable monitor``.
- Limite a taxa de UDP/123 na borda ou habilite *sessions-required* em dispositivos DDoS.
- Habilite filtragem de egress *BCP 38* para bloquear spoofing de origem.

Veja o artigo do centro de aprendizado da Cloudflare para um detalhamento passo a passo.

### 2. Ataques de Deslocamento de Tempo / Atraso (pesquisa Khronos / Chronos)

Mesmo com autentica√ß√£o, um atacante na rota pode silenciosamente **deslocar o rel√≥gio do cliente** ao descartar/atrasar pacotes. O rascunho **Khronos (anteriormente Chronos)** da IETF prop√µe consultar um conjunto diversificado de servidores em segundo plano e verificar a sanidade do resultado para detectar um deslocamento > ùö° ms. O chrony moderno (4.4+) j√° implementa um filtro de sanidade semelhante (``maxdistance`` / ``maxjitter``).

### 3. Abuso de NTS e exposi√ß√£o 4460/tcp

O NTS move a criptografia pesada para um **canal TLS 1.3 separado na 4460/tcp** (``ntske/1``). Implementa√ß√µes ruins (veja CVE-2023-33192) travam ao analisar cookies ou permitem cifras fracas. Os pentesters devem:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Procure por certificados autoassinados ou expirados e su√≠tes de cifra fracas (n√£o-AEAD). Refer√™ncia: RFC 8915 ¬ß4.

---
## Fortalecimento / Melhor Pr√°tica Atual (BCP-233 / RFC 8633)

*Operadores DEVEM:*

1. Usar **‚â• 4** fontes de tempo independentes e diversas (pools p√∫blicos, GPS, pontes PTP) para evitar contamina√ß√£o de fonte √∫nica.
2. Habilitar restri√ß√µes ``kod`` e ``limited``/``nomodify`` para que clientes abusivos recebam pacotes de limite de taxa **Kiss-o'-Death** em vez de respostas completas.
3. Monitorar logs do daemon para eventos de **panic** ou ajustes de passo > 1000 s. (Assinaturas de ataque conforme RFC 8633 ¬ß5.3.)
4. Considerar **leap-smear** para evitar interrup√ß√µes de segundo bissexto, mas garantir que *todos* os clientes a montante usem a mesma janela de smear.
5. Manter polling ‚â§24 h para que as bandeiras de segundo bissexto n√£o sejam perdidas.

Veja a RFC 8633 para uma lista de verifica√ß√£o abrangente.

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Ferramentas √öteis

| Ferramenta | Prop√≥sito | Exemplo |
|------------|-----------|---------|
| ``ntpwn`` | Wrapper para script-kiddie para spray de consultas monlist & peers | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Escaneamento em massa / sa√≠da JSON incluindo flag monlist | Veja o comando acima |
| ``chronyd`` com ``allow`` | Executar servidor NTP malicioso em laborat√≥rio de pentest | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Injetar pacotes NTP para MITM de desvio de tempo no Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## Comandos Autom√°ticos HackTricks
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Refer√™ncias

- RFC 8915 ‚Äì *Seguran√ßa de Tempo de Rede para o Protocolo de Tempo de Rede* (porta 4460)
- RFC 8633 ‚Äì *Protocolo de Tempo de Rede BCP*
- Relat√≥rio de DDoS da Cloudflare Q4 2024 (5,6 Tbps)
- Artigo da Cloudflare sobre *Ataque de Amplifica√ß√£o NTP*
- NTP 4.2.8p15 s√©rie CVE 2023-04
- Entradas NVD **CVE-2023-26551‚Äì55**, **CVE-2023-33192**
- Atualiza√ß√£o de seguran√ßa do chrony da SUSE 2024 (chrony 4.5)
- Rascunho Khronos/Chronos (mitiga√ß√£o de deslocamento de tempo)
- Manual/examples do chronyc para monitoramento remoto
- Documenta√ß√£o do m√≥dulo ntp do zgrab2
{{#include ../banners/hacktricks-training.md}}
