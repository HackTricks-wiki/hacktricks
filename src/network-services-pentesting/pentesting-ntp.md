# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Grundinformationen

Das **Network Time Protocol (NTP)** sorgt daf√ºr, dass Computer und Netzwerkger√§te √ºber Netzwerke mit variabler Latenz ihre Uhren genau synchronisieren. Es ist entscheidend f√ºr die Aufrechterhaltung einer pr√§zisen Zeitmessung in IT-Betrieb, Sicherheit und Protokollierung. Da Zeit in nahezu jedem Authentifizierungs-, Krypto-Protokoll- und forensischen Prozess verwendet wird, **kann ein Angreifer, der NTP beeinflussen kann, oft Sicherheitskontrollen umgehen oder Angriffe schwerer untersuchen.**

### Zusammenfassung & Sicherheitstipps

- **Zweck**: Synchronisiert die Uhren von Ger√§ten √ºber Netzwerke.
- **Bedeutung**: Kritisch f√ºr Sicherheit, Protokollierung, Krypto-Protokolle und verteilte Systeme.
- **Sicherheitsma√ünahmen**:
- Verwenden Sie vertrauensw√ºrdige NTP- oder NTS (Network Time Security)-Quellen mit Authentifizierung.
- Beschr√§nken Sie, wer den Daemon abfragen/befehlen kann (``restrict default noquery``, ``kod`` usw.).
- Deaktivieren Sie veraltete Mode-6/7-Steuerabfragen (``monlist``, ``ntpdc``) oder begrenzen Sie deren Rate.
- √úberwachen Sie die Synchronisationsdrift/Schaltsekundenstatus auf Manipulation.
- Halten Sie den Daemon aktualisiert (siehe die aktuellen CVEs unten).

**Standardports**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) ‚Äì TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Aufz√§hlung

### Klassisches ntpd / ntpq / ntpdc
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (in den meisten modernen Linux-Distributionen)

Nur eine Handvoll von √úberwachungsbefehlen wird von entfernten IPs akzeptiert, wenn ``cmdallow`` aktiviert ist:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Siehe die chronyc-Man-Seite f√ºr die Bedeutung der **M/S**-Flags und anderer Felder (Stratum, Reach, Jitter usw.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Massen-/Internetscanning
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Konfigurationdateien √ºberpr√ºfen

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd ‚Äì nur Client)

Achten Sie besonders auf die ``restrict``-Zeilen, ``kod`` (Kiss-o'-Death)-Einstellungen, ``disable monitor``/``includefile /etc/ntp/crypto`` und ob *NTS* aktiviert ist (``nts enable``).

---
## Aktuelle Schwachstellen (2023-2025)

| Jahr | CVE | Komponente | Auswirkung |
|------|-----|------------|------------|
| 2023 | **CVE-2023-26551‚Üí26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | Mehrere Out-of-Bounds-Schreibvorg√§nge, die √ºber **ntpq**-Antworten erreichbar sind. Patch in **4.2.8p16** ü°í Upgrade oder Backport-Fixes. |
| 2023 | **CVE-2023-33192** | **ntpd-rs** (Rust-Implementierung) | Fehlformatierte **NTS**-Cookies verursachen einen Remote-**DoS** vor v0.3.3 ‚Äì betrifft Port 123, selbst wenn NTS **deaktiviert** ist. |
| 2024 | Distro-Updates | **chrony 4.4 / 4.5** ‚Äì mehrere Sicherheitsverbesserungen & NTS-KE-Fixes (z.B. SUSE-RU-2024:2022) |
| 2024 | Rekord DDoS | Cloudflare berichtet √ºber einen **5,6 Tbps UDP-Reflexions**angriff (NTP unter den verwendeten Protokollen). Halten Sie *monitor* & *monlist* auf internetexponierten Hosts deaktiviert. |

> **Exploit-Kits**: Proof-of-Concept-Payloads f√ºr die 2023 ntpq OOB-Schreibserie sind auf GitHub (siehe Meinberg-Bericht) und k√∂nnen f√ºr Client-seitiges Phishing von Sysadmins verwendet werden.

---
## Fortgeschrittene Angriffe

### 1. NTP-Verst√§rkung / Reflexion

Die Legacy Mode-7 ``monlist``-Abfrage gibt bis zu **600 Host-Adressen** zur√ºck und ist immer noch auf Tausenden von Internet-Hosts vorhanden. Da die Antwort (428-468 Bytes/Eingabe) *~ 200√ó* gr√∂√üer ist als die 8-Byte-Anfrage, kann ein Angreifer dreistellige Verst√§rkungsfaktoren erreichen. Milderungsma√ünahmen:

- Upgrade auf ntp 4.2.8p15+ und **hinzuf√ºgen** von ``disable monitor``.
- Rate-Limit UDP/123 am Rand oder aktivieren Sie *sessions-required* auf DDoS-Ger√§ten.
- Aktivieren Sie *BCP 38* Egress-Filterung, um Quellspoofing zu blockieren.

Siehe den Artikel im Lernzentrum von Cloudflare f√ºr eine schrittweise Aufschl√ºsselung.

### 2. Zeitverschiebungs- / Verz√∂gerungsangriffe (Khronos / Chronos-Forschung)

Selbst mit Authentifizierung kann ein Angreifer auf dem Pfad die **Client-Uhr** stillschweigend verschieben, indem er Pakete verwirft/verz√∂gert. Der IETF **Khronos (ehemals Chronos) Entwurf** schl√§gt vor, im Hintergrund eine vielf√§ltige Menge von Servern abzufragen und das Ergebnis zu √ºberpr√ºfen, um eine Verschiebung > ùö° ms zu erkennen. Modernes chrony (4.4+) implementiert bereits einen √§hnlichen Sanity-Filter (``maxdistance`` / ``maxjitter``).

### 3. NTS-Missbrauch & 4460/tcp-Exposition

NTS verlagert die schwere Kryptografie auf einen separaten **TLS 1.3-Kanal auf 4460/tcp** (``ntske/1``). Schlechte Implementierungen (siehe CVE-2023-33192) st√ºrzen beim Parsen von Cookies ab oder erlauben schwache Chiffren. Pentester sollten:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Suche nach selbstsignierten oder abgelaufenen Zertifikaten und schwachen Cipher-Suites (nicht-AEAD). Referenz: RFC 8915 ¬ß4.

---
## H√§rtung / Beste Aktuelle Praxis (BCP-233 / RFC 8633)

*Betreiber SOLLTEN:*

1. **‚â• 4** unabh√§ngige, vielf√§ltige Zeitquellen (√∂ffentliche Pools, GPS, PTP-Br√ºcken) verwenden, um eine Einzelquellenvergiftung zu vermeiden.
2. ``kod`` und ``limited``/``nomodify``-Einschr√§nkungen aktivieren, damit missbr√§uchliche Clients **Kiss-o'-Death**-Rate-Limit-Pakete anstelle vollst√§ndiger Antworten erhalten.
3. Daemon-Protokolle auf **panic**-Ereignisse oder Schrittanpassungen > 1000 s √ºberwachen. (Signaturen eines Angriffs gem√§√ü RFC 8633 ¬ß5.3.)
4. **leap-smear** in Betracht ziehen, um Ausf√§lle durch Schaltsekunden zu vermeiden, aber sicherstellen, dass *alle* nachgelagerten Clients dasselbe Smear-Fenster verwenden.
5. Polling auf ‚â§24 h halten, damit Schaltsekunden-Flags nicht verpasst werden.

Siehe RFC 8633 f√ºr eine umfassende Checkliste.

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## N√ºtzliche Werkzeuge

| Werkzeug | Zweck | Beispiel |
|---------|-------|---------|
| ``ntpwn`` | Script-kiddie Wrapper zum Spr√ºhen von monlist- & peers-Abfragen | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Massen-Scanning / JSON-Ausgabe einschlie√ülich monlist-Flag | Siehe Befehl oben |
| ``chronyd`` mit ``allow`` | F√ºhren Sie einen b√∂sartigen NTP-Server im Pentest-Labor aus | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Injektion von NTP-Paketen f√ºr Zeitverschiebungs-MITM √ºber Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## HackTricks Automatische Befehle
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Referenzen

- RFC 8915 ‚Äì *Netzwerkzeit-Sicherheit f√ºr das Network Time Protocol* (Port 4460)
- RFC 8633 ‚Äì *Network Time Protocol BCP*
- Cloudflare DDoS-Bericht 2024 Q4 (5,6 Tbps)
- Cloudflare *NTP Amplification Attack* Artikel
- NTP 4.2.8p15 CVE-Serie 2023-04
- NVD-Eintr√§ge **CVE-2023-26551‚Äì55**, **CVE-2023-33192**
- SUSE chrony Sicherheitsupdate 2024 (chrony 4.5)
- Khronos/Chronos Entwurf (Zeitverschiebungs-Minderung)
- chronyc Handbuch/Beispiele f√ºr die Fern√ºberwachung
- zgrab2 ntp Modul-Dokumentation
{{#include /banners/hacktricks-training.md}}
