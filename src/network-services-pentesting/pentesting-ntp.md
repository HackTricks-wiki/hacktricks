# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Grundinformationen

Das **Network Time Protocol (NTP)** sorgt dafÃ¼r, dass Computer und NetzwerkgerÃ¤te Ã¼ber Netzwerke mit variabler Latenz ihre Uhren genau synchronisieren. Es ist entscheidend fÃ¼r die Aufrechterhaltung einer prÃ¤zisen Zeitmessung in IT-Betrieb, Sicherheit und Protokollierung. Da Zeit in nahezu jedem Authentifizierungs-, Krypto-Protokoll- und forensischen Prozess verwendet wird, **kann ein Angreifer, der NTP beeinflussen kann, oft Sicherheitskontrollen umgehen oder Angriffe schwerer untersuchen.**

### Zusammenfassung & Sicherheitstipps

- **Zweck**: Synchronisiert die Uhren von GerÃ¤ten Ã¼ber Netzwerke.
- **Bedeutung**: Kritisch fÃ¼r Sicherheit, Protokollierung, Krypto-Protokolle und verteilte Systeme.
- **SicherheitsmaÃŸnahmen**:
- Verwenden Sie vertrauenswÃ¼rdige NTP- oder NTS (Network Time Security)-Quellen mit Authentifizierung.
- BeschrÃ¤nken Sie, wer den Daemon abfragen/befehlen kann (``restrict default noquery``, ``kod`` usw.).
- Deaktivieren Sie veraltete Mode-6/7-Steuerabfragen (``monlist``, ``ntpdc``) oder begrenzen Sie deren Rate.
- Ãœberwachen Sie die Synchronisationsdrift/Schaltsekundenstatus auf Manipulation.
- Halten Sie den Daemon aktualisiert (siehe die aktuellen CVEs unten).

**Standardports**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## AufzÃ¤hlung

### Klassisches ntpd / ntpq / ntpdc
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (in den meisten modernen Linux-Distributionen)

Nur eine Handvoll von Ãœberwachungsbefehlen wird von entfernten IPs akzeptiert, wenn ``cmdallow`` aktiviert ist:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Siehe die chronyc-Man-Seite fÃ¼r die Bedeutung der **M/S**-Flags und anderer Felder (Stratum, Reach, Jitter usw.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Massen-/Internetscanning
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## Konfigurationdateien Ã¼berprÃ¼fen

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ nur Client)

Achten Sie besonders auf die ``restrict``-Zeilen, ``kod`` (Kiss-o'-Death)-Einstellungen, ``disable monitor``/``includefile /etc/ntp/crypto`` und ob *NTS* aktiviert ist (``nts enable``).

---
## Aktuelle Schwachstellen (2023-2025)

| Jahr | CVE | Komponente | Auswirkung |
|------|-----|------------|------------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | Mehrere Out-of-Bounds-SchreibvorgÃ¤nge, die Ã¼ber **ntpq**-Antworten erreichbar sind. Patch in **4.2.8p16** ğŸ¡’ Upgrade oder Backport-Fixes. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023 | **CVE-2023-33192** | **ntpd-rs** (Rust-Implementierung) | Fehlformatierte **NTS**-Cookies verursachen einen Remote-**DoS** vor v0.3.3 â€“ betrifft Port 123, selbst wenn NTS **deaktiviert** ist. îˆ€citeîˆ‚turn4view0îˆ|
| 2024 | Distro-Updates | **chrony 4.4 / 4.5** â€“ mehrere Sicherheitsverbesserungen & NTS-KE-Fixes (z.B. SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024 | Rekord DDoS | Cloudflare berichtet Ã¼ber einen **5.6 Tbps UDP-Reflexions**-Angriff (NTP unter den verwendeten Protokollen). Halten Sie *monitor* & *monlist* auf internet-facing Hosts deaktiviert. îˆ€citeîˆ‚turn5search0îˆ|

> **Exploit-Kits**: Proof-of-Concept-Payloads fÃ¼r die 2023 ntpq OOB-Schreibserie sind auf GitHub (siehe Meinberg-Bericht) und kÃ¶nnen fÃ¼r Client-seitiges Phishing von Sysadmins verwendet werden. îˆ€citeîˆ‚turn1search4îˆ

---
## Fortgeschrittene Angriffe

### 1. NTP-VerstÃ¤rkung / Reflexion

Die Legacy Mode-7 ``monlist``-Abfrage gibt bis zu **600 Host-Adressen** zurÃ¼ck und ist immer noch auf Tausenden von Internet-Hosts vorhanden. Da die Antwort (428-468 Bytes/Eingabe) *~ 200Ã—* grÃ¶ÃŸer ist als die 8-Byte-Anfrage, kann ein Angreifer dreistellige VerstÃ¤rkungsfaktoren erreichen. Milderungen:

- Upgrade auf ntp 4.2.8p15+ und **hinzufÃ¼gen** von ``disable monitor``.
- Rate-Limit UDP/123 am Rand oder aktivieren Sie *sessions-required* auf DDoS-GerÃ¤ten.
- Aktivieren Sie *BCP 38* Egress-Filterung, um Quellspoofing zu blockieren.

Siehe den Artikel im Lernzentrum von Cloudflare fÃ¼r eine Schritt-fÃ¼r-Schritt-ErklÃ¤rung. îˆ€citeîˆ‚turn5search1îˆ

### 2. Zeitverschiebungs- / VerzÃ¶gerungsangriffe (Khronos / Chronos-Forschung)

Selbst mit Authentifizierung kann ein Angreifer auf dem Pfad die **Client-Uhr** stillschweigend verschieben, indem er Pakete verwirft/verzÃ¶gert. Der IETF **Khronos (ehemals Chronos) Entwurf** schlÃ¤gt vor, im Hintergrund eine vielfÃ¤ltige Menge von Servern abzufragen und das Ergebnis zu Ã¼berprÃ¼fen, um eine Verschiebung > ğš¡ ms zu erkennen. Modernes chrony (4.4+) implementiert bereits einen Ã¤hnlichen Sanity-Filter (``maxdistance`` / ``maxjitter``). îˆ€citeîˆ‚turn9search1îˆ

### 3. NTS-Missbrauch & 4460/tcp-Exposition

NTS verlagert die schwere Kryptografie auf einen separaten **TLS 1.3-Kanal auf 4460/tcp** (``ntske/1``). Schlechte Implementierungen (siehe CVE-2023-33192) stÃ¼rzen beim Parsen von Cookies ab oder erlauben schwache Chiffren. Pentester sollten:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Look for self-signed or expired certificates and weak cipher-suites (non-AEAD). Reference: RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## Hardening / Best-Current-Practice (BCP-233 / RFC 8633)

*Betreiber SOLLTEN:*

1. **â‰¥ 4** unabhÃ¤ngige, vielfÃ¤ltige Zeitquellen (Ã¶ffentliche Pools, GPS, PTP-BrÃ¼cken) verwenden, um eine Vergiftung durch eine einzige Quelle zu vermeiden.
2. ``kod`` und ``limited``/``nomodify``-EinschrÃ¤nkungen aktivieren, damit missbrÃ¤uchliche Clients **Kiss-o'-Death**-Rate-Limit-Pakete anstelle vollstÃ¤ndiger Antworten erhalten.
3. Daemon-Protokolle auf **panic**-Ereignisse oder Schrittanpassungen > 1000 s Ã¼berwachen. (Signaturen eines Angriffs gemÃ¤ÃŸ RFC 8633 Â§5.3.)
4. **leap-smear** in Betracht ziehen, um AusfÃ¤lle durch Schaltsekunden zu vermeiden, aber sicherstellen, dass *alle* nachgelagerten Clients dasselbe Smear-Fenster verwenden.
5. Polling auf â‰¤24 h halten, damit Schaltsekunden-Flags nicht verpasst werden.

Siehe RFC 8633 fÃ¼r eine umfassende Checkliste. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## NÃ¼tzliche Werkzeuge

| Werkzeug | Zweck | Beispiel |
|---------|-------|---------|
| ``ntpwn`` | Script-kiddie Wrapper zum SprÃ¼hen von monlist- & peers-Abfragen | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Massen-Scanning / JSON-Ausgabe einschlieÃŸlich monlist-Flag | Siehe Befehl oben |
| ``chronyd`` mit ``allow`` | FÃ¼hren Sie einen bÃ¶sartigen NTP-Server im Pentest-Labor aus | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Injektion von NTP-Paketen fÃ¼r Zeitverschiebungs-MITM Ã¼ber Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## HackTricks Automatische Befehle
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Referenzen

- RFC 8915 â€“ *Network Time Security fÃ¼r das Network Time Protocol* (Port 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *Network Time Protocol BCP* îˆ€citeîˆ‚turn8search0îˆ
- Cloudflare DDoS-Bericht 2024 Q4 (5,6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- Cloudflare *NTP Amplification Attack* Artikel îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 CVE-Serie 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- NVD-EintrÃ¤ge **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- SUSE chrony Sicherheitsupdate 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Khronos/Chronos Entwurf (Zeitverschiebungs-Minderung) îˆ€citeîˆ‚turn9search1îˆ
- chronyc Handbuch/Beispiele fÃ¼r Remote-Ãœberwachung îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- zgrab2 ntp Modul-Dokumentation îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
