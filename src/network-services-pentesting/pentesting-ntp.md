# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## åŸºæœ¬ä¿¡æ¯

**ç½‘ç»œæ—¶é—´åè®® (NTP)** ç¡®ä¿è®¡ç®—æœºå’Œç½‘ç»œè®¾å¤‡åœ¨å¯å˜å»¶è¿Ÿç½‘ç»œä¸­å‡†ç¡®åŒæ­¥æ—¶é’Ÿã€‚å®ƒå¯¹äºç»´æŠ¤ IT æ“ä½œã€å®‰å…¨æ€§å’Œæ—¥å¿—è®°å½•ä¸­çš„ç²¾ç¡®è®¡æ—¶è‡³å…³é‡è¦ã€‚ç”±äºæ—¶é—´åœ¨å‡ ä¹æ¯ä¸ªèº«ä»½éªŒè¯ã€åŠ å¯†åè®®å’Œå–è¯è¿‡ç¨‹ä¸­éƒ½è¢«ä½¿ç”¨ï¼Œ**èƒ½å¤Ÿå½±å“ NTP çš„æ”»å‡»è€…é€šå¸¸å¯ä»¥ç»•è¿‡å®‰å…¨æ§åˆ¶æˆ–ä½¿æ”»å‡»æ›´éš¾ä»¥è°ƒæŸ¥ã€‚**

### æ‘˜è¦ä¸å®‰å…¨æç¤º

- **ç›®çš„**ï¼šåœ¨ç½‘ç»œä¸ŠåŒæ­¥è®¾å¤‡æ—¶é’Ÿã€‚
- **é‡è¦æ€§**ï¼šå¯¹å®‰å…¨ã€æ—¥å¿—è®°å½•ã€åŠ å¯†åè®®å’Œåˆ†å¸ƒå¼ç³»ç»Ÿè‡³å…³é‡è¦ã€‚
- **å®‰å…¨æªæ–½**ï¼š
- ä½¿ç”¨ç»è¿‡éªŒè¯çš„ NTP æˆ– NTSï¼ˆç½‘ç»œæ—¶é—´å®‰å…¨ï¼‰æºå¹¶è¿›è¡Œèº«ä»½éªŒè¯ã€‚
- é™åˆ¶å¯ä»¥æŸ¥è¯¢/å‘½ä»¤å®ˆæŠ¤è¿›ç¨‹çš„ç”¨æˆ·ï¼ˆ``restrict default noquery``ã€``kod`` ç­‰ï¼‰ã€‚
- ç¦ç”¨ä¼ ç»Ÿçš„ Mode-6/7 æ§åˆ¶æŸ¥è¯¢ï¼ˆ``monlist``ã€``ntpdc``ï¼‰æˆ–å¯¹å…¶è¿›è¡Œé€Ÿç‡é™åˆ¶ã€‚
- ç›‘æ§åŒæ­¥æ¼‚ç§»/é—°ç§’çŠ¶æ€ä»¥é˜²ç¯¡æ”¹ã€‚
- ä¿æŒå®ˆæŠ¤è¿›ç¨‹æ›´æ–°ï¼ˆè¯·å‚è§ä¸‹é¢çš„æœ€æ–° CVEï¼‰ã€‚

**é»˜è®¤ç«¯å£**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## æšä¸¾

### ç»å…¸ ntpd / ntpq / ntpdc
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (åœ¨å¤§å¤šæ•°ç°ä»£Linuxå‘è¡Œç‰ˆä¸­)

å½“``cmdallow``å¯ç”¨æ—¶ï¼Œä»…æ¥å—æ¥è‡ªè¿œç¨‹IPçš„å°‘æ•°ç›‘æ§å‘½ä»¤ï¼š
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
æŸ¥çœ‹ chronyc æ‰‹å†Œé¡µä»¥äº†è§£ **M/S** æ ‡å¿—å’Œå…¶ä»–å­—æ®µï¼ˆå±‚æ¬¡ã€å¯è¾¾æ€§ã€æŠ–åŠ¨ç­‰ï¼‰çš„å«ä¹‰ã€‚

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### å¤§è§„æ¨¡/äº’è”ç½‘æ‰«æ
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## æ£€æŸ¥é…ç½®æ–‡ä»¶

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ ä»…å®¢æˆ·ç«¯)

ç‰¹åˆ«æ³¨æ„ ``restrict`` è¡Œï¼Œ``kod`` (Kiss-o'-Death) è®¾ç½®ï¼Œ``disable monitor``/``includefile /etc/ntp/crypto`` ä»¥åŠ *NTS* æ˜¯å¦å¯ç”¨ (``nts enable``)ã€‚

---
## æœ€è¿‘çš„æ¼æ´ (2023-2025)

| å¹´ä»½ | CVE | ç»„ä»¶ | å½±å“ |
|------|-----|-----------|--------|
| 2023 | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | å¤šä¸ªè¶Šç•Œå†™å…¥å¯é€šè¿‡ **ntpq** å“åº”è®¿é—®ã€‚è¡¥ä¸åœ¨ **4.2.8p16** ğŸ¡’ å‡çº§æˆ–å›ç§»ä¿®å¤ã€‚ |
| 2023 | **CVE-2023-33192** | **ntpd-rs** (Rust å®ç°) | æ ¼å¼é”™è¯¯çš„ **NTS** cookie å¯¼è‡´ v0.3.3 ä¹‹å‰çš„è¿œç¨‹ **DoS** â€“ å³ä½¿åœ¨ NTS **ç¦ç”¨** æ—¶ä¹Ÿå½±å“ 123 ç«¯å£ã€‚ |
| 2024 | å‘è¡Œç‰ˆæ›´æ–° | **chrony 4.4 / 4.5** â€“ å¤šä¸ªå®‰å…¨åŠ å›ºå’Œ NTS-KE ä¿®å¤ (ä¾‹å¦‚ SUSE-RU-2024:2022) |
| 2024 | è®°å½• DDoS | Cloudflare æŠ¥å‘Š **5.6 Tbps UDP åå°„** æ”»å‡» (NTP åœ¨ä½¿ç”¨çš„åè®®ä¸­)ã€‚ä¿æŒ *monitor* å’Œ *monlist* åœ¨é¢å‘äº’è”ç½‘çš„ä¸»æœºä¸Šç¦ç”¨ã€‚ |

> **åˆ©ç”¨å·¥å…·åŒ…**ï¼š2023 å¹´ ntpq OOB å†™å…¥ç³»åˆ—çš„æ¦‚å¿µéªŒè¯æœ‰æ•ˆè½½è·åœ¨ GitHub ä¸Šå¯ç”¨ï¼ˆå‚è§ Meinberg çš„å†™ä½œï¼‰ï¼Œå¹¶å¯ç”¨äºé’ˆå¯¹ç³»ç»Ÿç®¡ç†å‘˜çš„å®¢æˆ·ç«¯é’“é±¼æ”»å‡»ã€‚

---
## é«˜çº§æ”»å‡»

### 1. NTP æ”¾å¤§ / åå°„

ä¼ ç»Ÿçš„ Mode-7 ``monlist`` æŸ¥è¯¢è¿”å›å¤šè¾¾ **600 ä¸ªä¸»æœºåœ°å€**ï¼Œå¹¶ä¸”ä»ç„¶å­˜åœ¨äºæ•°åƒä¸ªäº’è”ç½‘ä¸»æœºä¸Šã€‚ç”±äºå›å¤ï¼ˆ428-468 å­—èŠ‚/æ¡ç›®ï¼‰æ˜¯è¯·æ±‚çš„ 8 å­—èŠ‚çš„ *~ 200Ã—* å¤§ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥è¾¾åˆ°ä¸‰ä½æ•°çš„æ”¾å¤§å› å­ã€‚ç¼“è§£æªæ–½ï¼š

- å‡çº§åˆ° ntp 4.2.8p15+ å¹¶ **æ·»åŠ ** ``disable monitor``ã€‚
- åœ¨è¾¹ç¼˜å¯¹ UDP/123 è¿›è¡Œé€Ÿç‡é™åˆ¶æˆ–åœ¨ DDoS è®¾å¤‡ä¸Šå¯ç”¨ *sessions-required*ã€‚
- å¯ç”¨ *BCP 38* å‡ºå£è¿‡æ»¤ä»¥é˜»æ­¢æºæ¬ºéª—ã€‚

è¯·å‚é˜… Cloudflare çš„å­¦ä¹ ä¸­å¿ƒæ–‡ç« ä»¥è·å–é€æ­¥åˆ†è§£ã€‚

### 2. æ—¶é—´åç§» / å»¶è¿Ÿæ”»å‡» (Khronos / Chronos ç ”ç©¶)

å³ä½¿æœ‰èº«ä»½éªŒè¯ï¼Œè·¯å¾„ä¸Šçš„æ”»å‡»è€…ä¹Ÿå¯ä»¥é€šè¿‡ä¸¢å¼ƒ/å»¶è¿Ÿæ•°æ®åŒ…é™é»˜åœ° **ç§»åŠ¨å®¢æˆ·ç«¯æ—¶é’Ÿ**ã€‚IETF **Khronosï¼ˆå‰ç§° Chronosï¼‰è‰æ¡ˆ** æè®®åœ¨åå°æŸ¥è¯¢å¤šæ ·åŒ–çš„æœåŠ¡å™¨å¹¶å¯¹ç»“æœè¿›è¡Œåˆç†æ€§æ£€æŸ¥ï¼Œä»¥æ£€æµ‹åç§» > ğš¡ æ¯«ç§’ã€‚ç°ä»£ chrony (4.4+) å·²ç»å®ç°äº†ç±»ä¼¼çš„åˆç†æ€§è¿‡æ»¤å™¨ (``maxdistance`` / ``maxjitter``)ã€‚

### 3. NTS æ»¥ç”¨ä¸ 4460/tcp æš´éœ²

NTS å°†é‡å‹åŠ å¯†ç§»è‡³å•ç‹¬çš„ **TLS 1.3 é€šé“åœ¨ 4460/tcp** (``ntske/1``)ã€‚ä¸è‰¯å®ç°ï¼ˆå‚è§ CVE-2023-33192ï¼‰åœ¨è§£æ cookies æ—¶å´©æºƒæˆ–å…è®¸å¼±å¯†ç ã€‚æ¸—é€æµ‹è¯•äººå‘˜åº”ï¼š
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
æŸ¥æ‰¾è‡ªç­¾åæˆ–è¿‡æœŸè¯ä¹¦ä»¥åŠå¼±å¯†ç å¥—ä»¶ï¼ˆéAEADï¼‰ã€‚å‚è€ƒï¼šRFC 8915 Â§4ã€‚

---
## åŠ å›º / æœ€ä½³å½“å‰å®è·µ (BCP-233 / RFC 8633)

*æ“ä½œå‘˜åº”ï¼š*

1. ä½¿ç”¨ **â‰¥ 4** ä¸ªç‹¬ç«‹ã€å¤šæ ·çš„æ—¶é—´æºï¼ˆå…¬å…±æ± ã€GPSã€PTP-æ¡¥ï¼‰ä»¥é¿å…å•ä¸€æºæ±¡æŸ“ã€‚
2. å¯ç”¨ ``kod`` å’Œ ``limited``/``nomodify`` é™åˆ¶ï¼Œä»¥ä¾¿æ»¥ç”¨å®¢æˆ·ç«¯æ¥æ”¶ **Kiss-o'-Death** é™é€Ÿæ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯å®Œæ•´å“åº”ã€‚
3. ç›‘æ§å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—ä»¥æŸ¥æ‰¾ **panic** äº‹ä»¶æˆ–æ­¥è¿›è°ƒæ•´ > 1000 sã€‚ï¼ˆæ ¹æ®RFC 8633 Â§5.3çš„æ”»å‡»ç‰¹å¾ã€‚ï¼‰
4. è€ƒè™‘ **leap-smear** ä»¥é¿å…é—°ç§’ä¸­æ–­ï¼Œä½†ç¡®ä¿ *æ‰€æœ‰* ä¸‹æ¸¸å®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒçš„æ¶‚æŠ¹çª—å£ã€‚
5. ä¿æŒè½®è¯¢ â‰¤24 å°æ—¶ï¼Œä»¥å…é”™è¿‡é—°ç§’æ ‡å¿—ã€‚

è¯·å‚é˜…RFC 8633ä»¥è·å–å…¨é¢çš„æ£€æŸ¥æ¸…å•ã€‚

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## æœ‰ç”¨çš„å·¥å…·

| å·¥å…· | ç›®çš„ | ç¤ºä¾‹ |
|------|---------|---------|
| ``ntpwn`` | è„šæœ¬å°å­åŒ…è£…å™¨ï¼Œç”¨äºå–·å°„ monlist å’Œ peers æŸ¥è¯¢ | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | å¤§è§„æ¨¡æ‰«æ / JSON è¾“å‡ºï¼ŒåŒ…æ‹¬ monlist æ ‡å¿— | è§ä¸Šé¢çš„å‘½ä»¤ |
| ``chronyd`` ä¸ ``allow`` | åœ¨æ¸—é€æµ‹è¯•å®éªŒå®¤è¿è¡Œæ¶æ„ NTP æœåŠ¡å™¨ | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | æ³¨å…¥ NTP æ•°æ®åŒ…ä»¥è¿›è¡Œ Wi-Fi ä¸Šçš„æ—¶é—´åç§» MITM | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## HackTricks è‡ªåŠ¨å‘½ä»¤
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## å‚è€ƒæ–‡çŒ®

- RFC 8915 â€“ *ç½‘ç»œæ—¶é—´åè®®çš„ç½‘ç»œæ—¶é—´å®‰å…¨* (port 4460)
- RFC 8633 â€“ *ç½‘ç»œæ—¶é—´åè®® BCP*
- Cloudflare DDoS æŠ¥å‘Š 2024 Q4 (5.6 Tbps)
- Cloudflare *NTP æ”¾å¤§æ”»å‡»* æ–‡ç« 
- NTP 4.2.8p15 CVE ç³»åˆ— 2023-04
- NVD æ¡ç›® **CVE-2023-26551â€“55**, **CVE-2023-33192**
- SUSE chrony å®‰å…¨æ›´æ–° 2024 (chrony 4.5)
- Khronos/Chronos è‰æ¡ˆ (æ—¶é—´åç§»ç¼“è§£)
- chronyc æ‰‹å†Œ/è¿œç¨‹ç›‘æ§ç¤ºä¾‹
- zgrab2 ntp æ¨¡å—æ–‡æ¡£
{{#include /banners/hacktricks-training.md}}
