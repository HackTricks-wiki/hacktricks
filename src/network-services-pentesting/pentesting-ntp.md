# 123/udp - Pentesting NTP

{{#include ../banners/hacktricks-training.md}}

## Osnovne informacije

**Network Time Protocol (NTP)** osigurava da raÄunari i mreÅ¾ni ureÄ‘aji na mreÅ¾ama sa promenljivom latencijom taÄno sinhronizuju svoje satove. To je od vitalnog znaÄaja za odrÅ¾avanje preciznog merenja vremena u IT operacijama, bezbednosti i logovanju. PoÅ¡to se vreme koristi u gotovo svakoj autentifikaciji, kripto-protokolu i forenziÄkom procesu, **napadaÄ koji moÅ¾e da utiÄe na NTP Äesto moÅ¾e da zaobiÄ‘e bezbednosne kontrole ili oteÅ¾a istraÅ¾ivanje napada.**

### SaÅ¾etak i saveti za bezbednost

- **Svrha**: Sinhronizuje satove ureÄ‘aja preko mreÅ¾a.
- **ZnaÄaj**: KritiÄno za bezbednost, logovanje, kripto-protokole i distribuirane sisteme.
- **Bezbednosne mere**:
- Koristite pouzdane NTP ili NTS (Network Time Security) izvore sa autentifikacijom.
- OgraniÄite ko moÅ¾e da upita/naredi demon (``restrict default noquery``, ``kod`` itd.).
- OnemoguÄ‡ite nasleÄ‘ene Mode-6/7 kontrolne upite (``monlist``, ``ntpdc``) ili ih ograniÄite po brzini.
- Pratite pomeranje sinhronizacije/stanje skakanja sekundi za manipulaciju.
- OdrÅ¾avajte demona aÅ¾uriranim (vidite nedavne CVE-ove u nastavku).

**Podrazumevani portovi**
```
123/udp   NTP            (data + legacy control)
4460/tcp  NTS-KE (RFC 8915) â€“ TLS key-establishment for NTP
```

```
PORT    STATE SERVICE REASON
123/udp open  ntp     udp-response
```
---
## Enumeracija

### KlasiÄni ntpd / ntpq / ntpdc
```bash
# Information & variables
ntpq -c rv <IP>
ntpq -c readvar <IP>
ntpq -c peers <IP>
ntpq -c associations <IP>

# Legacy mode-7 (often disabled >=4.2.8p9)
ntpdc -c monlist <IP>
ntpdc -c listpeers <IP>
ntpdc -c sysinfo  <IP>
```
### chrony / chronyc (u veÄ‡ini modernih Linux distribucija)

Samo mali broj komandi za nadgledanje se prihvata sa udaljenih IP adresa kada je ``cmdallow`` omoguÄ‡en:
```bash
chronyc -a -n tracking   -h <IP>
chronyc -a -n sources -v -h <IP>
chronyc -a -n sourcestats -h <IP>
```
Pogledajte stranicu sa uputstvima za chronyc za znaÄenje **M/S** oznaka i drugih polja (stratum, reach, jitter, itd.).

### Nmap
```bash
# Safe discovery & vuln detection
nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 <IP>

# Explicit monlist check
nmap -sU -p123 --script ntp-monlist <IP>
```
### Masovno/Internet skeniranje
```bash
# Check if MONLIST is enabled (zgrab2 module)
zgrab2 ntp --monlist --timeout 3 --output-file monlist.json -f "zmap_results.csv"
```
---
## IstraÅ¾ite konfiguracione datoteke

- ``/etc/ntp.conf`` (ntpd)
- ``/etc/chrony/chrony.conf`` (chrony)
- ``/etc/systemd/timesyncd.conf`` (timesyncd â€“ samo klijent)

Obratite posebnu paÅ¾nju na ``restrict`` linije, ``kod`` (Kiss-o'-Death) podeÅ¡avanja, ``disable monitor``/``includefile /etc/ntp/crypto`` i da li je *NTS* omoguÄ‡en (``nts enable``).

---
## Nedavne ranjivosti (2023-2025)

| Godina | CVE | Komponenta | Uticaj |
|--------|-----|------------|--------|
| 2023   | **CVE-2023-26551â†’26555** | ntp 4.2.8p15 (libntp *mstolfp*, *praecis_parse*) | ViÅ¡e izlaznih pisanja koja se mogu dostiÄ‡i putem **ntpq** odgovora. Zakrpa u **4.2.8p16** ğŸ¡’ nadogradite ili vratite zakrpe. îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ|
| 2023   | **CVE-2023-33192** | **ntpd-rs** (Rust implementacija) | Neispravan **NTS** kolaÄiÄ‡ uzrokuje udaljeni **DoS** pre v0.3.3 â€“ utiÄe na port 123 Äak i kada je NTS **onemoguÄ‡en**. îˆ€citeîˆ‚turn4view0îˆ|
| 2024   | aÅ¾uriranja distribucije | **chrony 4.4 / 4.5** â€“ nekoliko bezbednosnih poboljÅ¡anja i NTS-KE zakrpa (npr. SUSE-RU-2024:2022) îˆ€citeîˆ‚turn2search2îˆ|
| 2024   | ZabeleÅ¾en DDoS | Cloudflare izveÅ¡tava o **5.6 Tbps UDP refleksionom** napadu (NTP meÄ‘u koriÅ¡Ä‡enim protokolima). DrÅ¾ite *monitor* i *monlist* onemoguÄ‡enim na hostovima koji su izloÅ¾eni internetu. îˆ€citeîˆ‚turn5search0îˆ|

> **Eksploatacione kitove**: Dokazi o konceptu za 2023 ntpq OOB-write seriju su na GitHub-u (vidi Meinberg izveÅ¡taj) i mogu se iskoristiti za phishing na klijentskoj strani sysadmina. îˆ€citeîˆ‚turn1search4îˆ

---
## Napredni napadi

### 1. NTP amplifikacija / refleksija

NasleÄ‘eni Mode-7 ``monlist`` upit vraÄ‡a do **600 adresa hostova** i joÅ¡ uvek je prisutan na hiljadama internet hostova. BuduÄ‡i da je odgovor (428-468 bajtova/unos) *~ 200Ã—* veÄ‡i od 8-bajtne zahteva, napadaÄ moÅ¾e dostiÄ‡i trocifrene faktore amplifikacije. MoguÄ‡nosti ublaÅ¾avanja:

- Nadogradite na ntp 4.2.8p15+ i **dodajte** ``disable monitor``.
- OgraniÄite brzinu UDP/123 na ivici ili omoguÄ‡ite *sessions-required* na DDoS ureÄ‘ajima.
- OmoguÄ‡ite *BCP 38* izlazno filtriranje da blokirate laÅ¾no predstavljanje izvora.

Pogledajte Älanak iz Cloudflare-ovog centra za uÄenje za detaljno objaÅ¡njenje. îˆ€citeîˆ‚turn5search1îˆ

### 2. Napadi pomeranja vremena / kaÅ¡njenja (Khronos / Chronos istraÅ¾ivanje)

ÄŒak i sa autentifikacijom, napadaÄ na putu moÅ¾e tiho **pomeriti klijentski sat** tako Å¡to Ä‡e odbaciti/odloÅ¾iti pakete. IETF **Khronos (ranije Chronos) nacrt** predlaÅ¾e upit raznovrsnom skupu servera u pozadini i proveru rezultata kako bi se otkrilo pomeranje > ğš¡ ms. Moderni chrony (4.4+) veÄ‡ implementira sliÄan filter provere (``maxdistance`` / ``maxjitter``). îˆ€citeîˆ‚turn9search1îˆ

### 3. Zloupotreba NTS i izloÅ¾enost 4460/tcp

NTS premesta teÅ¡ku kriptografiju na poseban **TLS 1.3 kanal na 4460/tcp** (``ntske/1``). LoÅ¡e implementacije (vidi CVE-2023-33192) se ruÅ¡e prilikom parsiranja kolaÄiÄ‡a ili dozvoljavaju slabe Å¡ifre. Pentesteri bi trebali:
```bash
# TLS reconnaissance
nmap -sV -p 4460 --script ssl-enum-ciphers,ssl-cert <IP>

# Grab banner & ALPN
openssl s_client -connect <IP>:4460 -alpn ntske/1 -tls1_3 -ign_eof
```
Look for self-signed or expired certificates and weak cipher-suites (non-AEAD). Reference: RFC 8915 Â§4. îˆ€citeîˆ‚turn11search0îˆ

---
## Hardening / Best-Current-Practice (BCP-233 / RFC 8633)

*Operateri TREBA da:*

1. Koriste **â‰¥ 4** nezavisna, raznolika vremenska izvora (javne grupe, GPS, PTP-bridge) kako bi izbegli trovanje jednim izvorom.
2. OmoguÄ‡e ``kod`` i ``limited``/``nomodify`` ograniÄenja tako da zlonamerni klijenti dobijaju **Kiss-o'-Death** pakete sa ograniÄenjem brzine umesto punih odgovora.
3. Prate dnevnike demona za **panic** dogaÄ‘aje ili prilagoÄ‘avanja koraka > 1000 s. (Potpisi napada prema RFC 8633 Â§5.3.)
4. Razmotre **leap-smear** kako bi izbegli prekide zbog leap-sekundi, ali osiguraju da *svi* klijenti nizvodno koriste isti smear prozor.
5. OdrÅ¾avaju polling â‰¤24 h kako ne bi propustili oznake leap-sekundi.

See RFC 8633 for a comprehensive checklist. îˆ€citeîˆ‚turn8search0îˆ‚turn8search1îˆ

---
## Shodan / Censys Dorks
```
port:123 "ntpd"          # Version banner
udp port:123 monlist:true # Censys tag for vulnerable servers
port:4460 "ntske"         # NTS-KE
```
---
## Korisni alati

| Alat | Svrha | Primer |
|------|---------|---------|
| ``ntpwn`` | Script-kiddie omotaÄ za slanje monlist & peers upita | ``python ntpwn.py --monlist targets.txt`` |
| **zgrab2 ntp** | Masovno skeniranje / JSON izlaz ukljuÄujuÄ‡i monlist zastavicu | Pogledajte komandu iznad |
| ``chronyd`` sa ``allow`` | Pokrenite rogue NTP server u pentest laboratoriji | ``chronyd -q 'server 127.127.1.0 iburst'`` |
| ``BetterCap`` | Umetnite NTP pakete za MITM napad sa pomeranjem vremena na Wi-Fi | ``set arp.spoof.targets <victim>; set ntp.time.delta 30s; arp.spoof on`` |

---
## HackTricks Automatske komande
```
Protocol_Name: NTP
Port_Number: 123
Protocol_Description: Network Time Protocol

Entry_1:
Name: Notes
Description: Notes for NTP
Note: |
The Network Time Protocol (NTP) ensures computers and network devices across variable-latency networks sync their clocks accurately. It's vital for maintaining precise timekeeping in IT operations, security, and logging. NTP's accuracy is essential, but it also poses security risks if not properly managed.

https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-ntp.html

Entry_2:
Name: Nmap
Description: Enumerate NTP
Command: nmap -sU -sV --script "ntp* and (discovery or vuln) and not (dos or brute)" -p 123 {IP}
```
---
## Reference

- RFC 8915 â€“ *Sigurnost mreÅ¾nog vremena za protokol mreÅ¾nog vremena* (port 4460) îˆ€citeîˆ‚turn11search0îˆ
- RFC 8633 â€“ *Protokol mreÅ¾nog vremena BCP* îˆ€citeîˆ‚turn8search0îˆ
- Cloudflare DDoS izveÅ¡taj 2024 Q4 (5.6 Tbps) îˆ€citeîˆ‚turn5search0îˆ
- Cloudflare *NTP amplifikacijski napad* Älanak îˆ€citeîˆ‚turn5search1îˆ
- NTP 4.2.8p15 CVE serija 2023-04 îˆ€citeîˆ‚turn1search4îˆ
- NVD unosi **CVE-2023-26551â€“55**, **CVE-2023-33192** îˆ€citeîˆ‚turn1search1îˆ‚turn1search2îˆ‚turn1search0îˆ‚turn4view0îˆ
- SUSE chrony bezbednosna aÅ¾uriranja 2024 (chrony 4.5) îˆ€citeîˆ‚turn2search2îˆ
- Khronos/Chronos nacrt (ublaÅ¾avanje pomeranja vremena) îˆ€citeîˆ‚turn9search1îˆ
- chronyc priruÄnik/primeri za daljinsko praÄ‡enje îˆ€citeîˆ‚turn3search0îˆ‚turn10search1îˆ
- zgrab2 ntp modul dokumentacija îˆ€citeîˆ‚turn7search0îˆ
{{#include /banners/hacktricks-training.md}}
