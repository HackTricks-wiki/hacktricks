# 8009 - Pentesting Apache JServ Protocol (AJP)

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/image (3).png" alt=""><figcaption></figcaption></figure>

¡Únete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores!

**Perspectivas de Hacking**\
Participa en contenido que profundiza en la emoción y los desafíos del hacking

**Noticias de Hackeo en Tiempo Real**\
Mantente al día con el mundo del hacking de ritmo rápido a través de noticias e información en tiempo real

**Últimos Anuncios**\
Mantente informado sobre las nuevas recompensas por errores que se lanzan y actualizaciones cruciales de la plataforma

**Únete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy mismo!

## Información Básica

De [https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/](https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/)

> AJP es un protocolo de red. Es una versión optimizada del protocolo HTTP para permitir que un servidor web independiente como [Apache](http://httpd.apache.org/) se comunique con Tomcat. Históricamente, Apache ha sido mucho más rápido que Tomcat al servir contenido estático. La idea es permitir que Apache sirva el contenido estático cuando sea posible, pero proxy la solicitud a Tomcat para el contenido relacionado con Tomcat.

También interesante:

> El protocolo ajp13 es orientado a paquetes. Se eligió un formato binario presumiblemente sobre el texto plano más legible por razones de rendimiento. El servidor web se comunica con el contenedor de servlets a través de conexiones TCP. Para reducir el costoso proceso de creación de sockets, el servidor web intentará mantener conexiones TCP persistentes con el contenedor de servlets y reutilizar una conexión para múltiples ciclos de solicitud/respuesta.

**Puerto por defecto:** 8009
```
PORT     STATE SERVICE
8009/tcp open  ajp13
```
## CVE-2020-1938 ['Ghostcat'](https://www.chaitin.cn/en/ghostcat)

Esta es una vulnerabilidad LFI que permite obtener algunos archivos como `WEB-INF/web.xml` que contiene credenciales. Este es un [exploit](https://www.exploit-db.com/exploits/48143) para abusar de la vulnerabilidad y los puertos expuestos AJP podrían ser vulnerables a ella.

Las versiones corregidas son 9.0.31 o superiores, 8.5.51, y 7.0.100.

## Enumeración

### Automático
```bash
nmap -sV --script ajp-auth,ajp-headers,ajp-methods,ajp-request -n -p 8009 <IP>
```
### [**Fuerza bruta**](../generic-hacking/brute-force.md#ajp)

## Proxy AJP

### Proxy inverso Nginx + AJP

([Consulta la versión Dockerizada](8009-pentesting-apache-jserv-protocol-ajp.md#Dockerized-version))

Es posible comunicarse con un puerto proxy AJP abierto (8009 TCP) utilizando el módulo `ajp_module` de Apache en Nginx y acceder al Tomcat Manager desde este puerto, lo que podría llevar a RCE en el servidor vulnerable.

- Comienza a descargar Nginx desde [https://nginx.org/en/download.html](https://nginx.org/en/download.html) y luego compílalo con el módulo ajp:
```bash
# Compile Nginx with the ajp module
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-version
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
```
- Luego, comenta el bloque `server` y añade lo siguiente en el bloque `http` en `/etc/nginx/conf/nginx.conf`.
```json
upstream tomcats {
server <TARGET_SERVER>:8009;
keepalive 10;
}
server {
listen 80;
location / {
ajp_keep_conn on;
ajp_pass tomcats;
}
}
```
- Finalmente, inicia nginx (`sudo nginx`) y verifica que funciona accediendo a `http://127.0.0.1`

### Versión Dockerizada de Nginx
```bash
git clone https://github.com/ScribblerCoder/nginx-ajp-docker
cd nginx-ajp-docker
```
Reemplace `TARGET-IP` en `nginx.conf` con la IP de AJP y luego construya y ejecute.
```bash
docker build . -t nginx-ajp-proxy
docker run -it --rm -p 80:80 nginx-ajp-proxy
```
### Proxy AJP de Apache

También es posible usar un **proxy AJP de Apache** para acceder a ese puerto en lugar de **Nginx**.

## Referencias

- [https://github.com/yaoweibin/nginx_ajp_module](https://github.com/yaoweibin/nginx_ajp_module)

<figure><img src="../images/image (3).png" alt=""><figcaption></figcaption></figure>

¡Únete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores!

**Perspectivas de Hacking**\
Participa en contenido que profundiza en la emoción y los desafíos del hacking

**Noticias de Hackeo en Tiempo Real**\
Mantente al día con el mundo del hacking de ritmo rápido a través de noticias e información en tiempo real

**Últimos Anuncios**\
Mantente informado sobre las nuevas recompensas por errores que se lanzan y actualizaciones cruciales de la plataforma

**Únete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy mismo!

{{#include ../banners/hacktricks-training.md}}
