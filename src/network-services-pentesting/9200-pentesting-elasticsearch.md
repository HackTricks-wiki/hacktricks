# 9200 - Pentesting Elasticsearch

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Erhalten Sie die Perspektive eines Hackers auf Ihre Webanwendungen, Ihr Netzwerk und Ihre Cloud**

**Finden und melden Sie kritische, ausnutzbare Sicherheitsanfälligkeiten mit echtem Geschäftsauswirkungen.** Verwenden Sie unsere 20+ benutzerdefinierten Tools, um die Angriffsfläche zu kartieren, Sicherheitsprobleme zu finden, die Ihnen ermöglichen, Berechtigungen zu eskalieren, und nutzen Sie automatisierte Exploits, um wesentliche Beweise zu sammeln, und verwandeln Sie Ihre harte Arbeit in überzeugende Berichte.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Grundinformationen

Elasticsearch ist eine **verteilte**, **Open Source** Such- und Analyse-Engine für **alle Arten von Daten**. Es ist bekannt für seine **Geschwindigkeit**, **Skalierbarkeit** und **einfachen REST-APIs**. Basierend auf Apache Lucene wurde es erstmals 2010 von Elasticsearch N.V. (jetzt bekannt als Elastic) veröffentlicht. Elasticsearch ist der Kernbestandteil des Elastic Stack, einer Sammlung von Open Source-Tools für Datenaufnahme, -anreicherung, -speicherung, -analyse und -visualisierung. Dieser Stack, der allgemein als ELK Stack bezeichnet wird, umfasst auch Logstash und Kibana und hat jetzt leichte Datenversandagenten namens Beats.

### Was ist ein Elasticsearch-Index?

Ein Elasticsearch **Index** ist eine Sammlung von **verwandten Dokumenten**, die als **JSON** gespeichert sind. Jedes Dokument besteht aus **Schlüsseln** und den entsprechenden **Werten** (Strings, Zahlen, Booleans, Daten, Arrays, Geolokationen usw.).

Elasticsearch verwendet eine effiziente Datenstruktur namens **invertierter Index**, um schnelle Volltextsuche zu ermöglichen. Dieser Index listet jedes einzigartige Wort in den Dokumenten auf und identifiziert die Dokumente, in denen jedes Wort erscheint.

Während des Indexierungsprozesses speichert Elasticsearch die Dokumente und erstellt den invertierten Index, der nahezu Echtzeitsuchen ermöglicht. Die **Index-API** wird verwendet, um JSON-Dokumente innerhalb eines bestimmten Index hinzuzufügen oder zu aktualisieren.

**Standardport**: 9200/tcp

## Manuelle Enumeration

### Banner

Das Protokoll, das zum Zugriff auf Elasticsearch verwendet wird, ist **HTTP**. Wenn Sie über HTTP darauf zugreifen, finden Sie einige interessante Informationen: `http://10.10.10.115:9200/`

![](<../images/image (294).png>)

Wenn Sie diese Antwort beim Zugriff auf `/` nicht sehen, siehe den folgenden Abschnitt.

### Authentifizierung

**Standardmäßig ist die Authentifizierung in Elasticsearch nicht aktiviert**, sodass Sie standardmäßig auf alles in der Datenbank zugreifen können, ohne Anmeldeinformationen verwenden zu müssen.

Sie können überprüfen, ob die Authentifizierung deaktiviert ist, indem Sie eine Anfrage an:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Wenn** Sie jedoch eine Anfrage an `/` senden und eine Antwort wie die folgende erhalten:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Das bedeutet, dass die Authentifizierung konfiguriert ist und **gültige Anmeldeinformationen** benötigt werden, um Informationen von Elasticsearch zu erhalten. Dann können Sie [**versuchen, es zu bruteforcen**](../generic-hacking/brute-force.md#elasticsearch) (es verwendet HTTP Basic Auth, daher kann alles, was BF HTTP Basic Auth unterstützt, verwendet werden).\
Hier haben Sie eine **Liste der Standardbenutzernamen**: _**elastic** (Superuser), remote_monitoring_user, beats_system, logstash_system, kibana, kibana_system, apm_system,_ \_anonymous\_.\_ Ältere Versionen von Elasticsearch haben das Standardpasswort **changeme** für diesen Benutzer.
```
curl -X GET http://user:password@IP:9200/
```
### Grundlegende Benutzerenumeration
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Elastic Info

Hier sind einige Endpunkte, die Sie **über GET** **zugreifen** können, um einige **Informationen** über Elasticsearch zu **erhalten**:

| \_cat                          | /\_cluster                    | /\_security              |
| ------------------------------ | ----------------------------- | ------------------------ |
| /\_cat/segments                | /\_cluster/allocation/explain | /\_security/user         |
| /\_cat/shards                  | /\_cluster/settings           | /\_security/privilege    |
| /\_cat/repositories            | /\_cluster/health             | /\_security/role_mapping |
| /\_cat/recovery                | /\_cluster/state              | /\_security/role         |
| /\_cat/plugins                 | /\_cluster/stats              | /\_security/api_key      |
| /\_cat/pending_tasks           | /\_cluster/pending_tasks      |                          |
| /\_cat/nodes                   | /\_nodes                      |                          |
| /\_cat/tasks                   | /\_nodes/usage                |                          |
| /\_cat/templates               | /\_nodes/hot_threads          |                          |
| /\_cat/thread_pool             | /\_nodes/stats                |                          |
| /\_cat/ml/trained_models       | /\_tasks                      |                          |
| /\_cat/transforms/\_all        | /\_remote/info                |                          |
| /\_cat/aliases                 |                               |                          |
| /\_cat/allocation              |                               |                          |
| /\_cat/ml/anomaly_detectors    |                               |                          |
| /\_cat/count                   |                               |                          |
| /\_cat/ml/data_frame/analytics |                               |                          |
| /\_cat/ml/datafeeds            |                               |                          |
| /\_cat/fielddata               |                               |                          |
| /\_cat/health                  |                               |                          |
| /\_cat/indices                 |                               |                          |
| /\_cat/master                  |                               |                          |
| /\_cat/nodeattrs               |                               |                          |
| /\_cat/nodes                   |                               |                          |

Diese Endpunkte wurden [**aus der Dokumentation**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) entnommen, wo Sie **mehr** finden können.\
Wenn Sie `/_cat` aufrufen, enthält die Antwort die unterstützten `/_cat/*` Endpunkte der Instanz.

In `/_security/user` (wenn Authentifizierung aktiviert ist) können Sie sehen, welcher Benutzer die Rolle `superuser` hat.

### Indices

Sie können **alle Indizes sammeln**, indem Sie `http://10.10.10.115:9200/_cat/indices?v` aufrufen.
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Um **Informationen darüber zu erhalten, welche Art von Daten in einem Index gespeichert sind**, können Sie auf: `http://host:9200/<index>` zugreifen, im Beispiel in diesem Fall `http://10.10.10.115:9200/bank`

![](<../images/image (342).png>)

### Index dumpen

Wenn Sie **alle Inhalte** eines Index dumpen möchten, können Sie auf: `http://host:9200/<index>/_search?pretty=true` zugreifen, wie `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../images/image (914).png>)

_Nehmen Sie sich einen Moment Zeit, um die Inhalte jedes Dokuments (Eintrag) im Bankindex und die Felder dieses Index, die wir im vorherigen Abschnitt gesehen haben, zu vergleichen._

Zu diesem Zeitpunkt könnten Sie bemerken, dass **es ein Feld namens "total" innerhalb von "hits" gibt**, das anzeigt, dass **1000 Dokumente gefunden wurden** in diesem Index, aber nur 10 abgerufen wurden. Das liegt daran, dass **standardmäßig eine Begrenzung von 10 Dokumenten besteht**.\
Aber jetzt, da Sie wissen, dass **dieser Index 1000 Dokumente enthält**, können Sie **alle dumpen**, indem Sie die Anzahl der Einträge, die Sie dumpen möchten, im **`size`**-Parameter angeben: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
\&#xNAN;_Hinweis: Wenn Sie eine größere Zahl angeben, werden trotzdem alle Einträge gedumpt, zum Beispiel könnten Sie `size=9999` angeben und es wäre seltsam, wenn es mehr Einträge gäbe (aber das sollten Sie überprüfen)._

### Alles dumpen

Um alles zu dumpen, können Sie einfach den **gleichen Pfad wie zuvor, aber ohne Angabe eines Index** gehen: `http://host:9200/_search?pretty=true` wie `http://10.10.10.115:9200/_search?pretty=true`\
Denken Sie daran, dass in diesem Fall die **Standardgrenze von 10** Ergebnissen angewendet wird. Sie können den `size`-Parameter verwenden, um eine **größere Anzahl von Ergebnissen** zu dumpen. Lesen Sie den vorherigen Abschnitt für weitere Informationen.

### Suche

Wenn Sie nach Informationen suchen, können Sie eine **rohe Suche in allen Indizes** durchführen, indem Sie zu `http://host:9200/_search?pretty=true&q=<search_term>` gehen, wie in `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../images/image (335).png>)

Wenn Sie nur in einem Index **suchen** möchten, können Sie ihn einfach im **Pfad** angeben: `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Beachten Sie, dass der q-Parameter, der zur Suche nach Inhalten verwendet wird, **reguläre Ausdrücke unterstützt**_

Sie können auch etwas wie [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) verwenden, um einen Elasticsearch-Dienst zu fuzzern.

### Schreibberechtigungen

Sie können Ihre Schreibberechtigungen überprüfen, indem Sie versuchen, ein neues Dokument in einem neuen Index zu erstellen, indem Sie etwas wie das Folgende ausführen:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
Dieser Befehl erstellt einen **neuen Index** namens `bookindex` mit einem Dokument vom Typ `books`, das die Attribute "_bookId_", "_author_", "_publisher_" und "_name_" hat.

Beachten Sie, wie der **neue Index jetzt in der Liste erscheint**:

![](<../images/image (130).png>)

Und beachten Sie die **automatisch erstellten Eigenschaften**:

![](<../images/image (434).png>)

## Automatische Enumeration

Einige Tools werden einige der zuvor präsentierten Daten abrufen:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

- `port:9200 elasticsearch`

<figure><img src="../images/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Erhalten Sie die Perspektive eines Hackers auf Ihre Webanwendungen, Ihr Netzwerk und Ihre Cloud**

**Finden und melden Sie kritische, ausnutzbare Schwachstellen mit echtem Geschäftsauswirkungen.** Verwenden Sie unsere 20+ benutzerdefinierten Tools, um die Angriffsfläche zu kartieren, Sicherheitsprobleme zu finden, die Ihnen ermöglichen, Privilegien zu eskalieren, und nutzen Sie automatisierte Exploits, um wesentliche Beweise zu sammeln, die Ihre harte Arbeit in überzeugende Berichte verwandeln.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{{#include ../banners/hacktricks-training.md}}
