# 3128/tcp - Pentesting Squid

{{#include ../banners/hacktricks-training.md}}

## 基本信息

来自 [Wikipedia](<https://en.wikipedia.org/wiki/Squid_(software)>):

> **Squid** 是一个缓存和转发的 HTTP web 代理。它有多种用途，包括通过缓存重复请求来加速 web 服务器，为共享网络资源的一组用户缓存 web、DNS 及其他计算机网络查询，并通过过滤流量来增强安全性。尽管主要用于 HTTP 和 FTP，Squid 对其他若干协议（包括 Internet Gopher、SSL、TLS 和 HTTPS）也提供有限支持。与 Privoxy 不同，Squid 不支持 SOCKS 协议，但可以与 Privoxy 配合使用以提供 SOCKS 支持。

**默认端口:** 3128
```
PORT     STATE  SERVICE      VERSION
3128/tcp open   http-proxy   Squid http proxy 4.11
```
## Enumeration

### Web Proxy

您可以尝试在浏览器中将此已发现的服务设置为 proxy。 但是，如果它配置了 HTTP authentication，系统会提示您输入用户名和密码。
```bash
# Try to proxify curl
curl --proxy http://10.10.11.131:3128 http://10.10.11.131
```
### Nmap 代理化

你也可以尝试滥用代理来**通过代理化 Nmap 扫描内部端口**。\
配置 proxychains 使用 squid 代理，在 proxichains.conf 文件末尾添加以下行： `http 10.10.10.10 3128`  
对于需要认证的代理，通过在末尾包含用户名和密码将凭据追加到配置中： `http 10.10.10.10 3128 username passw0rd`。

然后使用 proxychains 运行 nmap 来**从本地扫描主机**： `proxychains nmap -sT -n -p- localhost`

### SPOSE 扫描器

或者，可以使用 Squid Pivoting Open Port Scanner（[spose.py](https://github.com/aancw/spose)）。
```bash
python spose.py --proxy http://10.10.11.131:3128 --target 10.10.11.131
```
### Pivot 与 工具配置

*将 Squid 用作发现 pivot，并作为 CLI 和 browser 工具的透明上游跳点。*

- **从 “proxy” 扫描：** 通过 Squid 运行 SPOSE 以枚举从 proxy 主机/回环 可达的端口。使用 [uv](https://github.com/astral-sh/uv) 你可以安装 deps 并直接扫描所有 TCP 端口：
```bash
uv add --script spose.py -r requirements.txt
uv run spose.py --proxy http://SQUID_IP:3128 --target localhost --allports
```
- **Proxychains 用于 HTTP 交互:** 在 `/etc/proxychains.conf` 底部添加一个严格的 HTTP 条目：
```ini
[ProxyList]
http    SQUID_IP   3128
```
然后通过 Squid 透明地与内部监听器（例如绑定到 127.0.0.1 的 web UI）进行交互：
```bash
proxychains curl http://127.0.0.1:9191 -v
```
- **链路 Burp/Browser → Squid:** 将 Burp 的 *Proxy → Settings → Network → Connections → Upstream proxy servers* 配置为指向 `http://SQUID_IP:3128`。对内部主机（例如 `http://127.0.0.1:9191`）的请求将通过 Browser → Burp → Squid → 目标，从而可以对外部无法直接访问的服务进行完全拦截。

## References

- [SPOSE – Squid Pivoting Open Port Scanner](https://github.com/aancw/spose)
- [HTB Bamboo walkthrough (Squid pivoting example)](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)

{{#include ../banners/hacktricks-training.md}}
