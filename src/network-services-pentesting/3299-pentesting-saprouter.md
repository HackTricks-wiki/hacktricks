{{#include ../banners/hacktricks-training.md}}
```text
PORT     STATE SERVICE    VERSION
3299/tcp open  saprouter?
```
Ceci est un résumé du post de [https://blog.rapid7.com/2014/01/09/piercing-saprouter-with-metasploit/](https://blog.rapid7.com/2014/01/09/piercing-saprouter-with-metasploit/)

## Comprendre la pénétration de SAProuter avec Metasploit

SAProuter agit comme un proxy inverse pour les systèmes SAP, principalement pour contrôler l'accès entre Internet et les réseaux internes SAP. Il est couramment exposé à Internet en permettant le port TCP 3299 à travers les pare-feu organisationnels. Cette configuration rend SAProuter une cible attrayante pour le pentesting car il pourrait servir de passerelle vers des réseaux internes de grande valeur.

**Analyse et collecte d'informations**

Initialement, un scan est effectué pour identifier si un routeur SAP fonctionne sur une IP donnée en utilisant le module **sap_service_discovery**. Cette étape est cruciale pour établir la présence d'un routeur SAP et son port ouvert.
```text
msf> use auxiliary/scanner/sap/sap_service_discovery
msf auxiliary(sap_service_discovery) > set RHOSTS 1.2.3.101
msf auxiliary(sap_service_discovery) > run
```
Suite à la découverte, une enquête plus approfondie sur la configuration du routeur SAP est effectuée avec le module **sap_router_info_request** pour potentiellement révéler des détails sur le réseau interne.
```text
msf auxiliary(sap_router_info_request) > use auxiliary/scanner/sap/sap_router_info_request
msf auxiliary(sap_router_info_request) > set RHOSTS 1.2.3.101
msf auxiliary(sap_router_info_request) > run
```
**Énumération des services internes**

Avec les informations obtenues sur le réseau interne, le module **sap_router_portscanner** est utilisé pour sonder les hôtes et services internes via le SAProuter, permettant une compréhension plus approfondie des réseaux internes et des configurations de services.
```text
msf auxiliary(sap_router_portscanner) > set INSTANCES 00-50
msf auxiliary(sap_router_portscanner) > set PORTS 32NN
```
La flexibilité de ce module à cibler des instances SAP spécifiques et des ports en fait un outil efficace pour une exploration détaillée du réseau interne.

**Énumération Avancée et Cartographie des ACL**

Un scan supplémentaire peut révéler comment les Listes de Contrôle d'Accès (ACL) sont configurées sur le SAProuter, détaillant quelles connexions sont autorisées ou bloquées. Cette information est essentielle pour comprendre les politiques de sécurité et les vulnérabilités potentielles.
```text
msf auxiliary(sap_router_portscanner) > set MODE TCP
msf auxiliary(sap_router_portscanner) > set PORTS 80,32NN
```
**Énumération aveugle des hôtes internes**

Dans les scénarios où les informations directes provenant du SAProuter sont limitées, des techniques comme l'énumération aveugle peuvent être appliquées. Cette approche tente de deviner et de vérifier l'existence de noms d'hôtes internes, révélant des cibles potentielles sans adresses IP directes.

**Exploitation des informations pour le pentesting**

Après avoir cartographié le réseau et identifié les services accessibles, les testeurs de pénétration peuvent utiliser les capacités de proxy de Metasploit pour pivoter à travers le SAProuter pour une exploration et une exploitation supplémentaires des services SAP internes.
```text
msf auxiliary(sap_hostctrl_getcomputersystem) > set Proxies sapni:1.2.3.101:3299
msf auxiliary(sap_hostctrl_getcomputersystem) > set RHOSTS 192.168.1.18
msf auxiliary(sap_hostctrl_getcomputersystem) > run
```
**Conclusion**

Cette approche souligne l'importance des configurations sécurisées de SAProuter et met en évidence le potentiel d'accès aux réseaux internes grâce à des tests de pénétration ciblés. Sécuriser correctement les routeurs SAP et comprendre leur rôle dans l'architecture de sécurité réseau est crucial pour se protéger contre les accès non autorisés.

Pour des informations plus détaillées sur les modules Metasploit et leur utilisation, visitez [Rapid7's database](http://www.rapid7.com/db).

## **References**

- [https://www.rapid7.com/blog/post/2014/01/09/piercing-saprouter-with-metasploit/](https://www.rapid7.com/blog/post/2014/01/09/piercing-saprouter-with-metasploit/)

## Shodan

- `port:3299 !HTTP Network packet too big`

{{#include ../banners/hacktricks-training.md}}
