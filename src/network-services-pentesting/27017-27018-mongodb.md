# 27017,27018 - Pentesting MongoDB

{{#include ../banners/hacktricks-training.md}}

## Podstawowe informacje

**MongoDB** to **otwartoźródłowy** system zarządzania bazami danych, który używa **modelu bazy danych zorientowanego na dokumenty** do obsługi różnych form danych. Zapewnia elastyczność i skalowalność w zarządzaniu danymi nieustrukturyzowanymi lub półstrukturalnymi w zastosowaniach takich jak analityka big data i zarządzanie treścią. **Port domyślny:** 27017, 27018
```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## Enumeracja

### Ręczne
```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
print(db)
print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```
**Niektóre polecenia MongoDB:**
```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```
### Automatyczne
```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```
### Shodan

- Wszystkie mongodb: `"mongodb server information"`
- Wyszukaj całkowicie otwarte serwery mongodb: `"mongodb server information" -"partially enabled"`
- Tylko częściowo włączone auth: `"mongodb server information" "partially enabled"`

## Logowanie

Domyślnie mongo nie wymaga hasła.\
**Admin** to powszechna baza danych mongo.
```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```
Skrypt nmap: _**mongodb-brute**_ sprawdzi, czy creds są potrzebne.
```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```
### [**Brute force**](../generic-hacking/brute-force.md#mongo)

Sprawdź plik _/opt/bitnami/mongodb/mongodb.conf_, aby dowiedzieć się, czy wymagane są poświadczenia:
```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
## Przewidywanie Mongo Objectid

Przykład [stąd](https://techkranti.com/idor-through-mongodb-object-ids-prediction/).

Mongo Object IDs are **12-byte hexadecimal** strings:

![http://techidiocy.com/_id-objectid-in-mongodb/](../images/id-and-ObjectIds-in-MongoDB.png)

Na przykład, oto jak możemy rozłożyć rzeczywisty Object ID zwrócony przez aplikację: 5f2459ac9fa6dc2500314019

1. 5f2459ac: 1596217772 in decimal = piątek, 31 lipca 2020 17:49:32
2. 9fa6dc: Identyfikator maszyny
3. 2500: Id procesu
4. 314019: Przyrostowy licznik

Z powyższych elementów identyfikator maszyny pozostanie taki sam dopóki baza danych działa na tej samej maszynie fizycznej/wirtualnej. Process ID zmieni się tylko jeśli proces MongoDB zostanie zrestartowany. Timestamp będzie aktualizowany co sekundę. Jedynym wyzwaniem w zgadywaniu Object ID przez po prostu inkrementowanie wartości licznika i znacznika czasu, jest fakt, że Mongo DB generuje Object IDs i przypisuje Object IDs na poziomie systemu.

Narzędzie [https://github.com/andresriancho/mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict), podając startowy Object ID (możesz utworzyć konto i otrzymać startowy ID), zwraca około 1000 prawdopodobnych Object ID, które mogłyby zostać przypisane kolejnym obiektom, więc wystarczy je przetestować metodą bruteforce.

## Po

Jeśli jesteś root możesz **zmodyfikować** plik **mongodb.conf** tak, aby nie były potrzebne żadne poświadczenia (_noauth = true_) i **zalogować się bez poświadczeń**.

## MongoBleed zlib ujawnienie pamięci (CVE-2025-14847)

Powszechne nieautoryzowane ujawnienie pamięci ("MongoBleed") dotyczy MongoDB 3.6–8.2 zawsze gdy **kompresor sieciowy zlib jest włączony**. Podczas dekompresji OP\_MSG MongoDB zwraca **długość przydziału kontrolowaną przez atakującego zamiast rzeczywistej długości po dekompresji**, więc odpowiedź zawiera niezainicjalizowaną pamięć serwera należącą do innych połączeń, plików `/proc` lub cache WiredTiger.

### Wymagania ekspozycji i szybkie sprawdzenia

- Wersja serwera musi mieścić się w podatnych zakresach (3.6, 4.0, 4.2, 4.4.0–4.4.29, 5.0.0–5.0.31, 6.0.0–6.0.26, 7.0.0–7.0.27, 8.0.0–8.0.16, 8.2.0–8.2.2).
- `net.compression.compressors` lub `networkMessageCompressors` musi zawierać `zlib` (domyślnie w wielu buildach). Sprawdź to z poziomu powłoki poleceniem:
```javascript
db.adminCommand({getParameter: 1, networkMessageCompressors: 1})
```
- Atakujący potrzebuje tylko dostępu sieciowego do portu MongoDB. Uwierzytelnianie nie jest wymagane.

### Exploitation & harvesting workflow

1. Rozpocznij wire-protocol handshake, deklarując `compressors:["zlib"]` i wymuś użycie zlib dla sesji.
2. Wyślij spreparowane skompresowane ramki OP\_MSG, których zadeklarowane `uncompressedSize` jest dużo większe niż rzeczywista zawartość, tak aby MongoDB zaalokowało ogromny bufor.
3. Ponieważ MongoDB kopiuje całą długość bufora do odpowiedzi, parser BSON traktuje **garbage field names** jako prawidłowe dane aż do napotkania `\x00`, leaking fragmenty pamięci procesu przy każdej odpowiedzi.
4. Zmieniaj zadeklarowaną długość/offset dokumentu, żeby przemieszczać się po pamięci procesu i agregować leaks.

Publiczny PoC automatyzuje sondowanie offsetów i wyodrębnianie zwróconych fragmentów:
```bash
python3 mongobleed.py --host <target> --max-offset 50000 --output leaks.bin
```
Stosowanie szerszych zakresów offsetów konsekwentnie ujawnia:

- wewnętrzne logi MongoDB, UUID połączeń, adresy IP klientów oraz statystyki WireTiger.
- Artefakty z /proc takie jak `meminfo`, statystyki socketów lub ścieżki kontenerów przydatne przy container escape lub lateral movement.
- Sekrety znajdujące się w pamięci (database creds, API tokens, cloud keys, session cookies, itp.).

Na dużą skalę atakujący najpierw fingerprintują instancje `mongod` (np. Censys zauważył >87k odsłoniętych usług), potwierdzają wersję/kompresor, a następnie powtarzają powyższą sekwencję, aby zbudować przeszukiwalny zrzut leaked strings do późniejszej kompromitacji.


## Referencje

- [Tenable – CVE-2025-14847 (MongoBleed): MongoDB Memory Leak Vulnerability Exploited in the Wild](https://www.tenable.com/blog/cve-2025-14847-mongobleed-mongodb-memory-leak-vulnerability-exploited-in-the-wild)
- [MongoDB Security Advisory SERVER-115508](https://jira.mongodb.org/browse/SERVER-115508)
- [Censys – MongoBleed Advisory](https://censys.com/advisory/cve-2025-14847)
- [MongoBleed PoC (joe-desimone/mongobleed)](https://github.com/joe-desimone/mongobleed)

---

{{#include ../banners/hacktricks-training.md}}
