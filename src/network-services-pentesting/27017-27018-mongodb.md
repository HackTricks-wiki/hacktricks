# 27017,27018 - Pentesting MongoDB

{{#include ../banners/hacktricks-training.md}}

## 基本情報

**MongoDB** は **オープンソース** のデータベース管理システムで、**ドキュメント指向データベースモデル** を使用して多様な形式のデータを扱います。ビッグデータ解析やコンテンツ管理などのアプリケーションにおいて、非構造化または半構造化データを管理するための柔軟性とスケーラビリティを提供します。 **デフォルトポート:** 27017, 27018
```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## 列挙

### 手動
```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
print(db)
print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```
**いくつかの MongoDB コマンド:**
```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```
### 自動
```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```
### Shodan

- すべての mongodb: `"mongodb server information"`
- 完全に公開された mongodb サーバを検索: `"mongodb server information" -"partially enabled"`
- auth が部分的に有効なもののみ: `"mongodb server information" "partially enabled"`

## ログイン

デフォルトでは mongo はパスワードを必要としません.\
**Admin** は一般的な mongo データベースです.
```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```
nmap スクリプト: _**mongodb-brute**_ は creds が必要かどうかを確認します。
```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```
### [**Brute force**](../generic-hacking/brute-force.md#mongo)

credentials が必要かどうかを確認するには、_/opt/bitnami/mongodb/mongodb.conf_ を確認してください:
```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
## Mongo Objectid Predict

Example [from here](https://techkranti.com/idor-through-mongodb-object-ids-prediction/).

Mongo Object IDs are **12バイトの16進数** 文字列:

![http://techidiocy.com/_id-objectid-in-mongodb/](../images/id-and-ObjectIds-in-MongoDB.png)

例えば、アプリケーションが返す実際の Object ID を分解すると次のようになります: 5f2459ac9fa6dc2500314019

1. 5f2459ac: 1596217772 in decimal = Friday, 31 July 2020 17:49:32
2. 9fa6dc: マシン識別子
3. 2500: プロセス ID
4. 314019: 増分カウンタ

上記の要素のうち、マシン識別子はデータベースが同じ物理/仮想マシン上で動作している限り変わりません。プロセス ID は MongoDB プロセスが再起動された場合にのみ変わります。タイムスタンプは毎秒更新されます。カウンタとタイムスタンプの値を単純にインクリメントして Object IDs を推測する際の唯一の課題は、MongoDB がシステムレベルで Object IDs を生成し割り当てるという点です。

ツール [https://github.com/andresriancho/mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict) は、開始の Object ID を与えると（アカウントを作成して開始 ID を取得できます）、次に割り当てられる可能性のある約1000件の候補 Object ID を返すので、それらを bruteforce するだけで済みます。

## Post

If you are root you can **modify** the **mongodb.conf** file so no credentials are needed (_noauth = true_) and **login without credentials**.

## MongoBleed zlib Memory Disclosure (CVE-2025-14847)

A widespread unauthenticated memory disclosure ("MongoBleed") impacts MongoDB 3.6–8.2 whenever the **zlib network compressor is enabled**. During OP\_MSG decompression MongoDB returns the **attacker-controlled allocation length instead of the real uncompressed length**, so the reply contains uninitialized server memory that belongs to other connections, `/proc` files, or the WiredTiger cache.

### Exposure requirements & quick checks

- Server version must be within the vulnerable ranges (3.6, 4.0, 4.2, 4.4.0–4.4.29, 5.0.0–5.0.31, 6.0.0–6.0.26, 7.0.0–7.0.27, 8.0.0–8.0.16, 8.2.0–8.2.2).
- `net.compression.compressors` or `networkMessageCompressors` must include `zlib` (default on many builds). Check it from the shell with:
```javascript
db.adminCommand({getParameter: 1, networkMessageCompressors: 1})
```
- 攻撃者は MongoDB ポートへのネットワークアクセスだけが必要です。認証は不要です。

### Exploitation & harvesting workflow

1. `compressors:["zlib"]` を広告しつつ wire-protocol ハンドシェイクを開始し、セッションに zlib を使わせる。
2. 実際のペイロードよりも宣言された `uncompressedSize` がはるかに大きい、細工した圧縮済みの OP\_MSG フレームを送信して MongoDB に巨大なバッファを割り当てさせる。
3. MongoDB がバッファ全長をレスポンスにコピーするため、BSON パーサは `\x00` に達するまで **garbage field names** を有効なデータとして扱い、leaking chunks of process memory on every response。
4. 主張されたドキュメント長/オフセットを変えてプロセスメモリを走査し、aggregate leaks を収集する。

The public PoC automates the probing offsets and carving of the returned fragments:
```bash
python3 mongobleed.py --host <target> --max-offset 50000 --output leaks.bin
```
広いオフセット範囲で実行すると一貫して得られるもの:

- MongoDB の内部ログ、接続 UUID、クライアント IP、および WireTiger stats。
- /proc のアーティファクト（`meminfo`、socket statistics、またはコンテナパスなど）。これらは container escape や lateral movement に役立つ。
- メモリ上に常駐している秘密情報（database creds、API tokens、cloud keys、session cookies 等）。

大規模に行う場合、攻撃者はまず mongod インスタンスのフィンガープリントを取得（例: Censys saw >87k exposed services）、version/compressor を確認し、その後上記のシーケンスをループしてフォローオン侵害のために leaked strings の検索可能なダンプを構築する。


## 参考文献

- [Tenable – CVE-2025-14847 (MongoBleed): MongoDB Memory Leak Vulnerability Exploited in the Wild](https://www.tenable.com/blog/cve-2025-14847-mongobleed-mongodb-memory-leak-vulnerability-exploited-in-the-wild)
- [MongoDB Security Advisory SERVER-115508](https://jira.mongodb.org/browse/SERVER-115508)
- [Censys – MongoBleed Advisory](https://censys.com/advisory/cve-2025-14847)
- [MongoBleed PoC (joe-desimone/mongobleed)](https://github.com/joe-desimone/mongobleed)

---

{{#include ../banners/hacktricks-training.md}}
