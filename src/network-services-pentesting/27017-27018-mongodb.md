# 27017,27018 - Pentesting MongoDB

{{#include ../banners/hacktricks-training.md}}

## 기본 정보

**MongoDB**는 **오픈 소스** 데이터베이스 관리 시스템으로, 다양한 형태의 데이터를 처리하기 위해 **문서 지향형 데이터베이스 모델**을 사용합니다. 이는 빅데이터 분석 및 콘텐츠 관리와 같은 애플리케이션에서 비정형 또는 반정형 데이터를 관리할 때 유연성과 확장성을 제공합니다. **Default port:** 27017, 27018
```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## 열거

### 수동
```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
print(db)
print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```
**일부 MongoDB 명령어:**
```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```
### 자동
```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```
### Shodan

- 모든 mongodb: `"mongodb server information"`
- 완전히 열린 mongodb 서버 검색: `"mongodb server information" -"partially enabled"`
- auth가 부분적으로만 활성화된 경우: `"mongodb server information" "partially enabled"`

## Login

기본적으로 mongo는 비밀번호를 요구하지 않습니다.\
**Admin**은 일반적인 mongo 데이터베이스입니다.
```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```
nmap 스크립트: _**mongodb-brute**_ 는 creds 가 필요한지 확인합니다.
```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```
### [**Brute force**](../generic-hacking/brute-force.md#mongo)

자격 증명이 필요한지 확인하려면 _/opt/bitnami/mongodb/mongodb.conf_ 파일을 확인하세요:
```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
## Mongo Objectid 예측

Example [from here](https://techkranti.com/idor-through-mongodb-object-ids-prediction/).

Mongo Object IDs are **12바이트 16진수** 문자열:

![http://techidiocy.com/_id-objectid-in-mongodb/](../images/id-and-ObjectIds-in-MongoDB.png)

예를 들어, 애플리케이션이 반환한 실제 Object ID(5f2459ac9fa6dc2500314019)를 분해하면 다음과 같습니다:

1. 5f2459ac: 1596217772 십진수 = 2020년 7월 31일 금요일 17:49:32  
2. 9fa6dc: Machine Identifier  
3. 2500: Process ID  
4. 314019: 증가 카운터

위 요소들 중 Machine Identifier는 데이터베이스가 동일한 물리/가상 머신에서 실행되는 한 그대로 유지됩니다. Process ID는 MongoDB 프로세스가 재시작될 때만 변경됩니다. Timestamp는 매초 업데이트됩니다. 단순히 카운터와 타임스탬프 값을 증가시켜 Object IDs를 추측할 때의 유일한 어려움은 Mongo DB가 시스템 수준에서 Object IDs를 생성하고 할당한다는 점입니다.

도구 [https://github.com/andresriancho/mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict)는 시작 Object ID(계정을 생성해 시작 ID를 얻을 수 있음)를 주면 다음에 할당되었을 가능성이 있는 약 1000개의 가능한 Object IDs를 반환하므로, 그 값들만 bruteforce하면 됩니다.

## Post

If you are root you can **modify** the **mongodb.conf** file so no credentials are needed (_noauth = true_) and **login without credentials**.

## MongoBleed zlib 메모리 노출 (CVE-2025-14847)

A widespread unauthenticated memory disclosure ("MongoBleed") impacts MongoDB 3.6–8.2 whenever the **zlib network compressor is enabled**. During OP\_MSG decompression MongoDB returns the **attacker-controlled allocation length instead of the real uncompressed length**, so the reply contains uninitialized server memory that belongs to other connections, `/proc` files, or the WiredTiger cache.

### 노출 조건 및 빠른 확인

- Server version must be within the vulnerable ranges (3.6, 4.0, 4.2, 4.4.0–4.4.29, 5.0.0–5.0.31, 6.0.0–6.0.26, 7.0.0–7.0.27, 8.0.0–8.0.16, 8.2.0–8.2.2).  
- `net.compression.compressors` or `networkMessageCompressors` must include `zlib` (default on many builds). Check it from the shell with:
```javascript
db.adminCommand({getParameter: 1, networkMessageCompressors: 1})
```
- attacker는 MongoDB 포트에 대한 네트워크 접근만 있으면 됩니다. 인증은 필요하지 않습니다.

### Exploitation & harvesting workflow

1. `compressors:["zlib"]`를 광고하면서 wire-protocol handshake를 시작하고 세션을 zlib 사용으로 강제합니다.
2. 선언된 `uncompressedSize`가 실제 페이로드보다 훨씬 큰 조작된 압축 OP\_MSG 프레임을 전송하여 MongoDB가 거대한 버퍼를 할당하게 합니다.
3. MongoDB가 전체 버퍼 길이를 응답에 복사하기 때문에, BSON parser는 `\x00`을 만날 때까지 **garbage field names**를 유효한 데이터로 취급하여 각 응답에서 process memory의 조각을 leaking합니다.
4. 주장된 문서 길이/오프셋을 변경하여 process memory를 탐색하고 leaks를 집계합니다.

The public PoC automates the probing offsets and carving of the returned fragments:
```bash
python3 mongobleed.py --host <target> --max-offset 50000 --output leaks.bin
```
Running wider offset ranges consistently yields:

- MongoDB 내부 로그, connection UUIDs, 클라이언트 IP 및 WireTiger 통계.
- `/proc` 아티팩트(예: `meminfo`), 소켓 통계 또는 container paths — container escape나 lateral movement에 유용한 경로들.
- 메모리에 상주하는 비밀(예: database creds, API tokens, cloud keys, session cookies 등).

At scale, attackers first fingerprint `mongod` instances (e.g., Censys saw >87k exposed services), confirm the version/compressor, then loop the above sequence to build a searchable dump of leaked strings for follow-on compromise.


## References

- [Tenable – CVE-2025-14847 (MongoBleed): MongoDB Memory Leak Vulnerability Exploited in the Wild](https://www.tenable.com/blog/cve-2025-14847-mongobleed-mongodb-memory-leak-vulnerability-exploited-in-the-wild)
- [MongoDB Security Advisory SERVER-115508](https://jira.mongodb.org/browse/SERVER-115508)
- [Censys – MongoBleed Advisory](https://censys.com/advisory/cve-2025-14847)
- [MongoBleed PoC (joe-desimone/mongobleed)](https://github.com/joe-desimone/mongobleed)

---

{{#include ../banners/hacktricks-training.md}}
