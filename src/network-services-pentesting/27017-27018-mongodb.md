# 27017,27018 - Pentesting MongoDB

{{#include ../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

**MongoDB** είναι ένα **ανοιχτού κώδικα** σύστημα διαχείρισης βάσεων δεδομένων που χρησιμοποιεί ένα **μοντέλο βάσης δεδομένων προσανατολισμένο σε έγγραφα** για να χειρίζεται ποικίλες μορφές δεδομένων. Προσφέρει ευελιξία και επεκτασιμότητα για τη διαχείριση μη δομημένων ή ημι-δομημένων δεδομένων σε εφαρμογές όπως ανάλυση μεγάλων δεδομένων και διαχείριση περιεχομένου. **Προεπιλεγμένη θύρα:** 27017, 27018
```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## Καταγραφή

### Χειροκίνητο
```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
print(db)
print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```
**Κάποιες MongoDB εντολές:**
```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```
### Αυτόματο
```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```
### Shodan

- All mongodb: `"mongodb server information"`
- Search for full open mongodb servers: `"mongodb server information" -"partially enabled"`
- Only partially enable auth: `"mongodb server information" "partially enabled"`

## Σύνδεση

Από προεπιλογή το mongo δεν απαιτεί κωδικό πρόσβασης.\
**Admin** είναι μια κοινή βάση δεδομένων mongo.
```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```
Το nmap script: _**mongodb-brute**_ θα ελέγξει αν χρειάζονται creds.
```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```
### [**Brute force**](../generic-hacking/brute-force.md#mongo)

Κοιτάξτε μέσα στο _/opt/bitnami/mongodb/mongodb.conf_ για να μάθετε αν απαιτούνται διαπιστευτήρια:
```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
## Mongo Objectid Predict

Παράδειγμα [από εδώ](https://techkranti.com/idor-through-mongodb-object-ids-prediction/).

Mongo Object IDs είναι **12-byte hexadecimal** συμβολοσειρές:

![http://techidiocy.com/_id-objectid-in-mongodb/](../images/id-and-ObjectIds-in-MongoDB.png)

Για παράδειγμα, έτσι μπορούμε να αναλύσουμε ένα πραγματικό Object ID που επέστρεψε μια εφαρμογή: 5f2459ac9fa6dc2500314019

1. 5f2459ac: 1596217772 σε δεκαδικό = Παρασκευή, 31 Ιουλίου 2020 17:49:32
2. 9fa6dc: Αναγνωριστικό μηχανής
3. 2500: Process ID
4. 314019: Ένας αυξανόμενος μετρητής

Από τα παραπάνω στοιχεία, το αναγνωριστικό μηχανής θα παραμένει το ίδιο όσο η βάση δεδομένων τρέχει στην ίδια φυσική/virtual μηχανή. Το Process ID θα αλλάζει μόνο αν επανεκκινηθεί η διεργασία MongoDB. Το timestamp ενημερώνεται κάθε δευτερόλεπτο. Η μόνη πρόκληση στο να μαντέψουμε Object IDs απλά αυξάνοντας τον μετρητή και τις τιμές του timestamp, είναι το γεγονός ότι το MongoDB δημιουργεί και αναθέτει Object IDs σε επίπεδο συστήματος.

Το εργαλείο [https://github.com/andresriancho/mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict), δεδομένου ενός αρχικού Object ID (μπορείτε να δημιουργήσετε λογαριασμό και να πάρετε ένα αρχικό ID), επιστρέφει περίπου 1000 πιθανά Object IDs που ενδέχεται να έχουν ανατεθεί στα επόμενα αντικείμενα, οπότε απλώς χρειάζεται να τα bruteforce-άρετε.

## Post

Αν είστε root μπορείτε να **τροποποιήσετε** το αρχείο **mongodb.conf** ώστε να μην απαιτούνται διαπιστευτήρια (_noauth = true_) και να **συνδεθείτε χωρίς διαπιστευτήρια**.

## MongoBleed zlib Memory Disclosure (CVE-2025-14847)

Μια ευρέως διαδεδομένη μη αυθεντικοποιημένη αποκάλυψη μνήμης ("MongoBleed") επηρεάζει τις εκδόσεις MongoDB 3.6–8.2 όποτε ο **zlib network compressor είναι ενεργοποιημένος**. Κατά τη διάρκεια της αποσυμπίεσης OP_MSG, το MongoDB επιστρέφει το **μήκος κατανομής που ελέγχεται από τον επιτιθέμενο αντί για το πραγματικό μήκος μετά την αποσυμπίεση**, οπότε η απάντηση περιέχει μη αρχικοποιημένη μνήμη του server που ανήκει σε άλλες συνδέσεις, αρχεία `/proc`, ή την WiredTiger cache.

### Exposure requirements & quick checks

- Η έκδοση του server πρέπει να είναι εντός των ευάλωτων εκδόσεων (3.6, 4.0, 4.2, 4.4.0–4.4.29, 5.0.0–5.0.31, 6.0.0–6.0.26, 7.0.0–7.0.27, 8.0.0–8.0.16, 8.2.0–8.2.2).
- `net.compression.compressors` ή `networkMessageCompressors` πρέπει να περιλαμβάνουν `zlib` (default σε πολλές builds). Ελέγξτε το από το shell με:
```javascript
db.adminCommand({getParameter: 1, networkMessageCompressors: 1})
```
- Ο επιτιθέμενος χρειάζεται μόνο δικτυακή πρόσβαση στη θύρα MongoDB. Δεν απαιτείται αυθεντικοποίηση.

### Exploitation & harvesting workflow

1. Εκκινήστε το wire-protocol handshake ενώ δηλώνετε `compressors:["zlib"]` και αναγκάστε τη συνεδρία να χρησιμοποιήσει zlib.
2. Στείλτε κατασκευασμένα συμπιεσμένα OP\_MSG frames των οποίων το δηλωμένο `uncompressedSize` είναι πολύ μεγαλύτερο από το πραγματικό payload, έτσι ώστε το MongoDB να δεσμεύσει έναν τεράστιο buffer.
3. Επειδή το MongoDB αντιγράφει ολόκληρο το μήκος του buffer στην απάντηση, ο BSON parser αντιμετωπίζει τα **άχρηστα ονόματα πεδίων** ως έγκυρα δεδομένα μέχρι να χτυπήσει ένα `\x00`, leaking κομμάτια της μνήμης διεργασίας σε κάθε απάντηση.
4. Μεταβάλλετε το δηλωμένο μήκος/offset του εγγράφου για να περιηγηθείτε στη μνήμη διεργασίας και να συγκεντρώσετε leaks.

The public PoC automates the probing offsets and carving of the returned fragments:
```bash
python3 mongobleed.py --host <target> --max-offset 50000 --output leaks.bin
```
Η χρήση μεγαλύτερων εύρων offset αποδίδει σταθερά:

- Εσωτερικά logs του MongoDB, connection UUIDs, client IPs και WireTiger stats.
- `/proc` artifacts όπως `meminfo`, socket statistics ή container paths που είναι χρήσιμα για container escape ή lateral movement.
- Μυστικά που τυχαίνει να βρίσκονται στη μνήμη (database creds, API tokens, cloud keys, session cookies, κ.λπ.).

Σε μεγάλη κλίμακα, οι επιτιθέμενοι πρώτα κάνουν fingerprint σε instances `mongod` (π.χ. η Censys saw >87k exposed services), επιβεβαιώνουν την έκδοση/compressor, και στη συνέχεια επαναλαμβάνουν την παραπάνω ακολουθία για να δημιουργήσουν ένα αναζητήσιμο dump από leaked strings για follow-on compromise.


## Αναφορές

- [Tenable – CVE-2025-14847 (MongoBleed): MongoDB Memory Leak Vulnerability Exploited in the Wild](https://www.tenable.com/blog/cve-2025-14847-mongobleed-mongodb-memory-leak-vulnerability-exploited-in-the-wild)
- [MongoDB Security Advisory SERVER-115508](https://jira.mongodb.org/browse/SERVER-115508)
- [Censys – MongoBleed Advisory](https://censys.com/advisory/cve-2025-14847)
- [MongoBleed PoC (joe-desimone/mongobleed)](https://github.com/joe-desimone/mongobleed)

---

{{#include ../banners/hacktricks-training.md}}
