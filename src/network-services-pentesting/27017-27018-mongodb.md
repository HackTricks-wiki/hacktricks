# 27017,27018 - Pentesting MongoDB

{{#include ../banners/hacktricks-training.md}}

## Informações básicas

**MongoDB** é um sistema de gerenciamento de banco de dados de **código aberto** que utiliza um **modelo de banco de dados orientado a documentos** para lidar com diversas formas de dados. Ele oferece flexibilidade e escalabilidade para gerenciar dados não estruturados ou semi-estruturados em aplicações como análise de big data e gerenciamento de conteúdo. **Porta padrão:** 27017, 27018
```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## Enumeração

### Manual
```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
print(db)
print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```
**Alguns comandos do MongoDB:**
```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```
### Automático
```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```
### Shodan

- Todos os mongodb: `"mongodb server information"`
- Procurar por servidores mongodb totalmente abertos: `"mongodb server information" -"partially enabled"`
- Somente auth parcialmente habilitada: `"mongodb server information" "partially enabled"`

## Login

Por padrão, mongo não requer senha.\
**Admin** é um banco de dados mongo comum.
```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```
O script do nmap: _**mongodb-brute**_ verificará se creds são necessários.
```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```
### [**Brute force**](../generic-hacking/brute-force.md#mongo)

Verifique o arquivo _/opt/bitnami/mongodb/mongodb.conf_ para saber se credenciais são necessárias:
```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
## Mongo Objectid Predict

Example [from here](https://techkranti.com/idor-through-mongodb-object-ids-prediction/).

Mongo Object IDs são **sequências hexadecimais de 12 bytes**:

![http://techidiocy.com/_id-objectid-in-mongodb/](../images/id-and-ObjectIds-in-MongoDB.png)

Por exemplo, aqui está como podemos dissecar um Object ID real retornado por uma aplicação: 5f2459ac9fa6dc2500314019

1. 5f2459ac: 1596217772 em decimal = sexta-feira, 31 de julho de 2020 17:49:32
2. 9fa6dc: Identificador da máquina
3. 2500: ID do processo
4. 314019: Um contador incremental

Dos elementos acima, o identificador da máquina permanecerá o mesmo enquanto o banco de dados estiver rodando na mesma máquina física/virtual. O ID do processo só muda se o processo MongoDB for reiniciado. O timestamp é atualizado a cada segundo. O único desafio em adivinhar Object IDs simplesmente incrementando os valores do contador e do timestamp é o fato de que o MongoDB gera e atribui Object IDs a nível de sistema.

A ferramenta [https://github.com/andresriancho/mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict), dado um Object ID inicial (você pode criar uma conta e obter um ID inicial), retorna cerca de 1000 Object IDs prováveis que poderiam ter sido atribuídos aos próximos objetos, então você só precisa bruteforceá-los.

## Post

If you are root you can **modify** the **mongodb.conf** file so no credentials are needed (_noauth = true_) and **login without credentials**.

## MongoBleed zlib Memory Disclosure (CVE-2025-14847)

A widespread unauthenticated memory disclosure ("MongoBleed") impacts MongoDB 3.6–8.2 whenever the **zlib network compressor is enabled**. During OP\_MSG decompression MongoDB returns the **attacker-controlled allocation length instead of the real uncompressed length**, so the reply contains uninitialized server memory that belongs to other connections, `/proc` files, or the WiredTiger cache.

### Requisitos de exposição e verificações rápidas

- Server version must be within the vulnerable ranges (3.6, 4.0, 4.2, 4.4.0–4.4.29, 5.0.0–5.0.31, 6.0.0–6.0.26, 7.0.0–7.0.27, 8.0.0–8.0.16, 8.2.0–8.2.2).
- `net.compression.compressors` or `networkMessageCompressors` must include `zlib` (default on many builds). Verifique isso no shell com:
```javascript
db.adminCommand({getParameter: 1, networkMessageCompressors: 1})
```
- O atacante precisa apenas de acesso de rede à porta do MongoDB. Nenhuma autenticação é necessária.

### Fluxo de exploração e coleta

1. Inicie o handshake do wire-protocol anunciando `compressors:["zlib"]` e force a sessão a usar zlib.
2. Envie quadros comprimidos OP\_MSG forjados cujo `uncompressedSize` declarado seja muito maior que o payload real, para que o MongoDB aloque um buffer enorme.
3. Como o MongoDB copia todo o comprimento do buffer na resposta, o parser BSON trata **garbage field names** como dados válidos até encontrar um `\x00`, leaking chunks of process memory em cada resposta.
4. Varie o comprimento/offset do documento declarado para percorrer a memória do processo e agregar leaks.

O PoC público automatiza os probing offsets e o carving dos fragmentos retornados:
```bash
python3 mongobleed.py --host <target> --max-offset 50000 --output leaks.bin
```
Executar intervalos de offset mais amplos de forma consistente resulta em:

- logs internos do MongoDB, UUIDs de conexão, IPs de clientes e estatísticas do WireTiger.
- artefatos em `/proc` como `meminfo`, estatísticas de socket ou caminhos de container úteis para container escape ou lateral movement.
- Segredos que estejam residentes na memória (database creds, API tokens, cloud keys, session cookies, etc.).

Em larga escala, os atacantes primeiro fazem fingerprint das instâncias `mongod` (e.g., Censys saw >87k exposed services), confirmam a versão/compressor e então repetem a sequência acima para construir um dump pesquisável de leaked strings para comprometimentos subsequentes.


## Referências

- [Tenable – CVE-2025-14847 (MongoBleed): MongoDB Memory Leak Vulnerability Exploited in the Wild](https://www.tenable.com/blog/cve-2025-14847-mongobleed-mongodb-memory-leak-vulnerability-exploited-in-the-wild)
- [MongoDB Security Advisory SERVER-115508](https://jira.mongodb.org/browse/SERVER-115508)
- [Censys – MongoBleed Advisory](https://censys.com/advisory/cve-2025-14847)
- [MongoBleed PoC (joe-desimone/mongobleed)](https://github.com/joe-desimone/mongobleed)

---

{{#include ../banners/hacktricks-training.md}}
