# 27017,27018 - Pentesting MongoDB

{{#include ../banners/hacktricks-training.md}}

## Informazioni di base

**MongoDB** è un sistema di gestione di database **open source** che utilizza un **modello di database orientato ai documenti** per gestire diverse tipologie di dati. Offre flessibilità e scalabilità per la gestione di dati non strutturati o semi-strutturati in applicazioni come analisi dei big data e gestione dei contenuti. **Porta predefinita:** 27017, 27018
```
PORT      STATE SERVICE VERSION
27017/tcp open  mongodb MongoDB 2.6.9 2.6.9
```
## Enumerazione

### Manuale
```python
from pymongo import MongoClient
client = MongoClient(host, port, username=username, password=password)
client.server_info() #Basic info
#If you have admin access you can obtain more info
admin = client.admin
admin_info = admin.command("serverStatus")
cursor = client.list_databases()
for db in cursor:
print(db)
print(client[db["name"]].list_collection_names())
#If admin access, you could dump the database also
```
**Alcuni comandi MongoDB:**
```bash
show dbs
use <db>
show collections
db.<collection>.find()  #Dump the collection
db.<collection>.count() #Number of records of the collection
db.current.find({"username":"admin"})  #Find in current db the username admin
```
### Automatico
```bash
nmap -sV --script "mongo* and default" -p 27017 <IP> #By default all the nmap mongo enumerate scripts are used
```
### Shodan

- Tutti i server mongodb: `"mongodb server information"`
- Cerca server mongodb completamente aperti: `"mongodb server information" -"partially enabled"`
- Solo auth parzialmente abilitata: `"mongodb server information" "partially enabled"`

## Accesso

Di default mongo non richiede password.\
**Admin** è un database mongo comune.
```bash
mongo <HOST>
mongo <HOST>:<PORT>
mongo <HOST>:<PORT>/<DB>
mongo <database> -u <username> -p '<password>'
```
Lo script nmap: _**mongodb-brute**_ controllerà se sono necessari creds.
```bash
nmap -n -sV --script mongodb-brute -p 27017 <ip>
```
### [**Brute force**](../generic-hacking/brute-force.md#mongo)

Controlla dentro _/opt/bitnami/mongodb/mongodb.conf_ per sapere se sono necessarie credenziali:
```bash
grep "noauth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#" #Not needed
grep "auth.*true" /opt/bitnami/mongodb/mongodb.conf | grep -v "^#\|noauth" #Not needed
```
## Mongo Objectid Predict

Example [from here](https://techkranti.com/idor-through-mongodb-object-ids-prediction/).

Mongo Object IDs sono **12-byte esadecimali** stringhe:

![http://techidiocy.com/_id-objectid-in-mongodb/](../images/id-and-ObjectIds-in-MongoDB.png)

Per esempio, ecco come possiamo scomporre un reale Object ID restituito da un'applicazione: 5f2459ac9fa6dc2500314019

1. 5f2459ac: 1596217772 in decimal = venerdì, 31 luglio 2020 17:49:32
2. 9fa6dc: Machine Identifier
3. 2500: Process ID
4. 314019: Un contatore incrementale

Degli elementi sopra, il machine identifier resterà lo stesso finché il database gira sulla stessa macchina fisica/virtuale. Il Process ID cambierà solo se il processo MongoDB viene riavviato. Il Timestamp viene aggiornato ogni secondo. L'unica sfida nel indovinare Object IDs semplicemente incrementando il contatore e i valori del timestamp è il fatto che Mongo DB genera e assegna Object IDs a livello di sistema.

Lo strumento [https://github.com/andresriancho/mongo-objectid-predict](https://github.com/andresriancho/mongo-objectid-predict), dato un Object ID di partenza (puoi creare un account e ottenere un ID di partenza), restituisce circa 1000 probabili Object ID che potrebbero essere stati assegnati agli oggetti successivi, quindi ti basta bruteforzarli.

## Post

Se sei root puoi **modificare** il file **mongodb.conf** in modo che non siano necessarie credenziali (_noauth = true_) e effettuare il login senza credenziali.

## MongoBleed zlib Memory Disclosure (CVE-2025-14847)

Una diffusa divulgazione di memoria non autenticata ("MongoBleed") impatta MongoDB 3.6–8.2 ogni volta che il compressore di rete **zlib** è abilitato. Durante la decompressione di OP\_MSG MongoDB restituisce la **lunghezza di allocazione controllata dall'attaccante invece della reale lunghezza decompresso**, così la risposta contiene memoria di server non inizializzata che appartiene ad altre connessioni, file /proc, o alla cache di WiredTiger.

### Requisiti di esposizione & controlli rapidi

- La versione del server deve rientrare negli intervalli vulnerabili (3.6, 4.0, 4.2, 4.4.0–4.4.29, 5.0.0–5.0.31, 6.0.0–6.0.26, 7.0.0–7.0.27, 8.0.0–8.0.16, 8.2.0–8.2.2).
- `net.compression.compressors` o `networkMessageCompressors` devono includere `zlib` (default su molte build). Verificalo dalla shell con:
```javascript
db.adminCommand({getParameter: 1, networkMessageCompressors: 1})
```
- L'attaccante ha solo bisogno dell'accesso di rete alla porta MongoDB. Non è necessaria alcuna autenticazione.

### Flusso di sfruttamento e raccolta

1. Iniziare il wire-protocol handshake mentre si pubblicizza `compressors:["zlib"]` e forzare la sessione a usare zlib.
2. Inviare frame OP\_MSG compressi appositamente creati il cui dichiarato `uncompressedSize` è molto più grande del payload reale in modo che MongoDB allochi un buffer enorme.
3. Poiché MongoDB copia l'intera lunghezza del buffer nella reply, il parser BSON tratta **nomi di campo non validi** come dati validi finché non incontra `\x00`, leaking chunks of process memory on every response.
4. Variare la lunghezza/offset del documento dichiarato per scorrere la memoria del processo e aggregare leaks.

The public PoC automates the probing offsets and carving of the returned fragments:
```bash
python3 mongobleed.py --host <target> --max-offset 50000 --output leaks.bin
```
Eseguire range di offset più ampi produce costantemente:

- log interni di MongoDB, UUID delle connessioni, IP dei client e statistiche WireTiger.
- `/proc` artefatti come `meminfo`, statistiche di socket o percorsi dei container utili per container escape o lateral movement.
- Segreti residenti in memoria (credenziali del database, token API, chiavi cloud, cookie di sessione, ecc.).

Su larga scala, gli attaccanti prima fingerprint le istanze `mongod` (ad es., Censys ha visto >87k servizi esposti), confermano la version/compressor, quindi ripetono la sequenza sopra per costruire un dump ricercabile di leaked strings per compromissioni successive.


## References

- [Tenable – CVE-2025-14847 (MongoBleed): MongoDB Memory Leak Vulnerability Exploited in the Wild](https://www.tenable.com/blog/cve-2025-14847-mongobleed-mongodb-memory-leak-vulnerability-exploited-in-the-wild)
- [MongoDB Security Advisory SERVER-115508](https://jira.mongodb.org/browse/SERVER-115508)
- [Censys – MongoBleed Advisory](https://censys.com/advisory/cve-2025-14847)
- [MongoBleed PoC (joe-desimone/mongobleed)](https://github.com/joe-desimone/mongobleed)

---

{{#include ../banners/hacktricks-training.md}}
