# 5353/UDP Multicast DNS (mDNS) and DNS-SD

{{#include ../banners/hacktricks-training.md}}

## बुनियादी जानकारी

Multicast DNS (mDNS) स्थानीय लिंक के अंदर एक unicast DNS server के बिना DNS-जैसे नाम समाधान और सेवा खोज को सक्षम करता है। यह UDP/5353 और मल्टीकास्ट पते 224.0.0.251 (IPv4) और FF02::FB (IPv6) का उपयोग करता है। DNS Service Discovery (DNS-SD, typically used with mDNS) PTR, SRV and TXT records के माध्यम से सेवाओं को सूचीबद्ध करने और वर्णित करने का एक मानकीकृत तरीका प्रदान करता है।
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Key protocol विवरण जो आप अक्सर हमलों के दौरान उपयोग करेंगे:
- .local ज़ोन में नाम mDNS के माध्यम से resolve होते हैं।
- QU (Query Unicast) बिट मल्टीकास्ट प्रश्नों के लिए भी unicast उत्तरों का अनुरोध कर सकता है।
- Implementations को उन packets को ignore करना चाहिए जो local link से sourced नहीं हैं; कुछ stacks अभी भी उन्हें स्वीकार करते हैं।
- Probing/announcing अनन्य host/service नामों को लागू करता/सुनिश्चित करता है; यहाँ हस्तक्षेप करने से DoS/“name squatting” की स्थितियाँ बन सकती हैं।

## DNS-SD सेवा मॉडल

Services को .local के अंतर्गत _<service>._tcp या _<service>._udp के रूप में पहचाना जाता है, उदाहरण के लिए _ipp._tcp.local (printers), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge), आदि। प्रकारों की खोज _services._dns-sd._udp.local के साथ करें, फिर खोजे गए instances को SRV/TXT/A/AAAA में resolve करें।

## नेटवर्क एक्सप्लोरेशन और सूचीकरण

- nmap target scan (होस्ट पर प्रत्यक्ष mDNS):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap broadcast discovery (सेगमेंट को सुनकर सभी DNS-SD प्रकार/instances को सूचीबद्ध करें):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Packet capture with tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Tip: कुछ browsers/WebRTC अस्थायी (ephemeral) mDNS hostnames का उपयोग स्थानीय IPs को छिपाने के लिए करते हैं। यदि आप वायर्ड ट्रैफ़िक पर random-UUID.local उम्मीदवार देखते हैं, तो उन्हें mDNS से resolve करें ताकि आप स्थानीय IPs पर pivot कर सकें।

## Attacks

### mDNS name probing interference (DoS / name squatting)

प्रोबिंग चरण के दौरान, एक होस्ट नाम की अनन्यता की जांच करता है। नकली (spoofed) conflicts के साथ जवाब देने से यह मजबूर होता है कि वह नए नाम चुने या विफल हो जाए। इससे service registration और discovery में देरी या रोकथाम हो सकती है।

Example with Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### सेवा spoofing and impersonation (MitM)

प्रचारित DNS-SD सेवाओं (printers, AirPlay, HTTP, file shares) का impersonate करके क्लाइंट्स को आपसे जुड़ने के लिए मजबूर करें। यह विशेष रूप से उपयोगी है:
- _ipp._tcp या _printer._tcp को spoofing करके दस्तावेज़ कैप्चर करें।
- क्लाइंट्स को HTTP/HTTPS सेवाओं की ओर लुभाकर tokens/cookies इकट्ठा करें या payloads पहुँचाएँ।
- जब Windows क्लाइंट्स spoofed services के साथ auth negotiate करते हैं, तब इसे NTLM relay techniques के साथ मिलाकर उपयोग करें।

bettercap के zerogod module (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
साथ ही सामान्य LLMNR/NBNS/mDNS/WPAD spoofing और credential capture/relay workflows देखें:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### हाल की implementation समस्याओं पर नोट्स (engagements के दौरान DoS/persistence के लिए उपयोगी)

- Avahi reachable-assertion और D-Bus crash bugs (2023) avahi-daemon को Linux वितरणों पर terminate कर सकते हैं (उदा. CVE-2023-38469..38473, CVE-2023-1981), जिससे target hosts पर service discovery restart तक प्रभावित रहती है।
- Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) आसन्न WLAN क्लाइंट्स को crafted mDNS flood करने देता है, जिससे WLC CPU spike होता है और AP tunnels drop हो जाते हैं — यह उपयोगी हो सकता है यदि आपको engagement के दौरान client roaming या controller resets मजबूर करने हों।
- Apple mDNSResponder logic error DoS (CVE-2024-44183) एक sandboxed local process को Bonjour crash करने देता है ताकि Apple endpoints पर सेवाओं के publication/lookup को अस्थायी रूप से दबाया जा सके; मौजूदा iOS/macOS रिलीज़ में patched है।
- Apple mDNSResponder correctness issue (CVE-2025-31222) ने लोकल privilege escalation की अनुमति दी थी via mDNSResponder; unmanaged Macs/iPhones पर persistence के लिए उपयोगी, हालिया iOS/macOS updates में fixed है।

### Browser/WebRTC mDNS पर विचार

आधुनिक Chromium/Firefox host candidates को random mDNS नामों से obfuscate करते हैं। आप managed endpoints पर LAN IPs को फिर से expose कर सकते हैं Chrome policy `WebRtcLocalIpsAllowedUrls` push करके (या `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/Edge समतुल्य toggle करके) ताकि ICE mDNS की बजाय host candidates को expose करे; इसे `HKLM\Software\Policies\Google\Chrome` के माध्यम से सेट करें।

जब उपयोगकर्ता सुरक्षा को मैन्युअली disable करते हैं (WebRTC troubleshooting guides में सामान्य), उनके ब्राउज़र्स फिर से plain host candidates advertise करना शुरू कर देते हैं, जिन्हें आप mDNS या ICE signaling के माध्यम से capture कर सकते हैं ताकि host discovery तेज़ हो सके।

## Defensive विचार और OPSEC

- Segment boundaries: सुरक्षा ज़ोन के बीच 224.0.0.251/FF02::FB को route न करें जब तक कि एक mDNS gateway स्पष्ट रूप से आवश्यक न हो। यदि आपको discovery bridge करनी ही पड़े तो allowlists और rate limits पसंद करें।
- Windows endpoints/servers:
- mDNS के माध्यम से name resolution को हार्ड-डिसेबल करने के लिए रजिस्ट्री वैल्यू सेट करें और reboot करें:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- Managed environments में built-in “mDNS (UDP-In)” Windows Defender Firewall rule (कम से कम Domain profile पर) को disable करें ताकि inbound mDNS processing रोकी जा सके जबकि home/roaming कार्यक्षमता बरकरार रहे।
- नए Windows 11 builds/GPO templates पर, policy “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” का उपयोग करें और इसे Disabled पर सेट करें।
- Linux (Avahi):
- आवश्यक न होने पर publishing को लॉक डाउन करें: `disable-publishing=yes` सेट करें, और interfaces को `/etc/avahi/avahi-daemon.conf` में `allow-interfaces=` / `deny-interfaces=` से सीमित करें।
- `check-response-ttl=yes` पर विचार करें और जब तक सख्त रूप से आवश्यक न हो `enable-reflector=yes` से बचें; reflecting करते समय `reflect-filters=` allowlists को प्राथमिकता दें।
- macOS: यदि किसी विशेष सबनेट के लिए Bonjour discovery आवश्यक नहीं है तो host/network firewalls पर inbound mDNS को प्रतिबंधित करें।
- Monitoring: `_services._dns-sd._udp.local` queries में असामान्य surge या critical services के SRV/TXT में अचानक बदलाव पर alert करें; ये spoofing या service impersonation के संकेत होते हैं।

## टूलिंग त्वरित संदर्भ

- nmap NSE: `dns-service-discovery` और `broadcast-dns-service-discovery`।
- Pholus: active scan, reverse mDNS sweeps, DoS और spoofing में सहायक।
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: discover, save, advertise, और impersonate mDNS/DNS-SD services (उपरोक्त उदाहरण देखें)।

## Spoofing/MitM

इस सेवा पर किया जाने वाला सबसे रोचक हमला client और real server के बीच संचार में MitM करना है। आप संवेदनशील फ़ाइलें प्राप्त कर सकते हैं (printer के साथ संचार में MitM करें) या यहां तक कि credentials भी प्राप्त कर सकते हैं (Windows authentication).\
For more information check:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## संदर्भ

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
