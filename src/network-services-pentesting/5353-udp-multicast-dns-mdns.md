# 5353/UDP Multicast DNS (mDNS) and DNS-SD

{{#include ../banners/hacktricks-training.md}}

## Temel Bilgiler

Multicast DNS (mDNS), yerel bir bağlantı içinde unicast DNS sunucusu olmadan DNS-benzeri ad çözümü ve servis keşfi sağlar. UDP/5353 ve çok yayın adresleri 224.0.0.251 (IPv4) ve FF02::FB (IPv6) kullanılır. DNS Service Discovery (DNS-SD, genellikle mDNS ile birlikte kullanılan), PTR, SRV ve TXT kayıtları aracılığıyla hizmetleri listelemek ve tanımlamak için standartlaştırılmış bir yol sunar.
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Ana protokol ayrıntıları — saldırılarda sıkça kullanacağınız:
- .local bölgesindeki isimler mDNS ile çözülür.
- QU (Query Unicast) biti, multicast sorguları için bile unicast yanıtları isteyebilir.
- Implementasyonlar yerel bağlantıdan gelmeyen paketleri yok saymalıdır; bazı stack'ler hâlâ bunları kabul eder.
- Probing/announcing benzersiz host/servis isimlerini zorunlu kılar; buraya müdahale etmek DoS/“name squatting” durumları oluşturur.

## DNS-SD servis modeli

Servisler .local altında _<service>._tcp veya _<service>._udp olarak tanımlanır, örn. _ipp._tcp.local (yazıcılar), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge) vb. Türleri _services._dns-sd._udp.local ile keşfedin, ardından bulunan örnekleri SRV/TXT/A/AAAA olarak çözümleyin.

## Ağ Keşfi ve Enumarasyon

- nmap hedef taraması (bir hostta doğrudan mDNS):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap broadcast discovery (segmenti dinleyip tüm DNS-SD türlerini/örneklerini numaralandırır):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Packet capture with tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

İpucu: Bazı tarayıcılar/WebRTC, yerel IP'leri gizlemek için geçici mDNS host isimleri kullanır. Ağ üzerinde random-UUID.local gibi adaylar görürseniz, bunları mDNS ile çözümleyip yerel IP'lere erişin.

## Saldırılar

### mDNS isim sorgulama müdahalesi (DoS / name squatting)

Sorgulama aşamasında, bir host isim benzersizliğini kontrol eder. Sahte çakışmalarla cevap vermek, onun yeni isimler seçmesini ya da başarısız olmasını zorlar. Bu, servis kaydı ve keşfini geciktirebilir veya engelleyebilir.

Pholus ile örnek:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### Hizmet spoofing ve impersonation (MitM)

İlan edilen DNS-SD servislerini (yazıcılar, AirPlay, HTTP, dosya paylaşımları) taklit ederek istemcileri size bağlanmaya zorlayın. Bu özellikle kullanışlıdır:

- Belgeleri _ipp._tcp veya _printer._tcp üzerinde spoofing yaparak yakalayın.
- İstemcileri tokens/cookies toplamak veya payload teslim etmek için HTTP/HTTPS servislerine çekin.
- Windows istemcileri spoofed services ile auth müzakere ettiğinde NTLM relay teknikleriyle birleştirin.

ile bettercap’s zerogod module (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Also see generic LLMNR/NBNS/mDNS/WPAD spoofing and credential capture/relay workflows:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Son uygulama sorunları notları (engagementlar sırasında DoS/persistence için faydalı)

- Avahi reachable-assertion ve D-Bus crash hataları (2023) Linux dağıtımlarında avahi-daemon'u sonlandırabilir (örn. CVE-2023-38469..38473, CVE-2023-1981), hedef hostlarda servis keşfini restart edilene kadar aksatır.
- Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) bitişik WLAN istemcilerinin crafted mDNS ile WLC CPU'sunu zirveye taşımasına ve AP tünellerinin düşmesine neden olabilir—engagement sırasında istemci roaming veya controller reset zorlamanız gerektiğinde kullanışlıdır.
- Apple mDNSResponder logic error DoS (CVE-2024-44183) sandbox'lanmış yerel bir prosesin Bonjour'u çökertmesine izin vererek Apple uç noktalarında servis yayını/arama işlemlerini kısa süreliğine bastırabilir; mevcut iOS/macOS sürümlerinde patchlendi.
- Apple mDNSResponder correctness issue (CVE-2025-31222) yerel privilege escalation'a izin veriyordu; unmanaged Mac/iPhone'larda persistence için kullanılabilir, son iOS/macOS güncellemelerinde düzeltildi.

### Browser/WebRTC mDNS hususları

Modern Chromium/Firefox host candidate'ları rastgele mDNS isimleriyle obfuskle eder. Yönetilen uç noktalarda LAN IP'lerini yeniden ortaya çıkarmak için Chrome politikasını `WebRtcLocalIpsAllowedUrls` olarak zorlayabilir (veya `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/Edge eşdeğerini değiştirebilirsiniz) böylece ICE mDNS yerine host candidate'ları açığa çıkarır; `HKLM\Software\Policies\Google\Chrome` üzerinden ayarlanır.

Kullanıcılar korumayı elle devre dışı bıraktığında (WebRTC sorun giderme rehberlerinde yaygın), tarayıcıları tekrar düz host candidate'ları ilan etmeye başlar; bunları mDNS veya ICE signaling ile yakalayarak host keşfini hızlandırabilirsiniz.

## Savunma ve OPSEC dikkate alınması gerekenler

- Segment sınırları: 224.0.0.251/FF02::FB'yi güvenlik zonları arasında, bir mDNS gateway açıkça gerekli olmadıkça yönlendirmeyin. Keşfi bridge etmeniz gerekiyorsa, allowlist ve rate limit tercih edin.
- Windows endpoints/servers:
- mDNS üzerinden isim çözümlemesini tamamen devre dışı bırakmak için registry değerini ayarlayın ve yeniden başlatın:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- Yönetilen ortamlarda, inbound mDNS işlemeyi engellemek için yerleşik “mDNS (UDP-In)” Windows Defender Firewall kuralını (en azından Domain profilde) devre dışı bırakın; böylece home/roaming işlevselliği korunur.
- Yeni Windows 11 build'leri/GPO şablonlarında, “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” politikasını kullanın ve Disabled olarak ayarlayın.
- Linux (Avahi):
- Yayını gerekli olmadığında kısıtlayın: `/etc/avahi/avahi-daemon.conf` içinde `disable-publishing=yes` ayarlayın ve `allow-interfaces=` / `deny-interfaces=` ile arayüzleri sınırlayın.
- `check-response-ttl=yes` düşünün ve `enable-reflector=yes` sadece kesinlikle gerekli olmadıkça kullanmayın; yansıtma yaparken `reflect-filters=` allowlist'lerini tercih edin.
- macOS: Bonjour keşfi belirli alt ağlar için gerekliyse hariç, host/ağ firewall'larında inbound mDNS'i kısıtlayın.
- İzleme: `_services._dns-sd._udp.local` sorgularında olağandışı artışlar veya kritik servislerin SRV/TXT kayıtlarında ani değişiklikler için uyarı oluşturun; bunlar spoofing veya servis taklidi göstergeleridir.

## Araçlar hızlı referans

- nmap NSE: `dns-service-discovery` ve `broadcast-dns-service-discovery`.
- Pholus: aktif tarama, reverse mDNS sweep'leri, DoS ve spoofing yardımcıları.
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: mDNS/DNS-SD servislerini keşfetme, kaydetme, ilan etme ve taklit etme (yukarıdaki örneklere bakınız).

## Spoofing/MitM

Bu servis üzerinden yapabileceğiniz en ilginç saldırılardan biri, istemci ile gerçek sunucu arasındaki iletişimde MitM gerçekleştirmektir. Yazıcı ile olan iletişimi MitM yaparak hassas dosyalar elde edebilir veya Windows authentication gibi kimlik bilgilerini alabilirsiniz.\
Daha fazla bilgi için bakınız:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## Referanslar

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
