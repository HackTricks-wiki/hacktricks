# 5353/UDP Multicast DNS (mDNS) i DNS-SD

{{#include ../banners/hacktricks-training.md}}

## Osnovne informacije

Multicast DNS (mDNS) omogućava DNS-slično rešavanje imena i otkrivanje servisa unutar lokalne link veze bez unicast DNS servera. Koristi UDP/5353 i multicast adrese 224.0.0.251 (IPv4) i FF02::FB (IPv6). DNS Service Discovery (DNS-SD, obično korišćen zajedno sa mDNS) pruža standardizovan način za nabrajanje i opisivanje servisa putem PTR, SRV i TXT zapisa.
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
Ključni detalji protokola koje ćete često koristiti tokom napada:
- Imena u .local zoni se rešavaju putem mDNS.
- QU (Query Unicast) bit može zahtevati unicast odgovore čak i za multicast upite.
- Implementacije bi trebalo da ignorišu pakete koji nisu poreklom sa lokalnog linka; neki stackovi ih i dalje prihvataju.
- Probing/announcing name uniqueness; mešanje ovde stvara DoS/“name squatting” uslove.

## DNS-SD model servisa

Servisi se identifikuju kao _<service>._tcp ili _<service>._udp pod .local, npr. _ipp._tcp.local (štampači), _airplay._tcp.local (AirPlay), _adb._tcp.local (Android Debug Bridge), itd. Otkrivajte tipove sa _services._dns-sd._udp.local, zatim rešavajte otkrivene instance na SRV/TXT/A/AAAA.

## Istraživanje mreže i enumeracija

- nmap target scan (direktni mDNS na hostu):
```bash
nmap -sU -p 5353 --script=dns-service-discovery <target>
```
- nmap broadcast discovery (slušajte segment i enumerišite sve DNS-SD tipove/instance):
```bash
sudo nmap --script=broadcast-dns-service-discovery
```
- avahi-browse (Linux):
```bash
# List service types
avahi-browse -bt _services._dns-sd._udp
# Browse all services and resolve to host/port
avahi-browse -art
```
- Apple dns-sd (macOS):
```bash
# Browse all HTTP services
dns-sd -B _http._tcp
# Enumerate service types
dns-sd -B _services._dns-sd._udp
# Resolve a specific instance to SRV/TXT
dns-sd -L "My Printer" _ipp._tcp local
```
- Packet capture with tshark:
```bash
# Live capture
sudo tshark -i <iface> -f "udp port 5353" -Y mdns
# Only DNS-SD service list queries
sudo tshark -i <iface> -f "udp port 5353" -Y "dns.qry.name == \"_services._dns-sd._udp.local\""
```

Tip: Neki browser-i/WebRTC koriste ephemarne mDNS hostname-ove da bi maskirali lokalne IP-ove. Ako na mreži vidite random-UUID.local kandidate, rešite ih putem mDNS da biste pivotirali na lokalne IP-ove.

## Napadi

### Ometanje provere imena mDNS (DoS / name squatting)

Tokom faze provere (probinga), host proverava jedinstvenost imena. Odgovaranjem falsifikovanim konfliktima prisiljavate ga da izabere nova imena ili da ne uspe. Ovo može odložiti ili sprečiti registraciju i otkrivanje servisa.

Example with Pholus:
```bash
# Block new devices from taking names by auto-faking responses
sudo python3 pholus3.py <iface> -afre -stimeout 1000
```
### Lažiranje servisa i impersonacija (MitM)

Lažirajte oglašene DNS-SD servise (štampači, AirPlay, HTTP, deljene datoteke) da navodite klijente da se povežu na vas. Ovo je posebno korisno za:
- Uhvatiti dokumente lažiranjem _ipp._tcp ili _printer._tcp.
- Privući klijente na HTTP/HTTPS servise da biste prikupili tokene/kolačiće ili isporučili payloads.
- Kombinovati sa NTLM relay tehnikama kada se Windows klijenti pregovaraju oko autentifikacije prema lažiranim servisima.

Sa bettercap-ovim zerogod modulom (mDNS/DNS-SD spoofer/impersonator):
```bash
# Start mDNS/DNS-SD discovery
sudo bettercap -iface <iface> -eval "zerogod.discovery on"

# Show all services seen from a host
> zerogod.show 192.168.1.42
# Show full DNS records for a host (newer bettercap)
> zerogod.show-full 192.168.1.42

# Impersonate all services of a target host automatically
> zerogod.impersonate 192.168.1.42

# Save IPP print jobs to disk while impersonating a printer
> set zerogod.ipp.save_path ~/.bettercap/zerogod/documents/
> zerogod.impersonate 192.168.1.42

# Replay previously captured services
> zerogod.save 192.168.1.42 target.yml
> zerogod.advertise target.yml
```
Also see generic LLMNR/NBNS/mDNS/WPAD spoofing and credential capture/relay workflows:

{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

### Napomene o nedavnim problemima implementacije (korisno za DoS/persistenciju tokom angažmana)

- Avahi reachable-assertion and D-Bus crash bugs (2023) mogu da terminiraju avahi-daemon na Linux distribucijama (npr. CVE-2023-38469..38473, CVE-2023-1981), ometajući otkrivanje servisa na ciljnim hostovima dok se ne restartuje.
- Cisco IOS XE Wireless LAN Controller mDNS gateway DoS (CVE-2024-20303) omogućava susednim WLAN klijentima da preplave kreiranim mDNS-om, opterećujući CPU WLC-a i rušeći AP tunelove — korisno ako treba da primorate klijente na roaming ili resetovanje kontrolera tokom angažmana.
- Apple mDNSResponder logic error DoS (CVE-2024-44183) omogućava sandboxovanom lokalnom procesu da sruši Bonjour i kratkotrajno potisne objavljivanje/potrošnju servisa na Apple endpoint-ima; ispravljeno u aktuelnim iOS/macOS izdanjima.
- Apple mDNSResponder correctness issue (CVE-2025-31222) dozvolio je lokalno eskaliranje privilegija putem mDNSResponder-a; korisno za persistenciju na unmanaged Mac-ovima/iPhone-ima, ispravljeno u novijim iOS/macOS ažuriranjima.

### Browser/WebRTC mDNS razmatranja

Moderni Chromium/Firefox obfuscate host candidates sa nasumičnim mDNS imenima. Možete ponovo izložiti LAN IP-ove na managed endpoint-ima tako što ćete primeniti Chrome politiku `WebRtcLocalIpsAllowedUrls` (ili prebacivanjem `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`/ekvivalent u Edge) tako da ICE izlaže host candidates umesto mDNS-a; podesite putem `HKLM\Software\Policies\Google\Chrome`.

Kada korisnici ručno onemoguće zaštitu (često u WebRTC troubleshooting vodičima), njihovi browseri ponovo počinju da reklamiraju obične host candidates, koje možete uhvatiti preko mDNS-a ili ICE signaling-a da ubrzate otkrivanje hostova.

## Odbrambena razmatranja i OPSEC

- Granice segmenata: Ne rutirajte 224.0.0.251/FF02::FB između sigurnosnih zona osim ako mDNS gateway nije eksplicitno potreban. Ako morate premostiti otkrivanje, preferirajte allowlists i rate limits.
- Windows endpoints/servers:
- Da trajno onemogućite rešavanje imena preko mDNS postavite vrednost u registru i restartujte:
```
HKLM\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters\EnableMDNS = 0 (DWORD)
```
- U upravljanim okruženjima, onemogućite ugrađeno “mDNS (UDP-In)” Windows Defender Firewall pravilo (bar na Domain profilu) da biste sprečili inbound mDNS procesiranje dok čuvate home/roaming funkcionalnost.
- Na novijim Windows 11 build-ovima/GPO template-ima, koristite politiku “Computer Configuration > Administrative Templates > Network > DNS Client > Configure multicast DNS (mDNS) protocol” i podesite je na Disabled.
- Linux (Avahi):
- Ograničite publikovanje kada nije potrebno: podesite `disable-publishing=yes`, i restriktujte interfejse sa `allow-interfaces=` / `deny-interfaces=` u `/etc/avahi/avahi-daemon.conf`.
- Razmotrite `check-response-ttl=yes` i izbegavajte `enable-reflector=yes` osim ako nije strogo neophodno; preferirajte `reflect-filters=` allowlists kada reflektujete.
- macOS: Ograničite inbound mDNS na host/network firewall-ovima kada Bonjour otkrivanje nije potrebno za određene podmreže.
- Monitoring: Upozorite na neobične skokove u `_services._dns-sd._udp.local` upitima ili nagle promene u SRV/TXT kritičnih servisa; ovo su indikatori spoofing-a ili impersonacije servisa.

## Brz pregled alata

- nmap NSE: `dns-service-discovery` i `broadcast-dns-service-discovery`.
- Pholus: active scan, reverse mDNS sweeps, DoS and spoofing helpers.
```bash
# Passive sniff (timeout seconds)
sudo python3 pholus3.py <iface> -stimeout 60
# Enumerate service types
sudo python3 pholus3.py <iface> -sscan
# Send generic mDNS requests
sudo python3 pholus3.py <iface> --request
# Reverse mDNS sweep of a subnet
sudo python3 pholus3.py <iface> -rdns_scanning 192.168.2.0/24
```
- bettercap zerogod: discover, save, advertise, and impersonate mDNS/DNS-SD services (see examples above).

## Spoofing/MitM

Najzanimljiviji napad koji možete izvesti preko ovog servisa je MitM u komunikaciji između klijenta i stvarnog servera. Možda ćete moći da dobijete osetljive fajlove (MitM komunikaciju sa printerom) ili čak kredencijale (Windows authentication).\
Za više informacija pogledajte:


{{#ref}}
../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## References

- [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical_IoT_Hacking.html?id=GbYEEAAAQBAJ&redir_esc=y)
- [Nmap NSE: broadcast-dns-service-discovery](https://nmap.org/nsedoc/scripts/broadcast-dns-service-discovery.html)
- [bettercap zerogod (mDNS/DNS-SD discovery, spoofing, impersonation)](https://www.bettercap.org/modules/ethernet/zerogod/)
- [Cisco IOS XE WLC mDNS gateway DoS (CVE-2024-20303) advisory](https://www.cisco.com/c/en/us/support/docs/csa/cisco-sa-wlc-mdns-dos-4hv6pBGf.html)
- [Rapid7 advisory for Apple mDNSResponder CVE-2024-44183](https://www.rapid7.com/db/vulnerabilities/apple-mdnsresponder-cve-2024-44183/)
- [Rapid7 writeup of Apple mDNSResponder CVE-2025-31222](https://www.rapid7.com/db/vulnerabilities/apple-osx-mdnsresponder-cve-2025-31222/)

{{#include ../banners/hacktricks-training.md}}
