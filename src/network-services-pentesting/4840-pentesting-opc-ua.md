# 4840 - Pentesting OPC UA

{{#include ../banners/hacktricks-training.md}}


## Temel Bilgiler

**OPC UA**, açılımı **Open Platform Communications Unified Access** olan, veri alışverişi ve ekipman kontrolü için İmalat, Enerji, Havacılık ve Savunma gibi çeşitli endüstrilerde kullanılan kritik bir açık kaynak protokoldür. Özellikle PLC'lerle olmak üzere farklı üreticilerin ekipmanlarının birbirleriyle iletişim kurmasını sağlar.

Yapılandırması güçlü güvenlik önlemlerine izin verir, fakat genellikle eski cihazlarla uyumluluk için bu önlemler azaltılır ve sistemleri risklere karşı açık hale getirir. Ayrıca, OPC UA servislerini bulmak zor olabilir; ağ tarayıcıları bunları standart dışı portlarda çalışıyorsa tespit etmeyebilir.

**Default port:** 4840 (binary `opc.tcp`). Birçok vendor ayrı discovery endpoint'leri (`/discovery`), HTTPS binding'leri (4843/443) veya vendor-özel listener portları such as 49320 (KepServerEX), 62541 (OPC Foundation reference stack) and 48050 (UaGateway) açar. Her host için birden fazla endpoint bekleyin; her biri taşıma profili, güvenlik politikası ve kullanıcı-token desteğini duyurur.

| Yerleşik NodeId | Neden önemli |
| --- | --- |
| `i=2253` (`0:Server`) | `ServerArray`, vendor/product string'leri ve namespace URI'lerini barındırır.
| `i=2256` (`ServerStatus`) | Çalışma süresini (uptime), mevcut durumu ve isteğe bağlı olarak build bilgilerini ortaya çıkarır.
| `i=2267` (`ServerDiagnosticsSummary`) | Oturum sayılarını, abort edilmiş istekleri vb. gösterir. Brute-force denemelerini fingerprint'lemek için çok uygundur.
| `i=85` (`ObjectsFolder`) | Açığa çıkmış cihaz tag'lerini, metotlarını ve alarmlarını dolaşmak için giriş noktası.
```text
PORT     STATE SERVICE REASON
4840/tcp open  unknown syn-ack
```
## Pentesting OPC UA

OPC UA sunucularındaki güvenlik sorunlarını ortaya çıkarmak için [OpalOPC](https://opalopc.com/) ile scan yapın.
```bash
opalopc -vv opc.tcp://$target_ip_or_hostname:$target_port
```
### Keşif ve Enumerasyon Rehberi

1. **Tüm OPC UA taşıma kanallarını bulun**
```bash
nmap -sV -Pn -n --open -p 4840,4843,49320,48050,53530,62541 $TARGET
```
Ortam LDS-ME multicast discovery kullanıyorsa UDP grup adreslerinde tekrarlayın.

2. **Uç noktaların parmak izini çıkarın**
- Her transport üzerinden `FindServers`/`GetEndpoints` çağırarak `SecurityPolicyUri`, `SecurityMode`, `UserTokenType`, uygulama URI'sı ve ürün dizelerini yakalayın.
- Vendor-özel NodeId'leri çözebilmek için namespace'leri listeleyin; namespace çakışmalarını suistimal ederek istemcileri saldırgan kontrollü şemaları yüklemeye zorlayın.

3. **Adres uzayında gezin**
- `ObjectsFolder (i=85)`'den başlayın ve yazılabilir process değişkenlerini, `Method` düğümlerini ve tarihçe/kayıt (historian/log) düğümlerini bulmak için özyinelemeli olarak `Browse`/`Read` yapın.
- Firmware kökenini anlamak için `ServerStatus.BuildInfo`'yu, sunucu kaynaklarını tüketmenin ne kadar kolay olduğunu ölçmek için `ServerCapabilities.OperationLimits`'i sorgulayın.
- Eğer anonim erişime izin veriliyorsa, bakım yöntemlerinde (örn. `ns=2;s=Reset`, `ns=2;s=StartMotor`) hemen `Call` test edin. Birçok tedarikçi özel metodlara rol izinlerini bağlamayı unutuyor.

4. **Oturum suiistimali**
- MITM veya diagnostiklerin açığa çıkmasıyla yakalanmış diğer oturumlardan `AuthenticationToken` değerlerini yeniden kullanın veya klonlayın; mevcut abonelikleri ele geçirin.
- Onlarca pasif oturum oluşturarak sunucuyu `SessionDiagnostics` flooding'e zorlayın; bazı stack'ler `MaxSessionCount` limiti aşıldığında çöker.

### OpalOPC ile Otomatik Değerlendirme

- Tarayıcı etkileşimli veya headless çalışabilir; CI/CD tarzı OT değerlendirmeleri için kullanışlıdır. Makine-okunur bulgularını raporlama hattınıza aktarıp anonim girişler, zayıf politikalar, sertifika doğrulama hataları ve yazılabilir değişkenleri dakikalar içinde vurgulayın.
- OpalOPC çıktısını manuel tarama ile birleştirin: keşfedilen uç nokta listesini özel araçlarınıza geri besleyin, sonra yüksek etkili düğümleri (örn. `MotorControl/StartStop`, `RecipeManager/Upload`) seçici olarak kötüye kullanın.

### Eski güvenlik politikalarına saldırı (Basic128Rsa15)

- **Bleichenbacher-style oracle:** Hâlâ deprecated `Basic128Rsa15` politikasına izin veren sistemler (genellikle `CMPOPCUASTACK_ALLOW_SHA1_BASED_SECURITY` gibi build flag'leriyle ayarlanmış) padding doğrulama farklarını leak eder. Bunu exploit etmek için crafted PKCS#1 v1.5 blob'larıyla `CreateSession` / `OpenSecureChannel` el sıkışmalarını flood ederek sunucu sertifikasının özel anahtarını geri kazanın; sonra sunucu kimliğine bürün veya trafiği decrypt edin.
- **Authentication bypass:** OPC Foundation’ın .NET Standard stack'i 1.5.374.158 öncesinde (CVE-2024-42512) ve ona bağımlı ürünler, kimlik doğrulanmamış saldırganların o eski politikayı zorlamasına ve uygulama seviyesinde kimlik doğrulamayı atlamasına izin veriyordu. Anahtar materyalini ele geçirdikten sonra rastgele `UserIdentityTokens` sunabilir, imzalı `ActivateSession` isteklerini replay edebilir ve tesisi güvenilir bir mühendislik iş istasyonu gibi kullanabilirsiniz.
- **Operasyonel iş akışı:**
1. `GetEndpoints` ile politikaları listeleyin ve herhangi bir `Basic128Rsa15` kaydını not edin.
2. Bu politikayı açıkça müzakere edin (`CreateSession` içindeki `SecurityPolicyUri`), ardından geri alınan anahtar doğrulanana kadar oracle döngünüzü çalıştırın.
3. Anahtarı yüksek ayrıcalıklı bir oturum taklit etmek, rolleri değiştirmek veya kötü niyetli bir reverse proxy gibi davranarak diğer istemcileri sessizce downgrade etmek için suistimal edin.
- OPC Foundation aynı zamanda HTTPS binding'leri için CVE-2024-42513 yayımladı. Hedefiniz TLS iddia etse bile proxy arkasındaki binary transport için sessizce Basic128Rsa15'e geri dönmediğinden emin olun.

### Sömürme için OPC UA istemcileri oluşturma

- **Özel istemciler:** Drop-in kütüphaneler (python-opcua/asyncua, node-opcua, open62541) exploit mantığını kendiniz yazmanıza izin verir. Tedarikçiler firmware güncellemelerinden sonra namespace'leri yeniden sıraladığında istemeden çapraz-namespace yazmaları önlemek için her zaman hedef namespace indeksinizi zorunlu kılın.
- **Node kötüye kullanım kontrol listesi:**
- `HistoryRead` ile üretim etiketlerinde tescilli tariflerin anlık görüntüsünü alın.
- `TranslateBrowsePathsToNodeIds` ile insan tarafından okunabilir varlık isimlerini Claroty’nin çerçevesi gibi araçlara verilebilecek NodeId'lere çözün.
- `Call` + `Method` düğümlerini kullanarak bakım görevlerini tetikleyin (firmware yükleme, kalibrasyon, cihaz yeniden başlatmaları).
- `RegisterNodes`'un kötüye kullanımıyla sık erişilen düğümleri pinleyip tutamaçları hiç serbest bırakmayarak meşru istemcileri mağdur edin.
- **Oturum sertleştirme testleri:** Son derece düşük yayınlama aralıkları (50 ms altı) ve aşırı büyük monitored-item kuyrukları ile onlarca aboneliği bağlamayı deneyin. Birçok stack `RevisedPublishingInterval`'ı yanlış hesaplar ve zamanlayıcı taşmaları nedeniyle çöker.

### Fuzzing ve exploit geliştirme araçları

Claroty Team82 yılların Pwn2Own-seviyesindeki araştırmasını yeniden kullanılabilir modüllere paketleyen açık-kaynak `opcua-exploit-framework`'ü yayımladı:

- **Modlar:** `sanity` (hafif okumalar/taramalar), `attacks` (örn. thread pool starvation, file upload DoS), `corpus` (replay fuzzing payload'ları), `server` (istemcilere backdoor koymak için rogue OPC UA server).
- **Kullanım örneği:**
```bash
# Run a DoS attack against a Prosys Simulation Server endpoint
python3 main.py prosys 10.10.10.10 53530 /OPCUA/SimulationServer thread_pool_wait_starvation

# Replay an entire Boofuzz corpus against open62541
python3 main.py open62541 192.168.1.50 4840 / opcua_message_boofuzz_db input_corpus_minimized/opcua.db
```
- **Rogue server senaryosu:** Paketlenmiş asyncua tabanlı server, kötü niyetli adres uzayları sunarak istemci yazılımlarını hedeflemenize izin verir (örneğin, UA Expert klonlarında parsing hatalarını tetiklemek için aşırı büyük `ExtensionObject` cevapları).
- **Hedef kapsamı:** Dahili profiller Kepware, Ignition, Unified Automation, Softing SIS, Triangle Microworks, Node-OPCUA, Python OPC UA, Milo, open62541 vb. ile eşlenmiştir; böylece payload'ları yeniden yazmadan hızlıca stack'ler arasında geçiş yapabilirsiniz.
- **Entegrasyon ipuçları:** Çıktısını kendi fuzzer'larınızla zincirleyin—önce `corpus` payload'larını dağıtın, sonra OpalOPC'nin çöküşün güvensiz varsayılanları (anonim giriş, setpoint yazma erişimi, vb.) yeniden canlandırıp canlandırmadığını yeniden doğrulamasını sağlayın.

### Kimlik doğrulama atlatmalarını sömürme

Eğer kimlik doğrulama atlatma zaafiyetleri bulunursa, buna göre bir [OPC UA client](https://www.prosysopc.com/products/opc-ua-browser/) yapılandırabilir ve nereye erişebileceğinizi görebilirsiniz. Bu, yalnızca proses değerlerini okumaktan ağır sanayi ekipmanlarını çalıştırmaya kadar her şeyi mümkün kılabilir.

Eriştiğiniz cihaz hakkında ipucu edinmek için adres uzayındaki "ServerStatus" node değerlerini okuyun ve kullanım kılavuzu için google'da arama yapın.

## Shodan

- `port:4840`
- `port:62541 "OPC UA"`
- `ssl:"urn:opcua"`
- `product:"opc ua"`

Aramayı vendor dizeleri (`"Ignition OPC UA"`, `"KepServerEX"`) veya sertifikalar (`"CN=UaServerCert"`) ile birleştirerek müdahaleci testlere başlamadan önce yüksek değerli varlıkları önceliklendirin.

## Referanslar

- [https://opalopc.com/how-to-hack-opc-ua/](https://opalopc.com/how-to-hack-opc-ua/)
- [https://github.com/claroty/opcua-exploit-framework](https://github.com/claroty/opcua-exploit-framework)
- [https://certvde.com/en/advisories/VDE-2025-022/](https://certvde.com/en/advisories/VDE-2025-022/)


{{#include ../banners/hacktricks-training.md}}
