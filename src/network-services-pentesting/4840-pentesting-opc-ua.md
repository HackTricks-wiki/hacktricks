# 4840 - Pentesting OPC UA

{{#include ../banners/hacktricks-training.md}}


## Basiese Inligting

**OPC UA**, wat staan vir **Open Platform Communications Unified Access**, is 'n belangrike open-source-protokol wat in verskeie nywerhede soos Vervaardiging, Energie, Lugvaart en Verdediging gebruik word vir data-uitruil en toerustingbeheer. Dit maak dit moontlik dat toerusting van verskillende verskaffers met mekaar kan kommunikeer, veral met PLCs.

Die konfigurasie daarvan laat toe vir sterk sekuriteitsmaatreëls, maar dikwels word hierdie maatreëls verslap vir versoenbaarheid met ouer toestelle, wat stelsels aan risiko's blootstel. Verder kan dit moeilik wees om OPC UA-dienste te vind aangesien netwerkskandeerders hulle dalk nie opspoor as hulle op nie-standaard poorte is nie.

**Default port:** 4840 (binary `opc.tcp`). Baie verskaffers openbaar afsonderlike discovery endpoints (`/discovery`), HTTPS bindings (4843/443), of verskaffer-spesifieke luisterpoorte soos 49320 (KepServerEX), 62541 (OPC Foundation reference stack) en 48050 (UaGateway). Verwacht meerdere endpoints per gasheer, elk wat transportprofiel, sekuriteitsbeleid en user-token ondersteuning adverteer.

| Ingeboude NodeId | Waarom dit saak maak |
| --- | --- |
| `i=2253` (`0:Server`) | Bevat `ServerArray`, vendor/product strings en namespace URIs.
| `i=2256` (`ServerStatus`) | Gee die optyd, huidige toestand, en opsioneel bou-inligting.
| `i=2267` (`ServerDiagnosticsSummary`) | Wys sessie-aantalle, afgebreekte versoeke, ens. Great for fingerprinting brute-force attempts.
| `i=85` (`ObjectsFolder`) | Ingangspunt om deur blootgestelde toestel-tags, metodes en alarms te deurloop.
```text
PORT     STATE SERVICE REASON
4840/tcp open  unknown syn-ack
```
## Pentesting OPC UA

Om sekuriteitsprobleme in OPC UA-bedieners te openbaar, scan dit met [OpalOPC](https://opalopc.com/).
```bash
opalopc -vv opc.tcp://$target_ip_or_hostname:$target_port
```
### Ontdekking & Enumerasie Speelboek

1. **Vind al die OPC UA-transporte**
```bash
nmap -sV -Pn -n --open -p 4840,4843,49320,48050,53530,62541 $TARGET
```
Herhaal op UDP-groepadresse as die omgewing LDS-ME multicast-ontdekking gebruik.

2. **Vingerafdruk van eindpunte**
- Roep `FindServers`/`GetEndpoints` oor elke transport aan om `SecurityPolicyUri`, `SecurityMode`, `UserTokenType`, application URI en produktstringe vas te vang.
- Enumereer namespaces sodat jy vendor-spesifieke NodeIds kan oplos; misbruik namespace-botsings om kliënte te dwing om aanvaller-beheerde skemas te laai.

3. **Deursoek die adresruimte**
- Begin by `ObjectsFolder (i=85)` en gebruik rekursiewe `Browse`/`Read` om skryfbare prosesvariabeles, `Method` nodes en historian/log nodes te vind.
- Navraag `ServerStatus.BuildInfo` om firmware-herkoms te verstaan, en `ServerCapabilities.OperationLimits` om te skat hoe maklik dit is om bedienerhulpbronne uit te put.
- As anonieme toegang toegelaat word, toets onmiddellik `Call` op onderhoudsmetodes (bv. `ns=2;s=Reset`, `ns=2;s=StartMotor`). Baie verskaffers vergeet om rolpermissies aan pasgemaakte metodes te koppel.

4. **Sessie-misbruik**
- Hergebruik of kloon `AuthenticationToken`-waardes van ander sessies (gevang via MITM of diagnostiese blootstelling) om bestaande subscriptions te kaap.
- Dwing die bediener in `SessionDiagnostics`-vloed deur dosyne inaktiewe sessies te skep; sommige stacks crash sodra die `MaxSessionCount`-limiet oorskry is.

### Geautomatiseerde assessering met OpalOPC

- Die scanner kan interaktief of headless loop, wat handig is vir CI/CD-styl OT-baselines. Pipe sy machine-readable bevindinge in jou rapporteringspyplyn om anonieme aanmeldings, swak beleid, sertifikaat-validasie foute en skryfbare veranderlikes binne minute uit te lig.
- Kombineer OpalOPC-uitsette met handmatige browsing: voed die ontdekte eindpuntlys terug in jou eie tooling, en benut dan selektief nodes met groot impak (bv. `MotorControl/StartStop`, `RecipeManager/Upload`).

### Aanval op verouderde sekuriteitsbeleide (Basic128Rsa15)

- **Bleichenbacher-style oracle:** Sisteme wat steeds die verouderde `Basic128Rsa15` policy toelaat (dikwels geskakel via build flags soos `CMPOPCUASTACK_ALLOW_SHA1_BASED_SECURITY`) leak verskille in padding-validasie. Benut dit deur `CreateSession` / `OpenSecureChannel` handshakes te oorlaai met vervaardigde PKCS#1 v1.5 blobs om die bedienersertifikaat se private sleutel te herwin, en dan die bediener te imiteer of verkeer te ontsleutel.
- **Authentication bypass:** OPC Foundation’s .NET Standard stack voor 1.5.374.158 (CVE-2024-42512) en afhanklike produkte laat ongeauthentiseerde aanvallers toe om daardie legacy-policy af te dwing en gevolglik aansoekvlak-authentisering oor te slaan. Sodra jy die sleutelmateriaal besit, kan jy arbitrêre `UserIdentityTokens` voorlê, ondertekende `ActivateSession` versoeke hervertoons, en die aanleg as 'n vertroude engineering-werkstasie bedryf.
- **Operationele workflow:**
1. Enumereer beleide met `GetEndpoints` en merk enige `Basic128Rsa15` inskrywings.
2. Onderhandel daardie beleid eksplisiet (`SecurityPolicyUri` in `CreateSession`), en laat jou oracle-lus loop tot die herwonne sleutel valideer.
3. Misbruik die sleutel om 'n hoë-privilegie sessie te vervals, rolle te wissel, of stilweg ander kliënte af te gradeer deur as 'n sogenaamde rogue reverse proxy op te tree.
- OPC Foundation het gelyktydig CVE-2024-42513 vir HTTPS-bindings gepubliseer. Selfs as jou teiken TLS verklaar, maak seker dit val nie stilweg terug na Basic128Rsa15 vir die binêre transport agter die proxy nie.

### Crafting OPC UA clients for exploitation

- **Custom clients:** Drop-in libraries (python-opcua/asyncua, node-opcua, open62541) laat jou toe om exploit-logika self aan te stuur. Dwing altyd jou teiken-namespace-indeks af om toevallige cross-namespace-skrywings te vermy wanneer verskaffers namespaces herorden na firmware-opdaterings.
- **Node-misbruik kontrolelys:**
- `HistoryRead` op produksietags om eie resep-ensiklopedieë te snapshot.
- `TranslateBrowsePathsToNodeIds` om mensleesbare assetname na NodeIds op te los wat aan gadgets soos Claroty’s framework gevoer kan word.
- `Call` + `Method` nodes om onderhoudstake te aktiveer (firmware-upload, kalibrasie, toestelherlaaie).
- `RegisterNodes` misbruik om dikwels-toeganklike nodes te pen en dan legitieme kliënte uit te suig deur nooit die handvatsels vry te gee nie.
- **Sessie-verhardingstoetse:** Probeer om dosyne subskripsies te bind met buitengewoon lae publishing intervals (onder 50 ms) plus oor-grootte monitored-item queues. Baie stacks bereken `RevisedPublishingInterval` verkeerd en crash as gevolg van skeduleerder-oorvloede.

### Fuzzing & exploit development tooling

Claroty Team82 het 'n open-source `opcua-exploit-framework` vrygestel wat jare se Pwn2Own-grade navorsing in herbruikbare modules inpak:

- **Modes:** `sanity` (ligte reads/browses), `attacks` (bv. thread pool starvation, file upload DoS), `corpus` (replay fuzzing payloads), `server` (rogue OPC UA server om kliënte te backdoor).
- **Usage pattern:**
```bash
# Run a DoS attack against a Prosys Simulation Server endpoint
python3 main.py prosys 10.10.10.10 53530 /OPCUA/SimulationServer thread_pool_wait_starvation

# Replay an entire Boofuzz corpus against open62541
python3 main.py open62541 192.168.1.50 4840 / opcua_message_boofuzz_db input_corpus_minimized/opcua.db
```
- **Rogue server scenario:** Die ingeslote asyncua-gebaseerde server laat jou toe om kliënt-sagteware te teiken deur kwaadwillige adresruimtes voor te sit (bv. antwoorde met oor-grootte `ExtensionObject`s om parser-bugs in UA Expert-klone te trigger).
- **Target coverage:** Ingeboude profiele map na Kepware, Ignition, Unified Automation, Softing SIS, Triangle Microworks, Node-OPCUA, Python OPC UA, Milo, open62541, ens., sodat jy vinnig tussen stacks kan wissel sonder om payloads te her-skryf.
- **Integrasie wenke:** Koppel sy uitsette aan jou eie fuzzers—spray eers die `corpus` payloads, en laat dan OpalOPC her-verify of die crash insegure standaarde (anonieme login, setpoint write access, ens.) hervat het.

### Exploiting authentication bypasses

Indien authentication bypass-kwetsbaarhede gevind word, kan jy 'n [OPC UA client](https://www.prosysopc.com/products/opc-ua-browser/) ooreenkomstig konfigureer en sien waartoe jy toegang het. Dit kan enigiets toelaat van bloot proseswaardes lees tot werklik swaar nywerheidsuitrusting bedryf.

Om 'n idee te kry van die toestel waartoe jy toegang het, lees die "ServerStatus" node-waardes in die adresruimte en google vir 'n gebruikershandleiding.

## Shodan

- `port:4840`
- `port:62541 "OPC UA"`
- `ssl:"urn:opcua"`
- `product:"opc ua"`

Kombineer die soektog met verskafferstringe (`"Ignition OPC UA"`, `"KepServerEX"`) of sertifikate (`"CN=UaServerCert"`) om hoë-waarde assets te prioriteit voor jy indringende toetse begin.

## Verwysings

- [https://opalopc.com/how-to-hack-opc-ua/](https://opalopc.com/how-to-hack-opc-ua/)
- [https://github.com/claroty/opcua-exploit-framework](https://github.com/claroty/opcua-exploit-framework)
- [https://certvde.com/en/advisories/VDE-2025-022/](https://certvde.com/en/advisories/VDE-2025-022/)


{{#include ../banners/hacktricks-training.md}}
