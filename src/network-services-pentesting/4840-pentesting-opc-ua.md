# 4840 - Pentesting OPC UA

{{#include ../banners/hacktricks-training.md}}


## Basic Information

**OPC UA**(Open Platform Communications Unified Access의 약자)는 제조, 에너지, 항공우주 및 국방 등 다양한 산업에서 데이터 교환과 장비 제어에 사용되는 중요한 오픈 소스 프로토콜입니다. 특히 서로 다른 공급업체의 장비, 특히 PLC들 간의 통신을 가능하게 합니다.

구성상 강력한 보안 설정을 적용할 수 있지만, 구형 장치와의 호환성을 위해 종종 보안이 약화되어 시스템이 위험에 노출됩니다. 또한 OPC UA 서비스는 비표준 포트에 있을 경우 네트워크 스캐너가 탐지하지 못해 찾기 어려울 수 있습니다.

**Default port:** 4840 (binary `opc.tcp`). 많은 공급업체가 별도의 discovery 엔드포인트(`/discovery`), HTTPS 바인딩(4843/443) 또는 49320 (KepServerEX), 62541 (OPC Foundation reference stack), 48050 (UaGateway)과 같은 공급업체별 리스너 포트를 노출합니다. 각 호스트는 전송 프로필, 보안 정책 및 사용자 토큰 지원을 광고하는 여러 엔드포인트를 가질 수 있습니다.

| Built-in NodeId | Why it matters |
| --- | --- |
| `i=2253` (`0:Server`) | `ServerArray`, 공급업체/제품 문자열 및 네임스페이스 URI를 포함합니다.
| `i=2256` (`ServerStatus`) | 가동 시간, 현재 상태 및 선택적으로 빌드 정보를 공개합니다.
| `i=2267` (`ServerDiagnosticsSummary`) | 세션 수, 중단된 요청 등 을 보여줍니다. 무차별 대입(brute-force) 시도 fingerprinting에 유용합니다.
| `i=85` (`ObjectsFolder`) | 노출된 장치 태그, 메서드 및 알람을 탐색하기 위한 진입점입니다.
```text
PORT     STATE SERVICE REASON
4840/tcp open  unknown syn-ack
```
## Pentesting OPC UA

OPC UA 서버의 보안 문제를 찾으려면 [OpalOPC](https://opalopc.com/)로 스캔하세요.
```bash
opalopc -vv opc.tcp://$target_ip_or_hostname:$target_port
```
### 탐지 및 열거 플레이북

1. **모든 OPC UA 전송 찾기**
```bash
nmap -sV -Pn -n --open -p 4840,4843,49320,48050,53530,62541 $TARGET
```
환경이 LDS-ME 멀티캐스트 검색을 사용하면 UDP 그룹 주소에서도 반복 실행하세요.

2. **엔드포인트 지문 수집**
- 각 전송에서 `FindServers`/`GetEndpoints`를 호출해 `SecurityPolicyUri`, `SecurityMode`, `UserTokenType`, application URI 및 product 문자열을 캡처하세요.
- 벤더별 NodeIds를 해석할 수 있도록 namespace를 열거하고, namespace 충돌을 악용해 클라이언트가 공격자가 제어하는 스키마를 로드하도록 유도하세요.

3. **주소 공간 탐색**
- `ObjectsFolder (i=85)`에서 시작해 재귀적으로 `Browse`/`Read`를 실행하여 쓰기 가능한 프로세스 변수, `Method` 노드 및 historian/log 노드를 찾으세요.
- 펌웨어 출처를 파악하기 위해 `ServerStatus.BuildInfo`를 조회하고, 서버 리소스를 쉽게 고갈시킬 수 있는지 평가하려면 `ServerCapabilities.OperationLimits`를 확인하세요.
- 익명 액세스가 허용되면 즉시 유지보수 메서드에 대해 `Call`을 테스트하세요(예: `ns=2;s=Reset`, `ns=2;s=StartMotor`). 많은 벤더가 커스텀 메서드에 역할 권한을 바인딩하는 것을 잊습니다.

4. **세션 악용**
- 다른 세션에서 재사용하거나 복제한 `AuthenticationToken` 값을 사용(MITM 또는 진단 정보 노출로 획득)해 기존 구독을 탈취하세요.
- 수십 개의 비활성 세션을 만들어 서버를 `SessionDiagnostics` 플러딩 상태로 몰아넣으세요; 일부 스택은 `MaxSessionCount` 한도를 초과하면 충돌합니다.

### Automated assessment with OpalOPC

- 스캐너는 대화형 또는 헤드리스로 실행할 수 있어 CI/CD 스타일 OT 기준을 자동화하는 데 유용합니다. 기계 판독 가능한 결과를 리포팅 파이프라인으로 전달하면 익명 로그인, 약한 정책, 인증서 검증 오류 및 쓰기 가능한 변수들을 몇 분 안에 강조할 수 있습니다.
- OpalOPC 출력과 수동 브라우징을 결합하세요: 발견된 엔드포인트 목록을 커스텀 툴에 다시 투입한 다음, 영향도가 큰 노드(예: `MotorControl/StartStop`, `RecipeManager/Upload`)를 선택적으로 무기화하세요.

### Attacking legacy security policies (Basic128Rsa15)

- **Bleichenbacher-style oracle:** 아직 구식 `Basic128Rsa15` 정책을 허용하는 시스템(종종 `CMPOPCUASTACK_ALLOW_SHA1_BASED_SECURITY` 같은 빌드 플래그로 토글됨)은 패딩 검증 차이를 누출합니다. 조작된 PKCS#1 v1.5 블랍으로 `CreateSession` / `OpenSecureChannel` 핸드셰이크를 대량으로 보내 이 오라클을 통해 서버 인증서의 개인 키를 회복한 뒤 서버를 가장하거나 트래픽을 복호화하세요.
- **Authentication bypass:** OPC Foundation의 .NET Standard 스택(버전 1.5.374.158 이전) 및 이와 연동된 제품들은 비인증 공격자가 해당 레거시 정책을 강제로 사용하도록 하고 결과적으로 애플리케이션 수준 인증을 우회하게 합니다(CVE-2024-42512). 키 소재를 획득하면 임의의 `UserIdentityTokens`를 제시하거나 서명된 `ActivateSession` 요청을 재생해 플랜트를 신뢰된 엔지니어링 워크스테이션으로서 조작할 수 있습니다.
- **운영 워크플로우:**
1. `GetEndpoints`로 정책을 열거하고 `Basic128Rsa15` 항목을 확인하세요.
2. `CreateSession`에서 해당 정책(`SecurityPolicyUri`)을 명시적으로 협상한 뒤, 회복된 키가 검증될 때까지 오라클 루프를 실행하세요.
3. 해당 키를 악용해 높은 권한의 세션을 위조하거나 역할을 전환하거나 악성 리버스 프록시로 행동해 다른 클라이언트를 은밀히 다운그레이드하세요.
- OPC Foundation은 동시에 HTTPS 바인딩에 대해 CVE-2024-42513을 공개했습니다. 대상이 TLS를 주장하더라도 프록시 뒤의 바이너리 전송이 Basic128Rsa15로 조용히 폴백되는지 확인하세요.

### Crafting OPC UA clients for exploitation

- **Custom clients:** drop-in 라이브러리(python-opcua/asyncua, node-opcua, open62541)를 사용하면 직접 exploit 로직을 구동할 수 있습니다. 벤더가 펌웨어 업데이트 후 namespace 순서를 변경할 수 있으니 대상 namespace 인덱스를 항상 강제하여 의도치 않은 크로스-네임스페이스 쓰기를 방지하세요.
- **Node abuse checklist:**
- `HistoryRead`로 프로덕션 태그의 스냅샷을 얻어 독점 레시피를 탈취하세요.
- `TranslateBrowsePathsToNodeIds`로 사람 읽기 쉬운 자산 이름을 NodeIds로 해석해 Claroty의 프레임워크 같은 도구에 제공하세요.
- `Call` + `Method` 노드로 유지보수 작업(펌웨어 업로드, 보정, 장치 재부팅)을 트리거하세요.
- `RegisterNodes`를 악용해 자주 접근되는 노드를 고정(pinning)한 뒤 핸들을 해제하지 않아 정당한 클라이언트를 고갈시키세요.
- **세션 경화 테스트:** 매우 짧은 퍼블리싱 인터벌(50 ms 이하)과 과도한 모니터된-아이템 큐를 사용해 수십 개의 구독을 바인딩해 보세요. 많은 스택이 `RevisedPublishingInterval`을 잘못 계산해 스케줄러 오버플로우로 인해 충돌합니다.

### Fuzzing & exploit development tooling

Claroty Team82는 수년간의 Pwn2Own 급 연구를 재사용 가능한 모듈로 패키징한 오픈소스 `opcua-exploit-framework`를 공개했습니다:

- **Modes:** `sanity` (경량 읽기/브라우즈), `attacks` (예: 쓰레드 풀 고갈, 파일 업로드 DoS), `corpus` (리플레이 퍼징 페이로드), `server` (클라이언트를 백도어하기 위한 rogue OPC UA 서버).
- **Usage pattern:**
```bash
# Run a DoS attack against a Prosys Simulation Server endpoint
python3 main.py prosys 10.10.10.10 53530 /OPCUA/SimulationServer thread_pool_wait_starvation

# Replay an entire Boofuzz corpus against open62541
python3 main.py open62541 192.168.1.50 4840 / opcua_message_boofuzz_db input_corpus_minimized/opcua.db
```
- **Rogue server scenario:** 번들된 asyncua 기반 서버는 공격자가 악성 주소 공간을 제공해 클라이언트 소프트웨어를 표적으로 삼을 수 있게 합니다(예: UA Expert 클론의 파싱 버그를 유발하는 과도한 크기의 `ExtensionObject`를 응답으로 제공).
- **Target coverage:** 내장 프로파일은 Kepware, Ignition, Unified Automation, Softing SIS, Triangle Microworks, Node-OPCUA, Python OPC UA, Milo, open62541 등과 매핑되어 있어 페이로드를 다시 작성하지 않고도 스택 간 전환이 가능합니다.
- **통합 팁:** 출력물을 자체 퍼저와 연결하세요—먼저 `corpus` 페이로드를 스프레이한 다음 OpalOPC로 충돌이 insecure한 기본값(익명 로그인, 세트포인트 쓰기 접근 등)을 다시 생성했는지 재검증하세요.

### Exploiting authentication bypasses

인증 우회 취약점이 발견되면 [OPC UA client](https://www.prosysopc.com/products/opc-ua-browser/)를 적절히 구성해 접근 가능한 항목을 확인하세요. 이는 단순히 프로세스 값을 읽는 것부터 중장비 산업 장비를 실제로 조작하는 것까지 허용할 수 있습니다.

접근 가능한 장치의 단서를 얻으려면 주소 공간에서 "ServerStatus" 노드 값을 읽고 해당 장비의 사용 설명서를 검색하세요.

## Shodan

- `port:4840`
- `port:62541 "OPC UA"`
- `ssl:"urn:opcua"`
- `product:"opc ua"`

검색을 벤더 문자열(`"Ignition OPC UA"`, `"KepServerEX"`)이나 인증서(`"CN=UaServerCert"`)와 결합해 침투 테스트를 시작하기 전에 가치 높은 자산을 우선순위로 지정하세요.

## References

- [https://opalopc.com/how-to-hack-opc-ua/](https://opalopc.com/how-to-hack-opc-ua/)
- [https://github.com/claroty/opcua-exploit-framework](https://github.com/claroty/opcua-exploit-framework)
- [https://certvde.com/en/advisories/VDE-2025-022/](https://certvde.com/en/advisories/VDE-2025-022/)


{{#include ../banners/hacktricks-training.md}}
