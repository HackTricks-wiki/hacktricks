# 4840 - Pentesting OPC UA

{{#include ../banners/hacktricks-training.md}}


## Taarifa za Msingi

**OPC UA**, inayomaanisha **Open Platform Communications Unified Access**, ni itifaki muhimu ya open-source inayotumika katika sekta mbalimbali kama Manufacturing, Energy, Aerospace, na Defence kwa kubadilishana data na udhibiti wa vifaa. Inawezesha kwa njia ya kipekee vifaa vya watengenezaji tofauti kuwasiliana, hasa na PLCs.

Mpangilio wake unaruhusu hatua madhubuti za usalama, lakini mara nyingi, kwa ajili ya ulinganifu na vifaa vya zamani, hatua hizi hupunguzwa, zikifichua mifumo kwa hatari. Zaidi ya hayo, kutafuta huduma za OPC UA kunaweza kuwa changamoto kwa kuwa skana za mtandao huenda zisizitambue ikiwa ziko kwenye ports zisizo za kawaida.

**Default port:** 4840 (binary `opc.tcp`). Wauzaji wengi huweka endpoints za discovery tofauti (`/discovery`), HTTPS bindings (4843/443), au vendor-specific listener ports such as 49320 (KepServerEX), 62541 (OPC Foundation reference stack) and 48050 (UaGateway). Tarajia multiple endpoints kwa kila host, kila moja ikitangaza transport profile, security policy na user-token support.

| Built-in NodeId | Kwa nini ni muhimu |
| --- | --- |
| `i=2253` (`0:Server`) | Inaweka `ServerArray`, vendor/product strings and namespace URIs. |
| `i=2256` (`ServerStatus`) | Inaonyesha muda wa kuendelea kufanya kazi, hali ya sasa, na kwa hiari taarifa za kujenga. |
| `i=2267` (`ServerDiagnosticsSummary`) | Inaonyesha idadi za sessions, aborted requests, n.k. Nzuri kwa fingerprinting ya jaribio za brute-force. |
| `i=85` (`ObjectsFolder`) | Njia ya kuingia kutembea kupitia device tags, methods na alarms zilizofichuliwa. |
```text
PORT     STATE SERVICE REASON
4840/tcp open  unknown syn-ack
```
## Pentesting OPC UA

Ili kufichua masuala ya usalama katika seva za OPC UA, scan kwa kutumia [OpalOPC](https://opalopc.com/).
```bash
opalopc -vv opc.tcp://$target_ip_or_hostname:$target_port
```
### Mwongozo wa Ugundaji na Uorodheshaji

1. **Pata usafirishaji yote ya OPC UA**
```bash
nmap -sV -Pn -n --open -p 4840,4843,49320,48050,53530,62541 $TARGET
```
Rudia kwenye anwani za kikundi za UDP ikiwa mazingira yanatumia LDS-ME multicast discovery.

2. **Tambua sifa za endpoints**
- Tumia `FindServers`/`GetEndpoints` kupitia kila transport ili kunasa `SecurityPolicyUri`, `SecurityMode`, `UserTokenType`, application URI na product strings.
- Orodhesha namespaces ili uweze kutatua NodeIds maalum za wauzaji; tumia migongano ya namespace kuwashawishi wateja wapakie skema zinazodhibitiwa na mshambuliaji.

3. **Pitia address space**
- Anza kutoka `ObjectsFolder (i=85)` na kwa urudufu `Browse`/`Read` ili kupata variables za mchakato zinazoweza kuandikwa, node za `Method` na node za historian/log.
- Uliza `ServerStatus.BuildInfo` kuelewa asili ya firmware, na `ServerCapabilities.OperationLimits` kutathmini jinsi ilivyo rahisi kuchosha rasilimali za server.
- Ikiwa ufikiaji wa anonymous unawezekana, jaribu mara moja `Call` kwenye methods za matengenezo (mfano, `ns=2;s=Reset`, `ns=2;s=StartMotor`). Wauzaji wengi husahau kufunga ruhusa za role kwa methods maalum.

4. **Matumizi mabaya ya Session**
- Reuse au clone thamani za `AuthenticationToken` kutoka kwenye sessions nyingine (zilizoonekana kupitia MITM au exposure ya diagnostics) ili kuiba subscriptions zilizopo.
- Force server kwenye flooding ya `SessionDiagnostics` kwa kuunda mamia ya sessions zisizofanya kazi; baadhi ya stacks zinashindwa mara tu kikomo cha `MaxSessionCount` kinapozidiwa.

### Tathmini ya kiotomatiki na OpalOPC

- Scanner inaweza kuendesha kwa njia ya interactive au headless, jambo linalofaa kwa CI/CD style OT baselines. Pipa matokeo yake yanayosomwa na mashine katika pipeline yako ya kuripoti ili kuonyesha anonymous logins, sera dhaifu, makosa ya uthibitishaji wa certificate na variables zinazoweza kuandikwa ndani ya dakika.
- Changanya output ya OpalOPC na browsing ya mkono: rudisha orodha ya endpoints zilizogunduliwa kwenye zana zako za custom, kisha chagua kwa makusudi ku-weaponize nodes zenye mwelekeo mkubwa (mfano, `MotorControl/StartStop`, `RecipeManager/Upload`).

### Kushambulia sera za usalama za zamani (Basic128Rsa15)

- **Bleichenbacher-style oracle:** Systems ambazo bado zinaweza sera iliyokataliwa ya `Basic128Rsa15` (mara nyingi imezimishwa/ianzishwa kupitia build flags kama `CMPOPCUASTACK_ALLOW_SHA1_BASED_SECURITY`) leak differences za validation ya padding. Tumia hili kwa kufyeka handshakes za `CreateSession` / `OpenSecureChannel` na blobs za PKCS#1 v1.5 zilizotengenezwa ili kurejesha private key ya certificate ya server, kisha jitumie kama server au dekripti trafiki.
- **Authentication bypass:** OPC Foundation’s .NET Standard stack kabla ya 1.5.374.158 (CVE-2024-42512) na bidhaa zinazoegemea zilimruhusu mshambuliaji asiyetambulika kulazimisha sera ya zamani kisha kupuuza uthibitishaji wa ngazi ya application. Mara unapomiliki key material unaweza kuwasilisha `UserIdentityTokens` zozote, kureplay signed `ActivateSession` requests, na kuendesha plant kama engineering workstation yenye kuaminika.
- **Mtiririko wa uendeshaji:**
1. Orodhesha policies kwa kutumia `GetEndpoints` na chukua kumbukumbu ya entries za `Basic128Rsa15`.
2. Negotiate sera hiyo kwa uwazi (`SecurityPolicyUri` katika `CreateSession`), kisha endesha loop ya oracle hadi key iliyorejeshwa iangkaliwe.
3. Tumia key hiyo kuunda session yenye ruhusa kubwa, badilisha roles, au kupunguza kimya wateja wengine kwa kujiendesha kama rogue reverse proxy.
- OPC Foundation pia ilichapisha CVE-2024-42513 kwa HTTPS bindings. Hata kama lengo lako linadai TLS, hakikisha haliturudi kimya kimya kwa Basic128Rsa15 kwa transport ya binary nyuma ya proxy.

### Kutengeneza wateja wa OPC UA kwa ajili ya mashambulizi

- **Custom clients:** Drop-in libraries (python-opcua/asyncua, node-opcua, open62541) zinakuwezesha kuendesha logic ya exploit yenyewe. Daima ulaze index ya namespace ya lengo lako ili kuepuka kuandika kwa makosa across-namespace wakati wauzaji wanaporudisha namespaces baada ya updates za firmware.
- **Orodha ya matumizi mabaya ya Node:**
- `HistoryRead` kwenye tags za uzalishaji kuchukua snapshot za mapishi ya kimaandishi.
- `TranslateBrowsePathsToNodeIds` kutatua majina ya mali yanayosomwa na binadamu kuwa NodeIds ambazo zinaweza kuingizwa kwenye gadgets kama Claroty’s framework.
- `Call` + node za `Method` ili kuchochea kazi za matengenezo (upload ya firmware, calibration, reboot za kifaa).
- `RegisterNodes` matumizi mabaya ili kufunga nodes zinazotembelewa mara kwa mara kisha kunyanyua wateja halali kwa kutowarejesha handles.
- **Session hardening tests:** Jaribu kufunga mamia ya subscriptions zenye publishing intervals za chini sana (chini ya 50 ms) pamoja na queues za monitored-item zilizopindukia ukubwa. Stacks nyingi hupotoka katika hesabu ya `RevisedPublishingInterval` na kushindwa kutokana na overflow za scheduler.

### Fuzzing na zana za maendeleo ya exploit

Claroty Team82 ilitoa open-source `opcua-exploit-framework` inayopakia miaka ya utafiti wa kiwango cha Pwn2Own katika moduli zinazoweza kutumika tena:

- **Modes:** `sanity` (lightweight reads/browses), `attacks` (mfano, thread pool starvation, file upload DoS), `corpus` (replay fuzzing payloads), `server` (rogue OPC UA server ili ku-backdoor clients).
- **Usage pattern:**
```bash
# Run a DoS attack against a Prosys Simulation Server endpoint
python3 main.py prosys 10.10.10.10 53530 /OPCUA/SimulationServer thread_pool_wait_starvation

# Replay an entire Boofuzz corpus against open62541
python3 main.py open62541 192.168.1.50 4840 / opcua_message_boofuzz_db input_corpus_minimized/opcua.db
```
- **Rogue server scenario:** Server iliyojumuishwa inayotegemea asyncua inakuwezesha kulenga software ya client kwa kutoa address spaces zenye madhara (kwa mfano, majibu yenye `ExtensionObject`s zilizo kubwa kupita kiasi ili kuchochea bugs za parsing katika nakala za UA Expert).
- **Target coverage:** Profiles zilizojengwa zinaendana na Kepware, Ignition, Unified Automation, Softing SIS, Triangle Microworks, Node-OPCUA, Python OPC UA, Milo, open62541, n.k., hivyo unaweza kubadilisha haraka kati ya stacks bila kuandika upya payloads.
- **Integration tips:** Funganya output yake na fuzzers zako—piga `corpus` payloads kwanza, kisha uwe na OpalOPC ku-verify tena ikiwa crash ilirudisha defaults zisizo salama (anonymous login, setpoint write access, n.k.).

### Kutumia kuepuka kwa uthibitishaji

Ikiwa vilipuuzwa vya authentication bypass vinapatikana, unaweza kusanidi [OPC UA client](https://www.prosysopc.com/products/opc-ua-browser/) ipasavyo na kuona unachoweza kufikia. Hii inaweza kuruhusu chochote kutoka kusoma thamani za mchakato tu hadi kwa kweli kuendesha vifaa vikubwa vya viwandani.

Ili kupata dalili ya kifaa unachoweza kufikia, soma thamani za node "ServerStatus" katika address space na google kwa mwongozo wa matumizi.

## Shodan

- `port:4840`
- `port:62541 "OPC UA"`
- `ssl:"urn:opcua"`
- `product:"opc ua"`

Changanya utafutaji na strings za wauzaji (`"Ignition OPC UA"`, `"KepServerEX"`) au certificates (`"CN=UaServerCert"`) ili kuweka kipaumbele kwa assets zenye thamani kubwa kabla ya kuanza upimaji wa intrusive.

## Marejeleo

- [https://opalopc.com/how-to-hack-opc-ua/](https://opalopc.com/how-to-hack-opc-ua/)
- [https://github.com/claroty/opcua-exploit-framework](https://github.com/claroty/opcua-exploit-framework)
- [https://certvde.com/en/advisories/VDE-2025-022/](https://certvde.com/en/advisories/VDE-2025-022/)


{{#include ../banners/hacktricks-training.md}}
