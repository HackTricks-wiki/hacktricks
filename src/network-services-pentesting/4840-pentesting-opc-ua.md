# 4840 - Pentesting OPC UA

{{#include ../banners/hacktricks-training.md}}


## Osnovne informacije

**OPC UA**, što znači **Open Platform Communications Unified Access**, je ključni open-source protokol koji se koristi u različitim industrijama kao što su proizvodnja, energetika, vazduhoplovstvo i odbrana za razmenu podataka i kontrolu opreme. Omogućava komunikaciju opreme različitih proizvođača, naročito sa PLC-ovima.

Njegova konfiguracija omogućava snažne bezbednosne mere, ali često se, radi kompatibilnosti sa starijim uređajima, te mere smanjuju, izlažući sisteme rizicima. Dodatno, pronalaženje OPC UA servisa može biti nezahvalno jer network scanners možda neće otkriti servise ako su na nestandardnim portovima.

**Default port:** 4840 (binary `opc.tcp`). Mnogi vendori izlažu odvojene discovery endpoint-e (`/discovery`), HTTPS bindings (4843/443), ili vendor-specifične listener portove kao što su 49320 (KepServerEX), 62541 (OPC Foundation reference stack) i 48050 (UaGateway). Očekujte više endpoint-a po hostu, od kojih svaki oglašava transportni profil, bezbednosnu politiku i podršku za user-token.

| Built-in NodeId | Zašto je važno |
| --- | --- |
| `i=2253` (`0:Server`) | Sadrži `ServerArray`, vendor/product stringove i namespace URI-je. |
| `i=2256` (`ServerStatus`) | Otkriva vreme rada (uptime), trenutno stanje i, opciono, informacije o build-u. |
| `i=2267` (`ServerDiagnosticsSummary`) | Prikazuje broj sesija, abortirane zahteve, itd. Odlično za fingerprinting brute-force pokušaja. |
| `i=85` (`ObjectsFolder`) | Ulazna tačka za pregled izloženih uređajskih tagova, metoda i alarma. |
```text
PORT     STATE SERVICE REASON
4840/tcp open  unknown syn-ack
```
## Pentesting OPC UA

Da biste otkrili sigurnosne probleme na OPC UA serverima, skenirajte ih pomoću [OpalOPC](https://opalopc.com/).
```bash
opalopc -vv opc.tcp://$target_ip_or_hostname:$target_port
```
### Discovery & Enumeration Playbook

1. **Pronađite sve OPC UA transporte**
```bash
nmap -sV -Pn -n --open -p 4840,4843,49320,48050,53530,62541 $TARGET
```
Ponovite na UDP grupnim adresama ako okruženje koristi LDS-ME multicast discovery.

2. **Identifikujte krajnje tačke**
- Pozovite `FindServers`/`GetEndpoints` preko svakog transporta da zabeležite `SecurityPolicyUri`, `SecurityMode`, `UserTokenType`, application URI i product stringove.
- Enumerišite namespace-ove da biste razrešili vendor-specific NodeId-e; iskoristite namespace collisions da naterate klijente da učitaju schemas pod kontrolom napadača.

3. **Pređite kroz adresni prostor**
- Počnite od `ObjectsFolder (i=85)` i rekurzivno `Browse`/`Read` da pronađete writable process variables, `Method` čvorove i historian/log čvorove.
- Query-ujte `ServerStatus.BuildInfo` da shvatite poreklo firmware-a, i `ServerCapabilities.OperationLimits` da procenite koliko je lako iscrpeti server resurse.
- Ako je anonymous access dozvoljen, odmah testirajte `Call` na maintenance metodama (npr. `ns=2;s=Reset`, `ns=2;s=StartMotor`). Mnogi vendor-i zaborave da povežu role permissions sa custom metodama.

4. **Zloupotreba sesija**
- Reuse-ujte ili klonirajte `AuthenticationToken` vrednosti iz drugih sesija (uhvaćenih putem MITM-a ili izloženih dijagnostika) da preuzmete postojeće subscriptions.
- Natjerajte server u `SessionDiagnostics` flooding kreiranjem desetina neaktivnih sesija; neki stack-ovi padaju kad se pređe `MaxSessionCount` limit.

### Automated assessment with OpalOPC

- Scanner može da radi interaktivno ili headless, što je zgodno za CI/CD tip OT baseline-a. Pipe-ujte njegove machine-readable nalaze u vaš reporting pipeline da istaknete anonymous logins, weak policies, certificate validation errors i writable variables za par minuta.
- Kombinujte OpalOPC output sa manuelnim browsing-om: vratite pronađeni endpoint list nazad u svoje alate, pa selektivno weaponize-ujte high-impact čvorove (npr. `MotorControl/StartStop`, `RecipeManager/Upload`).

### Attacking legacy security policies (Basic128Rsa15)

- **Bleichenbacher-style oracle:** Sistemi koji i dalje dozvoljavaju zastarelu `Basic128Rsa15` politiku (često uključenom preko build flag-ova poput `CMPOPCUASTACK_ALLOW_SHA1_BASED_SECURITY`) leak padding validation differences. Iskoristite ovo tako što ćete preplaviti `CreateSession` / `OpenSecureChannel` handshake-ove sa crafted PKCS#1 v1.5 blob-ovima da povratite private key server sertifikata, a zatim se predstavljajte kao server ili dekriptuјte saobraćaj.
- **Authentication bypass:** OPC Foundation’s .NET Standard stack pre 1.5.374.158 (CVE-2024-42512) i proizvodi koji ga koriste dozvoljavaju unauthenticated napadačima da forsiraju tu legacy politiku i potom preskoče application-level authentication. Kad ste u posedu key material-a, možete prezentovati arbitrarne `UserIdentityTokens`, replay-ovati potpisane `ActivateSession` zahteve i upravljati postrojenjem kao trusted engineering workstation.
- **Operativni tok:**
1. Enumerišite politike sa `GetEndpoints` i zabeležite svaku `Basic128Rsa15` entry.
2. Pregovarajte tu politiku eksplicitno (`SecurityPolicyUri` u `CreateSession`), pa pokrenite svoj oracle loop dok recovered key ne prođe validaciju.
3. Iskoristite ključ da forge-ujete session sa visokim privilegijama, promenite role, ili tiho downgrade-ujete druge klijente delujući kao rogue reverse proxy.
- OPC Foundation je istovremeno objavio CVE-2024-42513 za HTTPS bindings. Čak i ako cilj tvrdi TLS, proverite da li se tiho ne fallback-uje na Basic128Rsa15 za binary transport iza proxy-ja.

### Crafting OPC UA clients for exploitation

- **Custom clients:** Drop-in biblioteke (python-opcua/asyncua, node-opcua, open62541) omogućavaju da sami implementirate exploit logiku. Uvek fiksirajte target namespace index da izbegnete slučajne cross-namespace write-ove kad vendor-i promene redosled namespace-a posle firmware update-a.
- **Node abuse checklist:**
- `HistoryRead` na production tag-ovima da snapshot-ujete proprietary recipe-e.
- `TranslateBrowsePathsToNodeIds` da razrešite human-readable asset nazive u NodeId-e koje možete proslediti gadget-ima poput Claroty-jevog framework-a.
- `Call` + `Method` čvorovi da pokrenete maintenance zadatke (firmware upload, kalibracija, reboot uređaja).
- `RegisterNodes` mis-use da zakačite često korišćene čvorove i onda zvezdite legitimate klijente ne otpuštajući handle-ove.
- **Testovi robusnosti sesija:** Pokušajte da vezujete desetine subscriptions sa ekstremno niskim publishing intervalima (ispod 50 ms) plus oversized monitored-item queues. Mnogi stack-ovi pogrešno računaju `RevisedPublishingInterval` i padaju zbog scheduler overflow-a.

### Fuzzing & exploit development tooling

Claroty Team82 je objavio open-source `opcua-exploit-framework` koji pakuje višegodišnja Pwn2Own-grade istraživanja u ponovo upotrebljive module:

- **Modes:** `sanity` (lagana čitanja/browse-ovi), `attacks` (npr. thread pool starvation, file upload DoS), `corpus` (replay fuzzing payload-ova), `server` (rogue OPC UA server za backdoor-ovanje klijenata).
- **Usage pattern:**
```bash
# Run a DoS attack against a Prosys Simulation Server endpoint
python3 main.py prosys 10.10.10.10 53530 /OPCUA/SimulationServer thread_pool_wait_starvation

# Replay an entire Boofuzz corpus against open62541
python3 main.py open62541 192.168.1.50 4840 / opcua_message_boofuzz_db input_corpus_minimized/opcua.db
```
- **Rogue server scenario:** Ugrađeni asyncua-based server vam omogućava da target-ujete client software servirajući malicious address spaces (npr. odgovore sa oversized `ExtensionObject`-ima da trigger-ujete parsing bug-ove u UA Expert klonovima).
- **Target coverage:** Ugrađeni profili mapiraju na Kepware, Ignition, Unified Automation, Softing SIS, Triangle Microworks, Node-OPCUA, Python OPC UA, Milo, open62541, itd., tako da brzo možete menjati stack-ove bez prepisivanja payload-ova.
- **Integration tips:** Chain-ujte njegov output sa sopstvenim fuzzer-ima—prvo naprskajte `corpus` payload-ove, pa onda pustite OpalOPC da ponovo proveri da li crash vraća insecure defaults (anonymous login, setpoint write access, itd.).

### Exploiting authentication bypasses

Ako se nađu ranjivosti za bypass autentikacije, možete konfigurisati an [OPC UA client](https://www.prosysopc.com/products/opc-ua-browser/) kako treba i proveriti šta je dostupno. To može omogućiti sve od prostog čitanja procesa vrednosti do direktnog upravljanja teškom industrijskom opremom.

Da biste dobili nagoveštaj o uređaju kojem imate pristup, pročitajte vrednosti čvora "ServerStatus" u adresnom prostoru i google-ujte za user manual.

## Shodan

- `port:4840`
- `port:62541 "OPC UA"`
- `ssl:"urn:opcua"`
- `product:"opc ua"`

Kombinujte pretragu sa vendor stringovima (`"Ignition OPC UA"`, `"KepServerEX"`) ili sertifikatima (`"CN=UaServerCert"`) da prioritetizujete high-value asset-e pre nego što počnete intrusive testing.

## References

- [https://opalopc.com/how-to-hack-opc-ua/](https://opalopc.com/how-to-hack-opc-ua/)
- [https://github.com/claroty/opcua-exploit-framework](https://github.com/claroty/opcua-exploit-framework)
- [https://certvde.com/en/advisories/VDE-2025-022/](https://certvde.com/en/advisories/VDE-2025-022/)


{{#include ../banners/hacktricks-training.md}}
