# SIP (Session Initiation Protocol)

{{#include ../../../banners/hacktricks-training.md}}

## Información Básica

SIP (Session Initiation Protocol) es un **protocolo de señalización y control de llamadas** ampliamente utilizado para establecer, modificar y terminar sesiones multimedia, incluyendo voz, video y mensajería instantánea, sobre redes IP. Desarrollado por el **Internet Engineering Task Force (IETF)**, SIP está definido en **RFC 3261** y se ha convertido en el estándar de facto para VoIP y comunicaciones unificadas.

Algunas características clave de SIP incluyen:

1. **Protocolo basado en texto**: SIP es un protocolo basado en texto, lo que lo hace legible para humanos y más fácil de depurar. Se basa en un modelo de solicitud-respuesta, similar a HTTP, y utiliza métodos como INVITE, ACK, BYE y CANCEL para controlar las sesiones de llamada.
2. **Escalabilidad y Flexibilidad**: SIP es altamente escalable y puede ser utilizado en implementaciones a pequeña escala, así como en entornos empresariales y de grado de operador. Se puede extender fácilmente con nuevas características, lo que lo hace adaptable a varios casos de uso y requisitos.
3. **Interoperabilidad**: La amplia adopción y estandarización de SIP aseguran una mejor interoperabilidad entre diferentes dispositivos, aplicaciones y proveedores de servicios, promoviendo una comunicación fluida a través de varias plataformas.
4. **Diseño Modular**: SIP trabaja con otros protocolos como **RTP (Real-time Transport Protocol)** para la transmisión de medios y **SDP (Session Description Protocol)** para describir sesiones multimedia. Este diseño modular permite una mayor flexibilidad y compatibilidad con diferentes tipos de medios y códecs.
5. **Servidores Proxy y de Redirección**: SIP puede utilizar servidores proxy y de redirección para facilitar el enrutamiento de llamadas y proporcionar características avanzadas como desvío de llamadas, transferencia de llamadas y servicios de correo de voz.
6. **Presencia y Mensajería Instantánea**: SIP no se limita a la comunicación de voz y video. También soporta presencia y mensajería instantánea, habilitando una amplia gama de aplicaciones de comunicación unificada.

A pesar de sus muchas ventajas, SIP puede ser complejo de configurar y gestionar, particularmente al tratar con problemas de NAT y firewall. Sin embargo, su versatilidad, escalabilidad y amplio soporte en la industria lo convierten en una opción popular para VoIP y comunicación multimedia.

### Métodos SIP

Los métodos SIP fundamentales definidos en **RFC 3261** incluyen:

1. **INVITE**: Utilizado para **iniciar una nueva sesión (llamada)** o modificar una existente. El método INVITE lleva la descripción de la sesión (típicamente usando SDP) para informar al destinatario sobre los detalles de la sesión propuesta, como tipos de medios, códecs y protocolos de transporte.
2. **ACK**: Enviado para **confirmar la recepción** de una respuesta final a una solicitud INVITE. El método ACK asegura la fiabilidad de las transacciones INVITE proporcionando un reconocimiento de extremo a extremo.
3. **BYE**: Utilizado para **terminar una sesión establecida (llamada)**. El método BYE es enviado por cualquiera de las partes en la sesión para indicar que desea finalizar la comunicación.
4. **CANCEL**: Enviado para **cancelar una solicitud INVITE pendiente** antes de que se establezca la sesión. El método CANCEL permite al remitente abortar una transacción INVITE si cambia de opinión o si no hay respuesta del destinatario.
5. **OPTIONS**: Utilizado para **consultar las capacidades de un servidor SIP o agente de usuario**. El método OPTIONS puede ser enviado para solicitar información sobre métodos soportados, tipos de medios u otras extensiones sin establecer realmente una sesión.
6. **REGISTER**: Utilizado por un agente de usuario para **registrar su ubicación actual con un servidor registrador SIP**. El método REGISTER ayuda a mantener un mapeo actualizado entre el URI SIP de un usuario y su dirección IP actual, habilitando el enrutamiento y la entrega de llamadas.

> [!WARNING]
> Tenga en cuenta que para llamar a alguien **no es necesario usar el REGISTER** para nada.\
> Sin embargo, es posible que para realizar un **INVITE** el llamante necesite **autenticarse** primero o recibirá una respuesta **`401 Unauthorized`**.

Además de estos métodos fundamentales, hay **varios métodos de extensión SIP** definidos en otros RFC, tales como:

1. **SUBSCRIBE**: Definido en RFC 6665, el método SUBSCRIBE se utiliza para **solicitar notificaciones** sobre el estado de un recurso específico, como la presencia de un usuario o el estado de la llamada.
2. **NOTIFY**: También definido en RFC 6665, el método NOTIFY es enviado por un servidor para **informar a un agente de usuario suscrito** sobre cambios en el estado de un recurso monitoreado.
3. **REFER**: Definido en RFC 3515, el método REFER se utiliza para **solicitar que el destinatario realice una transferencia o refiera a un tercero**. Esto se utiliza típicamente para escenarios de **transferencia de llamadas**.
4. **MESSAGE**: Definido en RFC 3428, el método MESSAGE se utiliza para **enviar mensajes instantáneos entre agentes de usuario SIP**, habilitando la comunicación basada en texto dentro del marco SIP.
5. **UPDATE**: Definido en RFC 3311, el método UPDATE permite **modificar una sesión sin afectar el estado del diálogo existente**. Esto es útil para actualizar parámetros de sesión, como códecs o tipos de medios, durante una llamada en curso.
6. **PUBLISH**: Definido en RFC 3903, el método PUBLISH es utilizado por un agente de usuario para **publicar información del estado del evento a un servidor**, haciéndola disponible para otras partes interesadas.

### Códigos de Respuesta SIP

- **1xx (Respuestas Provisionales)**: Estas respuestas indican que la solicitud fue recibida y el servidor está continuando su procesamiento.
- 100 Trying: La solicitud fue recibida y el servidor está trabajando en ella.
- 180 Ringing: El destinatario está siendo alertado y tomará la llamada.
- 183 Session Progress: Proporciona información sobre el progreso de la llamada.
- **2xx (Respuestas Exitosas)**: Estas respuestas indican que la solicitud fue recibida, entendida y aceptada con éxito.
- 200 OK: La solicitud fue exitosa y el servidor la ha cumplido.
- 202 Accepted: La solicitud fue aceptada para su procesamiento, pero aún no se ha completado.
- **3xx (Respuestas de Redirección)**: Estas respuestas indican que se requiere una acción adicional para cumplir con la solicitud, típicamente contactando un recurso alternativo.
- 300 Multiple Choices: Hay múltiples opciones disponibles y el usuario o cliente debe elegir una.
- 301 Moved Permanently: El recurso solicitado ha sido asignado a un nuevo URI permanente.
- 302 Moved Temporarily: El recurso solicitado está temporalmente disponible en un URI diferente.
- 305 Use Proxy: La solicitud debe ser enviada a un proxy especificado.
- **4xx (Respuestas de Error del Cliente)**: Estas respuestas indican que la solicitud contiene una sintaxis incorrecta o no puede ser cumplida por el servidor.
- 400 Bad Request: La solicitud estaba mal formada o era inválida.
- 401 Unauthorized: La solicitud requiere autenticación del usuario.
- 403 Forbidden: El servidor entendió la solicitud pero se niega a cumplirla.
- 404 Not Found: El recurso solicitado no fue encontrado en el servidor.
- 408 Request Timeout: El servidor no recibió una solicitud completa dentro del tiempo que estaba preparado para esperar.
- 486 Busy Here: El destinatario está actualmente ocupado y no puede tomar la llamada.
- **5xx (Respuestas de Error del Servidor)**: Estas respuestas indican que el servidor no pudo cumplir con una solicitud válida.
- 500 Internal Server Error: El servidor encontró un error al procesar la solicitud.
- 501 Not Implemented: El servidor no soporta la funcionalidad requerida para cumplir con la solicitud.
- 503 Service Unavailable: El servidor no puede manejar la solicitud actualmente debido a mantenimiento o sobrecarga.
- **6xx (Respuestas de Fallo Global)**: Estas respuestas indican que la solicitud no puede ser cumplida por ningún servidor.
- 600 Busy Everywhere: Todos los destinos posibles para la llamada están ocupados.
- 603 Decline: El destinatario no desea participar en la llamada.
- 604 Does Not Exist Anywhere: El recurso solicitado no está disponible en ninguna parte de la red.

## Ejemplos

### Ejemplo de SIP INVITE
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Cada Parámetro Explicado</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Esta línea indica el método (INVITE), la URI de solicitud (sip:[jdoe@example.com](mailto:jdoe@example.com)), y la versión SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - El encabezado Via especifica el protocolo de transporte (UDP) y la dirección del cliente (pc33.example.com). El parámetro "branch" se utiliza para la detección de bucles y la coincidencia de transacciones.
3. **Max-Forwards**: `Max-Forwards: 70` - Este campo de encabezado limita el número de veces que la solicitud puede ser reenviada por proxies para evitar bucles infinitos.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - El encabezado To especifica el destinatario de la llamada, incluyendo su nombre para mostrar (John Doe) y la URI SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - El encabezado From especifica el remitente de la llamada, incluyendo su nombre para mostrar (Jane Smith) y la URI SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). El parámetro "tag" se utiliza para identificar de manera única el rol del remitente en el diálogo.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - El encabezado Call-ID identifica de manera única una sesión de llamada entre dos agentes de usuario.
7. **CSeq**: `CSeq: 314159 INVITE` - El encabezado CSeq contiene un número de secuencia y el método utilizado en la solicitud. Se utiliza para hacer coincidir respuestas con solicitudes y detectar mensajes fuera de orden.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - El encabezado Contact proporciona una ruta directa al remitente, que puede ser utilizada para solicitudes y respuestas posteriores.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - El encabezado User-Agent proporciona información sobre el software o hardware del remitente, incluyendo su nombre y versión.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - El encabezado Allow enumera los métodos SIP soportados por el remitente. Esto ayuda al destinatario a entender qué métodos se pueden utilizar durante la comunicación.
11. **Content-Type**: `Content-Type: application/sdp` - El encabezado Content-Type especifica el tipo de medio del cuerpo del mensaje, en este caso, SDP (Protocolo de Descripción de Sesión).
12. **Content-Length**: `Content-Length: 142` - El encabezado Content-Length indica el tamaño del cuerpo del mensaje en bytes.
13. **Message Body**: El cuerpo del mensaje contiene la descripción de sesión SDP, que incluye información sobre los tipos de medios, códecs y protocolos de transporte para la sesión propuesta.

- `v=0` - Versión del protocolo (0 para SDP)
- `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Originador e identificador de sesión
- `s=-` - Nombre de la sesión (un solo guion indica que no hay nombre de sesión)
- `c=IN IP4 pc33.example.com` - Información de conexión (tipo de red, tipo de dirección y dirección)
- `t=0 0` - Información de tiempo (tiempos de inicio y parada, 0 0 significa que la sesión no está limitada)
- `m=audio 49170 RTP/AVP 0` - Descripción del medio (tipo de medio, número de puerto, protocolo de transporte y lista de formatos). En este caso, especifica un flujo de audio utilizando RTP/AVP (Protocolo de Transporte en Tiempo Real / Perfil de Audio y Video) y formato 0 (PCMU/8000).
- `a=rtpmap:0 PCMU/8000` - Atributo que mapea el formato (0) al códec (PCMU) y su tasa de reloj (8000 Hz).

</details>

### Ejemplo de SIP REGISTER

El método REGISTER se utiliza en el Protocolo de Inicio de Sesión (SIP) para permitir que un agente de usuario (UA), como un teléfono VoIP o un softphone, **registre su ubicación con un servidor registrador SIP**. Este proceso permite que el servidor sepa **dónde enrutar las solicitudes SIP entrantes destinadas al usuario registrado**. El servidor registrador suele ser parte de un servidor proxy SIP o un servidor de registro dedicado.

Aquí hay un ejemplo detallado de los mensajes SIP involucrados en un proceso de autenticación REGISTER:

1. Solicitud inicial **REGISTER** del UA al servidor registrador:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Este mensaje inicial de REGISTER es enviado por el UA (Alice) al servidor registrador. Incluye información importante como la duración de registro deseada (Expires), el URI SIP del usuario (sip:[alice@example.com](mailto:alice@example.com)), y la dirección de contacto del usuario (sip:alice@192.168.1.100:5060).

2. **401 Unauthorized** respuesta del servidor registrador:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
El servidor registrador responde con un mensaje "401 Unauthorized", que incluye un encabezado "WWW-Authenticate". Este encabezado contiene información necesaria para que el UA se autentique, como el **realm de autenticación, nonce y algoritmo**.

3. Solicitud REGISTER **con credenciales de autenticación**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
El UA envía otra solicitud REGISTER, esta vez incluyendo el **"Authorization" header con las credenciales necesarias, como el nombre de usuario, realm, nonce y un valor de respuesta** calculado utilizando la información proporcionada y la contraseña del usuario.

Así es como se calcula la **respuesta de Authorization**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Respuesta de registro exitoso** del servidor registrador:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Después de que el servidor registrador verifica las credenciales proporcionadas, **envía una respuesta "200 OK" para indicar que el registro fue exitoso**. La respuesta incluye la información de contacto registrada y el tiempo de expiración para el registro. En este punto, el agente de usuario (Alice) está registrado con éxito en el servidor registrador SIP, y las solicitudes SIP entrantes para Alice pueden ser dirigidas a la dirección de contacto apropiada.

### Ejemplo de Llamada

<figure><img src="../../../images/image (1101).png" alt=""><figcaption></figcaption></figure>

> [!NOTE]
> No se menciona, pero el Usuario B necesita haber enviado un **mensaje REGISTER a Proxy 2** antes de poder recibir llamadas.

{{#include ../../../banners/hacktricks-training.md}}
