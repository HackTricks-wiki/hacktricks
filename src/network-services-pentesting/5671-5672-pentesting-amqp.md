# 5671,5672 - Pentesting AMQP

{{#include ../banners/hacktricks-training.md}}

## Informations de base

D'après [cloudamqp](https://www.cloudamqp.com/blog/2015-05-18-part1-rabbitmq-for-beginners-what-is-rabbitmq.html):

> **RabbitMQ** est un **logiciel de file d'attente de messages** également connu sous le nom de _broker de messages_ ou _gestionnaire de files_. En termes simples ; c'est un logiciel dans lequel des files sont définies, auxquelles des applications se connectent pour transférer un ou plusieurs messages.\
> Un **message peut contenir n'importe quel type d'information**. Il peut, par exemple, contenir des informations sur un processus ou une tâche devant démarrer sur une autre application (qui pourrait même se trouver sur un autre serveur), ou il peut s'agir d'un simple message texte. Le logiciel de gestion des files stocke les messages jusqu'à ce qu'une application réceptrice se connecte et retire un message de la file. L'application réceptrice traite ensuite le message.\
> Définition provenant de .

**Port par défaut** : 5672,5671
```
PORT     STATE SERVICE VERSION
5672/tcp open  amqp    RabbitMQ 3.1.5 (0-9)
```
## Énumération

### Manuel
```python
import amqp
#By default it uses default credentials "guest":"guest"
conn = amqp.connection.Connection(host="IP", port=5672, virtual_host="/")
conn.connect()
for k, v in conn.server_properties.items():
print(k, v)
```
### Automatique
```bash
nmap -sV -Pn -n -T4 -p 5672 --script amqp-info IP

PORT     STATE SERVICE VERSION
5672/tcp open  amqp    RabbitMQ 3.1.5 (0-9)
| amqp-info:
|   capabilities:
|     publisher_confirms: YES
|     exchange_exchange_bindings: YES
|     basic.nack: YES
|     consumer_cancel_notify: YES
|   copyright: Copyright (C) 2007-2013 GoPivotal, Inc.
|   information: Licensed under the MPL.  See http://www.rabbitmq.com/
|   platform: Erlang/OTP
|   product: RabbitMQ
|   version: 3.1.5
|   mechanisms: PLAIN AMQPLAIN
|_  locales: en_US
```
### Brute Force

- [**AMQP Protocol Brute-Force**](../generic-hacking/brute-force.md#amqp-activemq-rabbitmq-qpid-joram-and-solace)
- [**STOMP Protocol Brute-Force**](../generic-hacking/brute-force.md#stomp-activemq-rabbitmq-hornetq-and-openmq)

## Autres ports RabbitMQ

Dans [https://www.rabbitmq.com/networking.html](https://www.rabbitmq.com/networking.html) vous pouvez trouver que **rabbitmq utilise plusieurs ports** :

- **1883, 8883** : ([MQTT clients](http://mqtt.org) sans et avec TLS, si le [MQTT plugin](https://www.rabbitmq.com/mqtt.html) est activé. [**Learn more about how to pentest MQTT here**](1883-pentesting-mqtt-mosquitto.md).
- **4369: epmd**, un service de découverte de pairs utilisé par les nœuds RabbitMQ et les outils CLI. [**Learn more about how to pentest this service here**](4369-pentesting-erlang-port-mapper-daemon-epmd.md).
- **5672, 5671** : utilisés par les clients AMQP 0-9-1 et 1.0 sans et avec TLS
- **15672** : [HTTP API](https://www.rabbitmq.com/management.html) clients, [management UI](https://www.rabbitmq.com/management.html) et [rabbitmqadmin](https://www.rabbitmq.com/management-cli.html) (seulement si le [management plugin](https://www.rabbitmq.com/management.html) est activé). [**Learn more about how to pentest this service here**](15672-pentesting-rabbitmq-management.md).
- 15674 : clients STOMP-over-WebSockets (seulement si le [Web STOMP plugin](https://www.rabbitmq.com/web-stomp.html) est activé)
- 15675 : clients MQTT-over-WebSockets (seulement si le [Web MQTT plugin](https://www.rabbitmq.com/web-mqtt.html) est activé)
- 15692 : métriques Prometheus (seulement si le [Prometheus plugin](https://www.rabbitmq.com/prometheus.html) est activé)
- 25672 : utilisé pour la communication inter-nœud et des outils CLI (Erlang distribution server port) et est alloué à partir d'une plage dynamique (limitée à un port unique par défaut, calculée comme AMQP port + 20000). À moins que des connexions externes sur ces ports ne soient vraiment nécessaires (par ex. le cluster utilise [federation](https://www.rabbitmq.com/federation.html) ou des outils CLI sont utilisés sur des machines en dehors du sous-réseau), ces ports ne devraient pas être exposés publiquement. Voir le [networking guide](https://www.rabbitmq.com/networking.html) pour les détails. **Seulement 9 de ces ports sont ouverts sur Internet**.
- 35672-35682 : utilisés par les outils CLI (Erlang distribution client ports) pour la communication avec les nœuds et sont alloués à partir d'une plage dynamique (calculés comme server distribution port + 10000 through server distribution port + 10010). Voir le [networking guide](https://www.rabbitmq.com/networking.html) pour les détails.
- 61613, 61614 : [STOMP clients](https://stomp.github.io/stomp-specification-1.2.html) sans et avec TLS (seulement si le [STOMP plugin](https://www.rabbitmq.com/stomp.html) est activé). Moins de 10 appareils ont ce port ouvert et principalement UDP pour les nœuds DHT.

## Voir aussi

{{#ref}}
4222-pentesting-nats.md
{{#endref}}

## Shodan

- `AMQP`

## Références

- [CloudAMQP – RabbitMQ for beginners](https://www.cloudamqp.com/blog/2015-05-18-part1-rabbitmq-for-beginners-what-is-rabbitmq.html)
- [RabbitMQ Networking Guide](https://www.rabbitmq.com/networking.html)

{{#include ../banners/hacktricks-training.md}}
