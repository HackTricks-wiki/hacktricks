# 5671,5672 - Pentesting AMQP

{{#include ../banners/hacktricks-training.md}}

## Informação Básica

De [cloudamqp](https://www.cloudamqp.com/blog/2015-05-18-part1-rabbitmq-for-beginners-what-is-rabbitmq.html):

> **RabbitMQ** é um **message-queueing software** também conhecido como _message broker_ ou _queue manager._ Simplesmente dito; é um software onde filas são definidas, às quais aplicações se conectam para transferir uma mensagem ou mensagens.\
> Uma **mensagem pode incluir qualquer tipo de informação**. Poderia, por exemplo, conter informações sobre um processo ou tarefa que deve iniciar em outra aplicação (que poderia até estar em outro servidor), ou poderia ser apenas uma simples mensagem de texto. O software gerenciador de filas armazena as mensagens até que uma aplicação receptora conecte e retire uma mensagem da fila. A aplicação receptora então processa a mensagem.\
> Definição de .

**Porta padrão**: 5672,5671
```
PORT     STATE SERVICE VERSION
5672/tcp open  amqp    RabbitMQ 3.1.5 (0-9)
```
## Enumeração

### Manual
```python
import amqp
#By default it uses default credentials "guest":"guest"
conn = amqp.connection.Connection(host="IP", port=5672, virtual_host="/")
conn.connect()
for k, v in conn.server_properties.items():
print(k, v)
```
### Automático
```bash
nmap -sV -Pn -n -T4 -p 5672 --script amqp-info IP

PORT     STATE SERVICE VERSION
5672/tcp open  amqp    RabbitMQ 3.1.5 (0-9)
| amqp-info:
|   capabilities:
|     publisher_confirms: YES
|     exchange_exchange_bindings: YES
|     basic.nack: YES
|     consumer_cancel_notify: YES
|   copyright: Copyright (C) 2007-2013 GoPivotal, Inc.
|   information: Licensed under the MPL.  See http://www.rabbitmq.com/
|   platform: Erlang/OTP
|   product: RabbitMQ
|   version: 3.1.5
|   mechanisms: PLAIN AMQPLAIN
|_  locales: en_US
```
### Brute Force

- [**AMQP Protocol Brute-Force**](../generic-hacking/brute-force.md#amqp-activemq-rabbitmq-qpid-joram-and-solace)
- [**STOMP Protocol Brute-Force**](../generic-hacking/brute-force.md#stomp-activemq-rabbitmq-hornetq-and-openmq)

## Outras portas do RabbitMQ

Em [https://www.rabbitmq.com/networking.html](https://www.rabbitmq.com/networking.html) você pode encontrar que o **RabbitMQ usa várias portas**:

- **1883, 8883**: ([MQTT clients](http://mqtt.org) sem e com TLS, se o [MQTT plugin](https://www.rabbitmq.com/mqtt.html) estiver habilitado). [**Saiba mais sobre como pentest MQTT aqui**](1883-pentesting-mqtt-mosquitto.md).
- **4369: epmd**, um serviço de descoberta de peers usado por nodes RabbitMQ e ferramentas de CLI. [**Saiba mais sobre como pentest este serviço aqui**](4369-pentesting-erlang-port-mapper-daemon-epmd.md).
- **5672, 5671**: usados por clientes AMQP 0-9-1 e 1.0 sem e com TLS
- **15672**: clientes de [HTTP API](https://www.rabbitmq.com/management.html), [management UI](https://www.rabbitmq.com/management.html) e [rabbitmqadmin](https://www.rabbitmq.com/management-cli.html) (somente se o [management plugin](https://www.rabbitmq.com/management.html) estiver habilitado). [**Saiba mais sobre como pentest este serviço aqui**](15672-pentesting-rabbitmq-management.md).
- 15674: clientes STOMP-over-WebSockets (somente se o [Web STOMP plugin](https://www.rabbitmq.com/web-stomp.html) estiver habilitado)
- 15675: clientes MQTT-over-WebSockets (somente se o [Web MQTT plugin](https://www.rabbitmq.com/web-mqtt.html) estiver habilitado)
- 15692: métricas Prometheus (somente se o [Prometheus plugin](https://www.rabbitmq.com/prometheus.html) estiver habilitado)
- 25672: usado para comunicação inter-node e ferramentas de CLI (porta do servidor de distribuição Erlang) e é alocado a partir de um intervalo dinâmico (limitado a uma única porta por padrão, calculado como porta AMQP + 20000). A menos que conexões externas nessas portas sejam realmente necessárias (ex.: o cluster usa [federation](https://www.rabbitmq.com/federation.html) ou ferramentas de CLI são usadas em máquinas fora da sub-rede), essas portas não deveriam ficar expostas publicamente. Veja o [networking guide](https://www.rabbitmq.com/networking.html) para detalhes. **Apenas 9 dessas portas estão abertas na internet**.
- 35672-35682: usadas por ferramentas de CLI (portas cliente de distribuição Erlang) para comunicação com nodes e são alocadas a partir de um intervalo dinâmico (calculado como server distribution port + 10000 até server distribution port + 10010). Veja o [networking guide](https://www.rabbitmq.com/networking.html) para detalhes.
- 61613, 61614: [STOMP clients](https://stomp.github.io/stomp-specification-1.2.html) sem e com TLS (somente se o [STOMP plugin](https://www.rabbitmq.com/stomp.html) estiver habilitado). Menos de 10 dispositivos com esta porta aberta e majoritariamente UDP para nós DHT.

## Veja também

{{#ref}}
4222-pentesting-nats.md
{{#endref}}

## Shodan

- `AMQP`

## Referências

- [CloudAMQP – RabbitMQ for beginners](https://www.cloudamqp.com/blog/2015-05-18-part1-rabbitmq-for-beginners-what-is-rabbitmq.html)
- [RabbitMQ Networking Guide](https://www.rabbitmq.com/networking.html)

{{#include ../banners/hacktricks-training.md}}
