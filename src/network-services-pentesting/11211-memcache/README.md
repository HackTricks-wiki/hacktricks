# 11211 - Pentesting Memcache

{{#include ../../banners/hacktricks-training.md}}

## Πληροφορίες Πρωτοκόλλου

Από [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (προφορά: mem-cashed, mem-cash-dee) είναι ένα γενικού σκοπού κατανεμημένο [σύστημα προσωρινής αποθήκευσης μνήμης](https://en.wikipedia.org/wiki/Memory_caching). Χρησιμοποιείται συχνά για να επιταχύνει δυναμικές ιστοσελίδες που βασίζονται σε βάσεις δεδομένων, αποθηκεύοντας δεδομένα και αντικείμενα στη RAM για να μειώσει τον αριθμό των φορών που πρέπει να διαβαστεί μια εξωτερική πηγή δεδομένων (όπως μια βάση δεδομένων ή API).

Αν και το Memcached υποστηρίζει SASL, οι περισσότερες περιπτώσεις είναι **εκτεθειμένες χωρίς αυθεντικοποίηση**.

**Προεπιλεγμένη θύρα:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Για να εξάγετε όλες τις πληροφορίες που είναι αποθηκευμένες μέσα σε μια μνήμη memcache, πρέπει να:

1. Βρείτε **slabs** με **ενεργά στοιχεία**
2. Πάρτε τα **ονόματα κλειδιών** των slabs που ανιχνεύθηκαν προηγουμένως
3. Εξάγετε τα **αποθηκευμένα δεδομένα** αποκτώντας τα **ονόματα κλειδιών**

Θυμηθείτε ότι αυτή η υπηρεσία είναι απλώς μια **cache**, οπότε **τα δεδομένα μπορεί να εμφανίζονται και να εξαφανίζονται**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Αυτόματη
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping Memcache Keys**

Στον τομέα του memcache, ένα πρωτόκολλο που βοηθά στην οργάνωση των δεδομένων κατά slabs, υπάρχουν συγκεκριμένες εντολές για την επιθεώρηση των αποθηκευμένων δεδομένων, αν και με σημαντικούς περιορισμούς:

1. Οι κωδικοί μπορούν να απορριφθούν μόνο κατά slab class, ομαδοποιώντας κωδικούς παρόμοιου μεγέθους περιεχομένου.
2. Υπάρχει περιορισμός μίας σελίδας ανά slab class, που ισοδυναμεί με 1MB δεδομένων.
3. Αυτή η δυνατότητα είναι ανεπίσημη και μπορεί να καταργηθεί οποιαδήποτε στιγμή, όπως συζητείται σε [community forums](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

Ο περιορισμός του να μπορεί κανείς να απορρίψει μόνο 1MB από δυνητικά γιγαμπάιτ δεδομένων είναι ιδιαίτερα σημαντικός. Ωστόσο, αυτή η λειτουργικότητα μπορεί να προσφέρει ακόμα πληροφορίες σχετικά με τα πρότυπα χρήσης κωδικών, ανάλογα με τις συγκεκριμένες ανάγκες. Για εκείνους που δεν ενδιαφέρονται τόσο για τη μηχανική, μια επίσκεψη στην [tools section](https://lzone.de/cheat-sheet/memcached#tools) αποκαλύπτει εργαλεία για εκτενή απόρριψη. Εναλλακτικά, η διαδικασία χρήσης telnet για άμεση αλληλεπίδραση με τις ρυθμίσεις του memcached περιγράφεται παρακάτω.

### **How it Works**

Η οργάνωση μνήμης του memcache είναι καθοριστική. Ξεκινώντας το memcache με την επιλογή "-vv" αποκαλύπτει τις slab classes που δημιουργεί, όπως φαίνεται παρακάτω:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Για να εμφανίσετε όλα τα υπάρχοντα slabs, χρησιμοποιείται η ακόλουθη εντολή:
```bash
stats slabs
```
Η προσθήκη ενός μόνο κλειδιού στο memcached 1.4.13 απεικονίζει πώς οι κλάσεις slab γεμίζουν και διαχειρίζονται. Για παράδειγμα:
```bash
set mykey 0 60 1
1
STORED
```
Η εκτέλεση της εντολής "stats slabs" μετά την προσθήκη κλειδιού αποδίδει λεπτομερείς στατιστικές σχετικά με τη χρησιμοποίηση των slabs:
```bash
stats slabs
[...]
```
Αυτή η έξοδος αποκαλύπτει τους ενεργούς τύπους slab, τα χρησιμοποιούμενα chunks και τις λειτουργικές στατιστικές, προσφέροντας πληροφορίες σχετικά με την αποδοτικότητα των λειτουργιών ανάγνωσης και εγγραφής.

Μια άλλη χρήσιμη εντολή, "stats items", παρέχει δεδομένα σχετικά με τις εκδιώξεις, τους περιορισμούς μνήμης και τους κύκλους ζωής των αντικειμένων:
```bash
stats items
[...]
```
Αυτές οι στατιστικές επιτρέπουν εκπαιδευμένες υποθέσεις σχετικά με τη συμπεριφορά της προσωρινής αποθήκευσης εφαρμογών, συμπεριλαμβανομένης της αποδοτικότητας της προσωρινής αποθήκευσης για διαφορετικά μεγέθη περιεχομένου, της κατανομής μνήμης και της ικανότητας προσωρινής αποθήκευσης μεγάλων αντικειμένων.

### **Dumping Keys**

Για εκδόσεις πριν από την 1.4.31, τα κλειδιά αποθηκεύονται κατά κατηγορία slab χρησιμοποιώντας:
```bash
stats cachedump <slab class> <number of items to dump>
```
Για παράδειγμα, για να εξάγετε ένα κλειδί στην κλάση #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Αυτή η μέθοδος επαναλαμβάνει τις κλάσεις slab, εξάγοντας και προαιρετικά εκ dumping τις τιμές κλειδιών.

### **ΕΚΔΟΣΗ ΚΛΕΙΔΙΩΝ MEMCACHE (VER 1.4.31+)**

Με την έκδοση memcache 1.4.31 και άνω, εισάγεται μια νέα, ασφαλέστερη μέθοδος για την εκ dumping κλειδιών σε ένα παραγωγικό περιβάλλον, χρησιμοποιώντας μη αποκλειστική λειτουργία όπως αναλύεται στις [σημειώσεις έκδοσης](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Αυτή η προσέγγιση παράγει εκτενή έξοδο, γι' αυτό συνιστάται η χρήση της εντολής 'nc' για αποδοτικότητα. Παραδείγματα περιλαμβάνουν:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **ΕΡΓΑΛΕΙΑ ΕΚΧΥΛΙΣΗΣ**

Table [from here](https://lzone.de/blog).

| Programming Languages | Tools                                                                                                                             | Functionality                                                                                                                                                          |                                                                            |         |
| --------------------- | --------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------- | ------- |
| PHP                   | [simple script](http://snipt.org/xtP)                                                                                             | Εκτυπώνει τα ονόματα κλειδιών.                                                                                                                                       |                                                                            |         |
| Perl                  | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1&modificationDate=1229693957401) | Εκτυπώνει κλειδιά και τιμές                                                                                                                                          |                                                                            |         |
| Ruby                  | [simple script](https://gist.github.com/1365005)                                                                                  | Εκτυπώνει τα ονόματα κλειδιών.                                                                                                                                       |                                                                            |         |
| Perl                  | [memdump](https://search.cpan.org/~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Εργαλείο στο CPAN module                                                                                                                                             | [Memcached-libmemcached](https://search.cpan.org/~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                         | GUI παρακολούθησης Memcache που επιτρέπει επίσης την εκχύλιση κλειδιών                                                                                               |                                                                            |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                             | **Κάνει παγώμα της διαδικασίας memcached!!!** Να είστε προσεκτικοί όταν το χρησιμοποιείτε σε παραγωγή. Παρ' όλα αυτά, μπορείτε να παρακάμψετε τον περιορισμό των 1MB και να εκχυλίσετε **όλα** τα κλειδιά. |                                                                            |         |

## Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB Data Limit <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Σημειώστε ότι πριν από το memcached 1.4 δεν μπορείτε να αποθηκεύσετε αντικείμενα μεγαλύτερα από 1MB λόγω του προεπιλεγμένου μέγιστου μεγέθους slab.

### Ποτέ μην ορίζετε Timeout > 30 Days! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Εάν προσπαθήσετε να “ορίσετε” ή “προσθέσετε” ένα κλειδί με timeout μεγαλύτερο από το επιτρεπόμενο μέγιστο, μπορεί να μην πάρετε αυτό που περιμένετε, διότι το memcached τότε θεωρεί την τιμή ως Unix timestamp. Επίσης, αν το timestamp είναι στο παρελθόν, δεν θα κάνει τίποτα. Η εντολή σας θα αποτύχει σιωπηλά.

Έτσι, αν θέλετε να χρησιμοποιήσετε τη μέγιστη διάρκεια ζωής, καθορίστε 2592000. Παράδειγμα:
```
set my_key 0 2592000 1
1
```
### Κλειδιά που Εξαφανίζονται σε Υπερχείλιση <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Παρά το γεγονός ότι η τεκμηρίωση λέει κάτι σχετικά με την περιτύλιξη γύρω από 64bit, η υπερχείλιση μιας τιμής χρησιμοποιώντας το “incr” προκαλεί την εξαφάνιση της τιμής. Πρέπει να δημιουργηθεί ξανά χρησιμοποιώντας το “add”/”set”.

### Αναπαραγωγή <a href="#replication" id="replication"></a>

Το memcached από μόνο του δεν υποστηρίζει αναπαραγωγή. Αν το χρειάζεστε πραγματικά, πρέπει να χρησιμοποιήσετε λύσεις τρίτων:

- [repcached](http://repcached.lab.klab.org/): Πολυμάστερ ασύγχρονη αναπαραγωγή (patch set memcached 1.2)
- [Couchbase memcached interface](http://www.couchbase.com/memcached): Χρησιμοποιήστε το CouchBase ως drop-in memcached
- [yrmcds](https://cybozu.github.io/yrmcds/): Συμβατό με memcached Master-Slave αποθηκευτικό σύστημα κλειδιών-τιμών
- [twemproxy](https://github.com/twitter/twemproxy) (aka nutcracker): proxy με υποστήριξη memcached

### Εγχειρίδιο Εντολών


{{#ref}}
memcache-commands.md
{{#endref}}

### **Shodan**

- `port:11211 "STAT pid"`
- `"STAT pid"`

## Αναφορές

- [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{{#include ../../banners/hacktricks-training.md}}
