# 11211 - Memcache Pentesting

{{#include ../../banners/hacktricks-training.md}}

## Protokol Bilgisi

From [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (telaffuz: mem-cashed, mem-cash-dee) genel amaçlı dağıtık [bellek önbellekleme](https://en.wikipedia.org/wiki/Memory_caching) sistemidir. Genellikle dinamik veritabanı destekli web sitelerinin hızını artırmak için verileri ve nesneleri RAM'de önbelleğe alarak harici bir veri kaynağının (örneğin bir veritabanı veya API) okunma sayısını azaltmak için kullanılır.

Memcached SASL'yi desteklese de, çoğu örnek **kimlik doğrulama olmadan açığa çıkar**.

**Varsayılan port:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeration

### Manual

Bir memcache örneğinde kaydedilmiş tüm bilgileri dışarı aktarmak için şunları yapmalısınız:

1. **Aktif öğeler** ile **slab'ları** bulun
2. Daha önce tespit edilen slab'ların **anahtar adlarını** alın
3. **Anahtar adlarını** alarak **kaydedilmiş veriyi** dışarı aktarın

Bu hizmetin sadece bir **önbellek** olduğunu unutmayın, bu nedenle **veri görünebilir ve kaybolabilir**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Otomatik
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Memcache Anahtarlarını Dökme**

Memcache alanında, verileri slablar aracılığıyla düzenlemeye yardımcı olan bir protokolde, depolanan verileri incelemek için belirli komutlar bulunmaktadır, ancak dikkate değer kısıtlamalarla birlikte:

1. Anahtarlar yalnızca slab sınıfına göre dökülebilir, benzer içerik boyutuna sahip anahtarları gruplar.
2. Her slab sınıfı için bir sayfa limiti vardır, bu da 1MB veri ile eşdeğerdir.
3. Bu özellik resmi değildir ve [topluluk forumlarında](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM) tartışıldığı gibi herhangi bir zamanda sona erdirilebilir.

Potansiyel olarak gigabaytlarca veriden yalnızca 1MB dökme kısıtlaması özellikle önemlidir. Ancak, bu işlevsellik belirli ihtiyaçlara bağlı olarak anahtar kullanım desenleri hakkında içgörüler sunabilir. Mekaniklerle daha az ilgilenenler için, [araçlar bölümüne](https://lzone.de/cheat-sheet/memcached#tools) bir ziyaret, kapsamlı dökme için yardımcı programlar sunmaktadır. Alternatif olarak, memcached kurulumlarıyla doğrudan etkileşim için telnet kullanma süreci aşağıda açıklanmıştır.

### **Nasıl Çalışır**

Memcache'in bellek organizasyonu çok önemlidir. Memcache'i "-vv" seçeneğiyle başlatmak, ürettiği slab sınıflarını ortaya çıkarır, aşağıda gösterildiği gibi:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Tüm mevcut slab'leri görüntülemek için aşağıdaki komut kullanılır:
```bash
stats slabs
```
memcached 1.4.13'e tek bir anahtar eklemek, slab sınıflarının nasıl doldurulduğunu ve yönetildiğini gösterir. Örneğin:
```bash
set mykey 0 60 1
1
STORED
```
"stats slabs" komutunu anahtar eklemeden sonra çalıştırmak, slab kullanımına dair ayrıntılı istatistikler sağlar:
```bash
stats slabs
[...]
```
Bu çıktı, aktif slab türlerini, kullanılan parçaları ve operasyonel istatistikleri ortaya koyarak okuma ve yazma işlemlerinin verimliliği hakkında bilgiler sunar.

Başka bir yararlı komut, "stats items", tahliyeler, bellek kısıtlamaları ve öğe yaşam döngüleri hakkında veriler sağlar:
```bash
stats items
[...]
```
Bu istatistikler, farklı içerik boyutları için önbellek verimliliği, bellek tahsisi ve büyük nesneleri önbelleğe alma kapasitesi de dahil olmak üzere uygulama önbellekleme davranışı hakkında eğitimli varsayımlar yapmaya olanak tanır.

### **Anahtarları Dökme**

1.4.31'den önceki sürümler için, anahtarlar slab sınıfı tarafından şu şekilde dökülür:
```bash
stats cachedump <slab class> <number of items to dump>
```
Örneğin, sınıf #1'de bir anahtarı dökmek için:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Bu yöntem, slab sınıfları üzerinde yineleme yaparak anahtar değerlerini çıkarır ve isteğe bağlı olarak dökümünü alır.

### **MEMCACHE ANAHTARLARINI DÖKME (VER 1.4.31+)**

Memcache sürümü 1.4.31 ve üzeri ile, üretim ortamında anahtarları dökmek için yeni, daha güvenli bir yöntem tanıtılmıştır; bu yöntem, [sürüm notlarında](https://github.com/memcached/memcached/wiki/ReleaseNotes1431) detaylandırıldığı gibi, engellemeyen mod kullanmaktadır. Bu yaklaşım geniş bir çıktı üretir, bu nedenle verimlilik için 'nc' komutunun kullanılması önerilir. Örnekler şunlardır:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **DUMPING TOOLS**

Table [from here](https://lzone.de/blog).

| Programming Languages | Tools                                                                                                                             | Functionality                                                                                                                                                          |                                                                            |         |
| --------------------- | --------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------- | ------- |
| PHP                   | [simple script](http://snipt.org/xtP)                                                                                             | Anahtar adlarını yazdırır.                                                                                                                                                      |                                                                            |         |
| Perl                  | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1&modificationDate=1229693957401) | Anahtarları ve değerleri yazdırır.                                                                                                                                                 |                                                                            |         |
| Ruby                  | [simple script](https://gist.github.com/1365005)                                                                                  | Anahtar adlarını yazdırır.                                                                                                                                                      |                                                                            |         |
| Perl                  | [memdump](https://search.cpan.org/~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | CPAN modülündeki araç                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                         | Anahtarları dökme imkanı sunan Memcache İzleme GUI'si                                                                                                                  |                                                                            |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                             | **Memcached işleminizi dondurur!!!** Üretimde kullanırken dikkatli olun. Yine de bunu kullanarak 1MB sınırlamasını aşabilir ve **tüm** anahtarları gerçekten dökebilirsiniz. |                                                                            |         |

## Troubleshooting <a href="#troubleshooting" id="troubleshooting"></a>

### 1MB Data Limit <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Memcached 1.4'ten önce, varsayılan maksimum slab boyutu nedeniyle 1MB'den büyük nesneleri depolayamazsınız.

### Never Set a Timeout > 30 Days! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Eğer izin verilen maksimumdan daha büyük bir zaman aşımı ile bir anahtar “set” veya “add” etmeye çalışırsanız, memcached bu değeri bir Unix zaman damgası olarak değerlendireceği için beklediğiniz gibi olmayabilir. Ayrıca, zaman damgası geçmişte ise hiçbir şey yapmaz. Komutunuz sessizce başarısız olur.

Bu nedenle, maksimum ömrü kullanmak istiyorsanız 2592000 olarak belirtin. Örnek:
```
set my_key 0 2592000 1
1
```
### Taşan Değerlerde Kaybolan Anahtarlar <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Belgelerde, “incr” kullanarak 64bit değerinin taşmasının anahtarın kaybolmasına neden olduğu belirtilse de, bu değerin tekrar “add”/“set” ile oluşturulması gerekir.

### Çoğaltma <a href="#replication" id="replication"></a>

memcached kendisi çoğaltmayı desteklemez. Eğer gerçekten buna ihtiyacınız varsa, 3. parti çözümler kullanmalısınız:

- [repcached](http://repcached.lab.klab.org/): Çoklu-master asenkron çoğaltma (memcached 1.2 yaman seti)
- [Couchbase memcached arayüzü](http://www.couchbase.com/memcached): CouchBase'i memcached yerine kullanın
- [yrmcds](https://cybozu.github.io/yrmcds/): memcached uyumlu Master-Slave anahtar değer deposu
- [twemproxy](https://github.com/twitter/twemproxy) (aka nutcracker): memcached desteği olan proxy

### Komutlar Hızlı Referans

{{#ref}}
memcache-commands.md
{{#endref}}

### **Shodan**

- `port:11211 "STAT pid"`
- `"STAT pid"`

## Referanslar

- [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

{{#include ../../banners/hacktricks-training.md}}
