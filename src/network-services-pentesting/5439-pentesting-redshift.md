# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Información básica

Este puerto es usado por **Amazon Redshift** (almacén de datos gestionado por AWS). El protocolo de Redshift en la capa de red es un protocolo de **PostgreSQL** ligeramente modificado, por lo que la mayoría de las herramientas cliente de Postgres funcionan (psql, psycopg2, JDBC/ODBC), pero la autenticación y los requisitos de TLS difieren.

Para más información consulta:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeración y conectividad

- Puerto por defecto: **5439/TCP** (personalizable). Los workgroups serverless también usan por defecto 5439.
- Patrón de endpoint público: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) or `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift requiere TLS 1.2+ y cifrados con perfect-forward-secrecy. Los clientes antiguos pueden fallar; fuerza TLS moderno:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** controla si se permite texto plano. Los nuevos clusters/workgroups usan `default.redshift-2.0` con `require_ssl=true`, por lo que los ataques downgrade/mitm son más difíciles.

### Enumeración rápida con psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Los errores diferencian contraseña incorrecta vs usuario inexistente → potencial **username enumeration** durante brute force.

## Rutas de autenticación para probar

- **Contraseña de la base de datos** para el master user (a menudo llamado `awsuser`) o usuarios de BD creados.
- **IAM auth tokens**: genera credenciales de corta duración y conéctate vía libpq/JDBC/ODBC usando `sslmode=require` y `authMech=IAM` o `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Abusa de credenciales/roles IAM robados con un permiso equivalente estilo `rds-db:connect` para Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: el `plugin_name` de JDBC puede levantar un servidor web local para SSO; el callback de loopback capturado puede leak SAML assertion o temp creds.

## Misconfiguraciones comunes (red)

- Cluster marcado **PubliclyAccessible=true** con SG completamente abierto (0.0.0.0/0) expone una superficie tipo Postgres para brute force o explotación SQLi.
- **Puerto por defecto 5439** más SG por defecto permite descubrimiento fácil (Shodan/Censys). Cambiar el puerto es una oscuridad menor pero a veces se pasa por alto en listas de hardening.
- **No enhanced VPC routing** → COPY/UNLOAD van por Internet público; puede ser abusado para exfil si el atacante controla el bucket/endpoint S3.

## Notas de ataque

- Si el login tiene éxito, Redshift carece de superuser en serverless; en clusters provisionados el master user tiene amplios permisos, incluyendo crear UDFs (Python), external schema hacia Spectrum, COPY desde S3 del atacante, y `UNLOAD` para exfiltrar datos.
- Revisa el cluster parameter group para `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – que el logging esté deshabilitado ayuda al sigilo.
- Los workgroups serverless siguen siendo alcanzables vía TCP; misma superficie de ataque SQL que los clusters provisionados.

## Cambios recientes de seguridad (impacto ofensivo)

- **Acceso público deshabilitado por defecto** en nuevos clusters/snapshots; los legacy pueden seguir siendo públicos.
- **Cifrado en reposo + TLS forzado por defecto** significa que sniffing/mitm es más difícil; se necesitan credenciales válidas o SSRF hacia la ruta VPC.

## Referencias

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
