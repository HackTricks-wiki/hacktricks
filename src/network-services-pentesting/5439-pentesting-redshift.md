# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Informações Básicas

Esta porta é usada pelo **Amazon Redshift** (data warehouse gerenciado pela AWS). O protocolo de transporte do Redshift é uma versão ligeiramente modificada do protocolo **PostgreSQL**, então a maioria das ferramentas cliente Postgres funciona (psql, psycopg2, JDBC/ODBC), mas os requisitos de autenticação e TLS são diferentes.

For more information check:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeração & Conectividade

- Porta padrão: **5439/TCP** (personalizável). Serverless workgroups também usam 5439 por padrão.
- Padrão de endpoint público: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) or `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: O Redshift requer TLS 1.2+ e cifras perfect-forward-secrecy. Clientes antigos podem falhar; force TLS moderno:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- Parameter group `require_ssl` controla se plaintext é permitido. Novos clusters/workgroups usam `default.redshift-2.0` com `require_ssl=true`, então downgrade/mitm fica mais difícil.

### Enumeração rápida com psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Erros diferenciam senha incorreta vs usuário ausente → potencial **username enumeration** durante brute force.

## Caminhos de autenticação a testar

- **Database password** do usuário master (frequentemente chamado `awsuser`) ou usuários DB criados.
- **IAM auth tokens**: gere credenciais de curta duração e conecte via libpq/JDBC/ODBC usando `sslmode=require` e `authMech=IAM` ou `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Abuse de credenciais/roles IAM roubadas com permissão equivalente ao estilo `rds-db:connect` para Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: o JDBC `plugin_name` pode iniciar um servidor web local para SSO; o callback de loopback capturado pode leak a SAML assertion ou credenciais temporárias.

## Configurações incorretas comuns (rede)

- Cluster marcado **PubliclyAccessible=true** com SG aberto (0.0.0.0/0) expõe superfície Postgres-like para brute force ou exploração por SQLi.
- **Default port 5439** mais SG padrão permite descoberta fácil (Shodan/Censys). Mudar a porta é uma obfuscação menor, mas às vezes é negligenciado em checklists de hardening.
- **No enhanced VPC routing** → COPY/UNLOAD trafegam pela Internet pública; podem ser abusados para exfil quando o atacante controla o bucket/endpoint S3.

## Notas de ataque

- Se o login for bem-sucedido, o Redshift não tem superuser em serverless; em clusters provisionados o master user tem direitos amplos incluindo criar UDFs (Python), external schema para Spectrum, COPY de um S3 do atacante e `UNLOAD` para exfiltrar dados.
- Verifique o cluster parameter group por `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – logs desabilitados ajudam na furtividade.
- Workgroups serverless ainda acessíveis via TCP; mesma superfície de ataque SQL que clusters provisionados.

## Mudanças recentes de segurança (impacto ofensivo)

- **Public access disabled by default** em novos clusters/snapshots; instâncias legadas podem ainda ser públicas.
- **Encryption at rest + enforced TLS by default** significa que sniffing/mitm é mais difícil; é necessário credenciais válidas ou SSRF para um caminho dentro do VPC.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
