# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Grundlegende Informationen

Dieser Port wird von Amazon Redshift (AWS verwaltetes Data Warehouse) verwendet. Das Redshift-Wire-Protokoll ist ein leicht modifiziertes PostgreSQL-Protokoll, daher funktionieren die meisten Postgres-Client-Tools (psql, psycopg2, JDBC/ODBC), aber auth- und TLS-Anforderungen unterscheiden sich.

Für mehr Informationen siehe:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeration & Connectivity

- Default port: **5439/TCP** (anpassbar). Serverless workgroups verwenden ebenfalls standardmäßig 5439.
- Public endpoint pattern: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) or `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift verlangt TLS 1.2+ und perfect-forward-secrecy ciphers. Alte Clients können fehlschlagen; erzwinge modernes TLS:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** steuert, ob Klartext erlaubt ist. Neue Clusters/Workgroups verwenden `default.redshift-2.0` mit `require_ssl=true`, daher sind downgrade/mitm-Angriffe schwieriger.

### Quick enum with psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Fehlermeldungen unterscheiden schlechtes Passwort von fehlendem Benutzer → potenzielle **username enumeration** während brute force.

## Authentifizierungspfade zum Testen

- **Datenbank-Passwort** für den Master-Benutzer (oft `awsuser`) oder angelegte DB-Benutzer.
- **IAM auth tokens**: kurzlebige Anmeldeinformationen generieren und über libpq/JDBC/ODBC mit `sslmode=require` und `authMech=IAM` oder `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider` verbinden. Missbrauche gestohlene IAM creds/roles mit äquivalenten Berechtigungen vom Typ `rds-db:connect` für Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: Der JDBC-`plugin_name` kann einen lokalen Webserver für SSO starten; ein abgefangener Loopback-Callback kann SAML-Assertion oder temporäre creds leaken.

## Häufige Fehlkonfigurationen (Netzwerk)

- Cluster mit **PubliclyAccessible=true** und sehr offenem SG (0.0.0.0/0) öffnet eine Postgres-ähnliche Angriffsfläche für brute force oder SQLi-Exploitation.
- **Default port 5439** plus Standard-SG ermöglichen einfache Entdeckung (Shodan/Censys). Das Ändern des Ports ist nur geringe Verschleierung, wird aber in Hardening-Checklisten manchmal übersehen.
- **No enhanced VPC routing** → COPY/UNLOAD gehen über das öffentliche Internet; kann für exfil missbraucht werden, wenn ein Angreifer einen S3 bucket/endpoint kontrolliert.

## Angriffsnotizen

- Wenn der Login gelingt, hat Redshift im serverless keinen superuser; in provisioned Clustern besitzt der Master-Benutzer weitreichende Rechte, einschließlich Erstellen von UDFs (Python), external schema zu Spectrum, COPY von attacker S3 und `UNLOAD` zur exfil von Daten.
- Prüfe die cluster parameter group auf `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – deaktiviertes Logging erleichtert die Tarnung.
- Serverless workgroups sind weiterhin über TCP erreichbar; gleiche SQL-Angriffsfläche wie bei provisioned Clustern.

## Aktuelle Sicherheitsänderungen (Auswirkung auf Offensive)

- **Public access disabled by default** bei neuen Clustern/Snapshots; Legacy-Cluster können weiterhin öffentlich sein.
- **Encryption at rest + enforced TLS by default** macht Sniffing/MITM schwieriger; es werden gültige Credentials benötigt oder ein SSRF in den VPC-Pfad.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
