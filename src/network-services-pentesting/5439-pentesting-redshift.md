# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## 基本情報

このポートは **Amazon Redshift**（AWS が管理するデータウェアハウス）で使用されます。Redshift のワイヤープロトコルはわずかに変更された **PostgreSQL** プロトコルであるため、ほとんどの Postgres クライアントツール（psql、psycopg2、JDBC/ODBC）は動作しますが、認証や TLS の要件は異なります。

For more information check:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## 列挙と接続

- デフォルトポート: **5439/TCP**（カスタマイズ可能）。Serverless workgroups もデフォルトで 5439 を使用します。
- パブリックエンドポイントのパターン: `<clusterid>.<random>.<region>.redshift.amazonaws.com`（パブリック）または `.redshift.amazonaws.com.cn`（中国）。Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`。
- **TLS**: Redshift は TLS 1.2+ と perfect-forward-secrecy 暗号を要求します。古いクライアントは失敗する可能性があるため、モダンな TLS を強制してください:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** はプレーンテキストを許可するかどうかを制御します。新しいクラスター/ワークグループは `default.redshift-2.0` を使用し、`require_ssl=true` が設定されているため、downgrade/mitm は困難になります。

### Quick enum with psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
エラーがパスワード不正とユーザー不存在を区別する → ブルートフォース時に **username enumeration** の可能性がある。

## 認証パス（テスト対象）

- **Database password** — マスターユーザー（多くの場合 `awsuser`）や作成した DB ユーザーのパスワード。
- **IAM auth tokens**：短命の認証情報を生成し、libpq/JDBC/ODBC 経由で `sslmode=require` と `authMech=IAM` または `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider` を使って接続する。盗まれた IAM creds/roles を Redshift に相当する `rds-db:connect` スタイルの権限で悪用できる。
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**：JDBC の `plugin_name` は SSO 用にローカル webserver を起動する場合がある；ループバックのコールバックをキャプチャすると SAML assertion や一時的な認証情報を leak する可能性がある。

## よくあるミス設定（ネットワーク）

- クラスタが **PubliclyAccessible=true** かつ SG が 0.0.0.0/0 のように解放されていると、Postgres に似た攻撃面が露出し、ブルートフォースや SQLi の悪用対象になる。
- **Default port 5439** とデフォルト SG の組合せは Shodan/Censys による発見を容易にする。ポート変更は小さなセキュリティのぼかし（obscurity）に過ぎないが、ハーデニングチェックリストで見落とされがち。
- **No enhanced VPC routing** → COPY/UNLOAD がパブリックなインターネット経由で行われる；攻撃者が S3 バケット/エンドポイントを支配している場合、exfil に悪用できる。

## 攻撃メモ

- ログインに成功した場合、serverless の Redshift には superuser が存在しないが、provisioned クラスターではマスターユーザーが広範な権限を持ち、UDFs (Python) の作成、Spectrum への external schema、攻撃者制御の S3 からの COPY、データを exfil するための `UNLOAD` などが可能。
- クラスタの parameter group で `max_concurrency_scaling_clusters`、`require_ssl`、`enable_user_activity_logging` を確認する — ロギング無効はステルスを助ける。
- Serverless workgroups は TCP 経由で依然到達可能；provisioned クラスタと同じ SQL 攻撃面が存在する。

## 最近のセキュリティ変更（攻撃への影響）

- **Public access disabled by default** が新しいクラスタ/スナップショットに適用されるようになった；既存のレガシーなものは依然パブリックである可能性がある。
- **Encryption at rest + enforced TLS by default** により、スニッフィング/mitm が困難になった；有効な認証情報か VPC パスへの SSRF が必要になる。

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
