# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Osnovne informacije

Ovaj port koristi **Amazon Redshift** (AWS managed data warehouse). Redshift wire protocol je blago modifikovan **PostgreSQL** protokol, tako da većina Postgres klijentskih alata radi (psql, psycopg2, JDBC/ODBC), ali auth i TLS zahtevi se razlikuju.

Za više informacija pogledajte:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeracija i povezivanje

- Podrazumevani port: **5439/TCP** (može se menjati). Serverless workgroups takođe podrazumevano koriste 5439.
- Obrasci javnog endpointa: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) ili `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift zahteva TLS 1.2+ i perfect-forward-secrecy ciphers. Stari klijenti mogu da ne rade; prisilite korišćenje modernog TLS-a:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- Parameter group `require_ssl` kontroliše da li je plaintext dozvoljen. Nove clusters/workgroups koriste `default.redshift-2.0` sa `require_ssl=true`, tako da downgrade/mitm je teže izvesti.

### Brzo enum sa psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Greške prave razliku između loše lozinke i nepostojećeg korisnika → potencijalna **username enumeration** tokom brute force.

## Authentication paths to test

- **Lozinka baze podataka** za master korisnika (često nazvan `awsuser`) ili kreirane DB korisnike.
- **IAM auth tokens**: generišite kratkotrajne akredencijale i povežite se preko libpq/JDBC/ODBC koristeći `sslmode=require` i `authMech=IAM` ili `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Iskoristite ukradene IAM creds/roles sa odgovarajućom dozvolom tipa `rds-db:connect` za Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: JDBC `plugin_name` može pokrenuti lokalni webserver za SSO; uhvaćeni loopback callback može leak SAML assertion ili temp creds.

## Common misconfigurations (network)

- Cluster označen **PubliclyAccessible=true** sa široko otvorenim SG (0.0.0.0/0) izlaže Postgres-like površinu za brute force ili SQLi exploitation.
- **Default port 5439** plus default SG omogućavaju lako otkrivanje (Shodan/Censys). Promena porta je mala obfuskacija ali se ponekad previdi u checklistama za hardening.
- **No enhanced VPC routing** → COPY/UNLOAD prolaze preko javnog Interneta; mogu se iskoristiti za exfil ako napadač kontroliše S3 bucket/endpoint.

## Attack notes

- Ako prijava uspe, Redshift nema superuser-a u serverless; u provisioned clusters master user ima široka prava uključujući kreiranje UDFs (Python), external schema ka Spectrum, COPY sa napadačevog S3, i `UNLOAD` za exfil podataka.
- Proverite cluster parameter group za `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – onemogućen logging olakšava stealth.
- Serverless workgroups su i dalje dostupni preko TCP; ista SQL attack surface kao kod provisioned clusters.

## Recent security changes (offense impact)

- **Public access disabled by default** on new clusters/snapshots; legacy ones may still be public.
- **Encryption at rest + enforced TLS by default** means sniffing/mitm harder; need valid credentials or SSRF into VPC path.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
