# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Informations de base

Ce port est utilisé par **Amazon Redshift** (AWS managed data warehouse). Le protocole wire de Redshift est une version légèrement modifiée du protocole **PostgreSQL**, donc la plupart des outils clients Postgres fonctionnent (psql, psycopg2, JDBC/ODBC) mais l'auth et les exigences TLS diffèrent.

Pour plus d'informations, voir :

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumération et connectivité

- Port par défaut : **5439/TCP** (personnalisable). Les workgroups Serverless ont aussi 5439 par défaut.
- Modèle d'endpoint public : `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) ou `.redshift.amazonaws.com.cn` (Chine). Serverless : `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS** : Redshift exige TLS 1.2+ et des chiffrements avec perfect-forward-secrecy. Les anciens clients peuvent échouer ; forcer un TLS moderne :
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** contrôle si le plaintext est autorisé. Les nouveaux clusters/workgroups utilisent `default.redshift-2.0` avec `require_ssl=true`, donc downgrade/mitm est plus difficile.

### Enum rapide avec psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Les erreurs distinguent 'mot de passe incorrect' et 'utilisateur manquant' → risque de **username enumeration** lors d'un brute force.

## Chemins d'authentification à tester

- **Database password** pour l'utilisateur master (souvent nommé `awsuser`) ou les users DB créés.
- **IAM auth tokens** : générez des identifiants temporaires et connectez-vous via libpq/JDBC/ODBC en utilisant `sslmode=require` et `authMech=IAM` ou `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Abusez des IAM creds/roles volés avec l'équivalent de permission de type `rds-db:connect` pour Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins** : le JDBC `plugin_name` peut lancer un serveur web local pour SSO ; un callback loopback capturé peut leak la SAML assertion ou des temp creds.

## Mauvaises configurations courantes (réseau)

- Cluster marqué **PubliclyAccessible=true** avec un SG ouvert (0.0.0.0/0) expose une surface de type Postgres pour brute force ou exploitation SQLi.
- **Default port 5439** plus SG par défaut permet une découverte facile (Shodan/Censys). Changer le port n'est qu'une obscurité mineure mais est parfois oublié dans les checklists de hardening.
- **No enhanced VPC routing** → les opérations COPY/UNLOAD passent par l'Internet public ; peuvent être abusées pour exfil lorsque l'attaquant contrôle le bucket/endpoint S3.

## Notes d'attaque

- Si la connexion réussit, Redshift n'a pas de superuser en serverless ; dans les provisioned clusters l'utilisateur master dispose de larges droits incluant la création de UDFs (Python), external schema vers Spectrum, COPY depuis un S3 contrôlé par l'attaquant, et `UNLOAD` pour exfiltrer des données.
- Vérifiez le cluster parameter group pour `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – la désactivation du logging facilite la discrétion.
- Les serverless workgroups restent joignables via TCP ; même surface d'attaque SQL que les provisioned clusters.

## Changements de sécurité récents (impact sur l'offensive)

- **Public access disabled by default** sur les nouveaux clusters/snapshots ; les anciens peuvent encore être publics.
- **Encryption at rest + enforced TLS by default** rend le sniffing/mitm plus difficile ; il faut des identifiants valides ou un SSRF dans le chemin VPC.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
