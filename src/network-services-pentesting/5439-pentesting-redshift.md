# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Basic Information

This port is used by **Amazon Redshift** (AWS managed data warehouse). Redshift wire protocol is a slightly modified **PostgreSQL** protocol, so most Postgres client tooling works (psql, psycopg2, JDBC/ODBC) but auth and TLS requirements differ.

For more information check:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeration & Connectivity

- Domyślny port: **5439/TCP** (konfigurowalny). Serverless workgroups also default to 5439.
- Wzorzec publicznego endpointu: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) or `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift wymaga TLS 1.2+ i szyfrów z perfect-forward-secrecy. Starsze klienty mogą nie działać; wymuś nowoczesny TLS:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** kontroluje, czy dozwolony jest plaintext. Nowe klastry/workgroups używają `default.redshift-2.0` z `require_ssl=true`, więc downgrade/mitm jest trudniejszy.

### Quick enum with psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Błędy rozróżniają nieprawidłowe hasło od braku użytkownika → potencjalna **username enumeration** podczas brute force.

## Ścieżki uwierzytelniania do przetestowania

- **Hasło do bazy danych** dla użytkownika master (często nazwany `awsuser`) lub utworzonych użytkowników DB.
- **IAM auth tokens**: wygeneruj krótkotrwałe poświadczenia i połącz się przez libpq/JDBC/ODBC używając `sslmode=require` i `authMech=IAM` lub `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Abuse skradzionych IAM creds/roles z uprawnieniem równoważnym `rds-db:connect` dla Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: JDBC `plugin_name` może uruchomić lokalny webserver dla SSO; przechwycony loopback callback może leak SAML assertion lub temp creds.

## Częste błędy konfiguracyjne (sieć)

- Klaster oznaczony **PubliclyAccessible=true** z szeroko otwartym SG (0.0.0.0/0) eksponuje powierzchnię podobną do Postgres dla brute force lub SQLi.
- **Default port 5439** wraz z domyślnym SG umożliwia łatwe wykrycie (Shodan/Censys). Zmiana portu to drobne zaciemnienie, ale czasem pomijana w checklistach hardeningu.
- **No enhanced VPC routing** → COPY/UNLOAD idą przez publiczny Internet; może być nadużyte do exfil, gdy atakujący kontroluje S3 bucket/endpoint.

## Uwagi dotyczące ataku

- Jeśli logowanie powiedzie się, Redshift nie ma superusera w serverless; w provisioned clusters użytkownik master ma szerokie prawa, w tym tworzenie UDFs (Python), external schema do Spectrum, COPY z atakującego S3 oraz `UNLOAD` do exfil danych.
- Sprawdź cluster parameter group pod kątem `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – wyłączenie logowania ułatwia ukrycie.
- Serverless workgroups nadal osiągalne przez TCP; ta sama powierzchnia ataku SQL co w provisioned clusters.

## Ostatnie zmiany w bezpieczeństwie (wpływ na offense)

- **Public access disabled by default** na nowych klastrach/snapshotach; legacy mogą nadal być publiczne.
- **Encryption at rest + enforced TLS by default** oznacza, że sniffing/mitm jest trudniejszy; potrzebne są ważne poświadczenia lub SSRF do ścieżki VPC.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
