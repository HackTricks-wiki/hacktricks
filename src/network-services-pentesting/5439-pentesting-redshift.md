# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Basic Information

This port is used by **Amazon Redshift** (AWS managed data warehouse). Redshift wire protocol is a slightly modified **PostgreSQL** protocol, so most Postgres client tooling works (psql, psycopg2, JDBC/ODBC) but 인증과 TLS 요구 사항이 다릅니다.

For more information check:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeration & Connectivity

- Default port: **5439/TCP** (customizable). Serverless workgroups also default to 5439.
- Public endpoint pattern: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) or `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift requires TLS 1.2+ and perfect-forward-secrecy ciphers. Old clients may fail; force modern TLS:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** controls if plaintext is allowed. New clusters/workgroups use `default.redshift-2.0` with `require_ssl=true`, so downgrade/mitm is harder.

### Quick enum with psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
오류가 잘못된 비밀번호와 없는 사용자로 구분됨 → 잠재적인 **username enumeration** during brute force.

## 테스트할 인증 경로

- **Database password**: master 사용자(종종 `awsuser`) 또는 생성된 DB 사용자용.
- **IAM auth tokens**: 짧은 수명 자격증명을 생성하여 libpq/JDBC/ODBC로 `sslmode=require` 및 `authMech=IAM` 또는 `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`를 사용해 연결. 탈취한 IAM creds/roles을 Redshift에 대해 `rds-db:connect` 스타일의 동등한 권한으로 악용.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: JDBC `plugin_name`이 SSO를 위해 로컬 웹서버를 띄울 수 있음; 캡처된 loopback callback이 SAML assertion 또는 임시 creds를 leak할 수 있음.

## 일반적인 잘못된 구성 (네트워크)

- Cluster가 **PubliclyAccessible=true**로 설정되고 SG가 0.0.0.0/0로 넓게 열려 있으면 Postgres-like 공격 표면이 노출되어 brute force 또는 SQLi 악용 가능.
- **Default port 5439** 및 기본 SG는 (Shodan/Censys로) 쉽게 발견되게 함. 포트 변경은 약간의 은폐 효과지만 하드닝 체크리스트에서 종종 간과됨.
- **No enhanced VPC routing** → COPY/UNLOAD가 공용 인터넷을 통해 전송됨; 공격자가 S3 버킷/endpoint를 제어하는 경우 exfil을 위해 악용될 수 있음.

## 공격 노트

- 로그인에 성공하면, Redshift는 serverless에서는 superuser가 없지만 provisioned clusters에서는 master 사용자가 UDFs (Python) 생성, Spectrum으로 외부 스키마 생성, 공격자 S3에서 COPY, 및 `UNLOAD`로 데이터 exfil 등 광범위한 권한을 가짐.
- 클러스터 파라미터 그룹에서 `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` 확인 – 로깅이 비활성화되어 있으면 탐지 회피에 유리.
- Serverless workgroups는 여전히 TCP로 접근 가능; provisioned clusters와 동일한 SQL 공격 표면.

## 최근 보안 변경사항 (공격 영향)

- **Public access disabled by default**가 새 클러스터/스냅샷에 적용됨; legacy ones는 여전히 public일 수 있음.
- **Encryption at rest + enforced TLS by default**로 스니핑/mitm이 어려워짐; 유효한 자격증명이나 VPC 경로로의 SSRF가 필요함.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
