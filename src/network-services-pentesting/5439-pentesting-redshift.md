# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Informazioni di base

Questa porta è utilizzata da **Amazon Redshift** (data warehouse gestito da AWS). Il protocollo wire di Redshift è una versione leggermente modificata del protocollo **PostgreSQL**, quindi la maggior parte degli strumenti client Postgres funziona (psql, psycopg2, JDBC/ODBC), ma l'autenticazione e i requisiti TLS differiscono.

Per maggiori informazioni consulta:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumerazione e connettività

- Porta predefinita: **5439/TCP** (modificabile). Anche i workgroup serverless usano 5439 come predefinita.
- Formato endpoint pubblico: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) o `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift richiede TLS 1.2+ e cipher con perfect-forward-secrecy. Client datati potrebbero non funzionare; forzare TLS moderno:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** controlla se è consentito il plaintext. Nuovi cluster/workgroups usano `default.redshift-2.0` con `require_ssl=true`, quindi downgrade/mitm è più difficile.

### Enumerazione rapida con psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Gli errori differenziano password errata vs utente mancante → potenziale **username enumeration** durante brute force.

## Authentication paths to test

- **Password del database** per il master user (spesso chiamato `awsuser`) o utenti DB creati.
- **IAM auth tokens**: generare credenziali short-lived e connettersi via libpq/JDBC/ODBC usando `sslmode=require` e `authMech=IAM` o `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Abuse stolen IAM creds/roles con permessi equivalenti stile `rds-db:connect` per Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: JDBC `plugin_name` può avviare un webserver locale per SSO; il callback loopback catturato può leak SAML assertion o temp creds.

## Common misconfigurations (network)

- Cluster marcato **PubliclyAccessible=true** con SG wide-open (0.0.0.0/0) espone una superficie Postgres-like per brute force o sfruttamento SQLi.
- **Default port 5439** più SG di default permette facile discovery (Shodan/Censys). Cambiare porta è una minima offuscamento ma a volte viene trascurato nelle checklist di hardening.
- **No enhanced VPC routing** → COPY/UNLOAD transitano su Internet pubblico; possono essere abusati per exfil quando un attaccante controlla un bucket/endpoint S3.

## Attack notes

- Se il login ha successo, Redshift non ha superuser in serverless; nei provisioned clusters il master user ha ampi diritti inclusi creare UDFs (Python), external schema verso Spectrum, COPY da S3 controllato dall'attaccante, e `UNLOAD` per exfiltrare dati.
- Controllare il cluster parameter group per `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – logging disabilitato aiuta lo stealth.
- I workgroups serverless sono ancora raggiungibili via TCP; stessa superficie d'attacco SQL dei provisioned clusters.

## Recent security changes (offense impact)

- **Public access disabled by default** sui nuovi clusters/snapshots; quelli legacy possono essere ancora pubblici.
- **Encryption at rest + enforced TLS by default** significa che sniffing/mitm è più difficile; servono credenziali valide o SSRF nel percorso VPC.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
