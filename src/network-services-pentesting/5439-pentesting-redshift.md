# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## 基本信息

此端口由 **Amazon Redshift** 使用（AWS 托管的数据仓库）。Redshift 的 wire 协议是对 **PostgreSQL** 协议的轻微修改，因此大多数 Postgres 客户端工具（psql、psycopg2、JDBC/ODBC）可用，但认证和 TLS 要求有所不同。

更多信息请查看：

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## 枚举与连接

- 默认端口：**5439/TCP**（可自定义）。Serverless 工作组也默认使用 5439。
- 公共端点模式：`<clusterid>.<random>.<region>.redshift.amazonaws.com`（公有）或 `.redshift.amazonaws.com.cn`（中国）。Serverless：`<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`。
- **TLS**：Redshift 要求 TLS 1.2+ 和 perfect-forward-secrecy 密码套件。旧客户端可能失败；强制使用现代 TLS：
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** 控制是否允许明文。新的集群/工作组使用 `default.redshift-2.0` 并设置 `require_ssl=true`，因此降级攻击/mitm 更困难。

### 使用 psql 的快速枚举
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
错误能区分密码错误与用户不存在 → 在暴力破解期间可能发生 **username enumeration**。

## Authentication paths to test

- **数据库密码**：用于 master user（通常名为 `awsuser`）或创建的 DB 用户。
- **IAM auth tokens**：生成短期凭证并通过 libpq/JDBC/ODBC 使用 `sslmode=require` 和 `authMech=IAM` 或 `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider` 连接。滥用被窃取的 IAM creds/roles，具有类似 `rds-db:connect` 的权限以访问 Redshift。
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**：JDBC `plugin_name` 可能启动本地 webserver 用于 SSO；捕获的 loopback 回调可能会 leak SAML assertion 或临时凭证。

## Common misconfigurations (network)

- 群集标记为 **PubliclyAccessible=true** 且安全组（SG）完全开放（0.0.0.0/0），会暴露类 Postgres 的攻击面，便于进行 brute force 或 SQLi 利用。
- **默认端口 5439** 加上默认 SG 使其易被发现（Shodan/Censys）。更改端口只是轻微的混淆，但在加固清单中有时会被忽视。
- **No enhanced VPC routing** → COPY/UNLOAD 会走公共 Internet；当攻击者控制 S3 bucket/endpoint 时可被滥用于 exfil。

## Attack notes

- 如果登录成功，Redshift 在 serverless 环境中没有 superuser；在 provisioned clusters 中，master user 拥有广泛权限，包括创建 UDFs (Python)、external schema 到 Spectrum、从攻击者控制的 S3 执行 COPY，以及使用 `UNLOAD` 将数据 exfil。
- 检查 cluster parameter group 中的 `max_concurrency_scaling_clusters`、`require_ssl`、`enable_user_activity_logging` —— 禁用日志有利于隐匿。
- Serverless workgroups 仍可通过 TCP 访问；与 provisioned clusters 具有相同的 SQL 攻击面。

## Recent security changes (offense impact)

- **Public access disabled by default**：在新的 clusters/snapshots 上默认禁用；遗留实例可能仍然是公开的。
- **Encryption at rest + enforced TLS by default** 意味着 sniffing/mitm 更难；需要有效凭证或通过 SSRF 进入 VPC 路径。

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
