# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Αυτό το port χρησιμοποιείται από **Amazon Redshift** (AWS managed data warehouse). Το Redshift wire protocol είναι μια ελαφρώς τροποποιημένη **PostgreSQL** υλοποίηση, οπότε τα περισσότερα Postgres client εργαλεία λειτουργούν (psql, psycopg2, JDBC/ODBC), αλλά οι απαιτήσεις auth και TLS διαφέρουν.

Για περισσότερες πληροφορίες δείτε:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeration & Connectivity

- Προεπιλεγμένη θύρα: **5439/TCP** (προσαρμόσιμη). Serverless workgroups επίσης έχουν προεπιλογή 5439.
- Πρότυπο δημόσιου endpoint: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) ή `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Το Redshift απαιτεί TLS 1.2+ και ciphers με perfect-forward-secrecy. Παλαιοί clients ενδέχεται να αποτύχουν· επιβάλετε σύγχρονο TLS:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** ελέγχει αν επιτρέπεται plaintext. Νέα clusters/workgroups χρησιμοποιούν `default.redshift-2.0` με `require_ssl=true`, οπότε downgrade/mitm είναι πιο δύσκολο.

### Quick enum with psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Τα σφάλματα διαχωρίζουν bad password από missing user → πιθανή **username enumeration** κατά τη διάρκεια brute force.

## Διαδρομές ελέγχου ταυτότητας προς δοκιμή

- **Database password** για τον master user (συνήθως ονομάζεται `awsuser`) ή τους δημιουργημένους DB users.
- **IAM auth tokens**: δημιουργήστε short-lived credentials και συνδεθείτε μέσω libpq/JDBC/ODBC χρησιμοποιώντας `sslmode=require` και `authMech=IAM` ή `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Κακοποιήστε κλεμμένα IAM creds/roles με permission τύπου `rds-db:connect` ισοδύναμο για Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: το JDBC `plugin_name` μπορεί να spin up τοπικό webserver για SSO· ένας captured loopback callback μπορεί να leak SAML assertion ή temp creds.

## Συνηθισμένες λανθασμένες διαμορφώσεις (network)

- Cluster με **PubliclyAccessible=true** και wide-open SG (0.0.0.0/0) εκθέτει επιφάνεια τύπου Postgres για brute force ή SQLi exploitation.
- **Default port 5439** και default SG επιτρέπουν εύκολη ανακάλυψη (Shodan/Censys). Η αλλαγή του port είναι μικρή ασφάλεια μέσω απόκρυψης αλλά μερικές φορές παραβλέπεται στις λίστες ελέγχου hardening.
- **No enhanced VPC routing** → COPY/UNLOAD πηγαίνουν μέσω public Internet· αυτό μπορεί να εκμεταλλευθεί για exfil όταν ο attacker ελέγχει S3 bucket/endpoint.

## Σημειώσεις επίθεσης

- Αν το login πετύχει, το Redshift δεν έχει superuser στο serverless· σε provisioned clusters ο master user έχει ευρείες δικαιοδοσίες, συμπεριλαμβανομένης της δημιουργίας UDFs (Python), external schema προς Spectrum, COPY από attacker S3, και `UNLOAD` για exfil δεδομένων.
- Ελέγξτε το cluster parameter group για `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – η απενεργοποίηση του logging διευκολύνει την απόκρυψη.
- Τα serverless workgroups εξακολουθούν να είναι προσβάσιμα μέσω TCP· η ίδια SQL attack surface όπως στα provisioned clusters.

## Πρόσφατες αλλαγές ασφαλείας (επίπτωση στην επίθεση)

- **Public access disabled by default** σε new clusters/snapshots· legacy ones μπορεί να είναι ακόμα public.
- **Encryption at rest + enforced TLS by default** σημαίνει ότι sniffing/mitm είναι πιο δύσκολο· χρειάζονται έγκυρα credentials ή SSRF για πρόσβαση στη VPC path.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
