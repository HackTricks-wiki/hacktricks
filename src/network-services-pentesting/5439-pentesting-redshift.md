# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Temel Bilgiler

This port is used by **Amazon Redshift** (AWS managed data warehouse). Redshift wire protocol is a slightly modified **PostgreSQL** protocol, so most Postgres client tooling works (psql, psycopg2, JDBC/ODBC) but auth and TLS requirements differ.

For more information check:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Enumeration & Connectivity

- Default port: **5439/TCP** (customizable). Serverless workgroups also default to 5439.
- Public endpoint pattern: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) or `.redshift.amazonaws.com.cn` (China). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift requires TLS 1.2+ and perfect-forward-secrecy ciphers. Old clients may fail; force modern TLS:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** controls if plaintext is allowed. New clusters/workgroups use `default.redshift-2.0` with `require_ssl=true`, so downgrade/mitm is harder.

### Quick enum with psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Hatalar yanlış parola ile kullanıcı yokluğu arasını ayırt ediyorsa → brute force sırasında potansiyel **username enumeration**.

## Doğrulama yolları (test edilecek)

- **Database password**: master kullanıcı için (çoğunlukla `awsuser`) veya oluşturulmuş DB kullanıcıları.
- **IAM auth tokens**: kısa ömürlü kimlik bilgileri oluşturun ve libpq/JDBC/ODBC aracılığıyla `sslmode=require` ve `authMech=IAM` veya `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider` kullanarak bağlanın. Çalınmış IAM kimlik bilgileri/rollerini Redshift için eşdeğer `rds-db:connect` tarzı izinle kötüye kullanın.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: JDBC `plugin_name` SSO için yerel bir webserver başlatabilir; yakalanan loopback callback SAML assertion veya temp creds'i leak edebilir.

## Yaygın yanlış yapılandırmalar (ağ)

- Küme **PubliclyAccessible=true** olarak işaretlenmiş ve geniş SG (0.0.0.0/0) ile Postgres-benzeri yüzeyi brute force veya SQLi istismarı için açığa çıkarır.
- **Varsayılan port 5439** ve varsayılan SG kolay keşif sağlar (Shodan/Censys). Portu değiştirmek küçük bir gizleme önlemidir fakat sertleştirme kontrollerinde bazen göz ardı edilir.
- **No enhanced VPC routing** → COPY/UNLOAD halk interneti üzerinden gider; saldırgan S3 bucket/endpoint kontrol ettiğinde exfil için kötüye kullanılabilir.

## Saldırı notları

- Giriş başarılı olursa, Redshift serverless'de superuser yoktur; provisioned cluster'larda master kullanıcı UDFs (Python) oluşturma, Spectrum'a external schema ekleme, saldırganın S3'ünden COPY yapma ve verileri exfil etmek için `UNLOAD` dahil geniş haklara sahiptir.
- `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` için cluster parameter group'u kontrol edin – logging'in kapalı olması gizlenmeye yardımcı olur.
- Serverless workgroups yine TCP üzerinden erişilebilir; provisioned cluster'larla aynı SQL saldırı yüzeyi vardır.

## Son güvenlik değişiklikleri (saldırı etkisi)

- Yeni cluster/snapshot'larda **Public access varsayılan olarak devre dışı** bırakıldı; eski olanlar hâlâ public olabilir.
- **Encryption at rest + varsayılan olarak zorunlu TLS** sniffing/mitm'i zorlaştırır; geçerli kimlik bilgileri veya VPC yoluna SSRF gerekir.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
