# 5439 - Pentesting Redshift

{{#include ../banners/hacktricks-training.md}}

## Базова інформація

Цей порт використовується **Amazon Redshift** (кероване AWS сховище даних). Redshift wire protocol — трохи модифікований протокол **PostgreSQL**, тому більшість клієнтських інструментів для Postgres (psql, psycopg2, JDBC/ODBC) працюють, але вимоги до auth та TLS відрізняються.

Для детальнішої інформації див.:

{{#ref}}
https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-services/aws-redshift-enum.html
{{#endref}}

## Перерахування та підключення

- Порт за замовчуванням: **5439/TCP** (можна налаштувати). Serverless workgroups також за замовчуванням використовують 5439.
- Публічний шаблон endpoint: `<clusterid>.<random>.<region>.redshift.amazonaws.com` (public) або `.redshift.amazonaws.com.cn` (Китай). Serverless: `<workgroup>.<random>.<region>.redshift-serverless.amazonaws.com`.
- **TLS**: Redshift вимагає TLS 1.2+ і шифри з perfect-forward-secrecy. Старі клієнти можуть не працювати; застосуйте сучасний TLS:
```bash
psql "host=<endpoint> port=5439 user=awsuser dbname=dev sslmode=require"
# or using redshift-psql wrapper
```
- **Parameter group `require_ssl`** керує тим, чи дозволено plaintext. Нові кластери/workgroups використовують `default.redshift-2.0` з `require_ssl=true`, тому downgrade/mitm складніше.

### Швидке перерахування з psql
```bash
# basic banner/version
psql "host=<endpoint> user=<u> dbname=dev" -c 'select version();'
# list dbs, users, privileges
\l
\du
select * from pg_user;
select * from svv_redshift_sessions;
```
Помилки відрізняють неправильний пароль від відсутності користувача → потенційна **username enumeration** під час brute force.

## Authentication paths to test

- **Пароль бази даних** для master user (часто з іменем `awsuser`) або створених DB користувачів.
- **IAM auth tokens**: згенерувати короткочасні облікові дані і підключитись через libpq/JDBC/ODBC використовуючи `sslmode=require` і `authMech=IAM` або `plugin_name=com.amazon.redshift.plugin.OktaCredentialsProvider`. Зловживати вкраденими IAM creds/roles з правом еквівалентним `rds-db:connect` для Redshift.
```bash
aws redshift get-cluster-credentials --cluster-identifier <id> \
--db-user pentest --db-name dev --duration-seconds 900
psql "host=<endpoint> user=pentest password=<token> dbname=dev sslmode=require"
```
- **IAM Identity Center / SAML / Azure AD plugins**: JDBC `plugin_name` може підняти локальний вебсервер для SSO; перехоплений loopback callback може leak SAML assertion або temp creds.

## Common misconfigurations (network)

- Кластер з **PubliclyAccessible=true** та відкритою SG (0.0.0.0/0) відкриває Postgres-like поверхню для brute force або SQLi експлуатації.
- **Default port 5439** плюс стандартна SG дозволяють легке виявлення (Shodan/Censys). Зміна порту — лише поверхова обфускація, але іноді її пропускають у чек-листах hardening.
- **No enhanced VPC routing** → COPY/UNLOAD йдуть через публічний Інтернет; це можна зловживати для exfil, коли атакуючий контролює S3 bucket/endpoint.

## Attack notes

- Якщо вхід вдається, Redshift позбавлений superuser в serverless; у provisioned кластерах master user має широкі права, включаючи створення UDFs (Python), external schema до Spectrum, COPY з attacker S3, та `UNLOAD` для exfil даних.
- Перевірте cluster parameter group на наявність `max_concurrency_scaling_clusters`, `require_ssl`, `enable_user_activity_logging` – відключене логування сприяє прихованості.
- Serverless workgroups все ще доступні через TCP; той самий SQL attack surface, що й у provisioned кластерах.

## Recent security changes (offense impact)

- **Public access disabled by default** на нових кластерах/snapshots; старі можуть досі бути public.
- **Encryption at rest + enforced TLS by default** означає, що sniffing/mitm складніше; потрібні валідні облікові дані або SSRF у VPC path.

## References

- [AWS Security Blog – Redshift enhances security defaults (public access off, require SSL, encryption) – Nov 2024](https://aws.amazon.com/blogs/security/amazon-redshift-enhances-security-by-changing-default-behavior-in-2025/)
- [AWS Docs – Options for providing IAM credentials (JDBC/ODBC IAM/SAML plugins)](https://docs.aws.amazon.com/redshift/latest/mgmt/options-for-providing-iam-credentials.html)

{{#include ../banners/hacktricks-training.md}}
