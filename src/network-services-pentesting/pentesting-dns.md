# 53 - Pentesting DNS

{{#include ../banners/hacktricks-training.md}}


## **Informations de base**

Le **système de noms de domaine (DNS)** sert de répertoire pour Internet, permettant aux utilisateurs d'accéder à des sites Web via des **noms de domaine faciles à retenir** comme google.com ou facebook.com, au lieu des adresses numériques de protocole Internet (IP). En traduisant les noms de domaine en adresses IP, le DNS garantit que les navigateurs Web peuvent charger rapidement les ressources Internet, simplifiant ainsi notre navigation dans le monde en ligne.

**Port par défaut :** 53
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Différents serveurs DNS

- **Serveurs racine DNS** : Ceux-ci se trouvent au sommet de la hiérarchie DNS, gérant les domaines de premier niveau et intervenant uniquement si les serveurs de niveau inférieur ne répondent pas. La Internet Corporation for Assigned Names and Numbers (**ICANN**) supervise leur fonctionnement, avec un nombre global de 13.
- **Serveurs de noms autoritaires** : Ces serveurs ont le dernier mot pour les requêtes dans leurs zones désignées, offrant des réponses définitives. S'ils ne peuvent pas fournir de réponse, la requête est escaladée vers les serveurs racine.
- **Serveurs de noms non autoritaires** : Ne possédant pas de zones DNS, ces serveurs rassemblent des informations sur les domaines par le biais de requêtes à d'autres serveurs.
- **Serveur DNS de mise en cache** : Ce type de serveur mémorise les réponses aux requêtes précédentes pendant un certain temps pour accélérer les temps de réponse pour les demandes futures, la durée du cache étant dictée par le serveur autoritaire.
- **Serveur de transfert** : Jouant un rôle simple, les serveurs de transfert relaient simplement les requêtes à un autre serveur.
- **Résolveur** : Intégré dans les ordinateurs ou les routeurs, les résolveurs exécutent la résolution de noms localement et ne sont pas considérés comme autoritaires.

## Énumération

### **Récupération de bannières**

Il n'y a pas de bannières dans DNS mais vous pouvez récupérer la requête magique pour `version.bind. CHAOS TXT` qui fonctionnera sur la plupart des serveurs de noms BIND.\
Vous pouvez effectuer cette requête en utilisant `dig` :
```bash
dig version.bind CHAOS TXT @DNS
```
De plus, l'outil [`fpdns`](https://github.com/kirei/fpdns) peut également identifier le serveur.

Il est également possible de récupérer la bannière avec un script **nmap** :
```
--script dns-nsid
```
### **Tout enregistrement**

L'enregistrement **ANY** demandera au serveur DNS de **retourner** toutes les **entrées** disponibles qu'il **est prêt à divulguer**.
```bash
dig any victim.com @<DNS_IP>
```
### **Transfert de Zone**

Cette procédure est abrégée `Asynchronous Full Transfer Zone` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
### Plus d'infos
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Automatisation
```bash
for sub in $(cat <WORDLIST>);do dig $sub.<DOMAIN> @<DNS_IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver <DNS_IP> --enum -p 0 -s 0 -o subdomains.txt -f <WORDLIST> <DOMAIN>
```
#### Utilisation de nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### Modules Metasploit Utiles
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Scripts nmap utiles
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Reverse BF
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
> [!NOTE]
> Si vous parvenez à trouver des sous-domaines résolvant des adresses IP internes, vous devriez essayer d'effectuer un BF DNS inverse vers les NS du domaine demandant cette plage d'IP.

Un autre outil pour cela : [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Vous pouvez interroger des plages d'IP inverses à [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#_dns) (cet outil est également utile avec BGP).

### DNS - BF des sous-domaines
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Serveurs Active Directory
```bash
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com

nslookup -type=srv _kerberos._tcp.<CLIENT_DOMAIN>
nslookup -type=srv _kerberos._tcp.domain.com

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec
```bash
#Query paypal subdomains to ns3.isc-sns.info
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Force brute en utilisant des requêtes "AAAA" pour rassembler l'IPv6 des sous-domaines.
```bash
dnsdict6 -s -t <domain>
```
Bruteforce de DNS inverse en utilisant des adresses IPv6
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### DNS Recursion DDoS

Si **la récursion DNS est activée**, un attaquant pourrait **usurper** l'**origine** dans le paquet UDP afin de faire en sorte que le **DNS envoie la réponse au serveur victime**. Un attaquant pourrait abuser des types d'enregistrements **ANY** ou **DNSSEC** car ils ont tendance à avoir des réponses plus volumineuses.\
La façon de **vérifier** si un DNS prend en charge la **récursion** est de interroger un nom de domaine et de **vérifier** si le **drapeau "ra"** (_récursion disponible_) est dans la réponse :
```bash
dig google.com A @<IP>
```
**Non disponible**:

![](<../images/image (123).png>)

**Disponible**:

![](<../images/image (146).png>)


### Mail à un compte inexistant

**Envoyer un email à une adresse inexistante** en utilisant le domaine de la victime pourrait déclencher l'envoi d'une notification de non-livraison (NDN) dont les **en-têtes** pourraient contenir des informations intéressantes telles que le **nom des serveurs internes et les adresses IP**.

## Post-Exploitation

- Lors de la vérification de la configuration d'un serveur Bind, vérifiez la configuration du paramètre **`allow-transfer`** car il indique qui peut effectuer des transferts de zone et **`allow-recursion`** et **`allow-query`** car ils indiquent qui peut envoyer des requêtes récursives et des requêtes à celui-ci.
- Les noms des fichiers liés au DNS qui pourraient être intéressants à rechercher sur les machines sont :
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
## Références

- [https://www.myrasecurity.com/en/knowledge-hub/dns/](https://www.myrasecurity.com/en/knowledge-hub/dns/)
- Livre : **Network Security Assessment 3rd edition**

## Commandes Automatiques HackTricks
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for DNS
Note: |
#These are the commands I run every time I see an open DNS port

dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
dig axfr @{IP}
dig axfr {Domain_Name} @{IP}
nslookup
SERVER {IP}
127.0.0.1
{IP}
Domain_Name
exit

https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
Name: Banner Grab
Description: Grab DNS Banner
Command: dig version.bind CHAOS TXT @DNS

Entry_3:
Name: Nmap Vuln Scan
Description: Scan for Vulnerabilities with Nmap
Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
Name: Zone Transfer
Description: Three attempts at forcing a zone transfer
Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
Name: Active Directory
Description: Eunuerate a DC via DNS
Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"

Entry_6:
Name: consolesless mfs enumeration
Description: DNS enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit'
```
{{#include ../banners/hacktricks-training.md}}
