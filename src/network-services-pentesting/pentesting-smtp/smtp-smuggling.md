# SMTP Smuggling

{{#include ../../banners/hacktricks-training.md}}

## मूल जानकारी

This type of vulnerability was [**originally discovered in this post**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) were it's explained that It's possible to **exploit discrepancies in how the SMTP protocol is interpreted** when finalising an email, allowing an attacker to smuggle more emails in the body of the legit one, allowing to impersonate other users of the affected domain (such as admin@outlook.com) bypassing defenses such as SPF.

### क्यों

यह इसलिए संभव है क्योंकि SMTP प्रोटोकॉल में भेजे जाने वाले संदेश का DATA उपयोगकर्ता (attacker) द्वारा नियंत्रित होता है, जो पार्सरों के बीच अंतर का दुरुपयोग करके वैध ईमेल के बॉडी में अतिरिक्त ईमेल्स smuggle कर सकता है। मूल पोस्ट का यह चित्रित उदाहरण देखें:

<figure><img src="../../images/image (8) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### कैसे

इस भेद्यता का फायदा उठाने के लिए attacker को ऐसा डेटा भेजना पड़ता है जिसे **Outbound SMTP server यह समझे कि यह केवल 1 ईमेल है पर Inbound SMTP server यह समझे कि यह कई ईमेल हैं**।

शोधकर्ताओं ने खोजा कि अलग‑अलग Inbound servers किसी ईमेल संदेश के DATA के अंत के लिए अलग पात्रों/सीक्वेंस को मानते हैं जो Outbound servers मानते नहीं हैं।\
उदाहरण के लिए, सामान्य end‑of‑DATA `\r\n.\r` है। लेकिन अगर Inbound SMTP server `\n.` भी सपोर्ट करता है, तो attacker अपने ईमेल में बस वह डेटा जोड़ कर नए SMTP कमांड्स को शुरू कर सकता है और आगे के ईमेल smuggle कर सकता है, जैसा ऊपर के चित्र में दिखाया गया है।

बेशक, यह तभी काम करेगा जब **Outbound SMTP server भी इस डेटा को संदेश के अंत के रूप में न माने**, क्योंकि उस स्थिति में वह 1 के बजाय 2 ईमेल देख लेगा — अंततः यही desynchronization इस भेद्यता में दुरुपयोग की जा रही है।

संभावित desynchronization डेटा:

- `\n.`
- `\n.\r`

ध्यान दें कि SPF को bypass इसलिए किया जा सकता है क्योंकि यदि आप `user@outlook.com` के ईमेल से `admin@outlook.com` जैसा ईमेल smuggle करते हैं, तो **sender अभी भी `outlook.com` ही रहता है।**

---

## Attacker’s checklist (what conditions must hold?)

सफलतापूर्वक दूसरा ईमेल smuggle करने के लिए सामान्यतः निम्न होना चाहिए:

- एक outbound server A जिसके माध्यम से आप भेज सकें (अक्सर मान्य creds के साथ) जो non‑standard end‑of‑DATA सीक्वेंस को बिना बदले आगे फॉरवर्ड करे। कई सर्विसेज ने ऐतिहासिक रूप से `\n.\r\n` या `\n.\n` जैसे वैरिएंट फॉरवर्ड किए हैं।
- एक receiving server B जो उस non‑standard सीक्वेंस को end‑of‑DATA के रूप में व्याख्यायित करे और इसके बाद जो कुछ भी आए उसे नए SMTP कमांड्स (MAIL/RCPT/DATA...) के रूप में पार्स करे।
- Outbound को वास्तविक रूप से `DATA` के साथ भेजना चाहिए (not `BDAT`)। अगर A CHUNKING/BDAT सपोर्ट करता है, तो smuggling तभी काम करेगा जब वह DATA पर fallback करे (उदाहरण के लिए, अगर B CHUNKING advertise नहीं करता), अन्यथा length‑framed BDAT अस्पष्टता को रोकता है।
- PIPELINING आवश्यक नहीं है पर यह injected कमांड्स को एक ही TCP write में छुपाने में मदद करता है ताकि intermediate devices resynchronize न कर सकें।

प्राप्तकर्ता पर निर्भर सामान्य end‑of‑DATA वैरिएंट्स जिन्हें टेस्ट करना चाहिए:

- `\n.\n`
- `\n.\r\n`
- `\r.\r\n`
- `\r\n.\r` (bare CR at end)

नोट: जो काम करता है वह "what A forwards" ∩ "what B accepts" का intersection है।

---

## Manual exploitation example (single session)

The following shows the idea using a raw STARTTLS SMTP session. After the first DATA block we insert a non‑standard terminator, then another SMTP dialog that the receiving server may treat as a new message.

<details>
<summary>Manual smuggling session (STARTTLS)</summary>
```
$ openssl s_client -starttls smtp -crlf -connect smtp.example.com:587
EHLO a.example
AUTH PLAIN <base64(\0user@example.com\0password)>
MAIL FROM:<user@example.com>
RCPT TO:<victim@target.com>
DATA
From: User <user@example.com>
To: victim <victim@target.com>
Subject: legit

hello A
\n.\r\nMAIL FROM:<admin@target.com>
RCPT TO:<victim@target.com>
DATA
From: Admin <admin@target.com>
To: victim <victim@target.com>
Subject: smuggled

hello B
\r\n.\r\n
```
If A forwards `\n.\r\n` and B accepts it as end‑of‑DATA, message “hello B” may be accepted as a second email from `admin@target.com` while passing SPF (aligned with A’s IPs).
</details>

Tip: When testing interactively, ensure `-crlf` is used so OpenSSL preserves CRLF in what you type.

---

## ऑटोमेशन और स्कैनर्स

- hannob/smtpsmug: एक संदेश भेजता है जो कई malformed end‑of‑DATA sequences के साथ समाप्त होता है ताकि देखा जा सके कि रिसीवर क्या स्वीकार करता है।
- Example: `./smtpsmug -s mail.target.com -p 25 -t victim@target.com`
- The‑Login/SMTP‑Smuggling‑Tools: inbound और outbound दोनों तरफ के लिए scanner और साथ ही एक analysis SMTP server ताकि आप ठीक‑ठीक देख सकें कौन‑सी sequences sender से बचकर निकलती हैं।
- Inbound quick check: `python3 smtp_smuggling_scanner.py victim@target.com`
- Outbound via a relay: `python3 smtp_smuggling_scanner.py YOUR@ANALYSIS.DOMAIN --outbound-smtp-server smtp.relay.com --port 587 --starttls --sender-address you@relay.com --username you@relay.com --password '...'
`

ये tools आपको उन A→B जोड़ों का मैप बनाने में मदद करते हैं जहाँ smuggling वास्तव में काम करता है।

---

## CHUNKING/BDAT vs DATA

- DATA uses a sentinel terminator `<CR><LF>.<CR><LF>`; any ambiguity in how CR/LF are normalized or dot‑stuffed leads to desync.
- CHUNKING (BDAT) frames the body with an exact byte length and therefore prevents classic smuggling. However, if the sender falls back to DATA (because the receiver doesn’t advertise CHUNKING), classic smuggling becomes possible again.

---

## प्रभावित सॉफ़्टवेयर और फिक्स के नोट्स (टार्गेटिंग के लिए)

- Postfix: prior to 3.9 the default tolerated bare LFs; from 3.5.23/3.6.13/3.7.9/3.8.4 admins can enable `smtpd_forbid_bare_newline`. Current recommendation is `smtpd_forbid_bare_newline = normalize` (3.8.5+/3.7.10+/3.6.14+/3.5.24+) or set to `reject` for strict RFC enforcement.
- Exim: fixed in 4.97.1 (and later) for variants relying on mixed end‑of‑DATA sequences when DATA is used. Older 4.97/4.96 may be exploitable depending on PIPELINING/CHUNKING.
- Sendmail: fixed in 8.18; older 8.17.x accepted some non‑standard terminators.
- Various libraries/servers (e.g., aiosmtpd before 1.4.5, some vendor gateways, and specific SaaS relays) had similar issues; modern versions tend to accept DATA only with strict `<CR><LF>.<CR><LF>`.

ऊपर दिए स्कैनर्स का उपयोग करके वर्तमान व्यवहार सत्यापित करें; कई vendors ने early 2024–2025 में defaults बदल दिए हैं।

---

## Red team ops के लिए टिप्स

- Favor large commodity senders for A (historically Exchange Online, shared hosters, etc.). If they still forward some non‑standard EOM and they’re in the victim’s SPF, your smuggled MAIL FROM will inherit their reputation.
- Enumerate B’s SMTP extensions: `EHLO` banner for PIPELINING/CHUNKING; if CHUNKING is missing you have a better chance from BDAT‑first senders. Combine with malformed EOMs to probe acceptance.
- Watch headers: the smuggled message will usually create a separate Received chain starting at B. DMARC will often pass because MAIL FROM aligns with A’s IP space.

---

## **संदर्भ**

- [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)
- [https://www.postfix.org/smtp-smuggling.html](https://www.postfix.org/smtp-smuggling.html)

{{#include ../../banners/hacktricks-training.md}}
