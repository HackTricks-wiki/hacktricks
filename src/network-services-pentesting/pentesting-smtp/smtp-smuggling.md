# SMTP Smuggling

{{#include ../../banners/hacktricks-training.md}}

## Basiese Inligting

This type of vulnerability was [**originally discovered in this post**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) were it's explained that It's possible to **exploit discrepancies in how the SMTP protocol is interpreted** when finalising an email, allowing an attacker to smuggle more emails in the body of the legit one, allowing to impersonate other users of the affected domain (such as admin@outlook.com) bypassing defenses such as SPF.

### Waarom

Dit gebeur omdat in die SMTP‑protokol die **data of the message** wat in die e‑pos gestuur word deur ’n gebruiker (aanvaller) beheer word, wat spesiaal saamgestelde data kan stuur wat verskille in parsers misbruik en ekstra e‑posse in die ontvanger kan insmokkel. Kyk na hierdie geïllustreerde voorbeeld uit die original post:

<figure><img src="../../images/image (8) (1) (1) (1) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### Hoe

Om hierdie kwesbaarheid uit te buit, moet ’n aanvaller data stuur wat die Outbound SMTP server as net 1 email beskou, maar die Inbound SMTP server as verskeie emails beskou.

Die navorsers het ontdek dat verskillende Inbound servers verskillende karakters as die einde van die data van die e‑posboodskap beskou wat Outbound servers nie doen nie.\
Byvoorbeeld, ’n gereelde einde van die data is `\r\n.\r`. Maar as die Inbound SMTP server ook `\n.` ondersteun, kan ’n aanvaller eenvoudig daardie data in sy e‑pos voeg en dan begin om die SMTP‑opdragte van ’n nuwe boodskap aan te dui om dit te insmokkel, soos in die vorige beeld.

Natuurlik sal dit slegs werk as die Outbound SMTP server hierdie data nie ook as die einde van die boodskapdata behandel nie, want in daardie geval sal dit 2 e‑posse sien in plaas van net 1 — dit is dus die desinchronisasie wat in hierdie kwesbaarheid misbruik word.

Potential desynchronization data:

- `\n.`
- `\n.\r`

Neem ook kennis dat SPF omseil word omdat as jy ’n e‑pos insmokkel van `admin@outlook.com` vanuit ’n e‑pos van `user@outlook.com`, **the sender is still `outlook.com`.**

---

## Aanvaller se kontrolelys (watter voorwaardes moet waar wees?)

Om suksesvol ’n tweede e‑pos in te smokkel, benodig jy tipies:

- ’n Outbound server A waardeur jy kan stuur (dikwels met geldige creds) wat ’n nie‑standaard einde‑van‑DATA‑volgorde onveranderd sal deurstuur. Baie dienste het histories variante soos `\n.\r\n` of `\n.\n` deurgestuur.
- ’n Ontvangende server B wat daardie nie‑standaard volgorde as end‑of‑DATA sal interpreteer en dan wat ook al volg as nuwe SMTP‑opdragte (MAIL/RCPT/DATA...) sal parse.
- Outbound moet werklik met `DATA` stuur (nie `BDAT` nie). As A CHUNKING/BDAT ondersteun, werk insmokkel slegs as dit terugval na DATA (bv. B adverteer nie CHUNKING nie); anders voorkom lengte‑geframed BDAT onsekerheid.
- PIPELINING is nie verpligtend nie maar help om die ingespuite opdragte te verberg in ’n enkele TCP‑skrywe sodat intermediêre toestelle nie resynchroniseer nie.

Algemene end‑of‑DATA variante wat die moeite werd is om te toets (ontvanger‑afhanklik):

- `\n.\n`
- `\n.\r\n`
- `\r.\r\n`
- `\r\n.\r` (bare CR aan die einde)

Nota: Wat werk is die snit van “what A forwards” ∩ “what B accepts”.

---

## Handmatige uitbuiting voorbeeld (enkele sessie)

Die volgende wys die idee deur ’n rou STARTTLS SMTP‑sessie te gebruik. Na die eerste DATA‑blok voeg ons ’n nie‑standaard terminator in, en dan ’n ander SMTP‑dialoog wat die ontvangende server as ’n nuwe boodskap mag beskou.

<details>
<summary>Manual smuggling session (STARTTLS)</summary>
```
$ openssl s_client -starttls smtp -crlf -connect smtp.example.com:587
EHLO a.example
AUTH PLAIN <base64(\0user@example.com\0password)>
MAIL FROM:<user@example.com>
RCPT TO:<victim@target.com>
DATA
From: User <user@example.com>
To: victim <victim@target.com>
Subject: legit

hello A
\n.\r\nMAIL FROM:<admin@target.com>
RCPT TO:<victim@target.com>
DATA
From: Admin <admin@target.com>
To: victim <victim@target.com>
Subject: smuggled

hello B
\r\n.\r\n
```
</details>

Wenk: Wanneer jy interaktief toets, maak seker `-crlf` gebruik word sodat OpenSSL CRLF in wat jy tik bewaar.

---

## Automation en skandeerders

- hannob/smtpsmug: stuur 'n boodskap wat eindig met meerdere verkeerd geformatteerde end‑of‑DATA‑sekwense om te sien wat 'n ontvanger aanvaar.
- Example: `./smtpsmug -s mail.target.com -p 25 -t victim@target.com`
- The‑Login/SMTP‑Smuggling‑Tools: skandeerder vir beide inkomende en uitgaande kante plus 'n analise SMTP‑bediener om presies te sien watter sekwense 'n sender oorleef.
- Inkomende vinnige kontrole: `python3 smtp_smuggling_scanner.py victim@target.com`
- Uitgaande via 'n relay: `python3 smtp_smuggling_scanner.py YOUR@ANALYSIS.DOMAIN --outbound-smtp-server smtp.relay.com --port 587 --starttls --sender-address you@relay.com --username you@relay.com --password '...'
`

Hierdie gereedskap help jou om die A→B‑pare te karteer waar smuggling werklik werk.

---

## CHUNKING/BDAT vs DATA

- DATA gebruik 'n sentinel‑terminator `<CR><LF>.<CR><LF>`; enige onsekerheid oor hoe CR/LF genormaliseer of dot‑stuffed word, lei tot desinchronisasie.
- CHUNKING (BDAT) raam die liggaam met 'n presiese byte‑lengte en voorkom dus klassieke smuggling. As die sender egter terugval op DATA (omdat die ontvanger CHUNKING nie adverteer nie), raak klassieke smuggling weer moontlik.

---

## Aantekeninge oor geraakte sagteware en fiksings (vir teiken)

- Postfix: voor 3.9 het die verstek bare LFs toegelaat; vanaf 3.5.23/3.6.13/3.7.9/3.8.4 kan admins `smtpd_forbid_bare_newline` inskakel. Die huidige aanbeveling is `smtpd_forbid_bare_newline = normalize` (3.8.5+/3.7.10+/3.6.14+/3.5.24+) of stel dit op `reject` vir streng RFC‑afdwinging.
- Exim: reggemaak in 4.97.1 (en later) vir variante wat staatmaak op gemengde end‑of‑DATA‑sekwense wanneer DATA gebruik word. Ouer 4.97/4.96 kan moontlik uitbuitbaar wees, afhangend van PIPELINING/CHUNKING.
- Sendmail: reggemaak in 8.18; ouer 8.17.x het sommige nie‑standaard terminators aanvaar.
- Verskeie biblioteke/bedieners (bv. aiosmtpd before 1.4.5, sommige vendor gateways, en spesifieke SaaS relays) het soortgelyke probleme gehad; moderne weergawes neig om DATA slegs met streng `<CR><LF>.<CR><LF>` te aanvaar.

Gebruik die bogenoemde skandeerders om huidige gedrag te verifieer; baie verskaffers het standaardinstellings in vroeë 2024–2025 verander.

---

## Wenke vir red team‑ops

- Gee voorkeur aan groot kommersiële senders vir A (histories Exchange Online, gedeelde hosters, ens.). As hulle steeds sommige nie‑standaard EOM deurstuur en hulle is in die slagoffer se SPF, sal jou gesmuggelde MAIL FROM hul reputasie erf.
- Maak 'n lys van B se SMTP‑uitbreidings: `EHLO`‑banner vir PIPELINING/CHUNKING; as CHUNKING ontbreek het jy 'n beter kans met BDAT‑first senders. Kombineer dit met verkeerd geformateerde EOM's om aanneming te toets.
- Let op headers: die gesmuggelde boodskap sal gewoonlik 'n aparte Received‑ketting vanaf B skep. DMARC sal dikwels slaag omdat MAIL FROM uitgelyn is met A se IP‑ruimte.

---

## **Verwysings**

- [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)
- [https://www.postfix.org/smtp-smuggling.html](https://www.postfix.org/smtp-smuggling.html)

{{#include ../../banners/hacktricks-training.md}}
