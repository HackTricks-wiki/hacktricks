# Unicode Injection

{{#include ../../banners/hacktricks-training.md}}

## Wprowadzenie

W zaleÅ¼noÅ›ci od tego, jak zachowuje siÄ™ back-end/front-end, gdy **otrzymuje dziwne znaki unicode**, atakujÄ…cy moÅ¼e byÄ‡ w stanie **obejÅ›Ä‡ zabezpieczenia i wstrzyknÄ…Ä‡ dowolne znaki**, ktÃ³re mogÄ… byÄ‡ uÅ¼yte do **wykorzystania luk w wstrzykiwaniu**, takich jak XSS czy SQLi.

## Normalizacja Unicode

Normalizacja Unicode zachodzi, gdy **znaki unicode sÄ… normalizowane do znakÃ³w ascii**.

Jednym z powszechnych scenariuszy tego typu luki jest sytuacja, gdy system **modyfikuje** w jakiÅ› sposÃ³b **wejÅ›cie** uÅ¼ytkownika **po jego sprawdzeniu**. Na przykÅ‚ad, w niektÃ³rych jÄ™zykach proste wywoÅ‚anie do zamiany **wejÅ›cia na wielkie lub maÅ‚e litery** moÅ¼e znormalizowaÄ‡ dane wejÅ›ciowe, a **unicode zostanie przeksztaÅ‚cone na ASCII**, generujÄ…c nowe znaki.\
Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº:

{{#ref}}
unicode-normalization.md
{{#endref}}

## `\u` do `%`

Znaki unicode sÄ… zazwyczaj reprezentowane z **prefiksem `\u`**. Na przykÅ‚ad znak `ã±‹` to `\u3c4b`([sprawdÅº to tutaj](https://unicode-explorer.com/c/3c4B)). JeÅ›li backend **przeksztaÅ‚ca** prefiks **`\u` na `%`**, wynikowy ciÄ…g bÄ™dzie `%3c4b`, ktÃ³ry po dekodowaniu URL to: **`<4b`**. I, jak widaÄ‡, **znak ` < ` jest wstrzykiwany**.\
MoÅ¼esz uÅ¼yÄ‡ tej techniki do **wstrzykiwania dowolnego rodzaju znaku**, jeÅ›li backend jest podatny.\
SprawdÅº [https://unicode-explorer.com/](https://unicode-explorer.com/), aby znaleÅºÄ‡ potrzebne znaki.

Ta luka pochodzi z rzeczywistej luki, ktÃ³rÄ… odkryÅ‚ badacz, aby uzyskaÄ‡ bardziej szczegÃ³Å‚owe wyjaÅ›nienie, sprawdÅº [https://www.youtube.com/watch?v=aUsAHb0E7Cg](https://www.youtube.com/watch?v=aUsAHb0E7Cg)

## Wstrzykiwanie Emoji

Back-endy zachowujÄ… siÄ™ dziwnie, gdy **otrzymujÄ… emoji**. Tak byÅ‚o w [**tym opisie**](https://medium.com/@fpatrik/how-i-found-an-xss-vulnerability-via-using-emojis-7ad72de49209), gdzie badacz zdoÅ‚aÅ‚ osiÄ…gnÄ…Ä‡ XSS z Å‚adunkiem takim jak: `ğŸ’‹img src=x onerror=alert(document.domain)//ğŸ’›`

W tym przypadku bÅ‚Ä…d polegaÅ‚ na tym, Å¼e serwer po usuniÄ™ciu zÅ‚oÅ›liwych znakÃ³w **przekonwertowaÅ‚ ciÄ…g UTF-8 z Windows-1252 na UTF-8** (w zasadzie kodowanie wejÅ›ciowe i konwersja kodowania byÅ‚y niezgodne). Wtedy to nie daje poprawnego <, tylko dziwne unicode: `â€¹`\
``WiÄ™c wziÄ™li ten wynik i **przekonwertowali ponownie z UTF-8 na ASCII**. To **znormalizowaÅ‚o** `â€¹` do ` < `, w ten sposÃ³b exploit mÃ³gÅ‚ dziaÅ‚aÄ‡ w tym systemie.\
To, co siÄ™ wydarzyÅ‚o:
```php
<?php

$str = isset($_GET["str"]) ? htmlspecialchars($_GET["str"]) : "";

$str = iconv("Windows-1252", "UTF-8", $str);
$str = iconv("UTF-8", "ASCII//TRANSLIT", $str);

echo "String: " . $str;
```
Emoji lists:

- [https://github.com/iorch/jakaton_feminicidios/blob/master/data/emojis.csv](https://github.com/iorch/jakaton_feminicidios/blob/master/data/emojis.csv)
- [https://unicode.org/emoji/charts-14.0/full-emoji-list.html](https://unicode.org/emoji/charts-14.0/full-emoji-list.html)

## Windows Best-Fit/Worst-fit

Jak wyjaÅ›niono w **[tym Å›wietnym poÅ›cie](https://blog.orange.tw/posts/2025-01-worstfit-unveiling-hidden-transformers-in-windows-ansi/)**, Windows ma funkcjÄ™ nazwanÄ… **Best-Fit**, ktÃ³ra **zastÄ™puje znaki unicode**, ktÃ³re nie mogÄ… byÄ‡ wyÅ›wietlane w trybie ASCII, podobnym znakiem. MoÅ¼e to prowadziÄ‡ do **nieoczekiwanego zachowania**, gdy backend **oczekuje konkretnego znaku**, ale otrzymuje inny.

MoÅ¼na znaleÅºÄ‡ znaki best-fit w **[https://worst.fit/mapping/](https://worst.fit/mapping/)**.

PoniewaÅ¼ Windows zazwyczaj konwertuje ciÄ…gi unicode na ciÄ…gi ascii jako jednÄ… z ostatnich czÄ™Å›ci wykonania (zwykle przechodzÄ…c z API z sufiksem "W" do API z sufiksem "A", jak `GetEnvironmentVariableA` i `GetEnvironmentVariableW`), pozwala to atakujÄ…cym na obejÅ›cie zabezpieczeÅ„, wysyÅ‚ajÄ…c znaki unicode, ktÃ³re zostanÄ… ostatecznie przeksztaÅ‚cone w znaki ASCII, ktÃ³re wykonajÄ… nieoczekiwane dziaÅ‚ania.

W poÅ›cie na blogu zaproponowano metody obejÅ›cia luk, ktÃ³re zostaÅ‚y naprawione przy uÅ¼yciu **czarnej listy znakÃ³w**, wykorzystujÄ…c **przechodzenie Å›cieÅ¼ek** przy uÅ¼yciu [znakÃ³w mapowanych na â€œ/â€œ (0x2F)](https://worst.fit/mapping/#to%3A0x2f) i [znakÃ³w mapowanych na â€œ\â€œ (0x5C)](https://worst.fit/mapping/#to%3A0x5c) lub nawet obejÅ›cie zabezpieczeÅ„ przed ucieczkÄ… powÅ‚oki, takich jak `escapeshellarg` w PHP lub `subprocess.run` w Pythonie, uÅ¼ywajÄ…c listy; zrobiono to na przykÅ‚ad, uÅ¼ywajÄ…c **peÅ‚nozakresowych podwÃ³jnych cudzysÅ‚owÃ³w (U+FF02)** zamiast podwÃ³jnych cudzysÅ‚owÃ³w, wiÄ™c na koÅ„cu to, co wyglÄ…daÅ‚o jak 1 argument, zostaÅ‚o przeksztaÅ‚cone w 2 argumenty.

**ZauwaÅ¼, Å¼e aby aplikacja byÅ‚a podatna, musi uÅ¼ywaÄ‡ "W" Windows API, ale koÅ„czyÄ‡ wywoÅ‚ujÄ…c "A" Windows API, aby utworzyÄ‡ "Best-fit" ciÄ…gu unicode.**

**Wiele odkrytych luk nie zostanie naprawionych, poniewaÅ¼ ludzie nie zgadzajÄ… siÄ™, kto powinien zajÄ…Ä‡ siÄ™ tym problemem.**

{{#include ../../banners/hacktricks-training.md}}
