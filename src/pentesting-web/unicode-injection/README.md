# Injection Unicode

{{#include ../../banners/hacktricks-training.md}}

## Introduction

Selon le comportement du back-end/front-end lorsqu'il **re√ßoit des caract√®res unicode √©tranges**, un attaquant pourrait √™tre en mesure de **contourner les protections et d'injecter des caract√®res arbitraires** qui pourraient √™tre utilis√©s pour **exploiter des vuln√©rabilit√©s d'injection** telles que XSS ou SQLi.

## Normalisation Unicode

La normalisation Unicode se produit lorsque **les caract√®res unicode sont normalis√©s en caract√®res ascii**.

Un sc√©nario courant de ce type de vuln√©rabilit√© se produit lorsque le syst√®me **modifie** d'une mani√®re ou d'une autre l'**entr√©e** de l'utilisateur **apr√®s l'avoir v√©rifi√©e**. Par exemple, dans certaines langues, un simple appel pour mettre l'**entr√©e en majuscules ou en minuscules** pourrait normaliser l'entr√©e donn√©e et le **unicode sera transform√© en ASCII**, g√©n√©rant de nouveaux caract√®res.\
Pour plus d'infos, consultez :

{{#ref}}
unicode-normalization.md
{{#endref}}

## `\u` √† `%`

Les caract√®res Unicode sont g√©n√©ralement repr√©sent√©s avec le **pr√©fixe `\u`**. Par exemple, le caract√®re `„±ã` est `\u3c4b`([v√©rifiez-le ici](https://unicode-explorer.com/c/3c4B)). Si un backend **transforme** le pr√©fixe **`\u` en `%`**, la cha√Æne r√©sultante sera `%3c4b`, qui d√©cod√©e URL est : **`<4b`**. Et, comme vous pouvez le voir, un **caract√®re `<` est inject√©**.\
Vous pourriez utiliser cette technique pour **injecter n'importe quel type de caract√®re** si le backend est vuln√©rable.\
Consultez [https://unicode-explorer.com/](https://unicode-explorer.com/) pour trouver les caract√®res dont vous avez besoin.

Cette vuln√©rabilit√© provient en fait d'une vuln√©rabilit√© qu'un chercheur a trouv√©e, pour une explication plus approfondie, consultez [https://www.youtube.com/watch?v=aUsAHb0E7Cg](https://www.youtube.com/watch?v=aUsAHb0E7Cg)

## Injection d'√âmojis

Les back-ends se comportent parfois de mani√®re √©trange lorsqu'ils **re√ßoivent des √©mojis**. C'est ce qui s'est pass√© dans [**ce rapport**](https://medium.com/@fpatrik/how-i-found-an-xss-vulnerability-via-using-emojis-7ad72de49209) o√π le chercheur a r√©ussi √† obtenir un XSS avec une charge utile telle que : `üíãimg src=x onerror=alert(document.domain)//üíõ`

Dans ce cas, l'erreur √©tait que le serveur, apr√®s avoir supprim√© les caract√®res malveillants, **a converti la cha√Æne UTF-8 de Windows-1252 √† UTF-8** (essentiellement, l'encodage d'entr√©e et la conversion d'encodage √©taient incompatibles). Cela ne donne pas un < correct, juste un unicode √©trange : `‚Äπ`\
``Ils ont donc pris cette sortie et **convertie √† nouveau maintenant de UTF-8 √† ASCII**. Cela a **normalis√©** le `‚Äπ` en `<`, c'est ainsi que l'exploit a pu fonctionner sur ce syst√®me.\
Voici ce qui s'est pass√© :
```php
<?php

$str = isset($_GET["str"]) ? htmlspecialchars($_GET["str"]) : "";

$str = iconv("Windows-1252", "UTF-8", $str);
$str = iconv("UTF-8", "ASCII//TRANSLIT", $str);

echo "String: " . $str;
```
Emoji lists:

- [https://github.com/iorch/jakaton_feminicidios/blob/master/data/emojis.csv](https://github.com/iorch/jakaton_feminicidios/blob/master/data/emojis.csv)
- [https://unicode.org/emoji/charts-14.0/full-emoji-list.html](https://unicode.org/emoji/charts-14.0/full-emoji-list.html)

## Windows Best-Fit/Worst-fit

Comme expliqu√© dans **[ce super article](https://blog.orange.tw/posts/2025-01-worstfit-unveiling-hidden-transformers-in-windows-ansi/)**, Windows a une fonctionnalit√© appel√©e **Best-Fit** qui va **remplacer les caract√®res unicode** qui ne peuvent pas √™tre affich√©s en mode ASCII par un caract√®re similaire. Cela peut entra√Æner un **comportement inattendu** lorsque le backend **s'attend √† un caract√®re sp√©cifique** mais re√ßoit un caract√®re diff√©rent.

Il est possible de trouver des caract√®res best-fit dans **[https://worst.fit/mapping/](https://worst.fit/mapping/)**.

Comme Windows convertit g√©n√©ralement les cha√Ænes unicode en cha√Ænes ascii comme l'une des derni√®res parties de l'ex√©cution (passant g√©n√©ralement d'une API suffix√©e par "W" √† une API suffix√©e par "A" comme `GetEnvironmentVariableA` et `GetEnvironmentVariableW`), cela permettrait aux attaquants de contourner les protections en envoyant des caract√®res unicode qui seront finalement convertis en caract√®res ASCII qui effectueraient des actions inattendues.

Dans l'article de blog, des m√©thodes sont propos√©es pour contourner les vuln√©rabilit√©s corrig√©es en utilisant une **liste noire de caract√®res**, exploiter des **travers√©es de chemin** en utilisant [des caract√®res mapp√©s √† ‚Äú/‚Äú (0x2F)](https://worst.fit/mapping/#to%3A0x2f) et [des caract√®res mapp√©s √† ‚Äú\‚Äú (0x5C)](https://worst.fit/mapping/#to%3A0x5c) ou m√™me contourner les protections d'√©chappement de shell comme `escapeshellarg` de PHP ou `subprocess.run` de Python en utilisant une liste, cela a √©t√© fait par exemple en utilisant **des guillemets doubles en pleine largeur (U+FF02)** au lieu de guillemets doubles, de sorte qu'√† la fin ce qui semblait √™tre 1 argument √©tait transform√© en 2 arguments.

**Notez que pour qu'une application soit vuln√©rable, elle doit utiliser des API Windows "W" mais finir par appeler une API Windows "A" afin que le "Best-fit" de la cha√Æne unicode soit cr√©√©.**

**Plusieurs vuln√©rabilit√©s d√©couvertes ne seront pas corrig√©es car les gens ne s'accordent pas sur qui devrait r√©soudre ce probl√®me.**

{{#include ../../banners/hacktricks-training.md}}
