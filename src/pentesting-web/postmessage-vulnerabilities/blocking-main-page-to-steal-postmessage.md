# Bloccare la pagina principale per rubare postmessage

{{#include ../../banners/hacktricks-training.md}}

## Vincere RC con Iframes

Secondo questo [**writeup di Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), i documenti blob creati da origini nulle sono isolati per motivi di sicurezza, il che significa che se mantieni occupata la pagina principale, la pagina iframe verrà eseguita.

Fondamentalmente, in quella sfida un **iframe isolato viene eseguito** e subito **dopo** che è **caricato**, la **pagina parent** invierà un **messaggio post** con il **flag**.\
Tuttavia, quella comunicazione postmessage è **vulnerabile a XSS** (l'**iframe** può eseguire codice JS).

Pertanto, l'obiettivo dell'attaccante è **far sì che il parent crei l'iframe**, ma **prima** di far sì che la **pagina parent** **invi** i dati sensibili (**flag**), **tenerla occupata** e inviare il **payload all'iframe**. Mentre il **parent è occupato**, l'**iframe esegue il payload**, che sarà un po' di JS che ascolterà il **messaggio postmessage del parent e ruberà il flag**.\
Infine, l'iframe ha eseguito il payload e la pagina parent smette di essere occupata, quindi invia il flag e il payload lo rivela.

Ma come potresti far sì che il parent sia **occupato subito dopo aver generato l'iframe e solo mentre aspetta che l'iframe sia pronto per inviare i dati sensibili?** Fondamentalmente, devi trovare un'**azione** **async** che potresti far **eseguire** al parent. Ad esempio, in quella sfida il parent stava **ascoltando** i **postmessages** in questo modo:
```javascript
window.addEventListener("message", (e) => {
if (e.data == "blob loaded") {
$("#previewModal").modal()
}
})
```
quindi era possibile inviare un **intero grande in un postmessage** che verrà **convertito in stringa** in quella comparazione, il che richiederà del tempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
E per essere precisi e **inviare** quel **postmessage** proprio **dopo** che l'**iframe** è stato creato ma **prima** che sia **pronto** a ricevere i dati dal genitore, dovrai **giocare con i millisecondi di un `setTimeout`**.

{{#include ../../banners/hacktricks-training.md}}
