# Επαναφορά/Ξεχασμένος Κωδικός Πρόσβασης

{{#include ../banners/hacktricks-training.md}}

## **Διαρροή Κωδικού Επαναφοράς μέσω Referrer**

- Ο HTTP referer header μπορεί να διαρρεύσει τον κωδικό επαναφοράς αν περιλαμβάνεται στη διεύθυνση URL. Αυτό μπορεί να συμβεί όταν ένας χρήστης κάνει κλικ σε σύνδεσμο τρίτου μέρους μετά από αίτημα επαναφοράς κωδικού.
- **Επίπτωση**: Πιθανή κατάληψη λογαριασμού μέσω επιθέσεων Cross-Site Request Forgery (CSRF).
- **Εκμετάλλευση**: Για να ελέγξετε αν διαρρέει ο κωδικός επαναφοράς στον referer header, **ζητήστε επαναφορά κωδικού** στη διεύθυνση email σας και **κάντε κλικ στον σύνδεσμο επαναφοράς** που παρέχεται. **Μην αλλάξετε τον κωδικό σας** αμέσως. Αντίθετα, **μεταβείτε σε έναν ιστότοπο τρίτου μέρους** (όπως το Facebook ή το Twitter) ενώ **παρεμβάλλετε τα αιτήματα χρησιμοποιώντας το Burp Suite**. Εξετάστε τα αιτήματα για να δείτε αν ο **referer header περιέχει τον κωδικό επαναφοράς**, καθώς αυτό θα μπορούσε να εκθέσει ευαίσθητες πληροφορίες σε τρίτους.
- **Αναφορές**:
- [HackerOne Report 342693](https://hackerone.com/reports/342693)
- [HackerOne Report 272379](https://hackerone.com/reports/272379)
- [Άρθρο για τη Διαρροή Κωδικού Επαναφοράς](https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a)

## **Δηλητηρίαση Κωδικού Επαναφοράς**

- Οι επιτιθέμενοι μπορεί να χειριστούν τον Host header κατά τη διάρκεια των αιτημάτων επαναφοράς κωδικού για να κατευθύνουν τον σύνδεσμο επαναφοράς σε κακόβουλο ιστότοπο.
- **Επίπτωση**: Οδηγεί σε πιθανή κατάληψη λογαριασμού διαρρέοντας τους κωδικούς επαναφοράς στους επιτιθέμενους.
- **Βήματα Μείωσης**:
- Επικυρώστε τον Host header έναντι μιας λίστας επιτρεπόμενων τομέων.
- Χρησιμοποιήστε ασφαλείς, server-side μεθόδους για να δημιουργήσετε απόλυτες διευθύνσεις URL.
- **Διόρθωση**: Χρησιμοποιήστε `$_SERVER['SERVER_NAME']` για να κατασκευάσετε διευθύνσεις URL επαναφοράς κωδικού αντί για `$_SERVER['HTTP_HOST']`.
- **Αναφορές**:
- [Άρθρο Acunetix για τη Δηλητηρίαση Κωδικού Επαναφοράς](https://www.acunetix.com/blog/articles/password-reset-poisoning/)

## **Επαναφορά Κωδικού με Χειρισμό Παραμέτρου Email**

Οι επιτιθέμενοι μπορούν να χειριστούν το αίτημα επαναφοράς κωδικού προσθέτοντας επιπλέον παραμέτρους email για να παραπλανήσουν τον σύνδεσμο επαναφοράς.

- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο χρησιμοποιώντας &
```php
POST /resetPassword
[...]
email=victim@email.com&email=attacker@email.com
```
- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο χρησιμοποιώντας %20
```php
POST /resetPassword
[...]
email=victim@email.com%20email=attacker@email.com
```
- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο χρησιμοποιώντας |
```php
POST /resetPassword
[...]
email=victim@email.com|email=attacker@email.com
```
- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο χρησιμοποιώντας cc
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dcc:attacker@mail.tld"
```
- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο χρησιμοποιώντας bcc
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dbcc:attacker@mail.tld"
```
- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο χρησιμοποιώντας ,
```php
POST /resetPassword
[...]
email="victim@mail.tld",email="attacker@mail.tld"
```
- Προσθέστε το email του επιτιθέμενου ως δεύτερη παράμετρο στο json array
```php
POST /resetPassword
[...]
{"email":["victim@mail.tld","atracker@mail.tld"]}
```
- **Βήματα Ελάφρυνσης**:
- Κατάλληλη ανάλυση και επικύρωση παραμέτρων email από τον server.
- Χρήση προετοιμασμένων δηλώσεων ή παραμετροποιημένων ερωτημάτων για την αποτροπή επιθέσεων injection.
- **Αναφορές**:
- [https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be](https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be)
- [https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/](https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/)
- [https://twitter.com/HusseiN98D/status/1254888748216655872](https://twitter.com/HusseiN98D/status/1254888748216655872)

## **Αλλαγή Email και Κωδικού πρόσβασης οποιουδήποτε Χρήστη μέσω Παραμέτρων API**

- Οι επιτιθέμενοι μπορούν να τροποποιήσουν τις παραμέτρους email και κωδικού πρόσβασης σε αιτήματα API για να αλλάξουν τα διαπιστευτήρια του λογαριασμού.
```php
POST /api/changepass
[...]
("form": {"email":"victim@email.tld","password":"12345678"})
```
- **Βήματα Μείωσης**:
- Διασφαλίστε αυστηρή επικύρωση παραμέτρων και ελέγχους ταυτοποίησης.
- Εφαρμόστε ισχυρή καταγραφή και παρακολούθηση για την ανίχνευση και αντίδραση σε ύποπτες δραστηριότητες.
- **Αναφορά**:
- [Full Account Takeover via API Parameter Manipulation](https://medium.com/@adeshkolte/full-account-takeover-changing-email-and-password-of-any-user-through-api-parameters-3d527ab27240)

## **Χωρίς Περιορισμό Ρυθμού: Email Bombing**

- Η έλλειψη περιορισμού ρυθμού σε αιτήματα επαναφοράς κωδικού πρόσβασης μπορεί να οδηγήσει σε email bombing, κατακλύζοντας τον χρήστη με email επαναφοράς.
- **Βήματα Μείωσης**:
- Εφαρμόστε περιορισμό ρυθμού με βάση τη διεύθυνση IP ή τον λογαριασμό χρήστη.
- Χρησιμοποιήστε προκλήσεις CAPTCHA για να αποτρέψετε την αυτοματοποιημένη κακοποίηση.
- **Αναφορές**:
- [HackerOne Report 280534](https://hackerone.com/reports/280534)

## **Ανακαλύψτε Πώς Δημιουργείται το Token Επαναφοράς Κωδικού Πρόσβασης**

- Η κατανόηση του προτύπου ή της μεθόδου πίσω από τη δημιουργία token μπορεί να οδηγήσει σε πρόβλεψη ή brute-forcing tokens. Ορισμένες επιλογές:
- Βασισμένο σε Χρονική Σημείωση
- Βασισμένο στο UserID
- Βασισμένο στο email του Χρήστη
- Βασισμένο στο Όνομα και Επώνυμο
- Βασισμένο στην Ημερομηνία Γέννησης
- Βασισμένο στην Κρυπτογραφία
- **Βήματα Μείωσης**:
- Χρησιμοποιήστε ισχυρές, κρυπτογραφικές μεθόδους για τη δημιουργία token.
- Διασφαλίστε επαρκή τυχαιότητα και μήκος για να αποτρέψετε την προβλεψιμότητα.
- **Εργαλεία**: Χρησιμοποιήστε το Burp Sequencer για να αναλύσετε την τυχαιότητα των tokens.

## **Μπορεί να Μαντευτεί UUID**

- Εάν τα UUIDs (έκδοση 1) είναι μαντεύσιμα ή προβλέψιμα, οι επιτιθέμενοι μπορεί να τα brute-force για να δημιουργήσουν έγκυρα tokens επαναφοράς. Ελέγξτε:

{{#ref}}
uuid-insecurities.md
{{#endref}}

- **Βήματα Μείωσης**:
- Χρησιμοποιήστε την έκδοση 4 του GUID για τυχαιότητα ή εφαρμόστε επιπλέον μέτρα ασφαλείας για άλλες εκδόσεις.
- **Εργαλεία**: Χρησιμοποιήστε το [guidtool](https://github.com/intruder-io/guidtool) για την ανάλυση και δημιουργία GUIDs.

## **Manipulation Response: Αντικατάσταση Κακής Απόκρισης με Καλή**

- Manipulating HTTP responses για να παρακάμψετε μηνύματα σφάλματος ή περιορισμούς.
- **Βήματα Μείωσης**:
- Εφαρμόστε ελέγχους server-side για να διασφαλίσετε την ακεραιότητα της απόκρισης.
- Χρησιμοποιήστε ασφαλείς επικοινωνιακούς διαύλους όπως το HTTPS για να αποτρέψετε επιθέσεις man-in-the-middle.
- **Αναφορά**:
- [Critical Bug in Live Bug Bounty Event](https://medium.com/@innocenthacker/how-i-found-the-most-critical-bug-in-live-bug-bounty-event-7a88b3aa97b3)

## **Χρήση Εξαντλημένου Token**

- Δοκιμή αν τα εξαντλημένα tokens μπορούν ακόμα να χρησιμοποιηθούν για επαναφορά κωδικού πρόσβασης.
- **Βήματα Μείωσης**:
- Εφαρμόστε αυστηρές πολιτικές λήξης token και επικυρώστε την λήξη token server-side.

## **Brute Force Token Επαναφοράς Κωδικού Πρόσβασης**

- Προσπάθεια brute-force του token επαναφοράς χρησιμοποιώντας εργαλεία όπως το Burpsuite και το IP-Rotator για να παρακάμψετε τους περιορισμούς ρυθμού με βάση την IP.
- **Βήματα Μείωσης**:
- Εφαρμόστε ισχυρούς μηχανισμούς περιορισμού ρυθμού και κλειδώματος λογαριασμού.
- Παρακολουθήστε ύποπτες δραστηριότητες που υποδεικνύουν επιθέσεις brute-force.

## **Δοκιμάστε να Χρησιμοποιήσετε το Token σας**

- Δοκιμή αν το token επαναφοράς του επιτιθέμενου μπορεί να χρησιμοποιηθεί σε συνδυασμό με το email του θύματος.
- **Βήματα Μείωσης**:
- Διασφαλίστε ότι τα tokens είναι δεσμευμένα στη συνεδρία χρήστη ή σε άλλες συγκεκριμένες ιδιότητες χρήστη.

## **Ακύρωση Συνεδρίας κατά την Αποσύνδεση/Επαναφορά Κωδικού Πρόσβασης**

- Διασφάλιση ότι οι συνεδρίες ακυρώνονται όταν ο χρήστης αποσυνδέεται ή επαναφέρει τον κωδικό πρόσβασης.
- **Βήματα Μείωσης**:
- Εφαρμόστε σωστή διαχείριση συνεδρίας, διασφαλίζοντας ότι όλες οι συνεδρίες ακυρώνονται κατά την αποσύνδεση ή την επαναφορά κωδικού πρόσβασης.

## **Ακύρωση Συνεδρίας κατά την Αποσύνδεση/Επαναφορά Κωδικού Πρόσβασης**

- Τα tokens επαναφοράς θα πρέπει να έχουν χρόνο λήξης μετά τον οποίο γίνονται άκυρα.
- **Βήματα Μείωσης**:
- Ορίστε έναν λογικό χρόνο λήξης για τα tokens επαναφοράς και επιβάλετε αυστηρά την εφαρμογή του server-side.

## Αναφορές

- [https://anugrahsr.github.io/posts/10-Password-reset-flaws/#10-try-using-your-token](https://anugrahsr.github.io/posts/10-Password-reset-flaws/#10-try-using-your-token)

{{#include ../banners/hacktricks-training.md}}
