# hop-by-hop headers

{{#include ../banners/hacktricks-training.md}}

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) は **スペイン** で最も関連性の高いサイバーセキュリティイベントであり、**ヨーロッパ** で最も重要なイベントの一つです。**技術知識の促進**を使命とし、この会議はあらゆる分野の技術およびサイバーセキュリティ専門家の熱い交流の場です。

{% embed url="https://www.rootedcon.com/" %}

---

**この記事の要約** [**https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers**](https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers)

Hop-by-hop ヘッダーは、特定のトランスポートレベルの接続に特有で、主に HTTP/1.1 で二つのノード（クライアント-プロキシやプロキシ-プロキシ）間のデータを管理するために使用され、転送されることを意図していません。標準の hop-by-hop ヘッダーには、`Keep-Alive`、`Transfer-Encoding`、`TE`、`Connection`、`Trailer`、`Upgrade`、`Proxy-Authorization`、および `Proxy-Authenticate` が含まれ、[RFC 2616](https://tools.ietf.org/html/rfc2616#section-13.5.1) で定義されています。追加のヘッダーは、`Connection` ヘッダーを介して hop-by-hop として指定できます。

### Hop-by-Hop ヘッダーの悪用

プロキシによる hop-by-hop ヘッダーの不適切な管理は、セキュリティ問題を引き起こす可能性があります。プロキシはこれらのヘッダーを削除することが期待されていますが、すべてのプロキシがそうするわけではなく、潜在的な脆弱性を生じさせます。

### Hop-by-Hop ヘッダー処理のテスト

特定のヘッダーが hop-by-hop としてマークされるときのサーバーの応答の変化を観察することで、hop-by-hop ヘッダーの処理をテストできます。ツールやスクリプトを使用してこのプロセスを自動化し、プロキシがこれらのヘッダーをどのように管理しているかを特定し、誤設定やプロキシの動作を明らかにすることができます。

Hop-by-hop ヘッダーの悪用は、さまざまなセキュリティ上の影響を引き起こす可能性があります。以下は、これらのヘッダーが潜在的な攻撃のためにどのように操作されるかを示すいくつかの例です。

### `X-Forwarded-For` を使用したセキュリティ制御の回避

攻撃者は、`X-Forwarded-For` ヘッダーを操作して IP ベースのアクセス制御を回避できます。このヘッダーは、プロキシがクライアントの発信元 IP アドレスを追跡するために使用されることが多いです。しかし、プロキシがこのヘッダーを hop-by-hop として扱い、適切な検証なしに転送する場合、攻撃者は自分の IP アドレスを偽装できます。

**攻撃シナリオ:**

1. 攻撃者は、プロキシの背後にあるウェブアプリケーションに対して、`X-Forwarded-For` ヘッダーに偽の IP アドレスを含む HTTP リクエストを送信します。
2. 攻撃者は、`Connection: close, X-Forwarded-For` ヘッダーも含め、プロキシに `X-Forwarded-For` を hop-by-hop として扱うよう促します。
3. 誤設定されたプロキシは、偽装された `X-Forwarded-For` ヘッダーなしでリクエストをウェブアプリケーションに転送します。
4. ウェブアプリケーションは、元の `X-Forwarded-For` ヘッダーを見ていないため、リクエストが信頼されたプロキシから直接来たものと見なす可能性があり、無許可のアクセスを許可することがあります。

### Hop-by-Hop ヘッダー注入によるキャッシュポイズニング

キャッシュサーバーが hop-by-hop ヘッダーに基づいてコンテンツを誤ってキャッシュすると、攻撃者は悪意のあるヘッダーを注入してキャッシュを汚染する可能性があります。これにより、同じリソースを要求するユーザーに誤ったまたは悪意のあるコンテンツが提供されます。

**攻撃シナリオ:**

1. 攻撃者は、キャッシュされるべきでない hop-by-hop ヘッダー（例: `Connection: close, Cookie`）を含むリクエストをウェブアプリケーションに送信します。
2. 不適切に設定されたキャッシュサーバーは、hop-by-hop ヘッダーを削除せず、攻撃者のセッションに特化した応答をキャッシュします。
3. 同じリソースを要求する将来のユーザーは、攻撃者向けに調整されたキャッシュされた応答を受け取り、セッションハイジャックや機密情報の露出につながる可能性があります。

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) は **スペイン** で最も関連性の高いサイバーセキュリティイベントであり、**ヨーロッパ** で最も重要なイベントの一つです。**技術知識の促進**を使命とし、この会議はあらゆる分野の技術およびサイバーセキュリティ専門家の熱い交流の場です。

{% embed url="https://www.rootedcon.com/" %}

{{#include ../banners/hacktricks-training.md}}
