# JSON, XML & Yaml Hacking & Issues

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

Os seguintes problemas foram detectados no Go JSON, embora possam estar presentes em outras linguagens tamb√©m. Esses problemas foram publicados em [**este post no blog**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/).

Os parsers de JSON, XML e YAML do Go t√™m um longo hist√≥rico de inconsist√™ncias e padr√µes inseguros que podem ser explorados para **contornar a autentica√ß√£o**, **escalar privil√©gios** ou **exfiltrar dados sens√≠veis**.

### (Un)Marshaling Dados Inesperados

O objetivo √© explorar structs que permitem a um atacante ler/escrever campos sens√≠veis (por exemplo, `IsAdmin`, `Password`).

- Exemplo de Struct:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- Vulnerabilidades Comuns

1. **Tag ausente** (sem tag = campo ainda √© analisado por padr√£o):
```go
type User struct {
Username string
}
```
Carga √∫til:
```json
{"Username": "admin"}
```
2. **Uso incorreto de `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ‚ùå wrong
}
```
Carga √∫til:
```json
{"-": true}
```
‚úîÔ∏è Maneira adequada de bloquear um campo de ser (des)serializado:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Diferen√ßas de Parser

O objetivo √© contornar a autoriza√ß√£o explorando como diferentes parsers interpretam a mesma carga √∫til de maneira diferente, como em:
- CVE-2017-12635: contorno do Apache CouchDB via chaves duplicadas
- 2022: RCE de 0 cliques do Zoom via inconsist√™ncia do parser XML
- Contorno do SAML do GitLab 2025 via peculiaridades do XML

**1. Campos Duplicados:**
O `encoding/json` do Go pega o **√∫ltimo** campo.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Outros analisadores (por exemplo, Jackson do Java) podem levar o **primeiro**.

**2. Insensibilidade a Mai√∫sculas e Min√∫sculas:**
Go √© insens√≠vel a mai√∫sculas e min√∫sculas:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
At√© truques de Unicode funcionam:
```go
json.Unmarshal([]byte(`{"a‚Ñ™tion≈ø": "bypass"}`), &req)
```
**3. Incompatibilidade entre servi√ßos:**
Imagine:
- Proxy escrito em Go
- Servi√ßo de AuthZ escrito em Python

O atacante envia:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python v√™ `UserAction`, permite
- Go v√™ `AdminAction`, executa


### Confus√£o de Formato de Dados (Poliglotas)

O objetivo √© explorar sistemas que misturam formatos (JSON/XML/YAML) ou falham abertamente em erros de parser, como:
- **CVE-2020-16250**: HashiCorp Vault analisou JSON com um parser XML ap√≥s o STS retornar JSON em vez de XML.

O atacante controla:
- O cabe√ßalho `Accept: application/json`
- Controle parcial do corpo JSON

O parser XML do Go analisou **de qualquer forma** e confiou na identidade injetada.

- Payload elaborado:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
Resultado:
- **Go JSON** parser: `Action_2` (n√£o sens√≠vel a mai√∫sculas + √∫ltimo vence)
- **YAML** parser: `Action_1` (sens√≠vel a mai√∫sculas)
- **XML** parser: analisa `"Action_3"` dentro da string


### üîê Mitiga√ß√µes

| Risco                       | Corre√ß√£o                              |
|-----------------------------|---------------------------------------|
| Campos desconhecidos        | `decoder.DisallowUnknownFields()`     |
| Campos duplicados (JSON)    | ‚ùå Sem corre√ß√£o na stdlib              |
| Correspond√™ncia n√£o sens√≠vel a mai√∫sculas | ‚ùå Sem corre√ß√£o na stdlib              |
| Dados lixo em XML          | ‚ùå Sem corre√ß√£o na stdlib              |
| YAML: chaves desconhecidas  | `yaml.KnownFields(true)`              |


{{#include ../banners/hacktricks-training.md}}
