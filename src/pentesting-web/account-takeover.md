# Account Takeover

{{#include ../banners/hacktricks-training.md}}

## **Authorization Issue**

アカウントのメールアドレスを変更できるか試し、変更確認プロセスを必ず確認する。脆弱であれば、意図した被害者のメールアドレスに変更し、その後確認を行う。

## **Unicode Normalization Issue**

1. 被害者のアカウント `victim@gmail.com`
2. Unicode を使ってアカウントを作成する。  
例: `vićtim@gmail.com`

As explained in [**this talk**](https://www.youtube.com/watch?v=CiIyaZ3x49c), 上記の攻撃はサードパーティの identity providers を悪用しても実行できる場合がある:

- サードパーティの identity に、被害者と似たメールを Unicode を使って作成する（`vićtim@company.com` のように）。
- サードパーティの provider がメールを検証しないこと。
- もし identity provider がメールを検証する場合、ドメイン部分を攻撃できるかもしれない（例: `victim@ćompany.com`）。そのドメインを登録して、identity provider がドメインの ascii 版を生成し、被害者プラットフォームがドメイン名を正規化することを期待する。
- この identity provider 経由で victim プラットフォームにログインすると、プラットフォームが unicode 文字を正規化し、被害者アカウントへアクセスできる可能性がある。

詳細は Unicode Normalization のドキュメントを参照してください:


{{#ref}}
unicode-injection/unicode-normalization.md
{{#endref}}

## **Reusing Reset Token**

ターゲットシステムが **reset link を再利用可能** にしている場合、`gau`、`wayback`、`scan.io` のようなツールを使って **さらに多くの reset link を見つける**努力をするべきである。

## **Pre Account Takeover**

1. 被害者のメールを使ってプラットフォームにサインアップし、パスワードを設定する（被害者のメールへのアクセスがなければ確認できない可能性はあるが、確認を試みる）。
2. 被害者が OAuth を使ってサインアップしてアカウントを確認するまで待つ。
3. 通常のサインアップが確認されれば、被害者のアカウントへアクセスできることを期待する。

## **CORS Misconfiguration to Account Takeover**

ページに **CORS misconfigurations** がある場合、ユーザーから **機密情報を盗み出し** アカウントを **takeover** したり、認証情報を変更させて同様の目的に利用できる可能性がある:


{{#ref}}
cors-bypass.md
{{#endref}}

## **Csrf to Account Takeover**

ページが CSRF に対して脆弱であれば、ユーザーに **パスワード**、**メール**、または認証情報を変更させ、それを使ってアカウントにアクセスできる可能性がある:


{{#ref}}
csrf-cross-site-request-forgery.md
{{#endref}}

## **XSS to Account Takeover**

アプリケーションで XSS を見つけた場合、cookie、local storage、またはウェブページ上の情報を盗んでアカウントを takeover できる可能性がある:


{{#ref}}
xss-cross-site-scripting/
{{#endref}}

- ログインページ上の attribute-only reflected payloads は `document.onkeypress` をフックし、`new Image().src` でキーストロークを外部へエクスフィルトレーションし、フォームを送信せずに資格情報を盗むことができる。実践的なワークフローは [Attribute-only login XSS behind WAFs](xss-cross-site-scripting/README.md#attribute-only-login-xss-behind-wafs) を参照。

## **Same Origin + Cookies**

限定的な XSS やサブドメイン takeover を見つけた場合、cookie（例: 固定化）を操作して被害者アカウントを侵害することを試みることができる:


{{#ref}}
hacking-with-cookies/
{{#endref}}

## **Attacking Password Reset Mechanism**


{{#ref}}
reset-password.md
{{#endref}}

## Security-question resets that trust client-supplied usernames
"update security questions" フローが呼び出し元が既に認証されているにもかかわらず `username` パラメータを受け取る場合、バックエンドが通常 `UPDATE ... WHERE user_name = ?` のようにあなたの信頼できない値で実行するため、任意のアカウントのリカバリデータ（管理者を含む）を上書きできる。パターンは以下の通り:

1. 使い捨てユーザでログインし、session cookie を取得する。
2. リセットフォーム経由で被害者の username と新しい回答を送信する。
3. 注入した回答を使ってすぐに security-question ログインエンドポイントで認証し、被害者の特権を引き継ぐ。
```http
POST /reset.php HTTP/1.1
Host: file.era.htb
Cookie: PHPSESSID=<low-priv>
Content-Type: application/x-www-form-urlencoded

username=admin_ef01cab31aa&new_answer1=A&new_answer2=B&new_answer3=C
```
Anything gated by the victim's `$_SESSION` context (admin dashboards, dangerous stream-wrapper features, etc.) is now exposed without touching the real answers.

Enumerated usernames can then be targeted via the overwrite technique above or reused against ancillary services (FTP/SSH password spraying).

## **Response Manipulation**

認証レスポンスが単純なブール値にまで簡略化できる場合、false を true に変更してアクセスが得られるか試してください。

## OAuth to Account takeover


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

## Host Header Injection

1. パスワードリセット要求の開始後に Host header が変更される。
2. `X-Forwarded-For` proxy header が `attacker.com` に変更される。
3. Host, Referrer, and Origin headers が同時に `attacker.com` に変更される。
4. パスワードリセットを開始してからメールの再送を選択した後、上記の三つの方法がすべて用いられる。

## Response Manipulation

1. **Code Manipulation**: ステータスコードが `200 OK` に変更される。
2. **Code and Body Manipulation**:
- ステータスコードが `200 OK` に変更される。
- レスポンスボディが `{"success":true}` または空のオブジェクト `{}` に変更される。

これらの手法は、JSON がデータ送受信に利用されているシナリオで有効です。

## Change email of current session

出典: [このレポート](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea):

- 攻撃者は自分のメールを新しいものに変更するようリクエストする
- 攻撃者はメールアドレス変更を確認するためのリンクを受け取る
- 攻撃者はそのリンクを被害者に送信し、被害者がクリックするように仕向ける
- 被害者のメールは攻撃者が指定したものに変更される
- 攻撃によりパスワードを回復し、アカウントを乗っ取ることが可能になる

This also happened in [**this report**](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea).

### Bypass email verification for Account Takeover
- 攻撃者は attacker@test.com でログインし、signup 時にメールを確認する。
- 攻撃者は確認済みのメールを victim@test.com に変更する（メール変更時に二次確認なし）。
- これによりサイトは victim@test.com でのログインを許可し、被害者ユーザのメール検証をバイパスすることができる。

### Old Cookies

[**この投稿**](https://medium.com/@niraj1mahajan/uncovering-the-hidden-vulnerability-how-i-found-an-authentication-bypass-on-shopifys-exchange-cc2729ea31a9)で説明されているように、アカウントにログインして認証済みユーザとしてクッキーを保存し、ログアウトしてから再度ログインすることが可能でした。\
新しいログインでは別のクッキーが生成される場合があるにもかかわらず、古いクッキーが再び機能するようになっていました。

## 参考資料

- [https://blog.hackcommander.com/posts/2025/12/28/turning-a-harmless-xss-behind-a-waf-into-a-realistic-phishing-vector/](https://blog.hackcommander.com/posts/2025/12/28/turning-a-harmless-xss-behind-a-waf-into-a-realistic-phishing-vector/)
- [https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050](https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050)
- [https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea)
- [0xdf – HTB Era: security-question IDOR & username oracle](https://0xdf.gitlab.io/2025/11/29/htb-era.html)
{{#include ../banners/hacktricks-training.md}}
