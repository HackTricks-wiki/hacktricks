# Account Takeover

{{#include ../banners/hacktricks-training.md}}

## **Authorization Issue**

应尝试更改账户的电子邮件，并且必须检查确认流程。如果确认流程被发现**薄弱**，应将电子邮件更改为目标受害者的地址并完成确认。

## **Unicode Normalization Issue**

1. 目标受害者的账户为 `victim@gmail.com`
2. 使用 Unicode 创建一个账户，例如：`vićtim@gmail.com`

如 [**this talk**](https://www.youtube.com/watch?v=CiIyaZ3x49c) 所述，上述攻击也可以通过滥用第三方身份提供者来实现：

- 在第三方身份提供者处创建一个与受害者相似的邮箱，使用某些 unicode 字符（`vićtim@company.com`）。
- 第三方提供者不应验证该邮箱
- 如果身份提供者验证邮箱，或许可以攻击域名部分，例如：`victim@ćompany.com`，并注册该域名，期望身份提供者生成域名的 ascii 版本，而目标平台对域名进行归一化时则使用另一种表示。
- 通过该身份提供者在目标平台登录，目标平台应该对 unicode 字符进行规范化并允许你访问受害者账户。

有关详细信息，请参阅关于 Unicode Normalization 的文档：


{{#ref}}
unicode-injection/unicode-normalization.md
{{#endref}}

## **Reusing Reset Token**

如果目标系统允许**重置链接被重复使用**，应尽力使用诸如 `gau`、`wayback` 或 `scan.io` 等工具**寻找更多重置链接**。

## **Pre Account Takeover**

1. 应使用受害者的电子邮件在平台上注册并设置密码（应尝试确认该账户，尽管无法访问受害者的邮件可能使这一步不可行）。
2. 等待直到受害者使用 OAuth 注册并确认账户。
3. 希望普通的注册流程会被确认，从而可以访问受害者的账户。

## **CORS Misconfiguration to Account Takeover**

如果页面存在 **CORS misconfigurations**，你可能能够从用户处**窃取敏感信息**以**接管其账户**，或使其更改认证信息以达到相同目的：


{{#ref}}
cors-bypass.md
{{#endref}}

## **Csrf to Account Takeover**

如果页面存在 CSRF 漏洞，你可能能够让**用户修改其密码**、电子邮件或认证方式，从而随后访问该账户：


{{#ref}}
csrf-cross-site-request-forgery.md
{{#endref}}

## **XSS to Account Takeover**

如果你在应用中发现 XSS，可能能够窃取 cookies、local storage，或网页中的信息，从而允许你接管账户：


{{#ref}}
xss-cross-site-scripting/
{{#endref}}

- 在登录页面上的仅属性反射载荷可以 hook `document.onkeypress`，通过 `new Image().src` 外泄按键记录，并在不提交表单的情况下窃取凭证。参见 [Attribute-only login XSS behind WAFs](xss-cross-site-scripting/README.md#attribute-only-login-xss-behind-wafs) 获取实用流程。

## **Same Origin + Cookies**

如果你发现有限的 XSS 或子域接管，你可以操纵 cookies（例如固定它们）来尝试妥协受害者账户：


{{#ref}}
hacking-with-cookies/
{{#endref}}

## **Attacking Password Reset Mechanism**


{{#ref}}
reset-password.md
{{#endref}}

## Security-question resets that trust client-supplied usernames
如果“更新安全问题”的流程接受一个 `username` 参数，即使调用者已通过认证，你也可以覆盖任何账户的恢复数据（包括管理员），因为后端通常会用你不受信任的值执行 `UPDATE ... WHERE user_name = ?`。模式如下：

1. 使用一个一次性用户登录并捕获 session cookie。
2. 通过重置表单提交受害者的用户名以及新的答案。
3. 立即通过 security-question 登录端点使用你刚注入的答案进行认证，以继承受害者的权限。
```http
POST /reset.php HTTP/1.1
Host: file.era.htb
Cookie: PHPSESSID=<low-priv>
Content-Type: application/x-www-form-urlencoded

username=admin_ef01cab31aa&new_answer1=A&new_answer2=B&new_answer3=C
```
任何受受害者 `$_SESSION` 上下文限制的内容（admin dashboards、危险的 stream-wrapper 功能等）现在在不触碰真实答案的情况下被暴露。

枚举到的用户名随后可以通过上文的 overwrite 技术进行定向攻击，或在辅助服务（FTP/SSH password spraying）中重复使用。

## **Response Manipulation**

如果认证响应可以被 **简化为一个简单的布尔值：尝试将 false 改为 true**，就看看是否能获得访问权限。

## OAuth to Account takeover


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

## Host Header Injection

1. 在发起密码重置请求后，Host header 被修改。
2. 将 `X-Forwarded-For` 代理头改为 `attacker.com`。
3. 同时将 Host、Referrer 和 Origin 头改为 `attacker.com`。
4. 在发起密码重置后选择重发邮件时，会同时使用上述三种方法。

## Response Manipulation

1. **Code Manipulation**：将状态码改为 `200 OK`。
2. **Code and Body Manipulation**：
- 状态码改为 `200 OK`。
- 响应体被修改为 `{"success":true}` 或空对象 `{}`。

在使用 JSON 进行数据传输与接收的场景中，这些操纵技术非常有效。

## 更改当前会话的邮箱

来自 [此报告](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea)：

- 攻击者请求将他的邮箱更改为新的邮箱
- 攻击者收到用于确认邮箱更改的链接
- 攻击者将该链接发送给受害者，诱使其点击
- 受害者的邮箱被更改为攻击者指定的邮箱
- 攻击者可以恢复密码并接管该账户

这也发生在 [**this report**](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea)。

### Bypass email verification for Account Takeover
- 攻击者使用 attacker@test.com 登录并在注册时验证了邮箱。
- 攻击者将已验证的邮箱更改为 victim@test.com（邮箱更改时没有二次验证）
- 现在网站允许 victim@test.com 登录，我们已经绕过了受害者用户的邮箱验证。

### Old Cookies

正如 [**in this post**](https://medium.com/@niraj1mahajan/uncovering-the-hidden-vulnerability-how-i-found-an-authentication-bypass-on-shopifys-exchange-cc2729ea31a9) 中所解释的，可以登录一个账户，作为已认证用户保存 cookies，登出，然后再次登录。\
在新的登录过程中，尽管可能会生成不同的 cookies，但旧的 cookies 又重新生效了。

## References

- [https://blog.hackcommander.com/posts/2025/12/28/turning-a-harmless-xss-behind-a-waf-into-a-realistic-phishing-vector/](https://blog.hackcommander.com/posts/2025/12/28/turning-a-harmless-xss-behind-a-waf-into-a-realistic-phishing-vector/)
- [https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050](https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050)
- [https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea)
- [0xdf – HTB Era: security-question IDOR & username oracle](https://0xdf.gitlab.io/2025/11/29/htb-era.html)
{{#include ../banners/hacktricks-training.md}}
