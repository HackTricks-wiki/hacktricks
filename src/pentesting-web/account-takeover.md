# Account Takeover

{{#include ../banners/hacktricks-training.md}}

## **Problema di autorizzazione**

Si dovrebbe tentare di cambiare l'email di un account e il processo di conferma **deve essere esaminato**. Se risulta essere **debole**, l'email dovrebbe essere cambiata con quella della vittima designata e poi confermata.

## **Unicode Normalization Issue**

1. L'account della vittima designata `victim@gmail.com`
2. Bisogna creare un account usando Unicode\
   per esempio: `vićtim@gmail.com`

Come spiegato in [**questa talk**](https://www.youtube.com/watch?v=CiIyaZ3x49c), l'attacco precedente può essere effettuato anche abusando di identity provider di terze parti:

- Crea un account nel third party identity con un'email simile a quella della vittima usando qualche carattere unicode (`vićtim@company.com`).
- Il provider third party non dovrebbe verificare l'email
- Se l'identity provider verifica l'email, forse puoi attaccare la parte di dominio tipo: `victim@ćompany.com` e registrare quel dominio sperando che l'identity provider generi la versione ascii del dominio mentre la piattaforma vittima normalizza il nome di dominio.
- Effettua il login tramite questo identity provider nella piattaforma vittima che dovrebbe normalizzare il carattere unicode e permetterti di accedere all'account della vittima.

Per ulteriori dettagli, fai riferimento al documento su Unicode Normalization:


{{#ref}}
unicode-injection/unicode-normalization.md
{{#endref}}

## **Reusing Reset Token**

Se il sistema target permette che il **reset link venga riutilizzato**, si dovrebbero fare sforzi per **trovare altri reset link** usando strumenti come `gau`, `wayback`, o `scan.io`.

## **Pre Account Takeover**

1. L'email della vittima dovrebbe essere usata per registrarsi sulla piattaforma, e dovrebbe essere impostata una password (si dovrebbe tentare di confermarla, anche se la mancanza di accesso alle email della vittima potrebbe rendere questo impossibile).
2. Bisogna aspettare che la vittima si registri usando OAuth e confermi l'account.
3. Si spera che la registrazione normale venga confermata, permettendo l'accesso all'account della vittima.

## **CORS Misconfiguration to Account Takeover**

Se la pagina contiene **CORS misconfigurations** potresti essere in grado di **rubare informazioni sensibili** dall'utente per **prendere il controllo del suo account** o fargli cambiare informazioni di auth per lo stesso scopo:


{{#ref}}
cors-bypass.md
{{#endref}}

## **Csrf to Account Takeover**

Se la pagina è vulnerabile a CSRF potresti essere in grado di far sì che l'**utente modifichi la sua password**, email o autenticazione in modo da poter poi accedervi:


{{#ref}}
csrf-cross-site-request-forgery.md
{{#endref}}

## **XSS to Account Takeover**

Se trovi una XSS nell'applicazione potresti essere in grado di rubare cookies, local storage, o informazioni dalla pagina web che potrebbero permetterti di prendere controllo dell'account:


{{#ref}}
xss-cross-site-scripting/
{{#endref}}

## **Same Origin + Cookies**

Se trovi una XSS limitata o un subdomain take over, potresti giocare con i cookies (ad esempio fissandoli) per provare a compromettere l'account della vittima:


{{#ref}}
hacking-with-cookies/
{{#endref}}

## **Attacking Password Reset Mechanism**


{{#ref}}
reset-password.md
{{#endref}}

## Security-question resets that trust client-supplied usernames
Se un flusso di "update security questions" prende un parametro `username` anche se il chiamante è già autenticato, puoi sovrascrivere i dati di recovery di qualsiasi account (inclusi quelli admin) perché il backend tipicamente esegue `UPDATE ... WHERE user_name = ?` con il tuo valore non attendibile. Il pattern è:

1. Effettua il login con un utente usa-e-getta e cattura il cookie di sessione.
2. Invia il username della vittima più le nuove risposte tramite il form di reset.
3. Autenticati immediatamente tramite l'endpoint di login con security-question usando le risposte che hai appena iniettato per ereditare i privilegi della vittima.
```http
POST /reset.php HTTP/1.1
Host: file.era.htb
Cookie: PHPSESSID=<low-priv>
Content-Type: application/x-www-form-urlencoded

username=admin_ef01cab31aa&new_answer1=A&new_answer2=B&new_answer3=C
```
Qualsiasi cosa gated dal contesto `$_SESSION` della victim (admin dashboards, dangerous stream-wrapper features, ecc.) è ora esposta senza dover toccare le risposte reali.

Gli username enumerati possono quindi essere presi di mira tramite la tecnica di overwrite descritta sopra o riutilizzati contro servizi ancillari (FTP/SSH password spraying).

## **Response Manipulation**

Se la authentication response può essere ridotta a un semplice booleano, prova a cambiare false in true e verifica se ottieni accesso.

## OAuth to Account takeover


{{#ref}}
oauth-to-account-takeover.md
{{#endref}}

## Host Header Injection

1. L'header Host è modificato dopo l'inizio di una richiesta di password reset.
2. L'header proxy `X-Forwarded-For` viene modificato in `attacker.com`.
3. Gli header Host, Referrer e Origin sono contemporaneamente modificati in `attacker.com`.
4. Dopo aver avviato un password reset e poi scelto di reinviare la mail, vengono impiegati tutti e tre i metodi di cui sopra.

## Response Manipulation

1. **Code Manipulation**: Il codice di stato viene modificato in `200 OK`.
2. **Code and Body Manipulation**:
- Il codice di stato viene cambiato in `200 OK`.
- Il response body viene modificato in `{"success":true}` o in un oggetto vuoto `{}`.

Queste tecniche di manipolazione sono efficaci in scenari in cui JSON è utilizzato per la trasmissione e la ricezione dei dati.

## Modificare l'email della sessione corrente

From [this report](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea):

- Attacker richiede di cambiare la propria email con una nuova
- Attacker riceve un link per confermare il cambio dell'email
- Attacker invia il link alla victim così che lo clicchi
- L'email della victim viene cambiata con quella indicata dall'attacker
- The attack can recover the password and take over the account

This also happened in [**this report**](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea).


### Bypass email verification for Account Takeover
- Attacker logins with attacker@test.com and verifies email upon signup.
- Attacker cambia l'email verificata in victim@test.com (nessuna verifica secondaria sul cambio email)
- Ora il sito permette a victim@test.com di login e abbiamo bypassato la verifica email dell'utente victim.

### Old Cookies

Come spiegato [**in this post**](https://medium.com/@niraj1mahajan/uncovering-the-hidden-vulnerability-how-i-found-an-authentication-bypass-on-shopifys-exchange-cc2729ea31a9), era possibile effettuare il login in un account, salvare i cookies come utente autenticato, fare logout, e poi effettuare di nuovo il login.\
Con il nuovo login, anche se potrebbero essere generati cookies diversi, i vecchi hanno ricominciato a funzionare.

## Riferimenti

- [https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050](https://infosecwriteups.com/firing-8-account-takeover-methods-77e892099050)
- [https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea](https://dynnyd20.medium.com/one-click-account-take-over-e500929656ea)
- [0xdf – HTB Era: security-question IDOR & username oracle](https://0xdf.gitlab.io/2025/11/29/htb-era.html)
{{#include ../banners/hacktricks-training.md}}
