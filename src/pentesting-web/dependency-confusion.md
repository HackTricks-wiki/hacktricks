# 依存関係の混乱

{{#include ../banners/hacktricks-training.md}}


## 基本情報

要約すると、依存関係の混乱脆弱性は、プロジェクトが**スペルミス**のあるライブラリ、**存在しない**ライブラリ、または**バージョンが指定されていない**ライブラリを使用しており、使用される依存関係リポジトリが**公開リポジトリから更新されたバージョンを取得することを許可している**場合に発生します。

- **スペルミス**: **`reqests`**をインポートする代わりに`requests`
- **存在しない**: `company-logging`をインポートする、もはや**存在しない**内部ライブラリ
- **バージョンが指定されていない**: **内部**の**存在する**`company-requests`ライブラリをインポートするが、リポジトリは**公開リポジトリ**をチェックして**より新しいバージョン**があるかどうかを確認します。

## 悪用

> [!WARNING]
> すべてのケースにおいて、攻撃者は被害者企業が使用しているライブラリの**名前を持つ悪意のあるパッケージを公開する**だけで済みます。

### スペルミスと存在しない

あなたの会社が**内部でないライブラリをインポートしようとしている**場合、ライブラリのリポジトリは**公開リポジトリ**でそれを探す可能性が非常に高いです。攻撃者がそれを作成している場合、あなたのコードと実行中のマシンは非常に高い確率で侵害されるでしょう。

### バージョンが指定されていない

開発者が使用するライブラリの**バージョンを指定しない**、または**メジャーバージョン**だけを指定することは非常に一般的です。その場合、インタープリターはその要件に合った**最新バージョン**をダウンロードしようとします。\
ライブラリが**既知の外部ライブラリ**（例えば、pythonの`requests`）である場合、**攻撃者はあまりできることがありません**。なぜなら、彼は`requests`という名前のライブラリを作成できないからです（彼が元の著者でない限り）。\
しかし、ライブラリが**内部**のもので、例えばこの例の`requests-company`のように、**ライブラリリポジトリ**が**新しいバージョンを外部でもチェックすることを許可している**場合、公開されている新しいバージョンを探します。\
したがって、**攻撃者が**会社が`requests-company`ライブラリの**バージョン1.0.1**（マイナーアップデートを許可）を使用していることを知っている場合、彼は**バージョン1.0.2**のライブラリ`requests-company`を**公開**し、会社は内部のものの代わりにそのライブラリを**使用する**ことになります。

## AWSの修正

この脆弱性はAWSの**CodeArtifact**で発見されました（[**このブログ記事の詳細を読む**](https://zego.engineering/dependency-confusion-in-aws-codeartifact-86b9ff68963d)）。\
AWSは、ライブラリが内部か外部かを指定できるようにすることで、外部リポジトリから内部依存関係をダウンロードするのを避けるように修正しました。

## 脆弱なライブラリの発見

[**依存関係の混乱に関する元の投稿**](https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610)で、著者はJavaScriptプロジェクトの依存関係を含む何千もの公開されたpackage.jsonファイルを検索しました。

## 参考文献

- [https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610](https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610)
- [https://zego.engineering/dependency-confusion-in-aws-codeartifact-86b9ff68963d](https://zego.engineering/dependency-confusion-in-aws-codeartifact-86b9ff68963d)


{{#include ../banners/hacktricks-training.md}}
