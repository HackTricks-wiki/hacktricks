# SOME - Same Origin Method Execution

{{#include ../../banners/hacktricks-training.md}}

## Same Origin Method Execution

ページ内で制限されたjavascriptを実行できる場合があります。例えば、[ **実行されるコールバック値を制御できる**](#javascript-function)場合です。

その場合、最も良いことの一つは、**DOMにアクセスして、見つけた敏感なアクションを呼び出す**ことです（ボタンをクリックするなど）。しかし、通常、この脆弱性は**DOMに興味深いものがない小さなエンドポイント**で見つかります。

これらのシナリオでは、この攻撃は非常に有用です。なぜなら、その目的は**同じドメインの異なるページ内のDOMでの制限されたJS実行を悪用する**ことだからです。

基本的な攻撃の流れは次のとおりです：

- **悪用できるコールバックを見つける**（潜在的に\[\w\\.\_]に制限される）。
- 制限がなく、任意のJSを実行できる場合は、通常のXSSとしてこれを悪用できます。
- **被害者に攻撃者が制御するページを開かせる**。
- **ページは別のウィンドウで自分自身を開く**（新しいウィンドウは最初のウィンドウを参照する**`opener`**オブジェクトを持ちます）。
- **最初のページ**は、**興味深いDOM**がある**ページ**を読み込みます。
- **二番目のページ**は、コールバックを悪用して**脆弱なページ**を読み込み、**`opener`**オブジェクトを使用して**最初のページでアクションを実行**します（今や興味深いDOMを含んでいます）。

> [!CAUTION]
> 最初のページが二番目のページを作成した後に新しいURLにアクセスしても、**二番目のページの`opener`オブジェクトは新しいDOM内の最初のページへの有効な参照のままです**。
>
> さらに、二番目のページがopenerオブジェクトを使用できるためには、**両方のページが同じオリジンに存在する必要があります**。これが、この脆弱性を悪用するために、何らかの**同じオリジンのXSSを見つける必要がある理由です**。

### Exploitation

- この形式を使用して、**このタイプの脆弱性を悪用するPoCを生成**できます：[https://www.someattack.com/Playground/SOMEGenerator](https://www.someattack.com/Playground/SOMEGenerator)
- クリックするHTML要素へのDOMパスを見つけるために、このブラウザ拡張機能を使用できます：[https://www.someattack.com/Playground/targeting_tool](https://www.someattack.com/Playground/targeting_tool)

### Example

- 脆弱な例は[https://www.someattack.com/Playground/](https://www.someattack.com/Playground/)で見つけることができます。
- この例では、サーバーが**javascriptコードを生成し**、**コールバックパラメータの内容に基づいて**HTMLに追加しています：`<script>opener.{callbacl_content}</script>`。そのため、この例では`opener`の使用を明示的に示す必要はありません。
- また、このCTFの解説も確認してください：[https://ctftime.org/writeup/36068](https://ctftime.org/writeup/36068)

## References

- [https://conference.hitb.org/hitbsecconf2017ams/sessions/everybody-wants-some-advance-same-origin-method-execution/](https://conference.hitb.org/hitbsecconf2017ams/sessions/everybody-wants-some-advance-same-origin-method-execution/)

{{#include ../../banners/hacktricks-training.md}}
