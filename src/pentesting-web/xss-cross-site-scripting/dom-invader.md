# DOM Invader

{{#include ../../banners/hacktricks-training.md}}

## DOM Invader

DOM Invaderは、**Burp Suiteの組み込みChromiumブラウザ**にインストールされたブラウザツールです。これは、**DOM XSSやその他のクライアントサイドの脆弱性**（プロトタイプ汚染、DOMクラッブリングなど）を自動的に**JavaScriptソースとシンクを計測**することで検出するのを助けます。この拡張機能はBurpに同梱されており、有効にするだけで使用できます。

DOM Invaderは、ブラウザのDevToolsパネルにタブを追加し、次のことができます：

1. **制御可能なシンク**をリアルタイムで特定し、コンテキスト（属性、HTML、URL、JS）や適用されたサニタイズを含めます。
2. **`postMessage()`ウェブメッセージをログ、編集、再送信**するか、拡張機能に自動的に変異させることを許可します。
3. **クライアントサイドのプロトタイプ汚染ソースを検出し、ガジェット→シンクチェーンをスキャン**し、即座にPoCを生成します。
4. **DOMクラッブリングベクトルを見つける**（例：グローバル変数を上書きする`id` / `name`の衝突）。
5. **豊富な設定UIを介して動作を微調整**します（カスタムカナリア、自動注入、リダイレクトブロック、ソース/シンクリストなど）。

---

### 1. 有効にする

<figure><img src="../../images/image (1129).png" alt=""><figcaption></figcaption></figure>

1. **Proxy ➜ Intercept ➜ Open Browser**（Burpの埋め込みブラウザ）を開きます。
2. **Burp Suite**のロゴをクリックします（右上）。隠れている場合は、最初にジグソーピースをクリックします。
3. **DOM Invader**タブで、**Enable DOM Invader**をONに切り替え、**Reload**を押します。
4. DevToolsを開き（`F12` / 右クリック ➜ 検査）、ドックします。新しい**DOM Invader**パネルが表示されます。

> Burpはプロファイルごとに状態を記憶します。必要に応じて、*Settings ➜ Tools ➜ Burp’s browser ➜ Store settings...*で無効にします。

### 2. カナリアを注入する

**カナリア**は、DOM Invaderが追跡するランダムなマーカー文字列（例：`xh9XKYlV`）です。次のことができます：

* **コピー**して、パラメータ、フォーム、Web-Socketフレーム、ウェブメッセージなどに手動で注入します。
* **Inject URL params / Inject forms**ボタンを使用して、新しいタブを開き、カナリアがすべてのクエリキー/値またはフォームフィールドに自動的に追加されます。
* **空のカナリア**を検索して、悪用可能性に関係なくすべてのシンクを表示します（偵察に最適）。

#### カスタムカナリア（2025+）

Burp 2024.12では、**カナリア設定**（Burpロゴ ➜ DOM Invader ➜ Canary）が導入されました。次のことができます：

* **ランダム化**または**カスタム文字列**を設定します（マルチタブテストやデフォルト値がページ上に自然に表示される場合に便利）。
* 値をクリップボードに**コピー**します。
* 変更には**Reload**が必要です。

---

### 3. ウェブメッセージ（`postMessage`）

**Messages**サブタブは、すべての`window.postMessage()`呼び出しを記録し、`origin`、`source`、および`data`の使用を表示します。

• **修正して再送信**：メッセージをダブルクリックし、`data`を編集して**Send**を押します（Burp Repeaterのように）。

• **自動ファズ**：設定で**Postmessage interception ➜ Auto-mutate**を有効にして、DOM Invaderがカナリアベースのペイロードを生成し、ハンドラーに再生できるようにします。

フィールドの意味の要約：

* **origin** – ハンドラーが`event.origin`を検証するかどうか。
* **data** – ペイロードの場所。使用されていない場合、シンクは無関係です。
* **source** – iframe / ウィンドウ参照の検証；厳密なオリジンチェックよりも弱いことが多いです。

---

### 4. プロトタイプ汚染

**Settings ➜ Attack types ➜ Prototype pollution**で有効にします。

ワークフロー：

1. **Browse** – DOM Invaderは、URL/クエリ/ハッシュまたはJSONウェブメッセージで見つかった汚染**ソース**（`__proto__`、`constructor`、`prototype`）をフラグします。
2. **Test** – *Test*をクリックして、`Object.prototype.testproperty`が存在するはずのPoCタブを開きます：

```javascript
let obj = {};
console.log(obj.testproperty); // ➜ 'DOM_INVADER_PP_POC'
```
3. **ガジェットをスキャン** – DOM Invaderはプロパティ名をブルートフォースし、危険なシンク（例：`innerHTML`）に到達するかどうかを追跡します。
4. **Exploit** – ガジェット-シンクチェーンが見つかると、*Exploit*ボタンが表示され、ソース + ガジェット + シンクを連鎖させてアラートをトリガーします。

高度な設定（歯車アイコン）：

* **CSP / X-Frame-Optionsを削除**して、ガジェットスキャン中にiframeが機能するようにします。
* **別のフレームで技術をスキャン**して、`__proto__`と`constructor`の干渉を避けます。
* **技術を個別に無効に**して、脆弱なアプリに対応します。

---

### 5. DOMクラッブリング

**Attack types ➜ DOM clobbering**を切り替えます。DOM Invaderは、`id`/`name`属性がグローバル変数やフォームオブジェクトと衝突する動的に作成された要素を監視します（`<input name="location">` → `window.location`をクラッブします）。ユーザー制御のマークアップが変数の置き換えにつながるたびにエントリが生成されます。

---

## 6. 設定の概要（2025）

DOM Invaderは、**Main / Attack Types / Misc / Canary**のカテゴリに分かれました。

1. **Main**
* **Enable DOM Invader** – グローバルスイッチ。
* **Postmessage interception** – メッセージログのオン/オフ；自動変異のためのサブトグル。
* **Custom Sources/Sinks** – *歯車アイコン* ➜ 特定のシンク（例：`eval`、`setAttribute`）を有効/無効にして、アプリが壊れる可能性があります。

2. **Attack Types**
* **Prototype pollution**（技術ごとの設定あり）。
* **DOM clobbering**。

3. **Misc**
* **Redirect prevention** – クライアントサイドのリダイレクトをブロックして、シンクリストが失われないようにします。
* **Redirect前のブレークポイント** – リダイレクトの直前にJSを一時停止して、コールスタックを検査します。
* **すべてのソースにカナリアを注入** – どこにでもカナリアを自動注入；構成可能なソース/パラメータの許可リスト。

4. **Canary**
* カナリアを表示/ランダム化/カスタムカナリアを設定；クリップボードにコピー。変更にはブラウザのリロードが必要です。

---

### 7. ヒントと良い実践

* **異なるカナリアを使用** – `test`のような一般的な文字列を避け、そうでないと偽陽性が発生します。
* **重いシンク**（`eval`、`innerHTML`）を一時的に無効にして、ナビゲーション中にページ機能が壊れないようにします。
* **Burp Repeater & Proxyと組み合わせる** – 脆弱な状態を生成したブラウザリクエスト/レスポンスを複製し、最終的なエクスプロイトURLを作成します。
* **フレームスコープを忘れない** – ソース/シンクはブラウジングコンテキストごとに表示されます；iframe内の脆弱性は手動でフォーカスする必要があるかもしれません。
* **証拠をエクスポート** – DOM Invaderパネルを右クリック ➜ *Save screenshot*を選択して、レポートに含めます。

---

## References

- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader](https://portswigger.net/burp/documentation/desktop/tools/dom-invader)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/enabling](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/enabling)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/dom-xss](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/dom-xss)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/web-messages](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/web-messages)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/prototype-pollution](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/prototype-pollution)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/dom-clobbering](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/dom-clobbering)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/settings/canary](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/settings/canary)
- [https://portswigger.net/burp/documentation/desktop/tools/dom-invader/settings/misc](https://portswigger.net/burp/documentation/desktop/tools/dom-invader/settings/misc)

{{#include ../../banners/hacktricks-training.md}}
