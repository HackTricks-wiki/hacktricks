# Crypto in Malware / Reverse Engineering

{{#include ../../banners/hacktricks-training.md}}

Ta podsekcja pomaga, gdy zobaczysz crypto/compression w plikach binarnych i chcesz to szybko rozpoznać.

## Identyfikacja algorytmów kryptograficznych / kompresji

### Heurystyki ukierunkowane na technikę

- Dużo shifts/rotates, XORs i arytmetyki 32-bitowej w ciasnych pętlach.
- Lookup tables (S-boxes) w `.data` lub generowane w czasie wykonania.
- Powtarzające się pętle po `0x100` iteracji sugerujące RC4.

### Windows API dla crypto/kompresji

#### CryptDeriveKey / CryptCreateHash

Jeśli są używane, drugi parametr to `ALG_ID`:

![](<../../images/image (156).png>)

Table: https://learn.microsoft.com/en-us/windows/win32/seccrypto/alg-id

#### RtlCompressBuffer / RtlDecompressBuffer

Często wskazuje na wbudowaną kompresję Windows (LZNT1, XPRESS, etc).

### Stałe i tabele

Czasami można zidentyfikować hash/szyfr, wyszukując stałe (lub pierwszy dword tabel) w sieci.

![](<../../images/image (833).png>)

Przykład tabel AES:

![](<../../images/image (531).png>)

### Wskazówki rozpoznawania RC4

RC4 często rozpoznaje się po:

- Dwie pętle po 256 iteracji (init + KSA)
- Następnie pętla PRGA używająca `% 256` i XORująca keystream z danymi

## Rozpakowywanie binarek

### Technika

Packers przekształcają binarkę tak, że analiza statyczna jest myląca (junk code, encrypted sections, runtime unpacking). Celem jest złapać moment, w którym:

- alokuje/odszyfrowuje prawdziwy kod w pamięci
- oznacza go jako wykonywalny
- wykonuje skok do niego

### Identyfikacja spakowanych binarek

- Brak strings (lub tylko strings packera)
- Wiele strings bez xrefs (komercyjne packery)
- Użyj narzędzi do identyfikacji packera:
- PEiD
- Exeinfo PE

### Podstawowe zalecenia

- Zacznij analizę od dołu i idź w górę; unpackers często skaczą późno.
- Szukaj wzorców `JMP/CALL reg` lub sztuczek ze stosem (`push addr; retn`).
- Ustaw breakpoint na `VirtualAlloc`/`VirtualProtect` i śledź regiony RWX.
- Nagły wysyp strings po skoku często wskazuje, że dotarłeś do rozpakowanego kodu.
- Zrzutuj pamięć i napraw nagłówki narzędziami takimi jak PE-bear.

{{#include ../../banners/hacktricks-training.md}}
