# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS je uobičajen "siguran" izbor za WPA2/3-Enterprise, ali dve praktične slabosti se redovno pojavljuju tokom procena:

- **Otkrivanje identiteta bez autentikacije**: spoljašnji EAP-Response/Identity se šalje u nešifrovanom obliku pre nego što se izgradi bilo koji TLS tunel, tako da stvarna korisnička imena domena često procure u etru.
- **Pokvarena verifikacija servera od strane klijenta**: ako supplicant ne proverava striktno RADIUS server certificate (ili dozvoli korisnicima da prihvate upozorenja klikom), rogue AP sa self-signed cert i dalje može onboard victims — pretvarajući mutual TLS u one-way TLS.

## Otkrivanje EAP identiteta bez autentikacije / enumeracija korisničkih imena

EAP inicira razmenu identiteta *pre* nego što TLS počne. Ako klijent koristi stvarno korisničko ime domena kao svoj outer identity, svako u RF opsegu može da ga presretne bez autentikacije.

**Pasivni tok sakupljanja**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: brzo, no-auth prikupljanje korisničkih imena → pogura password spraying, phishing, povezivanje naloga. Još gore kada se korisnička imena poklapaju sa email adresama.

## Evil Twin preko neispravne validacije servera ("mTLS?")

Rogue APs koji emituju korporativni SSID mogu predstaviti bilo koji sertifikat. Ako klijent:
- **ne verifikuje** serverski sertifikat, ili
- **traži potvrdu od korisnika** i dozvoljava ignorisanje nepoverljivih CAs/self-signed sertifikata,
onda EAP-TLS prestaje da bude uzajamna autentikacija. Izmenjeni **hostapd/hostapd-wpe** koji preskače validaciju client-cert (npr. `SSL_set_verify(..., 0)`) je dovoljan da podigne Evil Twin.

### Rogue infra quick note

Na novijem Kali-ju, kompajlirajte `hostapd-wpe` koristeći hostapd-2.6 (sa https://w1.fi/releases/) i prvo instalirajte legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Zamke pogrešne konfiguracije Windows supplicanta (GUI/GPO)

Ključna podešavanja Windows EAP-TLS profila:
- **Proveri identitet servera validacijom sertifikata**
- Označeno → lanac poverenja mora biti pouzdan; Neoznačeno → prihvata se bilo koji samo-potpisani sertifikat.
- **Poveži se na ove servere**
- Prazno → prihvata se bilo koji sertifikat iz pouzdane CA; postavi CN/SAN listu da fiksira očekivane RADIUS nazive.
- **Ne traži od korisnika da autorizuje nove servere ili pouzdane CA**
- Označeno → korisnici ne mogu da zaobiđu upozorenje; Neoznačeno → korisnik može da veruje nepouzdanoj CA/sertifikatu i priključi se rogue AP-u.

Posmatrani ishodi:
- **Stroga validacija + bez promptova** → zlonamerni sertifikat odbijen; Windows zabeleži događaj i TLS ne uspeva (dobar signal za detekciju).
- **Validacija + prompt korisniku** → prihvatanje od strane korisnika = uspešna Evil Twin asocijacija.
- **Bez validacije** → neprimetna Evil Twin asocijacija sa bilo kojim sertifikatom.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
