# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS est le choix « sécurisé » courant pour WPA2/3-Enterprise, mais deux faiblesses pratiques apparaissent régulièrement lors des évaluations :

- **Unauthenticated identity leakage** : l'EAP-Response/Identity extérieur est envoyé en cleartext avant que le tunnel TLS ne soit établi, donc les vrais noms d'utilisateur de domaine leak souvent over the air.
- **Broken client server-validation** : si le supplicant ne vérifie pas strictement le certificat du serveur RADIUS (ou permet aux utilisateurs de passer outre les avertissements), un AP rogue avec un self-signed cert peut quand même onboarder des victimes — transformant le mutual TLS en one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP orchestre un échange d'identité *avant* le démarrage de TLS. Si le client utilise le nom d'utilisateur réel du domaine comme outer identity, toute personne en portée RF peut le collecter sans s'authentifier.

**Procédé de collecte passive**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact : collecte rapide de noms d'utilisateur sans authentification → alimente le password spraying, le phishing et la corrélation de comptes. Pire lorsque les noms d'utilisateur correspondent aux adresses e-mail.

## Evil Twin via validation du serveur cassée ("mTLS?")

Les APs rogue diffusant le SSID de l'entreprise peuvent présenter n'importe quel certificat. Si le client :
- **ne valide pas** le certificat du serveur, ou
- **invite l'utilisateur** et permet d'outrepasser les CAs non fiables / certificats auto-signés,
alors EAP-TLS cesse d'être mutuel. Un **hostapd/hostapd-wpe** modifié qui ignore la validation du certificat client (par ex., `SSL_set_verify(..., 0)`) suffit pour mettre en place l'Evil Twin.

### Note rapide sur l'infra rogue

Sur les versions récentes de Kali, compiler `hostapd-wpe` en utilisant hostapd-2.6 (depuis https://w1.fi/releases/) et installer d'abord les en-têtes legacy d'OpenSSL :
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant : pièges de mauvaise configuration (GUI/GPO)

Paramètres clés du profil Windows EAP-TLS :
- **Verify the server's identity by validating the certificate**
- Checked → la chaîne doit être de confiance ; unchecked → tout certificat auto-signé est accepté.
- **Connect to these servers**
- Empty → tout certificat d'une CA de confiance est accepté ; renseigner la liste CN/SAN pour épingler les noms RADIUS attendus.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Checked → les utilisateurs ne peuvent pas passer outre ; unchecked → l'utilisateur peut faire confiance à une CA/cert non approuvée et rejoindre le rogue AP.

Résultats observés :
- **Strict validation + no prompts** → certificat malveillant rejeté ; Windows enregistre un événement et TLS échoue (bon signal de détection).
- **Validation + user prompt** → acceptation par l'utilisateur = association Evil Twin réussie.
- **No validation** → association Evil Twin silencieuse avec n'importe quel certificat.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
