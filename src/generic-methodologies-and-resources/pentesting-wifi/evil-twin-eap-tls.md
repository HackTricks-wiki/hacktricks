# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS는 WPA2/3-Enterprise의 일반적인 "보안" 선택이지만, 평가 중에 두 가지 실용적인 약점이 자주 나타납니다:

- **Unauthenticated identity leakage**: 외부 EAP-Response/Identity는 TLS 터널이 구축되기 전에 평문으로 전송되므로, 실제 도메인 사용자 이름이 종종 leak되어 무선 범위로 노출됩니다.
- **Broken client server-validation**: supplicant가 RADIUS server certificate를 엄격히 검증하지 않거나(또는 사용자가 경고를 클릭해 넘어가도록 허용하면), self-signed cert를 가진 rogue AP가 여전히 피해자를 온보딩할 수 있어 mutual TLS가 one-way TLS로 전환됩니다.

## Unauthenticated EAP identity leakage / username enumeration

EAP는 TLS가 시작되기 *전*에 아이덴티티 교환을 수행합니다. 클라이언트가 외부 identity로 실제 도메인 사용자 이름을 사용하면, RF 범위 내 누구나 인증 없이 해당 이름을 수집할 수 있습니다.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: 빠르고 인증 불필요한 사용자 이름 수집 → fuels password spraying, phishing, 계정 연관화 촉진. 사용자 이름이 이메일 주소와 일치하면 더 악영향.

## TLS 1.3 privacy vs downgrade games

TLS 1.3은 클라이언트 인증서와 대부분의 핸드셰이크 메타데이터를 암호화하므로, supplicant가 *실제로* TLS 1.3을 협상하면 Evil Twin은 수동으로 클라이언트 인증서/신원을 알 수 없습니다. 많은 엔터프라이즈 스택은 호환성을 위해 여전히 TLS 1.2를 허용합니다; RFC 9190은 rogue AP가 TLS 1.2 static-RSA 수트만 제공하여 폴백을 강제하고 outer identity(또는 심지어 클라이언트 인증서)를 cleartext EAP-TLS로 다시 노출할 수 있다고 경고합니다.

**Offensive playbook (downgrade to leak ID):**
- `openssl_ciphersuite` / `ssl_ctx_flags`에서 TLS 1.3을 비활성화하고 TLS 1.2 static RSA 암호만 활성화한 상태로 hostapd-wpe를 컴파일합니다.
- 기업 SSID를 광고합니다; 피해자가 TLS 1.3을 시작할 때 TLS alert로 응답하고 핸드셰이크를 재시작하여 피어가 TLS 1.2로 재시도하게 만들면, 인증서 검증이 성공하기 전에 실제 신원이 드러납니다.
- hostapd-wpe에서 `force_authorized=1`과 조합하면 client-auth가 실패하더라도 4-way handshake가 완료되어 DHCP/DNS 레벨 트래픽을 phish하거나 포털에 활용할 수 있습니다.

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10은 EAP-TLS 서버 *및* 피어용 TLS 1.3 지원을 추가했지만 기본적으로 **disabled by default**로 배포됩니다; 클라이언트에서 `phase1="tls_disable_tlsv1_3=0"`을 설정해 활성화하면 다운그레이드 여지를 없앨 수 있습니다.

## Evil Twin via broken server validation ("mTLS?")

rogue APs가 기업 SSID를 브로드캐스트하면 임의의 인증서를 제시할 수 있습니다. 클라이언트가:
- **서버 인증서를 검증하지 않거나**, 또는
- **사용자에게 프롬프트를 띄워** 신뢰되지 않는 CA/자체 서명 인증서의 오버라이드를 허용하면,
EAP-TLS는 상호 인증이 아닙니다. 클라이언트 인증서 검증을 건너뛰도록 수정된 **hostapd/hostapd-wpe**(예: `SSL_set_verify(..., 0)`)면 Evil Twin을 세팅하는 데 충분합니다.

### Rogue infra quick note

최근 Kali에서 `hostapd-wpe`를 컴파일할 때 hostapd-2.6 (from https://w1.fi/releases/)을 사용하고 먼저 레거시 OpenSSL 헤더를 설치하세요:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant 구성 실수 (GUI/GPO)

Windows EAP-TLS 프로파일의 주요 설정:
- **인증서 검증을 통해 서버 신원 확인**
- 체크됨 → 체인이 신뢰되어야 함; 체크 해제됨 → 자체 서명(self-signed) cert 허용.
- **다음 서버에 연결**
- 비어 있음 → 신뢰된 CA의 모든 cert가 허용됨; CN/SAN 목록을 설정하여 예상 RADIUS 이름을 고정(pin).
- **사용자에게 새 서버 또는 신뢰할 수 있는 인증기관 승인 여부를 묻지 않음**
- 체크됨 → 사용자가 클릭하여 진행할 수 없음; 체크 해제됨 → 사용자가 신뢰되지 않은 CA/cert를 신뢰하여 악성 AP에 연결할 수 있음.

관찰된 결과:
- **엄격한 검증 + 프롬프트 없음** → 악성 cert 거부됨; Windows가 이벤트를 기록하고 TLS 실패 (좋은 탐지 신호).
- **검증 + 사용자 프롬프트** → 사용자가 승인하면 Evil Twin 연결 성공.
- **검증 없음** → 모든 cert로 조용히 Evil Twin 연결됨.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
