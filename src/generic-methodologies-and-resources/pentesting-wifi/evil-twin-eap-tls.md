# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS is die algemene "secure" keuse vir WPA2/3-Enterprise, maar twee praktiese swakpunte verskyn gereeld tydens assesserings:

- **Unauthenticated identity leakage**: die buitenste EAP-Response/Identity word in cleartext gestuur voordat enige TLS-tunnel opgebou is, sodat werklike domeingebruikersname dikwels leak oor die lug.
- **Broken client server-validation**: as die supplicant nie streng die RADIUS-server sertifikaat verifieer nie (of gebruikers toelaat om waarskuwings deur te klik), kan 'n rogue AP met 'n self-signed cert steeds slagoffers onboard – dit verander mutual TLS in one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP bestuur 'n identiteit-uitruiling *voor* TLS begin. As die client die werklike domeingebruikersnaam as sy buitenste identiteit gebruik, kan enigiemand binne RF-bereik dit versamel sonder om te authentiseer.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: vinnige, no-auth gebruikersnaaminsameling → voed password spraying, phishing, account correlation. Erger wanneer gebruikersname ooreenstem met e-posadresse.

## TLS 1.3 privaatheid vs downgrade-speletjies

TLS 1.3 enkripteer client sertifikate en meeste handshake-metagegewens, so wanneer 'n supplicant *werklik* TLS 1.3 onderhandel, kan 'n Evil Twin nie passief die client sertifikaat/identiteit leer nie. Baie enterprise-stakke laat steeds TLS 1.2 toe vir versoenbaarheid; RFC 9190 waarsku dat 'n rogue AP slegs TLS 1.2 static-RSA suites kan aanbied om 'n fallback te forceer en die outer identity (of selfs die client cert) weer in cleartext EAP-TLS bloot te lê.

**Aanvalsplan (downgrade to leak ID):**
- Kompileer hostapd-wpe met slegs TLS 1.2 static RSA ciphers aangeskakel en TLS 1.3 gedeaktiveer in `openssl_ciphersuite` / `ssl_ctx_flags`.
- Adverteer die korporatiewe SSID; wanneer die slagoffer TLS 1.3 inisieer, reageer met 'n TLS alert en herbegin die handshake sodat die peer weer probeer met TLS 1.2, wat sy werklike identiteit openbaar voordat sertifikaatvalidasie slaag.
- Kombineer dit met `force_authorized=1` in hostapd-wpe sodat die 4-way handshake voltooi word selfs as client-auth misluk, wat jou DHCP/DNS-vlak verkeer gee om te phish of 'n portal te gebruik.

**Verdedigende skakelaar (waarop om te let tydens 'n assessering):**
- hostapd/wpa_supplicant 2.10 het EAP-TLS server *en* peer-ondersteuning vir TLS 1.3 bygevoeg maar lewer dit **gedeaktiveer per verstek**; om dit op kliënte te aktiveer met `phase1="tls_disable_tlsv1_3=0"` verwyder die downgrade-venster.

## Evil Twin via gebroke server-validasie ("mTLS?")

Rogue APs wat die korporatiewe SSID uitsaai kan enige sertifikaat aanbied. As die kliënt:
- **nie die bediener-sertifikaat valideer nie**, of
- **die gebruiker vra** en oorvering van onbetroubare CAs/self-ondertekende sertifikate toelaat,
dan hou EAP-TLS op om wederkerig te wees. 'n Gemodifiseerde **hostapd/hostapd-wpe** wat client-sertifikaat-validasie oorslaan (bv. `SSL_set_verify(..., 0)`) is genoeg om die Evil Twin op te rig.

### Rogue infra quick note

Op onlangse Kali, kompileer `hostapd-wpe` met hostapd-2.6 (van https://w1.fi/releases/) en installeer eers die legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant misconfig pitfalls (GUI/GPO)

Belangrike instellings uit die Windows EAP-TLS profiel:
- **Verifieer die bediener se identiteit deur die sertifikaat te valideer**
- Gekies → ketting moet vertrou word; nie-gekies → enige self-ondertekende sertifikaat word aanvaar.
- **Koppel aan hierdie bedieners**
- Leeg → enige sertifikaat van 'n betroude CA word aanvaar; stel CN/SAN-lys om verwagte RADIUS-name vas te pen.
- **Moet nie die gebruiker vra om nuwe bedieners of betroude sertifiseringsowerhede te magtig nie**
- Gekies → gebruikers kan nie deurklik nie; nie-gekies → gebruiker kan 'n onbetroude CA/sertifikaat vertrou en by die rogue AP aansluit.

Waargenome uitkomste:
- **Strikte validering + geen versoeke** → rogue-sertifikaat word verwerp; Windows teken 'n gebeurtenis aan en TLS misluk (goeie opsporingssein).
- **Validering + gebruikerprompt** → gebruiker se aanvaarding = suksesvolle Evil Twin-assosiasie.
- **Geen validering** → stil Evil Twin-assosiasie met enige sertifikaat.

## Verwysings

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
