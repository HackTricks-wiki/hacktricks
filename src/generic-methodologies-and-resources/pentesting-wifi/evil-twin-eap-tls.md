# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS ni chaguo la kawaida "salama" kwa WPA2/3-Enterprise, lakini udhaifu wawili wa vitendo hujitokeza mara kwa mara wakati wa tathmini:

- **Uvuaji wa utambulisho usiouthibitishwa**: EAP-Response/Identity ya nje hutumwa kwa maandishi wazi kabla ya shimo lolote la TLS kujengwa, hivyo mara nyingi majina halisi ya watumiaji wa domain huvujwa hewani.
- **Uthibitishaji uliyovunjwa wa mteja-seva**: ikiwa supplicant haithibitishi kwa uangalifu cheti cha seva ya RADIUS (au inamruhusu mtumiaji kuruka onyo kwa kubofya), AP haribifu yenye self-signed cert bado inaweza kumuingiza mwathiriwa – kubadilisha mutual TLS kuwa one-way TLS.

## Uvuaji wa utambulisho wa EAP usiouthibitishwa / username enumeration

EAP inaendesha kubadilishana utambulisho *kabla* TLS haijaanza. Ikiwa mteja anatumia jina la mtumiaji halisi la domain kama utambulisho wake wa nje, mtu yeyote aliye ndani ya RF range anaweza kukikusanya bila kuthibitisha utambulisho.

**Mtiririko wa ukusanyaji pasivu**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: ukusanyaji wa majina ya watumiaji kwa haraka, bila uthibitisho → huchochea password spraying, phishing, na ulinganishaji wa akaunti. Mbaya zaidi wakati majina ya watumiaji yanalingana na anwani za barua pepe.

## Evil Twin via broken server validation ("mTLS?")

Rogue APs zinazotangaza SSID ya kampuni zinaweza kuwasilisha cheti chochote. Ikiwa mteja:
- **hayathibitishi** sertifikati ya seva, au
- **huonyesha onyo kwa mtumiaji** na kuruhusu kubatilisha CAs zisizoaminika/sertifikati zilizosainiwa binafsi,
basi EAP-TLS haibaki kuwa ya pande zote. hostapd/hostapd-wpe iliyorekebishwa ambayo inaruka uthibitisho wa sertifikati ya mteja (kwa mfano, `SSL_set_verify(..., 0)`) inatosha kuanzisha Evil Twin.

### Rogue infra quick note

Kwenye Kali ya hivi karibuni, compile `hostapd-wpe` ukitumia hostapd-2.6 (from https://w1.fi/releases/) na sakinisha kwanza vichwa (headers) vya OpenSSL vya zamani:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Mapungufu ya misconfig ya Windows supplicant (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **Verify the server's identity by validating the certificate**
- Imechaguliwa → mnyororo lazima uaminike; Haijachaguliwa → cert yoyote ya self-signed inakubaliwa.
- **Connect to these servers**
- Wazi → cert yoyote kutoka kwa trusted CA inakubaliwa; weka orodha ya CN/SAN ili ku-pin majina ya RADIUS yanayotarajiwa.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Imechaguliwa → watumiaji hawawezi kubofya kuendelea; Haijachaguliwa → mtumiaji anaweza kuamini CA/cert isiyokuwa ya kuaminika na kujiunga na rogue AP.

Observed outcomes:
- **Strict validation + no prompts** → rogue cert imekataliwa; Windows inaandika tukio na TLS inashindwa (ishara nzuri ya utambuzi).
- **Validation + user prompt** → ukubali wa mtumiaji = uunganisho wa Evil Twin uliofanikiwa.
- **No validation** → muunganisho wa Evil Twin kwa kimya kwa cert yoyote.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
