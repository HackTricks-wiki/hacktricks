# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS jest powszechnym "bezpiecznym" wyborem dla WPA2/3-Enterprise, ale dwie praktyczne słabości regularnie pojawiają się podczas ocen:

- **Unauthenticated identity leakage**: outer EAP-Response/Identity jest wysyłane w postaci jawnego tekstu zanim zostanie zbudowany jakikolwiek tunel TLS, więc prawdziwe domain usernames często leak over the air.
- **Broken client server-validation**: jeśli supplicant nie weryfikuje rygorystycznie RADIUS server certificate (lub pozwala użytkownikom zaakceptować ostrzeżenia), rogue AP z self-signed cert może nadal nakłonić ofiary do połączenia – zamieniając mutual TLS w one-way TLS.

## Unauthenticated EAP identity leakage / enumeracja nazw użytkowników

EAP wymusza wymianę identity *przed* rozpoczęciem TLS. Jeśli klient używa prawdziwej domain username jako swojej outer identity, każdy w zasięgu RF może ją zebrać bez uwierzytelniania.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: szybkie, bez uwierzytelniania zbieranie nazw użytkowników → napędza password spraying, phishing i korelację kont. Gorzej, gdy nazwy użytkowników odpowiadają adresom e-mail.

## Evil Twin przez wadliwą walidację serwera ("mTLS?")

Rogue APs nadawające korporacyjny SSID mogą przedstawić dowolny certyfikat. Jeśli klient:
- **nie waliduje** certyfikatu serwera, lub
- **wyświetla monit użytkownikowi** i pozwala na override of untrusted CAs/self-signed certs,
to EAP-TLS przestaje być wzajemnym uwierzytelnianiem. Zmodyfikowany **hostapd/hostapd-wpe**, który pomija walidację certyfikatu klienta (np. `SSL_set_verify(..., 0)`), wystarczy, by postawić Evil Twin.

### Krótka uwaga o Rogue infra

Na nowszym Kali skompiluj `hostapd-wpe` używając hostapd-2.6 (from https://w1.fi/releases/) i najpierw zainstaluj legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Pułapki błędnej konfiguracji supplicanta Windows (GUI/GPO)

Kluczowe ustawienia profilu Windows EAP-TLS:
- **Zweryfikuj tożsamość serwera poprzez walidację certyfikatu**
- Zaznaczone → łańcuch musi być zaufany; odznaczone → akceptowany jest każdy cert samopodpisany.
- **Połącz z tymi serwerami**
- Puste → akceptowany jest każdy cert od zaufanej CA; ustaw listę CN/SAN, aby przypiąć oczekiwane nazwy RADIUS.
- **Nie wyświetlaj monitu użytkownikowi o autoryzację nowych serwerów ani zaufanych urzędów certyfikacji**
- Zaznaczone → użytkownicy nie mogą kliknąć dalej; odznaczone → użytkownik może zaufać niezaufanej CA/cert i dołączyć do rogue AP.

Zaobserwowane skutki:
- **Ścisła walidacja + brak monitów** → rogue cert odrzucony; Windows zapisuje zdarzenie i TLS nie powiódł się (dobry sygnał detekcji).
- **Walidacja + monit dla użytkownika** → akceptacja użytkownika = udana asociacja z Evil Twin.
- **Brak walidacji** → cicha asociacja z Evil Twin z użyciem dowolnego cert.

## Referencje

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
