# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS je uobičajen "siguran" izbor za WPA2/3-Enterprise, ali se tokom procena redovno pojavljuju dve praktične slabosti:

- **Unauthenticated identity leakage**: spoljni EAP-Response/Identity se šalje nešifrovano pre nego što se uspostavi bilo koji TLS tunel, pa stvarna korisnička imena domena često leak preko vazduha.
- **Broken client server-validation**: ako supplicant ne proverava strogo RADIUS server certificate (ili dopušta korisnicima da kliknu i prihvate upozorenja), rogue AP sa self-signed cert i dalje može onboard victims – pretvarajući mutual TLS u one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP pokreće razmenu identiteta pre nego što TLS počne. Ako klijent koristi stvarno korisničko ime domena kao svoju spoljašnju identifikaciju, bilo ko u RF dometu može ga prikupiti bez autentifikacije.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Uticaj: brzo, prikupljanje korisničkih imena bez autentifikacije → pogoni password spraying, phishing, account correlation. Još gore kada se korisnička imena poklapaju sa email adresama.

## TLS 1.3 privatnost vs downgrade igre

TLS 1.3 šifruje client certs i većinu handshake metadata, tako da kada supplicant *zaista* pregovara TLS 1.3, Evil Twin ne može pasivno saznati client certificate/identity. Mnogi enterprise stackovi i dalje dozvoljavaju TLS 1.2 radi kompatibilnosti; RFC 9190 upozorava da rogue AP može ponuditi samo TLS 1.2 static-RSA suites da natera fallback i ponovo otkrije outer identity (ili čak client cert) u cleartext EAP-TLS.

**Offensive playbook (downgrade to leak ID):**
- Kompajlirajte hostapd-wpe sa samo TLS 1.2 static RSA ciphers omogućenim i TLS 1.3 isključenim u `openssl_ciphersuite` / `ssl_ctx_flags`.
- Reklamirajte korporativni SSID; kada žrtva inicira TLS 1.3, odgovorite sa TLS alert i restartujte handshake tako da peer pokuša ponovo sa TLS 1.2, otkrivajući njegovu pravu identitet pre nego što cert validation uspe.
- Povežite ovo sa `force_authorized=1` u hostapd-wpe tako da 4-way handshake bude završen čak i ako client-auth ne uspe, dajući vam DHCP/DNS-level saobraćaj za phish ili portal.

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10 je dodao EAP-TLS server *i* peer podršku za TLS 1.3 ali dolazi **onemogućen po defaultu**; omogućavanje na klijentima sa `phase1="tls_disable_tlsv1_3=0"` uklanja prozor za downgrade.

## Evil Twin via broken server validation ("mTLS?")

Rogue APs koji emituju korporativni SSID mogu predstaviti bilo koji certificate. Ako klijent:
- **ne proverava** server cert, ili
- **promptuje korisnika** i dozvoljava override nepouzdanim CA/self-signed certs,
onda EAP-TLS prestaje da bude mutual. Modifikovani **hostapd/hostapd-wpe** koji preskače client-cert validation (npr. `SSL_set_verify(..., 0)`) je dovoljan da se podigne Evil Twin.

### Rogue infra quick note

Na novijem Kali-ju, kompajlirajte `hostapd-wpe` koristeći hostapd-2.6 (from https://w1.fi/releases/) i prvo instalirajte legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant misconfig pitfalls (GUI/GPO)

Ključne opcije iz Windows EAP-TLS profila:
- **Verify the server's identity by validating the certificate**
- Označeno → lanac mora biti pouzdan; Neoznačeno → prihvata se bilo koji samopotpisani sertifikat.
- **Connect to these servers**
- Prazno → prihvata se bilo koji sertifikat iz pouzdane CA; postavite CN/SAN listu da biste pinovali očekivane RADIUS nazive.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Označeno → korisnici ne mogu da kliknu kroz; Neoznačeno → korisnik može da veruje nepouzdanoj CA/sertifikatu i priključi se rogue AP.

Uočeni ishodi:
- **Strict validation + no prompts** → lažni sertifikat odbijen; Windows beleži događaj i TLS ne uspeva (dobar signal za detekciju).
- **Validation + user prompt** → prihvatanje od strane korisnika = uspešna Evil Twin asocijacija.
- **No validation** → tiha Evil Twin asocijacija sa bilo kojim sertifikatom.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
