# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLSはWPA2/3-Enterpriseで一般的な「安全な」選択ですが、実務での評価では次の2つの実用的な弱点が定期的に見られます:

- **Unauthenticated identity leakage**: 外側の EAP-Response/Identity は TLS トンネルが確立される前に平文で送信されるため、実際のドメインのユーザー名が無線上でしばしば leak します。
- **Broken client server-validation**: supplicant が RADIUS server certificate を厳密に検証しない（またはユーザーが警告をクリックして進めることを許す）場合、self-signed cert を使った rogue AP が被害者をオンボードできてしまい、mutual TLS が one-way TLS に変わってしまいます。

## Unauthenticated EAP identity leakage / username enumeration

EAP は TLS が開始する*前に*ID 交換を行います。クライアントが実際のドメインのユーザー名を外側の identity として使用していると、RF 範囲内の誰でも認証なしにそれを収集できます。

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: fast, no-auth username collection → fuels password spraying, phishing, account correlation. Worse when usernames match email addresses.

## TLS 1.3 privacy vs downgrade games

TLS 1.3 はクライアント証明書とほとんどのハンドシェイクメタデータを暗号化するため、supplicant が実際に TLS 1.3 をネゴシエートすると、Evil Twin は受動的にクライアント証明書／識別子を取得できません。多くの企業向けスタックは互換性のためにまだ TLS 1.2 を許容しており、RFC 9190 は rogue AP が TLS 1.2 の static-RSA スイートのみを提示してフォールバックを強制し、外側の識別（あるいはクライアント証明書そのもの）を平文の EAP-TLS で再露出させる可能性を警告しています。

**Offensive playbook (downgrade to leak ID):**
- Compile hostapd-wpe with only TLS 1.2 static RSA ciphers enabled and TLS 1.3 disabled in `openssl_ciphersuite` / `ssl_ctx_flags`.
- Advertise the corporate SSID; when the victim initiates TLS 1.3, respond with a TLS alert and restart the handshake so the peer retries with TLS 1.2, revealing its real identity before cert validation succeeds.
- Pair this with `force_authorized=1` in hostapd-wpe so the 4-way handshake completes even if client-auth fails, giving you DHCP/DNS-level traffic to phish or portal.

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10 added EAP-TLS server *and* peer support for TLS 1.3 but ships it **disabled by default**; enabling it on clients with `phase1="tls_disable_tlsv1_3=0"` removes the downgrade window.

## Evil Twin via broken server validation ("mTLS?")

Rogue APs broadcasting the corporate SSID can present any certificate. If the client:
- **doesn’t validate** the server cert, or
- **prompts the user** and allows override of untrusted CAs/self-signed certs,
then EAP-TLS stops being mutual. A modified **hostapd/hostapd-wpe** that skips client-cert validation (e.g., `SSL_set_verify(..., 0)`) is enough to stand up the Evil Twin.

### Rogue infra quick note

On recent Kali, compile `hostapd-wpe` using hostapd-2.6 (from https://w1.fi/releases/) and install the legacy OpenSSL headers first:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant の設定ミスによる落とし穴 (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **証明書を検証してサーバーの識別を確認する**
- チェック済み → チェーンが信頼されている必要がある; 未チェック → 任意の自己署名証明書が受け入れられる。
- **これらのサーバーに接続する**
- 空欄 → 信頼された CA の証明書ならどれでも受け入れられる; CN/SAN リストを設定して想定される RADIUS 名をピン留めする。
- **ユーザーに新しいサーバーや信頼されていない認証局の承認を促さない**
- チェック済み → ユーザーはクリックして先に進めない; 未チェック → ユーザーが未信頼の CA/証明書を信頼して rogue AP に参加できる。

Observed outcomes:
- **厳密な検証 + プロンプトなし** → 不正な証明書は拒否される; Windows はイベントをログに記録し TLS が失敗する（良い検知シグナル）。
- **検証あり + ユーザープロンプト** → ユーザーの承認があれば Evil Twin への接続成功。
- **検証なし** → 任意の証明書でユーザーに気づかれずに Evil Twin に接続される。

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
