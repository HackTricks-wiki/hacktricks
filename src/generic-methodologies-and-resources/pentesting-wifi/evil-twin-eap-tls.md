# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS é a escolha "segura" comum para WPA2/3-Enterprise, mas duas fraquezas práticas aparecem regularmente durante avaliações:

- **Vazamento de identidade não autenticada**: o EAP-Response/Identity externo é enviado em cleartext antes de qualquer túnel TLS ser estabelecido, então nomes de usuário de domínio reais frequentemente vazam pelo ar.
- **Validação cliente-servidor quebrada**: se o supplicant não verificar estritamente o certificado do servidor RADIUS (ou permitir que usuários ignorem os avisos), um AP rogue com um certificado self-signed ainda pode onboardar vítimas — transformando mutual TLS em one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP conduz uma troca de identidade *antes* do início do TLS. Se o cliente usa o nome de usuário real do domínio como sua identidade externa, qualquer um em alcance RF pode coletá-lo sem se autenticar.

**Fluxo de coleta passiva**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impacto: rápido, coleta de username sem autenticação → alimenta password spraying, phishing, account correlation. Pior quando os usernames coincidem com endereços de email.

## Evil Twin via validação de servidor comprometida ("mTLS?")

APs maliciosos que anunciam o SSID corporativo podem apresentar qualquer certificado. Se o cliente:
- **não valida** o server cert, ou
- **solicita ao usuário** e permite sobrepor CAs não confiáveis/self-signed certs,
então o EAP-TLS deixa de ser mútuo. Um **hostapd/hostapd-wpe** modificado que pula a validação do client-cert (e.g., `SSL_set_verify(..., 0)`) é suficiente para levantar o Evil Twin.

### Nota rápida sobre infra rogue

No Kali recente, compile `hostapd-wpe` usando hostapd-2.6 (from https://w1.fi/releases/) e instale os headers legados do OpenSSL primeiro:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Armadilhas de misconfiguração do supplicant do Windows (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **Verify the server's identity by validating the certificate**
- Checked → chain must be trusted; unchecked → any self-signed cert is accepted.
- **Connect to these servers**
- Empty → any cert from a trusted CA is accepted; set CN/SAN list to pin expected RADIUS names.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Checked → users cannot click through; unchecked → user can trust an untrusted CA/cert and join the rogue AP.

Observed outcomes:
- **Strict validation + no prompts** → rogue cert rejected; Windows logs an event and TLS fails (good detection signal).
- **Validation + user prompt** → user acceptance = successful Evil Twin association.
- **No validation** → silent Evil Twin association with any cert.

## Referências

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
