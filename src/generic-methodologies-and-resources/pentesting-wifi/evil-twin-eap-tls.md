# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS ist die gängige „sichere“ Wahl für WPA2/3-Enterprise, aber zwei praktische Schwachstellen treten bei Assessments regelmäßig auf:

- **Unauthenticated identity leakage**: Die äußere EAP-Response/Identity wird in cleartext gesendet, bevor ein TLS-Tunnel aufgebaut ist, sodass echte Domain-Benutzernamen häufig over the air leak.
- **Broken client server-validation**: Wenn der supplicant das RADIUS-Serverzertifikat nicht strikt prüft (oder Nutzer erlaubt, Warnungen wegzuklicken), kann ein rogue AP mit einem self-signed cert trotzdem Opfer onboarden – wodurch mutual TLS zu one-way TLS wird.

## Unauthenticated EAP identity leakage / username enumeration

EAP führt einen Identitätsaustausch *noch bevor* TLS startet. Wenn der Client den echten Domain-Benutzernamen als seine outer identity verwendet, kann jede Person in RF-Reichweite ihn harvesten, ohne sich zu authentifizieren.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Auswirkung: schnell, keine Auth erforderlich — Sammlung von Benutzernamen → treibt password spraying, phishing und Account-Korrelation an. Schlimmer, wenn Benutzernamen mit E-Mail-Adressen übereinstimmen.

## Evil Twin via broken server validation ("mTLS?")

Rogue APs, die das Unternehmens-SSID ausstrahlen, können beliebige Zertifikate präsentieren. Wenn der Client:
- **das Serverzertifikat nicht validiert**, oder
- **den Benutzer zur Bestätigung auffordert** und das Überschreiben nicht vertrauenswürdiger CAs/selbstsignierter Zertifikate erlaubt,
dann ist EAP-TLS nicht mehr gegenseitig. Eine modifizierte **hostapd/hostapd-wpe**, die die Client-Zertifikatsprüfung überspringt (z. B. `SSL_set_verify(..., 0)`), reicht aus, um den Evil Twin aufzusetzen.

### Rogue infra quick note

Unter aktuellem Kali: kompiliere `hostapd-wpe` mit hostapd-2.6 (von https://w1.fi/releases/) und installiere zuerst die legacy OpenSSL-Header:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows-Supplicant: Fehlkonfigurationsfallen (GUI/GPO)

Wichtige Einstellungen im Windows EAP-TLS-Profil:
- **Verify the server's identity by validating the certificate**
- Checked → die Kette muss vertrauenswürdig sein; unchecked → jedes self-signed cert wird akzeptiert.
- **Connect to these servers**
- Empty → jedes cert von einer vertrauenswürdigen CA wird akzeptiert; set CN/SAN list um die erwarteten RADIUS-Namen zu pinnen.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Checked → Benutzer können nicht durchklicken; unchecked → Benutzer kann einer untrusted CA/cert vertrauen und sich mit dem rogue AP verbinden.

Beobachtete Ergebnisse:
- **Strict validation + no prompts** → bösartiges Zertifikat wird abgelehnt; Windows protokolliert ein Ereignis und TLS schlägt fehl (gutes Erkennungssignal).
- **Validation + user prompt** → Benutzerakzeptanz = erfolgreiche Evil Twin-Assoziation.
- **No validation** → stille Evil Twin-Assoziation mit jedem cert.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
