# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS 是 WPA2/3-Enterprise 中常见的“安全”选择，但在评估中经常出现两个实际弱点：

- **Unauthenticated identity leakage**: 外层 EAP-Response/Identity 在任何 TLS 隧道建立之前以明文发送，因此真实域用户名经常 leak 在空中。
- **Broken client server-validation**: 如果 supplicant 不严格验证 RADIUS server 的证书（或允许用户点击忽略警告），带自签名 cert 的 rogue AP 仍然可以让受害者加入网络 —— 将 mutual TLS 变成单向 TLS。

## Unauthenticated EAP identity leakage / username enumeration

EAP 在 TLS 启动 *之前* 驱动一次身份交换。如果客户端将真实域用户名用作其外层身份，任何处于 RF 范围内的人都可以在不进行认证的情况下收集到它。

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
影响：快速、无需认证的 username 收集 → 助长 password spraying、phishing、账户关联。 当 usernames 与电子邮件地址匹配时情况更糟。

## Evil Twin 通过损坏的服务器验证 ("mTLS?")

Rogue APs broadcasting the corporate SSID can present any certificate. 如果客户端：
- **不验证** server cert，或
- **提示用户** 并允许覆盖不受信任的 CAs/self-signed certs，
那么 EAP-TLS 就不再是双向认证了。修改过的 **hostapd/hostapd-wpe**，跳过 client-cert 验证（例如 `SSL_set_verify(..., 0)`），就足以部署 Evil Twin。

### Rogue infra quick note

在较新的 Kali 上，使用 hostapd-2.6 (来自 https://w1.fi/releases/) 编译 `hostapd-wpe`，并先安装 legacy OpenSSL headers：
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant 配置错误陷阱 (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **Verify the server's identity by validating the certificate**
- 已勾选 → 证书链必须受信任；未勾选 → 接受任何自签名证书。
- **Connect to these servers**
- 为空 → 接受来自受信任 CA 的任何证书；设置 CN/SAN 列表以固定预期的 RADIUS 名称。
- **Don't prompt user to authorise new servers or trusted certification authorities**
- 已勾选 → 用户无法点击通过；未勾选 → 用户可以信任不受信任的 CA/证书 并加入 rogue AP。

Observed outcomes:
- **Strict validation + no prompts** → rogue 证书被拒绝；Windows 记录事件并且 TLS 失败（良好的检测信号）。
- **Validation + user prompt** → 用户接受 = 成功的 Evil Twin 关联。
- **No validation** → 静默的 Evil Twin 关联，可使用任何证书。

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
