# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS es la opción común "segura" para WPA2/3-Enterprise, pero dos debilidades prácticas aparecen regularmente durante las evaluaciones:

- **Unauthenticated identity leakage**: la outer EAP-Response/Identity se envía en texto claro antes de que se construya cualquier túnel TLS, por lo que los nombres de usuario de dominio reales a menudo leak por el aire.
- **Broken client server-validation**: si el supplicant no verifica estrictamente el certificado del servidor RADIUS (o permite que los usuarios hagan click-through en las advertencias), un rogue AP con un self-signed cert aún puede onboard victims – convirtiendo mutual TLS en one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP inicia un intercambio de identidad *antes* de que TLS empiece. Si el cliente usa el nombre de usuario de dominio real como su outer identity, cualquiera en el rango RF puede recopilarlo sin autenticarse.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: rápido, recolección de nombres de usuario sin autenticación → alimenta password spraying, phishing, correlación de cuentas. Peor cuando los nombres de usuario coinciden con direcciones de correo electrónico.

## TLS 1.3 privacy vs downgrade games

TLS 1.3 cifra los certificados de cliente y la mayor parte de los metadatos del handshake, así que cuando un supplicant *realmente* negocia TLS 1.3, un Evil Twin no puede aprender de forma pasiva el certificado/identidad del cliente. Muchas pilas empresariales aún permiten TLS 1.2 por compatibilidad; RFC 9190 advierte que un AP rogue puede ofrecer solo suites static-RSA de TLS 1.2 para forzar un fallback y re-exponer la identidad externa (o incluso el certificado del cliente) en texto claro en EAP-TLS.

**Offensive playbook (downgrade to leak ID):**
- Compilar hostapd-wpe con solo los cifrados static-RSA de TLS 1.2 habilitados y TLS 1.3 deshabilitado en `openssl_ciphersuite` / `ssl_ctx_flags`.
- Anunciar el SSID corporativo; cuando la víctima inicie TLS 1.3, responder con una alerta TLS y reiniciar el handshake para que el peer reintente con TLS 1.2, revelando su identidad real antes de que la validación del certificado tenga éxito.
- Combinar esto con `force_authorized=1` en hostapd-wpe para que el 4-way handshake se complete incluso si client-auth falla, proporcionándote tráfico a nivel DHCP/DNS para phish o portal.

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10 agregó soporte de servidor *y* de peer para EAP-TLS en TLS 1.3 pero lo distribuye **deshabilitado por defecto**; habilitarlo en clientes con `phase1="tls_disable_tlsv1_3=0"` elimina la ventana de downgrade.

## Evil Twin via broken server validation ("mTLS?")

APs rogue que transmiten el SSID corporativo pueden presentar cualquier certificado. Si el cliente:
- **no valida** el certificado del servidor, o
- **solicita al usuario** y permite anular CAs no confiables/certificados self-signed,
entonces EAP-TLS deja de ser mutual. Un **hostapd/hostapd-wpe** modificado que omite la validación del certificado del cliente (p. ej., `SSL_set_verify(..., 0)`) es suficiente para desplegar el Evil Twin.

### Rogue infra quick note

En Kali reciente, compila `hostapd-wpe` usando hostapd-2.6 (from https://w1.fi/releases/) e instala primero los headers legacy de OpenSSL:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant: errores de misconfiguración (GUI/GPO)

Ajustes clave del perfil Windows EAP-TLS:
- **Verify the server's identity by validating the certificate**
- Marcado → la cadena debe ser de confianza; desmarcado → se acepta cualquier cert autofirmado.
- **Connect to these servers**
- Vacío → se acepta cualquier cert de una CA de confianza; establecer la lista CN/SAN para anclar los nombres RADIUS esperados.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Marcado → los usuarios no pueden seguir; desmarcado → el usuario puede confiar en una CA/cert no confiable y unirse al rogue AP.

Resultados observados:
- **Strict validation + no prompts** → rogue cert rechazado; Windows registra un evento y TLS falla (buen indicador de detección).
- **Validation + user prompt** → aceptación del usuario = asociación Evil Twin exitosa.
- **No validation** → asociación Evil Twin silenciosa con cualquier cert.

## Referencias

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
