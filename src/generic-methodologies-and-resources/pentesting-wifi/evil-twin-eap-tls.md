# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS 是 WPA2/3-Enterprise 中常见的“安全”选择，但在评估中经常出现两个实际弱点：

- **Unauthenticated identity leakage**: 外层 EAP-Response/Identity 在任何 TLS 隧道建立之前以明文发送，因此真实的域用户名经常在空中被 leak。
- **Broken client server-validation**: 如果 supplicant 不严格验证 RADIUS 服务器证书（或允许用户点击通过警告），带有 self-signed cert 的 rogue AP 仍能使受害者连网 —— 将 mutual TLS 变成 one-way TLS。

## Unauthenticated EAP identity leakage / username enumeration

EAP 在 TLS 开始之前进行身份交换。如果客户端将真实的域用户名作为外层身份，任何处于 RF 范围内的人都可以在未认证的情况下收集它。

**被动收集工作流程**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
影响：快速、无需认证的用户名收集 → 助长 password spraying、phishing、account correlation。在用户名与电子邮件地址匹配时情况更糟。

## TLS 1.3 隐私 vs 降级博弈

TLS 1.3 对客户端证书和大多数握手元数据进行了加密，因此当 supplicant *实际上* 协商 TLS 1.3 时，Evil Twin 无法被动地获取客户端证书/身份。许多企业堆栈为了兼容性仍然允许 TLS 1.2；RFC 9190 警告称 rogue AP 可以只提供 TLS 1.2 static-RSA 套件以强制回退，从而在明文 EAP-TLS 中重新暴露外层身份（甚至客户端证书）。

**Offensive playbook (downgrade to leak ID):**
- 编译 hostapd-wpe，只启用 TLS 1.2 static RSA 密码套件并在 `openssl_ciphersuite` / `ssl_ctx_flags` 中禁用 TLS 1.3。
- 广播企业 SSID；当受害者发起 TLS 1.3 时，回应一个 TLS alert 并重启握手，使对端重试 TLS 1.2，在证书验证成功前泄露其真实身份。
- 在 hostapd-wpe 中配合使用 `force_authorized=1`，即使 client-auth 失败也让 4-way handshake 完成，从而获得可用于 phish 或 portal 的 DHCP/DNS 级别流量。

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10 为 EAP-TLS server *和* peer 添加了对 TLS 1.3 的支持，但默认 **disabled by default**；在客户端上通过 `phase1="tls_disable_tlsv1_3=0"` 启用可以消除降级窗口。

## Evil Twin via broken server validation ("mTLS?")

广播企业 SSID 的 rogue AP 可以出示任意证书。如果客户端：
- **doesn’t validate** 服务器证书，或
- **prompts the user** 并允许覆盖不受信任 CA/自签名证书，
那么 EAP-TLS 就不再是双向的。修改过的 **hostapd/hostapd-wpe**（例如跳过客户端证书验证 `SSL_set_verify(..., 0)`）就足以搭起 Evil Twin。

### Rogue infra quick note

在较新的 Kali 上，使用 hostapd-2.6 (来自 https://w1.fi/releases/) 编译 `hostapd-wpe`，并先安装旧版 OpenSSL 头文件：
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant 配置错误陷阱 (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **Verify the server's identity by validating the certificate**
- Checked → 链必须被信任；unchecked → 接受任何自签名证书。
- **Connect to these servers**
- Empty → 接受来自受信任 CA 的任何证书；设置 CN/SAN 列表以固定预期的 RADIUS 名称。
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Checked → 用户无法跳过；unchecked → 用户可以信任不受信任的 CA/证书 并加入 rogue AP。

Observed outcomes:
- **Strict validation + no prompts** → 拒绝 rogue 证书；Windows 记录事件且 TLS 失败（是一个良好的检测信号）。
- **Validation + user prompt** → 用户接受 = 成功的 Evil Twin 关联。
- **No validation** → 使用任何证书静默与 Evil Twin 关联。

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
