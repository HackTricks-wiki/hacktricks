# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS є звичним «безпечним» вибором для WPA2/3-Enterprise, але під час перевірок регулярно виявляються дві практичні вразливості:

- **Unauthenticated identity leakage**: зовнішній EAP-Response/Identity надсилається в cleartext до того, як встановлено TLS-тунель, тож справжні domain usernames часто leak в ефірі.
- **Broken client server-validation**: якщо supplicant не суворо перевіряє сертифікат RADIUS server (або дозволяє користувачам click through warnings), зловмисний AP з self-signed cert все одно може onboard victims — перетворюючи mutual TLS на one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP виконує обмін identity *до* старту TLS. Якщо клієнт використовує реальний domain username як зовнішню identity, будь-хто в RF діапазоні може harvest його без автентифікації.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Вплив: швидкий збір імен користувачів без автентифікації → сприяє password spraying, phishing, account correlation. Гірше, коли імена користувачів збігаються з email-адресами.

## Evil Twin через некоректну валідацію сервера ("mTLS?")

Rogue APs, що транслюють корпоративний SSID, можуть пред'явити будь-який сертифікат. Якщо клієнт:
- **не перевіряє** сертифікат сервера, або
- **питає користувача** і дозволяє ігнорувати недовірені CA/самопідписані сертифікати,
тоді EAP-TLS перестає бути взаємним. Модифікований **hostapd/hostapd-wpe**, який пропускає валідацію клієнтського сертифіката (наприклад, `SSL_set_verify(..., 0)`), достатній для розгортання Evil Twin.

### Rogue infra — коротка примітка

На сучасних версіях Kali зкомпілюйте `hostapd-wpe`, використовуючи hostapd-2.6 (з https://w1.fi/releases/) і спочатку встановіть legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant: поширені misconfig помилки (GUI/GPO)

Ключові налаштування профілю Windows EAP-TLS:
- **Перевіряти ідентичність сервера шляхом валідації сертифіката**
- Вибрано → ланцюжок має бути довіреним; не вибрано → приймається будь-який самопідписаний сертифікат.
- **Підключатися до цих серверів**
- Пусто → приймається будь-який сертифікат від довіреного CA; встановіть список CN/SAN, щоб зафіксувати очікувані імена RADIUS.
- **Не запитувати у користувача дозвіл на авторизацію нових серверів або довірених центрів сертифікації**
- Вибрано → користувачі не можуть обійти попередження; не вибрано → користувач може довірити недовірений CA/сертифікат і приєднатися до rogue AP.

Спостережувані наслідки:
- **Сувора валідація + без підказок** → rogue cert відхилено; Windows записує подію і TLS не вдається (хороший сигнал для виявлення).
- **Валідація + запит користувачу** → прийняття користувачем = успішна Evil Twin асоціація.
- **Відсутність валідації** → безшумна Evil Twin асоціація з будь-яким сертифікатом.

## Посилання

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
