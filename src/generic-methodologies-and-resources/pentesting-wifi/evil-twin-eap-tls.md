# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS è la scelta comunemente considerata "sicura" per WPA2/3-Enterprise, ma due debolezze pratiche si presentano regolarmente durante le valutazioni:

- **Perdita non autenticata dell'identità**: l'outer EAP-Response/Identity viene inviato in testo in chiaro prima che venga stabilito qualsiasi tunnel TLS, quindi i veri nomi utente di dominio vengono spesso raccolti via radio.
- **Validazione client-server compromessa**: se il supplicant non verifica rigorosamente il certificato del server RADIUS (o consente agli utenti di ignorare gli avvisi), un rogue AP con un certificato self-signed può comunque far connettere le vittime – trasformando il mutual TLS in one-way TLS.

## Perdita di identità EAP non autenticata / enumerazione di nomi utente

EAP esegue uno scambio di identità *prima* che TLS inizi. Se il client utilizza il nome utente reale di dominio come identità esterna, chiunque nella portata RF può raccoglierlo senza autenticarsi.

**Flusso di raccolta passiva**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impatto: raccolta rapida di nomi utente senza autenticazione → favorisce password spraying, phishing, correlazione degli account. Peggio se i nomi utente corrispondono a indirizzi email.

## Evil Twin via broken server validation ("mTLS?")

AP rogue che trasmettono l'SSID aziendale possono presentare qualsiasi certificato. Se il client:
- **non valida** il certificato del server, o
- **chiede all'utente** e permette di ignorare CA non fidate/certificati self-signed,
allora EAP-TLS smette di essere mutua. Un modificato **hostapd/hostapd-wpe** che salta la validazione del certificato client (es., `SSL_set_verify(..., 0)`) è sufficiente per mettere in piedi l'Evil Twin.

### Rogue infra quick note

Sulle versioni recenti di Kali, compila `hostapd-wpe` usando hostapd-2.6 (da https://w1.fi/releases/) e installa prima gli header legacy di OpenSSL:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant: errori di configurazione (GUI/GPO)

Opzioni principali del profilo Windows EAP-TLS:
- **Verify the server's identity by validating the certificate**
- Spuntato → la chain deve essere trusted; non spuntato → qualsiasi self-signed cert è accettato.
- **Connect to these servers**
- Vuoto → any cert da una trusted CA è accettato; impostare la lista CN/SAN per pin-are i nomi RADIUS attesi.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Spuntato → gli utenti non possono procedere; non spuntato → l'utente può fidarsi di una untrusted CA/cert e unirsi al rogue AP.

Risultati osservati:
- **Strict validation + no prompts** → rogue cert rejected; Windows logs an event and TLS fails (good detection signal).
- **Validation + user prompt** → user acceptance = successful Evil Twin association.
- **No validation** → silent Evil Twin association with any cert.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
