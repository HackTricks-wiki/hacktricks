# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS — звичний «secure» вибір для WPA2/3-Enterprise, але під час перевірок регулярно виявляються дві практичні слабкості:

- **Unauthenticated identity leakage**: зовнішній EAP-Response/Identity надсилається у cleartext перед побудовою TLS-тунелю, тому реальні доменні імена користувачів часто leak over the air.
- **Broken client server-validation**: якщо supplicant не суворо перевіряє сертифікат RADIUS-сервера (або дозволяє користувачам ігнорувати попередження), rogue AP із self-signed cert все одно може onboard victims — перетворюючи mutual TLS на one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP ініціює обмін ідентифікацією *перед* запуском TLS. Якщо клієнт використовує реальне доменне ім'я користувача як свій outer identity, будь-хто в RF-діапазоні може harvest його без аутентифікації.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Вплив: швидкий збір імен користувачів без автентифікації → підживлює password spraying, phishing, кореляцію акаунтів. Гірше, коли імена користувачів збігаються з email-адресами.

## TLS 1.3: приватність проти атак пониження версії

TLS 1.3 шифрує client certs і більшість метаданих handshake, тож коли supplicant *фактично* погоджується на TLS 1.3, Evil Twin не може пасивно дізнатися client certificate/identity. Багато корпоративних стеків все ще дозволяють TLS 1.2 для сумісності; RFC 9190 попереджає, що rogue AP може запропонувати лише TLS 1.2 static-RSA набори шифрів, щоб змусити відкат і повторно розкрити outer identity (або навіть client cert) у cleartext EAP-TLS.

**Offensive playbook (downgrade to leak ID):**
- Скомпілюйте hostapd-wpe з увімкненими лише TLS 1.2 static RSA шифрами та з TLS 1.3 вимкненим у `openssl_ciphersuite` / `ssl_ctx_flags`.
- Рекламуйте корпоративний SSID; коли жертва ініціює TLS 1.3, відповідайте TLS alert і перезапустіть handshake, щоб peer повторно спробував з TLS 1.2, розкриваючи свою реальну identity до проходження валідації cert.
- Поєднайте це з `force_authorized=1` в hostapd-wpe, щоб 4-way handshake завершився навіть якщо client-auth не вдасться, даючи вам DHCP/DNS-рівневий трафік для phish або portal.

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10 додав підтримку EAP-TLS як на боці сервера, так і peer для TLS 1.3, але поставляється **вимкненою за замовчуванням**; увімкнення на клієнтах через `phase1="tls_disable_tlsv1_3=0"` усуває вікно для downgrade.

## Evil Twin через зламану валідацію сервера ("mTLS?")

Rogue APs, що транслюють корпоративний SSID, можуть пред'явити будь-який сертифікат. Якщо клієнт:
- **не перевіряє** server cert, або
- **питає користувача** і дозволяє обійти untrusted CAs/self-signed certs,
то EAP-TLS перестає бути mutual. Модифікований **hostapd/hostapd-wpe**, який пропускає перевірку client-cert (наприклад, `SSL_set_verify(..., 0)`), достатній для підняття Evil Twin.

### Rogue infra quick note

На останніх Kali, скомпілюйте `hostapd-wpe` використовуючи hostapd-2.6 (з https://w1.fi/releases/) і спочатку встановіть legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Підводні камені неправильних налаштувань Windows supplicant (GUI/GPO)

Ключові параметри профілю Windows EAP-TLS:
- **Перевіряти ідентичність сервера, валідуючи сертифікат**
- Позначено → ланцюжок має бути довіреним; не позначено → приймається будь-який самопідписаний сертифікат.
- **Підключатися до цих серверів**
- Порожнє → приймається будь-який сертифікат від довіреної CA; вкажіть список CN/SAN, щоб зафіксувати очікувані імена RADIUS.
- **Не запитувати користувача про авторизацію нових серверів або довірених центрів сертифікації**
- Позначено → користувачі не можуть продовжити всупереч попередженню; не позначено → користувач може довірити недовірену CA/сертифікат і підключитися до підробленої AP.

Спостережувані наслідки:
- **Сувора валідація + без запитів** → підроблений сертифікат відхиляється; Windows записує подію і TLS не встановлюється (добрий сигнал для виявлення).
- **Валідація + запит користувачу** → згода користувача = успішне приєднання до Evil Twin.
- **Без валідації** → безшумне приєднання до Evil Twin з будь-яким сертифікатом.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
