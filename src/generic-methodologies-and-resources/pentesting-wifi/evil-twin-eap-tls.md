# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS is the common "secure" choice for WPA2/3-Enterprise, but two practical weaknesses regularly show up during assessments:

- **Unauthenticated identity leakage**: Η εξωτερική EAP-Response/Identity αποστέλλεται σε cleartext πριν δημιουργηθεί οποιοδήποτε TLS tunnel, οπότε τα πραγματικά ονόματα χρήστη του domain συχνά leak over the air.
- **Broken client server-validation**: Αν ο supplicant δεν επαληθεύει αυστηρά το πιστοποιητικό του RADIUS server (ή επιτρέπει στους χρήστες να παρακάμπτουν/πατούν μέσα από προειδοποιήσεις), ένας rogue AP με self-signed cert μπορεί να εξακολουθήσει να onboard-άρει θύματα — μετατρέποντας mutual TLS σε one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

To EAP πραγματοποιεί ανταλλαγή ταυτότητας *πριν* ξεκινήσει το TLS. Αν ο client χρησιμοποιεί το πραγματικό domain username ως εξωτερική ταυτότητα, οποιοσδήποτε εντός RF range μπορεί να το harvest χωρίς να αυθεντικοποιηθεί.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: fast, no-auth username collection → fuels password spraying, phishing, account correlation. Worse when usernames match email addresses.

## TLS 1.3 privacy vs downgrade games

Το TLS 1.3 κρυπτογραφεί τα client certs και τα περισσότερα handshake metadata, οπότε όταν ένας supplicant *πραγματικά* διαπραγματεύεται TLS 1.3, ένα Evil Twin δεν μπορεί να μάθει παθητικά το client certificate/identity. Πολλά enterprise stacks εξακολουθούν να επιτρέπουν TLS 1.2 για συμβατότητα· το RFC 9190 προειδοποιεί ότι ένα rogue AP μπορεί να προσφέρει μόνο TLS 1.2 static-RSA suites για να αναγκάσει fallback και να επανεκθέσει την outer identity (ή ακόμα και το client cert) σε cleartext EAP-TLS.

**Offensive playbook (downgrade to leak ID):**
- Μεταγλωττίστε (compile) το hostapd-wpe με ενεργοποιημένα μόνο τα TLS 1.2 static RSA ciphers και με TLS 1.3 απενεργοποιημένο στο `openssl_ciphersuite` / `ssl_ctx_flags`.
- Διαφημίστε το corporate SSID· όταν το θύμα ξεκινήσει TLS 1.3, απαντήστε με ένα TLS alert και επανεκκινήστε το handshake ώστε ο peer να ξαναπροσπαθήσει με TLS 1.2, αποκαλύπτοντας την πραγματική του identity πριν ολοκληρωθεί η επικύρωση του cert.
- Συνδυάστε το με `force_authorized=1` στο hostapd-wpe ώστε το 4-way handshake να ολοκληρώνεται ακόμη και αν το client-auth αποτύχει, δίνοντάς σας DHCP/DNS-level traffic για να phish ή να σερβίρετε portal.

**Defensive toggle (what to look for during an assessment):**
- Το hostapd/wpa_supplicant 2.10 πρόσθεσε υποστήριξη EAP-TLS server *και* peer για TLS 1.3 αλλά παραδίδεται **απενεργοποιημένο από προεπιλογή**· η ενεργοποίησή του στους clients με `phase1="tls_disable_tlsv1_3=0"` αφαιρεί το παράθυρο downgrade.

## Evil Twin via broken server validation ("mTLS?")

Rogue APs broadcasting the corporate SSID can present any certificate. If the client:
- **doesn’t validate** the server cert, or
- **prompts the user** and allows override of untrusted CAs/self-signed certs,
then EAP-TLS stops being mutual. A modified **hostapd/hostapd-wpe** that skips client-cert validation (e.g., `SSL_set_verify(..., 0)`) is enough to stand up the Evil Twin.

### Rogue infra quick note

Σε πρόσφατο Kali, μεταγλωττίστε `hostapd-wpe` χρησιμοποιώντας hostapd-2.6 (από https://w1.fi/releases/) και εγκαταστήστε πρώτα τα legacy OpenSSL headers:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant παγίδες λανθασμένης διαμόρφωσης (GUI/GPO)

Βασικές ρυθμίσεις του προφίλ Windows EAP-TLS:
- **Επαλήθευση ταυτότητας διακομιστή με επικύρωση του πιστοποιητικού**
- Checked → chain must be trusted; unchecked → any self-signed cert is accepted.
- **Σύνδεση σε αυτούς τους διακομιστές**
- Empty → any cert from a trusted CA is accepted; set CN/SAN list to pin expected RADIUS names.
- **Να μην ζητείται από τον χρήστη έγκριση νέων διακομιστών ή αξιόπιστων αρχών πιστοποίησης**
- Checked → users cannot click through; unchecked → user can trust an untrusted CA/cert and join the rogue AP.

Παρατηρούμενα αποτελέσματα:
- **Αυστηρή επικύρωση + χωρίς προτροπές** → rogue cert rejected; Windows logs an event and TLS fails (good detection signal).
- **Επικύρωση + προτροπή χρήστη** → user acceptance = successful Evil Twin association.
- **Χωρίς επικύρωση** → silent Evil Twin association with any cert.

## Αναφορές

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
