# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS는 WPA2/3-Enterprise에서 흔히 "보안" 선택이지만, 평가 중에 자주 발견되는 두 가지 실용적 약점이 있습니다:

- **Unauthenticated identity leakage**: 외부의 EAP-Response/Identity는 TLS 터널이 설정되기 전에 평문으로 전송되므로, 실제 도메인 사용자 이름이 무선으로 자주 leak 됩니다.
- **Broken client server-validation**: supplicant가 RADIUS 서버 인증서를 엄격하게 검증하지 않거나 사용자가 경고를 클릭해 넘기도록 허용하면, self-signed cert를 가진 rogue AP가 여전히 피해자를 onboard할 수 있어 mutual TLS를 one-way TLS로 만들 수 있습니다.

## Unauthenticated EAP identity leakage / username enumeration

EAP는 TLS가 시작되기 *전에* identity 교환을 수행합니다. 클라이언트가 outer identity로 실제 도메인 사용자 이름을 사용하면, RF 범위 내 누구나 인증 없이 이를 수집할 수 있습니다.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: 빠르고 no-auth username 수집 → fuels password spraying, phishing, account correlation. Worse when usernames match email addresses.

## Evil Twin: 서버 검증이 깨진 경우 ("mTLS?")

Rogue APs가 corporate SSID를 브로드캐스트하면서 임의의 certificate를 제시할 수 있다. 클라이언트가:
- **doesn’t validate** 서버 cert를 검증하지 않거나,
- **prompts the user** 사용자에게 프롬프트를 표시해 untrusted CAs/self-signed certs를 재정의하도록 허용하면,
그러면 EAP-TLS는 상호 인증이 되지 않는다. client-cert 검증을 건너뛰도록 수정된 **hostapd/hostapd-wpe**(예: `SSL_set_verify(..., 0)`)면 Evil Twin을 세팅하기에 충분하다.

### Rogue infra quick note

최근 Kali에서는 hostapd-2.6 (from https://w1.fi/releases/)을 사용해 `hostapd-wpe`를 컴파일하고 먼저 legacy OpenSSL headers를 설치하세요:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant 오설정 위험 (GUI/GPO)

Windows EAP-TLS 프로필의 주요 설정:
- **Verify the server's identity by validating the certificate**
- 체크됨 → 체인이 신뢰되어야 함; 체크 해제 → 어떤 self-signed cert도 허용됨.
- **Connect to these servers**
- 비어 있음 → 신뢰된 CA의 어떤 cert도 허용됨; CN/SAN 목록을 설정하여 예상되는 RADIUS 이름을 핀(pin)으로 고정.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- 체크됨 → 사용자가 클릭하여 진행할 수 없음; 체크 해제 → 사용자가 신뢰되지 않은 CA/cert를 신뢰하고 rogue AP에 연결할 수 있음.

관찰된 결과:
- **엄격한 검증 + 프롬프트 없음** → rogue cert 거부됨; Windows는 이벤트를 기록하고 TLS가 실패함 (좋은 탐지 신호).
- **검증 + 사용자 프롬프트** → 사용자가 수락하면 성공적인 Evil Twin 연결.
- **검증 없음** → 어떤 cert로도 사용자 모르게 Evil Twin에 연결됨.

## References

- [EAP-TLS: 가장 안전한 옵션인가? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS 무선 인프라 (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - 네트워크 액세스 식별자](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
