# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS आमतौर पर WPA2/3-Enterprise के लिए 'सुरक्षित' विकल्प है, लेकिन मूल्यांकन के दौरान दो व्यावहारिक कमजोरियाँ नियमित रूप से सामने आती हैं:

- **Unauthenticated identity leakage**: बाहरी EAP-Response/Identity किसी भी TLS टनल बनने से पहले cleartext में भेजा जाता है, इसलिए असली डोमेन यूज़रनेम अक्सर वायरलेस माध्यम से leak हो जाते हैं।
- **Broken client server-validation**: यदि supplicant RADIUS server certificate को कड़ाई से verify नहीं करता (या users को warnings के माध्यम से click-through करने की अनुमति देता है), तो self-signed cert वाला rogue AP फिर भी victims को onboard कर सकता है — जिससे mutual TLS एकतरफा TLS में बदल जाता है।

## Unauthenticated EAP identity leakage / username enumeration

EAP TLS शुरू होने से *पहले* identity एक्सचेंज करता है। यदि client अपने outer identity के रूप में असली डोमेन username का उपयोग करता है, तो RF रेंज में कोई भी उसे प्रमाणीकरण किए बिना इकट्ठा कर सकता है।

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
प्रभाव: तेज़, no-auth username संग्रह → fuels password spraying, phishing, account correlation. Worse when usernames match email addresses.

## TLS 1.3 privacy vs downgrade games

TLS 1.3 client certs और अधिकतर handshake metadata को encrypt करता है, इसलिए जब एक supplicant *वास्तव में* TLS 1.3 negotiate करता है, तो एक Evil Twin passive रूप से client certificate/identity नहीं जान सकता। कई enterprise stacks अभी भी compatibility के लिए TLS 1.2 की अनुमति देते हैं; RFC 9190 चेतावनी देता है कि एक rogue AP केवल TLS 1.2 static-RSA suites ऑफर कर सकता है ताकि fallback मजबूर हो और outer identity (या यहाँ तक कि client cert) cleartext EAP-TLS में फिर से expose हो जाए।

**Offensive playbook (downgrade to leak ID):**
- hostapd-wpe को केवल TLS 1.2 static RSA ciphers enabled करके और TLS 1.3 को `openssl_ciphersuite` / `ssl_ctx_flags` में disabled करके compile करें।
- कॉर्पोरेट SSID advertise करें; जब victim TLS 1.3 initiate करे, तो TLS alert के साथ respond करें और handshake restart करें ताकि peer TLS 1.2 के साथ retry करे, और cert validation सफल होने से पहले उसकी असली identity reveal हो जाए।
- इसे hostapd-wpe में `force_authorized=1` के साथ जोड़ीए ताकि 4-way handshake पूरा हो जाए भले ही client-auth fail हो, और आपको DHCP/DNS-level ट्रैफ़िक मिल सके जिसे आप phish या portal के लिए उपयोग कर सकें।

**Defensive toggle (what to look for during an assessment):**
- hostapd/wpa_supplicant 2.10 ने EAP-TLS server *and* peer के लिए TLS 1.3 support जोड़ा है पर यह **disabled by default** आता है; क्लाइंट्स पर इसे `phase1="tls_disable_tlsv1_3=0"` के साथ enable करने से डाउनग्रेड विंडो हट जाती है।

## Evil Twin via broken server validation ("mTLS?")

कॉर्पोरेट SSID broadcast करने वाले rogue AP किसी भी certificate प्रस्तुत कर सकते हैं। अगर client:
- **सर्वर cert को validate नहीं करता**, या
- **उपयोगकर्ता से prompt करता है** और untrusted CAs/self-signed certs के override की अनुमति देता है,
तो EAP-TLS mutual होना बंद हो जाता है। एक संशोधित **hostapd/hostapd-wpe** जो client-cert validation को skip कर दे (उदा., `SSL_set_verify(..., 0)`) Evil Twin खड़ा करने के लिए पर्याप्त है।

### Rogue infra quick note

हाल के Kali पर, `hostapd-wpe` को hostapd-2.6 (from https://w1.fi/releases/) का उपयोग करके compile करें और पहले legacy OpenSSL headers इंस्टॉल करें:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant misconfig pitfalls (GUI/GPO)

Windows EAP-TLS profile के प्रमुख विकल्प:
- **Verify the server's identity by validating the certificate**
- Checked → chain को trusted होना चाहिए; unchecked → किसी भी self-signed cert को स्वीकार कर लिया जाता है।
- **Connect to these servers**
- Empty → trusted CA से कोई भी cert स्वीकार हो जाता है; CN/SAN सूची सेट करके अपेक्षित RADIUS नाम pin करें।
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Checked → उपयोगकर्ता आगे नहीं बढ़ सकते; unchecked → उपयोगकर्ता किसी untrusted CA/cert को भरोसा कर सकते हैं और rogue AP से जुड़ सकते हैं।

Observed outcomes:
- **Strict validation + no prompts** → rogue cert अस्वीकार; Windows एक इवेंट लॉग करता है और TLS fail होता है (अच्छा डिटेक्शन संकेत)।
- **Validation + user prompt** → उपयोगकर्ता की स्वीकृति = सफल Evil Twin association।
- **No validation** → किसी भी cert के साथ silent Evil Twin association।

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)
- [RFC 9190 – EAP-TLS 1.3](https://datatracker.ietf.org/doc/rfc9190/)
- [hostapd/wpa_supplicant 2.10 release notes (TLS 1.3 EAP-TLS support)](https://lists.infradead.org/pipermail/hostap/2022-February/040204.html)

{{#include ../../banners/hacktricks-training.md}}
