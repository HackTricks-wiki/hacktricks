# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS は WPA2/3-Enterprise で一般的に「安全」とされる選択肢だが、評価中にしばしば次の2つの実用的な弱点が現れる:

- **Unauthenticated identity leakage**: 外側の EAP-Response/Identity は TLS トンネルが確立される前に平文で送信されるため、実際のドメインユーザー名が無線上でしばしば leak される。
- **Broken client server-validation**: supplicant が RADIUS サーバー証明書を厳密に検証しない（またはユーザーに警告をクリックさせることを許す）場合、self-signed cert を用いた rogue AP が victims を onboard してしまい、mutual TLS を one-way TLS に変えてしまう。

## Unauthenticated EAP identity leakage / username enumeration

EAP は TLS が始まる *前に* アイデンティティ交換を行う。クライアントが外側の identity として実際のドメインユーザー名を使っている場合、RF range 内の誰でも認証なくそれを収集できる。

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
影響: 高速で認証不要のユーザー名収集 → password spraying、phishing、アカウント相関を助長します。ユーザー名がメールアドレスと一致する場合はさらに悪化します。

## Evil Twin via broken server validation ("mTLS?")

Rogue APs が corporate SSID をブロードキャストしていると、任意の証明書を提示できます。クライアントが:
- **サーバ証明書を検証しない**、または
- **ユーザーにプロンプトを表示し**、信頼されていない CA / 自己署名証明書の上書きを許可する場合、
then EAP-TLS stops being mutual. クライアント証明書の検証をスキップするように改変された **hostapd/hostapd-wpe**（例: `SSL_set_verify(..., 0)`）があれば、Evil Twin を立ち上げるのに十分です。

### Rogue infra quick note

最近の Kali では、`hostapd-wpe` を hostapd-2.6 (from https://w1.fi/releases/) を使ってコンパイルし、まずレガシー OpenSSL ヘッダをインストールしてください:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant misconfig pitfalls (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **Verify the server's identity by validating the certificate**
- Checked → チェーンは信頼されている必要がある；unchecked → 任意の自己署名 cert が受け入れられる。
- **Connect to these servers**
- Empty → 信頼された CA の任意の cert が受け入れられる；CN/SAN リストを設定して期待される RADIUS 名をピン留めする。
- **Don't prompt user to authorise new servers or trusted certification authorities**
- Checked → ユーザーはクリックして先に進めない；unchecked → ユーザーが信頼されていない CA/cert を信頼して rogue AP に参加できる。

Observed outcomes:
- **Strict validation + no prompts** → rogue cert は拒否される；Windows はイベントをログに記録し TLS は失敗する（良い検知シグナル）。
- **Validation + user prompt** → ユーザーが承認すると = 成功した Evil Twin 接続。
- **No validation** → 任意の cert でサイレントに Evil Twin に接続される。

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
