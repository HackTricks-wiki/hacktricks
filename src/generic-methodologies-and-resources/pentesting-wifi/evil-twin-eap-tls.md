# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS es la opción común "secure" para WPA2/3-Enterprise, pero dos debilidades prácticas aparecen regularmente durante las evaluaciones:

- **Unauthenticated identity leakage**: el outer EAP-Response/Identity se envía en cleartext antes de que se establezca cualquier túnel TLS, por lo que los real domain usernames a menudo leak por el aire.
- **Broken client server-validation**: si el supplicant no verifica estrictamente el certificado del servidor RADIUS (o permite que los usuarios ignoren las advertencias), un rogue AP con un self-signed cert aún puede permitir que las víctimas se conecten — convirtiendo mutual TLS en one-way TLS.

## Unauthenticated EAP identity leakage / username enumeration

EAP realiza un intercambio de identidad *antes* de que TLS comience. Si el cliente usa el nombre de usuario de dominio real como su outer identity, cualquiera en RF range puede recopilarlo sin autenticarse.

**Flujo de recopilación pasiva**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impacto: recolección rápida de nombres de usuario sin autenticación → alimenta password spraying, phishing y correlación de cuentas. Peor cuando los nombres de usuario coinciden con direcciones de email.

## Evil Twin vía validación de servidor rota ("mTLS?")

Rogue APs que transmiten el SSID corporativo pueden presentar cualquier certificado. Si el cliente:
- **no valida** el server cert, o
- **solicita al usuario** y permite anular CAs no confiables/self-signed certs,
entonces EAP-TLS deja de ser mutua. Un **hostapd/hostapd-wpe** modificado que omita la validación del client-cert (p. ej., `SSL_set_verify(..., 0)`) es suficiente para levantar el Evil Twin.

### Nota rápida sobre infraestructura Rogue

En Kali reciente, compila `hostapd-wpe` usando hostapd-2.6 (desde https://w1.fi/releases/) e instala primero los headers legacy de OpenSSL:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant misconfig pitfalls (GUI/GPO)

Key knobs from the Windows EAP-TLS profile:
- **Verificar la identidad del servidor validando el certificado**
- Marcado → la cadena debe ser de confianza; desmarcado → se acepta cualquier certificado autofirmado.
- **Conectarse a estos servidores**
- Vacío → se acepta cualquier certificado de una CA de confianza; establezca la lista CN/SAN para fijar los nombres RADIUS esperados.
- **No solicitar al usuario que autorice nuevos servidores o autoridades de certificación de confianza**
- Marcado → los usuarios no pueden continuar; desmarcado → el usuario puede confiar en una CA/cert no confiable y unirse al AP malicioso.

Observed outcomes:
- **Validación estricta + sin avisos** → certificado malicioso rechazado; Windows registra un evento y TLS falla (buen indicador de detección).
- **Validación + aviso al usuario** → aceptación del usuario = asociación Evil Twin exitosa.
- **Sin validación** → asociación silenciosa con Evil Twin con cualquier certificado.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
