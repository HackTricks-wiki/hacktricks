# Evil Twin EAP-TLS

{{#include ../../banners/hacktricks-training.md}}

EAP-TLS, WPA2/3-Enterprise için yaygın bir "güvenli" tercihtir, ancak değerlendirmelerde iki pratik zayıflık sıkça ortaya çıkar:

- **Unauthenticated identity leakage**: outer EAP-Response/Identity, herhangi bir TLS tüneli kurulmadan önce cleartext olarak gönderilir; bu yüzden gerçek domain kullanıcı adları genellikle kablosuz ortamda leak olur.
- **Broken client server-validation**: Eğer supplicant, RADIUS sunucu sertifikasını sıkı şekilde doğrulamaz (veya kullanıcıların uyarıları geçmesine izin verirse), self-signed cert kullanan bir rogue AP yine de kurbanları ağa dahil edebilir — mutual TLS'i tek yönlü TLS'e çevirir.

## Unauthenticated EAP identity leakage / username enumeration

EAP, TLS başlamadan önce bir kimlik değişimi yürütür. Eğer client gerçek domain kullanıcı adını outer identity olarak kullanıyorsa, RF menzilindekiler herhangi bir kimlik doğrulaması yapmadan bunu ele geçirebilir.

**Passive harvest workflow**
```bash
# 1) Park on the right channel/BSSID
airodump-ng -i $IFACE -c $CHAN --bssid $BSSID

# 2) Decode EAP frames and extract identities
# Trigger a client connection (e.g., your phone) to see the leak
tshark -i "$IFACE" -Y eap -V | grep "Identity: *[a-z]\|*[A-Z]\|*[0-9]"
```
Impact: hızlı, kimlik doğrulama gerektirmeyen username toplama → password spraying, phishing ve account correlation'ı besler. Usernames e-posta adresleriyle eşleştiğinde daha kötü.

## Evil Twin via bozuk sunucu doğrulaması ("mTLS?")

Kurumsal SSID'yi yayınlayan Rogue APs herhangi bir sertifika sunabilir. Eğer istemci:
- **sunucu sertifikasını doğrulamazsa**, veya
- **kullanıcıyı uyarır** ve güvensiz CAs/self-signed certs'lerin geçersiz kılınmasına izin verirse,
o zaman EAP-TLS karşılıklı olmaktan çıkar. İstemci sertifikası doğrulamasını atlayan değiştirilmiş bir **hostapd/hostapd-wpe** (örn. `SSL_set_verify(..., 0)`) Evil Twin'i kurmak için yeterlidir.

### Rogue infra kısa not

Son Kali sürümlerinde, `hostapd-wpe`'yi hostapd-2.6 (from https://w1.fi/releases/) kullanarak derleyin ve önce legacy OpenSSL headers'larını yükleyin:
```bash
apt-get install libssl1.0-dev
# patch hostapd-wpe to set verify_peer=0 in SSL_set_verify to accept any client cert
```
### Windows supplicant yanlış yapılandırma tuzakları (GUI/GPO)

Windows EAP-TLS profilindeki temel ayarlar:
- **Sertifikayı doğrulayarak sunucunun kimliğini doğrula**
- İşaretli → zincirin güvenilir olması gerekir; işaretsiz → herhangi bir self-signed sertifika kabul edilir.
- **Connect to these servers**
- Boş → trusted CA'dan gelen herhangi bir sertifika kabul edilir; CN/SAN listesi ayarlayarak beklenen RADIUS isimlerini kilitleyin.
- **Don't prompt user to authorise new servers or trusted certification authorities**
- İşaretli → kullanıcı atlatamaz; işaretsiz → kullanıcı, güvenilmeyen bir CA/sertifikayı güvenilir sayıp rogue AP'ye katılabilir.

Gözlemlenen sonuçlar:
- **Strict validation + no prompts** → rogue cert reddedilir; Windows bir olay kaydeder ve TLS başarısız olur (iyi bir tespit sinyali).
- **Validation + user prompt** → kullanıcı onayı = başarılı Evil Twin association.
- **No validation** → herhangi bir sertifika ile sessiz Evil Twin association.

## References

- [EAP-TLS: The most secure option? (NCC Group)](https://www.nccgroup.com/research-blog/eap-tls-the-most-secure-option/)
- [EAP-TLS wireless infrastructure (Versprite hostapd bypass)](https://versprite.com/blog/eap-tls-wireless-infrastructure/)
- [RFC 4282 - Network Access Identifier](https://datatracker.ietf.org/doc/html/rfc4282)
- [Microsoft ServerValidationParameters (WLAN profile)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpwl/0765966e-a16a-4e75-aec6-0f5f7bfbf31c)

{{#include ../../banners/hacktricks-training.md}}
