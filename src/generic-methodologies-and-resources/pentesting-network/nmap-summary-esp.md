# Nmap 概要 (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## パラメータ

### スキャンするIP

- **`<ip>,<net/mask>`:** IPを直接指定します
- **`-iL <ips_file>`:** list_IPs
- **`-iR <number>`**: ランダムなIPの数。`--exclude <Ips>` や `--excludefile <file>` で除外できます。

### 機器検出

デフォルトでは Nmap は発見フェーズとして次を実行します: `-PA80 -PS443 -PE -PP`

- **`-sL`**: 非侵襲的で、名前解決のために **DNS** リクエストを行いターゲットを一覧化します。例えば www.prueba.es/24 が全て自分の対象かどうかを把握するのに有用です。
- **`-Pn`**: **ping を行わない**。対象がすべてアクティブであると分かっている場合に有用です（そうでないと時間を無駄にする可能性がありますが、 false negative を出して非アクティブと判断することもあります）。発見フェーズをスキップします。
- **`-sn`** : **ポートスキャンを行わない**。発見フェーズ完了後、ポートスキャンを行いません。比較的ステルスで、小規模ネットワークのスキャンに向きます。特権がある場合は ACK (-PA) を 80 に、SYN (-PS) を 443 に送り、echo と Timestamp リクエストを送ります。特権がない場合は常に接続を完了します。ターゲットがネットワークの場合は ARP(-PR) のみを使用します。他のオプションと併用した場合は、他オプションのパケットのみが送られます。
- **`-PR`**: **ARP ping**。自ネットワーク内のホスト解析でデフォルトで使われ、ping より速いです。ARP パケットを使いたくない場合は `--send-ip` を使います。
- **`-PS <ports>`**: SYN パケットを送信し、SYN/ACK が返れば open（接続を終わらせないために RST を返す）、RST が返れば closed、応答がなければ unreachable。特権がない場合は完全接続が自動で使われます。ポート指定がない場合は 80 に投げます。
- **`-PA <ports>`**: 前者と同様だが ACK を使います。両方を併用すると精度が向上します。
- **`-PU <ports>`**: 逆に、閉じていると予想されるポートに送ります。ファイアウォールが TCP 接続のみをチェックする場合があります。closed なら port unreachable、別の ICMP が返るか応答なしなら destination unreachable と判断します。
- **`-PE, -PP, -PM`** : ICMP PING: echo reply、timestamp、addressmask。ターゲットがアクティブかを確認するために投げられます。
- **`-PY<ports>`**: デフォルトで 80 に SCTP INIT プローブを送ります。INIT-ACK (open) や ABORT (closed)、何も返らない、あるいは ICMP unreachable (inactive) が返る場合があります。
- **`-PO <protocols>`**: ヘッダでプロトコルを指定します。デフォルトは 1(ICMP), 2(IGMP), 4(Encap IP)。ICMP, IGMP, TCP (6), UDP (17) の場合はプロトコルヘッダを送信し、その他は IP ヘッダのみ送信します。ヘッダの誤形成により Protocol unreachable や同プロトコルからの応答が返ってくることで up を判定する目的です。
- **`-n`**: DNS を行わない
- **`-R`**: 常に DNS

### ポートスキャン手法

- **`-sS`**: 接続を完了させないため痕跡を残さず、使えれば非常に良い（特権が必要）。デフォルトで使用されます。
- **`-sT`**: 接続を完了するため痕跡を残すが確実に使える。デフォルトは特権なし。
- **`-sU`**: UDP 用で遅い。主に DNS(53), SNMP(161,162), DHCP(67,68)。(`-sU53,161,162,67,68`): open(reply), closed(port unreachable), filtered(別の ICMP), open/filtered(無応答)。open/filtered の場合、`-sV` が多数のリクエストを送って nmap がサポートするバージョンを検出し、真の状態を判別できます。時間が大幅に増えます。
- **`-sY`**: SCTP。接続確立に失敗するためログが残らず、-PY と同様に動作します。
- **`-sN,-sX,-sF`:** Null, Fin, Xmas。いくつかのファイアウォールを突破して情報を引き出せる場合があります。標準準拠のマシンは SYN, RST, ACK フラグのない要求には RST で応答するという点に基づきます: open/filtered(無応答), closed(RST), filtered(ICMP unreachable)。Windows、Cisco、BSDI、OS/400 では信頼性が低い。Unix では有効。
- **`-sM`**: Maimon scan: FIN と ACK を送信。BSD 用。現在ではすべて closed と返ることが多いです。
- **`-sA, sW`**: ACK と Window。ファイアウォール検出に使い、ポートが filtered かどうかを知るために使います。-sW は open と closed を window 値で区別します: open (RST で window != 0), closed (RST window = 0), filtered (ICMP unreachable または無応答)。全て closed と返る場合はこの手法が効いていない可能性があります。少数の open なら正常、多数 open と少数 closed なら逆に動作している可能性があります。
- **`-sI`:** Idle scan。アクティブなファイアウォールがあるが特定 IP へのフィルタがないことを知っている場合（または匿名性を保ちたい場合）に zombie スキャナを使用できます（全ポートに対して動作）。可能な zombie を探すには ipidseq スクリプトや auxiliary/scanner/ip/ipidseq を使用します。このスキャンは IP パケットの IPID 番号に基づきます。
- **`--badsum`:** チェックサムを誤らせて送信。通常はホストがパケットを破棄しますが、ファイアウォールが何らかの応答を返す場合があり、それでファイアウォールを検出します。
- **`-sZ`:** "Weird" SCTP スキャナ。cookie echo fragments を送ると、open なら破棄され、closed なら ABORT で応答されるはずです。init が通らないファイアウォールを通過する場合がありますが、filtered と open の区別がつかない欠点があります。
- **`-sO`:** IP プロトコルスキャン。時にはプロトコルすら判別できないような壊れた空のヘッダを送ります。ICMP protocol unreachable が返れば closed、port unreachable が返れば open、別のエラーなら filtered、無応答なら open|filtered と判断します。
- **`-b <server>`:** FTPhost--> 別ホストからターゲットをスキャンするのに使います。別マシンの FTP に接続し、スキャンしたいポートにファイルを送らせ、その応答から open/closed を判断します。[\<user>:\<password>@]\<server>\[:\<port>] ほとんどの FTP サーバはこれを許可しないため実用性は低いです。

### 重点解析

**-p:** スキャンするポートを指定するのに使用します。全 65,535 ポートを選択するには: **-p-** または **-p all**。Nmap は人気度に基づく内部分類を持ち、デフォルトでは上位 1000 ポートを使用します。**-F** (fast scan) では上位 100 を分析します。**--top-ports <number>** で 1 から 65,335 の範囲で上位 <number> を分析します。ポートはランダム順にチェックされます；これを防ぐには **-r** を使います。特定ポートも指定可能: 20-30,80,443,1024-（後者は 1024 以降を意味します）。プロトコルでグループ化も可能: U:53,T:21-25,80,139,S:9。Nmap の popular ports の範囲内で範囲指定も可能: -p [-1024] は nmap-services に含まれるポートのうち 1024 までを分析します。**--port-ratio <ratio>** は 0 から 1 の比率で最も一般的なポートを分析します。

**-sV** バージョンスキャン。強度は 0 から 9 で調整可能、デフォルトは 7。

**--version-intensity <number>** 強度を調整します。低くするともっとも可能性の高いプローブのみを送るため、UDP スキャン時間を大幅に短縮できます。

**-O** OS 検出

**--osscan-limit** 適切なホストスキャンには最低 1 つの open ポートと 1 つの closed ポートが必要です。この条件を満たさない場合にこのオプションを設定すると OS 予測を試みません（時間節約）。

**--osscan-guess** OS 検出が完璧でない場合により推測を試みます。

**スクリプト**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

デフォルトスクリプトを使うには -sC または --script=default

利用可能なタイプ: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, vuln

- **Auth:** 利用可能な認証スクリプトをすべて実行
- **Default:** 基本的なデフォルトツールスクリプトを実行
- **Discovery:** ターゲットから情報を取得
- **External:** 外部リソースを使うスクリプト
- **Intrusive:** ターゲットに対して侵襲的と見なされるスクリプトを使用
- **Malware:** マルウェアやバックドアによって開かれた接続を確認
- **Safe:** 非侵襲的なスクリプトのみを実行
- **Vuln:** よく知られた脆弱性を発見
- **All:** 利用可能なすべての NSE 拡張スクリプトを実行

スクリプトを検索するには:

**nmap --script-help="http-\*" -> http- で始まるもの**

**nmap --script-help="not intrusive" -> intrusive 以外すべて**

**nmap --script-help="default or safe" -> どちらかに含まれるもの**

**nmap --script-help="default and safe" --> 両方に含まれるもの**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> スクリプトの進行状況に関する情報を提供

--script-updatedb

**スクリプトを使うには、単に: nmap --script Script_Name target** --> スクリプトを使うとスクリプトとスキャナの両方が実行されるため、スキャナオプションも追加可能です。**"safe=1"** を追加すると安全なもののみを実行します。

**時間制御**

**Nmap は秒、分、ms 単位で時間を指定できます:** --host-timeout 引数 900000ms, 900, 900s, および 15m は同じ意味です。

Nmap はスキャン対象ホストの総数をグループに分割し、これらのグループをブロック単位で解析します。ブロック内が全て解析されるまで次のブロックに移らないため（ユーザはブロック解析完了まで更新を受け取りません）、大きなグループを使う方が効率的です。デフォルトでは class C で 256 を使用します。

これは **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ で変更できます（並列スキャンのグループサイズを調整）。

並列スキャナの数を制御できますが、Nmap はネットワーク状況に基づいて自動制御するため変更しないほうが良い場合が多いです: **--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

RTT タイムアウトを変更できますが通常は不要です: **--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

試行回数を変更できます: **--max-retries** _**<numtries>**_

ホストのスキャン時間を変更できます: **--host-timeout** _**<time>**_

各テスト間の間隔を延ばして遅くできます: **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

1秒あたりのパケット数を変更できます: **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

filtered または closed のポートは応答に時間がかかることが多いです。open のみに興味がある場合は次で高速化できます: **--defeat-rst-ratelimit**

Nmap の攻撃性を定義するには: -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> 1 ポートずつしかスキャンせず、次のポートまで 5 分待つ

-T1 と T2 --> 非常に似ており、それぞれ次のテストまで 15 秒と 0.4 秒待つ

-T3 --> デフォルト動作。並列スキャンを含む

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

ポートへのアクセスを許可せず、パケットを解析します。

**-f** パケットをフラグメント化します。デフォルトではヘッダ後を 8 バイト単位で分割します。サイズを指定するには ..mtu を使います（この場合 -f は使わないでください）。オフセットは 8 の倍数である必要があります。**Version スキャナとスクリプトはフラグメンテーションをサポートしません**

**-D decoy1,decoy2,ME** Nmap はスキャナを送りますが送信元を他の IP として偽装します。これにより実際の発信者を隠せます。リストに ME を入れると Nmap は自分をその位置に置きます。完全に隠すには自分の前に 5~6 個置くのが良いです。ランダム IP は RND:<number> で生成できます。TCP バージョン検出（接続なし）では機能しません。内部ネットワーク内の場合はアクティブな IP を使うのが望ましく、そうしないと自分だけがアクティブだと判別されやすくなります。

ランダム IP を使う例: nmap -D RND:10 Target_IP

**-S IP** Nmap があなたの IP を拾えない場合に指定します。別のターゲットが自分をスキャンしているように見せかける用途にも使えます。

**-e <interface>** インターフェースを選択する

多くの管理者は動作上の都合で一部のエントリポートをすべて許可していることがあります（DNS や FTP ポート等）。この脆弱性を見つけるために Nmap は **--source-port** _**<portnumber>**_ ; **-g** _**<portnumber>**_ を提供します（同等）。

**--data** _**<hex string>**_ 16 進文字列を送る: --data 0xdeadbeef や --data \xCA\xFE\x09

**--data-string** _**<string>**_ 通常の文字列を送る: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Nmap はヘッダのみ送るが、これでランダムなバイト数を追加できます

IP パケットを完全に構成するには **--ip-options** を使います

送受信されるパケットのオプションを見たい場合は --packet-trace を指定します。IP options を使った Nmap の使用例や詳しい情報は [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52) を参照してください。

**--ttl** _**<value>**_

**--randomize-hosts** 攻撃を目立たなくするためにホスト順をランダム化

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ MAC を変更する。例: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ プロキシを使用する。場合によってはプロキシが Nmap の望むだけの同時接続を維持できないため、並列数を調整する必要があります: --max-parallelism

**-sP** ARP によって自ネットワーク内のホストを発見

多くの管理者は特定のポートから来るパケットをすべて通すルールを作っています（例: 20,53,67）。その場合、Nmap にこれらのポートからパケットを送らせることが可能です: **nmap --source-port 53 IP**

**出力**

**-oN file** 通常出力

**-oX file** XML 出力

**-oS file** Script kiddies 出力

**-oG file** Greppable 出力

**-oA file** -oS を除くすべて

**-v level** 冗長レベル

**-d level** デバッグレベル

**--reason** ホストと状態の理由表示

**--stats-every time** 指定間隔で進行状況を報告

**--packet-trace** 送出パケットを表示。フィルタは指定可能（例: --version-trace や --script-trace）

**--open** open, open|filtered, unfiltered を表示

**--resume file** サマリを出力して再開

**その他**

**-6** IPv6 を許可

**-A** は -O -sV -sC --traceroute と同等

**実行中の操作**

Nmap 実行中にオプションを変更できます:

v / V 冗長レベルを上げる/下げる

d / D デバッグレベルを上げる/下げる

p / P パケットトレースをオン/オフ

? ランタイムのヘルプ画面を表示

**Vulscan**

Nmap スクリプトで、得られたサービスのバージョン情報をオフラインデータベース（他の重要な DB からダウンロードしたもの）と照合して既知の脆弱性を返します。

使用する DB:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Nmap フォルダにダウンロードしてインストールするには:

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

DB パッケージもダウンロードして /usr/share/nmap/scripts/vulscan/ に追加する必要があります。

使用例:

すべてを使う: sudo nmap -sV --script=vulscan HOST_TO_SCAN

特定の DB を使う: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Nmap サービススキャンを16倍高速化

[**この投稿に従い**](https://joshua.hu/nmap-speedup-service-scanning-16x)、`/usr/share/nmap/nmap-service-probes` 内のすべての **`totalwaitms`** の値を **300** に、`tcpwrappedms` を **200** に変更すると nmap のサービス解析を高速化できます。

さらに、明示的に **`servicewaitms`** を持たないプローブはデフォルトで **`5000`** を使用します。したがって、各プローブに値を追加するか、あるいは **nmap を自分でコンパイル** して [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79) のデフォルト値を変更することができます。

`/usr/share/nmap/nmap-service-probes` ファイル内の **`totalwaitms`** と **`tcpwrappedms`** の値をまったく変更したくない場合は、[パース用のコード](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358) を編集して `nmap-service-probes` ファイル内のこれらの値を完全に無視するようにできます。

## 制限された環境向けに静的リンクされた Nmap をビルドする

ハードニングされた環境や最小限の Linux（コンテナ、アプライアンス）では、動的リンクされた Nmap バイナリがランタイムローダや共有ライブラリの欠如（例: /lib64/ld-linux-x86-64.so.2, libc.so）により失敗することがあります。静的にリンクした独自の Nmap をビルドし、NSE データをバイナリと同梱すれば、システムパッケージをインストールせずに実行できます。

大まかな手順
- Docker 経由でクリーンな amd64 Ubuntu ビルダーを使う。
- OpenSSL と PCRE2 を静的ライブラリとしてビルドする。
- libpcap/libdnet を同梱して動的依存を避け、Nmap を静的リンクでビルドする。
- バイナリに NSE スクリプトやデータディレクトリをバンドルする。

ターゲットアーキテクチャの検出（例）
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
ステップ1 — ツールチェーンを準備する
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
ステップ2 — OpenSSL (1.1.1w) を静的にビルドする
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
ステップ3 — PCRE2 (10.43) を静的にビルドする
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
ステップ4 — Nmap (7.98) を静的にビルドする
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
要点
- -static, -static-libstdc++, -static-libgcc は静的リンクを強制します。
- --with-libpcap=included/--with-libdnet=included を使うとシステムの共有ライブラリを回避します。
- sed による調整は、存在する場合共有 libpcap ターゲットを無効化します。

Step 5 — バイナリとNSEデータをバンドルする
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
検証および運用メモ
- アーティファクトに対して file を使用し、静的にリンクされていることを確認する。
- Nmap がインストールされていないホストでもスクリプトの整合性を保つため、NSE データをバイナリと一緒に保持する。
- 静的なバイナリであっても AppArmor/seccomp/SELinux によって実行がブロックされる可能性がある; DNS/egress は引き続き動作する必要がある。
- 決定論的ビルドは、不透明な “static” バイナリをダウンロードするよりもサプライチェーンリスクを低減する。

One-liner (Dockerized)
<details>
<summary>ビルド、バンドル、アーティファクト情報を表示</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## 参考資料

- [Compiling static Nmap binary for jobs in restricted environments](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (helper tool)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL sources](https://www.openssl.org/source/)
- [PCRE2 releases](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap source tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
