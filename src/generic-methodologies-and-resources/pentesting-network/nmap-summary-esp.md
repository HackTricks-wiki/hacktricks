# Nmap Σύνοψη (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Παράμετροι

### IPs to scan

- **`<ip>,<net/mask>`:** Υποδεικνύει τα ips άμεσα
- **`-iL <ips_file>`:** list_IPs
- **`-iR <number>`**: Αριθμός τυχαίων Ips, μπορείτε να εξαιρέσετε πιθανά Ips με `--exclude <Ips>` ή `--excludefile <file>`.

### Equipment discovery

Από προεπιλογή το Nmap ξεκινά φάση ανακάλυψης που αποτελείται από: `-PA80 -PS443 -PE -PP`

- **`-sL`**: Δεν είναι επεμβατικό, απαριθμεί τους στόχους κάνοντας DNS requests για να επιλύσει ονόματα. Είναι χρήσιμο για να ξέρουμε αν π.χ. για www.prueba.es/24 όλα τα Ips είναι στόχοι μας.
- **`-Pn`**: No ping. Αυτό είναι χρήσιμο αν γνωρίζετε ότι όλοι είναι ενεργοί (αν όχι, μπορεί να χάσετε πολύ χρόνο, αλλά αυτή η επιλογή επίσης δίνει false negatives λέγοντας ότι δεν είναι ενεργοί), αποτρέπει τη φάση ανακάλυψης.
- **`-sn`** : No port scan. Αφού ολοκληρωθεί η φάση αναγνώρισης, δεν σαρώνονται θύρες. Είναι σχετικά stealthy και επιτρέπει μικρή σάρωση δικτύου. Με προνόμια στέλνει ένα ACK (-PA) στην 80, ένα SYN(-PS) στην 443 και ένα echo request και ένα Timestamp request, χωρίς προνόμια ολοκληρώνει πάντα τις συνδέσεις. Αν ο στόχος είναι το δίκτυο, χρησιμοποιεί μόνο ARP(-PR). Αν χρησιμοποιηθεί με άλλη επιλογή, μόνο τα πακέτα της άλλης επιλογής παραλείπονται.
- **`-PR`**: Ping ARP. Χρησιμοποιείται από προεπιλογή όταν αναλύουμε υπολογιστές στο δικό μας δίκτυο, είναι ταχύτερο από τη χρήση pings. Αν δεν θέλετε να χρησιμοποιήσετε ARP πακέτα χρησιμοποιήστε `--send-ip`.
- **`-PS <ports>`**: Στέλνει SYN πακέτα στα οποία, αν απαντήσει SYN/ACK είναι open (απαντά με RST ώστε να μην τερματίσει τη σύνδεση), αν απαντήσει RST είναι closed και αν δεν απαντήσει είναι unreachable. Σε περίπτωση μη ύπαρξης προνομίων, χρησιμοποιείται αυτόματα πλήρης σύνδεση. Αν δεν δοθούν ports, το στέλνει στην 80.
- **`-PA <ports>`**: Όπως το προηγούμενο αλλά με ACK, ο συνδυασμός τους δίνει καλύτερα αποτελέσματα.
- **`-PU <ports>`**: Ο στόχος είναι το αντίθετο, στέλνονται σε θύρες που αναμένεται να είναι closed. Κάποια firewalls ελέγχουν μόνο TCP συνδέσεις. Αν είναι closed απαντάται με port unreachable, αν απαντηθεί με άλλο icmp ή δεν απαντηθεί αφήνεται ως destination unreachable.
- **`-PE, -PP, -PM`** : ICMP PINGS: echo reply, timestamp και addresmask. Εκτελούνται για να βρουν αν ο στόχος είναι ενεργός.
- **`-PY<ports>`**: Στέλνει SCTP INIT probes στην 80 από προεπιλογή, μπορεί να απαντηθεί INIT-ACK(open) ή ABORT(closed) ή τίποτα ή ICMP unreachable(inactive).
- **`-PO <protocols>`**: Δηλώνεται ένας protocol στους headers, από προεπιλογή 1(ICMP), 2(IGMP) και 4(Encap IP). Για τα πρωτόκολλα ICMP, IGMP, TCP (6) και UDP (17) στέλνονται τα protocol headers, για τα υπόλοιπα αποστέλλεται μόνο το IP header. Ο σκοπός είναι ότι λόγω μη έγκυρων headers μπορεί να απαντηθεί Protocol unreachable ή απαντήσεις του ίδιου protocol για να γνωριστεί αν είναι up.
- **`-n`**: No DNS
- **`-R`**: DNS always

### Port scanning techniques

- **`-sS`**: Δεν ολοκληρώνει τη σύνδεση οπότε δεν αφήνει ίχνος, πολύ καλό αν μπορεί να χρησιμοποιηθεί.(προνόμια) Είναι το προεπιλεγμένο.
- **`-sT`**: Ολοκληρώνει τη σύνδεση, οπότε αφήνει ίχνος, αλλά μπορεί να χρησιμοποιηθεί πάντα. Από προεπιλογή χωρίς προνόμια.
- **`-sU`**: Πιο αργό, για UDP. Κυρίως: DNS(53), SNMP(161,162), DHCP(67 και 68), (-sU53,161,162,67,68): open(reply), closed(port unreachable), filtered (άλλο ICMP), open/filtered (τίποτα). Σε περίπτωση open/filtered, -sV στέλνει πολλές αιτήσεις για να εντοπίσει οποιαδήποτε από τις εκδόσεις που υποστηρίζει το nmap και μπορεί να ανιχνεύσει την πραγματική κατάσταση. Αυξάνει πολύ τον χρόνο.
- **`-sY`**: SCTP scanner που αποτυγχάνει να καθιερώσει σύνδεση, οπότε δεν υπάρχουν logs, λειτουργεί όπως -PY
- **`-sN,-sX,-sF`:** Null, Fin, Xmas, μπορούν να διαπεράσουν κάποια firewalls και να εξάγουν πληροφορία. Βασίζονται στο ότι οι συστήματα συμβατά με το πρότυπο θα απαντούν με RST σε όλα τα requests που δεν έχουν SYN, RST ή ACK flags ανυψωμένα: open/filtered(τίποτα), closed(RST), filtered (ICMP unreachable). Αναξιόπιστα σε Windows, Cisco, BSDI και OS/400. Σε unix ναι.
- **`-sM`**: Maimon scan: Στέλνει FIN και ACK flags, χρησιμοποιείται για BSD, τώρα θα επιστρέφει όλα ως closed.
- **`-sA, sW`**: ACK και Window, χρησιμοποιείται για να εντοπίσει firewalls, για να ξέρουμε αν οι θύρες είναι filtered ή όχι. Το -sW διακρίνει μεταξύ open/closed αφού οι ανοιχτές απαντούν με διαφορετική τιμή window: open (RST με window διαφορετικό από 0), closed (RST window = 0), filtered (ICMP unreachable ή τίποτα). Όλοι οι υπολογιστές δεν λειτουργούν έτσι, οπότε αν όλα είναι closed, δεν λειτουργεί, αν είναι λίγα open, λειτουργεί καλά, και αν είναι πολλά open και λίγα closed, λειτουργεί ανάποδα.
- **`-sI`:** Idle scan. Για περιπτώσεις όπου υπάρχει ενεργό firewall αλλά γνωρίζουμε ότι δεν φιλτράρει προς μια συγκεκριμένη Ip (ή όταν απλώς θέλουμε ανωνυμία) μπορούμε να χρησιμοποιήσουμε το zombie scanner (λειτουργεί για όλες τις θύρες), για να ψάξουμε πιθανούς zombies μπορούμε να χρησιμοποιήσουμε το scrpit ipidseq ή το exploit auxiliary/scanner/ip/ipidseq. Αυτός ο scanner βασίζεται στον αριθμό IPID των IP πακέτων.
- **`--badsum`:** Στέλνει το checksum λάθος, οι υπολογιστές θα απορρίψουν τα πακέτα, αλλά τα firewalls θα μπορούσαν να απαντήσουν κάτι, χρησιμοποιείται για να ανιχνεύσει firewalls.
- **`-sZ`:** "Weird" SCTP scanner, όταν στέλνει probes με cookie echo fragments θα πρέπει να απορριφθούν αν είναι open ή να απαντηθούν με ABORT αν είναι closed. Μπορεί να περάσει από firewalls που το init δεν περνά, το κακό είναι ότι δεν διακρίνει μεταξύ filtered και open.
- **`-sO`:** Protocol Ip scan. Στέλνει κατεστραμμένα και άδεια headers στα οποία μερικές φορές ούτε το protocol μπορεί να διακρίνεται. Αν φτάσει ICMP unreachable protocol είναι closed, αν φτάσει unreachable port είναι open, αν έρθει άλλο σφάλμα, filtered, αν δεν έρθει τίποτα, open|filtered.
- **`-b <server>`:** FTPhost--> Χρησιμοποιείται για να σαρώσει έναν host από έναν άλλο, αυτό γίνεται συνδεόμενοι στο ftp μιας άλλης μηχανής και ζητώντας της να στείλει αρχεία στις θύρες που θέλετε να σαρώσετε από άλλη μηχανή, ανάλογα με τις απαντήσεις θα ξέρουμε αν είναι open ή όχι. [\<user>:\<password>@]\<server>\[:\<port>] Σχεδόν όλοι οι ftp servers πλέον δεν το επιτρέπουν και επομένως έχει μικρή πρακτική χρησιμότητα.

### **Focus Analysis**

**-p:** Χρησιμοποιείται για να καθορίσει θύρες προς σάρωση. Για να επιλέξετε όλες τις 65,335 θύρες: **-p-** ή **-p all**. Το Nmap έχει εσωτερική κατάταξη βάσει δημοτικότητας. Από προεπιλογή, χρησιμοποιεί τις top 1000 θύρες. Με **-F** (fast scan) αναλύει τις top 100. Με **--top-ports <number>** αναλύει αυτόν τον αριθμό κορυφαίων θυρών (από 1 έως 65,335). Ελέγχει τις θύρες σε τυχαία σειρά· για να το αποτρέψετε, χρησιμοποιήστε **-r**. Μπορούμε επίσης να επιλέξουμε συγκεκριμένες θύρες: 20-30,80,443,1024- (το τελευταίο σημαίνει να κοιτάξει από 1024 και πάνω). Μπορούμε επίσης να ομαδοποιήσουμε θύρες ανά πρωτόκολλο: U:53,T:21-25,80,139,S:9. Μπορούμε επίσης να επιλέξουμε ένα range εντός των δημοφιλών θυρών του Nmap: -p [-1024] αναλύει μέχρι τη θύρα 1024 από αυτές που περιλαμβάνονται στο nmap-services. **--port-ratio <ratio>** Αναλύει τις πιο κοινές θύρες εντός ενός λόγου μεταξύ 0 και 1

**-sV** Version scanning, η ένταση μπορεί να ρυθμιστεί από 0 έως 9, προεπιλογή 7.

**--version-intensity <number>** Ρυθμίζουμε την ένταση, όσο πιο χαμηλή είναι τόσο λιγότερες και πιο πιθανές probes θα εκτελέσει, όχι όλες. Με αυτό μπορούμε να μειώσουμε σημαντικά τον χρόνο σάρωσης UDP

**-O** OS detection

**--osscan-limit** Για σωστή ανίχνευση host, χρειάζεται τουλάχιστον μία open port και μία closed port. Αν αυτή η προϋπόθεση δεν ικανοποιείται και έχουμε ενεργοποιήσει αυτή την επιλογή, δεν θα επιχειρήσει πρόβλεψη OS (εξοικονομεί χρόνο)

**--osscan-guess** Όταν η ανίχνευση OS δεν είναι τέλεια, αυτό την κάνει να προσπαθήσει περισσότερο

**Scripts**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

Για χρήση των default scripts, χρησιμοποιήστε -sC ή --script=default

Διαθέσιμοι τύποι είναι: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, και vuln

- **Auth:** εκτελεί όλα τα διαθέσιμα authentication scripts
- **Default:** εκτελεί βασικά default tool scripts
- **Discovery:** ανακτά πληροφορίες από τον στόχο ή θύμα
- **External:** script για χρήση εξωτερικών πόρων
- **Intrusive:** χρησιμοποιεί scripts που θεωρούνται intrusive προς το θύμα ή στόχο
- **Malware:** ελέγχει για συνδέσεις ανοιγμένες από κακόβουλο κώδικα ή backdoors
- **Safe:** εκτελεί μη επεμβατικά scripts
- **Vuln:** εντοπίζει τις πιο γνωστές ευπάθειες
- **All:** εκτελεί απολύτως όλα τα διαθέσιμα NSE extension scripts

Για να αναζητήσετε scripts:

**nmap --script-help="http-\*" -> Those starting with http-**

**nmap --script-help="not intrusive" -> All except those**

**nmap --script-help="default or safe" -> Those in either or both**

**nmap --script-help="default and safe" --> Those in both**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> Παρέχει πληροφορίες για την πορεία εκτέλεσης του script

--script-updatedb

**Για να χρησιμοποιήσετε ένα script, απλά γράψτε: nmap --script Script_Name target** --> Όταν χρησιμοποιείτε το script, θα εκτελέσουν τόσο το script όσο και ο scanner, οπότε μπορούν να προστεθούν και επιλογές scanner. Μπορούμε να προσθέσουμε **"safe=1"** για να εκτελεστούν μόνο τα safe.

**Time Control**

**Το Nmap μπορεί να ορίσει χρόνους σε seconds, minutes, ms:** --host-timeout arguments 900000ms, 900, 900s, and 15m όλα κάνουν το ίδιο.

Το Nmap διαιρεί τον συνολικό αριθμό hosts προς σάρωση σε ομάδες και αναλύει αυτές τις ομάδες σε blocks, οπότε δεν μεταβαίνει στο επόμενο block μέχρι να αναλυθούν όλα (και ο χρήστης δεν λαμβάνει ενημερώσεις μέχρι να ολοκληρωθεί το block). Έτσι, είναι πιο βέλτιστο για το Nmap να χρησιμοποιεί μεγάλες ομάδες. Από προεπιλογή σε class C χρησιμοποιεί 256.

Αυτό μπορεί να αλλάξει με **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ (Προσαρμόζει τα μεγέθη ομάδων παράλληλης σάρωσης)

Μπορείτε να ελέγξετε τον αριθμό των παράλληλων scanners αλλά προτιμάται να μην το κάνετε (το Nmap ήδη ενσωματώνει αυτόματο έλεγχο βάσει της κατάστασης του δικτύου): **--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

Μπορούμε να τροποποιήσουμε το RTT timeout, αλλά συνήθως δεν είναι απαραίτητο: **--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

Μπορούμε να τροποποιήσουμε τον αριθμό των προσπαθειών: **--max-retries** _**<numtries>**_

Μπορούμε να τροποποιήσουμε τον χρόνο σάρωσης ενός host: **--host-timeout** _**<time>**_

Μπορούμε να τροποποιήσουμε τον χρόνο μεταξύ κάθε δοκιμής για να επιβραδύνουμε: **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

Μπορούμε να τροποποιήσουμε τον αριθμό πακέτων ανά δευτερόλεπτο: **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

Πολλές θύρες παίρνουν πολύ χρόνο να απαντήσουν όταν είναι filtered ή closed. Αν μας ενδιαφέρουν μόνο οι open, μπορούμε να επιταχύνουμε με: **--defeat-rst-ratelimit**

Για να ορίσουμε πόσο επιθετικό θέλουμε το Nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> Σκανάρει μόνο 1 θύρα τη φορά και περιμένει 5min μέχρι την επόμενη

-T1 και T2 --> Πολύ παρόμοια αλλά περιμένουν μόνο 15 και 0.4sec αντίστοιχα μεταξύ κάθε δοκιμής

-T3 --> Προεπιλεγμένη λειτουργία, περιλαμβάνει παράλληλη σάρωση

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Δεν επιτρέπουν πρόσβαση σε θύρες και αναλύουν πακέτα.

**-f** Για fragmentation των πακέτων, από προεπιλογή τα τεμαχίζει σε 8bytes μετά το header, για να καθορίσετε αυτό το μέγεθος χρησιμοποιούμε ..mtu (με αυτό, μην χρησιμοποιείτε -f), το offset πρέπει να είναι πολλαπλάσιο του 8. **Version scanners και scripts δεν υποστηρίζουν fragmentation**

**-D decoy1,decoy2,ME** Το Nmap στέλνει scanners αλλά με άλλες IP διευθύνσεις ως προέλευση, έτσι σε κρύβει. Αν βάλεις ME στη λίστα, το Nmap θα σε τοποθετήσει εκεί, καλύτερα να βάλεις 5 ή 6 πριν από εσένα για να σε αποκρύψει πλήρως. Μπορούν να παραχθούν τυχαίες IP με RND:<number> για να δημιουργηθούν <number> τυχαίων IPs. Δεν δουλεύουν με TCP version detectors χωρίς σύνδεση. Αν είσαι μέσα σε δίκτυο, σε ενδιαφέρουν ενεργά IPs, διαφορετικά θα είναι πολύ εύκολο να καταλάβουν ότι είσαι ο μόνος ενεργός.

Για χρήση τυχαίων IPs: nmap -D RND:10 Target_IP

**-S IP** Όταν το Nmap δεν πιάνει τη δική σου IP πρέπει να τη δώσεις με αυτό. Επίσης χρησιμεύει για να τους κάνεις να νομίζουν ότι άλλος στόχος τους σκανάρει.

**-e <interface>** Για να επιλέξετε το interface

Πολλοί διαχειριστές αφήνουν κάποια είσοδο ports ανοιχτά για να δουλεύουν όλα σωστά και τους είναι ευκολότερο από το να βρουν άλλη λύση. Αυτά μπορεί να είναι DNS ports ή FTP ports... για να βρούμε αυτή την ευπάθεια το Nmap περιλαμβάνει: **--source-port** _**<portnumber>**_**;-g** _**<portnumber>**_ _Είναι ισοδύναμα_

**--data** _**<hex string>**_ Για να στείλετε hexadecimal text: --data 0xdeadbeef and --data \xCA\xFE\x09

**--data-string** _**<string>**_ Για να στείλετε κανονικό κείμενο: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Το Nmap στέλνει μόνο headers, με αυτό επιτυγχάνουμε την προσθήκη ενός αριθμού επιπλέον bytes (που θα δημιουργηθούν τυχαία)

Για να διαμορφώσετε πλήρως το IP packet χρησιμοποιήστε **--ip-options**

Αν θέλετε να δείτε τις επιλογές στα πακέτα που στέλνονται και λαμβάνονται, καθορίστε --packet-trace. Για περισσότερες πληροφορίες και παραδείγματα χρήσης των IP options με Nmap, δείτε [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**<value>**_

**--randomize-hosts** Για να κάνετε την επίθεση λιγότερο εμφανή

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ Για αλλαγή MAC παραδείγματα: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, and Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ Για χρήση proxies, μερικές φορές ένας proxy δεν διατηρεί τόσες ανοιχτές συνδέσεις όσο χρειάζεται το Nmap οπότε η παράλληλη λειτουργία θα πρέπει να προσαρμοστεί: --max-parallelism

**-sP** Για να ανακαλύψετε hosts στο δίκτυό μας με ARP

Πολλοί διαχειριστές δημιουργούν κανόνα firewall που επιτρέπει όλα τα πακέτα που προέρχονται από μια συγκεκριμένη θύρα να περνάνε (όπως 20,53 και 67), μπορούμε να πούμε στο Nmap να στείλει τα πακέτα μας από αυτές τις θύρες: **nmap --source-port 53 IP**

**Outputs**

**-oN file** Normal output

**-oX file** XML output

**-oS file** Script kiddies output

**-oG file** Greppable output

**-oA file** All except -oS

**-v level** verbosity

**-d level** debugging

**--reason** Λόγος για host και state

**--stats-every time** Κάθε αυτό το χρόνο μας ενημερώνει για την πορεία

**--packet-trace** Για να δείτε ποια πακέτα φεύγουν, μπορούν να καθοριστούν φίλτρα όπως: --version-trace or --script-trace

**--open** δείχνει open, open|filtered και unfiltered

**--resume file** Εξάγει μια σύνοψη

**Miscellaneous**

**-6** Επιτρέπει IPv6

**-A** ισοδυναμεί με -O -sV -sC --traceroute

**Run time**

Ενώ τρέχει το Nmap μπορούμε να αλλάξουμε επιλογές:

v / V Αυξάνει / μειώνει το επίπεδο verbosity

d / D Αυξάνει / μειώνει το επίπεδο debugging

p / P Ενεργοποιεί / απενεργοποιεί το packet tracing

? Εκτυπώνει μια οθόνη βοήθειας για runtime interaction

**Vulscan**

Nmap script που κοιτάζει εκδόσεις υπηρεσιών που λήφθηκαν σε μια offline βάση δεδομένων (κατεβασμένη από άλλες σημαντικές) και επιστρέφει πιθανές ευπάθειες

Οι βάσεις δεδομένων που χρησιμοποιεί είναι:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Για να κατεβάσετε και να εγκαταστήσετε στον φάκελο Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Θα χρειαστεί επίσης να κατεβάσετε τα πακέτα DB και να τα προσθέσετε στο /usr/share/nmap/scripts/vulscan/

Χρήση:

Για να χρησιμοποιήσετε όλα: sudo nmap -sV --script=vulscan HOST_TO_SCAN

Για να χρησιμοποιήσετε συγκεκριμένη DB: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Speed Up Nmap Service scan x16

Σύμφωνα με [**this post**](https://joshua.hu/nmap-speedup-service-scanning-16x) μπορείτε να επιταχύνετε την ανάλυση υπηρεσιών του nmap τροποποιώντας όλες τις τιμές **`totalwaitms`** στο **`/usr/share/nmap/nmap-service-probes`** σε **300** και **`tcpwrappedms`** σε **200**.

Επιπλέον, probes που δεν έχουν συγκεκριμένα ορισμένο **`servicewaitms`** χρησιμοποιούν προεπιλεγμένη τιμή **`5000`**. Επομένως, είτε μπορούμε να προσθέσουμε τιμές σε κάθε probe, είτε μπορούμε να **συμπιέσουμε το nmap** μόνοι μας και να αλλάξουμε την προεπιλεγμένη τιμή στο [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79).

Αν δεν θέλετε καθόλου να αλλάξετε τις τιμές **`totalwaitms`** και **`tcpwrappedms`** στο αρχείο `/usr/share/nmap/nmap-service-probes`, μπορείτε να επεξεργαστείτε τον [parsing code](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358) έτσι ώστε αυτές οι τιμές στο αρχείο `nmap-service-probes` να αγνοούνται πλήρως.

## Build a static Nmap for restricted environments

Σε hardened ή minimal Linux περιβάλλοντα (containers, appliances), τα dynamically linked Nmap binaries συχνά αποτυγχάνουν λόγω έλλειψης runtime loaders ή shared libraries (π.χ., /lib64/ld-linux-x86-64.so.2, libc.so). Η δημιουργία ενός statically linked Nmap και το πακετάρισμα των NSE δεδομένων επιτρέπει την εκτέλεση χωρίς εγκατάσταση συστημικών πακέτων.

Υψηλού επιπέδου προσέγγιση
- Χρησιμοποιήστε ένα clean amd64 Ubuntu builder μέσω Docker.
- Build OpenSSL και PCRE2 ως static libraries.
- Build Nmap συνδέοντας statically και χρησιμοποιώντας τα συμπεριλαμβανόμενα libpcap/libdnet για να αποφύγετε dynamic deps.
- Bundle NSE scripts και data directories με το binary.

Discover target architecture (example)
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
Βήμα 1 — Προετοιμάστε το toolchain
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
Βήμα 2 — Κατασκευή στατικού OpenSSL (1.1.1w)
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
Βήμα 3 — Κατασκευή στατικού PCRE2 (10.43)
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
Βήμα 4 — Κατασκευή στατικού Nmap (7.98)
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
Βασικά σημεία
- -static, -static-libstdc++, -static-libgcc επιβάλλουν στατική σύνδεση.
- Η χρήση --with-libpcap=included/--with-libdnet=included αποφεύγει τα system-shared libs.
- Ένα tweak με sed ουδετεροποιεί έναν στόχο shared libpcap αν υπάρχει.

Βήμα 5 — Συσκευασία του binary και των δεδομένων NSE
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
Σημειώσεις επαλήθευσης και ops
- Χρησιμοποιήστε το file πάνω στο artifact για να επιβεβαιώσετε ότι είναι statically linked.
- Διατηρήστε τα δεδομένα NSE μαζί με το binary ώστε να εξασφαλιστεί η ισοτιμία των script σε hosts χωρίς εγκατεστημένο Nmap.
- Ακόμη και με static binary, η εκτέλεση μπορεί να μπλοκαριστεί από AppArmor/seccomp/SELinux· το DNS/egress πρέπει να λειτουργεί.
- Τα Deterministic builds μειώνουν τον κίνδυνο supply-chain σε σύγκριση με το να κατεβάζετε αδιαφανή “static” binaries.

One-liner (Dockerized)
<details>
<summary>Κατασκευή, πακετάρισμα και εκτύπωση πληροφοριών artifact</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## Αναφορές

- [Compiling static Nmap binary for jobs in restricted environments](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (helper tool)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL sources](https://www.openssl.org/source/)
- [PCRE2 releases](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap source tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
