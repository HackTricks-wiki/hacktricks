# Podsumowanie Nmap (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parametry

### Adresy IP do skanowania

- **`<ip>,<net/mask>`:** Wskaż adresy IP bezpośrednio
- **`-iL <ips_file>`:** plik z listą IP
- **`-iR <number>`**: Liczba losowych IP, możesz wykluczyć możliwe IP używając `--exclude <Ips>` lub `--excludefile <file>`.

### Wykrywanie urządzeń

Domyślnie Nmap uruchamia fazę wykrywania składającą się z: `-PA80 -PS443 -PE -PP`

- **`-sL`**: Nieinwazyjne, listuje cele wykonując zapytania **DNS** w celu rozwiązania nazw. Przydatne, by sprawdzić np. czy dla www.prueba.es/24 wszystkie IP są naszymi celami.
- **`-Pn`**: **Brak pingowania**. Przydatne, gdy wiemy, że wszystkie są aktywne (w przeciwnym razie można stracić dużo czasu, ale ta opcja może też dawać fałszywe negatywy twierdząc, że nie są aktywne), zapobiega fazie wykrywania.
- **`-sn`** : **Brak skanowania portów**. Po zakończeniu fazy rozpoznania nie skanuje portów. Relatywnie skryte, pozwala na szybkie skanowanie małej sieci. Z uprawnieniami wysyła ACK (-PA) na 80, SYN(-PS) na 443 oraz echo request i Timestamp request, bez uprawnień zawsze kończy połączenia. Jeśli celem jest sieć, używa tylko ARP(-PR). Użyte z inną opcją, zostaną odrzucone tylko pakiety innej opcji.
- **`-PR`**: **Ping ARP**. Używane domyślnie przy analizie komputerów w naszej sieci, szybsze niż używanie pingów. Jeśli nie chcesz używać pakietów ARP, użyj `--send-ip`.
- **`-PS <ports>`**: Wysyła pakiety SYN; jeśli odpowie SYN/ACK oznacza open (odpowiada RST, by nie kończyć połączenia), jeśli odpowie RST to closed, a jeśli nie odpowie to unreachable. W przypadku braku uprawnień używana jest automatycznie pełna konekcja. Jeśli nie podano portów, używa 80.
- **`-PA <ports>`**: Jak poprzedni, ale z ACK; łączenie obu daje lepsze wyniki.
- **`-PU <ports>`**: Cel jest odwrotny — wysyłane do portów, które oczekuje się, że będą closed. Niektóre firewalle sprawdzają tylko połączenia TCP. Jeśli jest closed, odpowiedziane jest port unreachable; jeśli odpowie innym icmp lub brak odpowiedzi — oznaczane jako destination unreachable.
- **`-PE, -PP, -PM`** : ICMP PINGS: echo reply, timestamp i addresmask. Uruchamiane, by sprawdzić czy cel jest aktywny.
- **`-PY<ports>`**: Wysyła SCTP INIT probes na 80 domyślnie; może odpowiedzieć INIT-ACK(open) lub ABORT(closed) lub nic albo ICMP unreachable(inactive).
- **`-PO <protocols>`**: W nagłówkach wskazuje protokół, domyślnie 1(ICMP), 2(IGMP) i 4(Encap IP). Dla protokołów ICMP, IGMP, TCP (6) i UDP (17) wysyłane są nagłówki protokołów, dla pozostałych tylko nagłówek IP. Celem jest rozmycie nagłówków tak, by pojawiły się odpowiedzi typu Protocol unreachable lub odpowiedzi tego samego protokołu, by ustalić, czy host jest up.
- **`-n`**: Brak DNS
- **`-R`**: Zawsze DNS

### Techniki skanowania portów

- **`-sS`**: Nie kończy połączenia, więc nie zostawia śladu; bardzo dobre, jeśli można go użyć (wymaga uprawnień). Używane domyślnie.
- **`-sT`**: Kończy połączenie, więc zostawia ślad, ale można go użyć bez wątpliwości. Domyślnie bez uprawnień.
- **`-sU`**: Wolniejsze, dla UDP. Głównie: DNS(53), SNMP(161,162), DHCP(67 i 68), (-sU53,161,162,67,68): open(reply), closed(port unreachable), filtered (inne ICMP), open/filtered (brak odpowiedzi). W przypadku open/filtered, -sV wysyła liczne zapytania, aby wykryć którąkolwiek z wersji wspieranych przez nmap i może wykryć prawdziwy stan. Zwiększa znacząco czas.
- **`-sY`**: SCTP — nie udaje się nawiązać połączenia, więc nie ma logów; działa podobnie do -PY
- **`-sN,-sX,-sF`:** Null, Fin, Xmas — mogą przeniknąć niektóre firewalle i wydobyć informacje. Bazują na tym, że maszyny zgodne ze standardem powinny odpowiadać RST na wszystkie żądania bez SYN, RST lub ACK ustawionych: open/filtered (brak odpowiedzi), closed(RST), filtered (ICMP unreachable). Niewiarygodne na Windows, Cisco, BSDI i OS/400. Na unix tak.
- **`-sM`**: Maimon scan: Wysyła FIN i ACK, używane dla BSD, obecnie zwróci wszystkie jako closed.
- **`-sA, sW`**: ACK i Window, używane do wykrywania firewalli, by określić czy porty są filtrowane. -sW rozróżnia open/closed poprzez różną wartość window: open (RST z window != 0), closed (RST window = 0), filtered (ICMP unreachable lub brak odpowiedzi). Nie wszystkie maszyny tak działają; jeśli wszystkie są closed, to nie działa, jeśli kilka open — działa dobrze, jeśli wiele open i kilka closed — działa odwrotnie.
- **`-sI`:** Idle scan. Gdy jest aktywny firewall, ale wiemy, że nie filtruje do pewnego IP (lub gdy chcemy anonimowości), można użyć zombie scanner (działa dla wszystkich portów). Aby znaleźć możliwe zombie można użyć skryptu ipidseq lub exploit auxiliary/scanner/ip/ipidseq. Ten skaner bazuje na numerze IPID pakietów IP.
- **`--badsum`:** Wysyła błędną sumę kontrolną; komputery odrzuciłyby pakiety, ale firewalle mogą odpowiedzieć, używane do wykrywania firewalli.
- **`-sZ`:** "Weird" SCTP scanner — wysyłając probe z cookie echo fragments powinny być odrzucone jeśli open lub odpowiedziane ABORT jeśli closed. Może przejść przez firewalle, przez które init nie przechodzi; wada: nie rozróżnia filtered i open.
- **`-sO`:** Skan protokołów IP. Wysyła złe i puste nagłówki, w których czasem nie da się rozpoznać protokołu. Jeśli nadejdzie ICMP protocol unreachable — closed, jeśli ICMP port unreachable — open, jeśli inny błąd — filtered, jeśli brak odpowiedzi — open|filtered.
- **`-b <server>`:** FTPhost --> Używane do skanowania hosta z innego hosta; łączy się z FTP innej maszyny i każe jej wysyłać pliki na porty, które chcesz skanować z innej maszyny; na podstawie odpowiedzi dowiemy się, czy są open. [\<user>:\<password>@]\<server>\[:\<port>] Prawie wszystkie serwery FTP już tego nie pozwalają, więc ma niewiele praktycznego zastosowania.

### Analiza — szczegóły

**-p:** Używane do określenia portów do skanowania. Aby wybrać wszystkie 65,535 portów: **-p-** lub **-p all**. Nmap ma wewnętrzną klasyfikację opartą na popularności. Domyślnie używa top 1000 portów. Z **-F** (fast scan) analizuje top 100. Z **--top-ports <number>** analizuje tę liczbę najpopularniejszych portów (od 1 do 65,535). Sprawdza porty w losowej kolejności; by temu zapobiec, użyj **-r**. Możemy też wybrać konkretne porty: 20-30,80,443,1024- (to ostatnie oznacza od 1024 wzwyż). Możemy grupować porty według protokołów: U:53,T:21-25,80,139,S:9. Możemy też wybrać zakres w ramach popularnych portów Nmap: -p [-1024] analizuje do portu 1024 z tych uwzględnionych w nmap-services. **--port-ratio <ratio>** Analizuje najbardziej typowe porty w proporcji między 0 a 1

**-sV** Skanowanie wersji, intensywność można regulować od 0 do 9, domyślnie 7.

**--version-intensity <number>** Regulujemy intensywność — im niższa, tym uruchamiane są tylko najbardziej prawdopodobne sondy, a nie wszystkie. Dzięki temu znacznie można skrócić czas skanowania UDP.

**-O** Wykrywanie OS

**--osscan-limit** Do poprawnego skanowania hosta potrzebny jest przynajmniej jeden open i jeden closed port. Jeśli ten warunek nie jest spełniony i ustawiliśmy tę opcję, nie spróbuje przewidywać OS (oszczędza czas).

**--osscan-guess** Gdy wykrywanie OS nie jest pewne, zmusza do większego wysiłku w celu odgadnięcia.

**Skrypty**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

Aby użyć domyślnych skryptów, użyj -sC lub --script=default

Dostępne typy: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, i vuln

- **Auth:** uruchamia wszystkie dostępne skrypty uwierzytelniające
- **Default:** uruchamia podstawowe skrypty narzędzia
- **Discovery:** pobiera informacje z celu lub ofiary
- **External:** skrypt korzystający z zasobów zewnętrznych
- **Intrusive:** używa skryptów uznawanych za inwazyjne wobec celu
- **Malware:** sprawdza połączenia otwarte przez złośliwy kod lub backdoory
- **Safe:** uruchamia nieinwazyjne skrypty
- **Vuln:** odkrywa najbardziej znane podatności
- **All:** uruchamia absolutnie wszystkie dostępne skrypty NSE

Aby wyszukać skrypty:

**nmap --script-help="http-\*" -> Te zaczynające się od http-**

**nmap --script-help="not intrusive" -> Wszystkie poza inwazyjnymi**

**nmap --script-help="default or safe" -> Te należące do któregoś z nich**

**nmap --script-help="default and safe" --> Te należące do obu**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> Dostarcza informacji o postępie skryptu

--script-updatedb

**Aby użyć skryptu, wpisz: nmap --script Script_Name target** --> Przy użyciu skryptu zarówno skrypt, jak i skaner zostaną wykonane, więc można też dodać opcje skanera. Możemy dodać **"safe=1"** by wykonać tylko bezpieczne.

**Kontrola czasu**

**Nmap może przyjmować czasy w sekundach, minutach, ms:** --host-timeout argumenty 900000ms, 900, 900s, i 15m znaczą to samo.

Nmap dzieli łączną liczbę hostów do przeskanowania na grupy i analizuje je partiami; nie przechodzi do następnej partii dopóki wszystkie nie zostaną przeanalizowane (użytkownik nie otrzymuje aktualizacji dopóki partia nie zostanie zrobiona). W ten sposób optymalne jest używanie dużych grup. Domyślnie dla klasy C używa 256.

Można to zmienić za pomocą **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ (Dopasowuje rozmiary równoległych grup skanowania)

Możesz kontrolować liczbę równoległych skanerów, ale lepiej nie (Nmap ma automatyczną kontrolę opartą na stanie sieci): **--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

Możemy zmodyfikować timeout RTT, ale zwykle nie jest to konieczne: **--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

Możemy zmienić liczbę prób: **--max-retries** _**<numtries>**_

Możemy zmienić czas skanowania hosta: **--host-timeout** _**<time>**_

Możemy zmienić opóźnienie między testami, by zwolnić: **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

Możemy zmienić liczbę pakietów na sekundę: **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

Wiele portów długo odpowiada, gdy są filtrowane lub closed. Jeśli interesują nas tylko open, możemy przyspieszyć: **--defeat-rst-ratelimit**

Aby zdefiniować jak agresywny ma być Nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> Skanuje tylko 1 port naraz i czeka 5min do następnego

-T1 i T2 --> Bardzo podobne, ale czekają tylko 15s i 0.4s odpowiednio między testami

-T3 --> Domyślne działanie, zawiera skanowanie równoległe

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Blokują dostęp do portów i analizują pakiety.

**-f** Fragmentuje pakiety, domyślnie dzieli na fragmenty po 8 bajtów po nagłówku; by określić rozmiar użyj ..mtu (dla tego nie używaj -f), offset musi być wielokrotnością 8. **Version scanners i skrypty nie obsługują fragmentacji**

**-D decoy1,decoy2,ME** Nmap wysyła skany podając inne IP jako źródła, dzięki czemu się maskujesz. Jeśli umieścisz ME na liście, Nmap umieści tam twoje IP; lepiej umieścić 5-6 przed tobą by całkowicie się zamaskować. Losowe IP można wygenerować przez RND:<number> aby wygenerować <number> losowych IP. Nie działają z detektorami wersji TCP bez połączenia. Jeśli jesteś wewnątrz sieci, lepiej używać aktywnych IP, bo inaczej łatwo będzie ustalić, że jesteś jedynym aktywnym.

Aby użyć losowych IP: nmap -D RND:10 Target_IP

**-S IP** Gdy Nmap nie wykryje twojego IP, należy je podać tą opcją. Służy też do podszywania się pod inny skaner.

**-e <interface>** Wybór interfejsu

Wielu administratorów zostawia otwarte porty źródłowe, by wszystko działało poprawnie — łatwiej niż szukać innych rozwiązań. Mogą to być porty DNS lub FTP... by znaleźć tę słabość Nmap oferuje: **--source-port** _**<portnumber>**_**;-g** _**<portnumber>**_ _Są równoważne_

**--data** _**<hex string>**_ Aby wysłać heksadecymalny tekst: --data 0xdeadbeef i --data \xCA\xFE\x09

**--data-string** _**<string>**_ Aby wysłać zwykły tekst: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Nmap wysyła tylko nagłówki; z tym dodajemy liczbę dodatkowych bajtów (wygenerowanych losowo)

Aby w pełni skonfigurować pakiet IP użyj **--ip-options**

Jeśli chcesz zobaczyć opcje w wysyłanych i otrzymywanych pakietach, określ --packet-trace. Dla więcej informacji i przykładów użycia IP options z Nmap zobacz [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**<value>**_

**--randomize-hosts** Aby uczynić atak mniej oczywistym

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ Aby zmienić MAC przykłady: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, i Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ Aby używać proxy; czasami proxy nie utrzymuje tylu połączeń równoległych co Nmap, więc trzeba zmodyfikować równoległość: --max-parallelism

**-sP** Do odkrywania hostów w naszej sieci przez ARP

Wielu administratorów tworzy regułę firewall, która przepuszcza wszystkie pakiety pochodzące z konkretnego portu (np. 20,53 i 67); możemy kazać Nmap wysyłać pakiety ze źródłowego portu: **nmap --source-port 53 IP**

**Wyjścia**

**-oN file** Normalne wyjście

**-oX file** Wyjście XML

**-oS file** Script kiddies output

**-oG file** Greppable output

**-oA file** Wszystkie (oprócz -oS)

**-v level** poziom szczegółowości (verbosity)

**-d level** debugowanie

**--reason** Powód stanu hosta

**--stats-every time** Co ile czasu raportuje postęp

**--packet-trace** Aby zobaczyć wysyłane pakiety; można określić filtry jak: --version-trace lub --script-trace

**--open** pokazuje tylko open, open|filtered i unfiltered

**--resume file** Wznawia/wyświetla podsumowanie

**Różne**

**-6** Włącza IPv6

**-A** jest równoważne -O -sV -sC --traceroute

**Czas działania**

Podczas działania Nmap możemy zmieniać opcje:

v / V Zwiększ / zmniejsz poziom verbosity

d / D Zwiększ / zmniejsz poziom debugowania

p / P Włącz / wyłącz śledzenie pakietów

? Wyświetl ekran pomocy interakcji w czasie działania

**Vulscan**

Skrypt Nmap przeglądający wersje usług uzyskane w offline bazie danych (pobranej z innych ważnych źródeł) i zwracający możliwe podatności

Bazy, których używa:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Aby pobrać i zainstalować w folderze Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Trzeba też pobrać pakiety DB i dodać je do /usr/share/nmap/scripts/vulscan/

Użycie:

Aby użyć wszystkich: sudo nmap -sV --script=vulscan HOST_TO_SCAN

Aby użyć konkretnej bazy: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Przyspieszenie skanowania usług Nmap x16

Zgodnie z [**tym postem**](https://joshua.hu/nmap-speedup-service-scanning-16x) możesz przyspieszyć analizę usług nmap przez zmianę wszystkich wartości **`totalwaitms`** w **`/usr/share/nmap/nmap-service-probes`** na **300** oraz **`tcpwrappedms`** na **200**.

Ponadto, sondy które nie mają specyficznie zdefiniowanego **`servicewaitms`** używają domyślnej wartości **`5000`**. Możemy więc albo dodać wartości do każdej sondy, albo **skompilować nmap** samodzielnie i zmienić domyślną wartość w [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79).

Jeśli nie chcesz zmieniać wartości **`totalwaitms`** i **`tcpwrappedms`** w pliku `/usr/share/nmap/nmap-service-probes`, możesz edytować [parsing code](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358) tak, aby te wartości w pliku `nmap-service-probes` były całkowicie ignorowane.


## Zbudowanie statycznego Nmap dla ograniczonych środowisk

W utwardzonych lub minimalnych środowiskach Linux (kontenery, appliance) dynamicznie linkowane binaria Nmap często zawodzą z powodu brakujących loaderów runtime lub bibliotek współdzielonych (np. /lib64/ld-linux-x86-64.so.2, libc.so). Zbudowanie własnego statycznie linkowanego Nmap i dołączenie danych NSE pozwala na uruchomienie bez instalacji pakietów systemowych.

Ogólne podejście
- Użyj czystego amd64 Ubuntu jako buildera przez Docker.
- Zbuduj OpenSSL i PCRE2 jako biblioteki statyczne.
- Zbuduj Nmap linkując statycznie i używając dołączonych libpcap/libdnet, aby uniknąć zależności dynamicznych.
- Dołącz skrypty NSE i katalogi danych razem z binarnym programem.

Odkryj architekturę celu (przykład)
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
Krok 1 — Prepare toolchain
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
Krok 2 — Zbuduj statyczny OpenSSL (1.1.1w)
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
Krok 3 — Kompilacja statyczna PCRE2 (10.43)
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
Krok 4 — Zbuduj statyczny Nmap (7.98)
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
Najważniejsze punkty
- -static, -static-libstdc++, -static-libgcc wymuszają statyczne linkowanie.
- Użycie --with-libpcap=included/--with-libdnet=included zapobiega użyciu systemowych bibliotek współdzielonych.
- Poprawka sed neutralizuje docelową współdzieloną bibliotekę libpcap, jeśli jest obecna.

Krok 5 — Spakuj binary i dane NSE
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
Notatki weryfikacyjne i operacyjne
- Użyj polecenia file na artefakcie, aby potwierdzić, że jest statycznie linkowany.
- Przechowuj dane NSE razem z plikiem binarnym, aby zapewnić zgodność skryptów na hostach bez zainstalowanego Nmap.
- Nawet w przypadku statycznego pliku binarnego, wykonanie może zostać zablokowane przez AppArmor/seccomp/SELinux; DNS/egress musi nadal działać.
- Deterministyczne kompilacje zmniejszają ryzyko w łańcuchu dostaw w porównaniu z pobieraniem nieprzejrzystych “static” binarek.

Jednoliniówka (Dockerized)
<details>
<summary>Zbuduj, spakuj i wypisz informacje o artefakcie</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## Źródła

- [Compiling static Nmap binary for jobs in restricted environments](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (helper tool)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL sources](https://www.openssl.org/source/)
- [PCRE2 releases](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap source tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
