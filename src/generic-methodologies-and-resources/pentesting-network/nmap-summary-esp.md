# Nmap Sažetak (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parametri

### IP-ovi za skeniranje

- **`<ip>,<net/mask>`:** Unesite IP-ove direktno
- **`-iL <ips_file>`:** fajl sa IP adresama
- **`-iR <number>`**: Broj slučajnih IP-ova, moguće je isključiti IP-ove sa `--exclude <Ips>` ili `--excludefile <file>`.

### Otkrivanje uređaja

Po defaultu Nmap pokreće fazu otkrivanja koja se sastoji od: `-PA80 -PS443 -PE -PP`

- **`-sL`**: Nije invazivan, navodi ciljeve praveći DNS upite za rešavanje imena. Korisno da se zna, na primer, da li su svi IP-ovi iz www.prueba.es/24 naši ciljevi.
- **`-Pn`**: **Bez pingovanja**. Korisno ako znate da su svi aktivni (u suprotnom možete izgubiti mnogo vremena, a ova opcija može proizvesti i false negatives tvrdeći da nisu aktivni), on preskače fazu otkrivanja.
- **`-sn`** : **Bez skeniranja portova**. Nakon završetka faze rekognosciranja ne skenira portove. Relativno je stealtly i dozvoljava skeniranje malog mrežnog opsega. Sa privilegijama šalje ACK (-PA) na 80, SYN(-PS) na 443 i echo request i Timestamp request; bez privilegija uvek završava konekcije. Ako je cilj mreža, koristi samo ARP(-PR). Ako se koristi sa drugom opcijom, samo se paketi druge opcije šalju.
- **`-PR`**: **Ping ARP**. Koristi se po defaultu pri analiziranju računara u našoj mreži, brže je od korišćenja ICMP pingova. Ako ne želite ARP pakete koristite `--send-ip`.
- **`-PS <ports>`**: Šalje SYN pakete — ako stigne SYN/ACK smatra se open (cilj zatvara konekciju slanjem RST da ne bi završio konekciju), ako stigne RST smatra se closed, a ako nema odgovora smatra se unreachable. Ako nema privilegija automatski se koristi potpuna TCP konekcija. Ako se ne navede port, koristi se 80.
- **`-PA <ports>`**: Kao prethodni ali sa ACK, kombinacija oba daje bolje rezultate.
- **`-PU <ports>`**: Cilj je suprotan, šalju se na portove za koje se očekuje da budu zatvoreni. Neki firewall-i proveravaju samo TCP konekcije. Ako je zatvoren odgovara sa port unreachable, ako odgovori drugim ICMP-om ili ne odgovori smatra se destination unreachable.
- **`-PE, -PP, -PM`** : ICMP PINGOVI: echo reply, timestamp i addresmask. Pokreću se da bi se utvrdilo da li je cilj aktivan.
- **`-PY<ports>`**: Šalje SCTP INIT probe na 80 po defaultu; može odgovoriti INIT-ACK (open), ABORT (closed), ništa ili ICMP unreachable (inactive).
- **`-PO <protocols>`**: Navode se protokoli u numeričkim vrednostima, po defaultu 1(ICMP), 2(IGMP) i 4(Encap IP). Za ICMP, IGMP, TCP (6) i UDP (17) šalju se protokolni headeri, za ostale se šalje samo IP header. Cilj je da zbog malformacije headera stignu odgovori kao Protocol unreachable ili odgovori istog protokola da bi se znalo da li je up.
- **`-n`**: Bez DNS
- **`-R`**: Uvek DNS

### Tehnike skeniranja portova

- **`-sS`**: Ne završava konekciju pa ne ostavlja trag, vrlo dobar kad se može koristiti. (privilegije) Koristi se po defaultu.
- **`-sT`**: Završava konekciju, ostavlja trag, ali se može koristiti bezbedno. Po defaultu bez privilegija.
- **`-sU`**: Sporije, za UDP. Najčešće: DNS(53), SNMP(161,162), DHCP(67 i 68), (-sU53,161,162,67,68): open(reply), closed(port unreachable), filtered (drugi ICMP), open/filtered (nema odgovora). U slučaju open/filtered, -sV šalje brojne zahteve da detektuje verzije koje nmap podržava i može otkriti pravo stanje. Znatno produžava vreme.
- **`-sY`**: SCTP — ne uspostavlja se konekcija pa nema logova, radi slično -PY
- **`-sN,-sX,-sF`:** Null, Fin, Xmas — mogu proći kroz neke firewall-e i izvući informacije. Baziraju se na tome da mašine koje poštujue standard treba da odgovore sa RST na sve zahteve koji nemaju SYN, RST ili ACK flagove: open/filtered (nema odgovora), closed (RST), filtered (ICMP unreachable). Nepouzdano na Windows, Cisco, BSDI i OS/400. Na Unix-u radi.
- **`-sM`**: Maimon scan: Šalje FIN i ACK flagove, korišćen za BSD, trenutno će vratiti sve kao closed.
- **`-sA, sW`**: ACK i Window, koristi se za detekciju firewall-a, da bi se znalo da li su portovi filtrirani. -sW razlikuje open/closed po vrednosti window-a: open (RST sa window različitim od 0), closed (RST window = 0), filtered (ICMP unreachable ili nema odgovora). Ne radi na svim mašinama, pa ako sve izbaci closed, možda ne radi; ako su neki open, radi kako treba; ako je puno open i malo closed, radi obrnuto.
- **`-sI`:** Idle scan. Kada postoji aktivan firewall ali znamo da ne filtrira za određeni IP (ili kad želimo anonimnost) možemo koristiti zombie scan (radi za sve portove). Za pronalaženje mogućih zombies koristimo skriptu ipidseq ili exploit auxiliary/scanner/ip/ipidseq. Skener se bazira na IPID vrednosti IP paketa.
- **`--badsum`:** Šalje pogrešan checksum; računari bi odbacili pakete, ali firewall-i mogu odgovoriti nečim. Koristi se za detekciju firewall-a.
- **`-sZ`:** "Weird" SCTP skener — pri slanju probe sa cookie echo fragmentima treba da budu odbačeni ako su open ili odgovoreni sa ABORT ako su closed. Može proći kroz firewall-e gde init ne prolazi; mana je što ne razlikuje filtered od open.
- **`-sO`:** IP protocol scan. Šalju se neispravni i prazni header-i u kojima ponekad nije moguće ni razlikovati protokol. Ako stigne ICMP protocol unreachable, zatvoren je; ako stigne unreachable port, otvoren je; ako stigne neka druga greška, filtered; ako nema odgovora, open|filtered.
- **`-b <server>`:** FTPhost --> Koristi se za skeniranje hosta preko drugog hosta — povezuje se na FTP drugog servera i traži da taj server pošalje fajlove na portove koje želimo da skeniramo sa druge mašine; prema odgovorima znamo da li su portovi open ili ne. Sintaksa: [\<user>:\<password>@]\<server>\[:\<port>] Većina FTP servera više ne dozvoljava ovo pa je od slabe praktične upotrebe.

### Fokus analiza

**-p:** Koristi se za specificiranje portova koje treba skenirati. Za sve 65,535 portova: **-p-** ili **-p all**. Nmap ima internu klasifikaciju zasnovanu na popularnosti. Po defaultu koristi top 1000 portova. Sa **-F** (fast scan) analizira top 100. Sa **--top-ports <number>** analizira taj broj top portova (od 1 do 65,535). Provere portova rade se u nasumičnom redosledu; da to sprečite koristite **-r**. Takođe možete izabrati specifične portove: 20-30,80,443,1024- (zadnje znači od 1024 pa naviše). Mogu se grupisati portovi po protokolima: U:53,T:21-25,80,139,S:9. Mogu se birati i opsezi unutar Nmap-ovih popularnih portova: -p [-1024] analizira do porta 1024 od onih uključenih u nmap-services. **--port-ratio <ratio>** Analizira najčešće portove u odnosu (ratio) između 0 i 1

**-sV** Skeniranje verzija, intenzitet se reguliše od 0 do 9, default je 7.

**--version-intensity <number>** Reguliše intenzitet; što je manji broj, šalju se samo najverovatniji probe, ne svi. Ovo može značajno skratiti vreme UDP skeniranja.

**-O** Detekcija OS-a

**--osscan-limit** Za korektno OS skeniranje potrebna su bar jedan open i jedan closed port. Ako uslov nije ispunjen i ova opcija je uključena, neće pokušavati predikciju OS-a (štedi vreme).

**--osscan-guess** Kada detekcija OS-a nije savršena, ovo tera alat da pokušа jače (pogađa).

**Skripte**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

Za korišćenje default skripti, koristite -sC ili --script=default

Dostupni tipovi su: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, i vuln

- **Auth:** izvršava sve dostupne autentikacione skripte
- **Default:** izvršava osnovne default skripte alata
- **Discovery:** preuzima informacije sa cilja ili žrtve
- **External:** skripta za korišćenje eksternih resursa
- **Intrusive:** koristi skripte koje se smatraju intruzivnim za žrtvu/target
- **Malware:** proverava konekcije otvorene od strane malicioznog koda ili backdoora
- **Safe:** izvršava neintruzivne skripte
- **Vuln:** otkriva najpoznatije ranjivosti
- **All:** izvršava apsolutno sve dostupne NSE ekstenzije

Za pretragu skripti:

**nmap --script-help="http-\*" -> One koje počinju sa http-**

**nmap --script-help="not intrusive" -> Sve osim intruzivnih**

**nmap --script-help="default or safe" -> One koje su u bilo kojoj od dve kategorije**

**nmap --script-help="default and safe" --> One koje su u obe**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> Pruža informacije o tome kako skripta napreduje

--script-updatedb

**Da biste koristili skriptu, samo upišite: nmap --script Script_Name target** --> Kada koristite skriptu, biće izvršeni i skripta i skener, pa se mogu dodati i opcije skenera. Možemo dodati **"safe=1"** da izvršimo samo sigurne skripte.

**Kontrola vremena**

**Nmap može menjati vreme u sekundama, minutima, ms:** --host-timeout argumenti 900000ms, 900, 900s, i 15m sve rade isto.

Nmap deli ukupan broj hostova za skeniranje u grupe i analizira te grupe u blokovima, tako da ne prelazi na sledeći blok dok svi u bloku nisu analizirani (i korisnik ne dobija update dok se blok ne završi). Na ovaj način je optimalnije za Nmap da koristi velike grupe. Po defaultu za class C koristi 256.

Ovo se može promeniti sa **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ (Podešavanje veličine paralelnih grupa skeniranja)

Možete kontrolisati broj paralelnih skenera, ali je bolje ne dirati (Nmap već ima automatsku kontrolu na osnovu stanja mreže): **--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

Možemo menjati RTT timeout, ali obično nije neophodno: **--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

Možemo menjati broj pokušaja: **--max-retries** _**<numtries>**_

Možemo menjati vreme skeniranja po hostu: **--host-timeout** _**<time>**_

Možemo menjati vreme između svakog testa da bismo usporili: **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

Možemo menjati broj paketa po sekundi: **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

Mnogi portovi dugo odgovaraju kada su filtrirani ili zatvoreni. Ako nas zanimaju samo otvoreni, možemo ići brže sa: **--defeat-rst-ratelimit**

Da definišemo koliko agresivno želimo da Nmap bude: -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> Skenira samo 1 port istovremeno i čeka 5min pre sledećeg

-T1 i T2 --> Veoma slični, čekaju 15s odnosno 0.4s između testova

-T3 --> Default rad, uključuje paralelno skeniranje

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Blokiraju pristup portovima i analiziraju pakete.

**-f** Fragmentira pakete, po defaultu na fragmente od 8 bytes posle header-a; da bi se specificirala veličina koristi se ..mtu (uz ovo ne koristite -f), offset mora biti višekratnik od 8. **Version skripte i skeneri ne podržavaju fragmentaciju**

**-D decoy1,decoy2,ME** Nmap šalje skenove ali sa drugim IP adresama kao izvor, na taj način vas maskira. Ako stavite ME u listu, Nmap će vas pozicionirati tamo; bolje je staviti 5 ili 6 pre vas da potpuno zamaskirate pravo poreklo. Mogu se generisati random IP-ovi sa RND:<number> da se generiše <number> slučajnih IP-ova. Ne rade sa TCP version detectorima bez konekcije. Ako ste unutar mreže, zanimaće vas korišćenje aktivnih IP-ova, inače će biti lako primetiti da ste jedini aktivni.

Za korišćenje random IP-ova: nmap -D RND:10 Target_IP

**-S IP** Kada Nmap ne prepoznaje vaš IP, morate ga dati ovim parametrom. Takođe služi da ih natera da misle da ih skenira drugi cilj.

**-e <interface>** Za izbor interfejsa

Mnogi administratori ostave ulazne portove otvorene da bi sve radilo, što im je lakše nego tražiti drugo rešenje. To mogu biti DNS ili FTP portovi... da se pronađe ova ranjivost Nmap uključuje: **--source-port** _**<portnumber>**_**;-g** _**<portnumber>**_ _Ove su ekvivalentne_

**--data** _**<hex string>**_ Da se pošalje heksadecimalni sadržaj: --data 0xdeadbeef i --data \xCA\xFE\x09

**--data-string** _**<string>**_ Da se pošalje običan tekst: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Nmap šalje samo header-e; ovim dodajemo broj dodatnih bajtova (koji će biti generisani nasumično)

Za kompletno konfigurisanje IP paketa koristite **--ip-options**

Ako želite da vidite opcije u paketima koji se šalju i primaju, navedite --packet-trace. Za više informacija i primera korišćenja IP opcija sa Nmap, pogledajte [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**<value>**_

**--randomize-hosts** Da napad bude manje očigledan

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ Za promenu MAC-a primeri: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, i Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ Za korišćenje proxy-a; ponekad proxy ne održava toliko konekcija koliko Nmap želi pa bi trebalo promeniti paralelizam: --max-parallelism

**-sP** Za otkrivanje hostova u našoj mreži koristeći ARP

Mnogi administratori kreiraju pravilo na firewall-u koje dozvoljava sve pakete sa određenog porta (npr. 20,53 i 67); možemo reći Nmap-u da šalje pakete sa tih portova: **nmap --source-port 53 IP**

**Izlazi**

**-oN file** Normalni izlaz

**-oX file** XML izlaz

**-oS file** Script kiddies izlaz

**-oG file** Greppable izlaz

**-oA file** Sve osim -oS

**-v level** nivo verbositeta

**-d level** debug nivo

**--reason** Razlog stanja hosta i porta

**--stats-every time** Svaki taj period prikazuje napredak

**--packet-trace** Da vidite koji paketi izlaze; mogu se specificirati filteri kao: --version-trace ili --script-trace

**--open** prikazuje samo open, open|filtered i unfiltered

**--resume file** Vraća sažetak

**Razno**

**-6** Omogućava IPv6

**-A** isto kao -O -sV -sC --traceroute

**Run time**

Dok Nmap radi možemo menjati opcije:

v / V Povećaj / smanji level verbositeta

d / D Povećaj / smanji debug nivo

p / P Uključi / isključi packet tracing

? Prikazuje runtime help ekran

**Vulscan**

Nmap skripta koja pregleda verzije servisa dobijenih iz offline baze (preuzete sa drugih izvora) i vraća moguće ranjivosti

DB koje koristi:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Da preuzmete i instalirate u Nmap folder:

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Takođe ćete morati da preuzmete DB pakete i dodate ih u /usr/share/nmap/scripts/vulscan/

Korišćenje:

Da koristite sve: sudo nmap -sV --script=vulscan HOST_TO_SCAN

Da koristite specifičnu DB: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Ubrzajte Nmap service scan x16

Prema [**ovom postu**](https://joshua.hu/nmap-speedup-service-scanning-16x) možete ubrzati nmap analizu servisa tako što ćete sve vrednosti **`totalwaitms`** u **`/usr/share/nmap/nmap-service-probes`** promeniti na **300**, i vrednost **`tcpwrappedms`** na **200**.

Nadalje, probe koje nemaju specifično definisanu **`servicewaitms`** koriste podrazumevanu vrednost **`5000`**. Dakle, možemo ili dodati vrednosti svakom probe-u, ili možemo **kompajlirati nmap** sami i promeniti podrazumevanu vrednost u [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79).

Ako ne želite da menjate vrednosti **`totalwaitms`** i **`tcpwrappedms`** u `/usr/share/nmap/nmap-service-probes` fajlu, možete izmeniti [parsing code](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358) tako da se ove vrednosti u `nmap-service-probes` datoteci potpuno ignorišu.

## Kreirajte statički Nmap za ograničena okruženja

U ojačanim ili minimalnim Linux okruženjima (kontejneri, appliances), dinamički linkovani Nmap binarni fajlovi često ne rade zbog nedostajućih runtime loader-a ili deljenih biblioteka (npr. /lib64/ld-linux-x86-64.so.2, libc.so). Izgradnja sopstvenog statički linkovanog Nmap-a i spakovanje NSE podataka omogućava izvršavanje bez instalacije sistemskih paketa.

Visok nivo pristupa
- Koristite čist amd64 Ubuntu builder preko Docker-a.
- Build-ujte OpenSSL i PCRE2 kao statične biblioteke.
- Build-ujte Nmap koji se linkuje statički i koristi uključeni libpcap/libdnet da izbegne dinamičke zavisnosti.
- Spakujte NSE skripte i podatke zajedno sa binarnim fajlom.

Otkrivanje ciljne arhitekture (primer)
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
Korak 1 — Pripremite toolchain
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
Korak 2 — Izgradnja statičkog OpenSSL (1.1.1w)
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
Korak 3 — Sastavite statički PCRE2 (10.43)
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
Korak 4 — Kompajliranje statičkog Nmap-a (7.98)
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
Key points
- -static, -static-libstdc++, -static-libgcc primoravaju statičko linkovanje.
- Korišćenje --with-libpcap=included/--with-libdnet=included izbegava sistemske deljene biblioteke.
- sed podešavanje onemogućava deljenu libpcap biblioteku ako je prisutna.

Step 5 — Paketiranje binarnog fajla i NSE podataka
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
Verifikacija i operativne beleške
- Koristite file na artefaktu da potvrdite da je statički povezan.
- Sačuvajte NSE podatke uz binarni fajl kako biste obezbedili istovetnost skripti na hostovima bez instaliranog Nmap-a.
- Čak i sa statičkim binarnim fajlom, izvršavanje može biti blokirano od strane AppArmor/seccomp/SELinux; DNS/egress i dalje moraju funkcionisati.
- Determinističke izrade smanjuju rizik lanca snabdevanja u odnosu na preuzimanje neprovidnih “statičkih” binarnih fajlova.

Jednolinijski (Dockerized)
<details>
<summary>Sastavi, zapakuj i ispiši informacije o artefaktu</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## Referencije

- [Compiling static Nmap binary for jobs in restricted environments](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (helper tool)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL sources](https://www.openssl.org/source/)
- [PCRE2 releases](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap source tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
