# Nmap Muhtasari (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Vigezo

### IPs za kuchanganua

- **`<ip>,<net/mask>`:** Onyesha ips moja kwa moja
- **`-iL <ips_file>`:** list_IPs
- **`-iR <number>`**: Idadi ya IPs za nasibu, unaweza kuondoa IPs fulani kwa `--exclude <Ips>` au `--excludefile <file>`.

### Ugunduzi wa vifaa

Kwa chaguo-msingi Nmap inaanzisha awamu ya ugunduzi inayojumuisha: `-PA80 -PS443 -PE -PP`

- **`-sL`**: Si kuingilia, inaorodhesha malengo kwa kufanya maombi ya **DNS** kutatua majina. Inafaa kujua kama kwa mfano www.prueba.es/24 IP zote ni malengo yetu.
- **`-Pn`**: **Hakuna ping**. Hii inafaa ikiwa unajua kwamba zote zinafanya kazi (ikiwa si hivyo, unaweza kupoteza muda mwingi, lakini chaguo hili pia hutoa false negatives zikisema hazifanyi kazi), inazuia awamu ya ugunduzi.
- **`-sn`** : **Hakuna port scan**. Baada ya kukamilisha awamu ya reconnaissance, haiskani ports. Ni relatively stealthy, na inaruhusu skani ndogo ya mtandao. Kwa rasilimali za kiinua (privileges) inatuma ACK (-PA) kwa 80, SYN(-PS) kwa 443 na echo request na Timestamp request, bila rasilimali inakamilisha kila mara connections. Ikiwa lengo ni mtandao, inatumia ARP(-PR) pekee. Ikitumika pamoja na chaguo jingine, vifurushi vya chaguo jingine vinaporomoka tu.
- **`-PR`**: **Ping ARP**. Inatumiwa kwa default wakati wa kuchambua kompyuta ndani ya mtandao wetu, ni haraka kuliko kutumia pings. Ikiwa hutaki kutumia vifurushi vya ARP tumia `--send-ip`.
- **`-PS <ports>`**: Inatuma vifurushi vya SYN ambavyo ikiwa vinajibu SYN/ACK ni wazi (ambavyo vinajibu kwa RST ili kutokamilisha muunganisho), ikiwa vinajibu RST ni imefungwa na ikiwa havijibi haifiki. Ikiwa huna rasilimali, muunganisho kamili utatumika moja kwa moja. Ikiwa hakuna ports zilizopewa, inazituma kwa 80.
- **`-PA <ports>`**: Kama ilivyo hapo juu lakini kwa ACK, kuunganisha vyote viwili kunatoa matokeo bora.
- **`-PU <ports>`**: Lengo ni kinyume, zinatumwa kwa ports zinazotarajiwa kuwa zimefungwa. Firewalls fulani zinachunguza tu muunganisho za TCP. Ikiwa imefungwa inajibiwa na port unreachable, ikiwa inajibiwa na ICMP nyingine au hakujibiwa inaachwa kama destination unreachable.
- **`-PE, -PP, -PM`** : ICMP PINGS: echo reply, timestamp na addresmask. Zinatumwa kutambua kama lengo linafanya kazi.
- **`-PY<ports>`**: Inatuma SCTP INIT probes kwa 80 kwa default, INIT-ACK(open) au ABORT(closed) au hakuna au ICMP unreachable(inactive) zinaweza kujibiwa.
- **`-PO <protocols>`**: Inaonyesha protocol katika headers, kwa default 1(ICMP), 2(IGMP) na 4(Encap IP). Kwa protocols ICMP, IGMP, TCP (6) na UDP (17) headers za protocol zinatumwa, kwa zingine header ya IP tu inatumwa. Kusudi ni kwamba kutokana na malformed headers, Protocol unreachable au majibu ya protocol ile ile yatapokea ili kujua kama iko juu.
- **`-n`**: Hakuna DNS
- **`-R`**: DNS kila mara

### Mbinu za skanning ya port

- **`-sS`**: Haikamilishi muunganisho hivyo haiache alama nyingi, nzuri sana ikiwa inaweza kutumika.(privileges) Hii ndiyo inayotumika kwa default.
- **`-sT`**: Inakamilisha muunganisho, hivyo inaacha alama, lakini inaweza kutumika bila shaka. Kwa default bila privileges.
- **`-sU`**: Polepole, kwa UDP. Zaidi: DNS(53), SNMP(161,162), DHCP(67 na 68), (-sU53,161,162,67,68): open(reply), closed(port unreachable), filtered (icmp nyingine), open/filtered (hakujibiwa). Katika kesi ya open/filtered, -sV inatuma maombi mengi kugundua toleo lolote ambalo nmap inaunga mkono na inaweza kubaini hali halisi. Inaongezea sana muda.
- **`-sY`**: SCTP protocol inashindwa kuanzisha muunganisho, hivyo hakutakuwa na logs, inafanya kazi kama -PY
- **`-sN,-sX,-sF`:** Null, Fin, Xmas, zinaweza kuvamia firewalls fulani na kutoa taarifa. Zinategemea kuwa mashine zinazofuata standard zinapaswa kujibu kwa RST maombi yote yasiyo na SYN, RST au ACK vyote vilivyowekwa: open/filtered(hakujibiwa), closed(RST), filtered (ICMP unreachable). Hazitegemezeki kwenye Windows, Cisco, BSDI na OS/400. Kwenye unix zinafanya kazi.
- **`-sM`**: Maimon scan: Inatuma bendera FIN na ACK, hutumika kwa BSD, kwa sasa itarudisha zote kama closed.
- **`-sA, sW`**: ACK na Window, inatumiwa kutambua firewalls, kujua kama ports zimechujwa au la. -sW hutofautisha kati ya open/closed kwa kuwa zilizofunguka zinajibu kwa window tofauti: open (RST na window si 0), closed (RST window = 0), filtered (ICMP unreachable au hakujibiwa). Si kompyuta zote zinafanya hivi, hivyo ikiwa kila kitu kinaonekana closed, haifanyi kazi, ikiwa ni chache open, inafanya kazi vizuri, na ikiwa ni nyingi open na chache closed, inafanya kazi kinyume.
- **`-sI`:** Idle scan. Kwa kesi ambapo kuna firewall hai lakini tunajua haichujui kwa IP fulani (au tunataka tu anonymity) tunaweza kutumia zombie scanner (inafanya kazi kwa ports zote), kutafuta zombies tunaweza kutumia scrpit ipidseq au exploit auxiliary/scanner/ip/ipidseq. Scanner hii inategemea nambari ya IPID ya vifurushi vya IP.
- **`--badsum`:** Inatuma checksum isiyo sahihi, kompyuta zingekuwa zinatupa vifurushi, lakini firewalls zinaweza kujibu kitu, inatumika kugundua firewalls.
- **`-sZ`:** "Weird" SCTP scanner, wanapotuma probes na cookie echo fragments zinapaswa kupitwa ikiwa wazi au kujibiwa na ABORT ikiwa zimefungwa. Inaweza kupita kupitia firewalls ambazo init haipiti, kibaya ni kwamba haiwezi kutofautisha kati ya filtered na open.
- **`-sO`:** Protocol Ip scan. Inatuma headers mbaya na tupu ambazo wakati mwingine hata protocol haiwezi kutofautishwa. Ikiwa inakuja ICMP unreachable protocol ina maana imefungwa, ikiwa inakuja unreachable port ni wazi, ikiwa kuna error nyingine, filtered, ikiwa hakuna jibu, open|filtered.
- **`-b <server>`:** FTPhost--> Inatumika kuskani mwenyeji kutoka kwa mwingine, hii hufanywa kwa kuunganisha ftp ya mashine nyingine na kuomba itume files kwa ports unazotaka kuskani kutoka kwa mashine nyingine, kulingana na majibu tutajua ikiwa ziko wazi au la. [\<user>:\<password>@]\<server>\[:\<port>] Karibu servers zote za ftp sasa haziruhusu hili hivyo ni ya matumizi mdogo.

### Uchambuzi wa Kitu Muhimu

**-p:** Inatumika kutaja ports za kuskani. Kuchagua ports zote 65,335: **-p-** au **-p all**. Nmap ina daraja la ndani kulingana na umaarufu. Kwa default, inatumia top 1000 ports. Kwa **-F** (fast scan) inachunguza top 100. Kwa **--top-ports <number>** inachunguza idadi hiyo ya top ports (kutoka 1 hadi 65,335). Inakagua ports kwa mpangilio wa nasibu; ili kuzuia hili, tumia **-r**. Tunaweza pia kuchagua ports maalum: 20-30,80,443,1024- (hii ya mwisho inamaanisha kutazama kutoka 1024 kuendelea). Tunaweza pia kuunganisha ports kwa protocols: U:53,T:21-25,80,139,S:9. Tunaweza pia kuchagua safu ndani ya ports maarufu za Nmap: -p [-1024] inachunguza hadi port 1024 kutoka zile zilizoko kwenye nmap-services. **--port-ratio <ratio>** Inachunguza ports zinazotumika zaidi ndani ya ratio kati ya 0 na 1

**-sV** Version scanning, intensity inaweza kudhibitiwa kutoka 0 hadi 9, default ni 7.

**--version-intensity <number>** Tunadhibiti intensity, hivyo kadri inavyopunguzwa itatuma tu probes zinazowezekana zaidi, lakini si zote. Kwa hili, tunaweza kupunguza kwa kiasi kikubwa muda wa skanning ya UDP

**-O** OS detection

**--osscan-limit** Kwa skanning sahihi ya host, angalau port moja wazi na moja imefungwa zinahitajika. Ikiwa sharti hili halijatimizwa na tumeweka hii, haitajaribu utabiri wa OS (inaokoa muda)

**--osscan-guess** Wakati utambuzi wa OS hauwezi kuwa sahihi, hii inafanya ijaribu kwa bidii zaidi

**Scripts**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

Ili kutumia scripts za default, tumia -sC au --script=default

Aina zinapatikana ni: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, na vuln

- **Auth:** inatekeleza scripts zote za authentication zilizopo
- **Default:** inatekeleza scripts za msingi za default
- **Discovery:** inachukua taarifa kutoka kwa lengo au victim
- **External:** script ya kutumia rasilimali za nje
- **Intrusive:** inatumia scripts zinazoachukuliwa intrusive kwa victim au target
- **Malware:** hubaini miunganisho iliyoanzishwa na code hatari au backdoors
- **Safe:** inatekeleza scripts zisizo-intrusive
- **Vuln:** hugundua udhaifu unaojulikana zaidi
- **All:** inatekeleza kabisa NSE extension scripts zote zilizopo

Kutafuta scripts:

**nmap --script-help="http-\*" -> Those starting with http-***

**nmap --script-help="not intrusive" -> All except those**

**nmap --script-help="default or safe" -> Those in either or both**

**nmap --script-help="default and safe" --> Those in both**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> Hutoa taarifa jinsi script inavyoendelea

--script-updatedb

**Ili kutumia script, andika tu: nmap --script Script_Name target** --> Unapotumia script, script na scanner zote zitatekelezwa, hivyo chaguo za scanner pia zinaweza kuongezwa. Tunaweza kuongeza **"safe=1"** kutekeleza zile salama tu.

**Udhibiti wa Wakati**

**Nmap inaweza kubadilisha muda kwa sekunde, dakika, ms:** --host-timeout arguments 900000ms, 900, 900s, na 15m zote zinafanya kitu kimoja.

Nmap inagawanya idadi ya jumla ya hosts za kuskani katika vikundi na kuchambua vikundi hivi kwa block, hivyo haisogei kwenye block inayofuata mpaka zote zimalizwe (na mtumiaji hapati sasisho mpaka block imechambuliwa). Kwa njia hii, ni bora kwa Nmap kutumia vikundi vikubwa. Kwa default katika class C, inatumia 256.

Hii inaweza kubadilishwa na **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ (Rekebisha ukubwa wa vikundi vya skani sambamba)

Unaweza kudhibiti idadi ya scanners sambamba lakini ni bora usifanye hivyo (Nmap tayari ina udhibiti wa kiotomatiki kulingana na hali ya mtandao): **--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

Tunaweza kubadilisha RTT timeout, lakini kawaida si lazima: **--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

Tunaweza kubadilisha idadi ya jaribio: **--max-retries** _**<numtries>**_

Tunaweza kubadilisha muda wa skanning wa host: **--host-timeout** _**<time>**_

Tunaweza kubadilisha muda kati ya kila jaribio ili kuifanya iwe polepole: **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

Tunaweza kubadilisha idadi ya vifurushi kwa sekunde: **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

Ports nyingi zinachukua muda mrefu kujibu zinapochujwa au zikiwa zimefungwa. Ikiwa tunavutiwa tu na zile zilizo wazi, tunaweza kwenda haraka zaidi na: **--defeat-rst-ratelimit**

Ili kuelezea jinsi tunavyotaka Nmap kuwa kali: -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> Hutasaka zaidi ya port 1 kwa wakati na inasubiri 5min kabla ya ifuatayo

-T1 na T2 --> Zinafanana sana lakini hutosubiri 15 na 0.4sec mtawalia kati ya kila jaribio

-T3 --> Operesheni ya default, inajumuisha skanning sambamba

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Hawaruhusu ufikiaji wa ports na huchambua vifurushi.

**-f** Ili kugawanya vifurushi, kwa default vinagawanywa katika 8bytes baada ya header, kuelezea ukubwa tunatumia ..mtu (pamoja na hii, usitumie -f), offset lazima iwe mara 8. **Version scanners na scripts hazisaidii fragmentation**

**-D decoy1,decoy2,ME** Nmap inatuma scanners lakini na anwani za IP nyingine kama asili, kwa njia hii wanaficha wewe. Ikiwa unaweka ME kwenye orodha, Nmap itakuweka hapo, ni bora kuweka 5 au 6 kabla yako ili kukuficha kabisa. IPs za nasibu zinaweza kuzalishwa na RND:<number> Kuunda <number> ya IPs nasibu. Hazifanyi kazi na TCP version detectors bila connection. Ikiwa uko ndani ya mtandao, unavutiwa kutumia IPs zenye shughuli, vinginevyo itakuwa rahisi kugundua kuwa wewe ndiye unaotumika.

Ili kutumia IPs za nasibu: nmap -D RND:10 Target_IP

**-S IP** Kwa wakati Nmap haikuonyesha IP yako lazima uipe. Pia hutumika kuwafanya wadhani lengo lingine likuwa linawaskani.

**-e <interface>** Kuchagua interface

Wahudumu wengi huacha ports za kuingia wazi kwa kila kitu ili kazi zifanyike vizuri na ni rahisi kwengine kuliko kutafuta suluhisho. Hizi zinaweza kuwa ports za DNS au FTP... ili kupata udhaifu huu Nmap ina: **--source-port** _**<portnumber>**_**;-g** _**<portnumber>**_ _Zinafanana_

**--data** _**<hex string>**_ Kutuma maandishi ya hex: --data 0xdeadbeef na --data \xCA\xFE\x09

**--data-string** _**<string>**_ Kutuma maandishi ya kawaida: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Nmap hutuma headers tu, kwa hili tunaongeza idadi ya bytes zaidi (zitakazotengenezwa kwa nasibu)

Ili kusanidi kifurushi cha IP kikamilifu tumia **--ip-options**

Ikiwa ungependa kuona chaguzi katika vifurushi vinavyotumwa na kupokelewa, weka --packet-trace. Kwa habari zaidi na mifano ya kutumia IP options na Nmap, angalia [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**<value>**_

**--randomize-hosts** Kufanya shambulio isiwe dhahiri

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ Kubadili MAC mifano: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, na Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ Kutumia proxies, wakati mwingine proxy haidumishi connections nyingi kama Nmap inavyotaka hivyo parallelism itahitaji kubadilishwa: --max-parallelism

**-sP** Kugundua hosts katika mtandao wetu kwa ARP

Wahudumu wengi huunda sheria ya firewall inayoruhusu vifurushi vyote vinavyoja kutoka port fulani kupita (kama 20,53 na 67), tunaweza kuambia Nmap kutuma vifurushi vyetu kutoka kwenye ports hizi: **nmap --source-port 53 IP**

**Matokeo**

**-oN file** Normal output

**-oX file** XML output

**-oS file** Script kiddies output

**-oG file** Greppable output

**-oA file** Yote isipokuwa -oS

**-v level** verbosity

**-d level** debugging

**--reason** Sababu ya host na state

**--stats-every time** Kila muda huo inatuambia hali ya kazi

**--packet-trace** Kuona vifurushi vinavyotoka, filters zinaweza kutajwa kama: --version-trace au --script-trace

**--open** inaonyesha open, open|filtered na unfiltered

**--resume file** Inatoa muhtasari

**Mengineyo**

**-6** Inaruhusu IPv6

**-A** ni sawa na -O -sV -sC --traceroute

**Wakati wa kukimbia**

Wakati Nmap inaendelea tunaweza kubadilisha chaguzi:

v / V Ongeza / punguza kiwango cha verbosity

d / D Ongeza / punguza kiwango cha debugging

p / P Washa / zima packet tracing

? Chapisha skrini msaada wa runtime interaction

**Vulscan**

Nmap script inayochunguza toleo za services zilizopatikana kwa database ya offline (iliyopakuliwa kutoka kwa zingine muhimu) na kurudisha udhaifu unaowezekana

DBs zinazotumika ni:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Kupakua na kusanidi katika folda ya Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Pia utahitaji kupakua vifurushi vya DB na kuviweka katika /usr/share/nmap/scripts/vulscan/

Matumizi:

Ili kutumia zote: sudo nmap -sV --script=vulscan HOST_TO_SCAN

Ili kutumia DB maalum: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Harakisha Nmap Service scan x16

According [**to this post**](https://joshua.hu/nmap-speedup-service-scanning-16x) unaweza kuharakisha uchambuzi wa service wa nmap kwa kubadilisha thamani zote za **`totalwaitms`** katika **`/usr/share/nmap/nmap-service-probes`** hadi **300** na **`tcpwrappedms`** hadi **200**.

Zaidi ya hayo, probes ambazo hazina maalum **`servicewaitms`** zinatumia thamani ya default ya **`5000`**. Kwa hiyo, tunaweza kuongeza thamani kwa kila probe, au tunaweza **kujijenga nmap** wenyewe na kubadili thamani ya default katika [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79).

Kama hutaki kubadilisha thamani za **`totalwaitms`** na **`tcpwrappedms`** kabisa katika faili ya `/usr/share/nmap/nmap-service-probes`, unaweza kuhariri [parsing code](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358) ili thamani hizi katika faili `nmap-service-probes` zisizuiliwe kabisa.

## Kujenga Nmap ya static kwa mazingira yaliyofungiwa

Katika mazingira ya Linux yaliyohifadhiwa au minimal (containers, appliances), binaries za Nmap zilizounganishwa dinamiski mara nyingi zinashindwa kutokana na kukosekana kwa runtime loaders au maktaba za pamoja (mfano, /lib64/ld-linux-x86-64.so.2, libc.so). Kujenga Nmap yako mwenyewe iliyounganishwa statically na kuambatisha data za NSE kunaruhusu utekelezaji bila kusakinisha packages za mfumo.

Mbinu ya juu ya kiwango
- Tumia builder safi amd64 Ubuntu kupitia Docker.
- Jenga OpenSSL na PCRE2 kama maktaba static.
- Jenga Nmap ukilinking statically na kutumia libpcap/libdnet zilizomo ili kuepuka deps za dynamic.
- Ambatisha NSE scripts na directories za data pamoja na binary.

Gundua architecture ya lengo (mfano)
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
Hatua 1 — Andaa toolchain
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
Hatua 2 — Jenga OpenSSL ya static (1.1.1w)
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
Hatua 3 — Jenga PCRE2 ya statiki (10.43)
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
Hatua 4 — Jenga Nmap static (7.98)
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
Vidokezo muhimu
- -static, -static-libstdc++, -static-libgcc zinazolazimisha uunganishaji wa static.
- Kutumia --with-libpcap=included/--with-libdnet=included kunazuia matumizi ya maktaba za mfumo zilizosambazwa.
- Marekebisho ya sed huzuia lengo la libpcap lililoshirikiwa ikiwa lipo.

Hatua 5 — Kusanya binari na data za NSE
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
Vidokezo vya uhakiki na operesheni
- Tumia faili kwenye artifact kuthibitisha kuwa ni statically linked.
- Hifadhi NSE data pamoja na binary ili kuhakikisha script parity kwenye hosts ambazo hazina Nmap imewekwa.
- Hata kwa binary static, utekelezaji unaweza kuzuiwa na AppArmor/seccomp/SELinux; DNS/egress lazima bado ifanye kazi.
- Deterministic builds hupunguza hatari ya supply-chain ikilinganishwa na kupakua 'static' binaries zisizo wazi.

Mstari mmoja (Dockerized)
<details>
<summary>Jenga, pakia, na chapisha taarifa za artifact</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## Marejeleo

- [Compiling static Nmap binary for jobs in restricted environments](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (helper tool)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL sources](https://www.openssl.org/source/)
- [PCRE2 releases](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap source tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
