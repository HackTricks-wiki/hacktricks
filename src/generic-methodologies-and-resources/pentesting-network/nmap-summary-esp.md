# Nmap — Підсумок (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parameters

### IPs to scan

- **`<ip>,<net/mask>`:** Вказати ips безпосередньо
- **`-iL <ips_file>`:** list_IPs
- **`-iR <number>`**: Кількість випадкових Ips, можна виключити можливі Ips за допомогою `--exclude <Ips>` або `--excludefile <file>`.

### Equipment discovery

За замовчуванням Nmap запускає фазу виявлення, що складається з: `-PA80 -PS443 -PE -PP`

- **`-sL`**: Неінвазивний режим, перелічує цілі, роблячи **DNS** запити для розв'язання імен. Користь — дізнатися, чи, наприклад, www.prueba.es/24 всі Ips — наші цілі.
- **`-Pn`**: **No ping**. Корисно, якщо ви знаєте, що всі машини активні (інакше можна втратити багато часу, але ця опція також дає false negatives, стверджуючи, що вони неактивні), запобігає фазі виявлення.
- **`-sn`** : **No port scan**. Після завершення reconnaissance фази не сканує порти. Відносно stealth режим, дозволяє невеликий мережевий скан. З привілеями відправляє ACK (-PA) на 80, SYN(-PS) на 443 і echo request та Timestamp request, без привілеїв завжди завершує з'єднання. Якщо ціль — мережа, використовує тільки ARP(-PR). Якщо використовується з іншою опцією, тільки пакети іншої опції надсилаються.
- **`-PR`**: **Ping ARP**. Використовується за замовчуванням при аналізі машин у нашій мережі, швидше за використання ping. Якщо не хочете використовувати ARP-пакети — використовуйте `--send-ip`.
- **`-PS <ports>`**: Відправляє SYN-пакети: якщо відповідає SYN/ACK — відкрито (відповідає RST, щоб не завершувати з'єднання), якщо відповідає RST — закрито, якщо не відповідає — недосяжно. За відсутності привілеїв автоматично використовується повне з'єднання. Якщо порти не вказані, використовується 80.
- **`-PA <ports>`**: Як попередній, але з ACK; комбінування дає кращі результати.
- **`-PU <ports>`**: Мета протилежна — відправляються на порти, які очікується закритими. Деякі фаєрволи перевіряють лише TCP-з'єднання. Якщо закрито — відповідає port unreachable, інша ICMP або відсутність відповіді дають destination unreachable.
- **`-PE, -PP, -PM`** : ICMP PINGS: echo reply, timestamp і addresmask. Запускаються, щоб дізнатися, чи ціль активна.
- **`-PY<ports>`**: Відправляє SCTP INIT-проби на 80 за замовчуванням; відповіді: INIT-ACK(open) або ABORT(closed) або нічого або ICMP unreachable(inactive).
- **`-PO <protocols>`**: Вказується протокол у заголовках, за замовчуванням 1(ICMP), 2(IGMP) і 4(Encap IP). Для ICMP, IGMP, TCP (6) і UDP (17) надсилаються заголовки протоколів, для решти — тільки IP-заголовок. Мета — через неправильну форму заголовків отримати Protocol unreachable або відповіді того ж протоколу, щоб дізнатися, чи хост up.
- **`-n`**: No DNS
- **`-R`**: DNS always

### Port scanning techniques

- **`-sS`**: Не завершує з'єднання, тому не лишає слідів, дуже корисно, якщо можливо використовувати. (привілеї) Це режим за замовчуванням.
- **`-sT`**: Завершує з'єднання, тому лишає слід, але гарантовано працює. За замовчуванням без привілеїв.
- **`-sU`**: Повільніший, для UDP. Переважно: DNS(53), SNMP(161,162), DHCP(67 and 68), (-sU53,161,162,67,68): open(reply), closed(port unreachable), filtered (інша ICMP), open/filtered (нічого). У випадку open/filtered, -sV відправляє численні запити для виявлення версій, що підтримує nmap, і може виявити реальний стан. Значно збільшує час.
- **`-sY`**: SCTP — не вдається встановити з'єднання, тому нема логів, працює як -PY
- **`-sN,-sX,-sF`:** Null, Fin, Xmas — можуть проходити через деякі фаєрволи і витягувати інформацію. Базуються на тому, що стандартизовані машини повинні відповідати RST на всі запити без SYN, RST або ACK: open/filtered(нічого), closed(RST), filtered (ICMP unreachable). Ненадійні на Windows, Cisco, BSDI і OS/400. На unix — так.
- **`-sM`**: Maimon scan: Відправляє FIN і ACK, використовувався для BSD, наразі повертає всі як closed.
- **`-sA, sW`**: ACK і Window, використовуються для виявлення фаєрволів, щоб знати, чи порти filtered. -sW відрізняє open/closed, бо відкриті відповідають іншим window-значенням: open (RST з window ≠ 0), closed (RST window = 0), filtered (ICMP unreachable або нічого). Не всі машини так працюють, тому якщо всі закриті — метод не працює; якщо кілька відкриті — працює нормально; якщо багато відкритих і мало закритих — працює навпаки.
- **`-sI`:** Idle scan. Коли є активний фаєрвол, але відомо, що він не фільтрує до певного IP (або коли потрібна анонімність), можна використовувати zombie scanner (працює для всіх портів). Щоб знайти possible zombies, можна використати script ipidseq або exploit auxiliary/scanner/ip/ipidseq. Сканер базується на IPID полі IP-пакетів.
- **`--badsum`:** Відправляє неправильну checksum; машини могли б відкидати пакети, але фаєрволи можуть відповісти — використовується для виявлення фаєрволів.
- **`-sZ`:** "Weird" SCTP scanner; при відправці проб із cookie echo fragments вони повинні бути відкинуті, якщо відкрито, або відповісти ABORT якщо closed. Може проходити через фаєрволи, куди init не проходить; мінус — не відрізняє filtered від open.
- **`-sO`:** Protocol Ip scan. Відправляє некоректні та порожні заголовки, у яких інколи навіть протокол не можна визначити. Якщо приходить ICMP unreachable protocol — closed, якщо unreachable port — open, якщо інша помилка — filtered, якщо нічого — open|filtered.
- **`-b <server>`:** FTPhost --> Використовується для сканування хоста з іншого хоста: підключитись до FTP іншої машини і попросити її надіслати файли на порти, які ви хочете сканувати з іншого хоста; за відповідями визначаємо, відкриті чи ні. [\<user>:\<password>@]\<server>\[:\<port>] Майже всі ftp server-і вже не дозволяють це, тому має невелике практичне застосування.

### **Focus Analysis**

**-p:** Використовується для вказівки портів для сканування. Щоб вибрати всі 65,335 портів: **-p-** або **-p all**. Nmap має внутрішню класифікацію на основі популярності. За замовчуванням використовує топ 1000 портів. З **-F** (fast scan) аналізує топ 100. З **--top-ports <number>** аналізує ту кількість топ-портів (від 1 до 65,335). Перевіряє порти в довільному порядку; щоб цього уникнути, використовуйте **-r**. Можна також вибирати конкретні порти: 20-30,80,443,1024- (останнє означає шукати від 1024 і далі). Можна групувати порти по протоколах: U:53,T:21-25,80,139,S:9. Також можна вибрати діапазон у межах popular ports Nmap: -p [-1024] аналізує до порту 1024 з тих, що включені в nmap-services. **--port-ratio <ratio>** Аналізує найпоширеніші порти в межах коефіцієнта від 0 до 1

**-sV** Version scanning, інтенсивність можна регулювати від 0 до 9, за замовчуванням 7.

**--version-intensity <number>** Регулює інтенсивність; чим менше число, тим лише найімовірніші проби запускаються, але не всі. Це значно скорочує час UDP-сканування.

**-O** OS detection

**--osscan-limit** Для коректного OS-сканування потрібні принаймні один open port і один closed port. Якщо ця умова не виконана і опція встановлена, спроба визначення OS не виконується (заощаджує час).

**--osscan-guess** Коли OS detection не ідеальний, ця опція змушує намагатися сильніше.

**Scripts**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

Щоб використовувати default scripts, використовуйте -sC або --script=default

Available types are: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, and vuln

- **Auth:** виконує всі доступні authentication scripts
- **Default:** виконує базові default tool scripts
- **Discovery:** отримує інформацію з цілі або жертви
- **External:** скрипт для використання external resources
- **Intrusive:** використовує скрипти, які вважаються intrusive щодо жертви або цілі
- **Malware:** перевіряє з'єднання, відкриті зловмисним кодом або backdoors
- **Safe:** виконує non-intrusive scripts
- **Vuln:** виявляє найбільш відомі vulnerabilities
- **All:** виконує абсолютно всі доступні NSE extension scripts

Щоб шукати скрипти:

**nmap --script-help="http-\*" -> Those starting with http-**

**nmap --script-help="not intrusive" -> All except those**

**nmap --script-help="default or safe" -> Those in either or both**

**nmap --script-help="default and safe" --> Those in both**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> Надає інформацію про хід виконання скрипта

--script-updatedb

**Щоб використати скрипт, просто введіть: nmap --script Script_Name target** --> При використанні скрипта одночасно виконаються і сканер, і скрипт, тому можна додавати опції сканера. Можна додати **"safe=1"** щоб виконувати лише safe ones.

**Time Control**

**Nmap може приймати time в секундах, хвилинах, ms:** --host-timeout аргументи 900000ms, 900, 900s, і 15m роблять те саме.

Nmap ділить загальну кількість хостів для сканування на групи і аналізує ці групи блоками, тож не переходить до наступного блоку, поки всі не будуть проскановані (і користувач не отримує оновлень, доки блок не буде завершений). Таким чином Nmap оптимально працює з великими групами. За замовчуванням у class C використовує 256.

Це можна змінити за допомогою **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ (Налаштування розмірів паралельних груп сканування)

Можна контролювати кількість паралельних сканерів, але краще цього не робити (Nmap вже має автоматичний контроль на основі стану мережі): **--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

Можемо змінювати RTT timeout, але зазвичай це не потрібно: **--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

Можемо змінити кількість спроб: **--max-retries** _**<numtries>**_

Можемо змінити час сканування одного хоста: **--host-timeout** _**<time>**_

Можемо змінити затримку між кожним тестом, щоб уповільнити: **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

Можемо змінити кількість пакетів за секунду: **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

Багато портів довго відповідають, коли filtered або closed. Якщо цікавлять лише open, можна пришвидшити з: **--defeat-rst-ratelimit**

Щоб визначити, наскільки агресивним хочемо бути: -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> Сканує лише 1 порт за раз і чекає 5min до наступного

-T1 і T2 --> Дуже схожі, але чекають відповідно 15 та 0.4sec між кожним тестом

-T3 --> Дефолт, включає паралельне сканування

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Вони не дозволяють доступ до портів та аналізують пакети.

**-f** Фрагментація пакетів, за замовчуванням фрагментує на 8 bytes після заголовка; щоб вказати розмір — використовують ..mtu (з цим не використовуйте -f), офсет має бути кратним 8. **Version scanners і scripts не підтримують fragmentation**

**-D decoy1,decoy2,ME** Nmap відправляє сканування з іншими IP як джерело, так приховує вас. Якщо додати ME у список, Nmap поставить вас там; краще вставити 5 або 6 адрес перед вами, щоб повністю замаскувати. Random IPs можна генерувати з RND:<number> Для генерації <number> випадкових IPs. Вони не працюють з TCP version detectors без з'єднання. Якщо ви всередині мережі, краще використовувати активні IPs, інакше буде легко виявити, що ви — єдиний активний.

Щоб використати random IPs: nmap -D RND:10 Target_IP

**-S IP** Коли Nmap не вказує ваш IP, треба його задати. Також служить, щоб зробити вигляд, ніби інша ціль вас сканує.

**-e <interface>** Вибрати інтерфейс

Багато адміністраторів залишають деякі порти відкритими, щоб усе працювало зручніше. Це можуть бути DNS порти або FTP порти... щоб знайти цю вразливість, Nmap включає: **--source-port** _**<portnumber>**_**;-g** _**<portnumber>**_ _Еквівалентні_

**--data** _**<hex string>**_ Щоб відправити hex-текст: --data 0xdeadbeef та --data \xCA\xFE\x09

**--data-string** _**<string>**_ Щоб відправити звичайний текст: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Nmap надсилає лише заголовки; з цією опцією додається кількість байт (які будуть згенеровані випадково)

Щоб повністю налаштувати IP-пакет використовуйте **--ip-options**

Якщо хочете бачити опції у пакетах, що відправляються та отримуються, вкажіть --packet-trace. Для додаткової інформації та прикладів використання IP options з Nmap див. [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52).

**--ttl** _**<value>**_

**--randomize-hosts** Щоб зробити атаку менш очевидною

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ Щоб змінити MAC; приклади: Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, і Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ Щоб використовувати proxies; іноді proxy не підтримує стільки відкритих з'єднань, скільки хоче Nmap, тому потрібно змінити паралелізм: --max-parallelism

**-sP** Для виявлення хостів у нашій мережі через ARP

Багато адміністраторів створюють правило фаєрвола, що дозволяє всі пакети з певного порту (наприклад 20,53 і 67). Ми можемо наказати Nmap відправляти наші пакети з цих портів: **nmap --source-port 53 IP**

**Outputs**

**-oN file** Normal output

**-oX file** XML output

**-oS file** Script kiddies output

**-oG file** Greppable output

**-oA file** All except -oS

**-v level** verbosity

**-d level** debugging

**--reason** Причина стану хоста

**--stats-every time** Через цей інтервал повідомляє про прогрес

**--packet-trace** Щоб бачити які пакети виходять; можна вказувати фільтри, наприклад: --version-trace або --script-trace

**--open** Показує open, open|filtered та unfiltered

**--resume file** Відновлює збережений файл зі зведенням

**Miscellaneous**

**-6** Дозволяє IPv6

**-A** еквівалент -O -sV -sC --traceroute

**Run time**

Поки Nmap працює, можна змінювати опції:

v / V Збільшити / зменшити рівень verbosity

d / D Збільшити / зменшити рівень debugging

p / P Увімкнути / вимкнути packet tracing

? Друк допомоги для runtime interaction

**Vulscan**

Nmap скрипт, який дивиться на версії сервісів, отримані у офлайн базі даних (завантаженої з інших важливих джерел) і повертає можливі вразливості

DBs, які використовуються:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Щоб завантажити та встановити у папку Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Також потрібно завантажити DB пакети і додати їх в /usr/share/nmap/scripts/vulscan/

Використання:

Щоб використати все: sudo nmap -sV --script=vulscan HOST_TO_SCAN

Щоб використати конкретну DB: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Speed Up Nmap Service scan x16

За [**цією публікацією**](https://joshua.hu/nmap-speedup-service-scanning-16x) можна прискорити nmap service analysis, змінивши всі значення **`totalwaitms`** у **`/usr/share/nmap/nmap-service-probes`** на **300** та **`tcpwrappedms`** на **200**.

Крім того, probes, які не мають конкретно визначеного **`servicewaitms`**, використовують значення за замовчуванням **`5000`**. Тому або можна додати значення до кожного probe, або **скомпілювати nmap** самому і змінити значення за замовчуванням у [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79).

Якщо ви не хочете змінювати `totalwaitms` і `tcpwrappedms` у `/usr/share/nmap/nmap-service-probes` файлі, можна відредагувати [парсинг-код](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358) таким чином, щоб ці значення в `nmap-service-probes` файлі повністю ігнорувалися.


## Build a static Nmap for restricted environments

У захищених або мінімальних Linux-середовищах (контейнери, appliances) динамічно зв'язані Nmap бінарники часто не працюють через відсутні runtime loaders або shared libraries (наприклад, /lib64/ld-linux-x86-64.so.2, libc.so). Побудова власного статично зв'язаного Nmap і пакування NSE даних дозволяє виконувати його без інсталяції системних пакетів.

High-level approach
- Використати чистий amd64 Ubuntu builder через Docker.
- Побудувати OpenSSL та PCRE2 як static libraries.
- Побудувати Nmap, лінкуючи статично та використовуючи включені libpcap/libdnet, щоб уникнути динамічних залежностей.
- Пакувати NSE scripts і data directories разом з бінарником.

Discover target architecture (example)
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
Крок 1 — Підготуйте toolchain
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
Крок 2 — Зібрати статичний OpenSSL (1.1.1w)
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
Крок 3 — Збірка статичної PCRE2 (10.43)
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
Крок 4 — Збірка статичного Nmap (7.98)
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
Ключові моменти
- -static, -static-libstdc++, -static-libgcc примушують статичне зв'язування.
- Використання --with-libpcap=included/--with-libdnet=included уникає залежності від системних shared libs.
- Налаштування через sed нейтралізує ціль shared libpcap, якщо вона присутня.

Крок 5 — Упакувати бінарний файл і дані NSE
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
Примітки для перевірки та операцій
- Використайте file на артефакті, щоб підтвердити, що він має статичне лінкування.
- Зберігайте дані NSE разом із бінарним файлом, щоб забезпечити однаковість скриптів на хостах без встановленого Nmap.
- Навіть зі статичним бінарним файлом виконання може блокуватися AppArmor/seccomp/SELinux; DNS/egress має все одно працювати.
- Детерміновані збірки зменшують ризик ланцюга постачання у порівнянні з завантаженням непрозорих “static” бінарних файлів.

Однорядкова команда (Dockerized)
<details>
<summary>Зібрати, упакувати та вивести інформацію про артефакт</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## References

- [Compiling static Nmap binary for jobs in restricted environments](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (helper tool)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL sources](https://www.openssl.org/source/)
- [PCRE2 releases](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap source tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
