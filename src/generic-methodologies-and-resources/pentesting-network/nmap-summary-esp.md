# Nmap 概述 (ESP)

{{#include ../../banners/hacktricks-training.md}}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parameters

### IPs to scan

- **`<ip>,<net/mask>`:** 直接指定 ips
- **`-iL <ips_file>`:** list_IPs
- **`-iR <number>`**: 随机 Ips 的数量，可用 `--exclude <Ips>` 或 `--excludefile <file>` 排除可能的 Ips。

### Equipment discovery

默认情况下 Nmap 启动一个发现阶段，包含：`-PA80 -PS443 -PE -PP`

- **`-sL`**: 非侵入式，只列出目标并发出 **DNS** 请求解析名称。用于确认例如 www.prueba.es/24 中的所有 Ips 是否为我们的目标。
- **`-Pn`**: **No ping**。当你知道所有主机都在线时很有用（否则可能浪费大量时间，也可能产生误报把活的当成不活），它可以跳过发现阶段。
- **`-sn`** : **No port scan**。完成侦察阶段后不做端口扫描。相对隐蔽，适合小规模网络扫描。有权限时它会向 80 发 ACK (-PA)、向 443 发 SYN(-PS) 并发送 echo request 和 Timestamp request；无权限时则总是完成连接。如果目标是网络，它仅使用 ARP(-PR)。与其他选项一起使用时，只有其他选项的包会被发送。
- **`-PR`**: **Ping ARP**。在分析本网络内主机时默认使用，较 ping 更快。若不想用 ARP 包可用 `--send-ip`。
- **`-PS <ports>`**: 发送 SYN 包，若回应 SYN/ACK 表示 open（随后回复 RST 以不完成连接），若回应 RST 表示 closed，若无回应表示 unreachable。若无权限则自动使用完整连接。若未指定端口，默认为 80。
- **`-PA <ports>`**: 类似但使用 ACK，二者结合可得更好结果。
- **`-PU <ports>`**: 目标相反，发送到预计为 closed 的端口。有些防火墙只检查 TCP 连接。若 closed 会回复 port unreachable，若回复其他 icmp 或无回应则标记为 destination unreachable。
- **`-PE, -PP, -PM`** : ICMP PINGS：echo reply、timestamp 和 addresmask。用于判断目标是否在线。
- **`-PY<ports>`**: 发送 SCTP INIT 探针，默认到 80，可能回复 INIT-ACK(open)、ABORT(closed)、无回应或 ICMP unreachable(inactive)。
- **`-PO <protocols>`**: 在头部指定协议，默认 1(ICMP)、2(IGMP) 和 4(Encap IP)。对 ICMP、IGMP、TCP (6) 和 UDP (17) 协议发送协议头，其它协议只发送 IP 头。目的是通过异常头部触发 Protocol unreachable 或同协议的应答以判断是否在线。
- **`-n`**: No DNS
- **`-R`**: DNS always

### Port scanning techniques

- **`-sS`**: 不完成连接因此不留痕迹，若可用则很好。（需要权限）为默认使用方式。
- **`-sT`**: 完成连接，会留下痕迹，但在无权限时可用。默认在无权限下使用。
- **`-sU`**: 较慢，用于 UDP。常见：DNS(53)、SNMP(161,162)、DHCP(67 and 68)（示例：`-sU53,161,162,67,68`）：open(reply)、closed(port unreachable)、filtered(另一个 ICMP)、open/filtered(无回应)。在 open/filtered 情况，`-sV` 会发送大量请求以检测 nmap 支持的版本并确定真实状态，会显著增加耗时。
- **`-sY`**: SCTP 协议，尝试建立连接失败故无日志，工作方式类似 `-PY`
- **`-sN,-sX,-sF`:** Null、Fin、Xmas，可穿透某些防火墙并提取信息。基于标准合规主机对于没有 SYN、RST 或 ACK 位设置的请求应以 RST 响应：open/filtered(无回应)、closed(RST)、filtered(ICMP unreachable)。在 Windows、Cisco、BSDI 和 OS/400 上不可靠；在 unix 上可用。
- **`-sM`**: Maimon 扫描：发送 FIN 和 ACK 标志，曾用于 BSD，目前通常返回全部为 closed。
- **`-sA, sW`**: ACK 和 Window，用于检测防火墙，判断端口是否被过滤。`-sW` 能区分 open/closed，因为 open 的 RST 会带有非 0 的 window：open (RST window ≠ 0)、closed (RST window = 0)、filtered (ICMP unreachable 或无回应)。并非所有主机都这样工作：若全部显示 closed，则方法无效；若少数 open 则正常；若多数 open 少数 closed，则与上述相反。
- **`-sI`:** Idle scan。适用于存在活动防火墙但我们知道对某个 IP 不会过滤（或需要匿名）时，使用 zombie scanner（对所有端口可用）。可用脚本 ipidseq 或 exploit auxiliary/scanner/ip/ipidseq 寻找可能的 zombies。该扫描基于 IP 包的 IPID 编号。
- **`--badsum`:** 发送错误校验和，主机可能丢弃包，但防火墙可能会有响应，用于探测防火墙。
- **`-sZ`:** "Weird" SCTP 扫描，发送带 cookie echo fragments 的探针，open 时应被丢弃，closed 时应以 ABORT 响应。能穿过 init 无法穿过的防火墙，但无法区分 filtered 与 open。
- **`-sO`:** Protocol Ip 扫描。发送畸形或空头部，有时甚至无法区分协议。若收到 ICMP unreachable protocol 则为 closed，若收到 unreachable port 则为 open，若收到其它错误则为 filtered，若无回应则为 open|filtered。
- **`-b <server>`:** FTPhost --> 用一台机器通过另一台机器来扫描主机，方法是连接到另一台机器的 ftp 并请求其向你想扫描的端口发送文件，根据响应判断端口是否打开。格式: [\<user>:\<password>@]\<server>\[:\<port>]。几乎所有 ftp 服务器现在都不再允许此操作，实际用途有限。

### **Focus Analysis**

**-p:** 用于指定扫描端口。扫描全部 65,335 个端口：**-p-** 或 **-p all**。Nmap 有基于流行度的内部端口分类，默认扫描前 1000 个端口。使用 **-F**（fast scan）时扫描前 100 个。使用 **--top-ports <number>** 可扫描前 N 个端口（1 到 65,335）。端口按随机顺序检查；如需禁止随机，用 **-r**。也可选择具体端口：20-30,80,443,1024-（后者表示从 1024 起）。可按协议分组端口：U:53,T:21-25,80,139,S:9。也可在 Nmap 的 popular ports 范围内选择：`-p [-1024]` 分析 nmap-services 中到 1024 的端口。**--port-ratio <ratio>** 在 0 到 1 的比率内分析最常见端口。

**-sV** 版本扫描，强度可从 0 到 9 调节，默认 7。

**--version-intensity <number>** 调节强度，值越低只发送最可能的探针而非全部，从而可显著缩短 UDP 扫描时间。

**-O** OS detection

**--osscan-limit** 为了正确的主机识别，需要至少一个 open 端口和一个 closed 端口。若未满足且设置了此项，则不会尝试 OS 预测（节省时间）。

**--osscan-guess** 当 OS 检测不确定时，强制其进一步尝试猜测。

**Scripts**

--script _<filename>_|_<category>_|_<directory>_|_<expression>_[,...]

使用默认脚本，使用 -sC 或 --script=default

可用类型：auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, and vuln

- **Auth:** 执行所有可用的认证脚本
- **Default:** 执行基本的默认工具脚本
- **Discovery:** 从目标/受害者收集信息
- **External:** 使用外部资源的脚本
- **Intrusive:** 使用被认为对目标侵入性的脚本
- **Malware:** 检查恶意代码或后门打开的连接
- **Safe:** 执行非侵入性的脚本
- **Vuln:** 发现最已知的漏洞
- **All:** 执行所有可用的 NSE 扩展脚本

查找脚本：

**nmap --script-help="http-\*" -> Those starting with http-**

**nmap --script-help="not intrusive" -> All except those**

**nmap --script-help="default or safe" -> Those in either or both**

**nmap --script-help="default and safe" --> Those in both**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

--script-args _<n1>_=_<v1>_,_<n2>_={_<n3>_=_<v3>_},_<n4>_={_<v4>_,_<v5>_}

--script-args-file _<filename>_

--script-help _<filename>_|_<category>_|_<directory>_|_<expression>_|all[,...]

--script-trace ---> 提供脚本执行进度的信息

--script-updatedb

**使用脚本** 只需运行: nmap --script Script_Name target --> 使用脚本时，脚本和扫描器都会执行，因此也可以添加扫描器选项。可加 **"safe=1"** 仅执行安全脚本。

**Time Control**

Nmap 可以以秒、分钟、毫秒修改时间参数：--host-timeout 参数 900000ms、900、900s、和 15m 都等价。

Nmap 会将要扫描的主机总数分成若干组并分块分析，只有当该块内所有主机分析完成后才会进入下一块（用户在块完成前不会收到更新）。因此对 Nmap 来说使用大组更高效。默认在 class C 环境使用 256。

可用 **--min-hostgroup** _**<numhosts>**_**;** **--max-hostgroup** _**<numhosts>**_ 调整并行扫描组大小。

你可以控制并行扫描器数量，但通常不建议（Nmap 已基于网络状态自动控制）：**--min-parallelism** _**<numprobes>**_**;** **--max-parallelism** _**<numprobes>**_

可修改 RTT 超时，通常不必改动：**--min-rtt-timeout** _**<time>**_**,** **--max-rtt-timeout** _**<time>**_**,** **--initial-rtt-timeout** _**<time>**_

可修改尝试次数： **--max-retries** _**<numtries>**_

可修改单主机扫描超时： **--host-timeout** _**<time>**_

可修改每次测试之间的间隔以降低速度： **--scan-delay** _**<time>**_**;** **--max-scan-delay** _**<time>**_

可修改每秒包数： **--min-rate** _**<number>**_**;** **--max-rate** _**<number>**_

很多端口在被过滤或关闭时响应很慢。如果我们只关心 open，可以加快速度：**--defeat-rst-ratelimit**

定义 Nmap 的激进程度： -T paranoid|sneaky|polite|normal|aggressive|insane

-T (0-1)

-T0 --> 每次只扫描 1 个端口，并在下一次扫描前等待 5 分钟

-T1 和 T2 --> 非常相似，但分别只等待 15 秒和 0.4 秒每次测试之间

-T3 --> 默认操作，包含并行扫描

-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

它们阻止对端口的访问并分析数据包。

**-f** 将包分片，默认在头部后分片为 8 bytes，若要指定大小用 ..mtu（与此同时不要使用 -f），偏移必须为 8 的倍数。**Version scanners and scripts don't support fragmentation**

**-D decoy1,decoy2,ME** Nmap 发送扫描包但伪造来源 IP，借此隐藏真实来源。如果在列表中加入 ME，Nmap 会把你放那里，建议在你之前加入 5 或 6 个以彻底掩盖。可用 RND:<number> 生成随机 IP。TCP version detectors without connection 无法与此一起工作。如果你在内部网络，最好使用活跃的 IP，否则很容易看出只有你是活动的。

使用随机 IP： nmap -D RND:10 Target_IP

**-S IP** 当 Nmap 无法自动识别你的 IP 时可手动指定。亦可用来让目标误以为是另一个目标在扫描它们。

**-e <interface>** 选择接口

许多管理员为方便让某些端口对所有来源开放（例如 20、53、67），我们可以告诉 Nmap 从这些端口发送数据： **nmap --source-port 53 IP**

**--data** _**<hex string>**_ 发送十六进制数据： --data 0xdeadbeef 和 --data \xCA\xFE\x09

**--data-string** _**<string>**_ 发送普通文本： --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**<number>**_ Nmap 仅发送头部，使用此项可额外添加若干字节（随机生成）

要完整配置 IP 包可用 **--ip-options**

若想查看发送和接收包中的选项，可指定 --packet-trace。有关在 Nmap 中使用 IP options 的更多信息和示例，见 [http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52)。

**--ttl** _**<value>**_

**--randomize-hosts** 使攻击不那么明显

**--spoof-mac** _**<MAC address, prefix, or vendor name>**_ 更改 MAC 示例： Apple, 0, 01:02:03:04:05:06, deadbeefcafe, 0020F2, 和 Cisco

**--proxies** _**<Comma-separated list of proxy URLs>**_ 使用代理，有时代理不会维持 Nmap 想要的并发连接数，此时需要修改并行数： --max-parallelism

**-sP** 通过 ARP 在我们网络中发现主机

许多管理员创建防火墙规则允许来自某个端口的所有数据包通过（如 20、53、67），我们可以让 Nmap 从这些端口发送包： **nmap --source-port 53 IP**

**Outputs**

**-oN file** Normal output

**-oX file** XML output

**-oS file** Script kiddies output

**-oG file** Greppable output

**-oA file** All except -oS

**-v level** verbosity

**-d level** debugging

**--reason** 显示 host 和 state 的原因

**--stats-every time** 每隔该时间给出进度信息

**--packet-trace** 查看发送的包，可指定过滤如： --version-trace 或 --script-trace

**--open** 显示 open、open|filtered 和 unfiltered

**--resume file** 恢复并输出摘要

**Miscellaneous**

**-6** 支持 IPv6

**-A** 等同于 -O -sV -sC --traceroute

**Run time**

在 Nmap 运行过程中可以修改选项：

v / V 增加 / 减少 verbosity 等级

d / D 增加 / 减少 debugging 等级

p / P 开 / 关 packet tracing

? 打印运行时交互帮助界面

**Vulscan**

Nmap 的脚本，用离线数据库（从多个重要来源下载）对获得的服务版本进行比对并返回可能的漏洞

它使用的 DB 有：

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

下载并安装到 Nmap 文件夹：

wget http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

还需下载 DB 包并添加到 /usr/share/nmap/scripts/vulscan/

用法：

使用全部： sudo nmap -sV --script=vulscan HOST_TO_SCAN

使用特定 DB： sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST_TO_SCAN

## Speed Up Nmap Service scan x16

根据 [**to this post**](https://joshua.hu/nmap-speedup-service-scanning-16x) 你可以通过将 **`/usr/share/nmap/nmap-service-probes`** 中所有 **`totalwaitms`** 值改为 **300**，并将 **`tcpwrappedms`** 改为 **200** 来加速 nmap 的 service 分析。

此外，未为探针专门定义 **`servicewaitms`** 的探针会使用默认值 **`5000`**。因此，我们可以为每个探针添加该值，或者自行 **compile nmap** 并在 [**service_scan.h**](https://github.com/nmap/nmap/blob/master/service_scan.h#L79) 中更改默认值。

如果你完全不想在 `/usr/share/nmap/nmap-service-probes` 文件中更改 **`totalwaitms`** 和 **`tcpwrappedms`** 的值，你也可以编辑 [parsing code](https://github.com/nmap/nmap/blob/master/service_scan.cc#L1358)，使得该文件中的这些值被完全忽略。

## Build a static Nmap for restricted environments

在强化或极简的 Linux 环境（容器、appliances）中，动态链接的 Nmap 二进制常因缺少运行时 loader 或共享库（例如 /lib64/ld-linux-x86-64.so.2、libc.so）而无法运行。构建静态链接的 Nmap 并打包 NSE 数据可以在不安装系统包的情况下运行。

High-level approach
- 使用干净的 amd64 Ubuntu builder（通过 Docker）。
- 将 OpenSSL 和 PCRE2 构建为静态库。
- 构建 Nmap 时使用静态链接，并使用内置的 libpcap/libdnet 以避免动态依赖。
- 将 NSE 脚本和数据目录与二进制一起打包。

Discover target architecture (example)
```bash
uname -a
# If building from macOS/ARM/etc., pin the builder arch:
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc 'echo ok'
```
步骤 1 — 准备工具链
```bash
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev
```
步骤 2 — 构建静态 OpenSSL (1.1.1w)
```bash
OSSL="1.1.1w"
curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz"
tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL"
./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl
make -j"$(nproc)" && make install_sw
cd /tmp
```
第3步 — 构建静态 PCRE2 (10.43)
```bash
PCRE2=10.43
curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2"
tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2"
./configure --disable-shared --enable-static --prefix=/opt/pcre2
make -j"$(nproc)" && make install
cd /tmp
```
第4步 — 构建静态 Nmap (7.98)
```bash
NMAP=7.98
curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2"
tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP"
export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include"
export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc"
export LIBS="-lpcre2-8 -ldl -lpthread -lz"
./configure \
--with-openssl=/opt/ossl \
--with-libpcre=/opt/pcre2 \
--with-libpcap=included \
--with-libdnet=included \
--without-zenmap --without-ndiff --without-nmap-update
# Avoid building shared libpcap by accident
sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true
make -j1 V=1 nmap
strip nmap
```
要点
- -static, -static-libstdc++, -static-libgcc 强制静态链接。
- 使用 --with-libpcap=included/--with-libdnet=included 可避免使用系统共享库。
- sed 的调整会在存在时使共享 libpcap 目标失效。

第5步 — 打包 binary 和 NSE 数据
```bash
mkdir -p /out/nmap-bundle/nmap-data
cp nmap /out/nmap-bundle/nmap-linux-amd64-static
cp -r scripts nselib /out/nmap-bundle/nmap-data/
cp nse_main.lua nmap-services nmap-protocols nmap-service-probes \
nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc \
/out/nmap-bundle/nmap-data/ 2>/dev/null || true

tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle
```
验证与运维说明
- 使用 file 命令在工件上确认它是静态链接的。
- 将 NSE 数据与二进制文件一并保留，以确保在未安装 Nmap 的主机上脚本一致性。
- 即使是静态二进制，执行也可能被 AppArmor/seccomp/SELinux 阻止；DNS/egress 仍必须可用。
- 确定性构建相比下载不透明的“static”二进制能降低供应链风险。

单行命令（Docker 化）
<details>
<summary>构建、打包并打印工件信息</summary>
```bash
docker run --rm --platform=linux/amd64 -v "$(pwd)":/out -w /tmp ubuntu:22.04 bash -lc '
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive
apt-get update && apt-get install -y --no-install-recommends \
build-essential ca-certificates curl bzip2 xz-utils pkg-config perl python3 file git \
automake autoconf libtool m4 zlib1g-dev

OSSL="1.1.1w"; curl -fsSLO "https://www.openssl.org/source/openssl-$OSSL.tar.gz" \
&& tar xzf "openssl-$OSSL.tar.gz" && cd "openssl-$OSSL" \
&& ./Configure no-shared no-zlib linux-x86_64 -static --prefix=/opt/ossl \
&& make -j"$(nproc)" && make install_sw && cd /tmp

PCRE2=10.43; curl -fsSLO "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-$PCRE2/pcre2-$PCRE2.tar.bz2" \
&& tar xjf "pcre2-$PCRE2.tar.bz2" && cd "pcre2-$PCRE2" \
&& ./configure --disable-shared --enable-static --prefix=/opt/pcre2 \
&& make -j"$(nproc)" && make install && cd /tmp

NMAP=7.98; curl -fsSLO "https://nmap.org/dist/nmap-$NMAP.tar.bz2" \
&& tar xjf "nmap-$NMAP.tar.bz2" && cd "nmap-$NMAP" \
&& export CPPFLAGS="-I/opt/ossl/include -I/opt/pcre2/include" \
&& export LDFLAGS="-L/opt/ossl/lib -L/opt/pcre2/lib -static -static-libstdc++ -static-libgcc" \
&& export LIBS="-lpcre2-8 -ldl -lpthread -lz" \
&& ./configure --with-openssl=/opt/ossl --with-libpcre=/opt/pcre2 --with-libpcap=included --with-libdnet=included --without-zenmap --without-ndiff --without-nmap-update \
&& sed -i -e "s/^shared: /shared: #/" libpcap/Makefile || true \
&& make -j1 V=1 nmap && strip nmap

mkdir -p /out/nmap-bundle/nmap-data \
&& cp nmap /out/nmap-bundle/nmap-linux-amd64-static \
&& cp -r scripts nselib /out/nmap-bundle/nmap-data/ \
&& cp nse_main.lua nmap-services nmap-protocols nmap-service-probes nmap-mac-prefixes nmap-os-db nmap-payloads nmap-rpc /out/nmap-bundle/nmap-data/ 2>/dev/null || true \
&& tar -C /out -czf /out/nmap-linux-amd64-static-bundle.tar.gz nmap-bundle \
&& echo "===== OUTPUT ====="; ls -lah /out; echo "===== FILE TYPE ====="; file /out/nmap-bundle/nmap-linux-amd64-static || true
'
```
</details>

## 参考资料

- [在受限环境中为作业编译 static Nmap 二进制文件](https://www.pentestpartners.com/security-blog/compiling-static-nmap-binary-for-jobs-in-restricted-environments/)
- [Static Nmap Binary Generator (辅助工具)](https://github.com/0x5ubt13/static_nmap_binary_generator)
- [OpenSSL 源码](https://www.openssl.org/source/)
- [PCRE2 发布](https://github.com/PCRE2Project/pcre2/releases)
- [Nmap 源代码 tarballs](https://nmap.org/dist/)


{{#include ../../banners/hacktricks-training.md}}
