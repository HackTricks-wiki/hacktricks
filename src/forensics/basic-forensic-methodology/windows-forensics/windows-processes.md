{{#include ../../../banners/hacktricks-training.md}}

## smss.exe

**Менеджер сесій**.\
Сесія 0 запускає **csrss.exe** та **wininit.exe** (**сервіси ОС**), тоді як Сесія 1 запускає **csrss.exe** та **winlogon.exe** (**сесія користувача**). Однак ви повинні бачити **лише один процес** цього **бінарного файлу** без дочірніх у дереві процесів.

Також сесії, окрім 0 та 1, можуть означати, що відбуваються RDP сесії.

## csrss.exe

**Процес підсистеми клієнт/сервер**.\
Він управляє **процесами** та **потоками**, робить **API Windows** доступним для інших процесів, а також **відображає літери дисків**, створює **тимчасові файли** та обробляє **процес завершення роботи**.

Є один **запущений у Сесії 0 та інший у Сесії 1** (тобто **2 процеси** в дереві процесів). Інший створюється **для нової сесії**.

## winlogon.exe

**Процес входу в Windows**.\
Він відповідає за **вхід**/**вихід** користувача. Він запускає **logonui.exe** для запиту імені користувача та пароля, а потім викликає **lsass.exe** для їх перевірки.

Потім він запускає **userinit.exe**, який вказаний у **`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`** з ключем **Userinit**.

Крім того, попередній реєстр повинен містити **explorer.exe** в ключі **Shell**, інакше це може бути використано як **метод збереження шкідливого ПЗ**.

## wininit.exe

**Процес ініціалізації Windows**. \
Він запускає **services.exe**, **lsass.exe** та **lsm.exe** у Сесії 0. Має бути лише 1 процес.

## userinit.exe

**Додаток входу Userinit**.\
Завантажує **ntduser.dat в HKCU** та ініціалізує **середовище** **користувача**, запускає **скрипти входу** та **GPO**.

Він запускає **explorer.exe**.

## lsm.exe

**Менеджер локальних сесій**.\
Він працює з smss.exe для маніпуляції сесіями користувачів: вхід/вихід, запуск оболонки, блокування/розблокування робочого столу тощо.

Після W7 lsm.exe був перетворений на сервіс (lsm.dll).

Має бути лише 1 процес у W7, і з них сервіс, що виконує DLL.

## services.exe

**Менеджер контролю сервісів**.\
Він **завантажує** **сервіси**, налаштовані на **автозапуск**, та **драйвери**.

Це батьківський процес для **svchost.exe**, **dllhost.exe**, **taskhost.exe**, **spoolsv.exe** та багатьох інших.

Сервіси визначені в `HKLM\SYSTEM\CurrentControlSet\Services`, і цей процес підтримує базу даних у пам'яті з інформацією про сервіси, яку можна запитати за допомогою sc.exe.

Зверніть увагу, що **деякі** **сервіси** будуть працювати в **процесі самостійно**, а інші будуть **ділити процес svchost.exe**.

Має бути лише 1 процес.

## lsass.exe

**Підсистема локальної безпеки**.\
Він відповідає за **автентифікацію** користувача та створення **токенів безпеки**. Він використовує пакети автентифікації, розташовані в `HKLM\System\CurrentControlSet\Control\Lsa`.

Він записує в **журнал подій безпеки**, і має бути лише 1 процес.

Майте на увазі, що цей процес часто атакують для скидання паролів.

## svchost.exe

**Універсальний процес хостингу сервісів**.\
Він хостить кілька DLL-сервісів в одному спільному процесі.

Зазвичай ви знайдете, що **svchost.exe** запускається з прапором `-k`. Це запустить запит до реєстру **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost**, де буде ключ з аргументом, згаданим у -k, який міститиме сервіси для запуску в тому ж процесі.

Наприклад: `-k UnistackSvcGroup` запустить: `PimIndexMaintenanceSvc MessagingService WpnUserService CDPUserSvc UnistoreSvc UserDataSvc OneSyncSvc`

Якщо також використовується **прапор `-s`** з аргументом, тоді svchost запитується, щоб **запустити лише вказаний сервіс** в цьому аргументі.

Будуть кілька процесів `svchost.exe`. Якщо жоден з них **не використовує прапор `-k`**, це дуже підозріло. Якщо ви виявите, що **services.exe не є батьківським**, це також дуже підозріло.

## taskhost.exe

Цей процес діє як хост для процесів, що виконуються з DLL. Він також завантажує сервіси, які працюють з DLL.

У W8 це називається taskhostex.exe, а в W10 taskhostw.exe.

## explorer.exe

Це процес, відповідальний за **робочий стіл користувача** та запуск файлів через розширення файлів.

**Лише 1** процес має бути запущений **для кожного увійшовшого користувача.**

Це запускається з **userinit.exe**, який має бути завершений, тому **жоден батьківський** процес не повинен з'являтися для цього процесу.

# Виявлення шкідливих процесів

- Чи працює він з очікуваного шляху? (Жодні бінарні файли Windows не працюють з тимчасового розташування)
- Чи спілкується він з дивними IP-адресами?
- Перевірте цифрові підписи (артефакти Microsoft повинні бути підписані)
- Чи правильно написано?
- Чи працює під очікуваним SID?
- Чи є батьківський процес очікуваним (якщо є)?
- Чи є дочірні процеси тими, що очікуються? (жодного cmd.exe, wscript.exe, powershell.exe..?)

{{#include ../../../banners/hacktricks-training.md}}
