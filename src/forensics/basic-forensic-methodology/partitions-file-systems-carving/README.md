# Розділи/Файлові системи/Карвінг

{{#include ../../../banners/hacktricks-training.md}}

## Розділи

Жорсткий диск або **SSD диск можуть містити різні розділи** з метою фізичного розділення даних.\
**Мінімальна** одиниця диска - це **сектор** (зазвичай складається з 512B). Отже, розмір кожного розділу повинен бути кратним цьому розміру.

### MBR (майстер-завантажувальний запис)

Він розміщується в **першому секторі диска після 446B завантажувального коду**. Цей сектор є важливим для вказівки ПК, що і звідки має бути змонтовано.\
Він дозволяє до **4 розділів** (максимум **лише 1** може бути активним/**завантажувальним**). Однак, якщо вам потрібно більше розділів, ви можете використовувати **розширені розділи**. **Останній байт** цього першого сектора - це підпис завантажувального запису **0x55AA**. Лише один розділ може бути позначений як активний.\
MBR дозволяє **макс 2.2TB**.

![](<../../../images/image (489).png>)

![](<../../../images/image (490).png>)

З **байтів 440 до 443** MBR ви можете знайти **Windows Disk Signature** (якщо використовується Windows). Логічна буква диска жорсткого диска залежить від Windows Disk Signature. Зміна цього підпису може завадити Windows завантажитися (інструмент: [**Active Disk Editor**](https://www.disk-editor.org/index.html)**)**.

![](<../../../images/image (493).png>)

**Формат**

| Зсув        | Довжина    | Елемент              |
| ----------- | ---------- | ------------------- |
| 0 (0x00)    | 446(0x1BE) | Завантажувальний код |
| 446 (0x1BE) | 16 (0x10)  | Перший розділ       |
| 462 (0x1CE) | 16 (0x10)  | Другий розділ       |
| 478 (0x1DE) | 16 (0x10)  | Третій розділ       |
| 494 (0x1EE) | 16 (0x10)  | Четвертий розділ    |
| 510 (0x1FE) | 2 (0x2)    | Підпис 0x55 0xAA    |

**Формат запису розділу**

| Зсув      | Довжина   | Елемент                                               |
| --------- | -------- | ---------------------------------------------------- |
| 0 (0x00)  | 1 (0x01) | Активний прапор (0x80 = завантажувальний)           |
| 1 (0x01)  | 1 (0x01) | Початкова голівка                                    |
| 2 (0x02)  | 1 (0x01) | Початковий сектор (біти 0-5); верхні біти циліндра (6-7) |
| 3 (0x03)  | 1 (0x01) | Найнижчі 8 біт початкового циліндра                 |
| 4 (0x04)  | 1 (0x01) | Код типу розділу (0x83 = Linux)                      |
| 5 (0x05)  | 1 (0x01) | Кінцева голівка                                      |
| 6 (0x06)  | 1 (0x01) | Кінцевий сектор (біти 0-5); верхні біти циліндра (6-7) |
| 7 (0x07)  | 1 (0x01) | Найнижчі 8 біт кінцевого циліндра                   |
| 8 (0x08)  | 4 (0x04) | Сектори перед розділом (little endian)              |
| 12 (0x0C) | 4 (0x04) | Сектори в розділі                                    |

Щоб змонтувати MBR в Linux, спочатку потрібно отримати початковий зсув (ви можете використовувати `fdisk` і команду `p`)

![](<../../../images/image (413) (3) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (12).png>)

А потім використовуйте наступний код
```bash
#Mount MBR in Linux
mount -o ro,loop,offset=<Bytes>
#63x512 = 32256Bytes
mount -o ro,loop,offset=32256,noatime /path/to/image.dd /media/part/
```
**LBA (Логічне блочне адресування)**

**Логічне блочне адресування** (**LBA**) є загальною схемою, що використовується для **вказівки місця розташування блоків** даних, збережених на комп'ютерних носіях, зазвичай на вторинних системах зберігання, таких як жорсткі диски. LBA є особливо простим лінійним адресним методом; **блоки розташовані за цілим індексом**, при цьому перший блок має LBA 0, другий LBA 1 і так далі.

### GPT (GUID Таблиця Розділів)

GUID Таблиця Розділів, відома як GPT, віддається перевага за її покращені можливості в порівнянні з MBR (Основний Завантажувальний Запис). Вона відрізняється своєю **глобально унікальною ідентифікацією** для розділів, GPT виділяється кількома способами:

- **Місцезнаходження та Розмір**: Як GPT, так і MBR починаються з **сектора 0**. Однак GPT працює на **64 бітах**, на відміну від 32 біт MBR.
- **Обмеження Розділів**: GPT підтримує до **128 розділів** на системах Windows і може вміщувати до **9.4ZB** даних.
- **Назви Розділів**: Пропонує можливість називати розділи до 36 символів Unicode.

**Стійкість Даних та Відновлення**:

- **Резервування**: На відміну від MBR, GPT не обмежує дані про розділи та завантаження в одному місці. Вона реплікує ці дані по всьому диску, підвищуючи цілісність даних та стійкість.
- **Циклічна Контрольна Сума (CRC)**: GPT використовує CRC для забезпечення цілісності даних. Вона активно контролює наявність пошкоджень даних, і при виявленні GPT намагається відновити пошкоджені дані з іншого місця на диску.

**Захисний MBR (LBA0)**:

- GPT підтримує зворотну сумісність через захисний MBR. Ця функція розташована в простору спадкового MBR, але призначена для запобігання випадковому перезапису дисків GPT старими утилітами на основі MBR, тим самим захищаючи цілісність даних на дисках формату GPT.

![https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/GUID_Partition_Table_Scheme.svg/800px-GUID_Partition_Table_Scheme.svg.png](<../../../images/image (491).png>)

**Гібридний MBR (LBA 0 + GPT)**

[З Вікіпедії](https://en.wikipedia.org/wiki/GUID_Partition_Table)

В операційних системах, які підтримують **завантаження на основі GPT через BIOS** сервіси, а не EFI, перший сектор також може використовуватися для зберігання першої стадії коду **завантажувача**, але **модифікований** для розпізнавання **GPT** **розділів**. Завантажувач у MBR не повинен припускати розмір сектора 512 байт.

**Заголовок таблиці розділів (LBA 1)**

[З Вікіпедії](https://en.wikipedia.org/wiki/GUID_Partition_Table)

Заголовок таблиці розділів визначає використовувані блоки на диску. Він також визначає кількість і розмір записів розділів, які складають таблицю розділів (зсуви 80 і 84 в таблиці).

| Зсув     | Довжина  | Зміст                                                                                                                                                                     |
| -------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0 (0x00) | 8 байт   | Підпис ("EFI PART", 45h 46h 49h 20h 50h 41h 52h 54h або 0x5452415020494645ULL[ ](https://en.wikipedia.org/wiki/GUID_Partition_Table#cite_note-8
