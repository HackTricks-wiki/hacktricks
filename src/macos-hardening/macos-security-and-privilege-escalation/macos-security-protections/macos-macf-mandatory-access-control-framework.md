# macOS MACF

{{#include ../../../banners/hacktricks-training.md}}

## Âü∫Êú¨‰ø°ÊÅØ

**MACF** ‰ª£Ë°® **Mandatory Access Control Framework**ÔºåÂÆÉÊòØÂÜÖÁΩÆ‰∫éÊìç‰ΩúÁ≥ªÁªüÁöÑ‰∏Ä‰∏™ÂÆâÂÖ®Á≥ªÁªüÔºåÁî®‰∫éÂ∏ÆÂä©‰øùÊä§‰Ω†ÁöÑËÆ°ÁÆóÊú∫„ÄÇÂÆÉÈÄöËøáËÆæÁΩÆ **ÂÖ≥‰∫éË∞ÅÊàñ‰ªÄ‰πàÂèØ‰ª•ËÆøÈóÆÁ≥ªÁªüÊüê‰∫õÈÉ®ÂàÜÔºàÂ¶ÇÊñá‰ª∂„ÄÅÂ∫îÁî®Á®ãÂ∫èÂíåÁ≥ªÁªüËµÑÊ∫êÔºâÁöÑ‰∏•Ê†ºËßÑÂàô** Êù•Â∑•‰Ωú„ÄÇÈÄöËøáËá™Âä®Âº∫Âà∂ÊâßË°åËøô‰∫õËßÑÂàôÔºåMACF Á°Æ‰øùÂè™ÊúâË¢´ÊéàÊùÉÁöÑÁî®Êà∑ÂíåËøõÁ®ãÊâçËÉΩÊâßË°åÁâπÂÆöÊìç‰ΩúÔºå‰ªéËÄåÈôç‰ΩéÊú™ÊéàÊùÉËÆøÈóÆÊàñÊÅ∂ÊÑèÊ¥ªÂä®ÁöÑÈ£éÈô©„ÄÇ

Ê≥®ÊÑè MACF Êú¨Ë∫´Âπ∂‰∏çÂÅöÂá∫ÂÜ≥Á≠ñÔºåÂÆÉÂè™ÊòØ**Êã¶Êà™**Êìç‰ΩúÔºåÂπ∂Â∞ÜÂÜ≥Á≠ñÁïôÁªôÂÆÉË∞ÉÁî®ÁöÑ**Á≠ñÁï•Ê®°Âùó**Ôºàkernel extensionsÔºâÔºå‰æãÂ¶Ç `AppleMobileFileIntegrity.kext`„ÄÅ`Quarantine.kext`„ÄÅ`Sandbox.kext`„ÄÅ`TMSafetyNet.kext` Âíå `mcxalr.kext`„ÄÇ

- A policy may be enforcing (return 0 non-zero on some operation)
- A policy may be monitoring (return 0, so as not to object but piggyback on hook to do something)
- A MACF static policy is installed in boot and will NEVER be removed
- A MACF dynamic policy is installed by a KEXT (kextload) and may hypothetically be kextunloaded
- In iOS only static policies are allowed and in macOS static + dynamic.
- [https://newosxbook.com/xxr/index.php](https://newosxbook.com/xxr/index.php)


### ÊµÅÁ®ã

1. ËøõÁ®ãÊâßË°å syscall/mach trap
2. Âú®ÂÜÖÊ†∏‰∏≠Ë∞ÉÁî®Áõ∏ÂÖ≥ÂáΩÊï∞
3. ÂáΩÊï∞Ë∞ÉÁî® MACF
4. MACF Ê£ÄÊü•Âú®ÂÖ∂Á≠ñÁï•‰∏≠ËØ∑Ê±Ç hook ËØ•ÂáΩÊï∞ÁöÑÁ≠ñÁï•Ê®°Âùó
5. MACF Ë∞ÉÁî®Áõ∏ÂÖ≥Á≠ñÁï•
6. Á≠ñÁï•ÊåáÁ§∫ÊòØÂê¶ÂÖÅËÆ∏ÊàñÊãíÁªùËØ•Êìç‰Ωú

> [!CAUTION]
> Apple ÊòØÂîØ‰∏ÄËÉΩÂ§ü‰ΩøÁî® MAC Framework KPI ÁöÑÂÆû‰Ωì„ÄÇ

ÈÄöÂ∏∏Ôºå‰ΩøÁî® MACF Ê£ÄÊü•ÊùÉÈôêÁöÑÂáΩÊï∞‰ºöË∞ÉÁî®ÂÆè `MAC_CHECK`„ÄÇ‰æãÂ¶ÇÔºåÂú®ÂàõÂª∫ socket ÁöÑ syscall ‰∏≠Ôºå‰ºöË∞ÉÁî®ÂáΩÊï∞ `mac_socket_check_create`ÔºåËØ•ÂáΩÊï∞‰ºöË∞ÉÁî® `MAC_CHECK(socket_check_create, cred, domain, type, protocol);`„ÄÇÊ≠§Â§ñÔºåÂÆè `MAC_CHECK` Âú® security/mac_internal.h ‰∏≠ÂÆö‰πâÂ¶Ç‰∏ãÔºö
```c
Resolver tambien MAC_POLICY_ITERATE, MAC_CHECK_CALL, MAC_CHECK_RSLT


#define MAC_CHECK(check, args...) do {                                   \
error = 0;                                                           \
MAC_POLICY_ITERATE({                                                 \
if (mpc->mpc_ops->mpo_ ## check != NULL) {                   \
MAC_CHECK_CALL(check, mpc);                          \
int __step_err = mpc->mpc_ops->mpo_ ## check (args); \
MAC_CHECK_RSLT(check, mpc);                          \
error = mac_error_select(__step_err, error);         \
}                                                            \
});                                                                  \
} while (0)
```
Ê≥®ÊÑèÔºåÂ∞Ü `check` ËΩ¨Êç¢‰∏∫ `socket_check_create`ÔºåÂπ∂Â∞Ü `args...` ÊõøÊç¢‰∏∫ `(cred, domain, type, protocol)`Ôºå‰Ω†‰ºöÂæóÂà∞Ôºö
```c
// Note the "##" just get the param name and append it to the prefix
#define MAC_CHECK(socket_check_create, args...) do {                                   \
error = 0;                                                           \
MAC_POLICY_ITERATE({                                                 \
if (mpc->mpc_ops->mpo_socket_check_create != NULL) {                   \
MAC_CHECK_CALL(socket_check_create, mpc);                          \
int __step_err = mpc->mpc_ops->mpo_socket_check_create (args); \
MAC_CHECK_RSLT(socket_check_create, mpc);                          \
error = mac_error_select(__step_err, error);         \
}                                                            \
});                                                                  \
} while (0)
```
Â±ïÂºÄËæÖÂä©ÂÆèÂèØ‰ª•ÊòæÁ§∫ÂÖ∑‰ΩìÁöÑÊéßÂà∂ÊµÅÔºö
```c
do {                                                // MAC_CHECK
error = 0;
do {                                            // MAC_POLICY_ITERATE
struct mac_policy_conf *mpc;
u_int i;
for (i = 0; i < mac_policy_list.staticmax; i++) {
mpc = mac_policy_list.entries[i].mpc;
if (mpc == NULL) {
continue;
}
if (mpc->mpc_ops->mpo_socket_check_create != NULL) {
DTRACE_MACF3(mac__call__socket_check_create,
void *, mpc, int, error, int, MAC_ITERATE_CHECK); // MAC_CHECK_CALL
int __step_err = mpc->mpc_ops->mpo_socket_check_create(args);
DTRACE_MACF2(mac__rslt__socket_check_create,
void *, mpc, int, __step_err);                    // MAC_CHECK_RSLT
error = mac_error_select(__step_err, error);
}
}
if (mac_policy_list_conditional_busy() != 0) {
for (; i <= mac_policy_list.maxindex; i++) {
mpc = mac_policy_list.entries[i].mpc;
if (mpc == NULL) {
continue;
}
if (mpc->mpc_ops->mpo_socket_check_create != NULL) {
DTRACE_MACF3(mac__call__socket_check_create,
void *, mpc, int, error, int, MAC_ITERATE_CHECK);
int __step_err = mpc->mpc_ops->mpo_socket_check_create(args);
DTRACE_MACF2(mac__rslt__socket_check_create,
void *, mpc, int, __step_err);
error = mac_error_select(__step_err, error);
}
}
mac_policy_list_unbusy();
}
} while (0);
} while (0);
```
Êç¢Âè•ËØùËØ¥Ôºå`MAC_CHECK(socket_check_create, ...)` ÂÖàÈÅçÂéÜÈùôÊÄÅÁ≠ñÁï•ÔºåÊåâÊù°‰ª∂ÈîÅÂÆöÂπ∂Ëø≠‰ª£Âä®ÊÄÅÁ≠ñÁï•ÔºåÂú®ÊØè‰∏™ hook Âë®Âõ¥ÂèëÂá∫ DTrace Êé¢ÈíàÔºåÂπ∂ÈÄöËøá `mac_error_select()` Â∞ÜÊØè‰∏™ hook ÁöÑËøîÂõûÁ†ÅÂêàÂπ∂‰∏∫Âçï‰∏ÄÁöÑ `error` ÁªìÊûú„ÄÇ

### Ê†áÁ≠æ

MACF ‰ΩøÁî® **Ê†áÁ≠æ**ÔºåÁ≠ñÁï•Âú®Ê£ÄÊü•ÊòØÂê¶Â∫îÊéà‰∫àÊüê‰∫õËÆøÈóÆÊó∂‰ºö‰ΩøÁî®Ëøô‰∫õÊ†áÁ≠æ„ÄÇÊ†áÁ≠æÁªìÊûÑ‰ΩìÂ£∞ÊòéÁöÑ‰ª£Á†ÅÂèØ‰ª•Âú® [found here](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/_label.h)ÔºåÈöèÂêéÂú® **`struct ucred`** ÁöÑ [**here**](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/sys/ucred.h#L86) ‰∏≠ÁöÑ **`cr_label`** ÈÉ®ÂàÜ‰ΩøÁî®„ÄÇËØ•Ê†áÁ≠æÂåÖÂê´ flags ÂíåËã•Âπ≤ **ÊßΩ‰Ωç**ÔºåÂèØË¢´ **MACF Á≠ñÁï•Áî®‰∫éÂàÜÈÖçÊåáÈíà**„ÄÇ‰æãÂ¶Ç Sanbox ‰ºöÊåáÂêë container profile

## MACF Á≠ñÁï•

MACF Policy ÂÆö‰πâ‰∫ÜÂú®ÁâπÂÆöÂÜÖÊ†∏Êìç‰Ωú‰∏≠Â∫îÂ∫îÁî®ÁöÑËßÑÂàôÂíåÊù°‰ª∂„ÄÇ

‰∏Ä‰∏™ÂÜÖÊ†∏Êâ©Â±ïÂèØ‰ª•ÈÖçÁΩÆ‰∏Ä‰∏™ `mac_policy_conf` ÁªìÊûÑ‰ΩìÔºåÁÑ∂ÂêéË∞ÉÁî® `mac_policy_register` Ê≥®ÂÜåÂÆÉ„ÄÇÊëòËá™ [here](https://opensource.apple.com/source/xnu/xnu-2050.18.24/security/mac_policy.h.auto.html):
```c
#define mpc_t	struct mac_policy_conf *

/**
@brief Mac policy configuration

This structure specifies the configuration information for a
MAC policy module.  A policy module developer must supply
a short unique policy name, a more descriptive full name, a list of label
namespaces and count, a pointer to the registered enty point operations,
any load time flags, and optionally, a pointer to a label slot identifier.

The Framework will update the runtime flags (mpc_runtime_flags) to
indicate that the module has been registered.

If the label slot identifier (mpc_field_off) is NULL, the Framework
will not provide label storage for the policy.  Otherwise, the
Framework will store the label location (slot) in this field.

The mpc_list field is used by the Framework and should not be
modified by policies.
*/
/* XXX - reorder these for better aligment on 64bit platforms */
struct mac_policy_conf {
const char		*mpc_name;		/** policy name */
const char		*mpc_fullname;		/** full name */
const char		**mpc_labelnames;	/** managed label namespaces */
unsigned int		 mpc_labelname_count;	/** number of managed label namespaces */
struct mac_policy_ops	*mpc_ops;		/** operation vector */
int			 mpc_loadtime_flags;	/** load time flags */
int			*mpc_field_off;		/** label slot */
int			 mpc_runtime_flags;	/** run time flags */
mpc_t			 mpc_list;		/** List reference */
void			*mpc_data;		/** module data */
};
```
ÈÄöËøáÊ£ÄÊü•ÂØπ `mac_policy_register` ÁöÑË∞ÉÁî®ÔºåÂæàÂÆπÊòìËØÜÂà´Âá∫ÈÖçÁΩÆËøô‰∫õÁ≠ñÁï•ÁöÑÂÜÖÊ†∏Êâ©Â±ï„ÄÇ  
Ê≠§Â§ñÔºåÈÄöËøáÂèçÊ±áÁºñËØ•Êâ©Â±ï‰πüÂèØ‰ª•ÊâæÂà∞‰ΩøÁî®ÁöÑ `mac_policy_conf` ÁªìÊûÑ‰Ωì„ÄÇ

Ê≥®ÊÑè MACF Á≠ñÁï•‰πüÂèØ‰ª•**Âä®ÊÄÅ**Âú∞Ê≥®ÂÜåÂíåÊ≥®ÈîÄ„ÄÇ

Âú® `mac_policy_conf` ‰∏≠ÁöÑ‰∏ªË¶ÅÂ≠óÊÆµ‰πã‰∏ÄÊòØ **`mpc_ops`**„ÄÇËØ•Â≠óÊÆµÊåáÂÆö‰∫ÜÁ≠ñÁï•ÂÖ≥Ê≥®ÁöÑÊìç‰Ωú„ÄÇÊ≥®ÊÑèËøô‰∫õÊìç‰ΩúÊúâÊï∞Áôæ‰∏™ÔºåÂõ†Ê≠§ÂèØ‰ª•Â∞ÜÂÆÉ‰ª¨ÂÖ®ÈÉ®Ê∏ÖÈõ∂ÔºåÁÑ∂ÂêéÂè™ÈÄâÊã©Á≠ñÁï•ÊÑüÂÖ¥Ë∂£ÁöÑÈÇ£‰∫õ„ÄÇ From [here](https://opensource.apple.com/source/xnu/xnu-2050.18.24/security/mac_policy.h.auto.html):
```c
struct mac_policy_ops {
mpo_audit_check_postselect_t		*mpo_audit_check_postselect;
mpo_audit_check_preselect_t		*mpo_audit_check_preselect;
mpo_bpfdesc_label_associate_t		*mpo_bpfdesc_label_associate;
mpo_bpfdesc_label_destroy_t		*mpo_bpfdesc_label_destroy;
mpo_bpfdesc_label_init_t		*mpo_bpfdesc_label_init;
mpo_bpfdesc_check_receive_t		*mpo_bpfdesc_check_receive;
mpo_cred_check_label_update_execve_t	*mpo_cred_check_label_update_execve;
mpo_cred_check_label_update_t		*mpo_cred_check_label_update;
[...]
```
ÂΩìËøô‰∫õÊìç‰Ωú‰πã‰∏ÄË¢´Êã¶Êà™Êó∂ÔºåÂá†‰πéÊâÄÊúâÁöÑ hooks ÈÉΩ‰ºöË¢´ MACF ÂõûË∞É„ÄÇÁÑ∂ËÄåÔºå**`mpo_policy_*`** hooks ÊòØ‰∏™‰æãÂ§ñÔºåÂõ†‰∏∫ `mpo_hook_policy_init()` ÊòØÂú®Ê≥®ÂÜåÊó∂ÔºàÂç≥Âú® `mac_policy_register()` ‰πãÂêéÔºâË¢´Ë∞ÉÁî®ÁöÑÂõûË∞ÉÔºåËÄå `mpo_hook_policy_initbsd()` ÂàôÂú® BSD Â≠êÁ≥ªÁªüÊ≠£Á°ÆÂàùÂßãÂåñÂêéÁöÑÂêéÊúüÊ≥®ÂÜåÊúüÈó¥Ë¢´Ë∞ÉÁî®„ÄÇ

Ê≠§Â§ñÔºå**`mpo_policy_syscall`** hook ÂèØ‰ª•Ë¢´‰ªª‰Ωï kext Ê≥®ÂÜå‰ª•Êö¥Èú≤‰∏Ä‰∏™ÁßÅÊúâÁöÑ **ioctl** È£éÊ†ºË∞ÉÁî® **interface**„ÄÇÁÑ∂ÂêéÔºåÁî®Êà∑ client Â∞ÜËÉΩÂ§üË∞ÉÁî® `mac_syscall` (#381)ÔºåÂ∞Ü **policy name**„ÄÅ‰∏Ä‰∏™Êï¥Êï∞ **code** ‰ª•ÂèäÂèØÈÄâ **arguments** ‰Ωú‰∏∫ÂèÇÊï∞ÊåáÂÆö„ÄÇ\
‰æãÂ¶ÇÔºå**`Sandbox.kext`** ÁªèÂ∏∏ËøôÊ†∑‰ΩøÁî®„ÄÇ

Ê£ÄÊü• kext ÁöÑ **`__DATA.__const*`** ÂèØ‰ª•ËØÜÂà´Âú®Ê≥®ÂÜå policy Êó∂‰ΩøÁî®ÁöÑ `mac_policy_ops` ÁªìÊûÑ„ÄÇ‰πãÊâÄ‰ª•ËÉΩÊâæÂà∞ÂÆÉÔºåÊòØÂõ†‰∏∫ÂÆÉÁöÑÊåáÈíà‰Ωç‰∫é `mpo_policy_conf` ÂÜÖÁöÑÊüê‰∏™ÂÅèÁßªÂ§ÑÔºåÂπ∂‰∏îËØ•Âå∫Âüü‰ºöÂåÖÂê´‰∏ÄÂÆöÊï∞ÈáèÁöÑ NULL ÊåáÈíà„ÄÇ

Ê≠§Â§ñÔºå‰πüÂèØ‰ª•ÈÄöËøá‰ªéÂÜÖÂ≠ò‰∏≠ËΩ¨ÂÇ® struct **`_mac_policy_list`** Êù•Ëé∑ÂèñÈÖçÁΩÆ‰∫Ü policy ÁöÑ kext ÂàóË°®ÔºåËØ•ÁªìÊûÑ‰ºöÈöèÁùÄÊØè‰∏™Â∑≤Ê≥®ÂÜåÁöÑ policy ËÄåÊõ¥Êñ∞„ÄÇ

‰Ω†‰πüÂèØ‰ª•‰ΩøÁî®Â∑•ÂÖ∑ `xnoop` Êù•ËΩ¨ÂÇ®Á≥ªÁªü‰∏≠Ê≥®ÂÜåÁöÑÊâÄÊúâ policiesÔºö
```bash
xnoop offline .

XnüëÄp> macp
mac_policy_list(@0xfffffff0447159b8): 3 Mac Policies@0xfffffff0447153f0
0: 0xfffffff044886f18:
mpc_name: AppleImage4
mpc_fullName: AppleImage4 hooks
mpc_ops: mac_policy_ops@0xfffffff044886f68
1: 0xfffffff0448d7d40:
mpc_name: AMFI
mpc_fullName: Apple Mobile File Integrity
mpc_ops: mac_policy_ops@0xfffffff0448d72c8
2: 0xfffffff044b0b950:
mpc_name: Sandbox
mpc_fullName: Seatbelt sandbox policy
mpc_ops: mac_policy_ops@0xfffffff044b0b9b0
XnüëÄp> dump mac_policy_opns@0xfffffff0448d72c8
Type 'struct mac_policy_opns' is unrecognized - dumping as raw 64 bytes
Dumping 64 bytes from 0xfffffff0448d72c8
```
ÁÑ∂Âêé‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§ËΩ¨ÂÇ® check policy ÁöÑÊâÄÊúâÊ£ÄÊü•Ôºö
```bash
XnüëÄp> dump mac_policy_ops@0xfffffff044b0b9b0
Dumping 2696 bytes from 0xfffffff044b0b9b0 (as struct mac_policy_ops)

mpo_cred_check_label_update_execve(@0x30): 0xfffffff046d7fb54(PACed)
mpo_cred_check_label_update(@0x38): 0xfffffff046d7348c(PACed)
mpo_cred_label_associate(@0x58): 0xfffffff046d733f0(PACed)
mpo_cred_label_destroy(@0x68): 0xfffffff046d733e4(PACed)
mpo_cred_label_update_execve(@0x90): 0xfffffff046d7fb60(PACed)
mpo_cred_label_update(@0x98): 0xfffffff046d73370(PACed)
mpo_file_check_fcntl(@0xe8): 0xfffffff046d73164(PACed)
mpo_file_check_lock(@0x110): 0xfffffff046d7309c(PACed)
mpo_file_check_mmap(@0x120): 0xfffffff046d72fc4(PACed)
mpo_file_check_set(@0x130): 0xfffffff046d72f2c(PACed)
mpo_reserved08(@0x168): 0xfffffff046d72e3c(PACed)
mpo_reserved09(@0x170): 0xfffffff046d72e34(PACed)
mpo_necp_check_open(@0x1f0): 0xfffffff046d72d9c(PACed)
mpo_necp_check_client_action(@0x1f8): 0xfffffff046d72cf8(PACed)
mpo_vnode_notify_setextattr(@0x218): 0xfffffff046d72ca4(PACed)
mpo_vnode_notify_setflags(@0x220): 0xfffffff046d72c84(PACed)
mpo_proc_check_get_task_special_port(@0x250): 0xfffffff046d72b98(PACed)
mpo_proc_check_set_task_special_port(@0x258): 0xfffffff046d72ab4(PACed)
mpo_vnode_notify_unlink(@0x268): 0xfffffff046d72958(PACed)
mpo_vnode_check_copyfile(@0x290): 0xfffffff046d726c0(PACed)
mpo_mount_check_quotactl(@0x298): 0xfffffff046d725c4(PACed)
...
```
## XNU ‰∏≠ÁöÑ MACF ÂàùÂßãÂåñ

### Êó©ÊúüÂºïÂØºÂíå mac_policy_init()

- MACF ‰ºöÂæàÊó©Ë¢´ÂàùÂßãÂåñ„ÄÇÂú® `bootstrap_thread`ÔºàXNU ÂêØÂä®‰ª£Á†ÅÔºâ‰∏≠ÔºåÂú® `ipc_bootstrap` ‰πãÂêéÔºåXNU Ë∞ÉÁî® `mac_policy_init()`Ôºà‰Ωç‰∫é `mac_base.c`Ôºâ„ÄÇ
- `mac_policy_init()` ÂàùÂßãÂåñÂÖ®Â±Ä `mac_policy_list`Ôºà‰∏Ä‰∏™Á≠ñÁï•ÊßΩÁöÑÊï∞ÁªÑÊàñÂàóË°®ÔºâÔºåÂπ∂‰∏∫ XNU ÂÜÖÁöÑ MACÔºàMandatory Access ControlÔºåÂº∫Âà∂ËÆøÈóÆÊéßÂà∂ÔºâÊê≠Âª∫Âü∫Á°ÄËÆæÊñΩ„ÄÇ
- ÈöèÂêé‰ºöË∞ÉÁî® `mac_policy_initmach()`ÔºåË¥üË¥£ÂÜÖÊ†∏Á´ØÂØπÂÜÖÁΩÆÊàñÊçÜÁªëÁ≠ñÁï•ÁöÑÊ≥®ÂÜåÂ§ÑÁêÜ„ÄÇ

### `mac_policy_initmach()` ‰∏éÂä†ËΩΩ ‚ÄúÂÆâÂÖ®Êâ©Â±ï‚Äù

- `mac_policy_initmach()` ‰ºöÊ£ÄÊü•Â∑≤È¢ÑÂä†ËΩΩÁöÑÂÜÖÊ†∏Êâ©Â±ï (kexts)ÔºàÊàñÂú®‚Äúpolicy injection‚ÄùÂàóË°®‰∏≠ÁöÑ kextsÔºâÔºåÂπ∂Âú®ÂÖ∂ Info.plist ‰∏≠Êü•ÊâæÈîÆ `AppleSecurityExtension`„ÄÇ
- Âú® Info.plist ‰∏≠Â£∞Êòé `<key>AppleSecurityExtension</key>`ÔºàÊàñËÆæÁΩÆ‰∏∫ `true`ÔºâÁöÑ kexts Ë¢´ËßÜ‰∏∫‚ÄúÂÆâÂÖ®Êâ©Â±ï‚Äù‚Äî‚ÄîÂç≥ÂÆûÁé∞ MAC Á≠ñÁï•ÊàñÊåÇÊé•Âà∞ MACF Âü∫Á°ÄËÆæÊñΩÁöÑÊâ©Â±ï„ÄÇ
- Â∏¶ÊúâËØ•ÈîÆÁöÑ Apple kext Á§∫‰æãÂåÖÊã¨ **ALF.kext**„ÄÅ**AppleMobileFileIntegrity.kext (AMFI)**„ÄÅ**Sandbox.kext**„ÄÅ**Quarantine.kext**„ÄÅ**TMSafetyNet.kext**„ÄÅ**CoreTrust.kext**„ÄÅ**AppleSystemPolicy.kext** Á≠âÔºàÂ¶Ç‰Ω†Â∑≤ÂàóÂá∫Ôºâ„ÄÇ
- ÂÜÖÊ†∏Á°Æ‰øùËøô‰∫õ kexts ÊèêÂâçÂä†ËΩΩÔºåÁÑ∂ÂêéÂú®ÂºïÂØºÊúüÈó¥ÈÄöËøá `mac_policy_register` Ë∞ÉÁî®ÂÆÉ‰ª¨ÁöÑÊ≥®ÂÜå‰æãÁ®ãÔºåÂ∞ÜÂÆÉ‰ª¨ÊèíÂÖ• `mac_policy_list`„ÄÇ
- ÊØè‰∏™Á≠ñÁï•Ê®°ÂùóÔºàkextÔºâ‰ºöÊèê‰æõ‰∏Ä‰∏™ `mac_policy_conf` ÁªìÊûÑÔºåÂåÖÂê´Áî®‰∫éÂêÑÁßç MAC Êìç‰ΩúÁöÑÈí©Â≠êÔºà`mpc_ops`ÔºâÔºå‰æãÂ¶Ç vnode Ê£ÄÊü•„ÄÅexec Ê£ÄÊü•„ÄÅÊ†áÁ≠æÊõ¥Êñ∞Á≠â„ÄÇ
- Âä†ËΩΩÊó∂ÁöÑÊ†áÂøóÂèØËÉΩÂåÖÂê´ `MPC_LOADTIME_FLAG_NOTLATE`ÔºåË°®Á§∫‚ÄúÂøÖÈ°ªÊó©ÊúüÂä†ËΩΩ‚ÄùÔºàÂõ†Ê≠§ÊôöÊúüÊ≥®ÂÜåÂ∞ùËØï‰ºöË¢´ÊãíÁªùÔºâ„ÄÇ
- Ê≥®ÂÜåÂêéÔºåÊØè‰∏™Ê®°Âùó‰ºöËé∑Âæó‰∏Ä‰∏™Âè•ÊüÑÂπ∂Âç†ÊçÆ `mac_policy_list` ‰∏≠ÁöÑ‰∏Ä‰∏™ÊßΩ‰Ωç„ÄÇ
- ÂΩì‰ª•ÂêéËß¶ÂèëÊüê‰∏™ MAC Èí©Â≠êÔºà‰æãÂ¶Ç vnode ËÆøÈóÆ„ÄÅexec Á≠âÔºâÊó∂ÔºåMACF ‰ºöÈÅçÂéÜÊâÄÊúâÂ∑≤Ê≥®ÂÜåÁöÑÁ≠ñÁï•‰ª•ÂÅöÂá∫ÁªºÂêàÂÜ≥Á≠ñ„ÄÇ
- ÁâπÂà´ÊòØÔºå**AMFI**ÔºàApple Mobile File IntegrityÔºâÂ∞±ÊòØËøôÊ†∑‰∏Ä‰∏™ÂÆâÂÖ®Êâ©Â±ï„ÄÇÂÖ∂ Info.plist ÂåÖÂê´ `AppleSecurityExtension`ÔºåÂ∞ÜÂÖ∂Ê†áËÆ∞‰∏∫ÂÆâÂÖ®Á≠ñÁï•„ÄÇ
- ‰Ωú‰∏∫ÂÜÖÊ†∏ÂºïÂØºÁöÑ‰∏ÄÈÉ®ÂàÜÔºåÂÜÖÊ†∏ÁöÑÂä†ËΩΩÈÄªËæë‰ºöÁ°Æ‰øùÂú®ËÆ∏Â§öÂ≠êÁ≥ªÁªü‰æùËµñÂÆÉ‰πãÂâçÔºå‚ÄúÂÆâÂÖ®Á≠ñÁï•‚ÄùÔºàÂ¶Ç AMFI Á≠âÔºâÂ∑≤ÁªèÂ§Ñ‰∫éÊ¥ªÂä®Áä∂ÊÄÅ„ÄÇ‰æãÂ¶ÇÔºåÂÜÖÊ†∏‰ºö‚ÄúÈÄöËøáÂä†ËΩΩ‚Ä¶‚Ä¶ÂÆâÂÖ®Á≠ñÁï•Êù•‰∏∫Âç≥Â∞ÜÂà∞Êù•ÁöÑ‰ªªÂä°ÂÅöÂáÜÂ§áÔºåÂåÖÊã¨ AppleMobileFileIntegrity (AMFI)„ÄÅSandbox„ÄÅQuarantine Á≠ñÁï•„ÄÇ‚Äù
```bash
cd /System/Library/Extensions
find . -name Info.plist | xargs grep AppleSecurityExtension 2>/dev/null

./AppleImage4.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
./ALF.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
./CoreTrust.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
./AppleMobileFileIntegrity.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
./Quarantine.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
./Sandbox.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
./AppleSystemPolicy.kext/Contents/Info.plist:	<key>AppleSecurityExtension</key>
```
## KPI ‰æùËµñ & com.apple.kpi.dsep Âú® MAC policy kexts ‰∏≠

ÂΩìÁºñÂÜô‰ΩøÁî® MAC Ê°ÜÊû∂ÁöÑ kextÔºà‰æãÂ¶ÇË∞ÉÁî® `mac_policy_register()` Á≠âÔºâÊó∂ÔºåÂøÖÈ°ªÂ£∞ÊòéÂØπ KPIsÔºàKernel Programming InterfacesÔºâÁöÑ‰æùËµñÔºå‰ª•‰æø kext ÈìæÊé•Âô® (kxld) ËÉΩËß£ÊûêËøô‰∫õÁ¨¶Âè∑„ÄÇÂõ†Ê≠§ÔºåË¶ÅÂ£∞Êòé‰∏Ä‰∏™ `kext` ‰æùËµñ‰∫é MACFÔºå‰Ω†ÈúÄË¶ÅÂú® `Info.plist` ‰∏≠Áî® `com.apple.kpi.dsep` Êù•ÊåáÊòéÔºà`find . Info.plist | grep AppleSecurityExtension`ÔºâÔºåÁÑ∂ÂêéËØ• kext ‰ºöÂºïÁî®ËØ∏Â¶Ç `mac_policy_register`„ÄÅ`mac_policy_unregister` ‰ª•Âèä MAC Èí©Â≠êÂáΩÊï∞ÊåáÈíàÁ≠âÁ¨¶Âè∑„ÄÇË¶ÅËß£ÊûêËøô‰∫õÁ¨¶Âè∑ÔºåÂøÖÈ°ªÂ∞Ü `com.apple.kpi.dsep` Âàó‰∏∫‰æùËµñÈ°π„ÄÇ

Example Info.plist snippet (inside your .kext):
```xml
<key>OSBundleLibraries</key>
<dict>
<key>com.apple.kpi.dsep</key>
<string>18.0</string>
<key>com.apple.kpi.libkern</key>
<string>18.0</string>
<key>com.apple.kpi.bsd</key>
<string>18.0</string>
<key>com.apple.kpi.mach</key>
<string>18.0</string>
‚Ä¶ (other kpi dependencies as needed)
</dict>
```
## MACF Ë∞ÉÁî®ÁÇπ

ÈÄöÂ∏∏‰ºöÂú®‰ª£Á†Å‰∏≠ÁúãÂà∞ÂØπ MACF ÁöÑË∞ÉÁî®ÔºåÂÆÉ‰ª¨ÂÆö‰πâÂú®Á±ª‰ºº **`#if CONFIG_MAC`** ÁöÑÊù°‰ª∂Âùó‰∏≠„ÄÇÊ≠§Â§ñÔºåÂú®Ëøô‰∫õÂùóÂÜÖÂèØËÉΩ‰ºöÂèëÁé∞ÂØπ `mac_proc_check*` ÁöÑË∞ÉÁî®ÔºåËØ•Ë∞ÉÁî®‰ºöËÆ© MACF **Ê£ÄÊü•ÊùÉÈôê** ‰ª•ÊâßË°åÊüê‰∫õÊìç‰Ωú„ÄÇÊ≠§Â§ñÔºåMACF Ë∞ÉÁî®ÁöÑÊ†ºÂºèÊòØÔºö**`mac_<object>_<opType>_opName`**„ÄÇ

ÂØπË±°ÂèØ‰ª•ÊòØ‰∏ãÂàó‰πã‰∏ÄÔºö`bpfdesc`, `cred`, `file`, `proc`, `vnode`, `mount`, `devfs`, `ifnet`, `inpcb`, `mbuf`, `ipq`, `pipe`, `sysv[msg/msq/shm/sem]`, `posix[shm/sem]`, `socket`, `kext`„ÄÇ  
`opType` ÈÄöÂ∏∏‰∏∫ checkÔºåÁî®‰∫éÂÖÅËÆ∏ÊàñÊãíÁªùËØ•Êìç‰Ωú„ÄÇ‰ΩÜ‰πüÂèØËÉΩÊòØ `notify`ÔºåËøô‰ºöÂÖÅËÆ∏ kext ÂØπËØ•Êìç‰Ωú‰ΩúÂá∫ÂèçÂ∫î„ÄÇ

‰Ω†ÂèØ‰ª•Âú® [https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/kern/kern_mman.c#L621](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/kern/kern_mman.c#L621) ÊâæÂà∞‰∏Ä‰∏™Á§∫‰æãÔºö

<pre class="language-c"><code class="lang-c">int
mmap(proc_t p, struct mmap_args *uap, user_addr_t *retval)
{
[...]
#if CONFIG_MACF
<strong>			error = mac_file_check_mmap(vfs_context_ucred(ctx),
</strong>			    fp->fp_glob, prot, flags, file_pos + pageoff,
&maxprot);
if (error) {
(void)vnode_put(vp);
goto bad;
}
#endif /* MAC */
[...]
</code></pre>

ÁÑ∂ÂêéÔºåÂèØ‰ª•Âú® [https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_file.c#L174](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_file.c#L174) ÊâæÂà∞ `mac_file_check_mmap` ÁöÑÂÆûÁé∞‰ª£Á†Å„ÄÇ
```c
mac_file_check_mmap(struct ucred *cred, struct fileglob *fg, int prot,
int flags, uint64_t offset, int *maxprot)
{
int error;
int maxp;

maxp = *maxprot;
MAC_CHECK(file_check_mmap, cred, fg, NULL, prot, flags, offset, &maxp);
if ((maxp | *maxprot) != *maxprot) {
panic("file_check_mmap increased max protections");
}
*maxprot = maxp;
return error;
}
```
ÂÆÉË∞ÉÁî®‰∫Ü `MAC_CHECK` ÂÆèÔºåÂÖ∂‰ª£Á†ÅÂèØ‰ª•Âú® [https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_internal.h#L261](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_internal.h#L261) ÊâæÂà∞
```c
/*
* MAC_CHECK performs the designated check by walking the policy
* module list and checking with each as to how it feels about the
* request.  Note that it returns its value via 'error' in the scope
* of the caller.
*/
#define MAC_CHECK(check, args...) do {                              \
error = 0;                                                      \
MAC_POLICY_ITERATE({                                            \
if (mpc->mpc_ops->mpo_ ## check != NULL) {              \
DTRACE_MACF3(mac__call__ ## check, void *, mpc, int, error, int, MAC_ITERATE_CHECK); \
int __step_err = mpc->mpc_ops->mpo_ ## check (args); \
DTRACE_MACF2(mac__rslt__ ## check, void *, mpc, int, __step_err); \
error = mac_error_select(__step_err, error);         \
}                                                           \
});                                                             \
} while (0)
```
Ëøô‰ºöÈÅçÂéÜÊâÄÊúâÂ∑≤Ê≥®ÂÜåÁöÑ mac Á≠ñÁï•ÔºåË∞ÉÁî®ÂÆÉ‰ª¨ÁöÑÂáΩÊï∞Âπ∂Â∞ÜËæìÂá∫Â≠òÂÇ®Âú® error ÂèòÈáè‰∏≠ÔºåÂè™ÊúâÈÄöËøá `mac_error_select` ÁöÑÊàêÂäü‰ª£Á†ÅÊâçËÉΩË¶ÜÁõñËØ•ÂèòÈáèÔºåÂõ†Ê≠§Â¶ÇÊûú‰ªª‰ΩïÊ£ÄÊü•Â§±Ë¥•ÔºåÊï¥‰∏™Ê£ÄÊü•Â∞ÜÂ§±Ë¥•ÔºåÊìç‰ΩúÂ∞Ü‰∏çË¢´ÂÖÅËÆ∏„ÄÇ

> [!TIP]
> ‰ΩÜÊòØÔºåËØ∑ËÆ∞‰ΩèÔºåÂπ∂ÈùûÊâÄÊúâ MACF Ë∞ÉÁî®ÁÇπÈÉΩ‰ªÖÁî®‰∫éÊãíÁªùÊìç‰Ωú„ÄÇ‰æãÂ¶ÇÔºå`mac_priv_grant` Ë∞ÉÁî®‰∫ÜÂÆè [**MAC_GRANT**](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac_internal.h#L274)ÔºåÂ¶ÇÊûúÊúâ‰ªª‰ΩïÁ≠ñÁï•ËøîÂõû 0ÔºåÂÆÉÂ∞ÜÊéà‰∫àËØ∑Ê±ÇÁöÑÁâπÊùÉÔºö
>
> ```c
> /*
> * MAC_GRANT performs the designated check by walking the policy
> * module list and checking with each as to how it feels about the
> * request.  Unlike MAC_CHECK, it grants if any policies return '0',
> * and otherwise returns EPERM.  Note that it returns its value via
> * 'error' in the scope of the caller.
> */
> #define MAC_GRANT(check, args...) do {                              \
>    error = EPERM;                                                  \
>    MAC_POLICY_ITERATE({                                            \
> 	if (mpc->mpc_ops->mpo_ ## check != NULL) {                  \
> 	        DTRACE_MACF3(mac__call__ ## check, void *, mpc, int, error, int, MAC_ITERATE_GRANT); \
> 	        int __step_res = mpc->mpc_ops->mpo_ ## check (args); \
> 	        if (__step_res == 0) {                              \
> 	                error = 0;                                  \
> 	        }                                                   \
> 	        DTRACE_MACF2(mac__rslt__ ## check, void *, mpc, int, __step_res); \
> 	    }                                                           \
>    });                                                             \
> } while (0)
> ```

### priv_check & priv_grant

Ëøô‰∫õË∞ÉÁî®Áî®‰∫éÊ£ÄÊü•Âπ∂Êèê‰æõÔºàÂá†ÂçÅ‰∏™Ôºâ**ÁâπÊùÉ**ÔºåÂÆö‰πâÂú® [**bsd/sys/priv.h**](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/sys/priv.h)„ÄÇ\
Êüê‰∫õÂÜÖÊ†∏‰ª£Á†Å‰ºö‰ªé [**bsd/kern/kern_priv.c**](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/kern/kern_priv.c) Ë∞ÉÁî® `priv_check_cred()`Ôºå‰ΩøÁî®ËøõÁ®ãÁöÑ KAuth Âá≠ËØÅ Âíå Êüê‰∏™ÁâπÊùÉ‰ª£Á†ÅÔºå`priv_check_cred()` ‰ºöË∞ÉÁî® `mac_priv_check` Êù•Êü•ÁúãÊòØÂê¶ÊúâÁ≠ñÁï•**ÊãíÁªù**Êéà‰∫àËØ•ÁâπÊùÉÔºåÁÑ∂ÂêéÂÆÉ‰ºöË∞ÉÁî® `mac_priv_grant` Êù•Êü•ÁúãÊòØÂê¶ÊúâÁ≠ñÁï•Êéà‰∫àËØ• `privilege`„ÄÇ

### proc_check_syscall_unix

ËØ• hook ÂÖÅËÆ∏Êã¶Êà™ÊâÄÊúâÁ≥ªÁªüË∞ÉÁî®„ÄÇÂú® `bsd/dev/[i386|arm]/systemcalls.c` ‰∏≠ÂèØ‰ª•ÁúãÂà∞Â£∞ÊòéÁöÑÂáΩÊï∞ [`unix_syscall`](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/bsd/dev/arm/systemcalls.c#L160C1-L167C25)ÔºåÂÖ∂‰∏≠ÂåÖÂê´‰ª•‰∏ã‰ª£Á†ÅÔºö
```c
#if CONFIG_MACF
if (__improbable(proc_syscall_filter_mask(proc) != NULL && !bitstr_test(proc_syscall_filter_mask(proc), syscode))) {
error = mac_proc_check_syscall_unix(proc, syscode);
if (error) {
goto skip_syscall;
}
}
#endif /* CONFIG_MACF */
```
ËØ•ÂáΩÊï∞‰ºöÂú®Ë∞ÉÁî®ËøõÁ®ãÁöÑ **bitmask** ‰∏≠Ê£ÄÊü•ÂΩìÂâç syscall ÊòØÂê¶Â∫îË∞ÉÁî® `mac_proc_check_syscall_unix`„ÄÇËøôÊòØÂõ†‰∏∫ syscalls Ë¢´Ë∞ÉÁî®ÁöÑÈ¢ëÁéáÂæàÈ´òÔºåÂõ†Ê≠§ÊúâÂøÖË¶ÅÈÅøÂÖçÊØèÊ¨°ÈÉΩË∞ÉÁî® `mac_proc_check_syscall_unix`„ÄÇ

Ê≥®ÊÑèÔºåÂáΩÊï∞ `proc_set_syscall_filter_mask()`ÔºàÁî®‰∫éÂú®ËøõÁ®ã‰∏≠ËÆæÁΩÆ bitmask syscallsÔºâÁî± Sandbox Ë∞ÉÁî®Ôºå‰ª•Âú®ÂèóÊ≤ôÁÆ±ÈôêÂà∂ÁöÑËøõÁ®ã‰∏äËÆæÁΩÆÊé©Á†Å„ÄÇ

## Êö¥Èú≤ÁöÑ MACF syscalls

ÂèØ‰ª•ÈÄöËøá‰∏Ä‰∫õÂú® [security/mac.h](https://github.com/apple-oss-distributions/xnu/blob/94d3b452840153a99b38a3a9659680b2a006908e/security/mac.h#L151) ‰∏≠ÂÆö‰πâÁöÑ syscalls ‰∏é MACF ËøõË°å‰∫§‰∫íÔºö
```c
/*
* Extended non-POSIX.1e interfaces that offer additional services
* available from the userland and kernel MAC frameworks.
*/
#ifdef __APPLE_API_PRIVATE
__BEGIN_DECLS
int      __mac_execve(char *fname, char **argv, char **envv, mac_t _label);
int      __mac_get_fd(int _fd, mac_t _label);
int      __mac_get_file(const char *_path, mac_t _label);
int      __mac_get_link(const char *_path, mac_t _label);
int      __mac_get_pid(pid_t _pid, mac_t _label);
int      __mac_get_proc(mac_t _label);
int      __mac_set_fd(int _fildes, const mac_t _label);
int      __mac_set_file(const char *_path, mac_t _label);
int      __mac_set_link(const char *_path, mac_t _label);
int      __mac_mount(const char *type, const char *path, int flags, void *data,
struct mac *label);
int      __mac_get_mount(const char *path, struct mac *label);
int      __mac_set_proc(const mac_t _label);
int      __mac_syscall(const char *_policyname, int _call, void *_arg);
__END_DECLS
#endif /*__APPLE_API_PRIVATE*/
```
## ÂèÇËÄÉËµÑÊñô

- [**\*OS Internals Volume III**](https://newosxbook.com/home.html)


{{#include ../../../banners/hacktricks-training.md}}
