# macOS Office Sandbox Bypasses

{{#include ../../../../../banners/hacktricks-training.md}}

### Обхід пісочниці Word через Launch Agents

Застосунок використовує **кастомну пісочницю** з правом **`com.apple.security.temporary-exception.sbpl`**, і ця кастомна пісочниця дозволяє записувати файли будь-де, якщо ім'я файлу починається з `~$`: `(require-any (require-all (vnode-type REGULAR-FILE) (regex #"(^|/)~$[^/]+$")))`

Отже, втеча була такою ж легкою, як **створення `plist`** LaunchAgent у `~/Library/LaunchAgents/~$escape.plist`.

Перевірте [**оригінальний звіт тут**](https://www.mdsec.co.uk/2018/08/escaping-the-sandbox-microsoft-office-on-macos/).

### Обхід пісочниці Word через Login Items і zip

Пам'ятайте, що з першої втечі Word може записувати довільні файли, ім'я яких починається з `~$`, хоча після виправлення попередньої уразливості не було можливості записувати в `/Library/Application Scripts` або в `/Library/LaunchAgents`.

Було виявлено, що зсередини пісочниці можливо створити **Login Item** (додатки, які виконуються під час входу користувача). Однак ці додатки **не виконуватимуться, якщо** вони **не сертифіковані** і **неможливо додати аргументи** (тому ви не можете просто запустити зворотний шелл, використовуючи **`bash`**).

З попереднього обходу пісочниці Microsoft вимкнув можливість записувати файли в `~/Library/LaunchAgents`. Однак було виявлено, що якщо ви помістите **zip-файл як Login Item**, `Archive Utility` просто **розпакує** його в його поточному місці. Тому, оскільки за замовчуванням папка `LaunchAgents` з `~/Library` не створюється, було можливо **запакувати plist у `LaunchAgents/~$escape.plist`** і **помістити** zip-файл у **`~/Library`**, щоб при розпакуванні він досягнув місця збереження.

Перевірте [**оригінальний звіт тут**](https://objective-see.org/blog/blog_0x4B.html).

### Обхід пісочниці Word через Login Items і .zshenv

(Пам'ятайте, що з першої втечі Word може записувати довільні файли, ім'я яких починається з `~$`).

Однак у попередньої техніки була обмеження: якщо папка **`~/Library/LaunchAgents`** існує, тому що інше програмне забезпечення її створило, це призведе до збою. Тому для цього було виявлено інший ланцюг Login Items.

Зловмисник міг створити файли **`.bash_profile`** і **`.zshenv`** з корисним навантаженням для виконання, а потім запакувати їх і **записати zip у папку користувача жертви**: **`~/~$escape.zip`**.

Потім додайте zip-файл до **Login Items** і потім до програми **`Terminal`**. Коли користувач повторно входить, zip-файл буде розпакований у файлі користувача, перезаписуючи **`.bash_profile`** і **`.zshenv`**, і, отже, термінал виконає один з цих файлів (в залежності від того, чи використовується bash або zsh).

Перевірте [**оригінальний звіт тут**](https://desi-jarvis.medium.com/office365-macos-sandbox-escape-fcce4fa4123c).

### Обхід пісочниці Word з Open і змінними середовища

З пісочниць все ще можливо викликати інші процеси, використовуючи утиліту **`open`**. Більше того, ці процеси будуть виконуватися **в межах своєї власної пісочниці**.

Було виявлено, що утиліта open має опцію **`--env`** для запуску програми з **конкретними змінними середовища**. Отже, було можливо створити **файл `.zshenv`** у папці **всередині** **пісочниці** і використовувати `open` з `--env`, встановлюючи **змінну `HOME`** на цю папку, відкриваючи цю програму `Terminal`, яка виконає файл `.zshenv` (з якоїсь причини також було потрібно встановити змінну `__OSINSTALL_ENVIROMENT`).

Перевірте [**оригінальний звіт тут**](https://perception-point.io/blog/technical-analysis-of-cve-2021-30864/).

### Обхід пісочниці Word з Open і stdin

Утиліта **`open`** також підтримувала параметр **`--stdin`** (і після попереднього обходу більше не було можливості використовувати `--env`).

Суть у тому, що навіть якщо **`python`** був підписаний Apple, він **не виконає** скрипт з атрибутом **`quarantine`**. Однак було можливо передати йому скрипт з stdin, тому він не перевірить, чи був він під карантином чи ні:&#x20;

1. Скиньте файл **`~$exploit.py`** з довільними командами Python.
2. Запустіть _open_ **`–stdin='~$exploit.py' -a Python`**, що запускає програму Python з нашим скинутим файлом, який служить її стандартним введенням. Python із задоволенням виконує наш код, і оскільки це дочірній процес _launchd_, він не підпорядковується правилам пісочниці Word.

{{#include ../../../../../banners/hacktricks-training.md}}
