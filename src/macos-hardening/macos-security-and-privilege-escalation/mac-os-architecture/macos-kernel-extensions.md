# macOS Kernel Extensions & Debugging

{{#include ../../../banners/hacktricks-training.md}}

## Basic Information

Kernel extensions (Kexts) **рдкреИрдХреЗрдЬ** рд╣реИрдВ рдЬрд┐рдирдХрд╛ **`.kext`** рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╣реЛрддрд╛ рд╣реИ рдЬреЛ **macOS рдХрд░реНрдиреЗрд▓ рд╕реНрдкреЗрд╕ рдореЗрдВ рд╕реАрдзреЗ рд▓реЛрдб** рд╣реЛрддреЗ рд╣реИрдВ, рдореБрдЦреНрдп рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред

### Deprecation status & DriverKit / System Extensions
**macOS Catalina (10.15)** рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░ Apple рдиреЗ рдЕрдзрд┐рдХрд╛рдВрд╢ рдкреБрд░рд╛рдиреЗ KPI рдХреЛ *deprecated* рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдФрд░ **System Extensions & DriverKit** рдврд╛рдВрдЪреЗ рдХреЛ рдкреЗрд╢ рдХрд┐рдпрд╛ рдЬреЛ **рдпреВрдЬрд░-рд╕реНрдкреЗрд╕** рдореЗрдВ рдЪрд▓рддреЗ рд╣реИрдВред **macOS Big Sur (11)** рд╕реЗ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо *рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ kexts рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рд╕реЗ рдЗрдирдХрд╛рд░ рдХрд░реЗрдЧрд╛* рдЬреЛ deprecated KPI рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реИрдВ рдЬрдм рддрдХ рдХрд┐ рдорд╢реАрди **Reduced Security** рдореЛрдб рдореЗрдВ рдмреВрдЯ рди рд╣реЛред Apple Silicon рдкрд░, kexts рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЕрддрд┐рд░рд┐рдХреНрдд рд░реВрдк рд╕реЗ:

1. **Recovery** рдореЗрдВ рдкреБрдирдГ рдмреВрдЯ рдХрд░реЗрдВ тЖТ *Startup Security Utility*ред
2. **Reduced Security** рдХрд╛ рдЪрдпрди рдХрд░реЗрдВ рдФрд░ **тАЬAllow user management of kernel extensions from identified developersтАЭ** рдХреЛ рдЯрд┐рдХ рдХрд░реЗрдВред
3. рдкреБрдирдГ рдмреВрдЯ рдХрд░реЗрдВ рдФрд░ **System Settings тЖТ Privacy & Security** рд╕реЗ kext рдХреЛ рд╕реНрд╡реАрдХреГрдд рдХрд░реЗрдВред

DriverKit/System Extensions рдХреЗ рд╕рд╛рде рд▓рд┐рдЦреЗ рдЧрдП рдпреВрдЬрд░-рд▓реИрдВрдб рдбреНрд░рд╛рдЗрд╡рд░ **рд╣рдорд▓реЗ рдХреА рд╕рддрд╣ рдХреЛ рдХрд╛рдлреА рдХрдо** рдХрд░рддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдХреНрд░реИрд╢ рдпрд╛ рдореЗрдореЛрд░реА рднреНрд░рд╖реНрдЯрд╛рдЪрд╛рд░ рдПрдХ рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рддрдХ рд╕реАрдорд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рди рдХрд┐ рдХрд░реНрдиреЗрд▓ рд╕реНрдкреЗрд╕ рддрдХред

> ЁЯУЭ macOS Sequoia (15) рд╕реЗ Apple рдиреЗ рдХрдИ рдкреБрд░рд╛рдиреЗ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ рдФрд░ USB KPI рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рд╣реИ - рд╡рд┐рдХреНрд░реЗрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдПрдХрдорд╛рддреНрд░ рдЖрдЧреЗ-рд╕рдВрдЧрдд рд╕рдорд╛рдзрд╛рди System Extensions рдореЗрдВ рдорд╛рдЗрдЧреНрд░реЗрдЯ рдХрд░рдирд╛ рд╣реИред

### Requirements

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ, рдпрд╣ рдЗрддрдирд╛ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рд╣реИ рдХрд┐ **рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдирд╛ рдЬрдЯрд┐рд▓ рд╣реИ**ред рдпреЗ **рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ** рд╣реИрдВ рдЬреЛ рдПрдХ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реА рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП:

- рдЬрдм **рд░рд┐рдХрд╡рд░реА рдореЛрдб рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░рддреЗ рд╣реИрдВ**, рдХрд░реНрдиреЗрд▓ **рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП**:

<figure><img src="../../../images/image (327).png" alt=""><figcaption></figcaption></figure>

- рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ **рдХрд░реНрдиреЗрд▓ рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдХреЗ рд╕рд╛рде **рд╕рд╛рдЗрди** рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬреЛ рдХреЗрд╡рд▓ **Apple рджреНрд╡рд╛рд░рд╛** рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЬреЛ рдХрдВрдкрдиреА рдФрд░ рдЗрд╕рдХреЗ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдгреЛрдВ рдХреА рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╕рдореАрдХреНрд╖рд╛ рдХрд░реЗрдЧрд╛ред
- рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ **рдиреЛрдЯрд░рд╛рдЗрдЬ** рднреА рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, Apple рдЗрд╕реЗ рдореИрд▓рд╡реЗрдпрд░ рдХреЗ рд▓рд┐рдП рдЬрд╛рдВрдЪ рд╕рдХреЗрдЧрд╛ред
- рдлрд┐рд░, **root** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реА **рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рд▓реЛрдб** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдкреИрдХреЗрдЬ рдХреЗ рдЕрдВрджрд░ рдХреА рдлрд╝рд╛рдЗрд▓реЗрдВ **root** рдХреА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред
- рдЕрдкрд▓реЛрдб рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди, рдкреИрдХреЗрдЬ рдХреЛ **рд╕рдВрд░рдХреНрд╖рд┐рдд рдиреЙрди-рд░реВрдЯ рд╕реНрдерд╛рди** рдореЗрдВ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП: `/Library/StagedExtensions` (рдЗрд╕рдХреЗ рд▓рд┐рдП `com.apple.rootless.storage.KernelExtensionManagement` рдЧреНрд░рд╛рдВрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ)ред
- рдЕрдВрдд рдореЗрдВ, рдЬрдм рдЗрд╕реЗ рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ [**рдПрдХ рдкреБрд╖реНрдЯрд┐ рдЕрдиреБрд░реЛрдз рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛**](https://developer.apple.com/library/archive/technotes/tn2459/_index.html) рдФрд░, рдпрджрд┐ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛, рддреЛ рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рдЗрд╕реЗ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн** рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

### Loading process

Catalina рдореЗрдВ рдпрд╣ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдерд╛: рдпрд╣ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ **рд╕рддреНрдпрд╛рдкрди** рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдпреВрдЬрд░рд▓реИрдВрдб** рдореЗрдВ рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдХреЗрд╡рд▓ **`com.apple.private.security.kext-management`** рдЧреНрд░рд╛рдВрдЯ рд╡рд╛рд▓реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реА **рдХрд░реНрдиреЗрд▓ рд╕реЗ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**: `kextcache`, `kextload`, `kextutil`, `kextd`, `syspolicyd`

1. **`kextutil`** cli **рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рддреНрдпрд╛рдкрди** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ
- рдпрд╣ **`kextd`** рд╕реЗ **Mach рд╕реЗрд╡рд╛** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╛рдд рдХрд░реЗрдЧрд╛ред
2. **`kextd`** рдХрдИ рдЪреАрдЬреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛, рдЬреИрд╕реЗ **рд╣рд╕реНрддрд╛рдХреНрд╖рд░**
- рдпрд╣ **`syspolicyd`** рд╕реЗ рдмрд╛рдд рдХрд░реЗрдЧрд╛ рддрд╛рдХрд┐ рдпрд╣ **рдЬрд╛рдВрдЪ рд╕рдХреЗ** рдХрд┐ рдХреНрдпрд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ **рд▓реЛрдб** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
3. **`syspolicyd`** **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рд╕реЗ **рдкреНрд░реЙрдореНрдкреНрдЯ** рдХрд░реЗрдЧрд╛ рдпрджрд┐ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдкрд╣рд▓реЗ рд▓реЛрдб рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
- **`syspolicyd`** рдкрд░рд┐рдгрд╛рдо рдХреЛ **`kextd`** рдХреЛ рд░рд┐рдкреЛрд░реНрдЯ рдХрд░реЗрдЧрд╛
4. рдЕрдВрддрддрдГ **`kextd`** рдХрд░реНрдиреЗрд▓ рдХреЛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдмрддрд╛рдиреЗ** рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛

рдпрджрд┐ **`kextd`** рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ, рддреЛ **`kextutil`** рд╡рд╣реА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### Enumeration & management (loaded kexts)

`kextstat` рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рдЙрдкрдХрд░рдг рдерд╛ рд▓реЗрдХрд┐рди рдпрд╣ рд╣рд╛рд▓ рдХреЗ macOS рд░рд┐рд▓реАрдЬрд╝ рдореЗрдВ **deprecated** рд╣реИред рдЖрдзреБрдирд┐рдХ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ **`kmutil`** рд╣реИ:
```bash
# List every extension currently linked in the kernel, sorted by load address
sudo kmutil showloaded --sort

# Show only third-party / auxiliary collections
sudo kmutil showloaded --collection aux

# Unload a specific bundle
sudo kmutil unload -b com.example.mykext
```
рдкреБрд░рд╛рдиреА рд╕рд┐рдВрдЯреИрдХреНрд╕ рдЕрднреА рднреА рд╕рдВрджрд░реНрдн рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рд╣реИ:
```bash
# (Deprecated) Get loaded kernel extensions
kextstat

# (Deprecated) Get dependencies of the kext number 22
kextstat | grep " 22 " | cut -c2-5,50- | cut -d '(' -f1
```
`kmutil inspect` рдХрд╛ рдЙрдкрдпреЛрдЧ **Kernel Collection (KC)** рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ **dump** рдХрд░рдиреЗ рдпрд╛ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдПрдХ kext рд╕рднреА рдкреНрд░рддреАрдХ рдирд┐рд░реНрднрд░рддрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ:
```bash
# List fileset entries contained in the boot KC
kmutil inspect -B /System/Library/KernelCollections/BootKernelExtensions.kc --show-fileset-entries

# Check undefined symbols of a 3rd party kext before loading
kmutil libraries -p /Library/Extensions/FancyUSB.kext --undef-symbols
```
## Kernelcache

> [!CAUTION]
> рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди `/System/Library/Extensions/` рдореЗрдВ рд╣реЛрдиреЗ рдХреА рдЙрдореНрдореАрдж рд╣реИ, рдпрджрд┐ рдЖрдк рдЗрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдЬрд╛рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ **рдХреЛрдИ рдмрд╛рдЗрдирд░реА рдирд╣реАрдВ рдорд┐рд▓реЗрдЧреА**ред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг **рдХрд░реНрдиреЗрд▓рдХреИрд╢** рд╣реИ рдФрд░ рдПрдХ `.kext` рдХреЛ рд░рд┐рд╡рд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдЦреЛрдЬрдирд╛ рд╣реЛрдЧрд╛ред

**рдХрд░реНрдиреЗрд▓рдХреИрд╢** **XNU рдХрд░реНрдиреЗрд▓** рдХрд╛ рдПрдХ **рдкреВрд░реНрд╡-рд╕рдВрдХрд▓рд┐рдд рдФрд░ рдкреВрд░реНрд╡-рд▓рд┐рдВрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╕рдВрд╕реНрдХрд░рдг** рд╣реИ, рд╕рд╛рде рд╣реА рдЖрд╡рд╢реНрдпрдХ рдбрд┐рд╡рд╛рдЗрд╕ **рдбреНрд░рд╛рдЗрд╡рд░** рдФрд░ **рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рднреАред рдЗрд╕реЗ **рд╕рдВрдХреБрдЪрд┐рдд** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдмреВрдЯ-рдЕрдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди рдореЗрдореЛрд░реА рдореЗрдВ рдЕрдирд╕рдВрдХреБрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдХрд░реНрдиреЗрд▓рдХреИрд╢ рдПрдХ **рддреЗрдЬрд╝ рдмреВрдЯ рд╕рдордп** рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдХрд░реНрдиреЗрд▓ рдФрд░ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ рдХрд╛ рдПрдХ рддреИрдпрд╛рд░-рд╕реЗ-рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓рд╛ рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрд▓рдмреНрдз рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдмреВрдЯ рд╕рдордп рдкрд░ рдЗрди рдШрдЯрдХреЛрдВ рдХреЛ рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗ рд▓реЛрдб рдФрд░ рд▓рд┐рдВрдХ рдХрд░рдиреЗ рдореЗрдВ рд▓рдЧрдиреЗ рд╡рд╛рд▓реЗ рд╕рдордп рдФрд░ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рдмрдЪрдд рд╣реЛрддреА рд╣реИред

### Local Kerlnelcache

iOS рдореЗрдВ рдпрд╣ **`/System/Library/Caches/com.apple.kernelcaches/kernelcache`** рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ, macOS рдореЗрдВ рдЖрдк рдЗрд╕реЗ рдЗрд╕ рдХрдорд╛рдВрдб рд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ: **`find / -name "kernelcache" 2>/dev/null`** \
рдореЗрд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ macOS рдореЗрдВ рдореИрдВрдиреЗ рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдерд╛рди рдкрд░ рдкрд╛рдпрд╛:

- `/System/Volumes/Preboot/1BAEB4B5-180B-4C46-BD53-51152B7D92DA/boot/DAD35E7BC0CDA79634C20BD1BD80678DFB510B2AAD3D25C1228BB34BCD0A711529D3D571C93E29E1D0C1264750FA043F/System/Library/Caches/com.apple.kernelcaches/kernelcache`

#### IMG4

IMG4 рдлрд╝рд╛рдЗрд▓ рдкреНрд░рд╛рд░реВрдк рдПрдХ рдХрдВрдЯреЗрдирд░ рдкреНрд░рд╛рд░реВрдк рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ Apple рдЕрдкрдиреЗ iOS рдФрд░ macOS рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ **рдлрд░реНрдорд╡реЗрдпрд░** рдШрдЯрдХреЛрдВ (рдЬреИрд╕реЗ **рдХрд░реНрдиреЗрд▓рдХреИрд╢**) рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ **рд╕реНрдЯреЛрд░ рдФрд░ рд╕рддреНрдпрд╛рдкрд┐рдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИред IMG4 рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдПрдХ рд╣реЗрдбрд░ рдФрд░ рдХрдИ рдЯреИрдЧ рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдбреЗрдЯрд╛ рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдореЗрдВ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкреЗрд▓реЛрдб (рдЬреИрд╕реЗ рдХрд░реНрдиреЗрд▓ рдпрд╛ рдмреВрдЯрд▓реЛрдбрд░), рдПрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░, рдФрд░ рдПрдХ рд╕реЗрдЯ рдореИрдирд┐рдлреЗрд╕реНрдЯ рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдпрд╣ рдкреНрд░рд╛рд░реВрдк рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рд╕рддреНрдпрд╛рдкрди рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдбрд┐рд╡рд╛рдЗрд╕ рдлрд░реНрдорд╡реЗрдпрд░ рдШрдЯрдХ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЙрд╕рдХреА рдкреНрд░рд╛рдорд╛рдгрд┐рдХрддрд╛ рдФрд░ рдЕрдЦрдВрдбрддрд╛ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдШрдЯрдХреЛрдВ рд╕реЗ рдмрдирд╛ рд╣реЛрддрд╛ рд╣реИ:

- **Payload (IM4P)**:
- рдЕрдХреНрд╕рд░ рд╕рдВрдХреБрдЪрд┐рдд (LZFSE4, LZSS, тАж)
- рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб
- **Manifest (IM4M)**:
- рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╢рд╛рдорд┐рд▓ рд╣реИ
- рдЕрддрд┐рд░рд┐рдХреНрдд рдХреБрдВрдЬреА/рдорд╛рди рд╢рдмреНрджрдХреЛрд╢
- **Restore Info (IM4R)**:
- APNonce рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ
- рдХреБрдЫ рдЕрдкрдбреЗрдЯ рдХреЗ рдкреБрдирдГ рдЦреЗрд▓рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ
- рд╡реИрдХрд▓реНрдкрд┐рдХ: рдЖрдорддреМрд░ рдкрд░ рдпрд╣ рдирд╣реАрдВ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛

рдХрд░реНрдиреЗрд▓рдХреИрд╢ рдХреЛ рдЕрдирд╕рдВрдХреБрдЪрд┐рдд рдХрд░реЗрдВ:
```bash
# img4tool (https://github.com/tihmstar/img4tool)
img4tool -e kernelcache.release.iphone14 -o kernelcache.release.iphone14.e

# pyimg4 (https://github.com/m1stadev/PyIMG4)
pyimg4 im4p extract -i kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
```
### рдбрд╛рдЙрдирд▓реЛрдб

- [**KernelDebugKit Github**](https://github.com/dortania/KdkSupportPkg/releases)

[https://github.com/dortania/KdkSupportPkg/releases](https://github.com/dortania/KdkSupportPkg/releases) рдкрд░ рд╕рднреА рдХрд░реНрдиреЗрд▓ рдбрд┐рдмрдЧ рдХрд┐рдЯреНрд╕ рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдЗрд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, [Suspicious Package](https://www.mothersruin.com/software/SuspiciousPackage/get.html) рдЯреВрд▓ рдХреЗ рд╕рд╛рде рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ, **`.kext`** рдлрд╝реЛрд▓реНрдбрд░ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ**ред

рд╕рд┐рдВрдмреЙрд▓ рдХреЗ рд▓рд┐рдП рдЬрд╛рдВрдЪреЗрдВ:
```bash
nm -a ~/Downloads/Sandbox.kext/Contents/MacOS/Sandbox | wc -l
```
- [**theapplewiki.com**](https://theapplewiki.com/wiki/Firmware/Mac/14.x)**,** [**ipsw.me**](https://ipsw.me/)**,** [**theiphonewiki.com**](https://www.theiphonewiki.com/)

рдХрднреА-рдХрднреА Apple **kernelcache** рдХреЛ **symbols** рдХреЗ рд╕рд╛рде рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИред рдЖрдк рдЙрди рдкреГрд╖реНрдареЛрдВ рдкрд░ рджрд┐рдП рдЧрдП рд▓рд┐рдВрдХ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ рдХреБрдЫ firmware рдХреЛ symbols рдХреЗ рд╕рд╛рде рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред firmware рдореЗрдВ рдЕрдиреНрдп рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рд╛рде **kernelcache** рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛ред

рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ **extract** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдкрд╣рд▓реЗ `.ipsw` рд╕реЗ `.zip` рдореЗрдВ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдмрджрд▓реЗрдВ рдФрд░ рдлрд┐рд░ **unzip** рдХрд░реЗрдВред

Firmware рдХреЛ extract рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЖрдкрдХреЛ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдорд┐рд▓реЗрдЧреА рдЬреИрд╕реЗ: **`kernelcache.release.iphone14`**ред рдпрд╣ **IMG4** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╣реИ, рдЖрдк рдЗрд╕рдореЗрдВ рд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ:

[**pyimg4**](https://github.com/m1stadev/PyIMG4)**:**
```bash
pyimg4 im4p extract -i kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
```
[**img4tool**](https://github.com/tihmstar/img4tool)**:**
```bash
img4tool -e kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
```
### Inspecting kernelcache

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ kernelcache рдореЗрдВ рдкреНрд░рддреАрдХ рд╣реИрдВ
```bash
nm -a kernelcache.release.iphone14.e | wc -l
```
рдЗрд╕рдХреЗ рд╕рд╛рде, рд╣рдо рдЕрдм **рд╕рднреА рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ** рдпрд╛ **рд╡рд╣ рдЬреЛ рдЖрдкрдХреЛ рд░реБрдЪрд┐рдХрд░ рд╣реИ:**
```bash
# List all extensions
kextex -l kernelcache.release.iphone14.e
## Extract com.apple.security.sandbox
kextex -e com.apple.security.sandbox kernelcache.release.iphone14.e

# Extract all
kextex_all kernelcache.release.iphone14.e

# Check the extension for symbols
nm -a binaries/com.apple.security.sandbox | wc -l
```
## рд╣рд╛рд▓ рдХреА рдХрдордЬреЛрд░рд┐рдпрд╛рдБ рдФрд░ рд╢реЛрд╖рдг рддрдХрдиреАрдХреЗрдВ

| рд╡рд░реНрд╖ | CVE | рд╕рд╛рд░рд╛рдВрд╢ |
|------|-----|---------|
| 2024 | **CVE-2024-44243** | **`storagekitd`** рдореЗрдВ рд▓реЙрдЬрд┐рдХ рджреЛрд╖ рдиреЗ *root* рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдлрд╝рд╛рдЗрд▓-рдкреНрд░рдгрд╛рд▓реА рдмрдВрдбрд▓ рдкрдВрдЬреАрдХреГрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА, рдЬрд┐рд╕рдиреЗ рдЕрдВрддрддрдГ рдПрдХ **unsigned kext** рд▓реЛрдб рдХрд┐рдпрд╛, **System Integrity Protection (SIP)** рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдФрд░ рд╕реНрдерд╛рдпреА рд░реВрдЯрдХрд┐рдЯ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ред macOS 14.2 / 15.2 рдореЗрдВ рдкреИрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ред |
| 2021 | **CVE-2021-30892** (*Shrootless*) | `com.apple.rootless.install` рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рд╕рд╛рде рд╕реНрдерд╛рдкрдирд╛ рдбреЗрдорди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдордирдорд╛рдиреЗ рдкреЛрд╕реНрдЯ-рдЗрдВрд╕реНрдЯреЙрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, SIP рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рдордирдорд╛рдиреЗ kexts рдХреЛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред |

**рд░реЗрдб-рдЯреАрдорд░реНрд╕ рдХреЗ рд▓рд┐рдП рд╕реАрдЦрдиреЗ рдпреЛрдЧреНрдп рдмрд╛рддреЗрдВ**

1. **Disk Arbitration, Installer рдпрд╛ Kext Management рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдбреЗрдордиреНрд╕ (`codesign -dvv /path/bin | grep entitlements`) рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВред**
2. **SIP рдмрд╛рдпрдкрд╛рд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рд▓рдЧрднрдЧ рд╣рдореЗрд╢рд╛ рдПрдХ kext рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ тЖТ рдХрд░реНрдиреЗрд▓ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди**ред

**рд░рдХреНрд╖рд╛ рд╕рдВрдмрдВрдзреА рд╕реБрдЭрд╛рд╡**

*SIP рдХреЛ рд╕рдХреНрд╖рдо рд░рдЦреЗрдВ*, рдЧреИрд░-Apple рдмрд╛рдЗрдирд░реА рд╕реЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ `kmutil load`/`kmutil create -n aux` рдХреЙрд▓реНрд╕ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░реЗрдВ рдФрд░ `/Library/Extensions` рдореЗрдВ рдХрд┐рд╕реА рднреА рд▓реЗрдЦрди рдкрд░ рдЕрд▓рд░реНрдЯ рдХрд░реЗрдВред рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реБрд░рдХреНрд╖рд╛ рдШрдЯрдирд╛рдПрдБ `ES_EVENT_TYPE_NOTIFY_KEXTLOAD` рд▓рдЧрднрдЧ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдХреА рджреГрд╢реНрдпрддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИрдВред

## macOS рдХрд░реНрдиреЗрд▓ рдФрд░ kexts рдХрд╛ рдбрд┐рдмрдЧрд┐рдВрдЧ

Apple рдХреА рдЕрдиреБрд╢рдВрд╕рд┐рдд рдХрд╛рд░реНрдпрдкреНрд░рдгрд╛рд▓реА рдПрдХ **Kernel Debug Kit (KDK)** рдмрдирд╛рдиреЗ рдХреА рд╣реИ рдЬреЛ рдЪрд▓ рд░рд╣реЗ рдирд┐рд░реНрдорд╛рдг рд╕реЗ рдореЗрд▓ рдЦрд╛рддреА рд╣реИ рдФрд░ рдлрд┐рд░ **KDP (Kernel Debugging Protocol)** рдиреЗрдЯрд╡рд░реНрдХ рд╕рддреНрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **LLDB** рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рддреА рд╣реИред

### рдПрдХ рдмрд╛рд░ рдХрд╛ рд╕реНрдерд╛рдиреАрдп рдкреИрдирд┐рдХ рдбрд┐рдмрдЧрд┐рдВрдЧ
```bash
# Create a symbolication bundle for the latest panic
sudo kdpwrit dump latest.kcdata
kmutil analyze-panic latest.kcdata -o ~/panic_report.txt
```
### Live remote debugging from another Mac

1. рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ + рд▓рдХреНрд╖реНрдп рдорд╢реАрди рдХреЗ рд▓рд┐рдП рд╕рд╣реА **KDK** рд╕рдВрд╕реНрдХрд░рдг рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВред
2. рд▓рдХреНрд╖реНрдп Mac рдФрд░ рд╣реЛрд╕реНрдЯ Mac рдХреЛ **USB-C рдпрд╛ Thunderbolt рдХреЗрдмрд▓** рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВред
3. **рд▓рдХреНрд╖реНрдп** рдкрд░:
```bash
sudo nvram boot-args="debug=0x100 kdp_match_name=macbook-target"
reboot
```
4. **рд╣реЛрд╕реНрдЯ** рдкрд░:
```bash
lldb
(lldb) kdp-remote "udp://macbook-target"
(lldb) bt  # get backtrace in kernel context
```
### рдПрдХ рд╡рд┐рд╢реЗрд╖ рд▓реЛрдб рдХрд┐рдП рдЧрдП kext рдХреЗ рд▓рд┐рдП LLDB рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рдирд╛
```bash
# Identify load address of the kext
ADDR=$(kmutil showloaded --bundle-identifier com.example.driver | awk '{print $4}')

# Attach
sudo lldb -n kernel_task -o "target modules load --file /Library/Extensions/Example.kext/Contents/MacOS/Example --slide $ADDR"
```
> тД╣я╕П  KDP рдХреЗрд╡рд▓ рдПрдХ **рдкрдврд╝рдиреЗ-рдХреЗ рд▓рд┐рдП** рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдЧрддрд┐рд╢реАрд▓ рдЗрдВрд╕реНрдЯреНрд░реБрдореЗрдВрдЯреЗрд╢рди рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдмрд╛рдЗрдирд░реА рдХреЛ рдбрд┐рд╕реНрдХ рдкрд░ рдкреИрдЪ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, **рдХрд░реНрдиреЗрд▓ рдлрд╝рдВрдХреНрд╢рди рд╣реБрдХрд┐рдВрдЧ** (рдЬреИрд╕реЗ `mach_override`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдпрд╛ рдкреВрд░реНрдг рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдбреНрд░рд╛рдЗрд╡рд░ рдХреЛ **рд╣рд╛рдЗрдкрд░рд╡рд╛рдЗрдЬрд╝рд░** рдореЗрдВ рдорд╛рдЗрдЧреНрд░реЗрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

## рд╕рдВрджрд░реНрдн

- DriverKit рд╕реБрд░рдХреНрд╖рд╛ тАУ Apple рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рд╕реБрд░рдХреНрд╖рд╛ рдЧрд╛рдЗрдб
- Microsoft рд╕реБрд░рдХреНрд╖рд╛ рдмреНрд▓реЙрдЧ тАУ *CVE-2024-44243 SIP рдмрд╛рдпрдкрд╛рд╕ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг*

{{#include ../../../banners/hacktricks-training.md}}
