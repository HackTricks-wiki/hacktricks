# macOS Kernel Extensions & Debugging

{{#include ../../../banners/hacktricks-training.md}}

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

Kernel extensions (Kexts) ‚Äî —Ü–µ **–ø–∞–∫–µ—Ç–∏** –∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è–º **`.kext`**, —è–∫—ñ **–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ –ø—Ä–æ—Å—Ç—ñ—Ä —è–¥—Ä–∞ macOS**, –Ω–∞–¥–∞—é—á–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ñ–π –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ.

### –°—Ç–∞—Ç—É—Å –∑–Ω–µ—Ü—ñ–Ω–µ–Ω–Ω—è —Ç–∞ DriverKit / –°–∏—Å—Ç–µ–º–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è
–ü–æ—á–∏–Ω–∞—é—á–∏ –∑ **macOS Catalina (10.15)**, Apple –ø–æ–∑–Ω–∞—á–∏–ª–∞ –±—ñ–ª—å—à—ñ—Å—Ç—å –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö KPI —è–∫ *–∑–Ω–µ—Ü—ñ–Ω–µ–Ω—ñ* —ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª–∞ **–°–∏—Å—Ç–µ–º–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ç–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ DriverKit**, —è–∫—ñ –ø—Ä–∞—Ü—é—é—Ç—å —É **–ø—Ä–æ—Å—Ç–æ—Ä—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**. –ó **macOS Big Sur (11)** –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ *–≤—ñ–¥–º–æ–≤–∏—Ç—å—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏* —Å—Ç–æ—Ä–æ–Ω–Ω—ñ kext, —è–∫—ñ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö KPI, —è–∫—â–æ –º–∞—à–∏–Ω–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ –≤ —Ä–µ–∂–∏–º—ñ **–ó–º–µ–Ω—à–µ–Ω–æ—ó –±–µ–∑–ø–µ–∫–∏**. –ù–∞ Apple Silicon, –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó kext —Ç–∞–∫–æ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á:

1. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è –≤ **Recovery** ‚Üí *Startup Security Utility*.
2. –í–∏–±—Ä–∞–≤ **–ó–º–µ–Ω—à–µ–Ω—É –±–µ–∑–ø–µ–∫—É** —Ç–∞ –ø–æ–∑–Ω–∞—á–∏–≤ **‚Äú–î–æ–∑–≤–æ–ª–∏—Ç–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è–º–∏ —è–¥—Ä–∞ –≤—ñ–¥ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤‚Äù**.
3. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤—Å—è —Ç–∞ —Å—Ö–≤–∞–ª–∏–≤ kext –∑ **–°–∏—Å—Ç–µ–º–Ω–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å ‚Üí –ö–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ—Å—Ç—å —Ç–∞ –±–µ–∑–ø–µ–∫–∞**.

–î—Ä–∞–π–≤–µ—Ä–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –Ω–∞–ø–∏—Å–∞–Ω—ñ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º DriverKit/–°–∏—Å—Ç–µ–º–Ω–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å, –∑–Ω–∞—á–Ω–æ **–∑–º–µ–Ω—à—É—é—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω—é –∞—Ç–∞–∫–∏**, –æ—Å–∫—ñ–ª—å–∫–∏ –∑–±–æ—ó –∞–±–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ –æ–±–º–µ–∂–µ–Ω—ñ –ø—ñ—Å–æ—á–Ω–∏—Ü–µ—é, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ—Ä–æ–º —è–¥—Ä–∞.

> üìù –ó macOS Sequoia (15) Apple –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏–ª–∞ –∫—ñ–ª—å–∫–∞ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö KPI –¥–ª—è –º–µ—Ä–µ–∂—ñ —Ç–∞ USB ‚Äì —î–¥–∏–Ω–∏–º —Ä—ñ—à–µ–Ω–Ω—è–º, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É –¥–ª—è –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—ñ–≤, —î –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –°–∏—Å—Ç–µ–º–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è.

### –í–∏–º–æ–≥–∏

–û—á–µ–≤–∏–¥–Ω–æ, —â–æ —Ü–µ –Ω–∞—Å—Ç—ñ–ª—å–∫–∏ –ø–æ—Ç—É–∂–Ω–æ, —â–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞** —î **—Å–∫–ª–∞–¥–Ω–∏–º**. –û—Å—å **–≤–∏–º–æ–≥–∏**, —è–∫—ñ –ø–æ–≤–∏–Ω–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞, —â–æ–± –±—É—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–º:

- –ö–æ–ª–∏ **–≤—Ö–æ–¥–∏—Ç–µ –≤ —Ä–µ–∂–∏–º –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è**, —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞ **–ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ** –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:

<figure><img src="../../../images/image (327).png" alt=""><figcaption></figcaption></figure>

- –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞ –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ **–ø—ñ–¥–ø–∏—Å–∞–Ω–µ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º –ø—ñ–¥–ø–∏—Å—É –∫–æ–¥—É —è–¥—Ä–∞**, —è–∫–∏–π –º–æ–∂–µ –±—É—Ç–∏ **–Ω–∞–¥–∞–Ω–∏–π —Ç—ñ–ª—å–∫–∏ Apple**. –•—Ç–æ –¥–µ—Ç–∞–ª—å–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –∫–æ–º–ø–∞–Ω—ñ—é —Ç–∞ –ø—Ä–∏—á–∏–Ω–∏, —á–æ–º—É —Ü–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
- –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞ —Ç–∞–∫–æ–∂ –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ **–Ω–æ—Ç–∞—Ä–∏–∑–æ–≤–∞–Ω–µ**, Apple –∑–º–æ–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –π–æ–≥–æ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –ü–ó.
- –ü–æ—Ç—ñ–º, **–∫–æ—Ä–µ–Ω–µ–≤–∏–π** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î —Ç–∏–º, —Ö—Ç–æ –º–æ–∂–µ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞**, –∞ —Ñ–∞–π–ª–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞–∫–µ—Ç–∞ –ø–æ–≤–∏–Ω–Ω—ñ **–Ω–∞–ª–µ–∂–∞—Ç–∏ –∫–æ—Ä–µ–Ω—é**.
- –ü—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ—Å—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞–∫–µ—Ç –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–π —É **–∑–∞—Ö–∏—â–µ–Ω–æ–º—É –º—ñ—Å—Ü—ñ, —â–æ –Ω–µ —î –∫–æ—Ä–µ–Ω–µ–≤–∏–º**: `/Library/StagedExtensions` (–≤–∏–º–∞–≥–∞—î –Ω–∞–¥–∞–Ω–Ω—è `com.apple.rootless.storage.KernelExtensionManagement`).
- –ù–∞—Ä–µ—à—Ç—ñ, –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á [**–æ—Ç—Ä–∏–º–∞—î –∑–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è**](https://developer.apple.com/library/archive/technotes/tn2459/_index.html) —ñ, —è–∫—â–æ –ø—Ä–∏–π–º–µ, –∫–æ–º–ø'—é—Ç–µ—Ä –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ **–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π** –¥–ª—è –π–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

### –ü—Ä–æ—Ü–µ—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

–£ Catalina —Ü–µ –≤–∏–≥–ª—è–¥–∞–ª–æ —Ç–∞–∫: –¶—ñ–∫–∞–≤–æ –≤—ñ–¥–∑–Ω–∞—á–∏—Ç–∏, —â–æ –ø—Ä–æ—Ü–µ—Å **–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏** –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ **–ø—Ä–æ—Å—Ç–æ—Ä—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**. –û–¥–Ω–∞–∫ —Ç—ñ–ª—å–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ –∑ –Ω–∞–¥–∞–Ω–Ω—è–º **`com.apple.private.security.kext-management`** –º–æ–∂—É—Ç—å **–∑–∞–ø–∏—Ç—É–≤–∞—Ç–∏ —É —è–¥—Ä–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è**: `kextcache`, `kextload`, `kextutil`, `kextd`, `syspolicyd`

1. **`kextutil`** cli **–ø–æ—á–∏–Ω–∞—î** –ø—Ä–æ—Ü–µ—Å **–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏** –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è
- –í—ñ–Ω —Å–ø—ñ–ª–∫—É—î—Ç—å—Å—è –∑ **`kextd`**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **Mach service**.
2. **`kextd`** –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –∫—ñ–ª—å–∫–∞ —Ä–µ—á–µ–π, —Ç–∞–∫–∏—Ö —è–∫ **–ø—ñ–¥–ø–∏—Å**
- –í—ñ–Ω —Å–ø—ñ–ª–∫—É—î—Ç—å—Å—è –∑ **`syspolicyd`**, —â–æ–± **–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏**, —á–∏ –º–æ–∂–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±—É—Ç–∏ **–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–º**.
3. **`syspolicyd`** **–∑–∞–ø–∏—Ç–∞—î** **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, —è–∫—â–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –Ω–µ –±—É–ª–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ä–∞–Ω—ñ—à–µ.
- **`syspolicyd`** –ø–æ–≤—ñ–¥–æ–º–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç **`kextd`**
4. **`kextd`** –Ω–∞—Ä–µ—à—Ç—ñ –∑–º–æ–∂–µ **—Å–∫–∞–∑–∞—Ç–∏ —è–¥—Ä—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏** —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è

–Ø–∫—â–æ **`kextd`** –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, **`kextutil`** –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Ç—ñ –∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.

### –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è (–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ kexts)

`kextstat` –±—É–≤ —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏–º —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º, –∞–ª–µ –≤—ñ–Ω —î **–∑–Ω–µ—Ü—ñ–Ω–µ–Ω–∏–º** —É –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–∏–ø—É—Å–∫–∞—Ö macOS. –°—É—á–∞—Å–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî —Ü–µ **`kmutil`**:
```bash
# List every extension currently linked in the kernel, sorted by load address
sudo kmutil showloaded --sort

# Show only third-party / auxiliary collections
sudo kmutil showloaded --collection aux

# Unload a specific bundle
sudo kmutil unload -b com.example.mykext
```
–°—Ç–∞—Ä–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Å–µ —â–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è:
```bash
# (Deprecated) Get loaded kernel extensions
kextstat

# (Deprecated) Get dependencies of the kext number 22
kextstat | grep " 22 " | cut -c2-5,50- | cut -d '(' -f1
```
`kmutil inspect` —Ç–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è **–≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–º—ñ—Å—Ç—É –ö–æ–ª–µ–∫—Ü—ñ—ó –Ø–¥—Ä–∞ (KC)** –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, —â–æ kext –≤–∏—Ä—ñ—à—É—î –≤—Å—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Å–∏–º–≤–æ–ª—ñ–≤:
```bash
# List fileset entries contained in the boot KC
kmutil inspect -B /System/Library/KernelCollections/BootKernelExtensions.kc --show-fileset-entries

# Check undefined symbols of a 3rd party kext before loading
kmutil libraries -p /Library/Extensions/FancyUSB.kext --undef-symbols
```
## Kernelcache

> [!CAUTION]
> –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –æ—á—ñ–∫—É—î—Ç—å—Å—è, —â–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–¥—Ä–∞ –±—É–¥—É—Ç—å —É `/System/Library/Extensions/`, —è–∫—â–æ –≤–∏ –∑–∞–π–¥–µ—Ç–µ –≤ —Ü—é –ø–∞–ø–∫—É, –≤–∏ **–Ω–µ –∑–Ω–∞–π–¥–µ—Ç–µ –∂–æ–¥–Ω–æ–≥–æ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É**. –¶–µ –ø–æ–≤'—è–∑–∞–Ω–æ –∑ **kernelcache**, —ñ –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –∑–≤–æ—Ä–æ—Ç–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–¥–∏–Ω `.kext`, –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞–π—Ç–∏ —Å–ø–æ—Å—ñ–± –π–æ–≥–æ –æ—Ç—Ä–∏–º–∞—Ç–∏.

**Kernelcache** - —Ü–µ **–ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∞ —Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∑–≤'—è–∑–∞–Ω–∞ –≤–µ—Ä—Å—ñ—è —è–¥—Ä–∞ XNU**, —Ä–∞–∑–æ–º –∑ –æ—Å–Ω–æ–≤–Ω–∏–º–∏ –ø—Ä–∏—Å—Ç—Ä–æ—è–º–∏ **–¥—Ä–∞–π–≤–µ—Ä–∞–º–∏** —Ç–∞ **—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è–º–∏ —è–¥—Ä–∞**. –í—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É **—Å–∂–∞—Ç–æ–º—É** —Ñ–æ—Ä–º–∞—Ç—ñ —ñ —Ä–æ–∑–ø–∞–∫–æ–≤—É—î—Ç—å—Å—è –≤ –ø–∞–º'—è—Ç—å –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ—Å—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. Kernelcache —Å–ø—Ä–∏—è—î **—à–≤–∏–¥—à–æ–º—É —á–∞—Å—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**, –º–∞—é—á–∏ –≥–æ—Ç–æ–≤—É –¥–æ –∑–∞–ø—É—Å–∫—É –≤–µ—Ä—Å—ñ—é —è–¥—Ä–∞ —Ç–∞ –≤–∞–∂–ª–∏–≤–∏—Ö –¥—Ä–∞–π–≤–µ—Ä—ñ–≤, —â–æ –∑–º–µ–Ω—à—É—î —á–∞—Å —ñ —Ä–µ—Å—É—Ä—Å–∏, —è–∫—ñ —ñ–Ω–∞–∫—à–µ –≤–∏—Ç—Ä–∞—á–∞–ª–∏—Å—è –± –Ω–∞ –¥–∏–Ω–∞–º—ñ—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –∑–≤'—è–∑—É–≤–∞–Ω–Ω—è —Ü–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

### Local Kerlnelcache

–í iOS –≤—ñ–Ω —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π —É **`/System/Library/Caches/com.apple.kernelcaches/kernelcache`**, –≤ macOS –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –π–æ–≥–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é: **`find / -name "kernelcache" 2>/dev/null`** \
–£ –º–æ—î–º—É –≤–∏–ø–∞–¥–∫—É –≤ macOS —è –∑–Ω–∞–π—à–æ–≤ –π–æ–≥–æ –≤:

- `/System/Volumes/Preboot/1BAEB4B5-180B-4C46-BD53-51152B7D92DA/boot/DAD35E7BC0CDA79634C20BD1BD80678DFB510B2AAD3D25C1228BB34BCD0A711529D3D571C93E29E1D0C1264750FA043F/System/Library/Caches/com.apple.kernelcaches/kernelcache`

#### IMG4

–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É IMG4 - —Ü–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è Apple –≤ —ó—ó –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö iOS —Ç–∞ macOS –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ **–∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ –ø—Ä–æ—à–∏–≤–∫–∏** (—Ç–∞–∫–∏—Ö —è–∫ **kernelcache**). –§–æ—Ä–º–∞—Ç IMG4 –≤–∫–ª—é—á–∞—î –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ñ –∫—ñ–ª—å–∫–∞ —Ç–µ–≥—ñ–≤, —è–∫—ñ —ñ–Ω–∫–∞–ø—Å—É–ª—é—é—Ç—å —Ä—ñ–∑–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ –¥–∞–Ω–∏—Ö, –≤–∫–ª—é—á–∞—é—á–∏ —Ñ–∞–∫—Ç–∏—á–Ω–∏–π –∫–æ—Ä–∏—Å–Ω–∏–π –≤–∞–Ω—Ç–∞–∂ (—Ç–∞–∫–∏–π —è–∫ —è–¥—Ä–æ –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á), –ø—ñ–¥–ø–∏—Å —ñ –Ω–∞–±—ñ—Ä –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π –º–∞–Ω—ñ—Ñ–µ—Å—Ç—É. –§–æ—Ä–º–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º—É—î –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—ñ—á–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, —â–æ –¥–æ–∑–≤–æ–ª—è—î –ø—Ä–∏—Å—Ç—Ä–æ—é –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É–≤–∞—Ç–∏ –∞–≤—Ç–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —Ç–∞ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø—Ä–æ—à–∏–≤–∫–∏ –ø–µ—Ä–µ–¥ –π–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º.

–ó–∞–∑–≤–∏—á–∞–π –≤—ñ–Ω —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤:

- **Payload (IM4P)**:
- –ß–∞—Å—Ç–æ —Å—Ç–∏—Å–Ω—É—Ç–∏–π (LZFSE4, LZSS, ‚Ä¶)
- –ó–∞ –±–∞–∂–∞–Ω–Ω—è–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π
- **Manifest (IM4M)**:
- –ú—ñ—Å—Ç–∏—Ç—å –ø—ñ–¥–ø–∏—Å
- –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Å–ª–æ–≤–Ω–∏–∫ –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–Ω—è
- **Restore Info (IM4R)**:
- –í—ñ–¥–æ–º–∏–π —Ç–∞–∫–æ–∂ —è–∫ APNonce
- –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é –¥–µ—è–∫–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å
- OPTIONAL: –ó–∞–∑–≤–∏—á–∞–π —Ü–µ –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è

–†–æ–∑–ø–∞–∫—É–π—Ç–µ Kernelcache:
```bash
# img4tool (https://github.com/tihmstar/img4tool)
img4tool -e kernelcache.release.iphone14 -o kernelcache.release.iphone14.e

# pyimg4 (https://github.com/m1stadev/PyIMG4)
pyimg4 im4p extract -i kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
```
### –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏

- [**KernelDebugKit Github**](https://github.com/dortania/KdkSupportPkg/releases)

–í [https://github.com/dortania/KdkSupportPkg/releases](https://github.com/dortania/KdkSupportPkg/releases) –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤—Å—ñ –Ω–∞–±–æ—Ä–∏ –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è —è–¥—Ä–∞. –í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ, –∑–º–æ–Ω—Ç—É–≤–∞—Ç–∏, –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É [Suspicious Package](https://www.mothersruin.com/software/SuspiciousPackage/get.html), –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø–∞–ø–∫–∏ **`.kext`** —Ç–∞ **–≤–∏—Ç—è–≥—Ç–∏ –π–æ–≥–æ**.

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –π–æ–≥–æ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Å–∏–º–≤–æ–ª—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
nm -a ~/Downloads/Sandbox.kext/Contents/MacOS/Sandbox | wc -l
```
- [**theapplewiki.com**](https://theapplewiki.com/wiki/Firmware/Mac/14.x)**,** [**ipsw.me**](https://ipsw.me/)**,** [**theiphonewiki.com**](https://www.theiphonewiki.com/)

–Ü–Ω–æ–¥—ñ Apple –≤–∏–ø—É—Å–∫–∞—î **kernelcache** –∑ **symbols**. –í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ—è–∫—ñ –ø—Ä–æ—à–∏–≤–∫–∏ –∑ —Å–∏–º–≤–æ–ª–∞–º–∏, –ø–µ—Ä–µ–π—à–æ–≤—à–∏ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏ –Ω–∞ —Ü–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö. –ü—Ä–æ—à–∏–≤–∫–∏ –º—ñ—Å—Ç–∏—Ç–∏–º—É—Ç—å **kernelcache** —Å–µ—Ä–µ–¥ —ñ–Ω—à–∏—Ö —Ñ–∞–π–ª—ñ–≤.

–©–æ–± **extract** —Ñ–∞–π–ª–∏, –ø–æ—á–Ω—ñ—Ç—å –∑ –∑–º—ñ–Ω–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –∑ `.ipsw` –Ω–∞ `.zip` —ñ **unzip** –π–æ–≥–æ.

–ü—ñ—Å–ª—è –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏ –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ —Ñ–∞–π–ª –Ω–∞ –∫—à—Ç–∞–ª—Ç: **`kernelcache.release.iphone14`**. –í—ñ–Ω —É —Ñ–æ—Ä–º–∞—Ç—ñ **IMG4**, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏—Ç—è–≥—Ç–∏ —Ü—ñ–∫–∞–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:

[**pyimg4**](https://github.com/m1stadev/PyIMG4)**:**
```bash
pyimg4 im4p extract -i kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
```
[**img4tool**](https://github.com/tihmstar/img4tool)**:**
```bash
img4tool -e kernelcache.release.iphone14 -o kernelcache.release.iphone14.e
```
### –Ü–Ω—Å–ø–µ–∫—Ü—ñ—è kernelcache

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –º–∞—î kernelcache —Å–∏–º–≤–æ–ª–∏ –∑
```bash
nm -a kernelcache.release.iphone14.e | wc -l
```
–ó —Ü–∏–º –º–∏ —Ç–µ–ø–µ—Ä –º–æ–∂–µ–º–æ **–≤–∏—Ç—è–≥—Ç–∏ –≤—Å—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è** –∞–±–æ **—Ç–µ, —è–∫–µ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å:**
```bash
# List all extensions
kextex -l kernelcache.release.iphone14.e
## Extract com.apple.security.sandbox
kextex -e com.apple.security.sandbox kernelcache.release.iphone14.e

# Extract all
kextex_all kernelcache.release.iphone14.e

# Check the extension for symbols
nm -a binaries/com.apple.security.sandbox | wc -l
```
## –û—Å—Ç–∞–Ω–Ω—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ —Ç–∞ —Ç–µ—Ö–Ω—ñ–∫–∏ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

| –†—ñ–∫ | CVE | –†–µ–∑—é–º–µ |
|------|-----|---------|
| 2024 | **CVE-2024-44243** | –õ–æ–≥—ñ—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ **`storagekitd`** –¥–æ–∑–≤–æ–ª–∏–ª–∞ *root* –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ —à–∫—ñ–¥–ª–∏–≤–∏–π –ø–∞–∫–µ—Ç —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏, —è–∫–∏–π –≤ –∫—ñ–Ω—Ü–µ–≤–æ–º—É –ø—ñ–¥—Å—É–º–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–≤ **–Ω–µ–¥–æ–¥–ø–∏—Å–∞–Ω–∏–π kext**, **–æ–±–º–∏–Ω–∞—é—á–∏ –ó–∞—Ö–∏—Å—Ç —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏ (SIP)** —ñ –¥–æ–∑–≤–æ–ª—è—é—á–∏ –ø–æ—Å—Ç—ñ–π–Ω—ñ —Ä—É—Ç–∫—ñ—Ç–∏. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ macOS 14.2 / 15.2.   |
| 2021 | **CVE-2021-30892** (*Shrootless*) | –î–µ–º–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑ –ø—Ä–∞–≤–æ–º `com.apple.rootless.install` –º—ñ–≥ –±—É—Ç–∏ –∑–ª–æ–≤–∂–∏—Ç–∏–π –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç—ñ–≤ –ø—ñ—Å–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è SIP —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö kext.  |

**–í–∏—Å–Ω–æ–≤–∫–∏ –¥–ª—è —á–µ—Ä–≤–æ–Ω–∏—Ö –∫–æ–º–∞–Ω–¥**

1. **–®—É–∫–∞–π—Ç–µ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—ñ –¥–µ–º–æ–Ω–∏ (`codesign -dvv /path/bin | grep entitlements`), —è–∫—ñ –≤–∑–∞—î–º–æ–¥—ñ—é—Ç—å –∑ Disk Arbitration, Installer –∞–±–æ Kext Management.**
2. **–ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –æ–±—Ö—ñ–¥ SIP –º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏ –Ω–∞–¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ kext ‚Üí –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É —è–¥—Ä–∞**.

**–û–±–æ—Ä–æ–Ω–Ω—ñ –ø–æ—Ä–∞–¥–∏**

*–ó–∞–ª–∏—à–∞–π—Ç–µ SIP —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º*, –∫–æ–Ω—Ç—Ä–æ–ª—é–π—Ç–µ –≤–∏–∫–ª–∏–∫–∏ `kmutil load`/`kmutil create -n aux`, —â–æ –Ω–∞–¥—Ö–æ–¥—è—Ç—å –∑ –Ω–µ-Apple –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤, —ñ —Å–ø–æ–≤—ñ—â–∞–π—Ç–µ –ø—Ä–æ –±—É–¥—å-—è–∫–µ –∑–∞–ø–∏—Å—É–≤–∞–Ω–Ω—è –≤ `/Library/Extensions`. –ü–æ–¥—ñ—ó –±–µ–∑–ø–µ–∫–∏ –∫—ñ–Ω—Ü–µ–≤–∏—Ö —Ç–æ—á–æ–∫ `ES_EVENT_TYPE_NOTIFY_KEXTLOAD` –∑–∞–±–µ–∑–ø–µ—á—É—é—Ç—å –º–∞–π–∂–µ —Ä–µ–∞–ª—å–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥.

## –ù–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è —è–¥—Ä–∞ macOS —Ç–∞ kext

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —Ä–æ–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å Apple –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ **Kernel Debug Kit (KDK)**, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞–ø—É—â–µ–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó, –∞ –ø–æ—Ç—ñ–º –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ **LLDB** —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂–µ–≤—É —Å–µ—Å—ñ—é **KDP (Kernel Debugging Protocol)**.

### –û–¥–Ω–æ—Ä–∞–∑–æ–≤–µ –ª–æ–∫–∞–ª—å–Ω–µ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –ø–∞–Ω—ñ–∫–∏
```bash
# Create a symbolication bundle for the latest panic
sudo kdpwrit dump latest.kcdata
kmutil analyze-panic latest.kcdata -o ~/panic_report.txt
```
### –ñ–∏–≤–µ –≤—ñ–¥–¥–∞–ª–µ–Ω–µ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –∑ —ñ–Ω—à–æ–≥–æ Mac

1. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ + –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —Ç–æ—á–Ω—É –≤–µ—Ä—Å—ñ—é **KDK** –¥–ª—è —Ü—ñ–ª—å–æ–≤–æ—ó –º–∞—à–∏–Ω–∏.
2. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å —Ü—ñ–ª—å–æ–≤–∏–π Mac —ñ —Ö–æ—Å—Ç Mac –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **USB-C –∞–±–æ Thunderbolt –∫–∞–±–µ–ª—é**.
3. –ù–∞ **—Ü—ñ–ª—å–æ–≤–æ–º—É**:
```bash
sudo nvram boot-args="debug=0x100 kdp_match_name=macbook-target"
reboot
```
4. –ù–∞ **—Ö–æ—Å—Ç—ñ**:
```bash
lldb
(lldb) kdp-remote "udp://macbook-target"
(lldb) bt  # get backtrace in kernel context
```
### –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è LLDB –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ kext
```bash
# Identify load address of the kext
ADDR=$(kmutil showloaded --bundle-identifier com.example.driver | awk '{print $4}')

# Attach
sudo lldb -n kernel_task -o "target modules load --file /Library/Extensions/Example.kext/Contents/MacOS/Example --slide $ADDR"
```
> ‚ÑπÔ∏è  KDP –ª–∏—à–µ –Ω–∞–¥–∞—î **—Ç—ñ–ª—å–∫–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è** —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –î–ª—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ—ó —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ü—ñ—ó –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ –ø–∞—Ç—á–∏—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—Ö—É–∫ —Ñ—É–Ω–∫—Ü—ñ–π —è–¥—Ä–∞** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `mach_override`) –∞–±–æ –º—ñ–≥—Ä—É–≤–∞—Ç–∏ –¥—Ä–∞–π–≤–µ—Ä –¥–æ **–≥—ñ–ø–µ—Ä–≤—ñ–∑–æ—Ä–∞** –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É.

## References

- DriverKit Security ‚Äì Apple Platform Security Guide
- Microsoft Security Blog ‚Äì *Analyzing CVE-2024-44243 SIP bypass*

{{#include ../../../banners/hacktricks-training.md}}
