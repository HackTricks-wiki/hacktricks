# Relro

{{#include ../../banners/hacktricks-training.md}}

## Relro

**RELRO** рдХрд╛ рдорддрд▓рдм **Relocation Read-Only** рд╣реИ рдФрд░ рдпрд╣ linker (`ld`) рджреНрд╡рд╛рд░рд╛ рд▓рд╛рдЧреВ рдХреА рдЧрдИ рдПрдХ mitigation рд╣реИ рдЬреЛ ELF рдХреЗ рдХреБрдЫ data segments рдХреЛ рд╕рд╛рд░реА relocations рд▓рд╛рдЧреВ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж **read-only** рдмрдирд╛ рджреЗрддрд╛ рд╣реИред рдЙрджреНрджреЗрд╢реНрдп рдпрд╣ рд╣реИ рдХрд┐ attacker рдЙрди entries рдХреЛ overwrite рди рдХрд░ рд╕рдХреЗ рдЬреЛ execution рдХреЗ рджреМрд░рд╛рди dereference рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ тАФ рдЬреИрд╕реЗ **GOT (Global Offset Table)** рдпрд╛ рдЕрдиреНрдп relocation-рд╕рдВрдмрдВрдзрд┐рдд tables (рдЙрджрд╛. `__fini_array`)ред

Modern linkers RELRO рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ **GOT** (рдФрд░ рдХреБрдЫ рдЕрдиреНрдп sections) рдХреЛ **reтАУorder** рдХрд░рдХреЗ рддрд╛рдХрд┐ рд╡реЗ **.bss** рд╕реЗ **рдкрд╣рд▓реЗ** рд░рд╣реЗрдВ рдФрд░ тАФ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг тАФ рдПрдХ рд╕рдорд░реНрдкрд┐рдд `PT_GNU_RELRO` segment рдмрдирд╛рдХрд░ рдЬрд┐рд╕реЗ dynamic loader relocations рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж `RтАУX` рдХреЗ рд░реВрдк рдореЗрдВ remap рдХрд░ рджреЗрддрд╛ рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, **.bss** рдореЗрдВ рд╕рд╛рдорд╛рдиреНрдп buffer overflows рдЕрдм GOT рддрдХ рдирд╣реАрдВ рдкрд╣реБрдБрдЪ рдкрд╛рддреЗ рдФрд░ arbitraryтАРwrite primitives рдХрд╛ рдЙрдкрдпреЛрдЧ RELRO-protected рдкреЗрдЬ рдХреЗ рдЕрдВрджрд░ рдореМрдЬреВрдж function pointers рдХреЛ overwrite рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред

Linker рджреЛ рд╕реНрддрд░ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдирд┐рдХрд╛рд▓ рд╕рдХрддрд╛ рд╣реИ:

### Partial RELRO

* рдпрд╣ flag `-Wl,-z,relro` (рдпрд╛ рд╕реАрдзреЗ `ld` рдЪрд▓рд╛рддреЗ рд╕рдордп рд╕рд┐рд░реНрдл `-z relro`) рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* рдХреЗрд╡рд▓ **non-PLT** рд╣рд┐рд╕реНрд╕рд╛ of the **GOT** (data relocations рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рд╣рд┐рд╕реНрд╕рд╛) read-only segment рдореЗрдВ рдбрд╛рд▓рд╛ рдЬрд╛рддрд╛ рд╣реИред рдЬрд┐рди sections рдХреЛ run-time рдкрд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЬрд╝рд░реВрд░рдд рд╣реЛрддреА рд╣реИ тАФ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг **.got.plt** рдЬреЛ **lazy binding** рдХреЛ support рдХрд░рддрд╛ рд╣реИ тАФ рд╡реЗ writable рд╣реА рд░рд╣рддреЗ рд╣реИрдВред
* рдЗрд╕рд▓рд┐рдП, рдПрдХ **arbitrary write** primitive рдЕрднреА рднреА execution flow рдХреЛ redirect рдХрд░ рд╕рдХрддрд╛ рд╣реИ PLT entry рдХреЛ overwrite рдХрд░рдХреЗ (рдпрд╛ **ret2dlresolve** рдХрд░рдХреЗ)ред
* рдкреНрд░рджрд░реНрд╢рди рдкрд░ рдкреНрд░рднрд╛рд╡ рдирдЧрдгреНрдп рд╣реИ рдФрд░ рдЗрд╕рд▓рд┐рдП **рд▓рдЧрднрдЧ рд╣рд░ distribution рд╡рд░реНрд╖реЛрдВ рд╕реЗ рдХрдо рд╕реЗ рдХрдо Partial RELRO рдХреЗ рд╕рд╛рде packages рджреЗ рд░рд╣рд╛ рд╣реИ (рдпрд╣ 2016 рдХреЗ рдмрд╛рдж рд╕реЗ GCC/Binutils рдХрд╛ default рд╣реИ)**ред

### Full RELRO

* рдпрд╣ рджреЛрдиреЛрдВ flags рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ `-Wl,-z,relro,-z,now` (a.k.a. `-z relro -z now`)ред `-z now` dynamic loader рдХреЛ рдмрд╛рдзреНрдп рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╡рд╣ **рд╕рднреА** symbols рдкрд╣рд▓реЗ рд╕реЗ resolve рдХрд░ рджреЗ (eager binding), рддрд╛рдХрд┐ **.got.plt** рдХреЛ рджреЛрдмрд╛рд░рд╛ рд▓рд┐рдЦрдиреЗ рдХреА рдЬрд╝рд░реВрд░рдд рди рдкрдбрд╝реЗ рдФрд░ рдЗрд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ read-only map рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
* рдкреВрд░рд╛ **GOT**, **.got.plt**, **.fini_array**, **.init_array**, **.preinit_array** рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд internal glibc tables рдЕрдВрддрддрдГ рдПрдХ read-only `PT_GNU_RELRO` segment рдореЗрдВ рдЪрд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВред
* measurable start-up overhead рдЬреЛрдбрд╝рддрд╛ рд╣реИ (рд╕рднреА dynamic relocations launch рдкрд░ process рд╣реЛрддреЗ рд╣реИрдВ) рдкрд░ **рдХреЛрдИ run-time overhead рдирд╣реАрдВ** рд╣реЛрддрд╛ред

Since 2023 рдХрдИ mainstream distributions рдиреЗ **system tool-chain** (рдФрд░ рдЕрдзрд┐рдХрд╛рдВрд╢ packages) рдХреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **Full RELRO by default** рдХреЗ рд╕рд╛рде compile рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджрд┐рдпрд╛ рд╣реИ тАФ рдЬреИрд╕реЗ **Debian 12 тАЬbookwormтАЭ (dpkg-buildflags 13.0.0)** рдФрд░ **Fedora 35+**ред рдЗрд╕рд▓рд┐рдП рдПрдХ pentester рдХреЗ рд░реВрдк рдореЗрдВ рдЖрдкрдХреЛ рдЙрдореНрдореАрдж рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП рдХрд┐ рдЖрдк рдРрд╕реЗ binaries рдкрд╛рдПрдБрдЧреЗ рдЬрд┐рдирдореЗрдВ **рд╣рд░ GOT entry read-only** рд╣реЛрдЧреАред

---

## рдХрд┐рд╕реА binary рдореЗрдВ RELRO рдХреА рд╕реНрдерд┐рддрд┐ рдХреИрд╕реЗ рдЬрд╛рдВрдЪреЗрдВ
```bash
$ checksec --file ./vuln
[*] '/tmp/vuln'
Arch:     amd64-64-little
RELRO:    Full
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
```
`checksec` (part of [pwntools](https://github.com/pwncollege/pwntools) рдФрд░ рдХрдИ рд╡рд┐рддрд░рдгреЛрдВ) `ELF` рд╣реЗрдбрд░реНрд╕ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╕реНрддрд░ рдкреНрд░рд┐рдВрдЯ рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдЖрдк `checksec` рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ `readelf` рдкрд░ рдирд┐рд░реНрднрд░ рд░рд╣реЗрдВ:
```bash
# Partial RELRO тЖТ PT_GNU_RELRO is present but BIND_NOW is *absent*
$ readelf -l ./vuln | grep -E "GNU_RELRO|BIND_NOW"
GNU_RELRO      0x0000000000600e20 0x0000000000600e20
```

```bash
# Full RELRO тЖТ PT_GNU_RELRO *and* the DF_BIND_NOW flag
$ readelf -d ./vuln | grep BIND_NOW
0x0000000000000010 (FLAGS)              FLAGS: BIND_NOW
```
рдпрджрд┐ рдмрд╛рдЗрдирд░реА рдЪрд▓ рд░рд╣реА рд╣реИ (рдЙрджрд╛. set-uid root helper), рддреЛ рдЖрдк рдЕрднреА рднреА executable рдХреЛ **via `/proc/$PID/exe`** рдирд┐рд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
readelf -l /proc/$(pgrep helper)/exe | grep GNU_RELRO
```
---

## RELRO рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдЬрдм рдЖрдк рдЕрдкрдирд╛ рдХреЛрдб рдХрдВрдкрд╛рдЗрд▓ рдХрд░ рд░рд╣реЗ рд╣реЛрдВ
```bash
# GCC example тАУ create a PIE with Full RELRO and other common hardenings
$ gcc -fPIE -pie -z relro -z now -Wl,--as-needed -D_FORTIFY_SOURCE=2 main.c -o secure
```
`-z relro -z now` рджреЛрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ **GCC/clang** (рдЬреЛ `-Wl,` рдХреЗ рдмрд╛рдж рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ) рдФрд░ рд╕реАрдзреЗ **ld** рдкрд░ред рдЬрдм рдЖрдк **CMake 3.18+** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реЛрдВ рддреЛ рдЖрдк рдмрд┐рд▓реНрдЯ-рдЗрди рдкреНрд░реАрд╕реЗрдЯ рдХреЗ рд╕рд╛рде Full RELRO рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```cmake
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION ON) # LTO
set(CMAKE_ENABLE_EXPORTS OFF)
set(CMAKE_BUILD_RPATH_USE_ORIGIN ON)
set(CMAKE_EXE_LINKER_FLAGS "-Wl,-z,relro,-z,now")
```
---

## рдмрд╛рдпрдкрд╛рд╕ рддрдХрдиреАрдХреЗрдВ

| RELRO level | Typical primitive | Possible exploitation techniques |
|-------------|-------------------|----------------------------------|
| None / Partial | Arbitrary write | 1. **.got.plt** рдПрдВрдЯреНрд░реА рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗ execution pivot рдХрд░реЗрдВред<br>2. **ret2dlresolve** тАУ writable segment рдореЗрдВ рдирдХрд▓реА `Elf64_Rela` & `Elf64_Sym` рдмрдирд╛рдХрд░ `_dl_runtime_resolve` рдХреЛ рдХреЙрд▓ рдХрд░реЗрдВред<br>3. **.fini_array** / **atexit()** рд╕реВрдЪреА рдореЗрдВ рдореМрдЬреВрдж function pointers рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░реЗрдВред |
| Full | GOT is read-only | 1. рдХрд┐рд╕реА рдЕрдиреНрдп writable code pointers рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВ (C++ vtables, `__malloc_hook` < glibc 2.34, `__free_hook`, custom `.data` рд╕реЗрдХреНрд╢рди рдореЗрдВ callbacks, JIT pages)ред<br>2. relative read primitives рдХреЛ abuse рдХрд░рдХреЗ libc рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ **SROP/ROP into libc** рдХрд░реЗрдВред<br>3. рдЕрдЧрд░ environment attackerтАСcontrolled рд╣реИ рддреЛ **DT_RPATH**/`LD_PRELOAD` рдХреЗ рдЬрд░рд┐рдП rogue shared object inject рдХрд░реЗрдВ рдпрд╛ **`ld_audit`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред<br>4. **format-string** рдпрд╛ partial pointer overwrite рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ GOT рдХреЛ рдЫреБрдП рдмрд┐рдирд╛ control-flow рдмрджрд▓реЗрдВред |

> ЁЯТб Full RELRO рд╣реЛрдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж, loaded shared libraries (рдЬреИрд╕реЗ libc рд╕реНрд╡рдпрдВ) рдХрд╛ **GOT** рдЕрдХреНрд╕рд░ **only Partial RELRO** рд╣реЛрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ loader рджреНрд╡рд╛рд░рд╛ relocations рд▓рд╛рдЧреВ рдХрд┐рдП рдЬрд╛рдиреЗ рдкрд░ рд╡реЗ objects рдкрд╣рд▓реЗ рд╕реЗ рд╣реА mapped рд╣реЛрддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдРрд╕рд╛ **arbitrary write** primitive рд╣реИ рдЬреЛ рдХрд┐рд╕реА рдЕрдиреНрдп shared object рдХреЗ pages рдХреЛ рдЯрд╛рд░реНрдЧреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдЖрдк рдЕрднреА рднреА libc рдХреЗ GOT entries рдпрд╛ `__rtld_global` stack рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗ execution pivot рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ тАФ рдпрд╣ рддрдХрдиреАрдХ рдЖрдзреБрдирд┐рдХ CTF рдЪреБрдиреМрддрд┐рдпреЛрдВ рдореЗрдВ рдЕрдХреНрд╕рд░ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреА рдЬрд╛рддреА рд╣реИред

### рд╡рд╛рд╕реНрддрд╡рд┐рдХ рджреБрдирд┐рдпрд╛ рдХрд╛ рдмрд╛рдпрдкрд╛рд╕ рдЙрджрд╛рд╣рд░рдг (2024 CTF тАУ *pwn.college тАЬenlightenedтАЭ*)

Challenge Full RELRO рдХреЗ рд╕рд╛рде рдЖрдпрд╛ рдерд╛ред Exploit рдиреЗ рдПрдХ **off-by-one** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ heap chunk рдХреЗ size рдХреЛ рднреНрд░рд╖реНрдЯ рдХрд┐рдпрд╛, libc рдХреЛ leaked рдХрд┐рдпрд╛ `tcache poisoning` рд╕реЗ, рдФрд░ рдЕрдВрддрддрдГ `__free_hook` (RELRO segment рдХреЗ рдмрд╛рд╣рд░) рдХреЛ рдПрдХ one-gadget рд╕реЗ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдХреЗ code execution рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ред рдХрд┐рд╕реА рднреА GOT write рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рдереАред

---

## рд╣рд╛рд▓ рдХрд╛ рд░рд┐рд╕рд░реНрдЪ рдФрд░ рдХрдордЬреЛрд░рд┐рдпрд╛рдБ (2022-2025)

* **glibc hook removal (2.34 тЖТ present)** тАУ malloc/free hooks рдХреЛ рдореБрдЦреНрдп libc рд╕реЗ optional `libc_malloc_debug.so` рдореЗрдВ рдирд┐рдХрд╛рд▓рд╛ рдЧрдпрд╛, рдЬрд┐рд╕рд╕реЗ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп FullтАСRELRO bypass primitive рд╣рдЯ рдЧрдпрд╛; modern exploits рдХреЛ рдЕрдм рдЕрдиреНрдп writable pointers рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред
* **GNU ld RELRO pageтАСalignment fix (binutils 2.39+/2.41)** тАУ linker bug 30612 рдХреЗ рдХрд╛рд░рдг `PT_GNU_RELRO` рдХреЗ рдЕрдВрддрд┐рдо bytes 64тАпKiB page рд╕рд┐рд╕реНрдЯрдореНрд╕ рдкрд░ рдПрдХ writable page рд╕рд╛рдЭрд╛ рдХрд░рддреЗ рдереЗ; рд╡рд░реНрддрдорд╛рди binutils RELRO рдХреЛ `max-page-size` рдХреЗ рдЕрдиреБрд░реВрдк align рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд╣ тАЬRELRO gapтАЭ рдмрдВрдж рд╣реЛ рдЧрдпрд╛ред

---

## References

* [Why malloc hooks were removed from glibc](https://developers.redhat.com/articles/2021/08/25/securing-malloc-glibc-why-malloc-hooks-had-go)
* [Binutils bug 30612 тАУ RELRO end alignment](https://lists.gnu.org/archive/html/bug-binutils/2023-08/msg00305.html)

{{#include ../../banners/hacktricks-training.md}}
