# Relro

{{#include ../../banners/hacktricks-training.md}}

## Relro

**RELRO** stands for **Relocation Read-Only** and it is a mitigation implemented by the linker (`ld`) that turns a subset of the ELF‚Äôs data segments **—Ç—ñ–ª—å–∫–∏ –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö —Ä–µ–ª–æ–∫–∞—Ü—ñ–π**. –ú–µ—Ç–æ—é —î –ø–µ—Ä–µ—à–∫–æ–¥–∏—Ç–∏ –∞—Ç–∞–∫—É—é—á–æ–º—É –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å–∏ –≤ **GOT (Global Offset Table)** –∞–±–æ —ñ–Ω—à–∏—Ö —Ç–∞–±–ª–∏—Ü—è—Ö, –ø–æ–≤‚Äô—è–∑–∞–Ω–∏—Ö –∑ —Ä–µ–ª–æ–∫–∞—Ü—ñ—è–º–∏, –¥–æ —è–∫–∏—Ö –∑–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `__fini_array`).

–°—É—á–∞—Å–Ω—ñ –ª—ñ–Ω–∫–µ—Ä–∏ —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å RELRO —à–ª—è—Ö–æ–º **–ø–µ—Ä–µ–ø–æ—Ä—è–¥–∫—É–≤–∞–Ω–Ω—è** **GOT** (—Ç–∞ –∫—ñ–ª—å–∫–æ—Ö —ñ–Ω—à–∏—Ö —Å–µ–∫—Ü—ñ–π), —â–æ–± –≤–æ–Ω–∏ —Ä–æ–∑—Ç–∞—à–æ–≤—É–≤–∞–ª–∏—Å—è **–ø–µ—Ä–µ–¥** **.bss** —ñ ‚Äî —â–æ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–µ ‚Äî —à–ª—è—Ö–æ–º —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ `PT_GNU_RELRO`, —è–∫–∏–π –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π –ª–æ–∞–¥–µ—Ä –∑–∞—Å—Ç–æ—Å—É—î —Ä–µ–ª–æ–∫–∞—Ü—ñ—ó, –≤—ñ–¥–º–∞–ø–ª—é—î—Ç—å—Å—è —è–∫ `R‚ÄìX`. –í–Ω–∞—Å–ª—ñ–¥–æ–∫ —Ü—å–æ–≥–æ —Ç–∏–ø–æ–≤—ñ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ –≤ **.bss** –±—ñ–ª—å—à–µ –Ω–µ –º–æ–∂—É—Ç—å –¥—ñ—Å—Ç–∞—Ç–∏—Å—è –¥–æ GOT —ñ –ø—Ä–∏–º—ñ—Ç–∏–≤–∏ –¥–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –Ω–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É –≤–∫–∞–∑—ñ–≤–Ω–∏–∫—ñ–≤ –Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—ó, —â–æ –º—ñ—Å—Ç—è—Ç—å—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ, –∑–∞—Ö–∏—â–µ–Ω—ñ–π RELRO.

–Ü—Å–Ω—É—î **–¥–≤—ñ —Ä—ñ–≤–Ω—ñ** –∑–∞—Ö–∏—Å—Ç—É, —è–∫—ñ –º–æ–∂–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ª—ñ–Ω–∫–µ—Ä:

### Partial RELRO

* Produced with the flag `-Wl,-z,relro` (or just `-z relro` when invoking `ld` directly).
* Only the **non-PLT** part of the **GOT** (the part used for —Ä–µ–ª–æ–∫–∞—Ü—ñ–π –¥–∞–Ω–∏—Ö) is put into the read-only segment. Sections that need to be modified at run-time ‚Äì most importantly **.got.plt** which supports **lazy binding** ‚Äì remain writable.
* Because of that, an **arbitrary write** primitive can still redirect execution flow by overwriting a PLT entry (or by performing **ret2dlresolve**).
* The performance impact is negligible and therefore **almost every distribution has been shipping packages with at least Partial RELRO for years (it is the GCC/Binutils default as of 2016)**.

### Full RELRO

* Produced with **both** flags `-Wl,-z,relro,-z,now` (a.k.a. `-z relro -z now`). `-z now` forces the dynamic loader to resolve **all** symbols up-front (eager binding) so that **.got.plt** never needs to be written again and can safely be mapped read-only.
* The entire **GOT**, **.got.plt**, **.fini_array**, **.init_array**, **.preinit_array** and a few additional internal glibc tables end up inside a read-only `PT_GNU_RELRO` segment.
* Adds measurable start-up overhead (all dynamic relocations are processed at launch) but **no run-time overhead**.

Since 2023 several mainstream distributions have switched to compiling the **system tool-chain** (and most packages) with **Full RELRO by default** ‚Äì e.g. **Debian 12 ‚Äúbookworm‚Äù (dpkg-buildflags 13.0.0)** and **Fedora 35+**. As a pentester you should therefore expect to encounter binaries where **every GOT entry is read-only**.

---

## –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å RELRO —É binary
```bash
$ checksec --file ./vuln
[*] '/tmp/vuln'
Arch:     amd64-64-little
RELRO:    Full
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
```
`checksec` (—á–∞—Å—Ç–∏–Ω–∞ [pwntools](https://github.com/pwncollege/pwntools) —ñ –±–∞–≥–∞—Ç—å–æ—Ö –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—ñ–≤) –∞–Ω–∞–ª—ñ–∑—É—î –∑–∞–≥–æ–ª–æ–≤–∫–∏ `ELF` —ñ –≤–∏–≤–æ–¥–∏—Ç—å —Ä—ñ–≤–µ–Ω—å –∑–∞—Ö–∏—Å—Ç—É. –Ø–∫—â–æ –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `checksec`, –ø–æ–∫–ª–∞–¥–∞–π—Ç–µ—Å—å –Ω–∞ `readelf`:
```bash
# Partial RELRO ‚Üí PT_GNU_RELRO is present but BIND_NOW is *absent*
$ readelf -l ./vuln | grep -E "GNU_RELRO|BIND_NOW"
GNU_RELRO      0x0000000000600e20 0x0000000000600e20
```

```bash
# Full RELRO ‚Üí PT_GNU_RELRO *and* the DF_BIND_NOW flag
$ readelf -d ./vuln | grep BIND_NOW
0x0000000000000010 (FLAGS)              FLAGS: BIND_NOW
```
–Ø–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –∑–∞–ø—É—â–µ–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, set-uid root helper), –≤–∏ –≤—Å–µ —â–µ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª **—á–µ—Ä–µ–∑ `/proc/$PID/exe`**:
```bash
readelf -l /proc/$(pgrep helper)/exe | grep GNU_RELRO
```
## –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è RELRO –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó –≤–ª–∞—Å–Ω–æ–≥–æ code
```bash
# GCC example ‚Äì create a PIE with Full RELRO and other common hardenings
$ gcc -fPIE -pie -z relro -z now -Wl,--as-needed -D_FORTIFY_SOURCE=2 main.c -o secure
```
`-z relro -z now` –ø—Ä–∞—Ü—é—î –¥–ª—è –æ–±–æ—Ö **GCC/clang** (–ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è `-Wl,`) —ñ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –¥–ª—è **ld**. –ü—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ **CMake 3.18+** –≤–∏ –º–æ–∂–µ—Ç–µ —É–≤—ñ–º–∫–Ω—É—Ç–∏ Full RELRO –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç—É:
```cmake
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION ON) # LTO
set(CMAKE_ENABLE_EXPORTS OFF)
set(CMAKE_BUILD_RPATH_USE_ORIGIN ON)
set(CMAKE_EXE_LINKER_FLAGS "-Wl,-z,relro,-z,now")
```
---

## –ú–µ—Ç–æ–¥–∏ –æ–±—Ö–æ–¥—É

| RELRO level | Typical primitive | Possible exploitation techniques |
|-------------|-------------------|----------------------------------|
| –ù–µ–º–∞—î / –ß–∞—Å—Ç–∫–æ–≤–∏–π | Arbitrary write | 1. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ **.got.plt** entry —ñ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.<br>2. **ret2dlresolve** ‚Äì –∑–º–∞–π—Å—Ç—Ä—É–≤–∞—Ç–∏ —Ñ–µ–π–∫–æ–≤—ñ `Elf64_Rela` & `Elf64_Sym` –≤ –∑–∞–ø–∏—Å—É–≤–∞–Ω–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—ñ —ñ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `_dl_runtime_resolve`.<br>3. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏ —Ñ—É–Ω–∫—Ü—ñ–π —É **.fini_array** / —Å–ø–∏—Å–∫—É **atexit()**. |
| Full | GOT is read-only | 1. –®—É–∫–∞—Ç–∏ **—ñ–Ω—à—ñ –∑–∞–ø–∏—Å—É–≤–∞–Ω—ñ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏ –∫–æ–¥—É** (C++ vtables, `__malloc_hook` < glibc 2.34, `__free_hook`, callbacks —É –∫–∞—Å—Ç–æ–º–Ω–∏—Ö `.data` —Å–µ–∫—Ü—ñ—è—Ö, JIT —Å—Ç–æ—Ä—ñ–Ω–∫–∏).<br>2. –ó–ª–æ–≤–∂–∏–≤–∞—Ç–∏ *relative read* –ø—Ä–∏–º—ñ—Ç–∏–≤–∞–º–∏ —â–æ–± leaked libc —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏ **SROP/ROP into libc**.<br>3. –Ü–Ω–∂–µ–∫—Ç–∏—Ç–∏ –∑–ª–æ–≤–º–∏—Å–Ω–∏–π shared object —á–µ—Ä–µ–∑ **DT_RPATH**/`LD_PRELOAD` (—è–∫—â–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è –Ω–∞–ø–∞–¥–Ω–∏–∫–æ–º) –∞–±–æ **`ld_audit`**.<br>4. –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ **format-string** –∞–±–æ —á–∞—Å—Ç–∫–æ–≤–∏–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∞, —â–æ–± –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –±–µ–∑ –∑–º—ñ–Ω–∏ GOT. |

> üí° –ù–∞–≤—ñ—Ç—å –∑ Full RELRO **GOT –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö shared libraries (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ libc)** —î **–ª–∏—à–µ Partial RELRO**, –±–æ —Ü—ñ –æ–±'—î–∫—Ç–∏ –≤–∂–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω—ñ, –∫–æ–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —Ä–µ–ª–æ–∫–∞—Ü—ñ—ó. –Ø–∫—â–æ –≤–∏ –æ—Ç—Ä–∏–º—É—î—Ç–µ –ø—Ä–∏–º—ñ—Ç–∏–≤ arbitrary write, —è–∫–∏–π –º–æ–∂–µ —Ü—ñ–ª–∏—Ç–∏—Å—è –≤ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —ñ–Ω—à–æ–≥–æ shared object, –≤–∏ –≤—Å–µ –æ–¥–Ω–æ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤—à–∏ –∑–∞–ø–∏—Å–∏ GOT libc –∞–±–æ —Å—Ç–µ–∫ `__rtld_global` ‚Äî —Ç–µ—Ö–Ω—ñ–∫–∞, —è–∫—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ –µ–∫—Å–ø–ª—É–∞—Ç—É—é—Ç—å —É —Å—É—á–∞—Å–Ω–∏—Ö CTF-–∑–º–∞–≥–∞–Ω–Ω—è—Ö.

### –ü—Ä–∏–∫–ª–∞–¥ –æ–±—Ö–æ–¥—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —Å–≤—ñ—Ç—ñ (2024 CTF ‚Äì *pwn.college ‚Äúenlightened‚Äù*)

–ó–∞–≤–¥–∞–Ω–Ω—è –±—É–ª–æ –∑ Full RELRO. –ï–∫—Å–ø–ª–æ–π—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ **off-by-one** –¥–ª—è –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É heap chunk, leaked libc –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `tcache poisoning`, —ñ –≤—Ä–µ—à—Ç—ñ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤ `__free_hook` (–ø–æ–∑–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–º RELRO) –æ–¥–Ω–∏–º one-gadget –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É. –ó–∞–ø–∏—Å —É GOT –Ω–µ –∑–Ω–∞–¥–æ–±–∏–≤—Å—è.

---

## –û—Å—Ç–∞–Ω–Ω—ñ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è —Ç–∞ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ (2022-2025)

* **glibc hook removal (2.34 ‚Üí present)** ‚Äì malloc/free hooks –±—É–ª–∏ –≤–∏–Ω–µ—Å–µ–Ω—ñ –∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ libc –≤ –æ–ø—Ü—ñ–π–Ω–∏–π `libc_malloc_debug.so`, —â–æ —É—Å—É–Ω—É–ª–æ –ø–æ—à–∏—Ä–µ–Ω–∏–π –ø—Ä–∏–º—ñ—Ç–∏–≤ –æ–±—Ö–æ–¥—É Full‚ÄëRELRO; —Å—É—á–∞—Å–Ω—ñ –µ–∫—Å–ø–ª–æ–π—Ç–∏ –º–∞—é—Ç—å —Ü—ñ–ª–∏—Ç–∏—Å—å –≤ —ñ–Ω—à—ñ –∑–∞–ø–∏—Å—É–≤–∞–Ω—ñ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫–∏.
* **GNU ld RELRO page‚Äëalignment fix (binutils 2.39+/2.41)** ‚Äì –ø–æ–º–∏–ª–∫–∞ –ª—ñ–Ω–∫–µ—Ä–∞ 30612 —Å–ø—Ä–∏—á–∏–Ω—è–ª–∞, —â–æ –æ—Å—Ç–∞–Ω–Ω—ñ –±–∞–π—Ç–∏ `PT_GNU_RELRO` –¥—ñ–ª–∏–ª–∏ –∑–∞–ø–∏—Å—É–≤–∞–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ö –∑ 64‚ÄØKiB —Å—Ç–æ—Ä—ñ–Ω–∫–∞–º–∏; –ø–æ—Ç–æ—á–Ω—ñ binutils –≤–∏—Ä—ñ–≤–Ω—é—é—Ç—å RELRO –¥–æ `max-page-size`, –∑–∞–∫—Ä–∏–≤–∞—é—á–∏ —Ü—é ‚ÄúRELRO gap‚Äù.

---

## References

* [Why malloc hooks were removed from glibc](https://developers.redhat.com/articles/2021/08/25/securing-malloc-glibc-why-malloc-hooks-had-go)
* [Binutils bug 30612 ‚Äì RELRO end alignment](https://lists.gnu.org/archive/html/bug-binutils/2023-08/msg00305.html)

{{#include ../../banners/hacktricks-training.md}}
