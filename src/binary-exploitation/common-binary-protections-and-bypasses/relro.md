# Relro

{{#include ../../banners/hacktricks-training.md}}

## Relro

**RELRO** stands for **Relocation Read-Only** and it is a mitigation implemented by the linker (`ld`) that turns a subset of the ELFâ€™s data segments **read-only after all relocations have been applied**.  The goal is to stop an attacker from overwriting entries in the **GOT (Global Offset Table)** or other relocation-related tables that are dereferenced during program execution (e.g. `__fini_array`).

ç°ä»£é“¾æ¥å™¨é€šè¿‡**é‡æ–°æ’åˆ—** **GOT**ï¼ˆä»¥åŠå…¶ä»–ä¸€äº›èŠ‚ï¼‰ï¼Œä½¿å…¶ä½äº **.bss** ä¹‹å‰ï¼Œå¹¶â€”â€”æœ€é‡è¦çš„â€”â€”åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ `PT_GNU_RELRO` æ®µï¼Œè¯¥æ®µåœ¨åŠ¨æ€åŠ è½½å™¨å®Œæˆé‡å®šä½åç«‹å³è¢«æ˜ å°„ä¸º `Râ€“X`ã€‚å› æ­¤ï¼Œä½äº **.bss** çš„å…¸å‹ buffer overflows æ— æ³•å†åˆ°è¾¾ GOTï¼Œarbitraryâ€write primitives ä¹Ÿä¸èƒ½ç”¨äºè¦†ç›–ä½äº RELRO ä¿æŠ¤é¡µå†…çš„å‡½æ•°æŒ‡é’ˆã€‚

There are **two levels** of protection that the linker can emit:

### Partial RELRO

* Produced with the flag `-Wl,-z,relro` (or just `-z relro` when invoking `ld` directly).
* Only the **non-PLT** part of the **GOT** (the part used for data relocations) is put into the read-only segment.  Sections that need to be modified at run-time â€“ most importantly **.got.plt** which supports **lazy binding** â€“ remain writable.
* Because of that, an **arbitrary write** primitive can still redirect execution flow by overwriting a PLT entry (or by performing **ret2dlresolve**).
* The performance impact is negligible and therefore **almost every distribution has been shipping packages with at least Partial RELRO for years (it is the GCC/Binutils default as of 2016)**.

### Full RELRO

* Produced with **both** flags `-Wl,-z,relro,-z,now` (a.k.a. `-z relro -z now`).  `-z now` forces the dynamic loader to resolve **all** symbols up-front (eager binding) so that **.got.plt** never needs to be written again and can safely be mapped read-only.
* The entire **GOT**, **.got.plt**, **.fini_array**, **.init_array**, **.preinit_array** and a few additional internal glibc tables end up inside a read-only `PT_GNU_RELRO` segment.
* Adds measurable start-up overhead (all dynamic relocations are processed at launch) but **no run-time overhead**.

Since 2023 several mainstream distributions have switched to compiling the **system tool-chain** (and most packages) with **Full RELRO by default** â€“ e.g. **Debian 12 â€œbookwormâ€ (dpkg-buildflags 13.0.0)** and **Fedora 35+**.  As a pentester you should therefore expect to encounter binaries where **every GOT entry is read-only**.

---

## How to Check the RELRO status of a binary
```bash
$ checksec --file ./vuln
[*] '/tmp/vuln'
Arch:     amd64-64-little
RELRO:    Full
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
```
`checksec` (æ˜¯ [pwntools](https://github.com/pwncollege/pwntools) çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶åŒ…å«åœ¨è®¸å¤šå‘è¡Œç‰ˆä¸­) è§£æ `ELF` å¤´å¹¶æ‰“å°ä¿æŠ¤çº§åˆ«ã€‚ å¦‚æœä½ æ— æ³•ä½¿ç”¨ `checksec`ï¼Œè¯·ä½¿ç”¨ `readelf`ï¼š
```bash
# Partial RELRO â†’ PT_GNU_RELRO is present but BIND_NOW is *absent*
$ readelf -l ./vuln | grep -E "GNU_RELRO|BIND_NOW"
GNU_RELRO      0x0000000000600e20 0x0000000000600e20
```

```bash
# Full RELRO â†’ PT_GNU_RELRO *and* the DF_BIND_NOW flag
$ readelf -d ./vuln | grep BIND_NOW
0x0000000000000010 (FLAGS)              FLAGS: BIND_NOW
```
å¦‚æœäºŒè¿›åˆ¶æ­£åœ¨è¿è¡Œï¼ˆä¾‹å¦‚ set-uid root helperï¼‰ï¼Œä½ ä»ç„¶å¯ä»¥é€šè¿‡ **`/proc/$PID/exe`** æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ï¼š
```bash
readelf -l /proc/$(pgrep helper)/exe | grep GNU_RELRO
```
---

## åœ¨ç¼–è¯‘ä½ è‡ªå·±çš„ä»£ç æ—¶å¯ç”¨ RELRO
```bash
# GCC example â€“ create a PIE with Full RELRO and other common hardenings
$ gcc -fPIE -pie -z relro -z now -Wl,--as-needed -D_FORTIFY_SOURCE=2 main.c -o secure
```
`-z relro -z now` å¯¹ **GCC/clang**ï¼ˆåœ¨ `-Wl,` ä¹‹åä¼ é€’ï¼‰å’Œç›´æ¥å¯¹ **ld** éƒ½æœ‰æ•ˆã€‚ å½“ä½¿ç”¨ **CMake 3.18+** æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å†…ç½®é¢„è®¾è¯·æ±‚ Full RELROï¼š
```cmake
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION ON) # LTO
set(CMAKE_ENABLE_EXPORTS OFF)
set(CMAKE_BUILD_RPATH_USE_ORIGIN ON)
set(CMAKE_EXE_LINKER_FLAGS "-Wl,-z,relro,-z,now")
```
---

## ç»•è¿‡æŠ€å·§

| RELRO level | å…¸å‹åŸè¯­ | å¯èƒ½çš„åˆ©ç”¨æŠ€æœ¯ |
|-------------|-------------------|----------------------------------|
| None / Partial | Arbitrary write | 1. è¦†ç›– **.got.plt** æ¡ç›®å¹¶ pivot executionã€‚<br>2. **ret2dlresolve** â€“ åœ¨å¯å†™æ®µä¸­ä¼ªé€  `Elf64_Rela` & `Elf64_Sym` å¹¶è°ƒç”¨ `_dl_runtime_resolve`ã€‚<br>3. è¦†ç›– **.fini_array** / **atexit()** åˆ—è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚ |
| Full | GOT æ˜¯åªè¯»çš„ | 1. å¯»æ‰¾ **å…¶ä»–å¯å†™çš„ä»£ç æŒ‡é’ˆ** (C++ vtables, `__malloc_hook` < glibc 2.34, `__free_hook`, callbacks in custom `.data` sections, JIT pages)ã€‚<br>2. æ»¥ç”¨ *relative read* åŸè¯­æ¥ leak libc å¹¶æ‰§è¡Œ **SROP/ROP into libc**ã€‚<br>3. é€šè¿‡ **DT_RPATH**/`LD_PRELOAD`ï¼ˆå¦‚æœç¯å¢ƒå—æ”»å‡»è€…æ§åˆ¶ï¼‰æˆ– **`ld_audit`** æ³¨å…¥æ¶æ„å…±äº«å¯¹è±¡ã€‚<br>4. åˆ©ç”¨ **format-string** æˆ– partial pointer overwrite æ”¹å˜æ§åˆ¶æµè€Œæ— éœ€è§¦ç¢° GOTã€‚ |

> ğŸ’¡ å³ä¾¿åœ¨ Full RELRO ä¸‹ï¼Œ**å·²åŠ è½½å…±äº«åº“çš„ GOTï¼ˆä¾‹å¦‚ libc æœ¬èº«ï¼‰**ä»ç„¶æ˜¯ **only Partial RELRO**ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡åœ¨ loader åº”ç”¨é‡å®šä½æ—¶å·²ç»è¢«æ˜ å°„ã€‚å¦‚æœä½ è·å¾—äº†èƒ½å†™å…¥å…¶ä»–å…±äº«å¯¹è±¡é¡µé¢çš„ **arbitrary write** åŸè¯­ï¼Œä½ ä»ç„¶å¯ä»¥é€šè¿‡è¦†ç›– libc çš„ GOT æ¡ç›®æˆ– `__rtld_global` æ ˆæ¥ pivot executionï¼Œè¿™æ˜¯ä¸€ç§åœ¨ç°ä»£ CTF æŒ‘æˆ˜ä¸­ç»å¸¸è¢«åˆ©ç”¨çš„æŠ€æœ¯ã€‚

### çœŸå®ä¸–ç•Œç»•è¿‡ç¤ºä¾‹ (2024 CTF â€“ *pwn.college â€œenlightenedâ€*)

è¯¥é¢˜ç›®å¸¦æœ‰ Full RELROã€‚åˆ©ç”¨é“¾ä½¿ç”¨äº†ä¸€ä¸ª **off-by-one** ç ´åäº†å † chunk çš„å¤§å°ï¼Œé€šè¿‡ `tcache poisoning` leak äº† libcï¼Œæœ€åç”¨ one-gadget è¦†ç›–äº†ä½äº RELRO æ®µä¹‹å¤–çš„ `__free_hook` ä»¥è·å¾—ä»£ç æ‰§è¡Œã€‚æ— éœ€å†™å…¥ GOTã€‚

---

## è¿‘æœŸç ”ç©¶ä¸æ¼æ´ (2022-2025)

* **glibc hook removal (2.34 â†’ present)** â€“ malloc/free hooks ä»ä¸» libc ä¸­è¢«æŠ½ç¦»åˆ°å¯é€‰çš„ `libc_malloc_debug.so`ï¼Œæ¶ˆé™¤äº†ä¸€ä¸ªå¸¸è§çš„ Fullâ€‘RELRO ç»•è¿‡åŸè¯­ï¼›ç°ä»£åˆ©ç”¨å¿…é¡»é’ˆå¯¹å…¶ä»–å¯å†™æŒ‡é’ˆã€‚
* **GNU ld RELRO pageâ€‘alignment fix (binutils 2.39+/2.41)** â€“ linker bug 30612 å¯¼è‡´ `PT_GNU_RELRO` çš„æœ«å°¾å­—èŠ‚åœ¨ 64â€¯KiB é¡µé¢ç³»ç»Ÿä¸Šä¸ä¸€ä¸ªå¯å†™é¡µé¢å…±äº«ï¼›å½“å‰çš„ binutils å°† RELRO å¯¹é½åˆ° `max-page-size`ï¼Œä¿®è¡¥äº†è¯¥ â€œRELRO gapâ€ã€‚

---

## References

* [Why malloc hooks were removed from glibc](https://developers.redhat.com/articles/2021/08/25/securing-malloc-glibc-why-malloc-hooks-had-go)
* [Binutils bug 30612 â€“ RELRO end alignment](https://lists.gnu.org/archive/html/bug-binutils/2023-08/msg00305.html)

{{#include ../../banners/hacktricks-training.md}}
