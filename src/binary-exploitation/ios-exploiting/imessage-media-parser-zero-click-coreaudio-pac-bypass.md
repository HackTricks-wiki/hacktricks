# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → Abuso do CryptoTokenKit

{{#include ../../banners/hacktricks-training.md}}

Esta página resume uma superfície de ataque zero-click moderna no iOS e uma cadeia de exploração fim-a-fim observada que abusa do parsing automático de mídia do iMessage para comprometer o CoreAudio, contornar o BlastDoor, derrotar Pointer Authentication (PAC) via um caminho RPAC, escalar para o kernel e, finalmente, abusar do CryptoTokenKit para usos não autorizados de chaves.

> Aviso: Este é um resumo educacional para ajudar defensores, pesquisadores e red teams a entender as técnicas. Não use de forma ofensiva.

## Cadeia de alto nível

- Vetor de entrega: um anexo de áudio malicioso (por exemplo, .amr / MP4 AAC) enviado via iMessage/SMS.
- Auto-ingestão: o iOS analisa automaticamente mídias para pré-visualizações e conversões sem interação do usuário.
- Bug do parser: estruturas malformadas atingem o AudioConverterService do CoreAudio e corrompem a memória heap.
- Execução de código no contexto da mídia: RCE dentro do processo de parsing de mídia; relatado que contorna o isolamento do BlastDoor em caminhos específicos (por exemplo, o caminho de emolduramento “known sender”).
- Bypass PAC/RPAC: uma vez alcançado R/W arbitrário, um bypass PAC no caminho RPAC permite controle estável de fluxo sob arm64e PAC.
- Escalada para kernel: a cadeia converte execução em userland para execução no kernel (por exemplo, via caminhos de código wireless/AppleBCMWLAN e manejo de AMPDU, como visto nos logs abaixo).
- Pós-exploração: com acesso ao kernel, abusar do CryptoTokenKit para realizar assinaturas com chaves suportadas pelo Secure Enclave, ler caminhos de dados sensíveis (contextos do Keychain), interceptar mensagens/2FA, autorizar ações silenciosamente e habilitar vigilância furtiva (mic/camera/GPS) sem prompts.

## Observações sobre a superfície de ataque iMessage/BlastDoor

BlastDoor é um serviço endurecido projetado para analisar conteúdo de mensagens não confiáveis. Contudo, logs observados indicam caminhos onde as proteções podem ser contornadas quando mensagens são enquadradas como vindas de um “known sender” e quando filtros adicionais (por exemplo, Blackhole) são relaxados:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Conclusões:
- Auto-parsing ainda representa uma superfície de ataque remota, zero-click.
- Decisões de política/contexto (known sender, filtering state) podem alterar materialmente o isolamento efetivo.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

Componente afetado:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 parsing and conversion flows

Ponto de contato do parser observado (logs):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- Metadados de container/codec malformados (por exemplo, magic cookie inválido/curto/NULL) causam uma corrupção de memória durante o setup do decode.
- Dispara na iMessage media conversion path sem interações do usuário.
- Gera execução de código no processo de parsing de mídia. O write-up afirma que isso escapa BlastDoor no caminho de entrega observado, habilitando a próxima etapa.

Practical tips:
- Fuzz AAC/AMR magic cookie and MP4 codec atoms quando mirando conversões do AudioConverterService.
- Foque em heap overflows/underflows, OOB reads/writes, e confusão de size/length ao redor da inicialização do decoder.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) impede o hijacking de return addresses e function pointers. A cadeia relata derrotar o PAC usando um RPAC path uma vez que arbitrary read/write está disponível.

Key idea:
- Com arbitrary R/W, atacantes podem criar pointers válidos re-signed ou pivotar execução para caminhos PAC-tolerant. O chamado “RPAC path” permite controle de fluxo sob as restrições do PAC, transformando um userland RCE em uma configuração confiável de kernel exploit.

Notes for researchers:
- Colete info leaks para contornar KASLR e estabilizar cadeias ROP/JOP mesmo sob PAC.
- Mire em pontos de chamada que geram ou autenticam PAC de maneiras controláveis (por exemplo, assinaturas geradas sobre valores controlados pelo atacante, context keys previsíveis, ou sequências de gadgets que re-sign pointers).
- Espere variância nas hardening da Apple por SoC/OS; a confiabilidade depende de leaks, entropia e primitivos robustos.

## Kernel escalation: wireless/AMPDU path example

Na cadeia observada, uma vez em userland com corrupção de memória e um primitive de PAC bypass, o controle do kernel foi alcançado via code paths na pilha Wi‑Fi (AppleBCMWLAN) sob tratamento malformado de AMPDU. Example logs:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
Técnica geral:
- Use primitivas userland para construir kernel R/W ou caminhos de chamada controlados.
- Abusar de superfícies de kernel acessíveis (IOKit, networking/AMPDU, media shared memory, Mach interfaces) para obter kernel PC control ou acesso a memória arbitrária.
- Estabilize construindo read/write primitives e contornando as restrições PPL/SPTM quando aplicável.

## Post-exploitation: CryptoTokenKit e abuso de identity/signing

Uma vez que o kernel está comprometido, processos como identityservicesd podem ser personificados e operações criptográficas privilegiadas invocadas via CryptoTokenKit sem solicitações ao usuário. Exemplos de logs:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impacto:
- Usar chaves com suporte do Secure Enclave para assinaturas não autorizadas (tokens, mensagens, pagamentos), quebrando modelos de confiança mesmo se as chaves não forem exportadas.
- Interceptar códigos/mensagens 2FA silenciosamente; autorizar pagamentos/transferências; habilitar microfone/câmera/GPS furtivos.

Defensive angle:
- Trate quebras de integridade pós-kernel como catastróficas: impor runtime attestation para consumidores CTK; minimizar ambient authority; verificar entitlements no ponto de uso.

## Reproduction and telemetry hints (lab only)

- Delivery: enviar um áudio AMR/MP4-AAC criado para o dispositivo alvo via iMessage/SMS.
- Observe telemetry for the foregoing log lines around parsing and wireless stack reactions.
- Ensure devices are fully patched; only test in isolated lab setups.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain; keep devices up to date.
- Parser hardening: validação estrita para codec cookies/atoms e comprimentos; caminhos de decodificação defensivos com checagens de limites.
- iMessage isolation: evitar relaxar BlastDoor/Blackhole em contextos de “known sender” para parsing de mídia.
- PAC hardening: reduzir disponibilidade de PAC-gadget; garantir que assinaturas estejam vinculadas a contextos imprevisíveis; remover padrões PAC-tolerant que permitam bypass.
- CryptoTokenKit: exigir post-kernel attestation e entitlements fortes em tempo de chamada para operações vinculadas a chaves.
- Kernel surfaces: fortalecer o tratamento de wireless AMPDU/status; minimizar entradas controladas pelo atacante do userland após comprometimento.

## Affected versions (as reported)

- iOS 18.x anteriores a iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
