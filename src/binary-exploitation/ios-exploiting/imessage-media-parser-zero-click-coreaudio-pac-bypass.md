# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

This page summarizes a modern iOS zero-click attack surface and an observed end-to-end exploitation chain abusing iMessage automatic media parsing to compromise CoreAudio, bypass BlastDoor, defeat Pointer Authentication (PAC) via an RPAC path, escalate to kernel, and finally abuse CryptoTokenKit for unauthorized key uses.

> Warning: This is an educational summary to help defenders, researchers, and red teams understand the techniques. Do not use offensively.

## High-level chain

- Delivery vector: a malicious audio attachment (e.g., .amr / MP4 AAC) sent via iMessage/SMS.
- Auto-ingestion: iOS auto-parses media for previews and conversions without user interaction.
- Parser bug: malformed structures hit CoreAudio’s AudioConverterService and corrupt heap memory.
- Code exec in media context: RCE inside the media parsing process; reported to bypass BlastDoor isolation in specific paths (e.g., “known sender” framing path).
- PAC/RPAC bypass: once arbitrary R/W is achieved, a PAC bypass in the RPAC path enables stable control flow under arm64e PAC.
- Kernel escalation: the chain converts userland exec into kernel exec (e.g., via wireless/AppleBCMWLAN code paths and AMPDU handling as seen in logs below).
- Post-exploitation: with kernel, abuse CryptoTokenKit to perform signing with Secure Enclave–backed keys, read sensitive data paths (Keychain contexts), intercept messages/2FA, silently authorize actions, and enable stealth surveillance (mic/camera/GPS) without prompts.

## iMessage/BlastDoor attack surface notes

BlastDoor is a hardened service designed to parse untrusted message content. However, observed logs indicate paths where protections may be bypassed when messages are framed from a “known sender” and when additional filters (e.g., Blackhole) are relaxed:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Висновки:
- Автоматичний парсинг все ще представляє віддалену, zero-click поверхню атаки.
- Рішення щодо політики/контексту (відомий відправник, стан фільтрації) можуть суттєво змінити ефективну ізоляцію.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

Затронутий компонент:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 parsing and conversion flows

Спостережувана точка взаємодії парсера (логи):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Коротко про техніку:
- Неправильні метадані контейнера/codec (наприклад, invalid/short/NULL magic cookie) спричиняють пошкодження пам'яті під час налаштування декодування.
- Тригериться в iMessage media conversion path без взаємодії користувача.
- Призводить до code execution у процесі парсингу медіа. Автори вказують, що це обходить BlastDoor у спостережуваному шляху доставки, дозволяючи наступний етап.

Практичні поради:
- Fuzz AAC/AMR magic cookie та MP4 codec atoms при націлюванні на AudioConverterService conversions.
- Зосередьтеся на heap overflows/underflows, OOB reads/writes та size/length confusion навколо decoder initialization.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) перешкоджає перехопленню адрес повернення та вказівників функцій. У ланцюжку повідомляють про подолання PAC за допомогою RPAC path після отримання можливостей arbitrary read/write.

Ключова ідея:
- З можливістю arbitrary R/W атакувальники можуть створювати валідні, re-signed pointers або pivot execution до PAC-tolerant шляхів. Так званий “RPAC path” дозволяє control-flow в межах PAC-обмежень, перетворюючи userland RCE на надійну схему для kernel exploit.

Примітки для дослідників:
- Збирайте info leaks щоб обійти KASLR і стабілізувати ROP/JOP ланцюги навіть під PAC.
- Націлюйтесь на callsites, що генерують або authenticate PAC у контрольований спосіб (наприклад, signatures згенеровані на attacker-controlled значеннях, predictable context keys, або gadget sequences, які re-sign pointers).
- Очікуйте, що ступінь hardening від Apple варіюється за SoC/OS; надійність залежить від leaks, entropy та надійних primitives.

## Kernel escalation: wireless/AMPDU path example

У спостережуваному ланцюжку, коли в userland вже мала місце memory corruption та PAC bypass primitive, контроль над kernel було досягнуто через code paths у Wi‑Fi stack (AppleBCMWLAN) при неправильній обробці AMPDU. Приклад логів:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
Загальна техніка:
- Використовувати userland primitives для побудови kernel R/W або контрольованих шляхів виклику.
- Зловживати reachable kernel surfaces (IOKit, networking/AMPDU, media shared memory, Mach interfaces) для досягнення контролю kernel PC або доступу до довільної пам'яті.
- Стабілізувати шляхом побудови read/write primitives та обходу обмежень PPL/SPTM там, де це застосовно.

## Пост-експлуатація: CryptoTokenKit та зловживання identity/signing

Після компрометації ядра, процеси на кшталт identityservicesd можуть бути підроблені, і привілейовані криптографічні операції можуть бути викликані через CryptoTokenKit без запитів від користувача. Приклад логів:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Вплив:
- Використання ключів, підкріплених Secure Enclave, для несанкціонованого підписування (токени, повідомлення, платежі), що порушує моделі довіри навіть якщо ключі не експортовано.
- Тихо перехоплювати 2FA-коди/повідомлення; авторизовувати платежі/перекази; активувати прихований мікрофон/камеру/GPS.

Оборонний підхід:
- Розглядати порушення цілісності після kernel як катастрофічні: вимагати атестацію під час виконання для CTK-клієнтів; мінімізувати навколишні повноваження (ambient authority); перевіряти entitlements у момент використання.

## Reproduction and telemetry hints (lab only)

- Delivery: send a crafted AMR/MP4-AAC audio to the target device via iMessage/SMS.
- Observe telemetry for the foregoing log lines around parsing and wireless stack reactions.
- Ensure devices are fully patched; only test in isolated lab setups.

## Пом'якшення та ідеї жорсткого захисту

- Patch level: iOS 18.4.1 reportedly fixes this chain; keep devices up to date.
- Parser hardening: strict validation for codec cookies/atoms and lengths; defensive decoding paths with bounds checks.
- iMessage isolation: avoid relaxing BlastDoor/Blackhole in “known sender” contexts for media parsing.
- PAC hardening: reduce PAC-gadget availability; ensure signatures are bound to unpredictable contexts; remove PAC-tolerant bypassable patterns.
- CryptoTokenKit: require post-kernel attestation and strong entitlements at call-time for key-bound operations.
- Kernel surfaces: harden wireless AMPDU/status handling; minimize attacker-controlled inputs from userland after compromise.

## Уражені версії (за повідомленнями)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## Посилання

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
