# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit の悪用

{{#include ../../banners/hacktricks-training.md}}

> 警告: これは防御者、研究者、レッドチームが手法を理解するための教育的要約です。攻撃目的で使用しないでください。

## 高レベルのチェーン

- Delivery vector: a malicious audio attachment (e.g., .amr / MP4 AAC) sent via iMessage/SMS.
- 自動取り込み：iOSはユーザー操作なしにプレビューや変換のためにメディアを自動解析する。
- パーサのバグ：破損した構造がCoreAudioのAudioConverterServiceに到達し、ヒープメモリを破壊する。
- メディアコンテキストでのコード実行：メディア解析プロセス内でのRCE。特定の経路（例：「既知の送信者」フレーミング経路）でBlastDoorの隔離を回避すると報告されている。
- PAC/RPAC バイパス：任意のR/Wを獲得すると、RPAC経路のPACバイパスによりarm64e PAC下での安定した制御フローが可能になる。
- カーネル権限昇格：このチェーンはユーザーランドの実行をカーネル実行に変換する（例：wireless/AppleBCMWLANのコード経路や下記ログに見られるAMPDU処理を介して）。
- ポストエクスプロイト：カーネル取得後、CryptoTokenKitを悪用してSecure Enclave対応キーでの署名を行い、機密データ経路（Keychainコンテキスト）を読み取り、メッセージ/2FAを傍受し、ユーザー操作なしにアクションを静かに承認し、プロンプトなしでステルス監視（マイク/カメラ/GPS）を可能にする。

## iMessage/BlastDoor の攻撃面に関する注意

BlastDoorは信頼されていないメッセージコンテンツを解析するために強化されたサービスです。しかし、観測されたログは、メッセージが「既知の送信者」からフレーミングされ、追加フィルタ（例：Blackhole）が緩められた場合に保護がバイパスされ得る経路を示しています：
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
要点:
- Auto-parsing は依然として remote、zero-click attack surface を表す。
- ポリシー／コンテキストの判断（known sender、filtering state）は実効的な隔離を実質的に変えうる。

## CoreAudio: AudioConverterService ヒープ破壊 (userland RCE)

影響を受けるコンポーネント:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 のパースおよび変換フロー

観測されたパーサの接点（ログ）:
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- 破損したコンテナ/コーデックのメタデータ（例: 無効/短い/NULL magic cookie）がデコードセットアップ中にメモリ破損を引き起こす。
- ユーザーのタップなしに iMessage のメディア変換パスでトリガーされる。
- メディアパースプロセスでコード実行をもたらす。観測された配信経路ではこれが BlastDoor を回避すると報告されており、次段階を可能にする。

Practical tips:
- AudioConverterService の変換をターゲットにする場合は、AAC/AMR magic cookie と MP4 codec atoms をファズすること。
- decoder initialization 周辺での heap overflows/underflows、OOB reads/writes、サイズ/長さの混同に注力する。

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) はリターンアドレスや関数ポインタのハイジャックを妨げる。チェーンは、任意の読み書きが利用可能になった後に RPAC 経路を用いて PAC を攻略したと報告している。

Key idea:
- 任意の R/W があれば、攻撃者は有効な再署名済みポインタを作成したり、PAC に耐性のある経路に実行をピボットしたりできる。いわゆる “RPAC path” は PAC 制約下での制御フローを可能にし、userland の RCE を信頼性のあるカーネルエクスプロイトのセットアップに変える。

Notes for researchers:
- KASLR を無効化し、PAC 下でも ROP/JOP chains を安定化させるために info leaks を収集する。
- 攻撃者が制御できる方法で PAC を生成または認証する callsites を狙う（例: 攻撃者制御の値に対して生成される signatures、予測可能な context keys、ポインタを再署名する gadget シーケンスなど）。
- SoC/OS による Apple のハードニングの違いを想定すること。信頼性は leaks、エントロピー、頑健な primitives に依存する。

## Kernel escalation: wireless/AMPDU path example

観測されたチェーンでは、memory corruption と PAC bypass primitive を持って userland に入ると、malformed AMPDU 処理下の Wi‑Fi スタック (AppleBCMWLAN) のコードパスを介してカーネル制御が達成された。例としてログ:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
General technique:
- userland プリミティブを使って kernel R/W や制御された呼び出し経路を構築する。
- 到達可能なカーネルの表面（IOKit、networking/AMPDU、media shared memory、Mach interfaces）を悪用して kernel PC control や arbitrary memory を達成する。
- 読み/書きプリミティブを構築し、適用可能な場合は PPL/SPTM 制約を突破して安定化させる。

## Post-exploitation: CryptoTokenKit and identity/signing abuse

カーネルが侵害されると、identityservicesd のようなプロセスを偽装し、ユーザーの許可を求めるプロンプトなしに CryptoTokenKit を介して特権のある暗号操作を呼び出すことが可能になる。例示ログ：
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impact:
- Use Secure Enclave–backed keys for unauthorized signing (tokens, messages, payments), breaking trust models even if keys are not exported.
- Intercept 2FA codes/messages silently; authorize payments/transfers; enable stealth mic/camera/GPS.

Defensive angle:
- Treat post-kernel integrity breaks as catastrophic: enforce runtime attestation for CTK consumers; minimize ambient authority; verify entitlements at the point of use.

## Reproduction and telemetry hints (lab only)

- Delivery: send a crafted AMR/MP4-AAC audio to the target device via iMessage/SMS.
- Observe telemetry for the foregoing log lines around parsing and wireless stack reactions.
- Ensure devices are fully patched; only test in isolated lab setups.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain; keep devices up to date.
- Parser hardening: strict validation for codec cookies/atoms and lengths; defensive decoding paths with bounds checks.
- iMessage isolation: avoid relaxing BlastDoor/Blackhole in “known sender” contexts for media parsing.
- PAC hardening: reduce PAC-gadget availability; ensure signatures are bound to unpredictable contexts; remove PAC-tolerant bypassable patterns.
- CryptoTokenKit: require post-kernel attestation and strong entitlements at call-time for key-bound operations.
- Kernel surfaces: harden wireless AMPDU/status handling; minimize attacker-controlled inputs from userland after compromise.

## Affected versions (as reported)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
