# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

Αυτή η σελίδα συνοψίζει μια σύγχρονη επίθεση zero-click σε iOS και μια παρατηρούμενη αλυσίδα εκμετάλλευσης end-to-end που καταχράται την αυτοματοποιημένη ανάλυση μέσων του iMessage για να υπονομεύσει το CoreAudio, να παρακάμψει το BlastDoor, να νικήσει το Pointer Authentication (PAC) μέσω μονοπατιού RPAC, να κλιμακώσει σε kernel και τελικώς να καταχραστεί το CryptoTokenKit για μη εξουσιοδοτημένες χρήσεις κλειδιών.

> Προειδοποίηση: Αυτή είναι μια εκπαιδευτική σύνοψη για να βοηθήσει αμυντικούς, ερευνητές και red teams να κατανοήσουν τις τεχνικές. Μην τη χρησιμοποιήσετε επιθετικά.

## Αλυσίδα υψηλού επιπέδου

- Μέσο παράδοσης: ένα κακόβουλο audio attachment (π.χ., .amr / MP4 AAC) αποσταλμένο μέσω iMessage/SMS.
- Αυτόματη επεξεργασία: το iOS αναλύει αυτόματα μέσα για προεπισκοπήσεις και μετατροπές χωρίς αλληλεπίδραση χρήστη.
- Σφάλμα του parser: κακοσχηματισμένες δομές πλήττουν το CoreAudio’s AudioConverterService και καταστρέφουν τη heap μνήμη.
- Εκτέλεση κώδικα στο πλαίσιο μέσων: RCE εντός της διαδικασίας ανάλυσης μέσων· αναφέρθηκε ότι παρακάμπτει την απομόνωση του BlastDoor σε συγκεκριμένα μονοπάτια (π.χ., το framing path «known sender»).
- PAC/RPAC bypass: μόλις επιτευχθεί αυθαίρετο R/W, μια παράκαμψη PAC στο RPAC μονοπάτι επιτρέπει σταθερό control flow υπό arm64e PAC.
- Κλιμάκωση σε kernel: η αλυσίδα μετατρέπει την εκτέλεση σε userland σε εκτέλεση σε kernel (π.χ., μέσω ασύρματων/AppleBCMWLAN code paths και χειρισμού AMPDU όπως φαίνεται σε logs παρακάτω).
- Μετα-εκμετάλλευση: με kernel, καταχράται το CryptoTokenKit για εκτέλεση signing με κλειδιά υποστηριζόμενα από Secure Enclave, ανάγνωση ευαίσθητων διαδρομών δεδομένων (Keychain contexts), υποκλοπή μηνυμάτων/2FA, σιωπηρή εξουσιοδότηση ενεργειών, και ενεργοποίηση αποκρυφίας παρακολούθησης (mic/camera/GPS) χωρίς προτροπές.

## iMessage/BlastDoor attack surface notes

BlastDoor είναι μια σκληρυμένη υπηρεσία σχεδιασμένη να αναλύει μη αξιόπιστο περιεχόμενο μηνυμάτων. Ωστόσο, παρατηρούμενα logs υποδεικνύουν μονοπάτια όπου οι προστασίες ενδέχεται να παρακαμφθούν όταν τα μηνύματα πλαισιώνονται από έναν «known sender» και όταν χαλαρώνουν επιπλέον φίλτρα (π.χ., Blackhole):
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Συμπεράσματα:
- Η αυτόματη ανάλυση εξακολουθεί να αποτελεί απομακρυσμένη επιφάνεια επίθεσης zero-click.
- Οι αποφάσεις πολιτικής/πλαισίου (γνωστός αποστολέας, κατάσταση φιλτραρίσματος) μπορούν να αλλάξουν ουσιωδώς την αποτελεσματική απομόνωση.

## CoreAudio: AudioConverterService διαφθορά του heap (userland RCE)

Επηρεαζόμενο στοιχείο:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 ροές ανάλυσης και μετατροπής

Παρατηρούμενο σημείο επαφής του parser (logs):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- Malformed container/codec metadata (e.g., invalid/short/NULL magic cookie) προκαλεί memory corruption κατά τη διάρκεια του decode setup.
- Ενεργοποιείται στην iMessage media conversion path χωρίς taps από τον χρήστη.
- Παράγει code execution στη media parsing process. Το write-up ισχυρίζεται ότι αυτό ξεφεύγει από το BlastDoor στη παρατηρούμενη delivery path, επιτρέποντας το επόμενο στάδιο.

Practical tips:
- Fuzz AAC/AMR magic cookie and MP4 codec atoms όταν στοχεύετε AudioConverterService conversions.
- Επικεντρωθείτε σε heap overflows/underflows, OOB reads/writes, και size/length confusion γύρω από τη decoder initialization.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) εμποδίζει το hijacking των return addresses και των function pointers. Η αλυσίδα αναφέρει ότι νικάει το PAC χρησιμοποιώντας ένα RPAC path μόλις είναι διαθέσιμο arbitrary read/write.

Key idea:
- Με arbitrary R/W, οι επιτιθέμενοι μπορούν να δημιουργήσουν έγκυρους, re-signed pointers ή να pivot την εκτέλεση σε PAC-tolerant paths. Το λεγόμενο “RPAC path” επιτρέπει control-flow υπό PAC constraints, μετατρέποντας ένα userland RCE σε αξιόπιστο kernel exploit setup.

Notes for researchers:
- Συλλέξτε info leaks για να νικήσετε το KASLR και να σταθεροποιήσετε ROP/JOP chains ακόμη και υπό PAC.
- Στοχεύστε callsites που δημιουργούν ή authenticate το PAC με ελεγχόμενους τρόπους (π.χ., signatures που παράγονται σε attacker-controlled values, predictable context keys, ή gadget sequences που re-sign pointers).
- Αναμείνατε variance στην Apple hardening ανά SoC/OS· η αξιοπιστία εξαρτάται από leaks, entropy, και robust primitives.

## Kernel escalation: wireless/AMPDU path example

Στην παρατηρούμενη αλυσίδα, μόλις βρεθείτε στο userland με memory corruption και ένα PAC bypass primitive, ο έλεγχος του kernel επιτεύχθηκε μέσω code paths στο Wi‑Fi stack (AppleBCMWLAN) υπό malformed AMPDU handling. Example logs:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
General technique:
- Χρησιμοποιήστε userland primitives για να δημιουργήσετε kernel R/W ή ελεγχόμενες call paths.
- Καταχραστείτε reachable kernel surfaces (IOKit, networking/AMPDU, media shared memory, Mach interfaces) για να αποκτήσετε kernel PC control ή arbitrary memory.
- Σταθεροποιήστε δημιουργώντας read/write primitives και παρακάμπτοντας τους περιορισμούς PPL/SPTM όπου εφαρμόζεται.

## Post-exploitation: CryptoTokenKit and identity/signing abuse

Μόλις το kernel έχει παραβιαστεί, διεργασίες όπως identityservicesd μπορούν να μιμηθούν και προνομιούχες κρυπτογραφικές λειτουργίες να κληθούν μέσω CryptoTokenKit χωρίς προτροπές από τον χρήστη. Παραδείγματα logs:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Επιπτώσεις:
- Use Secure Enclave–backed keys για μη εξουσιοδοτημένη υπογραφή (tokens, messages, payments), σπάζοντας τα μοντέλα εμπιστοσύνης ακόμη και αν τα κλειδιά δεν έχουν εξαχθεί.
- Υποκλοπή 2FA codes/messages σιωπηλά; εξουσιοδότηση πληρωμών/μεταφορών; ενεργοποίηση stealth mic/camera/GPS.

Αμυντική προσέγγιση:
- Αντιμετωπίστε τις post-kernel integrity breaks ως καταστροφικές: επιβάλλετε runtime attestation για CTK consumers· ελαχιστοποιήστε την ambient authority· επαληθεύστε τα entitlements στο σημείο χρήσης.

## Reproduction and telemetry hints (lab only)

- Delivery: στείλτε ένα crafted AMR/MP4-AAC audio στη συσκευή-στόχο μέσω iMessage/SMS.
- Παρατηρήστε την τηλεμετρία για τις προαναφερθείσες γραμμές καταγραφής γύρω από parsing και τις αντιδράσεις του wireless stack.
- Βεβαιωθείτε ότι οι συσκευές είναι πλήρως patched· δοκιμάστε μόνο σε απομονωμένα εργαστηριακά περιβάλλοντα.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain· κρατήστε τις συσκευές ενημερωμένες.
- Parser hardening: αυστηρή επικύρωση για codec cookies/atoms και μήκη· αμυντικές διαδρομές αποκωδικοποίησης με bounds checks.
- iMessage isolation: αποφύγετε τη χαλάρωση των BlastDoor/Blackhole σε “known sender” contexts για media parsing.
- PAC hardening: μειώστε τη διαθεσιμότητα PAC-gadget· διασφαλίστε ότι οι υπογραφές δεσμεύονται σε μη προβλέψιμα contexts· αφαιρέστε PAC-tolerant πρότυπα που επιτρέπουν bypass.
- CryptoTokenKit: απαιτήστε post-kernel attestation και ισχυρά entitlements κατά το call-time για key-bound operations.
- Kernel surfaces: σκληραγώγηση του wireless AMPDU/status handling· ελαχιστοποιήστε τα attacker-controlled inputs από userland μετά από compromise.

## Affected versions (as reported)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
