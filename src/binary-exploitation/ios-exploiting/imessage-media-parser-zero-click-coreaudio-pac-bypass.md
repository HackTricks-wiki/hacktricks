# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

Ukurasa huu unatoa muhtasari wa uso wa shambulio wa kisasa wa iOS wa zero-click na mnyororo wa ukiukaji ulioonekana kutoka mwishoni-mwisho ukitumia iMessage automatic media parsing kuathiri CoreAudio, kupita BlastDoor, kuvunja Pointer Authentication (PAC) kupitia njia ya RPAC, kupandisha hadhi hadi kernel, na hatimaye kutumia CryptoTokenKit kwa matumizi ya funguo bila idhini.

> Tahadhari: Huu ni muhtasari wa kielimu kusaidia walinzi, watafiti, na timu za red kuelewa mbinu hizi. Usitumie kwa lengo la kushambulia.

## Mnyororo wa juu

- Delivery vector: a malicious audio attachment (e.g., .amr / MP4 AAC) sent via iMessage/SMS.
- Auto-ingestion: iOS huchambaza media kiotomatiki kwa ajili ya mapitio na uongofu bila mwingiliano wa mtumiaji.
- Parser bug: malformed structures hit CoreAudio’s AudioConverterService and corrupt heap memory.
- Code exec in media context: RCE inside the media parsing process; reported to bypass BlastDoor isolation in specific paths (e.g., “known sender” framing path).
- PAC/RPAC bypass: once arbitrary R/W is achieved, a PAC bypass in the RPAC path enables stable control flow under arm64e PAC.
- Kernel escalation: the chain converts userland exec into kernel exec (e.g., via wireless/AppleBCMWLAN code paths and AMPDU handling as seen in logs below).
- Post-exploitation: with kernel, abuse CryptoTokenKit to perform signing with Secure Enclave–backed keys, read sensitive data paths (Keychain contexts), intercept messages/2FA, silently authorize actions, and enable stealth surveillance (mic/camera/GPS) without prompts.

## iMessage/BlastDoor attack surface notes

BlastDoor ni huduma iliyokazwa (hardened) iliyoundwa kuchambaza maudhui ya ujumbe yasiyotegemewa. Hata hivyo, log zilizobainika zinaonyesha njia ambapo ulinzi unaweza kuvukwa wakati ujumbe unaframed kutoka kwa “known sender” na wakati vichujio vya ziada (mf., Blackhole) vinaporuhusiwa kupunguzwa:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Vidokezo:
- Auto-parsing bado inawakilisha eneo la shambulio la mbali, zero-click.
- Maamuzi ya policy/muktadha (known sender, filtering state) yanaweza kubadilisha kwa kiasi kikubwa ulinzi uliotekelezwa.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

Sehemu zilizoathiriwa:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 parsing and conversion flows

Mahali parser ilipotambuliwa (logs):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Muhtasari wa mbinu:
- metadata ya container/codec iliyopotoka (mfano, invalid/short/NULL magic cookie) husababisha memory corruption wakati wa decode setup.
- Inasababisha katika iMessage media conversion path bila taps kutoka kwa mtumiaji.
- Hutoa code execution katika media parsing process. The write-up inadai hili linavuka BlastDoor katika observed delivery path, kuruhusu hatua inayofuata.

Practical tips:
- Fuzz AAC/AMR magic cookie and MP4 codec atoms when targeting AudioConverterService conversions.
- Zingatia heap overflows/underflows, OOB reads/writes, na size/length confusion kuhusu decoder initialization.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) inazuia hijacking ya return addresses na function pointers. Mnyororo uliripoti kuvunja PAC kwa kutumia RPAC path mara arbitrary read/write inapatikana.

Wazo kuu:
- Kwa arbitrary R/W, attackers wanaweza kutengeneza pointers sahihi, zimesigned tena, au kupindisha execution kwenda PAC-tolerant paths. The so-called “RPAC path” inaruhusu control-flow chini ya vizingiti vya PAC, ikigeuza userland RCE kuwa setup imara ya kernel exploit.

Vidokezo kwa watafiti:
- Kusanya info leaks ili kuzuia KASLR na kuimarisha ROP/JOP chains hata chini ya PAC.
- Lenga callsites zinazozalisha au kuthibitisha PAC kwa njia zinazodhibitiwa (mfano, signatures generated on attacker-controlled values, predictable context keys, au gadget sequences ambazo re-sign pointers).
- Tarajia variance ya Apple hardening kwa SoC/OS; reliability inategemea leaks, entropy, na robust primitives.

## Kernel escalation: wireless/AMPDU path example

Katika mnyororo uliotazamwa, mara baada ya kuwa userland na memory corruption na PAC bypass primitive, udhibiti wa kernel ulipatikana kupitia code paths katika Wi‑Fi stack (AppleBCMWLAN) chini ya malformed AMPDU handling. Example logs:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
Mbinu za jumla:
- Tumia userland primitives kujenga kernel R/W au controlled call paths.
- Tumia vibaya reachable kernel surfaces (IOKit, networking/AMPDU, media shared memory, Mach interfaces) ili kupata kernel PC control au arbitrary memory.
- Imarisha kwa kujenga read/write primitives na kuvuka vizingiti vya PPL/SPTM pale inapofaa.

## Post-exploitation: CryptoTokenKit and identity/signing abuse

Mara kernel inapopatikana, mchakato kama identityservicesd unaweza kuigizwa na operesheni za cryptographic zenye vipaumbele zinaweza kuitwa kupitia CryptoTokenKit bila maonyo kwa mtumiaji. Mifano ya logs:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impact:
- Tumia funguo zinazotegemea Secure Enclave kwa kusaini bila idhini (tokeni, ujumbe, malipo), ukivunja miundo ya uaminifu hata kama funguo hazikutolewa.
- Piga intercept misimbo/ujumbe za 2FA kimyakimya; idhinisha malipo/uhamisho; wezesha kipaza sauti/kamera/GPS kimyakimya.

Defensive angle:
- Chukulia uvunjaji wa uadilifu baada ya kernel kama tukio la hatari kubwa: lazima uthibitisho wa runtime kwa watumiaji wa CTK; punguza ambient authority; thibitisha entitlements mahali pa matumizi.

## Reproduction and telemetry hints (lab only)

- Delivery: tuma sauti iliyotengenezwa AMR/MP4-AAC kwa kifaa lengwa kupitia iMessage/SMS.
- Angalia telemetry kwa mistari ya log zilizotajwa zinazohusu parsing na majibu ya wireless stack.
- Hakikisha vifaa vimepachikwa kikamilifu; jaribu tu katika mazingira ya maabara yaliyotengwa.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 inaripotiwa kurekebisha mnyororo huu; weka vifaa vikiwa hivi karibuni.
- Parser hardening: uthibitishaji mkali kwa codec cookies/atoms na urefu; njia za defensive decoding zenye ukaguzi wa mipaka.
- iMessage isolation: epuka kupunguza BlastDoor/Blackhole katika muktadha wa “known sender” kwa uchambuzi wa media.
- PAC hardening: punguza upatikanaji wa PAC-gadget; hakikisha saini zinahusishwa na muktadha usiotabirika; ondoa miundo inayovumilia PAC inayoweza kupitishwa.
- CryptoTokenKit: hitaji post-kernel attestation na entitlements thabiti wakati wa kuitwa kwa shughuli zinazohusisha funguo.
- Kernel surfaces: imarisha kushughulikia wireless AMPDU/status; punguza pembejeo zinazodhibitiwa na mshambuliaji kutoka userland baada ya uharibifu.

## Affected versions (as reported)

- iOS 18.x kabla ya iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
