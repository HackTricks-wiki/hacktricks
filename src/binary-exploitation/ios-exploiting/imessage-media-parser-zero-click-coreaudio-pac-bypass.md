# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

Ova stranica sažima moderan iOS zero-click attack surface i zapaženi end-to-end exploitation chain koji zloupotrebljava iMessage automatic media parsing da kompromituje CoreAudio, zaobiđe BlastDoor, porazi Pointer Authentication (PAC) putem RPAC puta, eskalira na kernel, i na kraju zloupotrebi CryptoTokenKit za neovlašćene upotrebe ključeva.

> Upozorenje: Ovo je edukativni sažetak da pomogne defenderima, researcherima i red timovima da razumeju tehnike. Ne koristiti u ofanzivne svrhe.

## Pregled lanca

- Vektor isporuke: zlonamerni audio prilog (npr. .amr / MP4 AAC) poslat putem iMessage/SMS.
- Automatsko preuzimanje: iOS automatski parsira medije za prikaze i konverzije bez interakcije korisnika.
- Bag u parseru: malformirane strukture pogađaju CoreAudio’s AudioConverterService i korumpiraju heap memoriju.
- Izvršavanje koda u kontekstu medija: RCE unutar procesa parsiranja medija; prijavljeno da zaobilazi BlastDoor izolaciju na specifičnim putevima (npr. “known sender” framing path).
- PAC/RPAC bypass: nakon što se postigne proizvoljno R/W, PAC bypass u RPAC putu omogućava stabilnu kontrolu toka izvršavanja pod arm64e PAC.
- Eskalacija na kernel: lanac konvertuje userland exec u kernel exec (npr. preko wireless/AppleBCMWLAN code paths i AMPDU obrade kao što se vidi u logovima ispod).
- Post-eksploatacija: uz kernel, zloupotrebi CryptoTokenKit da izvrši potpisivanje sa Secure Enclave–backed ključevima, čita osetljive putanje podataka (Keychain contexts), presreće poruke/2FA, tiho autorizuje akcije i omogućava prikrivenu nadzornu aktivnost (mic/camera/GPS) bez promptova.

## iMessage/BlastDoor attack surface notes

BlastDoor je ojačana usluga dizajnirana da parsira nepouzdan sadržaj poruka. Međutim, posmatrani logovi ukazuju na puteve gde se zaštite mogu zaobići kada su poruke označene kao “known sender” i kada su dodatni filteri (npr. Blackhole) ublaženi:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Zaključci:
- Auto-parsing i dalje predstavlja remote, zero-click attack surface.
- Policy/context odluke (known sender, filtering state) mogu materijalno promeniti efektivnu izolaciju.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

Pogođena komponenta:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 parsing and conversion flows

Posmatrana tačka dodira parsera (logovi):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- Neispravno container/codec metadata (npr. invalid/short/NULL magic cookie) izaziva memory corruption tokom decode setup.
- Okidači u iMessage media conversion path bez ikakve interakcije korisnika.
- Dovodi do code execution u media parsing procesu. Write-up tvrdi da ovo zaobilazi BlastDoor u posmatranom delivery path, omogućavajući sledeću fazu.

Practical tips:
- Fuzzuj AAC/AMR magic cookie i MP4 codec atoms kada ciljaš AudioConverterService conversions.
- Fokusiraj se na heap overflows/underflows, OOB reads/writes, i size/length confusion oko inicijalizacije dekodera.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) otežava hijacking of return addresses i function pointers. U lancu je izveštano da se PAC savladava koristeći RPAC path čim postane dostupno arbitrary read/write.

Key idea:
- Sa arbitrary R/W, napadači mogu konstruisati validne, re-signed pointers ili pivotirati izvršavanje na PAC-tolerantne puteve. Takozvani “RPAC path” omogućava control-flow unutar PAC ograničenja, pretvarajući userland RCE u pouzdano kernel exploit okruženje.

Notes for researchers:
- Prikupite info leaks da bi porazili KASLR i stabilizovali ROP/JOP chains čak i pod PAC.
- Ciljajte callsite-ove koji generišu ili autentifikuju PAC na kontrolisan način (npr. signatures generisane na attacker-controlled vrednostima, predictable context keys, ili gadget sekvence koje re-sign pointers).
- Očekujte varijacije Apple hardening-a po SoC/OS; pouzdanost zavisi od leaks, entropije i robusnih primitives.

## Kernel escalation: wireless/AMPDU path example

U posmatranom lancu, nakon što se uđe u userland sa memory corruption i PAC bypass primitive, kontrola nad kernelom je ostvarena putem code paths u Wi‑Fi stacku (AppleBCMWLAN) pod malformed AMPDU handling. Example logs:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
Opšti pristup:
- Koristite userland primitives da izgradite kernel R/W ili kontrolisane call paths.
- Zloupotrebite dostupne kernel površine (IOKit, networking/AMPDU, media shared memory, Mach interfaces) da biste ostvarili kernel PC control ili proizvoljnu memoriju.
- Stabilizujte tako što ćete izgraditi read/write primitives i zaobići PPL/SPTM ograničenja gde je primenljivo.

## Post-eksploatacija: CryptoTokenKit i zloupotreba identiteta/potpisivanja

Kada je kernel kompromitovan, procesi poput identityservicesd mogu biti lažno predstavljeni i privilegovane kriptografske operacije pozvane putem CryptoTokenKit bez korisničkih upita. Primer logova:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impact:
- Koristiti Secure Enclave–backed ključeve za neautorizovano potpisivanje (tokens, messages, payments), što narušava modele poverenja čak i ako ključevi nisu izvezeni.
- Presretati 2FA kodove/poruke tiho; odobravati uplate/transferе; omogućiti prikriveni mikrofon/kameru/GPS.

Defensive angle:
- Smatrati kršenje integriteta nakon kernela katastrofičnim: primenjivati runtime attestation za CTK consumers; minimizirati ambient authority; verifikovati entitlements na mestu upotrebe.

## Reproduction and telemetry hints (lab only)

- Delivery: pošaljite crafted AMR/MP4-AAC audio na ciljnu napravu preko iMessage/SMS.
- Posmatrajte telemetriju za gore navedene log linije vezane za parsiranje i reakcije wireless stack-a.
- Osigurajte da su uređaji potpuno patchovani; testirajte samo u izolovanim laboratorijskim okruženjima.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain; držite uređaje ažurnim.
- Parser hardening: stroga validacija codec cookies/atoms i dužina; defanzivni dekoderski putevi sa bounds checks.
- iMessage isolation: izbegavati opuštanje BlastDoor/Blackhole u kontekstima poznatog pošiljaoca za parsiranje medija.
- PAC hardening: smanjiti dostupnost PAC-gadgeta; osigurati da su potpisi vezani za nepredvidive kontekste; ukloniti PAC-tolerantne obrasce koji se mogu zaobići.
- CryptoTokenKit: zahtevati post-kernel attestation i jake entitlements pri pozivu za operacije vezane za ključeve.
- Kernel surfaces: ojačati rukovanje wireless AMPDU/status; minimizirati unose kontrolisane od napadača iz userlanda nakon kompromitacije.

## Affected versions (as reported)

- iOS 18.x pre iOS 18.4.1 (16. april 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path i kernel eskalacija putem AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
