# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit 滥用

{{#include ../../banners/hacktricks-training.md}}

本页总结了现代 iOS zero-click 攻击面以及一个观测到的端到端利用链：滥用 iMessage 的自动媒体解析来攻破 CoreAudio、绕过 BlastDoor、通过 RPAC 路径击败 Pointer Authentication (PAC)、升级到 kernel，最后滥用 CryptoTokenKit 进行未经授权的密钥使用。

> 警告：这是一个教育性摘要，旨在帮助防御者、研究人员和红队理解这些技术。请勿用于攻击性用途。

## 高级攻击链

- 投递向量：一个恶意的音频附件（例如 .amr / MP4 AAC），通过 iMessage/SMS 发送。
- 自动摄取：iOS 在无用户交互的情况下自动解析媒体以生成预览和转换。
- 解析器漏洞：畸形结构触发 CoreAudio 的 AudioConverterService 并破坏堆内存。
- 媒体上下文中的代码执行：在媒体解析进程内的 RCE；有报告称在特定路径（例如 “known sender” 构帧路径）可绕过 BlastDoor 隔离。
- PAC/RPAC 绕过：一旦达到任意读写，RPAC 路径中的 PAC 绕过可在 arm64e PAC 下实现稳定的控制流。
- 内核提权：该链将用户态执行转换为内核态执行（例如通过 wireless/AppleBCMWLAN 代码路径和日志中可见的 AMPDU 处理）。
- 后利用：获得内核后，滥用 CryptoTokenKit 使用受 Secure Enclave 支持的密钥进行签名、读取敏感数据路径（Keychain 上下文）、拦截消息/2FA、静默授权操作，并在无提示情况下启用隐蔽监控（mic/camera/GPS）。

## iMessage/BlastDoor 攻击面说明

BlastDoor 是一个为解析不受信任的消息内容而强化的服务。但观察到的日志表明，在消息来自“known sender”并且额外过滤（例如 Blackhole）被放宽的情况下，可能存在可绕过保护的路径：
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
要点:
- 自动解析仍然代表一个远程、zero-click 攻击面。
- 策略/上下文决策（已知发送者、过滤状态）会实质性改变实际隔离效果。

## CoreAudio: AudioConverterService heap corruption (userland RCE)

受影响的组件：
- CoreAudio → AudioConverterService → AAC/AMR/MP4 解析与转换流程

观察到的解析器接触点（日志）：
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- 损坏的容器/codec 元数据（例如 无效/过短/NULL magic cookie）会在解码设置阶段导致内存损坏。
- 在 iMessage 媒体转换路径中触发，无需用户点击。
- 在媒体解析进程中导致代码执行。该报告声称在观察到的投递路径中可突破 BlastDoor，从而使后续阶段成为可能。

Practical tips:
- 在针对 AudioConverterService 转换时，Fuzz AAC/AMR magic cookie 和 MP4 codec atoms。
- 关注解码器初始化期间的 heap overflows/underflows、OOB reads/writes，以及大小/长度混淆问题。

## 通过 RPAC 路径绕过 PAC (CVE-2025-31201)

arm64e Pointer Authentication (PAC) 阻碍对返回地址和函数指针的劫持。该链条报告一旦可用任意读/写，就使用 RPAC 路径绕过 PAC。

Key idea:
- 使用任意 R/W 时，攻击者可以制作有效的、重新签名的指针，或将执行枢转到对 PAC 兼容的路径。所谓的 “RPAC path” 在 PAC 约束下实现对控制流的控制，将 userland RCE 转变为可靠的内核利用准备。

Notes for researchers:
- 收集 info leaks 以击败 KASLR，并在 PAC 下稳定 ROP/JOP 链。
- 针对以可控方式生成或认证 PAC 的 callsite（例如基于攻击者控制的值生成的签名、可预测的上下文密钥，或重新签名指针的 gadget 序列）。
- 预期 Apple 在不同 SoC/OS 上的加固存在差异；可靠性取决于 leaks、熵和强健的原语。

## Kernel escalation: wireless/AMPDU path example

在观察到的链中，一旦在 userland 获取到内存损坏和 PAC 绕过原语，就通过 Wi‑Fi 堆栈（AppleBCMWLAN）中对 AMPDU 处理不当的代码路径实现了内核控制。示例日志：
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
通用技术：
- 使用 userland primitives 构建 kernel R/W 或受控的调用路径。
- 滥用可达的 kernel 表面（IOKit、networking/AMPDU、media shared memory、Mach interfaces）以获得 kernel PC 控制或 arbitrary memory。
- 通过构建 read/write primitives 并在适用时绕过 PPL/SPTM 限制来实现稳定性。

## 利用后：CryptoTokenKit 与 身份/签名 滥用

一旦 kernel 被攻破，像 identityservicesd 这样的进程可以被冒充，并可通过 CryptoTokenKit 调用有特权的加密操作而无需用户提示。示例日志：
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
影响：
- 使用 Secure Enclave–backed 密钥进行未授权签名（tokens、messages、payments），即使密钥未被导出也会破坏信任模型。
- 静默拦截 2FA codes/messages；授权支付/转账；启用隐蔽 mic/camera/GPS。

防御角度：
- 将 post-kernel integrity breaks 视为灾难性事件：对 CTK consumers 强制运行时 attestation；最小化 ambient authority；在使用点验证 entitlements。

## Reproduction and telemetry hints (lab only)

- Delivery: 通过 iMessage/SMS 向目标设备发送精心构造的 AMR/MP4-AAC audio。
- Observe telemetry for the foregoing log lines around parsing and wireless stack reactions.
- Ensure devices are fully patched；仅在隔离的实验室环境中测试。

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain；保持设备更新。
- Parser hardening: 对 codec cookies/atoms 和长度进行严格验证；在解码路径中采用带边界检查的防御性解码。
- iMessage isolation: 避免在 “known sender” 场景下放宽 BlastDoor/Blackhole 对媒体解析的限制。
- PAC hardening: 减少 PAC-gadget 的可用性；确保签名绑定到不可预测的上下文；移除可被绕过的 PAC-tolerant 模式。
- CryptoTokenKit: 要求对与密钥绑定的操作在调用时进行 post-kernel attestation 并具备强制的 entitlements。
- Kernel surfaces: 加强无线 AMPDU/status 处理；在被攻破后将 userland 可控输入降到最低。

## Affected versions (as reported)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
