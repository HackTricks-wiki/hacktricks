# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abus

{{#include ../../banners/hacktricks-training.md}}

Cette page résume une surface d'attaque iOS zero-click moderne et une chaîne d'exploitation de bout en bout observée abusant du parsing automatique des médias iMessage pour compromettre CoreAudio, bypasser BlastDoor, vaincre Pointer Authentication (PAC) via un chemin RPAC, escalader au kernel, et enfin abuser CryptoTokenKit pour des usages de clés non autorisés.

> Avertissement : Ceci est un résumé éducatif pour aider les défenseurs, chercheurs et red teams à comprendre les techniques. Ne pas utiliser à des fins offensives.

## Chaîne de haut niveau

- Delivery vector : une pièce jointe audio malveillante (p.ex., .amr / MP4 AAC) envoyée via iMessage/SMS.
- Ingestion automatique : iOS parse automatiquement les médias pour les aperçus et conversions sans interaction utilisateur.
- Bug du parseur : des structures malformées atteignent AudioConverterService de CoreAudio et corrompent la mémoire heap.
- Exécution de code dans le contexte média : RCE à l'intérieur du processus de parsing média ; rapporté pour bypasser l'isolation de BlastDoor dans des chemins spécifiques (p.ex., le framing path “known sender”).
- PAC/RPAC bypass : une fois un R/W arbitraire obtenu, un PAC bypass dans le chemin RPAC permet un contrôle de flux stable sous arm64e PAC.
- Escalade au Kernel : la chaîne convertit l'exécution userland en exécution kernel (p.ex., via les code paths wireless/AppleBCMWLAN et le traitement AMPDU comme vu dans les logs ci‑dessous).
- Post-exploitation : avec le kernel, abuser CryptoTokenKit pour signer avec des clés protégées par Secure Enclave, lire des chemins de données sensibles (contextes Keychain), intercepter messages/2FA, autoriser silencieusement des actions, et activer une surveillance furtive (micro/caméra/GPS) sans invites.

## iMessage/BlastDoor attack surface notes

BlastDoor est un service renforcé conçu pour parser du contenu de message non fiable. Cependant, des logs observés indiquent des chemins où les protections peuvent être bypassed lorsque les messages sont framés depuis un “known sender” et quand des filtres additionnels (p.ex., Blackhole) sont relâchés :
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Points clés :
- L'auto-parsing représente toujours une surface d'attaque distante, zero-click.
- Les décisions de politique/contexte (expéditeur connu, état du filtrage) peuvent modifier de manière significative l'isolation effective.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

Composant affecté :
- CoreAudio → AudioConverterService → flux d'analyse et de conversion AAC/AMR/MP4

Point de contact observé du parser (logs) :
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- Des métadonnées de conteneur/codec malformées (par ex., magic cookie invalide/court/NULL) provoquent une corruption mémoire lors de la configuration du décodeur.
- Déclenchements dans le chemin de conversion média iMessage sans taps de l'utilisateur.
- Donne une exécution de code dans le processus d'analyse média. Le write-up affirme que cela échappe à BlastDoor dans le chemin de livraison observé, permettant l'étape suivante.

Practical tips:
- Fuzz les magic cookie AAC/AMR et les atoms de codec MP4 lorsque vous ciblez les conversions AudioConverterService.
- Concentrez-vous sur heap overflows/underflows, OOB reads/writes, et les confusions de taille/longueur autour de l'initialisation du décodeur.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) empêche le détournement des adresses de retour et des pointeurs de fonction. La chaîne rapporte avoir vaincu PAC en utilisant un RPAC path une fois qu'un accès lecture/écriture arbitraire est disponible.

Key idea:
- Avec un R/W arbitraire, les attaquants peuvent fabriquer des pointeurs valides re-signed ou pivoter l'exécution vers des chemins tolérants PAC. Le soi-disant “RPAC path” permet le contrôle de flux sous contraintes PAC, transformant une userland RCE en une configuration d'exploit kernel fiable.

Notes for researchers:
- Collectez des info leaks pour vaincre KASLR et stabiliser les chaînes ROP/JOP même sous PAC.
- Ciblez les callsites qui génèrent ou authentifient PAC de manière contrôlable (par ex., signatures générées sur des valeurs contrôlées par l'attaquant, predictable context keys, ou séquences de gadgets qui re-sign pointers).
- Attendez-vous à une variance des hardening Apple selon le SoC/OS ; la fiabilité dépend des leaks, de l'entropie et de primitives robustes.

## Kernel escalation: wireless/AMPDU path example

Dans la chaîne observée, une fois en userland avec une corruption mémoire et une primitive de contournement PAC, le contrôle du kernel a été obtenu via des chemins de code dans la pile Wi‑Fi (AppleBCMWLAN) sous un traitement AMPDU malformé. Example logs:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
Technique générale :
- Utiliser des userland primitives pour construire un kernel R/W ou des chemins d'appel contrôlés.
- Abuser des surfaces kernel accessibles (IOKit, networking/AMPDU, media shared memory, Mach interfaces) pour obtenir le contrôle du PC du kernel ou un accès mémoire arbitraire.
- Stabiliser en construisant des primitives de lecture/écriture et en contournant les contraintes PPL/SPTM lorsque applicable.

## Post-exploitation : CryptoTokenKit et abus d'identity/signing

Une fois le kernel compromis, des processus comme identityservicesd peuvent être usurpés et des opérations cryptographiques privilégiées invoquées via CryptoTokenKit sans invite utilisateur. Exemples de logs :
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impact:
- Utiliser des clés protégées par le Secure Enclave pour des signatures non autorisées (tokens, messages, paiements), rompant les modèles de confiance même si les clés ne sont pas exportées.
- Intercepter silencieusement les codes/messages 2FA ; autoriser paiements/transferts ; activer micro/caméra/GPS furtifs.

Defensive angle:
- Considérer les ruptures d'intégrité post-kernel comme catastrophiques : appliquer l'attestation d'exécution pour les consommateurs CTK ; minimiser l'autorité ambiante ; vérifier les entitlements au point d'utilisation.

## Reproduction and telemetry hints (lab only)

- Delivery: envoyer un audio AMR/MP4-AAC spécialement conçu vers l'appareil cible via iMessage/SMS.
- Observer la télémétrie pour les lignes de log ci-dessus autour du parsing et des réactions de la pile sans fil.
- S'assurer que les appareils sont entièrement patched ; tester uniquement dans des environnements de laboratoire isolés.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain ; maintenir les appareils à jour.
- Parser hardening: validation stricte pour codec cookies/atoms et longueurs ; chemins de décodage défensifs avec vérifications de bornes.
- iMessage isolation: éviter d'assouplir BlastDoor/Blackhole dans les contextes “known sender” pour le parsing des médias.
- PAC hardening: réduire la disponibilité des PAC-gadgets ; s'assurer que les signatures sont liées à des contextes imprévisibles ; supprimer les patterns tolérants au PAC susceptibles d'être contournés.
- CryptoTokenKit: exiger une attestation post-kernel et des entitlements stricts au moment de l'appel pour les opérations liées aux clés.
- Kernel surfaces: durcir la gestion AMPDU/status sans fil ; minimiser les entrées contrôlées par un attaquant depuis userland après compromission.

## Affected versions (as reported)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
