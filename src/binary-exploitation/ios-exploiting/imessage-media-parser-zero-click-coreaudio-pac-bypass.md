# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

This page summarizes a modern iOS zero-click attack surface and an observed end-to-end exploitation chain abusing iMessage automatic media parsing to compromise CoreAudio, bypass BlastDoor, defeat Pointer Authentication (PAC) via an RPAC path, escalate to kernel, and finally abuse CryptoTokenKit for unauthorized key uses.

> चेतावनी: यह एक शैक्षणिक सारांश है ताकि defenders, researchers, और red teams इन तकनीकों को समझ सकें। इसका आक्रामक उपयोग न करें।

## उच्च-स्तरीय श्रृंखला

- डिलीवरी वेक्टर: एक malicious audio attachment (e.g., .amr / MP4 AAC) जो iMessage/SMS के माध्यम से भेजा जाता है।
- Auto-ingestion: iOS उपयोगकर्ता की किसी क्रिया के बिना previews और conversions के लिए मीडिया को auto-parse करता है।
- Parser bug: malformed structures CoreAudio’s AudioConverterService को प्रभावित करती हैं और heap memory को corrupt कर देती हैं।
- मीडिया संदर्भ में Code exec: media parsing process के अंदर RCE; रिपोर्ट है कि यह विशिष्ट paths में BlastDoor isolation को bypass कर सकता है (e.g., “known sender” framing path)।
- PAC/RPAC bypass: एक बार arbitrary R/W हासिल हो जाने पर, RPAC path में PAC bypass arm64e PAC के तहत स्थिर control flow सक्षम करता है।
- Kernel escalation: यह श्रृंखला userland exec को kernel exec में बदल देती है (e.g., wireless/AppleBCMWLAN code paths और AMPDU handling के माध्यम से जैसा कि नीचे लॉग्स में देखा गया है)।
- Post-exploitation: kernel के साथ, CryptoTokenKit का दुरुपयोग करके Secure Enclave–backed keys के साथ signing करना, sensitive data paths (Keychain contexts) पढ़ना, messages/2FA को intercept करना, silently actions को authorize करना, और बिना prompts के stealth surveillance (mic/camera/GPS) सक्षम करना।

## iMessage/BlastDoor हमला सतह नोट्स

BlastDoor एक hardened service है जो untrusted message content को parse करने के लिए डिज़ाइन की गई है। हालांकि, observed logs यह संकेत देते हैं कि कुछ paths ऐसे हैं जहाँ protections bypass हो सकती हैं जब messages “known sender” से framed हों और जब अतिरिक्त filters (e.g., Blackhole) relaxed हों:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
निष्कर्ष:
- Auto-parsing अब भी एक remote, zero-click attack surface का प्रतिनिधित्व करता है।
- नीति/संदर्भ निर्णय (known sender, filtering state) प्रभावी अलगाव को महत्वपूर्ण रूप से बदल सकते हैं।

## CoreAudio: AudioConverterService heap corruption (userland RCE)

प्रभावित घटक:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 parsing and conversion flows

प्रेक्षित parser touchpoint (logs):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- त्रुटिपूर्ण container/codec metadata (उदा., invalid/short/NULL magic cookie) decode setup के दौरान memory corruption पैदा करता है।
- उपयोगकर्ता के टैप किए बिना iMessage media conversion path में ट्रिगर होते हैं।
- media parsing process में code execution मिलता है। write-up का दावा है कि यह देखे गए delivery path में BlastDoor से बचकर अगला चरण सक्षम करता है।

Practical tips:
- Fuzz AAC/AMR magic cookie और MP4 codec atoms जब लक्ष्य AudioConverterService conversions हों।
- decoder initialization के आसपास heap overflows/underflows, OOB reads/writes, और size/length confusion पर ध्यान केंद्रित करें।

## RPAC path के माध्यम से PAC बायपास (CVE-2025-31201)

arm64e Pointer Authentication (PAC) return addresses और function pointers के hijacking को रोकता है। चेन बताती है कि एक बार arbitrary read/write उपलब्ध होने पर RPAC path का उपयोग करके PAC को पराजित किया जा सकता है।

Key idea:
- arbitrary R/W होने पर, हमलावर वैध, re-signed pointers तैयार कर सकते हैं या execution को PAC-tolerant paths पर pivot कर सकते हैं। तथाकथित “RPAC path” PAC प्रतिबंधों के तहत control-flow सक्षम करता है, जिससे userland RCE एक विश्वसनीय kernel exploit setup बन जाता है।

Notes for researchers:
- KASLR को हराने और PAC के तहत भी ROP/JOP chains को स्थिर करने के लिए info leaks इकट्ठा करें।
- उन callsites को target करें जो controllable तरीकों से PAC जनरेट या authenticate करते हैं (उदा., signatures generated on attacker-controlled values, predictable context keys, या gadget sequences जो pointers को re-sign करते हैं)।
- SoC/OS के अनुसार Apple hardening में भिन्नता की उम्मीद रखें; विश्वसनीयता leaks, entropy, और robust primitives पर निर्भर करती है।

## Kernel escalation: wireless/AMPDU path example

देखे गए चेन में, एक बार userland में memory corruption और PAC bypass primitive होने पर, kernel control Wi‑Fi stack (AppleBCMWLAN) के code paths के माध्यम से malformed AMPDU handling में प्राप्त किया गया। उदाहरण लॉग:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
General technique:
- userland primitives का उपयोग करके kernel R/W या controlled call paths बनाएं।
- पहुँच योग्य kernel surfaces (IOKit, networking/AMPDU, media shared memory, Mach interfaces) का दुरुपयोग करके kernel PC control या arbitrary memory हासिल करें।
- जहाँ लागू हो, read/write primitives बनाकर और PPL/SPTM constraints को हराकर स्थिरता हासिल करें।

## Post-exploitation: CryptoTokenKit and identity/signing abuse

एक बार kernel compromised हो जाने पर, identityservicesd जैसे processes की impersonation की जा सकती है और CryptoTokenKit के माध्यम से privileged cryptographic operations बिना user prompts के invoke किए जा सकते हैं। उदाहरण लॉग:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
प्रभाव:
- Secure Enclave–backed keys का उपयोग अनधिकृत signing के लिए (tokens, messages, payments), जिससे विश्वास मॉडल टूटते हैं भले ही keys export न हों।
- 2FA codes/messages को चुपके से intercept कर सकते हैं; payments/transfers को authorize कर सकते हैं; stealth mic/camera/GPS को सक्षम कर सकते हैं।

रक्षा का दृष्टिकोण:
- post-kernel integrity breaks को विनाशकारी मानें: CTK consumers के लिए runtime attestation लागू करें; ambient authority को न्यूनतम करें; उपयोग के बिंदु पर entitlements को verify करें।

## पुनरुत्पादन और टेलीमेट्री संकेत (केवल प्रयोगशाला)

- Delivery: लक्ष्य डिवाइस पर iMessage/SMS के माध्यम से एक crafted AMR/MP4-AAC ऑडियो भेजें।
- parsing और wireless stack प्रतिक्रियाओं के आसपास के उपरोक्त log lines के लिए telemetry देखें।
- सुनिश्चित करें कि डिवाइस पूरी तरह patched हों; केवल अलग-थलग lab सेटअप में ही परीक्षण करें।

## निवारण और हार्डनिंग विचार

- Patch level: iOS 18.4.1 कथित तौर पर इस chain को फिक्स करता है; डिवाइसों को अपडेट रखें।
- Parser hardening: codec cookies/atoms और lengths के लिए कड़ी validation; bounds checks के साथ defensive decoding paths।
- iMessage isolation: media parsing के लिए “known sender” contexts में BlastDoor/Blackhole को relaxing करने से बचें।
- PAC hardening: PAC-gadget की उपलब्धता कम करें; सुनिश्चित करें कि signatures अनपेक्षित contexts से बंधे हों; PAC-tolerant bypassable patterns को हटाएँ।
- CryptoTokenKit: key-bound operations के लिए call-time पर post-kernel attestation और मजबूत entitlements की आवश्यकता रखें।
- Kernel surfaces: wireless AMPDU/status handling को harden करें; compromise के बाद userland से attacker-controlled inputs को न्यूनतम करें।

## प्रभावित संस्करण (रिपोर्ट के अनुसार)

- iOS 18.x prior to iOS 18.4.1 (16 April, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
