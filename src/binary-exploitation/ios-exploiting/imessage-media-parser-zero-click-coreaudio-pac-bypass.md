# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

이 페이지는 iMessage의 자동 미디어 파싱을 악용해 CoreAudio를 손상시키고 BlastDoor를 우회하며 Pointer Authentication(PAC)을 RPAC 경로로 무력화하고 커널로 상승한 뒤 CryptoTokenKit을 악용하는 현대적인 iOS 제로-클릭 공격 표면과 관찰된 종단 간 익스플로잇 체인을 요약합니다.

> 경고: 본 내용은 방어자, 연구자, 레드팀이 기법을 이해하도록 돕기 위한 교육용 요약입니다. 공격 목적으로 사용하지 마십시오.

## High-level chain

- Delivery vector: a malicious audio attachment (e.g., .amr / MP4 AAC) sent via iMessage/SMS.
  - 전달 벡터: iMessage/SMS로 전송된 악성 오디오 첨부 파일(예: .amr / MP4 AAC).
- Auto-ingestion: iOS auto-parses media for previews and conversions without user interaction.
  - 자동 수집: iOS가 사용자 상호작용 없이 미리보기 및 변환을 위해 미디어를 자동으로 파싱합니다.
- Parser bug: malformed structures hit CoreAudio’s AudioConverterService and corrupt heap memory.
  - 파서 버그: 잘못된 구조가 CoreAudio의 AudioConverterService에 도달하여 힙 메모리를 손상시킵니다.
- Code exec in media context: RCE inside the media parsing process; reported to bypass BlastDoor isolation in specific paths (e.g., “known sender” framing path).
  - 미디어 컨텍스트에서의 코드 실행: 미디어 파싱 프로세스 내부의 RCE; 특정 경로(예: “known sender” 프레이밍 경로)에서 BlastDoor 격리를 우회한다고 보고됨.
- PAC/RPAC bypass: once arbitrary R/W is achieved, a PAC bypass in the RPAC path enables stable control flow under arm64e PAC.
  - PAC/RPAC 우회: 임의 R/W를 획득한 후 RPAC 경로에서의 PAC 우회로 arm64e PAC 하에서 안정적인 제어 흐름을 확보합니다.
- Kernel escalation: the chain converts userland exec into kernel exec (e.g., via wireless/AppleBCMWLAN code paths and AMPDU handling as seen in logs below).
  - 커널 권한 상승: 이 체인은 userland 실행을 커널 실행으로 전환합니다(예: 아래 로그에서 보이는 wireless/AppleBCMWLAN 코드 경로 및 AMPDU 처리 등을 통해).
- Post-exploitation: with kernel, abuse CryptoTokenKit to perform signing with Secure Enclave–backed keys, read sensitive data paths (Keychain contexts), intercept messages/2FA, silently authorize actions, and enable stealth surveillance (mic/camera/GPS) without prompts.
  - 사후 악용: 커널 권한을 획득하면 CryptoTokenKit을 악용해 Secure Enclave 기반 키로 서명하고, 민감한 데이터 경로(Keychain 컨텍스트)를 읽으며, 메시지/2FA를 가로채고, 사용자 프롬프트 없이 행동을 은밀히 승인하거나 마이크/카메라/GPS를 이용한 은밀한 감시를 수행할 수 있습니다.

## iMessage/BlastDoor attack surface notes

BlastDoor is a hardened service designed to parse untrusted message content. However, observed logs indicate paths where protections may be bypassed when messages are framed from a “known sender” and when additional filters (e.g., Blackhole) are relaxed:
- BlastDoor는 신뢰할 수 없는 메시지 콘텐츠를 파싱하도록 설계된 강화된 서비스입니다. 그러나 관찰된 로그는 메시지가 “known sender”로 프레이밍되거나 추가 필터(예: Blackhole)가 완화될 때 보호가 우회될 수 있는 경로들이 있음을 시사합니다:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
핵심 요지:
- 자동 파싱은 여전히 원격, zero-click 공격 표면을 제공한다.
- 정책/컨텍스트 결정(알려진 발신자, 필터링 상태)은 실질적인 격리 수준을 크게 변경할 수 있다.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

영향을 받는 구성 요소:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 파싱 및 변환 흐름

관찰된 파서 접점(로그):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
기술 요약:
- Malformed container/codec metadata (예: invalid/short/NULL magic cookie)는 디코드 설정 중 메모리 손상을 유발한다.
- 사용자의 탭 없이 iMessage 미디어 변환 경로에서 트리거된다.
- 미디어 파싱 프로세스에서 코드 실행이 발생한다. 보고서는 관찰된 전달 경로에서 이것이 BlastDoor를 우회하여 다음 단계를 가능하게 한다고 주장한다.

실용 팁:
- AudioConverterService 변환을 대상으로 할 때 AAC/AMR magic cookie와 MP4 codec atoms를 퍼징하라.
- 디코더 초기화 주변의 힙 오버플로우/언더플로우, OOB reads/writes, 및 크기/길이 혼동에 집중하라.

## RPAC 경로를 통한 PAC 우회 (CVE-2025-31201)

arm64e Pointer Authentication (PAC)은 리턴 주소와 함수 포인터 탈취를 방해한다. 해당 체인은 arbitrary read/write가 확보되면 RPAC 경로를 사용해 PAC을 무력화했다고 보고한다.

핵심 아이디어:
- arbitrary R/W를 통해 공격자는 유효하게 재서명된 포인터를 생성하거나 PAC-허용 경로로 실행을 피벗할 수 있다. 이른바 “RPAC path”는 PAC 제약 하에서 제어 흐름을 허용하여 userland RCE를 신뢰할 수 있는 커널 익스플로잇 설정으로 전환한다.

연구자 참고:
- KASLR을 무력화하고 PAC 하에서도 ROP/JOP 체인을 안정화하기 위해 info leaks를 수집하라.
- PAC를 제어 가능한 방식으로 생성하거나 인증하는 callsites를 타깃하라(예: 공격자가 제어하는 값으로 생성된 signatures, 예측 가능한 context keys, 또는 포인터를 재서명하는 gadget 시퀀스).
- SoC/OS에 따른 Apple의 hardening 차이를 예상하라; 신뢰성은 leaks, entropy, 및 견고한 primitives에 좌우된다.

## 커널 권한 상승: wireless/AMPDU 경로 예시

관찰된 체인에서는 메모리 손상과 PAC 우회 프리미티브로 userland에 진입한 후, malformed AMPDU 처리 하에서 Wi‑Fi 스택(AppleBCMWLAN)의 코드 경로를 통해 커널 제어를 획득했다. 예시 로그:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
일반 기법:
- userland primitives를 사용해 kernel R/W 또는 제어된 call paths를 구성한다.
- 도달 가능한 kernel surfaces (IOKit, networking/AMPDU, media shared memory, Mach interfaces)를 악용해 kernel PC control 또는 arbitrary memory를 획득한다.
- read/write primitives를 구축하고 필요시 PPL/SPTM 제약을 무력화해 안정화한다.

## 사후 활용: CryptoTokenKit 및 identity/서명 악용

커널이 손상되면 identityservicesd 같은 프로세스를 가장하여 CryptoTokenKit을 통해 사용자 프롬프트 없이 권한 있는 암호화 작업을 호출할 수 있다. 예시 로그:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impact:
- Use Secure Enclave–backed keys for unauthorized signing (tokens, messages, payments), breaking trust models even if keys are not exported.
- Intercept 2FA codes/messages silently; authorize payments/transfers; enable stealth mic/camera/GPS.

Defensive angle:
- Treat post-kernel integrity breaks as catastrophic: enforce runtime attestation for CTK consumers; minimize ambient authority; verify entitlements at the point of use.

## 재현 및 텔레메트리 힌트 (실험실 전용)

- Delivery: send a crafted AMR/MP4-AAC audio to the target device via iMessage/SMS.
- 파싱 및 무선 스택 반응 주변의 앞서 언급한 로그 라인을 텔레메트리에서 관찰.
- 장치가 최신 패치 상태인지 확인; 격리된 실험실 환경에서만 테스트.

## 완화 및 보안 강화 아이디어

- Patch level: iOS 18.4.1 reportedly fixes this chain; keep devices up to date.
- Parser hardening: strict validation for codec cookies/atoms and lengths; defensive decoding paths with bounds checks.
- iMessage isolation: avoid relaxing BlastDoor/Blackhole in “known sender” contexts for media parsing.
- PAC hardening: reduce PAC-gadget availability; ensure signatures are bound to unpredictable contexts; remove PAC-tolerant bypassable patterns.
- CryptoTokenKit: require post-kernel attestation and strong entitlements at call-time for key-bound operations.
- Kernel surfaces: harden wireless AMPDU/status handling; minimize attacker-controlled inputs from userland after compromise.

## 영향받는 버전 (보고된 바)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
