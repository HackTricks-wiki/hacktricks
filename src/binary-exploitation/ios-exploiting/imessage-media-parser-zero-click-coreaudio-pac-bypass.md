# iMessage Media Parser Zero-Click → CoreAudio RCE → PAC/RPAC → Kernel → CryptoTokenKit Abuse

{{#include ../../banners/hacktricks-training.md}}

Ta strona podsumowuje współczesną powierzchnię ataku w iOS i zaobserwowany łańcuch end-to-end wykorzystujący automatyczne parsowanie mediów w iMessage do kompromitacji CoreAudio, obejścia BlastDoor, złamania Pointer Authentication (PAC) przez ścieżkę RPAC, eskalacji do kernel i ostatecznego nadużycia CryptoTokenKit do nieautoryzowanego użycia kluczy.

> Ostrzeżenie: To jest streszczenie edukacyjne, mające pomóc obrońcom, badaczom i red teamom zrozumieć techniki. Nie używaj tego w sposób ofensywny.

## Schemat na wysokim poziomie

- Delivery vector: złośliwy załącznik audio (np. .amr / MP4 AAC) wysłany przez iMessage/SMS.
- Auto-ingestion: iOS automatycznie parsuje media w celu podglądu i konwersji bez interakcji użytkownika.
- Parser bug: sfałszowane struktury trafiają do CoreAudio’s AudioConverterService i uszkadzają pamięć sterty.
- Code exec in media context: RCE wewnątrz procesu parsowania mediów; zgłaszano obejście izolacji BlastDoor w specyficznych ścieżkach (np. ścieżka „znany nadawca”).
- PAC/RPAC bypass: po uzyskaniu arbitralnego R/W obejście PAC w ścieżce RPAC umożliwia stabilną kontrolę przepływu wykonywania pod arm64e PAC.
- Kernel escalation: łańcuch przekształca userland exec w kernel exec (np. przez ścieżki kodu wireless/AppleBCMWLAN i obsługę AMPDU, jak widać w logach poniżej).
- Post-exploitation: mając kernel, nadużyj CryptoTokenKit do wykonania podpisów za pomocą kluczy wspieranych przez Secure Enclave, odczytu wrażliwych ścieżek danych (konteksty Keychain), przechwytywania wiadomości/2FA, cichego autoryzowania akcji oraz włączenia ukrytego nadzoru (mikrofon/kamera/GPS) bez wyświetlania monitów.

## iMessage/BlastDoor attack surface notes

BlastDoor to utwardzona usługa zaprojektowana do parsowania nieufnej zawartości wiadomości. Jednak obserwowane logi wskazują ścieżki, gdzie zabezpieczenia mogą być obejściem, gdy wiadomości są opakowane ze „znanego nadawcy” i gdy dodatkowe filtry (np. Blackhole) są poluzowane:
```text
IDSDaemon    BlastDoor: Disabled for framing messages
SpamFilter   Blackhole disabled; user has disabled filtering unknown senders.
```
Wnioski:
- Auto-parsing nadal stanowi zdalną, zero-click powierzchnię ataku.
- Decyzje dotyczące polityki/kontekstu (znany nadawca, stan filtrowania) mogą istotnie zmienić efektywną izolację.

## CoreAudio: AudioConverterService heap corruption (userland RCE)

Dotknięty komponent:
- CoreAudio → AudioConverterService → AAC/AMR/MP4 parsing and conversion flows

Zaobserwowany punkt styku parsera (logi):
```text
AudioConverterService    ACMP4AACBaseDecoder.cpp: inMagicCookie=0x0, inMagicCookieByteSize=39
```
Technique summary:
- Uszkodzone metadane kontenera/kodeka (np. invalid/short/NULL magic cookie) powodują korupcję pamięci podczas konfiguracji dekodera.
- Aktywowane w ścieżce konwersji mediów iMessage bez stuknięć przez użytkownika.
- Dają wykonanie kodu w procesie parsowania mediów. Opis twierdzi, że to omija BlastDoor w obserwowanej ścieżce dostarczenia, umożliwiając następny etap.

Practical tips:
- Fuzzuj AAC/AMR magic cookie i MP4 codec atoms przy celowaniu w konwersje AudioConverterService.
- Skup się na heap overflows/underflows, OOB reads/writes oraz zamieszaniu size/length wokół inicjalizacji dekodera.

## PAC bypass via RPAC path (CVE-2025-31201)

arm64e Pointer Authentication (PAC) utrudnia przejęcie adresów powrotu i wskaźników funkcji. Łańcuch raportuje pokonanie PAC przy użyciu RPAC path po uzyskaniu arbitrary read/write.

Key idea:
- Przy arbitrary R/W atakujący mogą skonstruować prawidłowe, ponownie podpisane wskaźniki lub przekierować wykonanie do PAC-tolerant paths. Tak zwana “RPAC path” umożliwia kontrolę przepływu sterowania w ramach ograniczeń PAC, zamieniając userland RCE w wiarygodne przygotowanie exploita jądra.

Notes for researchers:
- Zbierz info leaks, aby pokonać KASLR i ustabilizować łańcuchy ROP/JOP nawet przy PAC.
- Celuj w callsites, które generują lub uwierzytelniają PAC w kontrolowalny sposób (np. signatures generated on attacker-controlled values, predictable context keys, or gadget sequences that re-sign pointers).
- Spodziewaj się zróżnicowania hardeningu Apple w zależności od SoC/OS; niezawodność zależy od leaks, entropy i solidnych primitives.

## Kernel escalation: wireless/AMPDU path example

W obserwowanym łańcuchu, po uzyskaniu userland z memory corruption i PAC bypass primitive, kontrola nad jądrem została osiągnięta przez ścieżki kodu w stosie Wi‑Fi (AppleBCMWLAN) przy nieprawidłowym przetwarzaniu AMPDU. Przykładowe logi:
```text
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 14
IO80211ControllerMonitor::setAMPDUstat unhandled kAMPDUStat_ type 13
```
Ogólna technika:
- Użyj userland primitives do zbudowania kernel R/W lub kontrolowanych call paths.
- Nadużyj osiągalnych kernel surfaces (IOKit, networking/AMPDU, media shared memory, Mach interfaces), aby uzyskać kontrolę nad kernel PC lub arbitralny dostęp do pamięci.
- Ustabilizuj exploit poprzez zbudowanie read/write primitives i ominięcie ograniczeń PPL/SPTM tam, gdzie to możliwe.

## Post-exploitation: CryptoTokenKit and identity/signing abuse

Gdy kernel zostanie przejęty, procesy takie jak identityservicesd mogą być podszyte, a uprzywilejowane operacje kryptograficzne wywoływane przez CryptoTokenKit bez monitów użytkownika. Przykładowe logi:
```text
CryptoTokenKit    operation:2 algo:algid:sign:ECDSA:digest-X962:SHA256
CryptoTokenKit    <sepk:p256(d) kid=9a86778f7163e305> parsed for identityservicesd
```
Impact:
- Wykorzystanie Secure Enclave–backed keys do nieautoryzowanego podpisywania (tokens, messages, payments), łamiąc modele zaufania nawet jeśli klucze nie zostały wyeksportowane.
- Ciche przechwytywanie kodów/wiadomości 2FA; autoryzowanie płatności/przelewów; aktywacja ukrytego mikrofonu/kamery/GPS.

Defensive angle:
- Traktować naruszenia integralności po stronie jądra jako katastrofalne: egzekwować runtime attestation dla konsumentów CTK; minimalizować ambient authority; weryfikować entitlements w miejscu użycia.

## Reproduction and telemetry hints (lab only)

- Delivery: wysłać spreparowany audio AMR/MP4-AAC na urządzenie docelowe przez iMessage/SMS.
- Obserwować telemetry dla wymienionych linii logów wokół parsowania i reakcji stosu bezprzewodowego.
- Upewnić się, że urządzenia są w pełni zaktualizowane; testować tylko w izolowanych środowiskach laboratoryjnych.

## Mitigations and hardening ideas

- Patch level: iOS 18.4.1 reportedly fixes this chain; utrzymywać urządzenia na bieżąco.
- Parser hardening: ścisła walidacja codec cookies/atoms i długości; defensywne ścieżki dekodowania z checksami granic.
- iMessage isolation: unikać rozluźniania BlastDoor/Blackhole w kontekstach „known sender” dla parsowania mediów.
- PAC hardening: ograniczyć dostępność PAC-gadgetów; zapewnić, by podpisy były powiązane z nieprzewidywalnymi kontekstami; usuwać wzorce tolerujące PAC, które dają się obejść.
- CryptoTokenKit: wymagać post-kernel attestation i silnych entitlements w czasie wywołania dla operacji związanych z kluczami.
- Kernel surfaces: utwardzić obsługę wireless AMPDU/status; minimalizować wejścia kontrolowane przez atakującego z userland po kompromisie.

## Affected versions (as reported)

- iOS 18.x prior to iOS 18.4.1 (April 16, 2025).
- Primary: CoreAudio → AudioConverterService (media auto-parsing path via iMessage/SMS).
- Chained: PAC/RPAC path and kernel escalation via AppleBCMWLAN AMPDU handling.

## References

- [iOS Crypto Heist repo (README)](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201)
- [Remote Crypto Attack Chain details](https://github.com/JGoyd/iOS-Attack-Chain-CVE-2025-31200-CVE-2025-31201/blob/main/Remote%20Crypto%20Attack%20Chain%20.md)

{{#include ../../banners/hacktricks-training.md}}
