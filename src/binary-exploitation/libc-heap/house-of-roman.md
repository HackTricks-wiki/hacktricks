# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Αυτή ήταν μια πολύ ενδιαφέρουσα τεχνική που επέτρεψε RCE χωρίς leaks μέσω fake fastbins, της unsorted_bin attack και των relative overwrites. Ωστόσο έχει [**επιδιορθώθεί**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Εφαρμοσιμότητα το 2026

- **glibc window:** Λειτουργεί αξιόπιστα σε **2.23–2.28**. Στο **2.29** οι πρόσθετοι έλεγχοι ακεραιότητας `unsorted_chunks` κάνουν την εγγραφή στο unsorted‑bin αναξιόπιστη, οπότε η επιτυχία πέφτει απότομα. Από **2.34** και μετά αφαιρέθηκαν οι `__malloc_hook/__free_hook`, καθιστώντας τον αρχικό στόχο μη διαθέσιμο. Χρησιμοποιήστε το μόνο σε παλιά libc’s (ή custom builds που διατηρούν τα hooks) ή για CTF challenges που συνοδεύουν παλιό libc.
- **Tcache era (≥2.26):** Η Tcache θα «καταναλώσει» τις 0x70 allocations και θα σταματήσει τα fastbin/unsorted primitives. Απενεργοποιήστε την (`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) **πριν** από οποιαδήποτε allocation ή γεμίστε κάθε 0x70 tcache bin με 7 frees για να το αδειάσετε.
- **Safe-linking:** Ισχύει για tcache/fastbin σε ≥2.32, αλλά το House of Roman χρειάζεται μόνο **partial pointer overwrite of a libc address already present in fd/bk**, οπότε το safe-linking δεν βοηθά τον αμυνόμενο εδώ (ο attacker ποτέ δεν forges έναν καινούργιο pointer). Ο πραγματικός αναχαιτιστής είναι η αφαίρεση των hooks και οι έλεγχοι του unsorted‑bin.

### Code

- You can find an example in [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)

### Στόχος

- RCE μέσω κατάχρησης relative pointers

### Απαιτήσεις

- Επεξεργασία δεικτών fastbin και unsorted bin
- 12 bits τυχαιότητας πρέπει να παραβιαστούν brute force (0.02% πιθανότητα επιτυχίας)

## Βήματα Επίθεσης

### Μέρος 1: Fastbin Chunk points to \_\_malloc_hook

Δημιουργήστε αρκετά chunks:

- `fastbin_victim` (0x60, offset 0): UAF chunk που θα χρησιμοποιηθεί αργότερα για να επεξεργαστεί τον heap pointer ώστε να δείχνει στην τιμή της LibC.
- `chunk2` (0x80, offset 0x70): Για σωστή στοίχιση
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): σχετική μετατόπιση στο chunk 'main_arena_use'

Στη συνέχεια `free(main_arena_use)` το οποίο θα τοποθετήσει αυτό το chunk στη λίστα unsorted και θα βάλει pointer στο `main_arena + 0x68` τόσο στο `fd` όσο και στο `bk`.

Τώρα καταχωρείται ένα νέο chunk `fake_libc_chunk(0x60)` επειδή θα περιέχει τους δείκτες προς `main_arena + 0x68` σε `fd` και `bk`.

Έπειτα γίνονται free τα `relative_offset_heap` και `fastbin_victim`.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim` έχει ένα `fd` που δείχνει στο `relative_offset_heap`
- `relative_offset_heap` είναι μια μετατόπιση από το `fake_libc_chunk`, το οποίο περιέχει δείκτη προς το `main_arena + 0x68`
- Η αλλαγή του τελευταίου byte του `fastbin_victim.fd` κάνει το `fastbin_victim` να δείχνει στο `main_arena + 0x68`.

Για τις προηγούμενες ενέργειες, ο attacker πρέπει να είναι σε θέση να τροποποιήσει το fd pointer του `fastbin_victim`.

Στη συνέχεια, το `main_arena + 0x68` δεν είναι τόσο ενδιαφέρον, οπότε το τροποποιούμε ώστε ο δείκτης να δείχνει στο **`__malloc_hook`**.

Σημειώστε ότι το `__memalign_hook` συνήθως αρχίζει με `0x7f` και έχει μηδενικά πριν από αυτό, επομένως είναι δυνατό να το ψευοδομήσουμε ως μια τιμή στο `0x70` fast bin. Επειδή τα τελευταία 4 bits της διεύθυνσης είναι **τυχαία** υπάρχουν `2^4=16` πιθανότητες η τιμή να καταλήξει να δείχνει εκεί που μας ενδιαφέρει. Έτσι πραγματοποιείται εδώ μια BF attack ώστε το chunk να τελειώνει ως εξής: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Για περισσότερες πληροφορίες σχετικά με τα υπόλοιπα bytes ελέγξτε την εξήγηση στο [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). Αν το brute force αποτύχει το πρόγραμμα απλώς καταρρέει (επανεκκινήστε μέχρι να δουλέψει).

Στη συνέχεια, γίνονται 2 mallocs για να αφαιρεθούν τα 2 αρχικά fast bin chunks και εκχωρείται ένα τρίτο για να πάρουμε ένα chunk μέσα στο **`__malloc_hook`**.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Μέρος 2: Unsorted_bin attack

Για περισσότερες πληροφορίες μπορείτε να δείτε:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

Αλλά στην ουσία επιτρέπει να γράψεις `main_arena + 0x68` σε οποιαδήποτε θέση προσδιορίζεται στο `chunk->bk`. Για την επίθεση επιλέγουμε το `__malloc_hook`. Στη συνέχεια, αφού το overwrite-άσουμε, θα χρησιμοποιήσουμε ένα relative overwrite για να δείξουμε σε ένα `one_gadget`.

Γι' αυτό αρχίζουμε να παίρνουμε ένα chunk και να το τοποθετούμε στο **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> Σημείωση ότι αυτή η επίθεση φθείρει το unsorted bin (οπότε και τα small και large). Επομένως μπορούμε πλέον να **χρησιμοποιήσουμε μόνο allocations από το fast bin** (ένα πιο σύνθετο πρόγραμμα μπορεί να κάνει άλλες allocations και να καταρρεύσει), και για να το ενεργοποιήσουμε πρέπει **να κάνουμε alloc του ίδιου μεγέθους αλλιώς το πρόγραμμα θα καταρρεύσει.**

Άρα, για να προκαλέσουμε το write του `main_arena + 0x68` στο `__malloc_hook`, αφού το θέσουμε στο `unsorted_bin_ptr->bk`, αρκεί να κάνουμε: **`malloc(0x80)`**

### Βήμα 3: Ορίστε \_\_malloc_hook σε system

Στο πρώτο βήμα ελέγξαμε ένα chunk που περιείχε το `__malloc_hook` (στην μεταβλητή `malloc_hook_chunk`) και στο δεύτερο βήμα καταφέραμε να γράψουμε εκεί το `main_arena + 0x68`.

Τώρα, εκμεταλλευόμαστε ένα partial overwrite στο `malloc_hook_chunk` για να χρησιμοποιήσουμε τη libc διεύθυνση που γράψαμε εκεί (`main_arena + 0x68`) ώστε να **δείχνει σε μια διεύθυνση `one_gadget`**.

Εδώ χρειάζεται να **bruteforce 12 bits τυχαιότητας** (περισσότερα στο [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Τέλος, μόλις η σωστή διεύθυνση έχει αντικατασταθεί, **καλέστε `malloc` και ενεργοποιήστε το `one_gadget`**.

## Σύγχρονες συμβουλές & παραλλαγές

- **Unsorted-bin check in 2.29+:** Αν πρέπει να τρέξετε σε 2.29–2.33, κατέστρεψε και τα δύο `fd` **και** `bk` για να ικανοποιηθεί ο έλεγχος ακεραιότητας πριν προκαλέσετε το write· αλλιώς το `_int_malloc` τερματίζει. Το ποσοστό επιτυχίας είναι πολύ χαμηλό και συνήθως πρακτικά εφαρμόσιμο μόνο σε brute-force CTF περιβάλλοντα.
- **Hook removal (2.34+):** Με το `__malloc_hook` να έχει αφαιρεθεί, προσαρμόστε το primitive ώστε να προσγειωθεί σε οποιοδήποτε εγγράψιμο GOT/global που μπορείτε να επαναχρησιμοποιήσετε (π.χ. overwrite `exit@GOT` σε non-PIE binaries) ή μεταβείτε σε ένα House of Pie style top‑chunk hijack για να ελέγξετε το `top` αντί για ένα hook.
- **Any‑address fastbin alloc (2024 gist):** Πρόσφατο writeup δείχνει πως η ίδια grooming χρησιμοποιείται για να fastbin‑allocate πάνω από το `__free_hook` ή άλλα globals, πρώτα αποθέτοντας έναν libc pointer στο fastbin και μετά επαναδείχνοντάς τον πριν το fixup. Αυτό δουλεύει σε 2.24–2.28 αλλά αποτυγχάνει στους ελέγχους ακεραιότητας της 2.29.

## Αναφορές

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
