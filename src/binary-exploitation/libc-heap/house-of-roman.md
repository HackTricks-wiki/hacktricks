# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## Grundlegende Informationen

Dies war eine sehr interessante Technik, die RCE ohne leaks über fake fastbins, den unsorted_bin-Angriff und relative overwrites ermöglichte. Allerdings wurde sie [**patched**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Anwendbarkeit in 2026

- **glibc window:** Funktioniert zuverlässig auf **2.23–2.28**. Auf **2.29** machen zusätzliche `unsorted_chunks`-Integritätsprüfungen den unsorted‑bin-Schreibvorgang unzuverlässig, wodurch die Erfolgsrate stark sinkt. Ab **2.34** wurden `__malloc_hook/__free_hook` entfernt, wodurch das ursprüngliche Ziel nicht mehr verfügbar ist. Verwende es nur auf alten libc-Versionen (oder custom builds, die die Hooks behalten) oder für CTF-Challenges, die eine alte libc mitliefern.
- **Tcache era (≥2.26):** Tcache wird deine 0x70-Allokationen verschlucken und die fastbin/unsorted-Primitives stoppen. Deaktiviere es (`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) **vor** jeglicher Allokation oder fülle jeden 0x70-tcache-Bin mit 7 frees, um ihn zu entleeren.
- **Safe-linking:** Es gilt für tcache/fastbin in ≥2.32, aber House of Roman benötigt nur **partial pointer overwrite of a libc address already present in fd/bk**, daher hilft safe-linking dem Verteidiger hier nicht (der Angreifer fälscht nie einen frischen Pointer). Der eigentliche Stopper ist das Entfernen der Hooks und die unsorted-bin-Checks.

### Code

- Ein Beispiel findest du unter [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)

### Ziel

- RCE durch Ausnutzung relativer pointers

### Anforderungen

- Edit fastbin und unsorted bin Pointer
- 12 Bits Zufälligkeit müssen per Brute Force erraten werden (0,02% Chance zu funktionieren)

## Angriffsablauf

### Teil 1: Fastbin Chunk points to \_\_malloc_hook

Erzeuge mehrere chunks:

- `fastbin_victim` (0x60, offset 0): UAF-Chunk, um später den Heap-Pointer so zu bearbeiten, dass er auf den LibC-Wert zeigt.
- `chunk2` (0x80, offset 0x70): Für gute Ausrichtung
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): relativer Offset auf dem 'main_arena_use'-Chunk

Dann `free(main_arena_use)`, wodurch dieser Chunk in die unsorted-Liste gelangt und sowohl `fd` als auch `bk` einen Pointer auf `main_arena + 0x68` erhalten.

Nun wird ein neuer Chunk `fake_libc_chunk(0x60)` alloziert, weil er die Pointer auf `main_arena + 0x68` in `fd` und `bk` enthalten wird.

Dann werden `relative_offset_heap` und `fastbin_victim` freigegeben.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim` hat ein `fd`, das auf `relative_offset_heap` zeigt
- `relative_offset_heap` ist ein Offset (Abstand) von `fake_libc_chunk`, welches einen Pointer auf `main_arena + 0x68` enthält
- Durch Ändern des letzten Bytes von `fastbin_victim.fd` zeigt `fastbin_victim` auf `main_arena + 0x68`.

Für die vorherigen Aktionen muss der Angreifer in der Lage sein, den fd-Pointer von `fastbin_victim` zu verändern.

Dann ist `main_arena + 0x68` nicht so interessant, deshalb ändern wir es so, dass der Pointer auf **`__malloc_hook`** zeigt.

Beachte, dass `__memalign_hook` normalerweise mit `0x7f` beginnt und davor Nullen stehen, daher ist es möglich, es als Wert im `0x70` fast bin zu fälschen. Da die letzten 4 Bits der Adresse **zufällig** sind, gibt es `2^4=16` Möglichkeiten, dass der Wert schließlich an die gewünschte Stelle zeigt. Daher wird hier eine BF attack durchgeführt, sodass das Chunk wie folgt endet: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`**.

(For more info about the rest of the bytes check the explanation in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). Wenn die brute force fehlschlägt, stürzt das Programm einfach ab (einfach neu starten, bis es funktioniert).

Dann werden 2 mallocs ausgeführt, um die 2 initialen fast bin chunks zu entfernen, und ein drittes wird alloziert, um ein chunk in **`__malloc_hook`** zu erhalten.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Teil 2: Unsorted_bin attack

Für mehr Infos kannst du folgendes prüfen:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

Im Wesentlichen erlaubt es, `main_arena + 0x68` an jede in `chunk->bk` angegebene Stelle zu schreiben. Für den Angriff wählen wir `__malloc_hook`. Nachdem wir diesen überschrieben haben, verwenden wir eine relative overwrite, um auf ein `one_gadget` zu zeigen.

Dafür holen wir zuerst einen Chunk und legen ihn in das **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> Beachte, dass dieser Angriff das unsorted bin korruptiert (daher auch small und large). Deshalb können wir jetzt nur **Allocations from the fast bin** verwenden (ein komplexeres Programm könnte andere Allocations durchführen und abstürzen), und um das zu triggern müssen wir **die gleiche Größe allocen, sonst stürzt das Programm ab.**

So, to trigger the write of `main_arena + 0x68` in `__malloc_hook` we perform after setting `__malloc_hook` in `unsorted_bin_ptr->bk` we just need to do: **`malloc(0x80)`**

### Step 3: Set \_\_malloc_hook to system

In step one we controlled a chunk containing `__malloc_hook` (in the variable `malloc_hook_chunk`) and in the second step we managed to write `main_arena + 0x68` there.

Now, we abuse a partial overwrite in `malloc_hook_chunk` to use the libc address we wrote there (`main_arena + 0x68`) to **point to a `one_gadget` address**.

Here is where it's needed to **bruteforce 12 bits of randomness** (more info in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Finally, once the correct address is overwritten, **call `malloc` and trigger the `one_gadget`**.

## Modern tips & variants

- **Unsorted-bin check in 2.29+:** If you must run on 2.29–2.33, corrupt both `fd` **and** `bk` to satisfy the integrity check before triggering the write; otherwise `_int_malloc` aborts. Die Erfolgsrate ist sehr niedrig und üblicherweise nur in brute-force CTF-Szenarien praktikabel.
- **Hook removal (2.34+):** With `__malloc_hook` gone, adapt the primitive to land on any writable GOT/global you can later reuse (e.g., overwrite `exit@GOT` in non-PIE binaries) or pivot to a **House of Pie** style top‑chunk hijack to control `top` instead of a hook.
- **Any‑address fastbin alloc (2024 gist):** A recent writeup shows reusing the same grooming to fastbin‑allocate over `__free_hook` or other globals by first landing a libc pointer in fastbin and then re‑pointing it before the fixup. This works on 2.24–2.28 but still dies on 2.29 integrity checks.

## References

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
