# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## Taarifa Msingi

Hii ilikuwa teknikia ya kuvutia sana ambayo iliruhusu RCE bila leaks kupitia fake fastbins, unsorted_bin attack na relative overwrites. Hata hivyo ime[**imerekebishwa**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Utegemezwaji mnamo 2026

- **Dirisha la glibc:** Inafanya kazi kwa kuaminika kwenye **2.23–2.28**. Kwenye **2.29** ukaguzi wa ziada wa `unsorted_chunks` hufanya unsorted‑bin write isiyokuwa ya kuaminika, hivyo mafanikio yanashuka kwa kasi. Kuanzia **2.34** `__malloc_hook/__free_hook` ziliondolewa, na kufanya lengo la awali lisipatikane. Itumie tu kwenye libc za zamani (au builds maalum zinazohifadhi hooks) au kwa changamoto za CTF zinazotumia libc ya zamani.
- **Tcache era (≥2.26):** Tcache itakula allocations zako za 0x70 na kuzuia primitives za fastbin/unsorted. Zimezimwa (`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) **kabla** ya allocation yoyote au jaza kila tcache bin ya 0x70 kwa 7 frees ili kuiteleza.
- **Safe-linking:** Inatumika kwenye tcache/fastbin katika ≥2.32, lakini House of Roman inahitaji tu **partial pointer overwrite of a libc address already present in fd/bk**, hivyo safe-linking haimsaidii defensive hapa (mtuhumiwa hahangaishi pointer mpya kabisa). Kitu kinachokomaza ni kuondolewa kwa hooks na ukaguzi wa unsorted-bin.

### Code

- Unaweza kupata mfano katika [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)

### Lengo

- RCE kwa kutumia vibaya relative pointers

### Mahitaji

- Kuhariri fastbin na unsorted bin pointers
- Inahitaji brute forcing ya 12 bits za randomness (0.02% nafasi ya kufanikiwa)

## Hatua za Shambulio

### Sehemu ya 1: Fastbin Chunk inaonyesha kwa \_\_malloc_hook

Tengeneza chunks kadhaa:

- `fastbin_victim` (0x60, offset 0): UAF chunk itakayotumika baadaye kuhariri heap pointer ili ionyeshe kwenye thamani ya LibC.
- `chunk2` (0x80, offset 0x70): kwa upangaji mzuri
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): relative offset kwenye chunk ya `main_arena_use`

Kisha `free(main_arena_use)` ambayo itaweka chunk hii kwenye unsorted list na itapata pointer kwa `main_arena + 0x68` katika pointer za `fd` na `bk`.

Sasa inapewa chunk mpya `fake_libc_chunk(0x60)` kwa sababu itakuwa na pointers kwa `main_arena + 0x68` katika `fd` na `bk`.

Kisha `relative_offset_heap` na `fastbin_victim` zimetolewa kwa free().
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim` ina `fd` inayorejelea `relative_offset_heap`
- `relative_offset_heap` ni offset ya umbali kutoka `fake_libc_chunk`, ambayo ina pointer kwenda `main_arena + 0x68`
- Kubadilisha baiti ya mwisho ya `fastbin_victim.fd` kunafanya `fastbin_victim` kurejelea `main_arena + 0x68`.

Kwa hatua zilizotajwa hapo juu, mshambuliaji anahitaji uwezo wa kubadilisha pointer ya fd ya `fastbin_victim`.

Kisha, `main_arena + 0x68` si jambo la kuvutia sana, hivyo tubadilishe ili pointer ianze kurejelea **`__malloc_hook`**.

Kumbuka kwamba `__memalign_hook` kwa kawaida huanza na `0x7f` na zeros kabla yake, hivyo inawezekana kuibuni kama thamani katika `0x70` fast bin. Kwa sababu bits 4 za mwisho za anwani ni **nasibu** kuna uwezekano `2^4=16` kwa thamani kumaliza kurejelea mahali tunapovutiwa. Kwa hivyo BF attack inafanywa hapa ili chunk iishe kama: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Kwa taarifa zaidi kuhusu baiti zilizobaki angalia maelezo katika the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). Ikiwa brute force itashindwa programu itagonga tu (anzisha upya hadi ifanye kazi).

Kisha, malloc mbili zinafanywa kuondoa chunk mbili za awali za fast bin na ya tatu inatolewa kupata chunk ndani ya **`__malloc_hook`**.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Sehemu 2: Unsorted_bin attack

Kwa maelezo zaidi unaweza kuangalia:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

Lakini kwa msingi inaruhusu kuandika `main_arena + 0x68` kwa eneo lolote lililoainishwa katika `chunk->bk`. Kwa shambulio tunachagua `__malloc_hook`. Kisha, baada ya ku-overwrite, tutatumia relative overwrite ili kuelekeza kwa `one_gadget`.

Kwa hili tunaanza kupata chunk na kuiweka ndani ya **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> Kumbuka kuwa shambulio hili linaharibu unsorted bin (hivyo small na large pia). Kwa hiyo sasa tunaweza tu **kutumia allocations kutoka fast bin** (programu ngumu zaidi inaweza kufanya allocations nyingine na kusababisha crash), na ili kuamsha hili lazima **tufanye alloc ya ukubwa huo huo au program ita-crash.**

Hivyo, ili kuamsha uandishi wa `main_arena + 0x68` ndani ya `__malloc_hook` baada ya kuweka `__malloc_hook` katika `unsorted_bin_ptr->bk` tunahitaji tu kufanya: **`malloc(0x80)`**

### Hatua 3: Weka __malloc_hook kwa system

Katika hatua ya kwanza tulidhibiti chunk iliyo na `__malloc_hook` (katika variable `malloc_hook_chunk`) na katika hatua ya pili tuliweza kuandika `main_arena + 0x68` huko.

Sasa, tunatumia partial overwrite katika `malloc_hook_chunk` ili kutumia anwani ya libc tuliyoandika huko (`main_arena + 0x68`) kuonyesha kwa anwani ya `one_gadget`.

Hapa ndipo panahitajika **bruteforce 12 bits of randomness** (more info in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Mwishowe, mara anwani sahihi itakapoundwa, **piga `malloc` na amsha `one_gadget`**.

## Modern tips & variants

- **Unsorted-bin check in 2.29+:** Ikiwa lazima uwe unakimbia kwa 2.29–2.33, haribu wote `fd` **na** `bk` ili kukidhi the integrity check kabla ya kuamsha uandishi; vinginevyo `_int_malloc` itajiondoa. Kiwango cha mafanikio ni kidogo sana na kawaida kinafanikiwa tu katika mazingira ya brute-force CTF.
- **Hook removal (2.34+):** Iwapo `__malloc_hook` imeondolewa, badilisha primitive ili iingie kwenye GOT/global yoyote writable unayoweza kutumia baadaye (kwa mfano, kuandika juu ya `exit@GOT` katika binaries zisizo-PIE) au pinda kwenda kwa mtindo wa hijack ya top‑chunk ya **House of Pie** ili kudhibiti `top` badala ya hook.
- **Any‑address fastbin alloc (2024 gist):** Maandishi ya hivi karibuni yanaonyesha kutumia tena grooming ile ile ili fastbin‑allocate juu ya `__free_hook` au globals nyingine kwa kwanza kuweka pointer ya libc kwenye fastbin kisha kuirejea kabla ya fixup. Hii inafanya kazi kwenye 2.24–2.28 lakini bado inashindwa kwenye integrity checks ya 2.29.

## References

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
