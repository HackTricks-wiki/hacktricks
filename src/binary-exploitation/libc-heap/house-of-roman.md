# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## 기본 정보

이 기법은 fake fastbins, the unsorted_bin attack 및 relative overwrites를 이용해 leak 없이 RCE를 가능하게 한 매우 흥미로운 기법이었습니다. 그러나 [**patched**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c) 되었습니다.

### 2026년 적용성

- **glibc window:** **2.23–2.28**에서 안정적으로 동작합니다. **2.29**에서는 추가된 `unsorted_chunks` 무결성 검사가 unsorted‑bin 쓰기를 신뢰할 수 없게 만들어 성공률이 급격히 떨어집니다. **2.34** 이후로는 `__malloc_hook/__free_hook`가 제거되어 원래 목표를 사용할 수 없습니다. 오래된 libc(또는 후크를 유지한 커스텀 빌드)나 오래된 libc를 제공하는 CTF 문제에서만 사용하세요.
- **Tcache era (≥2.26):** Tcache는 0x70 할당을 가로채 fastbin/unsorted 원시 기능을 멈추게 합니다. (할당 전에) 비활성화하세요(`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) 또는 각 0x70 tcache bin을 7번의 free로 채워 비우세요.
- **Safe-linking:** ≥2.32에서 tcache/fastbin에 적용되지만 House of Roman은 이미 `fd`/`bk`에 존재하는 libc 주소의 **부분 포인터 덮어쓰기(partial pointer overwrite)**만 필요로 하므로 safe-linking은 방어자에게 큰 도움이 되지 않습니다(공격자는 새 포인터를 위조하지 않습니다). 실제로 큰 장애물은 후크 제거와 unsorted-bin 검사입니다.

### 코드

- 예제는 [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)에서 찾을 수 있습니다.

### 목표

- 상대 포인터(relative pointers)를 악용한 RCE

### 요구사항

- fastbin 및 unsorted bin 포인터 편집
- 12비트의 무작위성을 브루트포스해야 함(성공 확률 0.02%)

## 공격 단계

### Part 1: Fastbin Chunk points to __malloc_hook

다음과 같이 여러 청크를 생성합니다:

- `fastbin_victim` (0x60, offset 0): 이후 UAF로 힙 포인터를 수정해 libc 값을 가리키게 할 청크.
- `chunk2` (0x80, offset 0x70): 정렬을 위해.
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): `main_arena_use` 청크의 상대 오프셋을 위한 청크.

그런 다음 `free(main_arena_use)`를 호출하면 이 청크는 unsorted 리스트에 들어가고 `fd`와 `bk` 포인터에 `main_arena + 0x68`에 대한 포인터를 얻게 됩니다.

이제 `fake_libc_chunk(0x60)`를 새로 할당하는데, 이 청크는 `fd`와 `bk`에 `main_arena + 0x68` 포인터를 담고 있게 됩니다.

그런 다음 `relative_offset_heap`과 `fastbin_victim`을 `free`합니다.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim`는 `fd`가 `relative_offset_heap`을 가리킨다
- `relative_offset_heap`는 `fake_libc_chunk`로부터의 거리 오프셋이며, 이는 `main_arena + 0x68`를 가리키는 포인터를 포함한다
- `fastbin_victim.fd`의 마지막 바이트를 변경하면 `fastbin_victim`가 `main_arena + 0x68`를 가리키게 된다.

위 동작들을 위해 공격자는 `fastbin_victim`의 fd 포인터를 수정할 수 있어야 한다.

그런데 `main_arena + 0x68`는 별로 흥미롭지 않으므로, 포인터가 **`__malloc_hook`**을 가리키도록 수정하자.

참고로 `__memalign_hook`는 보통 `0x7f`로 시작하고 그 앞은 0으로 채워지므로, 이를 `0x70` fast bin 안의 값으로 위조할 수 있다. 주소의 마지막 4비트가 **random**이기 때문에 우리가 원하는 곳을 가리키게 되는 경우는 `2^4=16`가지가 있다. 따라서 여기서는 BF attack을 수행하여 청크가 다음과 같이 끝나게 만든다: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(For more info about the rest of the bytes check the explanation in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). If the brute force fails the program just crashes (restart until it works).

그 다음, 초기의 2개 fast bin 청크를 제거하기 위해 2번의 malloc이 수행되고, 세 번째 malloc이 할당되어 **`__malloc_hook`**에 청크를 얻는다.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### 파트 2: Unsorted_bin attack

For more info you can check:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

요약하면, 이는 `chunk->bk`에 지정된 임의의 위치에 `main_arena + 0x68`을 쓸 수 있게 합니다. 공격에서는 `__malloc_hook`을 선택합니다. 그 후, 덮어쓴 뒤 relative overwrite를 사용해 `one_gadget`을 가리키게 합니다.

이를 위해 먼저 chunk를 얻어 **unsorted bin**에 넣습니다:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> 이 공격은 unsorted bin을 손상시킨다(따라서 small과 large도). 그래서 이제 우리는 **fast bin에서의 allocations만 사용할 수 있다** (더 복잡한 프로그램은 다른 할당을 수행해 크래시할 수 있음), 그리고 이를 트리거하려면 반드시 **같은 크기로 alloc해야 한다 그렇지 않으면 프로그램이 크래시한다.**

So, to trigger the write of `main_arena + 0x68` in `__malloc_hook` we perform after setting `__malloc_hook` in `unsorted_bin_ptr->bk` we just need to do: **`malloc(0x80)`**

### 3단계: \_\_malloc_hook을 system으로 설정

In step one we controlled a chunk containing `__malloc_hook` (in the variable `malloc_hook_chunk`) and in the second step we managed to write `main_arena + 0x68` there.

이제 `malloc_hook_chunk`에서의 partial overwrite를 악용해 그곳에 쓴 libc 주소(`main_arena + 0x68`)를 사용하여 **`one_gadget` 주소를 가리키게 한다**.

여기서는 **12비트의 랜덤성(unknown bits)을 브루트포스해야 한다** (자세한 내용은 the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Finally, once the correct address is overwritten, **call `malloc` and trigger the `one_gadget`**.

## 최신 팁 & 변형

- **Unsorted-bin check in 2.29+:** 2.29–2.33에서 실행해야 한다면 쓰기를 트리거하기 전에 무결성 검사를 통과시키기 위해 `fd` **및** `bk` 둘 다를 손상시켜야 한다; 그렇지 않으면 `_int_malloc`이 abort한다. 성공률은 매우 낮으며 보통 브루트포스 CTF 환경에서만 실용적이다.
- **Hook removal (2.34+):** `__malloc_hook`이 제거된 경우, 이후 재사용할 수 있는 쓰기 가능한 GOT/global 어느 곳에든 착지시키도록 primitive를 조정하거나(예: non-PIE 바이너리에서 `exit@GOT`를 덮어쓰기) 훅 대신 `top`을 제어하기 위해 **House of Pie** 스타일의 top‑chunk 하이재킹으로 전환하라.
- **Any‑address fastbin alloc (2024 gist):** 최근 문서에서는 동일한 grooming을 재사용해 먼저 fastbin에 libc 포인터를 넣고 fixup 전에 이를 재지정하여 `__free_hook`이나 다른 글로벌을 fastbin으로 할당하는 방법을 보여준다. 이는 2.24–2.28에서 동작하지만 2.29의 무결성 검사에서는 여전히 실패한다.

## 참고자료

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
