# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## Βασικές Πληροφορίες

Αυτή ήταν μια πολύ ενδιαφέρουσα τεχνική που επέτρεπε RCE χωρίς leaks μέσω fake fastbins, του unsorted_bin attack και των relative overwrites. Ωστόσο έχει [**patched**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### Εφαρμοσιμότητα το 2026

- **glibc window:** Λειτουργεί αξιόπιστα σε **2.23–2.28**. Στο **2.29** οι επιπλέον `unsorted_chunks` integrity checks κάνουν το unsorted‑bin write αναξιόπιστο, οπότε η επιτυχία πέφτει απότομα. Από **2.34** και μετά οι `__malloc_hook/__free_hook` αφαιρέθηκαν, καθιστώντας τον αρχικό στόχο μη διαθέσιμο. Χρησιμοποιήστε το μόνο σε παλιές libc’s (ή custom builds που κρατάνε τα hooks) ή για CTF challenges που shipαρουν παλιά libc.
- **Tcache era (≥2.26):** Το Tcache θα φάει τις 0x70 allocations και θα σταματήσει τα fastbin/unsorted primitives. Απενεργοποιήστε το (`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) **πριν** από οποιαδήποτε allocation ή γεμίστε κάθε 0x70 tcache bin με 7 frees για να το αδειάσετε.
- **Safe-linking:** Ισχύει για tcache/fastbin σε ≥2.32, αλλά το House of Roman χρειάζεται μόνο partial pointer overwrite μιας libc address που ήδη υπάρχει σε fd/bk, οπότε το safe-linking δεν βοηθά τον defender εδώ (ο attacker ποτέ δεν forges ένα νέο pointer). Ο πραγματικός ανασχετικός παράγων είναι η αφαίρεση των hooks και οι έλεγχοι του unsorted‑bin.

### Code

- Μπορείτε να βρείτε ένα παράδειγμα στο [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)

### Στόχος

- RCE εκμεταλλευόμενος relative pointers

### Απαιτήσεις

- Επεξεργασία των fastbin και unsorted bin pointers
- 12 bits of randomness πρέπει να υποβληθούν σε brute force (0.02% πιθανότητα επιτυχίας)

## Βήματα Επίθεσης

### Μέρος 1: Fastbin Chunk points to __malloc_hook

Δημιουργήστε αρκετά chunks:

- `fastbin_victim` (0x60, offset 0): UAF chunk που αργότερα θα αλλάξει το heap pointer ώστε να δείχνει στην τιμή του LibC.
- `chunk2` (0x80, offset 0x70): Για σωστή στοίχιση
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): relative offset στο chunk 'main_arena_use'

Στη συνέχεια κάνετε `free(main_arena_use)` το οποίο θα τοποθετήσει αυτό το chunk στη λίστα unsorted και θα βάλει pointer προς `main_arena + 0x68` τόσο στο `fd` όσο και στο `bk`.

Τώρα γίνεται allocation ενός νέου chunk `fake_libc_chunk(0x60)` επειδή θα περιέχει τους pointers προς `main_arena + 0x68` στα `fd` και `bk`.

Στη συνέχεια τα `relative_offset_heap` και `fastbin_victim` ελευθερώνονται.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim` έχει ένα `fd` που δείχνει στο `relative_offset_heap`
- `relative_offset_heap` είναι μια απόσταση (offset) από το `fake_libc_chunk`, το οποίο περιέχει έναν δείκτη προς `main_arena + 0x68`
- Η αλλαγή του τελευταίου byte του `fastbin_victim.fd` κάνει το `fastbin_victim` να δείχνει στο `main_arena + 0x68`.

Για τις προηγούμενες ενέργειες, ο attacker πρέπει να μπορεί να τροποποιήσει τον fd δείκτη του `fastbin_victim`.

Στη συνέχεια, το `main_arena + 0x68` δεν είναι τόσο ενδιαφέρον, οπότε ας το τροποποιήσουμε ώστε ο δείκτης να δείχνει στο **`__malloc_hook`**.

Σημειώστε ότι το `__memalign_hook` συνήθως ξεκινάει με `0x7f` και έχει μηδενικά πριν από αυτό, οπότε είναι δυνατό να το πλαστογραφήσετε ως μια τιμή στο `0x70` fast bin. Επειδή τα τελευταία 4 bits της διεύθυνσης είναι **τυχαία**, υπάρχουν `2^4=16` πιθανότητες για την τιμή να καταλήξει να δείχνει εκεί που μας ενδιαφέρει. Έτσι, εδώ εκτελείται ένα BF attack ώστε το chunk να τελειώνει ως εξής: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(For more info about the rest of the bytes check the explanation in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). Αν το brute force αποτύχει, το πρόγραμμα απλώς καταρρέει (επανεκκινήστε μέχρι να λειτουργήσει).

Στη συνέχεια, εκτελούνται 2 mallocs για να αφαιρεθούν τα 2 αρχικά fast bin chunks και κατανέμεται ένα τρίτο για να αποκτηθεί ένα chunk στο **`__malloc_hook`**.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Μέρος 2: Unsorted_bin attack

Για περισσότερες πληροφορίες μπορείτε να δείτε:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

Αλλά βασικά επιτρέπει να γράψεις `main_arena + 0x68` σε οποιαδήποτε θέση καθορίζεται στο `chunk->bk`. Για την επίθεση επιλέγουμε το `__malloc_hook`. Στη συνέχεια, αφού το υπεργράψουμε, θα χρησιμοποιήσουμε ένα relative overwrite για να δείξουμε σε ένα `one_gadget`.

Για αυτό αρχίζουμε να παίρνουμε ένα chunk και να το βάζουμε στο **unsorted bin**:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we had brute forced this previously).

> [!CAUTION]
> Σημειώστε ότι αυτή η επίθεση διαφθείρει το unsorted bin (και επομένως και τα small και large). Έτσι μπορούμε πλέον να **χρησιμοποιούμε μόνο allocations από το fast bin** (ένα πιο πολύπλοκο πρόγραμμα μπορεί να κάνει άλλες allocations και να καταρρεύσει), και για να το ενεργοποιήσουμε πρέπει να **κάνουμε alloc του ίδιου μεγέθους αλλιώς το πρόγραμμα θα καταρρεύσει.**

So, to trigger the write of `main_arena + 0x68` in `__malloc_hook` we perform after setting `__malloc_hook` in `unsorted_bin_ptr->bk` we just need to do: **`malloc(0x80)`**

### Βήμα 3: Set \_\_malloc_hook to system

In step one we controlled a chunk containing `__malloc_hook` (in the variable `malloc_hook_chunk`) and in the second step we managed to write `main_arena + 0x68` there.

Now, we abuse a partial overwrite in `malloc_hook_chunk` to use the libc address we wrote there (`main_arena + 0x68`) to **point to a `one_gadget` address**.

Here is where it's needed to **bruteforce 12 bits of randomness** (more info in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Finally, once the correct address is overwritten, **call `malloc` and trigger the `one_gadget`**.

## Modern tips & variants

- **Unsorted-bin check in 2.29+:** Αν πρέπει να τρέξετε σε 2.29–2.33, διαφθείρετε τόσο το `fd` **όσο και** το `bk` για να ικανοποιηθεί ο έλεγχος ακεραιότητας πριν ενεργοποιήσετε τη γραφή· αλλιώς `_int_malloc` τερματίζει. Το ποσοστό επιτυχίας είναι πολύ χαμηλό και συνήθως εφαρμόσιμο μόνο σε brute-force CTF σενάρια.
- **Hook removal (2.34+):** Με το `__malloc_hook` να έχει αφαιρεθεί, προσαρμόστε το primitive ώστε να καταλήξει σε οποιοδήποτε writable GOT/global που μπορείτε να επαναχρησιμοποιήσετε (π.χ. overwrite `exit@GOT` σε non-PIE binaries) ή pivot σε ένα top‑chunk hijack στυλ **House of Pie** για να ελέγξετε το `top` αντί για ένα hook.
- **Any‑address fastbin alloc (2024 gist):** Μια πρόσφατη writeup δείχνει επαναχρησιμοποίηση του ίδιου grooming για fastbin‑allocate πάνω από το `__free_hook` ή άλλα globals, πρώτα τοποθετώντας έναν libc pointer στο fastbin και μετά επαναδείχνοντάς το πριν τη διόρθωση. Αυτό δουλεύει σε 2.24–2.28 αλλά αποτυγχάνει στους ελέγχους ακεραιότητας του 2.29.

## References

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
