# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## Temel Bilgiler

Bu, fake fastbins, the unsorted_bin attack ve relative overwrites yoluyla leaks olmadan RCE'ye izin veren çok ilginç bir teknikti. Ancak [**patched**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c).

### 2026'de Uygulanabilirlik

- **glibc window:** **2.23–2.28** üzerinde güvenilir şekilde çalışır. **2.29**'da ek `unsorted_chunks` bütünlük kontrolleri unsorted‑bin yazımını güvensiz hale getirir, bu yüzden başarı keskin şekilde düşer. **2.34**'ten itibaren `__malloc_hook/__free_hook` kaldırıldı, bu da orijinal hedefi kullanılamaz kılar. Sadece eski libc’lerde (veya hook'ları tutan özel derlemelerde) veya eski bir libc ile gelen CTF zorluklarında kullanın.
- **Tcache era (≥2.26):** Tcache 0x70 tahsisatlarınıza müdahale eder ve fastbin/unsorted ilkelini durdurur. Bunu tahsisattan önce devre dışı bırakın (`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) veya her 0x70 tcache bin'ini boşaltmak için 7 free ile doldurun.
- **Safe-linking:** ≥2.32'de tcache/fastbin'e uygulanır, ancak House of Roman yalnızca `fd/bk` içinde zaten bulunan bir libc adresinin kısmi pointer overwrite'ını gerektirir, bu yüzden safe-linking savunana yardımcı olmaz (saldırgan asla yeni bir pointer oluşturmaz). Gerçek engel hook kaldırılması ve unsorted-bin kontrolleridir.

### Kod

- Bir örneği şurada bulabilirsiniz: [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)

### Hedef

- Relative pointers'ı kötüye kullanarak RCE

### Gereksinimler

- fastbin ve unsorted bin pointer'larını düzenleyebilme
- Çalışması için 12 bit rastgeleliğin brute forced edilmesi gerekir (%0.02 şans)

## Saldırı Adımları

### Bölüm 1: Fastbin Chunk __malloc_hook'a işaret ediyor

Birkaç chunk oluşturun:

- `fastbin_victim` (0x60, offset 0): Daha sonra heap pointer'ını LibC değerine işaret edecek şekilde düzenlemek için UAF chunk.
- `chunk2` (0x80, offset 0x70): İyi hizalama için
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): `main_arena_use` chunk'ında göreli offset

Sonra `free(main_arena_use)` — bu chunk'ı unsorted list'e yerleştirir ve `fd` ile `bk` pointer'larına `main_arena + 0x68` adresini koyar.

Şimdi `fake_libc_chunk(0x60)` adlı yeni bir chunk allocate edilir çünkü `fd` ve `bk` içinde `main_arena + 0x68` pointer'larını içerecektir.

Sonra `relative_offset_heap` ve `fastbin_victim` free edilir.
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim`'in `fd`'si `relative_offset_heap`'i işaret ediyor
- `relative_offset_heap`, `fake_libc_chunk`'ten olan mesafeye ait bir offset'tir; `fake_libc_chunk` içinde `main_arena + 0x68`'e işaret eden bir pointer bulunuyor
- `fastbin_victim.fd`'in son baytını değiştirmek `fastbin_victim`'in `main_arena + 0x68`'i işaret etmesini sağlar.

Önceki adımlar için, saldırganın `fastbin_victim`'in fd pointer'ını değiştirebilme yeteneğine sahip olması gerekir.

Daha sonra, `main_arena + 0x68` pek ilginç değil, bu yüzden pointer'ın **`__malloc_hook`**'u işaret etmesini sağlayalım.

Not: `__memalign_hook` genellikle `0x7f` ile başlar ve öncesinde sıfırlar olur; bu yüzden onu `0x70` fast bin'deki bir değer gibi sahtelemek mümkün. Adresin son 4 biti **rastgele** olduğu için değerin istediğimiz yere işaret etmesi için `2^4=16` olasılık vardır. Bu yüzden burada bir BF attack uygulanır, böylece chunk şu şekilde biter: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(Diğer byte'lar hakkında daha fazla bilgi için [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c) içindeki açıklamaya bakın). Eğer brute force başarısız olursa program sadece çöker (çalışana kadar yeniden başlatın).

Sonra, ilk 2 fast bin chunk'ını kaldırmak için 2 malloc çağrısı yapılır ve üçüncü malloc, **`__malloc_hook`** içinde bir chunk elde etmek için yapılır.
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Bölüm 2: Unsorted_bin attack

Daha fazla bilgi için bakabilirsiniz:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

Ama temelde `main_arena + 0x68`'i `chunk->bk` tarafından belirtilen herhangi bir konuma yazmamıza izin verir. Saldırı için `__malloc_hook`'u seçiyoruz. Ardından, onu overwrite ettikten sonra `one_gadget`'e işaret etmek için bir relative overwrite kullanacağız.

Bunun için önce bir chunk alıp **unsorted bin**'e koyuyoruz:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> Note that this attack corrupts the unsorted bin (hence small and large too). So we can only **use allocations from the fast bin now** (a more complex program might do other allocations and crash), and to trigger this we must **alloc the same size or the program will crash.**

So, to trigger the write of `main_arena + 0x68` in `__malloc_hook` we perform after setting `__malloc_hook` in `unsorted_bin_ptr->bk` we just need to do: **`malloc(0x80)`**

### Adım 3: \_\_malloc_hook'u system'e ayarlama

Birinci adımda `__malloc_hook`'u içeren bir chunk'ı kontrol ettik (değişken `malloc_hook_chunk`) ve ikinci adımda oraya `main_arena + 0x68` yazmayı başardık.

Şimdi, `malloc_hook_chunk`'ta kısmi overwrite istismarını kullanarak oraya yazdığımız libc adresini (`main_arena + 0x68`) **bir `one_gadget` adresine işaret ettirmek** için kullanıyoruz.

Burada **12 bitlik rasgeleliği bruteforce** etmemiz gerekiyor (daha fazla bilgi için [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Son olarak, doğru adres overwrite edildikten sonra, **`malloc`'ı çağırıp `one_gadget`'ı tetikleyin**.

## Modern tips & variants

- **Unsorted-bin check in 2.29+:** Eğer 2.29–2.33'te çalıştırmanız gerekiyorsa, yazmayı tetiklemeden önce bütünlük kontrolünü geçmek için hem `fd` **ve** `bk`'i bozun; aksi takdirde `_int_malloc` abort eder. Başarı oranı çok düşüktür ve genellikle sadece brute-force CTF ortamlarında uygulanabilir.
- **Hook removal (2.34+):** `__malloc_hook` yoksa, primitive'i daha sonra yeniden kullanabileceğiniz herhangi bir writable GOT/global üzerine gelecek şekilde uyarlayın (ör. non-PIE binarilerde `exit@GOT`'u overwrite etmek) veya bir hook yerine `top`'u kontrol etmek için **House of Pie** tarzı top‑chunk hijack'e pivot yapın.
- **Any‑address fastbin alloc (2024 gist):** Yakın tarihli bir yazı, önce fastbin'e bir libc pointer'ı yerleştirip sonra fixup'tan önce yeniden işaret ederek aynı grooming'i kullanıp `__free_hook` veya diğer global'lar üzerine fastbin-allocate yapmayı gösteriyor. Bu 2.24–2.28'de çalışır ancak 2.29 bütünlük kontrollerinde yine başarısız olur.

## References

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
