# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## बुनियादी जानकारी

यह एक बहुत रोचक तकनीक थी जो fake fastbins, the unsorted_bin attack और relative overwrites के जरिए leaks के बिना RCE की अनुमति देती थी। हालांकि इसे [**patched**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c) कर दिया गया है।

### 2026 में प्रासंगिकता

- **glibc window:** यह विश्वसनीय रूप से **2.23–2.28** पर काम करता है। **2.29** पर अतिरिक्त `unsorted_chunks` integrity checks unsorted‑bin write को अविश्वसनीय बना देते हैं, इसलिए सफलता तेज़ी से घट जाती है। **2.34** से `__malloc_hook/__free_hook` हटा दिए गए हैं, जिससे मूल लक्ष्य उपलब्ध नहीं रहता। इसे केवल पुराने libc (या वो custom builds जो hooks रखते हों) या उन CTF चुनौतियों के लिए उपयोग करें जो पुराना libc साथ देती हों।
- **Tcache era (≥2.26):** Tcache आपके 0x70 आवंटनों को उपभोग कर लेगा और fastbin/unsorted प्रिमिटिव्स को रोक देगा। इसे डिसेबल करें (`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`) किसी भी allocation से **पहले** या हर 0x70 tcache bin को ड्रेन करने के लिए 7 frees करके भरें।
- **Safe-linking:** यह ≥2.32 में tcache/fastbin पर लागू होता है, लेकिन House of Roman को केवल **partial pointer overwrite of a libc address already present in fd/bk** की आवश्यकता है, इसलिए safe-linking यहाँ defender की मदद नहीं करता (attacker कभी नया pointer forge नहीं करता)। असली रोकथाम hooks के हटने और unsorted‑bin चेक्स हैं।

### कोड

- आप एक उदाहरण यहाँ पा सकते हैं: [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)

### लक्ष्य

- relative pointers का दुरुपयोग कर RCE

### आवश्यकताएँ

- fastbin और unsorted bin pointers को एडिट करें
- 12 बिट की randomness को brute force करना होगा (काम करने की संभावना 0.02%)

## हमला चरण

### भाग 1: Fastbin Chunk \_\_malloc_hook की ओर इशारा करता है

कई chunks बनाएं:

- `fastbin_victim` (0x60, offset 0): UAF chunk, बाद में heap pointer को edit करने के लिए ताकि वह LibC value की ओर इशारा करे।
- `chunk2` (0x80, offset 0x70): अच्छे alignment के लिए
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): 'main_arena_use' chunk पर relative offset

फिर `free(main_arena_use)` करें, जो इस chunk को unsorted सूची में रखेगा और `fd` और `bk` दोनों pointers में `main_arena + 0x68` का pointer प्राप्त करेगा।

अब एक नया chunk `fake_libc_chunk(0x60)` allocate किया जाता है क्योंकि यह `fd` और `bk` में `main_arena + 0x68` के pointers रखेगा।

फिर `relative_offset_heap` और `fastbin_victim` को free किया जाता है।
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim` का `fd` `relative_offset_heap` की ओर इशारा करता है
- `relative_offset_heap` `fake_libc_chunk` से दूरी का एक offset है, जो `main_arena + 0x68` की ओर एक pointer रखता है
- `fastbin_victim.fd` के अंतिम बाइट को बदलने से `fastbin_victim` `main_arena + 0x68` की ओर इशारा करने लगता है।

इन कार्रवाइयों के लिए, attacker को `fastbin_victim` के fd pointer को संशोधित करने में सक्षम होना चाहिए।

फिर, `main_arena + 0x68` इतना दिलचस्प नहीं है, इसलिए इसे modify कर के pointer को **`__malloc_hook`** की ओर इशारा करने लायक बनाते हैं।

ध्यान दें कि `__memalign_hook` आमतौर पर `0x7f` से शुरू होता है और उसके पहले zeros होते हैं, इसलिए इसे `0x70` fast bin के एक value के रूप में fake करना संभव है। क्योंकि address के अंतिम 4 बिट्स **यादृच्छिक** होते हैं, `2^4=16` संभावनाएँ हैं कि value अंततः उस स्थान की ओर इशारा करे जिसमें हमें रुचि है। इसलिए यहाँ एक BF attack किया जाता है ताकि chunk ऐसे खत्म हो: **`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(For more info about the rest of the bytes check the explanation in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). अगर brute force असफल होता है तो प्रोग्राम बस crash कर जाता है (जितना बार चाहें restart करें जब तक काम न कर जाए)।

फिर, 2 mallocs perform किए जाते हैं ताकि शुरुआती 2 fast bin chunks हटा दिए जाएँ और तीसरा allocate किया जाता है ताकि **`__malloc_hook`** में एक chunk मिल सके।
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### भाग 2: Unsorted_bin attack

For more info you can check:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

लेकिन मूलतः यह आपको `chunk->bk` में निर्दिष्ट किसी भी लोकेशन पर `main_arena + 0x68` लिखने की अनुमति देता है। हम इस attack के लिए `__malloc_hook` चुनते हैं। फिर इसे overwrite करने के बाद हम एक relative overwrite का उपयोग करके इसे `one_gadget` की ओर पॉइंट करेंगे।

इसके लिए हम एक chunk लेते हैं और उसे **unsorted bin** में डालते हैं:
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> ध्यान दें कि यह attack unsorted bin को corrupt कर देता है (इसलिए small और large भी)। इसलिए अब हम केवल **use allocations from the fast bin now** कर सकते हैं (एक अधिक complex प्रोग्राम अन्य allocations कर सकता है और crash कर सकता है), और इसे trigger करने के लिए हमें **same size का alloc करना होगा वरना प्रोग्राम crash कर जाएगा.**

So, to trigger the write of `main_arena + 0x68` in `__malloc_hook` we perform after setting `__malloc_hook` in `unsorted_bin_ptr->bk` we just need to do: **`malloc(0x80)`**

### चरण 3: \_\_malloc_hook को system में सेट करें

In step one we controlled a chunk containing `__malloc_hook` (in the variable `malloc_hook_chunk`) and in the second step we managed to write `main_arena + 0x68` there.

Now, we abuse a partial overwrite in `malloc_hook_chunk` to use the libc address we wrote there (`main_arena + 0x68`) to **point to a `one_gadget` address**.

यहाँ पर **bruteforce 12 bits of randomness** करना पड़ता है (more info in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Finally, once the correct address is overwritten, **call `malloc` and trigger the `one_gadget`**।

## आधुनिक टिप्स & वेरिएंट

- **Unsorted-bin check in 2.29+:** यदि आपको 2.29–2.33 पर चलाना है, तो write trigger करने से पहले integrity check को संतुष्ट करने के लिए दोनों `fd` **और** `bk` को corrupt करें; अन्यथा `_int_malloc` abort कर देगा। सफल होने की दर बहुत कम है और आमतौर पर केवल brute-force CTF settings में ही व्यवहार्य रहती है।
- **Hook removal (2.34+):** जब `__malloc_hook` हट चुका हो, तो primitive को एडाप्ट करें ताकि यह किसी भी writable GOT/global पर उतर सके जिसे आप बाद में reuse कर सकें (उदा., non-PIE binaries में `exit@GOT` को overwrite करना) या hook के बजाय `top` को नियंत्रित करने के लिए **House of Pie** स्टाइल top‑chunk hijack की तरफ pivot करें।
- **Any‑address fastbin alloc (2024 gist):** एक हालिया writeup दिखाता है कि उसी grooming को reuse करके fastbin‑allocate करके `__free_hook` या अन्य globals पर पहुँचाया जा सकता है—पहले fastbin में एक libc pointer लैंड कराकर और फिर fixup से पहले उसे re‑point करना। यह 2.24–2.28 पर काम करता है लेकिन 2.29 की integrity checks पर अब भी विफल हो जाता है।

## References

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
