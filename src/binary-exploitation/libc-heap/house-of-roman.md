# House of Roman

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

这是一个非常有趣的技术，允许通过 fake fastbins、the unsorted_bin attack 和 relative overwrites 实现 RCE 而无需 leaks。不过它已被 [**patched**](https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=b90ddd08f6dd688e651df9ee89ca3a69ff88cd0c)。

### Applicability in 2026

- **glibc window:** 在 **2.23–2.28** 上可靠工作。 在 **2.29** 上，额外的 `unsorted_chunks` 完整性检查使得 unsorted‑bin 的写入变得不可靠，成功率急剧下降。 从 **2.34** 起 `__malloc_hook/__free_hook` 被移除，使原始目标不可用。仅在老版本 libc（或保留这些 hook 的自定义构建）或附带旧 libc 的 CTF 题目上使用它。
- **Tcache era (≥2.26):** Tcache 会吞掉你的 0x70 分配并阻断 fastbin/unsorted 原语。要么在任何分配之前禁用它（`setenv("GLIBC_TUNABLES","glibc.malloc.tcache_count=0",1);`），要么向每个 0x70 tcache bin 填入 7 次 free 以将其排空。
- **Safe-linking:** 它适用于 ≥2.32 的 tcache/fastbin，但 House of Roman 只需要对已存在于 fd/bk 的 libc 地址做部分指针覆盖，因此 safe-linking 对防御方没有帮助（攻击者并不伪造一个新的指针）。真正的阻断因素是 hook 的移除和 unsorted-bin 的检查。

### Code

- 你可以在 [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c) 找到示例

### Goal

- 通过滥用相对指针获得 RCE

### Requirements

- 编辑 fastbin 和 unsorted bin 指针
- 必须穷举 12 位的随机性（约 0.02% 的成功概率）

## Attack Steps

### Part 1: Fastbin Chunk points to __malloc_hook

Create several chunks:

- `fastbin_victim` (0x60, offset 0): UAF chunk later to edit the heap pointer later to point to the LibC value.
- `chunk2` (0x80, offset 0x70): For good alignment
- `main_arena_use` (0x80, offset 0x100)
- `relative_offset_heap` (0x60, offset 0x190): relative offset on the 'main_arena_use' chunk

然后 `free(main_arena_use)`，这会将该 chunk 放入 unsorted list，并在 `fd` 和 `bk` 指针中得到一个指向 `main_arena + 0x68` 的指针。

现在分配一个新的 chunk `fake_libc_chunk(0x60)`，因为它将在 `fd` 和 `bk` 中包含指向 `main_arena + 0x68` 的指针。

然后释放 `relative_offset_heap` 和 `fastbin_victim`。
```c
/*
Current heap layout:
0x0:   fastbin_victim       - size 0x70
0x70:  alignment_filler     - size 0x90
0x100: fake_libc_chunk      - size 0x70 (contains a fd ptr to main_arena + 0x68)
0x170: leftover_main        - size 0x20
0x190: relative_offset_heap - size 0x70

bin layout:
fastbin:  fastbin_victim -> relative_offset_heap
unsorted: leftover_main
*/
```
- `fastbin_victim` 的 `fd` 指向 `relative_offset_heap`
- `relative_offset_heap` 是相对于 `fake_libc_chunk` 的偏移，后者包含一个指向 `main_arena + 0x68` 的指针
- 修改 `fastbin_victim.fd` 的最后一个字节会使 `fastbin_victim` 指向 `main_arena + 0x68`。

为了完成上述操作，攻击者需要能够修改 `fastbin_victim` 的 fd 指针。

然后，`main_arena + 0x68` 本身并不重要，所以把它改成指向 **`__malloc_hook`**。

注意 `__memalign_hook` 通常以 `0x7f` 开头并在其之前有零，因此可以伪造为 `0x70` fast bin 中的一个值。由于地址的低 4 位是 **random**，因此有 `2^4=16` 种可能性使该值最终指向我们关心的位置。所以这里进行一次 BF attack，使得 chunk 最终如下：**`0x70: fastbin_victim -> fake_libc_chunk -> (__malloc_hook - 0x23)`.**

(For more info about the rest of the bytes check the explanation in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)). If the brute force fails the program just crashes (restart until it works).

然后，执行 2 次 malloc 来移除最初的两个 fast bin chunk，再进行第三次分配以在 **`__malloc_hook`** 获取一个 chunk。
```c
malloc(0x60);
malloc(0x60);
uint8_t* malloc_hook_chunk = malloc(0x60);
```
### Part 2: Unsorted_bin attack

For more info you can check:

{{#ref}}
unsorted-bin-attack.md
{{#endref}}

但基本上它允许将 `main_arena + 0x68` 写入到 `chunk->bk` 指定的任意位置。我们在此次攻击中选择 `__malloc_hook`。在覆盖之后，我们会使用相对覆盖将其指向一个 `one_gadget`。

为此，我们先获取一个 chunk 并将其放入 **unsorted bin**：
```c
uint8_t* unsorted_bin_ptr = malloc(0x80);
malloc(0x30); // Don't want to consolidate

puts("Put chunk into unsorted_bin\n");
// Free the chunk to create the UAF
free(unsorted_bin_ptr);
```
Use an UAF in this chunk to point `unsorted_bin_ptr->bk` to the address of `__malloc_hook` (we brute forced this previously).

> [!CAUTION]
> 注意：该攻击会破坏 unsorted bin（因此也会影响 small 和 large）。所以我们现在只能**use allocations from the fast bin now**（更复杂的程序可能会做其他分配并崩溃），并且要触发这一点我们必须**alloc the same size or the program will crash.**

So, to trigger the write of `main_arena + 0x68` in `__malloc_hook` we perform after setting `__malloc_hook` in `unsorted_bin_ptr->bk` we just need to do: **`malloc(0x80)`**

### Step 3: Set \_\_malloc_hook to system

In step one we controlled a chunk containing `__malloc_hook` (in the variable `malloc_hook_chunk`) and in the second step we managed to write `main_arena + 0x68` there.

Now, we abuse a partial overwrite in `malloc_hook_chunk` to use the libc address we wrote there (`main_arena + 0x68`) to **point to a `one_gadget` address**.

Here is where it's needed to **bruteforce 12 bits of randomness** (more info in the [how2heap](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)[ example](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)).

Finally, once the correct address is overwritten, **call `malloc` and trigger the `one_gadget`**.

## Modern tips & variants

- **Unsorted-bin check in 2.29+:** 如果必须在 2.29–2.33 上运行，在触发写入之前同时破坏 `fd` **和** `bk` 以满足完整性检查；否则 `_int_malloc` 会中止。成功率很低，通常只有在暴力破解的 CTF 场景下可行。
- **Hook removal (2.34+):** 随着 `__malloc_hook` 被移除，应将该原语改为落在任何你以后可以重用的可写 GOT/全局变量上（例如，在 non-PIE 二进制中覆盖 `exit@GOT`），或者转向 **House of Pie** 风格的 top‑chunk 劫持来控制 `top` 而不是 hook。
- **Any‑address fastbin alloc (2024 gist):** 最近的一篇 writeup 展示了重用相同的 grooming，通过先将一个 libc 指针放入 fastbin 然后在修复前重新指向它，来在 fastbin 上分配覆盖 `__free_hook` 或其他全局变量。这在 2.24–2.28 上有效，但在 2.29 的完整性检查下仍会失败。

## References

- [https://github.com/shellphish/how2heap](https://github.com/shellphish/how2heap)
- [https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c](https://github.com/shellphish/how2heap/blob/master/glibc_2.23/house_of_roman.c)
- [https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/](https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/house_of_roman/)
- [https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html](https://halloween.synacktiv.com/publications/heap-tricks-never-get-old-insomnihack-teaser-2022.html)
- [https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc](https://gist.github.com/romanking98/9aab2804832c0fb46615f025e8ffb0bc)

{{#include ../../banners/hacktricks-training.md}}
