# Tcache Bin Attack

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

Za više informacija o tome šta je Tcache bin, proverite ovu stranicu:

{{#ref}}
bins-and-memory-allocations.md
{{#endref}}

Prvo, imajte na umu da je Tcache uveden u Glibc verziji 2.26.

**Tcache attack** (poznat i kao **Tcache poisoning**) predložen na [**guyinatuxido stranici**](https://guyinatuxedo.github.io/29-tcache/tcache_explanation/index.html) je veoma sličan fast bin attack-u gde je cilj prepisati pokazivač na sledeći chunk u binu unutar oslobođenog chanka na proizvoljnu adresu kako bi kasnije bilo moguće **alokovati tu specifičnu adresu i potencijalno prepisati pokazivače**.

Međutim, danas, ako pokrenete pomenuti kod dobićete grešku: **`malloc(): unaligned tcache chunk detected`**. Dakle, potrebno je napisati kao adresu u novom pokazivaču usklađenu adresu (ili izvršiti binarni kod dovoljno puta tako da je napisana adresa zapravo usklađena).

### Tcache indexes attack

Obično je moguće pronaći na početku heap-a chunk koji sadrži **broj chunk-ova po indeksu** unutar tcache-a i adresu **glavnog chanka svakog tcache indeksa**. Ako iz nekog razloga bude moguće izmeniti ove informacije, bilo bi moguće **naterati glavni chunk nekog indeksa da pokazuje na željenu adresu** (kao što je `__malloc_hook`) kako bi se zatim alokovao chunk veličine indeksa i prepisali sadržaji `__malloc_hook` u ovom slučaju.

## Examples

- CTF [https://guyinatuxedo.github.io/29-tcache/dcquals19_babyheap/index.html](https://guyinatuxedo.github.io/29-tcache/dcquals19_babyheap/index.html)
- **Libc info leak**: Moguće je napuniti tcache, dodati chunk u nesortiranu listu, isprazniti tcache i **ponovo alocirati chunk iz nesortiranog bina** samo prepisujući prvih 8B, ostavljajući **drugom adresu do libc iz chanka netaknutom kako bismo je mogli pročitati**.
- **Tcache attack**: Binarni kod je ranjiv na 1B heap overflow. Ovo će se iskoristiti za promenu **header-a veličine** alociranog chanka čineći ga većim. Zatim, ovaj chunk će biti **oslobođen**, dodajući ga u tcache chunk-ova lažne veličine. Zatim ćemo alocirati chunk sa lažnom veličinom, a prethodni chunk će biti **vraćen znajući da je ovaj chunk zapravo bio manji** i to nam daje priliku da **prepišemo sledeći chunk u memoriji**.\
Iskoristićemo ovo da **prepišemo FD pokazivač sledećeg chanka** da pokazuje na **`malloc_hook`**, tako da je moguće alocirati 2 pokazivača: prvo legitiman pokazivač koji smo upravo izmenili, a zatim će druga alokacija vratiti chunk u **`malloc_hook`** koji je moguće iskoristiti za pisanje **one gadget**.
- CTF [https://guyinatuxedo.github.io/29-tcache/plaid19_cpp/index.html](https://guyinatuxedo.github.io/29-tcache/plaid19_cpp/index.html)
- **Libc info leak**: Postoji korišćenje nakon oslobađanja i dvostruko oslobađanje. U ovom izveštaju autor je iscurio adresu libc čitajući adresu chanka postavljenog u mali bin (kao da je iscurio iz nesortiranog bina, ali iz malog).
- **Tcache attack**: Tcache se vrši putem **dvostrukog oslobađanja**. Isti chunk se oslobađa dva puta, tako da će unutar Tcache-a chunk pokazivati na sebe. Zatim se alocira, njegov FD pokazivač se menja da pokazuje na **free hook** i zatim se ponovo alocira tako da će sledeći chunk na listi biti u free hook-u. Zatim se ovo takođe alocira i moguće je ovde napisati adresu `system` tako da kada se malloc koji sadrži `"/bin/sh"` oslobodi, dobijamo shell.
- CTF [https://guyinatuxedo.github.io/44-more_tcache/csaw19_popping_caps0/index.html](https://guyinatuxedo.github.io/44-more_tcache/csaw19_popping_caps0/index.html)
- Glavna ranjivost ovde je sposobnost da se `free` bilo koja adresa u heap-u ukazivanjem na njen offset.
- **Tcache indexes attack**: Moguće je alocirati i osloboditi chunk veličine koja kada se čuva unutar tcache chanka (chanka sa informacijama o tcache binovima) generiše **adresu sa vrednošću 0x100**. Ovo je zato što tcache čuva broj chunk-ova u svakom binu u različitim bajtovima, stoga jedan chunk u jednom specifičnom indeksu generiše vrednost 0x100.
- Zatim, ova vrednost izgleda kao da postoji chunk veličine 0x100. Omogućavajući da se iskoristi `free` ova adresa. Ovo će **dodati tu adresu u indeks chunk-ova veličine 0x100 u tcache**.
- Zatim, **alokacija** chanka veličine **0x100**, prethodna adresa će biti vraćena kao chunk, omogućavajući prepisivanje drugih tcache indeksa.\
Na primer, stavljajući adresu malloc hook-a u jedan od njih i alocirajući chunk veličine tog indeksa dobićemo chunk u calloc hook-u, što omogućava pisanje one gadget za dobijanje shell-a.
- CTF [https://guyinatuxedo.github.io/44-more_tcache/csaw19_popping_caps1/index.html](https://guyinatuxedo.github.io/44-more_tcache/csaw19_popping_caps1/index.html)
- Ista ranjivost kao pre sa jednim dodatnim ograničenjem.
- **Tcache indexes attack**: Sličan napad kao prethodni, ali koristeći manje koraka oslobađanjem chanka koji sadrži tcache informacije tako da se njegova adresa dodaje u tcache indeks njegove veličine, tako da je moguće alocirati tu veličinu i dobiti tcache chunk informacije kao chunk, što omogućava dodavanje free hook-a kao adrese jednog indeksa, alocirati ga i napisati one gadget na njemu.
- [**Math Door. HTB Cyber Apocalypse CTF 2023**](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/math-door/)
- **Write After Free** da se doda broj u `fd` pokazivač.
- Potrebno je puno **heap feng-shui** u ovom izazovu. Izveštaj pokazuje kako je **kontrola glave Tcache** free-liste prilično korisna.
- **Glibc leak** kroz `stdout` (FSOP).
- **Tcache poisoning** za dobijanje proizvoljne write primitive.

{{#include ../../banners/hacktricks-training.md}}
