# WWW2Exec - sips ICC Profile Out-of-Bounds Write (CVE-2024-44236)

{{#include ../../banners/hacktricks-training.md}}

## Επισκόπηση

Μια ευπάθεια εκτός ορίων εγγραφής στο Apple macOS Scriptable Image Processing System (`sips`) ICC profile parser (macOS 15.0.1, sips-307) λόγω ακατάλληλης επικύρωσης του πεδίου `offsetToCLUT` στα tags `lutAToBType` (`mAB `) και `lutBToAType` (`mBA `). Ένα κατασκευασμένο αρχείο ICC μπορεί να προκαλέσει μηδενικές εγγραφές έως 16 bytes πέρα από το heap buffer, διαφθείροντας τα μεταδεδομένα του heap ή τους δείκτες συναρτήσεων και επιτρέποντας την εκτέλεση αυθαίρετου κώδικα (CVE-2024-44236).

## Ευάλωτος Κώδικας

Η ευάλωτη συνάρτηση διαβάζει και μηδενίζει 16 bytes ξεκινώντας από μια θέση που ελέγχεται από τον επιτιθέμενο χωρίς να διασφαλίζει ότι βρίσκεται εντός του κατανεμημένου buffer:
```c
// Pseudocode from sub_1000194D0 in sips-307 (macOS 15.0.1)
for (i = offsetToCLUT; i < offsetToCLUT + 16; i++) {
if (i > numberOfInputChannels && buffer[i] != 0)
buffer[i] = 0;
}
```
Μόνο ένας έλεγχος `offsetToCLUT <= totalDataLength` εκτελείται. Ορίζοντας `offsetToCLUT == tagDataSize`, ο βρόχος δείχνει μέχρι 16 byte πέρα από το τέλος του `buffer`, διαφθείροντας τα γειτονικά μεταδεδομένα της στοίβας.

## Βήματα Εκμετάλλευσης

1. **Δημιουργία κακόβουλου προφίλ `.icc`:**
- Δημιουργήστε την κεφαλίδα ICC (128 byte) με υπογραφή `acsp` και μία μόνο είσοδο `lutAToBType` ή `lutBToAType`.
- Στον πίνακα ετικετών, ορίστε το `offsetToCLUT` ίσο με το `size` της ετικέτας (`tagDataSize`).
- Τοποθετήστε δεδομένα που ελέγχονται από τον επιτιθέμενο αμέσως μετά το μπλοκ δεδομένων της ετικέτας για να αντικαταστήσετε τα μεταδεδομένα της στοίβας.
2. **Ενεργοποίηση ανάλυσης:**

```bash
sips --verifyColor malicious.icc
```

3. **Διαφθορά μεταδεδομένων στοίβας:** Οι OOB μηδενικές εγγραφές αντικαθιστούν τα μεταδεδομένα του αλγορίθμου ή τους γειτονικούς δείκτες, επιτρέποντας στον επιτιθέμενο να αναλάβει τον έλεγχο ροής και να επιτύχει εκτέλεση αυθαίρετου κώδικα στο πλαίσιο της διαδικασίας `sips`.

## Επιπτώσεις

Η επιτυχής εκμετάλλευση έχει ως αποτέλεσμα την απομακρυσμένη εκτέλεση αυθαίρετου κώδικα με δικαιώματα χρήστη σε συστήματα macOS που εκτελούν το ευάλωτο εργαλείο `sips`.

## Ανίχνευση

- Παρακολουθήστε τις μεταφορές αρχείων σε κοινά πρωτόκολλα (FTP, HTTP/S, IMAP, SMB, NFS, SMTP).
- Εξετάστε τα μεταφερόμενα αρχεία με υπογραφή `acsp`.
- Για κάθε ετικέτα `mAB ` ή `mBA `, επαληθεύστε αν το πεδίο `Offset to CLUT` είναι ίσο με το `Tag data size`.
- Σημειώστε ως ύποπτο αν πληρούται αυτή η προϋπόθεση.

## Αναφορές

- ZDI blog: CVE-2024-44236: Ευπάθεια Εκτέλεσης Κώδικα από Απόσταση στο Εργαλείο sips της Apple macOS
https://www.thezdi.com/blog/2025/5/7/cve-2024-44236-remote-code-execution-vulnerability-in-apple-macos
- Ενημέρωση Ασφαλείας Apple Οκτωβρίου 2024 (patch που αποστέλλει το CVE-2024-44236)
https://support.apple.com/en-us/121564

{{#include /banners/hacktricks-training.md}}
