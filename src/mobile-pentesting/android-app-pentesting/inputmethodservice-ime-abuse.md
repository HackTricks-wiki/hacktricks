# Android IME / InputMethodService Missbrauch (bösartige Tastaturen)

{{#include ../../banners/hacktricks-training.md}}

## Übersicht

Android erlaubt Drittanbieter-Tastaturen über einen `InputMethodService` (IME). Sobald ein Benutzer eine Tastatur **aktiviert** und sie als **aktuelles Eingabemedium** auswählt, kann die IME im Grunde genommen **alle Texteingaben** auf dem Gerät über Apps hinweg beobachten (und beeinflussen).

Dies ist der Grund, warum mehrere Android banking trojans eine „secure keyboard“-Funktion bündeln: die bösartige IME empfängt Tastenanschläge sogar von Apps, die niemals ein `WebView` einbetten (Banking-Apps, Chat-Apps, Krypto-Wallets, etc.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` wird typischerweise auf dem IME-*service* deklariert, sodass nur das System sich damit binden kann. Allein durch die Deklaration werden keine besonderen Privilegien gewährt; der entscheidende Schritt ist, das Opfer dazu zu bringen, die Tastatur in den Einstellungen zu **aktivieren/auszuwählen**.

## Manifest-Deklaration

Eine Tastatur wird über einen Service mit der Intent-Action `android.view.InputMethod` und einer IME-Konfigurations-XML exponiert:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Erkennungstipp:** Eine nicht wie eine Tastatur aussehende App, die ein `InputMethodService` deklariert, ist ein starkes Warnzeichen.

## Woher die Daten stammen

Zur Laufzeit erfährt ein IME:

- Die **Ziel-App**, in die getippt wird (über `EditorInfo`, z. B. `attribute.packageName` in `onStartInput`).
- Der eingegebene Text (durch die Interaktion des IME mit der aktuellen `InputConnection` und/oder Key-Events, abhängig von der Implementierung).

Minimale (nicht-funktionale) Skizze des high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Häufiger Aktivierungs- & Sammelablauf (in der Praxis beobachtet)

- Die APK wird als „sichere Tastatur“ vermarktet oder die Tastatur ist in einen größeren trojan eingebettet.
- Die Malware bringt das Opfer in die System-Tastatureinstellungen (z. B. durch Starten von `Settings.ACTION_INPUT_METHOD_SETTINGS` und/oder Verwendung von UI automation), bis das IME aktiviert und als Standard gesetzt ist.
- Tastatureingaben werden pro App gepuffert und über den bestehenden C2-Kanal der Malware exfiltrated, oft kombiniert mit anderen Datenquellen (z. B. `WebView` man-in-the-browser Telemetrie).

## Wie erkennen / triagieren

### Prüfungen auf dem Gerät

- **Einstellungen**: Installierte Tastaturen / Standardtastatur (nach unbekannten IMEs suchen).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Statische Triage einer APK

- Suche nach `InputMethodService`-Klassen und dem Intent-Filter `android.view.InputMethod`.
- Untersuche die `@xml/*` IME-Konfiguration, auf die `android.view.im` verweist.
- Prüfe, ob die angegebene Funktionalität der App damit übereinstimmt, dass sie eine vollständige Tastatur-UI und -Ressourcen bereitstellt.

## Gegenmaßnahmen

- **User/MDM**: vertrauenswürdige Tastaturen zulassen; unbekannte IMEs in verwalteten Profilen/Geräten blockieren.
- **App-seitig (Apps mit hohem Risiko)**: Bevorzuge phishing-resistente Authentifizierung (passkeys/biometrics) und vermeide es, dich auf „secret text entry“ als Sicherheitsgrenze zu verlassen (ein bösartiges IME sitzt unterhalb der App-UI).
