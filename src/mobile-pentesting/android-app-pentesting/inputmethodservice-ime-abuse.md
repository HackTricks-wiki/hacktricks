# Android IME / InputMethodService Abuse (Teclados Maliciosos)

{{#include ../../banners/hacktricks-training.md}}

## Visão geral

Android permite teclados de terceiros via um `InputMethodService` (IME). Depois que um usuário **habilita** um teclado e o seleciona como o **método de entrada atual**, o IME pode observar (e influenciar) essencialmente **toda a entrada de texto** produzida no dispositivo em todos os apps.

É por isso que vários Android banking trojans incorporam um recurso de “teclado seguro”: o IME malicioso recebe as teclas mesmo de apps que nunca incorporam um `WebView` (apps bancários, apps de chat, carteiras cripto, etc.).

> [!NOTE]
> A permissão `android.permission.BIND_INPUT_METHOD` é tipicamente declarada no *service* do IME para que apenas o sistema possa vinculá-lo. Declarar essa permissão por si só não concede privilégios especiais; o passo crítico é fazer com que a vítima **habilite/selecione** o teclado nas Configurações.

## Declaração no Manifest

Um teclado é exposto através de um service com a action de intent `android.view.InputMethod` e um XML de configuração do IME:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Hunting tip:** um aplicativo que não aparenta ser um teclado e que declara um `InputMethodService` é um forte sinal de alerta.

## De onde vêm os dados

Em tempo de execução, um IME aprende:

- O **aplicativo alvo** no qual está sendo digitado (via `EditorInfo`, por exemplo `attribute.packageName` em `onStartInput`).
- O texto sendo inserido (através da interação do IME com o `InputConnection` atual e/ou eventos de tecla dependendo da implementação).

Esboço mínimo (não funcional) do high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Fluxo comum de ativação e coleta (observado no mundo real)

- O APK é comercializado como um “teclado seguro” ou o teclado está embutido dentro de um trojan mais amplo.
- O malware conduz a vítima para as configurações de teclado do sistema (por exemplo iniciando `Settings.ACTION_INPUT_METHOD_SETTINGS` e/ou usando automação de UI) até que o IME seja habilitado e definido como padrão.
- As teclas digitadas são armazenadas por aplicativo e exfiltradas através do canal C2 existente do malware, frequentemente combinadas com outras fontes de dados (por exemplo, telemetria man-in-the-browser do `WebView`).

## Como detectar / triar

### Verificações no dispositivo

- **Configurações**: Teclados instalados / teclado padrão (procure por IMEs desconhecidos).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Triagem estática de um APK

- Procure por classes `InputMethodService` e pelo intent filter `android.view.InputMethod`.
- Inspecione a configuração IME `@xml/*` referenciada por `android.view.im`.
- Verifique se a funcionalidade declarada do aplicativo corresponde a fornecer uma UI/recursos de teclado completa.

## Mitigações

- **User/MDM**: colocar em allowlist teclados confiáveis; bloquear IMEs desconhecidos em perfis/dispositivos gerenciados.
- **App-side (high risk apps)**: prefira autenticação resistente a phishing (passkeys/biometria) e evite confiar na "entrada de texto secreta" como limite de segurança (um IME malicioso fica abaixo da UI do aplicativo).
