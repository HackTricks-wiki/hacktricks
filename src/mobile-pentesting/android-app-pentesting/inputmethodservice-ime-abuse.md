# Android IME / InputMethodService zloupotreba (zlonamerne tastature)

{{#include ../../banners/hacktricks-training.md}}

## Pregled

Android dozvoljava tastature trećih strana preko `InputMethodService` (IME). Kada korisnik **omogući** tastaturu i **izabere** je kao **trenutni metod unosa**, IME može da posmatra (i utiče na) praktično **sav unos teksta** napravljen na uređaju preko aplikacija.

Zbog toga nekoliko Android banking trojans uključuje funkciju „secure keyboard“: zlonamerni IME prima pritiske tastera čak i iz aplikacija koje nikada ne ugrađuju `WebView` (bankarske aplikacije, chat aplikacije, kripto novčanici, itd.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` je obično deklarisan na IME *service* tako da samo sistem može da se bind-uje na njega. Deklarisanje samo po sebi ne daje posebne privilegije; ključni korak je navesti žrtvu da **omogući/izabere** tastaturu u Settings.

## Deklaracija u manifestu

Tastatura se izlaže preko servisa sa `android.view.InputMethod` intent akcijom i IME konfiguracionim XML-om:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Hunting tip:** aplikacija koja ne liči na tastaturu, a deklariše `InputMethodService`, predstavlja jak razlog za uzbunu.

## Odakle dolaze podaci

Tokom izvršavanja IME saznaje:

- **ciljna aplikacija** u koju se unosi tekst (putem `EditorInfo`, npr. `attribute.packageName` u `onStartInput`).
- Tekst koji se unosi (kroz interakciju IME-a sa trenutnim `InputConnection` i/ili key events u zavisnosti od implementacije).

Minimalna (nefunkcionalna) skica high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Česti tok aktivacije i prikupljanja (zabeleženo u stvarnom okruženju)

- APK se plasira kao "secure keyboard" ili je tastatura integrisana u širi trojan.
- Malver navodi žrtvu u podešavanja sistemske tastature (npr. pokretanjem `Settings.ACTION_INPUT_METHOD_SETTINGS` i/ili korišćenjem UI automation) dok IME ne bude omogućen i postavljen kao podrazumevani.
- Unosi sa tastature (keystrokes) se čuvaju po aplikaciji i eksfiltriraju preko postojećeg C2 kanala malvera, često u kombinaciji sa drugim izvorima podataka (npr. `WebView` man-in-the-browser telemetrija).

## Kako otkriti / trijaža

### Provere na uređaju

- **Settings**: Instalirane tastature / podrazumevana tastatura (potražite nepoznate IMEs).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Statička trijaža APK-a

- Potražite klase `InputMethodService` i intent filter `android.view.InputMethod`.
- Pregledajte `@xml/*` IME konfiguraciju na koju se poziva `android.view.im`.
- Proverite da li deklarisana funkcionalnost aplikacije odgovara tome da aplikacija isporučuje kompletnu tastaturu (UI i resurse).

## Mitigacije

- **User/MDM**: dozvolite samo pouzdane tastature (allowlist); blokirajte nepoznate IME u upravljanim profilima/uređajima.
- **App-side (high risk apps)**: preferirajte autentifikaciju otpornu na phishing (passkeys/biometrics) i izbegavajte oslanjanje na “secret text entry” kao bezbednosnu granicu (zlonamerni IME se nalazi ispod UI aplikacije).
