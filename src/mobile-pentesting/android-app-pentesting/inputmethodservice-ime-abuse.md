# Android IME / InputMethodService Abuse (Malicious Keyboards)

{{#include ../../banners/hacktricks-training.md}}

## Muhtasari

Android inaruhusu kibodi za wahusika wa tatu kupitia `InputMethodService` (IME). Mara mtumiaji **anapoiwezesha** kibodi na kui-chagua kama **njia ya kuingiza inayotumika sasa**, IME inaweza kuangalia (na kuathiri) takriban **ingizo zote za maandishi** zinazotolewa kwenye kifaa kupitia programu mbalimbali.

Hii ndiyo sababu trojans za benki za Android nyingi hujumuisha kipengele cha “secure keyboard”: IME mbaya hupokea vitufe hata kutoka kwa programu ambazo hazijawahi kuingiza `WebView` (programu za benki, programu za mazungumzo, pochi za crypto, n.k.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` kawaida hutangazwa kwenye IME *service* ili mfumo pekee uweze kuibandika. Kutangaza hakupi ruhusa maalum yenyewe; hatua muhimu ni kupata mwanaathiriwa **aweze/ai-chague** kibodi katika Settings.

## Manifest declaration

Kibodi inaonyeshwa kupitia service yenye kitendo cha nia `android.view.InputMethod` na XML ya usanidi ya IME:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Kidokezo:** programu isiyoonekana kama kibodi ambayo inatangaza `InputMethodService` ni ishara kali ya hatari.

## Chanzo la data

Wakati wa utekelezaji, IME inajifunza:

- Programu **lengwa** inayokuwa ikandikwa (kupitia `EditorInfo`, kwa mfano `attribute.packageName` katika `onStartInput`).
- Maandishi yanayoingizwa (kupitia mwingiliano wa IME na `InputConnection` ya sasa na/au matukio ya vitufe, kulingana na utekelezaji).

Mchoro mdogo (usiofanya kazi) wa high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Mtiririko wa kawaida wa kuwezesha na ukusanyaji (ulioonekana katika mazingira halisi)

- APK inauzwa kama “secure keyboard” au keyboard imejumuishwa ndani ya trojan pana.
- Malware inaelekeza victim kwenye mipangilio ya system keyboard (mfano kwa kuanzisha `Settings.ACTION_INPUT_METHOD_SETTINGS` na/au kutumia UI automation) hadi IME iwe imewezeshwa na kuwekwa kama default.
- Keystrokes zinabuffer kwa kila app na exfiltrated kupitia chaneli ya C2 ya malware iliyopo, mara nyingi zikichanganywa na vyanzo vingine vya data (mfano, `WebView` man-in-the-browser telemetry).

## Jinsi ya kugundua / kutathmini

### Ukaguzi kwenye kifaa

- **Mipangilio**: Installed keyboards / default keyboard (tazama IME zisizojulikana).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Triage ya static ya APK

- Tafuta madarasa `InputMethodService` na intent filter ya `android.view.InputMethod`.
- Chunguza `@xml/*` usanidi wa IME unaorejelewa na `android.view.im`.
- Kagua kama utendaji uliotajwa wa app unalingana na kusafirisha UI/rasilimali kamili ya keyboard.

## Kupunguza hatari

- **User/MDM**: allowlist keyboards zilizoaminika; zuia IMEs zisizojulikana katika managed profiles/devices.
- **App-side (high risk apps)**: pendelea uthibitishaji unaostahimili phishing (passkeys/biometrics) na epuka kutegemea “secret text entry” kama mipaka ya usalama (a malicious IME sits below the app UI).
