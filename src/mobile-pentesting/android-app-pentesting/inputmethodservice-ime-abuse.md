# Android IME / InputMethodService 滥用（恶意键盘）

{{#include ../../banners/hacktricks-training.md}}

## 概述

Android 允许通过 `InputMethodService` (IME) 使用第三方键盘。一旦用户 **启用** 某个键盘并将其选择为 **当前输入法**，IME 就能观察（并影响）设备上跨应用产生的几乎所有 **文本输入**。

这就是为什么一些 Android 银行木马会捆绑“安全键盘”功能：恶意 IME 即使从未嵌入 `WebView` 的应用（银行应用、聊天应用、crypto wallets 等）也能接收按键。

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` 通常在 IME 的 *service* 上声明，因此只有系统可以绑定到它。仅声明它本身并不会授予特殊权限；关键步骤是让受害者在设置中 **启用/选择** 该键盘。

## Manifest declaration

A keyboard is exposed via a service with the `android.view.InputMethod` intent action and an IME configuration XML:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**侦测提示：** 声明了 `InputMethodService` 却看起来不是键盘的应用是一个强烈的警示信号。

## 数据来源

运行时 IME 会获取：

- 正在输入的 **目标应用**（通过 `EditorInfo`，例如 `onStartInput` 中的 `attribute.packageName`）。
- 正在输入的文本（通过 IME 与当前 `InputConnection` 的交互和/或按键事件，取决于实现）。

高信号挂钩点的最小（非功能性）示意：
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Common enablement & collection workflow (observed in the wild)

- The APK is marketed as a “安全键盘” or the keyboard is embedded inside a broader trojan.
- The malware drives the victim into the system keyboard settings (e.g. by launching `Settings.ACTION_INPUT_METHOD_SETTINGS` and/or using UI automation) until the IME is enabled and set as default.
- Keystrokes are buffered per-app and exfiltrated via the malware’s existing C2 channel, often combined with other data sources (e.g., `WebView` man-in-the-browser telemetry).

## How to detect / triage

### On-device checks

- **Settings**: 已安装的键盘 / 默认键盘（查找未知的 IMEs）。
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### APK 的静态初筛

- 查找 `InputMethodService` 类和 `android.view.InputMethod` intent 过滤器。
- 检查由 `android.view.im` 引用的 `@xml/*` IME 配置。
- 核对应用声明的功能是否与发布完整键盘 UI/资源 相符。

## Mitigations

- **User/MDM**：将受信任的键盘列入允许列表；在受管理的配置文件/设备中阻止未知 IME。
- **App-side (high risk apps)**：优先使用抗钓鱼的认证（passkeys/biometrics），并避免将“secret text entry”作为安全边界（恶意 IME 位于应用 UI 之下）。
