# Android IME / InputMethodService Κατάχρηση (Κακόβουλα Πληκτρολόγια)

{{#include ../../banners/hacktricks-training.md}}

## Επισκόπηση

Το Android επιτρέπει πληκτρολόγια τρίτων μέσω ενός `InputMethodService` (IME). Μόλις ένας χρήστης **ενεργοποιήσει** ένα πληκτρολόγιο και το επιλέξει ως την **τρέχουσα μέθοδο εισαγωγής**, το IME μπορεί να παρακολουθεί (και να επηρεάζει) ουσιαστικά **όλη την εισαγωγή κειμένου** που παράγεται στη συσκευή σε όλες τις εφαρμογές.

Αυτός είναι ο λόγος που αρκετοί Android banking trojans ενσωματώνουν μια λειτουργία “secure keyboard”: το κακόβουλο IME λαμβάνει πατήματα πλήκτρων ακόμη και από εφαρμογές που δεν ενσωματώνουν `WebView` (τραπεζικές εφαρμογές, εφαρμογές συνομιλίας, πορτοφόλια κρυπτονομισμάτων κ.λπ.).

> [!NOTE]
> Η άδεια `android.permission.BIND_INPUT_METHOD` δηλώνεται συνήθως στην IME *service* ώστε μόνο το σύστημα να μπορεί να δεθεί σε αυτήν. Η δήλωσή της δεν παραχωρεί ειδικά προνόμια από μόνη της· το κρίσιμο βήμα είναι να κάνετε το θύμα να **ενεργοποιήσει/επιλέξει** το πληκτρολόγιο στις Ρυθμίσεις.

## Δήλωση στο Manifest

Ένα πληκτρολόγιο εκτίθεται μέσω μιας υπηρεσίας με το intent action `android.view.InputMethod` και ένα IME configuration XML:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Συμβουλή ανίχνευσης:** μια εφαρμογή που δεν μοιάζει με πληκτρολόγιο και δηλώνει `InputMethodService` αποτελεί σοβαρή ένδειξη κινδύνου.

## Από πού προέρχονται τα δεδομένα

Σε χρόνο εκτέλεσης ένα IME μαθαίνει:

- Η **εφαρμογή-στόχος** στην οποία γίνεται πληκτρολόγηση (μέσω `EditorInfo`, π.χ. `attribute.packageName` στο `onStartInput`).
- Το κείμενο που εισάγεται (μέσω της αλληλεπίδρασης του IME με την τρέχουσα `InputConnection` και/ή key events ανάλογα με την υλοποίηση).

Ελάχιστο (μη λειτουργικό) σκαρίφημα του high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Συνηθισμένη ροή ενεργοποίησης και συλλογής (παρατηρήθηκε σε πραγματικές επιθέσεις)

- Το APK προωθείται ως «ασφαλές πληκτρολόγιο» ή το πληκτρολόγιο είναι ενσωματωμένο μέσα σε ένα ευρύτερο trojan.
- Το malware οδηγεί το θύμα στις ρυθμίσεις συστήματος του πληκτρολογίου (π.χ. εκκινώντας `Settings.ACTION_INPUT_METHOD_SETTINGS` και/ή χρησιμοποιώντας UI automation) μέχρι το IME να ενεργοποιηθεί και να οριστεί ως προεπιλεγμένο.
- Keystrokes αποθηκεύονται ανά εφαρμογή και exfiltrated μέσω του υπάρχοντος C2 channel του malware, συχνά σε συνδυασμό με άλλες πηγές δεδομένων (π.χ., `WebView` man-in-the-browser telemetry).

## Πώς να εντοπίσετε / αξιολογήσετε

### Έλεγχοι στη συσκευή

- **Settings**: Installed keyboards / default keyboard (ελέγξτε για άγνωστα IMEs).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Στατική αξιολόγηση ενός APK

- Αναζητήστε κλάσεις `InputMethodService` και το intent filter `android.view.InputMethod`.
- Επιθεωρήστε το IME config `@xml/*` που αναφέρεται από `android.view.im`.
- Ελέγξτε αν η δηλωμένη λειτουργικότητα της εφαρμογής αντιστοιχεί στην αποστολή πλήρους διεπαφής πληκτρολογίου/πόρων.

## Μέτρα αντιμετώπισης

- **Χρήστης/MDM**: allowlist έμπιστα πληκτρολόγια; block άγνωστα IMEs σε διαχειριζόμενα προφίλ/συσκευές.
- **Στην πλευρά της εφαρμογής (εφαρμογές υψηλού κινδύνου)**: προτιμήστε phishing-resistant auth (passkeys/biometrics) και αποφύγετε να βασίζεστε στη “secret text entry” ως όριο ασφάλειας (ένα malicious IME κάθεται κάτω από το app UI).
