# Android IME / InputMethodService Зловживання (шкідливі клавіатури)

{{#include ../../banners/hacktricks-training.md}}

## Огляд

Android дозволяє сторонні клавіатури через `InputMethodService` (IME). Після того, як користувач **увімкне** клавіатуру й обере її як **поточний метод вводу**, IME може спостерігати (та впливати) фактично за **усім текстовим введенням**, що генерується на пристрої в різних додатках.

Це причина, чому кілька Android banking trojans комплектують функцію «secure keyboard»: шкідливий IME отримує натискання клавіш навіть від додатків, які ніколи не вбудовують `WebView` (банківські додатки, чати, криптогаманці тощо).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` типово декларується для IME *сервісу*, тож лише система може підключитися до нього. Само по собі декларування не надає особливих привілеїв; ключовим є змусити жертву **увімкнути/вибрати** клавіатуру в Налаштуваннях.

## Manifest declaration

A keyboard is exposed via a service with the `android.view.InputMethod` intent action and an IME configuration XML:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Порада для пошуку:** додаток, що не схожий на клавіатуру, який оголошує `InputMethodService`, є сильним червоним прапорцем.

## Звідки беруться дані

Під час виконання IME дізнається:

- **цільовий додаток**, у яке вводять текст (через `EditorInfo`, наприклад `attribute.packageName` в `onStartInput`).
- Текст, що вводиться (через взаємодію IME з поточним `InputConnection` та/або подіями клавіш залежно від реалізації).

Мінімальний (нефункціональний) ескіз high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Загальний робочий процес активації та збору (спостерігався в реальних умовах)

- APK рекламується як «безпечна клавіатура» або клавіатура вбудована в більший trojan.
- malware змушує жертву перейти в системні налаштування клавіатури (наприклад, запустивши `Settings.ACTION_INPUT_METHOD_SETTINGS` та/або використовуючи UI automation), поки IME не буде увімкнено та не встановлено за замовчуванням.
- Натискання клавіш буферизуються для кожного додатка та exfiltrated через існуючий C2-канал malware, часто в поєднанні з іншими джерелами даних (наприклад, телеметрією `WebView` man-in-the-browser).

## How to detect / triage

### On-device checks

- **Settings**: Встановлені клавіатури / клавіатура за замовчуванням (перевірте на наявність невідомих IMEs).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Статичний тріаж APK

- Шукайте класи `InputMethodService` та intent-фільтр `android.view.InputMethod`.
- Перевірте конфігурацію IME `@xml/*`, на яку посилається `android.view.im`.
- Переконайтесь, чи заявлена функціональність застосунку відповідає наданню повноцінного UI/ресурсів клавіатури.

## Заходи пом'якшення

- **User/MDM**: додайте надійні клавіатури до білого списку; блокуйте невідомі IME в керованих профілях/пристроях.
- **App-side (high risk apps)**: віддавайте перевагу захищеній від фішингу аутентифікації (passkeys/biometrics) і уникайте покладатися на “secret text entry” як межу безпеки (шкідливий IME знаходиться під UI застосунку).
