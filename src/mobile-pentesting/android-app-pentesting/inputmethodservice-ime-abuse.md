# Android IME / InputMethodService 악용 (악성 키보드)

{{#include ../../banners/hacktricks-training.md}}

## 개요

Android는 `InputMethodService`(IME)를 통해 서드파티 키보드를 허용합니다. 사용자가 키보드를 **활성화**하고 이를 **현재 입력 방식**으로 선택하면, IME는 기기 전역의 앱들에서 발생하는 사실상 **모든 텍스트 입력**을 관찰(및 영향을 미치)할 수 있습니다.

이 때문에 여러 Android 뱅킹 트로이목마는 ‘보안 키보드’ 기능을 번들로 포함합니다: 악성 IME는 `WebView`를 포함하지 않는 앱(뱅킹 앱, 채팅 앱, 암호화폐 지갑 등)에서도 키스트로크를 수신합니다.

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD`은 일반적으로 IME *service*에 선언되어 시스템만 바인드할 수 있도록 합니다. 선언 자체가 특별 권한을 부여하지는 않습니다; 핵심 단계는 피해자가 설정에서 키보드를 **활성화/선택**하게 하는 것입니다.

## 매니페스트 선언

키보드는 `android.view.InputMethod` 인텐트 액션을 가진 서비스와 IME 구성 XML을 통해 노출됩니다:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**헌팅 팁:** 키보드처럼 보이지 않는 앱이 `InputMethodService`를 선언하면 강력한 경고 신호입니다.

## 데이터 출처

실행 시 IME는 다음을 알 수 있습니다:

- 입력 중인 **대상 앱** (`EditorInfo`를 통해, 예: `onStartInput`의 `attribute.packageName`).
- 입력되는 텍스트 (IME의 현재 `InputConnection`과의 상호작용 및/또는 구현에 따라 키 이벤트를 통해).

신호가 강한 훅 포인트의 최소(비기능적) 스케치:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## 일반적인 활성화 및 수집 워크플로우 (실제로 관찰됨)

- APK는 "secure keyboard"로 홍보되거나, 키보드가 더 큰 trojan 내부에 포함되어 있습니다.
- 악성코드는 피해자를 시스템 키보드 설정으로 유도합니다(예: `Settings.ACTION_INPUT_METHOD_SETTINGS`를 실행하거나 UI 자동화를 사용해) — IME가 활성화되어 기본값으로 설정될 때까지.
- 키 입력은 앱별로 버퍼링되어 악성코드의 기존 C2 채널을 통해 유출되며, 종종 다른 데이터 소스(예: `WebView` man-in-the-browser telemetry)와 결합됩니다.

## 탐지 / 트리아지 방법

### 기기 내 검사

- **Settings**: 설치된 키보드 / 기본 키보드 (알 수 없는 IME를 찾아보세요).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### APK의 정적 선별

- `InputMethodService` 클래스와 `android.view.InputMethod` 인텐트 필터를 찾으세요.
- `android.view.im`에서 참조하는 `@xml/*` IME 구성을 검사하세요.
- 앱의 명시된 기능이 전체 키보드 UI/리소스를 탑재해 제공하는 것과 일치하는지 확인하세요.

## 완화 조치

- **사용자/MDM**: 신뢰할 수 있는 키보드를 허용 목록에 추가하고; 관리되는 프로필/기기에서는 알려지지 않은 IME를 차단하세요.
- **앱 측 (고위험 앱)**: 피싱에 강한 인증(패스키/생체인증)을 우선 사용하고, “secret text entry”를 보안 경계로 의존하지 마세요(악의적인 IME는 앱 UI 아래에 위치합니다).
