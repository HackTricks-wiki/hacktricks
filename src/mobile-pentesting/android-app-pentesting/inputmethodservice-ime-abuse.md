# Android IME / InputMethodService Kötüye Kullanımı (Kötücül Klavyeler)

{{#include ../../banners/hacktricks-training.md}}

## Genel Bakış

Android, üçüncü taraf klavyelere `InputMethodService` (IME) aracılığıyla izin verir. Bir kullanıcı bir klavyeyi **etkinleştirdiğinde** ve onu **mevcut giriş yöntemi** olarak seçtiğinde, IME uygulamalar genelinde cihazda üretilen temelde **tüm metin girişi**ni gözlemleyebilir (ve etkileyebilir).

Bu yüzden birçok Android bankacılık trojanı bir “güvenli klavye” özelliği paketler: kötü amaçlı IME, `WebView` barındırmayan uygulamalardan bile tuş vuruşlarını alır (bankacılık uygulamaları, sohbet uygulamaları, kripto cüzdanları vb.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` genellikle IME *servis* üzerinde beyan edilir, böylece yalnızca sistem ona bağlanabilir. Bunu beyan etmek tek başına özel ayrıcalık vermez; kilit adım, kurbana klavyeyi Ayarlar'da **etkinleştirmek/seçtirmek**'tir.

## Manifest bildirimi

Bir klavye, `android.view.InputMethod` intent action'ı olan bir servis aracılığıyla ve bir IME yapılandırma XML'iyle sunulur:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Avcılık ipucu:** klavye gibi görünmeyen ve bir `InputMethodService` bildiren bir uygulama büyük bir kırmızı bayraktır.

## Veriler nereden geliyor

Çalışma zamanında bir IME şunları öğrenir:

- Yazı yazılan **hedef uygulama** (`EditorInfo` aracılığıyla, ör. `attribute.packageName` içinde `onStartInput`).
- Girilen metin (IME’nin mevcut `InputConnection` ile etkileşimi ve/veya uygulamaya bağlı olarak key events aracılığıyla).

Yüksek-sinyalli hook point'in minimal (fonksiyonel olmayan) taslağı:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Yaygın etkinleştirme ve toplama iş akışı (doğada gözlemlendi)

- APK "güvenli klavye" olarak pazarlanır veya klavye daha geniş bir trojanın içine gömülüdür.
- Kötü amaçlı yazılım, mağduru sistem klavye ayarlarına yönlendirir (ör. `Settings.ACTION_INPUT_METHOD_SETTINGS` başlatarak ve/veya UI otomasyonu kullanarak) IME etkinleştirilip varsayılan yapılana kadar.
- Tuş vuruşları uygulama başına tamponlanır ve kötü amaçlı yazılımın mevcut C2 kanalından exfiltrated edilir; genellikle diğer veri kaynaklarıyla birleştirilir (ör. `WebView` man-in-the-browser telemetry).

## Nasıl tespit / triage edilir

### Cihaz üzerinde kontroller

- **Settings**: Yüklü klavyeler / varsayılan klavye (bilinmeyen IME'lere bakın).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Bir APK'nın statik ön incelemesi

- `InputMethodService` sınıflarını ve `android.view.InputMethod` intent filtresini ara.
- `android.view.im` tarafından referans verilen `@xml/*` IME yapılandırmasını incele.
- Uygulamanın beyan edilen işlevselliğinin tam bir klavye UI/kaynakları sağlamasıyla uyuşup uyuşmadığını kontrol et.

## Hafifletmeler

- **Kullanıcı/MDM**: güvenilir klavyeleri izinli listeye al; yönetilen profiller/cihazlarda bilinmeyen IME'leri engelle.
- **Uygulama tarafı (yüksek riskli uygulamalar)**: oltalama saldırılarına dayanıklı kimlik doğrulamayı (passkeys/biometrics) tercih edin ve "gizli metin girişi"ni bir güvenlik sınırı olarak kullanmaktan kaçının (kötü amaçlı bir IME uygulama UI'sının altında yer alır).
