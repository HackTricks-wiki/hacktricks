# Abuso de Android IME / InputMethodService (Teclados maliciosos)

{{#include ../../banners/hacktricks-training.md}}

## Descripción general

Android permite teclados de terceros vía un `InputMethodService` (IME). Una vez que un usuario **habilita** un teclado y lo selecciona como el **método de entrada actual**, el IME puede observar (e influir) esencialmente **todo el texto introducido** en el dispositivo a través de las apps.

Por eso varios troyanos bancarios de Android incluyen una función de “secure keyboard”: el IME malicioso recibe las pulsaciones incluso de apps que nunca incrustan un `WebView` (apps bancarias, apps de mensajería, wallets de crypto, etc.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` suele declararse en el *service* del IME para que solo el sistema pueda enlazarlo. Declararlo no concede privilegios especiales por sí mismo; el paso clave es lograr que la víctima **habilite/seleccione** el teclado en Settings.

## Declaración del manifiesto

Un teclado se expone mediante un servicio con la intent action `android.view.InputMethod` y un XML de configuración de IME:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Consejo de búsqueda:** una app que no parece un teclado y que declara un `InputMethodService` es una fuerte señal de alerta.

## De dónde provienen los datos

En tiempo de ejecución un IME aprende:

- La **app objetivo** en la que se escribe (a través de `EditorInfo`, p. ej. `attribute.packageName` en `onStartInput`).
- El texto que se introduce (a través de la interacción del IME con la `InputConnection` actual y/o eventos de tecla dependiendo de la implementación).

Esbozo mínimo (no funcional) del high-signal hook point:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Flujo común de habilitación y recolección (observado en el mundo real)

- El APK se comercializa como un “secure keyboard” o el teclado está integrado dentro de un trojan más amplio.
- El malware dirige a la víctima a la configuración de teclado del sistema (p. ej. lanzando `Settings.ACTION_INPUT_METHOD_SETTINGS` y/o usando UI automation) hasta que el IME esté habilitado y establecido como predeterminado.
- Los keystrokes se almacenan por aplicación y se exfiltran a través del canal C2 existente del malware, a menudo combinados con otras fuentes de datos (p. ej., `WebView` telemetría man-in-the-browser).

## Cómo detectar / triage

### Comprobaciones en el dispositivo

- **Settings**: teclados instalados / teclado predeterminado (buscar IMEs desconocidos).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Análisis estático de un APK

- Buscar clases `InputMethodService` y el filtro de intent `android.view.InputMethod`.
- Inspeccionar la configuración `@xml/*` IME referenciada por `android.view.im`.
- Comprobar si la funcionalidad declarada de la app coincide con incluir una UI/recursos completos de teclado.

## Mitigaciones

- **User/MDM**: allowlist teclados de confianza; bloquear IMEs desconocidos en perfiles/dispositivos gestionados.
- **App-side (high risk apps)**: preferir autenticación resistente a phishing (passkeys/biometrics) y evitar depender de “secret text entry” como límite de seguridad (un IME malicioso se sitúa por debajo de la UI de la app).
