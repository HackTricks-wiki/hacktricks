# Abus d'Android IME / InputMethodService (claviers malveillants)

{{#include ../../banners/hacktricks-training.md}}

## Présentation

Android permet des claviers tiers via un `InputMethodService` (IME). Une fois qu'un utilisateur **active** un clavier et le sélectionne comme **méthode de saisie actuelle**, l'IME peut observer (et influencer) essentiellement **toutes les saisies de texte** produites sur l'appareil à travers les applications.

C'est pour cette raison que plusieurs trojans bancaires Android intègrent une fonctionnalité de « secure keyboard » : l'IME malveillant reçoit les frappes même depuis des applications qui n'intègrent jamais de `WebView` (applications bancaires, messageries, wallets crypto, etc.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` est typiquement déclaré sur le *service* IME afin que seul le système puisse se binder à lui. Le fait de le déclarer n'accorde pas de privilèges particuliers en soi ; l'étape clé est d'amener la victime à **activer/sélectionner** le clavier dans les Settings.

## Déclaration dans le manifest

Un clavier est exposé via un service avec l'action d'intent `android.view.InputMethod` et un XML de configuration IME :
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Astuce de détection :** une application qui ne ressemble pas à un clavier et qui déclare un `InputMethodService` est un fort signal d'alerte.

## D'où proviennent les données

À l'exécution, un IME apprend :

- L'**application cible** dans laquelle on tape (via `EditorInfo`, p.ex. `attribute.packageName` dans `onStartInput`).
- Le texte saisi (via l'interaction de l'IME avec l'`InputConnection` courant et/ou les événements de touches selon l'implémentation).

Esquisse minimale (non-fonctionnelle) du point d'accroche à fort signal :
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Flux courant d'activation et de collecte (observé sur le terrain)

- L'APK est commercialisé comme un “clavier sécurisé” ou le clavier est intégré dans un trojan plus vaste.
- Le malware pousse la victime dans les paramètres clavier système (p. ex. en lançant `Settings.ACTION_INPUT_METHOD_SETTINGS` et/ou en utilisant UI automation) jusqu'à ce que l'IME soit activé et défini par défaut.
- Les frappes au clavier sont tamponnées par application et exfiltrées via le canal C2 existant du malware, souvent combinées à d'autres sources de données (p. ex., télémétrie `WebView` man-in-the-browser).

## Comment détecter / trier

### Vérifications sur l'appareil

- **Paramètres**: Claviers installés / clavier par défaut (chercher des IMEs inconnus).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Triage statique d'un APK

- Recherchez les classes `InputMethodService` et le filtre d'intent `android.view.InputMethod`.
- Inspectez la configuration IME `@xml/*` référencée par `android.view.im`.
- Vérifiez si la fonctionnalité déclarée de l'application correspond à l'inclusion d'une interface clavier complète et de ses ressources.

## Contre-mesures

- **User/MDM** : mettre sur liste blanche les claviers de confiance ; bloquer les IME inconnues dans les profils/appareils gérés.
- **App-side (high risk apps)** : privilégier l'authentification résistante au phishing (passkeys/biométrie) et éviter de compter sur la “saisie de texte secrète” comme frontière de sécurité (un IME malveillant se situe en dessous de l'UI de l'application).
