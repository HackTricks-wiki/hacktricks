# Android IME / InputMethodService Abuso (Tastiere Maligne)

{{#include ../../banners/hacktricks-training.md}}

## Panoramica

Android permette tastiere di terze parti tramite un `InputMethodService` (IME). Una volta che un utente **abilita** una tastiera e la seleziona come **metodo di input corrente**, l'IME può osservare (e influenzare) essenzialmente **tutti gli input di testo** prodotti sul dispositivo attraverso le app.

Questo è il motivo per cui diversi trojan bancari Android includono una funzione di “secure keyboard”: l'IME maligno riceve le battute anche da app che non incorporano mai una `WebView` (app bancarie, chat, crypto wallets, ecc.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` è tipicamente dichiarato sul *service* dell'IME affinché solo il sistema possa associarsi ad esso. Dichiararlo non concede privilegi speciali di per sé; il passo chiave è indurre la vittima a **abilitare/selezionare** la tastiera nelle Impostazioni.

## Dichiarazione nel Manifest

Una tastiera è esposta tramite un service con l'intent action `android.view.InputMethod` e un XML di configurazione IME:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Hunting tip:** un'app che non sembra una tastiera e dichiara un `InputMethodService` è un forte red flag.

## Da dove provengono i dati

Durante l'esecuzione un IME apprende:

- L'**target app** in cui si digita (tramite `EditorInfo`, es. `attribute.packageName` in `onStartInput`).
- Il testo inserito (tramite l'interazione dell'IME con l'`InputConnection` corrente e/o key events a seconda dell'implementazione).

Schizzo minimale (non funzionale) del punto di hook ad alto segnale:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Flusso comune di abilitazione e raccolta (osservato nel mondo reale)

- L'APK è commercializzato come una “tastiera sicura” oppure la tastiera è incorporata in un trojan più ampio.
- Il malware porta la vittima nelle impostazioni della tastiera di sistema (es. avviando `Settings.ACTION_INPUT_METHOD_SETTINGS` e/o usando UI automation) fino a quando l'IME non è abilitato e impostato come predefinito.
- Le pressioni dei tasti vengono memorizzate per-app ed esfiltrate tramite il canale C2 esistente del malware, spesso combinate con altre sorgenti di dati (es., `WebView` man-in-the-browser telemetry).

## Come rilevare / fare il triage

### Controlli sul dispositivo

- **Settings**: Tastiere installate / tastiera predefinita (cerca IME sconosciuti).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Analisi statica di un APK

- Cerca le classi `InputMethodService` e il filtro di intent `android.view.InputMethod`.
- Ispeziona i file di configurazione IME `@xml/*` referenziati da `android.view.im`.
- Verifica se la funzionalità dichiarata dell'app giustifica l'inclusione di una UI/risorse per una tastiera completa.

## Mitigazioni

- **User/MDM**: allowlist tastiere affidabili; bloccare IME sconosciuti nei profili/dispositivi gestiti.
- **Lato app (app ad alto rischio)**: preferire autenticazione resistente al phishing (passkeys/biometrics) e evitare di basarsi su “secret text entry” come confine di sicurezza (un IME malevolo si trova sotto la UI dell'app).
