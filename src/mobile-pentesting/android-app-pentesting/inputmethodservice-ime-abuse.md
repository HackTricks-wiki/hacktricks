# Nadużycie Android IME / InputMethodService (Złośliwe klawiatury)

{{#include ../../banners/hacktricks-training.md}}

## Przegląd

Android pozwala na używanie klawiatur firm trzecich za pomocą `InputMethodService` (IME). Gdy użytkownik **włączy** klawiaturę i wybierze ją jako **aktualną metodę wprowadzania**, IME może obserwować (i wpływać na) praktycznie **wszystkie wprowadzane teksty** generowane na urządzeniu we wszystkich aplikacjach.

To dlatego kilka trojanów bankowych dołącza funkcję „secure keyboard”: złośliwy IME otrzymuje naciśnięcia klawiszy nawet z aplikacji, które nigdy nie osadzają `WebView` (aplikacje bankowe, komunikatory, portfele kryptowalutowe itd.).

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` jest zazwyczaj deklarowane na IME *usłudze*, więc tylko system może się do niego związać. Deklaracja nie przyznaje sama w sobie specjalnych uprawnień; kluczowym krokiem jest nakłonienie ofiary do **włączenia/wybrania** klawiatury w Ustawieniach.

## Deklaracja w manifeście

Klawiatura jest udostępniana za pomocą serwisu z akcją intent `android.view.InputMethod` i konfiguracją IME w XML:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**Wskazówka wykrywania:** aplikacja nie wyglądająca na klawiaturę, która deklaruje `InputMethodService`, to silny znak ostrzegawczy.

## Skąd pochodzą dane

W czasie działania IME dowiaduje się:

- **Aplikacja docelowa**, do której wpisuje się tekst (przez `EditorInfo`, np. `attribute.packageName` w `onStartInput`).
- Tekst, który jest wpisywany (poprzez interakcję IME z aktualnym `InputConnection` i/lub zdarzeniami klawiszy w zależności od implementacji).

Minimalny (niefunkcjonalny) szkic punktu zaczepienia o wysokim sygnale:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## Typowy przebieg aktywacji i zbierania (zaobserwowany w rzeczywistych warunkach)

- APK jest reklamowany jako „bezpieczna klawiatura” lub klawiatura jest osadzona w ramach szerszego trojana.
- Malware kieruje ofiarę do ustawień systemowej klawiatury (np. uruchamiając `Settings.ACTION_INPUT_METHOD_SETTINGS` i/lub używając UI automation), aż IME zostanie włączone i ustawione jako domyślne.
- Wciśnięcia klawiszy są buforowane dla każdej aplikacji i eksfiltrowane przez istniejący kanał C2 malware, często łączone z innymi źródłami danych (np. `WebView` man-in-the-browser telemetry).

## Jak wykryć / przeprowadzić triage

### Kontrole na urządzeniu

- **Ustawienia**: Zainstalowane klawiatury / domyślna klawiatura (szukaj nieznanych IME).
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### Statyczna ocena pliku APK

- Szukaj klas `InputMethodService` oraz filtra intent `android.view.InputMethod`.
- Sprawdź konfigurację IME `@xml/*` odwoływaną przez `android.view.im`.
- Sprawdź, czy deklarowana funkcjonalność aplikacji uzasadnia dostarczenie pełnego interfejsu klawiatury/zasobów.

## Środki zaradcze

- **Użytkownik/MDM**: zezwalaj tylko na zaufane klawiatury; blokuj nieznane IME w zarządzanych profilach/urządzeniach.
- **Po stronie aplikacji (aplikacje wysokiego ryzyka)**: preferuj uwierzytelnianie odporne na phishing (passkeys/biometrics) i unikaj polegania na “secret text entry” jako granicy bezpieczeństwa (złośliwy IME znajduje się poniżej UI aplikacji).
