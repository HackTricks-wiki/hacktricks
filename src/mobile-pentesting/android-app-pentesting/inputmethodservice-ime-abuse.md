# Android IME / InputMethodService の悪用（悪意あるキーボード）

{{#include ../../banners/hacktricks-training.md}}

## 概要

Android は `InputMethodService` (IME) を通じてサードパーティ製キーボードを許可します。ユーザーがキーボードを **有効化** し、それを **現在の入力メソッド** として選択すると、IME はデバイス上のアプリ全体で生成されるほぼすべての **テキスト入力** を監視（および操作）できます。

このため複数の Android 向けバンキングトロイの木馬は “secure keyboard” 機能を同梱しています：悪意ある IME は、`WebView` を埋め込んでいないアプリ（銀行アプリ、チャットアプリ、暗号資産ウォレットなど）からのキー入力さえ受け取ります。

> [!NOTE]
> `android.permission.BIND_INPUT_METHOD` は通常 IME の *service* に宣言され、システムのみがそれにバインドできます。宣言するだけでは特別な権限は付与されません；重要なステップは被害者に設定でキーボードを **有効化/選択** させることです。

## Manifest 宣言

キーボードは `android.view.InputMethod` インテントアクションを持つサービスと、IME 設定用の XML によって公開されます:
```xml
<!-- AndroidManifest.xml -->
<service
android:name=".SpyKeyboard"
android:permission="android.permission.BIND_INPUT_METHOD"
android:exported="false">

<intent-filter>
<action android:name="android.view.InputMethod" />
</intent-filter>

<meta-data
android:name="android.view.im"
android:resource="@xml/spy_ime" />
</service>
```
**ハンティングのヒント:** キーボードに見えないアプリが `InputMethodService` を宣言している場合、それは強いレッドフラグです。

## データはどこから来るか

実行時、IMEは以下を把握します:

- 入力対象の**ターゲットアプリ**（`EditorInfo` 経由、例: `onStartInput` の `attribute.packageName`）。
- 入力されているテキスト（IMEが現在の `InputConnection` とやり取りすることや、実装に応じたキーイベントを通じて取得）。

高信号のフックポイントの最小（動作しない）スケッチ:
```java
public class SpyKeyboard extends InputMethodService {
@Override public void onStartInput(EditorInfo attribute, boolean restarting) {
// attribute.packageName identifies the foreground app receiving input
}
}
```
## 実際に観測された一般的な有効化と収集のワークフロー

- そのAPKは「セキュアなキーボード」として宣伝されるか、キーボードがより広範なトロイの木馬に埋め込まれている。
- マルウェアは被害者をシステムのキーボード設定に誘導し（例：`Settings.ACTION_INPUT_METHOD_SETTINGS` を起動したり、UI automation を使用したりして）、IMEが有効化され既定に設定されるまで操作を続ける。
- キーストロークはアプリ別にバッファリングされ、マルウェアの既存のC2チャネルを通じて持ち出されることが多く、他のデータソース（例：`WebView` man-in-the-browser テレメトリ）と組み合わせられることがある。

## 検出 / トリアージ方法

### デバイス上でのチェック

- **設定**: インストールされているキーボード / 既定のキーボード（不明なIMEがないか確認）。
- **ADB**:
```bash
adb shell dumpsys input_method
adb shell ime list -a
adb shell ime help
```
### APK の静的トリアージ

- `InputMethodService` クラスと `android.view.InputMethod` インテントフィルタを探す。
- `android.view.im` から参照される `@xml/*` の IME 設定を確認する。
- アプリの想定機能がフルキーボードの UI/リソースを同梱することと一致するか確認する。

## 緩和策

- **User/MDM**: 信頼できるキーボードを許可リストに登録する；管理対象プロファイル/デバイスでは不明な IME をブロックする。
- **App-side (high risk apps)**: フィッシング耐性のある認証（passkeys/biometrics）を優先し、アプリの UI より下位に位置する悪意ある IME が存在し得るため「secret text entry」をセキュリティ境界として頼らない。
