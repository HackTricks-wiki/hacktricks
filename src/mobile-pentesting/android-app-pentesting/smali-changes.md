# Smali — Décompilation/[Modification]/Compilation

{{#include ../../banners/hacktricks-training.md}}


Parfois, il est intéressant de modifier le code de l'application pour accéder à des informations cachées pour vous (par exemple des mots de passe fortement obfusqués ou des flags). Dans ce cas, il peut être utile de décompiler l'apk, modifier le code et recompiler.

**Opcodes reference:** [http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html)

## Méthode rapide

En utilisant **Visual Studio Code** et l'extension [APKLab](https://github.com/APKLab/APKLab), vous pouvez **décompiler automatiquement**, modifier, **recompiler**, signer et installer l'application sans exécuter la moindre commande.

Un autre **script** qui facilite grandement cette tâche est [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## Décompiler l'APK

En utilisant APKTool vous pouvez accéder au **smali code and resources**:
```bash
apktool d APP.apk
```
Si **apktool** vous renvoie une erreur, essayez [installing the **latest version**](https://ibotpeaches.github.io/Apktool/install/)

Some **interesting files you should look are**:

- _res/values/strings.xml_ (and all xmls inside res/values/*)
- _AndroidManifest.xml_
- Any file with extension _.sqlite_ or _.db_

If `apktool` has **problems decoding the application** take a look to [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) or try using the argument **`-r`** (Do not decode resources). Then, if the problem was in a resource and not in the source code, you won't have the problem (you won't also decompile the resources).

## Modifier le code smali

Vous pouvez **modifier** des **instructions**, changer la **valeur** de certaines variables ou **ajouter** de nouvelles instructions. Je modifie le code Smali en utilisant [**VS Code**](https://code.visualstudio.com), you then install the **smalise extension** and the editor will tell you if any **instruction is incorrect**.\
Some **examples** can be found here:

- [Smali changes examples](smali-changes.md)
- [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Or you can [**check below some Smali changes explained**](smali-changes.md#modifying-smali).

## Recompiler l'APK

Après avoir modifié le code, vous pouvez **recompiler** le code en utilisant:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Il va **compiler** le nouvel APK **dans** le dossier _**dist**_.

Si **apktool** génère une **erreur**, try[ installing the **latest version**](https://ibotpeaches.github.io/Apktool/install/)

### **Signer le nouvel APK**

Ensuite, vous devez **générer une clé** (il vous sera demandé un mot de passe et quelques informations que vous pouvez remplir aléatoirement) :
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Enfin, **signez** le nouvel APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Optimiser la nouvelle application

**zipalign** est un outil d'alignement d'archives qui apporte une optimisation importante aux fichiers d'application Android (APK). [More information here](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Signer le nouvel APK (encore ?)**

Si vous **préférez** utiliser [**apksigner**](https://developer.android.com/studio/command-line/) au lieu de jarsigner, **vous devez signer l'apk** après avoir appliqué **l'optimisation avec** zipaling. MAIS REMARQUEZ QUE VOUS N'AVEZ À **SIGNER L'APPLICATION QU'UNE FOIS** AVEC jarsigner (avant zipalign) OU AVEC aspsigner (après zipaling).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Modification de Smali

Pour le code Java Hello World suivant :
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Le code Smali serait:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
L'ensemble d'instructions Smali est disponible [ici](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Modifications légères

### Modifier les valeurs initiales d'une variable dans une fonction

Certaines variables sont définies au début de la fonction en utilisant l'opcode _const_. Vous pouvez modifier leurs valeurs, ou en définir de nouvelles :
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Opérations de base
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Changements majeurs

### Journalisation
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

- Si vous allez utiliser des variables déclarées à l'intérieur de la fonction (déclarées v0, v1, v2...) placez ces lignes entre le _.local <number>_ et les déclarations des variables (_const v0, 0x1_)
- Si vous voulez insérer le code de logging au milieu du code d'une fonction :
- Ajoutez 2 au nombre de variables déclarées : Ex : de _.locals 10_ à _.locals 12_
- Les nouvelles variables doivent être les numéros suivants des variables déjà déclarées (dans cet exemple il devrait s'agir de _v10_ et _v11_, souvenez-vous que ça commence en v0).
- Modifiez le code de la fonction de logging et utilisez _v10_ et _v11_ au lieu de _v5_ et _v1_.

### Toasting

N'oubliez pas d'ajouter 3 au nombre de _.locals_ au début de la fonction.

Ce code est prêt à être inséré au **milieu d'une fonction** (**changez** le nombre des **variables** si nécessaire). Il prendra la **valeur de this.o**, la **transformera** en **String** puis affichera un **toast** avec sa valeur.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
### Chargement d'une bibliothèque native au démarrage (System.loadLibrary)

Parfois, il est nécessaire de précharger une bibliothèque native afin qu'elle s'initialise avant d'autres libs JNI (par ex., pour activer la télémétrie/logging locale du processus). Vous pouvez injecter un appel à System.loadLibrary() dans un static initializer ou tôt dans Application.onCreate(). Exemple smali pour un static class initializer (<clinit>):
```smali
.class public Lcom/example/App;
.super Landroid/app/Application;

.method static constructor <clinit>()V
.registers 1
const-string v0, "sotap"         # library name without lib...so prefix
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
return-void
.end method
```
Sinon, placez les mêmes deux instructions au début de votre Application.onCreate() pour vous assurer que la bibliothèque se charge le plus tôt possible :
```smali
.method public onCreate()V
.locals 1

const-string v0, "sotap"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V

invoke-super {p0}, Landroid/app/Application;->onCreate()V
return-void
.end method
```
Remarques :
- Assurez-vous que la variante ABI correcte de la bibliothèque existe sous lib/<abi>/ (par ex., arm64-v8a/armeabi-v7a) afin d'éviter UnsatisfiedLinkError.
- Le chargement très précoce (class static initializer) garantit que le native logger peut observer l'activité JNI ultérieure.

## Références

- SoTap : enregistreur léger in-app du comportement JNI (.so) – [github.com/RezaArbabBot/SoTap](https://github.com/RezaArbabBot/SoTap)

{{#include ../../banners/hacktricks-training.md}}
