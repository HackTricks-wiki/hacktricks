# Smali - Απομεταγλώττιση/[Τροποποίηση]/Μεταγλώττιση

{{#include ../../banners/hacktricks-training.md}}


Μερικές φορές είναι ενδιαφέρον να τροποποιήσεις τον κώδικα της εφαρμογής για να αποκτήσεις πρόσβαση σε κρυφές πληροφορίες (ίσως καλά συγκεκαλυμμένα συνθηματικά ή flags). Τότε, μπορεί να είναι χρήσιμο να απομεταγλωττίσεις το apk, να τροποποιήσεις τον κώδικα και να το μεταγλωττίσεις ξανά.

**Αναφορά Opcodes:** [http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html)

## Γρήγορος Τρόπος

Χρησιμοποιώντας το **Visual Studio Code** και το πρόσθετο [APKLab](https://github.com/APKLab/APKLab), μπορείς να **απομεταγλωττίσεις αυτόματα**, τροποποιήσεις, **μεταγλωττίσεις ξανά**, υπογράψεις και εγκαταστήσεις την εφαρμογή χωρίς να εκτελέσεις καμία εντολή.

Ένα άλλο **script** που διευκολύνει πολύ αυτή την εργασία είναι [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)

## Απομεταγλώττιση του APK

Χρησιμοποιώντας το APKTool μπορείς να έχεις πρόσβαση στο **smali code and resources**:
```bash
apktool d APP.apk
```
Αν **apktool** σας δώσει κάποιο σφάλμα, δοκιμάστε[ installing the **latest version**](https://ibotpeaches.github.io/Apktool/install/)

Μερικά **ενδιαφέροντα αρχεία που πρέπει να κοιτάξετε**:

- _res/values/strings.xml_ (και όλα τα xml μέσα στο res/values/*)
- _AndroidManifest.xml_
- Οποιοδήποτε αρχείο με κατάληξη _.sqlite_ ή _.db_

Αν `apktool` έχει **προβλήματα στην αποκωδικοποίηση της εφαρμογής** ρίξτε μια ματιά στο [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) ή δοκιμάστε να χρησιμοποιήσετε το όρισμα **`-r`** (μην αποκωδικοποιήσετε τα resources). Έτσι, αν το πρόβλημα βρισκόταν σε κάποιο resource και όχι στον πηγαίο κώδικα, δεν θα αντιμετωπίσετε το πρόβλημα (επίσης δεν θα αποσυμπιλοποιηθούν τα resources).

## Αλλαγή κώδικα smali

Μπορείτε να **αλλάξετε** **εντολές**, να αλλάξετε την **τιμή** ορισμένων μεταβλητών ή να **προσθέσετε** νέες εντολές. Εγώ αλλάζω τον κώδικα Smali χρησιμοποιώντας το [**VS Code**](https://code.visualstudio.com), στη συνέχεια εγκαθιστάτε την **smalise extension** και ο επεξεργαστής θα σας πει αν κάποια **εντολή είναι λανθασμένη**.  
Μερικά **παραδείγματα** μπορείτε να βρείτε εδώ:

- [Smali changes examples](smali-changes.md)
- [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Ή μπορείτε να [**check below some Smali changes explained**](smali-changes.md#modifying-smali).

## Recompile the APK

Μετά την τροποποίηση του κώδικα μπορείτε να **επανασυγγράψετε** τον κώδικα χρησιμοποιώντας:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Θα **compile** το νέο APK **inside** τον _**dist**_ φάκελο.

Αν το **apktool** πετάξει **error**, δοκιμάστε [ installing the **latest version**](https://ibotpeaches.github.io/Apktool/install/)

### **Υπογράψτε το νέο APK**

Στη συνέχεια, πρέπει να **generate a key** (θα σας ζητηθεί ένα password και κάποιες πληροφορίες που μπορείτε να συμπληρώσετε τυχαία):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Τέλος, **υπογράψτε** το νέο APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Βελτιστοποίηση νέας εφαρμογής

**zipalign** είναι ένα εργαλείο ευθυγράμμισης αρχείων που παρέχει σημαντική βελτιστοποίηση για αρχεία εφαρμογής Android (APK). [More information here](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Υπογράψτε το νέο APK (ξανά;)**

Αν **προτιμάτε** να χρησιμοποιήσετε [**apksigner**](https://developer.android.com/studio/command-line/) αντί για jarsigner, **πρέπει να υπογράψετε το APK** αφού εφαρμόσετε **τη βελτιστοποίηση με** zipalign. ΑΛΛΑ ΣΗΜΕΙΩΣΤΕ ΟΤΙ ΠΡΕΠΕΙ ΝΑ **ΥΠΟΓΡΑΨΕΤΕ ΤΗΝ ΕΦΑΡΜΟΓΗ ΜΟΝΟ ΜΙΑ ΦΟΡΑ** ΜΕ jarsigner (πριν το zipalign) Ή ΜΕ apksigner (μετά το zipalign).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Τροποποίηση Smali

Για τον ακόλουθο Java κώδικα Hello World:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Ο κώδικας Smali θα ήταν:
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
The Smali instruction set is available [here](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Ελαφρές Αλλαγές

### Τροποποίηση αρχικών τιμών μιας μεταβλητής μέσα σε μια συνάρτηση

Ορισμένες μεταβλητές ορίζονται στην αρχή της συνάρτησης χρησιμοποιώντας το opcode _const_, μπορείτε να τροποποιήσετε τις τιμές τους, ή να ορίσετε νέες:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Βασικές Ενέργειες
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Μεγαλύτερες Αλλαγές

### Καταγραφή
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

- Αν πρόκειται να χρησιμοποιήσετε δηλωμένες μεταβλητές μέσα στη συνάρτηση (δηλωμένες v0,v1,v2...) τοποθετήστε αυτές τις γραμμές μεταξύ των _.local <number>_ και των δηλώσεων των μεταβλητών (_const v0, 0x1_)
- Αν θέλετε να βάλετε τον logging κώδικα στη μέση του κώδικα μιας συνάρτησης:
- Προσθέστε 2 στον αριθμό των δηλωμένων μεταβλητών: Ex: από _.locals 10_ to _.locals 12_
- Οι νέες μεταβλητές πρέπει να είναι οι επόμενοι αριθμοί μετά τις ήδη δηλωμένες μεταβλητές (σε αυτό το παράδειγμα θα είναι _v10_ και _v11_, θυμηθείτε ότι ξεκινά σε v0).
- Αλλάξτε τον κώδικα της logging συνάρτησης και χρησιμοποιήστε _v10_ και _v11_ αντί για _v5_ και _v1_.

### Εμφάνιση toast

Θυμηθείτε να προσθέσετε 3 στον αριθμό των _.locals_ στην αρχή της συνάρτησης.

Αυτός ο κώδικας είναι προετοιμασμένος για εισαγωγή στο **μέσο μιας συνάρτησης** (**αλλάξτε** τον αριθμό των **μεταβλητών** όπως χρειάζεται). Θα πάρει την **τιμή του this.o**, θα την **μετατρέψει** σε **String** και στη συνέχεια θα **κάνει** ένα **toast** με την τιμή του.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
### Φόρτωση μιας native βιβλιοθήκης κατά την εκκίνηση (System.loadLibrary)

Μερικές φορές χρειάζεται να προφορτώσετε μια native βιβλιοθήκη ώστε να αρχικοποιηθεί πριν από άλλες JNI libs (π.χ. για να ενεργοποιηθεί telemetry/logging σε επίπεδο διεργασίας). Μπορείτε να εισάγετε μια κλήση σε System.loadLibrary() σε έναν static initializer ή νωρίς στο Application.onCreate(). Παράδειγμα smali για static class initializer (<clinit>):
```smali
.class public Lcom/example/App;
.super Landroid/app/Application;

.method static constructor <clinit>()V
.registers 1
const-string v0, "sotap"         # library name without lib...so prefix
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
return-void
.end method
```
Εναλλακτικά, τοποθετήστε τις ίδιες δύο εντολές στην αρχή του Application.onCreate() για να εξασφαλίσετε ότι η βιβλιοθήκη φορτώνει όσο το δυνατόν νωρίτερα:
```smali
.method public onCreate()V
.locals 1

const-string v0, "sotap"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V

invoke-super {p0}, Landroid/app/Application;->onCreate()V
return-void
.end method
```
Σημειώσεις:
- Βεβαιωθείτε ότι η σωστή παραλλαγή ABI της βιβλιοθήκης υπάρχει κάτω από lib/<abi>/ (π.χ., arm64-v8a/armeabi-v7a) για να αποφύγετε το UnsatisfiedLinkError.
- Η φόρτωση πολύ νωρίς (class static initializer) εξασφαλίζει ότι ο native logger μπορεί να παρατηρήσει τη μετέπειτα δραστηριότητα JNI.

## Αναφορές

- SoTap: Ελαφρύς καταγραφέας συμπεριφοράς εντός εφαρμογής για JNI (.so) – [github.com/RezaArbabBot/SoTap](https://github.com/RezaArbabBot/SoTap)

{{#include ../../banners/hacktricks-training.md}}
