# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Informations de base**

**Tapjacking** est une attaque où une **application** **malveillante** est lancée et **se positionne au‑dessus d'une application victime**. Une fois qu'elle masque visiblement l'application victime, son interface utilisateur est conçue de manière à tromper l'utilisateur pour qu'il interagisse avec elle, tout en transmettant l'interaction à l'application victime.\
En pratique, elle **empêche l'utilisateur de savoir qu'il effectue réellement des actions sur l'application victime**.

### Détection

* Recherchez les **exported activities** dans le Android manifest (an activity with an intent-filter is exported by default). Si une exported activity est protégée par une permission, l'application attaquante devra obtenir la **same permission**, ce qui limite l'exploitabilité.
* Vérifiez la version **minimum SDK** `android:minSdkVersion` dans `AndroidManifest.xml`. Si elle est **inférieure à 30**, des comportements par défaut plus anciens peuvent rendre le tapjacking plus facile à exploiter.
* À l'exécution, utilisez `logcat` pour repérer les touches bloquées sur Android 12+ : le système journalise `Untrusted touch due to occlusion by <package>` lorsque les overlays sont filtrés.

### Protection

#### Blocage par défaut & compat flags sur Android 12+

Android 12 (API 31) a introduit **"Block untrusted touches"** : les touches provenant d'une autre fenêtre UID de type `TYPE_APPLICATION_OVERLAY` (opacité ≥0.8) sont ignorées. Cela est activé par défaut. Pendant les tests, vous pouvez le basculer :
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Les fenêtres de confiance (accessibilité, IME, assistant) reçoivent toujours des événements. Les overlays invisibles ou entièrement transparents contournent également le blocage, que les attaquants essaient d'exploiter en maintenant `alpha < 0.8`.

#### Gestion de **l'occlusion partielle**

Les overlays partiels qui laissent la zone cible visible ne sont pas automatiquement bloqués. Atténuez cela dans les vues sensibles en rejetant les événements avec le drapeau **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** :
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Si **`android:filterTouchesWhenObscured`** est défini sur **`true`**, la `View` ne recevra pas les événements tactiles chaque fois que la fenêtre de la vue est obscurcie par une autre fenêtre visible.

#### **`setFilterTouchesWhenObscured`**

L'attribut **`setFilterTouchesWhenObscured`** défini sur true peut également empêcher l'exploitation de cette vulnérabilité si la version d'Android est plus ancienne.\
Si défini sur **`true`**, par exemple, un bouton peut être automatiquement **désactivé s'il est obscurci** :
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

L’**application Android la plus récente** effectuant une attaque Tapjacking (et invoquant une activité exportée de l'application attaquée avant celle-ci) se trouve sur : [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Suivez les instructions du **README** pour l'utiliser.

### FloatingWindowApp

Un projet exemple implémentant **FloatingWindowApp**, utilisable pour se placer au-dessus d'autres activités et effectuer une attaque de clickjacking, se trouve sur [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (un peu ancien, bonne chance pour compiler l'apk).

### Qark

> [!CAUTION]
> Il semble que ce projet ne soit plus maintenu et que cette fonctionnalité ne fonctionne plus correctement

Vous pouvez utiliser [**qark**](https://github.com/linkedin/qark) avec les paramètres `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` pour créer une application malveillante afin de tester d'éventuelles vulnérabilités de **Tapjacking**.\

L'atténuation est relativement simple : le développeur peut choisir de ne pas recevoir d'événements tactiles lorsqu'une view est recouverte par une autre. En utilisant la [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Parfois, il est essentiel qu'une application puisse vérifier qu'une action est effectuée en pleine connaissance et avec le consentement de l'utilisateur, par exemple l'octroi d'une demande d'autorisation, un achat ou un clic sur une publicité. Malheureusement, une application malveillante pourrait tenter de tromper l'utilisateur pour qu'il effectue ces actions à son insu en dissimulant le but réel de la view. En remède, le framework propose un mécanisme de filtrage des touches qui peut être utilisé pour améliorer la sécurité des views donnant accès à des fonctionnalités sensibles.
>
> Pour activer le filtrage des touches, appelez [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) ou définissez l'attribut de layout android:filterTouchesWhenObscured à true. Une fois activé, le framework rejettera les touches reçues chaque fois que la fenêtre de la view est masquée par une autre fenêtre visible. En conséquence, la view ne recevra pas de touches chaque fois qu'un toast, un dialog ou une autre fenêtre apparaît au-dessus de la fenêtre de la view.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** utilisent des overlays presque transparents (p.ex., fausses invites NFC) pour capturer les gestes et les PIN d'écran de verrouillage tout en transmettant les touches en dessous, livrés via des modules Accessibility-ATS.
* **Anatsa/TeaBot droppers** déploient des overlays pour des centaines d'apps bancaires/crypto et affichent des overlays "maintenance" plein écran pour retarder les victimes pendant qu'ATS finalise les transferts.
* **Hidden-VNC banking RATs** affichent brièvement des overlays de phishing pour capturer des identifiants, puis s'appuient sur un VNC covert plus Accessibility pour rejouer les taps avec moins d'artéfacts sur l'appareil.

Prise en pratique pour les red teams : combinez un overlay avec `alpha < 0.8` pour contourner le blocage d'Android 12, puis escaladez vers un overlay accessibility plein écran une fois que l'utilisateur active le service. Instrumentez `GestureDescription` ou un VNC headless pour conserver le contrôle après la capture des identifiants.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Outre le Tapjacking classique, les familles modernes de malware bancaires Android (par ex. **ToxicPanda**, BrasDex, Sova, etc.) abusent de l'**Accessibility Service** pour placer une WebView **overlay** plein écran au-dessus de l'application légitime tout en étant capables de transmettre les entrées utilisateur vers la view sous-jacente. Cela augmente fortement la crédibilité et permet aux attaquants de voler des identifiants, des OTP ou même d'automatiser des transactions frauduleuses.

### How it works
1. L'APK malveillant demande la permission très sensible `BIND_ACCESSIBILITY_SERVICE`, cachant généralement la demande derrière une fausse boîte de dialogue Google/Chrome/visionneuse PDF.
2. Une fois que l'utilisateur active le service, le malware simule de manière programmatique les taps nécessaires pour accorder des permissions dangereuses supplémentaires (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Une **WebView** est ajoutée au window manager en utilisant le type de fenêtre **`TYPE_ACCESSIBILITY_OVERLAY`**. L'overlay peut être rendu totalement opaque ou semi-transparent et peut être marqué comme *“through”* afin que les touches originales soient toujours transmises à l'activité de fond (ainsi la transaction a lieu réellement alors que la victime ne voit que le formulaire de phishing).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Flux de travail typique utilisé par les banking Trojans
* Interroger les packages installés (`QUERY_ALL_PACKAGES`) pour déterminer quelle application bancaire / wallet est actuellement ouverte.
* Télécharger un **HTML/JS overlay template** depuis le C2 qui imite parfaitement cette application spécifique (logo, couleurs, chaînes i18n…).
* Afficher l'overlay, récolter les identifiants/PIN/motif.
* Utiliser l'**Accessibility API** (`performGlobalAction`, `GestureDescription`) pour automatiser des transferts en arrière-plan.

### Détection & Atténuation
* Auditer la liste des applications installées avec `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Du côté de l'application (bank / wallet) :
- Activer **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) sur les vues sensibles pour bloquer les services non-Play-Store.
- Combiner avec `setFilterTouchesWhenObscured(true)` et `FLAG_SECURE`.

Pour plus de détails sur l'exploitation des Accessibility Services pour un contrôle complet à distance de l'appareil (par ex. PlayPraetor, SpyNote, etc.) voir :


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Références
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
