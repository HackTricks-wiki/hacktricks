# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Основна інформація**

**Tapjacking** — це атака, коли запускається **зловмисний додаток**, який **розміщується поверх додатка-жертви**. Коли він візуально закриває додаток-жертву, його інтерфейс спроектований так, щоб обманути користувача і змусити його взаємодіяти з ним, тоді як ця взаємодія передається далі до додатка-жертви. У результаті користувача **приховують від інформації про те, що він фактично виконує дії в додатку-жертві**.

### Виявлення

* Шукайте **exported activities** в Android manifest (activity з intent-filter за замовчуванням експортується). Якщо exported activity захищена permission, атакуючому додатку знадобиться **той самий permission**, що обмежує можливість експлуатації.
* Перевірте мінімальну версію SDK `android:minSdkVersion` в `AndroidManifest.xml`. Якщо вона **нижча за 30**, старі поведінки за замовчуванням можуть полегшити експлуатацію tapjacking.
* Під час виконання використовуйте `logcat` для виявлення заблокованих дотиків на Android 12+: система логують `Untrusted touch due to occlusion by <package>` коли накладки фільтруються.

### Захист

#### Android 12+ default blocking & compat flags

Android 12 (API 31) запровадив **"Block untrusted touches"**: дотики, що надходять з вікна іншого UID типу `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8), відкидаються. Це увімкнено за замовчуванням. Під час тестів ви можете переключити це:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Довірені вікна (accessibility, IME, assistant) все ще отримують події. Невидимі або повністю прозорі оверлеї також обходять блокування — атакуючі намагаються цього досягти, підтримуючи `alpha < 0.8`.

#### Обробка **часткового перекриття**

Часткові оверлеї, що залишають цільову область видимою, не блокуються автоматично. У чутливих view пом’якшуйте ризик, відхиляючи події з прапором **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Якщо **`android:filterTouchesWhenObscured`** встановлено в **`true`**, то `View` не отримуватиме дотиків, коли вікно цього `View` буде затемнене іншим видимим вікном.

#### **`setFilterTouchesWhenObscured`**

Атрибут **`setFilterTouchesWhenObscured`**, встановлений у `true`, також може запобігти експлуатації цієї вразливості на старіших версіях Android.\
Якщо встановлено **`true`**, наприклад, кнопка може бути автоматично **відключена, якщо вона затемнена**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Експлуатація

### Tapjacking-ExportedActivity

Найбільш **новий Android додаток**, що виконує атаку Tapjacking (та викликає перед експортованою activity атакованого додатку), доступний за адресою: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Дотримуйтесь **README інструкцій для використання**.

### FloatingWindowApp

Приклад проєкту, що реалізує **FloatingWindowApp**, який можна використовувати для розміщення поверх інших activity для виконання clickjacking атаки, доступний у [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (трохи застарілий, успіхів у збірці apk).

### Qark

> [!CAUTION]
> Схоже, цей проєкт зараз не підтримується і ця функціональність більше не працює належним чином

Ви можете використовувати [**qark**](https://github.com/linkedin/qark) з параметрами `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` щоб створити зловмисний додаток для тестування можливих **Tapjacking** уразливостей.\

Захід пом'якшення відносно простий — розробник може вирішити не отримувати події торкання, коли view перекрито іншим. Використовуючи [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Іноді критично, щоб додаток міг перевірити, що дія виконується з повним відома та згодою користувача, наприклад при наданні запиту на дозвіл, здійсненні покупки або натисканні на рекламу. На жаль, зловмисний додаток може спробувати обдурити користувача й змусити його виконати ці дії несвідомо, приховуючи реальне призначення view. Як засіб захисту, фреймворк пропонує механізм фільтрації торкань, який можна використати для підвищення безпеки view, які надають доступ до чутливої функціональності.
>
> Щоб увімкнути фільтрацію торкань, викличте [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) або встановіть атрибут макета android:filterTouchesWhenObscured в true. Коли увімкнено, фреймворк відкидатиме торкання, які приходять щоразу, коли вікно view перекривається іншим видимим вікном. Внаслідок цього view не отримуватиме торкань щоразу, коли над його вікном з'являється toast, діалог або інше вікно.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** використовують майже прозорі оверлеї (наприклад, фейкові підказки NFC) щоб захоплювати жести та PIN-коди екрану блокування, одночасно пересилаючи торкання під ними; доставляються через Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** постачають оверлеї для сотень banking/crypto додатків і показують повноекранні "maintenance" оверлеї, щоб затримати жертв, поки ATS завершує перекази.
* **Hidden-VNC banking RATs** коротко відображають фішингові оверлеї для захоплення облікових даних, а потім покладаються на прихований VNC разом з Accessibility, щоб відтворювати торкання з меншим слідом на пристрої.

Практична порада для red teams: змішуйте оверлей з `alpha < 0.8` щоб обійти блокування Android 12, потім ескалюйте до повноекранного accessibility overlay після того, як користувач увімкне сервіс. Інструментуйте `GestureDescription` або безголовий VNC для збереження контролю після захоплення облікових даних.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Окрім класичного Tapjacking, сучасні сімейства Android banking malware (наприклад, **ToxicPanda**, BrasDex, Sova тощо) зловживають **Accessibility Service**, щоб помістити повноекранний WebView **overlay** над легітимним додатком, при цьому все ще маючи змогу **forward the user input** до view під ним. Це драматично підвищує правдоподібність і дозволяє зловмисникам красти облікові дані, OTP або навіть автоматизувати шахрайські транзакції.

### How it works
1. Зловмисний APK запитує високочутливий дозвіл `BIND_ACCESSIBILITY_SERVICE`, зазвичай приховуючи запит за фейковим діалогом Google/Chrome/PDF-viewer.
2. Після того, як користувач увімкне сервіс, malware програмно симулює торкання, необхідні для надання додаткових небезпечних дозволів (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Створюється і додається до window manager **WebView** з використанням типу вікна **`TYPE_ACCESSIBILITY_OVERLAY`**. Оверлей може бути повністю непрозорий або напівпрозорий і може бути позначений як *“through”*, так що початкові торкання все ще доставляються фонній activity (тобто транзакція дійсно відбувається, тоді як жертва бачить лише фішингову форму).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Типовий робочий процес, який використовують banking Trojans
* Query installed packages (`QUERY_ALL_PACKAGES`) щоб з'ясувати, який banking / wallet app наразі відкритий.
* Download an **HTML/JS overlay template** from the C2, який ідеально імітує цю конкретну програму (Logo, colours, i18n strings…).
* Відобразити overlay та зібрати credentials/PIN/pattern.
* Використати **Accessibility API** (`performGlobalAction`, `GestureDescription`) для автоматизації переказів у фоновому режимі.

### Виявлення та пом'якшення
* Перевірити список встановлених додатків за допомогою `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* З боку додатку (bank / wallet):
- Увімкнути **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) для чутливих view, щоб блокувати сервіси, що не з Play Store.
- Поєднати з `setFilterTouchesWhenObscured(true)` та `FLAG_SECURE`.

Для додаткових відомостей про використання Accessibility Services для повного віддаленого контролю пристрою (наприклад PlayPraetor, SpyNote тощо) див.:

{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Посилання
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
