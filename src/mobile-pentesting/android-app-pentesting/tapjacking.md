# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Temel Bilgiler**

**Tapjacking** bir saldırıdır; burada bir **kötü amaçlı** **uygulama** başlatılır ve **kendini hedef uygulamanın üstüne konumlandırır**. Hedef uygulamayı görünür şekilde örttüğünde, kullanıcı arayüzü kullanıcıyı onunla etkileşime girmeye kandıracak şekilde tasarlanır ve bu etkileşimi hedef uygulamaya iletir.\
Bunun etkisi, kullanıcının aslında hedef uygulama üzerinde işlem yaptığını bilmesini engellemektir.

### Tespit

* Android manifest içinde **exported activities**'e bakın (intent-filter içeren bir activity varsayılan olarak exported olur). Eğer exported bir activity bir permission ile korunuyorsa, saldıran uygulama aynı **permission**'a ihtiyaç duyacaktır; bu, exploit edilebilirliği sınırlar.
* `AndroidManifest.xml` içindeki **minimum SDK** sürümünü `android:minSdkVersion` kontrol edin. Eğer **30'dan düşükse**, eski varsayılan davranışlar tapjacking'i sömürmeyi kolaylaştırabilir.
* Çalışma zamanında, Android 12+ üzerinde engellenen dokunmaları tespit etmek için `logcat` kullanın: overlay'ler filtrelendiğinde sistem `Untrusted touch due to occlusion by <package>` kaydını tutar.

### Koruma

#### Android 12+ varsayılan engelleme ve compat flag'leri

Android 12 (API 31) ile **"Block untrusted touches"** tanıtıldı: başka bir UID penceresinden, türü `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) olan pencerelerden gelen dokunmalar düşürülür. Bu varsayılan olarak etkinleştirilmiştir. Testler sırasında bunu açıp kapatabilirsiniz:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Güvenilir pencereler (accessibility, IME, assistant) yine de olayları alır. Görünmez veya tamamen saydam overlay'ler de engeli atlatır; saldırganlar bunu `alpha < 0.8` tutarak kötüye kullanmaya çalışır.

#### **Kısmi örtülmeyi** ele alma

Hedef alanı görünür bırakan kısmi overlay'ler otomatik olarak engellenmez. Hassas görünümlerde, olayları **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** bayrağı ile reddederek önleyin:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Eğer **`android:filterTouchesWhenObscured`** **`true`** olarak ayarlanmışsa, `View`'in penceresi başka bir görünür pencere tarafından örtüldüğünde `View` dokunuşları almaz.

#### **`setFilterTouchesWhenObscured`**

Eğer Android sürümü daha düşükse, **`setFilterTouchesWhenObscured`** niteliğinin **`true`** olarak ayarlanması bu zafiyetin istismarını da engelleyebilir.\
Örneğin **`true`** olarak ayarlandığında, bir düğme otomatik olarak **örtüldüğünde devre dışı bırakılabilir**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## İstismar

### Tapjacking-ExportedActivity

Tapjacking saldırısı gerçekleştiren en güncel Android uygulaması (hedef uygulamanın exported activity'sinden önce invoke eden) şu adreste bulunabilir: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Kullanmak için **README talimatlarını** izleyin.

### FloatingWindowApp

Diğer aktivitelerin üstüne koyularak clickjacking saldırısı yapmak için kullanılabilecek **FloatingWindowApp** uygulamasının bir örnek projesi [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) adresinde bulunur (biraz eski, apk'yı derlemekte bol şans).

### Qark

> [!CAUTION]
> It looks like this project is now unmaintained and this functionality isn't properly working anymore

Olası **Tapjacking** açıklıklarını test etmek için kötü amaçlı bir uygulama oluşturmak üzere [**qark**](https://github.com/linkedin/qark) ile `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` parametrelerini kullanabilirsiniz.\

Etkisizleştirme görece basittir: geliştirici bir view başka bir view tarafından kapatıldığında dokunma olaylarını almamayı seçebilir. [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security) kullanılarak:

> Bazen bir uygulamanın, kullanıcıların tam bilgi ve onayıyla bir eylemin gerçekleştirildiğini doğrulayabilmesi önemlidir; örneğin bir izin isteğini onaylama, satın alma yapma veya bir reklama tıklama gibi. Ne yazık ki, kötü amaçlı bir uygulama, view'un amaçlanan işlevini gizleyerek kullanıcıyı habersizce bu eylemleri gerçekleştirecek şekilde kandırmaya çalışabilir. Çözüm olarak, framework hassas işlevlere erişim sağlayan view'ların güvenliğini artırmak için kullanılabilecek bir dokunma filtreleme mekanizması sunar.
>
> Dokunma filtrelemeyi etkinleştirmek için [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) çağırın veya android:filterTouchesWhenObscured layout özniteliğini true olarak ayarlayın. Etkinleştirildiğinde, framework view'un penceresi başka bir görünür pencere tarafından örtüldüğünde alınan dokunuşları yok sayacaktır. Sonuç olarak, bir toast, dialog veya başka bir pencere view'un penceresinin üzerinde belirdiğinde view dokunuşları almayacaktır.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** use nearly transparent overlays (e.g., fake NFC prompts) to capture gestures and lock-screen PINs while forwarding touches underneath, delivered via Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays for hundreds of banking/crypto apps and show full-screen "maintenance" overlays to stall victims while ATS completes transfers.
* **Hidden-VNC banking RATs** briefly display phishing overlays to capture credentials, then rely on covert VNC plus Accessibility to replay taps with fewer on-device artifacts.

Kırmızı ekipler için pratik çıkarım: Android 12 engellemesini aşmak için `alpha < 0.8` bir overlay ile başlayın, kullanıcı servisi etkinleştirdiğinde tam ekran bir accessibility overlay'e yükseltin. Kimlik bilgileri ele geçirildikten sonra kontrolü sürdürmek için `GestureDescription` veya başsız VNC kullanın.

---

## Accessibility Overlay Phishing (Bankacılık-Trojan Varyantı)

Klasik Tapjacking'in yanında, modern Android bankacılık kötü amaçlı yazılım aileleri (ör. **ToxicPanda**, BrasDex, Sova, vb.) **Accessibility Service**'i kötüye kullanarak meşru uygulamanın üzerine tam ekran bir WebView **overlay** yerleştirir ve yine de kullanıcı girdisini altındaki view'a **iletme** yeteneğini korur. Bu, inandırıcılığı ciddi şekilde artırır ve saldırganların kimlik bilgilerini, OTP'leri çalmasına veya hatta sahte işlemleri otomatikleştirmesine olanak tanır.

### Nasıl çalışır
1. Kötü amaçlı APK, genellikle isteği sahte bir Google/Chrome/PDF görüntüleyici dialogu arkasına gizleyerek, yüksek hassasiyetli `BIND_ACCESSIBILITY_SERVICE` iznini talep eder.
2. Kullanıcı servisi etkinleştirdiğinde, malware programatik olarak ek tehlikeli izinleri vermek için gerekli dokunuşları simüle eder (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Bir **WebView** açılır ve **`TYPE_ACCESSIBILITY_OVERLAY`** pencere türü kullanılarak window manager'a eklenir. Overlay tamamen opak veya yarı şeffaf olarak render edilebilir ve orijinal dokunuşların arka plandaki aktiviteye iletilmeye devam etmesi için *“through”* olarak işaretlenebilir (böylece işlem gerçekten gerçekleşirken kurban yalnızca phishing formunu görür).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### banking Trojans tarafından kullanılan tipik iş akışı
* Yüklü paketleri sorgula (`QUERY_ALL_PACKAGES`) ve hangi bankacılık / cüzdan uygulamasının şu anda açık olduğunu belirle.
* C2'den o belirli uygulamayı kusursuz taklit eden bir **HTML/JS overlay template** indir (Logo, renkler, i18n stringleri…).
* Overlay'i göster, kimlik bilgilerini/PIN/deseni topla.
* Arka planda transferleri otomatikleştirmek için **Accessibility API** (`performGlobalAction`, `GestureDescription`) kullan.

### Tespit ve Önleme
* Yüklü uygulamaların listesini denetle: `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Uygulama tarafında (banka / cüzdan):
- Hassas view'larda Play Store dışı servisleri engellemek için **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) etkinleştir.
- `setFilterTouchesWhenObscured(true)` ve `FLAG_SECURE` ile birleştir.

Tam uzaktan cihaz kontrolü için Accessibility Services'den yararlanma hakkında ek detaylar (ör. PlayPraetor, SpyNote, vb.) için bakınız:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Referanslar
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
