# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Informazioni di base**

**Tapjacking** è un attacco in cui un'**application** **maligna** viene lanciata e **si posiziona sopra un'applicazione vittima**. Una volta che oscura visivamente l'app vittima, la sua interfaccia utente è progettata in modo da indurre l'utente a interagire con essa, mentre inoltra l'interazione all'app vittima.  
Di fatto, impedisce all'utente di sapere che sta effettivamente eseguendo azioni sull'app vittima.

### Rilevamento

* Cerca **exported activities** nel Android manifest (an activity with an intent-filter is exported by default). Se un'exported activity è protetta da una permission, l'app attaccante avrà bisogno della **same permission**, il che limita l'exploitability.
* Controlla la versione **minimum SDK** `android:minSdkVersion` in `AndroidManifest.xml`. Se è **inferiore a 30**, i comportamenti di default più vecchi possono rendere più facile sfruttare tapjacking.
* A runtime, usa `logcat` per individuare tocchi bloccati su Android 12+: il sistema registra `Untrusted touch due to occlusion by <package>` quando gli overlay sono filtrati.

### Protezione

#### Blocco predefinito & compat flags in Android 12+

Android 12 (API 31) ha introdotto **"Block untrusted touches"**: i tocchi provenienti da una finestra con un altro UID di tipo `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) vengono scartati. Questo è abilitato di default. Durante i test puoi togglarlo:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Finestre trusted (accessibility, IME, assistant) continuano a ricevere eventi. Overlay invisibili o completamente trasparenti aggirano comunque il blocco; gli attaccanti cercano di abusarne mantenendo `alpha < 0.8`.

#### Gestione della **occlusione parziale**

Le sovrapposizioni parziali che lasciano visibile l'area di destinazione non vengono bloccate automaticamente. Mitiga nelle view sensibili rifiutando gli eventi con il **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** flag:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Se **`android:filterTouchesWhenObscured`** è impostato su **`true`**, la `View` non riceverà tocchi ogni volta che la finestra della `View` è oscurata da un'altra finestra visibile.

#### **`setFilterTouchesWhenObscured`**

L'attributo **`setFilterTouchesWhenObscured`** impostato su true può anche prevenire lo sfruttamento di questa vulnerabilità se la versione di Android è precedente.\
Se impostato su **`true`**, per esempio, un pulsante può essere automaticamente **disabilitato se è oscurato**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Sfruttamento

### Tapjacking-ExportedActivity

L'applicazione **Android** più **recente** che esegue un attacco Tapjacking (+ invocando prima di un'attività esportata dell'applicazione attaccata) si trova in: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Segui le istruzioni del **README** per usarla.

### FloatingWindowApp

Un progetto di esempio che implementa **FloatingWindowApp**, che può essere usato per posizionarsi sopra altre activity per eseguire un attacco di clickjacking, si trova in [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (un po' datato, buona fortuna a compilare l'apk).

### Qark

> [!CAUTION]
> Sembra che questo progetto non sia più mantenuto e questa funzionalità non funzioni più correttamente

Puoi usare [**qark**](https://github.com/linkedin/qark) con i parametri `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` per creare un'applicazione malevola per testare possibili vulnerabilità di **Tapjacking**.\

La mitigazione è relativamente semplice: lo sviluppatore può scegliere di non ricevere eventi touch quando una view è coperta da un'altra. Usando la [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Sometimes it is essential that an application be able to verify that an action is being performed with the full knowledge and consent of the user, such as granting a permission request, making a purchase or clicking on an advertisement. Unfortunately, a malicious application could try to spoof the user into performing these actions, unaware, by concealing the intended purpose of the view. As a remedy, the framework offers a touch filtering mechanism that can be used to improve the security of views that provide access to sensitive functionality.
>
> To enable touch filtering, call [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) or set the android:filterTouchesWhenObscured layout attribute to true. When enabled, the framework will discard touches that are received whenever the view's window is obscured by another visible window. As a result, the view will not receive touches whenever a toast, dialog or other window appears above the view's window.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** usano overlay quasi trasparenti (es., prompt NFC falsi) per catturare gesture e PIN della lock-screen mentre inoltrano i tocchi sottostanti, distribuiti tramite moduli Accessibility-ATS.
* **Anatsa/TeaBot droppers** forniscono overlay per centinaia di app banking/crypto e mostrano overlay a schermo intero di "maintenance" per bloccare le vittime mentre ATS completa i trasferimenti.
* **Hidden-VNC banking RATs** mostrano brevemente overlay di phishing per catturare credenziali, poi si affidano a VNC covert insieme ad Accessibility per riprodurre i tap con meno artefatti sul dispositivo.

Indicazione pratica per i red team: combina un overlay con `alpha < 0.8` per bypassare il blocco di Android 12, quindi scala a un overlay di accessibilità a schermo intero una volta che l'utente abilita il servizio. Strumenta `GestureDescription` o un VNC headless per mantenere il controllo dopo che le credenziali sono state catturate.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Oltre al classico Tapjacking, le moderne famiglie di malware bancari Android (es. **ToxicPanda**, BrasDex, Sova, ecc.) abusano del **Accessibility Service** per posizionare un WebView a schermo intero come **overlay** sopra l'applicazione legittima pur essendo in grado di **inoltrare l'input dell'utente** alla view sottostante. Questo aumenta drasticamente la credibilità e permette agli attaccanti di rubare credenziali, OTP o persino automatizzare transazioni fraudolente.

### Come funziona
1. L'APK malevolo richiede la permission altamente sensibile `BIND_ACCESSIBILITY_SERVICE`, solitamente nascondendo la richiesta dietro un dialogo falso di Google/Chrome/PDF-viewer.
2. Una volta che l'utente abilita il service, il malware simula programmaticamente i tap necessari per concedere permission aggiuntive pericolose (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Un **WebView** viene istanziato e aggiunto al window manager usando il tipo di finestra **`TYPE_ACCESSIBILITY_OVERLAY`**. L'overlay può essere renderizzato totalmente opaco o semi-trasparente e può essere contrassegnato come *“through”* in modo che i tocchi originali vengano comunque inviati all'activity di background (quindi la transazione avviene realmente mentre la vittima vede solo il form di phishing).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Tipico flusso di lavoro utilizzato dai banking Trojans
* Interrogare i pacchetti installati (`QUERY_ALL_PACKAGES`) per determinare quale banking / wallet app è attualmente aperta.
* Scaricare un **HTML/JS overlay template** dal C2 che imiti perfettamente quella specifica applicazione (Logo, colours, i18n strings…).
* Mostrare l'overlay, raccogliere credenziali/PIN/pattern.
* Usare la **Accessibility API** (`performGlobalAction`, `GestureDescription`) per automatizzare trasferimenti in background.

### Rilevamento & Mitigazione
* Auditare la lista delle app installate con `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Dal lato applicazione (bank / wallet):
- Abilitare **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) sulle view sensibili per bloccare i servizi non-Play-Store.
- Combinarlo con `setFilterTouchesWhenObscured(true)` e `FLAG_SECURE`.

Per dettagli aggiuntivi sull'utilizzo di Accessibility Services per il controllo remoto completo del dispositivo (es. PlayPraetor, SpyNote, ecc.) vedere:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Riferimenti
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
