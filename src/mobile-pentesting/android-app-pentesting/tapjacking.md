# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **基本信息**

**Tapjacking** 是一种攻击，其中一个 **恶意** **应用** 被启动并 **将自身置于受害者应用之上**。一旦它明显遮挡了受害应用，它的用户界面就会被设计成以欺骗用户与其交互，同时将该交互传递给受害应用。\
实际上，这就是 **使用户看不出他们实际上正在对受害应用执行操作**。

### 检测

* 查找 Android manifest 中的 **exported activities**（带有 intent-filter 的 activity 默认是 exported）。如果一个 exported activity 受某个权限保护，攻击应用将需要相同的**权限**，这会限制可利用性。
* 检查 `AndroidManifest.xml` 中的 **minimum SDK** 版本 `android:minSdkVersion`。如果它 **低于 30**，较旧的默认行为可能使 tapjacking 更容易被利用。
* 在运行时，使用 `logcat` 在 Android 12+ 上发现被阻止的触摸：当 overlays 被过滤时，系统会记录 `Untrusted touch due to occlusion by <package>`。

### 保护

#### Android 12+ 默认阻止与兼容标志

Android 12 (API 31) 引入了 **"Block untrusted touches"**：来自另一个 UID 且类型为 `TYPE_APPLICATION_OVERLAY`（opacity ≥0.8）的窗口的触摸会被丢弃。该功能默认启用。测试时可以切换它：
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
受信任的窗口 (accessibility, IME, assistant) 仍然会接收事件。不可见或完全透明的覆盖层也会绕过该阻止，攻击者会通过保持 `alpha < 0.8` 来滥用这一点。

#### 处理 **部分遮挡**

部分覆盖层如果仍让目标区域可见，则不会被自动阻止。在敏感视图中，通过拒绝带有 **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** 标志的事件来缓解：
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

如果 **`android:filterTouchesWhenObscured`** 设置为 **`true`**，当视图的窗口被另一个可见窗口遮挡时，该 `View` 将不会接收触摸事件。

#### **`setFilterTouchesWhenObscured`**

属性 **`setFilterTouchesWhenObscured`** 设为 true 也可以在 Android 版本较低时防止该漏洞被利用。\
如果设为 **`true`**，例如，按钮可以**在被遮挡时自动禁用**：
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

The most **recent Android application** performing a Tapjacking attack (+ invoking before an exported activity of the attacked application) can be found in: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

请遵循 **README 中的使用说明**。

### FloatingWindowApp

An example project implementing **FloatingWindowApp**, which can be used to put on top of other activities to perform a clickjacking attack, can be found in [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (a bit old, good luck building the apk).

一个实现了 FloatingWindowApp 的示例项目，可用于放置在其他 activity 之上以执行 clickjacking 攻击，可在 [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) 找到（较旧，构建 apk 可能会有困难）。

### Qark

> [!CAUTION]
> It looks like this project is now unmaintained and this functionality isn't properly working anymore

> 看起来该项目现在已不再维护，且此功能可能已无法正常工作

You can use [**qark**](https://github.com/linkedin/qark) with the `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` parameters to create a malicious application to test for possible **Tapjacking** vulnerabilities.\

你可以使用 [**qark**](https://github.com/linkedin/qark) 并带上 `--exploit-apk` 以及 --sdk-path `/Users/username/Library/Android/sdk` 参数来创建一个恶意应用，以测试可能的 **Tapjacking** 漏洞。

The mitigation is relatively simple as the developer may choose not to receive touch events when a view is covered by another. Using the [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

缓解方法相对简单：开发者可以选择在视图被其他视图覆盖时不接收触摸事件。参考 [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security)：

> Sometimes it is essential that an application be able to verify that an action is being performed with the full knowledge and consent of the user, such as granting a permission request, making a purchase or clicking on an advertisement. Unfortunately, a malicious application could try to spoof the user into performing these actions, unaware, by concealing the intended purpose of the view. As a remedy, the framework offers a touch filtering mechanism that can be used to improve the security of views that provide access to sensitive functionality.
>
> To enable touch filtering, call [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) or set the android:filterTouchesWhenObscured layout attribute to true. When enabled, the framework will discard touches that are received whenever the view's window is obscured by another visible window. As a result, the view will not receive touches whenever a toast, dialog or other window appears above the view's window.

> 有时，应用需要能验证用户在完全知情并同意的情况下执行某些操作，例如授予权限请求、进行购买或点击广告。不幸的是，恶意应用可能会通过隐藏视图的真实用途来欺骗用户在不知情的情况下执行这些操作。为此，框架提供了触摸过滤机制，可用于增强包含敏感功能的视图的安全性。
>
> 若要启用触摸过滤，请调用 [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) 或将 android:filterTouchesWhenObscured 布局属性设为 true。启用后，每当视图的窗口被另一个可见窗口遮挡时，框架会丢弃接收到的触摸事件。因此，每当 toast、dialog 或其他窗口出现在该视图之上时，该视图将不会接收触摸事件。

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** use nearly transparent overlays (e.g., fake NFC prompts) to capture gestures and lock-screen PINs while forwarding touches underneath, delivered via Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays for hundreds of banking/crypto apps and show full-screen "maintenance" overlays to stall victims while ATS completes transfers.
* **Hidden-VNC banking RATs** briefly display phishing overlays to capture credentials, then rely on covert VNC plus Accessibility to replay taps with fewer on-device artifacts.

* **Hook/Ermac variants** 使用几乎透明的覆盖层（例如伪造的 NFC 提示）来捕获手势和锁屏 PIN，同时将触摸事件转发到底层，通过 Accessibility-ATS 模块分发。
* **Anatsa/TeaBot droppers** 为数百个银行/加密应用提供覆盖层，并显示全屏的 "maintenance" 覆盖以拖延受害者，便于 ATS 完成转账。
* **Hidden-VNC banking RATs** 会短暂显示钓鱼覆盖层以窃取凭据，然后依赖隐蔽的 VNC 加上 Accessibility 来重放点击，从而减少设备上的痕迹。

Practical takeaway for red teams: mix an `alpha < 0.8` overlay to bypass Android 12 blocking, then escalate to a full-screen accessibility overlay once the user toggles the service. Instrument `GestureDescription` or a headless VNC to keep control after credentials are captured.

对红队的实用建议：混合使用 `alpha < 0.8` 的覆盖层以绕过 Android 12 的阻止，然后在用户切换该服务后升级为全屏 accessibility 覆盖。使用 `GestureDescription` 或无头 VNC 在凭据被窃取后保持控制。

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Besides classic Tapjacking, modern Android banking malware families (e.g. **ToxicPanda**, BrasDex, Sova, etc.) abuse the **Accessibility Service** to place a full-screen WebView **overlay** above the legitimate application while still being able to **forward the user input** to the view underneath.  This dramatically increases believability and allows attackers to steal credentials, OTPs or even automate fraudulent transactions.

除了经典的 Tapjacking，现代 Android 银行恶意软件家族（例如 **ToxicPanda**、BrasDex、Sova 等）滥用 **Accessibility Service**，在合法应用之上放置全屏的 WebView **overlay**，同时仍能将用户输入 **forward** 到下面的视图。这大大提高了逼真性，使攻击者能够窃取凭据、OTP，甚至自动化执行欺诈交易。

### How it works
1. The malicious APK requests the highly-sensitive `BIND_ACCESSIBILITY_SERVICE` permission, usually hiding the request behind a fake Google/Chrome/PDF-viewer dialog.
2. Once the user enables the service, the malware programmatically simulates the taps required to grant additional dangerous permissions (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. A **WebView** is inflated and added to the window manager using the **`TYPE_ACCESSIBILITY_OVERLAY`** window type.  The overlay can be rendered totally opaque or semi-transparent and can be flagged as *“through”* so that the original touches are still delivered to the background activity (thus the transaction really happens while the victim only sees the phishing form).

### 工作原理
1. 恶意 APK 请求高度敏感的 `BIND_ACCESSIBILITY_SERVICE` 权限，通常将该请求隐藏在伪造的 Google/Chrome/PDF 查看器对话框后面。
2. 一旦用户启用该服务，恶意软件会以编程方式模拟点击，以授予其他危险权限（例如 `READ_SMS`、`SYSTEM_ALERT_WINDOW`、`REQUEST_INSTALL_PACKAGES` 等）。
3. 使用 **`TYPE_ACCESSIBILITY_OVERLAY`** 窗口类型在 window manager 中 inflate 并添加一个 **WebView**。该 overlay 可以完全不透明或半透明渲染，也可以标记为 *“through”*，以便原始触摸仍然传递到底层活动（因此交易确实发生，而受害者只看到钓鱼表单）。
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### 银行木马的典型工作流程
* 查询已安装的包（`QUERY_ALL_PACKAGES`），以确定当前打开的是哪个银行/钱包应用。
* 从 C2 下载一个 **HTML/JS overlay template**，完美模仿该特定应用（Logo、颜色、i18n 字符串…）。
* 显示覆盖层，窃取凭证、PIN 或解锁图案。
* 使用 **Accessibility API**（`performGlobalAction`、`GestureDescription`）在后台自动化转账。

### 检测与缓解
* 使用 `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE` 审核已安装应用列表。
* 从应用端（银行/钱包）：
- 在敏感视图上启用 **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`**（Android 14+），以阻止非 Play Store 服务。
- 与 `setFilterTouchesWhenObscured(true)` 和 `FLAG_SECURE` 结合使用。

有关利用 Accessibility Services 实现完整远程设备控制（例如 PlayPraetor、SpyNote 等）的更多详情，请参见：


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## 参考资料
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
