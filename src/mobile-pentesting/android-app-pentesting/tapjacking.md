# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Podstawowe informacje**

**Tapjacking** to atak, w którym uruchamiana jest **złośliwa** **aplikacja** i **pozycjonuje się nad aplikacją ofiary**. Gdy wizualnie zasłoni aplikację ofiary, jej interfejs jest zaprojektowany tak, aby oszukać użytkownika i skłonić go do interakcji, podczas gdy przekazuje tę interakcję do aplikacji ofiary.\
W efekcie **oślepia użytkownika, uniemożliwiając mu stwierdzenie, że faktycznie wykonuje działania w aplikacji ofiary**.

### Wykrywanie

* Poszukaj **exported activities** w manifeście Android (aktywność z intent-filter jest domyślnie eksportowana). Jeśli eksportowana aktywność jest chroniona przez permission, aplikacja atakująca będzie potrzebować **tej samej permission**, co ogranicza możliwości eksploatacji.
* Sprawdź wersję **minimum SDK** `android:minSdkVersion` w `AndroidManifest.xml`. Jeśli jest **niższa niż 30**, starsze domyślne zachowania mogą ułatwiać wykorzystanie tapjacking.
* Podczas działania użyj `logcat`, aby wykryć zablokowane dotknięcia na Android 12+: system loguje `Untrusted touch due to occlusion by <package>` gdy nakładki są filtrowane.

### Ochrona

#### Android 12+ domyślne blokowanie i flagi zgodności

Android 12 (API 31) wprowadził **"Block untrusted touches"**: dotknięcia pochodzące z okna innego UID typu `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) są odrzucane. Funkcja ta jest domyślnie włączona. Podczas testów możesz ją przełączać:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Zaufane okna (accessibility, IME, assistant) nadal otrzymują zdarzenia. Niewidoczne lub całkowicie przezroczyste nakładki również omijają blokadę, co atakujący starają się wykorzystać, utrzymując `alpha < 0.8`.

#### Obsługa **częściowego zasłonięcia**

Częściowe nakładki, które pozostawiają widoczny obszar docelowy, nie są automatycznie blokowane. W wrażliwych widokach ogranicz ryzyko, odrzucając zdarzenia z flagą **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Jeśli **`android:filterTouchesWhenObscured`** jest ustawione na **`true`**, `View` nie będzie otrzymywać dotknięć za każdym razem, gdy okno widoku jest zasłonięte przez inne widoczne okno.

#### **`setFilterTouchesWhenObscured`**

Atrybut **`setFilterTouchesWhenObscured`** ustawiony na true może również zapobiec wykorzystaniu tej podatności, jeśli wersja Androida jest starsza.\
If set to **`true`**, for example, a button can be automatically **disabled if it is obscured**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Eksploatacja

### Tapjacking-ExportedActivity

The most **recent Android application** performing a Tapjacking attack (+ invoking before an exported activity of the attacked application) can be found in: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Follow the **README instructions to use it**.

### FloatingWindowApp

Przykładowy projekt implementujący **FloatingWindowApp**, który można umieścić nad innymi aktywnościami, aby przeprowadzić atak clickjacking, znajduje się w [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (trochę stary — powodzenia przy budowaniu apk).

### Qark

> [!CAUTION]
> Wygląda na to, że ten projekt nie jest już utrzymywany i ta funkcjonalność nie działa prawidłowo

Możesz użyć [**qark**](https://github.com/linkedin/qark) z parametrami `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` aby stworzyć złośliwą aplikację do testowania możliwych podatności **Tapjacking**.\

Środki zaradcze są stosunkowo proste — deweloper może zdecydować, aby nie otrzymywać zdarzeń dotyku, gdy widok jest zasłonięty przez inny. Korzystając z [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Czasami istotne jest, aby aplikacja mogła zweryfikować, że jakaś akcja jest wykonywana za pełną wiedzą i zgodą użytkownika — na przykład przy udzielaniu uprawnienia, dokonywaniu zakupu lub kliknięciu reklamy. Niestety, złośliwa aplikacja mogłaby próbować oszukać użytkownika, skłaniając go do wykonania tych akcji, nieświadomie, poprzez ukrywanie rzeczywistego przeznaczenia widoku. Jako środek zaradczy framework oferuje mechanizm filtrowania dotyku, który może być użyty do poprawy bezpieczeństwa widoków udostępniających dostęp do wrażliwej funkcjonalności.
>
> Aby włączyć filtrowanie dotyku, wywołaj [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) lub ustaw atrybut układu android:filterTouchesWhenObscured na true. Po włączeniu framework odrzuci dotknięcia otrzymywane, gdy okno widoku jest zasłonięte przez inne widoczne okno. W rezultacie widok nie będzie otrzymywał dotknięć, gdy nad jego oknem pojawi się toast, dialog lub inne okno.

---

### Najnowsze techniki złośliwego oprogramowania wykorzystujące nakładki

* **Hook/Ermac variants** używają niemal przezroczystych nakładek (np. fałszywych monitów NFC) do przechwytywania gestów i PIN-ów ekranu blokady, jednocześnie przekazując dotknięcia do spodniej warstwy, dostarczane przez moduły Accessibility-ATS.
* **Anatsa/TeaBot droppers** dostarczają nakładki dla setek aplikacji bankowych/krypto i pokazują pełnoekranowe nakładki konserwacyjne, aby opóźnić ofiary, podczas gdy ATS kończy przelewy.
* **Hidden-VNC banking RATs** krótko wyświetlają phishingowe nakładki, aby przechwycić poświadczenia, a następnie polegają na ukrytym VNC plus Accessibility, aby odtworzyć stuknięcia z mniejszą liczbą artefaktów na urządzeniu.

Wniosek praktyczny dla red teamów: zastosuj nakładkę z `alpha < 0.8`, aby obejść blokowanie w Android 12, a następnie eskaluj do pełnoekranowej nakładki accessibility, gdy użytkownik włączy usługę. Użyj `GestureDescription` lub headless VNC, aby utrzymać kontrolę po przechwyceniu poświadczeń.

---

## Phishing z nakładką Accessibility (wariant trojana bankowego)

Poza klasycznym Tapjackingiem, nowoczesne rodziny malware bankowego na Android (np. **ToxicPanda**, BrasDex, Sova, itd.) nadużywają **Accessibility Service**, aby umieścić pełnoekranowy WebView **nakładkę** nad prawdziwą aplikacją, jednocześnie będąc w stanie **przekazać dane wejściowe użytkownika** do widoku poniżej. To znacząco zwiększa wiarygodność i pozwala atakującym kraść poświadczenia, OTP lub nawet automatyzować fałszywe transakcje.

### Jak to działa
1. Złośliwy APK żąda wysoce wrażliwego uprawnienia `BIND_ACCESSIBILITY_SERVICE`, zwykle ukrywając prośbę za fałszywym dialogiem Google/Chrome/viewer PDF.
2. Gdy użytkownik włączy usługę, malware programowo symuluje stuknięcia wymagane do przyznania dodatkowych niebezpiecznych uprawnień (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. **WebView** jest inflate'owany i dodawany do window managera przy użyciu typu okna **`TYPE_ACCESSIBILITY_OVERLAY`**. Nakładka może być renderowana całkowicie nieprzezroczysta lub półprzezroczysta i może być oznaczona jako *“through”*, tak że oryginalne dotknięcia są nadal dostarczane do aktywności w tle (w efekcie transakcja naprawdę zachodzi, podczas gdy ofiara widzi tylko formularz phishingowy).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Typowy przebieg stosowany przez banking Trojans
* Sprawdź zainstalowane pakiety (`QUERY_ALL_PACKAGES`), aby ustalić, która aplikacja bankowa / wallet jest aktualnie otwarta.
* Pobierz z C2 **HTML/JS overlay template**, który perfekcyjnie imituje konkretną aplikację (Logo, colours, i18n strings…).
* Wyświetl nakładkę, zbierz credentials/PIN/wzór.
* Użyj **Accessibility API** (`performGlobalAction`, `GestureDescription`) do automatyzacji przelewów w tle.

### Wykrywanie i przeciwdziałanie
* Przeaudytuj listę zainstalowanych aplikacji za pomocą `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Po stronie aplikacji (bank / wallet):
- Włącz **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) dla wrażliwych widoków, aby zablokować non-Play-Store services.
- Połącz z `setFilterTouchesWhenObscured(true)` i `FLAG_SECURE`.

Dla dodatkowych szczegółów dotyczących wykorzystania Accessibility Services do pełnej zdalnej kontroli urządzenia (np. PlayPraetor, SpyNote, itd.) zobacz:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Źródła
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
