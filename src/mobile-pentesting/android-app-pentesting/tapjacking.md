# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **기본 정보**

**Tapjacking**은 **악성** **애플리케이션**이 실행되어 **피해자 애플리케이션 위에 자신을 위치시킨** 뒤 발생하는 공격입니다. 일단 피해자 앱을 시각적으로 가리면, 공격 앱의 UI는 사용자가 그것과 상호작용하도록 속이게 설계되고, 그 상호작용은 피해자 앱으로 전달됩니다.\
결과적으로 사용자는 자신이 실제로 피해자 앱에서 작업을 수행하고 있다는 사실을 알지 못하게 됩니다.

### 탐지

* Android 매니페스트에서 **exported activities**를 찾아보세요 (intent-filter가 있는 activity는 기본적으로 exported 됩니다). 만약 exported activity가 권한으로 보호되어 있다면, 공격 앱은 **동일한 권한**을 필요로 하며, 이는 악용 가능성을 제한합니다.
* `AndroidManifest.xml`의 `android:minSdkVersion`에서 **최소 SDK** 버전을 확인하세요. 만약 **30 미만**이면, 이전 기본 동작으로 인해 tapjacking을 악용하기 쉬울 수 있습니다.
* 런타임에는 `logcat`을 사용하여 Android 12+에서 차단된 터치를 확인하세요: 오버레이가 필터링될 때 시스템은 `Untrusted touch due to occlusion by <package>`를 로깅합니다.

### 보호

#### Android 12+ 기본 차단 및 호환성 플래그

Android 12 (API 31)은 **"Block untrusted touches"** 기능을 도입했습니다: `TYPE_APPLICATION_OVERLAY` 타입(opacity ≥0.8)의 다른 UID 창에서 온 터치는 차단됩니다. 이 기능은 기본적으로 활성화되어 있습니다. 테스트 중에는 이를 토글할 수 있습니다:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
신뢰된 창(접근성, IME, 어시스턴트)은 여전히 이벤트를 수신합니다. 보이지 않거나 완전히 투명한 오버레이도 차단을 우회할 수 있으며, 공격자는 `alpha < 0.8`을 유지하여 이를 악용하려고 합니다.

#### **부분 가림** 처리

대상 영역을 보이게 남겨두는 부분 오버레이는 자동으로 차단되지 않습니다. 민감한 뷰에서는 **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** 플래그가 설정된 이벤트를 거부해 완화하세요:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

만약 **`android:filterTouchesWhenObscured`**가 **`true`**로 설정되어 있으면, `View`의 윈도우가 다른 보이는 윈도우에 의해 가려질 때마다 해당 `View`는 터치를 받지 않습니다.

#### **`setFilterTouchesWhenObscured`**

속성 **`setFilterTouchesWhenObscured`**를 **`true`**로 설정하면 Android 버전이 낮을 경우 이 취약점의 악용을 방지할 수 있습니다.\
예를 들어 **`true`**로 설정하면 버튼은 가려질 경우 자동으로 **비활성화**될 수 있습니다:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## 악용

### Tapjacking-ExportedActivity

가장 **최신 Android 애플리케이션** 중 Tapjacking 공격(공격 대상 애플리케이션의 exported activity 전에 호출)을 수행하는 것은 다음에서 확인할 수 있습니다: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

사용하려면 **README 지침을 따르세요**.

### FloatingWindowApp

다른 액티비티 위에 올라가 clickjacking 공격을 수행하는 데 사용할 수 있는 **FloatingWindowApp**을 구현한 예제 프로젝트는 [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp)에서 찾을 수 있습니다 (다소 오래되어 apk 빌드에 성공하기 어려울 수 있습니다).

### Qark

> [!CAUTION]
> 이 프로젝트는 현재 유지보수되지 않으며 해당 기능이 더 이상 제대로 작동하지 않는 것으로 보입니다

`--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` 매개변수와 함께 [**qark**](https://github.com/linkedin/qark)를 사용하여 잠재적 **Tapjacking** 취약점을 테스트할 악성 애플리케이션을 생성할 수 있습니다.\

완화책은 비교적 간단합니다. 개발자가 뷰가 다른 뷰에 의해 가려졌을 때 터치 이벤트를 받지 않도록 선택할 수 있기 때문입니다. [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security)를 사용하면:

> 때때로 권한 요청 승인, 구매 또는 광고 클릭과 같이 사용자에게 완전한 인지와 동의가 있는 상태에서 작업이 수행되고 있음을 애플리케이션이 확인할 수 있어야 하는 경우가 있습니다. 불행히도 악의적인 애플리케이션은 뷰의 의도를 숨겨 사용자가 의식하지 못한 채 이러한 작업을 수행하도록 속이려 할 수 있습니다. 이를 해결하기 위해 프레임워크는 민감한 기능에 접근하는 뷰의 보안을 향상시키는 데 사용될 수 있는 터치 필터링 메커니즘을 제공합니다.
>
> 터치 필터링을 활성화하려면 [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29)를 호출하거나 android:filterTouchesWhenObscured 레이아웃 속성을 true로 설정하세요. 활성화되면 뷰의 윈도우가 다른 보이는 윈도우에 의해 가려질 때 수신된 터치를 프레임워크가 폐기합니다. 결과적으로 토스트, 다이얼로그 또는 다른 창이 뷰의 윈도우 위에 나타날 때 해당 뷰는 터치를 받지 않습니다.

---

### 최근 오버레이 기반 악성코드 기법

* **Hook/Ermac variants**는 거의 투명한 오버레이(예: 가짜 NFC 프롬프트)를 사용해 제스처와 잠금화면 PIN을 캡처하면서 아래쪽으로 터치를 전달하고, Accessibility-ATS 모듈을 통해 배포됩니다.
* **Anatsa/TeaBot droppers**는 수백 개의 뱅킹/암호화폐 앱용 오버레이를 배포하고 ATS가 전송을 완료하는 동안 피해자를 지연시키기 위해 전체 화면 "maintenance" 오버레이를 표시합니다.
* **Hidden-VNC banking RATs**는 자격증명을 훔치기 위해 잠깐 피싱 오버레이를 표시한 다음, 은밀한 VNC와 Accessibility를 이용해 장치 내 증거를 최소화하며 탭을 재생합니다.

red teams를 위한 실용적 요지: Android 12 차단을 우회하려면 `alpha < 0.8` 오버레이를 섞은 뒤, 사용자가 서비스를 토글하면 전체 화면 접근성 오버레이로 권한을 상승시키세요. 자격증명 확보 후에는 `GestureDescription`이나 헤드리스 VNC를 도구화하여 제어를 유지하세요.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

고전적인 Tapjacking 외에도, 현대의 Android 뱅킹 악성코드 계열(예: **ToxicPanda**, BrasDex, Sova 등)은 **Accessibility Service**를 악용하여 정식 애플리케이션 위에 전체 화면 WebView **overlay**를 띄우면서도 아래의 뷰로 **사용자 입력을 전달**할 수 있습니다. 이는 신뢰성을 크게 높여 공격자가 자격증명, OTP 또는 심지어 사기성 거래를 자동화하여 탈취할 수 있게 합니다.

### 작동 방식
1. 악성 APK는 매우 민감한 권한인 `BIND_ACCESSIBILITY_SERVICE`를 요청하며, 보통 이를 가짜 Google/Chrome/PDF 뷰어 대화상자 뒤에 숨깁니다.
2. 사용자가 서비스를 활성화하면, 악성코드는 프로그램적으로 추가적인 위험 권한들(`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …)을 부여하도록 필요한 탭을 시뮬레이션합니다.
3. **WebView**가 inflate되어 **`TYPE_ACCESSIBILITY_OVERLAY`** 윈도우 타입을 사용해 윈도우 매니저에 추가됩니다. 오버레이는 완전히 불투명하거나 반투명하게 렌더링될 수 있으며, 원래의 터치가 백그라운드 액티비티로 계속 전달되도록 *“through”*로 플래그될 수 있습니다(따라서 거래는 실제로 발생하지만 피해자는 피싱 양식만 보게 됩니다).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### 은행용 Trojans가 사용하는 일반적인 워크플로우
* 설치된 패키지를 조회(`QUERY_ALL_PACKAGES`)하여 현재 어떤 은행/지갑 앱이 열려 있는지 확인.
* C2에서 특정 애플리케이션을 완벽하게 모방하는 **HTML/JS overlay template**(로고, 색상, i18n 문자열 등)를 다운로드.
* 오버레이를 표시하고 자격증명/PIN/패턴을 탈취.
* 백그라운드에서 이체를 자동화하기 위해 **Accessibility API**(`performGlobalAction`, `GestureDescription`) 사용.

### 탐지 및 완화
* `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`로 설치된 앱 목록을 감사.
* 애플리케이션 측(은행/지갑):
- 민감한 뷰에 **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`**(Android 14+)를 설정하여 non-Play-Store 서비스를 차단.
- `setFilterTouchesWhenObscured(true)`와 `FLAG_SECURE`를 함께 사용.

원격 기기 완전 제어(예: PlayPraetor, SpyNote 등)를 위해 Accessibility Services를 활용하는 추가 정보는 다음을 참조:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## 참고자료
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
