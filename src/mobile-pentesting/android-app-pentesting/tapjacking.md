# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Informações Básicas**

**Tapjacking** é um ataque onde uma **aplicação maliciosa** é lançada e **se posiciona sobre uma aplicação vítima**. Uma vez que obscurece visivelmente o app vítima, sua interface é projetada de forma a enganar o usuário para interagir com ela, enquanto encaminha a interação para o app vítima.\
Em efeito, isso é **cegar o usuário quanto ao fato de que ele está realmente realizando ações no app vítima**.

### Detecção

* Procure por **exported activities** no manifest do Android (uma activity com um intent-filter é exportada por padrão). Se uma activity exportada for protegida por uma permission, o app atacante precisará da **mesma permission**, o que limita a exploitability.
* Verifique a versão **minimum SDK** `android:minSdkVersion` em `AndroidManifest.xml`. Se for **inferior a 30**, comportamentos padrão mais antigos podem tornar o tapjacking mais fácil de explorar.
* Em tempo de execução, use `logcat` para identificar toques bloqueados no Android 12+: o sistema registra `Untrusted touch due to occlusion by <package>` quando overlays são filtrados.

### Proteção

#### Bloqueio padrão do Android 12+ e compat flags

Android 12 (API 31) introduziu **"Block untrusted touches"**: toques vindos de outra janela com UID diferente do tipo `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) são descartados. Isso está habilitado por padrão. Durante testes você pode alterná-lo:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Janelas confiáveis (acessibilidade, IME, assistente) ainda recebem eventos. Sobreposições invisíveis ou totalmente transparentes também contornam o bloqueio, que atacantes tentam abusar mantendo `alpha < 0.8`.

#### Lidando com **obstrução parcial**

Sobreposições parciais que deixam a área alvo visível não são bloqueadas automaticamente. Mitigue em views sensíveis rejeitando eventos com a flag **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Se **`android:filterTouchesWhenObscured`** estiver definido como **`true`**, a `View` não receberá toques sempre que a janela da `View` for obscurecida por outra janela visível.

#### **`setFilterTouchesWhenObscured`**

O atributo **`setFilterTouchesWhenObscured`** definido como true também pode impedir a exploração dessa vulnerabilidade se a versão do Android for mais antiga.\
Se definido como **`true`**, por exemplo, um botão pode ser automaticamente **desabilitado se estiver obscurecido**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

The most **recent Android application** performing a Tapjacking attack (+ invoking before an exported activity of the attacked application) can be found in: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Follow the **README instructions to use it**.

### FloatingWindowApp

An example project implementing **FloatingWindowApp**, which can be used to put on top of other activities to perform a clickjacking attack, can be found in [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (a bit old, good luck building the apk).

### Qark

> [!CAUTION]
> It looks like this project is now unmaintained and this functionality isn't properly working anymore

You can use [**qark**](https://github.com/linkedin/qark) with the `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` parameters to create a malicious application to test for possible **Tapjacking** vulnerabilities.\

The mitigation is relatively simple as the developer may choose not to receive touch events when a view is covered by another. Using the [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Sometimes it is essential that an application be able to verify that an action is being performed with the full knowledge and consent of the user, such as granting a permission request, making a purchase or clicking on an advertisement. Unfortunately, a malicious application could try to spoof the user into performing these actions, unaware, by concealing the intended purpose of the view. As a remedy, the framework offers a touch filtering mechanism that can be used to improve the security of views that provide access to sensitive functionality.
>
> To enable touch filtering, call [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) or set the android:filterTouchesWhenObscured layout attribute to true. When enabled, the framework will discard touches that are received whenever the view's window is obscured by another visible window. As a result, the view will not receive touches whenever a toast, dialog or other window appears above the view's window.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** use nearly transparent overlays (e.g., fake NFC prompts) to capture gestures and lock-screen PINs while forwarding touches underneath, delivered via Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays for hundreds of banking/crypto apps and show full-screen "maintenance" overlays to stall victims while ATS completes transfers.
* **Hidden-VNC banking RATs** briefly display phishing overlays to capture credentials, then rely on covert VNC plus Accessibility to replay taps with fewer on-device artifacts.

Practical takeaway for red teams: mix an `alpha < 0.8` overlay to bypass Android 12 blocking, then escalate to a full-screen accessibility overlay once the user toggles the service. Instrument `GestureDescription` or a headless VNC to keep control after credentials are captured.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Besides classic Tapjacking, modern Android banking malware families (e.g. **ToxicPanda**, BrasDex, Sova, etc.) abuse the **Accessibility Service** to place a full-screen WebView **overlay** above the legitimate application while still being able to **forward the user input** to the view underneath.  This dramatically increases believability and allows attackers to steal credentials, OTPs or even automate fraudulent transactions.

### How it works
1. The malicious APK requests the highly-sensitive `BIND_ACCESSIBILITY_SERVICE` permission, usually hiding the request behind a fake Google/Chrome/PDF-viewer dialog.
2. Once the user enables the service, the malware programmatically simulates the taps required to grant additional dangerous permissions (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. A **WebView** is inflated and added to the window manager using the **`TYPE_ACCESSIBILITY_OVERLAY`** window type.  The overlay can be rendered totally opaque or semi-transparent and can be flagged as *“through”* so that the original touches are still delivered to the background activity (thus the transaction really happens while the victim only sees the phishing form).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Fluxo de trabalho típico usado por banking Trojans
* Consultar os pacotes instalados (`QUERY_ALL_PACKAGES`) para identificar qual banking / wallet app está atualmente aberto.
* Baixar um **HTML/JS overlay template** do C2 que imita perfeitamente essa aplicação específica (logo, cores, i18n strings…).
* Exibir o overlay, coletar credenciais/PIN/padrão.
* Usar a **Accessibility API** (`performGlobalAction`, `GestureDescription`) para automatizar transferências em segundo plano.

### Detecção & Mitigação
* Auditar a lista de apps instalados com `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Do lado da aplicação (bank / wallet):
- Habilitar **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) em views sensíveis para bloquear serviços não provenientes da Play-Store.
- Combinar com `setFilterTouchesWhenObscured(true)` e `FLAG_SECURE`.

Para detalhes adicionais sobre como aproveitar Accessibility Services para controle remoto completo do dispositivo (por exemplo PlayPraetor, SpyNote, etc.) veja:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Referências
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
