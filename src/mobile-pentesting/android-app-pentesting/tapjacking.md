# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **基本情報**

**Tapjacking** は、**悪意のある** **アプリケーション** が起動し、**被害アプリの上に自身を配置する** 攻撃です。視覚的に被害アプリを覆い隠すと、そのユーザーインターフェースはユーザを騙して操作させるように設計されており、同時にその操作を被害アプリに渡します。\ 
結果的に、ユーザは実際には被害アプリ上で操作を行っていることに気づかなくなります。

### 検出

* Android manifest 内で **exported activities** を探す（intent-filter を持つ activity はデフォルトで exported になる）。もし exported な activity が permission によって保護されている場合、攻撃アプリは **同じ permission** を必要とし、これにより悪用可能性は制限される。
* `AndroidManifest.xml` の `android:minSdkVersion` で **minimum SDK** バージョンを確認する。もし **30 未満** であれば、古いデフォルトの挙動により tapjacking の悪用が容易になる可能性がある。
* 実行時には `logcat` を使って Android 12+ でブロックされたタッチを確認する：オーバーレイがフィルタされるとシステムは `Untrusted touch due to occlusion by <package>` をログに出力する。

### 対策

#### Android 12+ のデフォルトブロッキングと互換フラグ

Android 12 (API 31) では **"Block untrusted touches"** が導入されました：別 UID のウィンドウでタイプが `TYPE_APPLICATION_OVERLAY`（不透明度 ≥0.8）のタッチは破棄されます。これはデフォルトで有効です。テスト中はこれを切り替えることができます：
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
信頼されたウィンドウ (accessibility, IME, assistant) は引き続きイベントを受け取ります。不可視または完全に透明なオーバーレイもブロックを回避します。攻撃者は `alpha < 0.8` を維持することでこれを悪用しようとします。

#### **部分的なオクルージョン** の対処

ターゲット領域を可視にしたままにする部分的なオーバーレイは自動的にブロックされません。機密性の高いビューでは、**`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** フラグが付いたイベントを拒否することで軽減してください:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

If **`android:filterTouchesWhenObscured`** is set to **`true`**, the `View` will not receive touches whenever view's window is obscured by another visible window.

#### **`setFilterTouchesWhenObscured`**

The attribute **`setFilterTouchesWhenObscured`** set to true can also prevent the exploitation of this vulnerability if the Android version is lower.\
If set to **`true`**, for example, a button can be automatically **無効化される場合があります（覆われているとき）**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

Tapjacking攻撃を行い（攻撃対象アプリのexported activityを呼び出す前に）いる最も**recent Android application**は次で見つかります: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity)。

**READMEの手順に従って使用してください**。

### FloatingWindowApp

**FloatingWindowApp**を実装したサンプルプロジェクトで、他のactivityの上に表示してclickjacking攻撃を行うために使えるものは、[**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) にあります（やや古く、apkをビルドするのは運次第です）。

### Qark

> [!CAUTION]
> このプロジェクトは現在メンテナンスされておらず、この機能は正しく動作しない可能性があります

`--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` パラメータを付けて [**qark**](https://github.com/linkedin/qark) を使用すると、可能性のある **Tapjacking** 脆弱性をテストするための悪意あるアプリを作成できます。\

軽減策は比較的単純で、開発者はビューが別のウィンドウで覆われているときにタッチイベントを受け取らないように選択できます。次の [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security) を参照してください:

> 時折、アプリケーションがユーザの完全な認識と同意のもとで操作が行われていることを検証できる必要がある場合があります。例えば、権限の付与、購入、広告のクリックなどです。残念ながら、悪意あるアプリはビューの意図を隠してユーザを騙し、これらの操作を気付かれずに行わせようとする可能性があります。これを解決するために、フレームワークはセンシティブな機能へアクセスを提供するビューのセキュリティを向上させるためのタッチフィルタリング機構を提供します。
>
> タッチフィルタリングを有効にするには、[`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) を呼び出すか、レイアウト属性 android:filterTouchesWhenObscured を true に設定します。これを有効にすると、ビューのウィンドウが別の可視ウィンドウで覆われているときに受信したタッチはフレームワークによって破棄されます。その結果、トースト、ダイアログ、または他のウィンドウがビューのウィンドウの上に表示されている間、ビューはタッチを受け取りません。

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** はほぼ透過の overlays（例: 偽の NFC プロンプト）を使ってジェスチャーやロック画面のPINをキャプチャし、下のアクティビティにタッチを転送しながら実行します。これらは Accessibility-ATS modules 経由で配布されます。
* **Anatsa/TeaBot droppers** は何百もの banking/crypto apps 向けに overlays を配布し、ATS が転送を完了する間に被害者を停滞させるためにフルスクリーンの "maintenance" overlays を表示します。
* **Hidden-VNC banking RATs** は資格情報を盗むために短時間フィッシング overlays を表示し、その後 covert VNC と Accessibility に頼って、より少ないデバイス上の痕跡でタップを再生します。

実務的なポイント（red teams 向け）: Android 12 のブロックを回避するために `alpha < 0.8` の overlay をまず混ぜ、その後ユーザがサービスを切り替えたらフルスクリーンの accessibility overlay にエスカレートします。資格情報を取得した後の制御を維持するために `GestureDescription` やヘッドレス VNC を仕込んでください。

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

古典的な Tapjacking に加え、現代の Android 銀行向け malware ファミリー（例: **ToxicPanda**, BrasDex, Sova など）は **Accessibility Service** を悪用して、正当なアプリケーションの上にフルスクリーンの WebView **overlay** を配置しながら、下のビューに **forward the user input** することができます。これにより信ぴょう性が大幅に向上し、攻撃者は資格情報、OTP、さらには不正なトランザクションの自動化まで行えます。

### How it works
1. 悪意ある APK は高感度の `BIND_ACCESSIBILITY_SERVICE` 権限を要求し、通常はこの要求を偽の Google/Chrome/PDF-viewer ダイアログの背後に隠します。
2. ユーザがサービスを有効にすると、マルウェアはプログラム的にさらに危険な権限（`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …）を付与させるために必要なタップをシミュレートします。
3. `WebView` がインフレートされ、`TYPE_ACCESSIBILITY_OVERLAY` ウィンドウタイプを使用して window manager に追加されます。オーバーレイは完全に不透明に表示することも半透明にすることもでき、*“through”* とフラグを立てて元のタッチを背景のアクティビティに届け続けるようにすることも可能です（そのため被害者はフィッシングフォームだけを見ている間に実際の取引が発生します）。
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### banking Trojans が使用する典型的なワークフロー
* インストール済みパッケージをクエリして (`QUERY_ALL_PACKAGES`) どの銀行／ウォレットアプリが現在開かれているかを特定する。
* C2 からその特定のアプリを完全に模倣する **HTML/JS overlay template**（ロゴ、色、i18n 文字列…）をダウンロードする。
* オーバーレイを表示して、credentials/PIN/pattern を収集する。
* バックグラウンドで振替を自動化するために **Accessibility API** (`performGlobalAction`, `GestureDescription`) を使用する。

### 検出と対策
* `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE` でインストール済みアプリの一覧を監査する。
* アプリケーション側（銀行／ウォレット）からの対策：
- センシティブなビューに対して **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) を有効にして、非 Play ストアのサービスをブロックする。
- `setFilterTouchesWhenObscured(true)` と `FLAG_SECURE` を組み合わせる。

For additional details on leveraging Accessibility Services for full remote device control (e.g. PlayPraetor, SpyNote, etc.) see:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## 参考資料
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
