# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Osnovne informacije**

**Tapjacking** je napad u kojem se pokreće **malicious application** i **pozicionira iznad victim application**. Kada vizuelno zakloni aplikaciju žrtve, njen korisnički interfejs je dizajniran tako da prevari korisnika da stupi u interakciju sa njim, dok istovremeno prosleđuje tu interakciju ciljnoj aplikaciji.\
U praksi, to znači da **oslepljuje korisnika tako da ne zna da zapravo izvodi radnje u aplikaciji žrtve**.

### Otkrivanje

* Potražite **exported activities** u Android manifestu (aktivnost sa intent-filterom je po defaultu exported). Ako je exported activity zaštićena permisijom, napadačka aplikacija će trebati **istu permisiju**, što ograničava mogućnost eksploatacije.
* Proverite **minimum SDK** verziju `android:minSdkVersion` u `AndroidManifest.xml`. Ako je **manja od 30**, starija podrazumevana ponašanja mogu olakšati eksploataciju tapjackinga.
* U runtime-u, koristite `logcat` da uočite blokirane dodire na Android 12+: sistem beleži `Untrusted touch due to occlusion by <package>` kada su overlay-i filtrirani.

### Zaštita

#### Android 12+ default blocking & compat flags

Android 12 (API 31) je uveo **"Block untrusted touches"**: dodiri koji dolaze iz prozora drugog UID-a tipa `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) se odbacuju. Ovo je uključeno po defaultu. Tokom testiranja možete to uključiti/isključiti:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Pouzdani prozori (accessibility, IME, assistant) i dalje primaju događaje. Nevidljivi ili potpuno prozirni overlay-i takođe zaobilaze blokadu, što napadači pokušavaju zloupotrebiti održavajući `alpha < 0.8`.

#### Rukovanje **delimičnim zaklanjanjem**

Delimični overlay-i koji ostavljaju ciljano područje vidljivim nisu automatski blokirani. Ublažite u osetljivim prikazima tako što ćete odbacivati događaje sa **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** flagom:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

If **`android:filterTouchesWhenObscured`** is set to **`true`**, the `View` will not receive touches whenever view's window is obscured by another visible window.

#### **`setFilterTouchesWhenObscured`**

Atribut **`setFilterTouchesWhenObscured`** postavljen na true takođe može sprečiti iskorišćavanje ove ranjivosti ako je verzija Androida niža.\
Ako je podešeno na **`true`**, na primer, dugme može biti automatski **onemogućeno ako je zasenčeno**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Eksploatacija

### Tapjacking-ExportedActivity

Najnovija **Android application** koja izvodi Tapjacking attack (+ invoking before an exported activity of the attacked application) može se naći u: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Pratite **README instructions to use it**.

### FloatingWindowApp

Primer projekta koji implementira **FloatingWindowApp**, koji se može koristiti za postavljanje preko drugih activities da bi se izveo clickjacking attack, može se naći u [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (a bit old, good luck building the apk).

### Qark

> [!CAUTION]
> Izgleda da je ovaj projekat sada neodržavan i da ova funkcionalnost više ne radi ispravno

Možete koristiti [**qark**](https://github.com/linkedin/qark) with the `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` parameters da kreirate malicioznu aplikaciju za testiranje mogućih **Tapjacking** vulnerabilities.\

Ublažavanje je relativno jednostavno jer developer može odlučiti da ne prima touch events kada je view prekriven drugim. Koristeći [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Ponekad je neophodno da aplikacija može da verifikuje da se radnja izvršava uz puno znanje i pristanak korisnika, kao što su odobravanje zahteva za dozvolu, kupovina ili klik na oglas. Nažalost, maliciozna aplikacija može pokušati da prevari korisnika da izvrši ove radnje, ne znajući za pravu namenu view-a, tako što će je sakriti. Kao lek, framework nudi mehanizam filtriranja touch-ova koji se može koristiti za poboljšanje sigurnosti view-ova koji omogućavaju pristup osetljivoj funkcionalnosti.
>
> Da biste omogućili filtriranje touch-ova, pozovite [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) or set the android:filterTouchesWhenObscured layout attribute to true. When enabled, the framework will discard touches that are received whenever the view's window is obscured by another visible window. As a result, the view will not receive touches whenever a toast, dialog or other window appears above the view's window.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** koriste nearly transparent overlays (npr. fake NFC prompts) da bi capture-ovali gestures i lock-screen PINs dok forwarding-uju touches ispod, isporučeni preko Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays za stotine banking/crypto apps i prikazuju full-screen "maintenance" overlays da stall-aju victims dok ATS completes transfers.
* **Hidden-VNC banking RATs** kratko prikazuju phishing overlays da bi capture-ovali credentials, zatim se oslanjaju na covert VNC plus Accessibility da replay-uju taps sa manje on-device artefakata.

Praktičan takeaway za red teams: mix an `alpha < 0.8` overlay da zaobiđete Android 12 blocking, zatim escalate-ujte na full-screen accessibility overlay once the user toggles the service. Instrument `GestureDescription` ili headless VNC da zadržite kontrolu nakon što su credentials capture-ovani.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Besides classic Tapjacking, modern Android banking malware families (e.g. **ToxicPanda**, BrasDex, Sova, etc.) abuse the **Accessibility Service** to place a full-screen WebView **overlay** above the legitimate application while still being able to **forward the user input** to the view underneath.  This dramatically increases believability and allows attackers to steal credentials, OTPs or even automate fraudulent transactions.

### How it works
1. The malicious APK requests the highly-sensitive `BIND_ACCESSIBILITY_SERVICE` permission, usually hiding the request behind a fake Google/Chrome/PDF-viewer dialog.
2. Once the user enables the service, the malware programmatically simulates the taps required to grant additional dangerous permissions (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. A **WebView** is inflated and added to the window manager using the **`TYPE_ACCESSIBILITY_OVERLAY`** window type.  The overlay can be rendered totally opaque or semi-transparent and can be flagged as *“through”* so that the original touches are still delivered to the background activity (thus the transaction really happens while the victim only sees the phishing form).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Tipičan tok rada koji koriste banking Trojans
* Query installed packages (`QUERY_ALL_PACKAGES`) to figure out which banking / wallet app is currently opened.
* Download an **HTML/JS overlay template** from the C2 that perfectly imitates that specific application (Logo, colours, i18n strings…).
* Display the overlay, harvest credentials/PIN/pattern.
* Use the **Accessibility API** (`performGlobalAction`, `GestureDescription`) to automate transfers in the background.

### Otkrivanje i ublažavanje
* Proverite listu instaliranih aplikacija sa `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Sa strane aplikacije (bank / wallet):
- Omogućite **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) na osetljivim view-ovima da blokirate non-Play-Store services.
- Kombinujte sa `setFilterTouchesWhenObscured(true)` i `FLAG_SECURE`.

For additional details on leveraging Accessibility Services for full remote device control (e.g. PlayPraetor, SpyNote, etc.) see:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Reference
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
