# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Taarifa za Msingi**

**Tapjacking** ni shambulio ambapo **programu hatarishi** inaanzishwa na **kujipanga juu ya programu ya mwathirika**. Mara inapoonekana kuficha programu ya mwathirika, kiolesura chake cha mtumiaji kimeundwa kwa njia ya kumdanganya mtumiaji kuingiliana nayo, wakati kwa kweli kinapitisha mwingiliano huo kwa programu ya mwathirika.\
Kwa vitendo, inamweka mtumiaji gizani kuhusu kujua kwamba kwa kweli anafanya vitendo kwenye programu ya mwathirika — **kumnyima mtumiaji uwezo wa kujua kwamba anafanya vitendo kwenye programu ya mwathirika**.

### Ugunduzi

* Angalia **exported activities** katika Android manifest (activity yenye intent-filter huwekwa exported kwa chaguo-msingi). Ikiwa exported activity inalindwa na ruhusa, app inayoshambulia itahitaji **ruhasa ile ile**, jambo ambalo linapunguza uwezo wa kutumika.
* Angalia toleo la **minimum SDK** `android:minSdkVersion` katika `AndroidManifest.xml`. Ikiwa ni **chini ya 30**, tabia za chaguo-msingi za zamani zinaweza kufanya tapjacking iwe rahisi kutumika.
* Wakati wa utekelezaji, tumia `logcat` kubaini touches zilizozuiwa kwenye Android 12+: mfumo unaandika log `Untrusted touch due to occlusion by <package>` wakati overlays zinachujwa.

### Ulinzi

#### Android 12+ default blocking & compat flags

Android 12 (API 31) ilileta **"Block untrusted touches"**: touches zinazoletwa kutoka kwa dirisha la UID tofauti la aina `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) zinakatwa. Hii imewezeshwa kwa chaguo-msingi. Wakati wa majaribio unaweza kuiwasha au kuizima:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Windows za kuaminika (accessibility, IME, assistant) bado hupokea matukio. Overlays zisizoonekana au zenye uwazi kabisa pia hupita kizuizi, jambo ambalo washambuliaji wanajaribu kutumia kwa kuweka `alpha < 0.8`.

#### Kushughulikia **kufunika kwa sehemu**

Overlays za sehemu ambazo zinaacha eneo la lengo liwe wazi hazizuilwi kiotomatiki. Punguza hatari katika views nyeti kwa kukataa matukio yenye bendera **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Ikiwa **`android:filterTouchesWhenObscured`** imewekwa kuwa **`true`**, `View` haitapokea mibofyo wakati wowote dirisha la `View` litakapofichwa na dirisha jingine linaloonekana.

#### **`setFilterTouchesWhenObscured`**

Sifa **`setFilterTouchesWhenObscured`** iliyowekwa kuwa **`true`** pia inaweza kuzuia kutumiwa kwa udhaifu huu ikiwa toleo la Android ni la chini.\
Ikiwa imewekwa kuwa **`true`**, kwa mfano, kitufe kinaweza kuzimwa kiotomatiki **ikiwa kimefichwa**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

The most **recent Android application** performing a Tapjacking attack (+ invoking before an exported activity of the attacked application) can be found in: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Follow the **README instructions to use it**.

### FloatingWindowApp

An example project implementing **FloatingWindowApp**, which can be used to put on top of other activities to perform a clickjacking attack, can be found in [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (a bit old, good luck building the apk).

### Qark

> [!CAUTION]
> It looks like this project is now unmaintained and this functionality isn't properly working anymore

Unaweza kutumia [**qark**](https://github.com/linkedin/qark) with the `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` parameters to create a malicious application to test for possible **Tapjacking** vulnerabilities.\

The mitigation is relatively simple as the developer may choose not to receive touch events when a view is covered by another. Using the [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Sometimes it is essential that an application be able to verify that an action is being performed with the full knowledge and consent of the user, such as granting a permission request, making a purchase or clicking on an advertisement. Unfortunately, a malicious application could try to spoof the user into performing these actions, unaware, by concealing the intended purpose of the view. As a remedy, the framework offers a touch filtering mechanism that can be used to improve the security of views that provide access to sensitive functionality.
>
> To enable touch filtering, call [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) or set the android:filterTouchesWhenObscured layout attribute to true. When enabled, the framework will discard touches that are received whenever the view's window is obscured by another visible window. As a result, the view will not receive touches whenever a toast, dialog or other window appears above the view's window.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** use nearly transparent overlays (e.g., fake NFC prompts) to capture gestures and lock-screen PINs while forwarding touches underneath, delivered via Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays for hundreds of banking/crypto apps and show full-screen "maintenance" overlays to stall victims while ATS completes transfers.
* **Hidden-VNC banking RATs** briefly display phishing overlays to capture credentials, then rely on covert VNC plus Accessibility to replay taps with fewer on-device artifacts.

Practical takeaway for red teams: mix an `alpha < 0.8` overlay to bypass Android 12 blocking, then escalate to a full-screen accessibility overlay once the user toggles the service. Instrument `GestureDescription` or a headless VNC to keep control after credentials are captured.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Besides classic Tapjacking, modern Android banking malware families (e.g. **ToxicPanda**, BrasDex, Sova, etc.) abuse the **Accessibility Service** to place a full-screen WebView **overlay** above the legitimate application while still being able to **forward the user input** to the view underneath.  This dramatically increases believability and allows attackers to steal credentials, OTPs or even automate fraudulent transactions.

### How it works
1. The malicious APK requests the highly-sensitive `BIND_ACCESSIBILITY_SERVICE` permission, usually hiding the request behind a fake Google/Chrome/PDF-viewer dialog.
2. Once the user enables the service, the malware programmatically simulates the taps required to grant additional dangerous permissions (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. A **WebView** is inflated and added to the window manager using the **`TYPE_ACCESSIBILITY_OVERLAY`** window type.  The overlay can be rendered totally opaque or semi-transparent and can be flagged as *“through”* so that the original touches are still delivered to the background activity (thus the transaction really happens while the victim only sees the phishing form).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Mwendo wa kawaida unaotumika na banking Trojans
* Kagua packages zilizowekwa (`QUERY_ALL_PACKAGES`) ili kubaini ni app gani ya benki / pochi imefunguliwa sasa.
* Pakua **HTML/JS overlay template** kutoka kwa C2 inayoiiga kabisa programu hiyo maalum (Logo, colours, i18n strings…).
* Onyesha overlay, kusanya credentials/PIN/pattern.
* Tumia **Accessibility API** (`performGlobalAction`, `GestureDescription`) kuendesha uhamisho kwa njia ya automatiska kwa background.

### Utambuzi na Kupunguza
* Kagua orodha ya apps zilizowekwa kwa kutumia `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Kwa upande wa programu (bank / wallet):
- Washa **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) kwenye views nyeti ili kuzuia services ambazo sio kutoka Play Store.
- Changanya na `setFilterTouchesWhenObscured(true)` na `FLAG_SECURE`.

Kwa maelezo zaidi juu ya kutumia Accessibility Services kwa udhibiti kamili wa kifaa kwa umbali (mfano PlayPraetor, SpyNote, nk.) ona:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Marejeo
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
