# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Βασικές Πληροφορίες**

**Tapjacking** είναι μια επίθεση όπου μια **κακόβουλη** **εφαρμογή** ξεκινάει και **τοποθετείται πάνω από μια εφαρμογή-θύμα**. Μόλις καλύψει οπτικά την εφαρμογή-θύμα, το user interface της σχεδιάζεται έτσι ώστε να ξεγελά τον χρήστη να αλληλεπιδράσει με αυτή, ενώ ταυτόχρονα προωθεί την αλληλεπίδραση προς την εφαρμογή-θύμα.\
Στην πράξη, αυτό **τυφλώνει τον χρήστη ως προς το ότι εκτελεί ενέργειες στην εφαρμογή-θύμα**.

### Detection

* Αναζητήστε **exported activities** στο Android manifest (an activity with an intent-filter is exported by default). Αν μια exported activity προστατεύεται από μια permission, η εφαρμογή-επιτιθέμενη θα χρειαστεί την **ίδια permission**, κάτι που περιορίζει την exploitability.
* Ελέγξτε το **minimum SDK** `android:minSdkVersion` στο `AndroidManifest.xml`. Αν είναι **κάτω από 30**, παλαιότερες προεπιλεγμένες συμπεριφορές μπορεί να κάνουν το tapjacking πιο εύκολο στην εκμετάλλευση.
* Κατά την εκτέλεση, χρησιμοποιήστε `logcat` για να εντοπίσετε blocked touches σε Android 12+: το σύστημα καταγράφει `Untrusted touch due to occlusion by <package>` όταν τα overlays φιλτράρονται.

### Protection

#### Android 12+ default blocking & compat flags

Android 12 (API 31) εισήγαγε **"Block untrusted touches"**: τα touches που προέρχονται από άλλο UID window του τύπου `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) απορρίπτονται. Αυτό είναι ενεργοποιημένο από προεπιλογή. Κατά τις δοκιμές μπορείτε να το εναλλαγείτε:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Τα εμπιστευόμενα παράθυρα (accessibility, IME, assistant) εξακολουθούν να λαμβάνουν συμβάντα. Αόρατες ή πλήρως διαφανείς επικαλύψεις επίσης παρακάμπτουν το μπλοκ, κάτι που οι επιτιθέμενοι προσπαθούν να εκμεταλλευτούν διατηρώντας `alpha < 0.8`.

#### Διαχείριση **μερικής απόφραξης**

Μερικές επικαλύψεις που αφήνουν την περιοχή-στόχο ορατή δεν μπλοκάρονται αυτόματα. Ελαχιστοποιήστε τον κίνδυνο σε ευαίσθητες προβολές απορρίπτοντας τα συμβάντα που έχουν τη σημαία **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Εάν **`android:filterTouchesWhenObscured`** είναι ρυθμισμένο σε **`true`**, το `View` δεν θα λαμβάνει αγγίγματα όποτε το παράθυρο της προβολής καλύπτεται από άλλο ορατό παράθυρο.

#### **`setFilterTouchesWhenObscured`**

Η ιδιότητα **`setFilterTouchesWhenObscured`** όταν έχει οριστεί σε `true` μπορεί επίσης να αποτρέψει την εκμετάλλευση αυτής της ευπάθειας εάν η έκδοση Android είναι παλαιότερη.\
Εάν οριστεί σε **`true`**, για παράδειγμα, ένα κουμπί μπορεί να απενεργοποιείται αυτόματα **εάν καλύπτεται**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Εκμετάλλευση

### Tapjacking-ExportedActivity

Η πιο πρόσφατη Android εφαρμογή που πραγματοποιεί επίθεση Tapjacking (και που καλεί πριν από μια exported activity της επιτιθέμενης εφαρμογής) βρίσκεται στο: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Ακολουθήστε τις οδηγίες στο **README** για να το χρησιμοποιήσετε.

### FloatingWindowApp

Ένα παράδειγμα έργου που υλοποιεί το **FloatingWindowApp**, το οποίο μπορεί να χρησιμοποιηθεί για να τοποθετηθεί πάνω από άλλες activities για να πραγματοποιήσει επίθεση clickjacking, βρίσκεται στο [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (λίγο παλιό, καλή τύχη στο να χτίσετε το apk).

### Qark

> [!CAUTION]
> Φαίνεται ότι αυτό το project δεν συντηρείται πλέον και αυτή η λειτουργικότητα δεν λειτουργεί σωστά πια

Μπορείτε να χρησιμοποιήσετε [**qark**](https://github.com/linkedin/qark) με τις παραμέτρους `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` για να δημιουργήσετε μια κακόβουλη εφαρμογή για να δοκιμάσετε τυχόν ευπάθειες **Tapjacking**.\

Η αντιμετώπιση είναι σχετικά απλή καθώς ο developer μπορεί να επιλέξει να μην λαμβάνει events αφής όταν ένα view καλύπτεται από άλλο. Χρησιμοποιώντας το [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Καμιά φορά είναι απαραίτητο μια εφαρμογή να μπορεί να επαληθεύσει ότι μια ενέργεια εκτελείται με την πλήρη γνώση και συγκατάθεση του χρήστη, όπως η χορήγηση ενός αιτήματος άδειας, η πραγματοποίηση μιας αγοράς ή το κλικ σε μια διαφήμιση. Δυστυχώς, μια κακόβουλη εφαρμογή θα μπορούσε να προσπαθήσει να εξαπατήσει τον χρήστη ώστε να εκτελέσει αυτές τις ενέργειες, χωρίς να το γνωρίζει, κρύβοντας τον προορισμό του view. Ως λύση, το framework προσφέρει έναν μηχανισμό φιλτραρίσματος αφής που μπορεί να χρησιμοποιηθεί για να βελτιώσει την ασφάλεια των views που παρέχουν πρόσβαση σε ευαίσθητη λειτουργικότητα.
>
> Για να ενεργοποιήσετε το φιλτράρισμα αφής, καλέστε [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) ή ορίστε το android:filterTouchesWhenObscured layout attribute σε true. Όταν είναι ενεργοποιημένο, το framework θα απορρίπτει τις αφές που λαμβάνονται κάθε φορά που το παράθυρο του view καλύπτεται από άλλο ορατό παράθυρο. Ως αποτέλεσμα, το view δεν θα λαμβάνει αφές κάθε φορά που ένα toast, dialog ή άλλο παράθυρο εμφανίζεται πάνω από το παράθυρο του view.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** χρησιμοποιούν σχεδόν διαφανή overlays (π.χ., fake NFC prompts) για να καταγράψουν gestures και lock-screen PINs ενώ προωθούν τις αφές από κάτω, παραδομένα μέσω Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays για εκατοντάδες banking/crypto apps και εμφανίζουν full-screen "maintenance" overlays για να καθυστερήσουν τα θύματα ενώ το ATS ολοκληρώνει μεταφορές.
* **Hidden-VNC banking RATs** εμφανίζουν σύντομα phishing overlays για να συλλάβουν credentials, και στη συνέχεια βασίζονται σε covert VNC plus Accessibility για να αναπαράγουν taps με λιγότερα on-device artifacts.

Πρακτικό συμπέρασμα για red teams: αναμίξτε ένα `alpha < 0.8` overlay για να παρακάμψετε το blocking του Android 12, και στη συνέχεια κλιμακώστε σε ένα full-screen accessibility overlay μόλις ο χρήστης ενεργοποιήσει την υπηρεσία. Ενσωματώστε `GestureDescription` ή ένα headless VNC για να διατηρήσετε τον έλεγχο μετά τη σύλληψη των credentials.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Besides classic Tapjacking, modern Android banking malware families (e.g. **ToxicPanda**, BrasDex, Sova, etc.) abuse the **Accessibility Service** to place a full-screen WebView **overlay** above the legitimate application while still being able to **forward the user input** to the view underneath.  This dramatically increases believability and allows attackers to steal credentials, OTPs or even automate fraudulent transactions.

### How it works
1. Το κακόβουλο APK ζητά την ιδιαίτερα ευαίσθητη άδεια `BIND_ACCESSIBILITY_SERVICE`, συνήθως κρύβοντας το αίτημα πίσω από ένα fake Google/Chrome/PDF-viewer dialog.
2. Μόλις ο χρήστης ενεργοποιήσει την υπηρεσία, το malware προγραμματικά προσομοιώνει τις αφές που απαιτούνται για να χορηγηθούν επιπλέον επικίνδυνες άδειες (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Ένα WebView δημιουργείται και προστίθεται στον window manager χρησιμοποιώντας τον τύπο παραθύρου `TYPE_ACCESSIBILITY_OVERLAY`. Το overlay μπορεί να αποδοθεί εντελώς αδιαφανές ή ημιδιαφανές και μπορεί να σημαδευτεί ως *“through”* ώστε οι αρχικές αφές να εξακολουθούν να παραδίδονται στην background activity (έτσι η συναλλαγή όντως εκτελείται ενώ το θύμα βλέπει μόνο τη phishing φόρμα).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Τυπική ροή εργασίας που χρησιμοποιούν τα banking Trojans
* Εντοπίζουν τα εγκατεστημένα πακέτα (`QUERY_ALL_PACKAGES`) για να διαπιστώσουν ποια banking / wallet app είναι ανοιχτή.
* Κατεβάζουν ένα **HTML/JS overlay template** από το C2 που μιμείται τέλεια εκείνη την συγκεκριμένη εφαρμογή (Logo, colours, i18n strings…).
* Εμφανίζουν το overlay, συλλέγουν credentials/PIN/pattern.
* Χρησιμοποιούν το **Accessibility API** (`performGlobalAction`, `GestureDescription`) για να αυτοματοποιήσουν τις μεταφορές στο παρασκήνιο.

### Detection & Mitigation
* Ελέγξτε τη λίστα εγκατεστημένων εφαρμογών με `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Από την πλευρά της εφαρμογής (bank / wallet):
- Ενεργοποιήστε **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) σε ευαίσθητες views για να εμποδίσετε υπηρεσίες εκτός Play Store.
- Συνδυάστε με `setFilterTouchesWhenObscured(true)` και `FLAG_SECURE`.

For additional details on leveraging Accessibility Services for full remote device control (e.g. PlayPraetor, SpyNote, etc.) see:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Αναφορές
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
