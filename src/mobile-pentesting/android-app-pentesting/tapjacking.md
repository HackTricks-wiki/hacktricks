# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Basiese Inligting**

**Tapjacking** is 'n aanval waar 'n **kwaadaardige** **toepassing** gelanseer word en **homself bo-op 'n slagoffer-toepassing posisioneer**. Sodra dit die slagoffer-toepassing sigbaar verberg, is die gebruikerskoppelvlak so ontwerp om die gebruiker te mislei om daarmee te interakteer, terwyl dit die interaksie aan die slagoffer-toepassing deurgee.\
In werklikheid **blind dit die gebruiker sodat hulle nie weet dat hulle eintlik aksies op die slagoffer-toepassing uitvoer nie**.

### Opsporing

* Kyk na **exported activities** in die Android manifest (n activity met 'n intent-filter word standaard exported). As 'n exported activity deur 'n permission beskerm word, sal die aanvallende app die **selfde permission** nodig hê, wat die benutbaarheid beperk.
* Kontroleer die **minimum SDK** weergawe `android:minSdkVersion` in `AndroidManifest.xml`. As dit **laer as 30** is, kan ouer standaardgedraginge tapjacking makliker maak om te benut.
* Tydens runtime, gebruik `logcat` om geblokkeerde aanrakinge op Android 12+ te sien: die stelsel log `Untrusted touch due to occlusion by <package>` wanneer overlays gefiltreer word.

### Beskerming

#### Android 12+ standaard blokkering & compat-vlae

Android 12 (API 31) het **"Block untrusted touches"** bekendgestel: aanrakinge komend van 'n ander UID-venster van tipe `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) word verwerp. Dit is standaard aangeskakel. Tydens toetse kan jy dit omskakel:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Betroubare vensters (accessibility, IME, assistant) ontvang steeds events. Onsigbare of volledig deursigtige overlays omseil ook die blok, wat aanvallers probeer misbruik deur `alpha < 0.8`.

#### Hantering van **gedeeltelike verberging**

Gedeeltelike overlays wat die teikenarea sigbaar laat, word nie outomaties geblokkeer nie. Mitigeer in sensitiewe views deur events te verwerp met die **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** vlag:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

As **`android:filterTouchesWhenObscured`** op **`true`** gestel is, sal die `View` nie aanrakinge ontvang nie wanneer die View se venster deur 'n ander sigbare venster bedek is.

#### **`setFilterTouchesWhenObscured`**

Die attribuut **`setFilterTouchesWhenObscured`** op **`true`** gestel kan ook die uitbuiting van hierdie kwesbaarheid voorkom as die Android-weergawe laer is.\
As dit op **`true`** gestel is, kan byvoorbeeld 'n knoppie outomaties **gedeaktiveer word as dit bedek is**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Uitbuiting

### Tapjacking-ExportedActivity

Die mees **onlangse Android-toepassing** wat 'n Tapjacking-aanval uitvoer (+ wat voor 'n exported activity van die geteikende toepassing aanroep) kan gevind word by: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Volg die **README-instruksies om dit te gebruik**.

### FloatingWindowApp

'n Voorbeeldprojek wat **FloatingWindowApp** implementeer, wat gebruik kan word om bo-op ander activities geplaas te word om 'n clickjacking-aanval uit te voer, kan gevind word by [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (iets oud — sterkte met die bou van die apk).

### Qark

> [!CAUTION]
> Dit lyk asof hierdie projek nou ononderhou is en hierdie funksionaliteit nie behoorlik meer werk nie

Jy kan [**qark**](https://github.com/linkedin/qark) met die `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` parameters gebruik om 'n kwaadwillige toepassing te skep om moontlike **Tapjacking** kwesbaarhede te toets.\

Die mitigasie is redelik eenvoudig aangesien die ontwikkelaar kan kies om nie raakraakgebeure te ontvang wanneer 'n view deur 'n ander gedek word nie. Met behulp van die [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Soms is dit noodsaaklik dat 'n toepassing kan verifieer dat 'n aksie uitgevoer word met die volle kennis en toestemming van die gebruiker, soos om 'n toestemmingsversoek toe te ken, 'n aankoop te doen of op 'n advertensie te klik. Ongelukkig kan 'n kwaadwillige toepassing probeer om die gebruiker te mislei om hierdie aksies onbewustelik uit te voer deur die beoogde doel van die view te verberg. As 'n oplossing bied die raamwerk 'n raakraakfiltreringsmeganisme wat gebruik kan word om die sekuriteit van views wat toegang tot sensitiewe funksionaliteit bied, te verbeter.
>
> Om raakraakfiltrering te aktiveer, roep [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) of stel die android:filterTouchesWhenObscured layout attribute op true. Wanneer geaktiveer, sal die raamwerk raakraak wat ontvang word verwerp wanneer die view's venster deur 'n ander sigbare venster gedek word. Gevolglik sal die view nie raakraak ontvang wanneer 'n toast, dialoog of ander venster bo die view's venster verskyn nie.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** gebruik byna deursigtige overlays (bv. fake NFC prompts) om gebare en slotskerm-PINs vas te vang terwyl hulle raakraak hieronder deurstuur, afgelewer via Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** plaas overlays vir honderde banking/crypto apps en wys volskerm "maintenance" overlays om slagoffers te vertraag terwyl ATS oordragte voltooi.
* **Hidden-VNC banking RATs** vertoon kortliks phishing-overlays om inlogbesonderhede vas te vang, en staatmaak dan op geheime VNC plus Accessibility om taps te herhaal met minder spore op die toestel.

Praktiese afleiding vir red teams: meng 'n `alpha < 0.8` overlay om Android 12-blokkasie te omseil, en eskaleer dan na 'n volskerm accessibility overlay sodra die gebruiker die diens aktiveer. Instrumenteer `GestureDescription` of 'n headless VNC om beheer te behou nadat inlogbesonderhede gevang is.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Benewens klassieke Tapjacking, misbruik moderne Android-bankmalware-families (bv. **ToxicPanda**, BrasDex, Sova, ens.) die **Accessibility Service** om 'n volskerm WebView **overlay** bo die legitieme toepassing te plaas terwyl dit steeds die vermoë het om die **gebruikersinvoer** na die view hieronder deur te stuur. Dit verhoog die geloofwaardigheid drasties en stel aanvallers in staat om inlogbesonderhede, OTPs of selfs geoutomatiseerde bedrieglike transaksies te steel.

### How it works
1. Die kwaadwillige APK versoek die hoogs-sensitiewe `BIND_ACCESSIBILITY_SERVICE` permission, gewoonlik deur die versoek agter 'n vals Google/Chrome/PDF-viewer dialoog weg te steek.
2. Sodra die gebruiker die diens aktiveer, simuleer die malware programmaties die tiks wat benodig word om addisionele gevaarlike permissions te verleen (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. 'n **WebView** word geïnflateer en by die window manager gevoeg met die **`TYPE_ACCESSIBILITY_OVERLAY`** venstertipe. Die overlay kan heeltemal ondoorsig of semi-deursigtig gerender word en kan as *“through”* gevlag wees sodat die oorspronklike raakraak steeds aan die background activity afgelewer word (dus gebeur die transaksie regtig terwyl die slagoffer slegs die phishing-vorm sien).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Tipiese werkvloei van banking Trojans
* Navraag oor geïnstalleerde pakkette (`QUERY_ALL_PACKAGES`) om te bepaal watter banking / wallet-app tans oop is.
* Laai 'n **HTML/JS overlay template** van die C2 wat daardie spesifieke toepassing perfek imiteer (Logo, kleure, i18n strings…).
* Vertoon die overlay en oes inlogbesonderhede/PIN/patroon.
* Gebruik die **Accessibility API** (`performGlobalAction`, `GestureDescription`) om oordragte op die agtergrond te outomatiseer.

### Opsporing & Mitigering
* Kontroleer die lys van geïnstalleerde apps met `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Vanaf die toepassing se kant (bank / wallet):
- Skakel **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) op sensitiewe views aan om nie-Play-Store-dienste te blokkeer.
- Kombineer met `setFilterTouchesWhenObscured(true)` en `FLAG_SECURE`.

For additional details on leveraging Accessibility Services for full remote device control (e.g. PlayPraetor, SpyNote, etc.) see:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## References
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
