# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Información básica**

**Tapjacking** es un ataque donde una **aplicación maliciosa** se lanza y **se posiciona encima de una aplicación víctima**. Una vez que oculta visiblemente la app víctima, su interfaz de usuario está diseñada de modo que engaña al usuario para que interactúe con ella, mientras que a su vez pasa la interacción a la app víctima.\
En efecto, está **cegando al usuario para que no sepa que en realidad está realizando acciones en la app víctima**.

### Detección

* Busca **exported activities** en el manifest de Android (una activity con un intent-filter está exportada por defecto). Si una activity exportada está protegida por un permiso, la app atacante necesitará el **mismo permiso**, lo que limita la explotabilidad.
* Comprueba la **minimum SDK** version `android:minSdkVersion` en `AndroidManifest.xml`. Si es **inferior a 30**, comportamientos por defecto antiguos pueden hacer que el tapjacking sea más fácil de explotar.
* En tiempo de ejecución, usa `logcat` para detectar toques bloqueados en Android 12+: el sistema registra `Untrusted touch due to occlusion by <package>` cuando se filtran overlays.

### Protección

#### Bloqueo por defecto en Android 12+ y banderas de compatibilidad

Android 12 (API 31) introdujo **"Block untrusted touches"**: los toques que provienen de otra ventana con distinto UID de tipo `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) son descartados. Esto está habilitado por defecto. Durante las pruebas puedes alternarlo:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Las ventanas confiables (accessibility, IME, assistant) siguen recibiendo eventos. Las superposiciones invisibles o totalmente transparentes también eluden el bloqueo, algo que los atacantes intentan explotar manteniendo `alpha < 0.8`.

#### Manejo de la **oclusión parcial**

Las superposiciones parciales que dejan el área objetivo visible no se bloquean automáticamente. Mitígalo en vistas sensibles rechazando eventos con la bandera **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Si **`android:filterTouchesWhenObscured`** está establecido en **`true`**, la `View` no recibirá toques cuando la ventana de la vista quede oculta por otra ventana visible.

#### **`setFilterTouchesWhenObscured`**

El atributo **`setFilterTouchesWhenObscured`** establecido en **`true`** también puede prevenir la explotación de esta vulnerabilidad si la versión de Android es más baja.\
Si se establece en **`true`**, por ejemplo, un botón puede ser automáticamente **deshabilitado si está oculto**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Explotación

### Tapjacking-ExportedActivity

La aplicación Android más **reciente** que realiza un ataque de Tapjacking (+ invocando antes una actividad exportada de la aplicación atacada) se puede encontrar en: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Sigue las instrucciones del **README** para usarla.

### FloatingWindowApp

Un proyecto de ejemplo que implementa **FloatingWindowApp**, que puede usarse para colocarse encima de otras activities para realizar un ataque de clickjacking, se encuentra en [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (algo antiguo, buena suerte compilando el apk).

### Qark

> [!CAUTION]
> Parece que este proyecto ya no se mantiene y esta funcionalidad puede no funcionar correctamente

Puedes usar [**qark**](https://github.com/linkedin/qark) con los parámetros `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` para crear una aplicación maliciosa y probar posibles vulnerabilidades de **Tapjacking**.\

La mitigación es relativamente simple, ya que el desarrollador puede optar por no recibir eventos táctiles cuando una vista está cubierta por otra. Usando la [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> A veces es esencial que una aplicación pueda verificar que una acción se realiza con pleno conocimiento y consentimiento del usuario, como conceder una solicitud de permiso, realizar una compra o hacer clic en un anuncio. Desafortunadamente, una aplicación maliciosa podría intentar engañar al usuario para que realice estas acciones sin saberlo, ocultando el propósito real de la vista. Como remedio, el framework ofrece un mecanismo de filtrado táctil que puede usarse para mejorar la seguridad de vistas que dan acceso a funcionalidades sensibles.
>
> Para habilitar el filtrado táctil, llama a [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) o establece el atributo de layout android:filterTouchesWhenObscured a true. Cuando está habilitado, el framework descartará los toques que se reciban siempre que la ventana de la vista esté oscurecida por otra ventana visible. Como resultado, la vista no recibirá toques siempre que aparezca un toast, un diálogo u otra ventana por encima de la ventana de la vista.

---

### Técnicas recientes de malware basadas en overlay

* **Hook/Ermac variants** usan overlays casi transparentes (p. ej., prompts NFC falsos) para capturar gestos y PINs de la pantalla de bloqueo mientras reenvían los toques al fondo, entregados vía Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** envían overlays para cientos de apps bancarias/crypto y muestran overlays de "maintenance" a pantalla completa para retrasar a las víctimas mientras ATS completa las transferencias.
* **Hidden-VNC banking RATs** muestran brevemente overlays de phishing para capturar credenciales, luego recurren a un VNC encubierto más Accessibility para reproducir toques con menos artefactos en el dispositivo.

Conclusión práctica para red teams: mezcla un overlay con `alpha < 0.8` para evadir el bloqueo de Android 12, y luego escala a un overlay de accesibilidad a pantalla completa una vez que el usuario active el servicio. Instrumenta `GestureDescription` o un VNC headless para mantener el control después de capturar credenciales.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Además del clásico Tapjacking, las familias modernas de malware bancario para Android (p. ej. **ToxicPanda**, BrasDex, Sova, etc.) abusan del **Accessibility Service** para colocar un **WebView** overlay a pantalla completa encima de la aplicación legítima mientras siguen pudiendo **reenviar la entrada del usuario** a la vista subyacente. Esto incrementa drásticamente la credibilidad y permite a los atacantes robar credenciales, OTPs o incluso automatizar transacciones fraudulentas.

### Cómo funciona
1. El APK malicioso solicita el permiso altamente sensible `BIND_ACCESSIBILITY_SERVICE`, normalmente ocultando la petición detrás de un diálogo falso de Google/Chrome/visor de PDF.
2. Una vez el usuario habilita el servicio, el malware simula programáticamente los toques necesarios para conceder permisos peligrosos adicionales (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Se infla un **WebView** y se añade al window manager usando el tipo de ventana **`TYPE_ACCESSIBILITY_OVERLAY`**. El overlay puede renderizarse totalmente opaco o semi-transparente y puede marcarse como *“through”* para que los toques originales sigan entregándose a la activity de fondo (por tanto la transacción realmente ocurre mientras la víctima solo ve el formulario de phishing).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Flujo de trabajo típico usado por banking Trojans
* Consultan los paquetes instalados (`QUERY_ALL_PACKAGES`) para determinar qué banking / wallet app está actualmente abierta.
* Descargan una **HTML/JS overlay template** desde el C2 que imita perfectamente esa aplicación específica (logotipo, colores, cadenas i18n…).
* Muestran el overlay y recolectan credenciales/PIN/patrón.
* Usan la **Accessibility API** (`performGlobalAction`, `GestureDescription`) para automatizar transferencias en segundo plano.

### Detección & Mitigación
* Auditar la lista de apps instaladas con `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Desde el lado de la aplicación (bank / wallet):
- Habilitar **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) en vistas sensibles para bloquear servicios no provenientes de Play-Store.
- Combinar con `setFilterTouchesWhenObscured(true)` y `FLAG_SECURE`.

Para detalles adicionales sobre cómo aprovechar Accessibility Services para control remoto completo del dispositivo (p.ej. PlayPraetor, SpyNote, etc.) ver:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Referencias
* [Android Developers – Riesgo y mitigaciones de Tapjacking (actualizado 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
