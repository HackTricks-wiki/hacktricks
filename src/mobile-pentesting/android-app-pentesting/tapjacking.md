# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Grundlegende Informationen**

**Tapjacking** ist ein Angriff, bei dem eine **bösartige** **Anwendung** gestartet wird und sich über eine Opferanwendung legt. Sobald sie die Opfer-App sichtbar verdeckt, ist ihre Benutzeroberfläche so gestaltet, dass sie den Benutzer dazu verleitet, mit ihr zu interagieren, während sie die Interaktion an die Opfer-App weiterleitet.\
Effektiv blendet sie den Benutzer, sodass dieser nicht weiß, dass er eigentlich Aktionen in der Opfer-App ausführt.

### Erkennung

* Suchen Sie nach **exported activities** im Android manifest (eine Activity mit einem intent-filter ist standardmäßig exported). Wenn eine exported activity durch eine permission geschützt ist, benötigt die angreifende App dieselbe **permission**, was die Ausnutzbarkeit einschränkt.
* Überprüfen Sie die **minimum SDK**-Version `android:minSdkVersion` in `AndroidManifest.xml`. Wenn sie **niedriger als 30** ist, können ältere Standardverhalten Tapjacking leichter ausnutzbar machen.
* Zur Laufzeit verwenden Sie `logcat`, um blockierte Touches auf Android 12+ zu erkennen: das System protokolliert `Untrusted touch due to occlusion by <package>` wenn Overlays gefiltert werden.

### Schutz

#### Android 12+ standardmäßiges Blockieren & compat flags

Android 12 (API 31) führte **"Block untrusted touches"** ein: Touches, die von einem Fenster mit anderer UID des Typs `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) stammen, werden verworfen. Dies ist standardmäßig aktiviert. Während Tests können Sie es umschalten:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Vertrauenswürdige Fenster (Accessibility, IME, Assistant) erhalten weiterhin Ereignisse. Unsichtbare oder vollständig transparente Overlays umgehen ebenfalls die Blockierung — Angreifer versuchen das auszunutzen, indem sie `alpha < 0.8` beibehalten.

#### Umgang mit **teilweiser Verdeckung**

Partielle Overlays, die den Zielbereich sichtbar lassen, werden nicht automatisch blockiert. In sensiblen Views sollte man das abmildern, indem man Ereignisse mit dem **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`**-Flag ablehnt:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Wenn **`android:filterTouchesWhenObscured`** auf **`true`** gesetzt ist, erhält die `View` keine Touch-Ereignisse, sobald das Fenster der View von einem anderen sichtbaren Fenster verdeckt wird.

#### **`setFilterTouchesWhenObscured`**

Das Attribut **`setFilterTouchesWhenObscured`**, auf **`true`** gesetzt, kann die Ausnutzung dieser Schwachstelle ebenfalls verhindern, wenn die Android-Version älter ist.\
Wenn es auf **`true`** gesetzt ist, kann zum Beispiel ein Button automatisch **deaktiviert werden, wenn er verdeckt ist**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

Die aktuellste **Android application**, die einen Tapjacking-Angriff durchführt (inkl. Aufruf vor einer exported activity der angegriffenen Anwendung), ist zu finden unter: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Befolgen Sie die **README instructions to use it**.

### FloatingWindowApp

Ein Beispielprojekt, das **FloatingWindowApp** implementiert und verwendet werden kann, um über andere Activities gelegt zu werden, um einen Clickjacking-Angriff auszuführen, ist zu finden unter [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (etwas älter, viel Glück beim Bauen der apk).

### Qark

> [!CAUTION]
> Es scheint, dass dieses Projekt mittlerweile ungewartet ist und diese Funktionalität nicht mehr richtig funktioniert

Sie können [**qark**](https://github.com/linkedin/qark) mit den Parametern `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` verwenden, um eine bösartige Anwendung zu erstellen, um mögliche **Tapjacking**-Schwachstellen zu testen.\

Die Gegenmaßnahme ist relativ einfach: Der Entwickler kann wählen, keine Touch-Events zu erhalten, wenn eine View von einer anderen bedeckt ist. Laut der [Android Developer’s Reference](https://developer.android.com/reference/android/view/View#security):

> Manchmal ist es unerlässlich, dass eine Anwendung verifizieren kann, dass eine Aktion mit vollem Wissen und Einverständnis des Nutzers ausgeführt wird, wie z. B. das Gewähren einer Berechtigungsanfrage, ein Kauf oder das Klicken auf eine Werbung. Leider könnte eine bösartige Anwendung versuchen, den Nutzer zu täuschen, damit er diese Aktionen unwissentlich ausführt, indem sie den vorgesehenen Zweck der View verschleiert. Als Abhilfe bietet das Framework einen Touch-Filter-Mechanismus, der verwendet werden kann, um die Sicherheit von Views zu verbessern, die Zugriff auf sensible Funktionalität bieten.
>
> Um Touch-Filtering zu aktivieren, rufen Sie [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) auf oder setzen Sie das android:filterTouchesWhenObscured Layout-Attribut auf true. Wenn aktiviert, verwirft das Framework Touches, die empfangen werden, wann immer das Fenster der View von einem anderen sichtbaren Fenster verdeckt wird. Infolgedessen erhält die View keine Touches, wann immer ein toast, dialog oder ein anderes Fenster über dem Fenster der View erscheint.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** use nearly transparent overlays (e.g., fake NFC prompts) to capture gestures and lock-screen PINs while forwarding touches underneath, delivered via Accessibility-ATS modules.
* **Anatsa/TeaBot droppers** ship overlays for hundreds of banking/crypto apps and show full-screen "maintenance" overlays to stall victims while ATS completes transfers.
* **Hidden-VNC banking RATs** briefly display phishing overlays to capture credentials, then rely on covert VNC plus Accessibility to replay taps with fewer on-device artifacts.

Praktische Erkenntnis für red teams: mixen Sie ein `alpha < 0.8` overlay, um die Android 12-Blockierung zu umgehen, und eskalieren Sie dann zu einem Full-Screen accessibility overlay, sobald der Nutzer den Service aktiviert. Instrumentieren Sie `GestureDescription` oder ein headless VNC, um die Kontrolle nach dem Erfassen der Zugangsdaten zu behalten.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Neben klassischem Tapjacking missbrauchen moderne Android-Banking-Malware-Familien (z. B. **ToxicPanda**, BrasDex, Sova, etc.) den **Accessibility Service**, um eine Full-Screen WebView **overlay** über der legitimen Anwendung zu platzieren und gleichzeitig die **Weiterleitung der Benutzereingaben** an die darunterliegende View zu ermöglichen. Das erhöht die Glaubwürdigkeit erheblich und ermöglicht Angreifern, Zugangsdaten, OTPs zu stehlen oder sogar betrügerische Transaktionen zu automatisieren.

### How it works
1. The malicious APK requests the highly-sensitive `BIND_ACCESSIBILITY_SERVICE` permission, usually hiding the request behind a fake Google/Chrome/PDF-viewer dialog.
2. Once the user enables the service, the malware programmatically simulates the taps required to grant additional dangerous permissions (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. A **WebView** is inflated and added to the window manager using the **`TYPE_ACCESSIBILITY_OVERLAY`** window type.  The overlay can be rendered totally opaque or semi-transparent and can be flagged as *“through”* so that the original touches are still delivered to the background activity (thus the transaction really happens while the victim only sees the phishing form).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Typischer Ablauf bei banking Trojans
* Abfragen installierter Packages (`QUERY_ALL_PACKAGES`), um herauszufinden, welche banking / wallet app gerade geöffnet ist.
* Herunterladen einer **HTML/JS overlay template** vom C2, die die spezifische Anwendung perfekt imitiert (Logo, colours, i18n strings…).
* Overlay anzeigen, Anmeldedaten/PIN/Muster abgreifen.
* Nutzung der **Accessibility API** (`performGlobalAction`, `GestureDescription`), um Überweisungen im Hintergrund zu automatisieren.

### Erkennung & Gegenmaßnahmen
* Audit der Liste installierter Apps mit `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Auf der Anwendungsseite (bank / wallet):
- Aktivieren Sie **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) auf sensiblen Views, um Nicht-Play-Store-Services zu blockieren.
- Kombinieren Sie dies mit `setFilterTouchesWhenObscured(true)` und `FLAG_SECURE`.

Für weitere Details zur Nutzung von Accessibility Services zur vollständigen Fernsteuerung des Geräts (z. B. PlayPraetor, SpyNote, etc.) siehe:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Referenzen
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
