# Tapjacking

{{#include ../../banners/hacktricks-training.md}}


## **Informações Básicas**

**Tapjacking** é um ataque onde um **aplicativo** **malicioso** é lançado e **se posiciona sobre um aplicativo vítima**. Uma vez que obscurece visivelmente o app vítima, sua interface é projetada de forma a enganar o usuário para interagir com ela, enquanto passa a interação para o aplicativo vítima.\
Em efeito, ele **cega o usuário para o fato de que ele está realmente executando ações no aplicativo vítima**.

### Detecção

* Procure por **atividades exportadas** no Android manifest (uma activity com um intent-filter é exported por padrão). Se uma atividade exportada estiver protegida por uma permission, o aplicativo atacante precisará da **mesma permission**, o que limita a exploitability.
* Verifique a **versão mínima do SDK** `android:minSdkVersion` em `AndroidManifest.xml`. Se for **inferior a 30**, comportamentos padrão mais antigos podem tornar o tapjacking mais fácil de explorar.
* Em tempo de execução, use `logcat` para identificar toques bloqueados no Android 12+: o sistema registra `Untrusted touch due to occlusion by <package>` quando overlays são filtrados.

### Proteção

#### Bloqueio padrão do Android 12+ & compat flags

Android 12 (API 31) introduziu **"Block untrusted touches"**: toques vindos de outra janela com UID diferente do tipo `TYPE_APPLICATION_OVERLAY` (opacity ≥0.8) são descartados. Isso vem ativado por padrão. Durante testes você pode alterná-lo:
```bash
# disable blocking for a specific package (for PoC crafting)
adb shell am compat disable BLOCK_UNTRUSTED_TOUCHES com.example.victim
# re‑enable
adb shell am compat reset BLOCK_UNTRUSTED_TOUCHES com.example.victim
```
Janelas confiáveis (accessibility, IME, assistant) ainda recebem eventos. Sobreposições invisíveis ou totalmente transparentes também burlam o bloqueio, que atacantes tentam abusar mantendo `alpha < 0.8`.

#### Tratamento de **oclusão parcial**

Sobreposições parciais que deixam a área alvo visível não são bloqueadas automaticamente. Mitigue em views sensíveis rejeitando eventos com a **`FLAG_WINDOW_IS_PARTIALLY_OBSCURED`** flag:
```java
@Override
public boolean onFilterTouchEventForSecurity(MotionEvent event) {
if ((event.getFlags() & MotionEvent.FLAG_WINDOW_IS_PARTIALLY_OBSCURED) != 0) {
return false; // drop tap when anything partially obscures us
}
return super.onFilterTouchEventForSecurity(event);
}
```
#### `filterTouchesWhenObscured`

Se **`android:filterTouchesWhenObscured`** estiver definido como **`true`**, a `View` não receberá toques sempre que a janela da `View` estiver obscurecida por outra janela visível.

#### **`setFilterTouchesWhenObscured`**

O atributo **`setFilterTouchesWhenObscured`** definido como true também pode impedir a exploração dessa vulnerabilidade se a versão do Android for mais antiga.\
Se definido como **`true`**, por exemplo, um botão pode ser automaticamente **desabilitado se estiver obscurecido**:
```xml
<Button android:text="Button"
android:id="@+id/button1"
android:layout_width="wrap_content"
android:layout_height="wrap_content"
android:filterTouchesWhenObscured="true">
</Button>
```
## Exploitation

### Tapjacking-ExportedActivity

A aplicação Android mais **recente** realizando um ataque de Tapjacking (+ invocando antes uma exported activity da aplicação atacada) pode ser encontrada em: [**https://github.com/carlospolop/Tapjacking-ExportedActivity**](https://github.com/carlospolop/Tapjacking-ExportedActivity).

Siga as **instruções do README para usá-la**.

### FloatingWindowApp

Um projeto de exemplo que implementa **FloatingWindowApp**, que pode ser usado para se sobrepor a outras activities para executar um ataque de clickjacking, pode ser encontrado em [**FloatingWindowApp**](https://github.com/aminography/FloatingWindowApp) (um pouco antigo, boa sorte compilando o apk).

### Qark

> [!CAUTION]
> Parece que este projeto não está mais mantido e esta funcionalidade não está funcionando corretamente

Você pode usar [**qark**](https://github.com/linkedin/qark) com os parâmetros `--exploit-apk` --sdk-path `/Users/username/Library/Android/sdk` para criar um aplicativo malicioso para testar possíveis vulnerabilidades de **Tapjacking**.\

A mitigação é relativamente simples, pois o desenvolvedor pode optar por não receber eventos de toque quando uma view está coberta por outra. Usando o Android Developer’s Reference:

> Às vezes é essencial que uma aplicação seja capaz de verificar que uma ação está sendo executada com o pleno conhecimento e consentimento do usuário, como conceder uma solicitação de permissão, fazer uma compra ou clicar em um anúncio. Infelizmente, uma aplicação maliciosa poderia tentar enganar o usuário para executar essas ações sem perceber, ocultando o propósito pretendido da view. Como remédio, o framework oferece um mecanismo de filtragem de toques que pode ser usado para melhorar a segurança de views que fornecem acesso a funcionalidades sensíveis.
>
> Para habilitar a filtragem de toques, chame [`setFilterTouchesWhenObscured(boolean)`](https://developer.android.com/reference/android/view/View#setFilterTouchesWhenObscured%28boolean%29) ou configure o atributo de layout android:filterTouchesWhenObscured para true. Quando habilitado, o framework descartará toques que sejam recebidos sempre que a janela da view estiver obscurecida por outra janela visível. Como resultado, a view não receberá toques sempre que um toast, diálogo ou outra janela aparecer acima da janela da view.

---

### Recent overlay-based malware techniques

* **Hook/Ermac variants** usam overlays quase transparentes (por exemplo, prompts NFC falsos) para capturar gestos e PINs de bloqueio de tela enquanto encaminham os toques para baixo, entregues via módulos Accessibility-ATS.
* **Anatsa/TeaBot droppers** incluem overlays para centenas de apps de banking/crypto e mostram overlays em tela cheia tipo "manutenção" para atrasar a vítima enquanto o ATS completa as transferências.
* **Hidden-VNC banking RATs** exibem brevemente overlays de phishing para capturar credenciais, depois dependem de VNC covert e Accessibility para reproduzir toques com menos vestígios no dispositivo.

Resumo prático para red teams: misture um overlay com `alpha < 0.8` para contornar o bloqueio do Android 12, então escale para um overlay de accessibility em tela cheia assim que o usuário habilitar o serviço. Instrumente `GestureDescription` ou um VNC headless para manter o controle após as credenciais serem capturadas.

---

## Accessibility Overlay Phishing (Banking-Trojan Variant)

Além do Tapjacking clássico, famílias modernas de malware bancário para Android (ex.: **ToxicPanda**, BrasDex, Sova, etc.) abusam do **Accessibility Service** para colocar um WebView em overlay em tela cheia acima da aplicação legítima enquanto ainda conseguem **encaminhar a entrada do usuário** para a view subjacente. Isso aumenta dramaticamente a credibilidade e permite que atacantes roubem credenciais, OTPs ou até mesmo automatizem transações fraudulentas.

### How it works
1. O APK malicioso solicita a permissão altamente sensível `BIND_ACCESSIBILITY_SERVICE`, geralmente ocultando a solicitação atrás de um diálogo falso do Google/Chrome/visualizador de PDF.
2. Uma vez que o usuário habilita o serviço, o malware simula programaticamente os toques necessários para conceder permissões perigosas adicionais (`READ_SMS`, `SYSTEM_ALERT_WINDOW`, `REQUEST_INSTALL_PACKAGES`, …).
3. Um **WebView** é inflado e adicionado ao window manager usando o tipo de janela **`TYPE_ACCESSIBILITY_OVERLAY`**. O overlay pode ser renderizado totalmente opaco ou semi-transparente e pode ser marcado como *“through”* para que os toques originais ainda sejam entregues à activity de fundo (assim a transação realmente acontece enquanto a vítima vê apenas o formulário de phishing).
```java
WebView phishingView = new WebView(getApplicationContext());
phishingView.getSettings().setJavaScriptEnabled(true);
phishingView.loadUrl("file:///android_asset/bank_login.html");

WindowManager wm = (WindowManager) getSystemService(WINDOW_SERVICE);
WindowManager.LayoutParams lp = new WindowManager.LayoutParams(
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.MATCH_PARENT,
WindowManager.LayoutParams.TYPE_ACCESSIBILITY_OVERLAY,  // <-- bypasses SYSTEM_ALERT_WINDOW prompt
WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,        // «through» flag → forward touches
PixelFormat.TRANSLUCENT);
wm.addView(phishingView, lp);
```
### Fluxo de trabalho típico usado por banking Trojans
* Consultar pacotes instalados (`QUERY_ALL_PACKAGES`) para identificar qual aplicativo bancário / de carteira está atualmente aberto.
* Baixar um **HTML/JS overlay template** do C2 que imita perfeitamente essa aplicação específica (Logo, cores, i18n strings…).
* Exibir o overlay, capturar credenciais/PIN/padrão.
* Usar a **Accessibility API** (`performGlobalAction`, `GestureDescription`) para automatizar transferências em background.

### Detecção & Mitigação
* Auditar a lista de apps instalados com `adb shell pm list packages -3 -e BIND_ACCESSIBILITY_SERVICE`.
* Do lado da aplicação (banco / carteira):
- Habilitar **`android:accessibilityDataSensitive="accessibilityDataPrivateYes"`** (Android 14+) em views sensíveis para bloquear serviços que não são da Play Store.
- Combinar com `setFilterTouchesWhenObscured(true)` e `FLAG_SECURE`.

Para detalhes adicionais sobre como explorar Accessibility Services para controle remoto completo do dispositivo (p.ex. PlayPraetor, SpyNote, etc.) veja:


{{#ref}}
accessibility-services-abuse.md
{{#endref}}

## Referências
* [Android Developers – Tapjacking risk & mitigations (updated 2024)](https://developer.android.com/privacy-and-security/risks/tapjacking)
* [Zimperium – HOOK v3 overlay expansion (Aug 2025)](https://thehackernews.com/2025/08/hook-android-trojan-adds-ransomware.html)

{{#include ../../banners/hacktricks-training.md}}
