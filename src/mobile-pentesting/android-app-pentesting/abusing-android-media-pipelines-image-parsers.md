# Κατάχρηση Android Media Pipelines & Image Parsers

{{#include ../../banners/hacktricks-training.md}}

## Παράδοση: Εφαρμογές μηνυμάτων ➜ MediaStore ➜ Προνομιακοί Αναλυτές

Τα σύγχρονα builds OEM εκτελούν τακτικά προνομιακούς indexers μέσων που ξανασκανάρουν το `MediaStore` για λειτουργίες "AI" ή κοινής χρήσης. Σε firmware της Samsung πριν από το patch Απριλίου 2025, το `com.samsung.ipservice` φορτώνει το Quram (`/system/lib64/libimagecodec.quram.so`) και αναλύει αυτόματα οποιοδήποτε αρχείο που το WhatsApp (ή άλλες εφαρμογές) τοποθετεί στο `MediaStore`. Στην πράξη, ένας επιτιθέμενος μπορεί να στείλει ένα DNG μεταμφιεσμένο ως `IMG-*.jpg`, να περιμένει το θύμα να πατήσει "download" (1-click), και η προνομιακή υπηρεσία θα αναλύσει το payload ακόμα κι αν ο χρήστης δεν ανοίξει ποτέ την gallery.
```bash
$ file IMG-2025-02-10.jpeg
TIFF image data ...
$ exiftool IMG-2025-02-10.jpeg | grep "Opcode List"
Opcode List 1 : [opcode 23], [opcode 23], ...
```
**Κύρια συμπεράσματα**
- Η παράδοση βασίζεται στην επανα-ανάλυση μέσων από το σύστημα (όχι από τον chat client) και έτσι κληρονομεί τα δικαιώματα αυτής της διαδικασίας (πλήρης read/write πρόσβαση στη gallery, δυνατότητα απόθεσης νέων media, κ.λπ.).
- Οποιοσδήποτε image parser προσβάσιμος μέσω του `MediaStore` (vision widgets, wallpapers, AI résumé features, κ.λπ.) γίνεται απομακρυσμένα προσβάσιμος αν ο attacker πείσει το θύμα να αποθηκεύσει media.

## Quram's DNG Opcode Interpreter Bugs

Τα DNG αρχεία ενσωματώνουν τρεις λίστες opcode που εφαρμόζονται σε διαφορετικά στάδια decode. Ο Quram αντιγράφει το API της Adobe, αλλά ο Stage-3 handler για το `DeltaPerColumn` (opcode ID 11) εμπιστεύεται όρια επιπέδων που προέρχονται από τον attacker.

### Αποτυχία ορίων επιπέδου στο `DeltaPerColumn`
- Οι attackers βάζουν `plane=5125` και `planes=5123` παρότι οι εικόνες Stage-3 εκθέτουν μόνο επίπεδα 0–2 (RGB).
- Ο Quram υπολογίζει `opcode_last_plane = image_planes + opcode_planes` αντί για `plane + count`, και ποτέ δεν ελέγχει αν το προκύπτον εύρος επιπέδων χωράει μέσα στην εικόνα.
- Επομένως ο βρόχος γράφει ένα delta σε `raw_pixel_buffer[plane_index]` με εντελώς ελεγχόμενο offset (π.χ., plane 5125 ⇒ offset `5125 * 2 bytes/pixel = 0x2800`). Κάθε opcode προσθέτει μία 16-bit float τιμή (0x6666) στην στοχευμένη θέση, αποδίδοντας ένα ακριβές heap OOB add primitive.

### Μετατροπή των increments σε arbitrary writes
- Το exploit πρώτα χαλάει τα Stage-3 `QuramDngImage.bottom/right` χρησιμοποιώντας 480 malformed `DeltaPerColumn` operations ώστε μελλοντικά opcodes να θεωρούν τεράστιες συντεταγμένες ως in-bounds.
- Τα `MapTable` opcodes (opcode 7) στοχεύονται τότε σε αυτά τα ψεύτικα όρια. Χρησιμοποιώντας πίνακα αντικατάστασης με όλα μηδενικά ή ένα `DeltaPerColumn` με `-Inf` deltas, ο attacker μηδενίζει οποιαδήποτε περιοχή, και στη συνέχεια εφαρμόζει επιπλέον deltas για να γράψει ακριβείς τιμές.
- Επειδή οι παράμετροι των opcode βρίσκονται μέσα στα DNG metadata, το payload μπορεί να κωδικοποιήσει εκατοντάδες χιλιάδες writes χωρίς να αγγίξει απευθείας τη μνήμη της διεργασίας.

## Heap Shaping Under Scudo

Ο Scudo κατηγοριοποιεί allocations κατά μέγεθος. Τυχαία ο Quram δεσμεύει τα παρακάτω αντικείμενα με τα ίδια 0x30-byte chunk sizes, οπότε καταλήγουν στην ίδια περιοχή (0x40-byte spacing στο heap):
- `QuramDngImage` descriptors για Stage 1/2/3
- `QuramDngOpcodeTrimBounds` και vendor `Unknown` opcodes (ID ≥14, συμπεριλαμβανομένου του ID 23)

Το exploit σειροθετεί allocations για να τοποθετήσει deterministically τα chunks:
1. Stage-1 `Unknown(23)` opcodes (20,000 entries) ψεκάζουν 0x30 chunks που απελευθερώνονται αργότερα.
2. Το Stage-2 απελευθερώνει αυτά τα opcodes και τοποθετεί ένα νέο `QuramDngImage` μέσα στην απελευθερωμένη περιοχή.
3. 240 Stage-2 `Unknown(23)` entries απελευθερώνονται, και το Stage-3 αμέσως δεσμεύει το `QuramDngImage` του συν ένα νέο raw pixel buffer του ίδιου μεγέθους, επαναχρησιμοποιώντας αυτές τις θέσεις.
4. Ένα crafted `TrimBounds` opcode τρέχει πρώτο στη λίστα 3 και δεσμεύει ακόμη ένα raw pixel buffer πριν απελευθερωθεί το Stage-2 state, εξασφαλίζοντας γειτνίαση "raw pixel buffer ➜ QuramDngImage".
5. 640 επιπλέον `TrimBounds` entries σημειώνονται `minVersion=1.4.0.1` έτσι ο dispatcher τα παραλείπει, αλλά τα backing objects παραμένουν allocated και αργότερα γίνονται primitive targets.

Αυτή η χορογραφία τοποθετεί το Stage-3 raw buffer αμέσως πριν από το Stage-3 `QuramDngImage`, οπότε το overflow βάσει επιπέδων αναστρέφει πεδία μέσα στον descriptor αντί να προκαλέσει τυχαίο crash.

## Reusing Vendor "Unknown" Opcodes as Data Blobs

Η Samsung αφήνει το high bit ενεργό στα vendor-specific opcode IDs (π.χ. ID 23), που λέει στον interpreter να *δεσμεύσει* τη δομή αλλά να παραλείψει την εκτέλεση. Το exploit κακοποιεί αυτά τα ανενεργά αντικείμενα ως attacker-controlled heaps:
- Οι λίστες opcode 1 και 2 `Unknown(23)` λειτουργούν ως συνεχή scratchpads για αποθήκευση bytes payload (JOP chain στην offset 0xf000 και ένα shell command στο 0x10000 σχετικό με το raw buffer).
- Επειδή ο interpreter εξακολουθεί να θεωρεί κάθε αντικείμενο ως opcode όταν επεξεργάζεται τη λίστα 3, η κατάληψη της vtable ενός αντικειμένου αρκεί αργότερα για να αρχίσει η εκτέλεση attacker data.

## Crafting Bogus `MapTable` Objects & Bypassing ASLR

Τα `MapTable` objects είναι μεγαλύτερα από τα `TrimBounds`, αλλά μόλις προκύψει η layout corruption, ο parser ευχαρίστως διαβάζει επιπλέον παραμέτρους out-of-bounds:
1. Χρησιμοποιήστε το linear write primitive για μερική υπερχείλιση ενός `TrimBounds` vtable pointer με ένα crafted `MapTable` substitution table που χαρτογραφεί τα χαμηλότερα 2 bytes από μια γειτονική `TrimBounds` vtable στην `MapTable` vtable. Μόνο τα low bytes διαφέρουν μεταξύ υποστηριζόμενων Quram builds, οπότε ένας μοναδικός 64K lookup table μπορεί να καλύψει επτά firmware εκδόσεις και κάθε 4 KB ASLR slide.
2. Επιδιορθώστε τα υπόλοιπα πεδία του `TrimBounds` (top/left/width/planes) έτσι ώστε το αντικείμενο να συμπεριφέρεται σαν έγκυρο `MapTable` όταν εκτελεστεί αργότερα.
3. Εκτελέστε το fake opcode πάνω σε μηδενισμένη μνήμη. Επειδή ο pointer του substitution table στην πραγματικότητα αναφέρεται στη vtable κάποιου άλλου opcode, τα output bytes γίνονται *leaked* low-order addresses από `libimagecodec.quram.so` ή το GOT του.
4. Εφαρμόστε επιπλέον `MapTable` passes για να μετατρέψετε αυτά τα δύο-byte leaks σε offsets προς gadgets όπως `__ink_jpeg_enc_process_image+64`, `QURAMWINK_Read_IO2+124`, `qpng_check_IHDR+624`, και την libc `__system_property_get` entry. Οι attackers ανασυνθέτουν ουσιαστικά πλήρεις διευθύνσεις μέσα στην περιοχή του sprayed opcode χωρίς native memory disclosure APIs.

## Triggering the JOP ➜ `system()` Transition

Μόλις οι pointers των gadget και το shell command τοποθετηθούν μέσα στο opcode spray:
1. Ένα τελικό κύμα `DeltaPerColumn` writes προσθέτει `0x0100` στην offset 0x22 του Stage-3 `QuramDngImage`, μετακινώντας τον pointer του raw buffer κατά 0x10000 ώστε τώρα να αναφέρεται στο attacker command string.
2. Ο interpreter αρχίζει να εκτελεί την ουρά από 1040 `Unknown(23)` opcodes. Η πρώτη χαλασμένη εγγραφή έχει την vtable της αντικατεστημένη με τον forged table στην offset 0xf000, έτσι `QuramDngOpcode::aboutToApply` επιλύει `qpng_read_data` (τη 4η εγγραφή) από τον fake table.
3. Τα αλυσιδωτά gadgets κάνουν: φόρτωση του pointer `QuramDngImage`, πρόσθεση 0x20 για να δείξει στον pointer του raw buffer, dereference του, αντιγραφή του αποτελέσματος σε `x19/x0`, και μετά άλμα μέσω GOT slots που έχουν ξαναγραφεί σε `system`. Επειδή ο raw buffer pointer τώρα δείχνει στο attacker string, το τελικό gadget εκτελεί `system(<shell command>)` μέσα σε `com.samsung.ipservice`.

## Σημειώσεις για παραλλαγές allocator

Υπάρχουν δύο οικογένειες payload: μία ρυθμισμένη για jemalloc και άλλη για scudo. Διαφέρουν στην παραγγελία των opcode blocks για να πετύχουν γειτνίαση αλλά μοιράζονται τα ίδια λογικά primitives (DeltaPerColumn bug ➜ MapTable zero/write ➜ bogus vtable ➜ JOP). Η απενεργοποιημένη quarantine του Scudo κάνει την επαναχρησιμοποίηση freelist των 0x30-byte ντετερμινιστική, ενώ ο jemalloc εξαρτάται από τον έλεγχο size-class μέσω tile/subIFD sizing.

## References

- [Project Zero – A look at an Android ITW DNG exploit](https://projectzero.google/2025/12/android-itw-dng.html)

{{#include ../../banners/hacktricks-training.md}}
