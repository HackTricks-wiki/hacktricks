# Zloupotreba Android media pipelines i image parsera

{{#include ../../banners/hacktricks-training.md}}

## Dostava: Messaging Apps ➜ MediaStore ➜ Privileged Parsers

Moderne OEM verzije redovno pokreću privilegovane media indexere koji ponovo skeniraju `MediaStore` zbog "AI" ili funkcija deljenja. Na Samsung firmware-u pre April 2025 patch-a, `com.samsung.ipservice` učitava Quram (`/system/lib64/libimagecodec.quram.so`) i automatski parsira svaku datoteku koju WhatsApp (ili druge aplikacije) ubace u `MediaStore`. U praksi, napadač može poslati DNG prikriven kao `IMG-*.jpg`, sačekati da žrtva dodirne "download" (1-click), i privilegovana usluga će parsirati payload čak i ako korisnik nikada ne otvori galeriju.
```bash
$ file IMG-2025-02-10.jpeg
TIFF image data ...
$ exiftool IMG-2025-02-10.jpeg | grep "Opcode List"
Opcode List 1 : [opcode 23], [opcode 23], ...
```
**Ključni zaključci**
- Isporuka zavisi od ponovnog parsiranja medija od strane sistema (ne chat klijenta) i zato nasleđuje dozvole tog procesa (puni read/write pristup galeriji, mogućnost ubacivanja novog medija, itd.).
- Bilo koji image parser dostupan preko `MediaStore` (vision widgets, wallpapers, AI résumé features, itd.) postaje udaljeno dostupan ako napadač ubedi metu da sačuva medij.

## Quram's DNG Opcode Interpreter Bugs

DNG fajlovi ugrađuju tri liste opcode-ova primenjene u različitim fazama dekodiranja. Quram kopira Adobe-ov API, ali njegov Stage-3 handler za `DeltaPerColumn` (opcode ID 11) veruje granicama planova koje dostavi napadač.

### Failing plane bounds in `DeltaPerColumn`
- Napadači podešavaju `plane=5125` i `planes=5123` iako Stage-3 slike izlažu samo planove 0–2 (RGB).
- Quram računa `opcode_last_plane = image_planes + opcode_planes` umesto `plane + count`, i nikada ne proverava da li ostvareni opseg planova staje unutar slike.
- Petlja zato upisuje delta vrednost u `raw_pixel_buffer[plane_index]` sa potpuno kontrolisanim offsetom (npr. plane 5125 ⇒ offset `5125 * 2 bytes/pixel = 0x2800`). Svaki opcode dodaje 16-bit float vrednost (0x6666) na ciljnu lokaciju, što daje preciznu heap OOB add primitivu.

### Turning increments into arbitrary writes
- Eksploit prvo korumpira Stage-3 `QuramDngImage.bottom/right` koristeći 480 malformisanih `DeltaPerColumn` operacija tako da budući opcode-i tretiraju ogromne koordinate kao in-bounds.
- `MapTable` opcode-i (opcode 7) su potom usmereni na te lažne granice. Korišćenjem tabele zamenjivanja svih nula ili `DeltaPerColumn` sa `-Inf` deltas, napadač ničim postavi bilo koji region na nulu, a zatim primenjuje dodatne delte da upiše tačne vrednosti.
- Pošto parametri opcode-a žive u DNG metadata, payload može enkodirati stotine hiljada upisa bez direktnog dodirivanja procesa memorije.

## Heap Shaping Under Scudo

Scudo grupiše alokacije po veličini. Quram slučajno alocira sledeće objekte sa identičnom veličinom chunk-a 0x30, pa završe u istom regionu (razmak 0x40 na heap-u):
- `QuramDngImage` descriptors za Stage 1/2/3
- `QuramDngOpcodeTrimBounds` i vendor `Unknown` opcode-i (ID ≥14, uključujući ID 23)

Eksploit sekvencira alokacije da deterministički postavi chunk-ove:
1. Stage-1 `Unknown(23)` opcode-i (20,000 entry-ja) raspršuju 0x30 chunk-ove koji se kasnije oslobađaju.
2. Stage-2 oslobađa te opcode-e i postavlja novi `QuramDngImage` unutar oslobođenog regiona.
3. 240 Stage-2 `Unknown(23)` entry-ja se oslobađa, i Stage-3 odmah alocira svoj `QuramDngImage` plus novi raw pixel buffer iste veličine, ponovo koristeći ta mesta.
4. Krojeni `TrimBounds` opcode se izvršava prvi u listi 3 i alocira još jedan raw pixel buffer pre nego što se Stage-2 stanje oslobodi, garantujući susedstvo "raw pixel buffer ➜ QuramDngImage".
5. Dodatnih 640 `TrimBounds` entry-ja označeno je sa `minVersion=1.4.0.1` tako da dispatcher preskače njihovo izvršavanje, ali njihovi backing objekti ostaju alocirani i kasnije postaju cilj primitiva.

Ova koreografija stavlja Stage-3 raw buffer odmah pre Stage-3 `QuramDngImage`, pa overflow zasnovan na planovima preokreće polja unutar descriptor-a umesto da sruši nasumično stanje.

## Reusing Vendor "Unknown" Opcodes as Data Blobs

Samsung ostavlja high bit postavljen u vendor-specific opcode ID-jevima (npr. ID 23), što interpreteru govori da *alokira* strukturu ali preskoči izvršenje. Eksploit zloupotrebljava te dormatne objekte kao heap-ove pod kontrolom napadača:
- Opcode liste 1 i 2 `Unknown(23)` entry-ji služe kao kontiguni scratchpad-i za skladištenje payload bajtova (JOP chain na offsetu 0xf000 i shell komanda na 0x10000 relativno u raw buffer-u).
- Pošto interpreter i dalje tretira svaki objekat kao opcode kad se lista 3 procesuira, preuzimanje vtable-a jednog objekta kasnije je dovoljno da počne izvršavati napadačka data.

## Crafting Bogus `MapTable` Objects & Bypassing ASLR

`MapTable` objekti su veći od `TrimBounds`, ali kad korupcija rasporeda stigne, parser rado čita dodatne parametre out-of-bounds:
1. Iskoristi linearni write primitiv da delimično prepiše `TrimBounds` vtable pointer sa krojenom `MapTable` substitution tabelom koja mapira niža 2 bajta iz susednog `TrimBounds` vtable-a na `MapTable` vtable. Samo niži bajtovi se razlikuju između podržanih Quram build-ova, tako da jedna 64K lookup tabela može pokriti sedam firmware verzija i svaki 4 KB ASLR slide.
2. Ispegla ostatak `TrimBounds` polja (top/left/width/planes) tako da objekat ponaša kao validan `MapTable` kad se kasnije izvrši.
3. Izvrši lažni opcode preko nultirane memorije. Pošto pointer substitution tabele zapravo referencira vtable drugog opcode-a, output bajtovi postaju *leaked* low-order adrese iz `libimagecodec.quram.so` ili njegovog GOT-a.
4. Primeni dodatne `MapTable` prolaze da konvertuje ta 2-bajtna leak-ovana mesta u offset-e ka gadget-ima kao što su `__ink_jpeg_enc_process_image+64`, `QURAMWINK_Read_IO2+124`, `qpng_check_IHDR+624`, i libc-ov `__system_property_get` entry. Napadači efektivno rekonstruišu pune adrese unutar svog raspršenog opcode regiona bez nativnih API-ja za otkrivanje memorije.

## Triggering the JOP ➜ `system()` Transition

Kada su pokazivači na gadget-e i shell komanda postavljeni unutar opcode spray-a:
1. Finalna runda `DeltaPerColumn` upisa dodaje `0x0100` na offset 0x22 Stage-3 `QuramDngImage`, pomerajući njegov raw buffer pointer za 0x10000 tako da sada ukazuje na napadačev komandni string.
2. Interpreter počinje da izvršava rep od 1040 `Unknown(23)` opcode-a. Prvi korumpirani entry ima svoj vtable zamenjen sa falsifikovanom tabelom na offsetu 0xf000, pa `QuramDngOpcode::aboutToApply` resolve-uje `qpng_read_data` (četvrti entry) iz lažne tabele.
3. Povezani gadget-i izvedu: učitaj `QuramDngImage` pointer, dodaj 0x20 da pokazuje na raw buffer pointer, dereferenciraj ga, kopiraj rezultat u `x19/x0`, pa skači kroz GOT slotove prepisane na `system`. Pošto raw buffer pointer sada pokazuje na napadačev string, finalni gadget izvršava `system(<shell command>)` unutar `com.samsung.ipservice`.

## Notes on Allocator Variants

Postoje dve porodice payload-a: jedna podešena za jemalloc, druga za scudo. Razlikuju se u načinu na koji su opcode blokovi poredjani da bi se postigla susednost, ali dele iste logičke primitive (DeltaPerColumn bug ➜ MapTable zero/write ➜ bogus vtable ➜ JOP). Scudo-ova onemogućena quarantine čini reuse 0x30-byte freelist-a determinističkim, dok jemalloc zavisi od kontrole size-class preko tile/subIFD sizing-a.

## References

- [Project Zero – A look at an Android ITW DNG exploit](https://projectzero.google/2025/12/android-itw-dng.html)

{{#include ../../banners/hacktricks-training.md}}
