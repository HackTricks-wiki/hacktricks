# Ausnutzen einer debuggbare Anwendung

{{#include ../../banners/hacktricks-training.md}}

# **Umgehen von Root- und Debugging-Prüfungen**

Dieser Abschnitt des Beitrags ist eine Zusammenfassung des Beitrags [**https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0**](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)

## Schritte, um eine Android-App debuggbare zu machen und Prüfungen zu umgehen

### **Die App debuggbare machen**

Inhalt basierend auf https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0

1. **APK dekompilieren:**

- Verwenden Sie das APK-GUI-Tool zum Dekompilieren der APK.
- Fügen Sie in der _android-manifest_-Datei `android:debuggable=true` hinzu, um den Debugging-Modus zu aktivieren.
- Kompilieren Sie die modifizierte Anwendung neu, signieren Sie sie und zipalignen Sie sie.

2. **Die modifizierte Anwendung installieren:**

- Verwenden Sie den Befehl: `adb install <application_name>`.

3. **Den Paketnamen abrufen:**

- Führen Sie `adb shell pm list packages –3` aus, um Drittanbieteranwendungen aufzulisten und den Paketnamen zu finden.

4. **Die App auf das Warten auf Debugger-Verbindung einstellen:**

- Befehl: `adb shell am setup-debug-app –w <package_name>`.
- **Hinweis:** Dieser Befehl muss jedes Mal ausgeführt werden, bevor die Anwendung gestartet wird, um sicherzustellen, dass sie auf den Debugger wartet.
- Für Persistenz verwenden Sie `adb shell am setup-debug-app –w -–persistent <package_name>`.
- Um alle Flags zu entfernen, verwenden Sie `adb shell am clear-debug-app <package_name>`.

5. **Für das Debugging in Android Studio vorbereiten:**

- Navigieren Sie in Android Studio zu _Datei -> Profil oder APK öffnen_.
- Öffnen Sie die neu kompilierte APK.

6. **Breakpoints in wichtigen Java-Dateien setzen:**
- Setzen Sie Breakpoints in `MainActivity.java` (insbesondere in der `onCreate`-Methode), `b.java` und `ContextWrapper.java`.

### **Umgehen von Prüfungen**

Die Anwendung wird an bestimmten Punkten überprüfen, ob sie debuggbare ist, und auch nach Binärdateien suchen, die auf ein gerootetes Gerät hinweisen. Der Debugger kann verwendet werden, um Anwendungsinformationen zu ändern, das debuggbare Bit zurückzusetzen und die Namen der gesuchten Binärdateien zu ändern, um diese Prüfungen zu umgehen.

Für die debuggbare Prüfung:

1. **Flag-Einstellungen ändern:**
- Navigieren Sie im Variablenbereich der Debugger-Konsole zu: `this mLoadedAPK -> mApplicationInfo -> flags = 814267974`.
- **Hinweis:** Die binäre Darstellung von `flags = 814267974` ist `11000011100111011110`, was darauf hinweist, dass das "Flag_debuggable" aktiv ist.

![https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png](https://miro.medium.com/v2/resize:fit:1400/1*-ckiSbWGSoc1beuxxpKbow.png)

Diese Schritte gewährleisten zusammen, dass die Anwendung debuggt werden kann und dass bestimmte Sicherheitsprüfungen mithilfe des Debuggers umgangen werden können, was eine eingehendere Analyse oder Modifikation des Verhaltens der Anwendung ermöglicht.

Schritt 2 beinhaltet das Ändern eines Flag-Werts auf 814267972, was binär als 110000101101000000100010100 dargestellt wird.

# **Ausnutzen einer Schwachstelle**

Eine Demonstration wurde mit einer verwundbaren Anwendung durchgeführt, die einen Button und ein Textfeld enthält. Zunächst zeigt die Anwendung "Crack Me". Das Ziel ist es, die Nachricht von "Try Again" zu "Hacked" zur Laufzeit zu ändern, ohne den Quellcode zu modifizieren.

## **Überprüfen auf Schwachstellen**

- Die Anwendung wurde mit `apktool` dekompiliert, um auf die `AndroidManifest.xml`-Datei zuzugreifen.
- Das Vorhandensein von `android_debuggable="true"` in der AndroidManifest.xml zeigt an, dass die Anwendung debuggbare ist und anfällig für Ausnutzung ist.
- Es ist erwähnenswert, dass `apktool` ausschließlich verwendet wird, um den debuggbare Status zu überprüfen, ohne den Code zu ändern.

## **Vorbereitung des Setups**

- Der Prozess umfasste das Starten eines Emulators, das Installieren der verwundbaren Anwendung und die Verwendung von `adb jdwp`, um die Dalvik-VM-Ports zu identifizieren, die lauschen.
- Das JDWP (Java Debug Wire Protocol) ermöglicht das Debuggen einer Anwendung, die in einer VM läuft, indem ein einzigartiger Port bereitgestellt wird.
- Portweiterleitung war notwendig für das Remote-Debugging, gefolgt von der Anbindung von JDB an die Zielanwendung.

## **Code zur Laufzeit injizieren**

- Die Ausnutzung wurde durch das Setzen von Breakpoints und das Steuern des Anwendungsflusses durchgeführt.
- Befehle wie `classes` und `methods <class_name>` wurden verwendet, um die Struktur der Anwendung aufzudecken.
- Ein Breakpoint wurde in der `onClick`-Methode gesetzt, und ihre Ausführung wurde gesteuert.
- Die Befehle `locals`, `next` und `set` wurden verwendet, um lokale Variablen zu inspizieren und zu ändern, insbesondere um die Nachricht "Try Again" in "Hacked" zu ändern.
- Der modifizierte Code wurde mit dem Befehl `run` ausgeführt, wodurch die Ausgabe der Anwendung in Echtzeit erfolgreich geändert wurde.

Dieses Beispiel demonstrierte, wie das Verhalten einer debuggbare Anwendung manipuliert werden kann, was das Potenzial für komplexere Ausnutzungen wie den Zugriff auf die Shell des Geräts im Kontext der Anwendung hervorhebt.

## Referenzen

- [https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0](https://medium.com/@shubhamsonani/hacking-with-precision-bypass-techniques-via-debugger-in-android-apps-27fd562b2cc0)
- [https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications](https://resources.infosecinstitute.com/android-hacking-security-part-6-exploiting-debuggable-android-applications)

{{#include ../../banners/hacktricks-training.md}}
