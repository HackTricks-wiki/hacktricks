# Kuchambua Maktaba za Asili

{{#include ../../banners/hacktricks-training.md}}


**Kwa taarifa zaidi angalia:** [**https://maddiestone.github.io/AndroidAppRE/reversing_native_libs.html**](https://maddiestone.github.io/AndroidAppRE/reversing_native_libs.html)

Programu za Android zinaweza kutumia maktaba za asili, mara nyingi zilizotungwa kwa C au C++, kwa kazi zinazohitaji utendaji wa juu. Waumba wa malware pia hutumia maktaba hizi kwa sababu ELF shared objects bado ni ngumu zaidi decompile ikilinganishwa na DEX/OAT byte-code.
Ukurasa huu unalenga kwenye mtiririko wa kazi wa *vitendo* na maboresho ya zana *ya hivi karibuni* (2023-2025) ambayo yanafanya kuchambua faili za Android `.so` kuwa rahisi zaidi.

---

### Mtiririko wa uchunguzi wa haraka kwa `libfoo.so` iliyotolewa hivi karibuni

1. **Toa maktaba**
```bash
# From an installed application
adb shell "run-as <pkg> cat lib/arm64-v8a/libfoo.so" > libfoo.so
# Or from the APK (zip)
unzip -j target.apk "lib/*/libfoo.so" -d extracted_libs/
```
2. **Tambua usanifu & ulinzi**
```bash
file libfoo.so        # arm64 or arm32 / x86
readelf -h libfoo.so  # OS ABI, PIE, NX, RELRO, etc.
checksec --file libfoo.so  # (peda/pwntools)
```
3. **Orodhesha alama zilizotumwa nje & vifungo vya JNI**
```bash
readelf -s libfoo.so | grep ' Java_'     # dynamic-linked JNI
strings libfoo.so   | grep -i "RegisterNatives" -n   # static-registered JNI
```
4. **Pakia katika decompiler** (Ghidra ≥ 11.0, IDA Pro, Binary Ninja, Hopper or Cutter/Rizin) na endesha uchambuzi otomatiki.
Toleo jipya la Ghidra limeleta decompiler ya AArch64 inayotambua PAC/BTI stubs na MTE tags, ikiboresha sana uchambuzi wa maktaba zilizojengwa kwa NDK ya Android 14.
5. **Amua kati ya static vs dynamic reversing:** code iliyokatwa au iliyofichwa mara nyingi inahitaji *instrumentation* (Frida, ptrace/gdbserver, LLDB).

---

### Instrumentation ya Dynamic (Frida ≥ 16)

Mfululizo wa Frida 16 ulileta maboresho kadhaa maalumu kwa Android ambayo husaidia pale lengo linapotumia optimizations za kisasa za Clang/LLD:

* `thumb-relocator` sasa inaweza *hook* tiny ARM/Thumb functions zinazozalishwa na alignment kali ya LLD (`--icf=all`).
* Kukagua na kure-bind *ELF import slots* kunafanya kazi kwenye Android, kuruhusu patching kwa kila module kwa `dlopen()`/`dlsym()` wakati inline hooks zinapokataa.
* Java hooking ilirekebishwa kwa **ART quick-entrypoint** mpya inayotumika wakati apps zime-compile kwa `--enable-optimizations` kwenye Android 14.

Mfano: kuorodhesha functions zote zilizosasishwa kupitia `RegisterNatives` na ku-dump anwani zao wakati wa runtime:
```javascript
Java.perform(function () {
var Runtime = Java.use('java.lang.Runtime');
var register = Module.findExportByName(null, 'RegisterNatives');
Interceptor.attach(register, {
onEnter(args) {
var envPtr  = args[0];
var clazz   = Java.cast(args[1], Java.use('java.lang.Class'));
var methods = args[2];
var count   = args[3].toInt32();
console.log('[+] RegisterNatives on ' + clazz.getName() + ' -> ' + count + ' methods');
// iterate & dump (JNI nativeMethod struct: name, sig, fnPtr)
}
});
});
```
Frida itafanya kazi bila marekebisho kwenye vifaa vya PAC/BTI (Pixel 8/Android 14+) mradi tu utumie frida-server 16.2 au toleo jipya zaidi — matoleo ya awali yalishindwa kutambua padding kwa inline hooks.

### Telemetry ya ndani ya mchakato ya JNI kupitia .so iliyopangwa kabla (SoTap)

Wakati instrumentation yenye sifa kamili ni zaidi ya kinachohitajika au imezuiliwa, bado unaweza kupata uonekano wa kiwango cha native kwa kupakia kabla logger ndogo ndani ya mchakato lengwa. SoTap ni maktaba nyepesi ya Android native (.so) inayorekodi tabia ya wakati wa utekelezaji ya maktaba nyingine za JNI (.so) ndani ya mchakato huo wa app (no root required).

Sifa muhimu:
- Inaanza mapema na inafuatilia mwingiliano wa JNI/native ndani ya mchakato unaoipakia.
- Inahifadhi logs kwa kutumia njia mbalimbali zinazoweza kuandikwa na ina fallback ya heshima kwa Logcat wakati uhifadhi umezuiliwa.
- Inayoweza kubadilishwa kwenye chanzo: hariri sotap.c ili kupanua/kubadilisha kinachorekodiwa na ujenge upya kwa kila ABI.

Usanidi (repack the APK):
1) Weka build sahihi ya ABI ndani ya APK ili loader iweze kutatua libsotap.so:
- lib/arm64-v8a/libsotap.so (for arm64)
- lib/armeabi-v7a/libsotap.so (for arm32)
2) Hakikisha SoTap inapakuliwa kabla ya maktaba nyingine za JNI. Inject a call early (e.g., Application subclass static initializer or onCreate) ili logger ianzishwe kwanza. Smali snippet example:
```smali
const-string v0, "sotap"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
```
3) Rebuild/sign/install, run the app, then collect logs.

Njia za logi (zinakaguliwa kwa mpangilio):
```
/data/user/0/%s/files/sotap.log
/data/data/%s/files/sotap.log
/sdcard/Android/data/%s/files/sotap.log
/sdcard/Download/sotap-%s.log
# If all fail: fallback to Logcat only
```
Notes and troubleshooting:
- ABI alignment is mandatory. A mismatch will raise UnsatisfiedLinkError and the logger won’t load.
- Storage constraints are common on modern Android; if file writes fail, SoTap will still emit via Logcat.
- Behavior/verbosity is intended to be customized; rebuild from source after editing sotap.c.

This approach is useful for malware triage and JNI debugging where observing native call flows from process start is critical but root/system-wide hooks aren’t available.

---

### Recent vulnerabilities worth hunting for in APKs

| Year | CVE | Affected library | Notes |
|------|-----|------------------|-------|
|2023|CVE-2023-4863|`libwebp` ≤ 1.3.1|Heap buffer overflow reachable from native code that decodes WebP images. Several Android apps bundle vulnerable versions. When you see a `libwebp.so` inside an APK, check its version and attempt exploitation or patching.| |
|2024|Multiple|OpenSSL 3.x series|Several memory-safety and padding-oracle issues. Many Flutter & ReactNative bundles ship their own `libcrypto.so`.|

Unapogundua *third-party* `.so` files ndani ya APK, hakikisha unalinganisha hash yao dhidi ya advisories za upstream. SCA (Software Composition Analysis) haiko kawaida kwenye mobile, kwa hivyo builds zilizozee zenye udhaifu ni nyingi.

---

### Anti-Reversing & Hardening trends (Android 13-15)

* **Pointer Authentication (PAC) & Branch Target Identification (BTI):** Android 14 inawezesha PAC/BTI katika system libraries kwenye silicon inayounga mkono ARMv8.3+. Decompilers sasa zinaonyesha PAC‐related pseudo-instructions; kwa dynamic analysis Frida inaingiza trampolines *after* stripping PAC, lakini trampolines zako za kawaida zinapaswa kuita `pacda`/`autibsp` inapofaa.
* **MTE & Scudo hardened allocator:** memory-tagging ni opt-in lakini apps nyingi zinazotumia Play-Integrity zinajenga kwa `-fsanitize=memtag`; tumia `setprop arm64.memtag.dump 1` pamoja na `adb shell am start ...` ili kushika tag faults.
* **LLVM Obfuscator (opaque predicates, control-flow flattening):** commercial packers (e.g., Bangcle, SecNeo) zinazilinda zaidi *native* code, si Java pekee; tarajia bogus control-flow na encrypted string blobs katika `.rodata`.

---

### Resources

- **Learning ARM Assembly:** [Azeria Labs – ARM Assembly Basics](https://azeria-labs.com/writing-arm-assembly-part-1/)
- **JNI & NDK Documentation:** [Oracle JNI Spec](https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/jniTOC.html) · [Android JNI Tips](https://developer.android.com/training/articles/perf-jni) · [NDK Guides](https://developer.android.com/ndk/guides/)
- **Debugging Native Libraries:** [Debug Android Native Libraries Using JEB Decompiler](https://medium.com/@shubhamsonani/how-to-debug-android-native-libraries-using-jeb-decompiler-eec681a22cf3)

### References

- Frida 16.x change-log (Android hooking, tiny-function relocation) – [frida.re/news](https://frida.re/news/)
- NVD advisory for `libwebp` overflow CVE-2023-4863 – [nvd.nist.gov](https://nvd.nist.gov/vuln/detail/CVE-2023-4863)
- SoTap: Lightweight in-app JNI (.so) behavior logger – [github.com/RezaArbabBot/SoTap](https://github.com/RezaArbabBot/SoTap)
- SoTap Releases – [github.com/RezaArbabBot/SoTap/releases](https://github.com/RezaArbabBot/SoTap/releases)
- How to work with SoTap? – [t.me/ForYouTillEnd/13](https://t.me/ForYouTillEnd/13)

{{#include ../../banners/hacktricks-training.md}}
