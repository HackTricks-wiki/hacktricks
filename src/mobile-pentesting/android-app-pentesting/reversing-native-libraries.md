# Reversing Native Libraries

{{#include ../../banners/hacktricks-training.md}}


**For further information check:** [**https://maddiestone.github.io/AndroidAppRE/reversing_native_libs.html**](https://maddiestone.github.io/AndroidAppRE/reversing_native_libs.html)

Android apps can use native libraries, typically written in C or C++, for performance-critical tasks. Malware creators also abuse these libraries because ELF shared objects are still harder to decompile than DEX/OAT byte-code.
This page focuses on *practical* workflows and *recent* tooling improvements (2023-2025) that make reversing Android `.so` files easier.

---

### Quick triage-workflow for a freshly pulled `libfoo.so`

1. **Extract the library**
```bash
# From an installed application
adb shell "run-as <pkg> cat lib/arm64-v8a/libfoo.so" > libfoo.so
# Or from the APK (zip)
unzip -j target.apk "lib/*/libfoo.so" -d extracted_libs/
```
2. **Identify architecture & protections**
```bash
file libfoo.so        # arm64 or arm32 / x86
readelf -h libfoo.so  # OS ABI, PIE, NX, RELRO, etc.
checksec --file libfoo.so  # (peda/pwntools)
```
3. **List exported symbols & JNI bindings**
```bash
readelf -s libfoo.so | grep ' Java_'     # dynamic-linked JNI
strings libfoo.so   | grep -i "RegisterNatives" -n   # static-registered JNI
```
4. **Load in a decompiler** (Ghidra ≥ 11.0, IDA Pro, Binary Ninja, Hopper or Cutter/Rizin) and run auto-analysis.
Newer Ghidra versions introduced an AArch64 decompiler that recognises PAC/BTI stubs and MTE tags, greatly improving analysis of libraries built with the Android 14 NDK.
5. **Decide on static vs dynamic reversing:** stripped, obfuscated code often needs *instrumentation* (Frida, ptrace/gdbserver, LLDB).

---

### Dynamic Instrumentation (Frida ≥ 16)

Frida’s 16-series brought several Android-specific improvements that help when the target uses modern Clang/LLD optimisations:

* `thumb-relocator` can now *hook tiny ARM/Thumb functions* generated by LLD’s aggressive alignment (`--icf=all`).
* Enumerating and rebinding *ELF import slots* works on Android, enabling per-module `dlopen()`/`dlsym()` patching when inline hooks are rejected.
* Java hooking was fixed for the new **ART quick-entrypoint** used when apps are compiled with `--enable-optimizations` on Android 14.

Example: enumerating all functions registered through `RegisterNatives` and dumping their addresses at runtime:
```javascript
Java.perform(function () {
var Runtime = Java.use('java.lang.Runtime');
var register = Module.findExportByName(null, 'RegisterNatives');
Interceptor.attach(register, {
onEnter(args) {
var envPtr  = args[0];
var clazz   = Java.cast(args[1], Java.use('java.lang.Class'));
var methods = args[2];
var count   = args[3].toInt32();
console.log('[+] RegisterNatives on ' + clazz.getName() + ' -> ' + count + ' methods');
// iterate & dump (JNI nativeMethod struct: name, sig, fnPtr)
}
});
});
```
Frida itaenda moja kwa moja kwenye vifaa vinavyounga mkono PAC/BTI (Pixel 8/Android 14+) mradi tu unatumia frida-server 16.2 au baadaye – toleo za mapema zilishindwa kupata padding kwa inline hooks.

### Telemetri ya JNI ndani ya mchakato kupitia .so iliyopakiwa kabla (SoTap)

Wakati instrumentation yenye sifa kamili ni ya ziada au imezuiwa, bado unaweza kupata uonekano wa ngazi ya native kwa kupakia kabla logger ndogo ndani ya mchakato lengwa. SoTap ni maktaba nyepesi ya Android native (.so) inayorekodi tabia za runtime za maktaba nyingine za JNI (.so) ndani ya mchakato moja la app (no root required).

Sifa kuu:
- Inaanzishwa mapema na inafuatilia mwingiliano wa JNI/native ndani ya mchakato unaoipakia.
- Inahifadhi logi kwa kutumia njia kadhaa zinazoweza kuandikwa na inarudi kwa Logcat kwa upole wakati uhifadhi umepunguzwa.
- Inayoweza kubadilishwa kwa chanzo: hariri sotap.c ili kupanua/kubadilisha kinachorekodiwa na ujenge tena kwa kila ABI.

Usanidi (repack the APK):
1) Weka build sahihi ya ABI ndani ya APK ili loader iweze kutatua libsotap.so:
- lib/arm64-v8a/libsotap.so (for arm64)
- lib/armeabi-v7a/libsotap.so (for arm32)
2) Hakikisha SoTap inapakiwa kabla ya maktaba nyingine za JNI. Weka wito mapema (km., Application subclass static initializer au onCreate) ili logger ianzishwe kwanza. Mfano wa snippet ya Smali:
```smali
const-string v0, "sotap"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
```
3) Jenga upya/sign/install, endesha app, kisha kusanya logi.

Log paths (checked in order):
```
/data/user/0/%s/files/sotap.log
/data/data/%s/files/sotap.log
/sdcard/Android/data/%s/files/sotap.log
/sdcard/Download/sotap-%s.log
# If all fail: fallback to Logcat only
```
Notes and troubleshooting:
- Ulinganifu wa ABI ni lazima. Kosa la mismatch litasababisha UnsatisfiedLinkError na logger haitapakia.
- Vizuizi vya uhifadhi ni kawaida kwenye Android za kisasa; ikiwa uandishi wa faili unashindwa, SoTap bado itaonyesha kupitia Logcat.
- Tabia/uvuvi wa taarifa (behavior/verbosity) imetengenezwa ili kurekebishwa; jenga tena kutoka source baada ya kuhariri sotap.c.

Njia hii ni muhimu kwa malware triage na JNI debugging ambapo kuangalia mtiririko wa antcall za native tangu kuanzishwa kwa process ni muhimu lakini root/kuweka hooks za mfumo mzima hazipatikani.

---

### Toleo la hivi karibuni la udhaifu zinazostahili kutafutwa ndani ya APKs

| Year | CVE | Affected library | Notes |
|------|-----|------------------|-------|
|2023|CVE-2023-4863|`libwebp` ≤ 1.3.1|Heap buffer overflow reachable from native code that decodes WebP images. Several Android apps bundle vulnerable versions. When you see a `libwebp.so` inside an APK, check its version and attempt exploitation or patching.| |
|2024|Multiple|OpenSSL 3.x series|Several memory-safety and padding-oracle issues. Many Flutter & ReactNative bundles ship their own `libcrypto.so`.|

Unapoona faili za *third-party* `.so` ndani ya APK, daima linganisha hash yao dhidi ya advisories za upstream. SCA (Software Composition Analysis) haijaenea sana kwenye mobile, hivyo builds zilizozee na zilizo na udhaifu ni nyingi.

---

### Mwelekeo ya Anti-Reversing & Hardening (Android 13-15)

* **Pointer Authentication (PAC) & Branch Target Identification (BTI):** Android 14 inawasha PAC/BTI katika system libraries kwenye silicon inayounga mkono ARMv8.3+. Decompilers sasa zinaonyesha pseudo-instructions zinazohusiana na PAC; kwa dynamic analysis Frida huingiza trampolines *baada ya* kuondoa PAC, lakini trampolines zako za custom zinapaswa kuita `pacda`/`autibsp` pale inapohitajika.
* **MTE & Scudo hardened allocator:** memory-tagging ni opt-in lakini apps nyingi zinazoelewa Play-Integrity hujenga kwa `-fsanitize=memtag`; tumia `setprop arm64.memtag.dump 1` pamoja na `adb shell am start ...` ili kukamata tag faults.
* **LLVM Obfuscator (opaque predicates, control-flow flattening):** packers za kibiashara (mfano, Bangcle, SecNeo) mara nyingi zinazuia natively code, sio Java pekee; tarajia control-flow bandia na blob za strings zilizofumwa katika `.rodata`.

---

### Resources

- **Learning ARM Assembly:** [Azeria Labs – ARM Assembly Basics](https://azeria-labs.com/writing-arm-assembly-part-1/)
- **JNI & NDK Documentation:** [Oracle JNI Spec](https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/jniTOC.html) · [Android JNI Tips](https://developer.android.com/training/articles/perf-jni) · [NDK Guides](https://developer.android.com/ndk/guides/)
- **Debugging Native Libraries:** [Debug Android Native Libraries Using JEB Decompiler](https://medium.com/@shubhamsonani/how-to-debug-android-native-libraries-using-jeb-decompiler-eec681a22cf3)

### References

- Frida 16.x change-log (Android hooking, tiny-function relocation) – [frida.re/news](https://frida.re/news/)
- NVD advisory for `libwebp` overflow CVE-2023-4863 – [nvd.nist.gov](https://nvd.nist.gov/vuln/detail/CVE-2023-4863)
- SoTap: Lightweight in-app JNI (.so) behavior logger – [github.com/RezaArbabBot/SoTap](https://github.com/RezaArbabBot/SoTap)
- SoTap Releases – [github.com/RezaArbabBot/SoTap/releases](https://github.com/RezaArbabBot/SoTap/releases)
- How to work with SoTap? – [t.me/ForYouTillEnd/13](https://t.me/ForYouTillEnd/13)

{{#include ../../banners/hacktricks-training.md}}
