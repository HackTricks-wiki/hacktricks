# Αντίστροφη ανάλυση native βιβλιοθηκών

{{#include ../../banners/hacktricks-training.md}}


**Για περισσότερες πληροφορίες δείτε:** [**https://maddiestone.github.io/AndroidAppRE/reversing_native_libs.html**](https://maddiestone.github.io/AndroidAppRE/reversing_native_libs.html)

Οι Android εφαρμογές μπορούν να χρησιμοποιούν native βιβλιοθήκες, συνήθως γραμμένες σε C ή C++, για εργασίες κρίσιμες ως προς την απόδοση. Οι δημιουργοί malware επίσης κακοποιούν αυτές τις βιβλιοθήκες επειδή τα ELF shared objects είναι ακόμα πιο δύσκολα στην αποσύνθεση από το DEX/OAT byte-code.
Αυτή η σελίδα επικεντρώνεται σε *πρακτικά* workflows και *πρόσφατες* βελτιώσεις εργαλείων (2023-2025) που κάνουν την αντίστροφη ανάλυση των Android `.so` αρχείων πιο εύκολη.

---

### Γρήγορο workflow διαλογής για ένα πρόσφατα εξαγμένο `libfoo.so`

1. **Εξαγωγή της βιβλιοθήκης**
```bash
# From an installed application
adb shell "run-as <pkg> cat lib/arm64-v8a/libfoo.so" > libfoo.so
# Or from the APK (zip)
unzip -j target.apk "lib/*/libfoo.so" -d extracted_libs/
```
2. **Καθορισμός αρχιτεκτονικής & προστασιών**
```bash
file libfoo.so        # arm64 or arm32 / x86
readelf -h libfoo.so  # OS ABI, PIE, NX, RELRO, etc.
checksec --file libfoo.so  # (peda/pwntools)
```
3. **Καταγραφή εξαγόμενων συμβόλων & δεσμών JNI**
```bash
readelf -s libfoo.so | grep ' Java_'     # dynamic-linked JNI
strings libfoo.so   | grep -i "RegisterNatives" -n   # static-registered JNI
```
4. **Φόρτωση σε decompiler** (Ghidra ≥ 11.0, IDA Pro, Binary Ninja, Hopper or Cutter/Rizin) και εκτέλεση αυτόματης ανάλυσης.
Οι νεότερες εκδόσεις Ghidra εισήγαγαν έναν AArch64 decompiler που αναγνωρίζει PAC/BTI stubs και MTE tags, βελτιώνοντας σημαντικά την ανάλυση βιβλιοθηκών που χτίστηκαν με το Android 14 NDK.
5. **Αποφασίστε για static vs dynamic reversing:** ο stripped, obfuscated κώδικας συχνά χρειάζεται *instrumentation* (Frida, ptrace/gdbserver, LLDB).

---

### Δυναμική instrumentation (Frida ≥ 16)

Η σειρά 16 του Frida έφερε αρκετές βελτιώσεις ειδικά για Android που βοηθούν όταν ο στόχος χρησιμοποιεί σύγχρονες βελτιστοποιήσεις Clang/LLD:

* `thumb-relocator` πλέον μπορεί να hook tiny ARM/Thumb functions που παράγονται από την επιθετική στοίχιση του LLD (`--icf=all`).
* Η καταγραφή και επαναδέσμευση των *ELF import slots* λειτουργεί σε Android, επιτρέποντας per-module `dlopen()`/`dlsym()` patching όταν τα inline hooks απορρίπτονται.
* Το Java hooking διορθώθηκε για το νέο **ART quick-entrypoint** που χρησιμοποιείται όταν οι εφαρμογές μεταγλωττίζονται με `--enable-optimizations` στο Android 14.

Παράδειγμα: καταγραφή όλων των functions που εγγράφονται μέσω `RegisterNatives` και dump των διευθύνσεών τους κατά το runtime:
```javascript
Java.perform(function () {
var Runtime = Java.use('java.lang.Runtime');
var register = Module.findExportByName(null, 'RegisterNatives');
Interceptor.attach(register, {
onEnter(args) {
var envPtr  = args[0];
var clazz   = Java.cast(args[1], Java.use('java.lang.Class'));
var methods = args[2];
var count   = args[3].toInt32();
console.log('[+] RegisterNatives on ' + clazz.getName() + ' -> ' + count + ' methods');
// iterate & dump (JNI nativeMethod struct: name, sig, fnPtr)
}
});
});
```
Frida θα λειτουργήσει χωρίς επιπλέον ρυθμίσεις σε συσκευές με ενεργοποιημένο PAC/BTI (Pixel 8/Android 14+) αρκεί να χρησιμοποιήσετε frida-server 16.2 ή νεότερη — οι παλαιότερες εκδόσεις απέτυχαν να εντοπίσουν padding για inline hooks.

### Τοπική τηλεμετρία JNI σε επίπεδο διεργασίας μέσω προφορτωμένης .so (SoTap)

Όταν η πλήρης instrumentation με όλα τα χαρακτηριστικά είναι υπερβολική ή μπλοκάρεται, μπορείτε παρόλα αυτά να αποκτήσετε ορατότητα σε επίπεδο native προφορτώνοντας έναν μικρό logger μέσα στη στοχευόμενη διεργασία. Το SoTap είναι μια ελαφριά Android native (.so) βιβλιοθήκη που καταγράφει τη συμπεριφορά κατά το runtime άλλων JNI (.so) βιβλιοθηκών μέσα στην ίδια διεργασία εφαρμογής (no root required).

Βασικά χαρακτηριστικά:
- Εκκινεί νωρίς και παρακολουθεί τις αλληλεπιδράσεις JNI/native μέσα στη διεργασία που το φορτώνει.
- Αποθηκεύει τα logs σε πολλαπλές εγγράψιμες τοποθεσίες με ομαλή εναλλαγή στο Logcat όταν ο αποθηκευτικός χώρος είναι περιορισμένος.
- Προσαρμόσιμο σε επίπεδο πηγαίου κώδικα: επεξεργαστείτε το sotap.c για να επεκτείνετε/προσαρμόσετε τι καταγράφεται και ανακατασκευάστε ανά ABI.

Ρύθμιση (repack the APK):
1) Drop the proper ABI build into the APK so the loader can resolve libsotap.so:
- lib/arm64-v8a/libsotap.so (for arm64)
- lib/armeabi-v7a/libsotap.so (for arm32)
2) Ensure SoTap loads before other JNI libs. Inject a call early (e.g., Application subclass static initializer or onCreate) so the logger is initialized first. Smali snippet example:
```smali
const-string v0, "sotap"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
```
3) Rebuild/sign/install, run the app, then collect logs.

Διαδρομές καταγραφών (ελέγχονται με αυτή τη σειρά):
```
/data/user/0/%s/files/sotap.log
/data/data/%s/files/sotap.log
/sdcard/Android/data/%s/files/sotap.log
/sdcard/Download/sotap-%s.log
# If all fail: fallback to Logcat only
```
Σημειώσεις και αντιμετώπιση προβλημάτων:
- Η ευθυγράμμιση του ABI είναι υποχρεωτική. Μη ταύτιση θα προκαλέσει UnsatisfiedLinkError και ο logger δεν θα φορτωθεί.
- Οι περιορισμοί αποθήκευσης είναι συνηθισμένοι σε σύγχρονα Android· αν οι εγγραφές αρχείων αποτύχουν, το SoTap θα εξακολουθήσει να εκδίδει μέσω Logcat.
- Η συμπεριφορά/λεπτολογησία προορίζεται να προσαρμοστεί· αναδημιουργήστε από τον πηγαίο κώδικα μετά την επεξεργασία του sotap.c.

Αυτή η προσέγγιση είναι χρήσιμη για malware triage και JNI debugging όπου η παρακολούθηση των ροών κλήσεων native από την εκκίνηση της διεργασίας είναι κρίσιμη αλλά δεν υπάρχουν διαθέσιμα root/system-wide hooks.

---

### Πρόσφατες ευπάθειες που αξίζει να αναζητήσετε σε APKs

| Έτος | CVE | Επηρεασμένη βιβλιοθήκη | Σημειώσεις |
|------|-----|------------------|-------|
|2023|CVE-2023-4863|`libwebp` ≤ 1.3.1|Heap buffer overflow reachable from native code that decodes WebP images. Several Android apps bundle vulnerable versions. When you see a `libwebp.so` inside an APK, check its version and attempt exploitation or patching.| |
|2024|Multiple|OpenSSL 3.x series|Several memory-safety and padding-oracle issues. Many Flutter & ReactNative bundles ship their own `libcrypto.so`.|

Όταν εντοπίσετε *third-party* `.so` αρχεία μέσα σε ένα APK, πάντα αντιπαραβάλετε το hash τους με upstream advisories. SCA (Software Composition Analysis) είναι ασυνήθιστη στο mobile, οπότε παλιές ευάλωτες builds είναι διαδεδομένες.

---

### Anti-Reversing & Hardening trends (Android 13-15)

* **Pointer Authentication (PAC) & Branch Target Identification (BTI):** Android 14 ενεργοποιεί PAC/BTI στις system libraries σε υποστηριζόμενο ARMv8.3+ silicon. Οι decompilers πλέον εμφανίζουν PAC‐σχετικές pseudo-instructions· για dynamic analysis το Frida εγχέει trampolines *after* stripping PAC, αλλά τα custom trampolines σας θα πρέπει να καλούν `pacda`/`autibsp` όπου χρειάζεται.
* **MTE & Scudo hardened allocator:** Το memory-tagging είναι opt-in αλλά πολλές Play-Integrity aware apps κάνουν build με `-fsanitize=memtag`; χρησιμοποιήστε `setprop arm64.memtag.dump 1` μαζί με `adb shell am start ...` για να καταγράψετε tag faults.
* **LLVM Obfuscator (opaque predicates, control-flow flattening):** commercial packers (e.g., Bangcle, SecNeo) increasingly protect *native* code, not only Java; expect bogus control-flow and encrypted string blobs in `.rodata`.

---

### Resources

- **Learning ARM Assembly:** [Azeria Labs – ARM Assembly Basics](https://azeria-labs.com/writing-arm-assembly-part-1/)
- **JNI & NDK Documentation:** [Oracle JNI Spec](https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/jniTOC.html) · [Android JNI Tips](https://developer.android.com/training/articles/perf-jni) · [NDK Guides](https://developer.android.com/ndk/guides/)
- **Debugging Native Libraries:** [Debug Android Native Libraries Using JEB Decompiler](https://medium.com/@shubhamsonani/how-to-debug-android-native-libraries-using-jeb-decompiler-eec681a22cf3)

### References

- Frida 16.x change-log (Android hooking, tiny-function relocation) – [frida.re/news](https://frida.re/news/)
- NVD advisory for `libwebp` overflow CVE-2023-4863 – [nvd.nist.gov](https://nvd.nist.gov/vuln/detail/CVE-2023-4863)
- SoTap: Lightweight in-app JNI (.so) behavior logger – [github.com/RezaArbabBot/SoTap](https://github.com/RezaArbabBot/SoTap)
- SoTap Releases – [github.com/RezaArbabBot/SoTap/releases](https://github.com/RezaArbabBot/SoTap/releases)
- How to work with SoTap? – [t.me/ForYouTillEnd/13](https://t.me/ForYouTillEnd/13)

{{#include ../../banners/hacktricks-training.md}}
