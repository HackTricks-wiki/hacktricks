# Android Anti-Instrumentation & SSL Pinning Bypass (Frida/Objection)

{{#include ../../banners/hacktricks-training.md}}

Bu sayfa, instrumentation algılayan/root‑engelleyen veya TLS pinning uygulayan Android uygulamalarına karşı dinamik analiz yeteneğini geri kazanmak için pratik bir iş akışı sunar. Hızlı triyaj, yaygın tespitler ve mümkün olduğunda repacking yapmadan atlatmak için copy‑pasteable hooks/tactics üzerine odaklanır.

## Detection Surface (what apps check)

- Root kontrolleri: su binary, Magisk paths, getprop values, common root packages
- Frida/debugger kontrolleri (Java): Debug.isDebuggerConnected(), ActivityManager.getRunningAppProcesses(), getRunningServices(), scanning /proc, classpath, loaded libs
- Native anti‑debug: ptrace(), syscalls, anti‑attach, breakpoints, inline hooks
- Erken init kontrolleri: Application.onCreate() veya process start hooks — instrumentation varsa crash olur
- TLS pinning: custom TrustManager/HostnameVerifier, OkHttp CertificatePinner, Conscrypt pinning, native pins

## Step 1 — Quick win: hide root with Magisk DenyList

- Enable Zygisk in Magisk
- Enable DenyList, add the target package
- Reboot and retest

Birçok uygulama sadece bariz göstergelere (su/Magisk paths/getprop) bakar. DenyList sıklıkla basit kontrolleri nötralize eder.

References:
- Magisk (Zygisk & DenyList): https://github.com/topjohnwu/Magisk

### Play Integrity / Zygisk detections (post‑SafetyNet)

Yeni banka/kimlik uygulamaları runtime kontrollerini Google Play Integrity (SafetyNet yerine) ile ilişkilendirir ve Zygisk'in kendisi mevcutsa crash olabilir. Hızlı triyaj ipuçları:

- Temporarily disable Zygisk (toggle off + reboot) and retry; bazı uygulamalar Zygote injection yüklendiği anda crash olur.
- If attestation blocks login, patch Google Play Services with PlayIntegrityFix/Fork + TrickyStore or use ReZygisk/Zygisk‑Next only when testing. Hedefi DenyList'te tut ve props leak eden LSPosed modüllerinden kaçın.
- For one‑off runs, use KernelSU/APatch (no Zygote injection) to stay under Zygisk heuristics, then attach Frida.

## Step 2 — 30‑second Frida Codeshare tests

Derinlemesine dalmadan önce yaygın drop‑in script'leri dene:

- anti-root-bypass.js
- anti-frida-detection.js
- hide_frida_gum.js

Example:
```bash
frida -U -f com.example.app -l anti-frida-detection.js
```
Bunlar tipik olarak Java root/debug kontrollerini, process/service taramalarını ve native ptrace()'yi stub'lar. Hafif korumalı uygulamalarda yararlıdır; sertleştirilmiş hedefler için özel hook'lar gerekebilir.

- Codeshare: https://codeshare.frida.re/

## Medusa (Frida framework) ile otomatikleştirme

Medusa, SSL unpinning, root/emulator detection bypass, HTTP comms logging, crypto key interception ve daha fazlası için 90+ hazır modül sağlar.
```bash
git clone https://github.com/Ch0pin/medusa
cd medusa
pip install -r requirements.txt
python medusa.py

# Example interactive workflow
show categories
use http_communications/multiple_unpinner
use root_detection/universal_root_detection_bypass
run com.target.app
```
İpucu: Medusa, custom hooks yazmadan önce hızlı kazanımlar için harikadır. Ayrıca cherry-pick ile modules seçip bunları kendi scripts'inizle birleştirebilirsiniz.

## Adım 3 — init-time detectors'ı attaching late ile atlatın

Birçok tespit yalnızca process spawn/onCreate() sırasında çalışır. Spawn‑time injection (-f) veya gadgets yakalanır; UI yüklendikten sonra attaching yapmak bu kontrollerin arasından sıyrılabilir.
```bash
# Launch the app normally (launcher/adb), wait for UI, then attach
frida -U -n com.example.app
# Or with Objection to attach to running process
aobjection --gadget com.example.app explore  # if using gadget
```
Eğer bu işe yararsa, oturumu kararlı tutun ve map ve stub kontrollerine ilerleyin.

## Adım 4 — Jadx ile tespit mantığını eşleyin ve string araması yapın

Jadx'te statik triage anahtar kelimeleri:
- "frida", "gum", "root", "magisk", "ptrace", "su", "getprop", "debugger"

Tipik Java kalıpları:
```java
public boolean isFridaDetected() {
return getRunningServices().contains("frida");
}
```
İncelenmesi/hooklanması gereken yaygın API'ler:
- android.os.Debug.isDebuggerConnected
- android.app.ActivityManager.getRunningAppProcesses / getRunningServices
- java.lang.System.loadLibrary / System.load (native köprüsü)
- java.lang.Runtime.exec / ProcessBuilder (komutları denetleme)
- android.os.SystemProperties.get (root/emülatör heuristikleri)

## Adım 5 — Runtime stubbing with Frida (Java)

Yeniden paketleme yapmadan güvenli değerler döndürmek için özel guard'ları override edin:
```js
Java.perform(() => {
const Checks = Java.use('com.example.security.Checks');
Checks.isFridaDetected.implementation = function () { return false; };

// Neutralize debugger checks
const Debug = Java.use('android.os.Debug');
Debug.isDebuggerConnected.implementation = function () { return false; };

// Example: kill ActivityManager scans
const AM = Java.use('android.app.ActivityManager');
AM.getRunningAppProcesses.implementation = function () { return java.util.Collections.emptyList(); };
});
```
Triaging early crashes? Öldüğünden hemen önce classes'ları dump edin; muhtemel detection namespaces'i tespit etmek için:
```js
Java.perform(() => {
Java.enumerateLoadedClasses({
onMatch: n => console.log(n),
onComplete: () => console.log('Done')
});
});
```
// Quick root detection stub example (adapt to target package/class names)
Java.perform(() => {
try {
const RootChecker = Java.use('com.target.security.RootCheck');
RootChecker.isDeviceRooted.implementation = function () { return false; };
} catch (e) {}
});

Çalışma akışını doğrulamak için şüpheli yöntemleri loglayın ve etkisiz hale getirin:
```js
Java.perform(() => {
const Det = Java.use('com.example.security.DetectionManager');
Det.checkFrida.implementation = function () {
console.log('checkFrida() called');
return false;
};
});
```
## Emülatör/VM tespitini atlatma (Java stubs)

Yaygın heuristikler: Build.FINGERPRINT/MODEL/MANUFACTURER/HARDWARE alanlarının generic/goldfish/ranchu/sdk içermesi; QEMU artifaktları (ör. /dev/qemu_pipe, /dev/socket/qemud); varsayılan MAC 02:00:00:00:00:00; 10.0.2.x NAT; telephony/sensors eksik.

Build alanlarının hızlı spoof'lanması:
```js
Java.perform(function(){
var Build = Java.use('android.os.Build');
Build.MODEL.value = 'Pixel 7 Pro';
Build.MANUFACTURER.value = 'Google';
Build.BRAND.value = 'google';
Build.FINGERPRINT.value = 'google/panther/panther:14/UP1A.231105.003/1234567:user/release-keys';
});
```
Dosya varlığı kontrolleri ve tanımlayıcılar için (TelephonyManager.getDeviceId/SubscriberId, WifiInfo.getMacAddress, SensorManager.getSensorList) gerçekçi değerler döndürecek stub'larla tamamlayın.

## SSL pinning bypass quick hook (Java)

Özel TrustManagers'ı nötralize edin ve izin verici SSL contexts'i zorlayın:
```js
Java.perform(function(){
var X509TrustManager = Java.use('javax.net.ssl.X509TrustManager');
var SSLContext = Java.use('javax.net.ssl.SSLContext');

// No-op validations
X509TrustManager.checkClientTrusted.implementation = function(){ };
X509TrustManager.checkServerTrusted.implementation = function(){ };

// Force permissive TrustManagers
var TrustManagers = [ X509TrustManager.$new() ];
var SSLContextInit = SSLContext.init.overload('[Ljavax.net.ssl.KeyManager;','[Ljavax.net.ssl.TrustManager;','java.security.SecureRandom');
SSLContextInit.implementation = function(km, tm, sr){
return SSLContextInit.call(this, km, TrustManagers, sr);
};
});
```
Notlar
- OkHttp için genişletin: gerekli olduğunda okhttp3.CertificatePinner ve HostnameVerifier'ı hook'layın, veya CodeShare'den evrensel bir unpinning scripti kullanın.
- Çalıştırma örneği: `frida -U -f com.target.app -l ssl-bypass.js --no-pause`

### OkHttp4 / gRPC / Cronet pinning (2024+)

Modern yığınlar daha yeni API'lerin içinde pin yapar (OkHttp4+, gRPC over Cronet/BoringSSL). Temel SSLContext hook takıldığında bu hooks'ları ekleyin:
```js
Java.perform(() => {
try {
const Pinner = Java.use('okhttp3.CertificatePinner');
Pinner.check.overload('java.lang.String', 'java.util.List').implementation = function(){};
Pinner.check$okhttp.implementation = function(){};
} catch (e) {}

try {
const CronetB = Java.use('org.chromium.net.CronetEngine$Builder');
CronetB.enablePublicKeyPinningBypassForLocalTrustAnchors.overload('boolean').implementation = function(){ return this; };
CronetB.setPublicKeyPins.overload('java.lang.String', 'java.util.Set', 'boolean').implementation = function(){ return this; };
} catch (e) {}
});
```
TLS hala başarısız oluyorsa, native seviyesine inip Cronet/gRPC tarafından kullanılan BoringSSL doğrulama giriş noktalarını yama:
```js
const customVerify = Module.findExportByName(null, 'SSL_CTX_set_custom_verify');
if (customVerify) {
Interceptor.attach(customVerify, {
onEnter(args){
// arg0 = SSL_CTX*, arg1 = mode, arg2 = callback
args[1] = ptr(0); // SSL_VERIFY_NONE
args[2] = NULL;  // disable callback
}
});
}
```
## Adım 6 — Java hooks başarısız olduğunda JNI/native izini takip edin

JNI entry points'lerini izleyerek native loaders ve detection init'i bulun:
```bash
frida-trace -n com.example.app -i "JNI_OnLoad"
```
Paketlenmiş .so dosyalarının hızlı native triage'i:
```bash
# List exported symbols & JNI
nm -D libfoo.so | head
objdump -T libfoo.so | grep Java_
strings -n 6 libfoo.so | egrep -i 'frida|ptrace|gum|magisk|su|root'
```
Etkileşimli/native reversing:
- Ghidra: https://ghidra-sre.org/
- r2frida: https://github.com/nowsecure/r2frida

Örnek: libc içindeki basit anti‑debug'i aşmak için ptrace'i devre dışı bırakma:
```js
const ptrace = Module.findExportByName(null, 'ptrace');
if (ptrace) {
Interceptor.replace(ptrace, new NativeCallback(function () {
return -1; // pretend failure
}, 'int', ['int', 'int', 'pointer', 'pointer']));
}
```
Ayrıca bakınız:
{{#ref}}
reversing-native-libraries.md
{{#endref}}

## Adım 7 — Objection patching (embed gadget / strip basics)

Eğer runtime hooks yerine repacking'i tercih ediyorsanız, deneyin:
```bash
objection patchapk --source app.apk
```
Notlar:
- apktool gerektirir; derleme sorunlarını önlemek için resmi kılavuzdan güncel bir sürüm kullanın: https://apktool.org/docs/install
- Gadget injection, root olmadan instrumentation sağlar; ancak daha güçlü init‑time kontrolleri tarafından yine de tespit edilebilir.

Opsiyonel olarak, Zygisk ortamlarında daha güçlü root gizleme için LSPosed modülleri ve Shamiko ekleyin ve alt süreçleri kapsayacak şekilde DenyList'i düzenleyin.

For a complete workflow including script-mode Gadget configuration and bundling your Frida 17+ agent into the APK, see:

[Frida Tutorial — Self-contained agent + Gadget embedding](frida-tutorial/README.md)

Referanslar:
- Objection: https://github.com/sensepost/objection

## Adım 8 — Yedek: Ağ görünürlüğü için TLS pinning'i yama

Eğer instrumentation engellenmişse, pinning'i statik olarak kaldırarak trafiği hâlâ inceleyebilirsiniz:
```bash
apk-mitm app.apk
# Then install the patched APK and proxy via Burp/mitmproxy
```
- Araç: https://github.com/shroudedcode/apk-mitm
- Ağ yapılandırması CA‑trust hileleri (ve Android 7+ kullanıcı CA trust) için bakınız:

{{#ref}}
make-apk-accept-ca-certificate.md
{{#endref}}

{{#ref}}
install-burp-certificate.md
{{#endref}}

## Kullanışlı komut kısa rehberi
```bash
# List processes and attach
frida-ps -Uai
frida -U -n com.example.app

# Spawn with a script (may trigger detectors)
frida -U -f com.example.app -l anti-frida-detection.js

# Trace native init
frida-trace -n com.example.app -i "JNI_OnLoad"

# Objection runtime
objection --gadget com.example.app explore

# Static TLS pinning removal
apk-mitm app.apk
```
## Evrensel proxy zorlaması + TLS unpinning (HTTP Toolkit Frida hooks)

Modern uygulamalar sıklıkla sistem proxy'lerini görmezden gelir ve pinning'i birden fazla katmanda uygular (Java + native), bu da kullanıcı/sistem CA'ları yüklü olsa bile trafiği yakalamayı zorlaştırır. Pratik bir yaklaşım, hazır Frida hooks ile evrensel TLS unpinning'i proxy forcing ile birleştirip trafiğin tamamını mitmproxy/Burp üzerinden yönlendirmektir.

Workflow
- mitmproxy'yi hostunuzda (veya Burp) çalıştırın. Cihazın host IP/port'una erişebildiğinden emin olun.
- HTTP Toolkit’s consolidated Frida hooks'u, ortak yığınlarda (OkHttp/OkHttp3, HttpsURLConnection, Conscrypt, WebView, vb.) hem TLS unpinning yapmak hem de proxy kullanımını zorlamak için yükleyin. Bu, CertificatePinner/TrustManager kontrollerini atlar ve proxy selector'larını override eder; böylece uygulama açıkça proxy'leri devre dışı bırakmış olsa bile trafik her zaman sizin proxy'niz üzerinden gönderilir.
- Hedef uygulamayı Frida ve hook script ile başlatın ve mitmproxy üzerinde istekleri yakalayın.

Example
```bash
# Device connected via ADB or over network (-U)
# See the repo for the exact script names & options
frida -U -f com.vendor.app \
-l ./android-unpinning-with-proxy.js \
--no-pause

# mitmproxy listening locally
mitmproxy -p 8080
```
Notlar
- Mümkünse sistem genelinde bir proxy ile birleştirin: `adb shell settings put global http_proxy <host>:<port>`. The Frida hooks will enforce proxy use even when apps bypass global settings.
- Bu teknik, pinning/proxy kaçınmasının yaygın olduğu mobile-to-IoT onboarding akışlarını MITM yapmanız gerektiğinde idealdir.
- Hooks: https://github.com/httptoolkit/frida-interception-and-unpinning

## Referanslar

- [Reversing Android Apps: Bypassing Detection Like a Pro](https://www.kayssel.com/newsletter/issue-12/)
- [Frida Codeshare](https://codeshare.frida.re/)
- [Objection](https://github.com/sensepost/objection)
- [apk-mitm](https://github.com/shroudedcode/apk-mitm)
- [Jadx](https://github.com/skylot/jadx)
- [Ghidra](https://ghidra-sre.org/)
- [r2frida](https://github.com/nowsecure/r2frida)
- [Apktool install guide](https://apktool.org/docs/install)
- [Magisk](https://github.com/topjohnwu/Magisk)
- [Medusa (Android Frida framework)](https://github.com/Ch0pin/medusa)
- [Build a Repeatable Android Bug Bounty Lab: Emulator vs Magisk, Burp, Frida, and Medusa](https://www.yeswehack.com/learn-bug-bounty/android-lab-mobile-hacking-tools)
- [Frida OkHttp4 SSL pinning bypass script](https://github.com/Zero3141/Frida-OkHttp-Bypass)
- [XDA guide to strong Play Integrity bypass (2025)](https://xdaforums.com/t/updated-11-17-2025-guide-get-strong-integrity-fix-banking-apps-revolut-google-wallet-android-16-working.4753805/)

{{#include ../../banners/hacktricks-training.md}}
