# Android Anti-Instrumentation & SSL Pinning Bypass (Frida/Objection)

{{#include ../../banners/hacktricks-training.md}}

Bu sayfa, Android uygulamalarının enstrümantasyonu tespit eden/kök engelleyen veya TLS pinning uygulayan dinamik analizini yeniden kazanmak için pratik bir iş akışı sağlar. Hızlı ön değerlendirme, yaygın tespitler ve mümkün olduğunda yeniden paketleme yapmadan bunları aşmak için kopyala-yapıştır yapılabilir kancalar/taktikler üzerine odaklanır.

## Tespit Yüzeyi (uygulamaların kontrol ettiği şeyler)

- Kök kontrolleri: su ikili dosyası, Magisk yolları, getprop değerleri, yaygın kök paketleri
- Frida/hata ayıklayıcı kontrolleri (Java): Debug.isDebuggerConnected(), ActivityManager.getRunningAppProcesses(), getRunningServices(), /proc taraması, classpath, yüklenen kütüphaneler
- Yerel anti-hata ayıklama: ptrace(), syscalls, anti-attach, kesme noktaları, inline kancalar
- Erken başlatma kontrolleri: Application.onCreate() veya enstrümantasyon mevcutsa çökmesine neden olan işlem başlatma kancaları
- TLS pinning: özel TrustManager/HostnameVerifier, OkHttp CertificatePinner, Conscrypt pinning, yerel pinler

## Adım 1 — Hızlı kazanım: Magisk DenyList ile kökü gizle

- Magisk'te Zygisk'i etkinleştir
- DenyList'i etkinleştir, hedef paketi ekle
- Yeniden başlat ve yeniden test et

Birçok uygulama yalnızca belirgin göstergeleri (su/Magisk yolları/getprop) arar. DenyList genellikle naif kontrolleri etkisiz hale getirir.

Referanslar:
- Magisk (Zygisk & DenyList): https://github.com/topjohnwu/Magisk

## Adım 2 — 30 saniyelik Frida Kod Paylaşımı testleri

Derinlemesine dalmadan önce yaygın drop-in betiklerini deneyin:

- anti-root-bypass.js
- anti-frida-detection.js
- hide_frida_gum.js

Örnek:
```bash
frida -U -f com.example.app -l anti-frida-detection.js
```
Bu genellikle Java root/debug kontrollerini, işlem/hizmet taramalarını ve yerel ptrace()'ı engeller. Hafif korumalı uygulamalarda faydalıdır; güçlendirilmiş hedefler özel kancalar gerektirebilir.

- Codeshare: https://codeshare.frida.re/

## Adım 3 — Geç bağlanarak init-zamanı dedektörlerini atlatma

Birçok tespit yalnızca işlem oluşturma/onCreate() sırasında çalışır. Oluşturma zamanı enjeksiyonu (-f) veya aletler yakalanır; UI yüklendikten sonra bağlanmak, geçiş yapabilir.
```bash
# Launch the app normally (launcher/adb), wait for UI, then attach
frida -U -n com.example.app
# Or with Objection to attach to running process
aobjection --gadget com.example.app explore  # if using gadget
```
Eğer bu işe yararsa, oturumu stabil tutun ve haritalama ile stub kontrollerine devam edin.

## Adım 4 — Jadx ve string avcılığı ile tespit mantığını haritalama

Jadx'teki statik triage anahtar kelimeleri:
- "frida", "gum", "root", "magisk", "ptrace", "su", "getprop", "debugger"

Tipik Java desenleri:
```java
public boolean isFridaDetected() {
return getRunningServices().contains("frida");
}
```
Yaygın API'ler gözden geçirmek/içine almak için:
- android.os.Debug.isDebuggerConnected
- android.app.ActivityManager.getRunningAppProcesses / getRunningServices
- java.lang.System.loadLibrary / System.load (native bridge)
- java.lang.Runtime.exec / ProcessBuilder (komutları sorgulama)
- android.os.SystemProperties.get (root/emülatör heuristikleri)

## Adım 5 — Frida ile Çalışma Zamanı Stub'lama (Java)

Özel korumaları geçersiz kılın ve yeniden paketleme olmadan güvenli değerler döndürün:
```js
Java.perform(() => {
const Checks = Java.use('com.example.security.Checks');
Checks.isFridaDetected.implementation = function () { return false; };

// Neutralize debugger checks
const Debug = Java.use('android.os.Debug');
Debug.isDebuggerConnected.implementation = function () { return false; };

// Example: kill ActivityManager scans
const AM = Java.use('android.app.ActivityManager');
AM.getRunningAppProcesses.implementation = function () { return java.util.Collections.emptyList(); };
});
```
Erken çöküşleri önceliklendirmek mi? Ölmeden hemen önce sınıfları dökerek muhtemel tespit ad alanlarını belirleyin:
```js
Java.perform(() => {
Java.enumerateLoadedClasses({
onMatch: n => console.log(n),
onComplete: () => console.log('Done')
});
});
```
Şüpheli yöntemleri kaydedin ve etkisiz hale getirin, böylece yürütme akışını doğrulayın:
```js
Java.perform(() => {
const Det = Java.use('com.example.security.DetectionManager');
Det.checkFrida.implementation = function () {
console.log('checkFrida() called');
return false;
};
});
```
## Adım 6 — Java hook'ları başarısız olduğunda JNI/yerli izini takip et

JNI giriş noktalarını izleyerek yerel yükleyicileri ve tespit başlatmalarını bul:
```bash
frida-trace -n com.example.app -i "JNI_OnLoad"
```
Paketlenmiş .so dosyalarının hızlı yerel ön değerlendirmesi:
```bash
# List exported symbols & JNI
nm -D libfoo.so | head
objdump -T libfoo.so | grep Java_
strings -n 6 libfoo.so | egrep -i 'frida|ptrace|gum|magisk|su|root'
```
Etkileşimli/yerli tersine mühendislik:
- Ghidra: https://ghidra-sre.org/
- r2frida: https://github.com/nowsecure/r2frida

Örnek: libc'deki basit anti-debug'u yenmek için ptrace'ı etkisiz hale getirin:
```js
const ptrace = Module.findExportByName(null, 'ptrace');
if (ptrace) {
Interceptor.replace(ptrace, new NativeCallback(function () {
return -1; // pretend failure
}, 'int', ['int', 'int', 'pointer', 'pointer']));
}
```
Ayrıca bakınız: {{#ref}}
reversing-native-libraries.md
{{#endref}}

## Adım 7 — Objection yamanması (gadget gömme / temel çıkarma)

Çalışma zamanı kancalarına yeniden paketlemeyi tercih ettiğinizde, deneyin:
```bash
objection patchapk --source app.apk
```
Notlar:
- apktool gerektirir; yapı sorunlarını önlemek için resmi kılavuzdan güncel bir sürüm aldığınızdan emin olun: https://apktool.org/docs/install
- Gadget enjeksiyonu, root olmadan enstrümantasyonu mümkün kılar ancak yine de daha güçlü init zamanı kontrolleri tarafından yakalanabilir.

Referanslar:
- Objection: https://github.com/sensepost/objection

## Adım 8 — Geri Dönüş: Ağ görünürlüğü için TLS pinning'i yamanlayın

Eğer enstrümantasyon engellenirse, pinning'i statik olarak kaldırarak trafiği hala inceleyebilirsiniz:
```bash
apk-mitm app.apk
# Then install the patched APK and proxy via Burp/mitmproxy
```
- Araç: https://github.com/shroudedcode/apk-mitm
- Ağ yapılandırma CA‑trust hileleri (ve Android 7+ kullanıcı CA güveni) için bkz:
{{#ref}}
make-apk-accept-ca-certificate.md
{{#endref}}
{{#ref}}
install-burp-certificate.md
{{#endref}}

## Kullanışlı komut kılavuzu
```bash
# List processes and attach
frida-ps -Uai
frida -U -n com.example.app

# Spawn with a script (may trigger detectors)
frida -U -f com.example.app -l anti-frida-detection.js

# Trace native init
frida-trace -n com.example.app -i "JNI_OnLoad"

# Objection runtime
objection --gadget com.example.app explore

# Static TLS pinning removal
apk-mitm app.apk
```
## İpuçları ve uyarılar

- Uygulamalar başlatıldığında çöküyorsa, başlatmadan ziyade geç bağlamayı tercih edin
- Bazı tespitler kritik akışlarda (örneğin, ödeme, kimlik doğrulama) yeniden çalışır — gezinme sırasında kancaları aktif tutun
- Statik ve dinamiği karıştırın: sınıfları kısaltmak için Jadx'te dize avı yapın; ardından yöntemleri bağlayarak çalışma zamanında doğrulayın
- Güçlendirilmiş uygulamalar paketleyiciler ve yerel TLS pinning kullanabilir — yerel kodu tersine çevirmeyi bekleyin

## Referanslar

- [Reversing Android Apps: Bypassing Detection Like a Pro](https://www.kayssel.com/newsletter/issue-12/)
- [Frida Codeshare](https://codeshare.frida.re/)
- [Objection](https://github.com/sensepost/objection)
- [apk-mitm](https://github.com/shroudedcode/apk-mitm)
- [Jadx](https://github.com/skylot/jadx)
- [Ghidra](https://ghidra-sre.org/)
- [r2frida](https://github.com/nowsecure/r2frida)
- [Apktool install guide](https://apktool.org/docs/install)
- [Magisk](https://github.com/topjohnwu/Magisk)

{{#include ../../banners/hacktricks-training.md}}
