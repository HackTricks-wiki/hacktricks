# Android Anti-Instrumentation & SSL Pinning Bypass (Frida/Objection)

{{#include ../../banners/hacktricks-training.md}}

Ukurasa huu unatoa mtiririko wa vitendo wa kurudisha uchambuzi wa dynamic dhidi ya apps za Android zinazoniona/block root‑instrumentation au zinazosukumiza TLS pinning. Unalenga triage ya haraka, detections za kawaida, na hooks/tactics zinazoweza kunakili‑weka (copy‑paste) ili kuzizusha bila ku‑repack inapowezekana.

## Detection Surface (what apps check)

- Root checks: su binary, Magisk paths, getprop values, common root packages
- Frida/debugger checks (Java): Debug.isDebuggerConnected(), ActivityManager.getRunningAppProcesses(), getRunningServices(), scanning /proc, classpath, loaded libs
- Native anti‑debug: ptrace(), syscalls, anti‑attach, breakpoints, inline hooks
- Early init checks: Application.onCreate() or process start hooks that crash if instrumentation is present
- TLS pinning: custom TrustManager/HostnameVerifier, OkHttp CertificatePinner, Conscrypt pinning, native pins

## Step 1 — Quick win: hide root with Magisk DenyList

- Enable Zygisk in Magisk
- Enable DenyList, add the target package
- Reboot and retest

Apps nyingi huangalia tu viashiria vinavyoonekana (su/Magisk paths/getprop). DenyList mara nyingi huutekeleza ukaguzi wa kimsingi.

Marejeo:
- Magisk (Zygisk & DenyList): https://github.com/topjohnwu/Magisk

### Play Integrity / Zygisk detections (post‑SafetyNet)

Apps za benki/taarifa mpya huunganisha ukaguzi wa runtime na Google Play Integrity (mbadala wa SafetyNet) na zinaweza pia kuzimwa ikiwa Zygisk yenyewe ipo. Vidokezo vya triage ya haraka:

- Zima kwa muda Zygisk (toggle off + reboot) na jaribu tena; baadhi ya apps huzimwa mara Zygote injection inapopakia.
- Ikiwa attestation inazuia login, patch Google Play Services na PlayIntegrityFix/Fork + TrickyStore au tumia ReZygisk/Zygisk‑Next tu wakati wa kujaribu. Weka target kwenye DenyList na epuka modules za LSPosed ambazo leak props.
- Kwa run moja‑tu, tumia KernelSU/APatch (hakuna Zygote injection) ili kukaa chini ya heuristics za Zygisk, kisha uambatane na Frida.

## Step 2 — 30‑second Frida Codeshare tests

Jaribu scripts za kawaida kabla ya kuchimba ndani:

- anti-root-bypass.js
- anti-frida-detection.js
- hide_frida_gum.js

Mfano:
```bash
frida -U -f com.example.app -l anti-frida-detection.js
```
Hizi kwa kawaida hufanya stub Java root/debug checks, process/service scans, na native ptrace(). Zinatumika kwenye apps zilizo na ulinzi mdogo; hardened targets zinaweza kuhitaji tailored hooks.

- Codeshare: https://codeshare.frida.re/

## Automatisha na Medusa (Frida framework)

Medusa inatoa zaidi ya 90 moduli zilizotengenezwa tayari kwa SSL unpinning, root/emulator detection bypass, HTTP comms logging, crypto key interception, na zaidi.
```bash
git clone https://github.com/Ch0pin/medusa
cd medusa
pip install -r requirements.txt
python medusa.py

# Example interactive workflow
show categories
use http_communications/multiple_unpinner
use root_detection/universal_root_detection_bypass
run com.target.app
```
Vidokezo: Medusa ni nzuri kwa ushindi wa haraka kabla ya kuandika hooks maalum. Unaweza pia cherry-pick modules na kuzichanganya na scripts zako mwenyewe.

## Hatua 3 — Bypass init-time detectors by attaching late

Uchunguzi mwingi unaendeshwa tu wakati wa process spawn/onCreate(). Spawn‑time injection (-f) au gadgets zinagunduliwa; kuambatisha baada UI inapopakia kunaweza kupita bila kugunduliwa.
```bash
# Launch the app normally (launcher/adb), wait for UI, then attach
frida -U -n com.example.app
# Or with Objection to attach to running process
aobjection --gadget com.example.app explore  # if using gadget
```
Ikiwa hili litafanya kazi, hakikisha kikao kinabaki thabiti na endelea na map na stub checks.

## Hatua 4 — Map detection logic via Jadx and string hunting

Maneno muhimu kwa triage ya statiki katika Jadx:
- "frida", "gum", "root", "magisk", "ptrace", "su", "getprop", "debugger"

Mifano ya kawaida ya Java:
```java
public boolean isFridaDetected() {
return getRunningServices().contains("frida");
}
```
API za kawaida za kukagua/hook:
- android.os.Debug.isDebuggerConnected
- android.app.ActivityManager.getRunningAppProcesses / getRunningServices
- java.lang.System.loadLibrary / System.load (daraja la asili)
- java.lang.Runtime.exec / ProcessBuilder (amri za kujaribu)
- android.os.SystemProperties.get (mbinu za kukisia za root/emulator)

## Hatua 5 — Runtime stubbing na Frida (Java)

Override custom guards ili zirudishe thamani salama bila repacking:
```js
Java.perform(() => {
const Checks = Java.use('com.example.security.Checks');
Checks.isFridaDetected.implementation = function () { return false; };

// Neutralize debugger checks
const Debug = Java.use('android.os.Debug');
Debug.isDebuggerConnected.implementation = function () { return false; };

// Example: kill ActivityManager scans
const AM = Java.use('android.app.ActivityManager');
AM.getRunningAppProcesses.implementation = function () { return java.util.Collections.emptyList(); };
});
```
Unachambua crash za mapema? Dump classes tu kabla ya kuanguka ili kugundua detection namespaces zinazowezekana:
```js
Java.perform(() => {
Java.enumerateLoadedClasses({
onMatch: n => console.log(n),
onComplete: () => console.log('Done')
});
});
```
// Quick root detection stub example (adapt to target package/class names)
Java.perform(() => {
try {
const RootChecker = Java.use('com.target.security.RootCheck');
RootChecker.isDeviceRooted.implementation = function () { return false; };
} catch (e) {}
});

Log na neuter methods zinazoshukiwa ili kuthibitisha mtiririko wa utekelezaji:
```js
Java.perform(() => {
const Det = Java.use('com.example.security.DetectionManager');
Det.checkFrida.implementation = function () {
console.log('checkFrida() called');
return false;
};
});
```
## Bypass emulator/VM detection (Java stubs)

Vigezo vya kawaida: Build.FINGERPRINT/MODEL/MANUFACTURER/HARDWARE vinavyotajwa generic/goldfish/ranchu/sdk; viashiria vya QEMU kama /dev/qemu_pipe, /dev/socket/qemud; MAC ya chaguo-msingi 02:00:00:00:00:00; 10.0.2.x NAT; ukosefu wa telephony/sensors.

Udanganyifu wa haraka wa Build fields:
```js
Java.perform(function(){
var Build = Java.use('android.os.Build');
Build.MODEL.value = 'Pixel 7 Pro';
Build.MANUFACTURER.value = 'Google';
Build.BRAND.value = 'google';
Build.FINGERPRINT.value = 'google/panther/panther:14/UP1A.231105.003/1234567:user/release-keys';
});
```
Ongeza stubs kwa ajili ya ukaguzi wa uwepo wa faili na vitambulisho (TelephonyManager.getDeviceId/SubscriberId, WifiInfo.getMacAddress, SensorManager.getSensorList) ili kurudisha thamani zinazofanana na halisi.

## SSL pinning bypass quick hook (Java)

Fanya TrustManagers maalum zisifanye kazi na kulazimisha SSL contexts zinazoruhusu:
```js
Java.perform(function(){
var X509TrustManager = Java.use('javax.net.ssl.X509TrustManager');
var SSLContext = Java.use('javax.net.ssl.SSLContext');

// No-op validations
X509TrustManager.checkClientTrusted.implementation = function(){ };
X509TrustManager.checkServerTrusted.implementation = function(){ };

// Force permissive TrustManagers
var TrustManagers = [ X509TrustManager.$new() ];
var SSLContextInit = SSLContext.init.overload('[Ljavax.net.ssl.KeyManager;','[Ljavax.net.ssl.TrustManager;','java.security.SecureRandom');
SSLContextInit.implementation = function(km, tm, sr){
return SSLContextInit.call(this, km, TrustManagers, sr);
};
});
```
Vidokezo
- Panua kwa OkHttp: hook okhttp3.CertificatePinner na HostnameVerifier kama inavyohitajika, au tumia universal unpinning script kutoka CodeShare.
- Mfano wa kuendesha: `frida -U -f com.target.app -l ssl-bypass.js --no-pause`

### OkHttp4 / gRPC / Cronet pinning (2024+)

Mifumo ya kisasa hu-pin ndani ya APIs mpya (OkHttp4+, gRPC over Cronet/BoringSSL). Ongeza hooks hizi wakati hook ya msingi ya SSLContext inasuasua:
```js
Java.perform(() => {
try {
const Pinner = Java.use('okhttp3.CertificatePinner');
Pinner.check.overload('java.lang.String', 'java.util.List').implementation = function(){};
Pinner.check$okhttp.implementation = function(){};
} catch (e) {}

try {
const CronetB = Java.use('org.chromium.net.CronetEngine$Builder');
CronetB.enablePublicKeyPinningBypassForLocalTrustAnchors.overload('boolean').implementation = function(){ return this; };
CronetB.setPublicKeyPins.overload('java.lang.String', 'java.util.Set', 'boolean').implementation = function(){ return this; };
} catch (e) {}
});
```
Ikiwa TLS bado inashindwa, hamia kwenye native na rekebisha BoringSSL verification entry points zinazotumiwa na Cronet/gRPC:
```js
const customVerify = Module.findExportByName(null, 'SSL_CTX_set_custom_verify');
if (customVerify) {
Interceptor.attach(customVerify, {
onEnter(args){
// arg0 = SSL_CTX*, arg1 = mode, arg2 = callback
args[1] = ptr(0); // SSL_VERIFY_NONE
args[2] = NULL;  // disable callback
}
});
}
```
## Hatua 6 — Fuata njia ya JNI/native wakati Java hooks zitashindwa

Fuatilia JNI entry points ili kupata native loaders na detection init:
```bash
frida-trace -n com.example.app -i "JNI_OnLoad"
```
Tathmini ya haraka ya native ya mafaili .so yaliyopakiwa:
```bash
# List exported symbols & JNI
nm -D libfoo.so | head
objdump -T libfoo.so | grep Java_
strings -n 6 libfoo.so | egrep -i 'frida|ptrace|gum|magisk|su|root'
```
Interactive/native reversing:
- Ghidra: https://ghidra-sre.org/
- r2frida: https://github.com/nowsecure/r2frida

Mfano: neuter ptrace to defeat simple anti‑debug in libc:
```js
const ptrace = Module.findExportByName(null, 'ptrace');
if (ptrace) {
Interceptor.replace(ptrace, new NativeCallback(function () {
return -1; // pretend failure
}, 'int', ['int', 'int', 'pointer', 'pointer']));
}
```
Angalia pia:
{{#ref}}
reversing-native-libraries.md
{{#endref}}

## Hatua 7 — Objection patching (embed gadget / strip basics)

Ukipendelea repacking kwa runtime hooks, jaribu:
```bash
objection patchapk --source app.apk
```
Vidokezo:
- Inahitaji apktool; hakikisha toleo la sasa kutoka kwenye mwongozo rasmi ili kuepuka matatizo ya kujenga: https://apktool.org/docs/install
- Gadget injection inaruhusu instrumentation bila root lakini bado inaweza kugunduliwa na init‑time checks zenye nguvu zaidi.

Hiari, ongeza modules za LSPosed na Shamiko kwa root hiding yenye nguvu zaidi katika mazingira ya Zygisk, na panga DenyList ili kufunika michakato ndogo.

Kwa mtiririko kamili wa kazi ikiwa ni pamoja na script-mode Gadget configuration na kuunganisha Frida 17+ agent ndani ya APK, ona:

[Frida Tutorial — Self-contained agent + Gadget embedding](frida-tutorial/README.md)

Marejeo:
- Objection: https://github.com/sensepost/objection

## Hatua 8 — Njia mbadala: Rekebisha TLS pinning kwa uwazi wa mtandao

Ikiwa instrumentation imezuiwa, bado unaweza kuchunguza trafiki kwa kuondoa pinning kwa njia ya statiki:
```bash
apk-mitm app.apk
# Then install the patched APK and proxy via Burp/mitmproxy
```
- Zana: https://github.com/shroudedcode/apk-mitm
- Kwa mbinu za usanidi wa mtandao kuhusu kuamini vyeti vya CA (na jinsi Android 7+ inavyokuamini vyeti vya CA za mtumiaji), angalia:

{{#ref}}
make-apk-accept-ca-certificate.md
{{#endref}}

{{#ref}}
install-burp-certificate.md
{{#endref}}

## Mwongozo mfupi wa amri
```bash
# List processes and attach
frida-ps -Uai
frida -U -n com.example.app

# Spawn with a script (may trigger detectors)
frida -U -f com.example.app -l anti-frida-detection.js

# Trace native init
frida-trace -n com.example.app -i "JNI_OnLoad"

# Objection runtime
objection --gadget com.example.app explore

# Static TLS pinning removal
apk-mitm app.apk
```
## Universal proxy forcing + TLS unpinning (HTTP Toolkit Frida hooks)

Programu za kisasa mara nyingi hazizingatii system proxies na hutumia tabaka mbalimbali za pinning (Java + native), na hivyo kufanya kukamata trafiki kuwa ngumu hata ikiwa user/system CAs zimewekwa. Njia ya vitendo ni kuchanganya universal TLS unpinning na proxy forcing kupitia Frida hooks zilizotengenezwa tayari, na kupeleka kila kitu kupitia mitmproxy/Burp.

Mtiririko
- Endesha mitmproxy kwenye mwenyeji wako (au Burp). Hakikisha kifaa kinaweza kufikia host IP/port.
- Pakia Frida hooks zilizojumuishwa za HTTP Toolkit ili ku-unpin TLS na kulazimisha matumizi ya proxy kwenye stacks za kawaida (OkHttp/OkHttp3, HttpsURLConnection, Conscrypt, WebView, n.k.). Hii inaepuka ukaguzi wa CertificatePinner/TrustManager na kubadilisha proxy selectors, hivyo trafiki itatumwa kila wakati kupitia proxy yako hata kama app imezimia proxies waziwazi.
- Anzisha app lengwa kwa Frida na script ya hook, na kamata requests katika mitmproxy.

Mfano
```bash
# Device connected via ADB or over network (-U)
# See the repo for the exact script names & options
frida -U -f com.vendor.app \
-l ./android-unpinning-with-proxy.js \
--no-pause

# mitmproxy listening locally
mitmproxy -p 8080
```
Vidokezo
- Unganisha na proxy ya kiwango cha mfumo kwa kutumia `adb shell settings put global http_proxy <host>:<port>` pale inapowezekana. Hooks za Frida zitatekeleza matumizi ya proxy hata wakati apps zinapovuka mipangilio ya mfumo.
- Mbinu hii ni bora unapohitaji kufanya MITM kwenye mchakato wa onboarding kutoka mobile hadi IoT ambapo pinning/proxy avoidance ni jambo la kawaida.
- Hooks: https://github.com/httptoolkit/frida-interception-and-unpinning

## References

- [Reversing Android Apps: Bypassing Detection Like a Pro](https://www.kayssel.com/newsletter/issue-12/)
- [Frida Codeshare](https://codeshare.frida.re/)
- [Objection](https://github.com/sensepost/objection)
- [apk-mitm](https://github.com/shroudedcode/apk-mitm)
- [Jadx](https://github.com/skylot/jadx)
- [Ghidra](https://ghidra-sre.org/)
- [r2frida](https://github.com/nowsecure/r2frida)
- [Apktool install guide](https://apktool.org/docs/install)
- [Magisk](https://github.com/topjohnwu/Magisk)
- [Medusa (Android Frida framework)](https://github.com/Ch0pin/medusa)
- [Build a Repeatable Android Bug Bounty Lab: Emulator vs Magisk, Burp, Frida, and Medusa](https://www.yeswehack.com/learn-bug-bounty/android-lab-mobile-hacking-tools)
- [Frida OkHttp4 SSL pinning bypass script](https://github.com/Zero3141/Frida-OkHttp-Bypass)
- [XDA guide to strong Play Integrity bypass (2025)](https://xdaforums.com/t/updated-11-17-2025-guide-get-strong-integrity-fix-banking-apps-revolut-google-wallet-android-16-working.4753805/)

{{#include ../../banners/hacktricks-training.md}}
