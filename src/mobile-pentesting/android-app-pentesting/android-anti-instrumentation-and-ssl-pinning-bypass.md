# Παρακάμψη Anti-Instrumentation & SSL Pinning σε Android (Frida/Objection)

{{#include ../../banners/hacktricks-training.md}}

Αυτή η σελίδα παρέχει ένα πρακτικό workflow για να επανακτήσετε dynamic analysis σε Android apps που ανιχνεύουν/μπλοκάρουν instrumentation λόγω root ή επιβάλλουν TLS pinning. Επικεντρώνεται σε γρήγορη τριάζ, κοινές ανιχνεύσεις και copy‑paste hooks/tactics για να τις παρακάμψετε χωρίς repacking όπου είναι δυνατό.

## Επιφάνεια ανίχνευσης (τι ελέγχουν οι εφαρμογές)

- Root checks: su binary, Magisk paths, getprop values, common root packages
- Frida/debugger checks (Java): Debug.isDebuggerConnected(), ActivityManager.getRunningAppProcesses(), getRunningServices(), scanning /proc, classpath, loaded libs
- Native anti‑debug: ptrace(), syscalls, anti‑attach, breakpoints, inline hooks
- Early init checks: Application.onCreate() or process start hooks that crash if instrumentation is present
- TLS pinning: custom TrustManager/HostnameVerifier, OkHttp CertificatePinner, Conscrypt pinning, native pins

## Βήμα 1 — Γρήγορο κέρδος: κρύψτε το root με Magisk DenyList

- Ενεργοποιήστε το Zygisk στο Magisk
- Ενεργοποιήστε το DenyList, προσθέστε το package του στόχου
- Επανεκκινήστε και δοκιμάστε ξανά

Πολλές εφαρμογές ψάχνουν μόνο για προφανείς ενδείξεις (su/Magisk paths/getprop). Το DenyList συχνά ουδετεροποιεί τις πρόχειρες ελέγχους.

References:
- Magisk (Zygisk & DenyList): https://github.com/topjohnwu/Magisk

### Play Integrity / Zygisk detections (post‑SafetyNet)

Οι νεότερες banking/ID εφαρμογές συνδέουν runtime checks με το Google Play Integrity (αντικατάσταση του SafetyNet) και μπορούν επίσης να κρασάρουν αν το Zygisk είναι παρόν. Γρήγορα tips για triage:

- Απενεργοποιήστε προσωρινά το Zygisk (toggle off + reboot) και δοκιμάστε ξανά· κάποιες εφαρμογές κρασάρουν αμέσως μόλις φορτώσει η Zygote injection.
- Αν η attestation μπλοκάρει το login, κάντε patch τα Google Play Services με PlayIntegrityFix/Fork + TrickyStore ή χρησιμοποιήστε ReZygisk/Zygisk‑Next μόνο κατά τη διάρκεια testing. Κρατήστε τον στόχο στο DenyList και αποφύγετε LSPosed modules που leak props.
- Για one‑off runs, χρησιμοποιήστε KernelSU/APatch (χωρίς Zygote injection) για να μείνετε κάτω από τις heuristics του Zygisk, και μετά κάντε attach το Frida.

## Βήμα 2 — Δοκιμές Frida Codeshare 30 δευτερολέπτων

Δοκιμάστε κοινά drop‑in scripts πριν προχωρήσετε σε βαθύτερη ανάλυση:

- anti-root-bypass.js
- anti-frida-detection.js
- hide_frida_gum.js

Παράδειγμα:
```bash
frida -U -f com.example.app -l anti-frida-detection.js
```
Συνήθως αυτά stub τα Java root/debug checks, τις process/service scans και την native ptrace(). Χρήσιμα σε lightly protected apps· hardened targets μπορεί να χρειάζονται tailored hooks.

- Codeshare: https://codeshare.frida.re/

## Αυτοματοποιήστε με Medusa (Frida framework)

Το Medusa παρέχει 90+ ready-made modules για SSL unpinning, root/emulator detection bypass, HTTP comms logging, crypto key interception, και άλλα.
```bash
git clone https://github.com/Ch0pin/medusa
cd medusa
pip install -r requirements.txt
python medusa.py

# Example interactive workflow
show categories
use http_communications/multiple_unpinner
use root_detection/universal_root_detection_bypass
run com.target.app
```
Συμβουλή: Η Medusa είναι εξαιρετική για γρήγορα αποτελέσματα πριν από τη συγγραφή custom hooks. Μπορείτε επίσης να cherry-pick modules και να τα συνδυάσετε με τα δικά σας scripts.

## Βήμα 3 — Bypass init-time detectors by attaching late

Πολλές ανιχνεύσεις εκτελούνται μόνο κατά το process spawn/onCreate(). Spawn‑time injection (-f) ή gadgets εντοπίζονται· attaching μετά το φόρτωμα του UI μπορεί να περάσει απαρατήρητο.
```bash
# Launch the app normally (launcher/adb), wait for UI, then attach
frida -U -n com.example.app
# Or with Objection to attach to running process
aobjection --gadget com.example.app explore  # if using gadget
```
Εάν αυτό λειτουργεί, διατηρήστε τη συνεδρία σταθερή και προχωρήστε στη χαρτογράφηση και στους ελέγχους stub.

## Step 4 — Χαρτογραφήστε τη λογική ανίχνευσης μέσω Jadx και αναζήτησης συμβολοσειρών

Στατικές λέξεις-κλειδιά στο Jadx:
- "frida", "gum", "root", "magisk", "ptrace", "su", "getprop", "debugger"

Τυπικά Java μοτίβα:
```java
public boolean isFridaDetected() {
return getRunningServices().contains("frida");
}
```
Common APIs to review/hook:
- android.os.Debug.isDebuggerConnected
- android.app.ActivityManager.getRunningAppProcesses / getRunningServices
- java.lang.System.loadLibrary / System.load (native bridge)
- java.lang.Runtime.exec / ProcessBuilder (probing commands)
- android.os.SystemProperties.get (root/emulator heuristics)

## Βήμα 5 — Runtime stubbing with Frida (Java)

Override των custom guards ώστε να επιστρέφουν ασφαλείς τιμές χωρίς repacking:
```js
Java.perform(() => {
const Checks = Java.use('com.example.security.Checks');
Checks.isFridaDetected.implementation = function () { return false; };

// Neutralize debugger checks
const Debug = Java.use('android.os.Debug');
Debug.isDebuggerConnected.implementation = function () { return false; };

// Example: kill ActivityManager scans
const AM = Java.use('android.app.ActivityManager');
AM.getRunningAppProcesses.implementation = function () { return java.util.Collections.emptyList(); };
});
```
Αν κάνετε triaging σε early crashes: Dump classes λίγο πριν τερματίσει για να εντοπίσετε πιθανά detection namespaces:
```js
Java.perform(() => {
Java.enumerateLoadedClasses({
onMatch: n => console.log(n),
onComplete: () => console.log('Done')
});
});
```
// Quick root detection stub example (adapt to target package/class names)
Java.perform(() => {
try {
const RootChecker = Java.use('com.target.security.RootCheck');
RootChecker.isDeviceRooted.implementation = function () { return false; };
} catch (e) {}
});

Καταγράψτε και αδρανοποιήστε ύποπτες μεθόδους για να επιβεβαιώσετε τη ροή εκτέλεσης:
```js
Java.perform(() => {
const Det = Java.use('com.example.security.DetectionManager');
Det.checkFrida.implementation = function () {
console.log('checkFrida() called');
return false;
};
});
```
## Bypass emulator/VM detection (Java stubs)

Συνήθεις ευρετικές τεχνικές: Πεδία Build.FINGERPRINT/MODEL/MANUFACTURER/HARDWARE που περιέχουν generic/goldfish/ranchu/sdk; QEMU artifacts όπως /dev/qemu_pipe, /dev/socket/qemud; προεπιλεγμένο MAC 02:00:00:00:00:00; 10.0.2.x NAT; έλλειψη telephony/sensors.

Γρήγορο spoof των πεδίων Build:
```js
Java.perform(function(){
var Build = Java.use('android.os.Build');
Build.MODEL.value = 'Pixel 7 Pro';
Build.MANUFACTURER.value = 'Google';
Build.BRAND.value = 'google';
Build.FINGERPRINT.value = 'google/panther/panther:14/UP1A.231105.003/1234567:user/release-keys';
});
```
Συμπληρώστε με stubs για ελέγχους ύπαρξης αρχείων και αναγνωριστικά (TelephonyManager.getDeviceId/SubscriberId, WifiInfo.getMacAddress, SensorManager.getSensorList) ώστε να επιστρέφουν ρεαλιστικές τιμές.

## SSL pinning bypass quick hook (Java)

Αδρανοποιήστε προσαρμοσμένους TrustManagers και επιβάλετε επιεικείς SSL contexts:
```js
Java.perform(function(){
var X509TrustManager = Java.use('javax.net.ssl.X509TrustManager');
var SSLContext = Java.use('javax.net.ssl.SSLContext');

// No-op validations
X509TrustManager.checkClientTrusted.implementation = function(){ };
X509TrustManager.checkServerTrusted.implementation = function(){ };

// Force permissive TrustManagers
var TrustManagers = [ X509TrustManager.$new() ];
var SSLContextInit = SSLContext.init.overload('[Ljavax.net.ssl.KeyManager;','[Ljavax.net.ssl.TrustManager;','java.security.SecureRandom');
SSLContextInit.implementation = function(km, tm, sr){
return SSLContextInit.call(this, km, TrustManagers, sr);
};
});
```
Σημειώσεις
- Επεκτείνετε για OkHttp: hook okhttp3.CertificatePinner και HostnameVerifier όπως χρειάζεται, ή χρησιμοποιήστε ένα universal unpinning script από CodeShare.
- Παράδειγμα εκτέλεσης: `frida -U -f com.target.app -l ssl-bypass.js --no-pause`

### OkHttp4 / gRPC / Cronet pinning (2024+)

Οι σύγχρονες στοίβες pin μέσα σε νεότερα APIs (OkHttp4+, gRPC over Cronet/BoringSSL). Προσθέστε αυτά τα hooks όταν ο βασικός SSLContext hook κολλάει:
```js
Java.perform(() => {
try {
const Pinner = Java.use('okhttp3.CertificatePinner');
Pinner.check.overload('java.lang.String', 'java.util.List').implementation = function(){};
Pinner.check$okhttp.implementation = function(){};
} catch (e) {}

try {
const CronetB = Java.use('org.chromium.net.CronetEngine$Builder');
CronetB.enablePublicKeyPinningBypassForLocalTrustAnchors.overload('boolean').implementation = function(){ return this; };
CronetB.setPublicKeyPins.overload('java.lang.String', 'java.util.Set', 'boolean').implementation = function(){ return this; };
} catch (e) {}
});
```
Αν το TLS εξακολουθεί να αποτυγχάνει, περάστε σε native και κάντε patch τα BoringSSL verification entry points που χρησιμοποιούνται από το Cronet/gRPC:
```js
const customVerify = Module.findExportByName(null, 'SSL_CTX_set_custom_verify');
if (customVerify) {
Interceptor.attach(customVerify, {
onEnter(args){
// arg0 = SSL_CTX*, arg1 = mode, arg2 = callback
args[1] = ptr(0); // SSL_VERIFY_NONE
args[2] = NULL;  // disable callback
}
});
}
```
## Βήμα 6 — Ακολουθήστε το ίχνος JNI/native όταν τα Java hooks αποτύχουν

Ανιχνεύστε τα JNI entry points για να εντοπίσετε native loaders και detection init:
```bash
frida-trace -n com.example.app -i "JNI_OnLoad"
```
Γρήγορη εγγενής διαλογή των ενσωματωμένων .so αρχείων:
```bash
# List exported symbols & JNI
nm -D libfoo.so | head
objdump -T libfoo.so | grep Java_
strings -n 6 libfoo.so | egrep -i 'frida|ptrace|gum|magisk|su|root'
```
Διαδραστικό/native reversing:
- Ghidra: https://ghidra-sre.org/
- r2frida: https://github.com/nowsecure/r2frida

Παράδειγμα: neuter ptrace για να παρακάμψετε απλό anti‑debug σε libc:
```js
const ptrace = Module.findExportByName(null, 'ptrace');
if (ptrace) {
Interceptor.replace(ptrace, new NativeCallback(function () {
return -1; // pretend failure
}, 'int', ['int', 'int', 'pointer', 'pointer']));
}
```
Δείτε επίσης:
{{#ref}}
reversing-native-libraries.md
{{#endref}}

## Βήμα 7 — Objection patching (embed gadget / strip basics)

Όταν προτιμάτε το repacking αντί για runtime hooks, δοκιμάστε:
```bash
objection patchapk --source app.apk
```
Σημειώσεις:
- Απαιτεί apktool· εξασφαλίστε μια ενημερωμένη έκδοση από τον επίσημο οδηγό για να αποφύγετε προβλήματα build: https://apktool.org/docs/install
- Gadget injection επιτρέπει instrumentation χωρίς root αλλά μπορεί ακόμα να εντοπιστεί από ισχυρότερους init‑time checks.

Προαιρετικά, προσθέστε LSPosed modules και Shamiko για ισχυρότερο root hiding σε περιβάλλοντα Zygisk, και επιμεληθείτε την DenyList ώστε να καλύπτει child processes.

Για ένα πλήρες workflow που περιλαμβάνει script-mode Gadget configuration και το bundling του Frida 17+ agent μέσα στο APK, δείτε:

[Frida Tutorial — Self-contained agent + Gadget embedding](frida-tutorial/README.md)

Αναφορές:
- Objection: https://github.com/sensepost/objection

## Step 8 — Εφεδρική λύση: Patch TLS pinning για δικτυακή ορατότητα

Αν η instrumentation μπλοκάρεται, μπορείτε να εξακολουθήσετε να ελέγχετε την κίνηση δικτύου αφαιρώντας στατικά το pinning:
```bash
apk-mitm app.apk
# Then install the patched APK and proxy via Burp/mitmproxy
```
- Εργαλείο: https://github.com/shroudedcode/apk-mitm
- Για τεχνάσματα CA‑trust στη διαμόρφωση δικτύου (και το Android 7+ user CA trust), δείτε:

{{#ref}}
make-apk-accept-ca-certificate.md
{{#endref}}

{{#ref}}
install-burp-certificate.md
{{#endref}}

## Χρήσιμο σύντομο υπόμνημα εντολών
```bash
# List processes and attach
frida-ps -Uai
frida -U -n com.example.app

# Spawn with a script (may trigger detectors)
frida -U -f com.example.app -l anti-frida-detection.js

# Trace native init
frida-trace -n com.example.app -i "JNI_OnLoad"

# Objection runtime
objection --gadget com.example.app explore

# Static TLS pinning removal
apk-mitm app.apk
```
## Universal proxy forcing + TLS unpinning (HTTP Toolkit Frida hooks)

Οι σύγχρονες εφαρμογές συχνά αγνοούν τους system proxies και εφαρμόζουν πολλαπλά επίπεδα pinning (Java + native), καθιστώντας τη σύλληψη της κίνησης δύσκολη ακόμα και με εγκατεστημένα user/system CAs. Μια πρακτική προσέγγιση είναι να συνδυάσετε universal TLS unpinning με proxy forcing μέσω έτοιμων Frida hooks και να δρομολογήσετε τα πάντα μέσω mitmproxy/Burp.

Ροή εργασίας
- Τρέξτε mitmproxy στον host σας (ή Burp). Βεβαιωθείτε ότι η συσκευή μπορεί να φτάσει στο host IP/port.
- Φορτώστε τα συγκεντρωμένα Frida hooks του HTTP Toolkit για να unpin TLS και να εξαναγκάσετε τη χρήση proxy σε κοινά stacks (OkHttp/OkHttp3, HttpsURLConnection, Conscrypt, WebView, κ.λπ.). Αυτό παρακάμπτει τους ελέγχους CertificatePinner/TrustManager και αντικαθιστά τους proxy selectors, οπότε η κίνηση στέλνεται πάντα μέσω του proxy σας ακόμα κι αν η εφαρμογή απενεργοποιεί ρητά τους proxies.
- Εκκινήστε την στοχευμένη εφαρμογή με Frida και το hook script, και καταγράψτε τα requests στο mitmproxy.

Παράδειγμα
```bash
# Device connected via ADB or over network (-U)
# See the repo for the exact script names & options
frida -U -f com.vendor.app \
-l ./android-unpinning-with-proxy.js \
--no-pause

# mitmproxy listening locally
mitmproxy -p 8080
```
Σημειώσεις
- Συνδυάστε το με proxy σε επίπεδο συστήματος μέσω `adb shell settings put global http_proxy <host>:<port>` όταν είναι δυνατό. Τα Frida hooks θα επιβάλλουν τη χρήση proxy ακόμη και όταν οι εφαρμογές παρακάμπτουν τις global ρυθμίσεις.
- Αυτή η τεχνική είναι ιδανική όταν χρειάζεται να κάνετε MITM σε mobile-to-IoT onboarding flows, όπου η αποφυγή pinning/proxy είναι συνηθισμένη.
- Hooks: https://github.com/httptoolkit/frida-interception-and-unpinning

## Αναφορές

- [Reversing Android Apps: Bypassing Detection Like a Pro](https://www.kayssel.com/newsletter/issue-12/)
- [Frida Codeshare](https://codeshare.frida.re/)
- [Objection](https://github.com/sensepost/objection)
- [apk-mitm](https://github.com/shroudedcode/apk-mitm)
- [Jadx](https://github.com/skylot/jadx)
- [Ghidra](https://ghidra-sre.org/)
- [r2frida](https://github.com/nowsecure/r2frida)
- [Apktool install guide](https://apktool.org/docs/install)
- [Magisk](https://github.com/topjohnwu/Magisk)
- [Medusa (Android Frida framework)](https://github.com/Ch0pin/medusa)
- [Build a Repeatable Android Bug Bounty Lab: Emulator vs Magisk, Burp, Frida, and Medusa](https://www.yeswehack.com/learn-bug-bounty/android-lab-mobile-hacking-tools)
- [Frida OkHttp4 SSL pinning bypass script](https://github.com/Zero3141/Frida-OkHttp-Bypass)
- [XDA guide to strong Play Integrity bypass (2025)](https://xdaforums.com/t/updated-11-17-2025-guide-get-strong-integrity-fix-banking-apps-revolut-google-wallet-android-16-working.4753805/)

{{#include ../../banners/hacktricks-training.md}}
