# Détournement de Tâches Android

{{#include ../../banners/hacktricks-training.md}}

## Tâches, Pile de Retour et Activités au Premier Plan

Dans Android, une **tâche** est essentiellement un ensemble d'activités avec lesquelles les utilisateurs interagissent pour accomplir un travail spécifique, organisées dans une **pile de retour**. Cette pile ordonne les activités en fonction de leur ouverture, l'activité la plus récente étant affichée en haut comme l'**activité au premier plan**. À tout moment, seule cette activité est visible à l'écran, faisant partie de la **tâche au premier plan**.

Voici un aperçu rapide des transitions d'activités :

- **Activité 1** commence comme la seule activité au premier plan.
- Le lancement de **l'Activité 2** pousse **l'Activité 1** dans la pile de retour, amenant **l'Activité 2** au premier plan.
- Le démarrage de **l'Activité 3** déplace **l'Activité 1** et **l'Activité 2** plus loin dans la pile, avec **l'Activité 3** maintenant devant.
- La fermeture de **l'Activité 3** ramène **l'Activité 2** au premier plan, mettant en avant le mécanisme de navigation des tâches simplifié d'Android.

![https://developer.android.com/images/fundamentals/diagram_backstack.png](<../../images/image (698).png>)

## Attaque par Affinité de Tâche

### Aperçu de l'Affinité de Tâche et des Modes de Lancement

Dans les applications Android, l'**affinité de tâche** spécifie la tâche préférée d'une activité, s'alignant généralement avec le nom du package de l'application. Cette configuration est essentielle pour créer une application de preuve de concept (PoC) pour démontrer l'attaque.

### Modes de Lancement

L'attribut `launchMode` dirige le traitement des instances d'activités au sein des tâches. Le mode **singleTask** est crucial pour cette attaque, dictant trois scénarios basés sur les instances d'activités existantes et les correspondances d'affinité de tâche. L'exploitation repose sur la capacité de l'application de l'attaquant à imiter l'affinité de tâche de l'application cible, induisant le système Android en erreur pour lancer l'application de l'attaquant au lieu de la cible prévue.

### Étapes D'Attaque Détaillées

1. **Installation de l'Application Malveillante** : La victime installe l'application de l'attaquant sur son appareil.
2. **Activation Initiale** : La victime ouvre d'abord l'application malveillante, préparant l'appareil pour l'attaque.
3. **Tentative de Lancement de l'Application Cible** : La victime tente d'ouvrir l'application cible.
4. **Exécution du Détournement** : En raison de l'affinité de tâche correspondante, l'application malveillante est lancée à la place de l'application cible.
5. **Tromperie** : L'application malveillante présente un faux écran de connexion ressemblant à l'application cible, trompant l'utilisateur pour qu'il saisisse des informations sensibles.

Pour une mise en œuvre pratique de cette attaque, consultez le dépôt Task Hijacking Strandhogg sur GitHub : [Task Hijacking Strandhogg](https://github.com/az0mb13/Task_Hijacking_Strandhogg).

### Mesures de Prévention

Pour prévenir de telles attaques, les développeurs peuvent définir `taskAffinity` sur une chaîne vide et opter pour le mode de lancement `singleInstance`, garantissant l'isolement de leur application par rapport aux autres. La personnalisation de la fonction `onBackPressed()` offre une protection supplémentaire contre le détournement de tâches.

## **Références**

- [**https://blog.dixitaditya.com/android-task-hijacking/**](https://blog.dixitaditya.com/android-task-hijacking/)
- [**https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html**](https://blog.takemyhand.xyz/2021/02/android-task-hijacking-with.html)

{{#include ../../banners/hacktricks-training.md}}
