# Tutorial de Frida

{{#include ../../../banners/hacktricks-training.md}}


## Instalación

Instalar **frida tools**:
```bash
pip install frida-tools
pip install frida
```
**Descarga e instala** en el dispositivo Android el **frida server** ([Download the latest release](https://github.com/frida/frida/releases)).\
Comando de una sola línea para reiniciar adb en modo root, conectarse a él, subir frida-server, darle permisos de ejecución y ejecutarlo en segundo plano:
```bash
adb root; adb connect localhost:6000; sleep 1; adb push frida-server /data/local/tmp/; adb shell "chmod 755 /data/local/tmp/frida-server"; adb shell "/data/local/tmp/frida-server &"
```
**Comprueba** si está **funcionando**:
```bash
frida-ps -U #List packages and processes
frida-ps -U | grep -i <part_of_the_package_name> #Get all the package name
```
## frida-ui (controlador de Frida basado en navegador)

**frida-ui** proporciona una interfaz web en `http://127.0.0.1:8000` para listar dispositivos/apps y adjuntar o spawn targets con scripts (no se necesita CLI).

- Instalar (fija `frida` a la versión del device server):
```bash
uv tool install frida-ui --with frida==16.7.19
# pipx install frida-ui
# pip install frida-ui
```
- Ejecutar:
```bash
frida-ui
frida-ui --host 127.0.0.1 --port 8000 --reload
```
- Funciones: descubre dispositivos USB/locales, agrega servidores remotos (`192.168.1.x:27042`) y soporta **Attach**, **Spawn** y **Spawn & Run** (to hook before early `onCreate()` logic).
- Scripting: editor, arrastra y suelta `.js`, importa CodeShare, descarga scripts y registros de sesión.
- Servidores remotos: `./frida-server -l 0.0.0.0:27042 -D` lo expone en la red para que frida-ui pueda conectarse sin ADB.

## Frida server vs. Gadget (root vs. no-root)

Dos formas comunes de instrumentar aplicaciones Android con Frida:

- Frida server (rooted devices): Empuja y ejecuta un daemon nativo que te permite attach a cualquier proceso.
- Frida Gadget (no root): Empaqueta Frida como una librería compartida dentro del APK y la carga automáticamente en el proceso objetivo.

Frida server (rooted)
```bash
# Download the matching frida-server binary for your device's arch
# https://github.com/frida/frida/releases
adb root
adb push frida-server-<ver>-android-<arch> /data/local/tmp/frida-server
adb shell chmod 755 /data/local/tmp/frida-server
adb shell /data/local/tmp/frida-server &    # run at boot via init/magisk if desired

# From host, list processes and attach
frida-ps -Uai
frida -U -n com.example.app
```
Frida Gadget (no-root)

1) Desempaqueta el APK, añade el .so del gadget y la configuración:
- Coloca libfrida-gadget.so en `lib/<abi>/` (p. ej., lib/arm64-v8a/)
- Crea assets/frida-gadget.config con la configuración para cargar tus scripts

Ejemplo frida-gadget.config
```json
{
"interaction": { "type": "script", "path": "/sdcard/ssl-bypass.js" },
"runtime": { "logFile": "/sdcard/frida-gadget.log" }
}
```
2) Referencia/carga el gadget para que se inicialice temprano:
- Más fácil: Añade un pequeño Java stub con System.loadLibrary("frida-gadget") en Application.onCreate(), o usa la carga nativa de librerías ya presente.

3) Reempaqueta y firma el APK, luego instala:
```bash
apktool d app.apk -o app_m
# ... add gadget .so and config ...
apktool b app_m -o app_gadget.apk
uber-apk-signer -a app_gadget.apk -o out_signed
adb install -r out_signed/app_gadget-aligned-debugSigned.apk
```
4) Adjuntar desde el host al proceso gadget:
```bash
frida-ps -Uai
frida -U -n com.example.app
```
Notas
- Gadget is detectado por algunas protecciones; mantén nombres/rutas stealthy y cárgalo tarde/condicionalmente si es necesario.
- En hardened apps, prefiere rooted testing con server + late attach, o combínalo con Magisk/Zygisk hiding.

## Inyección Frida basada en JDWP sin root/repackaging (frida-jdwp-loader)

Si el APK es debuggable (android:debuggable="true"), puedes attach over JDWP e inyectar una librería nativa en un Java breakpoint. No root y no APK repackaging.

- Repo: https://github.com/frankheat/frida-jdwp-loader
- Requisitos: ADB, Python 3, USB/Wireless debugging. App must be debuggable (emulator with `ro.debuggable=1`, rooted device with `resetprop`, or rebuild manifest).

Inicio rápido:
```bash
git clone https://github.com/frankheat/frida-jdwp-loader.git
cd frida-jdwp-loader
# Inject frida-gadget.so into a debuggable target
python frida-jdwp-loader.py frida -n com.example.myapplication
# Keep the breakpoint thread suspended for early hooks
python frida-jdwp-loader.py frida -n com.example.myapplication -s
# Networkless: run a local agent script via Gadget "script" mode
python frida-jdwp-loader.py frida -n com.example.myapplication -i script -l script.js
```
Notas
- Modos: spawn (detener en Application.onCreate) o attach (detener en Activity.onStart). Usa `-b` para establecer un método Java específico, `-g` para seleccionar la versión/ruta de Gadget, `-p` para elegir el puerto JDWP.
- Modo de escucha: reenvía Gadget (por defecto 127.0.0.1:27042) si es necesario: `adb forward tcp:27042 tcp:27042`; luego `frida-ps -H 127.0.0.1:27042`.
- Esto aprovecha la depuración JDWP. El riesgo es distribuir builds depurables o exponer JDWP.

## Agente autocontenido + incrustación de Gadget (Frida 17+; automatizado con Objection)

Frida 17 removed the built-in Java/ObjC bridges from GumJS. If your agent hooks Java, you must include the Java bridge inside your bundle.

1) Crea un agente Frida (TypeScript) e incluye el Java bridge
```bash
# Scaffolding
frida-create -t agent -o mod
cd mod && npm install
# Install the Java bridge for Frida 17+
npm install frida-java-bridge
# Dev loop (optional live-reload via REPL)
npm run watch
```
Hook Java mínimo (fuerza las tiradas de dados a 1):
```ts
import Java from "frida-java-bridge";

Java.perform(function () {
var dicer = Java.use("org.secuso.privacyfriendlydicer.dicer.Dicer");
dicer.rollDice.implementation = function (numDice: number, numFaces: number) {
return Array(numDice).fill(1);
};
});
```
Construir un único bundle para incrustar:
```bash
npm run build    # produces _agent.js via frida-compile
```
Prueba rápida de USB (opcional):
```bash
frida -U -f org.secuso.privacyfriendlydicer -l _agent.js
```
2) Configure Gadget to auto-load your script
El patcher de Objection espera un Gadget config; al usar script mode, especifica el on-disk path dentro del APK lib dir:
```json
{
"interaction": {
"type": "script",
"path": "libfrida-gadget.script.so"
}
}
```
3) Automatizar el parcheo de APK con Objection
```bash
# Embed Gadget, config, and your compiled agent into the APK; rebuild and sign
objection patchapk -s org.secuso.privacyfriendlydicer.apk \
-c gadget-config.json \
-l mod/_agent.js \
--use-aapt2
```
Qué hace patchapk (a alto nivel):
- Detecta la ABI del dispositivo (p. ej., arm64-v8a) y descarga el Gadget correspondiente
- Opcionalmente añade android.permission.INTERNET cuando sea necesario
- Inyecta un inicializador de clase estático que llama a System.loadLibrary("frida-gadget") en la actividad de lanzamiento
- Coloca lo siguiente en `lib/<abi>/`:
- libfrida-gadget.so
- libfrida-gadget.config.so (config serializada)
- libfrida-gadget.script.so (tu _agent.js)

Ejemplo de smali inyectado (inicializador estático):
```smali
.method static constructor <clinit>()V
.locals 1
const-string v0, "frida-gadget"
invoke-static {v0}, Ljava/lang/System;->loadLibrary(Ljava/lang/String;)V
return-void
.end method
```
4) Verificar el repack
```bash
apktool d org.secuso.privacyfriendlydicer.apk
apktool d org.secuso.privacyfriendlydicer.objection.apk
# Inspect differences
diff -r org.secuso.privacyfriendlydicer org.secuso.privacyfriendlydicer.objection
```
Cambios esperados:
- AndroidManifest.xml puede incluir `<uses-permission android:name="android.permission.INTERNET"/>`
- Nuevas librerías nativas bajo `lib/<abi>/` como se indicó anteriormente
- El smali de la actividad lanzable contiene un `<clinit>` estático que llama a System.loadLibrary("frida-gadget")

5) Split APKs
- Parchea el APK base (el que declara la actividad MAIN/LAUNCHER)
- Re-firma los splits restantes con la misma clave:
```bash
objection signapk split1.apk split2.apk ...
```
- Instalar splits juntos:
```bash
adb install-multiple split1.apk split2.apk ...
```
- Para distribución, puedes fusionar los splits en un único APK con APKEditor, luego alinear/firmar

## Eliminar FLAG_SECURE durante el análisis dinámico

Las apps que llaman a `getWindow().setFlags(LayoutParams.FLAG_SECURE, LayoutParams.FLAG_SECURE)` impiden capturas de pantalla, pantallas remotas e incluso las instantáneas de tareas recientes de Android. Cuando Freedom Chat aplicó esta bandera, la única forma de documentar los leaks fue manipular la ventana en tiempo de ejecución. Un patrón fiable es:

- Hook every `Window` overload that can re-apply the flag (`setFlags`, `addFlags`, `setAttributes`) and mask out bit `0x00002000` (`WindowManager.LayoutParams.FLAG_SECURE`).
- Después de que cada activity se reanude, programa una llamada en el hilo UI a `clearFlags(FLAG_SECURE)` para que Dialogs/Fragments creados posteriormente hereden el estado desbloqueado.
- Las apps construidas con React Native / Flutter suelen crear ventanas anidadas; hook `android.app.Dialog`/`android.view.View` helpers o recorre `getWindow().peekDecorView()` si todavía ves marcos negros.

<details>
<summary>Frida hook clearing Window.FLAG_SECURE</summary>
```javascript
Java.perform(function () {
var LayoutParams = Java.use("android.view.WindowManager$LayoutParams");
var FLAG_SECURE = LayoutParams.FLAG_SECURE.value;
var Window = Java.use("android.view.Window");
var Activity = Java.use("android.app.Activity");

function strip(value) {
var masked = value & (~FLAG_SECURE);
if (masked !== value) {
console.log("[-] Stripped FLAG_SECURE from 0x" + value.toString(16));
}
return masked;
}

Window.setFlags.overload('int', 'int').implementation = function (flags, mask) {
return this.setFlags.call(this, strip(flags), strip(mask));
};

Window.addFlags.implementation = function (flags) {
return this.addFlags.call(this, strip(flags));
};

Window.setAttributes.implementation = function (attrs) {
attrs.flags.value = strip(attrs.flags.value);
return this.setAttributes.call(this, attrs);
};

Activity.onResume.implementation = function () {
this.onResume();
var self = this;
Java.scheduleOnMainThread(function () {
try {
self.getWindow().clearFlags(FLAG_SECURE);
console.log("[+] Cleared FLAG_SECURE on " + self.getClass().getName());
} catch (err) {
console.log("[!] clearFlags failed: " + err);
}
});
};
});
```
</details>

Ejecute el script con `frida -U -f <package> -l disable-flag-secure.js --no-pause`, interactúe con la UI, y las capturas de pantalla/grabaciones volverán a funcionar. Como todo ocurre en el UI thread no hay parpadeo, y aún puede combinar el hook con HTTP Toolkit/Burp para capturar el tráfico que reveló el `/channel` PIN leak.

## Volcado DEX dinámico / desempaquetado con clsdumper (Frida)

`clsdumper` es un **DEX/class dumper** dinámico basado en Frida que sobrevive a aplicaciones hardened combinando una pre-etapa anti-Frida con estrategias de descubrimiento nativas y Java (funciona incluso si `Java.perform()` falla). Requisitos: Python 3.10+, dispositivo rooteado con `frida-server` en ejecución, conexión USB o TCP `--host`.

**Instalación y uso rápido**
```bash
pip install clsdumper
# Attach to a running app
clsdumper com.example.app
# Spawn first (hooks before early loaders)
clsdumper com.example.app --spawn
# Select strategies
clsdumper com.example.app --strategies fart_dump,oat_extract
```
**CLI options (más útiles)**
- `target`: nombre del paquete o PID.
- `--spawn`: usar spawn en lugar de attach.
- `--host <ip>`: conectar al frida-server remoto.
- `--strategies <comma>`: limitar/seleccionar extractors; por defecto son todos excepto `mmap_hook` (costoso).
- `--no-scan` / `--deep-scan`: deshabilitar o ralentizar el escaneo profundo de memoria (agrega escaneo CDEX).
- `--extract-classes`: postprocesar los dumps a `.smali` vía androguard.
- `--no-anti-frida`: omitir la etapa de bypass pre-hook.
- `--list` / `--list-apps`: enumerar procesos en ejecución o paquetes instalados.

**Bypass anti-instrumentation (fase 0)**
- Intercepta `sigaction`/`signal` para bloquear el registro de handlers de crash/anti-debug.
- Sirve un `/proc/self/maps` filtrado vía `memfd_create` para ocultar las regiones de Frida.
- Monitorea `pthread_create` para detectar/neutralizar hilos watchdog que buscan Frida.

**DEX discovery (fases 1–2)** — múltiples estrategias complementarias con metadata por acierto + deduplicación (djb2 en el lado del agente, SHA-256 en el lado del host):
- Nativo (no se necesita puente Java): `art_walk` (recorre ART Runtime→ClassLinker→DexFile), `open_common_hook` (hook `DexFile::OpenCommon`), `memory_scan` (DEX magic en mapas legibles), `oat_extract` (parsea los .vdex/.oat mapeados), `fart_dump` (hook `DefineClass` + recorrer `class_table_`), `dexfile_constructor` (hook constructores de `OatDexFile`), `mmap_hook` (monitoriza `mmap/mmap64`, desactivado por defecto por rendimiento).
- Java (cuando esté disponible): `cookie` (leer `mCookie` de ClassLoaders), `classloader_hook` (monitorea `loadClass`, `DexClassLoader`, `InMemoryDexClassLoader`).

**Formato de salida**
```
dump_<target>/
dex/classes_001.dex ...
classes/                 # only when --extract-classes
metadata.json            # strategy per hit + hashes
```
Consejo: las apps protegidas a menudo cargan código desde varias fuentes (in-memory payload, vdex/oat, custom loaders). Ejecutar con el conjunto multi-strategy predeterminado más `--spawn` maximiza la cobertura; habilita `--deep-scan` solo cuando sea necesario para evitar impactos de rendimiento.

## Tutoriales

### [Tutorial 1](frida-tutorial-1.md)

**Fuente**: [https://medium.com/infosec-adventures/introduction-to-frida-5a3f51595ca1](https://medium.com/infosec-adventures/introduction-to-frida-5a3f51595ca1)\
**APK**: [https://github.com/t0thkr1s/frida-demo/releases](https://github.com/t0thkr1s/frida-demo/releases)\
**Código fuente**: [https://github.com/t0thkr1s/frida-demo](https://github.com/t0thkr1s/frida-demo)

**Sigue el [link to read it](frida-tutorial-1.md).**

### [Tutorial 2](frida-tutorial-2.md)

**Fuente**: [https://11x256.github.io/Frida-hooking-android-part-2/](https://11x256.github.io/Frida-hooking-android-part-2/) (Parts 2, 3 & 4)\
**APKs and Source code**: [https://github.com/11x256/frida-android-examples](https://github.com/11x256/frida-android-examples)

**Sigue el [link to read it.](frida-tutorial-2.md)**

### [Tutorial 3](owaspuncrackable-1.md)

**Fuente**: [https://joshspicer.com/android-frida-1](https://joshspicer.com/android-frida-1)\
**APK**: [https://github.com/OWASP/owasp-mstg/blob/master/Crackmes/Android/Level_01/UnCrackable-Level1.apk](https://github.com/OWASP/owasp-mstg/blob/master/Crackmes/Android/Level_01/UnCrackable-Level1.apk)

**Sigue el [link to read it](owaspuncrackable-1.md).**

**Puedes encontrar más Awesome Frida scripts aquí:** [**https://codeshare.frida.re/**](https://codeshare.frida.re)

## Ejemplos rápidos

### Llamando a Frida desde la línea de comandos
```bash
frida-ps -U

#Basic frida hooking
frida -l disableRoot.js -f owasp.mstg.uncrackable1

#Hooking before starting the app
frida -U --no-pause -l disableRoot.js -f owasp.mstg.uncrackable1
#The --no-pause and -f options allow the app to be spawned automatically,
#frozen so that the instrumentation can occur, and the automatically
#continue execution with our modified code.
```
### Script básico de Python
```python
import frida, sys

jscode = open(sys.argv[0]).read()
process = frida.get_usb_device().attach('infosecadventures.fridademo')
script = process.create_script(jscode)
print('[ * ] Running Frida Demo application')
script.load()
sys.stdin.read()
```
### Hooking de funciones sin parámetros

Hook la función `a()` de la clase `sg.vantagepoint.a.c`
```javascript
Java.perform(function () {
rootcheck1.a.overload().implementation = function () {
return false;
};
});
```
Hook java `exit()`
```javascript
var sysexit = Java.use("java.lang.System")
sysexit.exit.overload("int").implementation = function (var_0) {
send("java.lang.System.exit(I)V  // We avoid exiting the application  :)")
}
```
Hook MainActivity `.onStart()` y `.onCreate()`
```javascript
var mainactivity = Java.use("sg.vantagepoint.uncrackable1.MainActivity")
mainactivity.onStart.overload().implementation = function () {
send("MainActivity.onStart() HIT!!!")
var ret = this.onStart.overload().call(this)
}
mainactivity.onCreate.overload("android.os.Bundle").implementation = function (
var_0
) {
send("MainActivity.onCreate() HIT!!!")
var ret = this.onCreate.overload("android.os.Bundle").call(this, var_0)
}
```
Hook android `.onCreate()`
```javascript
var activity = Java.use("android.app.Activity")
activity.onCreate.overload("android.os.Bundle").implementation = function (
var_0
) {
send("Activity HIT!!!")
var ret = this.onCreate.overload("android.os.Bundle").call(this, var_0)
}
```
### Hooking de funciones con parámetros y recuperación del valor

Hooking a decryption function. Imprime la entrada, llama a la función original para decrypt la entrada y, finalmente, imprime los datos en claro:

<details>
<summary>Hooking a decryption function (Java) — imprimir entradas/salidas</summary>
```javascript
function getString(data) {
var ret = ""
for (var i = 0; i < data.length; i++) {
ret += data[i].toString()
}
return ret
}
var aes_decrypt = Java.use("sg.vantagepoint.a.a")
aes_decrypt.a.overload("[B", "[B").implementation = function (var_0, var_1) {
send("sg.vantagepoint.a.a.a([B[B)[B   doFinal(enc)  // AES/ECB/PKCS7Padding")
send("Key       : " + getString(var_0))
send("Encrypted : " + getString(var_1))
var ret = this.a.overload("[B", "[B").call(this, var_0, var_1)
send("Decrypted : " + ret)

var flag = ""
for (var i = 0; i < ret.length; i++) {
flag += String.fromCharCode(ret[i])
}
send("Decrypted flag: " + flag)
return ret //[B
}
```
</details>

### Hooking de funciones y llamándolas con nuestra entrada

Hook una función que recibe una string y llámala con otra string (desde [here](https://11x256.github.io/Frida-hooking-android-part-2/))
```javascript
var string_class = Java.use("java.lang.String") // get a JS wrapper for java's String class

my_class.fun.overload("java.lang.String").implementation = function (x) {
//hooking the new function
var my_string = string_class.$new("My TeSt String#####") //creating a new String by using `new` operator
console.log("Original arg: " + x)
var ret = this.fun(my_string) // calling the original function with the new String, and putting its return value in ret variable
console.log("Return value: " + ret)
return ret
}
```
### Obtención de un objeto ya creado de una clase

Si quieres extraer algún atributo de un objeto creado, puedes usar esto.

En este ejemplo verás cómo obtener el objeto de la clase my_activity y cómo llamar a la función .secret() que imprimirá un atributo privado del objeto:
```javascript
Java.choose("com.example.a11x256.frida_test.my_activity", {
onMatch: function (instance) {
//This function will be called for every instance found by frida
console.log("Found instance: " + instance)
console.log("Result of secret func: " + instance.secret())
},
onComplete: function () {},
})
```
## Otros tutoriales de Frida

- [https://github.com/DERE-ad2001/Frida-Labs](https://github.com/DERE-ad2001/Frida-Labs)
- [Part 1 of Advanced Frida Usage blog series: IOS Encryption Libraries](https://8ksec.io/advanced-frida-usage-part-1-ios-encryption-libraries-8ksec-blogs/)


## Referencias

- [Build a Repeatable Android Bug Bounty Lab: Emulator vs Magisk, Burp, Frida, and Medusa](https://www.yeswehack.com/learn-bug-bounty/android-lab-mobile-hacking-tools)
- [Frida Gadget documentation](https://frida.re/docs/gadget/)
- [Frida releases (server binaries)](https://github.com/frida/frida/releases)
- [Objection (SensePost)](https://github.com/sensepost/objection)
- [Modding And Distributing Mobile Apps with Frida](https://pit.bearblog.dev/modding-and-distributing-mobile-apps-with-frida/)
- [frida-jdwp-loader](https://github.com/frankheat/frida-jdwp-loader)
- [Library injection for debuggable Android apps (blog)](https://koz.io/library-injection-for-debuggable-android-apps/)
- [jdwp-lib-injector (original idea/tool)](https://github.com/ikoz/jdwp-lib-injector)
- [jdwp-shellifier](https://github.com/hugsy/jdwp-shellifier)
- ["Super secure" MAGA-themed messaging app leaks everyone’s phone number](https://ericdaigle.ca/posts/super-secure-maga-messaging-app-leaks-everyones-phone-number/)
- [Android Frida Hooking: Disabling FLAG_SECURE](https://www.securify.nl/en/blog/android-frida-hooking-disabling-flagsecure/)
- [frida-ui](https://github.com/adityatelange/frida-ui)
- [clsdumper — Android Dynamic Class Dumper](https://github.com/TheQmaks/clsdumper)

{{#include ../../../banners/hacktricks-training.md}}
