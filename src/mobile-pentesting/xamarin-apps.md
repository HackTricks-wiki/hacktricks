# Xamarin Apps

{{#include ../banners/hacktricks-training.md}}

## **Maelezo ya Msingi**

Xamarin ni jukwaa la **open-source** lililotengenezwa kwa watengenezaji kujenga programu za **iOS, Android, na Windows** kwa kutumia .NET na C# frameworks. Jukwaa hili linatoa upatikanaji wa zana nyingi na extensions za kuunda programu za kisasa kwa ufanisi.

### Miundombinu ya Xamarin

- Kwa **Android**, Xamarin inaunganisha na namespaces za Android na Java kupitia .NET bindings, ikifanya kazi ndani ya mazingira ya utekelezaji ya Mono pamoja na Android Runtime (ART). Managed Callable Wrappers (MCW) na Android Callable Wrappers (ACW) zinawezesha mawasiliano kati ya Mono na ART, zote mbili zimetengenezwa juu ya kernel ya Linux.
- Kwa **iOS**, programu zinaendesha chini ya runtime ya Mono, zikitumia full Ahead of Time (AOT) compilation kubadilisha C# .NET code kuwa assembly ya ARM. Mchakato huu unaendesha pamoja na Objective-C Runtime kwenye kernel aina ya UNIX.

### .NET Runtime na Mono Framework

The **.NET framework** inajumuisha assemblies, classes, na namespaces kwa maendeleo ya programu, na .NET Runtime inasimamia utekelezaji wa code. Inatoa ujumuishaji wa majukwaa (platform independence) na compatibility ya nyuma (backward compatibility). The **Mono Framework** ni toleo la open-source la .NET framework, lililoanzishwa mwaka 2005 ili kueneza .NET kwa Linux, sasa linaungwa mkono na Microsoft na linaongozwa na Xamarin.

### Reverse Engineering Xamarin Apps

#### Decompilation of Xamarin Assemblies

Decompilation hubadilisha code iliyokomilika kurudi kuwa source code. Kwenye Windows, dirisha la Modules katika Visual Studio linaweza kutambua modules kwa decompilation, kuruhusu upatikanaji wa moja kwa moja wa third-party code na uondoaji wa source code kwa uchambuzi.

#### JIT vs AOT Compilation

- **Android** inaunga mkono Just-In-Time (JIT) na Ahead-Of-Time (AOT) compilation, kwa mode ya Hybrid AOT kwa kasi bora ya utekelezaji. Full AOT inapatikana tu kwa leseni za Enterprise.
- **iOS** inatumia AOT compilation pekee kutokana na vizuizi vya Apple juu ya utekelezaji wa code ya dynamic.

### Extracting dll Files from APK/IPA

Ili kufikia assemblies ndani ya APK/IPA, unzip faili na chunguza saraka ya assemblies. Kwa Android, zana kama [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) na [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) zinaweza kuondoa ukandamizaji wa faili za dll.
```bash
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Katika kesi ambapo baada ya ku-decompile APK inawezekana kuona folda unknown/assemblies/ yenye faili za `.dll` ndani yake, inaweza kutumia [**dnSpy**](https://github.com/dnSpy/dnSpy) moja kwa moja kwenye `.dlls` ili kuzichambua. Hata hivyo, wakati mwingine faili za `assemblies.blob` na `assemblies.manifest` ziko ndani ya folda unknown/assemblies/. Zana [pyxamstore](https://github.com/jakev/pyxamstore) inaweza kufungua faili `assemblies.blob` katika Xamarin apps, ikiruhusu kupata .NET assemblies kwa uchambuzi zaidi:
```bash
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
# After patching DLLs, rebuild the store
pyxamstore pack
```
Baadhi ya builds za hivi karibuni za Xamarin/MAUI zinahifadhi assemblies zilizokandamizwa kwa kutumia muundo wa **XALZ** ndani ya `/assemblies.blob` au `/resources/assemblies`. Unaweza kuzifungua (decompress) haraka kwa kutumia maktaba ya [xamarout](https://pypi.org/project/xamarout/):
```python
from xamarout import xalz
import os
for root, _, files in os.walk("."):
for f in files:
if open(os.path.join(root, f), 'rb').read(4) == b"XALZ":
xa = xalz.XamarinCompressedAssembly(os.path.join(root, f))
xa.write("decompressed/" + f)
```
Faili za iOS dll zinapatikana kwa urahisi kwa ajili ya decompilation, zikifichua sehemu kubwa za msimbo wa programu, ambazo mara nyingi zinashiriki msingi sawa katika majukwaa mbalimbali.

> **AOT on iOS**: managed IL imekusanywa kuwa native `*.aotdata.*` files. Kurekebisha DLL pekee haitabadilisha mantiki; unahitaji hook native stubs (mfano, kwa kutumia Frida) kwa sababu bodies za IL ni placeholders tupu.

### Uchambuzi wa Statiki

Mara `.dll` zinapopatikana, inawezekana kuchambua msimbo wa .Net kwa njia ya statiki kwa kutumia zana kama [**dnSpy**](https://github.com/dnSpy/dnSpy) au [**ILSpy**](https://github.com/icsharpcode/ILSpy) ambazo zinakuwezesha kuhariri msimbo wa app. Hii inaweza kuwa ya msaada mkubwa wakati wa ku-modify programu ili kupita vizuizi vya usalama, kwa mfano.\
Kumbuka kwamba baada ya kubadilisha app utahitaji kuipakia tena na kuiisaini tena.

> dnSpy imearchived; forks zinazohifadhiwa kama **dnSpyEx** zinaendelea kufanya kazi na assemblies za .NET 8/MAUI na zinahifadhi debug symbols wakati wa ku-save upya.

### Uchambuzi wa Dinamiki

Uchambuzi wa Dinamiki unahusisha kukagua SSL pinning na kutumia zana kama [Fridax](https://github.com/NorthwaveSecurity/fridax) kwa mabadiliko ya runtime kwenye binary ya .NET katika apps za Xamarin. Frida scripts zinapatikana za ku-bypass root detection au SSL pinning, zikiboresha uwezo wa uchambuzi.

Other interesting Frida scripts:

- [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
- [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
- [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

Updated **Frida-xamarin-unpin** (Mono >=6) hooks `System.Net.Http.HttpClient.SendAsync` and swaps the handler to a permissive one, so it still works even when pinning is implemented in custom handlers. Run it after the app starts:
```bash
frida -U -l dist/xamarin-unpin.js com.target.app --no-pause
```
Kiolezo cha haraka cha hook managed methods kwa kutumia `frida-mono-api` iliyojumuishwa:
```javascript
const mono = require('frida-mono-api');
Mono.ensureInitialized();
Mono.enumerateLoadedImages().forEach(i => console.log(i.name));
const klass = Mono.classFromName("Namespace", "Class");
const m = Mono.methodFromName(klass, "Method", 2);
Mono.intercept(m, { onEnter(args){ console.log(args[1].toInt32()); } });
```
### Kusaini tena

Chombo [Uber APK Signer](https://github.com/patrickfav/uber-apk-signer) kinarahisisha kusaini APK nyingi kwa ufunguo uleule, na kinaweza kutumika kusaini tena app baada ya mabadiliko kufanywa ndani yake.

## Marejeo

- [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
- [https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/](https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/)
- [https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf](https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf)
- [https://github.com/jakev/pyxamstore](https://github.com/jakev/pyxamstore)
- [https://pypi.org/project/xamarout/](https://pypi.org/project/xamarout/)
- [https://github.com/GoSecure/frida-xamarin-unpin](https://github.com/GoSecure/frida-xamarin-unpin)
- [https://gist.github.com/Diefunction/e26fce039efcab57aac342a4b2d48ff6](https://gist.github.com/Diefunction/e26fce039efcab57aac342a4b2d48ff6)
- [https://reverseengineering.stackexchange.com/questions/31716/deobfuscating-ios-dll-file-i-think-arm64](https://reverseengineering.stackexchange.com/questions/31716/deobfuscating-ios-dll-file-i-think-arm64)

{{#include ../banners/hacktricks-training.md}}
