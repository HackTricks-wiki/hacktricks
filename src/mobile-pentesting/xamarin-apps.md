# Xamarin Apps

{{#include ../banners/hacktricks-training.md}}

## **Basic Information**

Xamarin je **open-source platforma** namenjena developerima da **prave aplikacije za iOS, Android i Windows** koristeći .NET i C# framework-e. Ova platforma omogućava pristup brojnim alatima i ekstenzijama za efikasno kreiranje modernih aplikacija.

### Xamarin's Architecture

- Za **Android**, Xamarin integriše Android i Java namespaces putem .NET bindings, radeći u okviru Mono execution environment zajedno sa Android Runtime (ART). Managed Callable Wrappers (MCW) i Android Callable Wrappers (ACW) olakšavaju komunikaciju između Mono i ART, koji su oba zasnovana na Linux kernelu.
- Za **iOS**, aplikacije se izvršavaju pod Mono runtime-om, koristeći potpunu Ahead of Time (AOT) kompilaciju da pretvore C# .NET kod u ARM assembly jezik. Ovaj proces radi paralelno sa Objective-C Runtime-om na UNIX-sličnom kernelu.

### .NET Runtime and Mono Framework

**.NET framework** uključuje assemblies, klase i namespaces za razvoj aplikacija, pri čemu .NET Runtime upravlja izvršavanjem koda. Pruža platformsku nezavisnost i kompatibilnost unazad. **Mono Framework** je open-source verzija .NET framework-a, započeta 2005. da proširi .NET na Linux, sada podržana od strane Microsoft-a i vođena od strane Xamarin-a.

### Reverse Engineering Xamarin Apps

#### Decompilation of Xamarin Assemblies

Decompilation pretvara kompajlirani kod nazad u izvorni kod. Na Windows-u, Modules window u Visual Studio može identifikovati module za dekompilaciju, omogućavajući direktan pristup kodu trećih strana i ekstrakciju izvornog koda za analizu.

#### JIT vs AOT Compilation

- **Android** podržava Just-In-Time (JIT) i Ahead-Of-Time (AOT) kompilaciju, sa Hybrid AOT režimom za optimalnu brzinu izvršavanja. Full AOT je ekskluzivan za Enterprise licence.
- **iOS** koristi isključivo AOT kompilaciju zbog Apple-ovih ograničenja na dinamičko izvršavanje koda.

### Extracting dll Files from APK/IPA

Da biste pristupili assemblies u APK/IPA, raspakujte fajl i pregledajte assemblies direktorijum. Za Android, alati kao [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) i [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) mogu dekompresovati dll fajlove.
```bash
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
U slučajevima kada se nakon dekompajliranja APK-a može videti folder unknown/assemblies/ sa `.dll` fajlovima unutra, moguće je koristiti [**dnSpy**](https://github.com/dnSpy/dnSpy) direktno nad `.dlls` za analizu. Međutim, ponekad se fajlovi `assemblies.blob` i `assemblies.manifest` nalaze u folderu unknown/assemblies/. Alat [pyxamstore](https://github.com/jakev/pyxamstore) može da raspakuje fajl `assemblies.blob` u Xamarin aplikacijama, omogućavajući pristup .NET assemblies za dalju analizu:
```bash
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
# After patching DLLs, rebuild the store
pyxamstore pack
```
Neki noviji Xamarin/MAUI buildovi smeštaju kompresovane assemblies koristeći **XALZ** format unutar `/assemblies.blob` ili `/resources/assemblies`. Možete ih brzo dekompresovati pomoću [xamarout](https://pypi.org/project/xamarout/) biblioteke:
```python
from xamarout import xalz
import os
for root, _, files in os.walk("."):
for f in files:
if open(os.path.join(root, f), 'rb').read(4) == b"XALZ":
xa = xalz.XamarinCompressedAssembly(os.path.join(root, f))
xa.write("decompressed/" + f)
```
iOS dll files are readily accessible for decompilation, revealing significant portions of the application code, which often shares a common base across different platforms.

> **AOT on iOS**: managed IL is compiled into native `*.aotdata.*` files. Patching the DLL alone will not change logic; you need to hook native stubs (e.g., with Frida) because the IL bodies are empty placeholders.

### Static Analysis

Kada su `.dll` fajlovi dobijeni, moguće je statički analizirati .Net kod koristeći alate kao što su [**dnSpy**](https://github.com/dnSpy/dnSpy) or [**ILSpy**](https://github.com/icsharpcode/ILSpy) koji omogućavaju izmenu koda aplikacije. Ovo može biti izuzetno korisno za izmene aplikacije radi zaobilaženja zaštita, na primer.\
Imajte na umu da nakon izmena aplikacije morate ponovo da je upakujete i ponovo potpišete.

> dnSpy je arhiviran; održavani forkovi kao što je **dnSpyEx** i dalje rade sa .NET 8/MAUI assemblies i čuvaju debug simbole prilikom ponovnog snimanja.

### Dynamic Analysis

Dinamička analiza obuhvata proveru za SSL pinning i korišćenje alata kao što je [Fridax](https://github.com/NorthwaveSecurity/fridax) za runtime modifications of the .NET binary in Xamarin apps. Frida scripts are available to bypass root detection or SSL pinning, enhancing analysis capabilities.

Other interesting Frida scripts:

- [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
- [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
- [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

Updated **Frida-xamarin-unpin** (Mono >=6) hooks `System.Net.Http.HttpClient.SendAsync` and swaps the handler to a permissive one, so it still works even when pinning is implemented in custom handlers. Run it after the app starts:
```bash
frida -U -l dist/xamarin-unpin.js com.target.app --no-pause
```
Kratki šablon za hook upravljanih metoda pomoću priloženog `frida-mono-api`:
```javascript
const mono = require('frida-mono-api');
Mono.ensureInitialized();
Mono.enumerateLoadedImages().forEach(i => console.log(i.name));
const klass = Mono.classFromName("Namespace", "Class");
const m = Mono.methodFromName(klass, "Method", 2);
Mono.intercept(m, { onEnter(args){ console.log(args[1].toInt32()); } });
```
### Ponovno potpisivanje

Alat [Uber APK Signer](https://github.com/patrickfav/uber-apk-signer) pojednostavljuje potpisivanje više APK fajlova istim ključem i može se koristiti za ponovno potpisivanje aplikacije nakon što su u nju unesene izmene.

## Referencije

- [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
- [https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/](https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/)
- [https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf](https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf)
- [https://github.com/jakev/pyxamstore](https://github.com/jakev/pyxamstore)
- [https://pypi.org/project/xamarout/](https://pypi.org/project/xamarout/)
- [https://github.com/GoSecure/frida-xamarin-unpin](https://github.com/GoSecure/frida-xamarin-unpin)
- [https://gist.github.com/Diefunction/e26fce039efcab57aac342a4b2d48ff6](https://gist.github.com/Diefunction/e26fce039efcab57aac342a4b2d48ff6)
- [https://reverseengineering.stackexchange.com/questions/31716/deobfuscating-ios-dll-file-i-think-arm64](https://reverseengineering.stackexchange.com/questions/31716/deobfuscating-ios-dll-file-i-think-arm64)

{{#include ../banners/hacktricks-training.md}}
