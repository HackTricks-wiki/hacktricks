# Xamarin Apps

{{#include ../banners/hacktricks-training.md}}

## **Información Básica**

Xamarin es una **plataforma de código abierto** diseñada para que los desarrolladores **crean aplicaciones para iOS, Android y Windows** utilizando los frameworks .NET y C#. Esta plataforma ofrece acceso a numerosas herramientas y extensiones para crear aplicaciones modernas de manera eficiente.

### Arquitectura de Xamarin

- Para **Android**, Xamarin se integra con los espacios de nombres de Android y Java a través de enlaces .NET, operando dentro del entorno de ejecución Mono junto con el Android Runtime (ART). Los Managed Callable Wrappers (MCW) y Android Callable Wrappers (ACW) facilitan la comunicación entre Mono y ART, ambos construidos sobre el núcleo de Linux.
- Para **iOS**, las aplicaciones se ejecutan bajo el entorno de ejecución Mono, utilizando una compilación completa Ahead of Time (AOT) para convertir el código C# .NET en lenguaje ensamblador ARM. Este proceso se ejecuta junto con el Objective-C Runtime en un núcleo similar a UNIX.

### Entorno de Ejecución .NET y Framework Mono

El **framework .NET** incluye ensamblados, clases y espacios de nombres para el desarrollo de aplicaciones, con el .NET Runtime gestionando la ejecución del código. Ofrece independencia de plataforma y compatibilidad hacia atrás. El **Framework Mono** es una versión de código abierto del framework .NET, iniciada en 2005 para extender .NET a Linux, ahora respaldada por Microsoft y liderada por Xamarin.

### Ingeniería Inversa de Aplicaciones Xamarin

#### Decompilación de Ensamblados Xamarin

La decompilación transforma el código compilado de nuevo en código fuente. En Windows, la ventana de Módulos en Visual Studio puede identificar módulos para decompilación, permitiendo el acceso directo al código de terceros y la extracción del código fuente para análisis.

#### Compilación JIT vs AOT

- **Android** soporta la compilación Just-In-Time (JIT) y Ahead-Of-Time (AOT), con un modo híbrido AOT para una velocidad de ejecución óptima. La AOT completa es exclusiva para licencias Enterprise.
- **iOS** emplea únicamente la compilación AOT debido a las restricciones de Apple sobre la ejecución de código dinámico.

### Extracción de archivos dll de APK/IPA

Para acceder a los ensamblados en un APK/IPA, descomprime el archivo y explora el directorio de ensamblados. Para Android, herramientas como [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) y [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) pueden descomprimir archivos dll.
```bash
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
En casos donde después de descompilar el APK es posible ver la carpeta unknown/assemblies/ con los archivos `.dll` dentro, es posible usar [**dnSpy**](https://github.com/dnSpy/dnSpy) directamente sobre los `.dll` para analizarlos.\
Sin embargo, a veces se encuentran los archivos `assemblies.blob` y `assemblies.manifest` dentro de la carpeta unknown/assemblies/. La herramienta [pyxamstore](https://github.com/jakev/pyxamstore) se puede usar para descomprimir el archivo `assemblies.blob` en aplicaciones Xamarin, permitiendo el acceso a los ensamblajes .NET para un análisis posterior:
```bash
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
Los archivos .dll de iOS son fácilmente accesibles para la descompilación, revelando porciones significativas del código de la aplicación, que a menudo comparte una base común en diferentes plataformas.

### Análisis Estático

Una vez que se obtienen los `.dll`, es posible analizar el código .Net de forma estática utilizando herramientas como [**dnSpy**](https://github.com/dnSpy/dnSpy) **o** [**ILSpy**](https://github.com/icsharpcode/ILSpy) **que** permitirán modificar el código de la aplicación. Esto puede ser muy útil para manipular la aplicación y eludir protecciones, por ejemplo.\
Ten en cuenta que después de modificar la aplicación necesitarás empaquetarla nuevamente y firmarla de nuevo.

### Análisis Dinámico

El análisis dinámico implica verificar el pinning de SSL y utilizar herramientas como [Fridax](https://github.com/NorthwaveSecurity/fridax) para modificaciones en tiempo de ejecución del binario .NET en aplicaciones Xamarin. Los scripts de Frida están disponibles para eludir la detección de root o el pinning de SSL, mejorando las capacidades de análisis.

Otros scripts de Frida interesantes:

- [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
- [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
- [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

### Re-firmado

La herramienta [Uber APK Signer](https://github.com/patrickfav/uber-apk-signer) simplifica la firma de múltiples APKs con la misma clave, y se puede utilizar para volver a firmar una aplicación después de que se hayan realizado cambios en ella.

## Más información

- [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
- [https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/](https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/)
- [https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf](https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf)

{{#include ../banners/hacktricks-training.md}}
