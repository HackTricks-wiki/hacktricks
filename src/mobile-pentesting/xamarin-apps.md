# Applications Xamarin

{{#include ../banners/hacktricks-training.md}}

## **Informations de base**

Xamarin est une **plateforme open-source** conçue pour permettre aux développeurs de **créer des applications pour iOS, Android et Windows** en utilisant les frameworks .NET et C#. Cette plateforme offre un accès à de nombreux outils et extensions pour créer des applications modernes de manière efficace.

### Architecture de Xamarin

- Pour **Android**, Xamarin s'intègre avec les espaces de noms Android et Java via des liaisons .NET, fonctionnant dans l'environnement d'exécution Mono aux côtés de l'Android Runtime (ART). Les Managed Callable Wrappers (MCW) et les Android Callable Wrappers (ACW) facilitent la communication entre Mono et ART, tous deux basés sur le noyau Linux.
- Pour **iOS**, les applications s'exécutent sous l'environnement d'exécution Mono, utilisant une compilation complète Ahead of Time (AOT) pour convertir le code C# .NET en langage d'assemblage ARM. Ce processus fonctionne aux côtés de l'Objective-C Runtime sur un noyau de type UNIX.

### Environnement d'exécution .NET et Framework Mono

Le **framework .NET** comprend des assemblies, des classes et des espaces de noms pour le développement d'applications, avec l'environnement d'exécution .NET gérant l'exécution du code. Il offre une indépendance de la plateforme et une compatibilité ascendante. Le **Framework Mono** est une version open-source du framework .NET, initiée en 2005 pour étendre .NET à Linux, maintenant soutenue par Microsoft et dirigée par Xamarin.

### Ingénierie inverse des applications Xamarin

#### Décompilation des assemblies Xamarin

La décompilation transforme le code compilé en code source. Dans Windows, la fenêtre Modules dans Visual Studio peut identifier les modules pour la décompilation, permettant un accès direct au code tiers et l'extraction du code source pour analyse.

#### Compilation JIT vs AOT

- **Android** prend en charge la compilation Just-In-Time (JIT) et Ahead-Of-Time (AOT), avec un mode hybride AOT pour une vitesse d'exécution optimale. La compilation complète AOT est exclusive aux licences Enterprise.
- **iOS** utilise uniquement la compilation AOT en raison des restrictions d'Apple sur l'exécution de code dynamique.

### Extraction de fichiers dll à partir d'APK/IPA

Pour accéder aux assemblies dans un APK/IPA, décompressez le fichier et explorez le répertoire des assemblies. Pour Android, des outils comme [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) et [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) peuvent décompresser les fichiers dll.
```bash
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Dans les cas où, après avoir décompilé l'APK, il est possible de voir le dossier unknown/assemblies/ avec les fichiers `.dll` à l'intérieur, il est donc possible d'utiliser [**dnSpy**](https://github.com/dnSpy/dnSpy) directement sur les `.dll` pour les analyser.\
Cependant, parfois, on trouve les fichiers `assemblies.blob` et `assemblies.manifest` à l'intérieur du dossier unknown/assemblies/. L'outil [pyxamstore](https://github.com/jakev/pyxamstore) peut être utilisé pour décompresser le fichier `assemblies.blob` dans les applications Xamarin, permettant l'accès aux assemblies .NET pour une analyse plus approfondie :
```bash
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
Les fichiers .dll iOS sont facilement accessibles pour la décompilation, révélant des portions significatives du code de l'application, qui partagent souvent une base commune à travers différentes plateformes.

### Analyse statique

Une fois les `.dll` obtenues, il est possible d'analyser le code .Net de manière statique en utilisant des outils tels que [**dnSpy**](https://github.com/dnSpy/dnSpy) **ou** [**ILSpy**](https://github.com/icsharpcode/ILSpy) **qui** permettront de modifier le code de l'application. Cela peut être très utile pour altérer l'application afin de contourner les protections, par exemple.\
Notez qu'après avoir modifié l'application, vous devrez la reconditionner et la signer à nouveau.

### Analyse dynamique

L'analyse dynamique implique de vérifier le SSL pinning et d'utiliser des outils comme [Fridax](https://github.com/NorthwaveSecurity/fridax) pour des modifications en temps réel du binaire .NET dans les applications Xamarin. Des scripts Frida sont disponibles pour contourner la détection de root ou le SSL pinning, améliorant ainsi les capacités d'analyse.

Autres scripts Frida intéressants :

- [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
- [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
- [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

### Resignature

L'outil [Uber APK Signer](https://github.com/patrickfav/uber-apk-signer) simplifie la signature de plusieurs APK avec la même clé et peut être utilisé pour resignature une application après y avoir apporté des modifications.

## Informations supplémentaires

- [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
- [https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/](https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/)
- [https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf](https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf)

{{#include ../banners/hacktricks-training.md}}
