# Xamarin Uygulamaları

{{#include ../banners/hacktricks-training.md}}

## **Temel Bilgiler**

Xamarin, geliştiricilerin .NET ve C# framework'lerini kullanarak iOS, Android ve Windows için uygulamalar oluşturmasını sağlayan açık kaynaklı bir platformdur. Bu platform, modern uygulamaları verimli şekilde oluşturmak için çok sayıda araç ve eklentiye erişim sunar.

### Xamarin'ın Mimarisi

- **Android** için Xamarin, .NET binding'leri aracılığıyla Android ve Java namespace'leriyle bütünleşir; Mono yürütme ortamı içinde Android Runtime (ART) ile birlikte çalışır. Managed Callable Wrappers (MCW) ve Android Callable Wrappers (ACW), Mono ile ART arasındaki iletişimi kolaylaştırır; her ikisi de Linux çekirdeği üzerinde çalışır.
- **iOS** için uygulamalar Mono runtime altında çalışır ve C# .NET kodunu ARM assembly diline dönüştürmek için tam Ahead of Time (AOT) derleme kullanılır. Bu süreç, Objective-C Runtime ile birlikte UNIX-benzeri bir çekirdek üzerinde çalışır.

### .NET Runtime ve Mono Framework

.NET framework, uygulama geliştirme için assembly'ler, sınıflar ve namespace'ler içerir; .NET Runtime ise kod yürütmeyi yönetir. Platform bağımsızlığı ve geriye dönük uyumluluk sunar. Mono Framework, .NET framework'ünün açık kaynaklı bir sürümüdür; 2005'te .NET'i Linux'a taşımak amacıyla başlatılmıştır, şu anda Microsoft tarafından desteklenmekte ve Xamarin tarafından yönetilmektedir.

### Xamarin Uygulamalarının Tersine Mühendisliği

#### Xamarin Assembly'lerinin Decompilasyonu

Decompilation, derlenmiş kodu kaynak koda geri dönüştürme işlemidir. Windows'ta Visual Studio'daki Modules penceresi, decompilation için modülleri belirleyebilir; bu, üçüncü taraf koda doğrudan erişim ve analiz için kaynak kodunun çıkarılmasını sağlar.

#### JIT vs AOT Derleme

- **Android**, Just-In-Time (JIT) ve Ahead-Of-Time (AOT) derlemeyi destekler; optimal yürütme hızı için Hybrid AOT modu mevcuttur. Tam AOT yalnızca Enterprise lisanslarında mevcuttur.
- **iOS**, Apple'ın dinamik kod yürütme kısıtlamaları nedeniyle yalnızca AOT derleme kullanır.

### APK/IPA'den dll Dosyalarının Çıkarılması

APK/IPA içindeki assembly'lere erişmek için dosyayı unzip edip assemblies dizinini inceleyin. Android için [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) ve [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress) gibi araçlar dll dosyalarını açabilir.
```bash
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
APK'yi decompile ettikten sonra unknown/assemblies/ klasörünü içinde `.dll` dosyaları görmek mümkünse, bu `.dlls` üzerinde doğrudan [**dnSpy**](https://github.com/dnSpy/dnSpy) kullanarak analiz yapmak mümkündür. Ancak bazen unknown/assemblies/ klasöründe `assemblies.blob` ve `assemblies.manifest` dosyaları bulunur. [pyxamstore](https://github.com/jakev/pyxamstore) aracı, Xamarin uygulamalarında `assemblies.blob` dosyasını açarak .NET assembly'lerine erişim sağlar ve bunların daha fazla analiz edilmesine olanak verir:
```bash
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
# After patching DLLs, rebuild the store
pyxamstore pack
```
Bazı yeni Xamarin/MAUI build'leri, sıkıştırılmış assemblies dosyalarını **XALZ** formatında `/assemblies.blob` veya `/resources/assemblies` içinde saklar. Bunları [xamarout](https://pypi.org/project/xamarout/) kütüphanesi ile hızlıca açabilirsiniz:
```python
from xamarout import xalz
import os
for root, _, files in os.walk("."):
for f in files:
if open(os.path.join(root, f), 'rb').read(4) == b"XALZ":
xa = xalz.XamarinCompressedAssembly(os.path.join(root, f))
xa.write("decompressed/" + f)
```
iOS dll files are readily accessible for decompilation, revealing significant portions of the application code, which often shares a common base across different platforms.

> **AOT on iOS**: managed IL is compiled into native `*.aotdata.*` files. Patching the DLL alone will not change logic; you need to hook native stubs (e.g., with Frida) because the IL bodies are empty placeholders.

### Statik Analiz

Elde edilen `.dll`'ler alındıktan sonra, uygulamanın .Net kodunu statik olarak [**dnSpy**](https://github.com/dnSpy/dnSpy) veya [**ILSpy**](https://github.com/icsharpcode/ILSpy) gibi araçlarla analiz etmek ve uygulama kodunu değiştirmek mümkündür. Bu, örneğin korumaları atlamak için uygulamayı manipüle etmekte çok faydalı olabilir.\
Uygulamayı değiştirdikten sonra tekrar paketleyip yeniden imzalamanız gerektiğini unutmayın.

> dnSpy is archived; maintained forks like **dnSpyEx** keep working with .NET 8/MAUI assemblies and preserve debug symbols when re-saving.

### Dinamik Analiz

Dinamik analiz, SSL pinning'i kontrol etmeyi ve Xamarin uygulamalarında .NET ikilisinin runtime modifikasyonu için [Fridax](https://github.com/NorthwaveSecurity/fridax) gibi araçları kullanmayı içerir. Frida scriptleri, root tespitini veya SSL pinning'i atlamak için mevcuttur ve analiz yeteneklerini artırır.

Other interesting Frida scripts:

- [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
- [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
- [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

Updated **Frida-xamarin-unpin** (Mono >=6) hooks `System.Net.Http.HttpClient.SendAsync` and swaps the handler to a permissive one, so it still works even when pinning is implemented in custom handlers. Run it after the app starts:
```bash
frida -U -l dist/xamarin-unpin.js com.target.app --no-pause
```
Birlikte gelen `frida-mono-api` ile yönetilen metotları hook etmek için hızlı şablon:
```javascript
const mono = require('frida-mono-api');
Mono.ensureInitialized();
Mono.enumerateLoadedImages().forEach(i => console.log(i.name));
const klass = Mono.classFromName("Namespace", "Class");
const m = Mono.methodFromName(klass, "Method", 2);
Mono.intercept(m, { onEnter(args){ console.log(args[1].toInt32()); } });
```
### Yeniden İmzalama

Araç [Uber APK Signer](https://github.com/patrickfav/uber-apk-signer), aynı anahtar kullanılarak birden fazla APK'nin imzalanmasını kolaylaştırır ve yapılan değişikliklerden sonra uygulamayı yeniden imzalamak için kullanılabilir.

## Kaynaklar

- [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
- [https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/](https://thecobraden.com/posts/unpacking_xamarin_assembly_stores/)
- [https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf](https://medium.com/@justmobilesec/introduction-to-the-exploitation-of-xamarin-apps-fde4619a51bf)
- [https://github.com/jakev/pyxamstore](https://github.com/jakev/pyxamstore)
- [https://pypi.org/project/xamarout/](https://pypi.org/project/xamarout/)
- [https://github.com/GoSecure/frida-xamarin-unpin](https://github.com/GoSecure/frida-xamarin-unpin)
- [https://gist.github.com/Diefunction/e26fce039efcab57aac342a4b2d48ff6](https://gist.github.com/Diefunction/e26fce039efcab57aac342a4b2d48ff6)
- [https://reverseengineering.stackexchange.com/questions/31716/deobfuscating-ios-dll-file-i-think-arm64](https://reverseengineering.stackexchange.com/questions/31716/deobfuscating-ios-dll-file-i-think-arm64)

{{#include ../banners/hacktricks-training.md}}
