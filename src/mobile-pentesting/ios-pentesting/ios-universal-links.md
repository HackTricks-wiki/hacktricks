# iOS Universal Links

{{#include ../../banners/hacktricks-training.md}}

## Einführung

Universal Links bieten eine **nahtlose Weiterleitung** für Benutzer, indem sie Inhalte direkt in der App öffnen und die Notwendigkeit einer Weiterleitung über Safari umgehen. Diese Links sind **einzigartig** und sicher, da sie nicht von anderen Apps beansprucht werden können. Dies wird sichergestellt, indem eine `apple-app-site-association` JSON-Datei im Stammverzeichnis der Website gehostet wird, die eine überprüfbare Verbindung zwischen der Website und der App herstellt. In Fällen, in denen die App nicht installiert ist, übernimmt Safari und leitet den Benutzer zur Webseite weiter, wodurch die Präsenz der App erhalten bleibt.

Für Penetrationstester ist die `apple-app-site-association`-Datei von besonderem Interesse, da sie **sensible Pfade** offenbaren kann, die möglicherweise mit nicht veröffentlichten Funktionen in Zusammenhang stehen.

### **Analyse der Associated Domains Berechtigung**

Entwickler aktivieren Universal Links, indem sie die **Associated Domains** im Tab "Capabilities" von Xcode konfigurieren oder die `.entitlements`-Datei überprüfen. Jede Domain wird mit `applinks:` vorangestellt. Zum Beispiel könnte die Konfiguration von Telegram wie folgt aussehen:
```xml
<key>com.apple.developer.associated-domains</key>
<array>
<string>applinks:telegram.me</string>
<string>applinks:t.me</string>
</array>
```
Für umfassendere Einblicke, siehe die [archivierte Apple Developer Dokumentation](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW2).

Wenn mit einer kompilierten Anwendung gearbeitet wird, können Berechtigungen wie in [diesem Leitfaden](extracting-entitlements-from-compiled-application.md) beschrieben extrahiert werden.

### **Abrufen der Apple App Site Association Datei**

Die `apple-app-site-association` Datei sollte vom Server unter Verwendung der in den Berechtigungen angegebenen Domains abgerufen werden. Stellen Sie sicher, dass die Datei direkt über HTTPS unter `https://<domain>/apple-app-site-association` zugänglich ist. Tools wie der [Apple App Site Association (AASA) Validator](https://branch.io/resources/aasa-validator/) können bei diesem Prozess helfen.

### **Verarbeiten von Universal Links in der App**

Die App muss spezifische Methoden implementieren, um Universal Links korrekt zu verarbeiten. Die primäre Methode, nach der gesucht werden muss, ist [`application:continueUserActivity:restorationHandler:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623072-application). Es ist entscheidend, dass das Schema der verarbeiteten URLs HTTP oder HTTPS ist, da andere nicht unterstützt werden.

#### **Validierung der Datenhandler-Methode**

Wenn ein Universal Link eine App öffnet, wird ein `NSUserActivity` Objekt mit der URL an die App übergeben. Bevor diese URL verarbeitet wird, ist es wichtig, sie zu validieren und zu bereinigen, um Sicherheitsrisiken zu vermeiden. Hier ist ein Beispiel in Swift, das den Prozess demonstriert:
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity,
restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
// Check for web browsing activity and valid URL
if userActivity.activityType == NSUserActivityTypeBrowsingWeb, let url = userActivity.webpageURL {
application.open(url, options: [:], completionHandler: nil)
}

return true
}
```
URLs sollten sorgfältig analysiert und validiert werden, insbesondere wenn sie Parameter enthalten, um sich gegen potenzielles Spoofing oder fehlerhafte Daten abzusichern. Die `NSURLComponents` API ist dafür nützlich, wie unten gezeigt:
```swift
func application(_ application: UIApplication,
continue userActivity: NSUserActivity,
restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
guard userActivity.activityType == NSUserActivityTypeBrowsingWeb,
let incomingURL = userActivity.webpageURL,
let components = NSURLComponents(url: incomingURL, resolvingAgainstBaseURL: true),
let path = components.path,
let params = components.queryItems else {
return false
}

if let albumName = params.first(where: { $0.name == "albumname" })?.value,
let photoIndex = params.first(where: { $0.name == "index" })?.value {
// Process the URL with album name and photo index

return true

} else {
// Handle invalid or missing parameters

return false
}
}
```
Durch **sorgfältige Konfiguration und Validierung** können Entwickler sicherstellen, dass universelle Links die Benutzererfahrung verbessern und gleichzeitig Sicherheits- und Datenschutzstandards einhalten.

## Tools

- [GetUniversal.link](https://getuniversal.link/): Hilft dabei, das Testen und Verwalten der universellen Links und der AASA-Datei Ihrer App zu vereinfachen. Geben Sie einfach Ihre Domain ein, um die Integrität der AASA-Datei zu überprüfen, oder verwenden Sie das benutzerdefinierte Dashboard, um das Linkverhalten einfach zu testen. Dieses Tool hilft Ihnen auch zu bestimmen, wann Apple Ihre AASA-Datei das nächste Mal indizieren wird.

## References

- [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis)
- [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8)

{{#include ../../banners/hacktricks-training.md}}
