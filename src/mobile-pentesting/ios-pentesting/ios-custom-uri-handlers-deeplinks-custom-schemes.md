# iOS Custom URI Handlers / Deeplinks / Custom Schemes

{{#include ../../banners/hacktricks-training.md}}

## Basic Information

Custom URL schemes zinawezesha programu kuwasiliana kwa kutumia protokali maalum, kama ilivyoelezwa katika [Apple Developer Documentation](https://developer.apple.com/library/content/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/Inter-AppCommunication/Inter-AppCommunication.html#//apple_ref/doc/uid/TP40007072-CH6-SW1). Mipango hii lazima itangazwe na programu, ambayo kisha inashughulikia URL zinazokuja kufuata mipango hiyo. Ni muhimu **kuhakiki vigezo vyote vya URL** na **kukatisha URL zozote zisizo sahihi** ili kuzuia mashambulizi kupitia njia hii.

Mfano unatolewa ambapo URI `myapp://hostname?data=123876123` inachochea kitendo maalum cha programu. Uthibitisho wa udhaifu ulipatikana katika programu ya Skype Mobile, ambayo iliruhusu vitendo vya simu visivyo ruhusiwa kupitia protokali ya `skype://`. Mipango iliyosajiliwa inaweza kupatikana katika `Info.plist` ya programu chini ya `CFBundleURLTypes`. Programu zenye nia mbaya zinaweza kutumia hii kwa kujiandikisha tena URIs ili kukamata taarifa nyeti.

### Application Query Schemes Registration

Kuanzia iOS 9.0, ili kuangalia kama programu inapatikana, `canOpenURL:` inahitaji kutangaza mipango ya URL katika `Info.plist` chini ya `LSApplicationQueriesSchemes`. Hii inapunguza mipango ambayo programu inaweza kuuliza hadi 50, ikiongeza faragha kwa kuzuia orodha ya programu.
```xml
<key>LSApplicationQueriesSchemes</key>
<array>
<string>url_scheme1</string>
<string>url_scheme2</string>
</array>
```
### Kupima Usimamizi wa URL na Uthibitishaji

Wakuu wa programu wanapaswa kuchunguza mbinu maalum katika msimbo wa chanzo ili kuelewa ujenzi wa njia za URL na uthibitishaji, kama vile `application:didFinishLaunchingWithOptions:` na `application:openURL:options:`. Kwa mfano, Telegram inatumia mbinu mbalimbali za kufungua URL:
```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ application: UIApplication, open url: URL, sourceApplication: String?,
annotation: Any) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ app: UIApplication, open url: URL,
options: [UIApplicationOpenURLOptionsKey : Any] = [:]) -> Bool {
self.openUrl(url: url)
return true
}

func application(_ application: UIApplication, handleOpen url: URL) -> Bool {
self.openUrl(url: url)
return true
}
```
### Kupima Maombi ya URL kwa Programu Nyingine

Mbinu kama `openURL:options:completionHandler:` ni muhimu kwa kufungua URL ili kuingiliana na programu nyingine. Kutambua matumizi ya mbinu kama hizo katika msimbo wa chanzo wa programu ni muhimu kwa kuelewa mawasiliano ya nje.

### Kupima Mbinu Zilizopitwa na Wakati

Mbinu zilizopitwa na wakati zinazoshughulikia ufunguzi wa URL, kama `application:handleOpenURL:` na `openURL:`, zinapaswa kutambuliwa na kupitia kwa athari za usalama.

### Fuzzing ya Mifumo ya URL

Fuzzing ya mifumo ya URL inaweza kutambua makosa ya uharibifu wa kumbukumbu. Zana kama [Frida](https://codeshare.frida.re/@dki/ios-url-scheme-fuzzing/) zinaweza kuendesha mchakato huu kwa kufungua URL zenye mzigo tofauti ili kufuatilia ajali, kama inavyoonyeshwa na udanganyifu wa URL katika programu ya iGoat-Swift:
```bash
$ frida -U SpringBoard -l ios-url-scheme-fuzzing.js
[iPhone::SpringBoard]-> fuzz("iGoat", "iGoat://?contactNumber={0}&message={0}")
Watching for crashes from iGoat...
No logs were moved.
Opened URL: iGoat://?contactNumber=0&message=0
```
## Utekelezaji wa hijacking wa mpango wa URL wa kawaida

Kulingana na [**hiki kipande**](https://evanconnelly.github.io/post/ios-oauth/), programu mbaya zinaweza **kujiandikisha mipango ya kawaida ya programu nyingine,** kisha programu mbaya inaweza kufungua kivinjari ambacho kina vidakuzi vyote vya Programu ya Safari na [ASWebAuthenticationSession](https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession/2990952-init#parameters).&#x20;

Kwa kivinjari, programu mbaya inaweza kupakia ukurasa wa wavuti unaodhibitiwa na mshambuliaji na TCC itauliza mtumiaji wa simu ruhusa za kufungua programu hiyo. Kisha, ukurasa wa wavuti mbaya unaweza kuelekeza kwenye ukurasa wa mwathirika, kwa mfano mtiririko wa OAuth na parameter `prompt=none`. Ikiwa mtumiaji tayari alikuwa amejiandikisha katika mtiririko wa OAuth, mtiririko wa OAuth utatuma siri nyuma kwa programu ya mwathirika kwa kutumia mpango wa kawaida wa programu ya mwathirika.\
Hata hivyo, kwa sababu programu mbaya pia iliandikishwa na kwa sababu kivinjari kilichotumika kiko ndani ya programu mbaya, mpango wa kawaida utashughulikiwa katika kesi hii na programu mbaya ambayo itakuwa na uwezo wa kuiba token ya OAuth.

## Marejeo

- [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0075/](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0075/)
- [https://evanconnelly.github.io/post/ios-oauth/](https://evanconnelly.github.io/post/ios-oauth/)

{{#include ../../banners/hacktricks-training.md}}
