# 2049 - Pentesting Servicio NFS

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

* 驴Trabajas en una **empresa de ciberseguridad**? 驴Quieres ver tu **empresa anunciada en HackTricks**? 驴O quieres tener acceso a la **煤ltima versi贸n del PEASS o descargar HackTricks en PDF**? 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **nete al** [****](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## **Informaci贸n B谩sica**

**NFS** es un sistema dise帽ado para **cliente/servidor** que permite a los usuarios acceder sin problemas a archivos a trav茅s de una red como si estos archivos estuvieran ubicados dentro de un directorio local.

Un aspecto notable de este protocolo es su falta de **mecanismos de autenticaci贸n** o **autorizaci贸n integrados**. En su lugar, la autorizaci贸n se basa en **informaci贸n del sistema de archivos**, siendo el servidor el encargado de traducir con precisi贸n la **informaci贸n de usuario proporcionada por el cliente** al formato de **autorizaci贸n requerido por el sistema de archivos**, siguiendo principalmente la **sintaxis UNIX**.

La autenticaci贸n com煤nmente se basa en **identificadores de `UID`/`GID` de UNIX y pertenencias a grupos**. Sin embargo, surge un desaf铆o debido a la posible falta de coincidencia en **mapeos de `UID`/`GID`** entre clientes y servidores, lo que no deja espacio para verificaci贸n adicional por parte del servidor. En consecuencia, el protocolo es m谩s adecuado para su uso dentro de **redes de confianza**, dada su dependencia en este m茅todo de autenticaci贸n.

**Puerto predeterminado**: 2049/TCP/UDP (excepto la versi贸n 4, que solo necesita TCP o UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Versiones

- **NFSv2**: Esta versi贸n es reconocida por su amplia compatibilidad con varios sistemas, marcando su importancia con operaciones iniciales predominantemente sobre UDP. Siendo la **m谩s antigua** de la serie, sent贸 las bases para futuros desarrollos.

- **NFSv3**: Introducida con una serie de mejoras, NFSv3 ampli贸 a su predecesora al admitir tama帽os de archivo variables y ofrecer mecanismos mejorados de informe de errores. A pesar de sus avances, enfrent贸 limitaciones en la plena compatibilidad con clientes NFSv2.

- **NFSv4**: Una versi贸n emblem谩tica en la serie NFS, NFSv4 present贸 una serie de caracter铆sticas dise帽adas para modernizar el intercambio de archivos en redes. Las mejoras notables incluyen la integraci贸n de Kerberos para **alta seguridad**, la capacidad de atravesar firewalls y operar a trav茅s de Internet sin necesidad de mapeadores de puertos, soporte para Listas de Control de Acceso (ACLs) y la introducci贸n de operaciones basadas en estado. Sus mejoras de rendimiento y la adopci贸n de un protocolo con estado distinguen a NFSv4 como un avance fundamental en las tecnolog铆as de intercambio de archivos en red.

Cada versi贸n de NFS ha sido desarrollada con la intenci贸n de abordar las necesidades en evoluci贸n de los entornos de red, mejorando progresivamente la seguridad, la compatibilidad y el rendimiento.

## Enumeraci贸n

### Scripts 煤tiles de nmap
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### M贸dulos 煤tiles de Metasploit
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montaje

Para saber **qu茅 carpeta** tiene el servidor **disponible** para montar, puedes preguntarle usando:
```bash
showmount -e <IP>
```
Luego montarlo usando:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Debes especificar **usar la versi贸n 2** porque no tiene **ninguna** **autenticaci贸n** ni **autorizaci贸n**.

**Ejemplo:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permisos

Si montas una carpeta que contiene **archivos o carpetas solo accesibles por alg煤n usuario** (por **UID**). Puedes **crear** **localmente** un usuario con ese **UID** y usando ese **usuario** podr谩s **acceder** al archivo/carpeta.

## NSFShell

Para listar, montar y cambiar el UID y GID f谩cilmente para tener acceso a los archivos, puedes usar [nfsshell](https://github.com/NetDirect/nfsshell).

[隆Tutorial 煤til de NFSShell!](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Archivos de configuraci贸n
```
/etc/exports
/etc/lib/nfs/etab
```
### Configuraciones peligrosas

- **Permisos de Lectura y Escritura (`rw`):** Esta configuraci贸n permite tanto la lectura como la escritura en el sistema de archivos. Es esencial considerar las implicaciones de otorgar un acceso tan amplio.

- **Uso de Puertos Inseguros (`insecure`):** Cuando est谩 habilitado, esto permite que el sistema utilice puertos por encima de 1024. La seguridad de los puertos por encima de este rango puede ser menos estricta, aumentando el riesgo.

- **Visibilidad de Sistemas de Archivos Anidados (`nohide`):** Esta configuraci贸n hace que los directorios sean visibles incluso si otro sistema de archivos est谩 montado debajo de un directorio exportado. Cada directorio requiere su propia entrada de exportaci贸n para una gesti贸n adecuada.

- **Propietario de Archivos Ra铆z (`no_root_squash`):** Con esta configuraci贸n, los archivos creados por el usuario root mantienen su UID/GID original de 0, ignorando el principio de privilegio m铆nimo y potencialmente otorgando permisos excesivos.

- **No Anulaci贸n de Todos los Usuarios (`no_all_squash`):** Esta opci贸n asegura que las identidades de usuario se conserven en todo el sistema, lo que podr铆a provocar problemas de permisos y control de acceso si no se manejan correctamente.

## Escalada de privilegios utilizando configuraciones incorrectas de NFS

[Escalada de privilegios de NFS no\_root\_squash y no\_all\_squash](../linux-hardening/privilege-escalation/nfs-no\_root_squash-misconfiguration-pe.md)

## Comandos autom谩ticos de HackTricks
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
<details>

<summary><strong>Aprende a hackear AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

* 驴Trabajas en una **empresa de ciberseguridad**? 驴Quieres ver tu **empresa anunciada en HackTricks**? 驴O quieres tener acceso a la **煤ltima versi贸n del PEASS o descargar HackTricks en PDF**? 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **nete al** [****](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
