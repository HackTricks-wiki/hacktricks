# 9200 - Pentesting Elasticsearch

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n b치sica

Elasticsearch es un motor de b칰squeda y an치lisis **distribuido**, de **c칩digo abierto** para **todo tipo de datos**. Es conocido por su **velocidad**, **escalabilidad** y **API REST simple**. Construido sobre Apache Lucene, fue lanzado por primera vez en 2010 por Elasticsearch N.V. (ahora conocido como Elastic). Elasticsearch es el componente central de Elastic Stack, una colecci칩n de herramientas de c칩digo abierto para ingesti칩n, enriquecimiento, almacenamiento, an치lisis y visualizaci칩n de datos. Esta pila, com칰nmente conocida como ELK Stack, tambi칠n incluye Logstash y Kibana, y ahora tiene agentes de env칤o de datos ligeros llamados Beats.

### 쯈u칠 es un 칤ndice de Elasticsearch?

Un **칤ndice de Elasticsearch** es una colecci칩n de **documentos relacionados** almacenados como **JSON**. Cada documento consta de **claves** y sus correspondientes **valores** (cadenas, n칰meros, booleanos, fechas, matrices, geolocalizaciones, etc.).

Elasticsearch utiliza una estructura de datos eficiente llamada **칤ndice invertido** para facilitar b칰squedas de texto completo r치pidas. Este 칤ndice lista cada palabra 칰nica en los documentos e identifica los documentos en los que aparece cada palabra.

Durante el proceso de indexaci칩n, Elasticsearch almacena los documentos y construye el 칤ndice invertido, lo que permite b칰squedas casi en tiempo real. El **API de 칤ndice** se utiliza para agregar o actualizar documentos JSON dentro de un 칤ndice espec칤fico.

**Puerto predeterminado**: 9200/tcp

## Enumeraci칩n manual

### Banner

El protocolo utilizado para acceder a Elasticsearch es **HTTP**. Cuando accedes a 칠l a trav칠s de HTTP, encontrar치s informaci칩n interesante: `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Si no ves esa respuesta al acceder a `/`, consulta la siguiente secci칩n.

### Autenticaci칩n

**Por defecto, Elasticsearch no tiene la autenticaci칩n habilitada**, por lo que por defecto puedes acceder a todo dentro de la base de datos sin usar credenciales.

Puedes verificar que la autenticaci칩n est치 deshabilitada con una solicitud a:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Sin embargo**, si env칤as una solicitud a `/` y recibes una respuesta como la siguiente:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Esto significa que la autenticaci칩n est치 configurada y **necesitas credenciales v치lidas** para obtener informaci칩n de Elasticsearch. Luego, puedes [**intentar hacer fuerza bruta**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (utiliza autenticaci칩n b치sica HTTP, por lo que cualquier herramienta de fuerza bruta para autenticaci칩n b치sica HTTP puede ser utilizada).\
Aqu칤 tienes una **lista de nombres de usuario predeterminados**: _**elastic** (superusuario), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Las versiones antiguas de Elasticsearch tienen la contrase침a predeterminada **changeme** para este usuario.
```
curl -X GET http://user:password@IP:9200/
```
### Enumeraci칩n b치sica de usuarios
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Informaci칩n de Elastic

Aqu칤 hay algunos puntos finales a los que puedes **acceder mediante GET** para **obtener** informaci칩n sobre elasticsearch:

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Estos puntos finales fueron [**tomados de la documentaci칩n**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) donde puedes **encontrar m치s**.\
Adem치s, si accedes a `/_cat`, la respuesta contendr치 los puntos finales `/_cat/*` admitidos por la instancia.

En `/_security/user` (si la autenticaci칩n est치 habilitada) puedes ver qu칠 usuario tiene el rol `superuser`.

### 칈ndices

Puedes **recopilar todos los 칤ndices** accediendo a `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Para obtener **informaci칩n sobre qu칠 tipo de datos se guardan dentro de un 칤ndice** puedes acceder a: `http://host:9200/<index>` por ejemplo en este caso `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Volcar 칤ndice

Si deseas **volcar todo el contenido** de un 칤ndice puedes acceder a: `http://host:9200/<index>/_search?pretty=true` como en `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_T칩mate un momento para comparar el contenido de cada documento (entrada) dentro del 칤ndice bank y los campos de este 칤ndice que vimos en la secci칩n anterior._

Entonces, en este punto puedes notar que **hay un campo llamado "total" dentro de "hits"** que indica que se encontraron **1000 documentos** dentro de este 칤ndice pero solo se recuperaron 10. Esto se debe a que **por defecto hay un l칤mite de 10 documentos**.\
Pero, ahora que sabes que **este 칤ndice contiene 1000 documentos**, puedes **volcar todos ellos** indicando el n칰mero de entradas que deseas volcar en el par치metro **`size`**: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
_Nota: Si indicas un n칰mero mayor, todas las entradas se volcar치n de todos modos, por ejemplo podr칤as indicar `size=9999` y ser칤a extra침o si hubiera m치s entradas (pero deber칤as verificar)._

### Volcar todo

Para volcar todo simplemente puedes ir al **mismo camino que antes pero sin indicar ning칰n 칤ndice** `http://host:9200/_search?pretty=true` como `http://10.10.10.115:9200/_search?pretty=true`\
Recuerda que en este caso se aplicar치 el **l칤mite predeterminado de 10** resultados. Puedes usar el par치metro `size` para volcar una **mayor cantidad de resultados**. Lee la secci칩n anterior para m치s informaci칩n.

### B칰squeda

Si est치s buscando alguna informaci칩n puedes hacer una **b칰squeda en bruto en todos los 칤ndices** yendo a `http://host:9200/_search?pretty=true&q=<t칠rmino_de_b칰squeda>` como en `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Si solo deseas **buscar en un 칤ndice** puedes simplemente **especificarlo** en la **ruta**: `http://host:9200/<index>/_search?pretty=true&q=<t칠rmino_de_b칰squeda>`

_Nota que el par치metro q utilizado para buscar contenido **admite expresiones regulares**_

Tambi칠n puedes usar algo como [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) para fuzzear un servicio de elasticsearch.

### Permisos de escritura

Puedes verificar tus permisos de escritura intentando crear un nuevo documento dentro de un nuevo 칤ndice ejecutando algo como lo siguiente:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
Esa cmd crear치 un **nuevo 칤ndice** llamado `bookindex` con un documento de tipo `books` que tiene los atributos "_bookId_", "_author_", "_publisher_" y "_name_"

Observa c칩mo el **nuevo 칤ndice aparece ahora en la lista**:

![](<../.gitbook/assets/image (268).png>)

Y nota las **propiedades creadas autom치ticamente**:

![](<../.gitbook/assets/image (269).png>)

## Enumeraci칩n Autom치tica

Algunas herramientas obtendr치n algunos de los datos presentados anteriormente:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

* `port:9200 elasticsearch`

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
