# Nginx

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con mÃ¡s de una dÃ©cada que se celebrarÃ¡ el 7 y 8 de septiembre de 2023 en BogotÃ¡, Colombia. Es un evento de gran contenido tÃ©cnico donde se presentan las Ãºltimas investigaciones en espaÃ±ol que atrae a hackers e investigadores de todo el mundo.\
Â¡RegÃ­strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

## Falta la ubicaciÃ³n raÃ­z <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
        root /etc/nginx;

        location /hello.txt {
                try_files $uri $uri/ =404;
                proxy_pass http://127.0.0.1:8080/;
        }
}
```
La directiva "root" especifica la carpeta raÃ­z para Nginx. En el ejemplo anterior, la carpeta raÃ­z es `/etc/nginx`, lo que significa que podemos acceder a los archivos dentro de esa carpeta. La configuraciÃ³n anterior no tiene una ubicaciÃ³n para `/ (location / {...})`, solo para `/hello.txt`. Debido a esto, la directiva "root" se establecerÃ¡ globalmente, lo que significa que las solicitudes a `/` lo llevarÃ¡n a la ruta local `/etc/nginx`.

Una solicitud tan simple como `GET /nginx.conf` revelarÃ­a el contenido del archivo de configuraciÃ³n de Nginx almacenado en `/etc/nginx/nginx.conf`. Si la raÃ­z se establece en `/etc`, una solicitud `GET` a `/nginx/nginx.conf` revelarÃ­a el archivo de configuraciÃ³n. En algunos casos, es posible acceder a otros archivos de configuraciÃ³n, registros de acceso e incluso credenciales cifradas para la autenticaciÃ³n bÃ¡sica de HTTP.

## ConfiguraciÃ³n incorrecta de LFI de Alias <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dentro de la configuraciÃ³n de Nginx, busque las declaraciones "location", si alguna se parece a:
```
location /imgs { 
    alias /path/images/;
}
```
Hay una vulnerabilidad de LFI porque:
```
/imgs../flag.txt
```
El siguiente es contenido de un libro de hacking sobre tÃ©cnicas de hacking. El siguiente contenido es del archivo network-services-pentesting/pentesting-web/nginx.md. Traduzca el texto relevante en inglÃ©s al espaÃ±ol y devuelva la traducciÃ³n manteniendo la sintaxis de markdown. No traduzca cosas como cÃ³digo, nombres de tÃ©cnicas de hacking, palabras de hacking, nombres de plataformas en la nube / SaaS (como Workspace, aws, gcp ...), la palabra 'leak', pentesting y etiquetas de markdown. Tampoco agregue nada aparte de la traducciÃ³n y la sintaxis de markdown.
```
/path/images/../flag.txt
```
La configuraciÃ³n correcta serÃ¡:
```
location /imgs/ { 
    alias /path/images/;
}
```
**Entonces, si encuentras algÃºn servidor Nginx, debes verificar esta vulnerabilidad. AdemÃ¡s, puedes descubrirla si encuentras que la fuerza bruta de archivos/directorios se comporta de manera extraÃ±a.**

MÃ¡s informaciÃ³n: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Pruebas de Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Uso inseguro de variables <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Un ejemplo de una configuraciÃ³n vulnerable de Nginx es:
```
location / {
  return 302 https://example.com$uri;
}
```
Los caracteres de nueva lÃ­nea para las solicitudes HTTP son \r (retorno de carro) y \n (avance de lÃ­nea). La codificaciÃ³n de URL de los caracteres de nueva lÃ­nea resulta en la siguiente representaciÃ³n de los caracteres `%0d%0a`. Cuando estos caracteres se incluyen en una solicitud como `http://localhost/%0d%0aDetectify:%20clrf` a un servidor con la configuraciÃ³n incorrecta, el servidor responderÃ¡ con una nueva cabecera llamada `Detectify` ya que la variable $uri contiene los caracteres de nueva lÃ­nea decodificados de la URL.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Aprenda mÃ¡s sobre los riesgos de la inyecciÃ³n CRLF y la divisiÃ³n de respuestas en [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Cualquier variable

En algunos casos, los datos suministrados por el usuario pueden ser tratados como una variable de Nginx. No estÃ¡ claro por quÃ© puede estar sucediendo esto, pero no es tan poco comÃºn o fÃ¡cil de probar como se ve en este [informe de H1](https://hackerone.com/reports/370094). Si buscamos el mensaje de error, podemos ver que se encuentra en el [mÃ³dulo de filtro SSI](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), lo que revela que esto se debe a SSI.

Una forma de probar esto es establecer un valor de encabezado de referencia:
```
$ curl -H â€˜Referer: barâ€™ http://localhost/foo$http_referer | grep â€˜foobarâ€™
```
Escaneamos esta mala configuraciÃ³n y encontramos varias instancias donde un usuario podrÃ­a imprimir el valor de las variables de Nginx. El nÃºmero de instancias vulnerables encontradas ha disminuido, lo que podrÃ­a indicar que esto fue parcheado.

## Lectura de respuesta de backend sin procesar

Con `proxy_pass` de Nginx, existe la posibilidad de interceptar errores y encabezados HTTP creados por el backend. Esto es muy Ãºtil si desea ocultar mensajes de error y encabezados internos para que sean manejados por Nginx. Nginx automÃ¡ticamente servirÃ¡ una pÃ¡gina de error personalizada si el backend responde con una. Pero, Â¿quÃ© pasa si Nginx no entiende que es una respuesta HTTP?

Si un cliente envÃ­a una solicitud HTTP no vÃ¡lida a Nginx, esa solicitud se reenviarÃ¡ tal cual al backend, y el backend responderÃ¡ con su contenido sin procesar. Entonces, Nginx no entenderÃ¡ la respuesta HTTP no vÃ¡lida y simplemente la reenviarÃ¡ al cliente. Imagina una aplicaciÃ³n uWSGI como esta:
```python
def application(environ, start_response):
   start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
   return [b"Secret info, should not be visible!"]
```
Y con las siguientes directivas en Nginx:
```
http {
   error_page 500 /html/error.html;
   proxy_intercept_errors on;
   proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) servirÃ¡ una respuesta personalizada si el backend tiene un estado de respuesta mayor a 300. En nuestra aplicaciÃ³n uWSGI anterior, enviaremos un `Error 500` que serÃ¡ interceptado por Nginx.

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) es bastante autoexplicativo; ocultarÃ¡ cualquier encabezado HTTP especificado del cliente.

Si enviamos una solicitud `GET` normal, Nginx devolverÃ¡:
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
Pero si enviamos una solicitud HTTP invÃ¡lida, como:
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
Obtendremos la siguiente respuesta:
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes establecido en off

La directiva [merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) estÃ¡ establecida en "on" por defecto, lo que es un mecanismo para comprimir dos o mÃ¡s barras diagonales en una sola, por lo que `///` se convertirÃ­a en `/`. Si Nginx se utiliza como proxy inverso y la aplicaciÃ³n que se estÃ¡ proxyando es vulnerable a la inclusiÃ³n de archivos locales, el uso de barras diagonales adicionales en la solicitud podrÃ­a dejar espacio para explotarlo. Esto se describe en detalle por [Danny Robinson y Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

Encontramos 33 archivos de configuraciÃ³n de Nginx con `merge_slashes` establecido en "off".

## No se especifica el valor por defecto para la directiva map

Parece ser un caso comÃºn cuando **`map` se utiliza para algÃºn tipo de control de autorizaciÃ³n**. Un ejemplo simplificado podrÃ­a ser:
```
http {
...
    map $uri $mappocallow {
        /map-poc/private 0;
        /map-poc/secret 0;
        /map-poc/public 1;
    }
...
}
```

```
server {
...
    location /map-poc {
        if ($mappocallow = 0) {return 403;}
        return 200 "Hello. It is private area: $mappocallow";
    }
...
}
```
[SegÃºn el manual](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html):

> valor por defecto\
> establece el valor resultante si el valor de origen no coincide con ninguna de las variantes especificadas. Cuando no se especifica un valor por defecto, el valor resultante por defecto serÃ¡ una cadena vacÃ­a.

Es fÃ¡cil olvidar el valor `default`. Por lo tanto, **un delincuente puede evadir este "control de autorizaciÃ³n"** simplemente accediendo a un **caso inexistente dentro de `/map-poc`** como `https://targethost.com/map-poc/another-private-area`.

## SuplantaciÃ³n de DNS en Nginx

SegÃºn este post: [http://blog.zorinaq.com/nginx-resol**ver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/) **podrÃ­a ser posible falsificar registros DNS** para Nginx si se **conoce el servidor DNS que estÃ¡ usando Nginx** (y se puede interceptar de alguna manera la comunicaciÃ³n, por lo que esto **no es vÃ¡lido si se usa 127.0.0.1**) y el **dominio que estÃ¡ solicitando**.

Nginx puede especificar un servidor DNS para usar con:
```
resolver     8.8.8.8;
```
## Directivas `proxy_pass` e `internal`

La directiva **`proxy_pass`** se puede utilizar para **redirigir internamente solicitudes a otros servidores** internos o externos.\
La directiva **`internal`** se utiliza para dejar claro a Nginx que la **ubicaciÃ³n solo se puede acceder internamente**.

El uso de estas directivas **no es una vulnerabilidad, pero se debe verificar cÃ³mo estÃ¡n configuradas**.

## proxy\_set\_header Upgrade & Connection

Si el servidor nginx estÃ¡ configurado para pasar los encabezados Upgrade y Connection, se podrÃ­a realizar un [**ataque de H2C Smuggling**](../../pentesting-web/h2c-smuggling.md) para acceder a puntos finales protegidos / internos.

{% hint style="danger" %}
Esta vulnerabilidad permitirÃ­a a un atacante **establecer una conexiÃ³n directa con el punto final `proxy_pass`** (`http://backend:9999` en este caso) cuyo contenido no serÃ¡ verificado por nginx.
{% endhint %}

Ejemplo de configuraciÃ³n vulnerable para robar `/flag` de [aquÃ­](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
    listen       443 ssl;
    server_name  localhost;

    ssl_certificate       /usr/local/nginx/conf/cert.pem;
    ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

    location / {
     proxy_pass http://backend:9999;
     proxy_http_version 1.1;
     proxy_set_header Upgrade $http_upgrade;
     proxy_set_header Connection $http_connection;
    }

    location /flag {
     deny all;
    }
```
{% hint style="warning" %}
Ten en cuenta que incluso si `proxy_pass` apuntaba a una ruta especÃ­fica como `http://backend:9999/socket.io`, la conexiÃ³n se establecerÃ¡ con `http://backend:9999`, por lo que puedes contactar cualquier otra ruta dentro de ese punto final interno. Por lo tanto, no importa si se especifica una ruta en la URL de `proxy_pass`.
{% endhint %}

## PruÃ©balo tÃº mismo

Detectify ha creado un repositorio de GitHub donde puedes usar Docker para configurar tu propio servidor de prueba vulnerable de Nginx con algunas de las configuraciones incorrectas discutidas en este artÃ­culo y tratar de encontrarlas tÃº mismo.

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Herramientas de anÃ¡lisis estÃ¡tico

### [GIXY](https://github.com/yandex/gixy)

Gixy es una herramienta para analizar la configuraciÃ³n de Nginx. El objetivo principal de Gixy es prevenir la configuraciÃ³n incorrecta de seguridad y automatizar la detecciÃ³n de fallas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner es una herramienta simple para buscar configuraciones incorrectas y vulnerabilidades comunes de Nginx.

## Referencias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con mÃ¡s de una dÃ©cada que se celebrarÃ¡ el 7 y 8 de septiembre de 2023 en BogotÃ¡, Colombia. Es un evento de gran contenido tÃ©cnico donde se presentan las Ãºltimas investigaciones en espaÃ±ol que atrae a hackers e investigadores de todo el mundo.\
Â¡RegÃ­strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
