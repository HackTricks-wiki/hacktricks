# Nginx

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con mÃ¡s de una dÃ©cada que se celebrarÃ¡ el 7 y 8 de septiembre de 2023 en BogotÃ¡, Colombia. Es un evento de gran contenido tÃ©cnico donde se presentan las Ãºltimas investigaciones en espaÃ±ol que atrae a hackers e investigadores de todo el mundo.\
Â¡RegÃ­strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

## ãƒ«ãƒ¼ãƒˆã®å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nginxã®`root`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã€Nginxã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä¸Šè¨˜ã®ä¾‹ã§ã¯ã€ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã¯`/etc/nginx`ã§ã‚ã‚Šã€ãã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ä¸Šè¨˜ã®è¨­å®šã«ã¯`/ (location / {...})`ã®å ´æ‰€ãŒãªãã€`root`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€`/`ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹`/etc/nginx`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

å˜ç´”ãª`GET /nginx.conf`ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€`/etc/nginx/nginx.conf`ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹Nginxã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å…¬é–‹ã—ã¾ã™ã€‚ãƒ«ãƒ¼ãƒˆãŒ`/etc`ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€`GET`ãƒªã‚¯ã‚¨ã‚¹ãƒˆ`/nginx/nginx.conf`ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¬é–‹ã—ã¾ã™ã€‚ä¸€éƒ¨ã®å ´åˆã§ã¯ã€ä»–ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã€ã•ã‚‰ã«ã¯HTTPåŸºæœ¬èªè¨¼ã®æš—å·åŒ–ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

Nginxã®è¨­å®šå†…ã®ã€Œlocationã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```
location /imgs {
alias /path/images/;
}
```
ä»¥ä¸‹ã®ç†ç”±ã«ã‚ˆã‚Šã€LFIï¼ˆLocal File Inclusionï¼‰ã®è„†å¼±æ€§ãŒå­˜åœ¨ã—ã¾ã™ã€‚

```plaintext
1. The application allows user-supplied input to be included in file paths without proper sanitization or validation.
2. The application does not enforce proper access controls, allowing unauthorized users to access sensitive files.
3. The application does not restrict file inclusion to a specific directory or whitelist of allowed files.
```

æ”»æ’ƒè€…ã¯ã€LFIè„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®è„†å¼±æ€§ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã«ã¯ã€å…¥åŠ›ã®æ¤œè¨¼ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’é©åˆ‡ã«è¡Œã„ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å¼·åŒ–ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å–ã‚Šè¾¼ã¿ã‚’ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¾ãŸã¯è¨±å¯ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«åˆ¶é™ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```
/imgs../flag.txt
```
# Nginx

Nginx is a popular web server that is commonly used to serve static content, reverse proxy, and load balance web applications. It is known for its high performance, scalability, and reliability.

## Configuration Files

Nginx uses configuration files to define how it should handle incoming requests. The main configuration file is typically located at `/etc/nginx/nginx.conf`. Additional configuration files can be included using the `include` directive.

## Virtual Hosts

Nginx supports virtual hosts, allowing multiple websites to be hosted on a single server. Each virtual host is defined in a separate configuration file and can have its own set of directives.

## Reverse Proxy

Nginx can be used as a reverse proxy to distribute incoming requests to multiple backend servers. This can be useful for load balancing or for serving content from different locations.

To configure Nginx as a reverse proxy, the `proxy_pass` directive is used to specify the backend server's address.

## Load Balancing

Nginx can also be used as a load balancer to distribute incoming requests across multiple backend servers. It supports various load balancing algorithms, such as round-robin, least connections, and IP hash.

To configure Nginx as a load balancer, the `upstream` directive is used to define the backend servers, and the `proxy_pass` directive is used to specify the load balancing method.

## Security Considerations

When configuring Nginx, it is important to consider security best practices. Some important considerations include:

- Enabling HTTPS to encrypt communication between clients and the server.
- Implementing access controls to restrict access to sensitive resources.
- Configuring proper file permissions to prevent unauthorized access.
- Regularly updating Nginx to apply security patches and bug fixes.

By following these best practices, you can help ensure the security and integrity of your Nginx server.
```
/path/images/../flag.txt
```
æ­£ã—ã„è¨­å®šã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š
```
location /imgs/ {
alias /path/images/;
}
```
**ã—ãŸãŒã£ã¦ã€Nginxã‚µãƒ¼ãƒãƒ¼ã‚’è¦‹ã¤ã‘ãŸå ´åˆã¯ã€ã“ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ãŒç•°å¸¸ãªæŒ¯ã‚‹èˆã„ã‚’ã—ã¦ã„ã‚‹å ´åˆã«ã‚‚ç™ºè¦‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**

è©³ç´°æƒ…å ±ï¼š[https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetixã®ãƒ†ã‚¹ãƒˆï¼š
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## å®‰å…¨ã§ãªã„ãƒ‘ã‚¹åˆ¶é™ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ¬¡ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## å±é™ºãªå¤‰æ•°ã®ä½¿ç”¨ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

è„†å¼±ãªNginxã®è¨­å®šã®ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```
location / {
return 302 https://example.com$uri;
}
```
HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ”¹è¡Œæ–‡å­—ã¯\rï¼ˆã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ï¼‰ã¨\nï¼ˆæ”¹è¡Œï¼‰ã§ã™ã€‚æ”¹è¡Œæ–‡å­—ã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ–‡å­—ã®è¡¨ç¾ `%0d%0a` ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ–‡å­—ãŒãƒŸã‚¹æ§‹æˆã®ã‚ã‚‹ã‚µãƒ¼ãƒãƒ¼ã«å«ã¾ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ï¼š`http://localhost/%0d%0aDetectify:%20clrf`ï¼‰ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€$uriå¤‰æ•°ã«URLãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ”¹è¡Œæ–‡å­—ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã¯æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ `Detectify` ã‚’å«ã‚“ã ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
CRLFã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ—ãƒªãƒƒãƒ†ã‚£ãƒ³ã‚°ã®ãƒªã‚¹ã‚¯ã«ã¤ã„ã¦ã¯ã€[https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/)ã§è©³ã—ãå­¦ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

### ä»»æ„ã®å¤‰æ•°

ã„ãã¤ã‹ã®å ´åˆã«ãŠã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ãŒNginxã®å¤‰æ•°ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãªãœã“ã‚ŒãŒèµ·ã“ã‚‹ã®ã‹ã¯æ˜ç¢ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã‚Œã¯çã—ã„ã“ã¨ã§ã¯ãªãã€ç°¡å˜ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚[H1ãƒ¬ãƒãƒ¼ãƒˆ](https://hackerone.com/reports/370094)ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢ã™ã‚‹ã¨ã€[SSIãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365)ã§è¦‹ã¤ã‹ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã¯SSIã«èµ·å› ã™ã‚‹ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã®ä¸€ã¤ã¯ã€Refererãƒ˜ãƒƒãƒ€ãƒ¼ã®å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã™ï¼š
```
$ curl -H â€˜Referer: barâ€™ http://localhost/foo$http_referer | grep â€˜foobarâ€™
```
ã“ã®è¨­å®šãƒŸã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€Nginxå¤‰æ•°ã®å€¤ã‚’è¡¨ç¤ºã§ãã‚‹è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚è„†å¼±ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ•°ã¯æ¸›å°‘ã—ã¦ãŠã‚Šã€ã“ã‚Œã¯ä¿®æ­£ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®èª­ã¿å–ã‚Š

Nginxã®`proxy_pass`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚„HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦ã€ä»£ã‚ã‚Šã«NginxãŒå‡¦ç†ã™ã‚‹ãŸã‚éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’è¿”ã™å ´åˆã€Nginxã¯è‡ªå‹•çš„ã«ãã‚Œã‚’æä¾›ã—ã¾ã™ã€‚ã—ã‹ã—ã€ã‚‚ã—NginxãŒãã‚ŒãŒHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ã„ãªã„å ´åˆã¯ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒç„¡åŠ¹ãªHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’Nginxã«é€ä¿¡ã™ã‚‹ã¨ã€ãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãã®ã¾ã¾ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è»¢é€ã•ã‚Œã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ç”Ÿã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã§å¿œç­”ã—ã¾ã™ã€‚ãã®å¾Œã€Nginxã¯ç„¡åŠ¹ãªHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç†è§£ã›ãšã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è»¢é€ã—ã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ãªuWSGIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ï¼š
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
ãã—ã¦ã€æ¬¡ã®Nginxã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ç”¨ã—ã¦:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors)ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ300ã‚ˆã‚Šå¤§ãã„å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æŒã¤å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ ã®å¿œç­”ã‚’æä¾›ã—ã¾ã™ã€‚ä¸Šè¨˜ã®uWSGIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€Nginxã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã•ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header)ã¯ã€æŒ‡å®šã•ã‚ŒãŸHTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰éš ã™ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

é€šå¸¸ã®`GET`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€Nginxã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¿”ã—ã¾ã™ï¼š
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
ã—ã‹ã—ã€ç„¡åŠ¹ãªHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å ´åˆã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
æ¬¡ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã—ã¾ã™ï¼š
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashesã‚’offã«è¨­å®šã™ã‚‹

[merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes)ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œonã€ã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€2ã¤ä»¥ä¸Šã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’1ã¤ã«åœ§ç¸®ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€`///`ã¯`/`ã«ãªã‚Šã¾ã™ã€‚NginxãŒãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã€ãƒ—ãƒ­ã‚­ã‚·ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³ã®è„†å¼±æ€§ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä½™åˆ†ãªã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ”»æ’ƒã®ä½™åœ°ãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ã€[Danny Robinsonã¨Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d)ã«ã‚ˆã£ã¦è©³ã—ãèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

ç§ãŸã¡ã¯ã€33å€‹ã®Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§`merge_slashes`ãŒã€Œoffã€ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

## mapãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“

ã“ã‚Œã¯ã€**`map`ãŒä½•ã‚‰ã‹ã®èªè¨¼åˆ¶å¾¡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ä¸€èˆ¬çš„ãªã‚±ãƒ¼ã‚¹**ã®ã‚ˆã†ã§ã™ã€‚ç°¡å˜ãªä¾‹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ã‚ˆã‚‹ã¨](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html):

> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤\
> ã‚½ãƒ¼ã‚¹å€¤ãŒæŒ‡å®šã•ã‚ŒãŸãƒãƒªã‚¢ãƒ³ãƒˆã®ã„ãšã‚Œã¨ã‚‚ä¸€è‡´ã—ãªã„å ´åˆã«è¨­å®šã•ã‚Œã‚‹çµæœã®å€¤ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çµæœã®å€¤ã¯ç©ºã®æ–‡å­—åˆ—ã«ãªã‚Šã¾ã™ã€‚

`default`å€¤ã‚’å¿˜ã‚Œã‚‹ã“ã¨ã¯ç°¡å˜ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**æ‚ªæ„ã®ã‚ã‚‹è€…ã¯å˜ç´”ã«`/map-poc`å†…ã®å­˜åœ¨ã—ãªã„ã‚±ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã“ã®ã€Œèªè¨¼åˆ¶å¾¡ã€ã‚’ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€`https://targethost.com/map-poc/another-private-area`ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

## Nginxã®DNSã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°

ã“ã®è¨˜äº‹ã«ã‚ˆã‚‹ã¨ï¼š[http://blog.zorinaq.com/nginx-resol**ver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)ã€ã‚‚ã—ã‚‚NginxãŒä½¿ç”¨ã—ã¦ã„ã‚‹DNSã‚µãƒ¼ãƒãƒ¼ã‚’**çŸ¥ã£ã¦ã„ã‚‹**ï¼ˆãã—ã¦é€šä¿¡ã‚’å‚å—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã“ã‚Œã¯**127.0.0.1**ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯æœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰å ´åˆã€ãã—ã¦NginxãŒ**å•ã„åˆã‚ã›ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³**ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆã€Nginxã®DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ—ãƒ¼ãƒ•ã‚£ãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

Nginxã¯æ¬¡ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹DNSã‚µãƒ¼ãƒãƒ¼ã‚’æŒ‡å®šã§ãã¾ã™ï¼š
```
resolver     8.8.8.8;
```
## `proxy_pass` ãŠã‚ˆã³ `internal` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–

**`proxy_pass`** ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã€å†…éƒ¨ã¾ãŸã¯å¤–éƒ¨ã®ä»–ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å†…éƒ¨çš„ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚\
**`internal`** ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã€Nginxã«å¯¾ã—ã¦ãã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†…éƒ¨ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®ä½¿ç”¨ã¯ã€è„†å¼±æ€§ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãã‚Œã‚‰ãŒã©ã®ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## proxy\_set\_header Upgrade & Connection

nginxã‚µãƒ¼ãƒãƒ¼ãŒUpgradeãŠã‚ˆã³Connectionãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¸¡ã™ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€[**h2cã‚¹ãƒã‚°ãƒªãƒ³ã‚°æ”»æ’ƒ**](../../pentesting-web/h2c-smuggling.md)ã‚’å®Ÿè¡Œã—ã¦ã€ä¿è­·ã•ã‚ŒãŸ/å†…éƒ¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% hint style="danger" %}
ã“ã®è„†å¼±æ€§ã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯`proxy_pass`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆã“ã®å ´åˆã¯`http://backend:9999`ï¼‰ã¨ã®ç›´æ¥æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯nginxã«ã‚ˆã£ã¦ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã›ã‚“ã€‚
{% endhint %}

ä»¥ä¸‹ã¯ã€[ã“ã“](https://bishopfox.com/blog/h2c-smuggling-request)ã‹ã‚‰`/flag`ã‚’ç›—ã‚€ãŸã‚ã®è„†å¼±ãªè¨­å®šã®ä¾‹ã§ã™ã€‚
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
`proxy_pass`ãŒ`http://backend:9999/socket.io`ã®ã‚ˆã†ãªç‰¹å®šã®**ãƒ‘ã‚¹**ã‚’æŒ‡ã—ã¦ã„ãŸå ´åˆã§ã‚‚ã€æ¥ç¶šã¯`http://backend:9999`ã¨ç¢ºç«‹ã•ã‚Œã‚‹ãŸã‚ã€ãã®å†…éƒ¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå†…ã®ä»–ã®ãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€`proxy_pass`ã®URLã«ãƒ‘ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
{% endhint %}

## è‡ªåˆ†ã§è©¦ã—ã¦ã¿ã‚‹

Detectifyã¯ã€ã“ã®è¨˜äº‹ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã„ãã¤ã‹ã®è¨­å®šãƒŸã‚¹ã‚’æŒã¤è„†å¼±ãªNginxãƒ†ã‚¹ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’Dockerã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ãã‚‹GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸã€‚è¦‹ã¤ã‘ã‚‹ãŸã‚ã«è‡ªåˆ†ã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## é™çš„è§£æãƒ„ãƒ¼ãƒ«

### [GIXY](https://github.com/yandex/gixy)

Gixyã¯Nginxã®è¨­å®šã‚’åˆ†æã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Gixyã®ä¸»ãªç›®æ¨™ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¨­å®šãƒŸã‚¹ã‚’é˜²æ­¢ã—ã€æ¬ é™¥ã®æ¤œå‡ºã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwnerã¯ã€ä¸€èˆ¬çš„ãªNginxã®è¨­å®šãƒŸã‚¹ã¨è„†å¼±æ€§ã‚’æ¢ã™ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con mÃ¡s de una dÃ©cada que se celebrarÃ¡ el 7 y 8 de septiembre de 2023 en BogotÃ¡, Colombia. Es un evento de gran contenido tÃ©cnico donde se presentan las Ãºltimas investigaciones en espaÃ±ol que atrae a hackers e investigadores de todo el mundo.\
Â¡RegÃ­strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **and** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
