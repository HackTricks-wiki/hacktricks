# Seguran√ßa do ImageMagick

Durante nossas auditorias, ocasionalmente nos deparamos com arquivos de configura√ß√£o de pol√≠tica de seguran√ßa (`policy.xml`) do [ImageMagick](https://imagemagick.org/), √∫teis para limitar o comportamento padr√£o e os recursos consumidos pela biblioteca. Na pr√°tica, esses arquivos geralmente cont√™m uma infinidade de recomenda√ß√µes coletadas de v√°rias fontes na internet. Isso normalmente acontece por duas raz√µes:

* Suas op√ß√µes s√£o descritas apenas de forma geral na p√°gina de documenta√ß√£o online da biblioteca, sem uma clara explica√ß√£o do que cada diretiva de seguran√ßa permitida pela pol√≠tica est√° regulando. Embora a complexidade arquitetural e a granularidade das op√ß√µes defin√≠veis pela pol√≠tica sejam os principais obst√°culos para um iniciante, a base de conhecimento correspondente poderia ser mais acolhedora. Por padr√£o, o ImageMagick vem com uma pol√≠tica irrestrita que deve ser ajustada pelos desenvolvedores dependendo do uso. De acordo com a documenta√ß√£o, _"isso oferece a m√°xima utilidade para instala√ß√µes do ImageMagick que s√£o executadas em um ambiente isolado, talvez em uma inst√¢ncia do Docker, ou atr√°s de um firewall onde os riscos de seguran√ßa s√£o muito menores em compara√ß√£o com um site p√∫blico."_ Uma pol√≠tica estrita e segura tamb√©m est√° dispon√≠vel, no entanto, [como observado no passado](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html), nem sempre est√° bem configurada.
* O ImageMagick [suporta mais de 100 formatos principais de arquivo](https://imagemagick.org/script/formats.php#supported) (sem incluir subformatos) de tipos de formatos de imagem. As infames vulnerabilidades que afetam a biblioteca ao longo dos anos produziram uma s√©rie de corre√ß√µes de seguran√ßa urgentes e solu√ß√µes alternativas envolvendo a adi√ß√£o de itens de pol√≠tica que excluem os formatos e recursos afetados (ImageTragick em [2016](https://imagetragick.com/), RCE de [@taviso](https://twitter.com/taviso) via GhostScript em [2018](https://seclists.org/oss-sec/2018/q3/142), inje√ß√£o de shell de [@insertScript](https://twitter.com/insertScript) via senha de PDF em [2020](https://insert-script.blogspot.com/2020/11/imagemagick-shell-injection-via-pdf.html), [@alexisdanizan](https://twitter.com/alexisdanizan) em [2021](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html)).

### Rumo a pol√≠ticas mais seguras <a href="#towards-safer-policies" id="towards-safer-policies"></a>

Com isso em mente, decidimos estudar os efeitos de todas as op√ß√µes aceitas pelo analisador de pol√≠tica de seguran√ßa do ImageMagick e escrever uma [ferramenta para ajudar tanto os desenvolvedores quanto as equipes de seguran√ßa a projetar e auditar esses arquivos](https://imagemagick-secevaluator.doyensec.com/). Devido ao n√∫mero de op√ß√µes dispon√≠veis e √† necessidade de negar explicitamente todas as configura√ß√µes inseguras, isso geralmente √© uma tarefa manual, que pode n√£o identificar sutis contornos que comprometem a for√ßa de uma pol√≠tica. Tamb√©m √© f√°cil definir pol√≠ticas que parecem funcionar, mas n√£o oferecem nenhum benef√≠cio real de seguran√ßa. As verifica√ß√µes da ferramenta s√£o baseadas em nossa pesquisa com o objetivo de ajudar os desenvolvedores a fortalecer suas pol√≠ticas e melhorar a seguran√ßa de suas aplica√ß√µes, para garantir que as pol√≠ticas forne√ßam um benef√≠cio de seguran√ßa significativo e n√£o possam ser subvertidas por atacantes.

A ferramenta pode ser encontrada em [imagemagick-secevaluator.doyensec.com/](https://imagemagick-secevaluator.doyensec.com/).

### Abordagem de lista de permiss√µes versus lista de nega√ß√µes <a href="#allowlist-vs-denylist-approach" id="allowlist-vs-denylist-approach"></a>

Uma s√©rie de pol√≠ticas aparentemente seguras podem ser encontradas online, especificando uma lista de codificadores inseguros semelhantes a:
```xml
  ...
  <policy domain="coder" rights="none" pattern="EPHEMERAL" />
  <policy domain="coder" rights="none" pattern="EPI" />
  <policy domain="coder" rights="none" pattern="EPS" />
  <policy domain="coder" rights="none" pattern="MSL" />
  <policy domain="coder" rights="none" pattern="MVG" />
  <policy domain="coder" rights="none" pattern="PDF" />
  <policy domain="coder" rights="none" pattern="PLT" />
  <policy domain="coder" rights="none" pattern="PS" />
  <policy domain="coder" rights="none" pattern="PS2" />
  <policy domain="coder" rights="none" pattern="PS3" />
  <policy domain="coder" rights="none" pattern="SHOW" />
  <policy domain="coder" rights="none" pattern="TEXT" />
  <policy domain="coder" rights="none" pattern="WIN" />
  <policy domain="coder" rights="none" pattern="XPS" />
  ...
```
No ImageMagick 6.9.7-7, uma [mudan√ßa n√£o listada](https://blog.awm.jp/2017/02/09/imagemagick-en/) foi implementada. O analisador de pol√≠ticas mudou o comportamento de proibir o uso de um codificador se houvesse pelo menos uma regra de permiss√£o `none` na pol√≠tica para respeitar a √∫ltima regra correspondente na pol√≠tica para o codificador. Isso significa que √© poss√≠vel adotar uma abordagem de lista de permiss√µes em pol√≠ticas modernas, negando primeiro todos os direitos dos codificadores e habilitando os aprovados. Uma pol√≠tica mais segura especificaria:
```xml
  ...
  <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" />
  <policy domain="coder" rights="read | write" pattern="{GIF,JPEG,PNG,WEBP}" />
  ...
```
### Sensibilidade a mai√∫sculas e min√∫sculas <a href="#case-sensitivity" id="case-sensitivity"></a>

Considere a seguinte diretiva:
```
  ...
  <policy domain="coder" rights="none" pattern="ephemeral,epi,eps,msl,mvg,pdf,plt,ps,ps2,ps3,show,text,win,xps" />
  ...
```
Com isso, as convers√µes ainda ser√£o permitidas, j√° que os padr√µes de pol√≠tica diferenciam mai√∫sculas de min√∫sculas. Os codificadores e m√≥dulos devem sempre estar em mai√∫sculas na pol√≠tica (por exemplo, "EPS" e n√£o "eps").

### Limites de recursos <a href="#resource-limits" id="resource-limits"></a>

A nega√ß√£o de servi√ßo no ImageMagick √© bastante f√°cil de ser alcan√ßada. Para obter um novo conjunto de payloads, √© conveniente pesquisar por palavras-chave como "oom" nas issues recentemente abertas no reposit√≥rio Github da biblioteca. Isso √© um problema, j√° que uma inst√¢ncia do ImageMagick que aceita entradas potencialmente maliciosas (o que √© frequentemente o caso) sempre estar√° propensa a ser explorada. Por causa disso, a ferramenta tamb√©m relata se limites razo√°veis n√£o s√£o explicitamente definidos pela pol√≠tica.

### Fragmenta√ß√£o de pol√≠tica <a href="#policy-fragmentation" id="policy-fragmentation"></a>

Uma vez que uma pol√≠tica √© definida, √© importante garantir que o arquivo de pol√≠tica esteja em vigor. Pacotes do ImageMagick inclu√≠dos na distribui√ß√£o ou instalados como depend√™ncias por meio de v√°rios gerenciadores de pacotes podem especificar pol√≠ticas diferentes que interferem entre si. Um r√°pido `find` em sua m√°quina local identificar√° v√°rias ocorr√™ncias de arquivos `policy.xml`:
```shell-session
$ find / -iname policy.xml

# Example output on macOS
/usr/local/etc/ImageMagick-7/policy.xml
/usr/local/Cellar/imagemagick@6/6.9.12-60/etc/ImageMagick-6/policy.xml
/usr/local/Cellar/imagemagick@6/6.9.12-60/share/doc/ImageMagick-6/www/source/policy.xml
/usr/local/Cellar/imagemagick/7.1.0-45/etc/ImageMagick-7/policy.xml
/usr/local/Cellar/imagemagick/7.1.0-45/share/doc/ImageMagick-7/www/source/policy.xml

# Example output on Ubuntu
/usr/local/etc/ImageMagick-7/policy.xml
/usr/local/share/doc/ImageMagick-7/www/source/policy.xml
/opt/ImageMagick-7.0.11-5/config/policy.xml
/opt/ImageMagick-7.0.11-5/www/source/policy.xml

```
As pol√≠ticas tamb√©m podem ser configuradas usando o argumento CLI [-limit](https://imagemagick.org/script/command-line-options.php#limit), m√©todos da API [MagickCore](https://imagemagick.org/api/resource.php#SetMagickResourceLimit) ou com vari√°veis de ambiente.

### Uma pol√≠tica restritiva inicial <a href="#a-starter-restrictive-policy" id="a-starter-restrictive-policy"></a>

Come√ßando pela pol√≠tica mais restritiva descrita na documenta√ß√£o oficial, projetamos uma pol√≠tica restritiva que re√∫ne todas as nossas observa√ß√µes:
```xml
<policymap xmlns="">
  <policy domain="resource" name="temporary-path" value="/mnt/magick-conversions-with-restrictive-permissions"/> <!-- the location should only be accessible to the low-privileged user running ImageMagick -->
  <policy domain="resource" name="memory" value="256MiB"/>
  <policy domain="resource" name="list-length" value="32"/>
  <policy domain="resource" name="width" value="8KP"/>
  <policy domain="resource" name="height" value="8KP"/>
  <policy domain="resource" name="map" value="512MiB"/>
  <policy domain="resource" name="area" value="16KP"/>
  <policy domain="resource" name="disk" value="1GiB"/>
  <policy domain="resource" name="file" value="768"/>
  <policy domain="resource" name="thread" value="2"/>
  <policy domain="resource" name="time" value="10"/>
  <policy domain="module" rights="none" pattern="*" /> 
  <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" /> 
  <policy domain="coder" rights="write" pattern="{PNG,JPG,JPEG}" /> <!-- your restricted set of acceptable formats, set your rights needs -->
  <policy domain="filter" rights="none" pattern="*" />
  <policy domain="path" rights="none" pattern="@*"/>
  <policy domain="cache" name="memory-map" value="anonymous"/>
  <policy domain="cache" name="synchronize" value="true"/>
  <!-- <policy domain="cache" name="shared-secret" value="my-secret-passphrase" stealth="True"/> Only needed for distributed pixel cache spanning multiple servers -->
  <policy domain="system" name="shred" value="2"/>
  <policy domain="system" name="max-memory-request" value="256MiB"/>
  <policy domain="resource" name="throttle" value="1"/> <!-- Periodically yield the CPU for at least the time specified in ms -->
  <policy xmlns="" domain="system" name="precision" value="6"/>
</policymap>
```
Voc√™ pode verificar se uma pol√≠tica de seguran√ßa est√° ativa usando o comando `identify`:
```
identify -list policy
Path: ImageMagick/policy.xml
...
```
Voc√™ tamb√©m pode brincar com a pol√≠tica acima usando nossa ferramenta de avalia√ß√£o enquanto desenvolve uma personalizada.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
