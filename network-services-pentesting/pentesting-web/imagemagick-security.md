# Seguridad de ImageMagick

Durante nuestras auditor√≠as, a veces nos encontramos con archivos de configuraci√≥n de pol√≠ticas de seguridad (`policy.xml`) de [ImageMagick](https://imagemagick.org/), √∫tiles para limitar el comportamiento predeterminado y los recursos consumidos por la biblioteca. En la pr√°ctica, estos archivos a menudo contienen una gran cantidad de recomendaciones recopiladas de diversas fuentes en Internet. Esto suele suceder por dos razones:

* Sus opciones solo se describen de manera general en la p√°gina de documentaci√≥n en l√≠nea de la biblioteca, sin una clara descomposici√≥n de lo que regula cada directiva de seguridad permitida por la pol√≠tica. Si bien la complejidad arquitect√≥nica y la granularidad de las opciones definibles por la pol√≠tica son los principales obst√°culos para un novato, la base de conocimientos correspondiente podr√≠a ser m√°s acogedora. Por defecto, ImageMagick viene con una pol√≠tica no restringida que debe ajustarse por los desarrolladores seg√∫n su uso. Seg√∫n la documentaci√≥n, "esto proporciona la m√°xima utilidad para las instalaciones de ImageMagick que se ejecutan en un entorno aislado, quiz√°s en una instancia de Docker, o detr√°s de un firewall donde los riesgos de seguridad se reducen en gran medida en comparaci√≥n con un sitio web p√∫blico". Tambi√©n se proporciona una pol√≠tica estricta y segura, sin embargo, como se se√±al√≥ en el pasado, no siempre est√° bien configurada.
* ImageMagick admite m√°s de 100 formatos de archivo principales (sin incluir subformatos) de tipos de formatos de imagen. Las infames vulnerabilidades que afectan a la biblioteca a lo largo de los a√±os han producido una serie de correcciones de seguridad urgentes y soluciones alternativas que implican la adici√≥n de elementos de pol√≠tica que excluyen los formatos y caracter√≠sticas afectados (ImageTragick en [2016](https://imagetragick.com/), RCE de [@taviso](https://twitter.com/taviso) a trav√©s de GhostScript en [2018](https://seclists.org/oss-sec/2018/q3/142), inyecci√≥n de shell de [@insertScript](https://twitter.com/insertScript) a trav√©s de la contrase√±a de PDF en [2020](https://insert-script.blogspot.com/2020/11/imagemagick-shell-injection-via-pdf.html), de [@alexisdanizan](https://twitter.com/alexisdanizan) en [2021](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html)).

### Hacia pol√≠ticas m√°s seguras <a href="#towards-safer-policies" id="towards-safer-policies"></a>

Con esto en mente, decidimos estudiar los efectos de todas las opciones aceptadas por el analizador de pol√≠ticas de seguridad de ImageMagick y escribir una [herramienta para ayudar tanto a los desarrolladores como a los equipos de seguridad a dise√±ar y auditar estos archivos](https://imagemagick-secevaluator.doyensec.com/). Debido al n√∫mero de opciones disponibles y la necesidad de denegar expl√≠citamente todas las configuraciones inseguras, esto suele ser una tarea manual, que puede no identificar subrepticios bypasses que socavan la fuerza de una pol√≠tica. Tambi√©n es f√°cil establecer pol√≠ticas que parecen funcionar, pero que no ofrecen ning√∫n beneficio real de seguridad. Las comprobaciones de la herramienta se basan en nuestra investigaci√≥n destinada a ayudar a los desarrolladores a endurecer sus pol√≠ticas y mejorar la seguridad de sus aplicaciones, para asegurarse de que las pol√≠ticas proporcionen un beneficio de seguridad significativo y no puedan ser subvertidas por atacantes.

La herramienta se puede encontrar en [imagemagick-secevaluator.doyensec.com/](https://imagemagick-secevaluator.doyensec.com/).

### Enfoque de lista blanca vs lista negra <a href="#allowlist-vs-denylist-approach" id="allowlist-vs-denylist-approach"></a>

Se pueden encontrar en l√≠nea una serie de pol√≠ticas aparentemente seguras, que especifican una lista de codificadores inseguros similares a:
```xml
  ...
  <policy domain="coder" rights="none" pattern="EPHEMERAL" />
  <policy domain="coder" rights="none" pattern="EPI" />
  <policy domain="coder" rights="none" pattern="EPS" />
  <policy domain="coder" rights="none" pattern="MSL" />
  <policy domain="coder" rights="none" pattern="MVG" />
  <policy domain="coder" rights="none" pattern="PDF" />
  <policy domain="coder" rights="none" pattern="PLT" />
  <policy domain="coder" rights="none" pattern="PS" />
  <policy domain="coder" rights="none" pattern="PS2" />
  <policy domain="coder" rights="none" pattern="PS3" />
  <policy domain="coder" rights="none" pattern="SHOW" />
  <policy domain="coder" rights="none" pattern="TEXT" />
  <policy domain="coder" rights="none" pattern="WIN" />
  <policy domain="coder" rights="none" pattern="XPS" />
  ...
```
En ImageMagick 6.9.7-7, se realiz√≥ un [cambio no listado](https://blog.awm.jp/2017/02/09/imagemagick-en/). El analizador de pol√≠ticas cambi√≥ su comportamiento, pasando de no permitir el uso de un codificador si hab√≠a al menos una regla de permiso `none` en la pol√≠tica, a respetar la √∫ltima regla coincidente en la pol√≠tica para el codificador. Esto significa que es posible adoptar un enfoque de lista de permitidos en las pol√≠ticas modernas, denegando primero todos los derechos de los codificadores y habilitando solo los aprobados. Una pol√≠tica m√°s segura especificar√≠a:
```xml
  ...
  <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" />
  <policy domain="coder" rights="read | write" pattern="{GIF,JPEG,PNG,WEBP}" />
  ...
```
### Sensibilidad a may√∫sculas y min√∫sculas <a href="#case-sensitivity" id="case-sensitivity"></a>

Considere la siguiente directiva:
```
  ...
  <policy domain="coder" rights="none" pattern="ephemeral,epi,eps,msl,mvg,pdf,plt,ps,ps2,ps3,show,text,win,xps" />
  ...
```
Con esto, las conversiones seguir√°n siendo permitidas, ya que los patrones de pol√≠tica distinguen entre may√∫sculas y min√∫sculas. Los codificadores y m√≥dulos siempre deben estar en may√∫sculas en la pol√≠tica (por ejemplo, "EPS" en lugar de "eps").

### L√≠mites de recursos <a href="#resource-limits" id="resource-limits"></a>

La denegaci√≥n de servicio en ImageMagick es bastante f√°cil de lograr. Para obtener un conjunto fresco de payloads, es conveniente buscar [‚Äúoom‚Äù](https://github.com/ImageMagick/ImageMagick/issues?q=oom) u otras palabras clave similares en los problemas recientemente abiertos reportados en el repositorio Github de la biblioteca. Esto es un problema ya que una instancia de ImageMagick que acepta entradas potencialmente maliciosas (que a menudo es el caso) siempre estar√° propensa a ser explotada. Debido a esto, la herramienta tambi√©n informa si no se establecen l√≠mites razonables expl√≠citamente en la pol√≠tica.

### Fragmentaci√≥n de pol√≠ticas <a href="#policy-fragmentation" id="policy-fragmentation"></a>

Una vez que se define una pol√≠tica, es importante asegurarse de que el archivo de pol√≠tica est√© teniendo efecto. Los paquetes de ImageMagick incluidos en la distribuci√≥n o instalados como dependencias a trav√©s de m√∫ltiples gestores de paquetes pueden especificar diferentes pol√≠ticas que interfieren entre s√≠. Una b√∫squeda r√°pida con `find` en su m√°quina local identificar√° m√∫ltiples ocurrencias de archivos `policy.xml`:
```shell-session
$ find / -iname policy.xml

# Example output on macOS
/usr/local/etc/ImageMagick-7/policy.xml
/usr/local/Cellar/imagemagick@6/6.9.12-60/etc/ImageMagick-6/policy.xml
/usr/local/Cellar/imagemagick@6/6.9.12-60/share/doc/ImageMagick-6/www/source/policy.xml
/usr/local/Cellar/imagemagick/7.1.0-45/etc/ImageMagick-7/policy.xml
/usr/local/Cellar/imagemagick/7.1.0-45/share/doc/ImageMagick-7/www/source/policy.xml

# Example output on Ubuntu
/usr/local/etc/ImageMagick-7/policy.xml
/usr/local/share/doc/ImageMagick-7/www/source/policy.xml
/opt/ImageMagick-7.0.11-5/config/policy.xml
/opt/ImageMagick-7.0.11-5/www/source/policy.xml

```
Las pol√≠ticas tambi√©n se pueden configurar utilizando el argumento CLI [-limit](https://imagemagick.org/script/command-line-options.php#limit), los m√©todos de la API [MagickCore](https://imagemagick.org/api/resource.php#SetMagickResourceLimit) o con variables de entorno.

### Una pol√≠tica restrictiva inicial <a href="#a-starter-restrictive-policy" id="a-starter-restrictive-policy"></a>

A partir de la pol√≠tica m√°s restrictiva descrita en la documentaci√≥n oficial, dise√±amos una pol√≠tica restrictiva que recopila todas nuestras observaciones:
```xml
<policymap xmlns="">
  <policy domain="resource" name="temporary-path" value="/mnt/magick-conversions-with-restrictive-permissions"/> <!-- the location should only be accessible to the low-privileged user running ImageMagick -->
  <policy domain="resource" name="memory" value="256MiB"/>
  <policy domain="resource" name="list-length" value="32"/>
  <policy domain="resource" name="width" value="8KP"/>
  <policy domain="resource" name="height" value="8KP"/>
  <policy domain="resource" name="map" value="512MiB"/>
  <policy domain="resource" name="area" value="16KP"/>
  <policy domain="resource" name="disk" value="1GiB"/>
  <policy domain="resource" name="file" value="768"/>
  <policy domain="resource" name="thread" value="2"/>
  <policy domain="resource" name="time" value="10"/>
  <policy domain="module" rights="none" pattern="*" /> 
  <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" /> 
  <policy domain="coder" rights="write" pattern="{PNG,JPG,JPEG}" /> <!-- your restricted set of acceptable formats, set your rights needs -->
  <policy domain="filter" rights="none" pattern="*" />
  <policy domain="path" rights="none" pattern="@*"/>
  <policy domain="cache" name="memory-map" value="anonymous"/>
  <policy domain="cache" name="synchronize" value="true"/>
  <!-- <policy domain="cache" name="shared-secret" value="my-secret-passphrase" stealth="True"/> Only needed for distributed pixel cache spanning multiple servers -->
  <policy domain="system" name="shred" value="2"/>
  <policy domain="system" name="max-memory-request" value="256MiB"/>
  <policy domain="resource" name="throttle" value="1"/> <!-- Periodically yield the CPU for at least the time specified in ms -->
  <policy xmlns="" domain="system" name="precision" value="6"/>
</policymap>
```
Puedes verificar que una pol√≠tica de seguridad est√° activa usando el comando `identify`:
```
identify -list policy
Path: ImageMagick/policy.xml
...
```
Tambi√©n puedes jugar con la pol√≠tica anterior usando nuestra herramienta de evaluaci√≥n mientras desarrollas una personalizada.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
