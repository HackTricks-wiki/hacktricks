<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Nota importante:**

![imagen](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** es una funci贸n de PHP que se puede utilizar para cargar extensiones de PHP. Si la funci贸n no est谩 deshabilitada, se podr铆a abusar de ella para **burlar `disable_functions` y ejecutar comandos arbitrarios**.\
Sin embargo, tiene algunas limitaciones estrictas:

* La funci贸n `dl` debe estar **presente** en el **entorno** y **no deshabilitada**
* La extensi贸n de PHP **debe compilarse con la misma versi贸n principal** (versi贸n de API de PHP) que est谩 utilizando el servidor (puedes ver esta informaci贸n en la salida de phpinfo)
* La extensi贸n de PHP debe estar **ubicada en el directorio** que est谩 **definido** por la directiva **`extension_dir`** (puedes verlo en la salida de phpinfo). Es muy improbable que un atacante que intente abusar del servidor tenga acceso de escritura sobre este directorio, por lo que este requisito probablemente te impedir谩 abusar de esta t茅cnica).

**Si cumples con estos requisitos, contin煤a leyendo la publicaci贸n** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **para aprender c贸mo burlar `disable_functions`**. Aqu铆 tienes un resumen:

La [funci贸n dl](http://www.php.net/manual/en/function.dl.php) se utiliza para cargar extensiones de PHP din谩micamente durante la ejecuci贸n del script. Las extensiones de PHP, generalmente escritas en C/C++, mejoran la funcionalidad de PHP. El atacante, al darse cuenta de que la funci贸n `dl` no est谩 deshabilitada, decide crear una extensi贸n de PHP personalizada para ejecutar comandos del sistema.

### Pasos realizados por el atacante:

1. **Identificaci贸n de la versi贸n de PHP:**
- El atacante determina la versi贸n de PHP utilizando un script (`<?php echo 'La versi贸n de PHP es '.PHP_VERSION; ?>`).

2. **Adquisici贸n de la fuente de PHP:**
- Descarga la fuente de PHP desde el sitio web oficial de [PHP](http://www.php.net/downloads.php) o el [archivo](http://museum.php.net) si la versi贸n es antigua.

3. **Configuraci贸n local de PHP:**
- Extrae e instala la versi贸n espec铆fica de PHP en su sistema.

4. **Creaci贸n de la extensi贸n:**
- Estudia [la creaci贸n de extensiones de PHP](http://www.php.net/manual/en/zend.creating.php) e inspecciona el c贸digo fuente de PHP.
- Se centra en duplicar la funcionalidad de la [funci贸n exec](http://www.php.net/manual/en/function.exec.php) ubicada en `ext/standard/exec.c`.

### Notas para compilar la extensi贸n personalizada:

1. **ZEND_MODULE_API_NO:**
- El `ZEND_MODULE_API_NO` en `bypass.c` debe coincidir con la compilaci贸n actual de la Extensi贸n Zend, que se puede obtener con:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modificaci贸n de PHP_FUNCTION:**
- Para versiones recientes de PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` puede necesitar ajustes. El fragmento de c贸digo proporcionado detalla esta modificaci贸n.

### Archivos de la extensi贸n personalizada:

- **bypass.c**:
- Implementa la funcionalidad principal de la extensi贸n personalizada.
- **php_bypass.h**:
- Archivo de encabezado que define las propiedades de la extensi贸n.
- **config.m4**:
- Utilizado por `phpize` para configurar el entorno de compilaci贸n de la extensi贸n personalizada.

### Compilaci贸n de la extensi贸n:

1. **Comandos de compilaci贸n:**
- Utiliza `phpize`, `./configure` y `make` para compilar la extensi贸n.
- El archivo resultante `bypass.so` se encuentra en el subdirectorio de m贸dulos.

2. **Limpieza:**
- Ejecuta `make clean` y `phpize --clean` despu茅s de la compilaci贸n.

### Subida y ejecuci贸n en el host v铆ctima:

1. **Compatibilidad de versiones:**
- Asegura que las versiones de la API de PHP coincidan entre el sistema del atacante y el de la v铆ctima.

2. **Carga de la extensi贸n:**
- Utiliza la funci贸n `dl`, eludiendo las restricciones mediante el uso de rutas relativas o un script para automatizar el proceso.

3. **Ejecuci贸n del script:**
- El atacante sube `bypass.so` y un script de PHP al servidor de la v铆ctima.
- El script utiliza la funci贸n `dl_local` para cargar din谩micamente `bypass.so` y luego llama a `bypass_exec` con un comando pasado a trav茅s del par谩metro de consulta `cmd`.

### Ejecuci贸n de comandos:

- El atacante ahora puede ejecutar comandos accediendo a: `http://www.ejemplo.com/script.php?cmd=<comando>`


Esta detallada gu铆a describe el proceso de creaci贸n e implementaci贸n de una extensi贸n de PHP para ejecutar comandos del sistema, explotando la funci贸n `dl`, la cual idealmente deber铆a estar deshabilitada para prevenir brechas de seguridad de este tipo.


<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
