<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# RetenciÃ³n de trabajos

Algunas impresoras tienen trabajos de impresiÃ³n almacenados accesibles desde el servidor web. Sin embargo, por lo general, la retenciÃ³n de trabajos debe activarse explÃ­citamente para un determinado trabajo de impresiÃ³n y se puede hacer mediante comandos PJL estÃ¡ndar o cÃ³digo PostScript propietario. Los trabajos se mantienen en memoria y se pueden reimprimir desde el panel de control.

## PJL

La retenciÃ³n legÃ­tima de trabajos se puede habilitar para el documento actual estableciendo la variable PJL HOLD como se muestra a continuaciÃ³n:
```
@PJL SET HOLD=ON
[actual data to be printed follows]
```
Los trabajos retenidos se mantienen en memoria y pueden ser reimpresos desde el panel de control de la impresora. Esta caracterÃ­stica es compatible con varias impresoras, sin embargo, parece que solo algunos dispositivos Epson permiten establecer la retenciÃ³n permanente de trabajos mediante `@PJL DEFAULT HOLD=ON`.

**Â¿CÃ³mo probar este ataque?**

Utilice el comando `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en modo pjl y verifique si se puede establecer la retenciÃ³n permanente de trabajos:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Setting job retention, reconnecting to see if still enabled
Retention for future print jobs: OFF
```
## PostScript

PostScript ofrece funcionalidades similares, pero especÃ­ficas del modelo y del proveedor. Para las series HP LaserJet 4k y varias impresoras Kyocera, se puede habilitar la retenciÃ³n de trabajos mediante la adiciÃ³n de los siguientes comandos al documento PostScript:
```
<< /Collate true /CollateDetails
<< /Hold 1 /Type 8 >> >> setpagedevice
```
Aunque teÃ³ricamente es posible habilitar permanentemente la retenciÃ³n de trabajos PostScript utilizando el operador [startjob](./#postscript-ps), esta configuraciÃ³n se restablece explÃ­citamente por CUPS al comienzo de cada trabajo de impresiÃ³n utilizando `<< /Collate false >> setpagedevice`. Para contrarrestar este mecanismo de protecciÃ³n, el atacante puede redefinir permanentemente el operador `setpagedevice` para que no tenga ningÃºn efecto.

**Â¿CÃ³mo probar este ataque?**

Usa el comando `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Job retention enabled.
```
# Captura de trabajos

Es posible, aunque poco comÃºn, activar la retenciÃ³n de trabajos en el diÃ¡logo de impresiÃ³n como se discutiÃ³ anteriormente. Sin embargo, con PostScript se tiene acceso completo sobre el trabajo de impresiÃ³n actual y con el operador [startjob](./#postscript-ps), incluso es posible salir del ciclo del servidor y acceder a trabajos futuros. Tal funcionalidad tiene el potencial de capturar todos los documentos si se utiliza PostScript como controlador de impresora.

## PostScript

Con la capacidad de conectarse a operadores arbitrarios de PostScript, es posible manipular y acceder a trabajos de impresiÃ³n ajenos. Para **analizar la secuencia de datos real enviada a la impresora**, se puede aplicar una caracterÃ­stica bastante interesante del lenguaje PostScript: leer su propio cÃ³digo de programa como datos utilizando el operador `currentfile`. De esta manera, toda la secuencia de datos que debe ser procesada por el intÃ©rprete de PostScript se puede acceder mediante la lectura y almacenamiento en un archivo en el dispositivo de la impresora. Si la impresora no ofrece acceso al sistema de archivos, los **documentos capturados se pueden almacenar en la memoria**, por ejemplo, dentro de diccionarios permanentes de PostScript. \
Un problema prÃ¡ctico es decidir **quÃ© operador debe ser conectado** ya que no se tiene acceso a la secuencia de datos hasta que este operador es procesado por el intÃ©rprete de PostScript. Como un atacante quiere capturar trabajos de impresiÃ³n desde el principio, el **operador redefinido debe ser el primer operador** contenido en el documento de PostScript. Afortunadamente, todos los documentos impresos con CUPS se comprimen en una estructura fija que comienza con `currentfile /ASCII85Decode filter /LZWDecode filter cvx exec`. BasÃ¡ndose en la suposiciÃ³n de tal estructura fija, el atacante puede capturar documentos desde el principio y ejecutar (es decir, imprimir) el archivo posteriormente. Para sistemas de impresiÃ³n **diferentes a CUPS**, este ataque tambiÃ©n deberÃ­a ser posible, pero **los operadores deben ser adaptados**. Tenga en cuenta que el encabezado de PostScript que generalmente incluye el tamaÃ±o del medio, el usuario y los nombres de trabajo no se pueden capturar utilizando este mÃ©todo porque primero se conecta al comienzo del documento real. Otra estrategia genÃ©rica para conectarse al comienzo de cada trabajo de impresiÃ³n es establecer el parÃ¡metro del sistema `BeginPage`, si es compatible con la impresora (la mayorÃ­a de las impresoras lo hacen). Esta vulnerabilidad probablemente ha estado presente en dispositivos de impresiÃ³n durante dÃ©cadas, ya que se abusan Ãºnicamente de las construcciones de lenguaje definidas por el estÃ¡ndar PostScript.

Use el comando `capture` de [**PRET**](https://github.com/RUB-NDS/PRET) en modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.

printer:/> capture 
Print job operations:  capture <operation>
  capture start   - Record future print jobs.
  capture stop    - End capturing print jobs.
  capture list    - Show captured print jobs.
  capture fetch   - Save captured print jobs.
  capture print   - Reprint saved print jobs.
printer:/> capture start
Future print jobs will be captured in memory!
printer:/> exit
```
Ahora, imprima documentos arbitrarios (asegÃºrese de que PRET estÃ© desconectado para no bloquear el canal de impresiÃ³n). DespuÃ©s, puede listar, recuperar o reimprimir los documentos capturados:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> capture list
Free virtual memory: 16.6M | Limit to capture:  5.0M
date          size  user           jobname                 creator             
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Jan 25 18:38  3.1M  -              -                       -                   
Jan 25 18:40  170K  -              -                       -                   
printer:/> capture fetch
Receiving capture/printer/690782792
3239748 bytes received. 
Receiving capture/printer/690646210
174037 bytes received.
printer:/> capture print
printing...
printing...
2 jobs reprinted
printer:/> capture stop
Stopping job capture, deleting recorded jobs
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **grupo de Discord** o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme en** **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y al repositorio [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
