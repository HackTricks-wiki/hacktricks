# **IntroduÃ§Ã£o**

Imprimir sem permissÃ£o pode ser um risco de seguranÃ§a ou violaÃ§Ã£o da polÃ­tica da empresa. Em ambientes onde os trabalhos de impressÃ£o sÃ£o cobrados, um atacante interno tem motivaÃ§Ã£o para contornar o sistema de contabilidade. AlÃ©m disso, ser capaz de "imprimir" Ã© uma condiÃ§Ã£o prÃ©via para a maioria dos ataques contra impressoras de rede.

Existem duas abordagens principais quando se trata de contabilidade de trabalhos de impressÃ£o: **deixar a impressora lidar diretamente com isso ou usar um servidor de impressÃ£o intermediÃ¡rio**. A primeira abordagem Ã© especÃ­fica do fornecedor, geralmente envolve algum tipo de "driver de impressora" especial e nÃ£o Ã© discutida aqui. A outra abordagem envolve um servidor de impressÃ£o separado - geralmente uma implementaÃ§Ã£o de software como [CUPS](https://en.wikipedia.org/wiki/CUPS) ou [LPRng](https://en.wikipedia.org/wiki/LPRng) - para lidar com a contabilidade e Ã© bastante comum em empresas e instituiÃ§Ãµes. O servidor de impressÃ£o pode falar LPD, IPP ou outros protocolos de impressÃ£o e encaminha trabalhos para a impressora real. **Ã‰ importante observar que o acesso direto Ã  rede da impressora deve ser restrito**, caso contrÃ¡rio, um atacante pode **facilmente contornar o servidor de impressÃ£o** e seus mecanismos de contabilidade. Isso significa filtrar o acesso Ã s portas tÃ­picas e atÃ­picas (LPD, IPP, raw, HTTP, SMB, FTP, SNMP).

Basicamente, existem duas abordagens para contornar os sistemas de contabilidade de trabalhos de impressÃ£o: **fingir ser outro usuÃ¡rio ou manipular o contador** de pÃ¡ginas impressas. A seguir, ambas as opÃ§Ãµes sÃ£o discutidas para instalaÃ§Ãµes LPRng (v3.8.B) e CUPS (v2.1.4), que sÃ£o sistemas de impressÃ£o de cÃ³digo aberto populares usados em ambientes acadÃªmicos e corporativos. Uma comparaÃ§Ã£o das caracterÃ­sticas de seguranÃ§a de ambos os sistemas Ã© apresentada abaixo.

| Sistema de impressÃ£o | Protocolo | Criptografia | AutenticaÃ§Ã£o | Contador de pÃ¡ginas |
| --------------- | -------- | ---------- | -------------- | ------------ |
| **LPRng**       | LPD      | SSL/TLS    | Kerberos, PGP  | hardware     |
| **CUPS**        | IPP      | SSL/TLS    | Kerberos, HTTP | software     |

# Bypasses de autenticaÃ§Ã£o

LPRng e CUPS oferecem ambos criptografia de canal baseada em SSL e esquemas de autenticaÃ§Ã£o seguros como [Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\)), trabalhos de impressÃ£o assinados com PGP ou autenticaÃ§Ã£o HTTP [bÃ¡sica](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication). Se **configurados corretamente** e no caso em que o atacante nÃ£o possa acessar a impressora diretamente, ela **nÃ£o serÃ¡ capaz de fingir ser outros usuÃ¡rios**. No entanto, esses recursos de seguranÃ§a sÃ£o **opcionais e raramente aplicados** nos servidores de impressÃ£o do mundo real. Em vez disso, os **nomes de usuÃ¡rio fornecidos como parÃ¢metros LPD (LPRng) ou IPP (CUPS) sÃ£o registrados e contabilizados** - o que pode ser definido como valores arbitrÃ¡rios pelo lado do cliente. As razÃµes para isso sÃ£o uma consideraÃ§Ã£o simples de custo-benefÃ­cio na maioria das instituiÃ§Ãµes: o Kerberos precisa de uma configuraÃ§Ã£o especial em cada cliente e a autenticaÃ§Ã£o **HTTP** requer que os usuÃ¡rios digitem uma **senha** sempre que desejarem imprimir algo, enquanto os custos de algumas impressÃµes nÃ£o contabilizadas sÃ£o suportÃ¡veis.

VocÃª pode **verificar a autenticaÃ§Ã£o adequada** tentando imprimir com um **nome de usuÃ¡rio personalizado** como este:
```
lp -U nobody test.ps
```
# ManipulaÃ§Ã£o do contador de pÃ¡ginas

## Contadores de pÃ¡ginas de hardware

Para uma contabilidade correta, **o nÃºmero de pÃ¡ginas impressas deve ser determinado** pelo sistema de impressÃ£o, o que nÃ£o Ã© uma tarefa trivial. Os autores do **LPRng** _assumem que a impressora possui algum tipo de mecanismo de contador de pÃ¡ginas nÃ£o volÃ¡til que Ã© confiÃ¡vel e imune a ciclos de ligar/desligar_. Tais **contadores de pÃ¡ginas de hardware** sÃ£o suportados pela maioria das impressoras e **lidos** pelo LPRng **usando PJL apÃ³s** cada trabalho de **impressÃ£o**. A **HP** atÃ© documentou um recurso para **escrever** na variÃ¡vel do **contador de pÃ¡ginas** definindo a impressora no modo de serviÃ§o. Dessa forma, o **contador de pÃ¡ginas** da _HP LaserJet 1200, HP LaserJet 4200N_ e _HP LaserJet 4250N_ **pode ser manipulado** dentro de um trabalho de impressÃ£o. No final do documento a ser impresso e separado pelo [UEL](./#uel), o contador simplesmente precisa ser redefinido para o seu valor original (por exemplo, `2342`):
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
Um atacante pode definir um nÃºmero negativo de pÃ¡ginas impressas. Note que redefinir o dispositivo para os [padrÃµes de fÃ¡brica](factory-defaults.md) tambÃ©m **redefine o contador de pÃ¡ginas para zero em alguns** dos dispositivos testados.\
A reduÃ§Ã£o do contador de pÃ¡ginas tambÃ©m pode ser usada para **vender uma impressora acima do seu preÃ§o** jÃ¡ que pode ser comparada ao hodÃ´metro ao comprar um carro de segunda mÃ£o. No entanto, vale ressaltar que **redefinir o contador de pÃ¡ginas nÃ£o Ã© necessariamente para fins maliciosos**: Ã© um modelo de negÃ³cios bem conhecido vender tinta com preÃ§os elevados para dispositivos jato de tinta de baixo custo e bloquear kits de recarga de terceiros, recusando-se a imprimir apÃ³s um certo nÃºmero de pÃ¡ginas - para lidar com tais prÃ¡ticas antiÃ©ticas, Ã© absolutamente legÃ­timo redefinir o contador de pÃ¡ginas.

Em impressoras HP laserjet mais antigas, o comando `pagecount` do [PRET](https://github.com/RUB-NDS/PRET) pode ser usado para definir facilmente contadores de pÃ¡ginas de hardware:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## Contadores de pÃ¡ginas de software

O **CUPS** usa **contadores de pÃ¡ginas de software** que foram implementados para todas as principais linguagens de descriÃ§Ã£o de pÃ¡gina. Para PostScript, uma maneira fÃ¡cil de contornar a contabilidade Ã© verificar se o parÃ¢metro do sistema PageCount existe - o que retornarÃ¡ falso quando interpretado no CUPS / Ghostscript - antes de imprimir o documento, como mostrado abaixo.
```
currentsystemparams (PageCount) known {
  <@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
Desta forma, o software de contabilidade usado pelo CUPS renderiza um documento diferente do que o da impressora. O CUPS sÃ³ contabiliza uma pÃ¡gina - o que parece ser um mÃ­nimo codificado - enquanto o trabalho de impressÃ£o real pode conter centenas de pÃ¡ginas. Observe que o uso da opÃ§Ã£o/fila IPP 'raw' Ã© obrigatÃ³rio, caso contrÃ¡rio, o CUPS analisa o cÃ³digo com um filtro PostScript-to-PostScript (ps2write do Ghostscript) antes que ele chegue ao contador de pÃ¡ginas.

**Como testar esse ataque?**

Envolver um documento PostScript de vÃ¡rias pÃ¡ginas arbitrÃ¡rio no cÃ³digo acima e imprimir. Em seguida, vÃ¡ para [`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which_jobs=all) e verifique o contador de pÃ¡ginas do CUPS para este trabalho de impressÃ£o. Observe que Ã© necessÃ¡rio estabelecer uma fila bruta. Ou seja, uma fila em que o sistema de filtragem nÃ£o esteja envolvido e o trabalho de impressÃ£o vÃ¡ diretamente para uma impressora. Para o CUPS, isso Ã© feito definindo o tipo de conteÃºdo como `application/vnd.cups-raw`. Se o seu sistema jÃ¡ estiver configurado para usar o servidor de impressÃ£o a ser testado, basta usar:
```
lp -o raw test.ps
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
