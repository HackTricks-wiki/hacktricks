# **IntroducciÃ³n**

Imprimir sin permiso puede ser un riesgo de seguridad o una violaciÃ³n de la polÃ­tica de la empresa. En entornos donde se cobra por los trabajos de impresiÃ³n, un atacante interno tiene motivaciÃ³n para evitar el sistema de contabilidad. AdemÃ¡s, poder "imprimir" es una condiciÃ³n previa para la mayorÃ­a de los ataques contra las impresoras de red.

Hay dos enfoques principales cuando se trata de contabilidad de trabajos de impresiÃ³n: **dejar que la impresora lo maneje directamente o usar un servidor de impresiÃ³n en el medio**. El primer enfoque es especÃ­fico del proveedor, generalmente implica algÃºn tipo de "controlador de impresora" especial y no se discute mÃ¡s aquÃ­. El otro enfoque implica un servidor de impresiÃ³n separado, generalmente una implementaciÃ³n de software como [CUPS](https://en.wikipedia.org/wiki/CUPS) o [LPRng](https://en.wikipedia.org/wiki/LPRng), para manejar la contabilidad y es bastante comÃºn en empresas e instituciones. El servidor de impresiÃ³n puede hablar LPD, IPP u otros protocolos de impresiÃ³n y reenvÃ­a trabajos a la impresora real. **Es importante tener en cuenta que el acceso directo a la red de la impresora debe estar restringido**, de lo contrario, un atacante puede **burlar fÃ¡cilmente el servidor de impresiÃ³n** y sus mecanismos de contabilidad. Esto significa filtrar el acceso a puertos tÃ­picos y atÃ­picos (LPD, IPP, crudo, HTTP, SMB, FTP, SNMP).

BÃ¡sicamente hay dos enfoques para evitar los sistemas de contabilidad de trabajos de impresiÃ³n: **suplantar a otro usuario o manipular el contador** de pÃ¡ginas impresas. A continuaciÃ³n, se discuten ambas opciones para las instalaciones de LPRng (v3.8.B) y CUPS (v2.1.4), que son sistemas de impresiÃ³n de cÃ³digo abierto populares utilizados en entornos acadÃ©micos y corporativos. Se presenta una comparaciÃ³n de las caracterÃ­sticas de seguridad de ambos sistemas a continuaciÃ³n.

| Sistema de impresiÃ³n | Protocolo | Cifrado | AutenticaciÃ³n | Contador de pÃ¡ginas |
| --------------- | -------- | ---------- | -------------- | ------------ |
| **LPRng**       | LPD      | SSL/TLS    | Kerberos, PGP  | hardware     |
| **CUPS**        | IPP      | SSL/TLS    | Kerberos, HTTP | software     |

# Saltos de autenticaciÃ³n

LPRng y CUPS ofrecen ambos cifrado de canal basado en SSL y esquemas de autenticaciÃ³n seguros como [Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\)), trabajos de impresiÃ³n firmados con PGP o autenticaciÃ³n HTTP [bÃ¡sica](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication). Si estÃ¡n **configurados correctamente** y en caso de que el atacante no pueda acceder directamente a la impresora, **no podrÃ¡ suplantar a otros usuarios**. Sin embargo, estas caracterÃ­sticas de seguridad son **opcionales y raramente se aplican** en los servidores de impresiÃ³n del mundo real. En su lugar, los **nombres de usuario dados como parÃ¡metros LPD (LPRng) o IPP (CUPS) se registran y contabilizan** - lo que puede establecerse en valores arbitrarios por el lado del cliente. Las razones de esto son una consideraciÃ³n simple de costo-beneficio en la mayorÃ­a de las instituciones: **Kerberos necesita una configuraciÃ³n especial** en cada cliente y la **autenticaciÃ³n HTTP** requiere que los usuarios ingresen una **contraseÃ±a** cada vez que quieran imprimir algo, mientras que los costos de algunas impresiones no contabilizadas son soportables.

Puede **verificar la autenticaciÃ³n adecuada** intentando imprimir con un **nombre de usuario personalizado** como este:
```
lp -U nobody test.ps
```
# ManipulaciÃ³n del contador de pÃ¡ginas

## Contadores de pÃ¡ginas de hardware

Para una contabilidad correcta, **se debe determinar el nÃºmero de pÃ¡ginas impresas** por el sistema de impresiÃ³n, lo cual no es una tarea trivial. Los autores de **LPRng** _suponen que la impresora tiene algÃºn tipo de mecanismo de contador de pÃ¡ginas no volÃ¡til que es confiable e impermeable a los ciclos de encendido / apagado_. Tales **contadores de pÃ¡ginas de hardware** son compatibles con la mayorÃ­a de las impresoras y **se leen** mediante LPRng **usando PJL despuÃ©s** de cada trabajo de impresiÃ³n. **HP** incluso ha documentado una funciÃ³n para **escribir** en la variable del **contador de pÃ¡ginas** configurando la impresora en modo de servicio. De esta manera, el **contador de pÃ¡ginas** de la _HP LaserJet 1200, HP LaserJet 4200N_ y _HP LaserJet 4250N_ **puede ser manipulado** dentro de un trabajo de impresiÃ³n. Al final del documento a imprimir y separado por el [UEL](./#uel), el contador simplemente debe restablecerse a su valor original (por ejemplo, `2342`):
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
Un atacante podrÃ­a establecer un nÃºmero negativo de pÃ¡ginas impresas. Tenga en cuenta que restablecer el dispositivo a [valores de fÃ¡brica](factory-defaults.md) tambiÃ©n **restablece el contador de pÃ¡ginas a cero en algunos** de los dispositivos probados.\
Reducir el contador de pÃ¡ginas tambiÃ©n se puede utilizar para **vender una impresora por encima de su precio** ya que se puede comparar con el odÃ³metro al comprar un coche de segunda mano. Sin embargo, vale la pena enfatizar que **restablecer el contador de pÃ¡ginas no es necesariamente para fines maliciosos**: es un modelo de negocio bien conocido vender tinta sobrevalorada para dispositivos de inyecciÃ³n de tinta de bajo costo y bloquear los kits de recarga de terceros al negarse a imprimir despuÃ©s de cierto nÃºmero de pÃ¡ginas - para manejar tales prÃ¡cticas poco Ã©ticas, es absolutamente legÃ­timo restablecer el contador de pÃ¡ginas.

En las impresoras HP antiguas, el comando `pagecount` de [PRET](https://github.com/RUB-NDS/PRET) se puede utilizar para establecer fÃ¡cilmente los contadores de pÃ¡ginas de hardware:
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## Contadores de pÃ¡ginas de software

**CUPS** utiliza **contadores de pÃ¡ginas de software** que se han implementado para todos los principales lenguajes de descripciÃ³n de pÃ¡ginas. Para PostScript, una forma sencilla de evitar la contabilizaciÃ³n es comprobar si existe el parÃ¡metro del sistema PageCount, que devolverÃ¡ falso al ser interpretado en CUPS/Ghostscript, antes de imprimir el documento, como se muestra a continuaciÃ³n.
```
currentsystemparams (PageCount) known {
  <@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
De esta manera, el software de contabilidad utilizado por CUPS genera un documento diferente al de la impresora. **CUPS solo tiene en cuenta una pÃ¡gina** - lo que parece ser un **mÃ­nimo codificado** - mientras que el trabajo de impresiÃ³n **real** puede contener **cientos de pÃ¡ginas**. Tenga en cuenta que el uso de la cola/opciÃ³n IPP "raw" es obligatorio, de lo contrario CUPS analiza el cÃ³digo con un filtro PostScript-to-PostScript (ps2write de Ghostscript) antes de que llegue al contador de pÃ¡ginas.

**Â¿CÃ³mo probar este ataque?**

**Envuelva** un **documento PostScript de varias pÃ¡ginas arbitrario** en el **cÃ³digo anterior** e imprÃ­malo. Luego vaya a [`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which\_jobs=all) y verifique el contador de pÃ¡ginas de CUPS para este trabajo de impresiÃ³n. Tenga en cuenta que debe establecer una cola en bruto. Es decir, una cola donde el sistema de filtrado no estÃ¡ involucrado y el trabajo de impresiÃ³n va directamente a una impresora. Para CUPS, esto se hace estableciendo el tipo de contenido en `application/vnd.cups-raw`. Si su sistema ya estÃ¡ configurado para usar el servidor de impresiÃ³n que se va a probar, simplemente use:
```
lp -o raw test.ps
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **grupo de Discord** o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme en** **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y al repositorio [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
