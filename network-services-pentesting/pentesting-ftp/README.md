# 21 - Pentesting FTP

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* 쯊rabajas en una **empresa de ciberseguridad**? 쯈uieres ver tu **empresa anunciada en HackTricks**? 쯆 quieres tener acceso a la **칰ltima versi칩n del PEASS o descargar HackTricks en PDF**? 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **칔nete al** [**游눫**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Grupo de Seguridad Try Hard**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Informaci칩n B치sica

El **Protocolo de Transferencia de Archivos (FTP)** sirve como un protocolo est치ndar para la transferencia de archivos a trav칠s de una red inform치tica entre un servidor y un cliente.\
Es un protocolo de **texto plano** que utiliza como **car치cter de nueva l칤nea `0x0d 0x0a`** por lo que a veces es necesario **conectar usando `telnet`** o **`nc -C`**.

**Puerto Predeterminado:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Conexiones Activas y Pasivas

En **FTP Activo**, el **cliente** FTP primero **inicia** la **conexi칩n de control** desde su puerto N al puerto de comandos del Servidor FTP, que es el puerto 21. El **cliente** luego **escucha** en el puerto **N+1** y env칤a el puerto N+1 al Servidor FTP. El Servidor FTP luego **inicia** la **conexi칩n de datos** desde **su puerto M al puerto N+1** del Cliente FTP.

Sin embargo, si el Cliente FTP tiene un firewall configurado que controla las conexiones de datos entrantes desde el exterior, entonces el FTP activo puede ser un problema. Y, una soluci칩n factible para eso es el FTP Pasivo.

En **FTP Pasivo**, el cliente inicia la conexi칩n de control desde su puerto N al puerto 21 del Servidor FTP. Despu칠s de esto, el cliente emite un comando **passv**. El servidor luego env칤a al cliente uno de sus n칰meros de puerto M. Y el **cliente** **inicia** la **conexi칩n de datos** desde **su puerto P al puerto M** del Servidor FTP.

Fuente: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Depuraci칩n de Conexiones

Los comandos **`debug`** y **`trace`** de **FTP** se pueden utilizar para ver **c칩mo se est치 produciendo la comunicaci칩n**.

## Enumeraci칩n

### Captura de Banner
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Conectar a FTP usando starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Enumeraci칩n sin autenticaci칩n

Con **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Puedes usar los comandos `HELP` y `FEAT` para obtener informaci칩n del servidor FTP:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Inicio de sesi칩n an칩nimo

_anonymous : anonymous_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Fuerza bruta](../../generic-methodologies-and-resources/brute-force.md#ftp)

Aqu칤 puedes encontrar una lista 칰til con credenciales FTP por defecto: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatizado

Las comprobaciones de inicio de sesi칩n an칩nimo y rebote FTP se realizan de forma predeterminada con nmap con la opci칩n **-sC** o:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Conexi칩n del navegador

Puedes conectarte a un servidor FTP utilizando un navegador (como Firefox) usando una URL como:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Ten en cuenta que si una **aplicaci칩n web** est치 enviando datos controlados por un usuario **directamente a un servidor FTP**, puedes enviar una doble codificaci칩n de URL `%0d%0a` (en doble codificaci칩n de URL esto es `%250d%250a`) y hacer que el **servidor FTP realice acciones arbitrarias**. Una de estas posibles acciones arbitrarias es descargar contenido de un servidor controlado por un usuario, realizar un escaneo de puertos o intentar comunicarse con otros servicios basados en texto sin formato (como http).

## Descargar todos los archivos del FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Si tu usuario/contrase침a tiene caracteres especiales, se puede usar el [siguiente comando](https://stackoverflow.com/a/113900/13647948):
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Algunos comandos FTP

* **`USER nombredeusuario`**
* **`PASS contrase침a`**
* **`HELP`** El servidor indica qu칠 comandos son compatibles
* \*\*`PORT 127,0,0,1,0,80`\*\* Esto indicar치 al servidor FTP establecer una conexi칩n con la IP 127.0.0.1 en el puerto 80 (_debes poner el quinto car치cter como "0" y el sexto como el puerto en decimal o usar el quinto y sexto para expresar el puerto en hexadecimal_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\* Esto indicar치 al servidor FTP establecer una conexi칩n TCP (_indicado por "2"_) con la IP 127.0.0.1 en el puerto 80. Este comando **soporta IPv6**.
* **`LIST`** Esto enviar치 la lista de archivos en la carpeta actual
* **`LIST -R`** Listar de forma recursiva (si lo permite el servidor)
* **`APPE /ruta/algo.txt`** Esto indicar치 al FTP almacenar los datos recibidos de una conexi칩n **pasiva** o de una conexi칩n **PORT/EPRT** en un archivo. Si el nombre de archivo existe, a침adir치 los datos.
* **`STOR /ruta/algo.txt`** Como `APPE` pero sobrescribir치 los archivos
* **`STOU /ruta/algo.txt`** Como `APPE`, pero si existe no har치 nada.
* **`RETR /ruta/al/archivo`** Debe establecerse una conexi칩n pasiva o de puerto. Luego, el servidor FTP enviar치 el archivo indicado a trav칠s de esa conexi칩n
* **`REST 6`** Esto indicar치 al servidor que la pr칩xima vez que env칤e algo usando `RETR` debe comenzar en el sexto byte.
* **`TYPE i`** Establecer la transferencia a binario
* **`PASV`** Esto abrir치 una conexi칩n pasiva e indicar치 al usuario d칩nde puede conectarse
* **`PUT /tmp/archivo.txt`** Subir el archivo indicado al FTP

![](<../../.gitbook/assets/image (227).png>)

## Ataque FTPBounce

Algunos servidores FTP permiten el comando PORT. Este comando se puede usar para indicar al servidor que desea conectarse a otro servidor FTP en alg칰n puerto. Luego, puede usar esto para escanear qu칠 puertos de un host est치n abiertos a trav칠s de un servidor FTP.

[**Aprende aqu칤 c칩mo abusar de un servidor FTP para escanear puertos.**](ftp-bounce-attack.md)

Tambi칠n podr칤as abusar de este comportamiento para hacer que un servidor FTP interact칰e con otros protocolos. Podr칤as **subir un archivo que contenga una solicitud HTTP** y hacer que el servidor FTP vulnerable **la env칤e a un servidor HTTP arbitrario** (_춰quiz치s para agregar un nuevo usuario administrador!_) o incluso subir una solicitud FTP y hacer que el servidor FTP vulnerable descargue un archivo para un servidor FTP diferente.\
La teor칤a es sencilla:

1. **Sube la solicitud (dentro de un archivo de texto) al servidor vulnerable.** Recuerda que si deseas comunicarte con otro servidor HTTP o FTP, debes cambiar las l칤neas con `0x0d 0x0a`
2. **Usa `REST X` para evitar enviar los caracteres que no deseas enviar** (quiz치s para subir la solicitud dentro del archivo necesitabas poner alg칰n encabezado de imagen al principio)
3. **Usa `PORT` para conectarte al servidor y servicio arbitrarios**
4. **Usa `RETR` para enviar la solicitud guardada al servidor.**

Es muy probable que esto **genere un error como** _**Socket no escribible**_ **porque la conexi칩n no dura lo suficiente para enviar los datos con `RETR`**. Algunas sugerencias para intentar evitarlo son:

* Si est치s enviando una solicitud HTTP, **pon la misma solicitud una tras otra** hasta **\~0.5MB** como m칤nimo. As칤:

{% file src="../../.gitbook/assets/posts (1).txt" %}
posts.txt
{% endfile %}

* Intenta **llenar la solicitud con datos "basura" relativos al protocolo** (hablando con FTP quiz치s solo comandos basura o repitiendo la instrucci칩n `RETR` para obtener el archivo)
* Simplemente **llena la solicitud con muchos caracteres nulos u otros** (divididos en l칤neas o no)

De todos modos, aqu칤 tienes un [ejemplo antiguo sobre c칩mo abusar de esto para hacer que un servidor FTP descargue un archivo de un servidor FTP diferente.](ftp-bounce-download-2oftp-file.md)

## Vulnerabilidad del Servidor Filezilla

**FileZilla** suele **vincularse** a un **servicio administrativo local** para el **Servidor FileZilla** (puerto 14147). Si puedes crear un **t칰nel** desde **tu m치quina** para acceder a este puerto, puedes **conectarte** a **칠l** usando una **contrase침a en blanco** y **crear** un **nuevo usuario** para el servicio FTP.

## Archivos de configuraci칩n
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Explotaci칩n

La configuraci칩n predeterminada de vsFTPd se puede encontrar en `/etc/vsftpd.conf`. Aqu칤, podr칤as encontrar algunas configuraciones peligrosas:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Directorio para an칩nimos.
* `chown_uploads=YES` - Cambiar la propiedad de los archivos cargados de forma an칩nima
* `chown_username=username` - Usuario al que se le da la propiedad de los archivos cargados de forma an칩nima
* `local_enable=YES` - Permitir a los usuarios locales iniciar sesi칩n
* `no_anon_password=YES` - No solicitar contrase침a a los an칩nimos
* `write_enable=YES` - Permitir comandos: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE y SITE

### Shodan

* `ftp`
* `port:21`

***

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Comandos Autom치ticos de HackTricks
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

* 쯊rabajas en una **empresa de ciberseguridad**? 쯈uieres ver tu **empresa anunciada en HackTricks**? 쯆 quieres tener acceso a la **칰ltima versi칩n del PEASS o descargar HackTricks en PDF**? 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt칠n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **칔nete al** [**游눫**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme en** **Twitter** 游냕[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
