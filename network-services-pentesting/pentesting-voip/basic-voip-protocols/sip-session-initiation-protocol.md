# SIP (Protocolo de Iniciaci贸n de Sesi贸n)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci贸n B谩sica

SIP (Protocolo de Iniciaci贸n de Sesi贸n) es un **protocolo de se帽alizaci贸n y control de llamadas** ampliamente utilizado para establecer, modificar y terminar sesiones multimedia, incluyendo voz, video y mensajer铆a instant谩nea, sobre redes IP. Desarrollado por el **Grupo de Trabajo de Ingenier铆a de Internet (IETF)**, SIP est谩 definido en **RFC 3261** y se ha convertido en el est谩ndar de facto para VoIP y comunicaciones unificadas.

Algunas caracter铆sticas clave de SIP incluyen:

1. **Protocolo Basado en Texto**: SIP es un protocolo basado en texto, lo que lo hace legible para humanos y m谩s f谩cil de depurar. Est谩 basado en un modelo de solicitud-respuesta, similar a HTTP, y utiliza m茅todos como INVITE, ACK, BYE y CANCEL para controlar sesiones de llamadas.
2. **Escalabilidad y Flexibilidad**: SIP es altamente escalable y puede ser utilizado en implementaciones a peque帽a escala, as铆 como en entornos empresariales grandes y de grado de operador. Puede ser f谩cilmente extendido con nuevas caracter铆sticas, lo que lo hace adaptable a varios casos de uso y requisitos.
3. **Interoperabilidad**: La amplia adopci贸n y estandarizaci贸n de SIP aseguran una mejor interoperabilidad entre diferentes dispositivos, aplicaciones y proveedores de servicios, promoviendo una comunicaci贸n fluida en diversas plataformas.
4. **Dise帽o Modular**: SIP trabaja con otros protocolos como **RTP (Protocolo de Transporte en Tiempo Real)** para la transmisi贸n de medios y **SDP (Protocolo de Descripci贸n de Sesi贸n)** para describir sesiones multimedia. Este dise帽o modular permite una mayor flexibilidad y compatibilidad con diferentes tipos de medios y c贸decs.
5. **Servidores Proxy y de Redirecci贸n**: SIP puede utilizar servidores proxy y de redirecci贸n para facilitar el enrutamiento de llamadas y proporcionar funciones avanzadas como reenv铆o de llamadas, transferencia de llamadas y servicios de correo de voz.
6. **Presencia y Mensajer铆a Instant谩nea**: SIP no se limita a la comunicaci贸n de voz y video. Tambi茅n soporta presencia y mensajer铆a instant谩nea, permitiendo una amplia gama de aplicaciones de comunicaci贸n unificada.

A pesar de sus muchas ventajas, SIP puede ser complejo de configurar y gestionar, especialmente al tratar con problemas de traves铆a NAT y cortafuegos. Sin embargo, su versatilidad, escalabilidad y amplio soporte en la industria lo convierten en una opci贸n popular para VoIP y comunicaci贸n multimedia.

### M茅todos SIP

Los m茅todos SIP principales definidos en **RFC 3261** incluyen:

1. **INVITE**: Utilizado para **iniciar una nueva sesi贸n (llamada)** o modificar una existente. El m茅todo INVITE lleva la descripci贸n de la sesi贸n (t铆picamente utilizando SDP) para informar al destinatario sobre los detalles de la sesi贸n propuesta, como tipos de medios, c贸decs y protocolos de transporte.
2. **ACK**: Enviado para **confirmar la recepci贸n** de una respuesta final a una solicitud INVITE. El m茅todo ACK asegura la fiabilidad de las transacciones INVITE proporcionando un acuse de recibo de extremo a extremo.
3. **BYE**: Utilizado para **terminar una sesi贸n establecida (llamada)**. El m茅todo BYE es enviado por cualquiera de las partes en la sesi贸n para indicar que desean finalizar la comunicaci贸n.
4. **CANCEL**: Enviado para **cancelar una solicitud INVITE pendiente** antes de que se establezca la sesi贸n. El m茅todo CANCEL permite al remitente abortar una transacci贸n INVITE si cambian de opini贸n o si no hay respuesta del destinatario.
5. **OPTIONS**: Utilizado para **consultar las capacidades de un servidor o agente de usuario SIP**. El m茅todo OPTIONS puede ser enviado para solicitar informaci贸n sobre m茅todos soportados, tipos de medios u otras extensiones sin establecer realmente una sesi贸n.
6. **REGISTER**: Utilizado por un agente de usuario para **registrar su ubicaci贸n actual con un servidor registrador SIP**. El m茅todo REGISTER ayuda a mantener un mapeo actualizado entre el URI SIP de un usuario y su direcci贸n IP actual, permitiendo el enrutamiento y entrega de llamadas.

{% hint style="warning" %}
Ten en cuenta que para llamar a alguien **no es necesario usar el REGISTER** para nada.\
Sin embargo, es posible que para realizar un **INVITE** el llamante necesite **autenticarse** primero o recibir谩 una respuesta **`401 Unauthorized`**.
{% endhint %}

Adem谩s de estos m茅todos principales, existen **varios m茅todos de extensi贸n SIP** definidos en otros RFC, como:

1. **SUBSCRIBE**: Definido en RFC 6665, el m茅todo SUBSCRIBE se utiliza para **solicitar notificaciones** sobre el estado de un recurso espec铆fico, como la presencia de un usuario o el estado de una llamada.
2. **NOTIFY**: Tambi茅n definido en RFC 6665, el m茅todo NOTIFY es enviado por un servidor para **informar a un agente de usuario suscrito** sobre cambios en el estado de un recurso monitoreado.
3. **REFER**: Definido en RFC 3515, el m茅todo REFER se utiliza para **solicitar que el destinatario realice una transferencia o se refiera a un tercero**. Esto se utiliza t铆picamente en escenarios de **transferencia de llamadas**.
4. **MESSAGE**: Definido en RFC 3428, el m茅todo MESSAGE se utiliza para **enviar mensajes instant谩neos entre agentes de usuario SIP**, permitiendo la comunicaci贸n basada en texto dentro del marco de SIP.
5. **UPDATE**: Definido en RFC 3311, el m茅todo UPDATE permite **modificar una sesi贸n sin afectar el estado del di谩logo existente**. Esto es 煤til para actualizar par谩metros de sesi贸n, como c贸decs o tipos de medios, durante una llamada en curso.
6. **PUBLISH**: Definido en RFC 3903, el m茅todo PUBLISH es utilizado por un agente de usuario para **publicar informaci贸n de estado de eventos en un servidor**, haci茅ndola disponible para otras partes interesadas.

### C贸digos de Respuesta SIP

* **1xx (Respuestas Provisionales)**: Estas respuestas indican que la solicitud fue recibida y el servidor contin煤a proces谩ndola.
* 100 Trying: La solicitud fue recibida y el servidor est谩 trabajando en ella.
* 180 Ringing: El destinatario est谩 siendo alertado y tomar谩 la llamada.
* 183 Session Progress: Proporciona informaci贸n sobre el progreso de la llamada.
* **2xx (Respuestas Exitosas)**: Estas respuestas indican que la solicitud fue recibida, entendida y aceptada con 茅xito.
* 200 OK: La solicitud fue exitosa y el servidor la ha cumplido.
* 202 Accepted: La solicitud fue aceptada para su procesamiento, pero a煤n no se ha completado.
* **3xx (Respuestas de Redirecci贸n)**: Estas respuestas indican que se requiere una acci贸n adicional para cumplir con la solicitud, t铆picamente contactando un recurso alternativo.
* 300 Multiple Choices: Hay m煤ltiples opciones disponibles y el usuario o cliente debe elegir una.
* 301 Moved Permanently: El recurso solicitado ha sido asignado a un nuevo URI permanente.
* 302 Moved Temporarily: El recurso solicitado est谩 temporalmente disponible en un URI diferente.
* 305 Use Proxy: La solicitud debe ser enviada a un proxy especificado.
* **4xx (Respuestas de Error del Cliente)**: Estas respuestas indican que la solicitud contiene una sintaxis incorrecta o no puede ser cumplida por el servidor.
* 400 Bad Request: La solicitud estaba mal formada o inv谩lida.
* 401 Unauthorized: La solicitud requiere autenticaci贸n de usuario.
* 403 Forbidden: El servidor entendi贸 la solicitud pero se niega a cumplirla.
* 404 Not Found: El recurso solicitado no se encontraba en el servidor.
* 408 Request Timeout: El servidor no recibi贸 una solicitud completa dentro del tiempo que estaba preparado para esperar.
* 486 Busy Here: El destinatario est谩 ocupado actualmente y no puede tomar la llamada.
* **5xx (Respuestas de Error del Servidor)**: Estas respuestas indican que el servidor no pudo cumplir con una solicitud v谩lida.
* 500 Internal Server Error: El servidor encontr贸 un error al procesar la solicitud.
* 501 Not Implemented: El servidor no soporta la funcionalidad requerida para cumplir con la solicitud.
* 503 Service Unavailable: El servidor actualmente no puede manejar la solicitud debido a mantenimiento o sobrecarga.
* **6xx (Respuestas de Fallo Global)**: Estas respuestas indican que la solicitud no puede ser cumplida por ning煤n servidor.
* 600 Busy Everywhere: Todos los destinos posibles para la llamada est谩n ocupados.
* 603 Decline: El destinatario no desea participar en la llamada.
* 604 Does Not Exist Anywhere: El recurso solicitado no est谩 disponible en ninguna parte de la red.
## Ejemplos

### Ejemplo de SIP INVITE
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Cada Par谩metro Explicado</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Esta l铆nea indica el m茅todo (INVITE), el URI de la solicitud (sip:[jdoe@example.com](mailto:jdoe@example.com)), y la versi贸n de SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - El encabezado Via especifica el protocolo de transporte (UDP) y la direcci贸n del cliente (pc33.example.com). El par谩metro "branch" se utiliza para la detecci贸n de bucles y la coincidencia de transacciones.
3. **Max-Forwards**: `Max-Forwards: 70` - Este campo de encabezado limita el n煤mero de veces que la solicitud puede ser reenviada por proxies para evitar bucles infinitos.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - El encabezado To especifica el destinatario de la llamada, incluyendo su nombre para mostrar (John Doe) y URI de SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - El encabezado From especifica el remitente de la llamada, incluyendo su nombre para mostrar (Jane Smith) y URI de SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). El par谩metro "tag" se utiliza para identificar de forma 煤nica el rol del remitente en el di谩logo.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - El encabezado Call-ID identifica de forma 煤nica una sesi贸n de llamada entre dos agentes de usuario.
7. **CSeq**: `CSeq: 314159 INVITE` - El encabezado CSeq contiene un n煤mero de secuencia y el m茅todo utilizado en la solicitud. Se utiliza para hacer coincidir respuestas con solicitudes y detectar mensajes fuera de orden.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - El encabezado Contact proporciona una ruta directa al remitente, que puede ser utilizada para solicitudes y respuestas posteriores.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - El encabezado User-Agent proporciona informaci贸n sobre el software o hardware del remitente, incluyendo su nombre y versi贸n.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - El encabezado Allow lista los m茅todos SIP admitidos por el remitente. Esto ayuda al destinatario a entender qu茅 m茅todos se pueden utilizar durante la comunicaci贸n.
11. **Content-Type**: `Content-Type: application/sdp` - El encabezado Content-Type especifica el tipo de medio del cuerpo del mensaje, en este caso, SDP (Protocolo de Descripci贸n de Sesi贸n).
12. **Content-Length**: `Content-Length: 142` - El encabezado Content-Length indica el tama帽o del cuerpo del mensaje en bytes.
13. **Cuerpo del Mensaje**: El cuerpo del mensaje contiene la descripci贸n de sesi贸n SDP, que incluye informaci贸n sobre los tipos de medios, c贸decs y protocolos de transporte para la sesi贸n propuesta.

* `v=0` - Versi贸n del protocolo (0 para SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Originador e identificador de sesi贸n
* `s=-` - Nombre de la sesi贸n (un guion indica que no hay nombre de sesi贸n)
* `c=IN IP4 pc33.example.com` - Informaci贸n de conexi贸n (tipo de red, tipo de direcci贸n y direcci贸n)
* `t=0 0` - Informaci贸n de temporizaci贸n (tiempos de inicio y finalizaci贸n, 0 0 significa que la sesi贸n no est谩 limitada)
* `m=audio 49170 RTP/AVP 0` - Descripci贸n de medios (tipo de medio, n煤mero de puerto, protocolo de transporte y lista de formatos). En este caso, especifica una transmisi贸n de audio utilizando RTP/AVP (Protocolo de Transporte en Tiempo Real / Perfil de Audio y Video) y formato 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atributo que asigna el formato (0) al c贸dec (PCMU) y su frecuencia de reloj (8000 Hz).

</details>

### Ejemplo de Registro SIP

El m茅todo REGISTER se utiliza en el Protocolo de Inicio de Sesi贸n (SIP) para permitir que un agente de usuario (UA), como un tel茅fono VoIP o un softphone, **registre su ubicaci贸n con un servidor registrador SIP**. Este proceso permite que el servidor sepa **d贸nde dirigir las solicitudes SIP entrantes destinadas al usuario registrado**. El servidor registrador suele ser parte de un servidor proxy SIP o un servidor de registro dedicado.

Aqu铆 tienes un ejemplo detallado de los mensajes SIP involucrados en un proceso de autenticaci贸n de REGISTRO:

1. Solicitud de **REGISTER** inicial del UA al servidor registrador:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Este mensaje REGISTER inicial es enviado por el UA (Alice) al servidor registrador. Incluye informaci贸n importante como la duraci贸n de registro deseada (Expires), el URI SIP del usuario (sip:[alice@example.com](mailto:alice@example.com)), y la direcci贸n de contacto del usuario (sip:alice@192.168.1.100:5060).

2. Respuesta **401 No autorizado** del servidor registrador:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
El servidor del registrador responde con un mensaje de "401 No autorizado", que incluye un encabezado "WWW-Authenticate". Este encabezado contiene la informaci贸n necesaria para que el UA se autentique, como el **reino de autenticaci贸n, nonce y algoritmo**.

3. Solicitud de REGISTRO **con credenciales de autenticaci贸n**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
El UA env铆a otra solicitud REGISTER, esta vez incluyendo el **encabezado "Authorization" con las credenciales necesarias, como el nombre de usuario, reino, nonce y un valor de respuesta** calculado utilizando la informaci贸n proporcionada y la contrase帽a del usuario.

As铆 es como se calcula la **respuesta de autorizaci贸n**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Respuesta de registro** exitosa del servidor registrador:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Despu茅s de que el servidor de registro verifica las credenciales proporcionadas, **env铆a una respuesta "200 OK" para indicar que el registro fue exitoso**. La respuesta incluye la informaci贸n de contacto registrada y el tiempo de expiraci贸n del registro. En este punto, el agente de usuario (Alice) est谩 registrado con 茅xito en el servidor de registro SIP, y las solicitudes SIP entrantes para Alice pueden ser dirigidas a la direcci贸n de contacto apropiada.

### Ejemplo de Llamada

<figure><img src="../../../.gitbook/assets/image (1101).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
No se menciona, pero el Usuario B necesita haber enviado un mensaje **REGISTER a Proxy 2** antes de poder recibir llamadas.
{% endhint %}
