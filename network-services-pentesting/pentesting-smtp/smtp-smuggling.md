# Contrabando SMTP

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci贸n B谩sica

Este tipo de vulnerabilidad fue [**descubierta originalmente en esta publicaci贸n**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) donde se explica que es posible **explotar discrepancias en c贸mo se interpreta el protocolo SMTP** al finalizar un correo electr贸nico, lo que permite a un atacante contrabandear m谩s correos electr贸nicos en el cuerpo del leg铆timo, permitiendo suplantar a otros usuarios del dominio afectado (como admin@outlook.com) eludiendo defensas como SPF.

### Por qu茅

Esto se debe a que en el protocolo SMTP, los **datos del mensaje** que se enviar谩n en el correo electr贸nico son controlados por un usuario (atacante) que podr铆a enviar datos especialmente dise帽ados abusando de las diferencias en los analizadores que contrabandear谩n correos electr贸nicos adicionales en el receptor. Echa un vistazo a este ejemplo ilustrado de la publicaci贸n original:

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### C贸mo

Para explotar esta vulnerabilidad, un atacante necesita enviar algunos datos que el **servidor SMTP saliente piensa que es solo 1 correo electr贸nico pero el servidor SMTP entrante piensa que hay varios correos electr贸nicos**.

Los investigadores descubrieron que diferentes **servidores entrantes consideran diferentes caracteres como el final de los datos** del mensaje de correo electr贸nico que los servidores salientes no consideran.\
Por ejemplo, un final regular de los datos es `\r\n.\r\n`. Pero si el servidor SMTP entrante tambi茅n admite `\n.\n`, un atacante podr铆a simplemente agregar **esos datos en su correo electr贸nico y comenzar a indicar los comandos SMTP** de uno nuevo para contrabandearlo como en la imagen anterior.

Por supuesto, esto solo funcionar铆a si el **servidor SMTP saliente tampoco trata estos datos** como el final de los datos del mensaje, porque en ese caso ver谩 2 correos electr贸nicos en lugar de solo 1, por lo que al final esta es la desincronizaci贸n que se est谩 explotando en esta vulnerabilidad.

Datos potenciales de desincronizaci贸n:

* `\n.\n`
* `\n.\r\n`

Tambi茅n tenga en cuenta que el SPF se evade porque si contrabandea un correo electr贸nico desde `admin@outlook.com` desde un correo electr贸nico de `user@outlook.com`, **el remitente sigue siendo `outlook.com`.**

## **Referencias**

* [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
