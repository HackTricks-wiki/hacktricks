# 11211 - Pentesting Memcache

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci贸n del Protocolo

Desde [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (pronunciaci贸n: mem-cached, mem-cash-dee) es un sistema de [cach茅 de memoria](https://en.wikipedia.org/wiki/Memory\_caching) distribuida de prop贸sito general. A menudo se utiliza para acelerar sitios web din谩micos basados en bases de datos mediante el almacenamiento en cach茅 de datos y objetos en RAM para reducir la cantidad de veces que se debe leer una fuente de datos externa (como una base de datos o una API).

Aunque Memcached admite SASL, la mayor铆a de las instancias est谩n **expuestas sin autenticaci贸n**.

**Puerto predeterminado:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumeraci贸n

### Manual

Para extraer toda la informaci贸n guardada dentro de una instancia de memcache necesitas:

1. Encontrar **slabs** con **elementos activos**
2. Obtener los **nombres de clave** de los slabs detectados anteriormente
3. Exfiltrar los **datos guardados** obteniendo los nombres de clave

Recuerda que este servicio es solo una **cach茅**, por lo que **los datos pueden aparecer y desaparecer**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2

#### Memcached

Memcached es un sistema de almacenamiento en cach茅 de objetos de alto rendimiento. Es com煤nmente utilizado para acelerar aplicaciones web al almacenar en cach茅 datos y objetos en la memoria RAM. Memcached escucha en el puerto 11211 por defecto y no tiene autenticaci贸n habilitada de forma predeterminada. Esto puede llevar a vulnerabilidades de seguridad si no se configura adecuadamente. 

#### Escaneo de Memcached

Puedes escanear en busca de servidores Memcached abiertos utilizando herramientas como `nmap` o `masscan`. Una vez identificados los servidores Memcached, puedes intentar acceder a ellos y realizar pruebas de penetraci贸n para identificar posibles vulnerabilidades y configuraciones incorrectas. 

#### Ataques a Memcached

Algunos ataques comunes a servidores Memcached abiertos incluyen la amplificaci贸n de ataques DDoS, donde un atacante puede enviar solicitudes falsificadas a un servidor Memcached y hacer que responda con una cantidad mucho mayor de datos, lo que puede abrumar al objetivo del ataque. Es importante asegurarse de que los servidores Memcached est茅n correctamente configurados y protegidos para evitar este tipo de ataques.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Autom谩tico
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Volcado de Claves de Memcache**

En el 谩mbito de memcache, un protocolo que ayuda a organizar datos por fragmentos, existen comandos espec铆ficos para inspeccionar los datos almacenados, aunque con limitaciones notables:

1. Las claves solo se pueden volcar por clase de fragmento, agrupando claves de tama帽o de contenido similar.
2. Existe un l铆mite de una p谩gina por clase de fragmento, lo que equivale a 1 MB de datos.
3. Esta funci贸n es no oficial y puede ser descontinuada en cualquier momento, como se discute en los [foros comunitarios](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

La limitaci贸n de solo poder volcar 1 MB de potencialmente gigabytes de datos es particularmente significativa. Sin embargo, esta funcionalidad a煤n puede ofrecer informaci贸n sobre patrones de uso de claves, dependiendo de necesidades espec铆ficas. Para aquellos menos interesados en la mec谩nica, una visita a la [secci贸n de herramientas](https://lzone.de/cheat-sheet/memcached#tools) revela utilidades para volcados completos. Alternativamente, se describe a continuaci贸n el proceso de usar telnet para interactuar directamente con configuraciones de memcached.

### **C贸mo Funciona**

La organizaci贸n de la memoria de Memcache es fundamental. Iniciar memcache con la opci贸n "-vv" revela las clases de fragmentos que genera, como se muestra a continuaci贸n:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Para mostrar todas las losas actualmente existentes, se utiliza el siguiente comando:
```bash
stats slabs
```
A帽adir una clave 煤nica a memcached 1.4.13 ilustra c贸mo se poblaron y gestionaron las clases de fragmentos. Por ejemplo:
```bash
set mykey 0 60 1
1
STORED
```
Ejecutar el comando "stats slabs" despu茅s de agregar una clave proporciona estad铆sticas detalladas sobre la utilizaci贸n de las placas:
```bash
stats slabs
[...]
```
Este resultado revela los tipos de fragmentos activos, los fragmentos utilizados y las estad铆sticas operativas, ofreciendo informaci贸n sobre la eficiencia de las operaciones de lectura y escritura.

Otro comando 煤til, "stats items", proporciona datos sobre las evicciones, las limitaciones de memoria y los ciclos de vida de los elementos:
```bash
stats items
[...]
```
### **Volcado de Claves**

Para versiones anteriores a 1.4.31, las claves se vuelcan por clase de fragmento usando:
```bash
stats cachedump <slab class> <number of items to dump>
```
Por ejemplo, para volcar una clave en la clase #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Este m茅todo itera sobre las clases de fragmentos, extrayendo y opcionalmente volcando los valores de las claves.

### **VOLCADO DE CLAVES DE MEMCACHE (VER 1.4.31+)**

Con la versi贸n de memcache 1.4.31 y superior, se introduce un nuevo m茅todo m谩s seguro para volcar claves en un entorno de producci贸n, utilizando el modo no bloqueante como se detalla en las [notas de la versi贸n](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Este enfoque genera una salida extensa, por lo tanto, se recomienda emplear el comando 'nc' para mayor eficiencia. Ejemplos incluyen:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **HERRAMIENTAS DE VOLCADO**

Tabla [desde aqu铆](https://lzone.de/blog).

| Lenguajes de Programaci贸n | Herramientas                                                                                                                      | Funcionalidad                                                                                           |                                                                             |         |
| ------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                       | [script simple](http://snipt.org/xtP)                                                                                            | Imprime nombres de claves.                                                                              |                                                                             |         |
| Perl                      | [script simple](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime claves y valores.                                                                               |                                                                             |         |
| Ruby                      | [script simple](https://gist.github.com/1365005)                                                                                 | Imprime nombres de claves.                                                                              |                                                                             |         |
| Perl                      | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                       | Herramienta en m贸dulo CPAN.                                                                            | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                       | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                        | GUI de Monitoreo de Memcache que tambi茅n permite el volcado de claves.                                   |                                                                             |         |
| libmemcached              | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                            | **隆Congela tu proceso de memcached!** Ten cuidado al usar esto en producci贸n. A煤n as铆, puedes evitar la limitaci贸n de 1MB y realmente volcar **todas** las claves. |                                                                             |         |

## Soluci贸n de Problemas <a href="#troubleshooting" id="troubleshooting"></a>

### L铆mite de Datos de 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Ten en cuenta que antes de memcached 1.4 no puedes almacenar objetos mayores a 1MB debido al tama帽o m谩ximo de fragmento predeterminado.

### 隆Nunca Establezcas un Tiempo de Espera > 30 D铆as! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Si intentas "establecer" o "agregar" una clave con un tiempo de espera mayor al m谩ximo permitido, es posible que no obtengas lo que esperas, ya que memcached trata el valor como una marca de tiempo Unix. Adem谩s, si la marca de tiempo est谩 en el pasado, no har谩 nada en absoluto. Tu comando fallar谩 silenciosamente.

Por lo tanto, si deseas utilizar el tiempo de vida m谩ximo, especifica 2592000. Ejemplo:
```
set my_key 0 2592000 1
1
```
### Claves que desaparecen al desbordarse <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

A pesar de que la documentaci贸n menciona algo sobre envolver alrededor de 64 bits al desbordar un valor usando "incr", hace que el valor desaparezca. Es necesario crearlo nuevamente usando "add"/"set".

### Replicaci贸n <a href="#replication" id="replication"></a>

memcached en s铆 no admite replicaci贸n. Si realmente la necesitas, debes usar soluciones de terceros:

* [repcached](http://repcached.lab.klab.org/): Replicaci贸n as铆ncrona multi-maestro (conjunto de parches de memcached 1.2)
* [Interfaz de memcached de Couchbase](http://www.couchbase.com/memcached): Usa CouchBase como reemplazo de memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): Almacenamiento de clave-valor maestro-esclavo compatible con memcached
* [twemproxy](https://github.com/twitter/twemproxy) (tambi茅n conocido como nutcracker): proxy con soporte para memcached

### Hoja de trucos de comandos

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Referencias

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
