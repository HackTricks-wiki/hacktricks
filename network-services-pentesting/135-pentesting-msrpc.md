# 135, 593 - Pentesting MSRPC

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**oficial mercanc铆a de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

nete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores!

**Perspectivas de Hacking**\
Invol煤crate con contenido que profundiza en la emoci贸n y desaf铆os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente actualizado con el mundo del hacking de ritmo r谩pido a trav茅s de noticias e informaci贸n en tiempo real

**ltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por errores que se lanzan y las actualizaciones cruciales de la plataforma

**nete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

## Informaci贸n B谩sica

El protocolo de Llamada a Procedimiento Remoto de Microsoft (MSRPC), un modelo cliente-servidor que permite a un programa solicitar un servicio de un programa ubicado en otra computadora sin entender los detalles de la red, se deriv贸 inicialmente de software de c贸digo abierto y posteriormente fue desarrollado y protegido por derechos de autor por Microsoft.

El mapeador de puntos finales de RPC se puede acceder a trav茅s de los puertos TCP y UDP 135, SMB en TCP 139 y 445 (con una sesi贸n nula o autenticada), y como un servicio web en el puerto TCP 593.
```
135/tcp   open     msrpc         Microsoft Windows RPC
```
## 驴C贸mo funciona MSRPC?

Iniciado por la aplicaci贸n cliente, el proceso MSRPC implica llamar a un procedimiento de stub local que luego interact煤a con la biblioteca de tiempo de ejecuci贸n del cliente para preparar y transmitir la solicitud al servidor. Esto incluye convertir par谩metros en un formato est谩ndar de Representaci贸n de Datos de Red. La elecci贸n del protocolo de transporte es determinada por la biblioteca de tiempo de ejecuci贸n si el servidor es remoto, asegurando que el RPC se entregue a trav茅s de la pila de red.

![https://0xffsec.com/handbook/images/msrpc.png](https://0xffsec.com/handbook/images/msrpc.png)

## **Identificaci贸n de Servicios RPC Expuestos**

La exposici贸n de servicios RPC a trav茅s de TCP, UDP, HTTP y SMB puede determinarse consultando el servicio localizador de RPC y los puntos finales individuales. Herramientas como rpcdump facilitan la identificaci贸n de servicios RPC 煤nicos, denotados por los valores de **IFID**, revelando detalles del servicio y enlaces de comunicaci贸n:
```
D:\rpctools> rpcdump [-p port] <IP>
**IFID**: 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc version 1.0
Annotation: Messenger Service
UUID: 00000000-0000-0000-0000-000000000000
Binding: ncadg_ip_udp:<IP>[1028]
```
El acceso al servicio de localizaci贸n de RPC est谩 habilitado a trav茅s de protocolos espec铆ficos: ncacn\_ip\_tcp y ncadg\_ip\_udp para acceder a trav茅s del puerto 135, ncacn\_np para conexiones SMB, y ncacn\_http para comunicaci贸n RPC basada en web. Los siguientes comandos ejemplifican la utilizaci贸n de m贸dulos de Metasploit para auditar e interactuar con servicios MSRPC, centr谩ndose principalmente en el puerto 135:
```bash
use auxiliary/scanner/dcerpc/endpoint_mapper
use auxiliary/scanner/dcerpc/hidden
use auxiliary/scanner/dcerpc/management
use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor
rpcdump.py <IP> -p 135
```
Todas las opciones excepto `tcp_dcerpc_auditor` est谩n espec铆ficamente dise帽adas para apuntar a MSRPC en el puerto 135.

#### Interfaces RPC destacadas

* **IFID**: 12345778-1234-abcd-ef00-0123456789ab
* **Named Pipe**: `\pipe\lsarpc`
* **Descripci贸n**: Interfaz LSA, utilizada para enumerar usuarios.


* **IFID**: 3919286a-b10c-11d0-9ba8-00c04fd92ef5
* **Named Pipe**: `\pipe\lsarpc`
* **Descripci贸n**: Interfaz de Servicios de Directorio (DS) de LSA, utilizada para enumerar dominios y relaciones de confianza.


* **IFID**: 12345778-1234-abcd-ef00-0123456789ac
* **Named Pipe**: `\pipe\samr`
* **Descripci贸n**: Interfaz SAMR de LSA, utilizada para acceder a elementos p煤blicos de la base de datos SAM (por ejemplo, nombres de usuario) y forzar contrase帽as de usuario independientemente de la pol铆tica de bloqueo de cuentas.


* **IFID**: 1ff70682-0a51-30e8-076d-740be8cee98b
* **Named Pipe**: `\pipe\atsvc`
* **Descripci贸n**: Programador de tareas, utilizado para ejecutar comandos de forma remota.


* **IFID**: 338cd001-2244-31f1-aaaa-900038001003
* **Named Pipe**: `\pipe\winreg`
* **Descripci贸n**: Servicio de registro remoto, utilizado para acceder y modificar el registro del sistema.


* **IFID**: 367abb81-9844-35f1-ad32-98f038001003
* **Named Pipe**: `\pipe\svcctl`
* **Descripci贸n**: Administrador de control de servicios y servicios de servidor, utilizado para iniciar y detener servicios de forma remota y ejecutar comandos.


* **IFID**: 4b324fc8-1670-01d3-1278-5a47bf6ee188
* **Named Pipe**: `\pipe\srvsvc`
* **Descripci贸n**: Administrador de control de servicios y servicios de servidor, utilizado para iniciar y detener servicios de forma remota y ejecutar comandos.


* **IFID**: 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57
* **Named Pipe**: `\pipe\epmapper`
* **Descripci贸n**: Interfaz DCOM, utilizada para forzar contrase帽as y recopilar informaci贸n a trav茅s de WM.

### Identificaci贸n de direcciones IP

Utilizando [https://github.com/mubix/IOXIDResolver](https://github.com/mubix/IOXIDResolver), proveniente de la investigaci贸n de [Airbus](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/), es posible abusar del m茅todo _**ServerAlive2**_ dentro de la interfaz _**IOXIDResolver**_.

Este m茅todo ha sido utilizado para obtener informaci贸n de interfaz como la direcci贸n **IPv6** de la m谩quina HTB _APT_. Ver [aqu铆](https://0xdf.gitlab.io/2021/04/10/htb-apt.html) el an谩lisis de 0xdf sobre APT, incluye un m茅todo alternativo utilizando rpcmap.py de [Impacket](https://github.com/SecureAuthCorp/impacket/) con _stringbinding_ (ver arriba).

### Ejecutando un RCE con credenciales v谩lidas

Es posible ejecutar c贸digo remoto en una m谩quina si se dispone de las credenciales de un usuario v谩lido utilizando [dcomexec.py](https://github.com/fortra/impacket/blob/master/examples/dcomexec.py) del framework Impacket.

**Recuerda probar con los diferentes objetos disponibles**
* ShellWindows
* ShellBrowserWindow
* MMC20


## Puerto 593

El **rpcdump.exe** de [rpctools](https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools) puede interactuar con este puerto.

## Referencias
* [https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)
* [https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/](https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/)
* [https://0xffsec.com/handbook/services/msrpc/](https://0xffsec.com/handbook/services/msrpc/)

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

nete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers y cazadores de bugs experimentados!

**Perspectivas de Hacking**\
Invol煤crate con contenido que explora la emoci贸n y los desaf铆os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente al d铆a con el mundo del hacking a trav茅s de noticias e informaci贸n en tiempo real

**ltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por bugs y actualizaciones importantes de plataformas

**nete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!
