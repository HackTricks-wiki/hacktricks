# Metodolog铆a de Pentesting de Extensiones del Navegador

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Informaci贸n B谩sica

Las extensiones del navegador est谩n escritas en JavaScript y se cargan en segundo plano por el navegador. Tienen su [DOM](https://www.w3schools.com/js/js_htmldom.asp) pero pueden interactuar con los DOM de otros sitios. Esto significa que pueden comprometer la confidencialidad, integridad y disponibilidad (CIA) de otros sitios.

## Componentes Principales

Los dise帽os de las extensiones se ven mejor cuando se visualizan y constan de tres componentes. Veamos cada componente en detalle.

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Scripts de Contenido**

Cada script de contenido tiene acceso directo al DOM de una **煤nica p谩gina web** y, por lo tanto, est谩 expuesto a **entradas potencialmente maliciosas**. Sin embargo, el script de contenido no tiene permisos aparte de la capacidad de enviar mensajes al n煤cleo de la extensi贸n.

### **N煤cleo de la Extensi贸n**

El n煤cleo de la extensi贸n contiene la mayor铆a de los privilegios/accesos de la extensi贸n, pero solo puede interactuar con el contenido web a trav茅s de [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) y scripts de contenido. Adem谩s, el n煤cleo de la extensi贸n no tiene acceso directo a la m谩quina host.

### **Binario Nativo**

La extensi贸n permite un binario nativo que puede **acceder a la m谩quina host con los privilegios completos del usuario.** El binario nativo interact煤a con el n煤cleo de la extensi贸n a trav茅s de la Interfaz de Programaci贸n de Aplicaciones de Plugin de Netscape est谩ndar ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) utilizada por Flash y otros complementos del navegador.

### L铆mites

{% hint style="danger" %}
Para obtener los privilegios completos del usuario, un atacante debe convencer a la extensi贸n de pasar una entrada maliciosa desde el script de contenido al n煤cleo de la extensi贸n y desde el n煤cleo de la extensi贸n al binario nativo.
{% endhint %}

Cada componente de la extensi贸n est谩 separado entre s铆 por **fuertes l铆mites de protecci贸n**. Cada componente se ejecuta en un **proceso de sistema operativo separado**. Los scripts de contenido y los n煤cleos de extensi贸n se ejecutan en **procesos de sandbox** no disponibles para la mayor铆a de los servicios del sistema operativo.

Adem谩s, los scripts de contenido se separan de sus p谩ginas web asociadas al **ejecutarse en un mont贸n de JavaScript separado**. El script de contenido y la p谩gina web tienen **acceso al mismo DOM subyacente**, pero los dos **nunca intercambian punteros de JavaScript**, evitando la filtraci贸n de funcionalidades de JavaScript.

## **`manifest.json`**

Una extensi贸n de Chrome es simplemente una carpeta ZIP con una extensi贸n de archivo [.crx](https://www.lifewire.com/crx-file-2620391). El n煤cleo de la extensi贸n es el archivo **`manifest.json`** en la ra铆z de la carpeta, que especifica el dise帽o, los permisos y otras opciones de configuraci贸n.

Ejemplo:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Los scripts de contenido se **cargan** cada vez que el usuario **navega a una p谩gina coincidente**, en nuestro caso cualquier p谩gina que coincida con la expresi贸n **`https://example.com/*`** y no coincida con el regex **`*://*/*/business*`**. Se ejecutan **como los propios scripts de la p谩gina** y tienen acceso arbitrario al [Modelo de Objetos del Documento (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model) de la p谩gina.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Para incluir o excluir m谩s URLs tambi茅n es posible utilizar **`include_globs`** y **`exclude_globs`**.

Este es un ejemplo de script de contenido que agregar谩 un bot贸n de explicaci贸n a la p谩gina cuando [la API de almacenamiento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para recuperar el valor `message` del almacenamiento de la extensi贸n.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Un mensaje es enviado a las p谩ginas de extensi贸n por el script de contenido cuando se hace clic en este bot贸n, a trav茅s de la utilizaci贸n de la [**API runtime.sendMessage()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Esto se debe a la limitaci贸n del script de contenido en el acceso directo a las APIs, siendo `storage` una de las pocas excepciones. Para funcionalidades m谩s all谩 de estas excepciones, se env铆an mensajes a las p谩ginas de extensi贸n con las que los scripts de contenido pueden comunicarse.

{% hint style="warning" %}
Dependiendo del navegador, las capacidades del script de contenido pueden variar ligeramente. Para los navegadores basados en Chromium, la lista de capacidades est谩 disponible en la [documentaci贸n de Chrome Developers](https://developer.chrome.com/docs/extensions/mv3/content_scripts/#capabilities), y para Firefox, la [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#webextension_apis) sirve como fuente principal.\
Tambi茅n es importante destacar que los scripts de contenido tienen la capacidad de comunicarse con scripts de fondo, lo que les permite realizar acciones y transmitir respuestas de vuelta.
{% endhint %}

Para ver y depurar scripts de contenido en Chrome, se puede acceder al men煤 de herramientas para desarrolladores de Chrome desde Opciones > M谩s herramientas > Herramientas para desarrolladores O presionando Ctrl + Shift + I.

Una vez que se muestren las herramientas para desarrolladores, se debe hacer clic en la pesta帽a **Source**, seguida de la pesta帽a **Content Scripts**. Esto permite observar los scripts de contenido en ejecuci贸n de varias extensiones y establecer puntos de interrupci贸n para rastrear el flujo de ejecuci贸n.

### Scripts de contenido inyectados

{% hint style="success" %}
Tenga en cuenta que los **Scripts de Contenido no son obligatorios** ya que tambi茅n es posible **inyectar scripts din谩micamente** y **inyectarlos program谩ticamente** en p谩ginas web a trav茅s de **`tabs.executeScript`**. Esto proporciona en realidad un mayor **control granular**.
{% endhint %}

Para la inyecci贸n program谩tica de un script de contenido, la extensi贸n debe tener [permisos de host](https://developer.chrome.com/docs/extensions/reference/permissions) para la p谩gina en la que se van a inyectar los scripts. Estos permisos pueden ser asegurados ya sea solicit谩ndolos dentro del manifiesto de la extensi贸n o de forma temporal a trav茅s de [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Ejemplo de extensi贸n basada en activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Inyectar un archivo JS al hacer clic:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Inyectar una funci贸n** al hacer clic:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Ejemplo con permisos de script
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
### Scripts de Contenido `run_at`

El campo `run_at` controla **cu谩ndo se inyectan archivos JavaScript en la p谩gina web**. El valor preferido y predeterminado es `"document_idle"`.

Los valores posibles son:

- **`document_idle`**: Siempre que sea posible
- **`document_start`**: Despu茅s de cualquier archivo `css`, pero antes de que se construya cualquier otro DOM o se ejecute cualquier otro script.
- **`document_end`**: Inmediatamente despu茅s de que el DOM est茅 completo, pero antes de que se carguen subrecursos como im谩genes y marcos.

#### A trav茅s de `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
A trav茅s de **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `antecedentes`

Los mensajes enviados por los scripts de contenido son recibidos por la **p谩gina de fondo**, la cual desempe帽a un papel central en la coordinaci贸n de los componentes de la extensi贸n. Es importante destacar que la p谩gina de fondo persiste a lo largo de la vida de la extensi贸n, operando discretamente sin interacci贸n directa del usuario. Posee su propio Modelo de Objetos del Documento (DOM), lo que permite interacciones complejas y gesti贸n de estado.

**Puntos Clave**:

- **Rol de la P谩gina de Fondo:** Act煤a como el centro nervioso de la extensi贸n, garantizando la comunicaci贸n y coordinaci贸n entre las diversas partes de la extensi贸n.
- **Persistencia:** Es una entidad siempre presente, invisible para el usuario pero fundamental para la funcionalidad de la extensi贸n.
- **Generaci贸n Autom谩tica:** Si no se define expl铆citamente, el navegador crear谩 autom谩ticamente una p谩gina de fondo. Esta p谩gina generada autom谩ticamente incluir谩 todos los scripts de fondo especificados en el manifiesto de la extensi贸n, asegurando el funcionamiento sin problemas de las tareas de fondo de la extensi贸n.

{% hint style="success" %}
La conveniencia proporcionada por el navegador al generar autom谩ticamente una p谩gina de fondo (cuando no se declara expl铆citamente) garantiza que todos los scripts de fondo necesarios est茅n integrados y operativos, agilizando el proceso de configuraci贸n de la extensi贸n.
{% endhint %}

Ejemplo de script de fondo:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Utiliza la [API runtime.onMessage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) para escuchar mensajes. Cuando se recibe un mensaje `"explain"`, utiliza la [API tabs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) para abrir una p谩gina en una nueva pesta帽a.

Para depurar el script de fondo, puedes ir a los **detalles de la extensi贸n e inspeccionar el service worker**, esto abrir谩 las herramientas de desarrollo con el script de fondo:

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

### P谩ginas de opciones y otras

Las extensiones del navegador pueden contener varios tipos de p谩ginas:

* Las **p谩ginas de acci贸n** se muestran en un **men煤 desplegable al hacer clic en el 铆cono de la extensi贸n**.
* P谩ginas que la extensi贸n **cargar谩 en una nueva pesta帽a**.
* **P谩ginas de opciones**: Esta p谩gina se muestra encima de la extensi贸n al hacer clic. En el manifiesto anterior, pude acceder a esta p谩gina en `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` o haciendo clic en:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Ten en cuenta que estas p谩ginas no son persistentes como las p谩ginas de fondo, ya que cargan contenido din谩micamente seg煤n sea necesario. A pesar de esto, comparten ciertas capacidades con la p谩gina de fondo:

- **Comunicaci贸n con Scripts de Contenido:** Similar a la p谩gina de fondo, estas p谩ginas pueden recibir mensajes de scripts de contenido, facilitando la interacci贸n dentro de la extensi贸n.
- **Acceso a APIs Espec铆ficas de la Extensi贸n:** Estas p谩ginas tienen un amplio acceso a APIs espec铆ficas de la extensi贸n, sujeto a los permisos definidos para la extensi贸n.

### `permissions` y `host_permissions`

**`permissions`** y **`host_permissions`** son entradas del `manifest.json` que indicar谩n **qu茅 permisos** tiene la extensi贸n del navegador (almacenamiento, ubicaci贸n...) y en **qu茅 p谩ginas web**.

Dado que las extensiones del navegador pueden tener tanto **privilegios**, una maliciosa o comprometida podr铆a permitir al atacante **diferentes medios para robar informaci贸n sensible y espiar al usuario**.

Verifica c贸mo funcionan estos ajustes y c贸mo podr铆an ser abusados en:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

Una **pol铆tica de seguridad de contenido** tambi茅n puede declararse dentro del `manifest.json`. Si est谩 definida, podr铆a ser **vulnerable**.

La configuraci贸n predeterminada para las p谩ginas de extensiones del navegador es bastante restrictiva:
```bash
script-src 'self'; object-src 'self';
```
Para obtener m谩s informaci贸n sobre CSP y posibles bypass, consulta:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

para que una p谩gina web pueda acceder a una p谩gina de una Extensi贸n del Navegador, por ejemplo, una p谩gina `.html`, esta p谩gina debe ser mencionada en el campo **`web_accessible_resources`** del `manifest.json`.\
Por ejemplo:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Estas p谩ginas son accesibles en URL como:
```
chrome-extension://<extension-id>/message.html
```
En las extensiones p煤blicas el **identificador de extensi贸n es accesible**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

Sin embargo, si se utiliza el par谩metro `manifest.json` **`use_dynamic_url`**, este **id puede ser din谩mico**.

Permitir el acceso a estas p谩ginas hace que estas p谩ginas sean **potencialmente vulnerables a ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Permitir que estas p谩ginas se carguen solo por la extensi贸n y no por URLs aleatorias podr铆a prevenir ataques de ClickJacking.
{% endhint %}

### `externally_connectable`

Seg煤n la [**documentaci贸n**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), la propiedad del manifiesto `"externally_connectable"` declara **qu茅 extensiones y p谩ginas web pueden conectarse** a tu extensi贸n a trav茅s de [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) y [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Si la clave **`externally_connectable`** no est谩 declarada en el manifiesto de tu extensi贸n o se declara como **`"ids": ["*"]`**, **todas las extensiones pueden conectarse, pero ninguna p谩gina web puede conectarse**.
* Si se especifican **IDs espec铆ficos**, como en `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **solo esas aplicaciones** pueden conectarse.
* Si se especifican **coincidencias**, esas aplicaciones web podr谩n conectarse:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Si se especifica como vac铆o: **`"externally_connectable": {}`**, ninguna aplicaci贸n o web podr谩 conectarse.

Cuanto **menos extensiones y URLs** se indiquen aqu铆, **menor ser谩 la superficie de ataque**.

{% hint style="danger" %}
Si una p谩gina web **vulnerable a XSS o toma de control** est谩 indicada en **`externally_connectable`**, un atacante podr谩 **enviar mensajes directamente al script de fondo**, evitando por completo el Content Script y su CSP.

Por lo tanto, este es un **bypass muy poderoso**.
{% endhint %}

## Comunicaci贸n Web **锔** Content Script

Los entornos donde operan los **content scripts** y donde existen las p谩ginas host est谩n **separados** entre s铆, asegurando **aislamiento**. A pesar de este aislamiento, ambos tienen la capacidad de interactuar con el **Modelo de Objetos del Documento (DOM)** de la p谩gina, un recurso compartido. Para que la p谩gina host se comunique con el **content script**, o indirectamente con la extensi贸n a trav茅s del content script, es necesario utilizar el **DOM** al que ambas partes tienen acceso como canal de comunicaci贸n.

### Mensajes de Publicaci贸n

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Una comunicaci贸n segura de Post Message debe verificar la autenticidad del mensaje recibido, esto se puede hacer verificando:

- **`event.isTrusted`**: Esto es Verdadero solo si el evento fue desencadenado por la acci贸n de un usuario.
- El script de contenido podr铆a esperar un mensaje solo si el usuario realiza alguna acci贸n.
- **Dominio de origen**: podr铆a esperar un mensaje solo de una lista blanca de dominios.
- Si se usa una expresi贸n regular, tenga mucho cuidado.
- **Fuente**: `received_message.source !== window` se puede usar para verificar si el mensaje fue **de la misma ventana** donde el Script de Contenido est谩 escuchando.

Las verificaciones anteriores, incluso si se realizan, podr铆an ser vulnerables, as铆 que verifique en la siguiente p谩gina **posibles bypasses de Post Message**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Otra posible forma de comunicaci贸n podr铆a ser a trav茅s de **URLs de Iframe**, puedes encontrar un ejemplo en:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Esto no es "exactamente" una forma de comunicaci贸n, pero la **web y el script de contenido tendr谩n acceso al DOM web**. Por lo tanto, si el **script de contenido** est谩 leyendo alguna informaci贸n de 茅l, **confiando en el DOM web**, la web podr铆a **modificar estos datos** (porque la web no deber铆a ser confiable, o porque la web es vulnerable a XSS) y **comprometer el Script de Contenido**.

Tambi茅n puedes encontrar un ejemplo de un **XSS basado en DOM para comprometer una extensi贸n del navegador** en:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Informaci贸n Sensible en Memoria/C贸digo

Si una Extensi贸n del Navegador almacena **informaci贸n sensible dentro de su memoria**, esto podr铆a ser **volcado** (especialmente en m谩quinas Windows) y **buscado** para esta informaci贸n.

Por lo tanto, la memoria de la Extensi贸n del Navegador **no debe considerarse segura** y la **informaci贸n sensible** como credenciales o frases mnem贸nicas **no debe ser almacenada**.

Por supuesto, **no coloque informaci贸n sensible en el c贸digo**, ya que ser谩 **p煤blica**.

## Comunicaci贸n Script de Contenido **锔** Script de Fondo

Un Script de Contenido puede usar las funciones [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **o** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) para enviar un mensaje **serializable en JSON** de una sola vez.

Para manejar la **respuesta**, use la **Promesa** devuelta. Aunque, para compatibilidad con versiones anteriores, a煤n puede pasar un **callback** como 煤ltimo argumento.

Enviar una solicitud desde un **script de contenido** se ve as铆:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Enviar una solicitud desde la **extensi贸n** (generalmente un **script de fondo**). Un Script de Contenido puede utilizar las funciones, excepto que necesitas especificar a qu茅 pesta帽a enviarlo. Ejemplo de c贸mo enviar un mensaje al script de contenido en la pesta帽a seleccionada:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
En el **extremo receptor**, necesitas configurar un [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **escuchador de eventos** para manejar el mensaje. Esto se ve igual desde un script de contenido o una p谩gina de extensi贸n.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
En el ejemplo resaltado, **`sendResponse()`** se ejecut贸 de forma s铆ncrona. Para modificar el controlador de eventos `onMessage` para la ejecuci贸n as铆ncrona de `sendResponse()`, es imperativo incorporar `return true;`.

Una consideraci贸n importante es que en escenarios donde m煤ltiples p谩ginas est谩n configuradas para recibir eventos `onMessage`, **la primera p谩gina en ejecutar `sendResponse()`** para un evento espec铆fico ser谩 la 煤nica capaz de entregar la respuesta de manera efectiva. Cualquier respuesta posterior al mismo evento no ser谩 tomada en cuenta.

Al crear nuevas extensiones, la preferencia deber铆a ser hacia las promesas en lugar de los callbacks. En cuanto al uso de callbacks, la funci贸n `sendResponse()` se considera v谩lida solo si se ejecuta directamente dentro del contexto s铆ncrono, o si el controlador de eventos indica una operaci贸n as铆ncrona al devolver `true`. En caso de que ninguno de los controladores devuelva `true` o si la funci贸n `sendResponse()` es eliminada de la memoria (recolectada por el recolector de basura), el callback asociado con la funci贸n `sendMessage()` se activar谩 por defecto.


## Cargando una Extensi贸n en el Navegador

1. **Descarga** la Extensi贸n del Navegador y descompr铆mela
2. Ve a **`chrome://extensions/`** y **habilita** el `Modo de Desarrollador`
3. Haz clic en el bot贸n **`Cargar sin empaquetar`**

En **Firefox** ve a **`about:debugging#/runtime/this-firefox`** y haz clic en el bot贸n **`Cargar complemento temporal`**.

## Obteniendo el c贸digo fuente desde la tienda

El c贸digo fuente de una extensi贸n de Chrome se puede obtener a trav茅s de varios m茅todos. A continuaci贸n se detallan explicaciones e instrucciones para cada opci贸n.

### Descargar Extensi贸n como ZIP a trav茅s de la L铆nea de Comandos

El c贸digo fuente de una extensi贸n de Chrome se puede descargar como un archivo ZIP usando la l铆nea de comandos. Esto implica usar `curl` para obtener el archivo ZIP desde una URL espec铆fica y luego extraer el contenido del archivo ZIP a un directorio. A continuaci贸n se detallan los pasos:

1. Reemplaza `"extension_id"` con el ID real de la extensi贸n.
2. Ejecuta los siguientes comandos:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### Utilizar el sitio web CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Utilizar la extensi贸n CRX Viewer

Otro m茅todo conveniente es utilizar el Chrome Extension Source Viewer, que es un proyecto de c贸digo abierto. Se puede instalar desde la [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). El c贸digo fuente del visor est谩 disponible en su [repositorio de GitHub](https://github.com/Rob--W/crxviewer).

### Ver el c贸digo fuente de una extensi贸n instalada localmente

Las extensiones de Chrome instaladas localmente tambi茅n se pueden inspeccionar. As铆 es c贸mo:

1. Accede al directorio de perfil local de Chrome visitando `chrome://version/` y localizando el campo "Ruta del perfil".
2. Navega a la subcarpeta `Extensions/` dentro del directorio del perfil.
3. Esta carpeta contiene todas las extensiones instaladas, t铆picamente con su c贸digo fuente en un formato legible.

Para identificar las extensiones, puedes mapear sus IDs a nombres:

- Habilita el Modo Desarrollador en la p谩gina `about:extensions` para ver las IDs de cada extensi贸n.
- Dentro de la carpeta de cada extensi贸n, el archivo `manifest.json` contiene un campo `name` legible, lo que te ayuda a identificar la extensi贸n.

### Utilizar un Archivador de Archivos o Desempaquetador

Ve a la Chrome Web Store y descarga la extensi贸n. El archivo tendr谩 una extensi贸n `.crx`.
Cambia la extensi贸n del archivo de `.crx` a `.zip`.
Utiliza cualquier archivador de archivos (como WinRAR, 7-Zip, etc.) para extraer el contenido del archivo ZIP.

### Utilizar el Modo Desarrollador en Chrome

Abre Chrome y ve a `chrome://extensions/`.
Habilita "Modo desarrollador" en la esquina superior derecha.
Haz clic en "Cargar extensi贸n sin empaquetar...".
Navega al directorio de tu extensi贸n.
Esto no descarga el c贸digo fuente, pero es 煤til para ver y modificar el c贸digo de una extensi贸n ya descargada o desarrollada.

## Lista de Verificaci贸n de Auditor铆a de Seguridad

Aunque las Extensiones del Navegador tienen una **superficie de ataque limitada**, algunas de ellas podr铆an contener **vulnerabilidades** o **mejoras potenciales de endurecimiento**. Las siguientes son las m谩s comunes:

* [ ] **Limitar** tanto como sea posible los **`permisos`** solicitados
* [ ] **Limitar** tanto como sea posible los **`host_permissions`**
* [ ] Utilizar una **`content_security_policy`** **fuerte**
* [ ] **Limitar** tanto como sea posible los **`externally_connectable`**, si no se necesita ninguno y es posible, no dejarlo por defecto, especificar **`{}`**
* [ ] Si se menciona una **URL vulnerable a XSS o a toma de control**, un atacante podr谩 **enviar mensajes directamente a los scripts de fondo**. Un bypass muy poderoso.
* [ ] **Limitar** tanto como sea posible los **`web_accessible_resources`**, incluso vac铆o si es posible.
* [ ] Si **`web_accessible_resources`** no es ninguno, verificar [**ClickJacking**](browext-clickjacking.md)
* [ ] Si hay alguna **comunicaci贸n** desde la **extensi贸n** a la **p谩gina web**, [**verificar XSS**](browext-xss-example.md) **vulnerabilidades** causadas en la comunicaci贸n.
* [ ] Si se utilizan Mensajes Post, verificar [**vulnerabilidades de Mensajes Post**](../postmessage-vulnerabilities/)**.**
* [ ] Si el **Script de Contenido accede a detalles del DOM**, verificar que no est茅n introduciendo un XSS si son **modificados** por la web
* [ ] Hacer un 茅nfasis especial si esta comunicaci贸n tambi茅n est谩 involucrada en la **comunicaci贸n del Script de Contenido -> Script de Fondo**
* **La informaci贸n sensible no debe ser almacenada** dentro del c贸digo de la Extensi贸n del Navegador
* **La informaci贸n sensible no debe ser almacenada** en la memoria de la Extensi贸n del Navegador

## Herramientas

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Extrae cualquier extensi贸n de Chrome desde un enlace proporcionado de la tienda web de Chrome.
* **Visor de manifest.json**: simplemente muestra una versi贸n JSON embellecida del manifiesto de la extensi贸n.
* **An谩lisis de Huella Digital**: Detecci贸n de [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) y generaci贸n autom谩tica de JavaScript de huella digital de extensi贸n de Chrome.
* **An谩lisis Potencial de Clickjacking**: Detecci贸n de p谩ginas HTML de extensi贸n con la directiva [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) establecida. Estas son potencialmente vulnerables a clickjacking dependiendo del prop贸sito de las p谩ginas.
* **Visor de Advertencias de Permisos**: que muestra una lista de todas las advertencias de permisos de Chrome que se mostrar谩n al intentar instalar la extensi贸n.
* **Funci贸n(es) Peligrosa(s)**: muestra la ubicaci贸n de funciones peligrosas que podr铆an ser explotadas por un atacante (por ejemplo, funciones como innerHTML, chrome.tabs.executeScript).
* **Punto(s) de Entrada**: muestra d贸nde la extensi贸n recibe entrada de usuario/externa. Esto es 煤til para comprender el 谩rea de superficie de una extensi贸n y buscar puntos potenciales para enviar datos maliciosamente elaborados a la extensi贸n.
* Tanto los esc谩neres de Funci贸n(es) Peligrosa(s) como de Punto(s) de Entrada tienen lo siguiente para sus alertas generadas:
* Fragmento de c贸digo relevante y l铆nea que caus贸 la alerta.
* Descripci贸n del problema.
* Un bot贸n "Ver Archivo" para ver el archivo fuente completo que contiene el c贸digo.
* La ruta del archivo alertado.
* La URI completa de la extensi贸n de Chrome del archivo alertado.
* El tipo de archivo que es, como un script de P谩gina de Fondo, Script de Contenido, Acci贸n del Navegador, etc.
* Si la l铆nea vulnerable est谩 en un archivo JavaScript, las rutas de todas las p谩ginas donde est谩 incluido, as铆 como el tipo de estas p谩ginas y el estado de [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources).
* **Analizador y verificador de Bypass de Pol铆tica de Seguridad de Contenido (CSP)**: Esto se帽alar谩 debilidades en la CSP de tu extensi贸n y tambi茅n iluminar谩 cualquier forma potencial de eludir tu CSP debido a CDNs en lista blanca, etc.
* **Bibliotecas Vulnerables Conocidas**: Utiliza [Retire.js](https://retirejs.github.io/retire.js) para verificar cualquier uso de bibliotecas JavaScript conocidas como vulnerables.
* Descargar extensi贸n y versiones formateadas.
* Descargar la extensi贸n original.
* Descargar una versi贸n embellecida de la extensi贸n (HTML y JavaScript auto embellecidos).
* Cach茅 autom谩tico de los resultados del escaneo, ejecutar un escaneo de extensi贸n tomar谩 una buena cantidad de tiempo la primera vez que lo ejecutes. Sin embargo, la segunda vez, asumiendo que la extensi贸n no se haya actualizado, ser谩 casi instant谩nea debido a que los resultados est谩n en cach茅.
* URLs de Informes Enlazables, enlaces f谩ciles para compartir un informe de extensi贸n generado por tarnish.

### [Neto](https://github.com/elevenpaths/neto)

El Proyecto Neto es un paquete de Python 3 concebido para analizar y desentra帽ar caracter铆sticas ocultas de complementos y extensiones de navegadores conocidos como Firefox y Chrome. Automatiza el proceso de descomprimir los archivos empaquetados para extraer estas caracter铆sticas de recursos relevantes en una extensi贸n como `manifest.json`, carpetas de localizaci贸n o archivos fuente de Javascript y HTML.

## Referencias

* **Gracias a** [**@naivenom**](https://twitter.com/naivenom) **por la ayuda con esta metodolog铆a**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

<details>

<summary><strong>Aprende hacking de AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
