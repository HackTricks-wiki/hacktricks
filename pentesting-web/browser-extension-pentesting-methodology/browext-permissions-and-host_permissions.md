# BrowExt - permisos & host\_permissions

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

### **`permissions`**

Los permisos se definen en el archivo **`manifest.json`** de la extensi칩n utilizando la propiedad **`permissions`** y permiten el acceso a casi todo lo que un navegador puede acceder (Cookies o Almacenamiento F칤sico):

El manifiesto anterior declara que la extensi칩n requiere el permiso `storage`. Esto significa que puede usar [la API de almacenamiento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para guardar sus datos de forma persistente. A diferencia de las APIs de cookies o `localStorage` que ofrecen a los usuarios cierto nivel de control, **el almacenamiento de la extensi칩n normalmente solo se puede borrar desinstalando la extensi칩n**.

Una extensi칩n solicitar치 los permisos indicados en su archivo **`manifest.json`** y despu칠s de instalar la extensi칩n, puedes **siempre verificar sus permisos en tu navegador**, como se muestra en esta imagen:

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Puedes encontrar la [**lista completa de permisos que una Extensi칩n de Navegador Chromium puede solicitar aqu칤**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu칤**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

La configuraci칩n opcional pero poderosa **`host_permissions`** indica con qu칠 hosts la extensi칩n va a poder interactuar a trav칠s de apis como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), y [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Los siguientes `host_permissions` b치sicamente permiten todo en la web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
```markdown
Estos son los hosts a los que la extensi칩n del navegador puede acceder libremente. Esto se debe a que cuando una extensi칩n del navegador llama a **`fetch("https://gmail.com/")`**, no est치 restringida por CORS.

## Abusando de `permissions` y `host_permissions`

### Pesta침as

Adem치s, **`host_permissions`** tambi칠n desbloquean la funcionalidad "avanzada" de la [**API de pesta침as**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Permiten que la extensi칩n llame a [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) y no solo obtenga una **lista de las pesta침as del navegador del usuario** sino que tambi칠n aprenda qu칠 **p치gina web (es decir, direcci칩n y t칤tulo) est치 cargada**.

{% hint style="danger" %}
No solo eso, oyentes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **tambi칠n se vuelven mucho m치s 칰tiles**. Estos ser치n notificados cada vez que una nueva p치gina se cargue en una pesta침a.
{% endhint %}

### Ejecutando scripts de contenido <a href="#running-content-scripts" id="running-content-scripts"></a>

Los scripts de contenido no necesariamente se escriben est치ticamente en el manifiesto de la extensi칩n. Dados suficientes **`host_permissions`**, **las extensiones tambi칠n pueden cargarlos din치micamente llamando a** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **o** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas API permiten ejecutar no solo archivos contenidos en las extensiones como scripts de contenido sino tambi칠n **c칩digo arbitrario**. La primera permite pasar c칩digo JavaScript como una cadena, mientras que la segunda espera una funci칩n JavaScript, lo cual es menos propenso a vulnerabilidades de inyecci칩n. A칰n as칤, ambas API pueden causar estragos si se usan incorrectamente.

{% hint style="danger" %}
Adem치s de las capacidades anteriores, los scripts de contenido podr칤an, por ejemplo, **interceptar credenciales** a medida que se ingresan en las p치ginas web. Otra forma cl치sica de abusar de ellos es **inyectar publicidad** en cada sitio web. Agregar **mensajes de estafa** para abusar de la credibilidad de sitios web de noticias tambi칠n es posible. Finalmente, podr칤an **manipular sitios web bancarios** para desviar transferencias de dinero.
{% endhint %}

### Privilegios impl칤citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Algunos privilegios de extensi칩n **no tienen que declararse expl칤citamente**. Un ejemplo es la [API de pesta침as](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): su funcionalidad b치sica es accesible sin ning칰n privilegio. Cualquier extensi칩n puede ser notificada cuando abres y cierras pesta침as, simplemente no sabr치 a qu칠 sitio web corresponden estas pesta침as.

쯉uena demasiado inofensivo? La API [tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) es algo menos inofensiva. Se puede usar para **crear una nueva pesta침a**, esencialmente lo mismo que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) que cualquier sitio web puede llamar. Sin embargo, mientras que `window.open()` est치 sujeto al **bloqueador de ventanas emergentes, `tabs.create()` no lo est치**. 

{% hint style="danger" %}
Una extensi칩n puede crear cualquier n칰mero de pesta침as cuando quiera.
{% endhint %}

Si revisas los posibles par치metros de `tabs.create()`, tambi칠n notar치s que sus capacidades van m치s all치 de lo que `window.open()` tiene permitido controlar. Y mientras que Firefox no permite usar URIs `data:` con esta API, Chrome no tiene tal protecci칩n. **El uso de tales URIs en el nivel superior ha sido** [**prohibido debido a que se abus칩 de ellas para phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) es muy similar a `tabs.create()` pero **modificar치 una pesta침a existente**. Entonces, una extensi칩n maliciosa puede, por ejemplo, cargar arbitrariamente una p치gina de publicidad en una de tus pesta침as y tambi칠n puede activar la pesta침a correspondiente.

### Webcam, geolocalizaci칩n y amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Probablemente sepas que los sitios web pueden solicitar permisos especiales, por ejemplo, para acceder a tu webcam (herramientas de videoconferencia) o ubicaci칩n geogr치fica (mapas). Son caracter칤sticas con considerable potencial de abuso, por lo que los usuarios tienen que confirmar cada vez que todav칤a quieren esto.

{% hint style="danger" %}
No es as칤 con las extensiones de navegador. **Si una extensi칩n del navegador** [**quiere acceder a tu webcam o micr칩fono**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, solo necesita pedir permiso una vez**
{% endhint %}

T칤picamente, una extensi칩n lo har치 inmediatamente despu칠s de ser instalada. Una vez que se acepta este aviso, **el acceso a la webcam es posible en cualquier momento**, incluso si el usuario no est치 interactuando con la extensi칩n en ese momento. S칤, un usuario solo aceptar치 este aviso si la extensi칩n realmente necesita acceso a la webcam. Pero despu칠s de eso, tienen que confiar en que la extensi칩n no grabar치 nada en secreto.

Con acceso a [tu ubicaci칩n geogr치fica exacta](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) o [contenidos de tu portapapeles](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API), otorgar permiso expl칤citamente es innecesario por completo. **Una extensi칩n simplemente agrega `geolocation` o `clipboard` a la entrada de** [**permisos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de su manifiesto**. Estos privilegios de acceso se otorgan impl칤citamente cuando se instala la extensi칩n. Por lo tanto, una extensi칩n maliciosa o comprometida con estos privilegios puede crear tu perfil de movimiento o monitorear tu portapapeles en busca de contrase침as copiadas sin que te des cuenta de nada.

Agregar la palabra clave **`history`** a la entrada de [permisos](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) del manifiesto de la extensi칩n otorga **acceso a la** [**API de historial**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Permite recuperar todo el historial de navegaci칩n del usuario de una vez, sin esperar a que el usuario visite estos sitios web nuevamente.

El **permiso `bookmarks`** tiene un potencial de abuso similar, este permite **leer todos los marcadores a trav칠s de la** [**API de marcadores**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiso de almacenamiento <a href="#the-storage-permission" id="the-storage-permission"></a>

El almacenamiento de la extensi칩n es simplemente una colecci칩n de clave-valor, muy similar a [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que cualquier sitio web podr칤a usar. Por lo tanto, no se debe almacenar informaci칩n sensible aqu칤.

Sin embargo, las empresas de publicidad tambi칠n podr칤an abusar de este almacenamiento.

### M치s permisos

Puedes encontrar la [**lista completa de permisos que una Extensi칩n del Navegador Chromium puede solicitar aqu칤**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu칤**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Prevenci칩n <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Las pol칤ticas para desarrolladores de Google [proh칤ben expl칤citamente](https://developer.chrome.com/docs/webstore/program_policies/#permissions) solicitar m치s privilegios de los necesarios para que la extensi칩n funcione. En mi experiencia, esta regla de hecho funciona. Solo puedo pensar en un caso en el que una extensi칩n del navegador [solicit칩 demasiados privilegios](https://palant.info/2020/01/13/pwning-avast-secure-browser-for-fun-and-profit/#selecting-a-target), y esta extensi칩n en particular se distribu칤a con el navegador en lugar de a trav칠s de alguna tienda de complementos.

En algunos casos, los navegadores podr칤an hacerlo mejor para **limitar el potencial de abuso** de los privilegios de las extensiones. Por ejemplo, Chrome permite la grabaci칩n de pantalla a trav칠s de las API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) o [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/). El potencial de abuso es bajo porque la primera solo se puede iniciar como **respuesta a una acci칩n del usuario** (t칤picamente haciendo clic en el icono de la extensi칩n) mientras que la segunda muestra un aviso para seleccionar la ventana de la aplicaci칩n a grabar. Ambos son suficientes para evitar que las extensiones comiencen a grabar en silencio en segundo plano.

Sin embargo, tales mejoras de seguridad tienden a hacer que las extensiones sean **menos flexibles y menos amigables para el usuario**. Un buen ejemplo aqu칤 es el [permiso activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission). Su prop칩sito es hacer innecesario solicitar privilegios de host para todo internet. En su lugar, la **extensi칩n puede acceder a la pesta침a actual cuando se activa expl칤citamente**, t칤picamente haciendo clic en su icono.

Ese enfoque funciona bien para algunas extensiones, particularmente aquellas donde el usuario necesita activar expl칤citamente una acci칩n. No **funciona en escenarios donde las extensiones tienen que realizar su trabajo autom치ticamente** sin embargo (lo que significa ser m치s conveniente para el usuario) o donde la acci칩n de la extensi칩n no se puede ejecutar inmediatamente y requiere preparaci칩n.

## **Referencias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Aprende AWS hacking de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
```
