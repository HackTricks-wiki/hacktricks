# BrowExt - permisos y host\_permissions

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica

### **`permissions`**

Los permisos se definen en el archivo **`manifest.json`** de la extensi칩n utilizando la propiedad **`permissions`** y permiten acceder a casi cualquier cosa a la que un navegador pueda acceder (Cookies o Almacenamiento F칤sico):

El manifiesto anterior declara que la extensi칩n requiere el permiso `storage`. Esto significa que puede utilizar [la API de almacenamiento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para almacenar sus datos de forma persistente. A diferencia de las cookies o las APIs de `localStorage` que dan a los usuarios cierto nivel de control, **el almacenamiento de la extensi칩n normalmente solo se puede borrar desinstalando la extensi칩n**.

Una extensi칩n solicitar치 los permisos indicados en su archivo **`manifest.json`** y despu칠s de instalar la extensi칩n, siempre puedes **verificar sus permisos en tu navegador**, como se muestra en esta imagen:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Puedes encontrar la [**lista completa de permisos que una Extensi칩n del Navegador Chromium puede solicitar aqu칤**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu칤**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

El ajuste opcional pero poderoso **`host_permissions`** indica con qu칠 hosts la extensi칩n podr치 interactuar a trav칠s de APIs como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) y [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Los siguientes `host_permissions` b치sicamente permiten todo en la web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Estos son los hosts a los que la extensi칩n del navegador puede acceder libremente. Esto se debe a que cuando una extensi칩n del navegador llama a **`fetch("https://gmail.com/")`** no est치 restringida por CORS.

## Abusando de `permissions` y `host_permissions`

### Pesta침as

Adem치s, **`host_permissions`** tambi칠n desbloquean la funcionalidad "avanzada" de la [API de pesta침as](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Permiten que la extensi칩n llame a [tabs.query()](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) y no solo obtenga una **lista de pesta침as del navegador del usuario**, sino que tambi칠n sepa qu칠 **p치gina web (direcci칩n y t칤tulo) est치 cargada**.

{% hint style="danger" %}
No solo eso, los listeners como [**tabs.onUpdated**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **tambi칠n se vuelven mucho m치s 칰tiles**. Ser치n notificados cada vez que una nueva p치gina se cargue en una pesta침a.
{% endhint %}

### Ejecuci칩n de scripts de contenido <a href="#running-content-scripts" id="running-content-scripts"></a>

Los scripts de contenido no necesariamente est치n escritos est치ticamente en el manifiesto de la extensi칩n. Con suficientes **`host_permissions`**, las **extensiones tambi칠n pueden cargarlos din치micamente llamando** [**tabs.executeScript()**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **o** [**scripting.executeScript()**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas APIs permiten ejecutar no solo archivos contenidos en las extensiones como scripts de contenido, sino tambi칠n **c칩digo arbitrario**. La primera permite pasar c칩digo JavaScript como una cadena, mientras que la segunda espera una funci칩n JavaScript que es menos propensa a vulnerabilidades de inyecci칩n. Aun as칤, ambas APIs causar치n estragos si se usan incorrectamente.

{% hint style="danger" %}
Adem치s de las capacidades mencionadas anteriormente, los scripts de contenido podr칤an, por ejemplo, **interceptar credenciales** a medida que se ingresan en p치ginas web. Otra forma cl치sica de abusar de ellos es **inyectar publicidad** en cada sitio web. Agregar **mensajes de estafa** para abusar de la credibilidad de los sitios de noticias tambi칠n es posible. Finalmente, podr칤an **manipular sitios web bancarios** para redirigir transferencias de dinero.
{% endhint %}

### Privilegios impl칤citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Algunos privilegios de extensi칩n **no tienen que ser declarados expl칤citamente**. Un ejemplo es la [API de pesta침as](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs): su funcionalidad b치sica es accesible sin ning칰n privilegio. Cualquier extensi칩n puede ser notificada cuando abres y cierras pesta침as, simplemente no sabr치 con qu칠 sitio web corresponden esas pesta침as.

쯉uena demasiado inofensivo? La [API tabs.create()](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) es algo menos inofensiva. Se puede usar para **crear una nueva pesta침a**, esencialmente lo mismo que [window.open()](https://developer.mozilla.org/es/docs/Web/API/Window/open) que puede ser llamado por cualquier sitio web. Sin embargo, mientras `window.open()` est치 sujeto al **bloqueador de ventanas emergentes, `tabs.create()` no lo est치**.

{% hint style="danger" %}
Una extensi칩n puede crear cualquier cantidad de pesta침as cuando lo desee.
{% endhint %}

Si revisas los posibles par치metros de `tabs.create()`, tambi칠n notar치s que sus capacidades van mucho m치s all치 de lo que `window.open()` est치 autorizado a controlar. Y mientras Firefox no permite que se utilicen URIs `data:` con esta API, Chrome no tiene esa protecci칩n. **El uso de tales URIs en el nivel superior ha sido** [**prohibido debido a su abuso para phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) es muy similar a `tabs.create()` pero **modificar치 una pesta침a existente**. Por lo tanto, una extensi칩n maliciosa puede, por ejemplo, cargar arbitrariamente una p치gina de publicidad en una de tus pesta침as, y tambi칠n puede activar la pesta침a correspondiente.

### C치mara web, geolocalizaci칩n y amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Probablemente sepas que los sitios web pueden solicitar permisos especiales, por ejemplo, para acceder a tu c치mara web (herramientas de videoconferencia) o ubicaci칩n geogr치fica (mapas). Son funciones con un considerable potencial de abuso, por lo que los usuarios deben confirmar cada vez que desean permitirlo.

{% hint style="danger" %}
No es as칤 con las extensiones del navegador. **Si una extensi칩n del navegador** [**quiere acceder a tu c치mara web o micr칩fono**](https://developer.mozilla.org/es/docs/Web/API/MediaDevices/getUserMedia)**, solo necesita pedir permiso una vez**
{% endhint %}

Normalmente, una extensi칩n lo har치 inmediatamente despu칠s de ser instalada. Una vez que se acepta este aviso, **el acceso a la c치mara web es posible en cualquier momento**, incluso si el usuario no est치 interactuando con la extensi칩n en ese momento. S칤, un usuario solo aceptar치 este aviso si la extensi칩n realmente necesita acceso a la c치mara web. Pero despu칠s de eso, debe confiar en que la extensi칩n no grabar치 nada en secreto.

Con acceso a [tu ubicaci칩n geogr치fica exacta](https://developer.mozilla.org/es/docs/Web/API/Geolocation) o [contenido de tu portapapeles](https://developer.mozilla.org/es/docs/Web/API/Clipboard_API), no es necesario otorgar permiso expl칤citamente. **Una extensi칩n simplemente agrega `geolocation` o `clipboard` a la** [**entrada de permisos**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de su manifiesto**. Estos privilegios de acceso se otorgan impl칤citamente cuando se instala la extensi칩n. Por lo tanto, una extensi칩n maliciosa o comprometida con estos privilegios puede crear tu perfil de movimiento o monitorear tu portapapeles en busca de contrase침as copiadas sin que te des cuenta.

Agregar la palabra clave **`history`** a la [entrada de permisos](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) del manifiesto de la extensi칩n otorga **acceso a la** [**API de historial**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/history). Permite recuperar todo el historial de navegaci칩n del usuario de una vez, sin esperar a que el usuario visite estos sitios web nuevamente.

El permiso **`bookmarks`** tiene un potencial de abuso similar, este permite **leer todos los marcadores a trav칠s de la** [**API de marcadores**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiso de almacenamiento <a href="#the-storage-permission" id="the-storage-permission"></a>

El almacenamiento de la extensi칩n es simplemente una colecci칩n de clave-valor, muy similar a [localStorage](https://developer.mozilla.org/es/docs/Web/API/Window/localStorage) que cualquier sitio web podr칤a usar. Por lo tanto, no se debe almacenar informaci칩n sensible aqu칤.

Sin embargo, las compa침칤as de publicidad tambi칠n podr칤an abusar de este almacenamiento.

### M치s permisos

Puedes encontrar la [**lista completa de permisos que una Extensi칩n de Navegador Chromium puede solicitar aqu칤**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aqu칤**](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Prevenci칩n <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

La pol칤tica del desarrollador de Google proh칤be expl칤citamente a las extensiones solicitar m치s privilegios de los necesarios para su funcionalidad, mitigando efectivamente las solicitudes excesivas de permisos. Un caso en el que una extensi칩n del navegador sobrepas칩 este l칤mite involucr칩 su distribuci칩n con el navegador en s칤 en lugar de a trav칠s de una tienda de complementos.

Los navegadores podr칤an limitar a칰n m치s el uso indebido de los privilegios de extensi칩n. Por ejemplo, las APIs [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) y [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) de Chrome, utilizadas para grabaci칩n de pantalla, est치n dise침adas para minimizar el abuso. La API tabCapture solo puede activarse a trav칠s de interacci칩n directa del usuario, como hacer clic en el 칤cono de la extensi칩n, mientras que desktopCapture requiere confirmaci칩n del usuario para que la ventana sea grabada, evitando actividades de grabaci칩n clandestinas.

Sin embargo, endurecer las medidas de seguridad a menudo resulta en una disminuci칩n de la flexibilidad y la facilidad de uso de las extensiones. El permiso [activeTab](https://developer.mozilla.org/es/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission) ilustra este compromiso. Se introdujo para eliminar la necesidad de que las extensiones soliciten privilegios de host en toda la internet, permitiendo que las extensiones accedan solo a la pesta침a actual mediante activaci칩n expl칤cita por parte del usuario. Este modelo es efectivo para extensiones que requieren acciones iniciadas por el usuario, pero es insuficiente para aquellas que requieren acciones autom치ticas o preventivas, comprometiendo as칤 la conveniencia y la capacidad de respuesta inmediata.
## **Referencias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
