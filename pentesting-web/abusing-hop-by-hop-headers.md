# Cabeceras hop-by-hop

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad mÃ¡s relevante en **EspaÃ±a** y uno de los mÃ¡s importantes en **Europa**. Con **la misiÃ³n de promover el conocimiento tÃ©cnico**, este congreso es un punto de encuentro para profesionales de la tecnologÃ­a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Â¿QuÃ© es una cabecera hop-by-hop?

Una cabecera hop-by-hop es una cabecera diseÃ±ada para ser procesada y consumida por el proxy que maneja actualmente la solicitud, en lugar de una cabecera de extremo a extremo.

SegÃºn [RFC 2616](https://tools.ietf.org/html/rfc2616#section-13.5.1), la especificaciÃ³n HTTP/1.1 trata las siguientes cabeceras como hop-by-hop por defecto: `Keep-Alive`, `Transfer-Encoding`, `TE`, `Connection`, `Trailer`, `Upgrade`, `Proxy-Authorization` y `Proxy-Authenticate`. Al encontrar estas cabeceras en una solicitud, un proxy compatible debe procesar o realizar cualquier acciÃ³n que estas cabeceras indiquen, y no reenviarlas al siguiente salto.

AdemÃ¡s de estas opciones predeterminadas, una solicitud [tambiÃ©n puede definir un conjunto personalizado de cabeceras que se tratarÃ¡n como hop-by-hop](https://tools.ietf.org/html/rfc2616#section-14.10) agregÃ¡ndolas a la cabecera `Connection`, de la siguiente manera:
```
Connection: close, X-Foo, X-Bar
```
## TeorÃ­a sobre el abuso de encabezados hop-by-hop

En teorÃ­a, los proxies deberÃ­an eliminar los encabezados hop-by-hop recibidos antes de enviarlos a la siguiente direcciÃ³n. Pero se puede encontrar en la prÃ¡ctica que algunos proxies lo hacen y otros simplemente envÃ­an todos los encabezados agregando su propio encabezado `Connection`.

![](<../.gitbook/assets/image (138).png>)

## Pruebas de eliminaciÃ³n hop-by-hop

Si encuentra un encabezado que hace que la respuesta del servidor cambie si se establece o no, entonces puede buscar eliminaciones hop-by-hop. Por ejemplo, el encabezado de cookie harÃ¡ que la respuesta del servidor sea dramÃ¡ticamente diferente si se establece (con un contenido vÃ¡lido) y si no lo estÃ¡.

Por lo tanto, envÃ­e una solicitud con un encabezado vÃ¡lido y con este valor del encabezado Connection `Connection: close, Cookie` si la respuesta es la misma que si no se enviÃ³ la cookie, entonces hay un proxy que estÃ¡ eliminando encabezados.

Puede encontrar si la respuesta del servidor es diferente si se elimina un encabezado utilizando esta tÃ©cnica usando [este script](https://gist.github.com/ndavison/298d11b3a77b97c908d63a345d3c624d). Luego, si pasa una lista de encabezados conocidos, como [esta](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/BurpSuite-ParamMiner/lowercase-headers), puede observar quÃ© encabezados estÃ¡n causando efectos a pesar de no estar en su solicitud original:
```
for HEADER in $(cat headers.txt); do python poison-test.py -u "https://target" -x "$HEADER"; sleep 1; done
```
Este ciclo recorre toda la lista de encabezados e imprime si su presencia en la lista hop-by-hop creÃ³ un cÃ³digo de estado diferente o un tamaÃ±o de cuerpo de respuesta.

## Abusando de X-Forwarded-For

En general, los proxies agregarÃ¡n las direcciones IP de los clientes dentro del encabezado `X-Forwarded-For` para que el siguiente salto sepa de dÃ³nde proviene la peticiÃ³n. Sin embargo, si un atacante envÃ­a un valor de conexiÃ³n como `Connection: close, X-Forwarded-For` y el primer proxy envÃ­a los encabezados hop-by-hop con sus valores (envÃ­a el valor especial de conexiÃ³n), entonces el segundo valor puede eliminar el encabezado X-Forward-For.\
Al final, la aplicaciÃ³n final no sabrÃ¡ quiÃ©n enviÃ³ la solicitud y puede pensar que fue el Ãºltimo proxy, y en este escenario un atacante puede acceder a recursos protegidos por la lista blanca de IP (Â¿tal vez algÃºn `/admin`?).

Dependiendo del sistema que se estÃ© atacando, tambiÃ©n puede haber `Forwarded`, `X-Real-IP` y otros que son menos comunes.

## Detectando Proxies y huellas de servicios

Esta tÃ©cnica puede ser Ãºtil para detectar proxies (usando la tÃ©cnica de cookies) o incluso para detectar servicios. Por ejemplo, si abusa de esta tÃ©cnica para eliminar el encabezado `X-BLUECOAT-VIA` y se produce un error, entonces ha descubierto que se estaba utilizando Bluecoat.

## Otros ataques

* Para una posible intoxicaciÃ³n de cachÃ© DoS abusando de esta tÃ©cnica, lea el enlace original.
* Esto podrÃ­a ser Ãºtil en ataques que permitan insertar nuevos encabezados (baja probabilidad).
* TambiÃ©n podrÃ­a ser Ãºtil para evitar funcionalidades defensivas. Por ejemplo, si la falta de un encabezado significa que una solicitud no debe ser procesada por un WAF, podrÃ­a evitar un WAF con esta tÃ©cnica.

## Referencias

{% embed url="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers" %}

â€‹

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad mÃ¡s relevante en **EspaÃ±a** y uno de los mÃ¡s importantes en **Europa**. Con **la misiÃ³n de promover el conocimiento tÃ©cnico**, este congreso es un punto de encuentro hirviente para los profesionales de la tecnologÃ­a y la ciberseguridad en todas las disciplinas.\


{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabaja en una **empresa de ciberseguridad**? Â¿Quiere ver su **empresa anunciada en HackTricks**? Â¿O quiere tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulte los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenga el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnase al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­game** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparta sus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
