# Cabeceras hop-by-hop

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks AWS)</strong></a><strong>!</strong></summary>

* 驴Trabajas en una **empresa de ciberseguridad**? 驴Quieres ver tu **empresa anunciada en HackTricks**? 驴O quieres tener acceso a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**? 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **nete al** [****](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

**Este es un resumen del post [https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers](https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers)**

Las cabeceras hop-by-hop son espec铆ficas de una 煤nica conexi贸n a nivel de transporte, utilizadas principalmente en HTTP/1.1 para gestionar datos entre dos nodos (como cliente-proxy o proxy-proxy), y no est谩n destinadas a ser reenviadas. Las cabeceras hop-by-hop est谩ndar incluyen `Keep-Alive`, `Transfer-Encoding`, `TE`, `Connection`, `Trailer`, `Upgrade`, `Proxy-Authorization` y `Proxy-Authenticate`, seg煤n lo definido en [RFC 2616](https://tools.ietf.org/html/rfc2616#section-13.5.1). Cabeceras adicionales pueden ser designadas como hop-by-hop a trav茅s de la cabecera `Connection`.

### Abuso de las cabeceras hop-by-hop
La gesti贸n incorrecta de las cabeceras hop-by-hop por parte de los proxies puede llevar a problemas de seguridad. Si bien se espera que los proxies eliminen estas cabeceras, no todos lo hacen, lo que crea posibles vulnerabilidades.

### Pruebas de manejo de cabeceras hop-by-hop
El manejo de las cabeceras hop-by-hop se puede probar observando los cambios en las respuestas del servidor cuando se marcan ciertas cabeceras como hop-by-hop. Herramientas y scripts pueden automatizar este proceso, identificando c贸mo los proxies gestionan estas cabeceras y potencialmente descubriendo configuraciones incorrectas o comportamientos de proxy.

El abuso de las cabeceras hop-by-hop puede llevar a diversas implicaciones de seguridad. A continuaci贸n se presentan un par de ejemplos que demuestran c贸mo estas cabeceras pueden ser manipuladas para posibles ataques:

### Saltarse controles de seguridad con `X-Forwarded-For`
Un atacante puede manipular la cabecera `X-Forwarded-For` para saltarse los controles de acceso basados en IP. Esta cabecera suele ser utilizada por los proxies para rastrear la direcci贸n IP de origen de un cliente. Sin embargo, si un proxy trata esta cabecera como hop-by-hop y la reenv铆a sin una validaci贸n adecuada, un atacante puede falsificar su direcci贸n IP.

**Escenario de ataque:**
1. El atacante env铆a una solicitud HTTP a una aplicaci贸n web detr谩s de un proxy, incluyendo una direcci贸n IP falsa en la cabecera `X-Forwarded-For`.
2. El atacante tambi茅n incluye la cabecera `Connection: close, X-Forwarded-For`, lo que hace que el proxy trate `X-Forwarded-For` como hop-by-hop.
3. El proxy mal configurado reenv铆a la solicitud a la aplicaci贸n web sin la cabecera falsificada `X-Forwarded-For`.
4. La aplicaci贸n web, al no ver la cabecera original `X-Forwarded-For`, podr铆a considerar la solicitud como proveniente directamente de un proxy de confianza, lo que potencialmente permite el acceso no autorizado.

### Envenenamiento de cach茅 mediante la inyecci贸n de cabeceras hop-by-hop
Si un servidor de cach茅 almacena incorrectamente contenido basado en cabeceras hop-by-hop, un atacante podr铆a inyectar cabeceras maliciosas para envenenar la cach茅. Esto servir铆a contenido incorrecto o malicioso a los usuarios que soliciten el mismo recurso.

**Escenario de ataque:**
1. Un atacante env铆a una solicitud a una aplicaci贸n web con una cabecera hop-by-hop que no deber铆a ser almacenada en cach茅 (por ejemplo, `Connection: close, Cookie`).
2. El servidor de cach茅 mal configurado no elimina la cabecera hop-by-hop y almacena la respuesta espec铆fica de la sesi贸n del atacante.
3. Los usuarios futuros que soliciten el mismo recurso reciben la respuesta en cach茅, que fue adaptada para el atacante, lo que potencialmente lleva al secuestro de sesi贸n o la exposici贸n de informaci贸n sensible.

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks AWS)</strong></a><strong>!</strong></summary>

* 驴Trabajas en una **empresa de ciberseguridad**? 驴Quieres ver tu **empresa anunciada en HackTricks**? 驴O quieres tener acceso a la **煤ltima versi贸n de PEASS o descargar HackTricks en PDF**? 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **nete al** [****](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
