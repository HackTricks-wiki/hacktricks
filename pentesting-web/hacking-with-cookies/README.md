# Hacking de Cookies

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver a tu **empresa anunciada en HackTricks**? o ¬øquieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com).
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live).
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para poder arreglarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en todo tu stack tecnol√≥gico, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Atributos de Cookies

### Expires & Max-Age

* `Expires` establece una fecha de caducidad para cuando se elimina una cookie.
* `Max-age` establece el tiempo en segundos para cuando se eliminar√° una cookie **(usa esto, ya no estamos en 2009)**.

### **Domain**

El atributo `Domain` especifica **qu√© hosts pueden recibir una cookie**. Si no se especifica, el atributo **toma por defecto** el **mismo host** que estableci√≥ la cookie, _**excluyendo subdominios**_. **Si se especifica `Domain`**, entonces **los subdominios siempre est√°n incluidos**. Por lo tanto, especificar `Domain` es menos restrictivo que omitirlo. Sin embargo, puede ser √∫til cuando los subdominios necesitan compartir informaci√≥n sobre un usuario.

Por ejemplo, si estableces `Domain=mozilla.org`, las cookies est√°n disponibles en subdominios como `developer.mozilla.org`. Pero si no lo haces, la cookie no se enviar√° a subdominios.

Si un **subdominio** `sub.example.com` **establece una cookie** con el atributo _domain_ de **`.example.com`**, se **enviar√°** en solicitudes al **dominio principal**.

### **Path**

El atributo `Path` indica un **camino URL que debe existir en la URL solicitada para enviar el encabezado `Cookie`**. El car√°cter `%x2F` ("/") se considera un separador de directorios, y las subcarpetas tambi√©n coinciden.

#### Orden

Cuando 2 cookies tienen el **mismo nombre**, la que se env√≠a es:

* La que tiene el **camino m√°s largo** que coincide con el camino URL.
* La **m√°s nueva** si ambas tienen el mismo camino.

### SameSite

Esto indicar√° al navegador si la **cookie** puede ser enviada **desde otros dominios**. Tiene 3 valores posibles:

* **Strict**: La cookie no se enviar√° junto con una solicitud por sitios web de terceros.
* **Lax**: La cookie se enviar√° junto con la solicitud GET iniciada por sitios web de terceros.
* **None**: La cookie se env√≠a desde cualquier dominio de terceros.

| **Tipo de Solicitud** | **C√≥digo de Ejemplo**                   | **Cookies Enviadas Cuando** |
| --------------------- | --------------------------------------- | --------------------------- |
| Enlace                | \<a href="...">\</a>                    | NotSet\*, Lax, None         |
| Precarga              | \<link rel="prerender" href=".."/>      | NotSet\*, Lax, None         |
| Formulario GET        | \<form method="GET" action="...">       | NotSet\*, Lax, None         |
| Formulario POST       | \<form method="POST" action="...">      | NotSet\*, None              |
| iframe                | \<iframe src="...">\</iframe>           | NotSet\*, None              |
| AJAX                  | $.get("...")                            | NotSet\*, None              |
| Imagen                | \<img src="...">                        | NetSet\*, None              |

Tabla de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) y ligeramente modificada.\
Una cookie con el atributo _**SameSite**_ **mitigar√° ataques CSRF** donde se necesita una sesi√≥n iniciada.

**\*Nota que desde Chrome80 (feb/2019) el comportamiento por defecto de una cookie sin un atributo samesite** **ser√° lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Nota que temporalmente, despu√©s de aplicar este cambio, las **cookies sin una pol√≠tica SameSite** en Chrome ser√°n **tratadas como None** durante los **primeros 2 minutos y luego como Lax para solicitudes POST de nivel superior entre sitios**.
## Banderas de Cookies

### HttpOnly

Esto evita que el **cliente** acceda a la cookie (Por ejemplo, a trav√©s de **Javascript**: `document.cookie`)

#### **Bypasses**

* Si la p√°gina est√° **enviando las cookies como respuesta** de una solicitud (por ejemplo, en una p√°gina **PHPinfo**), es posible abusar del XSS para enviar una solicitud a esta p√°gina y **robar las cookies** de la respuesta (ver un ejemplo en [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Esto podr√≠a ser evitado con solicitudes **TRACE** **HTTP** ya que la respuesta del servidor (si este m√©todo HTTP est√° disponible) reflejar√° las cookies enviadas. Esta t√©cnica se llama **Cross-Site Tracking**.
* Esta t√©cnica es evitada por **navegadores modernos al no permitir enviar una solicitud TRACE** desde JS. Sin embargo, se han encontrado bypasses a esto en software espec√≠fico como enviar `\r\nTRACE` en lugar de `TRACE` a IE6.0 SP2.
* Otra forma es la explotaci√≥n de vulnerabilidades zero/day de los navegadores.
* Es posible **sobrescribir cookies HttpOnly** realizando un ataque de desbordamiento de Cookie Jar:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Es posible utilizar el ataque de [**Cookie Smuggling**](./#cookie-smuggling) para exfiltrar estas cookies

### Secure

La solicitud **solo** enviar√° la cookie en una solicitud HTTP si la solicitud se transmite a trav√©s de un canal seguro (t√≠picamente **HTTPS**).

## Prefijos de Cookies

**Prefijo `__Secure-`**: debe establecerse con la bandera `secure` desde una p√°gina segura (HTTPS).

**Prefijo `__Host-`**: debe establecerse con la bandera `secure`, debe ser de una p√°gina segura (HTTPS), no debe tener un dominio especificado (y por lo tanto, no se env√≠an a subdominios), y el camino debe ser `/`.

Las cookies con prefijo `__Host-` no pueden enviarse a superdominios (cookies de subdominios a dominios) o subdominios (cookies de dominios a subdominios), por lo tanto, si quieres aislar las cookies de tu aplicaci√≥n, prefijar todo con `__Host-` no es una mala idea.

## Ataques con Cookies

Si encuentras alg√∫n tipo de cookie personalizada que contenga datos sensibles (sessionID, nombre de usuario, correos electr√≥nicos, etc.) definitivamente deber√≠as intentar explotarla

### Decodificaci√≥n de la cookie

Si la **cookie** est√° utilizando alg√∫n tipo de **codificaci√≥n Base** (como Base64) o similar, podr√≠as ser capaz de **decodificarla**, **cambiar** el **contenido** e **impersonar** usuarios arbitrarios.

### Secuestro de Sesi√≥n

Robar una cookie y usarla para impersonar al usuario dentro de una aplicaci√≥n

### Fijaci√≥n de Sesi√≥n

El atacante obtiene una cookie de una p√°gina web y env√≠a un enlace a la v√≠ctima para **iniciar sesi√≥n usando la misma cookie**. Si la cookie no cambia cuando un usuario inicia sesi√≥n, esto podr√≠a ser √∫til porque el atacante podr√≠a ser capaz de impersonar al usuario a trav√©s de una cookie.

Si encontraste un **XSS en un subdominio** o **controlas un subdominio**, lee:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Donaci√≥n de Sesi√≥n

El atacante env√≠a su propia sesi√≥n a la v√≠ctima. La v√≠ctima ver√° que ya ha iniciado sesi√≥n y supondr√° que est√° dentro de su cuenta, pero **las acciones se realizar√°n dentro de la cuenta del atacante**.

Si encontraste un **XSS en un subdominio** o **controlas un subdominio**, lee:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookie JWT](../hacking-jwt-json-web-tokens.md)

Haz clic en el enlace anterior para acceder a una p√°gina que explica posibles fallos en JWT.

### Cookie Vac√≠a

Los navegadores permiten una cookie con un nombre vac√≠o
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // empty name
document.cookie = "b=v2"
```
Esto resulta en la cabecera de cookie enviada:
```
a=v1; test value; b=v2;
```
M√°s interesante a√∫n, si tienes un vector que de alguna manera te permite **establecer la cookie vac√≠a**, puedes **controlar cualquier otra cookie**:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // this sets the empty cookie to a=b
```
Aunque internamente en el navegador, esto se establece como la cookie nombrada vac√≠a, resultar√° en el **encabezado de cookie enviado:**
```
a=b;
```
### Bug de Chrome - corrupci√≥n de document.cookie <a href="#chrome-bugdocumentcookie-corruption" id="chrome-bugdocumentcookie-corruption"></a>

Si un punto de c√≥digo sustituto unicode est√° en una cookie establecida, `document.cookie` se corromper√° permanentemente y devolver√° una cadena vac√≠a.
```js
document.cookie
// "a=b;"
document.cookie = "\ud800=meep";
document.cookie
// ""
```
### Contrabando de Cookies

Varios servidores web, incluyendo servidores Java como Jetty, TomCat, Undertow, y el framework web de Python Zope, as√≠ como servidores/frameworks web de Python como cherrypy, web.py, aiohttp server, bottle y webob, se han encontrado con que **interpretan incorrectamente las cadenas de cookies** debido al soporte obsoleto para RFC2965, un mecanismo de citaci√≥n de cookies anticuado que utiliza RFC2616 para la definici√≥n de una cadena citada.

Espec√≠ficamente, **estos servidores contin√∫an leyendo una cadena de cookie cuando encuentran un valor de cookie entre comillas dobles (dquoted), incluso si se encuentra un punto y coma**. Esto es problem√°tico porque **los puntos y coma se supone que separen pares clave-valor** en la cadena de cookie.

Por ejemplo, si un **navegador env√≠a tres cookies, RENDER\_TEXT, JSESSIONID,** y **ASDF:**
```basic
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
estos servidores los interpretan como parte de un **valor de cookie √∫nico** en lugar de tres cookies separadas.

Esto conlleva un riesgo de seguridad: si un atacante obtiene acceso a scripting entre sitios (XSS), puede utilizar este error para **exfiltrar cookies sensibles como las cookies HttpOnly**.

### Inyecci√≥n de Cookies

Se ha descubierto que muchos servidores web, incluyendo el Undertow de Java, el Zope de Python y aquellos que utilizan http.cookie.SimpleCookie y http.cookie.BaseCookie de la biblioteca est√°ndar de Python, **analizan incorrectamente las cookies, utilizando delimitadores incorrectos para iniciar el siguiente par nombre/valor de cookie**. Esto permite a un atacante **falsificar m√∫ltiples cookies mientras solo controla el valor de una cookie**.

En el caso de **Undertow**, comienza a analizar la siguiente cookie inmediatamente despu√©s del **final de un valor de cookie entre comillas**, sin esperar un punto y coma:
```bash
LANGUAGE="en-us" CSRF_TOKEN="SPOOFED_VALUE"
```
**Zope** comienza a analizar la siguiente cookie en una **coma**:
```bash
LANGUAGE=en-us,CSRF_TOKEN=SPOOFED_VALUE
```
Y **Python's SimpleCookie** y **BaseCookie** comienzan inmediatamente a analizar la siguiente cookie en un car√°cter de **espacio**:
```
LANGUAGE=en-us CSRF_TOKEN=SPOOFED_VALUE
```
Como resultado, servidores como **cherrypy**, **web.py**, **aiohttp** server, **bottle** y **webob** (Pyramid, TurboGears) son vulnerables a este tipo de ataque.

Este problema presenta importantes **implicaciones de seguridad**. Por ejemplo, si una aplicaci√≥n web utiliza **protecci√≥n CSRF basada en cookies**, un atacante puede **inyectar** una **cookie de token CSRF falsificada** para eludir esta protecci√≥n. Adem√°s, el √∫ltimo nombre de cookie duplicado en los paquetes http.cookie de Python anula los anteriores, lo que facilita especialmente este tipo de ataque.

Adem√°s, la **falsificaci√≥n** de cookies **`__Secure-`** y **`__Host-`** puede ser abusada en un contexto inseguro. Tambi√©n, en una configuraci√≥n donde las cookies se pasan a un servidor backend, **la inyecci√≥n de cookies podr√≠a llevar a elusiones de autorizaci√≥n** si el servidor backend es susceptible a la falsificaci√≥n pero el servidor frontend no lo es.

### Verificaciones de Cookies Extra Vulnerables

#### **Verificaciones b√°sicas**

* La **cookie** es **igual** cada vez que **inicias sesi√≥n**.
* Cierra sesi√≥n e intenta usar la misma cookie.
* Intenta iniciar sesi√≥n con 2 dispositivos (o navegadores) en la misma cuenta usando la misma cookie.
* Comprueba si la cookie tiene alguna informaci√≥n y trata de modificarla.
* Intenta crear varias cuentas con nombres de usuario casi id√©nticos y comprueba si puedes ver similitudes.
* Comprueba la opci√≥n de "**recordarme**" si existe para ver c√≥mo funciona. Si existe y podr√≠a ser vulnerable, siempre usa la cookie de **recordarme** sin ninguna otra cookie.
* Comprueba si la cookie anterior funciona incluso despu√©s de cambiar la contrase√±a.

#### **Ataques avanzados con cookies**

Si la cookie permanece igual (o casi) cuando inicias sesi√≥n, esto probablemente significa que la cookie est√° relacionada con alg√∫n campo de tu cuenta (probablemente el nombre de usuario). Entonces puedes:

* Intentar crear muchas **cuentas** con nombres de usuario muy **similares** e intentar **adivinar** c√≥mo funciona el algoritmo.
* Intentar **fuerza bruta en el nombre de usuario**. Si la cookie se guarda solo como un m√©todo de autenticaci√≥n para tu nombre de usuario, entonces puedes crear una cuenta con el nombre de usuario "**Bmin**" y **fuerza bruta** cada **bit** de tu cookie porque una de las cookies que intentar√°s ser√° la que pertenece a "**admin**".
* Intentar **Padding Oracle** (puedes descifrar el contenido de la cookie). Usa **padbuster**.

**Padding Oracle - Ejemplos de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster realizar√° varios intentos y te preguntar√° cu√°l es la condici√≥n de error (la que no es v√°lida).

Luego comenzar√° a descifrar la cookie (puede tardar varios minutos)

Si el ataque se ha realizado con √©xito, entonces podr√≠as intentar cifrar una cadena de tu elecci√≥n. Por ejemplo, si quisieras **cifrar** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Esta ejecuci√≥n te dar√° la cookie correctamente cifrada y codificada con la cadena **user=administrator** dentro.

**CBC-MAC**

Quiz√°s una cookie podr√≠a tener alg√∫n valor y podr√≠a estar firmada usando CBC. Entonces, la integridad del valor es la firma creada al usar CBC con el mismo valor. Como se recomienda usar como IV un vector nulo, este tipo de verificaci√≥n de integridad podr√≠a ser vulnerable.

**El ataque**

1. Obt√©n la firma del nombre de usuario **administ** = **t**
2. Obt√©n la firma del nombre de usuario **rator\x00\x00\x00 XOR t** = **t'**
3. Establece en la cookie el valor **administrator+t'** (**t'** ser√° una firma v√°lida de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Si la cookie est√° cifrada usando ECB, podr√≠a ser vulnerable.\
Cuando inicias sesi√≥n, la cookie que recibes siempre debe ser la misma.

**C√≥mo detectar y atacar:**

Crea 2 usuarios con datos casi id√©nticos (nombre de usuario, contrase√±a, correo electr√≥nico, etc.) e intenta descubrir alg√∫n patr√≥n dentro de la cookie dada.

Crea un usuario llamado, por ejemplo, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" y verifica si hay alg√∫n patr√≥n en la cookie (como ECB cifra con la misma clave cada bloque, los mismos bytes cifrados podr√≠an aparecer si el nombre de usuario est√° cifrado).

Deber√≠a haber un patr√≥n (con el tama√±o de un bloque utilizado). Entonces, sabiendo c√≥mo se cifra un mont√≥n de "a", puedes crear un nombre de usuario: "a"\*(tama√±o del bloque)+"admin". Luego, podr√≠as eliminar el patr√≥n cifrado de un bloque de "a" de la cookie. Y tendr√°s la cookie del nombre de usuario "admin".

## Referencias

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? o ¬øquieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
