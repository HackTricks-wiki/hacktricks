# MySQL File priv to SSRF/RCE

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este es un resumen de las t茅cnicas de MySQL/MariaDB/Percona de [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

### Falsificaci贸n de Petici贸n del Lado del Servidor (SSRF) mediante Funciones SQL

En la exploraci贸n de la exfiltraci贸n de datos Out of Band de SQL, la funci贸n `LOAD_FILE()` se emplea com煤nmente para iniciar solicitudes de red. Sin embargo, esta funci贸n est谩 limitada por el sistema operativo en el que opera y las configuraciones de inicio de la base de datos.

La variable global `secure_file_priv`, si no est谩 configurada, se establece por defecto en `/var/lib/mysql-files/`, limitando el acceso a archivos a este directorio a menos que se establezca como una cadena vac铆a (`""`). Este ajuste requiere modificaciones en el archivo de configuraci贸n de la base de datos o en los par谩metros de inicio.

Dado que `secure_file_priv` est谩 deshabilitado (`""`), y asumiendo que se otorgan los permisos necesarios para el archivo y `file_priv`, se pueden leer archivos fuera del directorio designado. Sin embargo, la capacidad de estas funciones para realizar llamadas de red depende en gran medida del sistema operativo. En sistemas Windows, las llamadas de red a rutas UNC son factibles debido a la comprensi贸n por parte del sistema operativo de las convenciones de nomenclatura UNC, lo que potencialmente lleva a la exfiltraci贸n de hashes NTLMv2.

Este m茅todo de SSRF est谩 limitado al puerto TCP 445 y no permite la modificaci贸n del n煤mero de puerto, aunque se puede utilizar para acceder a compartidos con privilegios de lectura completos y, como se demostr贸 en investigaciones anteriores, para robar hashes para una explotaci贸n adicional.

### Ejecuci贸n de C贸digo Remoto (RCE) mediante Funciones Definidas por el Usuario (UDF)

Las bases de datos MySQL ofrecen el uso de Funciones Definidas por el Usuario (UDF) a partir de archivos de biblioteca externos. Si estas bibliotecas son accesibles dentro de directorios espec铆ficos o en la variable de entorno `$PATH` del sistema, pueden ser invocadas desde MySQL.

Esta t茅cnica permite la ejecuci贸n de solicitudes de red/HTTP a trav茅s de una UDF, siempre que se cumplan varias condiciones, incluido el acceso de escritura al `@@plugin_dir`, `file_priv` configurado como `Y` y `secure_file_priv` deshabilitado.

Por ejemplo, la biblioteca `lib_mysqludf_sys` u otras bibliotecas UDF que permiten solicitudes HTTP pueden cargarse para realizar SSRF. Las bibliotecas deben transferirse al servidor, lo cual se puede lograr mediante la codificaci贸n en hexadecimal o base64 del contenido de la biblioteca y luego escribi茅ndola en el directorio correspondiente.

El proceso var铆a si el `@@plugin_dir` no es escribible, especialmente para versiones de MySQL superiores a `v5.0.67`. En tales casos, deben utilizarse rutas alternativas que sean escribibles.

La automatizaci贸n de estos procesos puede facilitarse con herramientas como SQLMap, que admite la inyecci贸n de UDF, y para inyecciones de SQL ciegas, se pueden utilizar t茅cnicas de redirecci贸n de salida o de contrabando de solicitudes DNS.
