# 2FA/OTP Bypass

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Bypass de autenticaci칩n de dos factores**

### **Bypass directo**

Para hacer bypass de 2FA, simplemente **intenta acceder directamente al siguiente endpoint** (necesitas conocer la ruta del siguiente endpoint). Si esto no funciona, intenta cambiar el **encabezado Referrer** como si vinieras de la p치gina de 2FA.

### **Reutilizaci칩n de token**

Quiz치s puedas reutilizar un token previamente usado dentro de la cuenta para autenticarte.

### Compartir tokens no utilizados

Verifica si puedes obtener el token de tu cuenta e intenta usarlo para hacer bypass del 2FA en una cuenta diferente.

### Token filtrado

쮼st치 el token filtrado en una respuesta de la aplicaci칩n web?

### Enlace de verificaci칩n de correo electr칩nico

Intenta usar el **enlace de verificaci칩n de correo electr칩nico recibido cuando se cre칩 la cuenta** para ver si, incluso si se configur칩 el 2FA, a칰n puedes acceder a tu perfil solo con ese enlace ([post](https://srahulceh.medium.com/behind-the-scenes-of-a-security-bug-the-perils-of-2fa-cookie-generation-496d9519771b)).

### Permiso de sesi칩n

Usando la misma sesi칩n, inicia el flujo usando tu cuenta y la cuenta de la v칤ctima. Al llegar al punto de 2FA en ambas cuentas, completa el 2FA con tu cuenta pero no accedas a la siguiente parte. En lugar de eso, intenta acceder al siguiente paso con el flujo de la cuenta de la v칤ctima. Si el back-end solo estableci칩 un booleano dentro de tus sesiones indicando que has pasado exitosamente el 2FA, podr치s hacer bypass del 2FA de la v칤ctima.

### **Funci칩n de restablecimiento de contrase침a**

En casi todas las aplicaciones web, la **funci칩n de restablecimiento de contrase침a inicia sesi칩n autom치ticamente al usuario en la aplicaci칩n** despu칠s de que se completa el procedimiento de restablecimiento.\
Verifica si se env칤a un **correo** con un **enlace** para **restablecer la contrase침a** y si puedes **reutilizar** ese **enlace** para restablecer la contrase침a **tantas veces como quieras** (incluso si la v칤ctima cambia su direcci칩n de correo electr칩nico).

Otra opci칩n para hacer bypass de 2FA con la funcionalidad de restablecimiento de contrase침a es **restablecer la contrase침a con acceso al correo** y usar la **nueva contrase침a para iniciar sesi칩n**, podr칤a ser posible que despu칠s de un cambio de contrase침a no se use el 2FA.

### OAuth

Si puedes comprometer la cuenta del usuario en una plataforma **OAuth** de confianza (Google, Facebook...)

### Fuerza bruta

#### Falta de l칤mite de tasa

쮿ay alg칰n l칤mite en la cantidad de c칩digos que puedes intentar, para que puedas simplemente forzarlo por fuerza bruta? Ten cuidado con un posible l칤mite de tasa "silencioso", siempre intenta varios c칩digos y luego el real para confirmar la vulnerabilidad.

#### L칤mite de tasa en el flujo pero sin l칤mite de tasa

En este caso, hay un l칤mite de tasa en el flujo (tienes que forzarlo muy lentamente: 1 hilo y algo de sue침o antes de 2 intentos) pero no hay l칤mite de tasa. Entonces, con suficiente tiempo, podr치s encontrar el c칩digo v치lido.

#### Reenviar c칩digo y restablecer el l칤mite

Hay un l칤mite de tasa pero cuando "reenv칤as el c칩digo" se env칤a el mismo c칩digo y el l칤mite de tasa se restablece. Entonces, puedes forzar el c칩digo mientras lo reenv칤as para que el l칤mite de tasa nunca se alcance.

#### Bypass del l칤mite de tasa del lado del cliente

{% content-ref url="rate-limit-bypass.md" %}
[rate-limit-bypass.md](rate-limit-bypass.md)
{% endcontent-ref %}

#### Falta de l칤mite de tasa en la cuenta del usuario

A veces puedes configurar el 2FA para algunas acciones dentro de tu cuenta (cambiar correo, contrase침a...). Sin embargo, incluso en casos donde hay un l칤mite de tasa cuando intentaste iniciar sesi칩n, no hay ning칰n l칤mite de tasa para proteger acciones dentro de la cuenta.

#### Falta de l칤mite de tasa reenviando el c칩digo v칤a SMS

No podr치s hacer bypass del 2FA pero podr치s gastar el dinero de la empresa.

#### Regeneraci칩n infinita de OTP

Si puedes **generar un nuevo OTP infinitas veces**, el OTP es **suficientemente simple** (4 n칰meros), y puedes intentar hasta 4 o 5 tokens por OTP generado, puedes simplemente intentar los mismos 4 o 5 tokens cada vez y generar OTPs hasta que coincida con los que est치s usando.

### Condici칩n de carrera

Revisa la secci칩n sobre bypass de 2FA de la siguiente p치gina:

{% content-ref url="race-condition.md" %}
[race-condition.md](race-condition.md)
{% endcontent-ref %}

### CSRF/Clickjacking

Verifica si hay una vulnerabilidad de Falsificaci칩n de Solicitud en Sitios Cruzados (CSRF) o de Clickjacking para desactivar el 2FA.

### Funcionalidad de "recordarme"

#### Cookie adivinable

Si la funcionalidad de "recordarme" usa una nueva cookie con un c칩digo adivinable, intenta adivinarlo.

#### Direcci칩n IP

Si la funcionalidad de "recordarme" est치 vinculada a tu direcci칩n IP, puedes intentar averiguar la direcci칩n IP de la v칤ctima e impersonarla usando el encabezado **X-Forwarded-For**.

### Versiones anteriores

#### Subdominios

Si puedes encontrar algunos subdominios de "pruebas" con la funcionalidad de inicio de sesi칩n, podr칤an estar usando versiones antiguas que no admiten 2FA (por lo que se hace bypass directamente) o esos endpoints podr칤an admitir una versi칩n vulnerable del 2FA.

#### APIs

Si encuentras que el 2FA est치 usando una API ubicada bajo un directorio /v\*/ (como "/v3/"), esto probablemente significa que hay endpoints de API m치s antiguos que podr칤an ser vulnerables a alg칰n tipo de bypass de 2FA.

### Sesiones anteriores

Cuando se habilita el 2FA, las sesiones creadas anteriormente deber칤an finalizarse. Esto se debe a que cuando un cliente tiene su cuenta comprometida, podr칤a querer protegerla activando el 2FA, pero si las sesiones anteriores no se finalizan, esto no lo proteger치.

### Control de acceso inadecuado a c칩digos de respaldo

Los c칩digos de respaldo se generan inmediatamente despu칠s de que se habilita el 2FA y est치n disponibles en una sola solicitud. Despu칠s de cada llamada subsiguiente a la solicitud, los c칩digos pueden regenerarse o permanecer sin cambios (c칩digos est치ticos). Si hay configuraciones err칩neas de CORS/vulnerabilidades de XSS y otros errores que te permiten "extraer" c칩digos de respaldo de la solicitud de respuesta del endpoint de c칩digos de respaldo, entonces el atacante podr칤a robar los c칩digos y hacer bypass del 2FA si se conocen el nombre de usuario y la contrase침a.

### Divulgaci칩n de informaci칩n

Si notas que aparece alguna informaci칩n confidencial en la p치gina de 2FA que no conoc칤as previamente (como el n칰mero de tel칠fono), entonces esto puede considerarse una vulnerabilidad de divulgaci칩n de informaci칩n.

### **Restablecimiento de contrase침a == desactivar 2FA**

1. Crea una cuenta y activa el 2FA.
2. Cierra sesi칩n de esa cuenta.
3. Ahora, ve a la p치gina de restablecimiento de contrase침a olvidada.
4. Cambia tu contrase침a.
5. Ahora intenta iniciar sesi칩n.
6. Si no se te pide que ingreses un c칩digo de 2FA, puedes reportarlo.

## Referencias

{% embed url="https://medium.com/@iSecMax/two-factor-authentication-security-testing-and-possible-bypasses-f65650412b35" %}

{% embed url="https://azwi.medium.com/2-factor-authentication-bypass-3b2bbd907718" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
