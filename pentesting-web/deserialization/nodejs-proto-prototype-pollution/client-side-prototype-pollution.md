# Client Side Prototype Pollution

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descubrimiento usando herramientas automÃ¡ticas

Las herramientas [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **y** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) se pueden utilizar para **encontrar vulnerabilidades de pollution de prototipos**.

AdemÃ¡s, tambiÃ©n se puede utilizar la **extensiÃ³n del navegador** [**PPScan**](https://github.com/msrkp/PPScan) para **escanear automÃ¡ticamente** las **pÃ¡ginas** a las que **accede** en busca de vulnerabilidades de pollution de prototipos.

### DepuraciÃ³n de dÃ³nde se utiliza una propiedad <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
    console.trace();
    return 'test';
}})
```
{% endcode %}

### Encontrando la causa raÃ­z de la contaminaciÃ³n de prototipos <a href="#5530" id="5530"></a>

Una vez que alguna de las herramientas ha **identificado** una **vulnerabilidad de contaminaciÃ³n de prototipos**, si el **cÃ³digo** no es muy **complejo**, puedes **buscar** en el cÃ³digo JS las palabras clave **`location.hash/decodeURIComponent/location.search`** en las Herramientas de Desarrollo de Chrome y encontrar el lugar vulnerable.

Si el cÃ³digo es grande y complejo, hay una manera fÃ¡cil de **descubrir dÃ³nde estÃ¡ el cÃ³digo vulnerable**:

* Usando una de las herramientas, **encuentra una vulnerabilidad** y obtÃ©n una **carga Ãºtil** que **establecerÃ¡ una propiedad** en el constructor. En ppmap se te darÃ¡ algo como: `constructor[prototype][ppmap]=reserved`
* Ahora, establece un **punto de interrupciÃ³n en la primera lÃ­nea de cÃ³digo JS** que se va a ejecutar en la pÃ¡gina, y actualiza la pÃ¡gina con la carga Ãºtil para que la **ejecuciÃ³n se detenga allÃ­**.
* Mientras la ejecuciÃ³n de JS estÃ¡ detenida, **pega el siguiente script en la consola de JS**. Este cÃ³digo indicarÃ¡ una vez que se crea la propiedad 'ppmap', para que puedas encontrar dÃ³nde se creÃ³.
```javascript
function debugAccess(obj, prop, debugGet=true){

    var origValue = obj[prop];

    Object.defineProperty(obj, prop, {
        get: function () {
            if ( debugGet )
                debugger;
            return origValue;
        },
        set: function(val) {
            debugger;
            return origValue = val;
        }
    });

};

debugAccess(Object.prototype, 'ppmap')
```
Regrese a **Fuentes** y haga clic en "Reanudar" la **ejecuciÃ³n** del script. DespuÃ©s de hacer eso, todo el **javascript** se **ejecutarÃ¡** y ppmap se volverÃ¡ a contaminar como se esperaba. Con la ayuda del Snippet podemos encontrar exactamente dÃ³nde se contamina la propiedad ppmap. Podemos **hacer clic** en la **Pila de llamadas** y se mostrarÃ¡n **diferentes** **pilas** donde se **produjo** la **contaminaciÃ³n**.

Â¿Pero cuÃ¡l elegir? La mayorÃ­a de las veces, la contaminaciÃ³n de prototipos ocurre en bibliotecas de Javascript, por lo que apunte a la pila que estÃ¡ adjunta a los archivos de biblioteca .js (mire el lado derecho, al igual que en la imagen, para saber a quÃ© punto final estÃ¡ adjunta la pila). En este caso, tenemos 2 pilas en la lÃ­nea 4 y 6, lÃ³gicamente elegiremos la lÃ­nea 4 porque es la primera vez que ocurre la contaminaciÃ³n, lo que significa que esta lÃ­nea es la razÃ³n de la vulnerabilidad. Haciendo clic en la pila nos redirigirÃ¡ al cÃ³digo vulnerable.

![](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Encontrar Gadgets de Script

El gadget es el **cÃ³digo que se aprovecharÃ¡ una vez que se descubra una vulnerabilidad de PP**.

Si la aplicaciÃ³n es simple, podemos **buscar** palabras clave como **`srcdoc/innerHTML/iframe/createElement`** y revisar el cÃ³digo fuente para verificar si conduce a la ejecuciÃ³n de Javascript. A veces, las tÃ©cnicas mencionadas pueden no encontrar gadgets en absoluto. En ese caso, la revisiÃ³n pura del cÃ³digo fuente revela algunos gadgets interesantes como el siguiente ejemplo.

### Ejemplo de encontrar un gadget PP en el cÃ³digo de la biblioteca Mithil

Consulte este artÃ­culo: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## RecompilaciÃ³n de payloads para bibliotecas vulnerables

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Referencias

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabaja en una **empresa de ciberseguridad**? Â¿Quiere ver su **empresa anunciada en HackTricks**? Â¿O quiere tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulte los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* Obtenga el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnase al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­game** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparta sus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
