# Condici칩n de Carrera

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f치cilmente con las herramientas comunitarias m치s avanzadas del mundo.\
Obt칠n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

{% hint style="warning" %}
Para obtener una comprensi칩n profunda de esta t칠cnica, consulta el informe original en [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## Mejorando los Ataques de Condici칩n de Carrera

El principal desaf칤o para aprovechar las condiciones de carrera es asegurarse de que m칰ltiples solicitudes se manejen al mismo tiempo, con **muy poca diferencia en sus tiempos de procesamiento, idealmente, menos de 1ms**.

Aqu칤 puedes encontrar algunas t칠cnicas para Sincronizar Solicitudes:

#### Ataque de un Solo Paquete HTTP/2 vs. Sincronizaci칩n del 칔ltimo Byte de HTTP/1.1

* **HTTP/2**: Permite enviar dos solicitudes sobre una 칰nica conexi칩n TCP, reduciendo el impacto del jitter de red. Sin embargo, debido a variaciones en el lado del servidor, dos solicitudes pueden no ser suficientes para un exploit de condici칩n de carrera consistente.
* **HTTP/1.1 'Sincronizaci칩n del 칔ltimo Byte'**: Permite el preenv칤o de la mayor칤a de las partes de 20-30 solicitudes, reteniendo un peque침o fragmento, que luego se env칤a juntas, logrando una llegada simult치nea al servidor.

La **preparaci칩n para la Sincronizaci칩n del 칔ltimo Byte** implica:

1. Enviar encabezados y datos del cuerpo menos el byte final sin finalizar el flujo.
2. Pausar durante 100ms despu칠s del env칤o inicial.
3. Deshabilitar TCP\_NODELAY para utilizar el algoritmo de Nagle para agrupar los marcos finales.
4. Hacer ping para calentar la conexi칩n.

El posterior env칤o de marcos retenidos deber칤a resultar en su llegada en un solo paquete, verificable a trav칠s de Wireshark. Este m칠todo no se aplica a archivos est치ticos, que normalmente no est치n involucrados en ataques de RC.

### Adapt치ndose a la Arquitectura del Servidor

Comprender la arquitectura del objetivo es crucial. Los servidores front-end pueden enrutar las solicitudes de manera diferente, afectando el tiempo. El calentamiento preventivo de la conexi칩n del lado del servidor, a trav칠s de solicitudes inconsecuentes, podr칤a normalizar el tiempo de solicitud.

#### Manejo de Bloqueos Basados en Sesiones

Los frameworks como el manejador de sesiones de PHP serializan las solicitudes por sesi칩n, lo que potencialmente oculta vulnerabilidades. Utilizar tokens de sesi칩n diferentes para cada solicitud puede evitar este problema.

#### Superar L칤mites de Tasa o Recursos

Si el calentamiento de la conexi칩n no es efectivo, provocar intencionalmente retrasos en los l칤mites de tasa o recursos de los servidores web a trav칠s de una inundaci칩n de solicitudes ficticias podr칤a facilitar el ataque de un solo paquete al inducir un retraso del lado del servidor propicio para las condiciones de carrera.

## Ejemplos de Ataque

* **Tubo Intruder - Ataque de un solo paquete HTTP2 (1 punto final)**: Puedes enviar la solicitud a **Turbo Intruder** (`Extensiones` -> `Turbo Intruder` -> `Enviar a Turbo Intruder`), puedes cambiar en la solicitud el valor que deseas probar por fuerza bruta para **`%s`** como en `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s` y luego seleccionar el **`ejemplos/race-single-packer-attack.py`** del men칰 desplegable:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si vas a **enviar valores diferentes**, podr칤as modificar el c칩digo con este que utiliza una lista de palabras del portapapeles:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Si la web no es compatible con HTTP2 (solo HTTP1.1), utiliza `Engine.THREADED` o `Engine.BURP` en lugar de `Engine.BURP2`.
{% endhint %}

* **Intrusi칩n de Tubo - Ataque de un solo paquete HTTP2 (Varios endpoints)**: En caso de que necesites enviar una solicitud a 1 endpoint y luego m칰ltiples a otros endpoints para activar la RCE, puedes modificar el script `race-single-packet-attack.py` con algo como:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Tambi칠n est치 disponible en **Repeater** a trav칠s de la nueva opci칩n '**Enviar grupo en paralelo**' en Burp Suite.
* Para **limit-overrun** simplemente podr칤as agregar la **misma solicitud 50 veces** en el grupo.
* Para el **calentamiento de la conexi칩n**, podr칤as **agregar** al **principio** del **grupo** algunas **solicitudes** a alguna parte no est치tica del servidor web.
* Para **retrasar** el proceso **entre** el procesamiento **de una solicitud y otra** en 2 pasos de subestado, podr칤as **agregar solicitudes adicionales entre** ambas solicitudes.
* Para un RC de **m칰ltiples puntos finales** podr칤as comenzar enviando la **solicitud** que **va al estado oculto** y luego **50 solicitudes** justo despu칠s que **explotan el estado oculto**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Raw BF

Antes de la investigaci칩n anterior, estos eran algunos payloads utilizados que simplemente intentaban enviar los paquetes lo m치s r치pido posible para causar un RC.

* **Repeater:** Consulta los ejemplos de la secci칩n anterior.
* **Intruder**: Env칤a la **solicitud** a **Intruder**, establece el **n칰mero de hilos** en **30** dentro del men칰 **Opciones y**, selecciona como payload **Cargas 칰tiles nulas** y genera **30.**
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## Metodolog칤a de RC

### L칤mite de sobrepaso / TOCTOU

Este es el tipo m치s b치sico de condici칩n de carrera donde **vulnerabilidades** que **aparecen** en lugares que **limitan la cantidad de veces que puedes realizar una acci칩n**. Como usar el mismo c칩digo de descuento varias veces en una tienda web. Un ejemplo muy f치cil se puede encontrar en [**este informe**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) o en [**este bug**](https://hackerone.com/reports/759247)**.**

Existen muchas variaciones de este tipo de ataque, incluyendo:

- Canjear una tarjeta de regalo varias veces
- Calificar un producto varias veces
- Retirar o transferir efectivo en exceso de tu saldo de cuenta
- Reutilizar una soluci칩n CAPTCHA 칰nica
- Saltarse un l칤mite de velocidad anti-fuerza bruta

### **Subestados ocultos**

Explotar condiciones de carrera complejas a menudo implica aprovechar oportunidades breves para interactuar con subestados de m치quina ocultos o **no intencionales**. As칤 es como se aborda esto:

1. **Identificar posibles subestados ocultos**
   - Comienza por se침alar los puntos finales que modifican o interact칰an con datos cr칤ticos, como perfiles de usuario o procesos de restablecimiento de contrase침a. Enf칩cate en:
     - **Almacenamiento**: Prefiere los puntos finales que manipulan datos persistentes en el servidor sobre aquellos que manejan datos en el lado del cliente.
     - **Acci칩n**: Busca operaciones que alteren datos existentes, las cuales son m치s propensas a crear condiciones explotables en comparaci칩n con aquellas que agregan nuevos datos.
     - **Clave**: Los ataques exitosos generalmente involucran operaciones clave en el mismo identificador, por ejemplo, nombre de usuario o token de restablecimiento.
2. **Realizar sondas iniciales**
   - Prueba los puntos finales identificados con ataques de condici칩n de carrera, observando cualquier desviaci칩n de los resultados esperados. Respuestas inesperadas o cambios en el comportamiento de la aplicaci칩n pueden indicar una vulnerabilidad.
3. **Demostrar la vulnerabilidad**
   - Reduce el ataque al n칰mero m칤nimo de solicitudes necesarias para explotar la vulnerabilidad, a menudo solo dos. Este paso puede requerir m칰ltiples intentos o automatizaci칩n debido al tiempo preciso involucrado.

### Ataques sensibles al tiempo

La precisi칩n en el tiempo de las solicitudes puede revelar vulnerabilidades, especialmente cuando se utilizan m칠todos predecibles como marcas de tiempo para tokens de seguridad. Por ejemplo, generar tokens de restablecimiento de contrase침a basados en marcas de tiempo podr칤a permitir tokens id칠nticos para solicitudes simult치neas.

**Para explotar:**

- Utiliza un tiempo preciso, como un ataque de paquete 칰nico, para realizar solicitudes de restablecimiento de contrase침a concurrentes. Los tokens id칠nticos indican una vulnerabilidad.

**Ejemplo:**

- Solicita dos tokens de restablecimiento de contrase침a al mismo tiempo y comp치ralos. Los tokens coincidentes sugieren un fallo en la generaci칩n de tokens.

**Consulta este** [**Laboratorio de PortSwigger**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) **para probar esto.**

## Estudios de casos de subestados ocultos

### Pagar y agregar un art칤culo

Consulta este [**Laboratorio de PortSwigger**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) para ver c칩mo **pagar** en una tienda y **agregar un art칤culo adicional** que **no necesitar치s pagar**.

### Confirmar otros correos electr칩nicos

La idea es **verificar una direcci칩n de correo electr칩nico y cambiarla a otra al mismo tiempo** para averiguar si la plataforma verifica la nueva direcci칩n cambiada.

### Cambiar correo electr칩nico a 2 direcciones de correo electr칩nico basadas en cookies

Seg칰n [**esta investigaci칩n**](https://portswigger.net/research/smashing-the-state-machine) Gitlab era vulnerable a una toma de control de esta manera porque podr칤a **enviar** el **token de verificaci칩n de correo electr칩nico de un correo electr칩nico al otro correo electr칩nico**.

**Consulta este** [**Laboratorio de PortSwigger**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) **para probar esto.**

### Estados de base de datos ocultos / Bypass de confirmaci칩n

Si se utilizan **2 escrituras diferentes** para **agregar informaci칩n** dentro de una **base de datos**, hay un peque침o per칤odo de tiempo donde **solo se ha escrito el primer dato** dentro de la base de datos. Por ejemplo, al crear un usuario, el **nombre de usuario** y la **contrase침a** podr칤an ser **escritos** y luego el **token** para confirmar la cuenta reci칠n creada se escribe. Esto significa que por un corto tiempo el **token para confirmar una cuenta es nulo**.

Por lo tanto, **registrarse en una cuenta y enviar varias solicitudes con un token vac칤o** (`token=` o `token[]=` u otra variaci칩n) para confirmar la cuenta de inmediato podr칤a permitir **confirmar una cuenta** donde no controlas el correo electr칩nico.

**Consulta este** [**Laboratorio de PortSwigger**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) **para probar esto.**

### Bypass de 2FA

El siguiente pseudo-c칩digo es vulnerable a una condici칩n de carrera porque en un tiempo muy corto el **2FA no se aplica** mientras se crea la sesi칩n:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### Persistencia eterna de OAuth2

Hay varios [**proveedores de OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Estos servicios te permitir치n crear una aplicaci칩n y autenticar a los usuarios que el proveedor haya registrado. Para hacerlo, el **cliente** necesitar치 **permitir que tu aplicaci칩n** acceda a algunos de sus datos dentro del **proveedor de OAuth**.\
As칤 que, hasta aqu칤 solo un inicio de sesi칩n com칰n con google/linkedin/github... donde se te muestra una p치gina que dice: "_La aplicaci칩n \<InsertCoolName> quiere acceder a tu informaci칩n, 쯗eseas permitirlo?_"

#### Condici칩n de Carrera en `authorization_code`

El **problema** surge cuando **aceptas** y autom치ticamente env칤a un **`authorization_code`** a la aplicaci칩n maliciosa. Luego, esta **aplicaci칩n abusa de una Condici칩n de Carrera en el proveedor de servicios de OAuth para generar m치s de un AT/RT** (_Authentication Token/Refresh Token_) a partir del **`authorization_code`** para tu cuenta. B치sicamente, abusar치 del hecho de que has aceptado que la aplicaci칩n acceda a tus datos para **crear varias cuentas**. Entonces, si **dejas de permitir que la aplicaci칩n acceda a tus datos, un par de AT/RT se eliminar치, pero los otros seguir치n siendo v치lidos**.

#### Condici칩n de Carrera en `Refresh Token`

Una vez que has **obtenido un RT v치lido** podr칤as intentar **abusar de 칠l para generar varios AT/RT** y **incluso si el usuario cancela los permisos** para que la aplicaci칩n maliciosa acceda a sus datos, **varios RT seguir치n siendo v치lidos**.

## **CC en WebSockets**

En [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) puedes encontrar un PoC en Java para enviar mensajes de websocket en **paralelo** y abusar de **Condiciones de Carrera tambi칠n en Web Sockets**.

## Referencias

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Usa [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f치cilmente con las herramientas comunitarias m치s avanzadas del mundo.\
춰Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
