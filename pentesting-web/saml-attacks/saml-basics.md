<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**art铆culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>


# Visi贸n general de SAML

**Security Assertion Markup Language (SAML)** es un est谩ndar abierto que permite a los proveedores de identidad (IdP) enviar credenciales de autorizaci贸n a los proveedores de servicios (SP). B谩sicamente, permite el inicio de sesi贸n 煤nico (SSO), lo que permite el uso de un conjunto de credenciales en varios sitios web. Esto simplifica la gesti贸n de m煤ltiples inicios de sesi贸n, como en el correo electr贸nico, software CRM o Active Directory. SAML utiliza XML para facilitar la comunicaci贸n estandarizada entre el IdP y los SP, vinculando la autenticaci贸n de identidad del usuario con la autorizaci贸n del servicio.

# Comparaci贸n entre SAML y OAuth

Si bien tanto **SAML** como **OAuth** ofrecen inicios de sesi贸n en internet simplificados, tienen sus diferencias:

- **SAML** ofrece m谩s control a las empresas, mejorando la seguridad de los inicios de sesi贸n SSO.
- **OAuth** es m谩s amigable para dispositivos m贸viles, utiliza JSON y fue co-desarrollado por Google y Twitter.

# Flujo de autenticaci贸n SAML

Para m谩s detalles, consulta la publicaci贸n completa en [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Este es un resumen:

El proceso de autenticaci贸n SAML implica varios pasos, como se ilustra en el esquema:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Intento de acceso a recursos**: El usuario intenta acceder a un recurso protegido.
2. **Generaci贸n de solicitud SAML**: El SP no reconoce al usuario y genera una solicitud SAML.
3. **Redirecci贸n al IdP**: El usuario es redirigido al IdP, con la solicitud SAML pasando a trav茅s del navegador del usuario.
4. **Recepci贸n de solicitud por el IdP**: El IdP recibe la solicitud SAML.
5. **Autenticaci贸n en el IdP**: El IdP autentica al usuario.
6. **Validaci贸n del usuario**: El IdP valida la legitimidad del usuario para acceder al recurso solicitado.
7. **Creaci贸n de respuesta SAML**: El IdP genera una respuesta SAML que contiene las afirmaciones necesarias.
8. **Redirecci贸n a la URL ACS del SP**: El usuario es redirigido a la URL del Servicio de Consumidor de Afirmaciones (ACS) del SP.
9. **Validaci贸n de la respuesta SAML**: El ACS valida la respuesta SAML.
10. **Acceso a recursos concedido**: Se concede acceso al recurso solicitado inicialmente.

# Ejemplo de solicitud SAML

Considera el escenario en el que un usuario solicita acceso a un recurso seguro en [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). El SP identifica la falta de autenticaci贸n y genera una solicitud SAML:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
La solicitud SAML en bruto se ve as铆:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Los elementos clave de esta solicitud incluyen:
- **AssertionConsumerServiceURL**: Especifica a d贸nde debe enviar el IdP la Respuesta SAML despu茅s de la autenticaci贸n.
- **Destination**: La direcci贸n del IdP a la que se env铆a la solicitud.
- **ProtocolBinding**: Define el m茅todo de transmisi贸n de mensajes del protocolo SAML.
- **saml:Issuer**: Identifica la entidad que inici贸 la solicitud.

Despu茅s de generar la Solicitud SAML, el SP responde con una **redirecci贸n 302**, dirigiendo el navegador al IdP con la Solicitud SAML codificada en la cabecera **Location** de la respuesta HTTP. El par谩metro **RelayState** mantiene la informaci贸n de estado durante la transacci贸n, asegurando que el SP reconozca la solicitud de recurso inicial al recibir la Respuesta SAML. El par谩metro **SAMLRequest** es una versi贸n comprimida y codificada del fragmento XML sin procesar, utilizando compresi贸n Deflate y codificaci贸n base64.


# Ejemplo de Respuesta SAML

Puedes encontrar una [respuesta SAML completa aqu铆](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Los componentes clave de la respuesta incluyen:

- **ds:Signature**: Esta secci贸n, una Firma XML, garantiza la integridad y autenticidad del emisor de la afirmaci贸n. La respuesta SAML en el ejemplo contiene dos elementos `ds:Signature`, uno para el mensaje y otro para la afirmaci贸n.
- **saml:Assertion**: Esta parte contiene informaci贸n sobre la identidad del usuario y posiblemente otros atributos.
- **saml:Subject**: Especifica el sujeto principal de todas las declaraciones en la afirmaci贸n.
- **saml:StatusCode**: Representa el estado de la operaci贸n en respuesta a la solicitud correspondiente.
- **saml:Conditions**: Detalla condiciones como el tiempo de validez de la Afirmaci贸n y el Proveedor de Servicios especificado.
- **saml:AuthnStatement**: Confirma que el IdP autentic贸 al sujeto de la Afirmaci贸n.
- **saml:AttributeStatement**: Contiene atributos que describen el sujeto de la Afirmaci贸n.

Despu茅s de la Respuesta SAML, el proceso incluye una redirecci贸n 302 desde el IdP. Esto lleva a una solicitud POST a la URL del Servicio de Consumidor de Afirmaciones (ACS) del Proveedor de Servicios. La solicitud POST incluye los par谩metros `RelayState` y `SAMLResponse`. El ACS es responsable de procesar y validar la Respuesta SAML.

Despu茅s de recibir la solicitud POST y validar la Respuesta SAML, se otorga acceso al recurso protegido solicitado inicialmente por el usuario. Esto se ilustra con una solicitud `GET` al punto final `/secure/` y una respuesta `200 OK`, indicando un acceso exitoso al recurso.


# Firmas XML

Las Firmas XML son vers谩tiles, capaces de firmar un 谩rbol XML completo o elementos espec铆ficos dentro de 茅l. Se pueden aplicar a cualquier Objeto XML, no solo a elementos de Respuesta. A continuaci贸n se muestran los tipos clave de Firmas XML:

### Estructura B谩sica de la Firma XML
Una Firma XML consta de elementos esenciales como se muestra:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Cada elemento `Reference` significa un recurso espec铆fico que est谩 siendo firmado, identificable por el atributo URI.

### Tipos de Firmas XML

1. **Firma Envolvente**: Este tipo de firma es un descendiente del recurso que firma, lo que significa que la firma est谩 contenida dentro de la misma estructura XML que el contenido firmado.

Ejemplo:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

En una firma envolvente, el elemento `ds:Transform` especifica que est谩 envuelto a trav茅s del algoritmo `enveloped-signature`.

2. **Firma Envolvente**: A diferencia de las firmas envolventes, las firmas envolventes envuelven el recurso que est谩 siendo firmado.

Ejemplo:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Firma Desvinculada**: Este tipo est谩 separado del contenido que firma. La firma y el contenido existen de forma independiente, pero se mantiene un enlace entre los dos.

Ejemplo:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

En conclusi贸n, las Firmas XML proporcionan formas flexibles de asegurar documentos XML, con cada tipo sirviendo diferentes necesidades estructurales y de seguridad.


# Referencias
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
