# Shadow DOM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## InformaciÃ³n bÃ¡sica

Shadow DOM es parte del conjunto de caracterÃ­sticas de [Web Components](https://developer.mozilla.org/es/docs/Web/Web_Components), que tiene como objetivo permitir a los desarrolladores de JS crear elementos personalizados reutilizables con su funcionalidad encapsulada lejos del resto del cÃ³digo del sitio web.

BÃ¡sicamente, puedes usar el Shadow DOM para **aislar el HTML y CSS de tu componente del resto de la pÃ¡gina web**. Por ejemplo, si creas IDs de elementos en un Shadow DOM, **no entrarÃ¡n en conflicto con los IDs de elementos en el DOM principal**. Cualquier selector CSS que utilices en tu Shadow DOM solo se aplicarÃ¡ dentro del Shadow DOM y no al DOM principal, y cualquier selector que utilices en el DOM principal no penetrarÃ¡ dentro del Shadow DOM.
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
Normalmente, cuando adjuntas un **shadow DOM "abierto" a un elemento**, puedes obtener una referencia al shadow DOM con **`$element.shadowRoot`**. Sin embargo, si el shadow DOM estÃ¡ adjunto en modo **"cerrado"**, no puedes obtener una referencia de esta manera. Incluso despuÃ©s de leer toda la documentaciÃ³n para desarrolladores que pude encontrar, todavÃ­a tengo algunas dudas sobre el propÃ³sito del modo cerrado. [SegÃºn Google](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> Hay otro tipo de shadow DOM llamado modo "cerrado". Cuando creas un Ã¡rbol de shadow cerrado, **JavaScript externo no podrÃ¡ acceder al DOM interno de tu componente**. Esto es similar a cÃ³mo funcionan los elementos nativos como `<video>`. JavaScript no puede acceder al shadow DOM de `<video>` porque el navegador lo implementa utilizando un shadow root en modo cerrado.

Sin embargo, tambiÃ©n afirman:

> Los shadow roots cerrados no son muy Ãºtiles. Algunos desarrolladores ven el modo cerrado como una **caracterÃ­stica de seguridad artificial**. Pero seamos claros, no es una caracterÃ­stica de seguridad.

## Accediendo al Shadow DOM

### window.find() y selecciones de texto <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

La funciÃ³n **`window.find("texto_de_bÃºsqueda")` penetra dentro de un shadow DOM**. Esta funciÃ³n tiene efectivamente la misma funcionalidad que ctrl-F en una pÃ¡gina web.

Es posible llamar a **`document.execCommand("SelectAll")`** para expandir la selecciÃ³n tanto como sea posible y luego llamar a **`window.getSelection()`** para **obtener el contenido** del texto seleccionado dentro del shadow DOM.

En **firefox**, puedes usar `getSelection()` que devuelve un objeto [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection), donde `anchorElement` es una **referencia a un elemento en el shadow DOM**. Por lo tanto, podemos filtrar el contenido del shadow DOM de la siguiente manera:
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
Pero esto no funciona en Chromium.

### contenteditable o inyecciÃ³n de CSS <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

Una forma en la que podrÃ­amos interactuar con el shadow DOM es si tenemos una **inyecciÃ³n de HTML o JS dentro de Ã©l**. Hay algunas situaciones interesantes en las que puedes obtener una inyecciÃ³n dentro de un shadow DOM donde no podrÃ­as en una pÃ¡gina normal con crossorigin.

Un ejemplo es si tienes algÃºn **elemento con el atributo `contenteditable`**. Este es un atributo HTML obsoleto y poco utilizado que declara que el **contenido de ese elemento puede ser editado por el usuario**. Podemos usar selecciones junto con la API **`document.execCommand`** para interactuar con un elemento contenteditable y obtener una inyecciÃ³n de HTML!
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
QuizÃ¡s aÃºn mÃ¡s interesante, **`contenteditable`** puede declararse en cualquier elemento en chromium aplicando una propiedad CSS obsoleta: `-webkit-user-modify:read-write`

Esto nos permite **elevar una inyecciÃ³n de CSS/estilo a una inyecciÃ³n de HTML**, agregando la propiedad CSS a un elemento y luego utilizando el comando `insertHTML`.

## CTF

Ver este writeup donde se utilizÃ³ esta tÃ©cnica como un desafÃ­o CTF: [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## Referencias

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
