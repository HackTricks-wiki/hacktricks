# Bloquear la pÃ¡gina principal para robar postmessage

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Ganando RCs con Iframes

SegÃºn este [**informe de Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710) los documentos de blob creados desde orÃ­genes nulos estÃ¡n aislados por razones de seguridad, lo que significa que si mantienes ocupada la pÃ¡gina principal, la pÃ¡gina del iframe se ejecutarÃ¡.

BÃ¡sicamente, en ese desafÃ­o se ejecuta un **iframe aislado** y justo **despuÃ©s** de que se **cargue**, la pÃ¡gina **padre** va a **enviar un mensaje post** con la **bandera**.\
Sin embargo, esa comunicaciÃ³n postmessage es **vulnerable a XSS** (el **iframe** puede ejecutar cÃ³digo JS).

Por lo tanto, el objetivo del atacante es **permitir que el padre cree el iframe**, pero **antes** de que la pÃ¡gina **padre** **envÃ­e los datos sensibles** (**bandera**) **mantenerla ocupada** y enviar el **payload al iframe**. Mientras el **padre estÃ¡ ocupado**, el **iframe ejecuta el payload** que serÃ¡ algÃºn JS que escucharÃ¡ el **mensaje postmessage del padre y filtrarÃ¡ la bandera**.\
Finalmente, el iframe ha ejecutado el payload y la pÃ¡gina padre deja de estar ocupada, por lo que envÃ­a la bandera y el payload la filtra.

Pero, Â¿cÃ³mo podrÃ­as hacer que el padre estÃ© **ocupado justo despuÃ©s de generar el iframe y solo mientras espera a que el iframe estÃ© listo para enviar los datos sensibles**? BÃ¡sicamente, necesitas encontrar una **acciÃ³n asincrÃ³nica** que el padre pueda **ejecutar**. Por ejemplo, en ese desafÃ­o, el padre estaba **escuchando** los **postmessages** de esta manera:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
Entonces era posible enviar un **nÃºmero entero grande en un postmessage** que serÃ¡ **convertido a cadena** en esa comparaciÃ³n, lo cual tomarÃ¡ algo de tiempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Y para ser preciso y **enviar** ese **postmessage** justo **despuÃ©s** de que se cree el **iframe** pero **antes** de que estÃ© **listo** para recibir los datos del padre, necesitarÃ¡s **jugar con los milisegundos de un `setTimeout`**.
