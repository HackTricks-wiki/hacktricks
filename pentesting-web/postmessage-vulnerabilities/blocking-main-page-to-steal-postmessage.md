# Bloqueando la pÃ¡gina principal para robar postmessage

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Ganando RCs con iframes

SegÃºn este [**writeup de Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), los documentos de blob creados desde orÃ­genes nulos estÃ¡n aislados por motivos de seguridad, lo que significa que si mantienes ocupada la pÃ¡gina principal, se ejecutarÃ¡ la pÃ¡gina iframe.

BÃ¡sicamente, en ese desafÃ­o se ejecuta un **iframe aislado** y justo **despuÃ©s** de que se **cargue**, la **pÃ¡gina principal** va a **enviar un mensaje post** con la **bandera**.\
Sin embargo, esa comunicaciÃ³n postmessage es **vulnerable a XSS** (el **iframe** puede ejecutar cÃ³digo JS).

Por lo tanto, el objetivo del atacante es **permitir que el padre cree el iframe**, pero **antes** de permitir que la **pÃ¡gina principal** **envÃ­e los datos sensibles** (**bandera**) **mantenerla ocupada** y enviar el **payload al iframe**. Mientras el **padre estÃ¡ ocupado**, el **iframe ejecuta el payload** que serÃ¡ algÃºn JS que escucharÃ¡ el **mensaje postmessage del padre y filtrarÃ¡ la bandera**.\
Finalmente, el iframe ha ejecutado el payload y la pÃ¡gina principal deja de estar ocupada, por lo que envÃ­a la bandera y el payload la filtra.

Pero, Â¿cÃ³mo podrÃ­as hacer que el padre estÃ© **ocupado justo despuÃ©s de generar el iframe y solo mientras espera a que el iframe estÃ© listo para enviar los datos sensibles**? BÃ¡sicamente, necesitas encontrar una **acciÃ³n asÃ­ncrona** que puedas hacer que el padre **ejecute**. Por ejemplo, en ese desafÃ­o, el padre estaba **escuchando** los **postmessages** como este:
```javascript
window.addEventListener('message', (e) => {
    if (e.data == 'blob loaded') {
        $("#previewModal").modal();
    }
});
```
AsÃ­ que era posible enviar un **entero grande en un postmessage** que se **convertirÃ­a en una cadena** en esa comparaciÃ³n, lo que llevarÃ­a algÃºn tiempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Y para ser precisos y **enviar** ese **postmessage** justo **despuÃ©s** de que se cree el **iframe** pero **antes** de que estÃ© **listo** para recibir los datos del padre, necesitarÃ¡s **jugar con los milisegundos de un `setTimeout`**.
