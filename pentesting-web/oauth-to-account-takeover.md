# OAuth para Toma de control de cuenta

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## Informaci贸n B谩sica <a href="#d4a8" id="d4a8"></a>

OAuth ofrece varias versiones, con informaci贸n fundamental accesible en la [documentaci贸n de OAuth 2.0](https://oauth.net/2/). Esta discusi贸n se centra principalmente en el ampliamente utilizado [tipo de concesi贸n de c贸digo de autorizaci贸n OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/), proporcionando un **marco de autorizaci贸n que permite a una aplicaci贸n acceder o realizar acciones en la cuenta de un usuario en otra aplicaci贸n** (el servidor de autorizaci贸n).

Considera un sitio web hipot茅tico _**https://ejemplo.com**_, dise帽ado para **mostrar todas tus publicaciones en redes sociales**, incluidas las privadas. Para lograr esto, se emplea OAuth 2.0. _https://ejemplo.com_ solicitar谩 tu permiso para **acceder a tus publicaciones en redes sociales**. En consecuencia, aparecer谩 una pantalla de consentimiento en _https://redessociales.com_, describiendo los **permisos solicitados y el desarrollador que realiza la solicitud**. Tras tu autorizaci贸n, _https://ejemplo.com_ obtiene la capacidad de **acceder a tus publicaciones en tu nombre**.

Es esencial comprender los siguientes componentes dentro del marco de OAuth 2.0:

- **propietario de recursos**: T煤, como **usuario/entidad**, autorizas el acceso a tu recurso, como tus publicaciones en redes sociales.
- **servidor de recursos**: El **servidor que gestiona las solicitudes autenticadas** despu茅s de que la aplicaci贸n ha asegurado un `token de acceso` en nombre del `propietario de recursos`, por ejemplo, **https://redessociales.com**.
- **aplicaci贸n cliente**: La **aplicaci贸n que busca autorizaci贸n** del `propietario de recursos`, como **https://ejemplo.com**.
- **servidor de autorizaci贸n**: El **servidor que emite `tokens de acceso`** a la `aplicaci贸n cliente` tras la autenticaci贸n exitosa del `propietario de recursos` y la obtenci贸n de autorizaci贸n, por ejemplo, **https://redessociales.com**.
- **client\_id**: Un identificador p煤blico y 煤nico para la aplicaci贸n.
- **client\_secret:** Una clave confidencial, conocida 煤nicamente por la aplicaci贸n y el servidor de autorizaci贸n, utilizada para generar `tokens de acceso`.
- **response\_type**: Un valor que especifica **el tipo de token solicitado**, como `c贸digo`.
- **scope**: El **nivel de acceso** que la `aplicaci贸n cliente` est谩 solicitando al `propietario de recursos`.
- **redirect\_uri**: La **URL a la que se redirige al usuario despu茅s de la autorizaci贸n**. Normalmente debe coincidir con la URL de redirecci贸n preregistrada.
- **state**: Un par谩metro para **mantener datos a trav茅s de la redirecci贸n del usuario hacia y desde el servidor de autorizaci贸n**. Su singularidad es fundamental para servir como un **mecanismo de protecci贸n CSRF**.
- **grant\_type**: Un par谩metro que indica **el tipo de concesi贸n y el tipo de token que se devolver谩**.
- **c贸digo**: El c贸digo de autorizaci贸n del `servidor de autorizaci贸n`, utilizado junto con `client_id` y `client_secret` por la aplicaci贸n cliente para adquirir un `token de acceso`.
- **token de acceso**: El **token que la aplicaci贸n cliente utiliza para las solicitudes de API** en nombre del `propietario de recursos`.
- **refresh\_token**: Permite a la aplicaci贸n **obtener un nuevo `token de acceso` sin volver a solicitar al usuario**.

### Flujo

El **flujo real de OAuth** procede de la siguiente manera:

1. Accedes a [https://ejemplo.com](https://ejemplo.com) y seleccionas el bot贸n "Integrar con Redes Sociales".
2. El sitio luego env铆a una solicitud a [https://redessociales.com](https://redessociales.com) solicitando tu autorizaci贸n para permitir que la aplicaci贸n de https://ejemplo.com acceda a tus publicaciones. La solicitud est谩 estructurada de la siguiente manera:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. A continuaci贸n, se te presenta una p谩gina de consentimiento.

4. Despu茅s de tu aprobaci贸n, la Red Social env铆a una respuesta a la `redirect_uri` con los par谩metros `code` y `state`:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com utiliza este `c贸digo`, junto con su `client_id` y `client_secret`, para realizar una solicitud del lado del servidor y obtener un `access_token` en tu nombre, lo que permite acceder a los permisos a los que has dado tu consentimiento:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Finalmente, el proceso concluye cuando https://example.com emplea tu `access_token` para realizar una llamada a la API de Social Media y acceder

## Vulnerabilidades <a href="#323a" id="323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

El `redirect_uri` es crucial para la seguridad en las implementaciones de OAuth y OpenID, ya que dirige hacia d贸nde se env铆an los datos sensibles, como c贸digos de autorizaci贸n, despu茅s de la autorizaci贸n. Si est谩 mal configurado, podr铆a permitir a los atacantes redirigir estas solicitudes a servidores maliciosos, lo que habilitar铆a la toma de control de cuentas.

Las t茅cnicas de explotaci贸n var铆an seg煤n la l贸gica de validaci贸n del servidor de autorizaci贸n. Pueden ir desde la coincidencia estricta de rutas hasta la aceptaci贸n de cualquier URL dentro del dominio o subdirectorio especificado. Los m茅todos comunes de explotaci贸n incluyen redirecciones abiertas, traversal de rutas, explotaci贸n de regex d茅biles e inyecci贸n de HTML para robo de tokens.

Adem谩s del `redirect_uri`, otros par谩metros de OAuth y OpenID como `client_uri`, `policy_uri`, `tos_uri` y `initiate_login_uri` tambi茅n son susceptibles a ataques de redirecci贸n. Estos par谩metros son opcionales y su soporte var铆a entre servidores.

Para aquellos que apuntan a un servidor OpenID, el punto de descubrimiento (`**.well-known/openid-configuration**`) a menudo enumera detalles de configuraci贸n valiosos como `registration_endpoint`, `request_uri_parameter_supported` y "`require_request_uri_registration`. Estos detalles pueden ayudar a identificar el punto de registro y otros aspectos de configuraci贸n del servidor.

### XSS en la implementaci贸n de redirecci贸n <a href="#bda5" id="bda5"></a>

Como se menciona en este informe de recompensa por errores [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html) podr铆a ser posible que la **URL de redirecci贸n se refleje en la respuesta** del servidor despu茅s de que el usuario se autentique, siendo **vulnerable a XSS**. Carga 煤til posible para probar:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Manejo inadecuado del par谩metro de estado <a href="#bda5" id="bda5"></a>

En las implementaciones de OAuth, el mal uso u omisi贸n del **par谩metro `state`** puede aumentar significativamente el riesgo de ataques de **falsificaci贸n de solicitudes entre sitios (CSRF)**. Esta vulnerabilidad surge cuando el par谩metro `state` no se utiliza, se utiliza como un valor est谩tico o no se valida correctamente, lo que permite a los atacantes eludir las protecciones CSRF.

Los atacantes pueden explotar esto interceptando el proceso de autorizaci贸n para vincular su cuenta con la cuenta de una v铆ctima, lo que puede llevar a posibles **tomas de control de cuentas**. Esto es especialmente cr铆tico en aplicaciones donde se utiliza OAuth con fines de **autenticaci贸n**.

Se han documentado ejemplos del mundo real de esta vulnerabilidad en varios desaf铆os de **CTF** y **plataformas de hacking**, destacando sus implicaciones pr谩cticas. El problema tambi茅n se extiende a integraciones con servicios de terceros como **Slack**, **Stripe** y **PayPal**, donde los atacantes pueden redirigir notificaciones o pagos a sus cuentas.

El manejo adecuado y la validaci贸n del **par谩metro `state`** son cruciales para protegerse contra CSRF y asegurar el flujo de OAuth.

### Pre Toma de Control de Cuenta <a href="#ebe4" id="ebe4"></a>

1. **Sin verificaci贸n de correo electr贸nico en la creaci贸n de cuentas**: Los atacantes pueden crear anticipadamente una cuenta utilizando el correo electr贸nico de la v铆ctima. Si la v铆ctima luego utiliza un servicio de terceros para iniciar sesi贸n, la aplicaci贸n podr铆a vincular inadvertidamente esta cuenta de terceros a la cuenta precreada del atacante, lo que lleva a un acceso no autorizado.

2. **Explotando la laxa verificaci贸n de correo electr贸nico de OAuth**: Los atacantes pueden explotar servicios de OAuth que no verifican correos electr贸nicos registr谩ndose con su servicio y luego cambiando el correo electr贸nico de la cuenta al de la v铆ctima. Este m茅todo tambi茅n conlleva riesgos de acceso no autorizado a la cuenta, similar al primer escenario pero a trav茅s de un vector de ataque diferente.

### Divulgaci贸n de Secretos <a href="#e177" id="e177"></a>

Identificar y proteger los par谩metros secretos de OAuth es crucial. Mientras que el **`client_id`** se puede divulgar de forma segura, revelar el **`client_secret`** plantea riesgos significativos. Si el `client_secret` se ve comprometido, los atacantes pueden explotar la identidad y la confianza de la aplicaci贸n para **robar `access_tokens`** e informaci贸n privada.

Una vulnerabilidad com煤n surge cuando las aplicaciones manejan err贸neamente el intercambio del `code` de autorizaci贸n por un `access_token` en el lado del cliente en lugar del lado del servidor. Este error conduce a la exposici贸n del `client_secret`, lo que permite a los atacantes generar `access_tokens` bajo la apariencia de la aplicaci贸n. Adem谩s, a trav茅s de la ingenier铆a social, los atacantes podr铆an escalar privilegios agregando alcances adicionales a la autorizaci贸n de OAuth, explotando a煤n m谩s el estado de confianza de la aplicaci贸n.

### Fuerza Bruta del Cliente Secreto

Puedes intentar **fuerza bruta en el client\_secret** de un proveedor de servicios con el proveedor de identidad para intentar robar cuentas.\
La solicitud para la FB puede ser similar a:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header filtrando C贸digo + Estado

Una vez que el cliente tenga el **c贸digo y el estado**, si se **refleja dentro del encabezado Referer** cuando navega a una p谩gina diferente, entonces es vulnerable.

### Token de Acceso Almacenado en el Historial del Navegador

Ve al **historial del navegador y verifica si el token de acceso est谩 guardado all铆**.

### C贸digo de Autorizaci贸n Eterno

El **c贸digo de autorizaci贸n deber铆a existir solo por un tiempo limitado para reducir la ventana de tiempo en la que un atacante puede robarlo y usarlo**.

### Token de Autorizaci贸n/Actualizaci贸n no vinculado al cliente

Si puedes obtener el **c贸digo de autorizaci贸n y usarlo con un cliente diferente, entonces puedes tomar el control de otras cuentas**.

### Rutas Felices, XSS, Iframes y Mensajes Post para filtrar c贸digos y valores de estado

**[Revisa este post](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)**

### AWS Cognito <a href="#bda5" id="bda5"></a>

En este informe de recompensa por errores: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) puedes ver que el **token** que **AWS Cognito** devuelve al usuario podr铆a tener **suficientes permisos para sobrescribir los datos del usuario**. Por lo tanto, si puedes **cambiar el correo electr贸nico del usuario por un correo electr贸nico de otro usuario**, podr铆as **apoderarte** de otras cuentas.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
### Abusando de tokens de otras aplicaciones <a href="#bda5" id="bda5"></a>

Como se menciona en [**este art铆culo**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), los flujos de OAuth que esperan recibir el **token** (y no un c贸digo) podr铆an ser vulnerables si no verifican que el token pertenezca a la aplicaci贸n.

Esto se debe a que un **atacante** podr铆a crear una **aplicaci贸n compatible con OAuth e iniciar sesi贸n con Facebook** (por ejemplo) en su propia aplicaci贸n. Luego, una vez que una v铆ctima inicie sesi贸n con Facebook en la **aplicaci贸n del atacante**, el atacante podr铆a obtener el **token de OAuth del usuario otorgado a su aplicaci贸n y usarlo para iniciar sesi贸n en la aplicaci贸n de OAuth de la v铆ctima utilizando el token de usuario de la v铆ctima**.

{% hint style="danger" %}
Por lo tanto, si el atacante logra que el usuario acceda a su propia aplicaci贸n de OAuth, podr谩 tomar el control de la cuenta de la v铆ctima en aplicaciones que esperan un token y no verifican si el token fue otorgado a su ID de aplicaci贸n.
{% endhint %}

### Dos enlaces y cookie <a href="#bda5" id="bda5"></a>

Seg煤n [**este art铆culo**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), era posible hacer que una v铆ctima abriera una p谩gina con un **returnUrl** que apuntara al host del atacante. Esta informaci贸n se **almacenar铆a en una cookie (RU)** y en un **paso posterior**, el **prompt** le **preguntar铆a** al **usuario** si desea dar acceso a ese host del atacante.

Para evitar este prompt, era posible abrir una pesta帽a para iniciar el **flujo de OAuth** que establecer铆a esta cookie RU utilizando el **returnUrl**, cerrar la pesta帽a antes de que se muestre el prompt y abrir una nueva pesta帽a sin ese valor. Entonces, el **prompt no informar谩 sobre el host del atacante**, pero la cookie se establecer谩 en 茅l, por lo que el **token se enviar谩 al host del atacante** en la redirecci贸n.

### Par谩metros de SSRFs <a href="#bda5" id="bda5"></a>

**[Consulta esta investigaci贸n](https://portswigger.net/research/hidden-oauth-attack-vectors) para m谩s detalles sobre esta t茅cnica.**

El Registro Din谩mico de Clientes en OAuth sirve como un vector menos obvio pero cr铆tico para vulnerabilidades de seguridad, espec铆ficamente para ataques de **Falsificaci贸n de Solicitudes del Lado del Servidor (SSRF)**. Este punto final permite a los servidores de OAuth recibir detalles sobre las aplicaciones cliente, incluidas URL sensibles que podr铆an ser explotadas.

**Puntos Clave:**

- El **Registro Din谩mico de Clientes** a menudo se asigna a `/register` y acepta detalles como `client_name`, `client_secret`, `redirect_uris` y URLs para logotipos o Conjuntos de Claves Web JSON (JWKs) a trav茅s de solicitudes POST.
- Esta caracter铆stica se adhiere a las especificaciones establecidas en **RFC7591** y **OpenID Connect Registration 1.0**, que incluyen par谩metros potencialmente vulnerables a SSRF.
- El proceso de registro puede exponer inadvertidamente a los servidores a SSRF de varias maneras:
- **`logo_uri`**: Una URL para el logotipo de la aplicaci贸n cliente que podr铆a ser recuperado por el servidor, desencadenando SSRF o llevando a XSS si la URL se maneja incorrectamente.
- **`jwks_uri`**: Una URL al documento JWK del cliente, que si se crea maliciosamente, puede hacer que el servidor realice solicitudes salientes a un servidor controlado por el atacante.
- **`sector_identifier_uri`**: Hace referencia a una matriz JSON de `redirect_uris`, que el servidor podr铆a recuperar, creando una oportunidad de SSRF.
- **`request_uris`**: Enumera los URIs de solicitud permitidos para el cliente, que pueden ser explotados si el servidor recupera estos URIs al inicio del proceso de autorizaci贸n.

**Estrategia de Explotaci贸n:**

- Se puede desencadenar SSRF registrando un nuevo cliente con URLs maliciosas en par谩metros como `logo_uri`, `jwks_uri` o `sector_identifier_uri`.
- Mientras que la explotaci贸n directa a trav茅s de `request_uris` puede ser mitigada por controles de lista blanca, suministrar un `request_uri` preregistrado y controlado por el atacante puede facilitar SSRF durante la fase de autorizaci贸n.

## Condiciones de Carrera en proveedores de OAuth

Si la plataforma que est谩s probando es un proveedor de OAuth, [**lee esto para probar posibles Condiciones de Carrera**](race-condition.md).

## Referencias

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)


<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Aprende hacking de AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
