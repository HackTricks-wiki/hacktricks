# Proxy / WAF Protections Bypass

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
- **HackTricks**ãŠã‚ˆã³**HackTricks Cloud**ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Nginx ACLãƒ«ãƒ¼ãƒ«ã®ãƒ‘ã‚¹åæ“ä½œã«ã‚ˆã‚‹ãƒã‚¤ãƒ‘ã‚¹ <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

[ã“ã®ç ”ç©¶](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)ã‹ã‚‰ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã€‚

Nginxã®ãƒ«ãƒ¼ãƒ«ä¾‹ï¼š
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
### **NodeJS - Express**

| Nginx Version | **Node.js Bypass Characters** |
| ------------- | ----------------------------- |
| 1.22.0        | `\xA0`                        |
| 1.21.6        | `\xA0`                        |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`        |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`        |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`        |

### **Flask**

| Nginx Version | **Flask Bypass Characters**                                    |
| ------------- | -------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                 |
| 1.21.6        | `\x85`, `\xA0`                                                 |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx Version | **Spring Boot Bypass Characters** |
| ------------- | --------------------------------- |
| 1.22.0        | `;`                               |
| 1.21.6        | `;`                               |
| 1.20.2        | `\x09`, `;`                       |
| 1.18.0        | `\x09`, `;`                       |
| 1.16.1        | `\x09`, `;`                       |

### **PHP-FPM**

Nginx FPM configuration:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginxã¯`/admin.php`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ãŒã€`/admin.php/index.php`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### é˜²æ­¢æ–¹æ³•
```plaintext
location ~* ^/admin {
deny all;
}
```
## Mod Securityãƒ«ãƒ¼ãƒ«ã®ãƒã‚¤ãƒ‘ã‚¹ <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### ãƒ‘ã‚¹ã®æ··ä¹±

[**ã“ã®æŠ•ç¨¿**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)ã§ã¯ã€ModSecurity v3ï¼ˆ3.0.12ã¾ã§ï¼‰ãŒ`REQUEST_FILENAME`å¤‰æ•°ã‚’é©åˆ‡ã«å®Ÿè£…ã—ã¦ã„ãªã‹ã£ãŸã“ã¨ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®å¤‰æ•°ã¯ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸãƒ‘ã‚¹ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®é–‹å§‹ã¾ã§ï¼‰ã‚’å«ã‚€ã¯ãšã§ã—ãŸã€‚ã“ã‚Œã¯ã€ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«URLãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸãŸã‚ã§ã™ã€‚\
ã—ãŸãŒã£ã¦ã€Mod Securityã§ã®`http://example.com/foo%3f';alert(1);foo=`ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€`%3f`ãŒ`?`ã«å¤‰æ›ã•ã‚Œã¦URLãƒ‘ã‚¹ãŒçµ‚äº†ã™ã‚‹ãŸã‚ã€ãƒ‘ã‚¹ãŒå˜ã«`/foo`ã§ã‚ã‚‹ã¨ä»®å®šã—ã¾ã™ãŒã€å®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ãŒå—ä¿¡ã™ã‚‹ãƒ‘ã‚¹ã¯`/foo%3f';alert(1);foo=`ã«ãªã‚Šã¾ã™ã€‚

å¤‰æ•°`REQUEST_BASENAME`ã¨`PATH_INFO`ã‚‚ã“ã®ãƒã‚°ã®å½±éŸ¿ã‚’å—ã‘ã¾ã—ãŸã€‚

Mod Securityã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³2ã§ã‚‚åŒæ§˜ã®ã“ã¨ãŒèµ·ã“ã‚Šã€ç‰¹å®šã®æ‹¡å¼µå­ã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼š`.bak`ãªã©ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ãä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚å˜ã«ãƒ‰ãƒƒãƒˆã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸ`%2e`ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ä¾‹ãˆã°ã€`https://example.com/backup%2ebak`ã€‚

## AWS WAF ACLã®ãƒã‚¤ãƒ‘ã‚¹ <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### ä¸æ­£ãªãƒ˜ãƒƒãƒ€ãƒ¼

[ã“ã®ç ”ç©¶](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)ã«ã‚ˆã‚‹ã¨ã€AWS WAFãŒé©ç”¨ã•ã‚ŒãŸHTTPãƒ˜ãƒƒãƒ€ãƒ¼ä¸Šã®ãƒ«ãƒ¼ãƒ«ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã‚ã‚Šã€AWSãŒé©åˆ‡ã«è§£æã—ãªã‹ã£ãŸãŒã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒè§£æã—ãŸã€Œä¸æ­£ãªã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã—ãŸã€‚

ä¾‹ãˆã°ã€æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãƒ˜ãƒƒãƒ€ãƒ¼X-Queryã«SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
AWS WAFã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã—ãŸã€‚ã“ã‚Œã¯ã€æ¬¡ã®è¡ŒãŒãƒ˜ãƒƒãƒ€ãƒ¼ã®å€¤ã®ä¸€éƒ¨ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—ãªã‹ã£ãŸãŸã‚ã§ã€ä¸€æ–¹ã€NODEJSã‚µãƒ¼ãƒãƒ¼ã¯ç†è§£ã—ã¦ã„ã¾ã—ãŸï¼ˆã“ã‚Œã¯ä¿®æ­£ã•ã‚Œã¾ã—ãŸï¼‰ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)


<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§ã®AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã™ã‚‹ã€‚

</details>
