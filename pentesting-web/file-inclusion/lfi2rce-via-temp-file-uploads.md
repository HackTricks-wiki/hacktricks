<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>



**Consulta todos los detalles de esta t茅cnica en [https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf](https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf)**

## **Cargas de archivos PHP**

Cuando un motor de **PHP** recibe una **solicitud POST** que contiene archivos formateados seg煤n RFC 1867, genera archivos temporales para almacenar los datos cargados. Estos archivos son cruciales para el manejo de la carga de archivos en scripts de PHP. La funci贸n `move_uploaded_file` debe usarse para trasladar estos archivos temporales a una ubicaci贸n deseada si se necesita almacenamiento persistente m谩s all谩 de la ejecuci贸n del script. Despu茅s de la ejecuci贸n, PHP elimina autom谩ticamente cualquier archivo temporal restante.

{% hint style="info" %}
**Alerta de seguridad: Los atacantes, al conocer la ubicaci贸n de los archivos temporales, podr铆an explotar una vulnerabilidad de Inclusi贸n de Archivos Locales para ejecutar c贸digo accediendo al archivo durante la carga.**
{% endhint %}

El desaf铆o para el acceso no autorizado radica en predecir el nombre del archivo temporal, que est谩 intencionalmente aleatorizado.

#### Explotaci贸n en Sistemas Windows

En Windows, PHP genera nombres de archivo temporales utilizando la funci贸n `GetTempFileName`, lo que resulta en un patr贸n como `<path>\<pre><uuuu>.TMP`. Es importante destacar que:

- La ruta predeterminada suele ser `C:\Windows\Temp`.
- El prefijo suele ser "php".
- El `<uuuu>` representa un valor hexadecimal 煤nico. Es crucial mencionar que, debido a la limitaci贸n de la funci贸n, solo se utilizan los 16 bits inferiores, lo que permite un m谩ximo de 65,535 nombres 煤nicos con una ruta y prefijo constantes, lo que hace factible la fuerza bruta.

Adem谩s, el proceso de explotaci贸n se simplifica en sistemas Windows. Una peculiaridad en la funci贸n `FindFirstFile` permite el uso de comodines en las rutas de Inclusi贸n de Archivos Locales (LFI). Esto permite crear una ruta de inclusi贸n como la siguiente para localizar el archivo temporal:
```
http://site/vuln.php?inc=c:\windows\temp\php<<
```
En ciertas situaciones, puede ser necesario un m谩scara m谩s espec铆fica (como `php1<<` o `phpA<<`). Se puede probar sistem谩ticamente estas m谩scaras para descubrir el archivo temporal subido.

#### Explotaci贸n en Sistemas GNU/Linux

Para sistemas GNU/Linux, la aleatoriedad en la nomenclatura de archivos temporales es s贸lida, lo que hace que los nombres no sean predecibles ni susceptibles a ataques de fuerza bruta. Se pueden encontrar m谩s detalles en la documentaci贸n referenciada.
