<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


## **Uploads de arquivos PHP**

O motor **PHP**, ao **receber um pacote POST** com **arquivos codificados** em **RFC 1867**, **cria** um ou mais **arquivos temporÃ¡rios** que sÃ£o usados para **armazenar os dados dos arquivos enviados**. Um script PHP que manipula uploads de arquivos deve usar a funÃ§Ã£o move\_uploaded\_file para mover o arquivo temporÃ¡rio enviado para um local desejado (se o script exigir que o arquivo exista apÃ³s o tÃ©rmino, Ã© claro). **Quando o script termina, o motor PHP remove todos os arquivos temporÃ¡rios** para os arquivos que foram enviados (se houver algum arquivo temporÃ¡rio restante apÃ³s o tÃ©rmino do script).

{% hint style="info" %}
**Como o invasor geralmente sabe onde esses arquivos temporÃ¡rios estÃ£o localizados, caso ele encontre uma InclusÃ£o Local de Arquivo, ele pode carregar o arquivo sendo enviado e obter RCE.**
{% endhint %}

O principal problema para acessar o arquivo Ã© basicamente **adivinhar seu nome (que serÃ¡ "aleatÃ³rio")**.

## ExploraÃ§Ã£o no Windows

Para gerar o **nome aleatÃ³rio no Windows**, o PHP usa a funÃ§Ã£o **`GetTempFileName`**. Ao procurar na documentaÃ§Ã£o, podemos encontrar a seguinte explicaÃ§Ã£o: A funÃ§Ã£o GetTempFileName cria um nome de arquivo temporÃ¡rio com a seguinte forma:

`<path>\<pre><uuuu>.TMP`

* O caminho Ã© `upload_tmp_dir`, que normalmente Ã© `C:\Windows\Temp`
* O prefixo Ã© geralmente: "php"
* O \<uuuu> Ã© um valor hexadecimal exclusivo. No entanto:
  * Apenas os 16 bits inferiores do parÃ¢metro uUnique sÃ£o usados. Isso limita o GetTempFileName a um mÃ¡ximo de 65.535 nomes de arquivo exclusivos se os parÃ¢metros lpPathName e lpPrefixString permanecerem os mesmos. **Ã‰ possÃ­vel forÃ§ar a entrada.**

Como vimos, Ã© bastante **fÃ¡cil** **encontrar** o **arquivo temporÃ¡rio em sistemas Windows**. E vai ficar mais fÃ¡cil porque a forÃ§a bruta nÃ£o Ã© necessÃ¡ria aqui, graÃ§as a uma peculiaridade do FindFirstFile que permite **usar mÃ¡scaras** (<< como \* e > como ?) em caminhos LFI no Windows. GraÃ§as a isso, pode-se formar um **caminho de inclusÃ£o como este**:
```
http://site/vuln.php?inc=c:\windows\temp\php<<
```
(Em alguns casos, uma mÃ¡scara mais especÃ­fica pode ser necessÃ¡ria, como `php1<<` ou `phpA<<`). VocÃª pode fazer Brute-Force de mÃ¡scaras mais especÃ­ficas atÃ© encontrar o arquivo temporÃ¡rio enviado.

## ExploraÃ§Ã£o GNU/Linux

O valor aleatÃ³rio do nome do arquivo Ã© bom o suficiente para nÃ£o ser previsÃ­vel nem passÃ­vel de Brute-Force. Para mais informaÃ§Ãµes, verifique as referÃªncias.

## ReferÃªncias

* [https://gynvael.coldwind.pl/?id=376](https://gynvael.coldwind.pl/?id=376)
* [https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf](https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
