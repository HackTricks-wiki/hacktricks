# LFI2RCE a travÃ©s de PHP\_SESSION\_UPLOAD\_PROGRESS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### InformaciÃ³n bÃ¡sica

Si encontraste una **InclusiÃ³n de Archivos Locales** incluso si **no tienes una sesiÃ³n** y `session.auto_start` estÃ¡ `Off`. Si **`session.upload_progress.enabled`** estÃ¡ **`On`** y proporcionas **`PHP_SESSION_UPLOAD_PROGRESS`** en los datos **multipart POST**, PHP **habilitarÃ¡ la sesiÃ³n para ti**.
```bash
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange'
$ ls -a /var/lib/php/sessions/
. ..
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange' -d 'PHP_SESSION_UPLOAD_PROGRESS=blahblahblah'
$ ls -a /var/lib/php/sessions/
. ..
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange' -F 'PHP_SESSION_UPLOAD_PROGRESS=blahblahblah'  -F 'file=@/etc/passwd'
$ ls -a /var/lib/php/sessions/
. .. sess_iamorange

In the last example the session will contain the string blahblahblah
```
Ten en cuenta que con **`PHP_SESSION_UPLOAD_PROGRESS`** puedes **controlar los datos dentro de la sesiÃ³n**, por lo que si incluyes tu archivo de sesiÃ³n, puedes incluir una parte que controles (como un shellcode de PHP, por ejemplo).

{% hint style="info" %}
Aunque la mayorÃ­a de los tutoriales en Internet recomiendan establecer `session.upload_progress.cleanup` en `Off` con fines de depuraciÃ³n, la configuraciÃ³n predeterminada de `session.upload_progress.cleanup` en PHP sigue siendo `On`. Esto significa que tu progreso de carga en la sesiÃ³n se limpiarÃ¡ lo antes posible. Por lo tanto, esto serÃ¡ una **condiciÃ³n de carrera**.
{% endhint %}

### El CTF

En el [**CTF original**](https://blog.orange.tw/2018/10/) donde se comenta esta tÃ©cnica, no fue suficiente explotar la condiciÃ³n de carrera, sino que el contenido cargado tambiÃ©n necesitaba comenzar con la cadena `@<?php`.

Debido a la configuraciÃ³n predeterminada de `session.upload_progress.prefix`, nuestro **archivo de SESIÃ“N comenzarÃ¡ con un prefijo molesto** `upload_progress_`. Por ejemplo: `upload_progress_controlledcontentbyattacker`

El truco para **eliminar el prefijo inicial** fue **codificar en base64 la carga Ãºtil 3 veces** y luego decodificarla mediante filtros `convert.base64-decode`, esto se debe a que cuando **decodificas en base64, PHP eliminarÃ¡ los caracteres extraÃ±os**, por lo que despuÃ©s de 3 veces solo la **carga Ãºtil enviada** por el atacante **permanecerÃ¡** (y luego el atacante puede controlar la parte inicial).

MÃ¡s informaciÃ³n en el informe original [https://blog.orange.tw/2018/10/](https://blog.orange.tw/2018/10/) y en la explotaciÃ³n final [https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp\_for\_php.py](https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp\_for\_php.py)\
Otro informe en [https://spyclub.tech/2018/12/21/one-line-and-return-of-one-line-php-writeup/](https://spyclub.tech/2018/12/21/one-line-and-return-of-one-line-php-writeup/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
