# Aplicaciones Xamarin

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informaci贸n B谩sica**

Xamarin es una plataforma de c贸digo abierto que proporciona a los desarrolladores acceso a una amplia selecci贸n de herramientas y complementos, permiti茅ndoles **crear aplicaciones modernas para iOS, Android y Windows utilizando los frameworks .NET y C#**.

### Arquitectura de Xamarin Android

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Xamarin ofrece enlaces .NET a los espacios de nombres Android.\* y Java.\*. Xamarin.

Las aplicaciones de Android funcionan bajo el entorno de ejecuci贸n Mono, con la m谩quina virtual Android Runtime (ART) ejecut谩ndose en paralelo.

El entorno de ejecuci贸n Mono llama a estos espacios de nombres a trav茅s de Managed Callable Wrappers (MCW) y proporciona Android Callable Wrappers (ACW) al ART.

Ambos entornos se ejecutan sobre el kernel de Linux e invocan varias APIs al c贸digo del usuario. La disposici贸n permite a los desarrolladores acceder al sistema subyacente.

### Proyecto Xamarin iOS

Las aplicaciones Xamarin.iOS se ejecutan bajo el entorno de ejecuci贸n Mono y utilizan la compilaci贸n completa Ahead of Time (AOT) para compilar c贸digos C# .NET a lenguaje ensamblador ARM.

Se ejecuta junto con el Runtime de Objective-C. Los entornos de ejecuci贸n se ejecutan sobre un kernel tipo UNIX e invocan varias APIs al c贸digo del usuario, lo que permite a los desarrolladores acceder al sistema gestionado o nativo subyacente.

El siguiente diagrama muestra esta arquitectura:

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 驴Qu茅 son el .Net Runtime y el Mono Framework?

**.Net framework es un conjunto de ensamblados, clases y espacios de nombres** que los desarrolladores pueden utilizar para crear aplicaciones; .Net Runtime ejecuta el c贸digo compilado, y el proceso se llama ejecuci贸n de c贸digo gestionado. .NET Runtime ofrece varias caracter铆sticas que aseguran la independencia de la plataforma y son compatibles con versiones anteriores del framework.

**Mono Framework** comenz贸 en 2005 como una implementaci贸n del .NET Framework para Linux (Ximian/SuSe/Novell). Patrocinado por Microsoft y liderado por Xamarin, Mono es la implementaci贸n de c贸digo abierto del framework .NET basada en los est谩ndares ECMA para Common Language Runtime y C#.

## T茅cnicas de Ingenier铆a Inversa para Aplicaciones Xamarin

### Decompilaci贸n de Ensamblados Xamarin

La decompilaci贸n es el proceso utilizado para producir c贸digo fuente a partir de c贸digo compilado. Para obtener informaci贸n sobre los ensamblados y ejecutables actualmente en memoria, Windows es un excelente lugar.

Para abrir la ventana de M贸dulos, selecciona Debug > Windows > Modules. Una vez que detectes el m贸dulo que requiere decompilaci贸n, haz clic derecho y selecciona "Decompile Source to Symbol File". Esta acci贸n **crea un archivo de s铆mbolos que contiene una fuente decompilada que**, a su vez, te permite entrar directamente en el c贸digo de terceros desde tu c贸digo fuente.

**Visual Studio** decompila el c贸digo gestionado, incluso en ausencia de s铆mbolos, permiti茅ndote mirar el c贸digo, inspeccionar las variables y establecer puntos de interrupci贸n. Para extraer el c贸digo fuente al disco, haz clic derecho en el m贸dulo con fuente incrustada y haz clic en "Extract Embedded Source ." Esto exportar谩 los archivos fuente a una carpeta de archivos Miscel谩neos para un an谩lisis posterior.

### Compilaci贸n JIT vs AOT de Aplicaciones Xamarin

Estas dos opciones para compilar c贸digo Xamarin basado en C# en una aplicaci贸n, es decir, **compilaci贸n Just in time y compilaci贸n ahead of time**. La forma de compilaci贸n afecta c贸mo se env铆a el c贸digo de la aplicaci贸n dentro del archivo apk o ipa. Echemos un vistazo r谩pido a continuaci贸n:

\- **Android**: Xamarin te permite compilar utilizando **tanto las banderas JIT como AOT para android**. Tambi茅n hay una forma de encontrar un punto intermedio para obtener la mayor velocidad de ejecuci贸n utilizando el modo Hybrid AOT. Ten en cuenta que el modo Full AOT solo est谩 disponible para la licencia Enterprise.

\- **iOS**: Solo hay una opci贸n en el caso de iOS, **compilaci贸n ahead-of-time**. Esto se debe a las pol铆ticas de Apple que proh铆ben la ejecuci贸n de c贸digo generado din谩micamente en un dispositivo.

{% hint style="info" %}
Si te encuentras con una aplicaci贸n compilada Full AOT, y si los archivos IL Assembly son eliminados para reducir el tama帽o de la compilaci贸n por el desarrollador, entonces la ingenier铆a inversa requiere un paso extra de extracci贸n de archivos dll de los archivos .dll.so de la carpeta lib o del archivo `libmonodroid_bundle_app.so`. Si es una aplicaci贸n compilada Hybrid AOT, y los archivos IL todav铆a se mantienen en el paquete de la aplicaci贸n, podemos usar eso para hacer ingenier铆a inversa de la aplicaci贸n.
{% endhint %}

## Obtenci贸n de los archivos dll del APK/IPA

Simplemente **descomprime el archivo apk/ipa** y copia todos los archivos presentes en el directorio de ensamblados:

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

En el caso de los **APKs de Android, estos archivos dll est谩n comprimidos** y no se pueden utilizar directamente para la decompilaci贸n. Afortunadamente, hay herramientas disponibles que podemos usar para **descomprimir estos archivos dll** como [XamAsmUnZ](https://github.com/cihansol/XamAsmUnZ) y [xamarin-decompress](https://github.com/NickstaDB/xamarin-decompress).
```
python3 xamarin-decompress.py -o /path/to/decompressed/apk
```
Es posible que en lugar de archivos dll veas `assemblies.blob` y `assemblies.manifest` en el directorio de ensamblados. Esto es un Xamarin AssemblyStore y la forma actualmente recomendada de empaquetar dlls en una aplicaci贸n Android. El `assemblies.manifest` es un archivo de texto que describe los contenidos del archivo binario `assemblies.blob`. Para desempaquetar estos necesitar谩s usar [pyxamstore](https://github.com/jakev/pyxamstore).
```
pyxamstore unpack -d /path/to/decompressed/apk/assemblies/
```
En el caso de iOS, **los archivos dll dentro de los archivos IPA pueden cargarse directamente** en un descompilador (no es necesario descomprimir nada).

**La mayor铆a del c贸digo de la aplicaci贸n se puede encontrar cuando descompilamos los archivos dll.** Tambi茅n tenga en cuenta que las aplicaciones basadas en el Framework de Xamarin contienen un 90% de c贸digo com煤n en las compilaciones de todas las plataformas como iOS, Android, etc.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

A partir de la captura de pantalla anterior que muestra los archivos dll presentes en el apk, podemos confirmar que es una aplicaci贸n Xamarin. Contiene archivos dll espec铆ficos de la aplicaci贸n junto con los archivos de biblioteca que se requieren para que la aplicaci贸n funcione, como `Xamarin.Essentails.dll` o `Mono.Security.dll`.

{% hint style="success" %}
Finalmente, puede usar [**estas herramientas recomendadas**](../reversing/reversing-tools-basic-methods/#net-decompiler) para acceder al **c贸digo C#** de los DLLs.
{% endhint %}

## An谩lisis Din谩mico

Intente verificar si la aplicaci贸n tiene alg煤n tipo de SSL pinning implementado. Si no, usar Burp como un CA del sistema deber铆a funcionar para interceptar solicitudes. **Frida con el entorno de ejecuci贸n de Java o ObjC no funcionar谩** aqu铆, pero afortunadamente hay una herramienta que se puede usar para engancharse a los m茅todos.

[**Fridax**](https://github.com/NorthwaveSecurity/fridax) le permite **modificar el binario .NET dentro de una aplicaci贸n Xamarin en tiempo de ejecuci贸n**. El an谩lisis est谩tico le ayudar谩 a identificar diferentes m茅todos presentes dentro de la aplicaci贸n, que luego pueden ser enganchados para el an谩lisis din谩mico usando Fridax. A continuaci贸n, se muestran algunos scripts de Frida que pueden ayudarnos a eludir la detecci贸n de root o el SSL-pinning:

* [**xamarin-antiroot**](https://codeshare.frida.re/@Gand3lf/xamarin-antiroot/)
* [**xamarin-root-detect-bypass**](https://codeshare.frida.re/@nuschpl/xamarin-root-detect-bypass/)
* [**Frida-xamarin-unpin**](https://github.com/GoSecure/frida-xamarin-unpin)

## Referencias

* [https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers](https://www.appknox.com/security/xamarin-reverse-engineering-a-guide-for-penetration-testers)
* [https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/](https://thecobraden.com/posts/unpacking\_xamarin\_assembly\_stores/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al grupo de**  [**Discord**](https://discord.gg/hRep4RUj7f) o al grupo de [**telegram**](https://t.me/peass) o **sigue** a **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
