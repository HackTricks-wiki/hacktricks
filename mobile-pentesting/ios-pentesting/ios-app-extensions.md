# Extensiones de Aplicaciones iOS

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Contenido copiado de** [**https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#app-extensions**](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#app-extensions)

Las extensiones de aplicaciones permiten que las apps ofrezcan funcionalidad y contenido personalizados a los usuarios mientras interact煤an con otras aplicaciones o el sistema. Algunas notables son:

* **Teclado Personalizado**: reemplaza el teclado del sistema iOS con un teclado personalizado para su uso en todas las aplicaciones.
* **Compartir**: publicar en un sitio web de compartici贸n o compartir contenido con otros.
* **Hoy**: tambi茅n llamados **widgets**, ofrecen contenido o realizan tareas r谩pidas en la vista Hoy del Centro de Notificaciones.

Por ejemplo, el usuario selecciona texto en la _aplicaci贸n anfitriona_, hace clic en el bot贸n "Compartir" y selecciona una "aplicaci贸n" o acci贸n de la lista. Esto activa la _extensi贸n de aplicaci贸n_ de la _aplicaci贸n contenedora_. La extensi贸n de la aplicaci贸n muestra su vista dentro del contexto de la aplicaci贸n anfitriona y utiliza los elementos proporcionados por la aplicaci贸n anfitriona, el texto seleccionado en este caso, para realizar una tarea espec铆fica (publicarlo en una red social, por ejemplo). Vea esta imagen de la [Gu铆a de Programaci贸n de Extensiones de Aplicaciones de Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple_ref/doc/uid/TP40014214-CH2-SW13) que resume bastante bien esto:

![](https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQx9khfTwUwYuMti%2Fapp_extensions_communication.png?alt=media)

### **Consideraciones de Seguridad**

Desde el punto de vista de la seguridad es importante notar que:

* Una **extensi贸n de aplicaci贸n nunca se comunica directamente con su aplicaci贸n contenedora** (t铆picamente, ni siquiera est谩 en ejecuci贸n mientras la extensi贸n de aplicaci贸n contenida est谩 funcionando).
* Una **extensi贸n de aplicaci贸n** y la **aplicaci贸n anfitriona** **se comunican** a trav茅s de comunicaci贸n **entre procesos**.
* La **aplicaci贸n contenedora** de una **extensi贸n de aplicaci贸n** y la **aplicaci贸n anfitriona no se comunican** en absoluto.
* Un **widget Hoy** (y ning煤n otro tipo de extensi贸n de aplicaci贸n) puede pedir al sistema que abra su aplicaci贸n contenedora llamando al m茅todo `openURL:completionHandler:` de la clase `NSExtensionContext`.
* Cualquier **extensi贸n de aplicaci贸n** y su **aplicaci贸n contenedora** pueden **acceder a datos compartidos en un contenedor compartido definido de forma privada**.
* Las extensiones de aplicaciones **no pueden acceder a algunas APIs**, por ejemplo, HealthKit.
* **No pueden recibir datos usando AirDrop** pero s铆 pueden enviar datos.
* **No se permiten tareas de fondo de larga duraci贸n** pero se pueden iniciar subidas o descargas.
* Las extensiones de aplicaciones **no pueden acceder a la c谩mara o al micr贸fono en un dispositivo iOS** (excepto las extensiones de aplicaciones de iMessage).

### An谩lisis Est谩tico

#### **Verificando si la Aplicaci贸n Contiene Extensiones de Aplicaciones**

Si tienes el c贸digo fuente original puedes buscar todas las ocurrencias de `NSExtensionPointIdentifier` con Xcode (cmd+shift+f) o echar un vistazo en "Build Phases / Embed App extensions":

![](<../../.gitbook/assets/image (496).png>)

All铆 puedes encontrar los nombres de todas las extensiones de aplicaciones embebidas seguidas de `.appex`, ahora puedes navegar a las extensiones de aplicaciones individuales en el proyecto.

Si no tienes el c贸digo fuente original:

Busca `NSExtensionPointIdentifier` entre todos los archivos dentro del paquete de la aplicaci贸n (IPA o aplicaci贸n instalada):
```bash
$ grep -nr NSExtensionPointIdentifier Payload/Telegram\ X.app/
Binary file Payload/Telegram X.app//PlugIns/SiriIntents.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Share.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/NotificationContent.appex/Info.plist matches
Binary file Payload/Telegram X.app//PlugIns/Widget.appex/Info.plist matches
Binary file Payload/Telegram X.app//Watch/Watch.app/PlugIns/Watch Extension.appex/Info.plist matches
```
Tambi茅n puedes acceder por SSH, encontrar el paquete de la aplicaci贸n y listar todo dentro de PlugIns (est谩n colocados all铆 por defecto) o hacerlo con objection:
```bash
ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # cd PlugIns
/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35/
Telegram X.app/PlugIns

ph.telegra.Telegraph on (iPhone: 11.1.2) [usb] # ls
NSFileType      Perms  NSFileProtection    Read    Write     Name
------------  -------  ------------------  ------  -------   -------------------------
Directory         493  None                True    False     NotificationContent.appex
Directory         493  None                True    False     Widget.appex
Directory         493  None                True    False     Share.appex
Directory         493  None                True    False     SiriIntents.appex
```
Podemos ver ahora las mismas cuatro extensiones de aplicaci贸n que vimos en Xcode antes.

#### **Determinando los Tipos de Datos Soportados**

Esto es importante para los datos que se comparten con aplicaciones anfitrionas (por ejemplo, a trav茅s de Extensiones de Compartir o de Acci贸n). Cuando el usuario selecciona alg煤n tipo de dato en una aplicaci贸n anfitriona y coincide con los tipos de datos definidos aqu铆, la aplicaci贸n anfitriona ofrecer谩 la extensi贸n. Vale la pena notar la diferencia entre esto y la compartici贸n de datos a trav茅s de `UIActivity`, donde tuvimos que definir los tipos de documentos, tambi茅n utilizando UTIs. Una aplicaci贸n no necesita tener una extensi贸n para eso. Es posible compartir datos utilizando solamente `UIActivity`.

Inspecciona el archivo `Info.plist` de la extensi贸n de la aplicaci贸n y busca `NSExtensionActivationRule`. Esa clave especifica los datos que se soportan as铆 como, por ejemplo, el m谩ximo de elementos soportados. Por ejemplo:
```markup
<key>NSExtensionAttributes</key>
<dict>
<key>NSExtensionActivationRule</key>
<dict>
<key>NSExtensionActivationSupportsImageWithMaxCount</key>
<integer>10</integer>
<key>NSExtensionActivationSupportsMovieWithMaxCount</key>
<integer>1</integer>
<key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
<integer>1</integer>
</dict>
</dict>
```
Solo los tipos de datos presentes aqu铆 y que no tengan `0` como `MaxCount` ser谩n compatibles. Sin embargo, es posible realizar un filtrado m谩s complejo utilizando una cadena de predicados que evaluar谩 los UTIs dados. Consulte la [Gu铆a de Programaci贸n de Extensiones de Aplicaciones de Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW8) para obtener informaci贸n m谩s detallada sobre esto.

**Verificaci贸n de Compartici贸n de Datos con la Aplicaci贸n Contenedora**

Recuerde que las extensiones de aplicaciones y sus aplicaciones contenedoras no tienen acceso directo a los contenedores de cada uno. Sin embargo, se puede habilitar la compartici贸n de datos. Esto se hace a trav茅s de ["App Groups"](https://developer.apple.com/library/archive/documentation/Miscellaneous/Reference/EntitlementKeyReference/Chapters/EnablingAppSandbox.html#//apple_ref/doc/uid/TP40011195-CH4-SW19) y la API [`NSUserDefaults`](https://developer.apple.com/documentation/foundation/nsuserdefaults). Vea esta figura de la [Gu铆a de Programaci贸n de Extensiones de Aplicaciones de Apple](https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW11):

![](../../mobile-apps-pentesting/ios-pentesting/broken-reference)

Como tambi茅n se menciona en la gu铆a, la aplicaci贸n debe configurar un contenedor compartido si la extensi贸n de la aplicaci贸n utiliza la clase `NSURLSession` para realizar una carga o descarga en segundo plano, de modo que tanto la extensi贸n como su aplicaci贸n contenedora puedan acceder a los datos transferidos.

**Verificaci贸n de si la Aplicaci贸n Restringe el Uso de Extensiones de Aplicaciones**

Es posible rechazar un tipo espec铆fico de extensi贸n de aplicaci贸n utilizando el siguiente m茅todo:

* [`application:shouldAllowExtensionPointIdentifier:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623122-application?language=objc)

Sin embargo, actualmente solo es posible para extensiones de aplicaciones de "teclado personalizado" (y debe verificarse al probar aplicaciones que manejan datos sensibles a trav茅s del teclado como, por ejemplo, aplicaciones bancarias).

### An谩lisis Din谩mico

Para el an谩lisis din谩mico podemos hacer lo siguiente para obtener conocimiento sin tener el c贸digo fuente:

* Inspeccionar los elementos que se est谩n compartiendo
* Identificar las extensiones de aplicaciones involucradas

**Inspeccionar los Elementos que se Est谩n Compartiendo**

Para esto deber铆amos enganchar `NSExtensionContext - inputItems` en la aplicaci贸n de origen de los datos.

Siguiendo el ejemplo anterior de Telegram, ahora usaremos el bot贸n "Compartir" en un archivo de texto (que se recibi贸 de un chat) para crear una nota en la aplicaci贸n de Notas con 茅l:

![](<../../.gitbook/assets/image (497).png>)

Si ejecutamos un rastreo, ver铆amos la siguiente salida:
```bash
(0x1c06bb420) NSExtensionContext - inputItems
0x18284355c Foundation!-[NSExtension _itemProviderForPayload:extensionContext:]
0x1828447a4 Foundation!-[NSExtension _loadItemForPayload:contextIdentifier:completionHandler:]
0x182973224 Foundation!__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S3__
0x182971968 Foundation!-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:]
0x182748830 Foundation!message_handler
0x181ac27d0 libxpc.dylib!_xpc_connection_call_event_handler
0x181ac0168 libxpc.dylib!_xpc_connection_mach_event
...
RET: (
"<NSExtensionItem: 0x1c420a540> - userInfo:
{
NSExtensionItemAttachmentsKey =     (
"<NSItemProvider: 0x1c46b30e0> {types = (\n \"public.plain-text\",\n \"public.file-url\"\n)}"
);
}"
)
```
Aqu铆 podemos observar que:

* Esto ocurri贸 bajo el cap贸 a trav茅s de XPC, concretamente se implementa mediante una `NSXPCConnection` que utiliza el Framework `libxpc.dylib`.
* Los UTIs incluidos en el `NSItemProvider` son `public.plain-text` y `public.file-url`, este 煤ltimo incluido en `NSExtensionActivationRule` del [`Info.plist` de la "Share Extension" de Telegram](https://github.com/TelegramMessenger/Telegram-iOS/blob/master/Telegram/Share/Info.plist).

**Identificando las App Extensions Involucradas**

Tambi茅n puedes averiguar qu茅 app extension se est谩 encargando de tus solicitudes y respuestas al interceptar `NSExtension - _plugIn`:

Ejecutamos el mismo ejemplo de nuevo:
```bash
(0x1c0370200) NSExtension - _plugIn
RET: <PKPlugin: 0x1163637f0 ph.telegra.Telegraph.Share(5.3) 5B6DE177-F09B-47DA-90CD-34D73121C785
1(2) /private/var/containers/Bundle/Application/15E6A58F-1CA7-44A4-A9E0-6CA85B65FA35
/Telegram X.app/PlugIns/Share.appex>

(0x1c0372300)  -[NSExtension _plugIn]
RET: <PKPlugin: 0x10bff7910 com.apple.mobilenotes.SharingExtension(1.5) 73E4F137-5184-4459-A70A-83
F90A1414DC 1(2) /private/var/containers/Bundle/Application/5E267B56-F104-41D0-835B-F1DAB9AE076D
/MobileNotes.app/PlugIns/com.apple.mobilenotes.SharingExtension.appex>
```
Como puedes ver, hay dos extensiones de aplicaci贸n involucradas:

* `Share.appex` est谩 enviando el archivo de texto (`public.plain-text` y `public.file-url`).
* `com.apple.mobilenotes.SharingExtension.appex` que est谩 recibiendo y procesar谩 el archivo de texto.

Si quieres aprender m谩s sobre lo que est谩 sucediendo bajo el cap贸 en t茅rminos de XPC, recomendamos echar un vistazo a las llamadas internas de "libxpc.dylib". Por ejemplo, puedes usar [`frida-trace`](https://www.frida.re/docs/frida-trace/) y luego profundizar en los m茅todos que encuentres m谩s interesantes extendiendo los stubs generados autom谩ticamente.

###

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆gueme** en **Twitter**  [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
