# Enlaces Universales de iOS

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Introducci贸n

Los enlaces universales ofrecen una experiencia de **redirecci贸n sin problemas** a los usuarios al abrir directamente el contenido en la aplicaci贸n, evitando la necesidad de redirecci贸n a Safari. Estos enlaces son **煤nicos** y seguros, ya que no pueden ser reclamados por otras aplicaciones. Esto se asegura alojando un archivo JSON `apple-app-site-association` en el directorio ra铆z del sitio web, estableciendo un enlace verificable entre el sitio web y la aplicaci贸n. En casos en los que la aplicaci贸n no est茅 instalada, Safari tomar谩 el control y dirigir谩 al usuario a la p谩gina web, manteniendo la presencia de la aplicaci贸n.

Para los probadores de penetraci贸n, el archivo `apple-app-site-association` es de particular inter茅s, ya que puede revelar **rutas sensibles**, potencialmente incluyendo aquellas relacionadas con funciones no lanzadas.

### **An谩lisis de la Concesi贸n de Dominios Asociados**

Los desarrolladores habilitan los Enlaces Universales configurando los **Dominios Asociados** en la pesta帽a de Capacidades de Xcode o inspeccionando el archivo `.entitlements`. Cada dominio se prefija con `applinks:`. Por ejemplo, la configuraci贸n de Telegram podr铆a aparecer de la siguiente manera:
```xml
<key>com.apple.developer.associated-domains</key>
<array>
<string>applinks:telegram.me</string>
<string>applinks:t.me</string>
</array>
```
Para obtener informaci贸n m谩s detallada, consulta la [Documentaci贸n de Desarrolladores de Apple archivada](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW2).

Si est谩s trabajando con una aplicaci贸n compilada, los permisos pueden extraerse seg煤n se describe en [esta gu铆a](extracting-entitlements-from-compiled-application.md).

### **Obtenci贸n del Archivo de Asociaci贸n de Sitio de la App de Apple**

El archivo `apple-app-site-association` debe obtenerse del servidor utilizando los dominios especificados en los permisos. Aseg煤rate de que el archivo sea accesible a trav茅s de HTTPS directamente en `https://<dominio>/apple-app-site-association`. Herramientas como el [Validador de Asociaci贸n de Sitio de la App de Apple (AASA)](https://branch.io/resources/aasa-validator/) pueden ayudar en este proceso.

### **Manejo de Enlaces Universales en la App**

La app debe implementar m茅todos espec铆ficos para manejar correctamente los enlaces universales. El m茅todo principal a buscar es [`application:continueUserActivity:restorationHandler:`](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623072-application). Es crucial que el esquema de las URL manejadas sea HTTP o HTTPS, ya que otros no ser谩n compatibles.

#### **Validaci贸n del M茅todo de Manejo de Datos**

Cuando un enlace universal abre una app, se pasa a la app un objeto `NSUserActivity` con la URL. Antes de procesar esta URL, es esencial validarla y sanearla para prevenir riesgos de seguridad. Aqu铆 tienes un ejemplo en Swift que muestra el proceso:
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity,
restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
// Check for web browsing activity and valid URL
if userActivity.activityType == NSUserActivityTypeBrowsingWeb, let url = userActivity.webpageURL {
application.open(url, options: [:], completionHandler: nil)
}

return true
}
```
Las URL deben ser analizadas y validadas cuidadosamente, especialmente si incluyen par谩metros, para protegerse contra posibles suplantaciones de identidad o datos malformados. La API `NSURLComponents` es 煤til para este prop贸sito, como se muestra a continuaci贸n:
```swift
func application(_ application: UIApplication,
continue userActivity: NSUserActivity,
restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
guard userActivity.activityType == NSUserActivityTypeBrowsingWeb,
let incomingURL = userActivity.webpageURL,
let components = NSURLComponents(url: incomingURL, resolvingAgainstBaseURL: true),
let path = components.path,
let params = components.queryItems else {
return false
}

if let albumName = params.first(where: { $0.name == "albumname" })?.value,
let photoIndex = params.first(where: { $0.name == "index" })?.value {
// Process the URL with album name and photo index

return true

} else {
// Handle invalid or missing parameters

return false
}
}
```
A trav茅s de una **configuraci贸n y validaci贸n diligentes**, los desarrolladores pueden asegurar que los enlaces universales mejoren la experiencia del usuario manteniendo los est谩ndares de seguridad y privacidad.

## Referencias
* [https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis](https://mas.owasp.org/MASTG/tests/ios/MASVS-PLATFORM/MASTG-TEST-0070/#static-analysis)
* [https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8](https://mobile-security.gitbook.io/mobile-security-testing-guide/ios-testing-guide/0x06h-testing-platform-interaction#testing-object-persistence-mstg-platform-8)

<details>
<summary><strong>Aprende hacking de AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).
</details>
