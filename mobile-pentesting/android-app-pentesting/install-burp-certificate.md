# Instalar Certificado Burp

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## En una M谩quina Virtual

En primer lugar, necesitas descargar el certificado Der desde Burp. Puedes hacer esto en _**Proxy**_ --> _**Options**_ --> _**Import / Export CA certificate**_

![](<../../.gitbook/assets/image (367).png>)

**Exporta el certificado en formato Der** y vamos a **transformarlo** a una forma que **Android** pueda **entender.** Ten en cuenta que **para configurar el certificado de burp en la m谩quina Android en AVD** necesitas **ejecutar** esta m谩quina **con** la opci贸n **`-writable-system`**.\
Por ejemplo, puedes ejecutarlo as铆:

{% code overflow="wrap" %}
```bash
C:\Users\<UserName>\AppData\Local\Android\Sdk\tools\emulator.exe -avd "AVD9" -http-proxy 192.168.1.12:8080 -writable-system
```
{% endcode %}

Luego, para **configurar el certificado de burp**, haz lo siguiente:

{% code overflow="wrap" %}
```bash
openssl x509 -inform DER -in burp_cacert.der -out burp_cacert.pem
CERTHASHNAME="`openssl x509 -inform PEM -subject_hash_old -in burp_cacert.pem | head -1`.0"
mv burp_cacert.pem $CERTHASHNAME #Correct name
adb root && sleep 2 && adb remount #Allow to write on /syste
adb push $CERTHASHNAME /sdcard/ #Upload certificate
adb shell mv /sdcard/$CERTHASHNAME /system/etc/security/cacerts/ #Move to correct location
adb shell chmod 644 /system/etc/security/cacerts/$CERTHASHNAME #Assign privileges
adb reboot #Now, reboot the machine
```
{% endcode %}

Una vez que la **m谩quina haya terminado de reiniciarse**, 隆el certificado de Burp estar谩 en uso por ella!

## Usando Magisc

Si **rooteaste tu dispositivo con Magisc** (quiz谩s un emulador), y no puedes seguir los **pasos anteriores** para instalar el certificado de Burp porque el **sistema de archivos es de solo lectura** y no puedes volverlo escribible, hay otra forma.

Explicado en [**este video**](https://www.youtube.com/watch?v=qQicUW0svB8) necesitas:

1. **Instalar un certificado de CA**: Simplemente **arrastra y suelta** el certificado DER de Burp **cambiando la extensi贸n** a `.crt` en el m贸vil para que se guarde en la carpeta de Descargas y ve a `Instalar un certificado` -> `Certificado de CA`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="164"><figcaption></figcaption></figure>

* Verifica que el certificado se haya guardado correctamente yendo a `Credenciales de confianza` -> `USUARIO`

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="334"><figcaption></figcaption></figure>

2. **Hacerlo de confianza del sistema**: Descarga el m贸dulo de Magisc [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts) (un archivo .zip), **arr谩stralo y su茅ltalo** en el tel茅fono, ve a la aplicaci贸n de Magisc en el tel茅fono a la secci贸n **`M贸dulos`**, haz clic en **`Instalar desde almacenamiento`**, selecciona el m贸dulo `.zip` y una vez instalado **reinicia** el tel茅fono:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" width="345"><figcaption></figcaption></figure>

* Despu茅s de reiniciar, ve a `Credenciales de confianza` -> `SISTEMA` y verifica que el certificado de Postswigger est茅 all铆

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt="" width="314"><figcaption></figcaption></figure>

## Post Android 14

En la 煤ltima versi贸n de Android 14, se ha observado un cambio significativo en el manejo de los certificados de Autoridad de Certificaci贸n (CA) de confianza del sistema. Anteriormente, estos certificados se encontraban en **`/system/etc/security/cacerts/`**, accesibles y modificables por usuarios con privilegios de root, lo que permit铆a su aplicaci贸n inmediata en todo el sistema. Sin embargo, con Android 14, la ubicaci贸n de almacenamiento se ha trasladado a **`/apex/com.android.conscrypt/cacerts`**, un directorio dentro de la ruta **`/apex`**, que es inmutable por naturaleza.

Los intentos de volver a montar la ruta de **cacerts de APEX** como escribible fracasan, ya que el sistema no permite tales operaciones. Incluso los intentos de desmontar o superponer el directorio con un sistema de archivos temporal (tmpfs) no evitan la inmutabilidad; las aplicaciones siguen accediendo a los datos de certificados originales independientemente de los cambios a nivel de sistema de archivos. Esta resistencia se debe a que el montaje de **`/apex`** est谩 configurado con propagaci贸n PRIVADA, asegurando que cualquier modificaci贸n dentro del directorio de **`/apex`** no afecte a otros procesos.

La inicializaci贸n de Android implica el proceso `init`, que, al iniciar el sistema operativo, tambi茅n inicia el proceso Zygote. Este proceso es responsable de lanzar procesos de aplicaci贸n con un nuevo espacio de nombres de montaje que incluye un montaje privado de **`/apex`**, aislando as铆 los cambios en este directorio de otros procesos.

Sin embargo, existe un m茅todo alternativo para aquellos que necesitan modificar los certificados de CA de confianza del sistema dentro del directorio de **`/apex`**. Esto implica volver a montar manualmente **`/apex`** para eliminar la propagaci贸n PRIVADA, haci茅ndolo as铆 escribible. El proceso incluye copiar el contenido de **`/apex/com.android.conscrypt`** a otra ubicaci贸n, desmontar el directorio **`/apex/com.android.conscrypt`** para eliminar la restricci贸n de solo lectura, y luego restaurar el contenido a su ubicaci贸n original dentro de **`/apex`**. Este enfoque requiere una acci贸n r谩pida para evitar bloqueos del sistema. Para garantizar la aplicaci贸n de estos cambios en todo el sistema, se recomienda reiniciar el `system_server`, lo que reinicia efectivamente todas las aplicaciones y lleva el sistema a un estado consistente.
```bash
# Create a separate temp directory, to hold the current certificates
# Otherwise, when we add the mount we can't read the current certs anymore.
mkdir -p -m 700 /data/local/tmp/tmp-ca-copy

# Copy out the existing certificates
cp /apex/com.android.conscrypt/cacerts/* /data/local/tmp/tmp-ca-copy/

# Create the in-memory mount on top of the system certs folder
mount -t tmpfs tmpfs /system/etc/security/cacerts

# Copy the existing certs back into the tmpfs, so we keep trusting them
mv /data/local/tmp/tmp-ca-copy/* /system/etc/security/cacerts/

# Copy our new cert in, so we trust that too
mv $CERTIFICATE_PATH /system/etc/security/cacerts/

# Update the perms & selinux context labels
chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*

# Deal with the APEX overrides, which need injecting into each namespace:

# First we get the Zygote process(es), which launch each app
ZYGOTE_PID=$(pidof zygote || true)
ZYGOTE64_PID=$(pidof zygote64 || true)
# N.b. some devices appear to have both!

# Apps inherit the Zygote's mounts at startup, so we inject here to ensure
# all newly started apps will see these certs straight away:
for Z_PID in "$ZYGOTE_PID" "$ZYGOTE64_PID"; do
if [ -n "$Z_PID" ]; then
nsenter --mount=/proc/$Z_PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
fi
done

# Then we inject the mount into all already running apps, so they
# too see these CA certs immediately:

# Get the PID of every process whose parent is one of the Zygotes:
APP_PIDS=$(
echo "$ZYGOTE_PID $ZYGOTE64_PID" | \
xargs -n1 ps -o 'PID' -P | \
grep -v PID
)

# Inject into the mount namespace of each of those apps:
for PID in $APP_PIDS; do
nsenter --mount=/proc/$PID/ns/mnt -- \
/bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts &
done
wait # Launched in parallel - wait for completion here

echo "System certificate injected"
```
### Montaje de enlace a trav茅s de NSEnter

1. **Configuraci贸n de un directorio escribible**: Inicialmente, se establece un directorio escribible montando un `tmpfs` sobre el directorio existente de certificados del sistema no APEX. Esto se logra con el siguiente comando:
```bash
mount -t tmpfs tmpfs /system/etc/security/cacerts
```
2. **Preparando Certificados de CA**: Despu茅s de configurar el directorio escribible, los certificados de CA que se pretenden utilizar deben ser copiados en este directorio. Esto puede implicar copiar los certificados predeterminados desde `/apex/com.android.conscrypt/cacerts/`. Es esencial ajustar los permisos y las etiquetas SELinux de estos certificados en consecuencia.
3. **Montaje de Enlace para Zygote**: Utilizando `nsenter`, se ingresa al espacio de montaje de Zygote. Zygote, siendo el proceso responsable de lanzar aplicaciones de Android, requiere este paso para asegurar que todas las aplicaciones iniciadas en adelante utilicen los certificados de CA reci茅n configurados. El comando utilizado es:
```bash
nsenter --mount=/proc/$ZYGOTE_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
Esto asegura que cada nueva aplicaci贸n iniciada se adhiera a la configuraci贸n actualizada de los certificados de la CA.

4. **Aplicar Cambios a las Aplicaciones en Ejecuci贸n**: Para aplicar los cambios a las aplicaciones que ya est谩n en ejecuci贸n, se utiliza nuevamente `nsenter` para ingresar individualmente al espacio de nombres de cada aplicaci贸n y realizar un montaje de enlace similar. El comando necesario es:
```bash
nsenter --mount=/proc/$APP_PID/ns/mnt -- /bin/mount --bind /system/etc/security/cacerts /apex/com.android.conscrypt/cacerts
```
5. **Enfoque Alternativo - Reinicio Suave**: Un m茅todo alternativo implica realizar el montaje de enlace en el proceso `init` (PID 1) seguido de un reinicio suave del sistema operativo con los comandos `stop && start`. Este enfoque propagar铆a los cambios a trav茅s de todos los espacios de nombres, evitando la necesidad de abordar individualmente cada aplicaci贸n en ejecuci贸n. Sin embargo, este m茅todo generalmente es menos preferido debido a la incomodidad de reiniciar.

## Referencias

* [https://httptoolkit.com/blog/android-14-install-system-ca-certificate/](https://httptoolkit.com/blog/android-14-install-system-ca-certificate/)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
