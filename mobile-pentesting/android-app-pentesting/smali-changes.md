# Smali - DescompilaciÃ³n/\[ModificaciÃ³n]/CompilaciÃ³n

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

A veces es interesante modificar el cÃ³digo de la aplicaciÃ³n para acceder a informaciÃ³n oculta para ti (quizÃ¡s contraseÃ±as bien ofuscadas o banderas). Luego, podrÃ­a ser interesante descompilar el apk, modificar el cÃ³digo y volver a compilarlo.

**Referencia de opcodes:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Forma rÃ¡pida

Usando **Visual Studio Code** y la extensiÃ³n [APKLab](https://github.com/APKLab/APKLab), puedes **descompilar**, modificar, **compilar**, firmar e instalar automÃ¡ticamente la aplicaciÃ³n sin ejecutar ningÃºn comando.

Otro **script** que facilita mucho esta tarea es [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)****

## Descompilar el APK

Usando APKTool puedes acceder al **cÃ³digo smali y los recursos**:
```
apktool d APP.apk
```
Si **apktool** te da algÃºn error, intenta [instalar la **Ãºltima versiÃ³n**](https://ibotpeaches.github.io/Apktool/install/)

Algunos **archivos interesantes que debes buscar son**:

* _res/values/strings.xml_ (y todos los xml dentro de res/values/\*)
* _AndroidManifest.xml_
* Cualquier archivo con extensiÃ³n _.sqlite_ o _.db_

Si `apktool` tiene **problemas al decodificar la aplicaciÃ³n**, echa un vistazo a [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) o intenta usar el argumento **`-r`** (No decodificar recursos). Entonces, si el problema estaba en un recurso y no en el cÃ³digo fuente, no tendrÃ¡s el problema (tampoco descompilarÃ¡s los recursos).

## Cambiar el cÃ³digo Smali

Puedes **cambiar** **instrucciones**, cambiar el **valor** de algunas variables o **agregar** nuevas instrucciones. Cambio el cÃ³digo Smali usando [**VS Code**](https://code.visualstudio.com), luego instalas la **extensiÃ³n smalise** y el editor te dirÃ¡ si alguna **instrucciÃ³n es incorrecta**.\
Algunos **ejemplos** se pueden encontrar aquÃ­:

* [Ejemplos de cambios en Smali](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

O puedes [**ver a continuaciÃ³n algunos cambios en Smali explicados**](smali-changes.md#modifying-smali).

## Recompilar el APK

DespuÃ©s de modificar el cÃ³digo, puedes **recompilar** el cÃ³digo usando:
```bash
apktool b . #In the folder generated when you decompiled the application
```
CompilarÃ¡ el nuevo APK dentro de la carpeta _**dist**_.

Si **apktool** muestra un **error**, intenta [instalar la **Ãºltima versiÃ³n**](https://ibotpeaches.github.io/Apktool/install/)

### **Firmar el nuevo APK**

Luego, necesitarÃ¡s **generar una clave** (se te pedirÃ¡ una contraseÃ±a y alguna informaciÃ³n que puedes completar al azar):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Finalmente, **firma** el nuevo APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Optimizar nueva aplicaciÃ³n

**zipalign** es una herramienta de alineaciÃ³n de archivos que proporciona optimizaciones importantes a los archivos de aplicaciÃ³n de Android (APK). [MÃ¡s informaciÃ³n aquÃ­](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Firmar el nuevo APK (Â¿de nuevo?)**

Si **prefieres** usar \[**apksigner**]\([**https://developer.android.com/studio/command-line/apksigner**](https://developer.android.com/studio/command-line/apksigner))\*\* en lugar de jarsigner, **debes firmar el apk** despuÃ©s de aplicar **la optimizaciÃ³n con** zipaling\*\*. PERO TEN EN CUENTA QUE\*\* SOLO DEBES FIRMAR LA APLICACIÃ“N UNA VEZ\*\* CON jarsigner (antes de zipalign) O CON aspsigner (despuÃ©s de zipaling).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Modificando Smali

Para el siguiente cÃ³digo Java de Hello World:
```
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
El cÃ³digo Smali serÃ­a:
```
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
El conjunto de instrucciones Smali estÃ¡ disponible [aquÃ­](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### Cambios ligeros

### Modificar los valores iniciales de una variable dentro de una funciÃ³n

Algunas variables se definen al comienzo de la funciÃ³n utilizando el opcode _const_, puedes modificar sus valores o definir nuevas variables:
```
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### Operaciones bÃ¡sicas

#### Cambios en el cÃ³digo Smali

El cÃ³digo Smali es el lenguaje ensamblador utilizado en las aplicaciones de Android. Al realizar pruebas de penetraciÃ³n en aplicaciones Android, es posible que necesite realizar cambios en el cÃ³digo Smali para lograr ciertos objetivos. A continuaciÃ³n se presentan algunas operaciones bÃ¡sicas que puede realizar en el cÃ³digo Smali:

- **Modificar valores constantes**: Puede cambiar los valores constantes utilizados en el cÃ³digo Smali para alterar el comportamiento de la aplicaciÃ³n. Esto puede incluir cambiar valores numÃ©ricos, cadenas de texto o cualquier otro tipo de constante utilizada en el cÃ³digo.

- **Modificar llamadas a mÃ©todos**: Puede modificar las llamadas a mÃ©todos en el cÃ³digo Smali para redirigir el flujo de ejecuciÃ³n de la aplicaciÃ³n. Esto puede ser Ãºtil para realizar pruebas de penetraciÃ³n, como interceptar llamadas a mÃ©todos sensibles o modificar el comportamiento de la aplicaciÃ³n.

- **Agregar nuevas instrucciones**: Puede agregar nuevas instrucciones al cÃ³digo Smali para agregar funcionalidad adicional a la aplicaciÃ³n. Esto puede incluir la adiciÃ³n de nuevas funciones, la manipulaciÃ³n de datos o cualquier otra operaciÃ³n que desee realizar en el cÃ³digo.

- **Eliminar instrucciones**: Puede eliminar instrucciones del cÃ³digo Smali para eliminar funcionalidad no deseada de la aplicaciÃ³n. Esto puede ser Ãºtil para desactivar caracterÃ­sticas no deseadas o eliminar cÃ³digo malicioso.

Al realizar cambios en el cÃ³digo Smali, es importante tener en cuenta la estructura y la sintaxis del cÃ³digo para evitar errores y asegurarse de que los cambios se realicen correctamente.
```
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### Cambios importantes

### Registro
```
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recomendaciones:

* Si vas a utilizar variables declaradas dentro de la funciÃ³n (declaradas v0,v1,v2...), coloca estas lÃ­neas entre _.local \<nÃºmero>_ y las declaraciones de las variables (_const v0, 0x1_)
* Si deseas colocar el cÃ³digo de registro en medio del cÃ³digo de una funciÃ³n:
* AÃ±ade 2 al nÃºmero de variables declaradas: Ej: de _.locals 10_ a _.locals 12_
* Las nuevas variables deben ser los siguientes nÃºmeros de las variables ya declaradas (en este ejemplo deberÃ­an ser _v10_ y _v11_, recuerda que comienza en v0).
* Cambia el cÃ³digo de la funciÃ³n de registro y utiliza _v10_ y _v11_ en lugar de _v5_ y _v1_.

### Toasting

Recuerda aÃ±adir 3 al nÃºmero de _.locals_ al comienzo de la funciÃ³n.

Este cÃ³digo estÃ¡ preparado para ser insertado en el **medio de una funciÃ³n** (**cambia** el nÃºmero de las **variables** segÃºn sea necesario). TomarÃ¡ el **valor de this.o**, lo **transformarÃ¡** a **String** y luego **harÃ¡** un **toast** con su valor.
```
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* ObtÃ©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
