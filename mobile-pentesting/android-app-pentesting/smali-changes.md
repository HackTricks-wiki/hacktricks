# Smali - Decompiling/\[Modifying]/Compiling

<details>

<summary><strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ã§å­¦ã¶ï¼</strong></summary>

HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricks ã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯ **HackTricks ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã¾ãŸã¯[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„ã€‚
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€**[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦éš ã•ã‚ŒãŸæƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒèˆˆå‘³æ·±ã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆãŠãã‚‰ãã‚ˆãé›£èª­åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ•ãƒ©ã‚°ï¼‰ã€‚ãã®å¾Œã€APKã‚’é€†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã€å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã“ã¨ãŒèˆˆå‘³æ·±ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

**ã‚ªãƒšã‚³ãƒ¼ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## æ—©ã„æ–¹æ³•

**Visual Studio Code**ã¨[APKLab](https://github.com/APKLab/APKLab)æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**è‡ªå‹•çš„ã«é€†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã€å¤‰æ›´ã€**å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç½²åã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œã›ãšã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å¤§å¹…ã«ç°¡ç•¥åŒ–ã™ã‚‹**ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚‚ã†ä¸€ã¤ã¯[**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)ã§ã™ã€‚

## APKã‚’é€†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹

APKToolã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**smaliã‚³ãƒ¼ãƒ‰ã¨ãƒªã‚½ãƒ¼ã‚¹**ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ï¼š
```bash
apktool d APP.apk
```
If **apktool** gives you any error, try [installing the **latest version**](https://ibotpeaches.github.io/Apktool/install/)

Some **interesting files you should look are**:

* _res/values/strings.xml_ (and all xmls inside res/values/\*)
* _AndroidManifest.xml_
* Any file with extension _.sqlite_ or _.db_

If `apktool` has **problems decoding the application** take a look to [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) or try using the argument **`-r`** (Do not decode resources). Then, if the problem was in a resource and not in the source code, you won't have the problem (you won't also decompile the resources).

## Change smali code

You can **change** **instructions**, change the **value** of some variables or **add** new instructions. I change the Smali code using [**VS Code**](https://code.visualstudio.com), you then install the **smalise extension** and the editor will tell you if any **instruction is incorrect**.\
Some **examples** can be found here:

* [Smali changes examples](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Or you can [**check below some Smali changes explained**](smali-changes.md#modifying-smali).

## Recompile the APK

After modifying the code you can **recompile** the code using:
```bash
apktool b . #In the folder generated when you decompiled the application
```
ãã‚Œã¯**dist**ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ä¸­ã«æ–°ã—ã„APKã‚’**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã—ã¾ã™ã€‚

ã‚‚ã—**apktool**ãŒ**ã‚¨ãƒ©ãƒ¼**ã‚’å‡ºã—ãŸã‚‰ã€[**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«](https://ibotpeaches.github.io/Apktool/install/)ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### **æ–°ã—ã„APKã«ç½²åã™ã‚‹**

ãã®å¾Œã€**ã‚­ãƒ¼ã‚’ç”Ÿæˆ**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥åŠ›ã§ãã‚‹æƒ…å ±ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ï¼‰:
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
æœ€å¾Œã«ã€æ–°ã—ã„APKã«**ç½²å**ã‚’ä»˜ã‘ã¾ã™:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ–

**zipalign**ã¯ã€Androidã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆAPKï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã«é‡è¦ãªæœ€é©åŒ–ã‚’æä¾›ã™ã‚‹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ•´åˆ—ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚[ã“ã¡ã‚‰ã§è©³ç´°ã‚’ç¢ºèª](https://developer.android.com/studio/command-line/zipalign)ã€‚
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **æ–°ã—ã„APKã«ç½²åã™ã‚‹ï¼ˆå†ã³ï¼Ÿï¼‰**

ã‚‚ã—jarsignerã®ä»£ã‚ã‚Šã«[**apksigner**](https://developer.android.com/studio/command-line/)ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€zipalignã‚’é©ç”¨ã—ãŸå¾Œã«apkã«ç½²åã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã—ã€jarsignerï¼ˆzipalignã®å‰ï¼‰ã¾ãŸã¯aspsignerï¼ˆzipalignã®å¾Œï¼‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ç½²åã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯**1å›ã ã‘**ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
## Smaliã®å¤‰æ›´

æ¬¡ã®Hello World Javaã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦:
```java
public static void printHelloWorld() {
System.out.println("Hello World")
}
```
Smaliã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š
```java
.method public static printHelloWorld()V
.registers 2
sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
const-string v1, "Hello World"
invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
return-void
.end method
```
### è»½å¾®ãªå¤‰æ›´

### é–¢æ•°å†…ã®å¤‰æ•°ã®åˆæœŸå€¤ã‚’å¤‰æ›´ã™ã‚‹

ä¸€éƒ¨ã®å¤‰æ•°ã¯ã€é–¢æ•°ã®å†’é ­ã§ _const_ ã‚ªãƒšã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å€¤ã‚’å¤‰æ›´ã—ãŸã‚Šã€æ–°ã—ã„ã‚‚ã®ã‚’å®šç¾©ã—ãŸã‚Šã§ãã¾ã™:
```bash
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### åŸºæœ¬çš„ãªæ“ä½œ
```bash
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### å¤§ããªå¤‰æ›´

### ãƒ­ã‚®ãƒ³ã‚°
```bash
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
Recommendations:

* If you are going to use declared variables inside the function (declared v0,v1,v2...) put these lines between the _.local \<number>_ and the declarations of the variables (_const v0, 0x1_)
* If you want to put the logging code in the middle of the code of a function:
  * Add 2 to the number of declared variables: Ex: from _.locals 10_ to _.locals 12_
  * The new variables should be the next numbers of the already declared variables (in this example should be _v10_ and _v11_, remember that it starts in v0).
  * Change the code of the logging function and use _v10_ and _v11_ instead of _v5_ and _v1_.

### Toasting

Remember to add 3 to the number of _.locals_ at the beginning of the function.

This code is prepared to be inserted in the **middle of a function** (**change** the number of the **variables** as necessary). It will take the **value of this.o**, **transform** it to **String** and them **make** a **toast** with its value.
```bash
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong>ã‚’ä½¿ç”¨ã—ã¦ã€<strong>ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶</strong>ï¼</summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã€ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€PRã‚’** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ãŠã‚ˆã³** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
