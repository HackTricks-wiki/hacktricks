# Smali - Decompilando/\[Modificando]/Compilando

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Ã€s vezes, Ã© interessante modificar o cÃ³digo do aplicativo para acessar informaÃ§Ãµes ocultas para vocÃª (talvez senhas bem ofuscadas ou flags). EntÃ£o, pode ser interessante descompilar o apk, modificar o cÃ³digo e recompilÃ¡-lo.

**ReferÃªncia de opcodes:** [http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html](http://pallergabor.uw.hu/androidblog/dalvik\_opcodes.html)

## Forma rÃ¡pida

Usando o **Visual Studio Code** e a extensÃ£o [APKLab](https://github.com/APKLab/APKLab), vocÃª pode **descompilar**, modificar, **recompilar**, assinar e instalar o aplicativo automaticamente sem executar nenhum comando.

Outro **script** que facilita muito essa tarefa Ã© [**https://github.com/ax/apk.sh**](https://github.com/ax/apk.sh)****

## Descompilar o APK

Usando o APKTool, vocÃª pode acessar o **cÃ³digo smali e recursos**:
```
apktool d APP.apk
```
Se o **apktool** apresentar algum erro, tente [instalar a **versÃ£o mais recente**](https://ibotpeaches.github.io/Apktool/install/).

Alguns **arquivos interessantes que vocÃª deve procurar sÃ£o**:

* _res/values/strings.xml_ (e todos os xmls dentro de res/values/\*)
* _AndroidManifest.xml_
* Qualquer arquivo com extensÃ£o _.sqlite_ ou _.db_

Se o `apktool` tiver **problemas para decodificar o aplicativo**, dÃª uma olhada em [https://ibotpeaches.github.io/Apktool/documentation/#framework-files](https://ibotpeaches.github.io/Apktool/documentation/#framework-files) ou tente usar o argumento **`-r`** (NÃ£o decodificar recursos). EntÃ£o, se o problema estiver em um recurso e nÃ£o no cÃ³digo-fonte, vocÃª nÃ£o terÃ¡ o problema (tambÃ©m nÃ£o descompilarÃ¡ os recursos).

## Alterar o cÃ³digo Smali

VocÃª pode **alterar** **instruÃ§Ãµes**, alterar o **valor** de algumas variÃ¡veis ou **adicionar** novas instruÃ§Ãµes. Eu altero o cÃ³digo Smali usando o [**VS Code**](https://code.visualstudio.com), entÃ£o vocÃª instala a **extensÃ£o smalise** e o editor informarÃ¡ se alguma **instruÃ§Ã£o estiver incorreta**.\
Alguns **exemplos** podem ser encontrados aqui:

* [Exemplos de alteraÃ§Ãµes do Smali](smali-changes.md)
* [Google CTF 2018 - Shall We Play a Game?](google-ctf-2018-shall-we-play-a-game.md)

Ou vocÃª pode [**ver abaixo algumas alteraÃ§Ãµes do Smali explicadas**](smali-changes.md#modifying-smali).

## Recompilar o APK

Depois de modificar o cÃ³digo, vocÃª pode **recompilar** o cÃ³digo usando:
```bash
apktool b . #In the folder generated when you decompiled the application
```
Ele irÃ¡ **compilar** o novo APK **dentro** da pasta _**dist**_.

Se o **apktool** apresentar um **erro**, tente [instalar a **versÃ£o mais recente**](https://ibotpeaches.github.io/Apktool/install/).

### **Assinar o novo APK**

Em seguida, vocÃª precisa **gerar uma chave** (serÃ¡ solicitada uma senha e algumas informaÃ§Ãµes que vocÃª pode preencher aleatoriamente):
```bash
keytool -genkey -v -keystore key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias <your-alias>
```
Finalmente, **assinem** o novo APK:
```bash
jarsigner -keystore key.jks path/to/dist/* <your-alias>
```
### Otimizar nova aplicaÃ§Ã£o

**zipalign** Ã© uma ferramenta de alinhamento de arquivos que fornece uma otimizaÃ§Ã£o importante para arquivos de aplicativos Android (APK). [Mais informaÃ§Ãµes aqui](https://developer.android.com/studio/command-line/zipalign).
```bash
zipalign [-f] [-v] <alignment> infile.apk outfile.apk
zipalign -v 4 infile.apk
```
### **Assinar o novo APK (novamente?)**

Se vocÃª **preferir** usar o \[**apksigner**]\([**https://developer.android.com/studio/command-line/apksigner**](https://developer.android.com/studio/command-line/apksigner))\*\* em vez do jarsigner, **vocÃª deve assinar o apk** apÃ³s aplicar **a otimizaÃ§Ã£o com** zipaling\*\*. MAS ATENÃ‡ÃƒO QUE\*\* VOCÃŠ SÃ“ PRECISA ASSINAR O APLICATIVO UMA VEZ\*\* COM jarsigner (antes do zipalign) OU COM aspsigner (depois do zipalign).
```bash
apksigner sign --ks key.jks ./dist/mycompiled.apk
```
Para o seguinte cÃ³digo Java Hello World:

```java
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
    }
}
```

O cÃ³digo Smali equivalente seria:

```
.class public LHelloWorld;
.super Ljava/lang/Object;

.method public static main([Ljava/lang/String;)V
    .registers 2

    sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
    const-string v1, "Hello, World!"
    invoke-virtual {v0, v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V

    return-void
.end method
```

To modify the behavior of the code, we can modify the Smali code directly. For example, we can change the string that is printed to the console by modifying the `const-string` instruction:

```
const-string v1, "Goodbye, World!"
```

After modifying the Smali code, we need to repackage the APK and sign it again before installing it on a device.
```
public static void printHelloWorld() {
    System.out.println("Hello World")
}
```
O cÃ³digo Smali seria:
```
.method public static printHelloWorld()V
    .registers 2
    sget-object v0, Ljava/lang/System;->out:Ljava/io/PrintStream;
    const-string v1, "Hello World"
    invoke-virtual {v0,v1}, Ljava/io/PrintStream;->println(Ljava/lang/String;)V
    return-void
.end method
```
O conjunto de instruÃ§Ãµes Smali estÃ¡ disponÃ­vel [aqui](https://source.android.com/devices/tech/dalvik/dalvik-bytecode#instructions).

### MudanÃ§as Leves

### Modificar valores iniciais de uma variÃ¡vel dentro de uma funÃ§Ã£o

Algumas variÃ¡veis sÃ£o definidas no inÃ­cio da funÃ§Ã£o usando o opcode _const_, vocÃª pode modificar seus valores ou definir novas:
```
#Number
const v9, 0xf4240
const/4 v8, 0x1
#Strings
const-string v5, "wins"
```
### OperaÃ§Ãµes BÃ¡sicas
```
#Math
add-int/lit8 v0, v2, 0x1 #v2 + 0x1 and save it in v0
mul-int v0,v2,0x2 #v2*0x2 and save in v0

#Move the value of one object into another
move v1,v2

#Condtions
if-ge #Greater or equals
if-le #Less or equals
if-eq #Equals

#Get/Save attributes of an object
iget v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save this.o inside v0
iput v0, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Save v0 inside this.o

#goto
:goto_6 #Declare this where you want to start a loop
if-ne v0, v9, :goto_6 #If not equals, go to: :goto_6
goto :goto_6 #Always go to: :goto_6
```
### MudanÃ§as Maiores

### Registro (Logging)
```
#Log win: <number>
iget v5, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I #Get this.o inside v5
invoke-static {v5}, Ljava/lang/String;->valueOf(I)Ljava/lang/String; #Transform number to String
move-result-object v1 #Move to v1
const-string v5, "wins" #Save "win" inside v5
invoke-static {v5, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I #Logging "Wins: <num>"
```
RecomendaÃ§Ãµes:

* Se vocÃª for usar variÃ¡veis declaradas dentro da funÃ§Ã£o (declaradas v0,v1,v2...), coloque essas linhas entre o _.local \<number>_ e as declaraÃ§Ãµes das variÃ¡veis (_const v0, 0x1_)
* Se vocÃª quiser colocar o cÃ³digo de registro no meio do cÃ³digo de uma funÃ§Ã£o:
  * Adicione 2 ao nÃºmero de variÃ¡veis declaradas: Ex: de _.locals 10_ para _.locals 12_
  * As novas variÃ¡veis devem ser os prÃ³ximos nÃºmeros das variÃ¡veis jÃ¡ declaradas (neste exemplo, devem ser _v10_ e _v11_, lembre-se de que comeÃ§a em v0).
  * Altere o cÃ³digo da funÃ§Ã£o de registro e use _v10_ e _v11_ em vez de _v5_ e _v1_.

### Toasting

Lembre-se de adicionar 3 ao nÃºmero de _.locals_ no inÃ­cio da funÃ§Ã£o.

Este cÃ³digo estÃ¡ preparado para ser inserido no **meio de uma funÃ§Ã£o** (**altere** o nÃºmero das **variÃ¡veis** conforme necessÃ¡rio). Ele irÃ¡ **pegar o valor de this.o**, **transformÃ¡-lo** em **String** e, em seguida, **fazer** um **toast** com seu valor.
```
const/4 v10, 0x1
const/4 v11, 0x1
const/4 v12, 0x1
iget v10, p0, Lcom/google/ctf/shallweplayagame/GameActivity;->o:I
invoke-static {v10}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
move-result-object v11
invoke-static {p0, v11, v12}, Landroid/widget/Toast;->makeText(Landroid/content/Context;Ljava/lang/CharSequence;I)Landroid/widget/Toast;
move-result-object v12
invoke-virtual {v12}, Landroid/widget/Toast;->show()V
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
