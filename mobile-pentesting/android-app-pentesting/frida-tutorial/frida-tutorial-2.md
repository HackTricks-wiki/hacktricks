# Tutorial de Frida 2

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FwdlXOpyZOVGNzyhOiiFK%2Fimage%20(1).png?alt=media&#x26;token=13f4d279-7d3f-47ce-a68e-35f9a906973f" alt=""><figcaption></figcaption></figure>

Si est√°s interesado en una **carrera de hacking** y en hackear lo imposible, ¬°**estamos contratando!** (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

**De**: [https://11x256.github.io/Frida-hooking-android-part-2/](https://11x256.github.io/Frida-hooking-android-part-2/) (Partes 2, 3 y 4)\
**APKs y c√≥digo fuente**: [https://github.com/11x256/frida-android-examples](https://github.com/11x256/frida-android-examples)

La parte 1 es muy f√°cil.

**Algunas partes del c√≥digo original no funcionan y han sido modificadas aqu√≠.**

## Parte 2

Aqu√≠ puedes ver un ejemplo de c√≥mo **enganchar 2 funciones con el mismo nombre** pero diferentes par√°metros.\
Tambi√©n aprender√°s c√≥mo **llamar a una funci√≥n con tus propios par√°metros**.\
Y finalmente, hay un ejemplo de c√≥mo **encontrar una instancia de una clase y hacer que llame a una funci√≥n**.
```javascript
//s2.js
console.log("Script loaded successfully ");
Java.perform(function x() {
    console.log("Inside java perform function");
    var my_class = Java.use("com.example.a11x256.frida_test.my_activity");
    //Hook "fun" with parameters (int, int)
    my_class.fun.overload("int", "int").implementation = function (x, y) { //hooking the old function
        console.log("original call: fun(" + x + ", " + y + ")");
        var ret_value = this.fun(2, 5);
        return ret_value;
    };
    //Hook "fun" with paramater(String)
    var string_class = Java.use("java.lang.String");
    my_class.fun.overload("java.lang.String").implementation = function (x) { //hooking the new function
        console.log("*")
        //Create a new String and call the function with your input.
        var my_string = string_class.$new("My TeSt String#####");
        console.log("Original arg: " + x);
        var ret = this.fun(my_string);
        console.log("Return value: " + ret);
        console.log("*")
        return ret;
    };
    //Find an instance of the class and call "secret" function.
    Java.choose("com.example.a11x256.frida_test.my_activity", {
        onMatch: function (instance) {
            console.log(tring, and the it has"Found instance: " + instance);
            console.log("Result of secret func: " + instance.secret());
        },
        onComplete: function () { }
    });
});
```
Se puede observar que para crear un String primero se ha referenciado la clase _java.lang.String_ y luego se ha creado un objeto _$new_ de esa clase con un String como contenido. Esta es la forma correcta de crear un nuevo objeto de una clase. Sin embargo, en este caso, se podr√≠a pasar a `this.fun()` cualquier String como: `this.fun("¬°hola!")`.
```python
//loader.py
import frida
import time

device = frida.get_usb_device()
pid = device.spawn(["com.example.a11x256.frida_test"])
device.resume(pid)
time.sleep(1) #Without it Java.perform silently fails
session = device.attach(pid)
script = session.create_script(open("s2.js").read())
script.load()

#prevent the python script from terminating
raw_input()
```

```
python loader.py
```
## Parte 3

### Python

Ahora ver√°s c√≥mo enviar comandos a la aplicaci√≥n enganchada a trav√©s de Python para llamar a una funci√≥n:
```python
//loader.py
import time
import frida

def my_message_handler(message, payload):
    print message
    print payload


device = frida.get_usb_device()
pid = device.spawn(["com.example.a11x256.frida_test"])
device.resume(pid)
time.sleep(1)  # Without it Java.perform silently fails
session = device.attach(pid)
with open("s3.js") as f:
    script = session.create_script(f.read())
script.on("message", my_message_handler)
script.load()

command = ""
while 1 == 1:
    command = raw_input("Enter command:\n1: Exit\n2: Call secret function\n3: Hook Secret\nchoice:")
    if command == "1":
        break
    elif command == "2":
        script.exports.callsecretfunction()
    elif command == "3":
        script.exports.hooksecretfunction()
```
El comando "**1**" **saldr√°**, el comando "**2**" encontrar√° una **instancia de la clase y llamar√° a la funci√≥n privada** _**secret()**_ y el comando "**3**" **enganchar√°** la funci√≥n _**secret()**_ para que **devuelva** una **cadena diferente**.

Entonces, si llamas a "**2**" obtendr√°s el **secreto real**, pero si llamas a "**3**" y luego a "**2**" obtendr√°s el **secreto falso**.

### JS
```javascript
console.log("Script loaded successfully ");
var instances_array = [];
function callSecretFun() {
    Java.perform(function () {
        if (instances_array.length == 0) { // if array is empty
            Java.choose("com.example.a11x256.frida_test.my_activity", {
                onMatch: function (instance) {
                    console.log("Found instance: " + instance);
                    instances_array.push(instance)
                    console.log("Result of secret func: " + instance.secret());
                },
                onComplete: function () { }

            });
        }
        else {//else if the array has some values
            console.log("Result of secret func: " + instances_array[0].secret());
        }

    });
}

function hookSecret() {
    Java.perform(function () {
        var my_class = Java.use("com.example.a11x256.frida_test.my_activity");
        var string_class = Java.use("java.lang.String");
        my_class.secret.overload().implementation = function(){
            var my_string = string_class.$new("TE ENGANNNNEEE");
            return my_string;
        }
    });
}
rpc.exports = {
    callsecretfunction: callSecretFun,
    hooksecretfunction: hookSecret
};
```
## Parte 4

Aqu√≠ ver√°s c√≥mo hacer que **Python y JS interact√∫en** utilizando objetos JSON. JS utiliza la funci√≥n `send()` para enviar datos al cliente de Python, y Python utiliza la funci√≥n `post()` para enviar datos al script de JS. El **JS bloquear√° la ejecuci√≥n** hasta que reciba una respuesta de Python.

### Python
```python
//loader.py
import time
import frida

def my_message_handler(message, payload):
    print message
    print payload
    if message["type"] == "send":
        print message["payload"]
        data = message["payload"].split(":")[1].strip()
        print 'message:', message
        data = data.decode("base64")
        user, pw = data.split(":")
        data = ("admin" + ":" + pw).encode("base64")
        print "encoded data:", data
        script.post({"my_data": data})  # send JSON object
        print "Modified data sent"


device = frida.get_usb_device()
pid = device.spawn(["com.example.a11x256.frida_test"])
device.resume(pid)
time.sleep(1)
session = device.attach(pid)
with open("s4.js") as f:
    script = session.create_script(f.read())
script.on("message", my_message_handler)  # register the message handler
script.load()
raw_input()
```
### JS

### Descripci√≥n

JavaScript (JS) es un lenguaje de programaci√≥n interpretado, de alto nivel y orientado a objetos. Es utilizado principalmente en el desarrollo web para crear interactividad en las p√°ginas. Tambi√©n es utilizado en el desarrollo de aplicaciones m√≥viles y de escritorio.

### Introducci√≥n a Frida y JS

Frida utiliza JavaScript como lenguaje de scripting para interactuar con las aplicaciones. Esto significa que podemos utilizar todas las funcionalidades de JavaScript para manipular la aplicaci√≥n en tiempo de ejecuci√≥n.

Frida proporciona una API para interactuar con la aplicaci√≥n en tiempo de ejecuci√≥n. Esta API est√° disponible en JavaScript y en Python. En este tutorial, nos centraremos en la API de JavaScript.

### Ejecuci√≥n de c√≥digo JS en Frida

Para ejecutar c√≥digo JS en Frida, primero debemos crear un script de Frida en JavaScript. Este script se ejecutar√° en el contexto de la aplicaci√≥n que estamos analizando.

Para crear un script de Frida en JavaScript, podemos utilizar cualquier editor de texto. En este tutorial, utilizaremos Visual Studio Code.

El siguiente es un ejemplo de script de Frida en JavaScript:

```javascript
console.log("Hello, world!");
```

Para ejecutar este script en Frida, primero debemos guardar el script en un archivo con extensi√≥n `.js`. Luego, podemos ejecutar el siguiente comando en la terminal:

```
frida -U -f com.example.app -l script.js --no-pause
```

Este comando ejecutar√° el script `script.js` en la aplicaci√≥n `com.example.app`. El par√°metro `--no-pause` evita que Frida se detenga despu√©s de ejecutar el script.

### Interacci√≥n con la aplicaci√≥n

Una vez que hemos ejecutado nuestro script en Frida, podemos interactuar con la aplicaci√≥n utilizando la API de Frida.

Por ejemplo, podemos utilizar la siguiente funci√≥n para obtener el valor de una variable en la aplicaci√≥n:

```javascript
function getVariableValue(variableName) {
  return Java.use("com.example.app.MainActivity").$new()[variableName].value;
}
```

Esta funci√≥n utiliza la API de Java de Frida para obtener el valor de una variable en la clase `MainActivity` de la aplicaci√≥n.

Tambi√©n podemos utilizar la siguiente funci√≥n para modificar el valor de una variable en la aplicaci√≥n:

```javascript
function setVariableValue(variableName, value) {
  Java.use("com.example.app.MainActivity").$new()[variableName].value = value;
}
```

Esta funci√≥n utiliza la API de Java de Frida para modificar el valor de una variable en la clase `MainActivity` de la aplicaci√≥n.

### Conclusi√≥n

JavaScript es un lenguaje de programaci√≥n muy poderoso que se puede utilizar para manipular aplicaciones en tiempo de ejecuci√≥n con Frida. La API de JavaScript de Frida proporciona todas las funcionalidades necesarias para interactuar con la aplicaci√≥n y manipular su comportamiento.
```javascript
console.log("Script loaded successfully ");
Java.perform(function () {
    var tv_class = Java.use("android.widget.TextView");
    tv_class.setText.overload('java.lang.CharSequence').implementation = function (x) {
        var string_to_send = x.toString();
        var string_to_recv = "";
        send(string_to_send); // send data to python code
        recv(function (received_json_object) {
            string_to_recv = received_json_object.my_data;
        }).wait(); //block execution till the message is received
        console.log("Final string_to_recv: "+ string_to_recv)
        return this.setText(string_to_recv);
    }
});
```
Hay una parte 5 que no voy a explicar porque no hay nada nuevo. Pero si quieres leerla, est√° aqu√≠: [https://11x256.github.io/Frida-hooking-android-part-5/](https://11x256.github.io/Frida-hooking-android-part-5/)



<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FwdlXOpyZOVGNzyhOiiFK%2Fimage%20(1).png?alt=media&#x26;token=13f4d279-7d3f-47ce-a68e-35f9a906973f" alt=""><figcaption></figcaption></figure>

Si est√°s interesado en una **carrera de hacking** y en hackear lo imposible - ¬°estamos contratando! (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) **grupo de Discord** o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
